begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007-2010 Broadcom Corporation. All rights reserved.  *  *    Gary Zambrano<zambrano@broadcom.com>  *    David Christensen<davidch@broadcom.com>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of Broadcom Corporation nor the name of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written consent.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS'  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_bxe.h"
end_include

begin_include
include|#
directive|include
file|"bxe_include.h"
end_include

begin_include
include|#
directive|include
file|"if_bxe.h"
end_include

begin_function_decl
name|void
name|bxe_write_dmae
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|bus_addr_t
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|bxe_read_dmae
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|bxe_set_gpio
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|bxe_get_gpio
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|bxe_set_spio
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|bxe_set_gpio_int
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint32_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|bxe_fw_command
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|BXE_DEBUG
end_ifdef

begin_function_decl
specifier|extern
name|uint32_t
name|bxe_reg_read32
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|bus_size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|bxe_reg_write32
parameter_list|(
name|struct
name|bxe_softc
modifier|*
parameter_list|,
name|bus_size_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|msleep
end_undef

begin_define
define|#
directive|define
name|msleep
parameter_list|(
name|m
parameter_list|)
value|DELAY(m * 1000)
end_define

begin_define
define|#
directive|define
name|EMAC_RX_MODE_KEEP_MAC_CONTROL
value|(1L<<3)
end_define

begin_define
define|#
directive|define
name|EMAC_RX_MODE_KEEP_VLAN_TAG
value|(1L<<10)
end_define

begin_define
define|#
directive|define
name|MDIO_PMA_REG_8481_LED1_MASK
value|0xa82c
end_define

begin_define
define|#
directive|define
name|MDIO_PMA_REG_8481_LED2_MASK
value|0xa82f
end_define

begin_define
define|#
directive|define
name|MDIO_PMA_REG_8481_LED3_MASK
value|0xa832
end_define

begin_comment
comment|/*  * [RW 27] 0 - must be active for Everest A0; 1- for Everest B0 when latch  * logic for interrupts must be used. Enable per bit of interrupt of  * ~latch_status.latch_status.  */
end_comment

begin_define
define|#
directive|define
name|NIG_REG_LATCH_BC_0
value|0x16210
end_define

begin_comment
comment|/*  * [RW 27] Latch for each interrupt from Unicore.b[0]  * status_emac0_misc_mi_int; b[1] status_emac0_misc_mi_complete;  * b[2]status_emac0_misc_cfg_change; b[3]status_emac0_misc_link_status;  * b[4]status_emac0_misc_link_change; b[5]status_emac0_misc_attn;  * b[6]status_serdes0_mac_crs; b[7]status_serdes0_autoneg_complete;  * b[8]status_serdes0_fiber_rxact; b[9]status_serdes0_link_status;  * b[10]status_serdes0_mr_page_rx; b[11]status_serdes0_cl73_an_complete;  * b[12]status_serdes0_cl73_mr_page_rx; b[13]status_serdes0_rx_sigdet;  * b[14]status_xgxs0_remotemdioreq; b[15]status_xgxs0_link10g;  * b[16]status_xgxs0_autoneg_complete; b[17]status_xgxs0_fiber_rxact;  * b[21:18]status_xgxs0_link_status; b[22]status_xgxs0_mr_page_rx;  * b[23]status_xgxs0_cl73_an_complete; b[24]status_xgxs0_cl73_mr_page_rx;  * b[25]status_xgxs0_rx_sigdet; b[26]status_xgxs0_mac_crs  */
end_comment

begin_define
define|#
directive|define
name|NIG_REG_LATCH_STATUS_0
value|0x18000
end_define

begin_define
define|#
directive|define
name|ETH_HLEN
value|14
end_define

begin_define
define|#
directive|define
name|ETH_OVREHEAD
value|(ETH_HLEN + 8)
end_define

begin_comment
comment|/* 8 for CRC + VLAN*/
end_comment

begin_define
define|#
directive|define
name|ETH_MIN_PACKET_SIZE
value|60
end_define

begin_define
define|#
directive|define
name|ETH_MAX_PACKET_SIZE
value|1500
end_define

begin_define
define|#
directive|define
name|ETH_MAX_JUMBO_PACKET_SIZE
value|9600
end_define

begin_define
define|#
directive|define
name|MDIO_ACCESS_TIMEOUT
value|1000
end_define

begin_define
define|#
directive|define
name|BMAC_CONTROL_RX_ENABLE
value|2
end_define

begin_struct
struct|struct
name|bxe_image_header
block|{
name|uint32_t
name|magic
decl_stmt|;
define|#
directive|define
name|FILE_MAGIC
value|0x669955aa
name|uint32_t
name|version
decl_stmt|;
define|#
directive|define
name|FORMAT_VERSION_2
value|0x2
name|uint32_t
name|type
decl_stmt|;
define|#
directive|define
name|IMAGE_HDR_TYPE_BCM8073
value|0x33373038
define|#
directive|define
name|IMAGE_HDR_TYPE_BCM8726
value|0x36323738
define|#
directive|define
name|IMAGE_HDR_TYPE_BCM8727
value|0x37323738
define|#
directive|define
name|IMAGE_HDR_TYPE_BCM8481
value|0x31383438
define|#
directive|define
name|IMAGE_HDR_TYPE_SFX7101
value|0x68706673
name|uint32_t
name|image_info
decl_stmt|;
name|uint32_t
name|byte_cnt
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Shortcut definitions  */
end_comment

begin_define
define|#
directive|define
name|NIG_LATCH_BC_ENABLE_MI_INT
value|0
end_define

begin_define
define|#
directive|define
name|NIG_STATUS_EMAC0_MI_INT
define|\
value|NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_EMAC0_MISC_MI_INT
end_define

begin_define
define|#
directive|define
name|NIG_STATUS_XGXS0_LINK10G
define|\
value|NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_XGXS0_LINK10G
end_define

begin_define
define|#
directive|define
name|NIG_STATUS_XGXS0_LINK_STATUS
define|\
value|NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_XGXS0_LINK_STATUS
end_define

begin_define
define|#
directive|define
name|NIG_STATUS_XGXS0_LINK_STATUS_SIZE
define|\
value|NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_XGXS0_LINK_STATUS_SIZE
end_define

begin_define
define|#
directive|define
name|NIG_STATUS_SERDES0_LINK_STATUS
define|\
value|NIG_STATUS_INTERRUPT_PORT0_REG_STATUS_SERDES0_LINK_STATUS
end_define

begin_define
define|#
directive|define
name|NIG_MASK_MI_INT
define|\
value|NIG_MASK_INTERRUPT_PORT0_REG_MASK_EMAC0_MISC_MI_INT
end_define

begin_define
define|#
directive|define
name|NIG_MASK_XGXS0_LINK10G
define|\
value|NIG_MASK_INTERRUPT_PORT0_REG_MASK_XGXS0_LINK10G
end_define

begin_define
define|#
directive|define
name|NIG_MASK_XGXS0_LINK_STATUS
define|\
value|NIG_MASK_INTERRUPT_PORT0_REG_MASK_XGXS0_LINK_STATUS
end_define

begin_define
define|#
directive|define
name|NIG_MASK_SERDES0_LINK_STATUS
define|\
value|NIG_MASK_INTERRUPT_PORT0_REG_MASK_SERDES0_LINK_STATUS
end_define

begin_define
define|#
directive|define
name|MDIO_AN_CL73_OR_37_COMPLETE
define|\
value|(MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_AUTONEG_COMPLETE |		\ 	MDIO_GP_STATUS_TOP_AN_STATUS1_CL37_AUTONEG_COMPLETE)
end_define

begin_define
define|#
directive|define
name|XGXS_RESET_BITS
define|\
value|(MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_RSTB_HW |	\ 	MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_IDDQ |		\ 	MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_PWRDWN |		\ 	MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_PWRDWN_SD |	\ 	MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_XGXS0_TXD_FIFO_RSTB)
end_define

begin_define
define|#
directive|define
name|SERDES_RESET_BITS
define|\
value|(MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_RSTB_HW |	\ 	MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_IDDQ |		\ 	MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_PWRDWN |	\ 	MISC_REGISTERS_RESET_REG_3_MISC_NIG_MUX_SERDES0_PWRDWN_SD)
end_define

begin_define
define|#
directive|define
name|AUTONEG_CL37
value|SHARED_HW_CFG_AN_ENABLE_CL37
end_define

begin_define
define|#
directive|define
name|AUTONEG_CL73
value|SHARED_HW_CFG_AN_ENABLE_CL73
end_define

begin_define
define|#
directive|define
name|AUTONEG_BAM
value|SHARED_HW_CFG_AN_ENABLE_BAM
end_define

begin_define
define|#
directive|define
name|AUTONEG_PARALLEL
value|SHARED_HW_CFG_AN_ENABLE_PARALLEL_DETECTION
end_define

begin_define
define|#
directive|define
name|AUTONEG_SGMII_FIBER_AUTODET
define|\
value|SHARED_HW_CFG_AN_EN_SGMII_FIBER_AUTO_DETECT
end_define

begin_define
define|#
directive|define
name|AUTONEG_REMOTE_PHY
value|SHARED_HW_CFG_AN_ENABLE_REMOTE_PHY
end_define

begin_define
define|#
directive|define
name|GP_STATUS_PAUSE_RSOLUTION_TXSIDE
define|\
value|MDIO_GP_STATUS_TOP_AN_STATUS1_PAUSE_RSOLUTION_TXSIDE
end_define

begin_define
define|#
directive|define
name|GP_STATUS_PAUSE_RSOLUTION_RXSIDE
define|\
value|MDIO_GP_STATUS_TOP_AN_STATUS1_PAUSE_RSOLUTION_RXSIDE
end_define

begin_define
define|#
directive|define
name|GP_STATUS_SPEED_MASK
define|\
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_MASK
end_define

begin_define
define|#
directive|define
name|GP_STATUS_10M
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10M
end_define

begin_define
define|#
directive|define
name|GP_STATUS_100M
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_100M
end_define

begin_define
define|#
directive|define
name|GP_STATUS_1G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_1G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_2_5G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_2_5G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_5G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_5G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_6G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_6G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_10G_HIG
define|\
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_HIG
end_define

begin_define
define|#
directive|define
name|GP_STATUS_10G_CX4
define|\
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_CX4
end_define

begin_define
define|#
directive|define
name|GP_STATUS_12G_HIG
define|\
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_12G_HIG
end_define

begin_define
define|#
directive|define
name|GP_STATUS_12_5G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_12_5G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_13G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_13G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_15G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_15G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_16G
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_16G
end_define

begin_define
define|#
directive|define
name|GP_STATUS_1G_KX
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_1G_KX
end_define

begin_define
define|#
directive|define
name|GP_STATUS_10G_KX4
define|\
value|MDIO_GP_STATUS_TOP_AN_STATUS1_ACTUAL_SPEED_10G_KX4
end_define

begin_define
define|#
directive|define
name|LINK_10THD
value|LINK_STATUS_SPEED_AND_DUPLEX_10THD
end_define

begin_define
define|#
directive|define
name|LINK_10TFD
value|LINK_STATUS_SPEED_AND_DUPLEX_10TFD
end_define

begin_define
define|#
directive|define
name|LINK_100TXHD
value|LINK_STATUS_SPEED_AND_DUPLEX_100TXHD
end_define

begin_define
define|#
directive|define
name|LINK_100T4
value|LINK_STATUS_SPEED_AND_DUPLEX_100T4
end_define

begin_define
define|#
directive|define
name|LINK_100TXFD
value|LINK_STATUS_SPEED_AND_DUPLEX_100TXFD
end_define

begin_define
define|#
directive|define
name|LINK_1000THD
value|LINK_STATUS_SPEED_AND_DUPLEX_1000THD
end_define

begin_define
define|#
directive|define
name|LINK_1000TFD
value|LINK_STATUS_SPEED_AND_DUPLEX_1000TFD
end_define

begin_define
define|#
directive|define
name|LINK_1000XFD
value|LINK_STATUS_SPEED_AND_DUPLEX_1000XFD
end_define

begin_define
define|#
directive|define
name|LINK_2500THD
value|LINK_STATUS_SPEED_AND_DUPLEX_2500THD
end_define

begin_define
define|#
directive|define
name|LINK_2500TFD
value|LINK_STATUS_SPEED_AND_DUPLEX_2500TFD
end_define

begin_define
define|#
directive|define
name|LINK_2500XFD
value|LINK_STATUS_SPEED_AND_DUPLEX_2500XFD
end_define

begin_define
define|#
directive|define
name|LINK_10GTFD
value|LINK_STATUS_SPEED_AND_DUPLEX_10GTFD
end_define

begin_define
define|#
directive|define
name|LINK_10GXFD
value|LINK_STATUS_SPEED_AND_DUPLEX_10GXFD
end_define

begin_define
define|#
directive|define
name|LINK_12GTFD
value|LINK_STATUS_SPEED_AND_DUPLEX_12GTFD
end_define

begin_define
define|#
directive|define
name|LINK_12GXFD
value|LINK_STATUS_SPEED_AND_DUPLEX_12GXFD
end_define

begin_define
define|#
directive|define
name|LINK_12_5GTFD
value|LINK_STATUS_SPEED_AND_DUPLEX_12_5GTFD
end_define

begin_define
define|#
directive|define
name|LINK_12_5GXFD
value|LINK_STATUS_SPEED_AND_DUPLEX_12_5GXFD
end_define

begin_define
define|#
directive|define
name|LINK_13GTFD
value|LINK_STATUS_SPEED_AND_DUPLEX_13GTFD
end_define

begin_define
define|#
directive|define
name|LINK_13GXFD
value|LINK_STATUS_SPEED_AND_DUPLEX_13GXFD
end_define

begin_define
define|#
directive|define
name|LINK_15GTFD
value|LINK_STATUS_SPEED_AND_DUPLEX_15GTFD
end_define

begin_define
define|#
directive|define
name|LINK_15GXFD
value|LINK_STATUS_SPEED_AND_DUPLEX_15GXFD
end_define

begin_define
define|#
directive|define
name|LINK_16GTFD
value|LINK_STATUS_SPEED_AND_DUPLEX_16GTFD
end_define

begin_define
define|#
directive|define
name|LINK_16GXFD
value|LINK_STATUS_SPEED_AND_DUPLEX_16GXFD
end_define

begin_define
define|#
directive|define
name|PHY_XGXS_FLAG
value|0x1
end_define

begin_define
define|#
directive|define
name|PHY_SGMII_FLAG
value|0x2
end_define

begin_define
define|#
directive|define
name|PHY_SERDES_FLAG
value|0x4
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_CON_TYPE_ADDR
value|0x2
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_CON_TYPE_VAL_LC
value|0x7
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_CON_TYPE_VAL_COPPER
value|0x21
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_COMP_CODE_ADDR
value|0x3
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_COMP_CODE_SR_MASK
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_COMP_CODE_LR_MASK
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_COMP_CODE_LRM_MASK
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_FC_TX_TECH_ADDR
value|0x8
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_PASSIVE
value|0x4
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_ACTIVE
value|0x8
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_OPTIONS_ADDR
value|0x40
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_OPTIONS_LINEAR_RX_OUT_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|SFP_EEPROM_OPTIONS_SIZE
value|2
end_define

begin_define
define|#
directive|define
name|EDC_MODE_LINEAR
value|0x0022
end_define

begin_define
define|#
directive|define
name|EDC_MODE_LIMITING
value|0x0044
end_define

begin_define
define|#
directive|define
name|EDC_MODE_PASSIVE_DAC
value|0x0055
end_define

begin_comment
comment|/*  * 8073 Download definitions.  */
end_comment

begin_comment
comment|/* spi Parameters.*/
end_comment

begin_define
define|#
directive|define
name|SPI_CTRL_1_L
value|0xC000
end_define

begin_define
define|#
directive|define
name|SPI_CTRL_1_H
value|0xC002
end_define

begin_define
define|#
directive|define
name|SPI_CTRL_2_L
value|0xC400
end_define

begin_define
define|#
directive|define
name|SPI_CTRL_2_H
value|0xC402
end_define

begin_define
define|#
directive|define
name|SPI_TXFIFO
value|0xD000
end_define

begin_define
define|#
directive|define
name|SPI_RXFIFO
value|0xD400
end_define

begin_comment
comment|/* Input Command Messages.*/
end_comment

begin_comment
comment|/*  * Write CPU/SPI Control Regs, followed by Count And  * CPU/SPI Controller Reg add/data pairs.  */
end_comment

begin_define
define|#
directive|define
name|WR_CPU_CTRL_REGS
value|0x11
end_define

begin_comment
comment|/*  * Read CPU/SPI Control Regs, followed by Count and  * CPU/SPI Controller Register Add.  */
end_comment

begin_define
define|#
directive|define
name|RD_CPU_CTRL_REGS
value|0xEE
end_define

begin_comment
comment|/*  * Write CPU/SPI Control Regs Continously, followed by  * Count and CPU/SPI Controller Reg addr and data's.  */
end_comment

begin_define
define|#
directive|define
name|WR_CPU_CTRL_FIFO
value|0x66
end_define

begin_comment
comment|/* Output Command Messages.*/
end_comment

begin_define
define|#
directive|define
name|DONE
value|0x4321
end_define

begin_comment
comment|/* SPI Controller Commands (known As messages).*/
end_comment

begin_define
define|#
directive|define
name|MSGTYPE_HWR
value|0x40
end_define

begin_define
define|#
directive|define
name|MSGTYPE_HRD
value|0x80
end_define

begin_define
define|#
directive|define
name|WRSR_OPCODE
value|0x01
end_define

begin_define
define|#
directive|define
name|WR_OPCODE
value|0x02
end_define

begin_define
define|#
directive|define
name|RD_OPCODE
value|0x03
end_define

begin_define
define|#
directive|define
name|WRDI_OPCODE
value|0x04
end_define

begin_define
define|#
directive|define
name|RDSR_OPCODE
value|0x05
end_define

begin_define
define|#
directive|define
name|WREN_OPCODE
value|0x06
end_define

begin_define
define|#
directive|define
name|WR_BLOCK_SIZE
value|0x40
end_define

begin_comment
comment|/* Maximum 64 Bytes Writes.*/
end_comment

begin_define
define|#
directive|define
name|BUF_SIZE_BCM
value|0x4000
end_define

begin_comment
comment|/* Code Size is 16k bytes.*/
end_comment

begin_define
define|#
directive|define
name|UPGRADE_TIMEOUT_BCM
value|1000
end_define

begin_comment
comment|/*  * INTERFACE  */
end_comment

begin_define
define|#
directive|define
name|CL45_WR_OVER_CL22
parameter_list|(
name|_sc
parameter_list|,
name|_port
parameter_list|,
name|_phy_addr
parameter_list|,
name|_bank
parameter_list|,
name|_addr
parameter_list|,
name|_val
parameter_list|)
define|\
value|bxe_cl45_write(_sc, _port, 0, _phy_addr, DEFAULT_PHY_DEV_ADDR,	\ 	(_bank + (_addr& 0xf)), _val)
end_define

begin_define
define|#
directive|define
name|CL45_RD_OVER_CL22
parameter_list|(
name|_sc
parameter_list|,
name|_port
parameter_list|,
name|_phy_addr
parameter_list|,
name|_bank
parameter_list|,
name|_addr
parameter_list|,
name|_val
parameter_list|)
define|\
value|bxe_cl45_read(_sc, _port, 0, _phy_addr, DEFAULT_PHY_DEV_ADDR,	\ 	(_bank + (_addr& 0xf)), _val)
end_define

begin_function
specifier|static
name|void
name|bxe_set_serdes_access
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|emac_base
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|emac_base
operator|=
operator|(
name|params
operator|->
name|port
operator|)
condition|?
name|GRCBASE_EMAC1
else|:
name|GRCBASE_EMAC0
expr_stmt|;
comment|/* Set Clause 22 */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_SERDES0_CTRL_MD_ST
operator|+
name|params
operator|->
name|port
operator|*
literal|0x10
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|,
literal|0x245f8000
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|,
literal|0x245d000f
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
comment|/* Set Clause 45 */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_SERDES0_CTRL_MD_ST
operator|+
name|params
operator|->
name|port
operator|*
literal|0x10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_phy_mdio
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint8_t
name|phy_flags
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_CTRL_MD_ST
operator|+
name|params
operator|->
name|port
operator|*
literal|0x18
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_CTRL_MD_DEVAD
operator|+
name|params
operator|->
name|port
operator|*
literal|0x18
argument_list|,
name|DEFAULT_PHY_DEV_ADDR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bxe_set_serdes_access
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_SERDES0_CTRL_MD_DEVAD
operator|+
name|params
operator|->
name|port
operator|*
literal|0x10
argument_list|,
name|DEFAULT_PHY_DEV_ADDR
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bxe_bits_en
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|bits
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|val
operator||=
name|bits
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bxe_bits_dis
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|bits
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|bits
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_emac_init
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|emac_base
decl_stmt|,
name|val
decl_stmt|;
name|uint16_t
name|timeout
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
comment|/* reset and unreset the emac core */
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|emac_base
operator|=
name|port
condition|?
name|GRCBASE_EMAC1
else|:
name|GRCBASE_EMAC0
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_2_CLEAR
argument_list|,
operator|(
name|MISC_REGISTERS_RESET_REG_2_RST_EMAC0_HARD_CORE
operator|<<
name|port
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_2_SET
argument_list|,
operator|(
name|MISC_REGISTERS_RESET_REG_2_RST_EMAC0_HARD_CORE
operator|<<
name|port
operator|)
argument_list|)
expr_stmt|;
comment|/* Init emac - use read-modify-write. */
comment|/* self clear reset */
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_MODE
argument_list|)
expr_stmt|;
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_MODE
argument_list|,
operator|(
name|val
operator||
name|EMAC_MODE_RESET
operator|)
argument_list|)
expr_stmt|;
name|timeout
operator|=
literal|200
expr_stmt|;
do|do
block|{
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_MODE
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"EMAC reset reg is %u\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timeout
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"EMAC timeout!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|timeout
operator|--
expr_stmt|;
block|}
do|while
condition|(
name|val
operator|&
name|EMAC_MODE_RESET
condition|)
do|;
comment|/* Set mac address. */
name|val
operator|=
operator|(
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|params
operator|->
name|mac_addr
index|[
literal|1
index|]
operator|)
expr_stmt|;
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_MAC_MATCH
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|params
operator|->
name|mac_addr
index|[
literal|5
index|]
operator|)
expr_stmt|;
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_MAC_MATCH
operator|+
literal|4
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_emac_enable
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|lb
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|emac_base
decl_stmt|,
name|ser_lane
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"enabling EMAC\n"
argument_list|)
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|emac_base
operator|=
name|port
condition|?
name|GRCBASE_EMAC1
else|:
name|GRCBASE_EMAC0
expr_stmt|;
comment|/* enable emac and not bmac */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_EMAC0_PORT
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
name|ser_lane
operator|=
operator|(
operator|(
name|params
operator|->
name|lane_config
operator|&
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK
operator|)
operator|>>
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS\n"
argument_list|)
expr_stmt|;
comment|/* select the master lanes (out of 0-3) */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS_LANE_SEL_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|ser_lane
argument_list|)
expr_stmt|;
comment|/* select XGXS */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS_SERDES0_MODE_SEL
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SerDes */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes\n"
argument_list|)
expr_stmt|;
comment|/* select SerDes */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS_SERDES0_MODE_SEL
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_RX_MODE
argument_list|,
name|EMAC_RX_MODE_RESET
argument_list|)
expr_stmt|;
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_TX_MODE
argument_list|,
name|EMAC_TX_MODE_RESET
argument_list|)
expr_stmt|;
comment|/* pause enable/disable */
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_RX_MODE
argument_list|,
name|EMAC_RX_MODE_FLOW_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_RX
condition|)
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_RX_MODE
argument_list|,
name|EMAC_RX_MODE_FLOW_EN
argument_list|)
expr_stmt|;
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_TX_MODE
argument_list|,
operator|(
name|EMAC_TX_MODE_EXT_PAUSE_EN
operator||
name|EMAC_TX_MODE_FLOW_EN
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_TX
condition|)
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_TX_MODE
argument_list|,
operator|(
name|EMAC_TX_MODE_EXT_PAUSE_EN
operator||
name|EMAC_TX_MODE_FLOW_EN
operator|)
argument_list|)
expr_stmt|;
comment|/* KEEP_VLAN_TAG, promiscuous */
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_RX_MODE
argument_list|)
expr_stmt|;
name|val
operator||=
name|EMAC_RX_MODE_KEEP_VLAN_TAG
operator||
name|EMAC_RX_MODE_PROMISCUOUS
expr_stmt|;
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_RX_MODE
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Set Loopback */
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_MODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lb
condition|)
name|val
operator||=
literal|0x810
expr_stmt|;
else|else
name|val
operator|&=
operator|~
literal|0x810
expr_stmt|;
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_MODE
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* enable emac */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_NIG_EMAC0_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Enable emac for jumbo packets. */
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_RX_MTU_SIZE
argument_list|,
operator|(
name|EMAC_RX_MTU_SIZE_JUMBO_ENA
operator||
operator|(
name|ETH_MAX_JUMBO_PACKET_SIZE
operator|+
name|ETH_OVREHEAD
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* strip CRC */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_NIG_INGRESS_EMAC0_NO_CRC
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
comment|/* Disable the NIG in/out to the bmac. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_IN_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_PAUSE_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Enable the NIG in/out to the emac. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EMAC0_IN_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_TX
condition|)
name|val
operator|=
literal|1
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EMAC0_PAUSE_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_EMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_REGS_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_EMAC
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_bmac1_enable
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|is_lb
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|bmac_addr
decl_stmt|,
name|wb_data
index|[
literal|2
index|]
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Enabling BigMAC1\n"
argument_list|)
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|bmac_addr
operator|=
name|port
condition|?
name|NIG_REG_INGRESS_BMAC1_MEM
else|:
name|NIG_REG_INGRESS_BMAC0_MEM
expr_stmt|;
comment|/* XGXS control */
name|wb_data
index|[
literal|0
index|]
operator|=
literal|0x3c
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_BMAC_XGXS_CONTROL
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* tx MAC SA */
name|wb_data
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|params
operator|->
name|mac_addr
index|[
literal|5
index|]
operator|)
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|params
operator|->
name|mac_addr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|params
operator|->
name|mac_addr
index|[
literal|1
index|]
operator|)
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_TX_SOURCE_ADDR
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* tx control */
name|val
operator|=
literal|0xc0
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_TX
condition|)
name|val
operator||=
literal|0x800000
expr_stmt|;
name|wb_data
index|[
literal|0
index|]
operator|=
name|val
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_TX_CONTROL
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* mac control */
name|val
operator|=
literal|0x3
expr_stmt|;
if|if
condition|(
name|is_lb
condition|)
block|{
name|val
operator||=
literal|0x4
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"enable bmac loopback\n"
argument_list|)
expr_stmt|;
block|}
name|wb_data
index|[
literal|0
index|]
operator|=
name|val
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_BMAC_CONTROL
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* set rx mtu */
name|wb_data
index|[
literal|0
index|]
operator|=
name|ETH_MAX_JUMBO_PACKET_SIZE
operator|+
name|ETH_OVREHEAD
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_RX_MAX_SIZE
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* rx control set to don't strip crc */
name|val
operator|=
literal|0x14
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_RX
condition|)
name|val
operator||=
literal|0x20
expr_stmt|;
name|wb_data
index|[
literal|0
index|]
operator|=
name|val
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_RX_CONTROL
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* set tx mtu */
name|wb_data
index|[
literal|0
index|]
operator|=
name|ETH_MAX_JUMBO_PACKET_SIZE
operator|+
name|ETH_OVREHEAD
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_TX_MAX_SIZE
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* set cnt max size */
name|wb_data
index|[
literal|0
index|]
operator|=
name|ETH_MAX_JUMBO_PACKET_SIZE
operator|+
name|ETH_OVREHEAD
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_CNT_MAX_SIZE
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* configure safc */
name|wb_data
index|[
literal|0
index|]
operator|=
literal|0x1000200
expr_stmt|;
name|wb_data
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_RX_LLFC_MSG_FLDS
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_bmac_enable
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|is_lb
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|uint8_t
name|rc
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
comment|/* reset and unreset the BigMac */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_2_CLEAR
argument_list|,
operator|(
name|MISC_REGISTERS_RESET_REG_2_RST_BMAC0
operator|<<
name|port
operator|)
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_2_SET
argument_list|,
operator|(
name|MISC_REGISTERS_RESET_REG_2_RST_BMAC0
operator|<<
name|port
operator|)
argument_list|)
expr_stmt|;
comment|/* enable access for bmac registers */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_REGS_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bxe_bmac1_enable
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|is_lb
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS_SERDES0_MODE_SEL
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS_LANE_SEL_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_EMAC0_PORT
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_TX
condition|)
name|val
operator|=
literal|1
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_PAUSE_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_EMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EMAC0_IN_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EMAC0_PAUSE_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_IN_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_BMAC
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_phy_deassert
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint8_t
name|phy_flags
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_phy_deassert:XGXS\n"
argument_list|)
expr_stmt|;
name|val
operator|=
name|XGXS_RESET_BITS
expr_stmt|;
block|}
else|else
block|{
comment|/* SerDes */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_phy_deassert:SerDes\n"
argument_list|)
expr_stmt|;
name|val
operator|=
name|SERDES_RESET_BITS
expr_stmt|;
block|}
name|val
operator|=
name|val
operator|<<
operator|(
name|params
operator|->
name|port
operator|*
literal|16
operator|)
expr_stmt|;
comment|/* reset and unreset the SerDes/XGXS */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_3_CLEAR
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_3_SET
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|bxe_set_phy_mdio
argument_list|(
name|params
argument_list|,
name|phy_flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bxe_link_status_update
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|link_10g
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|switch_cfg
operator|==
name|SWITCH_CFG_1G
condition|)
name|vars
operator|->
name|phy_flags
operator|=
name|PHY_SERDES_FLAG
expr_stmt|;
else|else
name|vars
operator|->
name|phy_flags
operator|=
name|PHY_XGXS_FLAG
expr_stmt|;
name|vars
operator|->
name|link_status
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|port_mb
index|[
name|port
index|]
operator|.
name|link_status
argument_list|)
argument_list|)
expr_stmt|;
name|vars
operator|->
name|link_up
operator|=
operator|(
name|vars
operator|->
name|link_status
operator|&
name|LINK_STATUS_LINK_UP
operator|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|link_up
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"phy link up\n"
argument_list|)
expr_stmt|;
name|vars
operator|->
name|phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
switch|switch
condition|(
name|vars
operator|->
name|link_status
operator|&
name|LINK_STATUS_SPEED_AND_DUPLEX_MASK
condition|)
block|{
case|case
name|LINK_10THD
case|:
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_HALF
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|LINK_10TFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10
expr_stmt|;
break|break;
case|case
name|LINK_100TXHD
case|:
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_HALF
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|LINK_100T4
case|:
case|case
name|LINK_100TXFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_100
expr_stmt|;
break|break;
case|case
name|LINK_1000THD
case|:
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_HALF
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|LINK_1000TFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_1000
expr_stmt|;
break|break;
case|case
name|LINK_2500THD
case|:
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_HALF
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|LINK_2500TFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_2500
expr_stmt|;
break|break;
case|case
name|LINK_10GTFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
break|break;
case|case
name|LINK_12GTFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_12000
expr_stmt|;
break|break;
case|case
name|LINK_12_5GTFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_12500
expr_stmt|;
break|break;
case|case
name|LINK_13GTFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_13000
expr_stmt|;
break|break;
case|case
name|LINK_15GTFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_15000
expr_stmt|;
break|break;
case|case
name|LINK_16GTFD
case|:
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_16000
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|vars
operator|->
name|link_status
operator|&
name|LINK_STATUS_TX_FLOW_CONTROL_ENABLED
condition|)
name|vars
operator|->
name|flow_ctrl
operator||=
name|FLOW_CTRL_TX
expr_stmt|;
else|else
name|vars
operator|->
name|flow_ctrl
operator|&=
operator|~
name|FLOW_CTRL_TX
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|link_status
operator|&
name|LINK_STATUS_RX_FLOW_CONTROL_ENABLED
condition|)
name|vars
operator|->
name|flow_ctrl
operator||=
name|FLOW_CTRL_RX
expr_stmt|;
else|else
name|vars
operator|->
name|flow_ctrl
operator|&=
operator|~
name|FLOW_CTRL_RX
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|&&
operator|(
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_10
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_100
operator|)
operator|)
condition|)
block|{
name|vars
operator|->
name|phy_flags
operator||=
name|PHY_SGMII_FLAG
expr_stmt|;
block|}
else|else
name|vars
operator|->
name|phy_flags
operator|&=
operator|~
name|PHY_SGMII_FLAG
expr_stmt|;
block|}
comment|/* Anything 10 and over uses the bmac. */
name|link_10g
operator|=
operator|(
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_10000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_12000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_12500
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_13000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_15000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_16000
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|link_10g
condition|)
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_BMAC
expr_stmt|;
else|else
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_EMAC
expr_stmt|;
block|}
else|else
block|{
comment|/* link down */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"phy link down\n"
argument_list|)
expr_stmt|;
name|vars
operator|->
name|phy_link_up
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_NONE
expr_stmt|;
comment|/* Indicate no mac active. */
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_NONE
expr_stmt|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"link_status 0x%x phy_link_up %x\n"
argument_list|,
name|vars
operator|->
name|link_status
argument_list|,
name|vars
operator|->
name|phy_link_up
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"line_speed %x duplex %x flow_ctrl 0x%x\n"
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|,
name|vars
operator|->
name|duplex
argument_list|,
name|vars
operator|->
name|flow_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_update_mng
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint32_t
name|link_status
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|port_mb
index|[
name|params
operator|->
name|port
index|]
operator|.
name|link_status
argument_list|)
argument_list|,
name|link_status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bmac_rx_disable
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|chip_id
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|uint32_t
name|bmac_addr
decl_stmt|,
name|wb_data
index|[
literal|2
index|]
decl_stmt|;
name|uint32_t
name|nig_bmac_enable
decl_stmt|;
name|bmac_addr
operator|=
name|port
condition|?
name|NIG_REG_INGRESS_BMAC1_MEM
else|:
name|NIG_REG_INGRESS_BMAC0_MEM
expr_stmt|;
name|nig_bmac_enable
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_REGS_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|)
expr_stmt|;
comment|/* Only if the bmac is out of reset */
if|if
condition|(
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|MISC_REG_RESET_REG_2
argument_list|)
operator|&
operator|(
name|MISC_REGISTERS_RESET_REG_2_RST_BMAC0
operator|<<
name|port
operator|)
operator|&&
name|nig_bmac_enable
condition|)
block|{
name|REG_RD_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_BMAC_CONTROL
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wb_data
index|[
literal|0
index|]
operator|&=
operator|~
name|BMAC_CONTROL_RX_ENABLE
expr_stmt|;
name|REG_WR_DMAE
argument_list|(
name|sc
argument_list|,
name|bmac_addr
operator|+
name|BIGMAC_REGISTER_BMAC_CONTROL
argument_list|,
name|wb_data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_pbf_update
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint32_t
name|flow_ctrl
parameter_list|,
name|uint32_t
name|line_speed
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|count
decl_stmt|,
name|crd
decl_stmt|,
name|init_crd
decl_stmt|;
name|uint32_t
name|thresh
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
comment|/* Disable port. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_DISABLE_NEW_TASK_PROC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
comment|/* Wait for init credit. */
name|init_crd
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_INIT_CRD
operator|+
name|port
operator|*
literal|4
argument_list|)
expr_stmt|;
name|crd
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_CREDIT
operator|+
name|port
operator|*
literal|8
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"init_crd 0x%x crd 0x%x\n"
argument_list|,
name|init_crd
argument_list|,
name|crd
argument_list|)
expr_stmt|;
name|count
operator|=
literal|1000
expr_stmt|;
while|while
condition|(
operator|(
name|init_crd
operator|!=
name|crd
operator|)
operator|&&
name|count
condition|)
block|{
name|msleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|crd
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_CREDIT
operator|+
name|port
operator|*
literal|8
argument_list|)
expr_stmt|;
name|count
operator|--
expr_stmt|;
block|}
name|crd
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_CREDIT
operator|+
name|port
operator|*
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|init_crd
operator|!=
name|crd
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BUG! init_crd 0x%x != crd 0x%x\n"
argument_list|,
name|init_crd
argument_list|,
name|crd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|flow_ctrl
operator|&
name|FLOW_CTRL_RX
operator|||
name|line_speed
operator|==
name|SPEED_10
operator|||
name|line_speed
operator|==
name|SPEED_100
operator|||
name|line_speed
operator|==
name|SPEED_1000
operator|||
name|line_speed
operator|==
name|SPEED_2500
condition|)
block|{
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_PAUSE_ENABLE
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Update threshold. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_ARB_THRSH
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Update init credit. */
name|init_crd
operator|=
literal|778
expr_stmt|;
comment|/* (800-18-4) */
block|}
else|else
block|{
name|thresh
operator|=
operator|(
name|ETH_MAX_JUMBO_PACKET_SIZE
operator|+
name|ETH_OVREHEAD
operator|)
operator|/
literal|16
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_PAUSE_ENABLE
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Update threshold. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_ARB_THRSH
operator|+
name|port
operator|*
literal|4
argument_list|,
name|thresh
argument_list|)
expr_stmt|;
comment|/* Update init credit. */
switch|switch
condition|(
name|line_speed
condition|)
block|{
case|case
name|SPEED_10000
case|:
name|init_crd
operator|=
name|thresh
operator|+
literal|553
operator|-
literal|22
expr_stmt|;
break|break;
case|case
name|SPEED_12000
case|:
name|init_crd
operator|=
name|thresh
operator|+
literal|664
operator|-
literal|22
expr_stmt|;
break|break;
case|case
name|SPEED_13000
case|:
name|init_crd
operator|=
name|thresh
operator|+
literal|742
operator|-
literal|22
expr_stmt|;
break|break;
case|case
name|SPEED_16000
case|:
name|init_crd
operator|=
name|thresh
operator|+
literal|778
operator|-
literal|22
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Invalid line_speed 0x%x\n"
argument_list|,
name|line_speed
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
block|}
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_P0_INIT_CRD
operator|+
name|port
operator|*
literal|4
argument_list|,
name|init_crd
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"PBF updated to speed %d credit %d\n"
argument_list|,
name|line_speed
argument_list|,
name|init_crd
argument_list|)
expr_stmt|;
comment|/* Probe the credit changes. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_INIT_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_INIT_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Enable port. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|PBF_REG_DISABLE_NEW_TASK_PROC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bxe_get_emac_base
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|uint32_t
name|emac_base
decl_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
comment|/* All MDC/MDIO is directed through single EMAC. */
if|if
condition|(
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_PORT_SWAP
argument_list|)
condition|)
name|emac_base
operator|=
name|GRCBASE_EMAC0
expr_stmt|;
else|else
name|emac_base
operator|=
name|GRCBASE_EMAC1
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
name|emac_base
operator|=
operator|(
name|port
operator|)
condition|?
name|GRCBASE_EMAC0
else|:
name|GRCBASE_EMAC1
expr_stmt|;
break|break;
default|default:
name|emac_base
operator|=
operator|(
name|port
operator|)
condition|?
name|GRCBASE_EMAC1
else|:
name|GRCBASE_EMAC0
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|emac_base
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_cl45_write
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|phy_addr
parameter_list|,
name|uint8_t
name|devad
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|uint32_t
name|mdio_ctrl
decl_stmt|,
name|saved_mode
decl_stmt|,
name|tmp
decl_stmt|;
name|uint8_t
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|mdio_ctrl
operator|=
name|bxe_get_emac_base
argument_list|(
name|sc
argument_list|,
name|ext_phy_type
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* 	 * Set clause 45 mode, slow down the MDIO clock to 2.5MHz 	 * (a value of 49==0x31) and make sure that the AUTO poll is off. 	 */
name|saved_mode
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|saved_mode
operator|&
operator|~
operator|(
name|EMAC_MDIO_MODE_AUTO_POLL
operator||
name|EMAC_MDIO_MODE_CLOCK_CNT
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|EMAC_MDIO_MODE_CLAUSE_45
operator||
operator|(
literal|49
operator|<<
name|EMAC_MDIO_MODE_CLOCK_CNT_BITSHIFT
operator|)
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|40
argument_list|)
expr_stmt|;
comment|/* address */
name|tmp
operator|=
operator|(
operator|(
name|phy_addr
operator|<<
literal|21
operator|)
operator||
operator|(
name|devad
operator|<<
literal|16
operator|)
operator||
name|reg
operator||
name|EMAC_MDIO_COMM_COMMAND_ADDRESS
operator||
name|EMAC_MDIO_COMM_START_BUSY
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|50
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|EMAC_MDIO_COMM_START_BUSY
operator|)
condition|)
block|{
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|tmp
operator|&
name|EMAC_MDIO_COMM_START_BUSY
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"write phy register failed\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
comment|/* data */
name|tmp
operator|=
operator|(
operator|(
name|phy_addr
operator|<<
literal|21
operator|)
operator||
operator|(
name|devad
operator|<<
literal|16
operator|)
operator||
name|val
operator||
name|EMAC_MDIO_COMM_COMMAND_WRITE_45
operator||
name|EMAC_MDIO_COMM_START_BUSY
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|50
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmp
operator|&
name|EMAC_MDIO_COMM_START_BUSY
operator|)
condition|)
block|{
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|tmp
operator|&
name|EMAC_MDIO_COMM_START_BUSY
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"write phy register failed\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
block|}
comment|/* Restore the saved mode. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|,
name|saved_mode
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_cl45_read
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|phy_addr
parameter_list|,
name|uint8_t
name|devad
parameter_list|,
name|uint16_t
name|reg
parameter_list|,
name|uint16_t
modifier|*
name|ret_val
parameter_list|)
block|{
name|uint32_t
name|mdio_ctrl
decl_stmt|,
name|saved_mode
decl_stmt|,
name|val
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|uint8_t
name|rc
decl_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|mdio_ctrl
operator|=
name|bxe_get_emac_base
argument_list|(
name|sc
argument_list|,
name|ext_phy_type
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* 	 * set clause 45 mode, slow down the MDIO clock to 2.5MHz 	 * (a value of 49==0x31) and make sure that the AUTO poll is off. 	 */
name|saved_mode
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|)
expr_stmt|;
name|val
operator|=
name|saved_mode
operator|&
operator|(
operator|(
name|EMAC_MDIO_MODE_AUTO_POLL
operator||
name|EMAC_MDIO_MODE_CLOCK_CNT
operator|)
operator|)
expr_stmt|;
name|val
operator||=
operator|(
name|EMAC_MDIO_MODE_CLAUSE_45
operator||
operator|(
literal|49L
operator|<<
name|EMAC_MDIO_MODE_CLOCK_CNT_BITSHIFT
operator|)
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|40
argument_list|)
expr_stmt|;
comment|/* address */
name|val
operator|=
operator|(
operator|(
name|phy_addr
operator|<<
literal|21
operator|)
operator||
operator|(
name|devad
operator|<<
literal|16
operator|)
operator||
name|reg
operator||
name|EMAC_MDIO_COMM_COMMAND_ADDRESS
operator||
name|EMAC_MDIO_COMM_START_BUSY
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|,
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|50
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
name|EMAC_MDIO_COMM_START_BUSY
operator|)
condition|)
block|{
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|val
operator|&
name|EMAC_MDIO_COMM_START_BUSY
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"read phy register failed\n"
argument_list|)
expr_stmt|;
operator|*
name|ret_val
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
comment|/* data */
name|val
operator|=
operator|(
operator|(
name|phy_addr
operator|<<
literal|21
operator|)
operator||
operator|(
name|devad
operator|<<
literal|16
operator|)
operator||
name|EMAC_MDIO_COMM_COMMAND_READ_45
operator||
name|EMAC_MDIO_COMM_START_BUSY
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|,
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|50
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_COMM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|val
operator|&
name|EMAC_MDIO_COMM_START_BUSY
operator|)
condition|)
block|{
operator|*
name|ret_val
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|val
operator|&
name|EMAC_MDIO_COMM_DATA
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|val
operator|&
name|EMAC_MDIO_COMM_START_BUSY
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"read phy register failed\n"
argument_list|)
expr_stmt|;
operator|*
name|ret_val
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
block|}
comment|/* Restore the saved mode. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|mdio_ctrl
operator|+
name|EMAC_REG_EMAC_MDIO_MODE
argument_list|,
name|saved_mode
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_aer_mmd
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ser_lane
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ser_lane
operator|=
operator|(
operator|(
name|params
operator|->
name|lane_config
operator|&
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK
operator|)
operator|>>
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT
operator|)
expr_stmt|;
name|offset
operator|=
operator|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
operator|)
condition|?
operator|(
name|params
operator|->
name|phy_addr
operator|+
name|ser_lane
operator|)
else|:
literal|0
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_AER_BLOCK
argument_list|,
name|MDIO_AER_BLOCK_AER_REG
argument_list|,
literal|0x3800
operator|+
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_master_ln
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|new_master_ln
decl_stmt|,
name|ser_lane
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ser_lane
operator|=
operator|(
operator|(
name|params
operator|->
name|lane_config
operator|&
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK
operator|)
operator|>>
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT
operator|)
expr_stmt|;
comment|/* Set the master_ln for AN. */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_XGXS_BLOCK2
argument_list|,
name|MDIO_XGXS_BLOCK2_TEST_MODE_LANE
argument_list|,
operator|&
name|new_master_ln
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_XGXS_BLOCK2
argument_list|,
name|MDIO_XGXS_BLOCK2_TEST_MODE_LANE
argument_list|,
operator|(
name|new_master_ln
operator||
name|ser_lane
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_reset_unicore
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|mii_control
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|&
name|mii_control
argument_list|)
expr_stmt|;
comment|/* Reset the unicore. */
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|(
name|mii_control
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_RESET
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|switch_cfg
operator|==
name|SWITCH_CFG_1G
condition|)
name|bxe_set_serdes_access
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* Wait for the reset to self clear. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MDIO_ACCESS_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
comment|/* The reset erased the previous bank value. */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|&
name|mii_control
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mii_control
operator|&
name|MDIO_COMBO_IEEO_MII_CONTROL_RESET
operator|)
condition|)
block|{
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BUG! XGXS is still in reset!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_swap_lanes
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|ser_lane
decl_stmt|,
name|rx_lane_swap
decl_stmt|,
name|tx_lane_swap
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* 	 * Each two bits represents a lane number: 	 *  No swap is 0123 => 0x1b no need to enable the swap. 	 */
name|ser_lane
operator|=
operator|(
operator|(
name|params
operator|->
name|lane_config
operator|&
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK
operator|)
operator|>>
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT
operator|)
expr_stmt|;
name|rx_lane_swap
operator|=
operator|(
operator|(
name|params
operator|->
name|lane_config
operator|&
name|PORT_HW_CFG_LANE_SWAP_CFG_RX_MASK
operator|)
operator|>>
name|PORT_HW_CFG_LANE_SWAP_CFG_RX_SHIFT
operator|)
expr_stmt|;
name|tx_lane_swap
operator|=
operator|(
operator|(
name|params
operator|->
name|lane_config
operator|&
name|PORT_HW_CFG_LANE_SWAP_CFG_TX_MASK
operator|)
operator|>>
name|PORT_HW_CFG_LANE_SWAP_CFG_TX_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|rx_lane_swap
operator|!=
literal|0x1b
condition|)
block|{
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_XGXS_BLOCK2
argument_list|,
name|MDIO_XGXS_BLOCK2_RX_LN_SWAP
argument_list|,
operator|(
name|rx_lane_swap
operator||
name|MDIO_XGXS_BLOCK2_RX_LN_SWAP_ENABLE
operator||
name|MDIO_XGXS_BLOCK2_RX_LN_SWAP_FORCE_ENABLE
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_XGXS_BLOCK2
argument_list|,
name|MDIO_XGXS_BLOCK2_RX_LN_SWAP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tx_lane_swap
operator|!=
literal|0x1b
condition|)
block|{
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_XGXS_BLOCK2
argument_list|,
name|MDIO_XGXS_BLOCK2_TX_LN_SWAP
argument_list|,
operator|(
name|tx_lane_swap
operator||
name|MDIO_XGXS_BLOCK2_TX_LN_SWAP_ENABLE
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_XGXS_BLOCK2
argument_list|,
name|MDIO_XGXS_BLOCK2_TX_LN_SWAP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_parallel_detection
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint8_t
name|phy_flags
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|control2
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL2
argument_list|,
operator|&
name|control2
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_1G
condition|)
name|control2
operator||=
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL2_PRL_DT_EN
expr_stmt|;
else|else
name|control2
operator|&=
operator|~
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL2_PRL_DT_EN
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|,
literal|"params->speed_cap_mask = 0x%x, control2 = 0x%x\n"
argument_list|,
name|params
operator|->
name|speed_cap_mask
argument_list|,
name|control2
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL2
argument_list|,
name|control2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
operator|)
operator|&&
operator|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10G
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"XGXS\n"
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_10G_PARALLEL_DETECT
argument_list|,
name|MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_LINK
argument_list|,
name|MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_LINK_CNT
argument_list|)
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_10G_PARALLEL_DETECT
argument_list|,
name|MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_CONTROL
argument_list|,
operator|&
name|control2
argument_list|)
expr_stmt|;
name|control2
operator||=
name|MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_CONTROL_PARDET10G_EN
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_10G_PARALLEL_DETECT
argument_list|,
name|MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_CONTROL
argument_list|,
name|control2
argument_list|)
expr_stmt|;
comment|/* Disable parallel detection of HiG. */
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_XGXS_BLOCK2
argument_list|,
name|MDIO_XGXS_BLOCK2_UNICORE_MODE_10G
argument_list|,
name|MDIO_XGXS_BLOCK2_UNICORE_MODE_10G_CX4_XGXS
operator||
name|MDIO_XGXS_BLOCK2_UNICORE_MODE_10G_HIGIG_XGXS
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_autoneg
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|enable_cl73
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|reg_val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* CL37 Autoneg */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|&
name|reg_val
argument_list|)
expr_stmt|;
comment|/* CL37 Autoneg Enabled */
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_AUTO_NEG
condition|)
name|reg_val
operator||=
name|MDIO_COMBO_IEEO_MII_CONTROL_AN_EN
expr_stmt|;
else|else
comment|/* CL37 Autoneg Disabled */
name|reg_val
operator|&=
operator|~
operator|(
name|MDIO_COMBO_IEEO_MII_CONTROL_AN_EN
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_RESTART_AN
operator|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
comment|/* Enable/Disable Autodetection */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1
argument_list|,
operator|&
name|reg_val
argument_list|)
expr_stmt|;
name|reg_val
operator|&=
operator|~
operator|(
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_SIGNAL_DETECT_EN
operator||
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_INVERT_SIGNAL_DETECT
operator|)
expr_stmt|;
name|reg_val
operator||=
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_FIBER_MODE
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_AUTO_NEG
condition|)
name|reg_val
operator||=
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_AUTODET
expr_stmt|;
else|else
name|reg_val
operator|&=
operator|~
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_AUTODET
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
comment|/* Enable TetonII and BAM autoneg. */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_BAM_NEXT_PAGE
argument_list|,
name|MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL
argument_list|,
operator|&
name|reg_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_AUTO_NEG
condition|)
block|{
comment|/* Enable BAM aneg Mode and TetonII aneg Mode. */
name|reg_val
operator||=
operator|(
name|MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_BAM_MODE
operator||
name|MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_TETON_AN
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|/* TetonII and BAM Autoneg Disabled. */
name|reg_val
operator|&=
operator|~
operator|(
name|MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_BAM_MODE
operator||
name|MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL_TETON_AN
operator|)
expr_stmt|;
block|}
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_BAM_NEXT_PAGE
argument_list|,
name|MDIO_BAM_NEXT_PAGE_MP5_NEXT_PAGE_CTRL
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_cl73
condition|)
block|{
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_USERB0
argument_list|,
name|MDIO_CL73_USERB0_CL73_UCTRL
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_USERB0
argument_list|,
name|MDIO_CL73_USERB0_CL73_BAM_CTRL1
argument_list|,
name|MDIO_CL73_USERB0_CL73_BAM_CTRL1_BAM_EN
operator||
name|MDIO_CL73_USERB0_CL73_BAM_CTRL1_BAM_STATION_MNGR_EN
operator||
name|MDIO_CL73_USERB0_CL73_BAM_CTRL1_BAM_NP_AFTER_BP_EN
argument_list|)
expr_stmt|;
comment|/* Set the CL73 AN speed. */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB1
argument_list|,
name|MDIO_CL73_IEEEB1_AN_ADV2
argument_list|,
operator|&
name|reg_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10G
condition|)
name|reg_val
operator||=
name|MDIO_CL73_IEEEB1_AN_ADV2_ADVR_10G_KX4
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_1G
condition|)
name|reg_val
operator||=
name|MDIO_CL73_IEEEB1_AN_ADV2_ADVR_1000M_KX
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB1
argument_list|,
name|MDIO_CL73_IEEEB1_AN_ADV2
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
comment|/* CL73 Autoneg Enabled. */
name|reg_val
operator|=
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL_AN_EN
expr_stmt|;
block|}
else|else
comment|/* CL73 Autoneg Disabled */
name|reg_val
operator|=
literal|0
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB0
argument_list|,
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Program SerDes, forced speed. */
end_comment

begin_function
specifier|static
name|void
name|bxe_program_serdes
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|reg_val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* Program duplex, disable autoneg and sgmii.*/
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|&
name|reg_val
argument_list|)
expr_stmt|;
name|reg_val
operator|&=
operator|~
operator|(
name|MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_AN_EN
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
condition|)
name|reg_val
operator||=
name|MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
comment|/* 	 * Program speed 	 * - needed only if the speed is greater than 1G (2.5G or 10G). 	 */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_MISC1
argument_list|,
operator|&
name|reg_val
argument_list|)
expr_stmt|;
comment|/* Clearing the speed value before setting the right speed. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"MDIO_REG_BANK_SERDES_DIGITAL = 0x%x\n"
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
name|reg_val
operator|&=
operator|~
operator|(
name|MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_MASK
operator||
name|MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_SEL
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_1000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_100
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_10
operator|)
operator|)
condition|)
block|{
name|reg_val
operator||=
operator|(
name|MDIO_SERDES_DIGITAL_MISC1_REFCLK_SEL_156_25M
operator||
name|MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_SEL
operator|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_10000
condition|)
name|reg_val
operator||=
name|MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_10G_CX4
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_13000
condition|)
name|reg_val
operator||=
name|MDIO_SERDES_DIGITAL_MISC1_FORCE_SPEED_13G
expr_stmt|;
block|}
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_MISC1
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_brcm_cl37_advertisment
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
comment|/* Configure the 48 bits for BAM AN. */
comment|/* Set extended capabilities. */
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_2_5G
condition|)
name|val
operator||=
name|MDIO_OVER_1G_UP1_2_5G
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10G
condition|)
name|val
operator||=
name|MDIO_OVER_1G_UP1_10G
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_OVER_1G
argument_list|,
name|MDIO_OVER_1G_UP1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_OVER_1G
argument_list|,
name|MDIO_OVER_1G_UP3
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_calc_ieee_aneg_adv
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
modifier|*
name|ieee_fc
parameter_list|)
block|{
operator|*
name|ieee_fc
operator|=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_FULL_DUPLEX
expr_stmt|;
comment|/* 	 * Resolve pause mode and advertisement. 	 * Please refer to Table 28B-3 of the 802.3ab-1999 spec. 	 */
switch|switch
condition|(
name|params
operator|->
name|req_flow_ctrl
condition|)
block|{
case|case
name|FLOW_CTRL_AUTO
case|:
if|if
condition|(
name|params
operator|->
name|req_fc_auto_adv
operator|==
name|FLOW_CTRL_BOTH
condition|)
block|{
operator|*
name|ieee_fc
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
expr_stmt|;
block|}
else|else
block|{
operator|*
name|ieee_fc
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC
expr_stmt|;
block|}
break|break;
case|case
name|FLOW_CTRL_TX
case|:
operator|*
name|ieee_fc
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC
expr_stmt|;
break|break;
case|case
name|FLOW_CTRL_RX
case|:
case|case
name|FLOW_CTRL_BOTH
case|:
operator|*
name|ieee_fc
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
expr_stmt|;
break|break;
case|case
name|FLOW_CTRL_NONE
case|:
default|default:
operator|*
name|ieee_fc
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_NONE
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_ieee_aneg_advertisment
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
name|ieee_fc
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* For AN, we are always publishing full duplex. */
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV
argument_list|,
name|ieee_fc
argument_list|)
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB1
argument_list|,
name|MDIO_CL73_IEEEB1_AN_ADV1
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|MDIO_CL73_IEEEB1_AN_ADV1_PAUSE_BOTH
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|ieee_fc
operator|<<
literal|3
operator|)
operator|&
name|MDIO_CL73_IEEEB1_AN_ADV1_PAUSE_MASK
operator|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB1
argument_list|,
name|MDIO_CL73_IEEEB1_AN_ADV1
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_restart_autoneg
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint8_t
name|enable_cl73
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|mii_control
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_restart_autoneg\n"
argument_list|)
expr_stmt|;
comment|/* Enable and restart BAM/CL37 aneg. */
if|if
condition|(
name|enable_cl73
condition|)
block|{
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB0
argument_list|,
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL
argument_list|,
operator|&
name|mii_control
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB0
argument_list|,
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL
argument_list|,
operator|(
name|mii_control
operator||
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL_AN_EN
operator||
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL_RESTART_AN
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|&
name|mii_control
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_restart_autoneg mii_control before = 0x%x\n"
argument_list|,
name|mii_control
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|(
name|mii_control
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_AN_EN
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_RESTART_AN
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_initialize_sgmii_process
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|control1
decl_stmt|,
name|mii_control
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* In SGMII mode, the unicore is always slave. */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1
argument_list|,
operator|&
name|control1
argument_list|)
expr_stmt|;
name|control1
operator||=
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_INVERT_SIGNAL_DETECT
expr_stmt|;
comment|/* set sgmii mode (and not fiber) */
name|control1
operator|&=
operator|~
operator|(
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_FIBER_MODE
operator||
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_AUTODET
operator||
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1_MSTR_MODE
operator|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_CONTROL1
argument_list|,
name|control1
argument_list|)
expr_stmt|;
comment|/* if forced speed */
if|if
condition|(
operator|!
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_AUTO_NEG
operator|)
condition|)
block|{
comment|/* Set speed, disable autoneg. */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|&
name|mii_control
argument_list|)
expr_stmt|;
name|mii_control
operator|&=
operator|~
operator|(
name|MDIO_COMBO_IEEO_MII_CONTROL_AN_EN
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_MASK
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX
operator|)
expr_stmt|;
switch|switch
condition|(
name|vars
operator|->
name|line_speed
condition|)
block|{
case|case
name|SPEED_100
case|:
name|mii_control
operator||=
name|MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_100
expr_stmt|;
break|break;
case|case
name|SPEED_1000
case|:
name|mii_control
operator||=
name|MDIO_COMBO_IEEO_MII_CONTROL_MAN_SGMII_SP_1000
expr_stmt|;
break|break;
case|case
name|SPEED_10
case|:
comment|/* There is nothing to set for 10M. */
break|break;
default|default:
comment|/* Invalid speed for SGMII. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Invalid line_speed 0x%x\n"
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Setting the full duplex. */
if|if
condition|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
condition|)
name|mii_control
operator||=
name|MDIO_COMBO_IEEO_MII_CONTROL_FULL_DUPLEX
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
name|mii_control
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* AN mode */
comment|/* Enable and restart AN. */
name|bxe_restart_autoneg
argument_list|(
name|params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Link management.  */
end_comment

begin_function
specifier|static
name|void
name|bxe_pause_resolve
parameter_list|(
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint32_t
name|pause_result
parameter_list|)
block|{
comment|/*  LD	    LP	 */
switch|switch
condition|(
name|pause_result
condition|)
block|{
comment|/* ASYM P ASYM P */
case|case
literal|0xb
case|:
comment|/*   1  0   1  1 */
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_TX
expr_stmt|;
break|break;
case|case
literal|0xe
case|:
comment|/*   1  1   1  0 */
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_RX
expr_stmt|;
break|break;
case|case
literal|0x5
case|:
comment|/*   0  1   0  1 */
case|case
literal|0x7
case|:
comment|/*   0  1   1  1 */
case|case
literal|0xd
case|:
comment|/*   1  1   0  1 */
case|case
literal|0xf
case|:
comment|/*   1  1   1  1 */
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_BOTH
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|pause_result
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_LINK_PARTNER_SYMMETRIC_PAUSE
expr_stmt|;
if|if
condition|(
name|pause_result
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_LINK_PARTNER_ASYMMETRIC_PAUSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_ext_phy_resolve_fc
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|uint16_t
name|ld_pause
decl_stmt|;
comment|/* local */
name|uint16_t
name|lp_pause
decl_stmt|;
comment|/* link partner */
name|uint16_t
name|pause_result
decl_stmt|;
name|uint8_t
name|port
decl_stmt|,
name|ret
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
comment|/* Read twice. */
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|autoneg
operator|&
name|AUTO_NEG_COMPLETE
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV_PAUSE
argument_list|,
operator|&
name|ld_pause
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_LP_AUTO_NEG
argument_list|,
operator|&
name|lp_pause
argument_list|)
expr_stmt|;
name|pause_result
operator|=
operator|(
name|ld_pause
operator|&
name|MDIO_AN_REG_ADV_PAUSE_MASK
operator|)
operator|>>
literal|8
expr_stmt|;
name|pause_result
operator||=
operator|(
name|lp_pause
operator|&
name|MDIO_AN_REG_ADV_PAUSE_MASK
operator|)
operator|>>
literal|10
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Ext PHY pause result 0x%x \n"
argument_list|,
name|pause_result
argument_list|)
expr_stmt|;
name|bxe_pause_resolve
argument_list|(
name|vars
argument_list|,
name|pause_result
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|==
name|FLOW_CTRL_NONE
operator|&&
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
condition|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LD
argument_list|,
operator|&
name|ld_pause
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LP
argument_list|,
operator|&
name|lp_pause
argument_list|)
expr_stmt|;
name|pause_result
operator|=
operator|(
name|ld_pause
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
operator|)
operator|>>
literal|5
expr_stmt|;
name|pause_result
operator||=
operator|(
name|lp_pause
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
operator|)
operator|>>
literal|7
expr_stmt|;
name|bxe_pause_resolve
argument_list|(
name|vars
argument_list|,
name|pause_result
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Ext PHY CL37 pause result 0x%x \n"
argument_list|,
name|pause_result
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function_decl
name|uint8_t
name|bxe_direct_parallel_detect_used
parameter_list|(
name|struct
name|link_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|uint8_t
name|bxe_direct_parallel_detect_used
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|pd_10g
decl_stmt|,
name|status2_1000x
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|!=
name|SPEED_AUTO_NEG
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_STATUS2
argument_list|,
operator|&
name|status2_1000x
argument_list|)
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_SERDES_DIGITAL
argument_list|,
name|MDIO_SERDES_DIGITAL_A_1000X_STATUS2
argument_list|,
operator|&
name|status2_1000x
argument_list|)
expr_stmt|;
if|if
condition|(
name|status2_1000x
operator|&
name|MDIO_SERDES_DIGITAL_A_1000X_STATUS2_AN_DISABLED
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"1G parallel detect link on port %d\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_10G_PARALLEL_DETECT
argument_list|,
name|MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_STATUS
argument_list|,
operator|&
name|pd_10g
argument_list|)
expr_stmt|;
if|if
condition|(
name|pd_10g
operator|&
name|MDIO_10G_PARALLEL_DETECT_PAR_DET_10G_STATUS_PD_LINK
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"10G parallel detect link on port %d\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_flow_ctrl_resolve
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint32_t
name|gp_status
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|ld_pause
decl_stmt|;
comment|/* local driver */
name|uint16_t
name|lp_pause
decl_stmt|;
comment|/* link partner */
name|uint16_t
name|pause_result
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_NONE
expr_stmt|;
comment|/* Resolve from gp_status in case of AN complete and not sgmii. */
if|if
condition|(
name|params
operator|->
name|req_flow_ctrl
operator|!=
name|FLOW_CTRL_AUTO
condition|)
name|vars
operator|->
name|flow_ctrl
operator|=
name|params
operator|->
name|req_flow_ctrl
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|!=
name|SPEED_AUTO_NEG
condition|)
name|vars
operator|->
name|flow_ctrl
operator|=
name|params
operator|->
name|req_fc_auto_adv
expr_stmt|;
elseif|else
if|if
condition|(
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
condition|)
name|bxe_ext_phy_resolve_fc
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|gp_status
operator|&
name|MDIO_AN_CL73_OR_37_COMPLETE
operator|)
operator|&&
operator|(
operator|!
operator|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_SGMII_FLAG
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|bxe_direct_parallel_detect_used
argument_list|(
name|params
argument_list|)
condition|)
block|{
name|vars
operator|->
name|flow_ctrl
operator|=
name|params
operator|->
name|req_fc_auto_adv
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|gp_status
operator|&
operator|(
name|MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_AUTONEG_COMPLETE
operator||
name|MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_MR_LP_NP_AN_ABLE
operator|)
operator|)
operator|==
operator|(
name|MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_AUTONEG_COMPLETE
operator||
name|MDIO_GP_STATUS_TOP_AN_STATUS1_CL73_MR_LP_NP_AN_ABLE
operator|)
condition|)
block|{
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB1
argument_list|,
name|MDIO_CL73_IEEEB1_AN_ADV1
argument_list|,
operator|&
name|ld_pause
argument_list|)
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB1
argument_list|,
name|MDIO_CL73_IEEEB1_AN_LP_ADV1
argument_list|,
operator|&
name|lp_pause
argument_list|)
expr_stmt|;
name|pause_result
operator|=
operator|(
name|ld_pause
operator|&
name|MDIO_CL73_IEEEB1_AN_ADV1_PAUSE_MASK
operator|)
operator|>>
literal|8
expr_stmt|;
name|pause_result
operator||=
operator|(
name|lp_pause
operator|&
name|MDIO_CL73_IEEEB1_AN_LP_ADV1_PAUSE_MASK
operator|)
operator|>>
literal|10
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"pause_result CL73 0x%x\n"
argument_list|,
name|pause_result
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV
argument_list|,
operator|&
name|ld_pause
argument_list|)
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_AUTO_NEG_LINK_PARTNER_ABILITY1
argument_list|,
operator|&
name|lp_pause
argument_list|)
expr_stmt|;
name|pause_result
operator|=
operator|(
name|ld_pause
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_MASK
operator|)
operator|>>
literal|5
expr_stmt|;
name|pause_result
operator||=
operator|(
name|lp_pause
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_MASK
operator|)
operator|>>
literal|7
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"pause_result CL37 0x%x\n"
argument_list|,
name|pause_result
argument_list|)
expr_stmt|;
block|}
name|bxe_pause_resolve
argument_list|(
name|vars
argument_list|,
name|pause_result
argument_list|)
expr_stmt|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"flow_ctrl 0x%x\n"
argument_list|,
name|vars
operator|->
name|flow_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_check_fallback_to_cl37
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|rx_status
decl_stmt|,
name|ustat_val
decl_stmt|,
name|cl37_fsm_recieved
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"bxe_check_fallback_to_cl37\n"
argument_list|)
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_RX0
argument_list|,
name|MDIO_RX0_RX_STATUS
argument_list|,
operator|&
name|rx_status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rx_status
operator|&
name|MDIO_RX0_RX_STATUS_SIGDET
operator|)
operator|!=
operator|(
name|MDIO_RX0_RX_STATUS_SIGDET
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Signal is not detected. Restoring CL73."
literal|"rx_status(0x80b0) = 0x%x\n"
argument_list|,
name|rx_status
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB0
argument_list|,
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL
argument_list|,
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL_AN_EN
argument_list|)
expr_stmt|;
return|return;
block|}
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_USERB0
argument_list|,
name|MDIO_CL73_USERB0_CL73_USTAT1
argument_list|,
operator|&
name|ustat_val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ustat_val
operator|&
operator|(
name|MDIO_CL73_USERB0_CL73_USTAT1_LINK_STATUS_CHECK
operator||
name|MDIO_CL73_USERB0_CL73_USTAT1_AN_GOOD_CHECK_BAM37
operator|)
operator|)
operator|!=
operator|(
name|MDIO_CL73_USERB0_CL73_USTAT1_LINK_STATUS_CHECK
operator||
name|MDIO_CL73_USERB0_CL73_USTAT1_AN_GOOD_CHECK_BAM37
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"CL73 state-machine is not stable. "
literal|"ustat_val(0x8371) = 0x%x\n"
argument_list|,
name|ustat_val
argument_list|)
expr_stmt|;
return|return;
block|}
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_REMOTE_PHY
argument_list|,
name|MDIO_REMOTE_PHY_MISC_RX_STATUS
argument_list|,
operator|&
name|cl37_fsm_recieved
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cl37_fsm_recieved
operator|&
operator|(
name|MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_OVER1G_MSG
operator||
name|MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_BRCM_OUI_MSG
operator|)
operator|)
operator|!=
operator|(
name|MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_OVER1G_MSG
operator||
name|MDIO_REMOTE_PHY_MISC_RX_STATUS_CL37_FSM_RECEIVED_BRCM_OUI_MSG
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"No CL37 FSM were received. "
literal|"misc_rx_status(0x8330) = 0x%x\n"
argument_list|,
name|cl37_fsm_recieved
argument_list|)
expr_stmt|;
return|return;
block|}
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_CL73_IEEEB0
argument_list|,
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bxe_restart_autoneg
argument_list|(
name|params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"Disabling CL73, and restarting CL37 autoneg\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_an_resolve
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint32_t
name|gp_status
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
case|:
if|if
condition|(
name|gp_status
operator|&
name|MDIO_AN_CL73_OR_37_COMPLETE
condition|)
block|{
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_COMPLETE
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_AUTO_NEGOTIATE_COMPLETE
expr_stmt|;
block|}
if|if
condition|(
name|bxe_direct_parallel_detect_used
argument_list|(
name|params
argument_list|)
condition|)
block|{
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_PARALLEL_DETECTION_USED
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_PARALLEL_DETECTION_USED
expr_stmt|;
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
case|:
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|<
name|SPEED_10000
condition|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_MII_STATUS
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
condition|)
block|{
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_COMPLETE
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_AUTO_NEGOTIATE_COMPLETE
expr_stmt|;
block|}
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_AN_EXPANSION
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_PARALLEL_DETECTION_USED
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_PARALLEL_DETECTION_USED
expr_stmt|;
block|}
break|break;
block|}
empty_stmt|;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
case|:
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_STATUS
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_STATUS
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
condition|)
block|{
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_COMPLETE
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_AUTO_NEGOTIATE_COMPLETE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_PARALLEL_DETECTION_USED
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_PARALLEL_DETECTION_USED
expr_stmt|;
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_COMPLETE
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_AUTO_NEGOTIATE_COMPLETE
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"AN result for port %d: 0x%x\n"
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|vars
operator|->
name|autoneg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_link_settings_status
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint32_t
name|gp_status
parameter_list|,
name|uint8_t
name|ext_phy_link_up
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|new_line_speed
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|vars
operator|->
name|link_status
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|autoneg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
condition|)
block|{
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_AUTO_NEGOTIATE_ENABLED
expr_stmt|;
name|vars
operator|->
name|autoneg
operator||=
name|AUTO_NEG_ENABLED
expr_stmt|;
block|}
if|if
condition|(
name|gp_status
operator|&
name|MDIO_GP_STATUS_TOP_AN_STATUS1_LINK_STATUS
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"phy link up gp_status=0x%x\n"
argument_list|,
name|gp_status
argument_list|)
expr_stmt|;
name|vars
operator|->
name|phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_LINK_UP
expr_stmt|;
if|if
condition|(
name|gp_status
operator|&
name|MDIO_GP_STATUS_TOP_AN_STATUS1_DUPLEX_STATUS
condition|)
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
else|else
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_HALF
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
condition|)
name|bxe_an_resolve
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|gp_status
argument_list|)
expr_stmt|;
name|bxe_flow_ctrl_resolve
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|gp_status
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|gp_status
operator|&
name|GP_STATUS_SPEED_MASK
condition|)
block|{
case|case
name|GP_STATUS_10M
case|:
name|new_line_speed
operator|=
name|SPEED_10
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|duplex
operator|==
name|DUPLEX_FULL
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_10TFD
expr_stmt|;
else|else
name|vars
operator|->
name|link_status
operator||=
name|LINK_10THD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_100M
case|:
name|new_line_speed
operator|=
name|SPEED_100
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|duplex
operator|==
name|DUPLEX_FULL
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_100TXFD
expr_stmt|;
else|else
name|vars
operator|->
name|link_status
operator||=
name|LINK_100TXHD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_1G
case|:
case|case
name|GP_STATUS_1G_KX
case|:
name|new_line_speed
operator|=
name|SPEED_1000
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|duplex
operator|==
name|DUPLEX_FULL
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_1000TFD
expr_stmt|;
else|else
name|vars
operator|->
name|link_status
operator||=
name|LINK_1000THD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_2_5G
case|:
name|new_line_speed
operator|=
name|SPEED_2500
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|duplex
operator|==
name|DUPLEX_FULL
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_2500TFD
expr_stmt|;
else|else
name|vars
operator|->
name|link_status
operator||=
name|LINK_2500THD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_5G
case|:
case|case
name|GP_STATUS_6G
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"link speed unsupported  gp_status 0x%x\n"
argument_list|,
name|gp_status
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
case|case
name|GP_STATUS_10G_KX4
case|:
case|case
name|GP_STATUS_10G_HIG
case|:
case|case
name|GP_STATUS_10G_CX4
case|:
name|new_line_speed
operator|=
name|SPEED_10000
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_10GTFD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_12G_HIG
case|:
name|new_line_speed
operator|=
name|SPEED_12000
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_12GTFD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_12_5G
case|:
name|new_line_speed
operator|=
name|SPEED_12500
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_12_5GTFD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_13G
case|:
name|new_line_speed
operator|=
name|SPEED_13000
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_13GTFD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_15G
case|:
name|new_line_speed
operator|=
name|SPEED_15000
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_15GTFD
expr_stmt|;
break|break;
case|case
name|GP_STATUS_16G
case|:
name|new_line_speed
operator|=
name|SPEED_16000
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_16GTFD
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"link speed unsupported gp_status 0x%x\n"
argument_list|,
name|gp_status
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
comment|/* 		 * Upon link speed change set the NIG into drain mode. 		 * Comes to deals with possible FIFO glitch due to clk change 		 * when speed is decreased without link down indicator. 		 */
if|if
condition|(
name|new_line_speed
operator|!=
name|vars
operator|->
name|line_speed
condition|)
block|{
if|if
condition|(
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
operator|&&
name|ext_phy_link_up
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Internal link speed %d is different "
literal|"than the external link speed %d\n"
argument_list|,
name|new_line_speed
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|)
expr_stmt|;
name|vars
operator|->
name|phy_link_up
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_DRAIN0_MODE
operator|+
name|params
operator|->
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|vars
operator|->
name|line_speed
operator|=
name|new_line_speed
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_TX
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_TX_FLOW_CONTROL_ENABLED
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|flow_ctrl
operator|&
name|FLOW_CTRL_RX
condition|)
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_RX_FLOW_CONTROL_ENABLED
expr_stmt|;
if|if
condition|(
operator|!
name|ext_phy_link_up
condition|)
name|vars
operator|->
name|link_status
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* link_down */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"phy link down\n"
argument_list|)
expr_stmt|;
name|vars
operator|->
name|phy_link_up
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_NONE
expr_stmt|;
name|vars
operator|->
name|autoneg
operator|=
name|AUTO_NEG_DISABLED
expr_stmt|;
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_NONE
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
operator|)
operator|&&
operator|(
operator|(
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
operator|)
operator|)
condition|)
block|{
name|bxe_check_fallback_to_cl37
argument_list|(
name|params
argument_list|)
expr_stmt|;
block|}
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"gp_status 0x%x  phy_link_up %x line_speed %x \n"
argument_list|,
name|gp_status
argument_list|,
name|vars
operator|->
name|phy_link_up
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"duplex %x  flow_ctrl 0x%x autoneg 0x%x\n"
argument_list|,
name|vars
operator|->
name|duplex
argument_list|,
name|vars
operator|->
name|flow_ctrl
argument_list|,
name|vars
operator|->
name|autoneg
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"link_status 0x%x\n"
argument_list|,
name|vars
operator|->
name|link_status
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_gmii_tx_driver
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|lp_up2
decl_stmt|;
name|uint16_t
name|tx_driver
decl_stmt|;
name|uint16_t
name|bank
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* read precomp */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_OVER_1G
argument_list|,
name|MDIO_OVER_1G_LP_UP2
argument_list|,
operator|&
name|lp_up2
argument_list|)
expr_stmt|;
comment|/* bits [10:7] at lp_up2, positioned at [15:12] */
name|lp_up2
operator|=
operator|(
operator|(
operator|(
name|lp_up2
operator|&
name|MDIO_OVER_1G_LP_UP2_PREEMPHASIS_MASK
operator|)
operator|>>
name|MDIO_OVER_1G_LP_UP2_PREEMPHASIS_SHIFT
operator|)
operator|<<
name|MDIO_TX0_TX_DRIVER_PREEMPHASIS_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|lp_up2
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|bank
operator|=
name|MDIO_REG_BANK_TX0
init|;
name|bank
operator|<=
name|MDIO_REG_BANK_TX3
condition|;
name|bank
operator|+=
operator|(
name|MDIO_REG_BANK_TX1
operator|-
name|MDIO_REG_BANK_TX0
operator|)
control|)
block|{
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|bank
argument_list|,
name|MDIO_TX0_TX_DRIVER
argument_list|,
operator|&
name|tx_driver
argument_list|)
expr_stmt|;
comment|/* Replace tx_driver bits [15:12] */
if|if
condition|(
name|lp_up2
operator|!=
operator|(
name|tx_driver
operator|&
name|MDIO_TX0_TX_DRIVER_PREEMPHASIS_MASK
operator|)
condition|)
block|{
name|tx_driver
operator|&=
operator|~
name|MDIO_TX0_TX_DRIVER_PREEMPHASIS_MASK
expr_stmt|;
name|tx_driver
operator||=
name|lp_up2
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|bank
argument_list|,
name|MDIO_TX0_TX_DRIVER
argument_list|,
name|tx_driver
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_emac_program
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint32_t
name|line_speed
parameter_list|,
name|uint32_t
name|duplex
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|mode
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|mode
operator|=
literal|0
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"setting link speed& duplex\n"
argument_list|)
expr_stmt|;
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|GRCBASE_EMAC0
operator|+
name|port
operator|*
literal|0x400
operator|+
name|EMAC_REG_EMAC_MODE
argument_list|,
operator|(
name|EMAC_MODE_25G_MODE
operator||
name|EMAC_MODE_PORT_MII_10M
operator||
name|EMAC_MODE_HALF_DUPLEX
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|line_speed
condition|)
block|{
case|case
name|SPEED_10
case|:
name|mode
operator||=
name|EMAC_MODE_PORT_MII_10M
expr_stmt|;
break|break;
case|case
name|SPEED_100
case|:
name|mode
operator||=
name|EMAC_MODE_PORT_MII
expr_stmt|;
break|break;
case|case
name|SPEED_1000
case|:
name|mode
operator||=
name|EMAC_MODE_PORT_GMII
expr_stmt|;
break|break;
case|case
name|SPEED_2500
case|:
name|mode
operator||=
operator|(
name|EMAC_MODE_25G_MODE
operator||
name|EMAC_MODE_PORT_GMII
operator|)
expr_stmt|;
break|break;
default|default:
comment|/* 10G not valid for EMAC */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Invalid line_speed 0x%x\n"
argument_list|,
name|line_speed
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|duplex
operator|==
name|DUPLEX_HALF
condition|)
name|mode
operator||=
name|EMAC_MODE_HALF_DUPLEX
expr_stmt|;
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|GRCBASE_EMAC0
operator|+
name|port
operator|*
literal|0x400
operator|+
name|EMAC_REG_EMAC_MODE
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|bxe_set_led
argument_list|(
name|params
argument_list|,
name|LED_MODE_OPER
argument_list|,
name|line_speed
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * External Phy section  */
end_comment

begin_function
name|void
name|bxe_ext_phy_hw_reset
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|)
block|{
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_1
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_LOW
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_1
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_ext_phy_reset
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Port %x: bxe_ext_phy_reset\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* 	 * The PHY reset is controled by GPIO 1. 	 * Give it 1ms of reset pulse. 	 */
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS Direct\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8705/8706\n"
argument_list|)
expr_stmt|;
comment|/* Restore normal power mode*/
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* HW reset */
name|bxe_ext_phy_hw_reset
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|0xa040
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
comment|/* Restore normal power mode*/
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_1
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|1
operator|<<
literal|15
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8072\n"
argument_list|)
expr_stmt|;
comment|/* 			 * Unset Low Power Mode and SW reset. 			 * Restore normal power mode. 			 */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|1
operator|<<
literal|15
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8073\n"
argument_list|)
expr_stmt|;
comment|/* Restore normal power mode. */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_1
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS SFX7101\n"
argument_list|)
expr_stmt|;
comment|/* Restore normal power mode. */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* HW reset */
name|bxe_ext_phy_hw_reset
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
case|:
comment|/* Restore normal power mode. */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* HW reset */
name|bxe_ext_phy_hw_reset
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|1
operator|<<
literal|15
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
case|:
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS PHY Failure detected\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BAD XGXS ext_phy_config 0x%x\n"
argument_list|,
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
comment|/* SerDes */
name|ext_phy_type
operator|=
name|SERDES_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_DIRECT
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes Direct\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_BCM5482
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes 5482\n"
argument_list|)
expr_stmt|;
name|bxe_ext_phy_hw_reset
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BAD SerDes ext_phy_config 0x%x\n"
argument_list|,
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_save_spirom_version
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|,
name|uint32_t
name|spirom_ver
parameter_list|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"FW version 0x%x:0x%x\n"
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
name|spirom_ver
operator|>>
literal|16
argument_list|)
argument_list|,
operator|(
name|uint16_t
operator|)
name|spirom_ver
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|port_mb
index|[
name|port
index|]
operator|.
name|ext_phy_fw_version
argument_list|)
argument_list|,
name|spirom_ver
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_save_bcm_spirom_ver
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|uint16_t
name|fw_ver1
decl_stmt|,
name|fw_ver2
decl_stmt|;
name|uint8_t
name|status
decl_stmt|;
name|status
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER1
argument_list|,
operator|&
name|fw_ver1
argument_list|)
expr_stmt|;
name|status
operator||=
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER2
argument_list|,
operator|&
name|fw_ver2
argument_list|)
expr_stmt|;
name|bxe_save_spirom_version
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|shmem_base
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fw_ver1
operator|<<
literal|16
operator||
name|fw_ver2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|BXE_PRINTF
argument_list|(
literal|"Reading the external PHY ROM failed. Status:0x%x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_save_8481_spirom_version
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|,
name|fw_ver1
decl_stmt|,
name|fw_ver2
decl_stmt|,
name|cnt
decl_stmt|;
comment|/* 	 * For the 32 bits registers in 8481, access via MDIO2ARM interface. 	 * (1) set register 0xc200_0014(SPI_BRIDGE_CTRL_2) to 0x03000000. 	 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA819
argument_list|,
literal|0x0014
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA81A
argument_list|,
literal|0xc200
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA81B
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA81C
argument_list|,
literal|0x0300
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA817
argument_list|,
literal|0x0009
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|100
condition|;
name|cnt
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA818
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
literal|1
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|100
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Unable to read 8481 phy fw version(1)\n"
argument_list|)
expr_stmt|;
name|bxe_save_spirom_version
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|shmem_base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 2) read register 0xc200_0000 (SPI_FW_STATUS). */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA819
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA81A
argument_list|,
literal|0xc200
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA817
argument_list|,
literal|0x000A
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|100
condition|;
name|cnt
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA818
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
literal|1
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|100
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Unable to read 8481 phy fw version(2)\n"
argument_list|)
expr_stmt|;
name|bxe_save_spirom_version
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|shmem_base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Lower 16 bits of the register SPI_FW_STATUS. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA81B
argument_list|,
operator|&
name|fw_ver1
argument_list|)
expr_stmt|;
comment|/* Upper 16 bits of register SPI_FW_STATUS. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0xA81C
argument_list|,
operator|&
name|fw_ver2
argument_list|)
expr_stmt|;
name|bxe_save_spirom_version
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|shmem_base
argument_list|,
operator|(
name|fw_ver2
operator|<<
literal|16
operator|)
operator||
name|fw_ver1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bcm8072_external_rom_boot
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Need to wait 200ms after reset. */
name|msleep
argument_list|(
literal|200
argument_list|)
expr_stmt|;
comment|/* 	 * Boot port from external ROM. 	 * Set ser_boot_ctl bit in the MISC_CTRL1 register. 	 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL1
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* Reset internal microprocessor */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL_ROM_RESET_INTERNAL_MP
argument_list|)
expr_stmt|;
comment|/* Set micro reset = 0. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL_ROM_MICRO_RESET
argument_list|)
expr_stmt|;
comment|/* Reset internal microprocessor. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL_ROM_RESET_INTERNAL_MP
argument_list|)
expr_stmt|;
comment|/* Wait for 100ms for code download via SPI port. */
name|msleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Clear ser_boot_ctl bit. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL1
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* Wait 100ms. */
name|msleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|bxe_save_bcm_spirom_ver
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|params
operator|->
name|shmem_base
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This is only required for 8073A1, version 102 only. */
end_comment

begin_function
specifier|static
name|uint8_t
name|bxe_8073_is_snr_needed
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Read 8073 HW revision. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_CHIP_REV
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
literal|1
condition|)
block|{
comment|/* No need to workaround in 8073 A1. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER2
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
comment|/* SNR should be applied only for version 0x102. */
if|if
condition|(
name|val
operator|!=
literal|0x102
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_bcm8073_xaui_wa
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|cnt
decl_stmt|,
name|cnt1
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_CHIP_REV
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|0
condition|)
block|{
comment|/* No need to workaround in 8073 A1. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* XAUI workaround in 8073 A0: */
comment|/* 	 * After loading the boot ROM and restarting Autoneg, 	 * poll Dev1, Reg $C820: 	 */
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|1000
condition|;
name|cnt
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_SPEED_LINK_STATUS
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
comment|/* 		 * If bit [14] = 0 or bit [13] = 0, continue on with 		 * system initialization (XAUI work-around not required, 		 * as these bits indicate 2.5G or 1G link up). 		 */
if|if
condition|(
operator|!
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|14
operator|)
operator|)
operator|||
operator|!
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|13
operator|)
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XAUI work-around not required\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"clc bit 15 went off\n"
argument_list|)
expr_stmt|;
comment|/* 			 * If bit 15 is 0, then poll Dev1, Reg $C841 until 			 * it's MSB (bit 15) goes to 1 (indicating that the 			 * XAUI workaround has completed), then continue on 			 * with system initialization. 			 */
for|for
control|(
name|cnt1
operator|=
literal|0
init|;
name|cnt1
operator|<
literal|1000
condition|;
name|cnt1
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_XAUI_WA
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XAUI workaround has completed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|msleep
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|msleep
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Warning: XAUI work-around timeout !!!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bcm8073_bcm8727_external_rom_boot
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
comment|/* Boot port from external ROM.  */
comment|/* EDC grst */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* ucode reboot and rst. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
literal|0x008c
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL1
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* Reset internal microprocessor. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL_ROM_MICRO_RESET
argument_list|)
expr_stmt|;
comment|/* Release srst bit. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL_ROM_RESET_INTERNAL_MP
argument_list|)
expr_stmt|;
comment|/* Wait for 100ms for code download via SPI port. */
name|msleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Clear ser_boot_ctl bit. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL1
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bxe_save_bcm_spirom_ver
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bcm8073_external_rom_boot
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|bxe_bcm8073_bcm8727_external_rom_boot
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_addr
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bcm8727_external_rom_boot
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|bxe_bcm8073_bcm8727_external_rom_boot
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_addr
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bcm8726_external_rom_boot
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Need to wait 100ms after reset. */
name|msleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Set serial boot control for external load. */
comment|/* Micro controller re-boot. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
literal|0x018B
argument_list|)
expr_stmt|;
comment|/* Set soft reset. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL_ROM_MICRO_RESET
argument_list|)
expr_stmt|;
comment|/* Set PLL register value to be same like in P13 ver. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL1
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* 	 * Clear soft reset. 	 * Will automatically reset micro-controller re-boot. 	 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL_ROM_RESET_INTERNAL_MP
argument_list|)
expr_stmt|;
comment|/* Wait for 150ms for microcode load. */
name|msleep
argument_list|(
literal|150
argument_list|)
expr_stmt|;
comment|/* Disable serial boot control, tristates pins SS_N, SCK, MOSI, MISO. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL1
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|bxe_save_bcm_spirom_ver
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|params
operator|->
name|shmem_base
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_sfp_set_transmitter
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|,
name|uint8_t
name|tx_en
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting transmitter tx_en=%x for port %x\n"
argument_list|,
name|tx_en
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Disable/Enable transmitter ( TX laser of the SFP+ module.). */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_en
condition|)
name|val
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|15
operator|)
expr_stmt|;
else|else
name|val
operator||=
operator|(
literal|1
operator|<<
literal|15
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_8726_read_sfp_module_eeprom
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|byte_cnt
parameter_list|,
name|uint8_t
modifier|*
name|o_buf
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|i
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|byte_cnt
operator|>
literal|16
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Reading from eeprom is is limited to 0xf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
comment|/* Set the read command byte count. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_BYTE_CNT
argument_list|,
operator|(
name|byte_cnt
operator||
literal|0xa000
operator|)
argument_list|)
expr_stmt|;
comment|/* Set the read command address. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_MEM_ADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
comment|/* Activate read command. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL
argument_list|,
literal|0x2c0f
argument_list|)
expr_stmt|;
comment|/* Wait up to 500us for command complete status. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
operator|==
name|MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
operator|!=
name|MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Got bad status 0x%x when reading from SFP+ EEPROM\n"
argument_list|,
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
comment|/* Read the buffer. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|byte_cnt
condition|;
name|i
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8726_TWO_WIRE_DATA_BUF
operator|+
name|i
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|o_buf
index|[
name|i
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|val
operator|&
name|MDIO_PMA_REG_8726_TWO_WIRE_DATA_MASK
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
operator|==
name|MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_IDLE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_8727_read_sfp_module_eeprom
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|byte_cnt
parameter_list|,
name|uint8_t
modifier|*
name|o_buf
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|val
decl_stmt|,
name|i
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|byte_cnt
operator|>
literal|16
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Reading from eeprom is is limited to 0xf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
comment|/* Need to read from 1.8000 to clear it. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
comment|/* Set the read command byte count. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_BYTE_CNT
argument_list|,
operator|(
operator|(
name|byte_cnt
operator|<
literal|2
operator|)
condition|?
literal|2
else|:
name|byte_cnt
operator|)
argument_list|)
expr_stmt|;
comment|/* Set the read command address. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_MEM_ADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
comment|/* Set the destination address. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
literal|0x8004
argument_list|,
name|MDIO_PMA_REG_8727_TWO_WIRE_DATA_BUF
argument_list|)
expr_stmt|;
comment|/* Activate read command. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL
argument_list|,
literal|0x8002
argument_list|)
expr_stmt|;
comment|/* 	 * Wait appropriate time for two-wire command to finish before 	 * polling the status register. 	 */
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Wait up to 500us for command complete status. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
operator|==
name|MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
operator|!=
name|MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_COMPLETE
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Got bad status 0x%x when reading from SFP+ EEPROM\n"
argument_list|,
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
comment|/* Read the buffer. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|byte_cnt
condition|;
name|i
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_TWO_WIRE_DATA_BUF
operator|+
name|i
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|o_buf
index|[
name|i
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|val
operator|&
name|MDIO_PMA_REG_8727_TWO_WIRE_DATA_MASK
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|MDIO_PMA_REG_SFP_TWO_WIRE_CTRL_STATUS_MASK
operator|)
operator|==
name|MDIO_PMA_REG_SFP_TWO_WIRE_STATUS_IDLE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_read_sfp_module_eeprom
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|byte_cnt
parameter_list|,
name|uint8_t
modifier|*
name|o_buf
parameter_list|)
block|{
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
condition|)
return|return
operator|(
name|bxe_8726_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
name|addr
argument_list|,
name|byte_cnt
argument_list|,
name|o_buf
argument_list|)
operator|)
return|;
elseif|else
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
condition|)
return|return
operator|(
name|bxe_8727_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
name|addr
argument_list|,
name|byte_cnt
argument_list|,
name|o_buf
argument_list|)
operator|)
return|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_get_edc_mode
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
modifier|*
name|edc_mode
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|BXE_DEBUG
name|struct
name|bxe_softc
modifier|*
name|sc
init|=
name|params
operator|->
name|sc
decl_stmt|;
endif|#
directive|endif
name|uint8_t
name|copper_module_type
decl_stmt|;
name|uint8_t
name|options
index|[
name|SFP_EEPROM_OPTIONS_SIZE
index|]
decl_stmt|;
name|uint8_t
name|val
decl_stmt|,
name|check_limiting_mode
decl_stmt|;
name|check_limiting_mode
operator|=
literal|0
expr_stmt|;
operator|*
name|edc_mode
operator|=
name|EDC_MODE_LIMITING
expr_stmt|;
comment|/* First check for copper cable. */
if|if
condition|(
name|bxe_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
name|SFP_EEPROM_CON_TYPE_ADDR
argument_list|,
literal|1
argument_list|,
operator|&
name|val
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Failed to read from SFP+ module EEPROM\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
switch|switch
condition|(
name|val
condition|)
block|{
case|case
name|SFP_EEPROM_CON_TYPE_VAL_COPPER
case|:
comment|/* 		 * Check if its active cable( includes SFP+ module) 		 * of passive cable. 		 */
if|if
condition|(
name|bxe_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
name|SFP_EEPROM_FC_TX_TECH_ADDR
argument_list|,
literal|1
argument_list|,
operator|&
name|copper_module_type
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Failed to read copper-cable-type"
literal|" from SFP+ EEPROM\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|copper_module_type
operator|&
name|SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_ACTIVE
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Active Copper cable detected\n"
argument_list|)
expr_stmt|;
name|check_limiting_mode
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|copper_module_type
operator|&
name|SFP_EEPROM_FC_TX_TECH_BITMASK_COPPER_PASSIVE
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Passive Copper cable detected\n"
argument_list|)
expr_stmt|;
operator|*
name|edc_mode
operator|=
name|EDC_MODE_PASSIVE_DAC
expr_stmt|;
block|}
else|else
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Unknown copper-cable-type 0x%x !!!\n"
argument_list|,
name|copper_module_type
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
break|break;
case|case
name|SFP_EEPROM_CON_TYPE_VAL_LC
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Optic module detected\n"
argument_list|)
expr_stmt|;
name|check_limiting_mode
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Unable to determine module type 0x%x !!!\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|check_limiting_mode
condition|)
block|{
if|if
condition|(
name|bxe_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
name|SFP_EEPROM_OPTIONS_ADDR
argument_list|,
name|SFP_EEPROM_OPTIONS_SIZE
argument_list|,
name|options
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Failed to read Option"
literal|" field from module EEPROM\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|options
index|[
literal|0
index|]
operator|&
name|SFP_EEPROM_OPTIONS_LINEAR_RX_OUT_MASK
operator|)
condition|)
operator|*
name|edc_mode
operator|=
name|EDC_MODE_LINEAR
expr_stmt|;
else|else
operator|*
name|edc_mode
operator|=
name|EDC_MODE_LIMITING
expr_stmt|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"EDC mode is set to 0x%x\n"
argument_list|,
operator|*
name|edc_mode
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This function read the relevant field from the module ( SFP+ ),  * and verify it is compliant with this board.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|bxe_verify_sfp_module
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
init|=
name|params
operator|->
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* uint32_t fw_resp; */
name|char
name|vendor_name
index|[
name|SFP_EEPROM_VENDOR_NAME_SIZE
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|vendor_pn
index|[
name|SFP_EEPROM_PART_NO_SIZE
operator|+
literal|1
index|]
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_feature_config
index|[
name|params
operator|->
name|port
index|]
operator|.
name|config
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK
operator|)
operator|==
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_NO_ENFORCEMENT
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"NOT enforcing module verification\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Ask the FW to validate the module. */
if|if
condition|(
operator|!
operator|(
name|params
operator|->
name|feature_config_flags
operator|&
name|FEATURE_CONFIG_BC_SUPPORTS_OPT_MDL_VRFY
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"FW does not support OPT MDL verification\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
comment|/* Format the warning message. */
if|if
condition|(
name|bxe_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
name|SFP_EEPROM_VENDOR_NAME_ADDR
argument_list|,
name|SFP_EEPROM_VENDOR_NAME_SIZE
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|vendor_name
argument_list|)
condition|)
name|vendor_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
else|else
name|vendor_name
index|[
name|SFP_EEPROM_VENDOR_NAME_SIZE
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|bxe_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
name|SFP_EEPROM_PART_NO_ADDR
argument_list|,
name|SFP_EEPROM_PART_NO_SIZE
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|vendor_pn
argument_list|)
condition|)
name|vendor_pn
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
else|else
name|vendor_pn
index|[
name|SFP_EEPROM_PART_NO_SIZE
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"Warning: Unqualified SFP+ module detected on %s, "
literal|"Port %d from %s part number %s\n"
argument_list|,
name|sc
operator|->
name|name
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|vendor_name
argument_list|,
name|vendor_pn
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_bcm8726_set_limiting_mode
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
name|edc_mode
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|cur_limiting_mode
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER2
argument_list|,
operator|&
name|cur_limiting_mode
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Current Limiting mode is 0x%x\n"
argument_list|,
name|cur_limiting_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|edc_mode
operator|==
name|EDC_MODE_LIMITING
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting LIMITING MODE\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER2
argument_list|,
name|EDC_MODE_LIMITING
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* LRM mode ( default )*/
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting LRM MODE\n"
argument_list|)
expr_stmt|;
comment|/* 		 * Changing to LRM mode takes quite few seconds. 		 * So do it only if current mode is limiting 		 * ( default is LRM ). 		 */
if|if
condition|(
name|cur_limiting_mode
operator|!=
name|EDC_MODE_LIMITING
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LRM_MODE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER2
argument_list|,
literal|0x128
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL0
argument_list|,
literal|0x4008
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LRM_MODE
argument_list|,
literal|0xaaaa
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_bcm8727_set_limiting_mode
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint16_t
name|edc_mode
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|uint16_t
name|phy_identifier
decl_stmt|;
name|uint16_t
name|rom_ver2_val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|&
name|phy_identifier
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|(
name|phy_identifier
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER2
argument_list|,
operator|&
name|rom_ver2_val
argument_list|)
expr_stmt|;
comment|/* Keep the MSB 8-bits, and set the LSB 8-bits with the edc_mode. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER2
argument_list|,
operator|(
name|rom_ver2_val
operator|&
literal|0xff00
operator|)
operator||
operator|(
name|edc_mode
operator|&
literal|0x00ff
operator|)
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|(
name|phy_identifier
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_wait_for_sfp_module_initialized
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|timeout
decl_stmt|;
name|uint8_t
name|val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* 	 * Initialization time after hot-plug may take up to 300ms for some 	 * phys type ( e.g. JDSU ). 	 */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|60
condition|;
name|timeout
operator|++
control|)
block|{
if|if
condition|(
name|bxe_read_sfp_module_eeprom
argument_list|(
name|params
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
operator|&
name|val
argument_list|)
operator|==
literal|0
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SFP+ module initialization took %d ms\n"
argument_list|,
name|timeout
operator|*
literal|5
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|msleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Make sure GPIOs are not using for LED mode. */
end_comment

begin_function
specifier|static
name|void
name|bxe_8727_power_module
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|,
name|uint8_t
name|is_power_up
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
comment|/* 	 * In the GPIO register, bit 4 is use to detemine if the GPIOs are 	 * operating as INPUT or as OUTPUT. Bit 1 is for input, and 0 for 	 * output 	 * Bits 0-1 determine the gpios value for OUTPUT in case bit 4 val is 0 	 * Bits 8-9 determine the gpios value for INPUT in case bit 4 val is 1 	 * where the 1st bit is the over-current(only input), and 2nd bit is 	 * for power( only output ). 	 */
comment|/* 	 * In case of NOC feature is disabled and power is up, set GPIO control 	 *  as input to enable listening of over-current indication. 	 */
if|if
condition|(
operator|!
operator|(
name|params
operator|->
name|feature_config_flags
operator|&
name|FEATURE_CONFIG_BCM8727_NOC
operator|)
operator|&&
name|is_power_up
condition|)
name|val
operator|=
operator|(
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
else|else
comment|/* 		 * Set GPIO control to OUTPUT, and set the power bit 		 * to according to the is_power_up. 		 */
name|val
operator|=
operator|(
operator|(
operator|!
operator|(
name|is_power_up
operator|)
operator|)
operator|<<
literal|1
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_GPIO_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_sfp_module_detection
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|,
name|val
decl_stmt|;
name|uint16_t
name|edc_mode
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|rc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_feature_config
index|[
name|params
operator|->
name|port
index|]
operator|.
name|config
argument_list|)
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SFP+ module plugged in/out detected on port %d\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|bxe_get_edc_mode
argument_list|(
name|params
argument_list|,
operator|&
name|edc_mode
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Failed to get valid module type\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|bxe_verify_sfp_module
argument_list|(
name|params
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* Check SFP+ module compatibility. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Module verification failed!!\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
comment|/* Turn on fault module-detected led. */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_0
argument_list|,
name|MISC_REGISTERS_GPIO_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
operator|)
operator|&&
operator|(
operator|(
name|val
operator|&
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK
operator|)
operator|==
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_POWER_DOWN
operator|)
condition|)
block|{
comment|/* Shutdown SFP+ module. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Shutdown SFP+ module!!\n"
argument_list|)
expr_stmt|;
name|bxe_8727_power_module
argument_list|(
name|sc
argument_list|,
name|params
argument_list|,
name|ext_phy_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* Turn off fault module-detected led. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Turn off fault module-detected led\n"
argument_list|)
expr_stmt|;
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_0
argument_list|,
name|MISC_REGISTERS_GPIO_LOW
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
comment|/* Power up the SFP module. */
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
condition|)
name|bxe_8727_power_module
argument_list|(
name|sc
argument_list|,
name|params
argument_list|,
name|ext_phy_addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Check and set limiting mode / LRM mode on 8726. 	 * On 8727 it is done automatically. 	 */
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
condition|)
name|bxe_bcm8726_set_limiting_mode
argument_list|(
name|params
argument_list|,
name|edc_mode
argument_list|)
expr_stmt|;
else|else
name|bxe_bcm8727_set_limiting_mode
argument_list|(
name|params
argument_list|,
name|edc_mode
argument_list|)
expr_stmt|;
comment|/* 	 * Enable transmit for this module if the module is approved, or 	 * if unapproved modules should also enable the Tx laser. 	 */
if|if
condition|(
name|rc
operator|==
literal|0
operator|||
operator|(
name|val
operator|&
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK
operator|)
operator|!=
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_DISABLE_TX_LASER
condition|)
name|bxe_sfp_set_transmitter
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|bxe_sfp_set_transmitter
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bxe_handle_module_detect_int
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|,
name|gpio_val
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
comment|/* Set valid module led off. */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_0
argument_list|,
name|MISC_REGISTERS_GPIO_HIGH
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* Get current gpio val refelecting module plugged in / out. */
name|gpio_val
operator|=
name|bxe_get_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_3
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Call the handling function in case module is detected. */
if|if
condition|(
name|gpio_val
operator|==
literal|0
condition|)
block|{
name|bxe_set_gpio_int
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_3
argument_list|,
name|MISC_REGISTERS_GPIO_INT_OUTPUT_CLR
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|bxe_wait_for_sfp_module_initialized
argument_list|(
name|params
argument_list|)
operator|==
literal|0
condition|)
name|bxe_sfp_module_detection
argument_list|(
name|params
argument_list|)
expr_stmt|;
else|else
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SFP+ module is not initialized\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_feature_config
index|[
name|params
operator|->
name|port
index|]
operator|.
name|config
argument_list|)
argument_list|)
expr_stmt|;
name|bxe_set_gpio_int
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_3
argument_list|,
name|MISC_REGISTERS_GPIO_INT_OUTPUT_SET
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Module was plugged out. */
comment|/* Disable transmit for this module. */
if|if
condition|(
operator|(
name|val
operator|&
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK
operator|)
operator|==
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_DISABLE_TX_LASER
condition|)
name|bxe_sfp_set_transmitter
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bcm807x_force_10G
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Force KR or KX. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|0x2040
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_10G_CTRL2
argument_list|,
literal|0x000b
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_BCM_CTRL
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_bcm8073_set_xaui_low_power_mode
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_CHIP_REV
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
condition|)
block|{
comment|/* Mustn't set low power mode in 8073 A0. */
return|return;
block|}
comment|/* Disable PLL sequencer (use read-modify-write to clear bit 13). */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
name|MDIO_XS_PLL_SEQUENCER
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
name|MDIO_XS_PLL_SEQUENCER
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* PLL controls */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x805E
argument_list|,
literal|0x1077
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x805D
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x805C
argument_list|,
literal|0x030B
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x805B
argument_list|,
literal|0x1240
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x805A
argument_list|,
literal|0x2490
argument_list|)
expr_stmt|;
comment|/* Tx Controls */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x80A7
argument_list|,
literal|0x0C74
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x80A6
argument_list|,
literal|0x9041
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x80A5
argument_list|,
literal|0x4640
argument_list|)
expr_stmt|;
comment|/* Rx Controls */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x80FE
argument_list|,
literal|0x01C4
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x80FD
argument_list|,
literal|0x9249
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
literal|0x80FC
argument_list|,
literal|0x2015
argument_list|)
expr_stmt|;
comment|/* Enable PLL sequencer (use read-modify-write to set bit 13). */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
name|MDIO_XS_PLL_SEQUENCER
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
name|MDIO_XS_PLL_SEQUENCER
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_8073_set_pause_cl37
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|cl37_val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LD
argument_list|,
operator|&
name|cl37_val
argument_list|)
expr_stmt|;
name|cl37_val
operator|&=
operator|~
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
expr_stmt|;
comment|/* Please refer to Table 28B-3 of 802.3ab-1999 spec. */
if|if
condition|(
operator|(
name|vars
operator|->
name|ieee_fc
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_SYMMETRIC
operator|)
operator|==
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_SYMMETRIC
condition|)
name|cl37_val
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_SYMMETRIC
expr_stmt|;
if|if
condition|(
operator|(
name|vars
operator|->
name|ieee_fc
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC
operator|)
operator|==
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC
condition|)
name|cl37_val
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC
expr_stmt|;
if|if
condition|(
operator|(
name|vars
operator|->
name|ieee_fc
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
operator|)
operator|==
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
condition|)
name|cl37_val
operator||=
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Ext phy AN advertize cl37 0x%x\n"
argument_list|,
name|cl37_val
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LD
argument_list|,
name|cl37_val
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_ext_phy_set_pause
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Read modify write pause advertizing. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV_PAUSE
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|MDIO_AN_REG_ADV_PAUSE_BOTH
expr_stmt|;
comment|/* Please refer to Table 28B-3 of 802.3ab-1999 spec. */
if|if
condition|(
operator|(
name|vars
operator|->
name|ieee_fc
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC
operator|)
operator|==
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_ASYMMETRIC
condition|)
name|val
operator||=
name|MDIO_AN_REG_ADV_PAUSE_ASYMMETRIC
expr_stmt|;
if|if
condition|(
operator|(
name|vars
operator|->
name|ieee_fc
operator|&
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
operator|)
operator|==
name|MDIO_COMBO_IEEE0_AUTO_NEG_ADV_PAUSE_BOTH
condition|)
name|val
operator||=
name|MDIO_AN_REG_ADV_PAUSE_PAUSE
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Ext phy AN advertize 0x%x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV_PAUSE
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_preemphasis
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
init|=
name|params
operator|->
name|sc
decl_stmt|;
name|uint16_t
name|bank
decl_stmt|,
name|i
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
for|for
control|(
name|bank
operator|=
name|MDIO_REG_BANK_RX0
operator|,
name|i
operator|=
literal|0
init|;
name|bank
operator|<=
name|MDIO_REG_BANK_RX3
condition|;
name|bank
operator|+=
operator|(
name|MDIO_REG_BANK_RX1
operator|-
name|MDIO_REG_BANK_RX0
operator|)
operator|,
name|i
operator|++
control|)
block|{
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|bank
argument_list|,
name|MDIO_RX0_RX_EQ_BOOST
argument_list|,
name|params
operator|->
name|xgxs_config_rx
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|bank
operator|=
name|MDIO_REG_BANK_TX0
operator|,
name|i
operator|=
literal|0
init|;
name|bank
operator|<=
name|MDIO_REG_BANK_TX3
condition|;
name|bank
operator|+=
operator|(
name|MDIO_REG_BANK_TX1
operator|-
name|MDIO_REG_BANK_TX0
operator|)
operator|,
name|i
operator|++
control|)
block|{
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|bank
argument_list|,
name|MDIO_TX0_TX_DRIVER
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_8481_set_led4
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* PHYC_CTL_LED_CTL */
comment|/* Enable continous signal to go active on link. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LINK_SIGNAL
argument_list|,
literal|0xa482
argument_list|)
expr_stmt|;
comment|/* Unmask LED4 for 10G link. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_SIGNAL_MASK
argument_list|,
operator|(
literal|1
operator|<<
literal|6
operator|)
argument_list|)
expr_stmt|;
comment|/* Unmask LED4 for 10G link. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
literal|0xFFFB
argument_list|,
literal|0xFFFD
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_8481_set_legacy_led_mode
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* 	 * LED1 (10G Link): Disable LED1 when 10/100/1000 link. 	 * LED2 (1G/100/10 Link): Enable LED2 when 10/100/1000 link). 	 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_SHADOW
argument_list|,
operator|(
literal|1
operator|<<
literal|15
operator|)
operator||
operator|(
literal|0xd
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0xc
operator|<<
literal|4
operator|)
operator||
literal|0xe
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_8481_set_10G_led_mode
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint32_t
name|ext_phy_type
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|val1
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
comment|/* 	 * LED1 (10G Link) 	 * Enable continuse based on source 7(10G-link). 	 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LINK_SIGNAL
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
comment|/* Set bit 2 to 0, and bits [1:0] to 10. */
name|val1
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|0
operator|)
operator||
operator|(
literal|1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
expr_stmt|;
comment|/* Clear bits 0,2,7*/
name|val1
operator||=
operator|(
operator|(
literal|1
operator|<<
literal|1
operator|)
operator||
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
comment|/* Set bit 1, 6 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LINK_SIGNAL
argument_list|,
name|val1
argument_list|)
expr_stmt|;
comment|/* Unmask LED1 for 10G link. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LED1_MASK
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
comment|/* Set bit 2 to 0, and bits [1:0] to 10. */
name|val1
operator||=
operator|(
literal|1
operator|<<
literal|7
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LED1_MASK
argument_list|,
name|val1
argument_list|)
expr_stmt|;
comment|/* 	 * LED2 (1G/100/10G Link). 	 * Mask LED2 for 10G link. 	 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LED2_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Unmask LED3 for 10G link. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LED3_MASK
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_LED3_BLINK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_init_internal_phy
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|enable_cl73
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_SGMII_FLAG
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
operator|)
operator|&&
operator|(
name|params
operator|->
name|feature_config_flags
operator|&
name|FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED
operator|)
condition|)
name|bxe_set_preemphasis
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* Forced speed requested? */
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|!=
name|SPEED_AUTO_NEG
operator|||
operator|(
operator|(
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
operator|)
operator|&&
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_EXT
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"not SGMII, no AN\n"
argument_list|)
expr_stmt|;
comment|/* Disable autoneg. */
name|bxe_set_autoneg
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Program speed and duplex. */
name|bxe_program_serdes
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* AN_mode */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"not SGMII, AN\n"
argument_list|)
expr_stmt|;
comment|/* AN enabled. */
name|bxe_set_brcm_cl37_advertisment
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* Program duplex& pause advertisement (for aneg). */
name|bxe_set_ieee_aneg_advertisment
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|ieee_fc
argument_list|)
expr_stmt|;
comment|/* Enable autoneg. */
name|bxe_set_autoneg
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|enable_cl73
argument_list|)
expr_stmt|;
comment|/* Enable and restart AN. */
name|bxe_restart_autoneg
argument_list|(
name|params
argument_list|,
name|enable_cl73
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* SGMII mode */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SGMII\n"
argument_list|)
expr_stmt|;
name|bxe_initialize_sgmii_process
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_ext_phy_init
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|cnt
decl_stmt|,
name|ctrl
decl_stmt|,
name|reg
decl_stmt|,
name|val
decl_stmt|;
name|uint16_t
name|fw_ver1
decl_stmt|,
name|fw_ver2
decl_stmt|;
name|uint16_t
name|lasi_ctrl_val
decl_stmt|,
name|rx_alarm_ctrl_val
decl_stmt|,
name|tmp1
decl_stmt|;
name|uint16_t
name|mod_abs
decl_stmt|,
name|phy_ver
decl_stmt|;
name|uint16_t
name|autoneg_val
decl_stmt|,
name|an_1000_val
decl_stmt|,
name|an_10_100_val
decl_stmt|;
name|uint16_t
name|autoneg_ctrl
decl_stmt|,
name|pma_ctrl
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ctrl
operator|=
literal|0
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* 		 * Make sure that the soft reset is off (expect for the 8072: 		 * due to the lock, it will be done inside the specific 		 * handling). 		 */
if|if
condition|(
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
operator|)
condition|)
block|{
comment|/* Wait for soft reset to get cleared upto 1 sec. */
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|1000
condition|;
name|cnt
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
operator|&
name|ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctrl
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
condition|)
break|break;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"control reg 0x%x (after %d ms)\n"
argument_list|,
name|ctrl
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
case|:
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8705\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_MISC_CTRL
argument_list|,
literal|0x8288
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
literal|0x7fbf
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CMU_PLL_BYPASS
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_WIS_DEVAD
argument_list|,
name|MDIO_WIS_REG_LASI_CNTL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
comment|/* BCM8705 doesn't have microcode, hence the 0. */
name|bxe_save_spirom_version
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|shmem_base
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706
case|:
comment|/* Wait until fw is loaded. */
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|100
condition|;
name|cnt
operator|++
control|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER1
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
break|break;
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8706 is initialized after %d ms\n"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|feature_config_flags
operator|&
name|FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|MDIO_XS_8706_REG_BANK_RX0
operator|+
name|i
operator|*
operator|(
name|MDIO_XS_8706_REG_BANK_RX1
operator|-
name|MDIO_XS_8706_REG_BANK_RX0
operator|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
name|reg
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
comment|/* Clear first 3 bits of the control. */
name|val
operator|&=
operator|~
literal|0x7
expr_stmt|;
comment|/* 					 * Set control bits according to 					 * configuation. 					 */
name|val
operator||=
operator|(
name|params
operator|->
name|xgxs_config_rx
index|[
name|i
index|]
operator|&
literal|0x7
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting RX Equalizer to BCM8706 reg 0x%x<-- val 0x%x\n"
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Force speed */
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_10000
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8706 force 10Gbps\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_DIGITAL_CTRL
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * Force 1Gbps using autoneg with 1G 				 * advertisment. 				 */
comment|/* Allow CL37 through CL73. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8706 AutoNeg\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_CL73
argument_list|,
literal|0x040c
argument_list|)
expr_stmt|;
comment|/* Enable Full-Duplex advertisment on CL37. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LP
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
comment|/* Enable CL37 AN. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_AN
argument_list|,
literal|0x1000
argument_list|)
expr_stmt|;
comment|/* 1G support */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV
argument_list|,
operator|(
literal|1
operator|<<
literal|5
operator|)
argument_list|)
expr_stmt|;
comment|/* Enable clause 73 AN. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
literal|0x1200
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM_CTRL
argument_list|,
literal|0x0400
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
block|}
name|bxe_save_bcm_spirom_ver
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|params
operator|->
name|shmem_base
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Initializing BCM8726\n"
argument_list|)
expr_stmt|;
name|bxe_bcm8726_external_rom_boot
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* 			 * Need to call module detected on initialization since 			 * the module detection triggered by actual module 			 * insertion might occur before driver is loaded, and 			 * when driver is loaded, it reset all registers, 			 * including the transmitter. 			 */
name|bxe_sfp_module_detection
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* Set Flow control */
name|bxe_ext_phy_set_pause
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_1000
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 1G force\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_10G_CTRL2
argument_list|,
literal|0xD
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
literal|0x5
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM_CTRL
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
operator|)
operator|&&
operator|(
operator|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_1G
operator|)
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 1G clause37 \n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_CL73
argument_list|,
literal|0x040c
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LD
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_AN
argument_list|,
literal|0x1000
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
literal|0x1200
argument_list|)
expr_stmt|;
comment|/* 				 * Enable RX-ALARM control to receive 				 * interrupt for 1G speed change. 				 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM_CTRL
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Default 10G. Set only LASI control */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Set TX PreEmphasis if needed. */
if|if
condition|(
operator|(
name|params
operator|->
name|feature_config_flags
operator|&
name|FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting TX_CTRL1 0x%x, TX_CTRL2 0x%x\n"
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|0
index|]
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8726_TX_CTRL1
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8726_TX_CTRL2
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
condition|)
block|{
name|rx_alarm_ctrl_val
operator|=
literal|0x400
expr_stmt|;
name|lasi_ctrl_val
operator|=
literal|0x0004
expr_stmt|;
block|}
else|else
block|{
name|rx_alarm_ctrl_val
operator|=
operator|(
literal|1
operator|<<
literal|2
operator|)
expr_stmt|;
name|lasi_ctrl_val
operator|=
literal|0x0004
expr_stmt|;
block|}
comment|/* Enable LASI. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM_CTRL
argument_list|,
name|rx_alarm_ctrl_val
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
name|lasi_ctrl_val
argument_list|)
expr_stmt|;
name|bxe_8073_set_pause_cl37
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
condition|)
name|bxe_bcm8072_external_rom_boot
argument_list|(
name|params
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* 				 * In case of 8073 with long xaui lines, 				 * don't set the 8073 xaui low power. 				 */
name|bxe_bcm8073_set_xaui_low_power_mode
argument_list|(
name|params
argument_list|)
expr_stmt|;
block|}
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_M8051_MSGOUT_REG
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Before rom RX_ALARM(port1):0x%x\n"
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
comment|/* 			 * If this is forced speed, set to KR or KX 			 * (all other are not supported). 			 */
if|if
condition|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_EXT
condition|)
block|{
name|bxe_bcm807x_force_10G
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Forced speed 10G on 807X\n"
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_BCM_CTRL
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|!=
name|SPEED_AUTO_NEG
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_10000
condition|)
name|val
operator|=
operator|(
literal|1
operator|<<
literal|7
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_2500
condition|)
block|{
name|val
operator|=
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
comment|/* 					 * Note that 2.5G works only 					 * when used with 1G advertisment. 					 */
block|}
else|else
name|val
operator|=
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10G
condition|)
name|val
operator||=
operator|(
literal|1
operator|<<
literal|7
operator|)
expr_stmt|;
comment|/* 				 * Note that 2.5G works only when 				 * used with 1G advertisment. 				 */
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
operator|(
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_1G
operator||
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_2_5G
operator|)
condition|)
name|val
operator||=
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"807x autoneg val = 0x%x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
condition|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8073_2_5G
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_2_5G
operator|)
operator|&&
operator|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
operator|)
operator|)
operator|||
operator|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_2500
operator|)
condition|)
block|{
comment|/* Allow 2.5G for A1 and above. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_CHIP_REV
argument_list|,
operator|&
name|phy_ver
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Add 2.5G\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy_ver
operator|>
literal|0
condition|)
name|tmp1
operator||=
literal|1
expr_stmt|;
else|else
name|tmp1
operator|&=
literal|0xfffe
expr_stmt|;
block|}
else|else
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Disable 2.5G\n"
argument_list|)
expr_stmt|;
name|tmp1
operator|&=
literal|0xfffe
expr_stmt|;
block|}
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8073_2_5G
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
block|}
comment|/* Add support for CL37 (passive mode) II. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LD
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_FC_LD
argument_list|,
operator|(
name|tmp1
operator||
operator|(
operator|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
operator|)
condition|?
literal|0x20
else|:
literal|0x40
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Add support for CL37 (passive mode) III. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_AN
argument_list|,
literal|0x1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
condition|)
block|{
comment|/* 				 * The SNR will improve about 2db by changing 				 * BW and FEE main tap. Rest commands are 				 * executed after link is up. 				 */
comment|/* 				 * Change FFE main cursor to 5 in EDC register. 				 */
if|if
condition|(
name|bxe_8073_is_snr_needed
argument_list|(
name|params
argument_list|)
condition|)
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_EDC_FFE_MAIN
argument_list|,
literal|0xFB0C
argument_list|)
expr_stmt|;
comment|/* 				 * Enable FEC (Forware Error Correction) 				 * Request in the AN. 				 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV2
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
name|tmp1
operator||=
operator|(
literal|1
operator|<<
literal|15
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_ADV2
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
block|}
name|bxe_ext_phy_set_pause
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
comment|/* Restart autoneg. */
name|msleep
argument_list|(
literal|500
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
literal|0x1200
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"807x Autoneg Restart: "
literal|"Advertise 1G=%x, 10G=%x\n"
argument_list|,
operator|(
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
operator|>
literal|0
operator|)
argument_list|,
operator|(
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
operator|)
operator|>
literal|0
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
comment|/* Enable PMD link, MOD_ABS_FLT, and 1G link alarm. */
name|rx_alarm_ctrl_val
operator|=
operator|(
literal|1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
name|lasi_ctrl_val
operator|=
literal|0x0004
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Initializing BCM8727\n"
argument_list|)
expr_stmt|;
comment|/* Enable LASI. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM_CTRL
argument_list|,
name|rx_alarm_ctrl_val
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
name|lasi_ctrl_val
argument_list|)
expr_stmt|;
comment|/* 			 * Initially configure  MOD_ABS to interrupt when 			 * module is presence( bit 8). 			 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|&
name|mod_abs
argument_list|)
expr_stmt|;
comment|/* 			 * Set EDC off by setting OPTXLOS signal input to low 			 * (bit 9). When the EDC is off it locks onto a 			 * reference clock and avoids becoming 'lost'. 			 */
name|mod_abs
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
name|mod_abs
argument_list|)
expr_stmt|;
comment|/* Make MOD_ABS give interrupt on change. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_PCS_OPT_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
literal|1
operator|<<
literal|12
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_PCS_OPT_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* 			 * Set 8727 GPIOs to input to allow reading from the 			 * 8727 GPIO0 status which reflect SFP+ module 			 * over-current. 			 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_PCS_OPT_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator|&=
literal|0xff8f
expr_stmt|;
comment|/* Reset bits 4-6 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_PCS_OPT_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|bxe_8727_power_module
argument_list|(
name|sc
argument_list|,
name|params
argument_list|,
name|ext_phy_addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bxe_bcm8073_set_xaui_low_power_mode
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_M8051_MSGOUT_REG
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
comment|/* Set option 1G speed. */
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_1000
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 1G force\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_10G_CTRL2
argument_list|,
literal|0xD
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_10G_CTRL2
argument_list|,
operator|&
name|tmp1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"1.7 = 0x%x \n"
argument_list|,
name|tmp1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
operator|)
operator|&&
operator|(
operator|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_1G
operator|)
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 1G clause37 \n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_MISC_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CL37_AN
argument_list|,
literal|0x1300
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * Since the 8727 has only single reset pin, 				 * need to set the 10G registers although it 				 * is default. 				 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
literal|0x7
argument_list|,
literal|0x0100
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|0x2040
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_10G_CTRL2
argument_list|,
literal|0x0008
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * Set 2-wire transfer rate to 400Khz since 100Khz 			 * is not operational. 			 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_TWO_WIRE_SLAVE_ADDR
argument_list|,
literal|0xa101
argument_list|)
expr_stmt|;
comment|/* Set TX PreEmphasis if needed. */
if|if
condition|(
operator|(
name|params
operator|->
name|feature_config_flags
operator|&
name|FEATURE_CONFIG_OVERRIDE_PREEMPHASIS_ENABLED
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting TX_CTRL1 0x%x, TX_CTRL2 0x%x\n"
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|0
index|]
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_TX_CTRL1
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_TX_CTRL2
argument_list|,
name|params
operator|->
name|xgxs_config_tx
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting the SFX7101 LASI indication\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_CTRL
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting the SFX7101 LED to blink on traffic\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_7107_LED_CNTL
argument_list|,
operator|(
literal|1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|bxe_ext_phy_set_pause
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
comment|/* Restart autoneg. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|val
operator||=
literal|0x200
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Save spirom version. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_7101_VER1
argument_list|,
operator|&
name|fw_ver1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_7101_VER2
argument_list|,
operator|&
name|fw_ver2
argument_list|)
expr_stmt|;
name|bxe_save_spirom_version
argument_list|(
name|params
operator|->
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|shmem_base
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fw_ver1
operator|<<
literal|16
operator||
name|fw_ver2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
case|:
comment|/* 			 * This phy uses the NIG latch mechanism since link 			 * indication arrives through its LED4 and not via 			 * its LASI signal, so we get steady signal 			 * instead of clear on read. 			 */
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LATCH_BC_0
operator|+
name|params
operator|->
name|port
operator|*
literal|4
argument_list|,
literal|1
operator|<<
name|NIG_LATCH_BC_ENABLE_MI_INT
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bxe_8481_set_led4
argument_list|(
name|params
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
condition|)
block|{
comment|/* Set 1000 speed advertisement. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_1000T_CTRL
argument_list|,
operator|&
name|an_1000_val
argument_list|)
expr_stmt|;
name|bxe_ext_phy_set_pause
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_1G
condition|)
block|{
name|an_1000_val
operator||=
operator|(
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
condition|)
name|an_1000_val
operator||=
operator|(
literal|1
operator|<<
literal|9
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Advertising 1G\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|an_1000_val
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_1000T_CTRL
argument_list|,
name|an_1000_val
argument_list|)
expr_stmt|;
comment|/* Set 100 speed advertisement. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_AN_ADV
argument_list|,
operator|&
name|an_10_100_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
operator|(
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_FULL
operator||
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_100M_HALF
operator|)
condition|)
block|{
name|an_10_100_val
operator||=
operator|(
literal|1
operator|<<
literal|7
operator|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
condition|)
name|an_10_100_val
operator||=
operator|(
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Advertising 100M\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|an_10_100_val
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|7
operator|)
operator||
operator|(
literal|1
operator|<<
literal|8
operator|)
operator|)
expr_stmt|;
comment|/* Set 10 speed advertisement. */
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
operator|(
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_FULL
operator||
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_HALF
operator|)
condition|)
block|{
name|an_10_100_val
operator||=
operator|(
literal|1
operator|<<
literal|5
operator|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
condition|)
name|an_10_100_val
operator||=
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Advertising 10M\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|an_10_100_val
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|1
operator|<<
literal|6
operator|)
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_AN_ADV
argument_list|,
name|an_10_100_val
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_MII_CTRL
argument_list|,
operator|&
name|autoneg_val
argument_list|)
expr_stmt|;
comment|/* Disable forced speed. */
name|autoneg_val
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|6
operator||
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
comment|/* 				 * Enable autoneg and restart autoneg 				 * for legacy speeds. 				 */
name|autoneg_val
operator||=
operator|(
literal|1
operator|<<
literal|9
operator||
literal|1
operator|<<
literal|12
operator|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
condition|)
name|autoneg_val
operator||=
operator|(
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
else|else
name|autoneg_val
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_MII_CTRL
argument_list|,
name|autoneg_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|speed_cap_mask
operator|&
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10G
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Advertising 10G\n"
argument_list|)
expr_stmt|;
comment|/* Restart autoneg for 10G */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Force speed */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_MII_CTRL
argument_list|,
operator|&
name|autoneg_ctrl
argument_list|)
expr_stmt|;
comment|/* Disable autoneg. */
name|autoneg_ctrl
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|12
operator|)
expr_stmt|;
comment|/* Set 1000 force. */
switch|switch
condition|(
name|params
operator|->
name|req_line_speed
condition|)
block|{
case|case
name|SPEED_10000
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Unable to set 10G force !\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPEED_1000
case|:
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
operator|&
name|pma_ctrl
argument_list|)
expr_stmt|;
name|autoneg_ctrl
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
name|autoneg_ctrl
operator||=
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|pma_ctrl
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
name|pma_ctrl
operator||=
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 1000M force\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
name|pma_ctrl
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPEED_100
case|:
name|autoneg_ctrl
operator||=
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
name|autoneg_ctrl
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 100M force\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SPEED_10
case|:
name|autoneg_ctrl
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
name|autoneg_ctrl
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 10M force\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Duplex mode */
if|if
condition|(
name|params
operator|->
name|req_duplex
operator|==
name|DUPLEX_FULL
condition|)
block|{
name|autoneg_ctrl
operator||=
operator|(
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting full duplex\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|autoneg_ctrl
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* Update autoneg ctrl and pma ctrl. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_LEGACY_MII_CTRL
argument_list|,
name|autoneg_ctrl
argument_list|)
expr_stmt|;
block|}
comment|/* Save spirom version. */
name|bxe_save_8481_spirom_version
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_addr
argument_list|,
name|params
operator|->
name|shmem_base
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS PHY Failure detected 0x%x\n"
argument_list|,
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BAD XGXS ext_phy_config 0x%x\n"
argument_list|,
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
comment|/* SerDes */
name|ext_phy_type
operator|=
name|SERDES_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_DIRECT
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes Direct\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_BCM5482
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes 5482\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BAD SerDes ext_phy_config 0x%x\n"
argument_list|,
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_8727_handle_mod_abs
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|uint16_t
name|mod_abs
decl_stmt|,
name|rx_alarm_status
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_feature_config
index|[
name|params
operator|->
name|port
index|]
operator|.
name|config
argument_list|)
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|&
name|mod_abs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mod_abs
operator|&
operator|(
literal|1
operator|<<
literal|8
operator|)
condition|)
block|{
comment|/* Module is absent. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"MOD_ABS indication show module is absent\n"
argument_list|)
expr_stmt|;
comment|/* 		 * 1. Set mod_abs to detect next module presence event 		 * 2. Set EDC off by setting OPTXLOS signal input to low 		 *    (bit 9). 		 *    When the EDC is off it locks onto a reference clock and 		 *    avoids becoming 'lost'. 		 */
name|mod_abs
operator|&=
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
name|mod_abs
argument_list|)
expr_stmt|;
comment|/* 		 * Clear RX alarm since it stays up as long as 		 * the mod_abs wasn't changed. 		 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|rx_alarm_status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Module is present. */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"MOD_ABS indication show module is present\n"
argument_list|)
expr_stmt|;
comment|/* 		 * First thing, disable transmitter, and if the 		 * module is ok, the module_detection will enable 		 * it. */
comment|/* 		 * 1. Set mod_abs to detect next module absent event ( bit 8) 		 * 2. Restore the default polarity of the OPRXLOS signal and 		 *    this signal will then correctly indicate the presence or 		 *    absence of the Rx signal. (bit 9) 		 */
name|mod_abs
operator||=
operator|(
operator|(
literal|1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
name|mod_abs
argument_list|)
expr_stmt|;
comment|/* 		 * Clear RX alarm since it stays up as long as the mod_abs 		 * wasn't changed. This is need to be done before calling 		 * the module detection, otherwise it will clear the link 		 * update alarm. 		 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|rx_alarm_status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK
operator|)
operator|==
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_DISABLE_TX_LASER
condition|)
name|bxe_sfp_set_transmitter
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bxe_wait_for_sfp_module_initialized
argument_list|(
name|params
argument_list|)
operator|==
literal|0
condition|)
name|bxe_sfp_module_detection
argument_list|(
name|params
argument_list|)
expr_stmt|;
else|else
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SFP+ module is not initialized\n"
argument_list|)
expr_stmt|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8727 RX_ALARM_STATUS 0x%x\n"
argument_list|,
name|rx_alarm_status
argument_list|)
expr_stmt|;
comment|/* No need to check link status in case of module plugged in/out. */
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_ext_phy_is_link_up
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|is_mi_int
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|val1
decl_stmt|,
name|val2
decl_stmt|;
name|uint16_t
name|rx_sd
decl_stmt|,
name|pcs_status
decl_stmt|;
name|uint16_t
name|link_status
decl_stmt|;
name|uint16_t
name|rx_alarm_status
decl_stmt|;
name|uint16_t
name|an1000_status
decl_stmt|;
name|uint16_t
name|legacy_status
decl_stmt|,
name|legacy_speed
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|ext_phy_link_up
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|val1
operator|=
literal|0
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS Direct\n"
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8705\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_WIS_DEVAD
argument_list|,
name|MDIO_WIS_REG_LASI_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8705 LASI status 0x%x\n"
argument_list|,
name|val1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_WIS_DEVAD
argument_list|,
name|MDIO_WIS_REG_LASI_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8705 LASI status 0x%x\n"
argument_list|,
name|val1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_SD
argument_list|,
operator|&
name|rx_sd
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
literal|1
argument_list|,
literal|0xc809
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
literal|1
argument_list|,
literal|0xc809
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8705 1.c809 val=0x%x\n"
argument_list|,
name|val1
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
operator|(
operator|(
name|rx_sd
operator|&
literal|0x1
operator|)
operator|&&
operator|(
name|val1
operator|&
operator|(
literal|1
operator|<<
literal|9
operator|)
operator|)
operator|&&
operator|(
operator|(
name|val1
operator|&
operator|(
literal|1
operator|<<
literal|8
operator|)
operator|)
operator|==
literal|0
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ext_phy_link_up
condition|)
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 8706/8726\n"
argument_list|)
expr_stmt|;
comment|/* Clear RX Alarm. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
comment|/* Clear LASI indication. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8706/8726 LASI status 0x%x-->0x%x\n"
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_SD
argument_list|,
operator|&
name|rx_sd
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PCS_DEVAD
argument_list|,
name|MDIO_PCS_REG_STATUS
argument_list|,
operator|&
name|pcs_status
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_LINK_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_LINK_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8706/8726 rx_sd 0x%x "
literal|"pcs_status 0x%x 1Gbps link_status 0x%x\n"
argument_list|,
name|rx_sd
argument_list|,
name|pcs_status
argument_list|,
name|val2
argument_list|)
expr_stmt|;
comment|/* 			 * Link is up if both bit 0 of pmd_rx_sd and bit 0 			 * of pcs_status are set, or if the autoneg bit 1 			 * is set. 			 */
name|ext_phy_link_up
operator|=
operator|(
operator|(
name|rx_sd
operator|&
name|pcs_status
operator|&
literal|0x1
operator|)
operator|||
operator|(
name|val2
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ext_phy_link_up
condition|)
block|{
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
condition|)
block|{
comment|/* 					 * If transmitter is disabled, 					 * ignore false link up indication. 					 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
if|if
condition|(
name|val1
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Tx is disabled\n"
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|val2
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
condition|)
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_1000
expr_stmt|;
else|else
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
name|link_status
operator|=
literal|0
expr_stmt|;
comment|/* Check the LASI. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|rx_alarm_status
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8727 RX_ALARM_STATUS 0x%x\n"
argument_list|,
name|rx_alarm_status
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8727 LASI status 0x%x\n"
argument_list|,
name|val1
argument_list|)
expr_stmt|;
comment|/* Clear MSG-OUT */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_M8051_MSGOUT_REG
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
comment|/* 			 * If a module is present and there is need to check 			 * for over current. 			 */
if|if
condition|(
operator|!
operator|(
name|params
operator|->
name|feature_config_flags
operator|&
name|FEATURE_CONFIG_BCM8727_NOC
operator|)
operator|&&
operator|!
operator|(
name|rx_alarm_status
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
operator|)
condition|)
block|{
comment|/* Check over-current using 8727 GPIO0 input. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8727_GPIO_CTRL
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val1
operator|&
operator|(
literal|1
operator|<<
literal|8
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8727 Power fault has been detected on port %d\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Error: Power fault on %s Port %d has been detected "
literal|"and the power to that SFP+ module has been removed "
literal|"to prevent failure of the card. Please remove the "
literal|"SFP+ module and restart the system to clear this "
literal|"error.\n"
argument_list|,
name|sc
operator|->
name|name
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* 					 * Disable all RX_ALARMs except for 					 * mod_abs. 					 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM_CTRL
argument_list|,
operator|(
literal|1
operator|<<
literal|5
operator|)
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
comment|/* Wait for module_absent_event. */
name|val1
operator||=
operator|(
literal|1
operator|<<
literal|8
operator|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
name|val1
argument_list|)
expr_stmt|;
comment|/* Clear RX alarm. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|rx_alarm_status
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Over current check */
comment|/* When module absent bit is set, check module. */
if|if
condition|(
name|rx_alarm_status
operator|&
operator|(
literal|1
operator|<<
literal|5
operator|)
condition|)
block|{
name|bxe_8727_handle_mod_abs
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* 				 * Enable all mod_abs and link detection bits. 				 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM_CTRL
argument_list|,
operator|(
operator|(
literal|1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * If transmitter is disabled, ignore false link 			 * up indication. 			 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PHY_IDENTIFIER
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
if|if
condition|(
name|val1
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Tx is disabled\n"
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_SPEED_LINK_STATUS
argument_list|,
operator|&
name|link_status
argument_list|)
expr_stmt|;
comment|/* 			 * Bits 0..2 --> speed detected, 			 * bits 13..15--> link is down 			 */
if|if
condition|(
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
operator|)
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|13
operator|)
operator|)
operator|)
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_1000
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link up in 1G\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link is down\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
name|link_status
operator|=
literal|0
expr_stmt|;
name|an1000_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
condition|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PCS_DEVAD
argument_list|,
name|MDIO_PCS_REG_LASI_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PCS_DEVAD
argument_list|,
name|MDIO_PCS_REG_LASI_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"870x LASI status 0x%x->0x%x\n"
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 				 * In 8073, port1 is directed through emac0 and 				 * port0 is directed through emac1. 				 */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8703 LASI status 0x%x\n"
argument_list|,
name|val1
argument_list|)
expr_stmt|;
block|}
comment|/* Clear the interrupt LASI status register. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PCS_DEVAD
argument_list|,
name|MDIO_PCS_REG_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PCS_DEVAD
argument_list|,
name|MDIO_PCS_REG_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"807x PCS status 0x%x->0x%x\n"
argument_list|,
name|val2
argument_list|,
name|val1
argument_list|)
expr_stmt|;
comment|/* Clear MSG-OUT. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_M8051_MSGOUT_REG
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
comment|/* Check the LASI. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_RX_ALARM
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"KR 0x9003 0x%x\n"
argument_list|,
name|val2
argument_list|)
expr_stmt|;
comment|/* Check the link status. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PCS_DEVAD
argument_list|,
name|MDIO_PCS_REG_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"KR PCS status 0x%x\n"
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
operator|(
operator|(
name|val1
operator|&
literal|4
operator|)
operator|==
literal|4
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"PMA_REG_STATUS=0x%x\n"
argument_list|,
name|val1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
condition|)
block|{
if|if
condition|(
name|ext_phy_link_up
operator|&&
operator|(
operator|(
name|params
operator|->
name|req_line_speed
operator|!=
name|SPEED_10000
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|bxe_bcm8073_xaui_wa
argument_list|(
name|params
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_LINK_STATUS
argument_list|,
operator|&
name|an1000_status
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_LINK_STATUS
argument_list|,
operator|&
name|an1000_status
argument_list|)
expr_stmt|;
comment|/* Check the link status on 1.1.2. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"KR PMA status 0x%x->0x%x, an_link_status=0x%x\n"
argument_list|,
name|val2
argument_list|,
name|val1
argument_list|,
name|an1000_status
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
operator|(
operator|(
operator|(
name|val1
operator|&
literal|4
operator|)
operator|==
literal|4
operator|)
operator|||
operator|(
name|an1000_status
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ext_phy_link_up
operator|&&
name|bxe_8073_is_snr_needed
argument_list|(
name|params
argument_list|)
condition|)
block|{
comment|/* 					 * The SNR will improve about 2dbby 					 * changing the BW and FEE main tap. 					 * 					 * The 1st write to change FFE main 					 * tap is set before restart AN. 					 * Change PLL Bandwidth in EDC 					 * register. 					 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_PLL_BANDWIDTH
argument_list|,
literal|0x26BC
argument_list|)
expr_stmt|;
comment|/* 					 * Change CDR Bandwidth in EDC register. 					  */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CDR_BANDWIDTH
argument_list|,
literal|0x0333
argument_list|)
expr_stmt|;
block|}
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8073_SPEED_LINK_STATUS
argument_list|,
operator|&
name|link_status
argument_list|)
expr_stmt|;
comment|/* 				 * Bits 0..2 --> speed detected, 				 * bits 13..15--> link is down 				 */
if|if
condition|(
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
operator|)
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link up in 10G\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|14
operator|)
operator|)
operator|)
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_2500
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link up in 2.5G\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|link_status
operator|&
operator|(
literal|1
operator|<<
literal|13
operator|)
operator|)
operator|)
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_1000
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link up in 1G\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link is down\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* See if 1G link is up for the 8072. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_LINK_STATUS
argument_list|,
operator|&
name|an1000_status
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_LINK_STATUS
argument_list|,
operator|&
name|an1000_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|an1000_status
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_1000
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link up in 1G\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ext_phy_link_up
condition|)
block|{
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x: External link up in 10G\n"
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
case|:
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_LASI_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"10G-base-T LASI status 0x%x->0x%x\n"
argument_list|,
name|val2
argument_list|,
name|val1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_STATUS
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"10G-base-T PMA status 0x%x->0x%x\n"
argument_list|,
name|val2
argument_list|,
name|val1
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
operator|(
operator|(
name|val1
operator|&
literal|4
operator|)
operator|==
literal|4
operator|)
expr_stmt|;
comment|/* 			 * if link is up print the AN outcome of the 			 * SFX7101 PHY. 			 */
if|if
condition|(
name|ext_phy_link_up
condition|)
block|{
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_MASTER_STATUS
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SFX7101 AN status 0x%x->Master=%x\n"
argument_list|,
name|val2
argument_list|,
operator|(
name|val2
operator|&
operator|(
literal|1
operator|<<
literal|14
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
case|:
comment|/* Check 10G-BaseT link status. */
comment|/* Check PMD signal ok. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
literal|0xFFFA
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_8481_PMD_SIGNAL
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"PMD_SIGNAL 1.a811 = 0x%x\n"
argument_list|,
name|val2
argument_list|)
expr_stmt|;
comment|/* Check link 10G. */
if|if
condition|(
name|val2
operator|&
operator|(
literal|1
operator|<<
literal|11
operator|)
condition|)
block|{
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
name|bxe_8481_set_10G_led_mode
argument_list|(
name|params
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Check Legacy speed link */
comment|/* 				 * Enable expansion register 0x42 				 * (Operation mode status). 				 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_EXPANSION_REG_ACCESS
argument_list|,
literal|0xf42
argument_list|)
expr_stmt|;
comment|/* Get legacy speed operation status. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_8481_EXPANSION_REG_RD_RW
argument_list|,
operator|&
name|legacy_status
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Legacy speed status = 0x%x\n"
argument_list|,
name|legacy_status
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
operator|(
operator|(
name|legacy_status
operator|&
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|)
operator|==
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ext_phy_link_up
condition|)
block|{
name|legacy_speed
operator|=
operator|(
name|legacy_status
operator|&
operator|(
literal|3
operator|<<
literal|9
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|legacy_speed
operator|==
operator|(
literal|0
operator|<<
literal|9
operator|)
condition|)
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10
expr_stmt|;
elseif|else
if|if
condition|(
name|legacy_speed
operator|==
operator|(
literal|1
operator|<<
literal|9
operator|)
condition|)
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_100
expr_stmt|;
elseif|else
if|if
condition|(
name|legacy_speed
operator|==
operator|(
literal|2
operator|<<
literal|9
operator|)
condition|)
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_1000
expr_stmt|;
else|else
comment|/* Should not happen */
name|vars
operator|->
name|line_speed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|legacy_status
operator|&
operator|(
literal|1
operator|<<
literal|8
operator|)
condition|)
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
else|else
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_HALF
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Link is up in %dMbps, is_duplex_full = %d\n"
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|,
operator|(
name|vars
operator|->
name|duplex
operator|==
name|DUPLEX_FULL
operator|)
argument_list|)
expr_stmt|;
name|bxe_8481_set_legacy_led_mode
argument_list|(
name|params
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BAD XGXS ext_phy_config 0x%x\n"
argument_list|,
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/* Set SGMII mode for external phy */
if|if
condition|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
condition|)
block|{
if|if
condition|(
name|vars
operator|->
name|line_speed
operator|<
name|SPEED_1000
condition|)
name|vars
operator|->
name|phy_flags
operator||=
name|PHY_SGMII_FLAG
expr_stmt|;
else|else
name|vars
operator|->
name|phy_flags
operator|&=
operator|~
name|PHY_SGMII_FLAG
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* SerDes */
name|ext_phy_type
operator|=
name|SERDES_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_DIRECT
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes Direct\n"
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_BCM5482
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes 5482\n"
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"BAD SerDes ext_phy_config 0x%x\n"
argument_list|,
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_link_up
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|ext_phy_link_up
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_link_int_enable
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|,
name|mask
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
comment|/* Setting the status to report on link up for either XGXS or SerDes. */
if|if
condition|(
name|params
operator|->
name|switch_cfg
operator|==
name|SWITCH_CFG_10G
condition|)
block|{
name|mask
operator|=
operator|(
name|NIG_MASK_XGXS0_LINK10G
operator||
name|NIG_MASK_XGXS0_LINK_STATUS
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"enabled XGXS interrupt\n"
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN
operator|)
condition|)
block|{
name|mask
operator||=
name|NIG_MASK_MI_INT
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"enabled external phy int\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* SerDes */
name|mask
operator|=
name|NIG_MASK_SERDES0_LINK_STATUS
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"enabled SerDes interrupt\n"
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|SERDES_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_DIRECT
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_NOT_CONN
operator|)
condition|)
block|{
name|mask
operator||=
name|NIG_MASK_MI_INT
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"enabled external phy int\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|NIG_REG_MASK_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x, is_xgxs %x, int_status 0x%x\n"
argument_list|,
name|port
argument_list|,
operator|(
name|params
operator|->
name|switch_cfg
operator|==
name|SWITCH_CFG_10G
operator|)
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|" int_mask 0x%x, MI_INT %x, SERDES_LINK %x\n"
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_MASK_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|)
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EMAC0_STATUS_MISC_MI_INT
operator|+
name|port
operator|*
literal|0x18
argument_list|)
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_SERDES0_STATUS_LINK_STATUS
operator|+
name|port
operator|*
literal|0x3c
argument_list|)
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|" 10G %x, XGXS_LINK %x\n"
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_STATUS_LINK10G
operator|+
name|port
operator|*
literal|0x68
argument_list|)
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_STATUS_LINK_STATUS
operator|+
name|port
operator|*
literal|0x68
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_8481_rearm_latch_signal
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|is_mi_int
parameter_list|)
block|{
name|uint32_t
name|latch_status
decl_stmt|,
name|is_mi_int_status
decl_stmt|;
name|latch_status
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Disable the MI INT ( external phy int ) 	 * by writing 1 to the status register. Link down indication 	 * is high-active-signal, so in this case we need to write 	 * the status to clear the XOR. 	 */
comment|/* Read Latched signals. */
name|latch_status
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LATCH_STATUS_0
operator|+
name|port
operator|*
literal|8
argument_list|)
expr_stmt|;
name|is_mi_int_status
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"original_signal = 0x%x, nig_status = 0x%x, latch_status = 0x%x\n"
argument_list|,
name|is_mi_int
argument_list|,
name|is_mi_int_status
argument_list|,
name|latch_status
argument_list|)
expr_stmt|;
comment|/* Handle only those with latched-signal=up. */
if|if
condition|(
name|latch_status
operator|&
literal|1
condition|)
block|{
comment|/* For all latched-signal=up,Write original_signal to status. */
if|if
condition|(
name|is_mi_int
condition|)
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|NIG_STATUS_EMAC0_MI_INT
argument_list|)
expr_stmt|;
else|else
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|NIG_STATUS_EMAC0_MI_INT
argument_list|)
expr_stmt|;
comment|/* For all latched-signal=up : Re-Arm Latch signals. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LATCH_STATUS_0
operator|+
name|port
operator|*
literal|8
argument_list|,
operator|(
name|latch_status
operator|&
literal|0xfffe
operator|)
operator||
operator|(
name|latch_status
operator|&
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Link management  */
end_comment

begin_function
specifier|static
name|void
name|bxe_link_int_ack
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|is_10g
parameter_list|,
name|uint8_t
name|is_mi_int
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ser_lane
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
comment|/* 	 * First reset all status, we assume only one line will be 	 * change at a time. 	 */
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
operator|(
name|NIG_STATUS_XGXS0_LINK10G
operator||
name|NIG_STATUS_XGXS0_LINK_STATUS
operator||
name|NIG_STATUS_SERDES0_LINK_STATUS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
operator|)
operator|||
operator|(
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
operator|)
condition|)
name|bxe_8481_rearm_latch_signal
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|is_mi_int
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|phy_link_up
condition|)
block|{
if|if
condition|(
name|is_10g
condition|)
block|{
comment|/* 			 * Disable the 10G link interrupt by writing 1 to 			 * the status register. 			 */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"10G XGXS phy link up\n"
argument_list|)
expr_stmt|;
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|NIG_STATUS_XGXS0_LINK10G
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|switch_cfg
operator|==
name|SWITCH_CFG_10G
condition|)
block|{
comment|/* 			 * Disable the link interrupt by writing 1 to 			 * the relevant lane in the status register. 			 */
name|ser_lane
operator|=
operator|(
operator|(
name|params
operator|->
name|lane_config
operator|&
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_MASK
operator|)
operator|>>
name|PORT_HW_CFG_LANE_SWAP_CFG_MASTER_SHIFT
operator|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"%d speed XGXS phy link up\n"
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|)
expr_stmt|;
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
operator|(
operator|(
literal|1
operator|<<
name|ser_lane
operator|)
operator|<<
name|NIG_STATUS_XGXS0_LINK_STATUS_SIZE
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* SerDes */
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"SerDes phy link up\n"
argument_list|)
expr_stmt|;
comment|/* 			 * Disable the link interrupt by writing 1 to 			 * the status register. 			 */
name|bxe_bits_en
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|NIG_STATUS_SERDES0_LINK_STATUS
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* link_down */
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_format_ver
parameter_list|(
name|uint32_t
name|num
parameter_list|,
name|uint8_t
modifier|*
name|str
parameter_list|,
name|uint16_t
name|len
parameter_list|)
block|{
name|uint32_t
name|mask
decl_stmt|;
name|uint8_t
modifier|*
name|str_ptr
decl_stmt|;
name|uint8_t
name|digit
decl_stmt|,
name|shift
decl_stmt|;
name|str_ptr
operator|=
name|str
expr_stmt|;
name|mask
operator|=
literal|0xf0000000
expr_stmt|;
name|shift
operator|=
literal|8
operator|*
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|10
condition|)
block|{
comment|/* Need more than 10 chars for this format. */
operator|*
name|str_ptr
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
while|while
condition|(
name|shift
operator|>
literal|0
condition|)
block|{
name|shift
operator|-=
literal|4
expr_stmt|;
name|digit
operator|=
operator|(
operator|(
name|num
operator|&
name|mask
operator|)
operator|>>
name|shift
operator|)
expr_stmt|;
if|if
condition|(
name|digit
operator|<
literal|0xa
condition|)
operator|*
name|str_ptr
operator|=
name|digit
operator|+
literal|'0'
expr_stmt|;
else|else
operator|*
name|str_ptr
operator|=
name|digit
operator|-
literal|0xa
operator|+
literal|'a'
expr_stmt|;
name|str_ptr
operator|++
expr_stmt|;
name|mask
operator|=
name|mask
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|shift
operator|==
literal|4
operator|*
literal|4
condition|)
block|{
operator|*
name|str_ptr
operator|=
literal|':'
expr_stmt|;
name|str_ptr
operator|++
expr_stmt|;
block|}
block|}
operator|*
name|str_ptr
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_get_ext_phy_fw_version
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint8_t
name|driver_loaded
parameter_list|,
name|uint8_t
modifier|*
name|version
parameter_list|,
name|uint16_t
name|len
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|,
name|spirom_ver
decl_stmt|;
name|uint8_t
name|status
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|version
operator|==
name|NULL
operator|||
name|params
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|spirom_ver
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|port_mb
index|[
name|params
operator|->
name|port
index|]
operator|.
name|ext_phy_fw_version
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
literal|0
expr_stmt|;
comment|/* Reset the returned value to zero. */
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
case|:
if|if
condition|(
name|len
operator|<
literal|5
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|version
index|[
literal|0
index|]
operator|=
operator|(
name|spirom_ver
operator|&
literal|0xFF
operator|)
expr_stmt|;
name|version
index|[
literal|1
index|]
operator|=
operator|(
name|spirom_ver
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
expr_stmt|;
name|version
index|[
literal|2
index|]
operator|=
operator|(
name|spirom_ver
operator|&
literal|0xFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|version
index|[
literal|3
index|]
operator|=
operator|(
name|spirom_ver
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|version
index|[
literal|4
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
name|status
operator|=
name|bxe_format_ver
argument_list|(
name|spirom_ver
argument_list|,
name|version
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
case|:
name|spirom_ver
operator|=
operator|(
operator|(
name|spirom_ver
operator|&
literal|0xF80
operator|)
operator|>>
literal|7
operator|)
operator|<<
literal|16
operator||
operator|(
name|spirom_ver
operator|&
literal|0x7F
operator|)
expr_stmt|;
name|status
operator|=
name|bxe_format_ver
argument_list|(
name|spirom_ver
argument_list|,
name|version
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705
case|:
name|version
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_FAILURE
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_get_ext_phy_fw_version: type is FAILURE!\n"
argument_list|)
expr_stmt|;
name|status
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_set_xgxs_loopback
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|is_10g
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|md_devad
decl_stmt|;
name|uint16_t
name|mii_control
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
if|if
condition|(
name|is_10g
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 10G loopback enable\n"
argument_list|)
expr_stmt|;
comment|/* Change the uni_phy_addr in the nig. */
name|md_devad
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
operator|(
name|NIG_REG_XGXS0_CTRL_MD_DEVAD
operator|+
name|port
operator|*
literal|0x18
operator|)
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_CTRL_MD_DEVAD
operator|+
name|port
operator|*
literal|0x18
argument_list|,
literal|0x5
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
literal|5
argument_list|,
operator|(
name|MDIO_REG_BANK_AER_BLOCK
operator|+
operator|(
name|MDIO_AER_BLOCK_AER_REG
operator|&
literal|0xf
operator|)
operator|)
argument_list|,
literal|0x2800
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
literal|5
argument_list|,
operator|(
name|MDIO_REG_BANK_CL73_IEEEB0
operator|+
operator|(
name|MDIO_CL73_IEEEB0_CL73_AN_CONTROL
operator|&
literal|0xf
operator|)
operator|)
argument_list|,
literal|0x6041
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|200
argument_list|)
expr_stmt|;
comment|/* Set aer mmd back. */
name|bxe_set_aer_mmd
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
comment|/* and md_devad */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_CTRL_MD_DEVAD
operator|+
name|port
operator|*
literal|0x18
argument_list|,
name|md_devad
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"XGXS 1G loopback enable\n"
argument_list|)
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|&
name|mii_control
argument_list|)
expr_stmt|;
name|CL45_WR_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_COMBO_IEEE0
argument_list|,
name|MDIO_COMBO_IEEE0_MII_CONTROL
argument_list|,
operator|(
name|mii_control
operator||
name|MDIO_COMBO_IEEO_MII_CONTROL_LOOPBACK
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_ext_phy_loopback
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|switch_cfg
operator|==
name|SWITCH_CFG_10G
condition|)
block|{
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* CL37 Autoneg Enabled */
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_NOT_CONN
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"ext_phy_loopback: We should not get here\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"ext_phy_loopback: 8705\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"ext_phy_loopback: 8706\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"PMA/PMD ext_phy_loopback: 8726\n"
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
case|:
comment|/* SFX7101_XGXS_TEST1 */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_type
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_XS_DEVAD
argument_list|,
name|MDIO_XS_SFX7101_XGXS_TEST1
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"ext_phy_loopback: set ext phy loopback\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
case|:
break|break;
block|}
comment|/* switch external PHY type */
block|}
else|else
block|{
comment|/* serdes */
name|ext_phy_type
operator|=
name|SERDES_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|ext_phy_addr
operator|=
operator|(
name|params
operator|->
name|ext_phy_config
operator|&
name|PORT_HW_CFG_SERDES_EXT_PHY_ADDR_MASK
operator|)
operator|>>
name|PORT_HW_CFG_SERDES_EXT_PHY_ADDR_SHIFT
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Override the led value of the requsted led. */
end_comment

begin_function
name|uint8_t
name|bxe_override_led_value
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint32_t
name|led_idx
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|uint32_t
name|reg_val
decl_stmt|;
name|uint32_t
name|emac_base
decl_stmt|;
comment|/* If port 0 then use EMAC0, else use EMAC1. */
name|emac_base
operator|=
operator|(
name|port
operator|)
condition|?
name|GRCBASE_EMAC1
else|:
name|GRCBASE_EMAC0
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_override_led_value() port %x led_idx %d value %d\n"
argument_list|,
name|port
argument_list|,
name|led_idx
argument_list|,
name|value
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|led_idx
condition|)
block|{
case|case
literal|0
case|:
comment|/* 10MB led */
comment|/* 		 * Read the current value of the LED register in the EMAC block. 		 */
name|reg_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|)
expr_stmt|;
comment|/* Set the OVERRIDE bit to 1. */
name|reg_val
operator||=
name|EMAC_LED_OVERRIDE
expr_stmt|;
comment|/* 		 * If value is 1, set the 10M_OVERRIDE bit, otherwise reset it. 		 */
name|reg_val
operator|=
operator|(
name|value
operator|==
literal|1
operator|)
condition|?
operator|(
name|reg_val
operator||
name|EMAC_LED_10MB_OVERRIDE
operator|)
else|:
operator|(
name|reg_val
operator|&
operator|~
name|EMAC_LED_10MB_OVERRIDE
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/*100MB led    */
comment|/* 		 * Read the current value of the LED register in the EMAC block. 		 */
name|reg_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|)
expr_stmt|;
comment|/* Set the OVERRIDE bit to 1. */
name|reg_val
operator||=
name|EMAC_LED_OVERRIDE
expr_stmt|;
comment|/* 		 * If value is 1, set the 100M_OVERRIDE bit, otherwise reset it. 		 */
name|reg_val
operator|=
operator|(
name|value
operator|==
literal|1
operator|)
condition|?
operator|(
name|reg_val
operator||
name|EMAC_LED_100MB_OVERRIDE
operator|)
else|:
operator|(
name|reg_val
operator|&
operator|~
name|EMAC_LED_100MB_OVERRIDE
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 1000MB led */
comment|/* 		 * Read the current value of the LED register in the EMAC block. 		 */
name|reg_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|)
expr_stmt|;
comment|/* Set the OVERRIDE bit to 1. */
name|reg_val
operator||=
name|EMAC_LED_OVERRIDE
expr_stmt|;
comment|/* 		 * If value is 1, set the 1000M_OVERRIDE bit, otherwise reset 		 * it. 		 */
name|reg_val
operator|=
operator|(
name|value
operator|==
literal|1
operator|)
condition|?
operator|(
name|reg_val
operator||
name|EMAC_LED_1000MB_OVERRIDE
operator|)
else|:
operator|(
name|reg_val
operator|&
operator|~
name|EMAC_LED_1000MB_OVERRIDE
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 2500MB led */
comment|/* 		 * Read the current value of the LED register in the EMAC block. 		 */
name|reg_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|)
expr_stmt|;
comment|/* Set the OVERRIDE bit to 1. */
name|reg_val
operator||=
name|EMAC_LED_OVERRIDE
expr_stmt|;
comment|/* 		 * If value is 1, set the 2500M_OVERRIDE bit, otherwise reset 		 * it. 		 */
name|reg_val
operator|=
operator|(
name|value
operator|==
literal|1
operator|)
condition|?
operator|(
name|reg_val
operator||
name|EMAC_LED_2500MB_OVERRIDE
operator|)
else|:
operator|(
name|reg_val
operator|&
operator|~
name|EMAC_LED_2500MB_OVERRIDE
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/*10G led */
if|if
condition|(
name|port
operator|==
literal|0
condition|)
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_10G_P0
argument_list|,
name|value
argument_list|)
expr_stmt|;
else|else
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_10G_P1
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* TRAFFIC led */
comment|/* Find if the traffic control is via BMAC or EMAC. */
if|if
condition|(
name|port
operator|==
literal|0
condition|)
name|reg_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_NIG_EMAC0_EN
argument_list|)
expr_stmt|;
else|else
name|reg_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_NIG_EMAC1_EN
argument_list|)
expr_stmt|;
comment|/*  Override the traffic led in the EMAC. */
if|if
condition|(
name|reg_val
operator|==
literal|1
condition|)
block|{
comment|/* 			 * Read the current value of the LED register in 			 * the EMAC block. 			 */
name|reg_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|)
expr_stmt|;
comment|/* Set the TRAFFIC_OVERRIDE bit to 1. */
name|reg_val
operator||=
name|EMAC_LED_OVERRIDE
expr_stmt|;
comment|/* 			 * If value is 1, set the TRAFFIC bit, otherwise reset 			 * it. 			 */
name|reg_val
operator|=
operator|(
name|value
operator|==
literal|1
operator|)
condition|?
operator|(
name|reg_val
operator||
name|EMAC_LED_TRAFFIC
operator|)
else|:
operator|(
name|reg_val
operator|&
operator|~
name|EMAC_LED_TRAFFIC
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|emac_base
operator|+
name|EMAC_REG_EMAC_LED
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Override the traffic led in the BMAC. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_OVERRIDE_TRAFFIC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_TRAFFIC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_override_led_value() unknown led index %d (should be 0-5)\n"
argument_list|,
name|led_idx
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_set_led
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|uint8_t
name|mode
parameter_list|,
name|uint32_t
name|speed
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|emac_base
decl_stmt|,
name|ext_phy_type
decl_stmt|,
name|tmp
decl_stmt|;
name|uint16_t
name|hw_led_mode
decl_stmt|;
name|uint8_t
name|port
decl_stmt|,
name|rc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|hw_led_mode
operator|=
name|params
operator|->
name|hw_led_mode
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|emac_base
operator|=
name|port
condition|?
name|GRCBASE_EMAC1
else|:
name|GRCBASE_EMAC0
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"bxe_set_led: port %x, mode %d\n"
argument_list|,
name|port
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"speed 0x%x, hw_led_mode 0x%x\n"
argument_list|,
name|speed
argument_list|,
name|hw_led_mode
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|LED_MODE_OFF
case|:
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_10G_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_MODE_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|SHARED_HW_CFG_LED_MAC1
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|EMAC_RD
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_LED
argument_list|)
expr_stmt|;
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_LED
argument_list|,
operator|(
name|tmp
operator||
name|EMAC_LED_OVERRIDE
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LED_MODE_OPER
case|:
if|if
condition|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
condition|)
block|{
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_MODE_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_10G_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_MODE_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|hw_led_mode
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_OVERRIDE_TRAFFIC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set blinking rate to ~15.9Hz. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_BLINK_RATE_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
name|LED_BLINK_RATE_VAL
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_BLINK_RATE_ENA_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|EMAC_RD
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_LED
argument_list|)
expr_stmt|;
name|EMAC_WR
argument_list|(
name|sc
argument_list|,
name|EMAC_REG_EMAC_LED
argument_list|,
operator|(
name|tmp
operator|&
operator|(
operator|~
name|EMAC_LED_OVERRIDE
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|CHIP_IS_E1
argument_list|(
name|sc
argument_list|)
operator|&&
operator|(
operator|(
name|speed
operator|==
name|SPEED_2500
operator|)
operator|||
operator|(
name|speed
operator|==
name|SPEED_1000
operator|)
operator|||
operator|(
name|speed
operator|==
name|SPEED_100
operator|)
operator|||
operator|(
name|speed
operator|==
name|SPEED_10
operator|)
operator|)
condition|)
block|{
comment|/* 			 * On Everest 1 Ax chip versions for speeds less than 			 * 10G LED scheme is different. 			 */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_OVERRIDE_TRAFFIC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_TRAFFIC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_LED_CONTROL_BLINK_TRAFFIC_P0
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|rc
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_set_led: Invalid led mode %d\n"
argument_list|,
name|mode
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_test_link
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint16_t
name|gp_status
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|gp_status
operator|=
literal|0
expr_stmt|;
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_GP_STATUS
argument_list|,
name|MDIO_GP_STATUS_TOP_AN_STATUS1
argument_list|,
operator|&
name|gp_status
argument_list|)
expr_stmt|;
comment|/* Link is up only if both local phy and external phy are up. */
if|if
condition|(
operator|(
name|gp_status
operator|&
name|MDIO_GP_STATUS_TOP_AN_STATUS1_LINK_STATUS
operator|)
operator|&&
name|bxe_ext_phy_is_link_up
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_link_initialize
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint8_t
name|port
decl_stmt|,
name|rc
decl_stmt|;
name|uint8_t
name|non_ext_phy
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Activate the external PHY. */
name|bxe_ext_phy_reset
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
name|bxe_set_aer_mmd
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
name|bxe_set_master_ln
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bxe_reset_unicore
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* Reset the SerDes and wait for reset bit return low. */
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
return|return
operator|(
name|rc
operator|)
return|;
name|bxe_set_aer_mmd
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
comment|/* Setting the masterLn_def again after the reset. */
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
name|bxe_set_master_ln
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|bxe_set_swap_lanes
argument_list|(
name|params
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
condition|)
block|{
if|if
condition|(
operator|(
name|params
operator|->
name|req_line_speed
operator|&&
operator|(
operator|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_100
operator|)
operator|||
operator|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_10
operator|)
operator|)
operator|)
operator|||
operator|(
operator|!
name|params
operator|->
name|req_line_speed
operator|&&
operator|(
name|params
operator|->
name|speed_cap_mask
operator|>=
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_10M_FULL
operator|)
operator|&&
operator|(
name|params
operator|->
name|speed_cap_mask
operator|<
name|PORT_HW_CFG_SPEED_CAPABILITY_D0_1G
operator|)
operator|)
condition|)
name|vars
operator|->
name|phy_flags
operator||=
name|PHY_SGMII_FLAG
expr_stmt|;
else|else
name|vars
operator|->
name|phy_flags
operator|&=
operator|~
name|PHY_SGMII_FLAG
expr_stmt|;
block|}
comment|/* 	 * In case of external phy existance, the line speed would be the 	 * line speed linked up by the external phy. In case it is direct 	 * only, then the line_speed during initialization will be equal 	 * to the req_line_speed. 	 */
name|vars
operator|->
name|line_speed
operator|=
name|params
operator|->
name|req_line_speed
expr_stmt|;
name|bxe_calc_ieee_aneg_adv
argument_list|(
name|params
argument_list|,
operator|&
name|vars
operator|->
name|ieee_fc
argument_list|)
expr_stmt|;
comment|/* Init ext phy and enable link state int. */
name|non_ext_phy
operator|=
operator|(
operator|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
operator|)
operator|||
operator|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_XGXS_10
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|non_ext_phy
operator|||
operator|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705
operator|)
operator|||
operator|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706
operator|)
operator|||
operator|(
name|ext_phy_type
operator|==
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
operator|)
operator|||
operator|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_EXT_PHY
operator|)
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|req_line_speed
operator|==
name|SPEED_AUTO_NEG
condition|)
name|bxe_set_parallel_detection
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|phy_flags
argument_list|)
expr_stmt|;
name|bxe_init_internal_phy
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|non_ext_phy
condition|)
name|rc
operator||=
name|bxe_ext_phy_init
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
operator|(
name|NIG_STATUS_XGXS0_LINK10G
operator||
name|NIG_STATUS_XGXS0_LINK_STATUS
operator||
name|NIG_STATUS_SERDES0_LINK_STATUS
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_phy_init
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Phy Initialization started\n"
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"req_speed %d, req_flowctrl %d\n"
argument_list|,
name|params
operator|->
name|req_line_speed
argument_list|,
name|params
operator|->
name|req_flow_ctrl
argument_list|)
expr_stmt|;
name|vars
operator|->
name|link_status
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|phy_link_up
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|link_up
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_NONE
expr_stmt|;
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_NONE
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|switch_cfg
operator|==
name|SWITCH_CFG_1G
condition|)
name|vars
operator|->
name|phy_flags
operator|=
name|PHY_SERDES_FLAG
expr_stmt|;
else|else
name|vars
operator|->
name|phy_flags
operator|=
name|PHY_XGXS_FLAG
expr_stmt|;
comment|/* disable attentions */
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|NIG_REG_MASK_INTERRUPT_PORT0
operator|+
name|params
operator|->
name|port
operator|*
literal|4
argument_list|,
operator|(
name|NIG_MASK_XGXS0_LINK_STATUS
operator||
name|NIG_MASK_XGXS0_LINK10G
operator||
name|NIG_MASK_SERDES0_LINK_STATUS
operator||
name|NIG_MASK_MI_INT
operator|)
argument_list|)
expr_stmt|;
name|bxe_emac_init
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_BMAC
condition|)
block|{
name|vars
operator|->
name|link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_NONE
expr_stmt|;
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_BMAC
expr_stmt|;
name|vars
operator|->
name|phy_flags
operator|=
name|PHY_XGXS_FLAG
expr_stmt|;
name|bxe_phy_deassert
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|phy_flags
argument_list|)
expr_stmt|;
comment|/* Set bmac loopback. */
name|bxe_bmac_enable
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_DRAIN0_MODE
operator|+
name|params
operator|->
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_EMAC
condition|)
block|{
name|vars
operator|->
name|link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_1000
expr_stmt|;
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_NONE
expr_stmt|;
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_EMAC
expr_stmt|;
name|vars
operator|->
name|phy_flags
operator|=
name|PHY_XGXS_FLAG
expr_stmt|;
name|bxe_phy_deassert
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|phy_flags
argument_list|)
expr_stmt|;
comment|/* Set bmac loopback. */
name|bxe_emac_enable
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bxe_emac_program
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|,
name|vars
operator|->
name|duplex
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_DRAIN0_MODE
operator|+
name|params
operator|->
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_XGXS_10
operator|)
operator|||
operator|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_EXT_PHY
operator|)
condition|)
block|{
name|vars
operator|->
name|link_up
operator|=
literal|1
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
name|SPEED_10000
expr_stmt|;
name|vars
operator|->
name|duplex
operator|=
name|DUPLEX_FULL
expr_stmt|;
name|vars
operator|->
name|flow_ctrl
operator|=
name|FLOW_CTRL_NONE
expr_stmt|;
name|vars
operator|->
name|phy_flags
operator|=
name|PHY_XGXS_FLAG
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_CTRL_PHY_ADDR
operator|+
name|params
operator|->
name|port
operator|*
literal|0x18
argument_list|)
expr_stmt|;
name|params
operator|->
name|phy_addr
operator|=
operator|(
name|uint8_t
operator|)
name|val
expr_stmt|;
name|bxe_phy_deassert
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|phy_flags
argument_list|)
expr_stmt|;
name|bxe_link_initialize
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_BMAC
expr_stmt|;
name|bxe_bmac_enable
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|loopback_mode
operator|==
name|LOOPBACK_XGXS_10
condition|)
block|{
comment|/* Set 10G XGXS loopback. */
name|bxe_set_xgxs_loopback
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Set external phy loopback. */
name|bxe_ext_phy_loopback
argument_list|(
name|params
argument_list|)
expr_stmt|;
block|}
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_DRAIN0_MODE
operator|+
name|params
operator|->
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bxe_set_led
argument_list|(
name|params
argument_list|,
name|LED_MODE_OPER
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* No loopback. */
name|bxe_phy_deassert
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|phy_flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|params
operator|->
name|switch_cfg
condition|)
block|{
case|case
name|SWITCH_CFG_1G
case|:
name|vars
operator|->
name|phy_flags
operator||=
name|PHY_SERDES_FLAG
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|ext_phy_config
operator|&
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_MASK
operator|)
operator|==
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_BCM5482
condition|)
block|{
name|vars
operator|->
name|phy_flags
operator||=
name|PHY_SGMII_FLAG
expr_stmt|;
block|}
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_SERDES0_CTRL_PHY_ADDR
operator|+
name|params
operator|->
name|port
operator|*
literal|0x10
argument_list|)
expr_stmt|;
name|params
operator|->
name|phy_addr
operator|=
operator|(
name|uint8_t
operator|)
name|val
expr_stmt|;
break|break;
case|case
name|SWITCH_CFG_10G
case|:
name|vars
operator|->
name|phy_flags
operator||=
name|PHY_XGXS_FLAG
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_CTRL_PHY_ADDR
operator|+
name|params
operator|->
name|port
operator|*
literal|0x18
argument_list|)
expr_stmt|;
name|params
operator|->
name|phy_addr
operator|=
operator|(
name|uint8_t
operator|)
name|val
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Invalid switch_cfg\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Phy address = 0x%x\n"
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|)
expr_stmt|;
name|bxe_link_initialize
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|bxe_link_int_enable
argument_list|(
name|params
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bxe_8726_reset_phy
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|ext_phy_addr
parameter_list|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_8726_reset_phy port %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Set serial boot control for external load. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_GEN_CTRL
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_link_reset
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|reset_ext_phy
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_config
decl_stmt|,
name|ext_phy_type
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|,
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|ext_phy_config
operator|=
name|params
operator|->
name|ext_phy_config
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|ext_phy_config
argument_list|)
expr_stmt|;
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_feature_config
index|[
name|params
operator|->
name|port
index|]
operator|.
name|config
argument_list|)
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"Resetting the link of port %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Disable attentions. */
name|vars
operator|->
name|link_status
operator|=
literal|0
expr_stmt|;
name|bxe_update_mng
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|link_status
argument_list|)
expr_stmt|;
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|NIG_REG_MASK_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
operator|(
name|NIG_MASK_XGXS0_LINK_STATUS
operator||
name|NIG_MASK_XGXS0_LINK10G
operator||
name|NIG_MASK_SERDES0_LINK_STATUS
operator||
name|NIG_MASK_MI_INT
operator|)
argument_list|)
expr_stmt|;
comment|/* Activate nig drain. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_DRAIN0_MODE
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Disable nig egress interface. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_EMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Stop BigMac rx. */
name|bxe_bmac_rx_disable
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|chip_id
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Disable emac. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_NIG_EMAC0_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* The PHY reset is controled by GPIO 1 Hold it as vars low. */
comment|/* Clear link led. */
name|bxe_set_led
argument_list|(
name|params
argument_list|,
name|LED_MODE_OFF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset_ext_phy
condition|)
block|{
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_DIRECT
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8072
case|:
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
comment|/* Disable Transmitter */
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_MASK
operator|)
operator|==
name|PORT_FEAT_CFG_OPT_MDL_ENFRCMNT_DISABLE_TX_LASER
condition|)
name|bxe_sfp_set_transmitter
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Setting 8073 port %d into low power mode\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_LOW
argument_list|,
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Set soft reset. */
name|bxe_8726_reset_phy
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|port
argument_list|,
name|ext_phy_addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
case|:
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_AN_DEVAD
argument_list|,
name|MDIO_AN_REG_CTRL
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8481
argument_list|,
name|ext_phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* HW reset */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_1
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_LOW
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_LOW
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"reset external PHY\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Reset the SerDes/XGXS. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_3_CLEAR
argument_list|,
operator|(
literal|0x1ff
operator|<<
operator|(
name|port
operator|*
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Reset BigMac. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_2_CLEAR
argument_list|,
operator|(
name|MISC_REGISTERS_RESET_REG_2_RST_BMAC0
operator|<<
name|port
operator|)
argument_list|)
expr_stmt|;
comment|/* Disable nig ingress interface. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_IN_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EMAC0_IN_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_BMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_EMAC0_OUT_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vars
operator|->
name|link_up
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_update_link_down
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_INFO
argument_list|,
literal|"Port %x: Link is down\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|bxe_set_led
argument_list|(
name|params
argument_list|,
name|LED_MODE_OFF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Indicate no mac active. */
name|vars
operator|->
name|mac_type
operator|=
name|MAC_TYPE_NONE
expr_stmt|;
comment|/* Update shared memory. */
name|vars
operator|->
name|link_status
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|line_speed
operator|=
literal|0
expr_stmt|;
name|bxe_update_mng
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|link_status
argument_list|)
expr_stmt|;
comment|/* Activate nig drain. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_DRAIN0_MODE
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Disable emac. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_NIG_EMAC0_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* Reset BigMac. */
name|bxe_bmac_rx_disable
argument_list|(
name|sc
argument_list|,
name|params
operator|->
name|chip_id
argument_list|,
name|params
operator|->
name|port
argument_list|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|GRCBASE_MISC
operator|+
name|MISC_REGISTERS_RESET_REG_2_CLEAR
argument_list|,
operator|(
name|MISC_REGISTERS_RESET_REG_2_RST_BMAC0
operator|<<
name|port
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_update_link_up
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|,
name|uint8_t
name|link_10g
parameter_list|,
name|uint32_t
name|gp_status
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|port
decl_stmt|,
name|rc
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|vars
operator|->
name|link_status
operator||=
name|LINK_STATUS_LINK_UP
expr_stmt|;
if|if
condition|(
name|link_10g
condition|)
block|{
name|bxe_bmac_enable
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bxe_set_led
argument_list|(
name|params
argument_list|,
name|LED_MODE_OPER
argument_list|,
name|SPEED_10000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|bxe_emac_program
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|,
name|vars
operator|->
name|duplex
argument_list|)
expr_stmt|;
name|bxe_emac_enable
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* AN complete? */
if|if
condition|(
name|gp_status
operator|&
name|MDIO_AN_CL73_OR_37_COMPLETE
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_SGMII_FLAG
operator|)
condition|)
name|bxe_set_gmii_tx_driver
argument_list|(
name|params
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* PBF - link up */
name|rc
operator||=
name|bxe_pbf_update
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|flow_ctrl
argument_list|,
name|vars
operator|->
name|line_speed
argument_list|)
expr_stmt|;
comment|/* Disable drain. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EGRESS_DRAIN0_MODE
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Update shared memory. */
name|bxe_update_mng
argument_list|(
name|params
argument_list|,
name|vars
operator|->
name|link_status
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|20
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This function should called upon link interrupt.  * In case vars->link_up, driver needs to  *	1. Update the pbf  *	2. Disable drain  *	3. Update the shared memory  *	4. Indicate link up  *	5. Set LEDs  *  Otherwise,  *	1. Update shared memory  *	2. Reset BigMac  *	3. Report link down  *	4. Unset LEDs  */
end_comment

begin_function
name|uint8_t
name|bxe_link_update
parameter_list|(
name|struct
name|link_params
modifier|*
name|params
parameter_list|,
name|struct
name|link_vars
modifier|*
name|vars
parameter_list|)
block|{
name|struct
name|bxe_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint16_t
name|gp_status
decl_stmt|;
name|uint8_t
name|link_10g
decl_stmt|,
name|port
decl_stmt|;
name|uint8_t
name|ext_phy_link_up
decl_stmt|,
name|rc
decl_stmt|;
name|uint8_t
name|is_mi_int
decl_stmt|;
name|sc
operator|=
name|params
operator|->
name|sc
expr_stmt|;
name|port
operator|=
name|params
operator|->
name|port
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|is_mi_int
operator|=
literal|0
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"port %x, XGXS?%x, int_status 0x%x\n"
argument_list|,
name|port
argument_list|,
operator|(
name|vars
operator|->
name|phy_flags
operator|&
name|PHY_XGXS_FLAG
operator|)
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STATUS_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|is_mi_int
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_EMAC0_STATUS_MISC_MI_INT
operator|+
name|port
operator|*
literal|0x18
argument_list|)
operator|>
literal|0
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"int_mask 0x%x MI_INT %x, SERDES_LINK %x\n"
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_MASK_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|)
argument_list|,
name|is_mi_int
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_SERDES0_STATUS_LINK_STATUS
operator|+
name|port
operator|*
literal|0x3c
argument_list|)
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|" 10G %x, XGXS_LINK %x\n"
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_STATUS_LINK10G
operator|+
name|port
operator|*
literal|0x68
argument_list|)
argument_list|,
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_XGXS0_STATUS_LINK_STATUS
operator|+
name|port
operator|*
literal|0x68
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable emac. */
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|NIG_REG_NIG_EMAC0_EN
operator|+
name|port
operator|*
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|params
operator|->
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Check external link change only for non-direct. */
name|ext_phy_link_up
operator|=
name|bxe_ext_phy_is_link_up
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|is_mi_int
argument_list|)
expr_stmt|;
comment|/* Read gp_status. */
name|CL45_RD_OVER_CL22
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|params
operator|->
name|phy_addr
argument_list|,
name|MDIO_REG_BANK_GP_STATUS
argument_list|,
name|MDIO_GP_STATUS_TOP_AN_STATUS1
argument_list|,
operator|&
name|gp_status
argument_list|)
expr_stmt|;
name|rc
operator|=
name|bxe_link_settings_status
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|gp_status
argument_list|,
name|ext_phy_link_up
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* Anything 10 and over uses the bmac. */
name|link_10g
operator|=
operator|(
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_10000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_12000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_12500
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_13000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_15000
operator|)
operator|||
operator|(
name|vars
operator|->
name|line_speed
operator|==
name|SPEED_16000
operator|)
operator|)
expr_stmt|;
name|bxe_link_int_ack
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|link_10g
argument_list|,
name|is_mi_int
argument_list|)
expr_stmt|;
comment|/* 	 * In case external phy link is up, and internal link is down, 	 * not initialized yet probably after link initialization, it 	 * needs to be initialized. 	 * Note that after link down-up as result of cable plug, 	 * the xgxs link would probably become up again without the need 	 * to initialize it. 	 */
if|if
condition|(
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_SERDES_EXT_PHY_TYPE_DIRECT
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8705
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8706
operator|)
operator|&&
operator|(
name|ext_phy_type
operator|!=
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
operator|)
operator|&&
operator|(
name|ext_phy_link_up
operator|&&
operator|!
name|vars
operator|->
name|phy_link_up
operator|)
condition|)
block|{
name|bxe_init_internal_phy
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Link is up only if both local phy and external phy are up. */
name|vars
operator|->
name|link_up
operator|=
operator|(
name|ext_phy_link_up
operator|&&
name|vars
operator|->
name|phy_link_up
operator|)
expr_stmt|;
if|if
condition|(
name|vars
operator|->
name|link_up
condition|)
name|rc
operator|=
name|bxe_update_link_up
argument_list|(
name|params
argument_list|,
name|vars
argument_list|,
name|link_10g
argument_list|,
name|gp_status
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|bxe_update_link_down
argument_list|(
name|params
argument_list|,
name|vars
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_8073_common_init_phy
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|uint32_t
name|ext_phy_config
decl_stmt|;
name|uint16_t
name|fw_ver1
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
index|[
name|PORT_MAX
index|]
decl_stmt|;
name|int
name|port
decl_stmt|;
comment|/* PART1 - Reset both phys. */
for|for
control|(
name|port
operator|=
name|PORT_MAX
operator|-
literal|1
init|;
name|port
operator|>=
name|PORT_0
condition|;
name|port
operator|--
control|)
block|{
comment|/* Extract the ext phy address for the port. */
name|ext_phy_config
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_hw_config
index|[
name|port
index|]
operator|.
name|external_phy_config
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable attentions. */
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|NIG_REG_MASK_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
operator|(
name|NIG_MASK_XGXS0_LINK_STATUS
operator||
name|NIG_MASK_XGXS0_LINK10G
operator||
name|NIG_MASK_SERDES0_LINK_STATUS
operator||
name|NIG_MASK_MI_INT
operator|)
argument_list|)
expr_stmt|;
name|ext_phy_addr
index|[
name|port
index|]
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* 		 * Need to take the phy out of low power mode in order 		 * to write to access its registers. 		 */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_HIGH
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* Reset the phy. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|1
operator|<<
literal|15
argument_list|)
expr_stmt|;
block|}
comment|/* Add delay of 150ms after reset. */
name|msleep
argument_list|(
literal|150
argument_list|)
expr_stmt|;
comment|/* PART2 - Download firmware to both phys. */
for|for
control|(
name|port
operator|=
name|PORT_MAX
operator|-
literal|1
init|;
name|port
operator|>=
name|PORT_0
condition|;
name|port
operator|--
control|)
block|{
name|bxe_bcm8073_external_rom_boot
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER1
argument_list|,
operator|&
name|fw_ver1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw_ver1
operator|==
literal|0
operator|||
name|fw_ver1
operator|==
literal|0x4321
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_8073_common_init_phy port %x:"
literal|"Download failed. fw version = 0x%x\n"
argument_list|,
name|port
argument_list|,
name|fw_ver1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
comment|/* Only set bit 10 = 1 (Tx power down). */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_TX_POWER_DOWN
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
comment|/* Phase1 of TX_POWER_DOWN reset. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_TX_POWER_DOWN
argument_list|,
operator|(
name|val
operator||
literal|1
operator|<<
literal|10
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Toggle Transmitter: Power down and then up with 600ms 	 * delay between. 	 */
name|msleep
argument_list|(
literal|600
argument_list|)
expr_stmt|;
comment|/* PART3 - complete TX_POWER_DOWN process, and set GPIO2 back to low. */
for|for
control|(
name|port
operator|=
name|PORT_MAX
operator|-
literal|1
init|;
name|port
operator|>=
name|PORT_0
condition|;
name|port
operator|--
control|)
block|{
comment|/* Phase2 of POWER_DOWN_RESET */
comment|/* Release bit 10 (Release Tx power down). */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_TX_POWER_DOWN
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_TX_POWER_DOWN
argument_list|,
operator|(
name|val
operator|&
operator|(
operator|~
operator|(
literal|1
operator|<<
literal|10
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|15
argument_list|)
expr_stmt|;
comment|/* Read modify write the SPI-ROM version select register. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_EDC_FFE_MAIN
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_EDC_FFE_MAIN
argument_list|,
operator|(
name|val
operator||
operator|(
literal|1
operator|<<
literal|12
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Set GPIO2 back to LOW. */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_2
argument_list|,
name|MISC_REGISTERS_GPIO_OUTPUT_LOW
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_8727_common_init_phy
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|uint32_t
name|swap_val
decl_stmt|,
name|swap_override
decl_stmt|;
name|uint32_t
name|ext_phy_config
decl_stmt|;
name|uint16_t
name|fw_ver1
decl_stmt|;
name|uint8_t
name|ext_phy_addr
index|[
name|PORT_MAX
index|]
decl_stmt|;
name|uint8_t
name|port
decl_stmt|,
name|first_port
decl_stmt|,
name|i
decl_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Executing BCM8727 common init\n"
argument_list|)
expr_stmt|;
name|swap_val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_PORT_SWAP
argument_list|)
expr_stmt|;
name|swap_override
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|NIG_REG_STRAP_OVERRIDE
argument_list|)
expr_stmt|;
name|bxe_ext_phy_hw_reset
argument_list|(
name|sc
argument_list|,
literal|1
operator|^
operator|(
name|swap_val
operator|&&
name|swap_override
operator|)
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|swap_val
operator|&&
name|swap_override
condition|)
name|first_port
operator|=
name|PORT_0
expr_stmt|;
else|else
name|first_port
operator|=
name|PORT_1
expr_stmt|;
comment|/* PART1 - Reset both phys. */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|port
operator|=
name|first_port
init|;
name|i
operator|<
name|PORT_MAX
condition|;
name|i
operator|++
operator|,
name|port
operator|=
operator|!
name|port
control|)
block|{
comment|/* Extract the ext phy address for the port. */
name|ext_phy_config
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_hw_config
index|[
name|port
index|]
operator|.
name|external_phy_config
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Disable attentions. */
name|bxe_bits_dis
argument_list|(
name|sc
argument_list|,
name|NIG_REG_MASK_INTERRUPT_PORT0
operator|+
name|port
operator|*
literal|4
argument_list|,
operator|(
name|NIG_MASK_XGXS0_LINK_STATUS
operator||
name|NIG_MASK_XGXS0_LINK10G
operator||
name|NIG_MASK_SERDES0_LINK_STATUS
operator||
name|NIG_MASK_MI_INT
operator|)
argument_list|)
expr_stmt|;
name|ext_phy_addr
index|[
name|port
index|]
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|ext_phy_config
argument_list|)
expr_stmt|;
comment|/* Reset the phy. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_CTRL
argument_list|,
literal|1
operator|<<
literal|15
argument_list|)
expr_stmt|;
block|}
comment|/* Add delay of 150ms after reset. */
name|msleep
argument_list|(
literal|150
argument_list|)
expr_stmt|;
comment|/* PART2 - Download firmware to both phys. */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|port
operator|=
name|first_port
init|;
name|i
operator|<
name|PORT_MAX
condition|;
name|i
operator|++
operator|,
name|port
operator|=
operator|!
name|port
control|)
block|{
name|bxe_bcm8727_external_rom_boot
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
argument_list|,
name|ext_phy_addr
index|[
name|port
index|]
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_ROM_VER1
argument_list|,
operator|&
name|fw_ver1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw_ver1
operator|==
literal|0
operator|||
name|fw_ver1
operator|==
literal|0x4321
condition|)
block|{
name|DBPRINT
argument_list|(
name|sc
argument_list|,
literal|1
comment|/*BXE_VERBOSE_PHY*/
argument_list|,
literal|"bxe_8727_common_init_phy port %x:"
literal|"Download failed. fw version = 0x%x\n"
argument_list|,
name|port
argument_list|,
name|fw_ver1
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_8726_common_init_phy
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|uint32_t
name|ext_phy_config
decl_stmt|,
name|val
decl_stmt|;
name|uint8_t
name|ext_phy_addr
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
comment|/* Use port1 because of the static port-swap. */
comment|/* Enable the module detection interrupt. */
name|val
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|MISC_REG_GPIO_EVENT_EN
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
operator|(
literal|1
operator|<<
name|MISC_REGISTERS_GPIO_3
operator|)
operator||
operator|(
literal|1
operator|<<
operator|(
name|MISC_REGISTERS_GPIO_3
operator|+
name|MISC_REGISTERS_GPIO_PORT_SHIFT
operator|)
operator|)
operator|)
expr_stmt|;
name|REG_WR
argument_list|(
name|sc
argument_list|,
name|MISC_REG_GPIO_EVENT_EN
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|bxe_ext_phy_hw_reset
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|PORT_MAX
condition|;
name|port
operator|++
control|)
block|{
comment|/* Extract the ext phy address for the port. */
name|ext_phy_config
operator|=
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_hw_config
index|[
name|port
index|]
operator|.
name|external_phy_config
argument_list|)
argument_list|)
expr_stmt|;
name|ext_phy_addr
operator|=
name|XGXS_EXT_PHY_ADDR
argument_list|(
name|ext_phy_config
argument_list|)
expr_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"8726_common_init : ext_phy_addr = 0x%x\n"
argument_list|,
name|ext_phy_addr
argument_list|)
expr_stmt|;
name|bxe_8726_reset_phy
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|ext_phy_addr
argument_list|)
expr_stmt|;
comment|/* Set fault module detected LED on. */
name|bxe_set_gpio
argument_list|(
name|sc
argument_list|,
name|MISC_REGISTERS_GPIO_0
argument_list|,
name|MISC_REGISTERS_GPIO_HIGH
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|bxe_84823_common_init_phy
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|bxe_ext_phy_hw_reset
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|bxe_common_init_phy
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|shmem_base
parameter_list|)
block|{
name|uint32_t
name|ext_phy_type
decl_stmt|;
name|uint8_t
name|rc
decl_stmt|;
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"Begin common phy init\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|0
expr_stmt|;
name|ext_phy_type
operator|=
literal|0
expr_stmt|;
comment|/* Read the ext_phy_type for arbitrary port(0) */
name|ext_phy_type
operator|=
name|XGXS_EXT_PHY_TYPE
argument_list|(
name|REG_RD
argument_list|(
name|sc
argument_list|,
name|shmem_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|shmem_region
argument_list|,
name|dev_info
operator|.
name|port_hw_config
index|[
literal|0
index|]
operator|.
name|external_phy_config
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_phy_type
condition|)
block|{
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8073
case|:
name|rc
operator|=
name|bxe_8073_common_init_phy
argument_list|(
name|sc
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727
case|:
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8727_NOC
case|:
name|rc
operator|=
name|bxe_8727_common_init_phy
argument_list|(
name|sc
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM8726
case|:
comment|/* 		 * GPIO1 affects both ports, so there's need to pull 		 * it for single port alone. 		 */
name|rc
operator|=
name|bxe_8726_common_init_phy
argument_list|(
name|sc
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
break|break;
case|case
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_BCM84823
case|:
name|rc
operator|=
name|bxe_84823_common_init_phy
argument_list|(
name|sc
argument_list|,
name|shmem_base
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DBPRINT
argument_list|(
name|sc
argument_list|,
name|BXE_VERBOSE_PHY
argument_list|,
literal|"bxe_common_init_phy: ext_phy 0x%x not required\n"
argument_list|,
name|ext_phy_type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bxe_sfx7101_sp_sw_reset
parameter_list|(
name|struct
name|bxe_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|port
parameter_list|,
name|uint8_t
name|phy_addr
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|,
name|cnt
decl_stmt|;
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
argument_list|,
name|phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_7101_RESET
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|cnt
operator|=
literal|0
init|;
name|cnt
operator|<
literal|10
condition|;
name|cnt
operator|++
control|)
block|{
name|msleep
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* Writes a self-clearing reset. */
name|bxe_cl45_write
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
argument_list|,
name|phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_7101_RESET
argument_list|,
operator|(
name|val
operator||
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Wait for clear. */
name|bxe_cl45_read
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|PORT_HW_CFG_XGXS_EXT_PHY_TYPE_SFX7101
argument_list|,
name|phy_addr
argument_list|,
name|MDIO_PMA_DEVAD
argument_list|,
name|MDIO_PMA_REG_7101_RESET
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * SPDX-License-Identifier: BSD-3-Clause  *  * Copyright (c) 2007 The DragonFly Project.  All rights reserved.  *   * This code is derived from software contributed to The DragonFly Project  * by Sepherosa Ziehau<sepherosa@gmail.com>  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *   * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  * 3. Neither the name of The DragonFly Project nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific, prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * $DragonFly: src/sys/dev/netif/bwi/bwiphy.c,v 1.5 2008/01/15 09:01:13 sephe Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_amrr.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bitops.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/if_bwireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/if_bwivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bwimac.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bwirf.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bwiphy.h>
end_include

begin_function_decl
specifier|static
name|void
name|bwi_phy_init_11a
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_phy_init_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_phy_init_11b_rev2
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_phy_init_11b_rev4
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_phy_init_11b_rev5
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_phy_init_11b_rev6
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_phy_config_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_phy_config_agc
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_tbl_write_2
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_tbl_write_4
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|SUP_BPHY
parameter_list|(
name|num
parameter_list|)
value|{ .rev = num, .init = bwi_phy_init_11b_rev##num }
end_define

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint8_t
name|rev
decl_stmt|;
name|void
function_decl|(
modifier|*
name|init
function_decl|)
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
block|}
name|bwi_sup_bphy
index|[]
init|=
block|{
name|SUP_BPHY
argument_list|(
literal|2
argument_list|)
block|,
name|SUP_BPHY
argument_list|(
literal|4
argument_list|)
block|,
name|SUP_BPHY
argument_list|(
literal|5
argument_list|)
block|,
name|SUP_BPHY
argument_list|(
literal|6
argument_list|)
block|}
struct|;
end_struct

begin_undef
undef|#
directive|undef
name|SUP_BPHY
end_undef

begin_define
define|#
directive|define
name|BWI_PHYTBL_WRSSI
value|0x1000
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_NOISE_SCALE
value|0x1400
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_NOISE
value|0x1800
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_ROTOR
value|0x2000
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_DELAY
value|0x2400
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_RSSI
value|0x4000
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_SIGMA_SQ
value|0x5000
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_WRSSI_REV1
value|0x5400
end_define

begin_define
define|#
directive|define
name|BWI_PHYTBL_FREQ
value|0x5800
end_define

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_freq_11g_rev1
index|[]
init|=
block|{
name|BWI_PHY_FREQ_11G_REV1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_noise_11g_rev1
index|[]
init|=
block|{
name|BWI_PHY_NOISE_11G_REV1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_noise_11g
index|[]
init|=
block|{
name|BWI_PHY_NOISE_11G
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|bwi_phy_rotor_11g_rev1
index|[]
init|=
block|{
name|BWI_PHY_ROTOR_11G_REV1
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_noise_scale_11g_rev2
index|[]
init|=
block|{
name|BWI_PHY_NOISE_SCALE_11G_REV2
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_noise_scale_11g_rev7
index|[]
init|=
block|{
name|BWI_PHY_NOISE_SCALE_11G_REV7
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_noise_scale_11g
index|[]
init|=
block|{
name|BWI_PHY_NOISE_SCALE_11G
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_sigma_sq_11g_rev2
index|[]
init|=
block|{
name|BWI_PHY_SIGMA_SQ_11G_REV2
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint16_t
name|bwi_phy_sigma_sq_11g_rev7
index|[]
init|=
block|{
name|BWI_PHY_SIGMA_SQ_11G_REV7
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|bwi_phy_delay_11g_rev1
index|[]
init|=
block|{
name|BWI_PHY_DELAY_11G_REV1
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|bwi_phy_write
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ctrl
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_CTRL
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint16_t
name|bwi_phy_read
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ctrl
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_CTRL
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
return|return
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_DATA
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bwi_phy_attach
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint8_t
name|phyrev
decl_stmt|,
name|phytype
decl_stmt|,
name|phyver
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Get PHY type/revision/version */
name|val
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHYINFO
argument_list|)
expr_stmt|;
name|phyrev
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_PHYINFO_REV_MASK
argument_list|)
expr_stmt|;
name|phytype
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_PHYINFO_TYPE_MASK
argument_list|)
expr_stmt|;
name|phyver
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_PHYINFO_VER_MASK
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"PHY: type %d, rev %d, ver %d\n"
argument_list|,
name|phytype
argument_list|,
name|phyrev
argument_list|,
name|phyver
argument_list|)
expr_stmt|;
comment|/* 	 * Verify whether the revision of the PHY type is supported 	 * Convert PHY type to ieee80211_phymode 	 */
switch|switch
condition|(
name|phytype
condition|)
block|{
case|case
name|BWI_PHYINFO_TYPE_11A
case|:
if|if
condition|(
name|phyrev
operator|>=
literal|4
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported 11A PHY, "
literal|"rev %u\n"
argument_list|,
name|phyrev
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|phy
operator|->
name|phy_init
operator|=
name|bwi_phy_init_11a
expr_stmt|;
name|phy
operator|->
name|phy_mode
operator|=
name|IEEE80211_MODE_11A
expr_stmt|;
name|phy
operator|->
name|phy_tbl_ctrl
operator|=
name|BWI_PHYR_TBL_CTRL_11A
expr_stmt|;
name|phy
operator|->
name|phy_tbl_data_lo
operator|=
name|BWI_PHYR_TBL_DATA_LO_11A
expr_stmt|;
name|phy
operator|->
name|phy_tbl_data_hi
operator|=
name|BWI_PHYR_TBL_DATA_HI_11A
expr_stmt|;
break|break;
case|case
name|BWI_PHYINFO_TYPE_11B
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|bwi_sup_bphy
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|phyrev
operator|==
name|bwi_sup_bphy
index|[
name|i
index|]
operator|.
name|rev
condition|)
block|{
name|phy
operator|->
name|phy_init
operator|=
name|bwi_sup_bphy
index|[
name|i
index|]
operator|.
name|init
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|nitems
argument_list|(
name|bwi_sup_bphy
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported 11B PHY, "
literal|"rev %u\n"
argument_list|,
name|phyrev
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|phy
operator|->
name|phy_mode
operator|=
name|IEEE80211_MODE_11B
expr_stmt|;
break|break;
case|case
name|BWI_PHYINFO_TYPE_11G
case|:
if|if
condition|(
name|phyrev
operator|>
literal|8
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported 11G PHY, "
literal|"rev %u\n"
argument_list|,
name|phyrev
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|phy
operator|->
name|phy_init
operator|=
name|bwi_phy_init_11g
expr_stmt|;
name|phy
operator|->
name|phy_mode
operator|=
name|IEEE80211_MODE_11G
expr_stmt|;
name|phy
operator|->
name|phy_tbl_ctrl
operator|=
name|BWI_PHYR_TBL_CTRL_11G
expr_stmt|;
name|phy
operator|->
name|phy_tbl_data_lo
operator|=
name|BWI_PHYR_TBL_DATA_LO_11G
expr_stmt|;
name|phy
operator|->
name|phy_tbl_data_hi
operator|=
name|BWI_PHYR_TBL_DATA_HI_11G
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported PHY type %d\n"
argument_list|,
name|phytype
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|phy
operator|->
name|phy_rev
operator|=
name|phyrev
expr_stmt|;
name|phy
operator|->
name|phy_version
operator|=
name|phyver
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|bwi_phy_set_bbp_atten
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|bbp_atten
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|mask
init|=
name|__BITS
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|0
condition|)
block|{
name|CSR_FILT_SETBITS_2
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
operator|~
name|mask
argument_list|,
name|__SHIFTIN
argument_list|(
name|bbp_atten
argument_list|,
name|mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|>
literal|1
condition|)
name|mask
operator|<<=
literal|2
expr_stmt|;
else|else
name|mask
operator|<<=
literal|3
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_BBP_ATTEN
argument_list|,
operator|~
name|mask
argument_list|,
name|__SHIFTIN
argument_list|(
name|bbp_atten
argument_list|,
name|mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|bwi_phy_calibrate
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
comment|/* Dummy read */
name|CSR_READ_4
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWI_MAC_STATUS
argument_list|)
expr_stmt|;
comment|/* Don't re-init */
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_CALIBRATED
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11G
operator|&&
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
block|{
name|bwi_mac_reset
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwi_phy_init_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwi_mac_reset
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|phy
operator|->
name|phy_flags
operator||=
name|BWI_PHY_F_CALIBRATED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_tbl_write_2
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ofs
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|phy_tbl_ctrl
operator|!=
literal|0
operator|&&
name|phy
operator|->
name|phy_tbl_data_lo
operator|!=
literal|0
argument_list|,
operator|(
literal|"phy_tbl_ctrl %d phy_tbl_data_lo %d"
operator|,
name|phy
operator|->
name|phy_tbl_ctrl
operator|,
name|phy
operator|->
name|phy_tbl_data_lo
operator|)
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy
operator|->
name|phy_tbl_ctrl
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy
operator|->
name|phy_tbl_data_lo
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_tbl_write_4
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ofs
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|KASSERT
argument_list|(
name|phy
operator|->
name|phy_tbl_data_lo
operator|!=
literal|0
operator|&&
name|phy
operator|->
name|phy_tbl_data_hi
operator|!=
literal|0
operator|&&
name|phy
operator|->
name|phy_tbl_ctrl
operator|!=
literal|0
argument_list|,
operator|(
literal|"phy_tbl_data_lo %d phy_tbl_data_hi %d phy_tbl_ctrl %d"
operator|,
name|phy
operator|->
name|phy_tbl_data_lo
operator|,
name|phy
operator|->
name|phy_tbl_data_hi
operator|,
name|phy
operator|->
name|phy_tbl_ctrl
operator|)
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy
operator|->
name|phy_tbl_ctrl
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy
operator|->
name|phy_tbl_data_hi
argument_list|,
name|data
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|phy
operator|->
name|phy_tbl_data_lo
argument_list|,
name|data
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwi_nrssi_write
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ofs
parameter_list|,
name|int16_t
name|data
parameter_list|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_NRSSI_CTRL
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_NRSSI_DATA
argument_list|,
operator|(
name|uint16_t
operator|)
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int16_t
name|bwi_nrssi_read
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ofs
parameter_list|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_NRSSI_CTRL
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
return|return
operator|(
name|int16_t
operator|)
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_NRSSI_DATA
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_phy_init_11a
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* TODO:11A */
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_phy_init_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
specifier|const
name|struct
name|bwi_tpctl
modifier|*
name|tpctl
init|=
operator|&
name|mac
operator|->
name|mac_tpctl
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
name|bwi_phy_init_11b_rev5
argument_list|(
name|mac
argument_list|)
expr_stmt|;
else|else
name|bwi_phy_init_11b_rev6
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
operator|||
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
condition|)
name|bwi_phy_config_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|2
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>
literal|5
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
operator|||
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
condition|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|val
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x400
argument_list|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|3
operator|||
name|val
operator|==
literal|5
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4c2
argument_list|,
literal|0x1816
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4c3
argument_list|,
literal|0x8006
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|5
condition|)
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4cc
argument_list|,
literal|0xff
argument_list|,
literal|0x1f00
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_rev
operator|<=
literal|2
operator|&&
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x47e
argument_list|,
literal|0x78
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x801
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x43e
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
operator|&&
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
condition|)
name|bwi_rf_get_gains
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|!=
literal|8
condition|)
name|bwi_rf_init
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpctl
operator|->
name|tp_ctrl2
operator|==
literal|0xffff
condition|)
block|{
name|bwi_rf_lo_update
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
operator|&&
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
operator|(
name|tpctl
operator|->
name|tp_ctrl1
operator|<<
literal|4
operator|)
operator||
name|tpctl
operator|->
name|tp_ctrl2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xfff0
argument_list|,
name|tpctl
operator|->
name|tp_ctrl2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|6
condition|)
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x36
argument_list|,
literal|0xfff
argument_list|,
name|tpctl
operator|->
name|tp_ctrl2
operator|<<
literal|12
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_PA_GPIO9
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2e
argument_list|,
literal|0x8075
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2e
argument_list|,
literal|0x807f
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|<
literal|2
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2f
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2f
argument_list|,
literal|0x202
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|bwi_rf_lo_adjust
argument_list|(
name|mac
argument_list|,
name|tpctl
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0x8078
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_SW_NRSSI
operator|)
operator|==
literal|0
condition|)
block|{
name|bwi_rf_init_hw_nrssi_table
argument_list|(
name|mac
argument_list|,
literal|0xffff
comment|/* XXX */
argument_list|)
expr_stmt|;
name|bwi_rf_set_nrssi_thr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
if|if
condition|(
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|==
name|BWI_INVALID_NRSSI
condition|)
block|{
name|KASSERT
argument_list|(
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|==
name|BWI_INVALID_NRSSI
argument_list|,
operator|(
literal|"rf_nrssi[1] %d"
operator|,
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
name|bwi_rf_calc_nrssi_slope
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|KASSERT
argument_list|(
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|!=
name|BWI_INVALID_NRSSI
argument_list|,
operator|(
literal|"rf_nrssi[1] %d"
operator|,
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
name|bwi_rf_set_nrssi_thr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x805
argument_list|,
literal|0x3230
argument_list|)
expr_stmt|;
name|bwi_mac_init_tpctl_11bg
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bbp_id
operator|==
name|BWI_BBPID_BCM4306
operator|&&
name|sc
operator|->
name|sc_bbp_pkg
operator|==
literal|2
condition|)
block|{
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x4c3
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_phy_init_11b_rev2
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* TODO:11B */
name|device_printf
argument_list|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_dev
argument_list|,
literal|"%s is not implemented yet\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_phy_init_11b_rev4
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|uint16_t
name|val
decl_stmt|,
name|ofs
decl_stmt|;
name|u_int
name|chan
decl_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|,
name|BWI_BPHY_CTRL_INIT
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|0x301c
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x26
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x30
argument_list|,
literal|0xc6
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x88
argument_list|,
literal|0x3e00
argument_list|)
expr_stmt|;
for|for
control|(
name|ofs
operator|=
literal|0
operator|,
name|val
operator|=
literal|0x3c3d
init|;
name|ofs
operator|<
literal|30
condition|;
operator|++
name|ofs
operator|,
name|val
operator|-=
literal|0x202
control|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x89
operator|+
name|ofs
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_MAGIC_REG1
argument_list|,
name|BWI_PHY_MAGIC_REG1_VAL1
argument_list|)
expr_stmt|;
name|chan
operator|=
name|rf
operator|->
name|rf_curchan
expr_stmt|;
if|if
condition|(
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
name|chan
operator|=
literal|6
expr_stmt|;
comment|/* Force to channel 6 */
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
name|chan
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|!=
name|BWI_RF_T_BCM2050
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x75
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x79
argument_list|,
literal|0x81
argument_list|)
expr_stmt|;
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x7b
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0xb0
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x38
argument_list|,
literal|0x677
argument_list|)
expr_stmt|;
name|bwi_rf_init_bcm2050
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x14
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x32
argument_list|,
literal|0xca
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x32
argument_list|,
literal|0xe0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|,
literal|0x7c2
argument_list|)
expr_stmt|;
name|bwi_rf_lo_update
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x26
argument_list|,
literal|0xcc00
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x26
argument_list|,
literal|0xce00
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
literal|0x1100
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x88a3
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x88c2
argument_list|)
expr_stmt|;
name|bwi_mac_set_tpctl_11bg
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_SW_NRSSI
condition|)
block|{
name|bwi_rf_calc_nrssi_slope
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwi_rf_set_nrssi_thr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|bwi_mac_init_tpctl_11bg
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_phy_init_11b_rev5
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|u_int
name|orig_chan
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|1
condition|)
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x50
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_pci_subvid
operator|!=
name|PCI_VENDOR_BROADCOM
operator|&&
name|sc
operator|->
name|sc_pci_subdid
operator|!=
name|BWI_PCI_SUBDEVICE_BU4306
condition|)
block|{
name|uint16_t
name|ofs
decl_stmt|,
name|val
decl_stmt|;
name|val
operator|=
literal|0x2120
expr_stmt|;
for|for
control|(
name|ofs
operator|=
literal|0xa8
init|;
name|ofs
operator|<
literal|0xc7
condition|;
operator|++
name|ofs
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|ofs
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|+=
literal|0x202
expr_stmt|;
block|}
block|}
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x700
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x38
argument_list|,
literal|0x667
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
block|{
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
block|}
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x42b
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x1c
argument_list|,
literal|0x186a
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x13
argument_list|,
literal|0xff
argument_list|,
literal|0x1900
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|,
literal|0xffc0
argument_list|,
literal|0x64
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xff80
argument_list|,
literal|0xa
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: bad_frame_preempt? */
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|1
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x26
argument_list|,
literal|0xce00
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x21
argument_list|,
literal|0x3763
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x22
argument_list|,
literal|0x1bc3
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x23
argument_list|,
literal|0x6f9
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x24
argument_list|,
literal|0x37e
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x26
argument_list|,
literal|0xcc00
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x30
argument_list|,
literal|0xc6
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|,
name|BWI_BPHY_CTRL_INIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|1
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|0x3e1c
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|0x301c
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|0
condition|)
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_MAGIC_REG1
argument_list|,
name|BWI_PHY_MAGIC_REG1_VAL1
argument_list|)
expr_stmt|;
comment|/* Force to channel 7 */
name|orig_chan
operator|=
name|rf
operator|->
name|rf_curchan
expr_stmt|;
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
literal|7
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|!=
name|BWI_RF_T_BCM2050
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x75
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x79
argument_list|,
literal|0x81
argument_list|)
expr_stmt|;
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x7b
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0xb0
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
name|orig_chan
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x14
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x32
argument_list|,
literal|0xca
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x88a3
argument_list|)
expr_stmt|;
name|bwi_mac_set_tpctl_11bg
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
name|CSR_FILT_SETBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_MAGIC_REG1
argument_list|,
literal|0xffc0
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_phy_init_11b_rev6
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|val
decl_stmt|,
name|ofs
decl_stmt|;
name|u_int
name|orig_chan
decl_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3e
argument_list|,
literal|0x817a
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x58
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|4
operator|||
name|rf
operator|->
name|rf_rev
operator|==
literal|5
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x37
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x53
argument_list|,
literal|0xb3
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x54
argument_list|,
literal|0x9b
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5e
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7d
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|HFLAGS_SETBITS
argument_list|(
name|mac
argument_list|,
name|BWI_HFLAG_MAGIC1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x53
argument_list|,
literal|0xb7
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x54
argument_list|,
literal|0x98
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x6b
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_ALT_IQ
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xfa
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5e
argument_list|,
literal|0xd8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xf5
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5e
argument_list|,
literal|0xb8
argument_list|)
expr_stmt|;
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x73
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7d
argument_list|,
literal|0xa8
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7c
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7e
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
literal|0x1e1f
expr_stmt|;
for|for
control|(
name|ofs
operator|=
literal|0x88
init|;
name|ofs
operator|<
literal|0x98
condition|;
operator|++
name|ofs
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|ofs
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|-=
literal|0x202
expr_stmt|;
block|}
name|val
operator|=
literal|0x3e3f
expr_stmt|;
for|for
control|(
name|ofs
operator|=
literal|0x98
init|;
name|ofs
operator|<
literal|0xa8
condition|;
operator|++
name|ofs
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|ofs
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|-=
literal|0x202
expr_stmt|;
block|}
name|val
operator|=
literal|0x2120
expr_stmt|;
for|for
control|(
name|ofs
operator|=
literal|0xa8
init|;
name|ofs
operator|<
literal|0xc8
condition|;
operator|++
name|ofs
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|ofs
argument_list|,
operator|(
name|val
operator|&
literal|0x3f3f
operator|)
argument_list|)
expr_stmt|;
name|val
operator|+=
literal|0x202
expr_stmt|;
comment|/* XXX: delay 10 us to avoid PCI parity errors with BCM4318 */
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11G
condition|)
block|{
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x42b
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Force to channel 7 */
name|orig_chan
operator|=
name|rf
operator|->
name|rf_curchan
expr_stmt|;
if|if
condition|(
name|orig_chan
operator|>=
literal|8
condition|)
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
literal|13
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|40
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|<
literal|6
operator|||
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7c
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x50
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|<=
literal|2
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7c
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5b
argument_list|,
literal|0x7b
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5c
argument_list|,
literal|0xb0
argument_list|)
expr_stmt|;
block|}
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xf8
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
name|orig_chan
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x14
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|>=
literal|6
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x88c2
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x8ac0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x38
argument_list|,
literal|0x668
argument_list|)
expr_stmt|;
name|bwi_mac_set_tpctl_11bg
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|<=
literal|5
condition|)
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xff80
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|<=
literal|2
condition|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5d
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|4
condition|)
block|{
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_MAGIC_REG1
argument_list|,
name|BWI_PHY_MAGIC_REG1_VAL2
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x61
argument_list|,
literal|0xf000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x2
argument_list|,
literal|0xffc0
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11B
condition|)
block|{
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
name|BWI_BBP_ATTEN_MAGIC2
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x16
argument_list|,
literal|0x410
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x17
argument_list|,
literal|0x820
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x62
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
name|bwi_rf_init_bcm2050
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwi_rf_lo_update
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_SW_NRSSI
condition|)
block|{
name|bwi_rf_calc_nrssi_slope
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwi_rf_set_nrssi_thr
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|bwi_mac_init_tpctl_11bg
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_phy_config_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
specifier|const
name|uint16_t
modifier|*
name|tbl
decl_stmt|;
name|uint16_t
name|wrd_ofs1
decl_stmt|,
name|wrd_ofs2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x406
argument_list|,
literal|0x4f19
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0xfc3f
argument_list|,
literal|0x340
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x42c
argument_list|,
literal|0x5a
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x427
argument_list|,
literal|0x1a
argument_list|)
expr_stmt|;
comment|/* Fill frequency table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|bwi_phy_freq_11g_rev1
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_FREQ
operator|+
name|i
argument_list|,
name|bwi_phy_freq_11g_rev1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* Fill noise table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|bwi_phy_noise_11g_rev1
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_NOISE
operator|+
name|i
argument_list|,
name|bwi_phy_noise_11g_rev1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* Fill rotor table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|bwi_phy_rotor_11g_rev1
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
comment|/* NB: data length is 4 bytes */
name|bwi_tbl_write_4
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_ROTOR
operator|+
name|i
argument_list|,
name|bwi_phy_rotor_11g_rev1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|bwi_nrssi_write
argument_list|(
name|mac
argument_list|,
literal|0xba98
argument_list|,
operator|(
name|int16_t
operator|)
literal|0x7654
argument_list|)
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|2
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4c0
argument_list|,
literal|0x1861
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4c1
argument_list|,
literal|0x271
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>
literal|2
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4c0
argument_list|,
literal|0x98
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4c1
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4c9
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
block|}
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x42b
argument_list|,
literal|0x800
argument_list|)
expr_stmt|;
comment|/* Fill RSSI table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
operator|++
name|i
control|)
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_RSSI
operator|+
name|i
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Fill noise table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|bwi_phy_noise_11g
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_NOISE
operator|+
name|i
argument_list|,
name|bwi_phy_noise_11g
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Fill noise scale table 	 */
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|<=
literal|2
condition|)
block|{
name|tbl
operator|=
name|bwi_phy_noise_scale_11g_rev2
expr_stmt|;
name|n
operator|=
name|nitems
argument_list|(
name|bwi_phy_noise_scale_11g_rev2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|7
operator|&&
operator|(
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x449
argument_list|)
operator|&
literal|0x200
operator|)
condition|)
block|{
name|tbl
operator|=
name|bwi_phy_noise_scale_11g_rev7
expr_stmt|;
name|n
operator|=
name|nitems
argument_list|(
name|bwi_phy_noise_scale_11g_rev7
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tbl
operator|=
name|bwi_phy_noise_scale_11g
expr_stmt|;
name|n
operator|=
name|nitems
argument_list|(
name|bwi_phy_noise_scale_11g
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_NOISE_SCALE
operator|+
name|i
argument_list|,
name|tbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Fill sigma square table 	 */
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|2
condition|)
block|{
name|tbl
operator|=
name|bwi_phy_sigma_sq_11g_rev2
expr_stmt|;
name|n
operator|=
name|nitems
argument_list|(
name|bwi_phy_sigma_sq_11g_rev2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>
literal|2
operator|&&
name|phy
operator|->
name|phy_rev
operator|<=
literal|8
condition|)
block|{
name|tbl
operator|=
name|bwi_phy_sigma_sq_11g_rev7
expr_stmt|;
name|n
operator|=
name|nitems
argument_list|(
name|bwi_phy_sigma_sq_11g_rev7
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tbl
operator|=
name|NULL
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_SIGMA_SQ
operator|+
name|i
argument_list|,
name|tbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
block|{
comment|/* Fill delay table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|bwi_phy_delay_11g_rev1
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|bwi_tbl_write_4
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_DELAY
operator|+
name|i
argument_list|,
name|bwi_phy_delay_11g_rev1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* Fill WRSSI (Wide-Band RSSI) table */
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|20
condition|;
operator|++
name|i
control|)
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_WRSSI_REV1
operator|+
name|i
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|bwi_phy_config_agc
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|wrd_ofs1
operator|=
literal|0x5001
expr_stmt|;
name|wrd_ofs2
operator|=
literal|0x5002
expr_stmt|;
block|}
else|else
block|{
comment|/* Fill WRSSI (Wide-Band RSSI) table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x20
condition|;
operator|++
name|i
control|)
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|BWI_PHYTBL_WRSSI
operator|+
name|i
argument_list|,
literal|0x820
argument_list|)
expr_stmt|;
name|bwi_phy_config_agc
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
comment|/* Dummy read */
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x403
argument_list|,
literal|0x1000
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
literal|0x3c02
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
literal|0x3c03
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|wrd_ofs1
operator|=
literal|0x401
expr_stmt|;
name|wrd_ofs2
operator|=
literal|0x402
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|BWI_IS_BRCM_BU4306
argument_list|(
name|sc
argument_list|)
operator|&&
name|sc
operator|->
name|sc_pci_revid
operator|==
literal|0x17
operator|)
condition|)
block|{
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|wrd_ofs1
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|wrd_ofs2
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
block|}
comment|/* phy->phy_flags& BWI_PHY_F_LINKED ? */
if|if
condition|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_PA_GPIO9
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x46e
argument_list|,
literal|0x3cf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Configure Automatic Gain Controller  */
end_comment

begin_function
specifier|static
name|void
name|bwi_phy_config_agc
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|ofs
decl_stmt|;
name|ofs
operator|=
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|?
literal|0x4c00
else|:
literal|0
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
argument_list|,
literal|0xfe
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
operator|+
literal|1
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
operator|+
literal|2
argument_list|,
literal|0x13
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
operator|+
literal|3
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
block|{
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
literal|0x1800
argument_list|,
literal|0x2710
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
literal|0x1801
argument_list|,
literal|0x9b83
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
literal|0x1802
argument_list|,
literal|0x9b83
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
literal|0x1803
argument_list|,
literal|0xf8d
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x455
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
block|}
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a5
argument_list|,
literal|0xff
argument_list|,
literal|0x5700
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x41a
argument_list|,
literal|0xff80
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x41a
argument_list|,
literal|0xc07f
argument_list|,
literal|0x2b80
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x48c
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x300
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a0
argument_list|,
literal|0xfff0
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a1
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x600
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a2
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x700
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a0
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a2
argument_list|,
literal|0xfff0
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x488
argument_list|,
literal|0xff00
argument_list|,
literal|0x1c
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x488
argument_list|,
literal|0xc0ff
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x496
argument_list|,
literal|0xff00
argument_list|,
literal|0x1c
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x489
argument_list|,
literal|0xff00
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x489
argument_list|,
literal|0xc0ff
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x482
argument_list|,
literal|0xff00
argument_list|,
literal|0x2e
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x496
argument_list|,
literal|0xff
argument_list|,
literal|0x1a00
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x481
argument_list|,
literal|0xff00
argument_list|,
literal|0x28
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x481
argument_list|,
literal|0xff
argument_list|,
literal|0x2c00
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x430
argument_list|,
literal|0x92b
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x41b
argument_list|,
literal|0xffe1
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x41b
argument_list|,
literal|0x1e
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x41f
argument_list|,
literal|0x287a
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x420
argument_list|,
literal|0xfff0
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|6
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x422
argument_list|,
literal|0x287a
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x420
argument_list|,
literal|0xfff
argument_list|,
literal|0x3000
argument_list|)
expr_stmt|;
block|}
block|}
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a8
argument_list|,
literal|0x8080
argument_list|,
literal|0x7874
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x48e
argument_list|,
literal|0x1c00
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|1
condition|)
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4ab
argument_list|,
literal|0xf0ff
argument_list|,
literal|0x600
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x48b
argument_list|,
literal|0x5e
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x48c
argument_list|,
literal|0xff00
argument_list|,
literal|0x1e
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x48d
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
block|}
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
operator|+
literal|0x800
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
operator|+
literal|0x801
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
operator|+
literal|0x802
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|ofs
operator|+
literal|0x803
argument_list|,
literal|28
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|6
condition|)
block|{
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x426
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x426
argument_list|,
literal|0x1000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|bwi_set_gains
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwi_gains
modifier|*
name|gains
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|tbl_gain_ofs1
decl_stmt|,
name|tbl_gain_ofs2
decl_stmt|,
name|tbl_gain
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|<=
literal|1
condition|)
block|{
name|tbl_gain_ofs1
operator|=
literal|0x5000
expr_stmt|;
name|tbl_gain_ofs2
operator|=
name|tbl_gain_ofs1
operator|+
literal|16
expr_stmt|;
block|}
else|else
block|{
name|tbl_gain_ofs1
operator|=
literal|0x400
expr_stmt|;
name|tbl_gain_ofs2
operator|=
name|tbl_gain_ofs1
operator|+
literal|8
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gains
operator|!=
name|NULL
condition|)
block|{
name|tbl_gain
operator|=
name|gains
operator|->
name|tbl_gain1
expr_stmt|;
block|}
else|else
block|{
comment|/* Bit swap */
name|tbl_gain
operator|=
operator|(
name|i
operator|&
literal|0x1
operator|)
operator|<<
literal|1
expr_stmt|;
name|tbl_gain
operator||=
operator|(
name|i
operator|&
literal|0x2
operator|)
operator|>>
literal|1
expr_stmt|;
block|}
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|tbl_gain_ofs1
operator|+
name|i
argument_list|,
name|tbl_gain
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|gains
operator|!=
name|NULL
condition|)
name|tbl_gain
operator|=
name|gains
operator|->
name|tbl_gain2
expr_stmt|;
else|else
name|tbl_gain
operator|=
name|i
expr_stmt|;
name|bwi_tbl_write_2
argument_list|(
name|mac
argument_list|,
name|tbl_gain_ofs2
operator|+
name|i
argument_list|,
name|tbl_gain
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gains
operator|==
name|NULL
operator|||
operator|(
name|gains
operator|!=
name|NULL
operator|&&
name|gains
operator|->
name|phy_gain
operator|!=
operator|-
literal|1
operator|)
condition|)
block|{
name|uint16_t
name|phy_gain1
decl_stmt|,
name|phy_gain2
decl_stmt|;
if|if
condition|(
name|gains
operator|!=
name|NULL
condition|)
block|{
name|phy_gain1
operator|=
operator|(
operator|(
name|uint16_t
operator|)
name|gains
operator|->
name|phy_gain
operator|<<
literal|14
operator|)
operator||
operator|(
operator|(
name|uint16_t
operator|)
name|gains
operator|->
name|phy_gain
operator|<<
literal|6
operator|)
expr_stmt|;
name|phy_gain2
operator|=
name|phy_gain1
expr_stmt|;
block|}
else|else
block|{
name|phy_gain1
operator|=
literal|0x4040
expr_stmt|;
name|phy_gain2
operator|=
literal|0x4000
expr_stmt|;
block|}
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a0
argument_list|,
literal|0xbfbf
argument_list|,
name|phy_gain1
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a1
argument_list|,
literal|0xbfbf
argument_list|,
name|phy_gain1
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4a2
argument_list|,
literal|0xbfbf
argument_list|,
name|phy_gain2
argument_list|)
expr_stmt|;
block|}
name|bwi_mac_dummy_xmit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwi_phy_clear_state
parameter_list|(
name|struct
name|bwi_phy
modifier|*
name|phy
parameter_list|)
block|{
name|phy
operator|->
name|phy_flags
operator|&=
operator|~
name|BWI_CLEAR_PHY_FLAGS
expr_stmt|;
block|}
end_function

end_unit


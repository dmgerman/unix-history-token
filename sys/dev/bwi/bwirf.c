begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2007 The DragonFly Project.  All rights reserved.  *   * This code is derived from software contributed to The DragonFly Project  * by Sepherosa Ziehau<sepherosa@gmail.com>  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *   * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  * 3. Neither the name of The DragonFly Project nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific, prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * $DragonFly: src/sys/dev/netif/bwi/bwirf.c,v 1.9 2008/08/21 12:19:33 swildner Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_bwi.h"
end_include

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_amrr.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bitops.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/if_bwireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/if_bwivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bwimac.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bwirf.h>
end_include

begin_include
include|#
directive|include
file|<dev/bwi/bwiphy.h>
end_include

begin_define
define|#
directive|define
name|RF_LO_WRITE
parameter_list|(
name|mac
parameter_list|,
name|lo
parameter_list|)
value|bwi_rf_lo_write((mac), (lo))
end_define

begin_define
define|#
directive|define
name|BWI_RF_2GHZ_CHAN
parameter_list|(
name|chan
parameter_list|)
define|\
value|(ieee80211_ieee2mhz((chan), IEEE80211_CHAN_2GHZ) - 2400)
end_define

begin_define
define|#
directive|define
name|BWI_DEFAULT_IDLE_TSSI
value|52
end_define

begin_struct
struct|struct
name|rf_saveregs
block|{
name|uint16_t
name|phy_01
decl_stmt|;
name|uint16_t
name|phy_03
decl_stmt|;
name|uint16_t
name|phy_0a
decl_stmt|;
name|uint16_t
name|phy_15
decl_stmt|;
name|uint16_t
name|phy_2a
decl_stmt|;
name|uint16_t
name|phy_30
decl_stmt|;
name|uint16_t
name|phy_35
decl_stmt|;
name|uint16_t
name|phy_60
decl_stmt|;
name|uint16_t
name|phy_429
decl_stmt|;
name|uint16_t
name|phy_802
decl_stmt|;
name|uint16_t
name|phy_811
decl_stmt|;
name|uint16_t
name|phy_812
decl_stmt|;
name|uint16_t
name|phy_814
decl_stmt|;
name|uint16_t
name|phy_815
decl_stmt|;
name|uint16_t
name|rf_43
decl_stmt|;
name|uint16_t
name|rf_52
decl_stmt|;
name|uint16_t
name|rf_7a
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SAVE_RF_REG
parameter_list|(
name|mac
parameter_list|,
name|regs
parameter_list|,
name|n
parameter_list|)
value|(regs)->rf_##n = RF_READ((mac), 0x##n)
end_define

begin_define
define|#
directive|define
name|RESTORE_RF_REG
parameter_list|(
name|mac
parameter_list|,
name|regs
parameter_list|,
name|n
parameter_list|)
value|RF_WRITE((mac), 0x##n, (regs)->rf_##n)
end_define

begin_define
define|#
directive|define
name|SAVE_PHY_REG
parameter_list|(
name|mac
parameter_list|,
name|regs
parameter_list|,
name|n
parameter_list|)
value|(regs)->phy_##n = PHY_READ((mac), 0x##n)
end_define

begin_define
define|#
directive|define
name|RESTORE_PHY_REG
parameter_list|(
name|mac
parameter_list|,
name|regs
parameter_list|,
name|n
parameter_list|)
value|PHY_WRITE((mac), 0x##n, (regs)->phy_##n)
end_define

begin_function_decl
specifier|static
name|int
name|bwi_rf_calc_txpower
parameter_list|(
name|int8_t
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|int16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_work_around
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwi_rf_gain_max_reached
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwi_rf_calibval
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwi_rf_get_tp_ctrl2
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_lo_update_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|bwi_rf_lo_measure_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_lo_update_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|bwi_rf_lo_devi_measure
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_lo_measure_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwi_rf_lo
modifier|*
parameter_list|,
name|struct
name|bwi_rf_lo
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|_bwi_rf_lo_update_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_lo_write
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwi_rf_lo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_set_nrssi_ofs_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_calc_nrssi_slope_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_calc_nrssi_slope_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_set_nrssi_thr_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_set_nrssi_thr_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_init_sw_nrssi_table
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwi_rf_calc_rssi_bcm2050
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwi_rxbuf_hdr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwi_rf_calc_rssi_bcm2053
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwi_rxbuf_hdr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwi_rf_calc_rssi_bcm2060
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|,
specifier|const
name|struct
name|bwi_rxbuf_hdr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwi_rf_calc_noise_bcm2050
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwi_rf_calc_noise_bcm2053
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bwi_rf_calc_noise_bcm2060
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_on_11a
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_on_11bg
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_off_11a
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_off_11bg
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|bwi_rf_off_11g_rev5
parameter_list|(
name|struct
name|bwi_mac
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|int8_t
name|bwi_txpower_map_11b
index|[
name|BWI_TSSI_MAX
index|]
init|=
block|{
name|BWI_TXPOWER_MAP_11B
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|int8_t
name|bwi_txpower_map_11g
index|[
name|BWI_TSSI_MAX
index|]
init|=
block|{
name|BWI_TXPOWER_MAP_11G
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|__inline
name|int16_t
name|bwi_nrssi_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|int16_t
name|val
decl_stmt|;
define|#
directive|define
name|NRSSI_11G_MASK
value|__BITS(13, 8)
name|val
operator|=
operator|(
name|int16_t
operator|)
name|__SHIFTOUT
argument_list|(
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x47f
argument_list|)
argument_list|,
name|NRSSI_11G_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>=
literal|32
condition|)
name|val
operator|-=
literal|64
expr_stmt|;
return|return
name|val
return|;
undef|#
directive|undef
name|NRSSI_11G_MASK
block|}
end_function

begin_expr_stmt
specifier|static
name|__inline
expr|struct
name|bwi_rf_lo
operator|*
name|bwi_get_rf_lo
argument_list|(
argument|struct bwi_mac *mac
argument_list|,
argument|uint16_t rf_atten
argument_list|,
argument|uint16_t bbp_atten
argument_list|)
block|{
name|int
name|n
block|;
name|n
operator|=
name|rf_atten
operator|+
operator|(
literal|14
operator|*
operator|(
name|bbp_atten
operator|/
literal|2
operator|)
operator|)
block|;
name|KASSERT
argument_list|(
name|n
operator|<
name|BWI_RFLO_MAX
argument_list|,
operator|(
literal|"n %d"
operator|,
name|n
operator|)
argument_list|)
block|;
return|return
operator|&
name|mac
operator|->
name|mac_rf
operator|.
name|rf_lo
index|[
name|n
index|]
return|;
block|}
end_expr_stmt

begin_function
specifier|static
name|__inline
name|int
name|bwi_rf_lo_isused
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwi_rf_lo
modifier|*
name|lo
parameter_list|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|idx
operator|=
name|lo
operator|-
name|rf
operator|->
name|rf_lo
expr_stmt|;
name|KASSERT
argument_list|(
name|idx
operator|>=
literal|0
operator|&&
name|idx
operator|<
name|BWI_RFLO_MAX
argument_list|,
operator|(
literal|"idx %d"
operator|,
name|idx
operator|)
argument_list|)
expr_stmt|;
return|return
name|isset
argument_list|(
name|rf
operator|->
name|rf_lo_used
argument_list|,
name|idx
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|bwi_rf_write
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ctrl
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CTRL
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_DATA_LO
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint16_t
name|bwi_rf_read
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ctrl
parameter_list|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|ctrl
operator||=
name|rf
operator|->
name|rf_ctrl_rd
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_ctrl_adj
condition|)
block|{
comment|/* XXX */
if|if
condition|(
name|ctrl
operator|<
literal|0x70
condition|)
name|ctrl
operator|+=
literal|0x80
expr_stmt|;
elseif|else
if|if
condition|(
name|ctrl
operator|<
literal|0x80
condition|)
name|ctrl
operator|+=
literal|0x70
expr_stmt|;
block|}
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CTRL
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
return|return
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_DATA_LO
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|bwi_rf_attach
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|uint16_t
name|type
decl_stmt|,
name|manu
decl_stmt|;
name|uint8_t
name|rev
decl_stmt|;
comment|/* 	 * Get RF manufacture/type/revision 	 */
if|if
condition|(
name|sc
operator|->
name|sc_bbp_id
operator|==
name|BWI_BBPID_BCM4317
condition|)
block|{
comment|/* 		 * Fake a BCM2050 RF 		 */
name|manu
operator|=
name|BWI_RF_MANUFACT_BCM
expr_stmt|;
name|type
operator|=
name|BWI_RF_T_BCM2050
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_bbp_rev
operator|==
literal|0
condition|)
name|rev
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_bbp_rev
operator|==
literal|1
condition|)
name|rev
operator|=
literal|4
expr_stmt|;
else|else
name|rev
operator|=
literal|5
expr_stmt|;
block|}
else|else
block|{
name|uint32_t
name|val
decl_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CTRL
argument_list|,
name|BWI_RF_CTRL_RFINFO
argument_list|)
expr_stmt|;
name|val
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_DATA_HI
argument_list|)
expr_stmt|;
name|val
operator|<<=
literal|16
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CTRL
argument_list|,
name|BWI_RF_CTRL_RFINFO
argument_list|)
expr_stmt|;
name|val
operator||=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_DATA_LO
argument_list|)
expr_stmt|;
name|manu
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_RFINFO_MANUFACT_MASK
argument_list|)
expr_stmt|;
name|type
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_RFINFO_TYPE_MASK
argument_list|)
expr_stmt|;
name|rev
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_RFINFO_REV_MASK
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"RF: manu 0x%03x, type 0x%04x, rev %u\n"
argument_list|,
name|manu
argument_list|,
name|type
argument_list|,
name|rev
argument_list|)
expr_stmt|;
comment|/* 	 * Verify whether the RF is supported 	 */
name|rf
operator|->
name|rf_ctrl_rd
operator|=
literal|0
expr_stmt|;
name|rf
operator|->
name|rf_ctrl_adj
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|phy
operator|->
name|phy_mode
condition|)
block|{
case|case
name|IEEE80211_MODE_11A
case|:
if|if
condition|(
name|manu
operator|!=
name|BWI_RF_MANUFACT_BCM
operator|||
name|type
operator|!=
name|BWI_RF_T_BCM2060
operator|||
name|rev
operator|!=
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"only BCM2060 rev 1 RF "
literal|"is supported for 11A PHY\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|rf
operator|->
name|rf_ctrl_rd
operator|=
name|BWI_RF_CTRL_RD_11A
expr_stmt|;
name|rf
operator|->
name|rf_on
operator|=
name|bwi_rf_on_11a
expr_stmt|;
name|rf
operator|->
name|rf_off
operator|=
name|bwi_rf_off_11a
expr_stmt|;
name|rf
operator|->
name|rf_calc_rssi
operator|=
name|bwi_rf_calc_rssi_bcm2060
expr_stmt|;
name|rf
operator|->
name|rf_calc_noise
operator|=
name|bwi_rf_calc_noise_bcm2060
expr_stmt|;
break|break;
case|case
name|IEEE80211_MODE_11B
case|:
if|if
condition|(
name|type
operator|==
name|BWI_RF_T_BCM2050
condition|)
block|{
name|rf
operator|->
name|rf_ctrl_rd
operator|=
name|BWI_RF_CTRL_RD_11BG
expr_stmt|;
name|rf
operator|->
name|rf_calc_rssi
operator|=
name|bwi_rf_calc_rssi_bcm2050
expr_stmt|;
name|rf
operator|->
name|rf_calc_noise
operator|=
name|bwi_rf_calc_noise_bcm2050
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|BWI_RF_T_BCM2053
condition|)
block|{
name|rf
operator|->
name|rf_ctrl_adj
operator|=
literal|1
expr_stmt|;
name|rf
operator|->
name|rf_calc_rssi
operator|=
name|bwi_rf_calc_rssi_bcm2053
expr_stmt|;
name|rf
operator|->
name|rf_calc_noise
operator|=
name|bwi_rf_calc_noise_bcm2053
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"only BCM2050/BCM2053 RF "
literal|"is supported for 11B PHY\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|rf
operator|->
name|rf_on
operator|=
name|bwi_rf_on_11bg
expr_stmt|;
name|rf
operator|->
name|rf_off
operator|=
name|bwi_rf_off_11bg
expr_stmt|;
name|rf
operator|->
name|rf_calc_nrssi_slope
operator|=
name|bwi_rf_calc_nrssi_slope_11b
expr_stmt|;
name|rf
operator|->
name|rf_set_nrssi_thr
operator|=
name|bwi_rf_set_nrssi_thr_11b
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|6
condition|)
name|rf
operator|->
name|rf_lo_update
operator|=
name|bwi_rf_lo_update_11g
expr_stmt|;
else|else
name|rf
operator|->
name|rf_lo_update
operator|=
name|bwi_rf_lo_update_11b
expr_stmt|;
break|break;
case|case
name|IEEE80211_MODE_11G
case|:
if|if
condition|(
name|type
operator|!=
name|BWI_RF_T_BCM2050
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"only BCM2050 RF "
literal|"is supported for 11G PHY\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|rf
operator|->
name|rf_ctrl_rd
operator|=
name|BWI_RF_CTRL_RD_11BG
expr_stmt|;
name|rf
operator|->
name|rf_on
operator|=
name|bwi_rf_on_11bg
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_rev
operator|>=
literal|5
condition|)
name|rf
operator|->
name|rf_off
operator|=
name|bwi_rf_off_11g_rev5
expr_stmt|;
else|else
name|rf
operator|->
name|rf_off
operator|=
name|bwi_rf_off_11bg
expr_stmt|;
name|rf
operator|->
name|rf_calc_nrssi_slope
operator|=
name|bwi_rf_calc_nrssi_slope_11g
expr_stmt|;
name|rf
operator|->
name|rf_set_nrssi_thr
operator|=
name|bwi_rf_set_nrssi_thr_11g
expr_stmt|;
name|rf
operator|->
name|rf_calc_rssi
operator|=
name|bwi_rf_calc_rssi_bcm2050
expr_stmt|;
name|rf
operator|->
name|rf_calc_noise
operator|=
name|bwi_rf_calc_noise_bcm2050
expr_stmt|;
name|rf
operator|->
name|rf_lo_update
operator|=
name|bwi_rf_lo_update_11g
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unsupported PHY mode\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|rf
operator|->
name|rf_type
operator|=
name|type
expr_stmt|;
name|rf
operator|->
name|rf_rev
operator|=
name|rev
expr_stmt|;
name|rf
operator|->
name|rf_manu
operator|=
name|manu
expr_stmt|;
name|rf
operator|->
name|rf_curchan
operator|=
name|IEEE80211_CHAN_ANY
expr_stmt|;
name|rf
operator|->
name|rf_ant_mode
operator|=
name|BWI_ANT_MODE_AUTO
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|bwi_rf_set_chan
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|u_int
name|chan
parameter_list|,
name|int
name|work_around
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
if|if
condition|(
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
return|return;
name|MOBJ_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_CHAN
argument_list|,
name|chan
argument_list|)
expr_stmt|;
comment|/* TODO: 11A */
if|if
condition|(
name|work_around
condition|)
name|bwi_rf_work_around
argument_list|(
name|mac
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN
argument_list|,
name|BWI_RF_2GHZ_CHAN
argument_list|(
name|chan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|==
literal|14
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_locale
operator|==
name|BWI_SPROM_LOCALE_JAPAN
condition|)
name|HFLAGS_CLRBITS
argument_list|(
name|mac
argument_list|,
name|BWI_HFLAG_NOT_JAPAN
argument_list|)
expr_stmt|;
else|else
name|HFLAGS_SETBITS
argument_list|(
name|mac
argument_list|,
name|BWI_HFLAG_NOT_JAPAN
argument_list|)
expr_stmt|;
name|CSR_SETBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
operator|(
literal|1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX */
block|}
else|else
block|{
name|CSR_CLRBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
literal|0x840
argument_list|)
expr_stmt|;
comment|/* XXX */
block|}
name|DELAY
argument_list|(
literal|8000
argument_list|)
expr_stmt|;
comment|/* DELAY(2000); */
name|mac
operator|->
name|mac_rf
operator|.
name|rf_curchan
operator|=
name|chan
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwi_rf_get_gains
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|SAVE_PHY_MAX
value|15
define|#
directive|define
name|SAVE_RF_MAX
value|3
specifier|static
specifier|const
name|uint16_t
name|save_rf_regs
index|[
name|SAVE_RF_MAX
index|]
init|=
block|{
literal|0x52
block|,
literal|0x43
block|,
literal|0x7a
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_regs
index|[
name|SAVE_PHY_MAX
index|]
init|=
block|{
literal|0x0429
block|,
literal|0x0001
block|,
literal|0x0811
block|,
literal|0x0812
block|,
literal|0x0814
block|,
literal|0x0815
block|,
literal|0x005a
block|,
literal|0x0059
block|,
literal|0x0058
block|,
literal|0x000a
block|,
literal|0x0003
block|,
literal|0x080f
block|,
literal|0x0810
block|,
literal|0x002b
block|,
literal|0x0015
block|}
decl_stmt|;
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|uint16_t
name|save_phy
index|[
name|SAVE_PHY_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_rf
index|[
name|SAVE_RF_MAX
index|]
decl_stmt|;
name|uint16_t
name|trsw
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|loop1_max
decl_stmt|,
name|loop1
decl_stmt|,
name|loop2
decl_stmt|;
comment|/* 	 * Save PHY/RF registers for later restoration 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_MAX
condition|;
operator|++
name|i
control|)
name|save_phy
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x2d
argument_list|)
expr_stmt|;
comment|/* dummy read */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|save_rf
index|[
name|i
index|]
operator|=
name|RF_READ
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0xc000
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x1
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
literal|0x2
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0xc
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xc
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xffcf
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x780
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x59
argument_list|,
literal|0xc810
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0xa
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x3
argument_list|,
literal|0xff9f
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|loop1_max
operator|=
literal|15
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
name|loop1_max
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|loop1_max
operator|=
literal|9
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
name|loop1_max
argument_list|)
expr_stmt|;
block|}
name|bwi_phy_set_bbp_atten
argument_list|(
name|mac
argument_list|,
literal|11
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|3
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0xc020
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0x8020
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x2b
argument_list|,
literal|0xffc0
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x2b
argument_list|,
literal|0xc0ff
argument_list|,
literal|0x800
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x3000
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_EXT_LNA
operator|)
operator|&&
name|phy
operator|->
name|phy_rev
operator|>=
literal|7
condition|)
block|{
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x800
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
block|}
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* 	 * Find out 'loop1/loop2', which will be used to calculate 	 * max loopback gain later 	 */
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|loop1_max
condition|;
operator|++
name|i
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
operator|++
name|j
control|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|bwi_rf_gain_max_reached
argument_list|(
name|mac
argument_list|,
name|j
argument_list|)
condition|)
goto|goto
name|loop1_exit
goto|;
block|}
block|}
name|loop1_exit
label|:
name|loop1
operator|=
name|i
expr_stmt|;
name|loop2
operator|=
name|j
expr_stmt|;
comment|/* 	 * Find out 'trsw', which will be used to calculate 	 * TRSW(TX/RX switch) RX gain later 	 */
if|if
condition|(
name|loop2
operator|>=
literal|8
condition|)
block|{
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|trsw
operator|=
literal|0x1b
expr_stmt|;
for|for
control|(
name|i
operator|=
name|loop2
operator|-
literal|8
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
name|trsw
operator|-=
literal|3
expr_stmt|;
if|if
condition|(
name|bwi_rf_gain_max_reached
argument_list|(
name|mac
argument_list|,
name|i
argument_list|)
condition|)
break|break;
block|}
block|}
else|else
block|{
name|trsw
operator|=
literal|0x18
expr_stmt|;
block|}
comment|/* 	 * Restore saved PHY/RF registers 	 */
comment|/* First 4 saved PHY registers need special processing */
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
name|SAVE_PHY_MAX
condition|;
operator|++
name|i
control|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
name|i
index|]
argument_list|,
name|save_phy
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bwi_phy_set_bbp_atten
argument_list|(
name|mac
argument_list|,
name|mac
operator|->
name|mac_tpctl
operator|.
name|bbp_atten
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|,
name|save_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
literal|2
index|]
argument_list|,
name|save_phy
index|[
literal|2
index|]
operator||
literal|0x3
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
literal|2
index|]
argument_list|,
name|save_phy
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
literal|3
index|]
argument_list|,
name|save_phy
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
literal|0
index|]
argument_list|,
name|save_phy
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
literal|1
index|]
argument_list|,
name|save_phy
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Calculate gains 	 */
name|rf
operator|->
name|rf_lo_gain
operator|=
operator|(
name|loop2
operator|*
literal|6
operator|)
operator|-
operator|(
name|loop1
operator|*
literal|4
operator|)
operator|-
literal|11
expr_stmt|;
name|rf
operator|->
name|rf_rx_gain
operator|=
name|trsw
operator|*
literal|2
expr_stmt|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_INIT
argument_list|,
literal|"lo gain: %u, rx gain: %u\n"
argument_list|,
name|rf
operator|->
name|rf_lo_gain
argument_list|,
name|rf
operator|->
name|rf_rx_gain
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SAVE_RF_MAX
undef|#
directive|undef
name|SAVE_PHY_MAX
block|}
end_function

begin_function
name|void
name|bwi_rf_init
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2060
condition|)
block|{
comment|/* TODO: 11A */
block|}
else|else
block|{
if|if
condition|(
name|rf
operator|->
name|rf_flags
operator|&
name|BWI_RF_F_INITED
condition|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x78
argument_list|,
name|rf
operator|->
name|rf_calib
argument_list|)
expr_stmt|;
else|else
name|bwi_rf_init_bcm2050
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_off_11a
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x4
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5
argument_list|,
literal|0xfb
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x10
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x11
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xaa00
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_off_11bg
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xaa00
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_off_11g_rev5
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x8c
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x8c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_work_around
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|u_int
name|chan
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
if|if
condition|(
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s invalid channel!!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|!=
name|BWI_RF_T_BCM2050
operator|||
name|rf
operator|->
name|rf_rev
operator|>=
literal|6
condition|)
return|return;
if|if
condition|(
name|chan
operator|<=
literal|10
condition|)
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN
argument_list|,
name|BWI_RF_2GHZ_CHAN
argument_list|(
name|chan
operator|+
literal|4
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN
argument_list|,
name|BWI_RF_2GHZ_CHAN
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN
argument_list|,
name|BWI_RF_2GHZ_CHAN
argument_list|(
name|chan
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|__inline
expr|struct
name|bwi_rf_lo
operator|*
name|bwi_rf_lo_find
argument_list|(
argument|struct bwi_mac *mac
argument_list|,
argument|const struct bwi_tpctl *tpctl
argument_list|)
block|{
name|uint16_t
name|rf_atten
block|,
name|bbp_atten
block|;
name|int
name|remap_rf_atten
block|;
name|remap_rf_atten
operator|=
literal|1
block|;
if|if
condition|(
name|tpctl
operator|==
name|NULL
condition|)
block|{
name|bbp_atten
operator|=
literal|2
expr_stmt|;
name|rf_atten
operator|=
literal|3
expr_stmt|;
block|}
end_expr_stmt

begin_else
else|else
block|{
if|if
condition|(
name|tpctl
operator|->
name|tp_ctrl1
operator|==
literal|3
condition|)
name|remap_rf_atten
operator|=
literal|0
expr_stmt|;
name|bbp_atten
operator|=
name|tpctl
operator|->
name|bbp_atten
expr_stmt|;
name|rf_atten
operator|=
name|tpctl
operator|->
name|rf_atten
expr_stmt|;
if|if
condition|(
name|bbp_atten
operator|>
literal|6
condition|)
name|bbp_atten
operator|=
literal|6
expr_stmt|;
block|}
end_else

begin_if
if|if
condition|(
name|remap_rf_atten
condition|)
block|{
define|#
directive|define
name|MAP_MAX
value|10
specifier|static
specifier|const
name|uint16_t
name|map
index|[
name|MAP_MAX
index|]
init|=
block|{
literal|11
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|13
block|,
literal|12
block|,
literal|13
block|,
literal|12
block|,
literal|13
block|,
literal|12
block|}
decl_stmt|;
if|#
directive|if
literal|0
block|KASSERT(rf_atten< MAP_MAX, ("rf_atten %d", rf_atten)); 		rf_atten = map[rf_atten];
else|#
directive|else
if|if
condition|(
name|rf_atten
operator|>=
name|MAP_MAX
condition|)
block|{
name|rf_atten
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
block|}
else|else
block|{
name|rf_atten
operator|=
name|map
index|[
name|rf_atten
index|]
expr_stmt|;
block|}
endif|#
directive|endif
undef|#
directive|undef
name|MAP_MAX
block|}
end_if

begin_return
return|return
name|bwi_get_rf_lo
argument_list|(
name|mac
argument_list|,
name|rf_atten
argument_list|,
name|bbp_atten
argument_list|)
return|;
end_return

begin_macro
unit|}  void
name|bwi_rf_lo_adjust
argument_list|(
argument|struct bwi_mac *mac
argument_list|,
argument|const struct bwi_tpctl *tpctl
argument_list|)
end_macro

begin_block
block|{
specifier|const
name|struct
name|bwi_rf_lo
modifier|*
name|lo
decl_stmt|;
name|lo
operator|=
name|bwi_rf_lo_find
argument_list|(
name|mac
argument_list|,
name|tpctl
argument_list|)
expr_stmt|;
name|RF_LO_WRITE
argument_list|(
name|mac
argument_list|,
name|lo
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|bwi_rf_lo_write
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwi_rf_lo
modifier|*
name|lo
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|val
operator|=
operator|(
name|uint8_t
operator|)
name|lo
operator|->
name|ctrl_lo
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|uint8_t
operator|)
name|lo
operator|->
name|ctrl_hi
operator|)
operator|<<
literal|8
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_RF_LO
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwi_rf_gain_max_reached
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xf0ff
argument_list|,
name|idx
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xfff
argument_list|,
literal|0xa000
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xf000
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
return|return
operator|(
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x2d
argument_list|)
operator|>=
literal|0xdfc
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX use bitmap array */
end_comment

begin_function
specifier|static
name|__inline
name|uint16_t
name|bitswap4
parameter_list|(
name|uint16_t
name|val
parameter_list|)
block|{
name|uint16_t
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|val
operator|&
literal|0x8
operator|)
operator|>>
literal|3
expr_stmt|;
name|ret
operator||=
operator|(
name|val
operator|&
literal|0x4
operator|)
operator|>>
literal|1
expr_stmt|;
name|ret
operator||=
operator|(
name|val
operator|&
literal|0x2
operator|)
operator|<<
literal|1
expr_stmt|;
name|ret
operator||=
operator|(
name|val
operator|&
literal|0x1
operator|)
operator|<<
literal|3
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|uint16_t
name|bwi_phy812_value
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|lpd
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|uint16_t
name|lo_gain
decl_stmt|,
name|ext_lna
decl_stmt|,
name|loop
decl_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|lo_gain
operator|=
name|rf
operator|->
name|rf_lo_gain
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|lo_gain
operator|+=
literal|0x3e
expr_stmt|;
else|else
name|lo_gain
operator|+=
literal|0x26
expr_stmt|;
if|if
condition|(
name|lo_gain
operator|>=
literal|0x46
condition|)
block|{
name|lo_gain
operator|-=
literal|0x46
expr_stmt|;
name|ext_lna
operator|=
literal|0x3000
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lo_gain
operator|>=
literal|0x3a
condition|)
block|{
name|lo_gain
operator|-=
literal|0x3a
expr_stmt|;
name|ext_lna
operator|=
literal|0x1000
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lo_gain
operator|>=
literal|0x2e
condition|)
block|{
name|lo_gain
operator|-=
literal|0x2e
expr_stmt|;
name|ext_lna
operator|=
literal|0x2000
expr_stmt|;
block|}
else|else
block|{
name|lo_gain
operator|-=
literal|0x10
expr_stmt|;
name|ext_lna
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
literal|16
condition|;
operator|++
name|loop
control|)
block|{
name|lo_gain
operator|-=
operator|(
literal|6
operator|*
name|loop
operator|)
expr_stmt|;
if|if
condition|(
name|lo_gain
operator|<
literal|6
condition|)
break|break;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|7
operator|&&
operator|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_EXT_LNA
operator|)
condition|)
block|{
if|if
condition|(
name|ext_lna
condition|)
name|ext_lna
operator||=
literal|0x8000
expr_stmt|;
name|ext_lna
operator||=
operator|(
name|loop
operator|<<
literal|8
operator|)
expr_stmt|;
switch|switch
condition|(
name|lpd
condition|)
block|{
case|case
literal|0x011
case|:
return|return
literal|0x8f92
return|;
case|case
literal|0x001
case|:
return|return
operator|(
literal|0x8092
operator||
name|ext_lna
operator|)
return|;
case|case
literal|0x101
case|:
return|return
operator|(
literal|0x2092
operator||
name|ext_lna
operator|)
return|;
case|case
literal|0x100
case|:
return|return
operator|(
literal|0x2093
operator||
name|ext_lna
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"unsupported lpd\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ext_lna
operator||=
operator|(
name|loop
operator|<<
literal|8
operator|)
expr_stmt|;
switch|switch
condition|(
name|lpd
condition|)
block|{
case|case
literal|0x011
case|:
return|return
literal|0xf92
return|;
case|case
literal|0x001
case|:
case|case
literal|0x101
case|:
return|return
operator|(
literal|0x92
operator||
name|ext_lna
operator|)
return|;
case|case
literal|0x100
case|:
return|return
operator|(
literal|0x93
operator||
name|ext_lna
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"unsupported lpd\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|panic
argument_list|(
literal|"never reached\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|bwi_rf_init_bcm2050
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|SAVE_RF_MAX
value|3
define|#
directive|define
name|SAVE_PHY_COMM_MAX
value|4
define|#
directive|define
name|SAVE_PHY_11G_MAX
value|6
specifier|static
specifier|const
name|uint16_t
name|save_rf_regs
index|[
name|SAVE_RF_MAX
index|]
init|=
block|{
literal|0x0043
block|,
literal|0x0051
block|,
literal|0x0052
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_regs_comm
index|[
name|SAVE_PHY_COMM_MAX
index|]
init|=
block|{
literal|0x0015
block|,
literal|0x005a
block|,
literal|0x0059
block|,
literal|0x0058
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_regs_11g
index|[
name|SAVE_PHY_11G_MAX
index|]
init|=
block|{
literal|0x0811
block|,
literal|0x0812
block|,
literal|0x0814
block|,
literal|0x0815
block|,
literal|0x0429
block|,
literal|0x0802
block|}
decl_stmt|;
name|uint16_t
name|save_rf
index|[
name|SAVE_RF_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy_comm
index|[
name|SAVE_PHY_COMM_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy_11g
index|[
name|SAVE_PHY_11G_MAX
index|]
decl_stmt|;
name|uint16_t
name|phyr_35
decl_stmt|,
name|phyr_30
init|=
literal|0
decl_stmt|,
name|rfr_78
decl_stmt|,
name|phyr_80f
init|=
literal|0
decl_stmt|,
name|phyr_810
init|=
literal|0
decl_stmt|;
name|uint16_t
name|bphy_ctrl
init|=
literal|0
decl_stmt|,
name|bbp_atten
decl_stmt|,
name|rf_chan_ex
decl_stmt|;
name|uint16_t
name|phy812_val
decl_stmt|;
name|uint16_t
name|calib
decl_stmt|;
name|uint32_t
name|test_lim
decl_stmt|,
name|test
decl_stmt|;
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * Save registers for later restoring 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|save_rf
index|[
name|i
index|]
operator|=
name|RF_READ
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|save_phy_comm
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_regs_comm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11B
condition|)
block|{
name|phyr_30
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|bphy_ctrl
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x30
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|,
literal|0x3f3f
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_11G_MAX
condition|;
operator|++
name|i
control|)
block|{
name|save_phy_11g
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_regs_11g
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|phyr_80f
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|)
expr_stmt|;
name|phyr_810
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|3
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0xc020
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0x8020
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x011
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|<
literal|7
operator|||
operator|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_EXT_LNA
operator|)
operator|==
literal|0
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x1b3
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x9b3
argument_list|)
expr_stmt|;
block|}
name|CSR_SETBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|phyr_35
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|bbp_atten
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|)
expr_stmt|;
name|rf_chan_ex
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|0
condition|)
block|{
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
literal|0x122
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|>=
literal|2
condition|)
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x3
argument_list|,
literal|0xffbf
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|CSR_SETBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
block|}
name|calib
operator|=
name|bwi_rf_calibval
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x78
argument_list|,
literal|0x26
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x011
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xbfaf
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2b
argument_list|,
literal|0x1403
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x001
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xbfa0
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x51
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
block|}
name|test_lim
operator|=
literal|0
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x480
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x59
argument_list|,
literal|0xc810
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xefb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xfff0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|test_lim
operator|+=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x2d
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
block|}
operator|++
name|test_lim
expr_stmt|;
name|test_lim
operator|>>=
literal|9
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|test
operator|=
literal|0
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
name|int
name|j
decl_stmt|;
name|rfr_78
operator|=
operator|(
name|bitswap4
argument_list|(
name|i
argument_list|)
operator|<<
literal|1
operator|)
operator||
literal|0x20
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x78
argument_list|,
name|rfr_78
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/* NB: This block is slight different than the above one */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
operator|++
name|j
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0xd80
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x59
argument_list|,
literal|0xc810
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xefb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xfff0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|test
operator|+=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x2d
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|phy812_val
operator|=
name|bwi_phy812_value
argument_list|(
name|mac
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|phy812_val
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xafb0
argument_list|)
expr_stmt|;
block|}
operator|++
name|test
expr_stmt|;
name|test
operator|>>=
literal|8
expr_stmt|;
if|if
condition|(
name|test
operator|>
name|test_lim
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>
literal|15
condition|)
name|rf
operator|->
name|rf_calib
operator|=
name|rfr_78
expr_stmt|;
else|else
name|rf
operator|->
name|rf_calib
operator|=
name|calib
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_calib
operator|!=
literal|0xffff
condition|)
block|{
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_INIT
argument_list|,
literal|"RF calibration value: 0x%04x\n"
argument_list|,
name|rf
operator|->
name|rf_calib
argument_list|)
expr_stmt|;
name|rf
operator|->
name|rf_flags
operator||=
name|BWI_RF_F_INITED
expr_stmt|;
block|}
comment|/* 	 * Restore trashes registers 	 */
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs_comm
index|[
literal|0
index|]
argument_list|,
name|save_phy_comm
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
block|{
name|int
name|pos
init|=
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|SAVE_RF_MAX
decl_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|pos
index|]
argument_list|,
name|save_rf
index|[
name|pos
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs_comm
index|[
name|i
index|]
argument_list|,
name|save_phy_comm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
name|bbp_atten
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|!=
literal|0
condition|)
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
name|rf_chan_ex
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|,
name|phyr_35
argument_list|)
expr_stmt|;
name|bwi_rf_work_around
argument_list|(
name|mac
argument_list|,
name|rf
operator|->
name|rf_curchan
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11B
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x30
argument_list|,
name|phyr_30
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|,
name|bphy_ctrl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|||
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
comment|/* XXX Spec only says when PHY is linked (gmode) */
name|CSR_CLRBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_11G_MAX
condition|;
operator|++
name|i
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs_11g
index|[
name|i
index|]
argument_list|,
name|save_phy_11g
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
name|phyr_80f
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|,
name|phyr_810
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|SAVE_PHY_11G_MAX
undef|#
directive|undef
name|SAVE_PHY_COMM_MAX
undef|#
directive|undef
name|SAVE_RF_MAX
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwi_rf_calibval
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* http://bcm-specs.sipsolutions.net/RCCTable */
specifier|static
specifier|const
name|uint16_t
name|rf_calibvals
index|[]
init|=
block|{
literal|0x2
block|,
literal|0x3
block|,
literal|0x1
block|,
literal|0xf
block|,
literal|0x6
block|,
literal|0x7
block|,
literal|0x5
block|,
literal|0xf
block|,
literal|0xa
block|,
literal|0xb
block|,
literal|0x9
block|,
literal|0xf
block|,
literal|0xe
block|,
literal|0xf
block|,
literal|0xd
block|,
literal|0xf
block|}
decl_stmt|;
name|uint16_t
name|val
decl_stmt|,
name|calib
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|val
operator|=
name|RF_READ
argument_list|(
name|mac
argument_list|,
name|BWI_RFR_BBP_ATTEN
argument_list|)
expr_stmt|;
name|idx
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_RFR_BBP_ATTEN_CALIB_IDX
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|idx
operator|<
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|rf_calibvals
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|rf_calibvals
index|[
literal|0
index|]
argument_list|)
argument_list|)
argument_list|,
operator|(
literal|"idx %d"
operator|,
name|idx
operator|)
argument_list|)
expr_stmt|;
name|calib
operator|=
name|rf_calibvals
index|[
name|idx
index|]
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|BWI_RFR_BBP_ATTEN_CALIB_BIT
condition|)
name|calib
operator||=
literal|0x1
expr_stmt|;
name|calib
operator||=
literal|0x20
expr_stmt|;
return|return
name|calib
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int32_t
name|_bwi_adjust_devide
parameter_list|(
name|int32_t
name|num
parameter_list|,
name|int32_t
name|den
parameter_list|)
block|{
if|if
condition|(
name|num
operator|<
literal|0
condition|)
return|return
operator|(
name|num
operator|/
name|den
operator|)
return|;
else|else
return|return
operator|(
name|num
operator|+
name|den
operator|/
literal|2
operator|)
operator|/
name|den
return|;
block|}
end_function

begin_comment
comment|/*  * http://bcm-specs.sipsolutions.net/TSSI_to_DBM_Table  * "calculating table entries"  */
end_comment

begin_function
specifier|static
name|int
name|bwi_rf_calc_txpower
parameter_list|(
name|int8_t
modifier|*
name|txpwr
parameter_list|,
name|uint8_t
name|idx
parameter_list|,
specifier|const
name|int16_t
name|pa_params
index|[]
parameter_list|)
block|{
name|int32_t
name|m1
decl_stmt|,
name|m2
decl_stmt|,
name|f
decl_stmt|,
name|dbm
decl_stmt|;
name|int
name|i
decl_stmt|;
name|m1
operator|=
name|_bwi_adjust_devide
argument_list|(
literal|16
operator|*
name|pa_params
index|[
literal|0
index|]
operator|+
name|idx
operator|*
name|pa_params
index|[
literal|1
index|]
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|m2
operator|=
name|imax
argument_list|(
name|_bwi_adjust_devide
argument_list|(
literal|32768
operator|+
name|idx
operator|*
name|pa_params
index|[
literal|2
index|]
argument_list|,
literal|256
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
define|#
directive|define
name|ITER_MAX
value|16
name|f
operator|=
literal|256
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITER_MAX
condition|;
operator|++
name|i
control|)
block|{
name|int32_t
name|q
decl_stmt|,
name|d
decl_stmt|;
name|q
operator|=
name|_bwi_adjust_devide
argument_list|(
name|f
operator|*
literal|4096
operator|-
name|_bwi_adjust_devide
argument_list|(
name|m2
operator|*
name|f
argument_list|,
literal|16
argument_list|)
operator|*
name|f
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|d
operator|=
name|abs
argument_list|(
name|q
operator|-
name|f
argument_list|)
expr_stmt|;
name|f
operator|=
name|q
expr_stmt|;
if|if
condition|(
name|d
operator|<
literal|2
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|ITER_MAX
condition|)
return|return
name|EINVAL
return|;
undef|#
directive|undef
name|ITER_MAX
name|dbm
operator|=
name|_bwi_adjust_devide
argument_list|(
name|m1
operator|*
name|f
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbm
operator|<
operator|-
literal|127
condition|)
name|dbm
operator|=
operator|-
literal|127
expr_stmt|;
elseif|else
if|if
condition|(
name|dbm
operator|>
literal|128
condition|)
name|dbm
operator|=
literal|128
expr_stmt|;
operator|*
name|txpwr
operator|=
name|dbm
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|bwi_rf_map_txpower
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|sprom_ofs
decl_stmt|,
name|val
decl_stmt|,
name|mask
decl_stmt|;
name|int16_t
name|pa_params
index|[
literal|3
index|]
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|ant_gain
decl_stmt|,
name|reg_txpower_max
decl_stmt|;
comment|/* 	 * Find out max TX power 	 */
name|val
operator|=
name|bwi_read_sprom
argument_list|(
name|sc
argument_list|,
name|BWI_SPROM_MAX_TXPWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11A
condition|)
block|{
name|rf
operator|->
name|rf_txpower_max
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_SPROM_MAX_TXPWR_MASK_11A
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rf
operator|->
name|rf_txpower_max
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_SPROM_MAX_TXPWR_MASK_11BG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_PA_GPIO9
operator|)
operator|&&
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11G
condition|)
name|rf
operator|->
name|rf_txpower_max
operator|-=
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|rf
operator|->
name|rf_txpower_max
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"invalid max txpower in sprom\n"
argument_list|)
expr_stmt|;
name|rf
operator|->
name|rf_txpower_max
operator|=
literal|74
expr_stmt|;
block|}
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"max txpower from sprom: %d dBm\n"
argument_list|,
name|rf
operator|->
name|rf_txpower_max
argument_list|)
expr_stmt|;
comment|/* 	 * Find out region/domain max TX power, which is adjusted 	 * by antenna gain and 1.5 dBm fluctuation as mentioned 	 * in v3 spec. 	 */
name|val
operator|=
name|bwi_read_sprom
argument_list|(
name|sc
argument_list|,
name|BWI_SPROM_ANT_GAIN
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11A
condition|)
name|ant_gain
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_SPROM_ANT_GAIN_MASK_11A
argument_list|)
expr_stmt|;
else|else
name|ant_gain
operator|=
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_SPROM_ANT_GAIN_MASK_11BG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ant_gain
operator|==
literal|0xff
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"invalid antenna gain in sprom\n"
argument_list|)
expr_stmt|;
name|ant_gain
operator|=
literal|2
expr_stmt|;
block|}
name|ant_gain
operator|*=
literal|4
expr_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"ant gain %d dBm\n"
argument_list|,
name|ant_gain
argument_list|)
expr_stmt|;
name|reg_txpower_max
operator|=
literal|90
operator|-
name|ant_gain
operator|-
literal|6
expr_stmt|;
comment|/* XXX magic number */
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"region/domain max txpower %d dBm\n"
argument_list|,
name|reg_txpower_max
argument_list|)
expr_stmt|;
comment|/* 	 * Force max TX power within region/domain TX power limit 	 */
if|if
condition|(
name|rf
operator|->
name|rf_txpower_max
operator|>
name|reg_txpower_max
condition|)
name|rf
operator|->
name|rf_txpower_max
operator|=
name|reg_txpower_max
expr_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"max txpower %d dBm\n"
argument_list|,
name|rf
operator|->
name|rf_txpower_max
argument_list|)
expr_stmt|;
comment|/* 	 * Create TSSI to TX power mapping 	 */
if|if
condition|(
name|sc
operator|->
name|sc_bbp_id
operator|==
name|BWI_BBPID_BCM4301
operator|&&
name|rf
operator|->
name|rf_type
operator|!=
name|BWI_RF_T_BCM2050
condition|)
block|{
name|rf
operator|->
name|rf_idle_tssi0
operator|=
name|BWI_DEFAULT_IDLE_TSSI
expr_stmt|;
name|bcopy
argument_list|(
name|bwi_txpower_map_11b
argument_list|,
name|rf
operator|->
name|rf_txpower_map0
argument_list|,
sizeof|sizeof
argument_list|(
name|rf
operator|->
name|rf_txpower_map0
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|back
goto|;
block|}
define|#
directive|define
name|IS_VALID_PA_PARAM
parameter_list|(
name|p
parameter_list|)
value|((p) != 0&& (p) != -1)
define|#
directive|define
name|N
parameter_list|(
name|arr
parameter_list|)
value|(int)(sizeof(arr) / sizeof(arr[0]))
comment|/* 	 * Extract PA parameters 	 */
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11A
condition|)
name|sprom_ofs
operator|=
name|BWI_SPROM_PA_PARAM_11A
expr_stmt|;
else|else
name|sprom_ofs
operator|=
name|BWI_SPROM_PA_PARAM_11BG
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|pa_params
argument_list|)
condition|;
operator|++
name|i
control|)
name|pa_params
index|[
name|i
index|]
operator|=
operator|(
name|int16_t
operator|)
name|bwi_read_sprom
argument_list|(
name|sc
argument_list|,
name|sprom_ofs
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|pa_params
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
comment|/* 		 * If one of the PA parameters from SPROM is not valid, 		 * fall back to the default values, if there are any. 		 */
if|if
condition|(
operator|!
name|IS_VALID_PA_PARAM
argument_list|(
name|pa_params
index|[
name|i
index|]
argument_list|)
condition|)
block|{
specifier|const
name|int8_t
modifier|*
name|txpower_map
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11A
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"no tssi2dbm table for 11a PHY\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11G
condition|)
block|{
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"%s\n"
argument_list|,
literal|"use default 11g TSSI map"
argument_list|)
expr_stmt|;
name|txpower_map
operator|=
name|bwi_txpower_map_11g
expr_stmt|;
block|}
else|else
block|{
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"%s\n"
argument_list|,
literal|"use default 11b TSSI map"
argument_list|)
expr_stmt|;
name|txpower_map
operator|=
name|bwi_txpower_map_11b
expr_stmt|;
block|}
name|rf
operator|->
name|rf_idle_tssi0
operator|=
name|BWI_DEFAULT_IDLE_TSSI
expr_stmt|;
name|bcopy
argument_list|(
name|txpower_map
argument_list|,
name|rf
operator|->
name|rf_txpower_map0
argument_list|,
sizeof|sizeof
argument_list|(
name|rf
operator|->
name|rf_txpower_map0
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|back
goto|;
block|}
block|}
undef|#
directive|undef
name|N
comment|/* 	 * All of the PA parameters from SPROM are valid. 	 */
comment|/* 	 * Extract idle TSSI from SPROM. 	 */
name|val
operator|=
name|bwi_read_sprom
argument_list|(
name|sc
argument_list|,
name|BWI_SPROM_IDLE_TSSI
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"sprom idle tssi: 0x%04x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11A
condition|)
name|mask
operator|=
name|BWI_SPROM_IDLE_TSSI_MASK_11A
expr_stmt|;
else|else
name|mask
operator|=
name|BWI_SPROM_IDLE_TSSI_MASK_11BG
expr_stmt|;
name|rf
operator|->
name|rf_idle_tssi0
operator|=
operator|(
name|int
operator|)
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_VALID_PA_PARAM
argument_list|(
name|rf
operator|->
name|rf_idle_tssi0
argument_list|)
condition|)
name|rf
operator|->
name|rf_idle_tssi0
operator|=
literal|62
expr_stmt|;
undef|#
directive|undef
name|IS_VALID_PA_PARAM
comment|/* 	 * Calculate TX power map, which is indexed by TSSI 	 */
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_ATTACH
operator||
name|BWI_DBG_TXPOWER
argument_list|,
literal|"%s\n"
argument_list|,
literal|"TSSI-TX power map:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWI_TSSI_MAX
condition|;
operator|++
name|i
control|)
block|{
name|error
operator|=
name|bwi_rf_calc_txpower
argument_list|(
operator|&
name|rf
operator|->
name|rf_txpower_map0
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
name|pa_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"bwi_rf_calc_txpower failed\n"
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|BWI_DEBUG
if|if
condition|(
name|i
operator|!=
literal|0
operator|&&
name|i
operator|%
literal|8
operator|==
literal|0
condition|)
block|{
name|_DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_ATTACH
operator||
name|BWI_DBG_TXPOWER
argument_list|,
literal|"%s\n"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|_DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_ATTACH
operator||
name|BWI_DBG_TXPOWER
argument_list|,
literal|"%d "
argument_list|,
name|rf
operator|->
name|rf_txpower_map0
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|_DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_ATTACH
operator||
name|BWI_DBG_TXPOWER
argument_list|,
literal|"%s\n"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|back
label|:
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_TXPOWER
operator||
name|BWI_DBG_ATTACH
argument_list|,
literal|"idle tssi0: %d\n"
argument_list|,
name|rf
operator|->
name|rf_idle_tssi0
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_lo_update_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwi_tpctl
modifier|*
name|tpctl
init|=
operator|&
name|mac
operator|->
name|mac_tpctl
decl_stmt|;
name|struct
name|rf_saveregs
name|regs
decl_stmt|;
name|uint16_t
name|ant_div
decl_stmt|,
name|chan_ex
decl_stmt|;
name|uint8_t
name|devi_ctrl
decl_stmt|;
name|u_int
name|orig_chan
decl_stmt|;
comment|/* 	 * Save RF/PHY registers for later restoration 	 */
name|orig_chan
operator|=
name|rf
operator|->
name|rf_curchan
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|regs
argument_list|,
sizeof|sizeof
argument_list|(
name|regs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
block|{
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|429
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|802
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
name|regs
operator|.
name|phy_429
operator|&
literal|0x7fff
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
name|regs
operator|.
name|phy_802
operator|&
literal|0xfffc
argument_list|)
expr_stmt|;
block|}
name|ant_div
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
name|ant_div
operator||
literal|0x8000
argument_list|)
expr_stmt|;
name|chan_ex
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|2a
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|SAVE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|43
argument_list|)
expr_stmt|;
name|SAVE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|7a
argument_list|)
expr_stmt|;
name|SAVE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|52
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
block|{
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|811
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|812
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|814
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|815
argument_list|)
expr_stmt|;
block|}
comment|/* Force to channel 6 */
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
name|regs
operator|.
name|phy_429
operator|&
literal|0x7fff
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
name|regs
operator|.
name|phy_802
operator|&
literal|0xfffc
argument_list|)
expr_stmt|;
name|bwi_mac_dummy_xmit
argument_list|(
name|mac
argument_list|)
expr_stmt|;
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0x6
argument_list|)
expr_stmt|;
name|bwi_phy_set_bbp_atten
argument_list|(
name|mac
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2e
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0x78
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|,
name|regs
operator|.
name|phy_35
operator|&
literal|0xff7f
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
name|regs
operator|.
name|rf_7a
operator|&
literal|0xfff0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2b
argument_list|,
literal|0x203
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x8a3
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
name|regs
operator|.
name|phy_814
operator||
literal|0x3
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
name|regs
operator|.
name|phy_815
operator|&
literal|0xfffc
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x1b3
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xb2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|tpctl
operator|->
name|tp_ctrl2
operator|=
name|bwi_rf_get_tp_ctrl2
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0x8078
argument_list|)
expr_stmt|;
comment|/* 	 * Measure all RF LO 	 */
name|devi_ctrl
operator|=
name|_bwi_rf_lo_update_11g
argument_list|(
name|mac
argument_list|,
name|regs
operator|.
name|rf_7a
argument_list|)
expr_stmt|;
comment|/* 	 * Restore saved RF/PHY registers 	 */
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xe300
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
operator|(
name|devi_ctrl
operator|<<
literal|8
operator|)
operator||
literal|0xa0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
operator|(
name|devi_ctrl
operator|<<
literal|8
operator|)
operator||
literal|0xa2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
operator|(
name|devi_ctrl
operator|<<
literal|8
operator|)
operator||
literal|0xa3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
name|devi_ctrl
operator||
literal|0xefa0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|tpctl
operator|=
name|NULL
expr_stmt|;
name|bwi_rf_lo_adjust
argument_list|(
name|mac
argument_list|,
name|tpctl
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2e
argument_list|,
literal|0x807f
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2f
argument_list|,
literal|0x202
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2f
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
name|chan_ex
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|2a
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|60
argument_list|)
expr_stmt|;
name|RESTORE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|43
argument_list|)
expr_stmt|;
name|RESTORE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|7a
argument_list|)
expr_stmt|;
name|regs
operator|.
name|rf_52
operator|&=
literal|0xf0
expr_stmt|;
name|regs
operator|.
name|rf_52
operator||=
operator|(
name|RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|regs
operator|.
name|rf_52
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
name|ant_div
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
block|{
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|811
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|812
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|814
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|815
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|429
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|802
argument_list|)
expr_stmt|;
block|}
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
name|orig_chan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|bwi_rf_lo_devi_measure
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|ctrl
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint32_t
name|devi
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
name|ctrl
operator|<<=
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xe300
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|ctrl
operator||
literal|0xb0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|ctrl
operator||
literal|0xb2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
name|ctrl
operator||
literal|0xb3
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xf300
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
name|ctrl
operator||
literal|0xefa0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
name|ctrl
operator||
literal|0xefe0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
name|ctrl
operator||
literal|0xffe0
argument_list|)
expr_stmt|;
block|}
name|DELAY
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|devi
operator|+=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x2d
argument_list|)
expr_stmt|;
block|}
return|return
name|devi
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwi_rf_get_tp_ctrl2
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint32_t
name|devi_min
decl_stmt|;
name|uint16_t
name|tp_ctrl2
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|devi_min
operator|=
name|bwi_rf_lo_devi_measure
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
name|uint32_t
name|devi
decl_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|devi
operator|=
name|bwi_rf_lo_devi_measure
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|devi
operator|<
name|devi_min
condition|)
block|{
name|devi_min
operator|=
name|devi
expr_stmt|;
name|tp_ctrl2
operator|=
name|i
expr_stmt|;
block|}
block|}
return|return
name|tp_ctrl2
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|_bwi_rf_lo_update_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|orig_rf7a
parameter_list|)
block|{
define|#
directive|define
name|RF_ATTEN_LISTSZ
value|14
define|#
directive|define
name|BBP_ATTEN_MAX
value|4
comment|/* half */
specifier|static
specifier|const
name|int
name|rf_atten_list
index|[
name|RF_ATTEN_LISTSZ
index|]
init|=
block|{
literal|3
block|,
literal|1
block|,
literal|5
block|,
literal|7
block|,
literal|9
block|,
literal|2
block|,
literal|0
block|,
literal|4
block|,
literal|6
block|,
literal|8
block|,
literal|1
block|,
literal|2
block|,
literal|3
block|,
literal|4
block|}
decl_stmt|;
specifier|static
specifier|const
name|int
name|rf_atten_init_list
index|[
name|RF_ATTEN_LISTSZ
index|]
init|=
block|{
literal|0
block|,
literal|3
block|,
literal|1
block|,
literal|5
block|,
literal|7
block|,
literal|3
block|,
literal|2
block|,
literal|0
block|,
literal|4
block|,
literal|6
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|}
decl_stmt|;
specifier|static
specifier|const
name|int
name|rf_lo_measure_order
index|[
name|RF_ATTEN_LISTSZ
index|]
init|=
block|{
literal|3
block|,
literal|1
block|,
literal|5
block|,
literal|7
block|,
literal|9
block|,
literal|2
block|,
literal|0
block|,
literal|4
block|,
literal|6
block|,
literal|8
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|13
block|}
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|mac
operator|->
name|mac_sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|bwi_rf_lo
name|lo_save
decl_stmt|,
modifier|*
name|lo
decl_stmt|;
name|uint8_t
name|devi_ctrl
init|=
literal|0
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|adj_rf7a
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|lo_save
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_save
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|RF_ATTEN_LISTSZ
condition|;
operator|++
name|idx
control|)
block|{
name|int
name|init_rf_atten
init|=
name|rf_atten_init_list
index|[
name|idx
index|]
decl_stmt|;
name|int
name|rf_atten
init|=
name|rf_atten_list
index|[
name|idx
index|]
decl_stmt|;
name|int
name|bbp_atten
decl_stmt|;
for|for
control|(
name|bbp_atten
operator|=
literal|0
init|;
name|bbp_atten
operator|<
name|BBP_ATTEN_MAX
condition|;
operator|++
name|bbp_atten
control|)
block|{
name|uint16_t
name|tp_ctrl2
decl_stmt|,
name|rf7a
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|lo_save
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_save
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|init_rf_atten
operator|<
literal|0
condition|)
block|{
name|lo
operator|=
name|bwi_get_rf_lo
argument_list|(
name|mac
argument_list|,
name|rf_atten
argument_list|,
literal|2
operator|*
name|bbp_atten
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|lo
argument_list|,
operator|&
name|lo_save
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_save
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lo
operator|=
name|bwi_get_rf_lo
argument_list|(
name|mac
argument_list|,
name|init_rf_atten
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|lo
argument_list|,
operator|&
name|lo_save
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_save
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|devi_ctrl
operator|=
literal|0
expr_stmt|;
name|adj_rf7a
operator|=
literal|0
expr_stmt|;
comment|/* 				 * XXX 				 * Linux driver overflows 'val' 				 */
if|if
condition|(
name|init_rf_atten
operator|>=
literal|0
condition|)
block|{
name|int
name|val
decl_stmt|;
name|val
operator|=
name|rf_atten
operator|*
literal|2
operator|+
name|bbp_atten
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|14
condition|)
block|{
name|adj_rf7a
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|17
condition|)
name|devi_ctrl
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|19
condition|)
name|devi_ctrl
operator|=
literal|2
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|lo
operator|=
name|bwi_get_rf_lo
argument_list|(
name|mac
argument_list|,
name|rf_atten
argument_list|,
literal|2
operator|*
name|bbp_atten
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bwi_rf_lo_isused
argument_list|(
name|mac
argument_list|,
name|lo
argument_list|)
condition|)
continue|continue;
name|bcopy
argument_list|(
name|lo
argument_list|,
operator|&
name|lo_save
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_save
argument_list|)
argument_list|)
expr_stmt|;
name|devi_ctrl
operator|=
literal|3
expr_stmt|;
name|adj_rf7a
operator|=
literal|0
expr_stmt|;
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|BWI_RFR_ATTEN
argument_list|,
name|rf_atten
argument_list|)
expr_stmt|;
name|tp_ctrl2
operator|=
name|mac
operator|->
name|mac_tpctl
operator|.
name|tp_ctrl2
expr_stmt|;
if|if
condition|(
name|init_rf_atten
operator|<
literal|0
condition|)
name|tp_ctrl2
operator||=
operator|(
literal|3
operator|<<
literal|4
operator|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|BWI_RFR_TXPWR
argument_list|,
name|tp_ctrl2
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|bwi_phy_set_bbp_atten
argument_list|(
name|mac
argument_list|,
name|bbp_atten
operator|*
literal|2
argument_list|)
expr_stmt|;
name|rf7a
operator|=
name|orig_rf7a
operator|&
literal|0xfff0
expr_stmt|;
if|if
condition|(
name|adj_rf7a
condition|)
name|rf7a
operator||=
literal|0x8
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
name|rf7a
argument_list|)
expr_stmt|;
name|lo
operator|=
name|bwi_get_rf_lo
argument_list|(
name|mac
argument_list|,
name|rf_lo_measure_order
index|[
name|idx
index|]
argument_list|,
name|bbp_atten
operator|*
literal|2
argument_list|)
expr_stmt|;
name|bwi_rf_lo_measure_11g
argument_list|(
name|mac
argument_list|,
operator|&
name|lo_save
argument_list|,
name|lo
argument_list|,
name|devi_ctrl
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|devi_ctrl
return|;
undef|#
directive|undef
name|RF_ATTEN_LISTSZ
undef|#
directive|undef
name|BBP_ATTEN_MAX
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_lo_measure_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwi_rf_lo
modifier|*
name|src_lo
parameter_list|,
name|struct
name|bwi_rf_lo
modifier|*
name|dst_lo
parameter_list|,
name|uint8_t
name|devi_ctrl
parameter_list|)
block|{
define|#
directive|define
name|LO_ADJUST_MIN
value|1
define|#
directive|define
name|LO_ADJUST_MAX
value|8
define|#
directive|define
name|LO_ADJUST
parameter_list|(
name|hi
parameter_list|,
name|lo
parameter_list|)
value|{ .ctrl_hi = hi, .ctrl_lo = lo }
specifier|static
specifier|const
name|struct
name|bwi_rf_lo
name|rf_lo_adjust
index|[
name|LO_ADJUST_MAX
index|]
init|=
block|{
name|LO_ADJUST
argument_list|(
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|LO_ADJUST
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|LO_ADJUST
argument_list|(
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
block|,
name|LO_ADJUST
argument_list|(
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
block|,
name|LO_ADJUST
argument_list|(
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
block|,
name|LO_ADJUST
argument_list|(
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
block|,
name|LO_ADJUST
argument_list|(
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|LO_ADJUST
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
block|}
decl_stmt|;
undef|#
directive|undef
name|LO_ADJUST
name|struct
name|bwi_rf_lo
name|lo_min
decl_stmt|;
name|uint32_t
name|devi_min
decl_stmt|;
name|int
name|found
decl_stmt|,
name|loop_count
decl_stmt|,
name|adjust_state
decl_stmt|;
name|bcopy
argument_list|(
name|src_lo
argument_list|,
operator|&
name|lo_min
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_min
argument_list|)
argument_list|)
expr_stmt|;
name|RF_LO_WRITE
argument_list|(
name|mac
argument_list|,
operator|&
name|lo_min
argument_list|)
expr_stmt|;
name|devi_min
operator|=
name|bwi_rf_lo_devi_measure
argument_list|(
name|mac
argument_list|,
name|devi_ctrl
argument_list|)
expr_stmt|;
name|loop_count
operator|=
literal|12
expr_stmt|;
comment|/* XXX */
name|adjust_state
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|struct
name|bwi_rf_lo
name|lo_base
decl_stmt|;
name|int
name|i
decl_stmt|,
name|fin
decl_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|adjust_state
operator|==
literal|0
condition|)
block|{
name|i
operator|=
name|LO_ADJUST_MIN
expr_stmt|;
name|fin
operator|=
name|LO_ADJUST_MAX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|adjust_state
operator|%
literal|2
operator|==
literal|0
condition|)
block|{
name|i
operator|=
name|adjust_state
operator|-
literal|1
expr_stmt|;
name|fin
operator|=
name|adjust_state
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|adjust_state
operator|-
literal|2
expr_stmt|;
name|fin
operator|=
name|adjust_state
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
name|LO_ADJUST_MIN
condition|)
name|i
operator|+=
name|LO_ADJUST_MAX
expr_stmt|;
name|KASSERT
argument_list|(
name|i
operator|<=
name|LO_ADJUST_MAX
operator|&&
name|i
operator|>=
name|LO_ADJUST_MIN
argument_list|,
operator|(
literal|"i %d"
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fin
operator|>
name|LO_ADJUST_MAX
condition|)
name|fin
operator|-=
name|LO_ADJUST_MAX
expr_stmt|;
name|KASSERT
argument_list|(
name|fin
operator|<=
name|LO_ADJUST_MAX
operator|&&
name|fin
operator|>=
name|LO_ADJUST_MIN
argument_list|,
operator|(
literal|"fin %d"
operator|,
name|fin
operator|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|lo_min
argument_list|,
operator|&
name|lo_base
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_base
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|struct
name|bwi_rf_lo
name|lo
decl_stmt|;
name|lo
operator|.
name|ctrl_hi
operator|=
name|lo_base
operator|.
name|ctrl_hi
operator|+
name|rf_lo_adjust
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ctrl_hi
expr_stmt|;
name|lo
operator|.
name|ctrl_lo
operator|=
name|lo_base
operator|.
name|ctrl_lo
operator|+
name|rf_lo_adjust
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|ctrl_lo
expr_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|lo
operator|.
name|ctrl_lo
argument_list|)
operator|<
literal|9
operator|&&
name|abs
argument_list|(
name|lo
operator|.
name|ctrl_hi
argument_list|)
operator|<
literal|9
condition|)
block|{
name|uint32_t
name|devi
decl_stmt|;
name|RF_LO_WRITE
argument_list|(
name|mac
argument_list|,
operator|&
name|lo
argument_list|)
expr_stmt|;
name|devi
operator|=
name|bwi_rf_lo_devi_measure
argument_list|(
name|mac
argument_list|,
name|devi_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|devi
operator|<
name|devi_min
condition|)
block|{
name|devi_min
operator|=
name|devi
expr_stmt|;
name|adjust_state
operator|=
name|i
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|lo
argument_list|,
operator|&
name|lo_min
argument_list|,
sizeof|sizeof
argument_list|(
name|lo_min
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|fin
condition|)
break|break;
if|if
condition|(
name|i
operator|==
name|LO_ADJUST_MAX
condition|)
name|i
operator|=
name|LO_ADJUST_MIN
expr_stmt|;
else|else
operator|++
name|i
expr_stmt|;
block|}
block|}
do|while
condition|(
name|loop_count
operator|--
operator|&&
name|found
condition|)
do|;
name|bcopy
argument_list|(
operator|&
name|lo_min
argument_list|,
name|dst_lo
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dst_lo
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|LO_ADJUST_MIN
undef|#
directive|undef
name|LO_ADJUST_MAX
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_calc_nrssi_slope_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|SAVE_RF_MAX
value|3
define|#
directive|define
name|SAVE_PHY_MAX
value|8
specifier|static
specifier|const
name|uint16_t
name|save_rf_regs
index|[
name|SAVE_RF_MAX
index|]
init|=
block|{
literal|0x7a
block|,
literal|0x52
block|,
literal|0x43
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_regs
index|[
name|SAVE_PHY_MAX
index|]
init|=
block|{
literal|0x30
block|,
literal|0x26
block|,
literal|0x15
block|,
literal|0x2a
block|,
literal|0x20
block|,
literal|0x5a
block|,
literal|0x59
block|,
literal|0x58
block|}
decl_stmt|;
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|save_rf
index|[
name|SAVE_RF_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy
index|[
name|SAVE_PHY_MAX
index|]
decl_stmt|;
name|uint16_t
name|ant_div
decl_stmt|,
name|bbp_atten
decl_stmt|,
name|chan_ex
decl_stmt|;
name|int16_t
name|nrssi
index|[
literal|2
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * Save RF/PHY registers for later restoration 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|save_rf
index|[
name|i
index|]
operator|=
name|RF_READ
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_MAX
condition|;
operator|++
name|i
control|)
name|save_phy
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ant_div
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|)
expr_stmt|;
name|bbp_atten
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|)
expr_stmt|;
name|chan_ex
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|)
expr_stmt|;
comment|/* 	 * Calculate nrssi0 	 */
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|5
condition|)
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xff80
argument_list|)
expr_stmt|;
else|else
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xfff0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x30
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|,
literal|0x7f7f
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x26
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x8a3
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|nrssi
index|[
literal|0
index|]
operator|=
operator|(
name|int16_t
operator|)
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x27
argument_list|)
expr_stmt|;
comment|/* 	 * Calculate nrssi1 	 */
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xff80
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|>=
literal|2
condition|)
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|0
condition|)
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
literal|0x122
argument_list|)
expr_stmt|;
else|else
name|CSR_CLRBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
literal|0xdfff
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|,
literal|0x3f3f
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xf330
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xff0f
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x480
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x59
argument_list|,
literal|0x810
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi
index|[
literal|1
index|]
operator|=
operator|(
name|int16_t
operator|)
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x27
argument_list|)
expr_stmt|;
comment|/* 	 * Restore saved RF/PHY registers 	 */
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
literal|0
index|]
argument_list|,
name|save_phy
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
literal|0
index|]
argument_list|,
name|save_rf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
name|ant_div
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
name|i
index|]
argument_list|,
name|save_phy
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bwi_rf_work_around
argument_list|(
name|mac
argument_list|,
name|rf
operator|->
name|rf_curchan
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|!=
literal|0
condition|)
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
name|chan_ex
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|SAVE_PHY_MAX
condition|;
operator|++
name|i
control|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_regs
index|[
name|i
index|]
argument_list|,
name|save_phy
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|,
name|save_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Install calculated narrow RSSI values 	 */
if|if
condition|(
name|nrssi
index|[
literal|0
index|]
operator|==
name|nrssi
index|[
literal|1
index|]
condition|)
name|rf
operator|->
name|rf_nrssi_slope
operator|=
literal|0x10000
expr_stmt|;
else|else
name|rf
operator|->
name|rf_nrssi_slope
operator|=
literal|0x400000
operator|/
operator|(
name|nrssi
index|[
literal|0
index|]
operator|-
name|nrssi
index|[
literal|1
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|nrssi
index|[
literal|0
index|]
operator|<=
operator|-
literal|4
condition|)
block|{
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|=
name|nrssi
index|[
literal|0
index|]
expr_stmt|;
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|=
name|nrssi
index|[
literal|1
index|]
expr_stmt|;
block|}
undef|#
directive|undef
name|SAVE_RF_MAX
undef|#
directive|undef
name|SAVE_PHY_MAX
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_set_nrssi_ofs_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|SAVE_RF_MAX
value|2
define|#
directive|define
name|SAVE_PHY_COMM_MAX
value|10
define|#
directive|define
name|SAVE_PHY6_MAX
value|8
specifier|static
specifier|const
name|uint16_t
name|save_rf_regs
index|[
name|SAVE_RF_MAX
index|]
init|=
block|{
literal|0x7a
block|,
literal|0x43
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_comm_regs
index|[
name|SAVE_PHY_COMM_MAX
index|]
init|=
block|{
literal|0x0001
block|,
literal|0x0811
block|,
literal|0x0812
block|,
literal|0x0814
block|,
literal|0x0815
block|,
literal|0x005a
block|,
literal|0x0059
block|,
literal|0x0058
block|,
literal|0x000a
block|,
literal|0x0003
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy6_regs
index|[
name|SAVE_PHY6_MAX
index|]
init|=
block|{
literal|0x002e
block|,
literal|0x002f
block|,
literal|0x080f
block|,
literal|0x0810
block|,
literal|0x0801
block|,
literal|0x0060
block|,
literal|0x0014
block|,
literal|0x0478
block|}
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|save_rf
index|[
name|SAVE_RF_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy_comm
index|[
name|SAVE_PHY_COMM_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy6
index|[
name|SAVE_PHY6_MAX
index|]
decl_stmt|;
name|uint16_t
name|rf7b
init|=
literal|0xffff
decl_stmt|;
name|int16_t
name|nrssi
decl_stmt|;
name|int
name|i
decl_stmt|,
name|phy6_idx
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|save_phy_comm
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|save_rf
index|[
name|i
index|]
operator|=
name|RF_READ
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x1
argument_list|,
literal|0x3fff
argument_list|,
literal|0x4000
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0xc
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xfff3
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|6
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY6_MAX
condition|;
operator|++
name|i
control|)
name|save_phy6
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy6_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x478
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x801
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x60
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x14
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
block|}
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|nrssi
operator|=
name|bwi_nrssi_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|==
literal|31
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|7
init|;
name|i
operator|>=
literal|4
condition|;
operator|--
name|i
control|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7b
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi
operator|=
name|bwi_nrssi_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|<
literal|31
operator|&&
name|rf7b
operator|==
literal|0xffff
condition|)
name|rf7b
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|rf7b
operator|==
literal|0xffff
condition|)
name|rf7b
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|struct
name|bwi_gains
name|gains
decl_stmt|;
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xff80
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0xc
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xc
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x480
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x59
argument_list|,
literal|0x810
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|==
literal|0
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x3
argument_list|,
literal|0x122
argument_list|)
expr_stmt|;
else|else
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0xa
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x814
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x815
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x3
argument_list|,
literal|0xff9f
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|gains
argument_list|,
sizeof|sizeof
argument_list|(
name|gains
argument_list|)
argument_list|)
expr_stmt|;
name|gains
operator|.
name|tbl_gain1
operator|=
literal|3
expr_stmt|;
name|gains
operator|.
name|tbl_gain2
operator|=
literal|0
expr_stmt|;
name|gains
operator|.
name|phy_gain
operator|=
literal|1
expr_stmt|;
name|bwi_set_gains
argument_list|(
name|mac
argument_list|,
operator|&
name|gains
argument_list|)
expr_stmt|;
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xf0
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|30
argument_list|)
expr_stmt|;
name|nrssi
operator|=
name|bwi_nrssi_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|==
operator|-
literal|32
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7b
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi
operator|=
name|bwi_nrssi_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|>
operator|-
literal|31
operator|&&
name|rf7b
operator|==
literal|0xffff
condition|)
name|rf7b
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|rf7b
operator|==
literal|0xffff
condition|)
name|rf7b
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|rf7b
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7b
argument_list|,
name|rf7b
argument_list|)
expr_stmt|;
comment|/* 	 * Restore saved RF/PHY registers 	 */
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|6
condition|)
block|{
for|for
control|(
name|phy6_idx
operator|=
literal|0
init|;
name|phy6_idx
operator|<
literal|4
condition|;
operator|++
name|phy6_idx
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy6_regs
index|[
name|phy6_idx
index|]
argument_list|,
name|save_phy6
index|[
name|phy6_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Saved PHY registers 0, 1, 2 are handled later */
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|,
name|save_phy_comm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|SAVE_RF_MAX
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
operator|--
name|i
control|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|,
name|save_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|bwi_set_gains
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|6
condition|)
block|{
for|for
control|(
init|;
name|phy6_idx
operator|<
name|SAVE_PHY6_MAX
condition|;
operator|++
name|phy6_idx
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy6_regs
index|[
name|phy6_idx
index|]
argument_list|,
name|save_phy6
index|[
name|phy6_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
literal|0
index|]
argument_list|,
name|save_phy_comm
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
literal|2
index|]
argument_list|,
name|save_phy_comm
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
literal|1
index|]
argument_list|,
name|save_phy_comm
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SAVE_RF_MAX
undef|#
directive|undef
name|SAVE_PHY_COMM_MAX
undef|#
directive|undef
name|SAVE_PHY6_MAX
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_calc_nrssi_slope_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
define|#
directive|define
name|SAVE_RF_MAX
value|3
define|#
directive|define
name|SAVE_PHY_COMM_MAX
value|4
define|#
directive|define
name|SAVE_PHY3_MAX
value|8
specifier|static
specifier|const
name|uint16_t
name|save_rf_regs
index|[
name|SAVE_RF_MAX
index|]
init|=
block|{
literal|0x7a
block|,
literal|0x52
block|,
literal|0x43
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy_comm_regs
index|[
name|SAVE_PHY_COMM_MAX
index|]
init|=
block|{
literal|0x15
block|,
literal|0x5a
block|,
literal|0x59
block|,
literal|0x58
block|}
decl_stmt|;
specifier|static
specifier|const
name|uint16_t
name|save_phy3_regs
index|[
name|SAVE_PHY3_MAX
index|]
init|=
block|{
literal|0x002e
block|,
literal|0x002f
block|,
literal|0x080f
block|,
literal|0x0810
block|,
literal|0x0801
block|,
literal|0x0060
block|,
literal|0x0014
block|,
literal|0x0478
block|}
decl_stmt|;
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|uint16_t
name|save_rf
index|[
name|SAVE_RF_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy_comm
index|[
name|SAVE_PHY_COMM_MAX
index|]
decl_stmt|;
name|uint16_t
name|save_phy3
index|[
name|SAVE_PHY3_MAX
index|]
decl_stmt|;
name|uint16_t
name|ant_div
decl_stmt|,
name|bbp_atten
decl_stmt|,
name|chan_ex
decl_stmt|;
name|struct
name|bwi_gains
name|gains
decl_stmt|;
name|int16_t
name|nrssi
index|[
literal|2
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|phy3_idx
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|>=
literal|9
condition|)
return|return;
elseif|else
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
name|bwi_rf_set_nrssi_ofs_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
comment|/* 	 * Save RF/PHY registers for later restoration 	 */
name|ant_div
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|)
expr_stmt|;
name|CSR_SETBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|save_rf
index|[
name|i
index|]
operator|=
name|RF_READ
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|save_phy_comm
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bbp_atten
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|)
expr_stmt|;
name|chan_ex
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|3
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY3_MAX
condition|;
operator|++
name|i
control|)
name|save_phy3
index|[
name|i
index|]
operator|=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|save_phy3_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|4
operator|||
name|phy
operator|->
name|phy_rev
operator|==
literal|6
operator|||
name|phy
operator|->
name|phy_rev
operator|==
literal|7
condition|)
block|{
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x478
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|3
operator|||
name|phy
operator|->
name|phy_rev
operator|==
literal|5
condition|)
block|{
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x810
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
block|}
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x60
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x14
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Calculate nrssi0 	 */
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x70
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|gains
argument_list|,
sizeof|sizeof
argument_list|(
name|gains
argument_list|)
argument_list|)
expr_stmt|;
name|gains
operator|.
name|tbl_gain1
operator|=
literal|0
expr_stmt|;
name|gains
operator|.
name|tbl_gain2
operator|=
literal|8
expr_stmt|;
name|gains
operator|.
name|phy_gain
operator|=
literal|0
expr_stmt|;
name|bwi_set_gains
argument_list|(
name|mac
argument_list|,
operator|&
name|gains
argument_list|)
expr_stmt|;
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0xffcf
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xffcf
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
block|}
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi
index|[
literal|0
index|]
operator|=
name|bwi_nrssi_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* 	 * Calculate nrssi1 	 */
name|RF_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xff80
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_version
operator|>=
literal|2
condition|)
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x3
argument_list|,
literal|0xff9f
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|CSR_SETBITS_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|RF_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xf330
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0xffcf
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0xffcf
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|gains
argument_list|,
sizeof|sizeof
argument_list|(
name|gains
argument_list|)
argument_list|)
expr_stmt|;
name|gains
operator|.
name|tbl_gain1
operator|=
literal|3
expr_stmt|;
name|gains
operator|.
name|tbl_gain2
operator|=
literal|0
expr_stmt|;
name|gains
operator|.
name|phy_gain
operator|=
literal|1
expr_stmt|;
name|bwi_set_gains
argument_list|(
name|mac
argument_list|,
operator|&
name|gains
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|==
literal|8
condition|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xff0f
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x43
argument_list|,
literal|0xfff0
argument_list|,
literal|0x9
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x5a
argument_list|,
literal|0x480
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x59
argument_list|,
literal|0x810
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x58
argument_list|,
literal|0xd
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|nrssi
index|[
literal|1
index|]
operator|=
name|bwi_nrssi_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* 	 * Install calculated narrow RSSI values 	 */
if|if
condition|(
name|nrssi
index|[
literal|1
index|]
operator|==
name|nrssi
index|[
literal|0
index|]
condition|)
name|rf
operator|->
name|rf_nrssi_slope
operator|=
literal|0x10000
expr_stmt|;
else|else
name|rf
operator|->
name|rf_nrssi_slope
operator|=
literal|0x400000
operator|/
operator|(
name|nrssi
index|[
literal|0
index|]
operator|-
name|nrssi
index|[
literal|1
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|nrssi
index|[
literal|0
index|]
operator|>=
operator|-
literal|4
condition|)
block|{
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|=
name|nrssi
index|[
literal|1
index|]
expr_stmt|;
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|=
name|nrssi
index|[
literal|0
index|]
expr_stmt|;
block|}
comment|/* 	 * Restore saved RF/PHY registers 	 */
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|3
condition|)
block|{
for|for
control|(
name|phy3_idx
operator|=
literal|0
init|;
name|phy3_idx
operator|<
literal|4
condition|;
operator|++
name|phy3_idx
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy3_regs
index|[
name|phy3_idx
index|]
argument_list|,
name|save_phy3
index|[
name|phy3_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x812
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x811
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_RF_MAX
condition|;
operator|++
name|i
control|)
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
name|save_rf_regs
index|[
name|i
index|]
argument_list|,
name|save_rf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_ANTDIV
argument_list|,
name|ant_div
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BBP_ATTEN
argument_list|,
name|bbp_atten
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_RF_CHAN_EX
argument_list|,
name|chan_ex
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SAVE_PHY_COMM_MAX
condition|;
operator|++
name|i
control|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy_comm_regs
index|[
name|i
index|]
argument_list|,
name|save_phy_comm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bwi_rf_work_around
argument_list|(
name|mac
argument_list|,
name|rf
operator|->
name|rf_curchan
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x802
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
name|bwi_set_gains
argument_list|(
name|mac
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x429
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|3
condition|)
block|{
for|for
control|(
init|;
name|phy3_idx
operator|<
name|SAVE_PHY3_MAX
condition|;
operator|++
name|phy3_idx
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|save_phy3_regs
index|[
name|phy3_idx
index|]
argument_list|,
name|save_phy3
index|[
name|phy3_idx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|bwi_rf_init_sw_nrssi_table
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|bwi_rf_set_nrssi_thr_11g
argument_list|(
name|mac
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SAVE_RF_MAX
undef|#
directive|undef
name|SAVE_PHY_COMM_MAX
undef|#
directive|undef
name|SAVE_PHY3_MAX
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_init_sw_nrssi_table
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|int
name|d
decl_stmt|,
name|i
decl_stmt|;
name|d
operator|=
literal|0x1f
operator|-
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWI_NRSSI_TBLSZ
condition|;
operator|++
name|i
control|)
block|{
name|int
name|val
decl_stmt|;
name|val
operator|=
operator|(
operator|(
operator|(
name|i
operator|-
name|d
operator|)
operator|*
name|rf
operator|->
name|rf_nrssi_slope
operator|)
operator|/
literal|0x10000
operator|)
operator|+
literal|0x3a
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|0
condition|)
name|val
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|>
literal|0x3f
condition|)
name|val
operator|=
literal|0x3f
expr_stmt|;
name|rf
operator|->
name|rf_nrssi_table
index|[
name|i
index|]
operator|=
name|val
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|bwi_rf_init_hw_nrssi_table
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|uint16_t
name|adjust
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWI_NRSSI_TBLSZ
condition|;
operator|++
name|i
control|)
block|{
name|int16_t
name|val
decl_stmt|;
name|val
operator|=
name|bwi_nrssi_read
argument_list|(
name|mac
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|-=
name|adjust
expr_stmt|;
if|if
condition|(
name|val
operator|<
operator|-
literal|32
condition|)
name|val
operator|=
operator|-
literal|32
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|>
literal|31
condition|)
name|val
operator|=
literal|31
expr_stmt|;
name|bwi_nrssi_write
argument_list|(
name|mac
argument_list|,
name|i
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_set_nrssi_thr_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|int32_t
name|thr
decl_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|!=
name|BWI_RF_T_BCM2050
operator|||
operator|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_SW_NRSSI
operator|)
operator|==
literal|0
condition|)
return|return;
comment|/* 	 * Calculate nrssi threshold 	 */
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|>=
literal|6
condition|)
block|{
name|thr
operator|=
operator|(
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|-
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|)
operator|*
literal|32
expr_stmt|;
name|thr
operator|+=
literal|20
operator|*
operator|(
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|+
literal|1
operator|)
expr_stmt|;
name|thr
operator|/=
literal|40
expr_stmt|;
block|}
else|else
block|{
name|thr
operator|=
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|-
literal|5
expr_stmt|;
block|}
if|if
condition|(
name|thr
operator|<
literal|0
condition|)
name|thr
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|thr
operator|>
literal|0x3e
condition|)
name|thr
operator|=
literal|0x3e
expr_stmt|;
name|PHY_READ
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_NRSSI_THR_11B
argument_list|)
expr_stmt|;
comment|/* dummy read */
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_NRSSI_THR_11B
argument_list|,
operator|(
operator|(
operator|(
name|uint16_t
operator|)
name|thr
operator|)
operator|<<
literal|8
operator|)
operator||
literal|0x1c
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_rev
operator|>=
literal|6
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x87
argument_list|,
literal|0xe0d
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x86
argument_list|,
literal|0xc0b
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x85
argument_list|,
literal|0xa09
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x84
argument_list|,
literal|0x808
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x83
argument_list|,
literal|0x808
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x82
argument_list|,
literal|0x604
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x81
argument_list|,
literal|0x302
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x80
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|__inline
name|int32_t
name|_nrssi_threshold
parameter_list|(
specifier|const
name|struct
name|bwi_rf
modifier|*
name|rf
parameter_list|,
name|int32_t
name|val
parameter_list|)
block|{
name|val
operator|*=
operator|(
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|-
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|val
operator|+=
operator|(
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|<<
literal|6
operator|)
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|32
condition|)
name|val
operator|+=
literal|31
expr_stmt|;
else|else
name|val
operator|+=
literal|32
expr_stmt|;
name|val
operator|>>=
literal|6
expr_stmt|;
if|if
condition|(
name|val
operator|<
operator|-
literal|31
condition|)
name|val
operator|=
operator|-
literal|31
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|>
literal|31
condition|)
name|val
operator|=
literal|31
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_set_nrssi_thr_11g
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|int32_t
name|thr1
decl_stmt|,
name|thr2
decl_stmt|;
name|uint16_t
name|thr
decl_stmt|;
comment|/* 	 * Find the two nrssi thresholds 	 */
if|if
condition|(
operator|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
operator|)
operator|==
literal|0
operator|||
operator|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_SW_NRSSI
operator|)
operator|==
literal|0
condition|)
block|{
name|int16_t
name|nrssi
decl_stmt|;
name|nrssi
operator|=
name|bwi_nrssi_read
argument_list|(
name|mac
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrssi
operator|>=
literal|32
condition|)
name|nrssi
operator|-=
literal|64
expr_stmt|;
if|if
condition|(
name|nrssi
operator|<
literal|3
condition|)
block|{
name|thr1
operator|=
literal|0x2b
expr_stmt|;
name|thr2
operator|=
literal|0x27
expr_stmt|;
block|}
else|else
block|{
name|thr1
operator|=
literal|0x2d
expr_stmt|;
name|thr2
operator|=
literal|0x2b
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* TODO Interfere mode */
name|thr1
operator|=
name|_nrssi_threshold
argument_list|(
operator|&
name|mac
operator|->
name|mac_rf
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
name|thr2
operator|=
name|_nrssi_threshold
argument_list|(
operator|&
name|mac
operator|->
name|mac_rf
argument_list|,
literal|0xe
argument_list|)
expr_stmt|;
block|}
define|#
directive|define
name|NRSSI_THR1_MASK
value|__BITS(5, 0)
define|#
directive|define
name|NRSSI_THR2_MASK
value|__BITS(11, 6)
name|thr
operator|=
name|__SHIFTIN
argument_list|(
operator|(
name|uint32_t
operator|)
name|thr1
argument_list|,
name|NRSSI_THR1_MASK
argument_list|)
operator||
name|__SHIFTIN
argument_list|(
operator|(
name|uint32_t
operator|)
name|thr2
argument_list|,
name|NRSSI_THR2_MASK
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
name|BWI_PHYR_NRSSI_THR_11G
argument_list|,
literal|0xf000
argument_list|,
name|thr
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|NRSSI_THR1_MASK
undef|#
directive|undef
name|NRSSI_THR2_MASK
block|}
end_function

begin_function
name|void
name|bwi_rf_clear_tssi
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* XXX use function pointer */
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_mode
operator|==
name|IEEE80211_MODE_11A
condition|)
block|{
comment|/* TODO:11A */
block|}
else|else
block|{
name|uint16_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
name|val
operator|=
name|__SHIFTIN
argument_list|(
name|BWI_INVALID_TSSI
argument_list|,
name|BWI_LO_TSSI_MASK
argument_list|)
operator||
name|__SHIFTIN
argument_list|(
name|BWI_INVALID_TSSI
argument_list|,
name|BWI_HI_TSSI_MASK
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
operator|++
name|i
control|)
block|{
name|MOBJ_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_TSSI_DS
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
operator|++
name|i
control|)
block|{
name|MOBJ_WRITE_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_TSSI_OFDM
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|bwi_rf_clear_state
parameter_list|(
name|struct
name|bwi_rf
modifier|*
name|rf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|rf
operator|->
name|rf_flags
operator|&=
operator|~
name|BWI_RF_CLEAR_FLAGS
expr_stmt|;
name|bzero
argument_list|(
name|rf
operator|->
name|rf_lo
argument_list|,
sizeof|sizeof
argument_list|(
name|rf
operator|->
name|rf_lo
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|rf
operator|->
name|rf_lo_used
argument_list|,
sizeof|sizeof
argument_list|(
name|rf
operator|->
name|rf_lo_used
argument_list|)
argument_list|)
expr_stmt|;
name|rf
operator|->
name|rf_nrssi_slope
operator|=
literal|0
expr_stmt|;
name|rf
operator|->
name|rf_nrssi
index|[
literal|0
index|]
operator|=
name|BWI_INVALID_NRSSI
expr_stmt|;
name|rf
operator|->
name|rf_nrssi
index|[
literal|1
index|]
operator|=
name|BWI_INVALID_NRSSI
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BWI_NRSSI_TBLSZ
condition|;
operator|++
name|i
control|)
name|rf
operator|->
name|rf_nrssi_table
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
name|rf
operator|->
name|rf_lo_gain
operator|=
literal|0
expr_stmt|;
name|rf
operator|->
name|rf_rx_gain
operator|=
literal|0
expr_stmt|;
name|bcopy
argument_list|(
name|rf
operator|->
name|rf_txpower_map0
argument_list|,
name|rf
operator|->
name|rf_txpower_map
argument_list|,
sizeof|sizeof
argument_list|(
name|rf
operator|->
name|rf_txpower_map
argument_list|)
argument_list|)
expr_stmt|;
name|rf
operator|->
name|rf_idle_tssi
operator|=
name|rf
operator|->
name|rf_idle_tssi0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_on_11a
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* TODO:11A */
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_on_11bg
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xcc00
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_flags
operator|&
name|BWI_PHY_F_LINKED
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xc0
argument_list|)
expr_stmt|;
else|else
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bwi_rf_set_chan
argument_list|(
name|mac
argument_list|,
literal|6
comment|/* XXX */
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bwi_rf_set_ant_mode
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|int
name|ant_mode
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_phy
modifier|*
name|phy
init|=
operator|&
name|mac
operator|->
name|mac_phy
decl_stmt|;
name|uint16_t
name|val
decl_stmt|;
name|KASSERT
argument_list|(
name|ant_mode
operator|==
name|BWI_ANT_MODE_0
operator|||
name|ant_mode
operator|==
name|BWI_ANT_MODE_1
operator|||
name|ant_mode
operator|==
name|BWI_ANT_MODE_AUTO
argument_list|,
operator|(
literal|"ant_mode %d"
operator|,
name|ant_mode
operator|)
argument_list|)
expr_stmt|;
name|HFLAGS_CLRBITS
argument_list|(
name|mac
argument_list|,
name|BWI_HFLAG_AUTO_ANTDIV
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11B
condition|)
block|{
comment|/* NOTE: v4/v3 conflicts, take v3 */
if|if
condition|(
name|mac
operator|->
name|mac_rev
operator|==
literal|2
condition|)
name|val
operator|=
name|BWI_ANT_MODE_AUTO
expr_stmt|;
else|else
name|val
operator|=
name|ant_mode
expr_stmt|;
name|val
operator|<<=
literal|7
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x3e2
argument_list|,
literal|0xfe7f
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 11a/g */
comment|/* XXX reg/value naming */
name|val
operator|=
name|ant_mode
operator|<<
literal|7
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x401
argument_list|,
literal|0x7e7f
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ant_mode
operator|==
name|BWI_ANT_MODE_AUTO
condition|)
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x42b
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11A
condition|)
block|{
comment|/* TODO:11A */
block|}
else|else
block|{
comment|/* 11g */
if|if
condition|(
name|ant_mode
operator|==
name|BWI_ANT_MODE_AUTO
condition|)
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x48c
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
else|else
name|PHY_CLRBITS
argument_list|(
name|mac
argument_list|,
literal|0x48c
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|2
condition|)
block|{
name|PHY_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x461
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x4ad
argument_list|,
literal|0xff00
argument_list|,
literal|0x15
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|==
literal|2
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x427
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PHY_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x427
argument_list|,
literal|0xff00
argument_list|,
literal|0x8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phy
operator|->
name|phy_rev
operator|>=
literal|6
condition|)
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x49b
argument_list|,
literal|0xdc
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* XXX v4 set AUTO_ANTDIV unconditionally */
if|if
condition|(
name|ant_mode
operator|==
name|BWI_ANT_MODE_AUTO
condition|)
name|HFLAGS_SETBITS
argument_list|(
name|mac
argument_list|,
name|BWI_HFLAG_AUTO_ANTDIV
argument_list|)
expr_stmt|;
name|val
operator|=
name|ant_mode
operator|<<
literal|8
expr_stmt|;
name|MOBJ_FILT_SETBITS_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_TX_BEACON
argument_list|,
literal|0xfc3f
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MOBJ_FILT_SETBITS_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_TX_ACK
argument_list|,
literal|0xfc3f
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MOBJ_FILT_SETBITS_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_TX_PROBE_RESP
argument_list|,
literal|0xfc3f
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* XXX what's these */
if|if
condition|(
name|phy
operator|->
name|phy_mode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|CSR_SETBITS_2
argument_list|(
name|sc
argument_list|,
literal|0x5e
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
literal|0x100
argument_list|,
literal|0x1000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|mac_rev
operator|<
literal|5
condition|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
literal|0x10c
argument_list|,
literal|0x1000000
argument_list|)
expr_stmt|;
name|mac
operator|->
name|mac_rf
operator|.
name|rf_ant_mode
operator|=
name|ant_mode
expr_stmt|;
block|}
end_function

begin_function
name|int
name|bwi_rf_get_latest_tssi
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|int8_t
name|tssi
index|[]
parameter_list|,
name|uint16_t
name|ofs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
control|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|val
operator|=
name|MOBJ_READ_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|ofs
operator|+
name|i
argument_list|)
expr_stmt|;
name|tssi
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|int8_t
operator|)
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_LO_TSSI_MASK
argument_list|)
expr_stmt|;
name|tssi
index|[
name|i
operator|++
index|]
operator|=
operator|(
name|int8_t
operator|)
name|__SHIFTOUT
argument_list|(
name|val
argument_list|,
name|BWI_HI_TSSI_MASK
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|tssi
index|[
name|i
index|]
operator|==
name|BWI_INVALID_TSSI
condition|)
return|return
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|bwi_rf_tssi2dbm
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
name|int8_t
name|tssi
parameter_list|,
name|int8_t
modifier|*
name|txpwr
parameter_list|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|int
name|pwr_idx
decl_stmt|;
name|pwr_idx
operator|=
name|rf
operator|->
name|rf_idle_tssi
operator|+
operator|(
name|int
operator|)
name|tssi
operator|-
name|rf
operator|->
name|rf_base_tssi
expr_stmt|;
if|#
directive|if
literal|0
block|if (pwr_idx< 0 || pwr_idx>= BWI_TSSI_MAX) 		return EINVAL;
else|#
directive|else
if|if
condition|(
name|pwr_idx
operator|<
literal|0
condition|)
name|pwr_idx
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|pwr_idx
operator|>=
name|BWI_TSSI_MAX
condition|)
name|pwr_idx
operator|=
name|BWI_TSSI_MAX
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
operator|*
name|txpwr
operator|=
name|rf
operator|->
name|rf_txpower_map
index|[
name|pwr_idx
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwi_rf_calc_rssi_bcm2050
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwi_rxbuf_hdr
modifier|*
name|hdr
parameter_list|)
block|{
name|uint16_t
name|flags1
decl_stmt|,
name|flags3
decl_stmt|;
name|int
name|rssi
decl_stmt|,
name|lna_gain
decl_stmt|;
name|rssi
operator|=
name|hdr
operator|->
name|rxh_rssi
expr_stmt|;
name|flags1
operator|=
name|le16toh
argument_list|(
name|hdr
operator|->
name|rxh_flags1
argument_list|)
expr_stmt|;
name|flags3
operator|=
name|le16toh
argument_list|(
name|hdr
operator|->
name|rxh_flags3
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags1
operator|&
name|BWI_RXH_F1_OFDM
condition|)
block|{
if|if
condition|(
name|rssi
operator|>
literal|127
condition|)
name|rssi
operator|-=
literal|256
expr_stmt|;
if|if
condition|(
name|flags3
operator|&
name|BWI_RXH_F3_BCM2050_RSSI
condition|)
name|rssi
operator|+=
literal|17
expr_stmt|;
else|else
name|rssi
operator|-=
literal|4
expr_stmt|;
return|return
name|rssi
return|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_SW_NRSSI
condition|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
if|if
condition|(
name|rssi
operator|>=
name|BWI_NRSSI_TBLSZ
condition|)
name|rssi
operator|=
name|BWI_NRSSI_TBLSZ
operator|-
literal|1
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
literal|31
operator|-
operator|(
name|int
operator|)
name|rf
operator|->
name|rf_nrssi_table
index|[
name|rssi
index|]
operator|)
operator|*
operator|-
literal|131
operator|)
operator|/
literal|128
expr_stmt|;
name|rssi
operator|-=
literal|67
expr_stmt|;
block|}
else|else
block|{
name|rssi
operator|=
operator|(
operator|(
literal|31
operator|-
name|rssi
operator|)
operator|*
operator|-
literal|149
operator|)
operator|/
literal|128
expr_stmt|;
name|rssi
operator|-=
literal|68
expr_stmt|;
block|}
if|if
condition|(
name|mac
operator|->
name|mac_phy
operator|.
name|phy_mode
operator|!=
name|IEEE80211_MODE_11G
condition|)
return|return
name|rssi
return|;
if|if
condition|(
name|flags3
operator|&
name|BWI_RXH_F3_BCM2050_RSSI
condition|)
name|rssi
operator|+=
literal|20
expr_stmt|;
name|lna_gain
operator|=
name|__SHIFTOUT
argument_list|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|rxh_phyinfo
argument_list|)
argument_list|,
name|BWI_RXH_PHYINFO_LNAGAIN
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
name|mac
operator|->
name|mac_sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_RX
argument_list|,
literal|"lna_gain %d, phyinfo 0x%04x\n"
argument_list|,
name|lna_gain
argument_list|,
name|le16toh
argument_list|(
name|hdr
operator|->
name|rxh_phyinfo
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|lna_gain
condition|)
block|{
case|case
literal|0
case|:
name|rssi
operator|+=
literal|27
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rssi
operator|+=
literal|6
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rssi
operator|+=
literal|12
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 		 * XXX 		 * According to v3 spec, we should do _nothing_ here, 		 * but it seems that the result RSSI will be too low 		 * (relative to what ath(4) says).  Raise it a little 		 * bit. 		 */
name|rssi
operator|+=
literal|5
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"impossible lna gain %d"
argument_list|,
name|lna_gain
argument_list|)
expr_stmt|;
block|}
return|return
name|rssi
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwi_rf_calc_rssi_bcm2053
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwi_rxbuf_hdr
modifier|*
name|hdr
parameter_list|)
block|{
name|uint16_t
name|flags1
decl_stmt|;
name|int
name|rssi
decl_stmt|;
name|rssi
operator|=
operator|(
operator|(
operator|(
name|int
operator|)
name|hdr
operator|->
name|rxh_rssi
operator|-
literal|11
operator|)
operator|*
literal|103
operator|)
operator|/
literal|64
expr_stmt|;
name|flags1
operator|=
name|le16toh
argument_list|(
name|hdr
operator|->
name|rxh_flags1
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags1
operator|&
name|BWI_RXH_F1_BCM2053_RSSI
condition|)
name|rssi
operator|-=
literal|109
expr_stmt|;
else|else
name|rssi
operator|-=
literal|83
expr_stmt|;
return|return
name|rssi
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwi_rf_calc_rssi_bcm2060
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|bwi_rxbuf_hdr
modifier|*
name|hdr
parameter_list|)
block|{
name|int
name|rssi
decl_stmt|;
name|rssi
operator|=
name|hdr
operator|->
name|rxh_rssi
expr_stmt|;
if|if
condition|(
name|rssi
operator|>
literal|127
condition|)
name|rssi
operator|-=
literal|256
expr_stmt|;
return|return
name|rssi
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwi_rf_calc_noise_bcm2050
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|int
name|noise
decl_stmt|;
name|val
operator|=
name|MOBJ_READ_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_RF_NOISE
argument_list|)
expr_stmt|;
name|noise
operator|=
operator|(
name|int
operator|)
name|val
expr_stmt|;
comment|/* XXX check bounds? */
if|if
condition|(
name|mac
operator|->
name|mac_sc
operator|->
name|sc_card_flags
operator|&
name|BWI_CARD_F_SW_NRSSI
condition|)
block|{
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
if|if
condition|(
name|noise
operator|>=
name|BWI_NRSSI_TBLSZ
condition|)
name|noise
operator|=
name|BWI_NRSSI_TBLSZ
operator|-
literal|1
expr_stmt|;
name|noise
operator|=
operator|(
operator|(
literal|31
operator|-
operator|(
name|int
operator|)
name|rf
operator|->
name|rf_nrssi_table
index|[
name|noise
index|]
operator|)
operator|*
operator|-
literal|131
operator|)
operator|/
literal|128
expr_stmt|;
name|noise
operator|-=
literal|67
expr_stmt|;
block|}
else|else
block|{
name|noise
operator|=
operator|(
operator|(
literal|31
operator|-
name|noise
operator|)
operator|*
operator|-
literal|149
operator|)
operator|/
literal|128
expr_stmt|;
name|noise
operator|-=
literal|68
expr_stmt|;
block|}
return|return
name|noise
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwi_rf_calc_noise_bcm2053
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|int
name|noise
decl_stmt|;
name|val
operator|=
name|MOBJ_READ_2
argument_list|(
name|mac
argument_list|,
name|BWI_COMM_MOBJ
argument_list|,
name|BWI_COMM_MOBJ_RF_NOISE
argument_list|)
expr_stmt|;
name|noise
operator|=
operator|(
name|int
operator|)
name|val
expr_stmt|;
comment|/* XXX check bounds? */
name|noise
operator|=
operator|(
operator|(
name|noise
operator|-
literal|11
operator|)
operator|*
literal|103
operator|)
operator|/
literal|64
expr_stmt|;
name|noise
operator|-=
literal|109
expr_stmt|;
return|return
name|noise
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bwi_rf_calc_noise_bcm2060
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
comment|/* XXX Dont know how to calc */
return|return
operator|(
name|BWI_NOISE_FLOOR
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|bwi_rf_lo_measure_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|uint16_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
operator|++
name|i
control|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xafa0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xefa0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xffa0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|40
argument_list|)
expr_stmt|;
name|val
operator|+=
name|PHY_READ
argument_list|(
name|mac
argument_list|,
literal|0x2c
argument_list|)
expr_stmt|;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bwi_rf_lo_update_11b
parameter_list|(
name|struct
name|bwi_mac
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|bwi_softc
modifier|*
name|sc
init|=
name|mac
operator|->
name|mac_sc
decl_stmt|;
name|struct
name|bwi_rf
modifier|*
name|rf
init|=
operator|&
name|mac
operator|->
name|mac_rf
decl_stmt|;
name|struct
name|rf_saveregs
name|regs
decl_stmt|;
name|uint16_t
name|rf_val
decl_stmt|,
name|phy_val
decl_stmt|,
name|min_val
decl_stmt|,
name|val
decl_stmt|;
name|uint16_t
name|rf52
decl_stmt|,
name|bphy_ctrl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DPRINTF
argument_list|(
name|sc
argument_list|,
name|BWI_DBG_RF
operator||
name|BWI_DBG_INIT
argument_list|,
literal|"%s enter\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|regs
argument_list|,
sizeof|sizeof
argument_list|(
name|regs
argument_list|)
argument_list|)
expr_stmt|;
name|bphy_ctrl
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Save RF/PHY registers for later restoration 	 */
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|rf52
operator|=
name|RF_READ
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|)
operator|&
literal|0xfff0
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
block|{
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|0a
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|2a
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|03
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|01
argument_list|)
expr_stmt|;
name|SAVE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|SAVE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|43
argument_list|)
expr_stmt|;
name|SAVE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|7a
argument_list|)
expr_stmt|;
name|bphy_ctrl
operator|=
name|CSR_READ_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|)
expr_stmt|;
name|SAVE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|52
argument_list|)
expr_stmt|;
name|regs
operator|.
name|rf_52
operator|&=
literal|0xf0
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x30
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_PHY_CTRL
argument_list|,
literal|0x3f3f
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x35
argument_list|,
name|regs
operator|.
name|phy_35
operator|&
literal|0xff7f
argument_list|)
expr_stmt|;
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x7a
argument_list|,
name|regs
operator|.
name|rf_7a
operator|&
literal|0xfff0
argument_list|)
expr_stmt|;
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x15
argument_list|,
literal|0xb000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2b
argument_list|,
literal|0x203
argument_list|)
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2a
argument_list|,
literal|0x8a3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2b
argument_list|,
literal|0x1402
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Setup RF signal 	 */
name|rf_val
operator|=
literal|0
expr_stmt|;
name|min_val
operator|=
name|UINT16_MAX
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|rf52
operator||
name|i
argument_list|)
expr_stmt|;
name|bwi_rf_lo_measure_11b
argument_list|(
name|mac
argument_list|)
expr_stmt|;
comment|/* Ignore return value */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
operator|++
name|i
control|)
block|{
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|rf52
operator||
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
name|bwi_rf_lo_measure_11b
argument_list|(
name|mac
argument_list|)
operator|/
literal|10
expr_stmt|;
if|if
condition|(
name|val
operator|<
name|min_val
condition|)
block|{
name|min_val
operator|=
name|val
expr_stmt|;
name|rf_val
operator|=
name|i
expr_stmt|;
block|}
block|}
name|RF_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
name|rf52
operator||
name|rf_val
argument_list|)
expr_stmt|;
comment|/* 	 * Setup PHY signal 	 */
name|phy_val
operator|=
literal|0
expr_stmt|;
name|min_val
operator|=
name|UINT16_MAX
expr_stmt|;
for|for
control|(
name|i
operator|=
operator|-
literal|4
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
operator|-
literal|4
init|;
name|j
operator|<
literal|5
condition|;
name|j
operator|+=
literal|2
control|)
block|{
name|uint16_t
name|phy2f
decl_stmt|;
name|phy2f
operator|=
operator|(
literal|0x100
operator|*
name|i
operator|)
operator|+
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
name|phy2f
operator|+=
literal|0x100
expr_stmt|;
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2f
argument_list|,
name|phy2f
argument_list|)
expr_stmt|;
name|val
operator|=
name|bwi_rf_lo_measure_11b
argument_list|(
name|mac
argument_list|)
operator|/
literal|10
expr_stmt|;
if|if
condition|(
name|val
operator|<
name|min_val
condition|)
block|{
name|min_val
operator|=
name|val
expr_stmt|;
name|phy_val
operator|=
name|phy2f
expr_stmt|;
block|}
block|}
block|}
name|PHY_WRITE
argument_list|(
name|mac
argument_list|,
literal|0x2f
argument_list|,
name|phy_val
operator|+
literal|0x101
argument_list|)
expr_stmt|;
comment|/* 	 * Restore saved RF/PHY registers 	 */
if|if
condition|(
name|rf
operator|->
name|rf_type
operator|==
name|BWI_RF_T_BCM2050
condition|)
block|{
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|0a
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|2a
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|35
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|03
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|01
argument_list|)
expr_stmt|;
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|30
argument_list|)
expr_stmt|;
name|RESTORE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|43
argument_list|)
expr_stmt|;
name|RESTORE_RF_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|7a
argument_list|)
expr_stmt|;
name|RF_FILT_SETBITS
argument_list|(
name|mac
argument_list|,
literal|0x52
argument_list|,
literal|0xf
argument_list|,
name|regs
operator|.
name|rf_52
argument_list|)
expr_stmt|;
name|CSR_WRITE_2
argument_list|(
name|sc
argument_list|,
name|BWI_BPHY_CTRL
argument_list|,
name|bphy_ctrl
argument_list|)
expr_stmt|;
block|}
name|RESTORE_PHY_REG
argument_list|(
name|mac
argument_list|,
operator|&
name|regs
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|bwi_rf_work_around
argument_list|(
name|mac
argument_list|,
name|rf
operator|->
name|rf_curchan
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


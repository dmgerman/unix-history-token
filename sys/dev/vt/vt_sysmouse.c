begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1999 Kazutaka YOKOTA<yokota@zodiac.mech.utsunomiya-u.ac.jp>  * All rights reserved.  *  * Copyright (c) 2009 The FreeBSD Foundation  * All rights reserved.  *  * This software was developed by Ed Schouten under sponsorship from the  * FreeBSD Foundation.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/filio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<sys/random.h>
end_include

begin_include
include|#
directive|include
file|<sys/selinfo.h>
end_include

begin_include
include|#
directive|include
file|<sys/sigio.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<dev/vt/vt.h>
end_include

begin_decl_stmt
specifier|static
name|d_open_t
name|sysmouse_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|sysmouse_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_read_t
name|sysmouse_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|sysmouse_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_poll_t
name|sysmouse_poll
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|sysmouse_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_open
operator|=
name|sysmouse_open
block|,
operator|.
name|d_close
operator|=
name|sysmouse_close
block|,
operator|.
name|d_read
operator|=
name|sysmouse_read
block|,
operator|.
name|d_ioctl
operator|=
name|sysmouse_ioctl
block|,
operator|.
name|d_poll
operator|=
name|sysmouse_poll
block|,
operator|.
name|d_name
operator|=
literal|"sysmouse"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mtx
name|sysmouse_lock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cv
name|sysmouse_sleep
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|selinfo
name|sysmouse_bufpoll
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysmouse_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mousestatus_t
name|sysmouse_status
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sysmouse_flags
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SM_ASYNC
value|0x1
end_define

begin_decl_stmt
specifier|static
name|struct
name|sigio
modifier|*
name|sysmouse_sigio
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SYSMOUSE_MAXFRAMES
value|250
end_define

begin_comment
comment|/* 2 KB */
end_comment

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_SYSMOUSE
argument_list|,
literal|"sysmouse"
argument_list|,
literal|"sysmouse device"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
modifier|*
name|sysmouse_buffer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|sysmouse_start
decl_stmt|,
name|sysmouse_length
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|sysmouse_buf_read
parameter_list|(
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
name|MOUSE_SYS_PACKETSIZE
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|sysmouse_buffer
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
elseif|else
if|if
condition|(
name|sysmouse_length
operator|==
literal|0
condition|)
return|return
operator|(
name|EWOULDBLOCK
operator|)
return|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|sysmouse_buffer
operator|+
name|sysmouse_start
operator|*
name|MOUSE_SYS_PACKETSIZE
argument_list|,
name|MOUSE_SYS_PACKETSIZE
argument_list|)
expr_stmt|;
name|sysmouse_start
operator|=
operator|(
name|sysmouse_start
operator|+
literal|1
operator|)
operator|%
name|SYSMOUSE_MAXFRAMES
expr_stmt|;
name|sysmouse_length
operator|--
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
name|error
operator|=
name|uiomove
argument_list|(
name|buf
argument_list|,
name|length
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sysmouse_buf_store
parameter_list|(
specifier|const
name|unsigned
name|char
name|buf
index|[
name|MOUSE_SYS_PACKETSIZE
index|]
parameter_list|)
block|{
name|unsigned
name|int
name|idx
decl_stmt|;
if|if
condition|(
name|sysmouse_buffer
operator|==
name|NULL
operator|||
name|sysmouse_length
operator|==
name|SYSMOUSE_MAXFRAMES
condition|)
return|return;
name|idx
operator|=
operator|(
name|sysmouse_start
operator|+
name|sysmouse_length
operator|)
operator|%
name|SYSMOUSE_MAXFRAMES
expr_stmt|;
name|memcpy
argument_list|(
name|sysmouse_buffer
operator|+
name|idx
operator|*
name|MOUSE_SYS_PACKETSIZE
argument_list|,
name|buf
argument_list|,
name|MOUSE_SYS_PACKETSIZE
argument_list|)
expr_stmt|;
name|sysmouse_length
operator|++
expr_stmt|;
name|cv_broadcast
argument_list|(
operator|&
name|sysmouse_sleep
argument_list|)
expr_stmt|;
name|selwakeup
argument_list|(
operator|&
name|sysmouse_bufpoll
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysmouse_flags
operator|&
name|SM_ASYNC
operator|&&
name|sysmouse_sigio
operator|!=
name|NULL
condition|)
name|pgsigio
argument_list|(
operator|&
name|sysmouse_sigio
argument_list|,
name|SIGIO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sysmouse_process_event
parameter_list|(
name|mouse_info_t
modifier|*
name|mi
parameter_list|)
block|{
comment|/* MOUSE_BUTTON?DOWN -> MOUSE_MSC_BUTTON?UP */
specifier|static
specifier|const
name|int
name|buttonmap
index|[
literal|8
index|]
init|=
block|{
name|MOUSE_MSC_BUTTON1UP
operator||
name|MOUSE_MSC_BUTTON2UP
operator||
name|MOUSE_MSC_BUTTON3UP
block|,
name|MOUSE_MSC_BUTTON2UP
operator||
name|MOUSE_MSC_BUTTON3UP
block|,
name|MOUSE_MSC_BUTTON1UP
operator||
name|MOUSE_MSC_BUTTON3UP
block|,
name|MOUSE_MSC_BUTTON3UP
block|,
name|MOUSE_MSC_BUTTON1UP
operator||
name|MOUSE_MSC_BUTTON2UP
block|,
name|MOUSE_MSC_BUTTON2UP
block|,
name|MOUSE_MSC_BUTTON1UP
block|,
literal|0
block|, 	}
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
name|MOUSE_SYS_PACKETSIZE
index|]
decl_stmt|;
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|iy
decl_stmt|,
name|z
decl_stmt|;
name|random_harvest
argument_list|(
name|mi
argument_list|,
sizeof|sizeof
expr|*
name|mi
argument_list|,
literal|2
argument_list|,
name|RANDOM_MOUSE
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mi
operator|->
name|operation
condition|)
block|{
case|case
name|MOUSE_ACTION
case|:
name|sysmouse_status
operator|.
name|button
operator|=
name|mi
operator|->
name|u
operator|.
name|data
operator|.
name|buttons
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|MOUSE_MOTION_EVENT
case|:
name|x
operator|=
name|mi
operator|->
name|u
operator|.
name|data
operator|.
name|x
expr_stmt|;
name|y
operator|=
name|mi
operator|->
name|u
operator|.
name|data
operator|.
name|y
expr_stmt|;
name|z
operator|=
name|mi
operator|->
name|u
operator|.
name|data
operator|.
name|z
expr_stmt|;
break|break;
case|case
name|MOUSE_BUTTON_EVENT
case|:
name|x
operator|=
name|y
operator|=
name|z
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|u
operator|.
name|event
operator|.
name|value
operator|>
literal|0
condition|)
name|sysmouse_status
operator|.
name|button
operator||=
name|mi
operator|->
name|u
operator|.
name|event
operator|.
name|id
expr_stmt|;
else|else
name|sysmouse_status
operator|.
name|button
operator|&=
operator|~
name|mi
operator|->
name|u
operator|.
name|event
operator|.
name|id
expr_stmt|;
break|break;
default|default:
goto|goto
name|done
goto|;
block|}
name|sysmouse_status
operator|.
name|dx
operator|+=
name|x
expr_stmt|;
name|sysmouse_status
operator|.
name|dy
operator|+=
name|y
expr_stmt|;
name|sysmouse_status
operator|.
name|dz
operator|+=
name|z
expr_stmt|;
name|sysmouse_status
operator|.
name|flags
operator||=
operator|(
operator|(
name|x
operator|||
name|y
operator|||
name|z
operator|)
condition|?
name|MOUSE_POSCHANGED
else|:
literal|0
operator|)
operator||
operator|(
name|sysmouse_status
operator|.
name|obutton
operator|^
name|sysmouse_status
operator|.
name|button
operator|)
expr_stmt|;
if|if
condition|(
name|sysmouse_status
operator|.
name|flags
operator|==
literal|0
condition|)
goto|goto
name|done
goto|;
comment|/* The first five bytes are compatible with MouseSystems. */
name|buf
index|[
literal|0
index|]
operator|=
name|MOUSE_MSC_SYNC
operator||
name|buttonmap
index|[
name|sysmouse_status
operator|.
name|button
operator|&
name|MOUSE_STDBUTTONS
index|]
expr_stmt|;
name|x
operator|=
name|imax
argument_list|(
name|imin
argument_list|(
name|x
argument_list|,
literal|255
argument_list|)
argument_list|,
operator|-
literal|256
argument_list|)
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|x
operator|>>
literal|1
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
name|x
operator|-
name|buf
index|[
literal|1
index|]
expr_stmt|;
name|iy
operator|=
operator|-
name|imax
argument_list|(
name|imin
argument_list|(
name|y
argument_list|,
literal|255
argument_list|)
argument_list|,
operator|-
literal|256
argument_list|)
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|iy
operator|>>
literal|1
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
name|iy
operator|-
name|buf
index|[
literal|2
index|]
expr_stmt|;
comment|/* Extended part. */
name|z
operator|=
name|imax
argument_list|(
name|imin
argument_list|(
name|z
argument_list|,
literal|127
argument_list|)
argument_list|,
operator|-
literal|128
argument_list|)
expr_stmt|;
name|buf
index|[
literal|5
index|]
operator|=
operator|(
name|z
operator|>>
literal|1
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|buf
index|[
literal|6
index|]
operator|=
operator|(
name|z
operator|-
operator|(
name|z
operator|>>
literal|1
operator|)
operator|)
operator|&
literal|0x7f
expr_stmt|;
comment|/* Buttons 4-10. */
name|buf
index|[
literal|7
index|]
operator|=
operator|(
operator|~
name|sysmouse_status
operator|.
name|button
operator|>>
literal|3
operator|)
operator|&
literal|0x7f
expr_stmt|;
name|sysmouse_buf_store
argument_list|(
name|buf
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
name|vt_mouse_event
argument_list|(
name|mi
operator|->
name|operation
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|mi
operator|->
name|u
operator|.
name|event
operator|.
name|id
argument_list|,
name|mi
operator|->
name|u
operator|.
name|event
operator|.
name|value
argument_list|,
name|sysmouse_level
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
name|done
label|:
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysmouse_open
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|oflags
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|void
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|MOUSE_SYS_PACKETSIZE
operator|*
name|SYSMOUSE_MAXFRAMES
argument_list|,
name|M_SYSMOUSE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysmouse_buffer
operator|==
name|NULL
condition|)
block|{
name|sysmouse_buffer
operator|=
name|buf
expr_stmt|;
name|sysmouse_start
operator|=
name|sysmouse_length
operator|=
literal|0
expr_stmt|;
name|sysmouse_level
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|buf
argument_list|,
name|M_SYSMOUSE
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysmouse_close
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|fflag
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sysmouse_buffer
argument_list|,
name|M_SYSMOUSE
argument_list|)
expr_stmt|;
name|sysmouse_buffer
operator|=
name|NULL
expr_stmt|;
name|sysmouse_level
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysmouse_read
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|ioflag
parameter_list|)
block|{
name|unsigned
name|int
name|length
decl_stmt|;
name|ssize_t
name|oresid
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|oresid
operator|=
name|uio
operator|->
name|uio_resid
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
name|length
operator|=
name|sysmouse_level
operator|>=
literal|1
condition|?
name|MOUSE_SYS_PACKETSIZE
else|:
name|MOUSE_MSC_PACKETSIZE
expr_stmt|;
while|while
condition|(
name|uio
operator|->
name|uio_resid
operator|>=
name|length
condition|)
block|{
name|error
operator|=
name|sysmouse_buf_read
argument_list|(
name|uio
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
comment|/* Process the next frame. */
continue|continue;
block|}
elseif|else
if|if
condition|(
name|error
operator|!=
name|EWOULDBLOCK
condition|)
block|{
comment|/* Error (e.g. EFAULT). */
break|break;
block|}
else|else
block|{
comment|/* Block. */
if|if
condition|(
name|oresid
operator|!=
name|uio
operator|->
name|uio_resid
operator|||
name|ioflag
operator|&
name|O_NONBLOCK
condition|)
break|break;
name|error
operator|=
name|cv_wait_sig
argument_list|(
operator|&
name|sysmouse_sleep
argument_list|,
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
break|break;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysmouse_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|FIOASYNC
case|:
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
condition|)
name|sysmouse_flags
operator||=
name|SM_ASYNC
expr_stmt|;
else|else
name|sysmouse_flags
operator|&=
operator|~
name|SM_ASYNC
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|FIONBIO
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|FIOGETOWN
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|fgetown
argument_list|(
operator|&
name|sysmouse_sigio
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|FIOSETOWN
case|:
return|return
operator|(
name|fsetown
argument_list|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
argument_list|,
operator|&
name|sysmouse_sigio
argument_list|)
operator|)
return|;
case|case
name|MOUSE_GETHWINFO
case|:
block|{
name|mousehw_t
modifier|*
name|hw
init|=
operator|(
name|mousehw_t
operator|*
operator|)
name|data
decl_stmt|;
name|hw
operator|->
name|buttons
operator|=
literal|10
expr_stmt|;
name|hw
operator|->
name|iftype
operator|=
name|MOUSE_IF_SYSMOUSE
expr_stmt|;
name|hw
operator|->
name|type
operator|=
name|MOUSE_MOUSE
expr_stmt|;
name|hw
operator|->
name|model
operator|=
name|MOUSE_MODEL_GENERIC
expr_stmt|;
name|hw
operator|->
name|hwid
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|MOUSE_GETLEVEL
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|sysmouse_level
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|MOUSE_GETMODE
case|:
block|{
name|mousemode_t
modifier|*
name|mode
init|=
operator|(
name|mousemode_t
operator|*
operator|)
name|data
decl_stmt|;
name|mode
operator|->
name|rate
operator|=
operator|-
literal|1
expr_stmt|;
name|mode
operator|->
name|resolution
operator|=
operator|-
literal|1
expr_stmt|;
name|mode
operator|->
name|accelfactor
operator|=
literal|0
expr_stmt|;
name|mode
operator|->
name|level
operator|=
name|sysmouse_level
expr_stmt|;
switch|switch
condition|(
name|mode
operator|->
name|level
condition|)
block|{
case|case
literal|0
case|:
name|mode
operator|->
name|protocol
operator|=
name|MOUSE_PROTO_MSC
expr_stmt|;
name|mode
operator|->
name|packetsize
operator|=
name|MOUSE_MSC_PACKETSIZE
expr_stmt|;
name|mode
operator|->
name|syncmask
index|[
literal|0
index|]
operator|=
name|MOUSE_MSC_SYNCMASK
expr_stmt|;
name|mode
operator|->
name|syncmask
index|[
literal|1
index|]
operator|=
name|MOUSE_MSC_SYNC
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|mode
operator|->
name|protocol
operator|=
name|MOUSE_PROTO_SYSMOUSE
expr_stmt|;
name|mode
operator|->
name|packetsize
operator|=
name|MOUSE_SYS_PACKETSIZE
expr_stmt|;
name|mode
operator|->
name|syncmask
index|[
literal|0
index|]
operator|=
name|MOUSE_SYS_SYNCMASK
expr_stmt|;
name|mode
operator|->
name|syncmask
index|[
literal|1
index|]
operator|=
name|MOUSE_SYS_SYNC
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|MOUSE_GETSTATUS
case|:
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
operator|*
operator|(
name|mousestatus_t
operator|*
operator|)
name|data
operator|=
name|sysmouse_status
expr_stmt|;
name|sysmouse_status
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|sysmouse_status
operator|.
name|obutton
operator|=
name|sysmouse_status
operator|.
name|button
expr_stmt|;
name|sysmouse_status
operator|.
name|dx
operator|=
literal|0
expr_stmt|;
name|sysmouse_status
operator|.
name|dy
operator|=
literal|0
expr_stmt|;
name|sysmouse_status
operator|.
name|dz
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|MOUSE_SETLEVEL
case|:
block|{
name|int
name|level
decl_stmt|;
name|level
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|level
operator|!=
literal|0
operator|&&
name|level
operator|!=
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sysmouse_level
operator|=
name|level
expr_stmt|;
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
name|vt_mouse_state
argument_list|(
operator|(
name|level
operator|==
literal|0
operator|)
condition|?
name|VT_MOUSE_SHOW
else|:
name|VT_MOUSE_HIDE
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|MOUSE_SETMODE
case|:
block|{
name|mousemode_t
modifier|*
name|mode
init|=
operator|(
name|mousemode_t
operator|*
operator|)
name|data
decl_stmt|;
switch|switch
condition|(
name|mode
operator|->
name|level
condition|)
block|{
case|case
operator|-
literal|1
case|:
comment|/* Do nothing. */
break|break;
case|case
literal|0
case|:
case|case
literal|1
case|:
name|sysmouse_level
operator|=
name|mode
operator|->
name|level
expr_stmt|;
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
name|vt_mouse_state
argument_list|(
operator|(
name|mode
operator|->
name|level
operator|==
literal|0
operator|)
condition|?
name|VT_MOUSE_SHOW
else|:
name|VT_MOUSE_HIDE
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
name|MOUSE_MOUSECHAR
case|:
return|return
operator|(
literal|0
operator|)
return|;
default|default:
ifdef|#
directive|ifdef
name|VT_SYSMOUSE_DEBUG
name|printf
argument_list|(
literal|"sysmouse: unknown ioctl: %c:%lx\n"
argument_list|,
operator|(
name|char
operator|)
name|IOCGROUP
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|IOCBASECMD
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|sysmouse_poll
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|events
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|int
name|revents
init|=
literal|0
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
condition|)
block|{
if|if
condition|(
name|sysmouse_length
operator|>
literal|0
condition|)
name|revents
operator|=
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
expr_stmt|;
else|else
name|selrecord
argument_list|(
name|td
argument_list|,
operator|&
name|sysmouse_bufpoll
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sysmouse_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|revents
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sysmouse_drvinit
parameter_list|(
name|void
modifier|*
name|unused
parameter_list|)
block|{
if|if
condition|(
operator|!
name|vty_enabled
argument_list|(
name|VTY_VT
argument_list|)
condition|)
return|return;
name|mtx_init
argument_list|(
operator|&
name|sysmouse_lock
argument_list|,
literal|"sysmouse"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|cv_init
argument_list|(
operator|&
name|sysmouse_sleep
argument_list|,
literal|"sysmrd"
argument_list|)
expr_stmt|;
name|make_dev
argument_list|(
operator|&
name|sysmouse_cdevsw
argument_list|,
literal|0
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0600
argument_list|,
literal|"sysmouse"
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|SYSINIT
argument_list|(
name|sysmouse
argument_list|,
name|SI_SUB_DRIVERS
argument_list|,
name|SI_ORDER_MIDDLE
argument_list|,
name|sysmouse_drvinit
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* mga_state.c -- State support for MGA G200/G400 -*- linux-c -*-  * Created: Thu Jan 27 02:53:43 2000 by jhartmann@precisioninsight.com */
end_comment

begin_comment
comment|/*-  * Copyright 1999 Precision Insight, Inc., Cedar Park, Texas.  * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Jeff Hartmann<jhartmann@valinux.com>  *    Keith Whitwell<keith@tungstengraphics.com>  *  * Rewritten by:  *    Gareth Hughes<gareth@valinux.com>  * $FreeBSD$  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/mga_drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/mga_drv.h"
end_include

begin_comment
comment|/* ================================================================  * DMA hardware state programming functions  */
end_comment

begin_function
specifier|static
name|void
name|mga_emit_clip_rect
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_clip_rect_t
modifier|*
name|box
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|unsigned
name|int
name|pitch
init|=
name|dev_priv
operator|->
name|front_pitch
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* Force reset of DWGCTL on G400 (eliminates clip disable bit). 	 */
if|if
condition|(
name|dev_priv
operator|->
name|chipset
operator|==
name|MGA_CARD_TYPE_G400
condition|)
block|{
name|DMA_BLOCK
argument_list|(
name|MGA_DWGCTL
argument_list|,
name|ctx
operator|->
name|dwgctl
argument_list|,
name|MGA_LEN
operator|+
name|MGA_EXEC
argument_list|,
literal|0x80000000
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|ctx
operator|->
name|dwgctl
argument_list|,
name|MGA_LEN
operator|+
name|MGA_EXEC
argument_list|,
literal|0x80000000
argument_list|)
expr_stmt|;
block|}
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_CXBNDRY
argument_list|,
operator|(
operator|(
name|box
operator|->
name|x2
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
name|box
operator|->
name|x1
argument_list|,
name|MGA_YTOP
argument_list|,
name|box
operator|->
name|y1
operator|*
name|pitch
argument_list|,
name|MGA_YBOT
argument_list|,
operator|(
name|box
operator|->
name|y2
operator|-
literal|1
operator|)
operator|*
name|pitch
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|mga_g200_emit_context
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DSTORG
argument_list|,
name|ctx
operator|->
name|dstorg
argument_list|,
name|MGA_MACCESS
argument_list|,
name|ctx
operator|->
name|maccess
argument_list|,
name|MGA_PLNWT
argument_list|,
name|ctx
operator|->
name|plnwt
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|ctx
operator|->
name|dwgctl
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_ALPHACTRL
argument_list|,
name|ctx
operator|->
name|alphactrl
argument_list|,
name|MGA_FOGCOL
argument_list|,
name|ctx
operator|->
name|fogcolor
argument_list|,
name|MGA_WFLAG
argument_list|,
name|ctx
operator|->
name|wflag
argument_list|,
name|MGA_ZORG
argument_list|,
name|dev_priv
operator|->
name|depth_offset
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_FCOL
argument_list|,
name|ctx
operator|->
name|fcol
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|mga_g400_emit_context
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DSTORG
argument_list|,
name|ctx
operator|->
name|dstorg
argument_list|,
name|MGA_MACCESS
argument_list|,
name|ctx
operator|->
name|maccess
argument_list|,
name|MGA_PLNWT
argument_list|,
name|ctx
operator|->
name|plnwt
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|ctx
operator|->
name|dwgctl
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_ALPHACTRL
argument_list|,
name|ctx
operator|->
name|alphactrl
argument_list|,
name|MGA_FOGCOL
argument_list|,
name|ctx
operator|->
name|fogcolor
argument_list|,
name|MGA_WFLAG
argument_list|,
name|ctx
operator|->
name|wflag
argument_list|,
name|MGA_ZORG
argument_list|,
name|dev_priv
operator|->
name|depth_offset
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WFLAG1
argument_list|,
name|ctx
operator|->
name|wflag
argument_list|,
name|MGA_TDUALSTAGE0
argument_list|,
name|ctx
operator|->
name|tdualstage0
argument_list|,
name|MGA_TDUALSTAGE1
argument_list|,
name|ctx
operator|->
name|tdualstage1
argument_list|,
name|MGA_FCOL
argument_list|,
name|ctx
operator|->
name|fcol
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_STENCIL
argument_list|,
name|ctx
operator|->
name|stencil
argument_list|,
name|MGA_STENCILCTL
argument_list|,
name|ctx
operator|->
name|stencilctl
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|mga_g200_emit_tex0
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|0
index|]
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXCTL2
argument_list|,
name|tex
operator|->
name|texctl2
argument_list|,
name|MGA_TEXCTL
argument_list|,
name|tex
operator|->
name|texctl
argument_list|,
name|MGA_TEXFILTER
argument_list|,
name|tex
operator|->
name|texfilter
argument_list|,
name|MGA_TEXBORDERCOL
argument_list|,
name|tex
operator|->
name|texbordercol
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXORG
argument_list|,
name|tex
operator|->
name|texorg
argument_list|,
name|MGA_TEXORG1
argument_list|,
name|tex
operator|->
name|texorg1
argument_list|,
name|MGA_TEXORG2
argument_list|,
name|tex
operator|->
name|texorg2
argument_list|,
name|MGA_TEXORG3
argument_list|,
name|tex
operator|->
name|texorg3
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXORG4
argument_list|,
name|tex
operator|->
name|texorg4
argument_list|,
name|MGA_TEXWIDTH
argument_list|,
name|tex
operator|->
name|texwidth
argument_list|,
name|MGA_TEXHEIGHT
argument_list|,
name|tex
operator|->
name|texheight
argument_list|,
name|MGA_WR24
argument_list|,
name|tex
operator|->
name|texwidth
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WR34
argument_list|,
name|tex
operator|->
name|texheight
argument_list|,
name|MGA_TEXTRANS
argument_list|,
literal|0x0000ffff
argument_list|,
name|MGA_TEXTRANSHIGH
argument_list|,
literal|0x0000ffff
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|mga_g400_emit_tex0
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|0
index|]
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
comment|/*  	printk("mga_g400_emit_tex0 %x %x %x\n", tex->texorg, */
comment|/*  	       tex->texctl, tex->texctl2); */
name|BEGIN_DMA
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXCTL2
argument_list|,
name|tex
operator|->
name|texctl2
operator||
name|MGA_G400_TC2_MAGIC
argument_list|,
name|MGA_TEXCTL
argument_list|,
name|tex
operator|->
name|texctl
argument_list|,
name|MGA_TEXFILTER
argument_list|,
name|tex
operator|->
name|texfilter
argument_list|,
name|MGA_TEXBORDERCOL
argument_list|,
name|tex
operator|->
name|texbordercol
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXORG
argument_list|,
name|tex
operator|->
name|texorg
argument_list|,
name|MGA_TEXORG1
argument_list|,
name|tex
operator|->
name|texorg1
argument_list|,
name|MGA_TEXORG2
argument_list|,
name|tex
operator|->
name|texorg2
argument_list|,
name|MGA_TEXORG3
argument_list|,
name|tex
operator|->
name|texorg3
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXORG4
argument_list|,
name|tex
operator|->
name|texorg4
argument_list|,
name|MGA_TEXWIDTH
argument_list|,
name|tex
operator|->
name|texwidth
argument_list|,
name|MGA_TEXHEIGHT
argument_list|,
name|tex
operator|->
name|texheight
argument_list|,
name|MGA_WR49
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WR57
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR53
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR61
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR52
argument_list|,
name|MGA_G400_WR_MAGIC
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WR60
argument_list|,
name|MGA_G400_WR_MAGIC
argument_list|,
name|MGA_WR54
argument_list|,
name|tex
operator|->
name|texwidth
operator||
name|MGA_G400_WR_MAGIC
argument_list|,
name|MGA_WR62
argument_list|,
name|tex
operator|->
name|texheight
operator||
name|MGA_G400_WR_MAGIC
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_TEXTRANS
argument_list|,
literal|0x0000ffff
argument_list|,
name|MGA_TEXTRANSHIGH
argument_list|,
literal|0x0000ffff
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|mga_g400_emit_tex1
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|1
index|]
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
comment|/*  	printk("mga_g400_emit_tex1 %x %x %x\n", tex->texorg,  */
comment|/*  	       tex->texctl, tex->texctl2); */
name|BEGIN_DMA
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXCTL2
argument_list|,
operator|(
name|tex
operator|->
name|texctl2
operator||
name|MGA_MAP1_ENABLE
operator||
name|MGA_G400_TC2_MAGIC
operator|)
argument_list|,
name|MGA_TEXCTL
argument_list|,
name|tex
operator|->
name|texctl
argument_list|,
name|MGA_TEXFILTER
argument_list|,
name|tex
operator|->
name|texfilter
argument_list|,
name|MGA_TEXBORDERCOL
argument_list|,
name|tex
operator|->
name|texbordercol
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXORG
argument_list|,
name|tex
operator|->
name|texorg
argument_list|,
name|MGA_TEXORG1
argument_list|,
name|tex
operator|->
name|texorg1
argument_list|,
name|MGA_TEXORG2
argument_list|,
name|tex
operator|->
name|texorg2
argument_list|,
name|MGA_TEXORG3
argument_list|,
name|tex
operator|->
name|texorg3
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXORG4
argument_list|,
name|tex
operator|->
name|texorg4
argument_list|,
name|MGA_TEXWIDTH
argument_list|,
name|tex
operator|->
name|texwidth
argument_list|,
name|MGA_TEXHEIGHT
argument_list|,
name|tex
operator|->
name|texheight
argument_list|,
name|MGA_WR49
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WR57
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR53
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR61
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR52
argument_list|,
name|tex
operator|->
name|texwidth
operator||
name|MGA_G400_WR_MAGIC
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WR60
argument_list|,
name|tex
operator|->
name|texheight
operator||
name|MGA_G400_WR_MAGIC
argument_list|,
name|MGA_TEXTRANS
argument_list|,
literal|0x0000ffff
argument_list|,
name|MGA_TEXTRANSHIGH
argument_list|,
literal|0x0000ffff
argument_list|,
name|MGA_TEXCTL2
argument_list|,
name|tex
operator|->
name|texctl2
operator||
name|MGA_G400_TC2_MAGIC
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|mga_g200_emit_pipe
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|unsigned
name|int
name|pipe
init|=
name|sarea_priv
operator|->
name|warp_pipe
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WIADDR
argument_list|,
name|MGA_WMODE_SUSPEND
argument_list|,
name|MGA_WVRTXSZ
argument_list|,
literal|0x00000007
argument_list|,
name|MGA_WFLAG
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR24
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WR25
argument_list|,
literal|0x00000100
argument_list|,
name|MGA_WR34
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR42
argument_list|,
literal|0x0000ffff
argument_list|,
name|MGA_WR60
argument_list|,
literal|0x0000ffff
argument_list|)
expr_stmt|;
comment|/* Padding required to to hardware bug. 	 */
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_WIADDR
argument_list|,
operator|(
name|dev_priv
operator|->
name|warp_pipe_phys
index|[
name|pipe
index|]
operator||
name|MGA_WMODE_START
operator||
name|MGA_WAGP_ENABLE
operator|)
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|mga_g400_emit_pipe
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|unsigned
name|int
name|pipe
init|=
name|sarea_priv
operator|->
name|warp_pipe
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
comment|/*  	printk("mga_g400_emit_pipe %x\n", pipe); */
name|BEGIN_DMA
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WIADDR2
argument_list|,
name|MGA_WMODE_SUSPEND
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|pipe
operator|&
name|MGA_T2
condition|)
block|{
name|DMA_BLOCK
argument_list|(
name|MGA_WVRTXSZ
argument_list|,
literal|0x00001e09
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x1e000000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dev_priv
operator|->
name|warp_pipe
operator|&
name|MGA_T2
condition|)
block|{
comment|/* Flush the WARP pipe */
name|DMA_BLOCK
argument_list|(
name|MGA_YDST
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_FXLEFT
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_FXRIGHT
argument_list|,
literal|0x00000001
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|MGA_DWGCTL_FLUSH
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_LEN
operator|+
name|MGA_EXEC
argument_list|,
literal|0x00000001
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007000
argument_list|,
name|MGA_TEXCTL2
argument_list|,
name|MGA_G400_TC2_MAGIC
argument_list|,
name|MGA_LEN
operator|+
name|MGA_EXEC
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_TEXCTL2
argument_list|,
operator|(
name|MGA_DUALTEX
operator||
name|MGA_G400_TC2_MAGIC
operator|)
argument_list|,
name|MGA_LEN
operator|+
name|MGA_EXEC
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_TEXCTL2
argument_list|,
name|MGA_G400_TC2_MAGIC
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
name|DMA_BLOCK
argument_list|(
name|MGA_WVRTXSZ
argument_list|,
literal|0x00001807
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WACCEPTSEQ
argument_list|,
literal|0x18000000
argument_list|)
expr_stmt|;
block|}
name|DMA_BLOCK
argument_list|(
name|MGA_WFLAG
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WFLAG1
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_WR56
argument_list|,
name|MGA_G400_WR56_MAGIC
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_WR49
argument_list|,
literal|0x00000000
argument_list|,
comment|/* tex0              */
name|MGA_WR57
argument_list|,
literal|0x00000000
argument_list|,
comment|/* tex0              */
name|MGA_WR53
argument_list|,
literal|0x00000000
argument_list|,
comment|/* tex1              */
name|MGA_WR61
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* tex1              */
name|DMA_BLOCK
argument_list|(
name|MGA_WR54
argument_list|,
name|MGA_G400_WR_MAGIC
argument_list|,
comment|/* tex0 width        */
name|MGA_WR62
argument_list|,
name|MGA_G400_WR_MAGIC
argument_list|,
comment|/* tex0 height       */
name|MGA_WR52
argument_list|,
name|MGA_G400_WR_MAGIC
argument_list|,
comment|/* tex1 width        */
name|MGA_WR60
argument_list|,
name|MGA_G400_WR_MAGIC
argument_list|)
expr_stmt|;
comment|/* tex1 height       */
comment|/* Padding required to to hardware bug */
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_WIADDR2
argument_list|,
operator|(
name|dev_priv
operator|->
name|warp_pipe_phys
index|[
name|pipe
index|]
operator||
name|MGA_WMODE_START
operator||
name|MGA_WAGP_ENABLE
operator|)
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mga_g200_emit_state
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|unsigned
name|int
name|dirty
init|=
name|sarea_priv
operator|->
name|dirty
decl_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|warp_pipe
operator|!=
name|dev_priv
operator|->
name|warp_pipe
condition|)
block|{
name|mga_g200_emit_pipe
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|warp_pipe
operator|=
name|sarea_priv
operator|->
name|warp_pipe
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_CONTEXT
condition|)
block|{
name|mga_g200_emit_context
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|MGA_UPLOAD_CONTEXT
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_TEX0
condition|)
block|{
name|mga_g200_emit_tex0
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|MGA_UPLOAD_TEX0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mga_g400_emit_state
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|unsigned
name|int
name|dirty
init|=
name|sarea_priv
operator|->
name|dirty
decl_stmt|;
name|int
name|multitex
init|=
name|sarea_priv
operator|->
name|warp_pipe
operator|&
name|MGA_T2
decl_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|warp_pipe
operator|!=
name|dev_priv
operator|->
name|warp_pipe
condition|)
block|{
name|mga_g400_emit_pipe
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|warp_pipe
operator|=
name|sarea_priv
operator|->
name|warp_pipe
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_CONTEXT
condition|)
block|{
name|mga_g400_emit_context
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|MGA_UPLOAD_CONTEXT
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_TEX0
condition|)
block|{
name|mga_g400_emit_tex0
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|MGA_UPLOAD_TEX0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|dirty
operator|&
name|MGA_UPLOAD_TEX1
operator|)
operator|&&
name|multitex
condition|)
block|{
name|mga_g400_emit_tex1
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|MGA_UPLOAD_TEX1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ================================================================  * SAREA state verification  */
end_comment

begin_comment
comment|/* Disallow all write destinations except the front and backbuffer.  */
end_comment

begin_function
specifier|static
name|int
name|mga_verify_context
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|dstorg
operator|!=
name|dev_priv
operator|->
name|front_offset
operator|&&
name|ctx
operator|->
name|dstorg
operator|!=
name|dev_priv
operator|->
name|back_offset
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"*** bad DSTORG: %x (front %x, back %x)\n\n"
argument_list|,
name|ctx
operator|->
name|dstorg
argument_list|,
name|dev_priv
operator|->
name|front_offset
argument_list|,
name|dev_priv
operator|->
name|back_offset
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|dstorg
operator|=
literal|0
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Disallow texture reads from PCI space.  */
end_comment

begin_function
specifier|static
name|int
name|mga_verify_tex
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
name|unit
index|]
decl_stmt|;
name|unsigned
name|int
name|org
decl_stmt|;
name|org
operator|=
name|tex
operator|->
name|texorg
operator|&
operator|(
name|MGA_TEXORGMAP_MASK
operator||
name|MGA_TEXORGACC_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|org
operator|==
operator|(
name|MGA_TEXORGMAP_SYSMEM
operator||
name|MGA_TEXORGACC_PCI
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"*** bad TEXORG: 0x%x, unit %d\n"
argument_list|,
name|tex
operator|->
name|texorg
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|tex
operator|->
name|texorg
operator|=
literal|0
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_verify_state
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|unsigned
name|int
name|dirty
init|=
name|sarea_priv
operator|->
name|dirty
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|MGA_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|MGA_NR_SAREA_CLIPRECTS
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_CONTEXT
condition|)
name|ret
operator||=
name|mga_verify_context
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_TEX0
condition|)
name|ret
operator||=
name|mga_verify_tex
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|chipset
operator|==
name|MGA_CARD_TYPE_G400
condition|)
block|{
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_TEX1
condition|)
name|ret
operator||=
name|mga_verify_tex
argument_list|(
name|dev_priv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_PIPE
condition|)
name|ret
operator||=
operator|(
name|sarea_priv
operator|->
name|warp_pipe
operator|>
name|MGA_MAX_G400_PIPES
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dirty
operator|&
name|MGA_UPLOAD_PIPE
condition|)
name|ret
operator||=
operator|(
name|sarea_priv
operator|->
name|warp_pipe
operator|>
name|MGA_MAX_G200_PIPES
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_verify_iload
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|,
name|unsigned
name|int
name|dstorg
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|)
block|{
if|if
condition|(
name|dstorg
operator|<
name|dev_priv
operator|->
name|texture_offset
operator|||
name|dstorg
operator|+
name|length
operator|>
operator|(
name|dev_priv
operator|->
name|texture_offset
operator|+
name|dev_priv
operator|->
name|texture_size
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"*** bad iload DSTORG: 0x%x\n"
argument_list|,
name|dstorg
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
if|if
condition|(
name|length
operator|&
name|MGA_ILOAD_MASK
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"*** bad iload length: 0x%x\n"
argument_list|,
name|length
operator|&
name|MGA_ILOAD_MASK
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_verify_blit
parameter_list|(
name|drm_mga_private_t
modifier|*
name|dev_priv
parameter_list|,
name|unsigned
name|int
name|srcorg
parameter_list|,
name|unsigned
name|int
name|dstorg
parameter_list|)
block|{
if|if
condition|(
operator|(
name|srcorg
operator|&
literal|0x3
operator|)
operator|==
operator|(
name|MGA_SRCACC_PCI
operator||
name|MGA_SRCMAP_SYSMEM
operator|)
operator|||
operator|(
name|dstorg
operator|&
literal|0x3
operator|)
operator|==
operator|(
name|MGA_SRCACC_PCI
operator||
name|MGA_SRCMAP_SYSMEM
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"*** bad blit: src=0x%x dst=0x%x\n"
argument_list|,
name|srcorg
argument_list|,
name|dstorg
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ================================================================  *  */
end_comment

begin_function
specifier|static
name|void
name|mga_dma_dispatch_clear
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_mga_clear_t
modifier|*
name|clear
parameter_list|)
block|{
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|drm_clip_rect_t
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007100
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007000
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|drm_clip_rect_t
modifier|*
name|box
init|=
operator|&
name|pbox
index|[
name|i
index|]
decl_stmt|;
name|u32
name|height
init|=
name|box
operator|->
name|y2
operator|-
name|box
operator|->
name|y1
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"   from=%d,%d to=%d,%d\n"
argument_list|,
name|box
operator|->
name|x1
argument_list|,
name|box
operator|->
name|y1
argument_list|,
name|box
operator|->
name|x2
argument_list|,
name|box
operator|->
name|y2
argument_list|)
expr_stmt|;
if|if
condition|(
name|clear
operator|->
name|flags
operator|&
name|MGA_FRONT
condition|)
block|{
name|BEGIN_DMA
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_PLNWT
argument_list|,
name|clear
operator|->
name|color_mask
argument_list|,
name|MGA_YDSTLEN
argument_list|,
operator|(
name|box
operator|->
name|y1
operator|<<
literal|16
operator|)
operator||
name|height
argument_list|,
name|MGA_FXBNDRY
argument_list|,
operator|(
name|box
operator|->
name|x2
operator|<<
literal|16
operator|)
operator||
name|box
operator|->
name|x1
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_FCOL
argument_list|,
name|clear
operator|->
name|clear_color
argument_list|,
name|MGA_DSTORG
argument_list|,
name|dev_priv
operator|->
name|front_offset
argument_list|,
name|MGA_DWGCTL
operator|+
name|MGA_EXEC
argument_list|,
name|dev_priv
operator|->
name|clear_cmd
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|clear
operator|->
name|flags
operator|&
name|MGA_BACK
condition|)
block|{
name|BEGIN_DMA
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_PLNWT
argument_list|,
name|clear
operator|->
name|color_mask
argument_list|,
name|MGA_YDSTLEN
argument_list|,
operator|(
name|box
operator|->
name|y1
operator|<<
literal|16
operator|)
operator||
name|height
argument_list|,
name|MGA_FXBNDRY
argument_list|,
operator|(
name|box
operator|->
name|x2
operator|<<
literal|16
operator|)
operator||
name|box
operator|->
name|x1
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_FCOL
argument_list|,
name|clear
operator|->
name|clear_color
argument_list|,
name|MGA_DSTORG
argument_list|,
name|dev_priv
operator|->
name|back_offset
argument_list|,
name|MGA_DWGCTL
operator|+
name|MGA_EXEC
argument_list|,
name|dev_priv
operator|->
name|clear_cmd
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|clear
operator|->
name|flags
operator|&
name|MGA_DEPTH
condition|)
block|{
name|BEGIN_DMA
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_PLNWT
argument_list|,
name|clear
operator|->
name|depth_mask
argument_list|,
name|MGA_YDSTLEN
argument_list|,
operator|(
name|box
operator|->
name|y1
operator|<<
literal|16
operator|)
operator||
name|height
argument_list|,
name|MGA_FXBNDRY
argument_list|,
operator|(
name|box
operator|->
name|x2
operator|<<
literal|16
operator|)
operator||
name|box
operator|->
name|x1
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_FCOL
argument_list|,
name|clear
operator|->
name|clear_depth
argument_list|,
name|MGA_DSTORG
argument_list|,
name|dev_priv
operator|->
name|depth_offset
argument_list|,
name|MGA_DWGCTL
operator|+
name|MGA_EXEC
argument_list|,
name|dev_priv
operator|->
name|clear_cmd
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
block|}
name|BEGIN_DMA
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Force reset of DWGCTL */
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_PLNWT
argument_list|,
name|ctx
operator|->
name|plnwt
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|ctx
operator|->
name|dwgctl
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
name|FLUSH_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mga_dma_dispatch_swap
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|)
block|{
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|drm_clip_rect_t
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|last_frame
operator|.
name|head
operator|=
name|dev_priv
operator|->
name|prim
operator|.
name|tail
expr_stmt|;
name|sarea_priv
operator|->
name|last_frame
operator|.
name|wrap
operator|=
name|dev_priv
operator|->
name|prim
operator|.
name|last_wrap
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|4
operator|+
name|nbox
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007100
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DSTORG
argument_list|,
name|dev_priv
operator|->
name|front_offset
argument_list|,
name|MGA_MACCESS
argument_list|,
name|dev_priv
operator|->
name|maccess
argument_list|,
name|MGA_SRCORG
argument_list|,
name|dev_priv
operator|->
name|back_offset
argument_list|,
name|MGA_AR5
argument_list|,
name|dev_priv
operator|->
name|front_pitch
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_PLNWT
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|MGA_DWGCTL_COPY
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|drm_clip_rect_t
modifier|*
name|box
init|=
operator|&
name|pbox
index|[
name|i
index|]
decl_stmt|;
name|u32
name|height
init|=
name|box
operator|->
name|y2
operator|-
name|box
operator|->
name|y1
decl_stmt|;
name|u32
name|start
init|=
name|box
operator|->
name|y1
operator|*
name|dev_priv
operator|->
name|front_pitch
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"   from=%d,%d to=%d,%d\n"
argument_list|,
name|box
operator|->
name|x1
argument_list|,
name|box
operator|->
name|y1
argument_list|,
name|box
operator|->
name|x2
argument_list|,
name|box
operator|->
name|y2
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_AR0
argument_list|,
name|start
operator|+
name|box
operator|->
name|x2
operator|-
literal|1
argument_list|,
name|MGA_AR3
argument_list|,
name|start
operator|+
name|box
operator|->
name|x1
argument_list|,
name|MGA_FXBNDRY
argument_list|,
operator|(
operator|(
name|box
operator|->
name|x2
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
name|box
operator|->
name|x1
argument_list|,
name|MGA_YDSTLEN
operator|+
name|MGA_EXEC
argument_list|,
operator|(
name|box
operator|->
name|y1
operator|<<
literal|16
operator|)
operator||
name|height
argument_list|)
expr_stmt|;
block|}
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_PLNWT
argument_list|,
name|ctx
operator|->
name|plnwt
argument_list|,
name|MGA_SRCORG
argument_list|,
name|dev_priv
operator|->
name|front_offset
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|ctx
operator|->
name|dwgctl
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
name|FLUSH_DMA
argument_list|()
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s... done.\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mga_dma_dispatch_vertex
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_t
modifier|*
name|buf
parameter_list|)
block|{
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|u32
name|address
init|=
operator|(
name|u32
operator|)
name|buf
operator|->
name|bus_address
decl_stmt|;
name|u32
name|length
init|=
operator|(
name|u32
operator|)
name|buf
operator|->
name|used
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"vertex: buf=%d used=%d\n"
argument_list|,
name|buf
operator|->
name|idx
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|used
condition|)
block|{
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
name|MGA_EMIT_STATE
argument_list|(
name|dev_priv
argument_list|,
name|sarea_priv
operator|->
name|dirty
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
block|{
name|mga_emit_clip_rect
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|sarea_priv
operator|->
name|boxes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|BEGIN_DMA
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_SECADDRESS
argument_list|,
operator|(
name|address
operator||
name|MGA_DMA_VERTEX
operator|)
argument_list|,
name|MGA_SECEND
argument_list|,
operator|(
operator|(
name|address
operator|+
name|length
operator|)
operator||
name|MGA_PAGPXFER
operator|)
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
do|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|AGE_BUFFER
argument_list|(
name|buf_priv
argument_list|)
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
name|mga_freelist_put
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|FLUSH_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mga_dma_dispatch_indices
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_t
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|start
parameter_list|,
name|unsigned
name|int
name|end
parameter_list|)
block|{
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|u32
name|address
init|=
operator|(
name|u32
operator|)
name|buf
operator|->
name|bus_address
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"indices: buf=%d start=%d end=%d\n"
argument_list|,
name|buf
operator|->
name|idx
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|end
condition|)
block|{
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
name|MGA_EMIT_STATE
argument_list|(
name|dev_priv
argument_list|,
name|sarea_priv
operator|->
name|dirty
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
block|{
name|mga_emit_clip_rect
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|sarea_priv
operator|->
name|boxes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|BEGIN_DMA
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_SETUPADDRESS
argument_list|,
name|address
operator|+
name|start
argument_list|,
name|MGA_SETUPEND
argument_list|,
operator|(
operator|(
name|address
operator|+
name|end
operator|)
operator||
name|MGA_PAGPXFER
operator|)
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
do|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|AGE_BUFFER
argument_list|(
name|buf_priv
argument_list|)
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
name|mga_freelist_put
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|FLUSH_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This copies a 64 byte aligned agp region to the frambuffer with a  * standard blit, the ioctl needs to do checking.  */
end_comment

begin_function
specifier|static
name|void
name|mga_dma_dispatch_iload
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_t
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|dstorg
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|)
block|{
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|u32
name|srcorg
init|=
name|buf
operator|->
name|bus_address
operator||
name|MGA_SRCACC_AGP
operator||
name|MGA_SRCMAP_SYSMEM
decl_stmt|;
name|u32
name|y2
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"buf=%d used=%d\n"
argument_list|,
name|buf
operator|->
name|idx
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
name|y2
operator|=
name|length
operator|/
literal|64
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007100
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DSTORG
argument_list|,
name|dstorg
argument_list|,
name|MGA_MACCESS
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_SRCORG
argument_list|,
name|srcorg
argument_list|,
name|MGA_AR5
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_PITCH
argument_list|,
literal|64
argument_list|,
name|MGA_PLNWT
argument_list|,
literal|0xffffffff
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|MGA_DWGCTL_COPY
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_AR0
argument_list|,
literal|63
argument_list|,
name|MGA_AR3
argument_list|,
literal|0
argument_list|,
name|MGA_FXBNDRY
argument_list|,
operator|(
literal|63
operator|<<
literal|16
operator|)
operator||
literal|0
argument_list|,
name|MGA_YDSTLEN
operator|+
name|MGA_EXEC
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_PLNWT
argument_list|,
name|ctx
operator|->
name|plnwt
argument_list|,
name|MGA_SRCORG
argument_list|,
name|dev_priv
operator|->
name|front_offset
argument_list|,
name|MGA_PITCH
argument_list|,
name|dev_priv
operator|->
name|front_pitch
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007000
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
name|AGE_BUFFER
argument_list|(
name|buf_priv
argument_list|)
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
name|mga_freelist_put
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|FLUSH_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mga_dma_dispatch_blit
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_mga_blit_t
modifier|*
name|blit
parameter_list|)
block|{
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|drm_clip_rect_t
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|u32
name|scandir
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|DMA_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_DMA
argument_list|(
literal|4
operator|+
name|nbox
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007100
argument_list|,
name|MGA_DWGSYNC
argument_list|,
literal|0x00007000
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_DWGCTL
argument_list|,
name|MGA_DWGCTL_COPY
argument_list|,
name|MGA_PLNWT
argument_list|,
name|blit
operator|->
name|planemask
argument_list|,
name|MGA_SRCORG
argument_list|,
name|blit
operator|->
name|srcorg
argument_list|,
name|MGA_DSTORG
argument_list|,
name|blit
operator|->
name|dstorg
argument_list|)
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_SGN
argument_list|,
name|scandir
argument_list|,
name|MGA_MACCESS
argument_list|,
name|dev_priv
operator|->
name|maccess
argument_list|,
name|MGA_AR5
argument_list|,
name|blit
operator|->
name|ydir
operator|*
name|blit
operator|->
name|src_pitch
argument_list|,
name|MGA_PITCH
argument_list|,
name|blit
operator|->
name|dst_pitch
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|int
name|srcx
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x1
operator|+
name|blit
operator|->
name|delta_sx
decl_stmt|;
name|int
name|srcy
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y1
operator|+
name|blit
operator|->
name|delta_sy
decl_stmt|;
name|int
name|dstx
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x1
operator|+
name|blit
operator|->
name|delta_dx
decl_stmt|;
name|int
name|dsty
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y1
operator|+
name|blit
operator|->
name|delta_dy
decl_stmt|;
name|int
name|h
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y2
operator|-
name|pbox
index|[
name|i
index|]
operator|.
name|y1
decl_stmt|;
name|int
name|w
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x2
operator|-
name|pbox
index|[
name|i
index|]
operator|.
name|x1
operator|-
literal|1
decl_stmt|;
name|int
name|start
decl_stmt|;
if|if
condition|(
name|blit
operator|->
name|ydir
operator|==
operator|-
literal|1
condition|)
block|{
name|srcy
operator|=
name|blit
operator|->
name|height
operator|-
name|srcy
operator|-
literal|1
expr_stmt|;
block|}
name|start
operator|=
name|srcy
operator|*
name|blit
operator|->
name|src_pitch
operator|+
name|srcx
expr_stmt|;
name|DMA_BLOCK
argument_list|(
name|MGA_AR0
argument_list|,
name|start
operator|+
name|w
argument_list|,
name|MGA_AR3
argument_list|,
name|start
argument_list|,
name|MGA_FXBNDRY
argument_list|,
operator|(
operator|(
name|dstx
operator|+
name|w
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|dstx
operator|&
literal|0xffff
operator|)
argument_list|,
name|MGA_YDSTLEN
operator|+
name|MGA_EXEC
argument_list|,
operator|(
name|dsty
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
block|}
comment|/* Do something to flush AGP? 	 */
comment|/* Force reset of DWGCTL */
name|DMA_BLOCK
argument_list|(
name|MGA_DMAPAD
argument_list|,
literal|0x00000000
argument_list|,
name|MGA_PLNWT
argument_list|,
name|ctx
operator|->
name|plnwt
argument_list|,
name|MGA_PITCH
argument_list|,
name|dev_priv
operator|->
name|front_pitch
argument_list|,
name|MGA_DWGCTL
argument_list|,
name|ctx
operator|->
name|dwgctl
argument_list|)
expr_stmt|;
name|ADVANCE_DMA
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ================================================================  *  */
end_comment

begin_function
specifier|static
name|int
name|mga_dma_clear
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_clear_t
name|clear
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|clear
argument_list|,
operator|(
name|drm_mga_clear_t
name|__user
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|clear
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|MGA_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|MGA_NR_SAREA_CLIPRECTS
expr_stmt|;
name|WRAP_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mga_dma_dispatch_clear
argument_list|(
name|dev
argument_list|,
operator|&
name|clear
argument_list|)
expr_stmt|;
comment|/* Make sure we restore the 3D state next time. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
name|MGA_UPLOAD_CONTEXT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_dma_swap
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|MGA_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|MGA_NR_SAREA_CLIPRECTS
expr_stmt|;
name|WRAP_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mga_dma_dispatch_swap
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Make sure we restore the 3D state next time. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
name|MGA_UPLOAD_CONTEXT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_dma_vertex
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|drm_mga_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_mga_vertex_t
name|vertex
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|vertex
argument_list|,
operator|(
name|drm_mga_vertex_t
name|__user
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|vertex
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vertex
operator|.
name|idx
operator|<
literal|0
operator|||
name|vertex
operator|.
name|idx
operator|>
name|dma
operator|->
name|buf_count
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|vertex
operator|.
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
name|buf
operator|->
name|used
operator|=
name|vertex
operator|.
name|used
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|vertex
operator|.
name|discard
expr_stmt|;
if|if
condition|(
operator|!
name|mga_verify_state
argument_list|(
name|dev_priv
argument_list|)
condition|)
block|{
if|if
condition|(
name|vertex
operator|.
name|discard
condition|)
block|{
if|if
condition|(
name|buf_priv
operator|->
name|dispatched
operator|==
literal|1
condition|)
name|AGE_BUFFER
argument_list|(
name|buf_priv
argument_list|)
expr_stmt|;
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
name|mga_freelist_put
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|WRAP_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mga_dma_dispatch_vertex
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_dma_indices
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|drm_mga_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_mga_indices_t
name|indices
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|indices
argument_list|,
operator|(
name|drm_mga_indices_t
name|__user
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|indices
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|indices
operator|.
name|idx
operator|<
literal|0
operator|||
name|indices
operator|.
name|idx
operator|>
name|dma
operator|->
name|buf_count
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|indices
operator|.
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|indices
operator|.
name|discard
expr_stmt|;
if|if
condition|(
operator|!
name|mga_verify_state
argument_list|(
name|dev_priv
argument_list|)
condition|)
block|{
if|if
condition|(
name|indices
operator|.
name|discard
condition|)
block|{
if|if
condition|(
name|buf_priv
operator|->
name|dispatched
operator|==
literal|1
condition|)
name|AGE_BUFFER
argument_list|(
name|buf_priv
argument_list|)
expr_stmt|;
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
name|mga_freelist_put
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|WRAP_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mga_dma_dispatch_indices
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|indices
operator|.
name|start
argument_list|,
name|indices
operator|.
name|end
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_dma_iload
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|drm_mga_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_mga_iload_t
name|iload
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|iload
argument_list|,
operator|(
name|drm_mga_iload_t
name|__user
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|iload
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (mga_do_wait_for_idle(dev_priv)< 0) { 		if (MGA_DMA_DEBUG) 			DRM_INFO("%s: -EBUSY\n", __FUNCTION__); 		return DRM_ERR(EBUSY); 	}
endif|#
directive|endif
if|if
condition|(
name|iload
operator|.
name|idx
operator|<
literal|0
operator|||
name|iload
operator|.
name|idx
operator|>
name|dma
operator|->
name|buf_count
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|iload
operator|.
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|mga_verify_iload
argument_list|(
name|dev_priv
argument_list|,
name|iload
operator|.
name|dstorg
argument_list|,
name|iload
operator|.
name|length
argument_list|)
condition|)
block|{
name|mga_freelist_put
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|WRAP_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mga_dma_dispatch_iload
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|iload
operator|.
name|dstorg
argument_list|,
name|iload
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/* Make sure we restore the 3D state next time. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
name|MGA_UPLOAD_CONTEXT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_dma_blit
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_mga_blit_t
name|blit
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|blit
argument_list|,
operator|(
name|drm_mga_blit_t
name|__user
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|blit
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|MGA_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|MGA_NR_SAREA_CLIPRECTS
expr_stmt|;
if|if
condition|(
name|mga_verify_blit
argument_list|(
name|dev_priv
argument_list|,
name|blit
operator|.
name|srcorg
argument_list|,
name|blit
operator|.
name|dstorg
argument_list|)
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|WRAP_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|mga_dma_dispatch_blit
argument_list|(
name|dev
argument_list|,
operator|&
name|blit
argument_list|)
expr_stmt|;
comment|/* Make sure we restore the 3D state next time. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
name|MGA_UPLOAD_CONTEXT
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mga_getparam
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_mga_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_mga_getparam_t
name|param
decl_stmt|;
name|int
name|value
decl_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"%s called with no initialization\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|param
argument_list|,
operator|(
name|drm_mga_getparam_t
name|__user
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"pid=%d\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|param
operator|.
name|param
condition|)
block|{
case|case
name|MGA_PARAM_IRQ_NR
case|:
name|value
operator|=
name|dev
operator|->
name|irq
expr_stmt|;
break|break;
default|default:
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
name|param
operator|.
name|value
argument_list|,
operator|&
name|value
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"copy_to_user\n"
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EFAULT
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|drm_ioctl_desc_t
name|mga_ioctls
index|[]
init|=
block|{
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_INIT
argument_list|)
index|]
operator|=
block|{
name|mga_dma_init
block|,
literal|1
block|,
literal|1
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_FLUSH
argument_list|)
index|]
operator|=
block|{
name|mga_dma_flush
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_RESET
argument_list|)
index|]
operator|=
block|{
name|mga_dma_reset
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_SWAP
argument_list|)
index|]
operator|=
block|{
name|mga_dma_swap
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_CLEAR
argument_list|)
index|]
operator|=
block|{
name|mga_dma_clear
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_VERTEX
argument_list|)
index|]
operator|=
block|{
name|mga_dma_vertex
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_INDICES
argument_list|)
index|]
operator|=
block|{
name|mga_dma_indices
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_ILOAD
argument_list|)
index|]
operator|=
block|{
name|mga_dma_iload
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_BLIT
argument_list|)
index|]
operator|=
block|{
name|mga_dma_blit
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|DRM_IOCTL_NR
argument_list|(
name|DRM_MGA_GETPARAM
argument_list|)
index|]
operator|=
block|{
name|mga_getparam
block|,
literal|1
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mga_max_ioctl
init|=
name|DRM_ARRAY_SIZE
argument_list|(
name|mga_ioctls
argument_list|)
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* r128_cce.c -- ATI Rage 128 driver -*- linux-c -*-  * Created: Wed Apr  5 19:24:19 2000 by kevin@precisioninsight.com  *  * Copyright 2000 Precision Insight, Inc., Cedar Park, Texas.  * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Gareth Hughes<gareth@valinux.com>  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"dev/drm/r128.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/r128_drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/r128_drv.h"
end_include

begin_define
define|#
directive|define
name|R128_FIFO_DEBUG
value|0
end_define

begin_comment
comment|/* CCE microcode (from ATI) */
end_comment

begin_decl_stmt
specifier|static
name|u32
name|r128_cce_microcode
index|[]
init|=
block|{
literal|0
block|,
literal|276838400
block|,
literal|0
block|,
literal|268449792
block|,
literal|2
block|,
literal|142
block|,
literal|2
block|,
literal|145
block|,
literal|0
block|,
literal|1076765731
block|,
literal|0
block|,
literal|1617039951
block|,
literal|0
block|,
literal|774592877
block|,
literal|0
block|,
literal|1987540286
block|,
literal|0
block|,
literal|2307490946U
block|,
literal|0
block|,
literal|599558925
block|,
literal|0
block|,
literal|589505315
block|,
literal|0
block|,
literal|596487092
block|,
literal|0
block|,
literal|589505315
block|,
literal|1
block|,
literal|11544576
block|,
literal|1
block|,
literal|206848
block|,
literal|1
block|,
literal|311296
block|,
literal|1
block|,
literal|198656
block|,
literal|2
block|,
literal|912273422
block|,
literal|11
block|,
literal|262144
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|33559837
block|,
literal|1
block|,
literal|7438
block|,
literal|1
block|,
literal|14809
block|,
literal|1
block|,
literal|6615
block|,
literal|12
block|,
literal|28
block|,
literal|1
block|,
literal|6614
block|,
literal|12
block|,
literal|28
block|,
literal|2
block|,
literal|23
block|,
literal|11
block|,
literal|18874368
block|,
literal|0
block|,
literal|16790922
block|,
literal|1
block|,
literal|409600
block|,
literal|9
block|,
literal|30
block|,
literal|1
block|,
literal|147854772
block|,
literal|16
block|,
literal|420483072
block|,
literal|3
block|,
literal|8192
block|,
literal|0
block|,
literal|10240
block|,
literal|1
block|,
literal|198656
block|,
literal|1
block|,
literal|15630
block|,
literal|1
block|,
literal|51200
block|,
literal|10
block|,
literal|34858
block|,
literal|9
block|,
literal|42
block|,
literal|1
block|,
literal|33559823
block|,
literal|2
block|,
literal|10276
block|,
literal|1
block|,
literal|15717
block|,
literal|1
block|,
literal|15718
block|,
literal|2
block|,
literal|43
block|,
literal|1
block|,
literal|15936948
block|,
literal|1
block|,
literal|570480831
block|,
literal|1
block|,
literal|14715071
block|,
literal|12
block|,
literal|322123831
block|,
literal|1
block|,
literal|33953125
block|,
literal|12
block|,
literal|55
block|,
literal|1
block|,
literal|33559908
block|,
literal|1
block|,
literal|15718
block|,
literal|2
block|,
literal|46
block|,
literal|4
block|,
literal|2099258
block|,
literal|1
block|,
literal|526336
block|,
literal|1
block|,
literal|442623
block|,
literal|4
block|,
literal|4194365
block|,
literal|1
block|,
literal|509952
block|,
literal|1
block|,
literal|459007
block|,
literal|3
block|,
literal|0
block|,
literal|12
block|,
literal|92
block|,
literal|2
block|,
literal|46
block|,
literal|12
block|,
literal|176
block|,
literal|1
block|,
literal|15734
block|,
literal|1
block|,
literal|206848
block|,
literal|1
block|,
literal|18432
block|,
literal|1
block|,
literal|133120
block|,
literal|1
block|,
literal|100670734
block|,
literal|1
block|,
literal|149504
block|,
literal|1
block|,
literal|165888
block|,
literal|1
block|,
literal|15975928
block|,
literal|1
block|,
literal|1048576
block|,
literal|6
block|,
literal|3145806
block|,
literal|1
block|,
literal|15715
block|,
literal|16
block|,
literal|2150645232U
block|,
literal|2
block|,
literal|268449859
block|,
literal|2
block|,
literal|10307
block|,
literal|12
block|,
literal|176
block|,
literal|1
block|,
literal|15734
block|,
literal|1
block|,
literal|15735
block|,
literal|1
block|,
literal|15630
block|,
literal|1
block|,
literal|15631
block|,
literal|1
block|,
literal|5253120
block|,
literal|6
block|,
literal|3145810
block|,
literal|16
block|,
literal|2150645232U
block|,
literal|1
block|,
literal|15864
block|,
literal|2
block|,
literal|82
block|,
literal|1
block|,
literal|343310
block|,
literal|1
block|,
literal|1064207
block|,
literal|2
block|,
literal|3145813
block|,
literal|1
block|,
literal|15728
block|,
literal|1
block|,
literal|7817
block|,
literal|1
block|,
literal|15729
block|,
literal|3
block|,
literal|15730
block|,
literal|12
block|,
literal|92
block|,
literal|2
block|,
literal|98
block|,
literal|1
block|,
literal|16168
block|,
literal|1
block|,
literal|16167
block|,
literal|1
block|,
literal|16002
block|,
literal|1
block|,
literal|16008
block|,
literal|1
block|,
literal|15974
block|,
literal|1
block|,
literal|15975
block|,
literal|1
block|,
literal|15990
block|,
literal|1
block|,
literal|15976
block|,
literal|1
block|,
literal|15977
block|,
literal|1
block|,
literal|15980
block|,
literal|0
block|,
literal|15981
block|,
literal|1
block|,
literal|10240
block|,
literal|1
block|,
literal|5253120
block|,
literal|1
block|,
literal|15720
block|,
literal|1
block|,
literal|198656
block|,
literal|6
block|,
literal|110
block|,
literal|1
block|,
literal|180224
block|,
literal|1
block|,
literal|103824738
block|,
literal|2
block|,
literal|112
block|,
literal|2
block|,
literal|3145839
block|,
literal|0
block|,
literal|536885440
block|,
literal|1
block|,
literal|114880
block|,
literal|14
block|,
literal|125
block|,
literal|12
block|,
literal|206975
block|,
literal|1
block|,
literal|33559995
block|,
literal|12
block|,
literal|198784
block|,
literal|0
block|,
literal|33570236
block|,
literal|1
block|,
literal|15803
block|,
literal|0
block|,
literal|15804
block|,
literal|3
block|,
literal|294912
block|,
literal|1
block|,
literal|294912
block|,
literal|3
block|,
literal|442370
block|,
literal|1
block|,
literal|11544576
block|,
literal|0
block|,
literal|811612160
block|,
literal|1
block|,
literal|12593152
block|,
literal|1
block|,
literal|11536384
block|,
literal|1
block|,
literal|14024704
block|,
literal|7
block|,
literal|310382726
block|,
literal|0
block|,
literal|10240
block|,
literal|1
block|,
literal|14796
block|,
literal|1
block|,
literal|14797
block|,
literal|1
block|,
literal|14793
block|,
literal|1
block|,
literal|14794
block|,
literal|0
block|,
literal|14795
block|,
literal|1
block|,
literal|268679168
block|,
literal|1
block|,
literal|9437184
block|,
literal|1
block|,
literal|268449792
block|,
literal|1
block|,
literal|198656
block|,
literal|1
block|,
literal|9452827
block|,
literal|1
block|,
literal|1075854602
block|,
literal|1
block|,
literal|1075854603
block|,
literal|1
block|,
literal|557056
block|,
literal|1
block|,
literal|114880
block|,
literal|14
block|,
literal|159
block|,
literal|12
block|,
literal|198784
block|,
literal|1
block|,
literal|1109409213
block|,
literal|12
block|,
literal|198783
block|,
literal|1
block|,
literal|1107312059
block|,
literal|12
block|,
literal|198784
block|,
literal|1
block|,
literal|1109409212
block|,
literal|2
block|,
literal|162
block|,
literal|1
block|,
literal|1075854781
block|,
literal|1
block|,
literal|1073757627
block|,
literal|1
block|,
literal|1075854780
block|,
literal|1
block|,
literal|540672
block|,
literal|1
block|,
literal|10485760
block|,
literal|6
block|,
literal|3145894
block|,
literal|16
block|,
literal|274741248
block|,
literal|9
block|,
literal|168
block|,
literal|3
block|,
literal|4194304
block|,
literal|3
block|,
literal|4209949
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|256
block|,
literal|14
block|,
literal|174
block|,
literal|1
block|,
literal|114857
block|,
literal|1
block|,
literal|33560007
block|,
literal|12
block|,
literal|176
block|,
literal|0
block|,
literal|10240
block|,
literal|1
block|,
literal|114858
block|,
literal|1
block|,
literal|33560018
block|,
literal|1
block|,
literal|114857
block|,
literal|3
block|,
literal|33560007
block|,
literal|1
block|,
literal|16008
block|,
literal|1
block|,
literal|114874
block|,
literal|1
block|,
literal|33560360
block|,
literal|1
block|,
literal|114875
block|,
literal|1
block|,
literal|33560154
block|,
literal|0
block|,
literal|15963
block|,
literal|0
block|,
literal|256
block|,
literal|0
block|,
literal|4096
block|,
literal|1
block|,
literal|409611
block|,
literal|9
block|,
literal|188
block|,
literal|0
block|,
literal|10240
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|R128_READ_PLL
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|R128_WRITE8
argument_list|(
name|R128_CLOCK_CNTL_INDEX
argument_list|,
name|addr
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
return|return
name|R128_READ
argument_list|(
name|R128_CLOCK_CNTL_DATA
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|R128_FIFO_DEBUG
end_if

begin_function
specifier|static
name|void
name|r128_status
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|printk
argument_list|(
literal|"GUI_STAT           = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|R128_READ
argument_list|(
name|R128_GUI_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"PM4_STAT           = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|R128_READ
argument_list|(
name|R128_PM4_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"PM4_BUFFER_DL_WPTR = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|R128_READ
argument_list|(
name|R128_PM4_BUFFER_DL_WPTR
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"PM4_BUFFER_DL_RPTR = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|R128_READ
argument_list|(
name|R128_PM4_BUFFER_DL_RPTR
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"PM4_MICRO_CNTL     = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|R128_READ
argument_list|(
name|R128_PM4_MICRO_CNTL
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"PM4_BUFFER_CNTL    = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|R128_READ
argument_list|(
name|R128_PM4_BUFFER_CNTL
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ================================================================  * Engine, FIFO control  */
end_comment

begin_function
specifier|static
name|int
name|r128_do_pixcache_flush
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|tmp
operator|=
name|R128_READ
argument_list|(
name|R128_PC_NGUI_CTLSTAT
argument_list|)
operator||
name|R128_PC_FLUSH_ALL
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PC_NGUI_CTLSTAT
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|R128_READ
argument_list|(
name|R128_PC_NGUI_CTLSTAT
argument_list|)
operator|&
name|R128_PC_BUSY
operator|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|R128_FIFO_DEBUG
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|DRM_ERR
argument_list|(
name|EBUSY
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_do_wait_for_fifo
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|entries
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|int
name|slots
init|=
name|R128_READ
argument_list|(
name|R128_GUI_STAT
argument_list|)
operator|&
name|R128_GUI_FIFOCNT_MASK
decl_stmt|;
if|if
condition|(
name|slots
operator|>=
name|entries
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|R128_FIFO_DEBUG
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|DRM_ERR
argument_list|(
name|EBUSY
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_do_wait_for_idle
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|ret
operator|=
name|r128_do_wait_for_fifo
argument_list|(
name|dev_priv
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|R128_READ
argument_list|(
name|R128_GUI_STAT
argument_list|)
operator|&
name|R128_GUI_ACTIVE
operator|)
condition|)
block|{
name|r128_do_pixcache_flush
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|R128_FIFO_DEBUG
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|DRM_ERR
argument_list|(
name|EBUSY
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ================================================================  * CCE control, initialization  */
end_comment

begin_comment
comment|/* Load the microcode for the CCE */
end_comment

begin_function
specifier|static
name|void
name|r128_cce_load_microcode
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|r128_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_MICROCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|R128_WRITE
argument_list|(
name|R128_PM4_MICROCODE_DATAH
argument_list|,
name|r128_cce_microcode
index|[
name|i
operator|*
literal|2
index|]
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_MICROCODE_DATAL
argument_list|,
name|r128_cce_microcode
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Flush any pending commands to the CCE.  This should only be used just  * prior to a wait for idle, as it informs the engine that the command  * stream is ending.  */
end_comment

begin_function
specifier|static
name|void
name|r128_do_cce_flush
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|tmp
operator|=
name|R128_READ
argument_list|(
name|R128_PM4_BUFFER_DL_WPTR
argument_list|)
operator||
name|R128_PM4_BUFFER_DL_DONE
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_DL_WPTR
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Wait for the CCE to go idle.  */
end_comment

begin_function
name|int
name|r128_do_cce_idle
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|GET_RING_HEAD
argument_list|(
name|dev_priv
argument_list|)
operator|==
name|dev_priv
operator|->
name|ring
operator|.
name|tail
condition|)
block|{
name|int
name|pm4stat
init|=
name|R128_READ
argument_list|(
name|R128_PM4_STAT
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|pm4stat
operator|&
name|R128_PM4_FIFOCNT_MASK
operator|)
operator|>=
name|dev_priv
operator|->
name|cce_fifo_size
operator|)
operator|&&
operator|!
operator|(
name|pm4stat
operator|&
operator|(
name|R128_PM4_BUSY
operator||
name|R128_PM4_GUI_ACTIVE
operator|)
operator|)
condition|)
block|{
return|return
name|r128_do_pixcache_flush
argument_list|(
name|dev_priv
argument_list|)
return|;
block|}
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|R128_FIFO_DEBUG
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
name|r128_status
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|DRM_ERR
argument_list|(
name|EBUSY
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Start the Concurrent Command Engine.  */
end_comment

begin_function
specifier|static
name|void
name|r128_do_cce_start
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|r128_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_CNTL
argument_list|,
name|dev_priv
operator|->
name|cce_mode
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
operator||
name|R128_PM4_BUFFER_CNTL_NOUPDATE
argument_list|)
expr_stmt|;
name|R128_READ
argument_list|(
name|R128_PM4_BUFFER_ADDR
argument_list|)
expr_stmt|;
comment|/* as per the sample code */
name|R128_WRITE
argument_list|(
name|R128_PM4_MICRO_CNTL
argument_list|,
name|R128_PM4_MICRO_FREERUN
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cce_running
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Reset the Concurrent Command Engine.  This will not flush any pending  * commands, so you must wait for the CCE command stream to complete  * before calling this routine.  */
end_comment

begin_function
specifier|static
name|void
name|r128_do_cce_reset
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_DL_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_DL_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Stop the Concurrent Command Engine.  This will not flush any pending  * commands, so you must flush the command stream and wait for the CCE  * to go idle before calling this routine.  */
end_comment

begin_function
specifier|static
name|void
name|r128_do_cce_stop
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|R128_WRITE
argument_list|(
name|R128_PM4_MICRO_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_CNTL
argument_list|,
name|R128_PM4_NONPM4
operator||
name|R128_PM4_BUFFER_CNTL_NOUPDATE
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cce_running
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Reset the engine.  This will stop the CCE if it is running.  */
end_comment

begin_function
specifier|static
name|int
name|r128_do_engine_reset
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|clock_cntl_index
decl_stmt|,
name|mclk_cntl
decl_stmt|,
name|gen_reset_cntl
decl_stmt|;
name|r128_do_pixcache_flush
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|clock_cntl_index
operator|=
name|R128_READ
argument_list|(
name|R128_CLOCK_CNTL_INDEX
argument_list|)
expr_stmt|;
name|mclk_cntl
operator|=
name|R128_READ_PLL
argument_list|(
name|dev
argument_list|,
name|R128_MCLK_CNTL
argument_list|)
expr_stmt|;
name|R128_WRITE_PLL
argument_list|(
name|R128_MCLK_CNTL
argument_list|,
name|mclk_cntl
operator||
name|R128_FORCE_GCP
operator||
name|R128_FORCE_PIPE3D_CP
argument_list|)
expr_stmt|;
name|gen_reset_cntl
operator|=
name|R128_READ
argument_list|(
name|R128_GEN_RESET_CNTL
argument_list|)
expr_stmt|;
comment|/* Taken from the sample code - do not change */
name|R128_WRITE
argument_list|(
name|R128_GEN_RESET_CNTL
argument_list|,
name|gen_reset_cntl
operator||
name|R128_SOFT_RESET_GUI
argument_list|)
expr_stmt|;
name|R128_READ
argument_list|(
name|R128_GEN_RESET_CNTL
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_GEN_RESET_CNTL
argument_list|,
name|gen_reset_cntl
operator|&
operator|~
name|R128_SOFT_RESET_GUI
argument_list|)
expr_stmt|;
name|R128_READ
argument_list|(
name|R128_GEN_RESET_CNTL
argument_list|)
expr_stmt|;
name|R128_WRITE_PLL
argument_list|(
name|R128_MCLK_CNTL
argument_list|,
name|mclk_cntl
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_CLOCK_CNTL_INDEX
argument_list|,
name|clock_cntl_index
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_GEN_RESET_CNTL
argument_list|,
name|gen_reset_cntl
argument_list|)
expr_stmt|;
comment|/* Reset the CCE ring */
name|r128_do_cce_reset
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* The CCE is no longer running after an engine reset */
name|dev_priv
operator|->
name|cce_running
operator|=
literal|0
expr_stmt|;
comment|/* Reset any pending vertex, indirect buffers */
name|r128_freelist_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_init_ring_buffer
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|ring_start
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* The manual (p. 2) says this address is in "VM space".  This 	 * means it's an offset from the start of AGP space. 	 */
if|#
directive|if
name|__REALLY_HAVE_AGP
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|is_pci
condition|)
name|ring_start
operator|=
name|dev_priv
operator|->
name|cce_ring
operator|->
name|offset
operator|-
name|dev
operator|->
name|agp
operator|->
name|base
expr_stmt|;
else|else
endif|#
directive|endif
name|ring_start
operator|=
name|dev_priv
operator|->
name|cce_ring
operator|->
name|offset
operator|-
name|dev
operator|->
name|sg
operator|->
name|handle
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_OFFSET
argument_list|,
name|ring_start
operator||
name|R128_AGP_OFFSET
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_DL_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_DL_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set watermark control */
name|R128_WRITE
argument_list|(
name|R128_PM4_BUFFER_WM_CNTL
argument_list|,
operator|(
operator|(
name|R128_WATERMARK_L
operator|/
literal|4
operator|)
operator|<<
name|R128_WMA_SHIFT
operator|)
operator||
operator|(
operator|(
name|R128_WATERMARK_M
operator|/
literal|4
operator|)
operator|<<
name|R128_WMB_SHIFT
operator|)
operator||
operator|(
operator|(
name|R128_WATERMARK_N
operator|/
literal|4
operator|)
operator|<<
name|R128_WMC_SHIFT
operator|)
operator||
operator|(
operator|(
name|R128_WATERMARK_K
operator|/
literal|64
operator|)
operator|<<
name|R128_WB_WM_SHIFT
operator|)
argument_list|)
expr_stmt|;
comment|/* Force read.  Why?  Because it's in the examples... */
name|R128_READ
argument_list|(
name|R128_PM4_BUFFER_ADDR
argument_list|)
expr_stmt|;
comment|/* Turn on bus mastering */
name|tmp
operator|=
name|R128_READ
argument_list|(
name|R128_BUS_CNTL
argument_list|)
operator|&
operator|~
name|R128_BUS_MASTER_DIS
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_BUS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_do_init_cce
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_r128_init_t
modifier|*
name|init
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|dev_priv
operator|=
name|DRM
argument_list|(
name|alloc
argument_list|)
argument_list|(
sizeof|sizeof
argument_list|(
name|drm_r128_private_t
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|memset
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|drm_r128_private_t
argument_list|)
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|is_pci
operator|=
name|init
operator|->
name|is_pci
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|is_pci
operator|&&
operator|!
name|dev
operator|->
name|sg
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"PCI GART memory not allocated!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|dev_priv
operator|->
name|usec_timeout
operator|=
name|init
operator|->
name|usec_timeout
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|usec_timeout
operator|<
literal|1
operator|||
name|dev_priv
operator|->
name|usec_timeout
operator|>
name|R128_MAX_USEC_TIMEOUT
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"TIMEOUT problem!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|dev_priv
operator|->
name|cce_mode
operator|=
name|init
operator|->
name|cce_mode
expr_stmt|;
comment|/* GH: Simple idle check. 	 */
name|atomic_set
argument_list|(
operator|&
name|dev_priv
operator|->
name|idle_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* We don't support anything other than bus-mastering ring mode, 	 * but the ring can be in either AGP or PCI space for the ring 	 * read pointer. 	 */
if|if
condition|(
operator|(
name|init
operator|->
name|cce_mode
operator|!=
name|R128_PM4_192BM
operator|)
operator|&&
operator|(
name|init
operator|->
name|cce_mode
operator|!=
name|R128_PM4_128BM_64INDBM
operator|)
operator|&&
operator|(
name|init
operator|->
name|cce_mode
operator|!=
name|R128_PM4_64BM_128INDBM
operator|)
operator|&&
operator|(
name|init
operator|->
name|cce_mode
operator|!=
name|R128_PM4_64BM_64VCBM_64INDBM
operator|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"Bad cce_mode!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
switch|switch
condition|(
name|init
operator|->
name|cce_mode
condition|)
block|{
case|case
name|R128_PM4_NONPM4
case|:
name|dev_priv
operator|->
name|cce_fifo_size
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|R128_PM4_192PIO
case|:
case|case
name|R128_PM4_192BM
case|:
name|dev_priv
operator|->
name|cce_fifo_size
operator|=
literal|192
expr_stmt|;
break|break;
case|case
name|R128_PM4_128PIO_64INDBM
case|:
case|case
name|R128_PM4_128BM_64INDBM
case|:
name|dev_priv
operator|->
name|cce_fifo_size
operator|=
literal|128
expr_stmt|;
break|break;
case|case
name|R128_PM4_64PIO_128INDBM
case|:
case|case
name|R128_PM4_64BM_128INDBM
case|:
case|case
name|R128_PM4_64PIO_64VCBM_64INDBM
case|:
case|case
name|R128_PM4_64BM_64VCBM_64INDBM
case|:
case|case
name|R128_PM4_64PIO_64VCPIO_64INDPIO
case|:
name|dev_priv
operator|->
name|cce_fifo_size
operator|=
literal|64
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|init
operator|->
name|fb_bpp
condition|)
block|{
case|case
literal|16
case|:
name|dev_priv
operator|->
name|color_fmt
operator|=
name|R128_DATATYPE_RGB565
expr_stmt|;
break|break;
case|case
literal|32
case|:
default|default:
name|dev_priv
operator|->
name|color_fmt
operator|=
name|R128_DATATYPE_ARGB8888
expr_stmt|;
break|break;
block|}
name|dev_priv
operator|->
name|front_offset
operator|=
name|init
operator|->
name|front_offset
expr_stmt|;
name|dev_priv
operator|->
name|front_pitch
operator|=
name|init
operator|->
name|front_pitch
expr_stmt|;
name|dev_priv
operator|->
name|back_offset
operator|=
name|init
operator|->
name|back_offset
expr_stmt|;
name|dev_priv
operator|->
name|back_pitch
operator|=
name|init
operator|->
name|back_pitch
expr_stmt|;
switch|switch
condition|(
name|init
operator|->
name|depth_bpp
condition|)
block|{
case|case
literal|16
case|:
name|dev_priv
operator|->
name|depth_fmt
operator|=
name|R128_DATATYPE_RGB565
expr_stmt|;
break|break;
case|case
literal|24
case|:
case|case
literal|32
case|:
default|default:
name|dev_priv
operator|->
name|depth_fmt
operator|=
name|R128_DATATYPE_ARGB8888
expr_stmt|;
break|break;
block|}
name|dev_priv
operator|->
name|depth_offset
operator|=
name|init
operator|->
name|depth_offset
expr_stmt|;
name|dev_priv
operator|->
name|depth_pitch
operator|=
name|init
operator|->
name|depth_pitch
expr_stmt|;
name|dev_priv
operator|->
name|span_offset
operator|=
name|init
operator|->
name|span_offset
expr_stmt|;
name|dev_priv
operator|->
name|front_pitch_offset_c
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|front_pitch
operator|/
literal|8
operator|)
operator|<<
literal|21
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|front_offset
operator|>>
literal|5
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|back_pitch_offset_c
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|back_pitch
operator|/
literal|8
operator|)
operator|<<
literal|21
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|back_offset
operator|>>
literal|5
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|depth_pitch_offset_c
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|depth_pitch
operator|/
literal|8
operator|)
operator|<<
literal|21
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|depth_offset
operator|>>
literal|5
operator|)
operator||
name|R128_DST_TILE
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|span_pitch_offset_c
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|depth_pitch
operator|/
literal|8
operator|)
operator|<<
literal|21
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|span_offset
operator|>>
literal|5
operator|)
operator|)
expr_stmt|;
name|DRM_GETSAREA
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|sarea
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find sarea!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_FIND_MAP
argument_list|(
name|dev_priv
operator|->
name|fb
argument_list|,
name|init
operator|->
name|fb_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|fb
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find framebuffer!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_FIND_MAP
argument_list|(
name|dev_priv
operator|->
name|mmio
argument_list|,
name|init
operator|->
name|mmio_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|mmio
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find mmio region!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_FIND_MAP
argument_list|(
name|dev_priv
operator|->
name|cce_ring
argument_list|,
name|init
operator|->
name|ring_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|cce_ring
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find cce ring region!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_FIND_MAP
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|init
operator|->
name|ring_rptr_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|ring_rptr
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find ring read pointer!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_FIND_MAP
argument_list|(
name|dev_priv
operator|->
name|buffers
argument_list|,
name|init
operator|->
name|buffers_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|buffers
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find dma buffer region!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|is_pci
condition|)
block|{
name|DRM_FIND_MAP
argument_list|(
name|dev_priv
operator|->
name|agp_textures
argument_list|,
name|init
operator|->
name|agp_textures_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|agp_textures
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find agp texture region!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|=
operator|(
name|drm_r128_sarea_t
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|dev_priv
operator|->
name|sarea
operator|->
name|handle
operator|+
name|init
operator|->
name|sarea_priv_offset
operator|)
expr_stmt|;
if|#
directive|if
name|__REALLY_HAVE_AGP
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|is_pci
condition|)
block|{
name|DRM_IOREMAP
argument_list|(
name|dev_priv
operator|->
name|cce_ring
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|DRM_IOREMAP
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|DRM_IOREMAP
argument_list|(
name|dev_priv
operator|->
name|buffers
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|cce_ring
operator|->
name|handle
operator|||
operator|!
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
operator|||
operator|!
name|dev_priv
operator|->
name|buffers
operator|->
name|handle
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Could not ioremap agp regions!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|dev_priv
operator|->
name|cce_ring
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
operator|->
name|cce_ring
operator|->
name|offset
expr_stmt|;
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|offset
expr_stmt|;
name|dev_priv
operator|->
name|buffers
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
operator|->
name|buffers
operator|->
name|offset
expr_stmt|;
block|}
if|#
directive|if
name|__REALLY_HAVE_AGP
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|is_pci
condition|)
name|dev_priv
operator|->
name|cce_buffers_offset
operator|=
name|dev
operator|->
name|agp
operator|->
name|base
expr_stmt|;
else|else
endif|#
directive|endif
name|dev_priv
operator|->
name|cce_buffers_offset
operator|=
name|dev
operator|->
name|sg
operator|->
name|handle
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|start
operator|=
operator|(
name|u32
operator|*
operator|)
name|dev_priv
operator|->
name|cce_ring
operator|->
name|handle
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|end
operator|=
operator|(
operator|(
name|u32
operator|*
operator|)
name|dev_priv
operator|->
name|cce_ring
operator|->
name|handle
operator|+
name|init
operator|->
name|ring_size
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|size
operator|=
name|init
operator|->
name|ring_size
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
operator|=
name|DRM
argument_list|(
name|order
argument_list|)
argument_list|(
name|init
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail_mask
operator|=
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|size
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|high_mark
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|=
literal|0
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_LAST_FRAME_REG
argument_list|,
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|=
literal|0
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_LAST_DISPATCH_REG
argument_list|,
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
argument_list|)
expr_stmt|;
if|#
directive|if
name|__REALLY_HAVE_AGP
if|if
condition|(
name|dev_priv
operator|->
name|is_pci
condition|)
block|{
endif|#
directive|endif
if|if
condition|(
operator|!
name|DRM
argument_list|(
name|ati_pcigart_init
argument_list|)
argument_list|(
name|dev
argument_list|,
operator|&
name|dev_priv
operator|->
name|phys_pci_gart
argument_list|,
operator|&
name|dev_priv
operator|->
name|bus_pci_gart
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to init PCI GART!\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|R128_WRITE
argument_list|(
name|R128_PCI_GART_PAGE
argument_list|,
name|dev_priv
operator|->
name|bus_pci_gart
argument_list|)
expr_stmt|;
if|#
directive|if
name|__REALLY_HAVE_AGP
block|}
endif|#
directive|endif
name|r128_cce_init_ring_buffer
argument_list|(
name|dev
argument_list|,
name|dev_priv
argument_list|)
expr_stmt|;
name|r128_cce_load_microcode
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|r128_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r128_do_cleanup_cce
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|)
block|{
if|#
directive|if
name|__HAVE_IRQ
comment|/* Make sure interrupts are disabled here because the uninstall ioctl 	 * may not have been called from userspace and after dev_private 	 * is freed, it's too late. 	 */
if|if
condition|(
name|dev
operator|->
name|irq
condition|)
name|DRM
function_decl|(
name|irq_uninstall
function_decl|)
parameter_list|(
name|dev
parameter_list|)
function_decl|;
endif|#
directive|endif
if|if
condition|(
name|dev
operator|->
name|dev_private
condition|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|#
directive|if
name|__REALLY_HAVE_AGP
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|is_pci
condition|)
block|{
if|if
condition|(
name|dev_priv
operator|->
name|cce_ring
operator|!=
name|NULL
condition|)
name|DRM_IOREMAPFREE
argument_list|(
name|dev_priv
operator|->
name|cce_ring
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|ring_rptr
operator|!=
name|NULL
condition|)
name|DRM_IOREMAPFREE
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|buffers
operator|!=
name|NULL
condition|)
name|DRM_IOREMAPFREE
argument_list|(
name|dev_priv
operator|->
name|buffers
argument_list|,
name|dev
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
operator|!
name|DRM
argument_list|(
name|ati_pcigart_cleanup
argument_list|)
argument_list|(
name|dev
argument_list|,
name|dev_priv
operator|->
name|phys_pci_gart
argument_list|,
name|dev_priv
operator|->
name|bus_pci_gart
argument_list|)
condition|)
name|DRM_ERROR
argument_list|(
literal|"failed to cleanup PCI GART!\n"
argument_list|)
expr_stmt|;
block|}
name|DRM
argument_list|(
name|free
argument_list|)
argument_list|(
name|dev
operator|->
name|dev_private
argument_list|,
sizeof|sizeof
argument_list|(
name|drm_r128_private_t
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r128_cce_init
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_r128_init_t
name|init
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|init
argument_list|,
operator|(
name|drm_r128_init_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|init
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|init
operator|.
name|func
condition|)
block|{
case|case
name|R128_INIT_CCE
case|:
return|return
name|r128_do_init_cce
argument_list|(
name|dev
argument_list|,
operator|&
name|init
argument_list|)
return|;
case|case
name|R128_CLEANUP_CCE
case|:
return|return
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
return|;
block|}
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|r128_cce_start
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|cce_running
operator|||
name|dev_priv
operator|->
name|cce_mode
operator|==
name|R128_PM4_NONPM4
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"%s while CCE running\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|r128_do_cce_start
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Stop the CCE.  The engine must have been idled before calling this  * routine.  */
end_comment

begin_function
name|int
name|r128_cce_stop
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_cce_stop_t
name|stop
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|stop
argument_list|,
operator|(
name|drm_r128_cce_stop_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|stop
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Flush any pending CCE commands.  This ensures any outstanding 	 * commands are exectuted by the engine before we turn it off. 	 */
if|if
condition|(
name|stop
operator|.
name|flush
condition|)
block|{
name|r128_do_cce_flush
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
comment|/* If we fail to make the engine go idle, we return an error 	 * code so that the DRM ioctl wrapper can try again. 	 */
if|if
condition|(
name|stop
operator|.
name|idle
condition|)
block|{
name|ret
operator|=
name|r128_do_cce_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
comment|/* Finally, we can turn off the CCE.  If the engine isn't idle, 	 * we will get some dropped triangles as they won't be fully 	 * rendered before the CCE is shut down. 	 */
name|r128_do_cce_stop
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* Reset the engine */
name|r128_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Just reset the CCE ring.  Called as part of an X Server engine reset.  */
end_comment

begin_function
name|int
name|r128_cce_reset
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"%s called before init done\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|r128_do_cce_reset
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* The CCE is no longer running after an engine reset */
name|dev_priv
operator|->
name|cce_running
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r128_cce_idle
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|cce_running
condition|)
block|{
name|r128_do_cce_flush
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
return|return
name|r128_do_cce_idle
argument_list|(
name|dev_priv
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|r128_engine_reset
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
return|return
name|r128_do_engine_reset
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|r128_fullscreen
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ================================================================  * Freelist management  */
end_comment

begin_define
define|#
directive|define
name|R128_BUFFER_USED
value|0xffffffff
end_define

begin_define
define|#
directive|define
name|R128_BUFFER_FREE
value|0
end_define

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static int r128_freelist_init( drm_device_t *dev ) { 	drm_device_dma_t *dma = dev->dma; 	drm_r128_private_t *dev_priv = dev->dev_private; 	drm_buf_t *buf; 	drm_r128_buf_priv_t *buf_priv; 	drm_r128_freelist_t *entry; 	int i;  	dev_priv->head = DRM(alloc)( sizeof(drm_r128_freelist_t), 				     DRM_MEM_DRIVER ); 	if ( dev_priv->head == NULL ) 		return DRM_ERR(ENOMEM);  	memset( dev_priv->head, 0, sizeof(drm_r128_freelist_t) ); 	dev_priv->head->age = R128_BUFFER_USED;  	for ( i = 0 ; i< dma->buf_count ; i++ ) { 		buf = dma->buflist[i]; 		buf_priv = buf->dev_private;  		entry = DRM(alloc)( sizeof(drm_r128_freelist_t), 				    DRM_MEM_DRIVER ); 		if ( !entry ) return DRM_ERR(ENOMEM);  		entry->age = R128_BUFFER_FREE; 		entry->buf = buf; 		entry->prev = dev_priv->head; 		entry->next = dev_priv->head->next; 		if ( !entry->next ) 			dev_priv->tail = entry;  		buf_priv->discard = 0; 		buf_priv->dispatched = 0; 		buf_priv->list_entry = entry;  		dev_priv->head->next = entry;  		if ( dev_priv->head->next ) 			dev_priv->head->next->prev = entry; 	}  	return 0;  }
endif|#
directive|endif
end_endif

begin_function
name|drm_buf_t
modifier|*
name|r128_freelist_get
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|)
block|{
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|t
decl_stmt|;
comment|/* FIXME: Optimize -- use freelist code */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dma
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|i
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|filp
operator|==
literal|0
condition|)
return|return
name|buf
return|;
block|}
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|t
operator|++
control|)
block|{
name|u32
name|done_age
init|=
name|R128_READ
argument_list|(
name|R128_LAST_DISPATCH_REG
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dma
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|i
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pending
operator|&&
name|buf_priv
operator|->
name|age
operator|<=
name|done_age
condition|)
block|{
comment|/* The buffer has been processed, so it 				 * can now be used. 				 */
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
return|return
name|buf
return|;
block|}
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"returning NULL!\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|r128_freelist_reset
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|)
block|{
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dma
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|drm_buf_t
modifier|*
name|buf
init|=
name|dma
operator|->
name|buflist
index|[
name|i
index|]
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|buf_priv
operator|->
name|age
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ================================================================  * CCE command submission  */
end_comment

begin_function
name|int
name|r128_wait_ring
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|drm_r128_ring_buffer_t
modifier|*
name|ring
init|=
operator|&
name|dev_priv
operator|->
name|ring
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|r128_update_ring_snapshot
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|space
operator|>=
name|n
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* FIXME: This is being ignored... */
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EBUSY
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_get_buffers
parameter_list|(
name|DRMFILE
name|filp
parameter_list|,
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_dma_t
modifier|*
name|d
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
for|for
control|(
name|i
operator|=
name|d
operator|->
name|granted_count
init|;
name|i
operator|<
name|d
operator|->
name|request_count
condition|;
name|i
operator|++
control|)
block|{
name|buf
operator|=
name|r128_freelist_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EAGAIN
argument_list|)
return|;
name|buf
operator|->
name|filp
operator|=
name|filp
expr_stmt|;
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|d
operator|->
name|request_indices
index|[
name|i
index|]
argument_list|,
operator|&
name|buf
operator|->
name|idx
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
operator|->
name|idx
argument_list|)
argument_list|)
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EFAULT
argument_list|)
return|;
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|d
operator|->
name|request_sizes
index|[
name|i
index|]
argument_list|,
operator|&
name|buf
operator|->
name|total
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
operator|->
name|total
argument_list|)
argument_list|)
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EFAULT
argument_list|)
return|;
name|d
operator|->
name|granted_count
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r128_cce_buffers
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|drm_dma_t
name|d
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|filp
argument_list|)
expr_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|d
argument_list|,
operator|(
name|drm_dma_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|d
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Please don't send us buffers. 	 */
if|if
condition|(
name|d
operator|.
name|send_count
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Process %d trying to send %d buffers via drmDMA\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|d
operator|.
name|send_count
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
comment|/* We'll send you buffers. 	 */
if|if
condition|(
name|d
operator|.
name|request_count
operator|<
literal|0
operator|||
name|d
operator|.
name|request_count
operator|>
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Process %d trying to get %d buffers (of %d max)\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|d
operator|.
name|request_count
argument_list|,
name|dma
operator|->
name|buf_count
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|d
operator|.
name|granted_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|d
operator|.
name|request_count
condition|)
block|{
name|ret
operator|=
name|r128_cce_get_buffers
argument_list|(
name|filp
argument_list|,
name|dev
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
block|}
name|DRM_COPY_TO_USER_IOCTL
argument_list|(
operator|(
name|drm_dma_t
operator|*
operator|)
name|data
argument_list|,
name|d
argument_list|,
sizeof|sizeof
argument_list|(
name|d
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


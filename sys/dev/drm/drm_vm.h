begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_function
specifier|static
name|int
name|DRM
function|(
name|dma_mmap
function|)
parameter_list|(
name|dev_t
name|kdev
parameter_list|,
name|vm_offset_t
name|offset
parameter_list|,
name|int
name|prot
parameter_list|)
block|{
name|drm_device_t
modifier|*
name|dev
init|=
name|kdev
operator|->
name|si_drv1
decl_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|unsigned
name|long
name|physical
decl_stmt|;
name|unsigned
name|long
name|page
decl_stmt|;
if|if
condition|(
operator|!
name|dma
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Error */
if|if
condition|(
operator|!
name|dma
operator|->
name|pagelist
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Nothing allocated */
name|page
operator|=
name|offset
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|physical
operator|=
name|dma
operator|->
name|pagelist
index|[
name|page
index|]
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"0x%08x (page %lu) => 0x%08lx\n"
argument_list|,
name|offset
argument_list|,
name|page
argument_list|,
name|physical
argument_list|)
expr_stmt|;
return|return
name|atop
argument_list|(
name|physical
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|DRM
function|(
name|mmap
function|)
parameter_list|(
name|dev_t
name|kdev
parameter_list|,
name|vm_offset_t
name|offset
parameter_list|,
name|int
name|prot
parameter_list|)
block|{
name|drm_device_t
modifier|*
name|dev
init|=
name|kdev
operator|->
name|si_drv1
decl_stmt|;
name|drm_map_t
modifier|*
name|map
init|=
name|NULL
decl_stmt|;
name|drm_map_list_entry_t
modifier|*
name|listentry
init|=
name|NULL
decl_stmt|;
comment|/*drm_file_t *priv;*/
comment|/*	DRM_DEBUG("offset = 0x%x\n", offset);*/
comment|/*XXX Fixme */
comment|/*priv = DRM(find_file_by_proc)(dev, p); 	if (!priv) { 		DRM_DEBUG("can't find authenticator\n"); 		return EINVAL; 	}  	if (!priv->authenticated) DRM_OS_RETURN(EACCES);*/
if|if
condition|(
name|dev
operator|->
name|dma
operator|&&
name|offset
operator|>=
literal|0
operator|&&
name|offset
operator|<
name|ptoa
argument_list|(
name|dev
operator|->
name|dma
operator|->
name|page_count
argument_list|)
condition|)
return|return
name|DRM
argument_list|(
name|dma_mmap
argument_list|)
argument_list|(
name|kdev
argument_list|,
name|offset
argument_list|,
name|prot
argument_list|)
return|;
comment|/* A sequential search of a linked list is 				   fine here because: 1) there will only be 				   about 5-10 entries in the list and, 2) a 				   DRI client only has to do this mapping 				   once, so it doesn't have to be optimized 				   for performance, even if the list was a 				   bit longer. */
name|TAILQ_FOREACH
argument_list|(
argument|listentry
argument_list|,
argument|dev->maplist
argument_list|,
argument|link
argument_list|)
block|{
name|map
operator|=
name|listentry
operator|->
name|map
expr_stmt|;
comment|/*		DRM_DEBUG("considering 0x%x..0x%x\n", map->offset, map->offset + map->size - 1);*/
if|if
condition|(
name|offset
operator|>=
name|map
operator|->
name|offset
operator|&&
name|offset
operator|<
name|map
operator|->
name|offset
operator|+
name|map
operator|->
name|size
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|listentry
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"can't find map\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|map
operator|->
name|flags
operator|&
name|_DRM_RESTRICTED
operator|)
operator|&&
name|suser
argument_list|(
name|DRM_OS_CURPROC
argument_list|)
operator|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"restricted map\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|map
operator|->
name|type
condition|)
block|{
case|case
name|_DRM_FRAME_BUFFER
case|:
case|case
name|_DRM_REGISTERS
case|:
case|case
name|_DRM_AGP
case|:
return|return
name|atop
argument_list|(
name|offset
argument_list|)
return|;
case|case
name|_DRM_SHM
case|:
return|return
name|atop
argument_list|(
name|vtophys
argument_list|(
name|offset
argument_list|)
argument_list|)
return|;
default|default:
return|return
operator|-
literal|1
return|;
comment|/* This should never happen. */
block|}
name|DRM_DEBUG
argument_list|(
literal|"bailing out\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


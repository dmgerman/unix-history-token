begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2008-2009 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *     Dave Airlie<airlied@redhat.com>  *     Alex Deucher<alexander.deucher@amd.com>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_drv.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/r600_microcode.h"
end_include

begin_define
define|#
directive|define
name|ATI_PCIGART_PAGE_SIZE
value|4096
end_define

begin_comment
comment|/**< PCI GART page size */
end_comment

begin_define
define|#
directive|define
name|ATI_PCIGART_PAGE_MASK
value|(~(ATI_PCIGART_PAGE_SIZE-1))
end_define

begin_define
define|#
directive|define
name|R600_PTE_VALID
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|R600_PTE_SYSTEM
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|R600_PTE_SNOOPED
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|R600_PTE_READABLE
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|R600_PTE_WRITEABLE
value|(1<< 6)
end_define

begin_comment
comment|/* MAX values used for gfx init */
end_comment

begin_define
define|#
directive|define
name|R6XX_MAX_SH_GPRS
value|256
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_TEMP_GPRS
value|16
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_SH_THREADS
value|256
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_SH_STACK_ENTRIES
value|4096
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_BACKENDS
value|8
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_BACKENDS_MASK
value|0xff
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_SIMDS
value|8
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_SIMDS_MASK
value|0xff
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_PIPES
value|8
end_define

begin_define
define|#
directive|define
name|R6XX_MAX_PIPES_MASK
value|0xff
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_SH_GPRS
value|256
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_TEMP_GPRS
value|16
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_SH_THREADS
value|256
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_SH_STACK_ENTRIES
value|4096
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_BACKENDS
value|8
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_BACKENDS_MASK
value|0xff
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_SIMDS
value|16
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_SIMDS_MASK
value|0xffff
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_PIPES
value|8
end_define

begin_define
define|#
directive|define
name|R7XX_MAX_PIPES_MASK
value|0xff
end_define

begin_function
specifier|static
name|int
name|r600_do_wait_for_fifo
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|entries
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|dev_priv
operator|->
name|stats
operator|.
name|boxes
operator||=
name|RADEON_BOX_WAIT_IDLE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|int
name|slots
decl_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
condition|)
name|slots
operator|=
operator|(
name|RADEON_READ
argument_list|(
name|R600_GRBM_STATUS
argument_list|)
operator|&
name|R700_CMDFIFO_AVAIL_MASK
operator|)
expr_stmt|;
else|else
name|slots
operator|=
operator|(
name|RADEON_READ
argument_list|(
name|R600_GRBM_STATUS
argument_list|)
operator|&
name|R600_CMDFIFO_AVAIL_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|slots
operator|>=
name|entries
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"wait for fifo failed status : 0x%08X 0x%08X\n"
argument_list|,
name|RADEON_READ
argument_list|(
name|R600_GRBM_STATUS
argument_list|)
argument_list|,
name|RADEON_READ
argument_list|(
name|R600_GRBM_STATUS2
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EBUSY
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_do_wait_for_idle
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|dev_priv
operator|->
name|stats
operator|.
name|boxes
operator||=
name|RADEON_BOX_WAIT_IDLE
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
condition|)
name|ret
operator|=
name|r600_do_wait_for_fifo
argument_list|(
name|dev_priv
argument_list|,
literal|8
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|r600_do_wait_for_fifo
argument_list|(
name|dev_priv
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RADEON_READ
argument_list|(
name|R600_GRBM_STATUS
argument_list|)
operator|&
name|R600_GUI_ACTIVE
operator|)
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"wait idle failed status : 0x%08X 0x%08X\n"
argument_list|,
name|RADEON_READ
argument_list|(
name|R600_GRBM_STATUS
argument_list|)
argument_list|,
name|RADEON_READ
argument_list|(
name|R600_GRBM_STATUS2
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EBUSY
return|;
block|}
end_function

begin_function
name|void
name|r600_page_table_cleanup
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_ati_pcigart_info
modifier|*
name|gart_info
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|struct
name|drm_sg_mem
modifier|*
name|entry
init|=
name|dev
operator|->
name|sg
decl_stmt|;
name|int
name|max_pages
decl_stmt|;
name|int
name|pages
decl_stmt|;
name|int
name|i
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|gart_info
operator|->
name|bus_addr
condition|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|max_pages
operator|=
operator|(
name|gart_info
operator|->
name|table_size
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|pages
operator|=
operator|(
name|entry
operator|->
name|pages
operator|<=
name|max_pages
operator|)
condition|?
name|entry
operator|->
name|pages
else|:
name|max_pages
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pages
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|entry
operator|->
name|busaddr
index|[
name|i
index|]
condition|)
break|break;
name|pci_unmap_single
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
name|entry
operator|->
name|busaddr
index|[
name|i
index|]
argument_list|,
name|PAGE_SIZE
argument_list|,
name|PCI_DMA_TODEVICE
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|gart_info
operator|->
name|gart_table_location
operator|==
name|DRM_ATI_GART_MAIN
condition|)
name|gart_info
operator|->
name|bus_addr
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* R600 has page table setup */
end_comment

begin_function
name|int
name|r600_page_table_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_ati_pcigart_info
modifier|*
name|gart_info
init|=
operator|&
name|dev_priv
operator|->
name|gart_info
decl_stmt|;
name|struct
name|drm_sg_mem
modifier|*
name|entry
init|=
name|dev
operator|->
name|sg
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|max_pages
decl_stmt|,
name|pages
decl_stmt|;
name|u64
modifier|*
name|pci_gart
decl_stmt|,
name|page_base
decl_stmt|;
name|dma_addr_t
name|entry_addr
decl_stmt|;
comment|/* okay page table is available - lets rock */
comment|/* PTEs are 64-bits */
name|pci_gart
operator|=
operator|(
name|u64
operator|*
operator|)
name|gart_info
operator|->
name|addr
expr_stmt|;
name|max_pages
operator|=
operator|(
name|gart_info
operator|->
name|table_size
operator|/
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|)
expr_stmt|;
name|pages
operator|=
operator|(
name|entry
operator|->
name|pages
operator|<=
name|max_pages
operator|)
condition|?
name|entry
operator|->
name|pages
else|:
name|max_pages
expr_stmt|;
name|memset
argument_list|(
name|pci_gart
argument_list|,
literal|0
argument_list|,
name|max_pages
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pages
condition|;
name|i
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|entry
operator|->
name|busaddr
index|[
name|i
index|]
operator|=
name|pci_map_single
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
name|page_address
argument_list|(
name|entry
operator|->
name|pagelist
index|[
name|i
index|]
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
name|PCI_DMA_TODEVICE
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|busaddr
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"unable to map PCIGART pages!\n"
argument_list|)
expr_stmt|;
name|r600_page_table_cleanup
argument_list|(
name|dev
argument_list|,
name|gart_info
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
endif|#
directive|endif
name|entry_addr
operator|=
name|entry
operator|->
name|busaddr
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
name|PAGE_SIZE
operator|/
name|ATI_PCIGART_PAGE_SIZE
operator|)
condition|;
name|j
operator|++
control|)
block|{
name|page_base
operator|=
operator|(
name|u64
operator|)
name|entry_addr
operator|&
name|ATI_PCIGART_PAGE_MASK
expr_stmt|;
name|page_base
operator||=
name|R600_PTE_VALID
operator||
name|R600_PTE_SYSTEM
operator||
name|R600_PTE_SNOOPED
expr_stmt|;
name|page_base
operator||=
name|R600_PTE_READABLE
operator||
name|R600_PTE_WRITEABLE
expr_stmt|;
operator|*
name|pci_gart
operator|=
name|page_base
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
literal|128
operator|)
operator|==
literal|0
condition|)
name|DRM_DEBUG
argument_list|(
literal|"page entry %d: 0x%016llx\n"
argument_list|,
name|i
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|page_base
argument_list|)
expr_stmt|;
name|pci_gart
operator|++
expr_stmt|;
name|entry_addr
operator|+=
name|ATI_PCIGART_PAGE_SIZE
expr_stmt|;
block|}
block|}
name|ret
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|done
label|:
endif|#
directive|endif
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_vm_flush_gart_range
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|resp
decl_stmt|,
name|countdown
init|=
literal|1000
decl_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_INVALIDATION_LOW_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_INVALIDATION_HIGH_ADDR
argument_list|,
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_REQUEST_RESPONSE
argument_list|,
literal|2
argument_list|)
expr_stmt|;
do|do
block|{
name|resp
operator|=
name|RADEON_READ
argument_list|(
name|R600_VM_CONTEXT0_REQUEST_RESPONSE
argument_list|)
expr_stmt|;
name|countdown
operator|--
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|(
name|resp
operator|&
literal|0xf0
operator|)
operator|==
literal|0
operator|)
operator|&&
name|countdown
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_vm_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
comment|/* initialise the VM to use the page table we constructed up there */
name|u32
name|vm_c0
decl_stmt|,
name|i
decl_stmt|;
name|u32
name|mc_rd_a
decl_stmt|;
name|u32
name|vm_l2_cntl
decl_stmt|,
name|vm_l2_cntl3
decl_stmt|;
comment|/* okay set up the PCIE aperture type thingo */
name|RADEON_WRITE
argument_list|(
name|R600_MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* setup MC RD a */
name|mc_rd_a
operator|=
name|R600_MCD_L1_TLB
operator||
name|R600_MCD_L1_FRAG_PROC
operator||
name|R600_MCD_SYSTEM_ACCESS_MODE_IN_SYS
operator||
name|R600_MCD_SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
operator||
name|R600_MCD_EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|R600_MCD_EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|R600_MCD_WAIT_L2_QUERY
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_RD_A_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_RD_B_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_WR_A_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_WR_B_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_RD_GFX_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_WR_GFX_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_RD_SYS_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_WR_SYS_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_RD_HDP_CNTL
argument_list|,
name|mc_rd_a
operator||
name|R600_MCD_L1_STRICT_ORDERING
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_WR_HDP_CNTL
argument_list|,
name|mc_rd_a
comment|/*| R600_MCD_L1_STRICT_ORDERING*/
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_RD_PDMA_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_WR_PDMA_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_RD_SEM_CNTL
argument_list|,
name|mc_rd_a
operator||
name|R600_MCD_SEMAPHORE_MODE
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_MCD_WR_SEM_CNTL
argument_list|,
name|mc_rd_a
argument_list|)
expr_stmt|;
name|vm_l2_cntl
operator|=
name|R600_VM_L2_CACHE_EN
operator||
name|R600_VM_L2_FRAG_PROC
operator||
name|R600_VM_ENABLE_PTE_CACHE_LRU_W
expr_stmt|;
name|vm_l2_cntl
operator||=
name|R600_VM_L2_CNTL_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_L2_CNTL
argument_list|,
name|vm_l2_cntl
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vm_l2_cntl3
operator|=
operator|(
name|R600_VM_L2_CNTL3_BANK_SELECT_0
argument_list|(
literal|0
argument_list|)
operator||
name|R600_VM_L2_CNTL3_BANK_SELECT_1
argument_list|(
literal|1
argument_list|)
operator||
name|R600_VM_L2_CNTL3_CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_L2_CNTL3
argument_list|,
name|vm_l2_cntl3
argument_list|)
expr_stmt|;
name|vm_c0
operator|=
name|R600_VM_ENABLE_CONTEXT
operator||
name|R600_VM_PAGE_TABLE_DEPTH_FLAT
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_CNTL
argument_list|,
name|vm_c0
argument_list|)
expr_stmt|;
name|vm_c0
operator|&=
operator|~
name|R600_VM_ENABLE_CONTEXT
expr_stmt|;
comment|/* disable all other contexts */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
name|vm_c0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_PAGE_TABLE_START_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_PAGE_TABLE_END_ADDR
argument_list|,
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|r600_vm_flush_gart_range
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* load r600 microcode */
end_comment

begin_function
specifier|static
name|void
name|r600_cp_load_microcode
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
specifier|const
name|u32
argument_list|(
operator|*
name|cp
argument_list|)
index|[
literal|3
index|]
expr_stmt|;
specifier|const
name|u32
modifier|*
name|pfp
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_R600
case|:
name|DRM_INFO
argument_list|(
literal|"Loading R600 Microcode\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|R600_cp_microcode
expr_stmt|;
name|pfp
operator|=
name|R600_pfp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RV610
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV610 Microcode\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|RV610_cp_microcode
expr_stmt|;
name|pfp
operator|=
name|RV610_pfp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RV630
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV630 Microcode\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|RV630_cp_microcode
expr_stmt|;
name|pfp
operator|=
name|RV630_pfp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RV620
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV620 Microcode\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|RV620_cp_microcode
expr_stmt|;
name|pfp
operator|=
name|RV620_pfp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RV635
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV635 Microcode\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|RV635_cp_microcode
expr_stmt|;
name|pfp
operator|=
name|RV635_pfp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RV670
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV670 Microcode\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|RV670_cp_microcode
expr_stmt|;
name|pfp
operator|=
name|RV670_pfp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RS780/RS880 Microcode\n"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|RS780_cp_microcode
expr_stmt|;
name|pfp
operator|=
name|RS780_pfp_microcode
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|r600_do_cp_stop
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|R600_RB_NO_UPDATE
operator||
name|R600_RB_BLKSZ
argument_list|(
literal|15
argument_list|)
operator||
name|R600_RB_BUFSZ
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
name|R600_SOFT_RESET_CP
argument_list|)
expr_stmt|;
name|RADEON_READ
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PM4_UCODE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_DATA
argument_list|,
name|cp
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_DATA
argument_list|,
name|cp
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_DATA
argument_list|,
name|cp
index|[
name|i
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PFP_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|RADEON_WRITE
argument_list|(
name|R600_CP_PFP_UCODE_DATA
argument_list|,
name|pfp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_RADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r700_vm_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
comment|/* initialise the VM to use the page table we constructed up there */
name|u32
name|vm_c0
decl_stmt|,
name|i
decl_stmt|;
name|u32
name|mc_vm_md_l1
decl_stmt|;
name|u32
name|vm_l2_cntl
decl_stmt|,
name|vm_l2_cntl3
decl_stmt|;
comment|/* okay set up the PCIE aperture type thingo */
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_SYSTEM_APERTURE_LOW_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_SYSTEM_APERTURE_HIGH_ADDR
argument_list|,
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mc_vm_md_l1
operator|=
name|R700_ENABLE_L1_TLB
operator||
name|R700_ENABLE_L1_FRAGMENT_PROCESSING
operator||
name|R700_SYSTEM_ACCESS_MODE_IN_SYS
operator||
name|R700_SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU
operator||
name|R700_EFFECTIVE_L1_TLB_SIZE
argument_list|(
literal|5
argument_list|)
operator||
name|R700_EFFECTIVE_L1_QUEUE_SIZE
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_MD_L1_TLB0_CNTL
argument_list|,
name|mc_vm_md_l1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_MD_L1_TLB1_CNTL
argument_list|,
name|mc_vm_md_l1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_MD_L1_TLB2_CNTL
argument_list|,
name|mc_vm_md_l1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_MB_L1_TLB0_CNTL
argument_list|,
name|mc_vm_md_l1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_MB_L1_TLB1_CNTL
argument_list|,
name|mc_vm_md_l1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_MB_L1_TLB2_CNTL
argument_list|,
name|mc_vm_md_l1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_MC_VM_MB_L1_TLB3_CNTL
argument_list|,
name|mc_vm_md_l1
argument_list|)
expr_stmt|;
name|vm_l2_cntl
operator|=
name|R600_VM_L2_CACHE_EN
operator||
name|R600_VM_L2_FRAG_PROC
operator||
name|R600_VM_ENABLE_PTE_CACHE_LRU_W
expr_stmt|;
name|vm_l2_cntl
operator||=
name|R700_VM_L2_CNTL_QUEUE_SIZE
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_L2_CNTL
argument_list|,
name|vm_l2_cntl
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_L2_CNTL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vm_l2_cntl3
operator|=
name|R700_VM_L2_CNTL3_BANK_SELECT
argument_list|(
literal|0
argument_list|)
operator||
name|R700_VM_L2_CNTL3_CACHE_UPDATE_MODE
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_L2_CNTL3
argument_list|,
name|vm_l2_cntl3
argument_list|)
expr_stmt|;
name|vm_c0
operator|=
name|R600_VM_ENABLE_CONTEXT
operator||
name|R600_VM_PAGE_TABLE_DEPTH_FLAT
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_CNTL
argument_list|,
name|vm_c0
argument_list|)
expr_stmt|;
name|vm_c0
operator|&=
operator|~
name|R600_VM_ENABLE_CONTEXT
expr_stmt|;
comment|/* disable all other contexts */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|RADEON_WRITE
argument_list|(
name|R600_VM_CONTEXT0_CNTL
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
name|vm_c0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_VM_CONTEXT0_PAGE_TABLE_BASE_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_VM_CONTEXT0_PAGE_TABLE_START_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_VM_CONTEXT0_PAGE_TABLE_END_ADDR
argument_list|,
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|r600_vm_flush_gart_range
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* load r600 microcode */
end_comment

begin_function
specifier|static
name|void
name|r700_cp_load_microcode
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
specifier|const
name|u32
modifier|*
name|pfp
decl_stmt|;
specifier|const
name|u32
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_RV770
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV770/RV790 Microcode\n"
argument_list|)
expr_stmt|;
name|pfp
operator|=
name|RV770_pfp_microcode
expr_stmt|;
name|cp
operator|=
name|RV770_cp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RV730
case|:
case|case
name|CHIP_RV740
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV730/RV740 Microcode\n"
argument_list|)
expr_stmt|;
name|pfp
operator|=
name|RV730_pfp_microcode
expr_stmt|;
name|cp
operator|=
name|RV730_cp_microcode
expr_stmt|;
break|break;
case|case
name|CHIP_RV710
case|:
name|DRM_INFO
argument_list|(
literal|"Loading RV710 Microcode\n"
argument_list|)
expr_stmt|;
name|pfp
operator|=
name|RV710_pfp_microcode
expr_stmt|;
name|cp
operator|=
name|RV710_cp_microcode
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|r600_do_cp_stop
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|R600_RB_NO_UPDATE
operator||
operator|(
literal|15
operator|<<
literal|8
operator|)
operator||
operator|(
literal|3
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
name|R600_SOFT_RESET_CP
argument_list|)
expr_stmt|;
name|RADEON_READ
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R700_PFP_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|RADEON_WRITE
argument_list|(
name|R600_CP_PFP_UCODE_DATA
argument_list|,
name|pfp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R700_PM4_UCODE_SIZE
condition|;
name|i
operator|++
control|)
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_DATA
argument_list|,
name|cp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_PFP_UCODE_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_WADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_RAM_RADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_test_writeback
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* Start with assuming that writeback doesn't work */
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|0
expr_stmt|;
comment|/* Writeback doesn't seem to work everywhere, test it here and possibly 	 * enable it if it appears to work 	 */
name|radeon_write_ring_rptr
argument_list|(
name|dev_priv
argument_list|,
name|R600_SCRATCHOFF
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SCRATCH_REG1
argument_list|,
literal|0xdeadbeef
argument_list|)
expr_stmt|;
for|for
control|(
name|tmp
operator|=
literal|0
init|;
name|tmp
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|tmp
operator|++
control|)
block|{
name|u32
name|val
decl_stmt|;
name|val
operator|=
name|radeon_read_ring_rptr
argument_list|(
name|dev_priv
argument_list|,
name|R600_SCRATCHOFF
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0xdeadbeef
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|)
block|{
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|1
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"writeback test succeeded in %d usecs\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|0
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"writeback test failed\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_no_wb
operator|==
literal|1
condition|)
block|{
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|0
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"writeback forced off\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|writeback_works
condition|)
block|{
comment|/* Disable writeback to avoid unnecessary bus master transfer */
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|RADEON_READ
argument_list|(
name|R600_CP_RB_CNTL
argument_list|)
operator||
name|RADEON_RB_NO_UPDATE
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r600_do_engine_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|cp_ptr
decl_stmt|,
name|cp_me_cntl
decl_stmt|,
name|cp_rb_cntl
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"Resetting GPU\n"
argument_list|)
expr_stmt|;
name|cp_ptr
operator|=
name|RADEON_READ
argument_list|(
name|R600_CP_RB_WPTR
argument_list|)
expr_stmt|;
name|cp_me_cntl
operator|=
name|RADEON_READ
argument_list|(
name|R600_CP_ME_CNTL
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_CNTL
argument_list|,
name|R600_CP_ME_HALT
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
literal|0x7fff
argument_list|)
expr_stmt|;
name|RADEON_READ
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_READ
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cp_rb_cntl
operator|=
name|RADEON_READ
argument_list|(
name|R600_CP_RB_CNTL
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|R600_RB_RPTR_WR_ENA
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_RPTR_WR
argument_list|,
name|cp_ptr
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_WPTR
argument_list|,
name|cp_ptr
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|cp_rb_cntl
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_CNTL
argument_list|,
name|cp_me_cntl
argument_list|)
expr_stmt|;
comment|/* Reset the CP ring */
name|r600_do_cp_reset
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* The CP is no longer running after an engine reset */
name|dev_priv
operator|->
name|cp_running
operator|=
literal|0
expr_stmt|;
comment|/* Reset any pending vertex, indirect buffers */
name|radeon_freelist_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|r600_get_tile_pipe_to_backend_map
parameter_list|(
name|u32
name|num_tile_pipes
parameter_list|,
name|u32
name|num_backends
parameter_list|,
name|u32
name|backend_disable_mask
parameter_list|)
block|{
name|u32
name|backend_map
init|=
literal|0
decl_stmt|;
name|u32
name|enabled_backends_mask
decl_stmt|;
name|u32
name|enabled_backends_count
decl_stmt|;
name|u32
name|cur_pipe
decl_stmt|;
name|u32
name|swizzle_pipe
index|[
name|R6XX_MAX_PIPES
index|]
decl_stmt|;
name|u32
name|cur_backend
decl_stmt|;
name|u32
name|i
decl_stmt|;
if|if
condition|(
name|num_tile_pipes
operator|>
name|R6XX_MAX_PIPES
condition|)
name|num_tile_pipes
operator|=
name|R6XX_MAX_PIPES
expr_stmt|;
if|if
condition|(
name|num_tile_pipes
operator|<
literal|1
condition|)
name|num_tile_pipes
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|num_backends
operator|>
name|R6XX_MAX_BACKENDS
condition|)
name|num_backends
operator|=
name|R6XX_MAX_BACKENDS
expr_stmt|;
if|if
condition|(
name|num_backends
operator|<
literal|1
condition|)
name|num_backends
operator|=
literal|1
expr_stmt|;
name|enabled_backends_mask
operator|=
literal|0
expr_stmt|;
name|enabled_backends_count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R6XX_MAX_BACKENDS
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|backend_disable_mask
operator|>>
name|i
operator|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|enabled_backends_mask
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
operator|++
name|enabled_backends_count
expr_stmt|;
block|}
if|if
condition|(
name|enabled_backends_count
operator|==
name|num_backends
condition|)
break|break;
block|}
if|if
condition|(
name|enabled_backends_count
operator|==
literal|0
condition|)
block|{
name|enabled_backends_mask
operator|=
literal|1
expr_stmt|;
name|enabled_backends_count
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|enabled_backends_count
operator|!=
name|num_backends
condition|)
name|num_backends
operator|=
name|enabled_backends_count
expr_stmt|;
name|memset
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|swizzle_pipe
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|*
name|R6XX_MAX_PIPES
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|num_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|3
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|5
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|5
index|]
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|6
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|5
index|]
operator|=
literal|3
expr_stmt|;
name|swizzle_pipe
index|[
literal|6
index|]
operator|=
literal|5
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|6
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|5
index|]
operator|=
literal|3
expr_stmt|;
name|swizzle_pipe
index|[
literal|6
index|]
operator|=
literal|5
expr_stmt|;
name|swizzle_pipe
index|[
literal|7
index|]
operator|=
literal|7
expr_stmt|;
break|break;
block|}
name|cur_backend
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cur_pipe
operator|=
literal|0
init|;
name|cur_pipe
operator|<
name|num_tile_pipes
condition|;
operator|++
name|cur_pipe
control|)
block|{
while|while
condition|(
operator|(
operator|(
literal|1
operator|<<
name|cur_backend
operator|)
operator|&
name|enabled_backends_mask
operator|)
operator|==
literal|0
condition|)
name|cur_backend
operator|=
operator|(
name|cur_backend
operator|+
literal|1
operator|)
operator|%
name|R6XX_MAX_BACKENDS
expr_stmt|;
name|backend_map
operator||=
call|(
name|u32
call|)
argument_list|(
operator|(
operator|(
name|cur_backend
operator|&
literal|3
operator|)
operator|<<
operator|(
name|swizzle_pipe
index|[
name|cur_pipe
index|]
operator|*
literal|2
operator|)
operator|)
argument_list|)
expr_stmt|;
name|cur_backend
operator|=
operator|(
name|cur_backend
operator|+
literal|1
operator|)
operator|%
name|R6XX_MAX_BACKENDS
expr_stmt|;
block|}
return|return
name|backend_map
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_count_pipe_bits
parameter_list|(
name|uint32_t
name|val
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|+=
name|val
operator|&
literal|1
expr_stmt|;
name|val
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_gfx_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|num_qd_pipes
decl_stmt|;
name|u32
name|sx_debug_1
decl_stmt|;
name|u32
name|tc_cntl
decl_stmt|;
name|u32
name|arb_pop
decl_stmt|;
name|u32
name|num_gs_verts_per_thread
decl_stmt|;
name|u32
name|vgt_gs_per_es
decl_stmt|;
name|u32
name|gs_prim_buffer_depth
init|=
literal|0
decl_stmt|;
name|u32
name|sq_ms_fifo_sizes
decl_stmt|;
name|u32
name|sq_config
decl_stmt|;
name|u32
name|sq_gpr_resource_mgmt_1
init|=
literal|0
decl_stmt|;
name|u32
name|sq_gpr_resource_mgmt_2
init|=
literal|0
decl_stmt|;
name|u32
name|sq_thread_resource_mgmt
init|=
literal|0
decl_stmt|;
name|u32
name|sq_stack_resource_mgmt_1
init|=
literal|0
decl_stmt|;
name|u32
name|sq_stack_resource_mgmt_2
init|=
literal|0
decl_stmt|;
name|u32
name|hdp_host_path_cntl
decl_stmt|;
name|u32
name|backend_map
decl_stmt|;
name|u32
name|gb_tiling_config
init|=
literal|0
decl_stmt|;
name|u32
name|cc_rb_backend_disable
init|=
literal|0
decl_stmt|;
name|u32
name|cc_gc_shader_pipe_config
init|=
literal|0
decl_stmt|;
name|u32
name|ramcfg
decl_stmt|;
comment|/* setup chip specs */
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_R600
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|192
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|CHIP_RV630
case|:
case|case
name|CHIP_RV635
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|3
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|192
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
case|case
name|CHIP_RV620
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|192
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|CHIP_RV670
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|192
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|192
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* Initialize HDP */
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|j
operator|+=
literal|0x18
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_CNTL
argument_list|,
name|R600_GRBM_READ_TIMEOUT
argument_list|(
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup tiling, simd, pipe config */
name|ramcfg
operator|=
name|RADEON_READ
argument_list|(
name|R600_RAMCFG
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|r600_max_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|gb_tiling_config
operator||=
name|R600_BANK_TILING
argument_list|(
operator|(
name|ramcfg
operator|>>
name|R600_NOOFBANK_SHIFT
operator|)
operator|&
name|R600_NOOFBANK_MASK
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_GROUP_SIZE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|ramcfg
operator|>>
name|R600_NOOFROWS_SHIFT
operator|)
operator|&
name|R600_NOOFROWS_MASK
operator|)
operator|>
literal|3
condition|)
block|{
name|gb_tiling_config
operator||=
name|R600_ROW_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_SAMPLE_SPLIT
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gb_tiling_config
operator||=
name|R600_ROW_TILING
argument_list|(
operator|(
operator|(
name|ramcfg
operator|>>
name|R600_NOOFROWS_SHIFT
operator|)
operator|&
name|R600_NOOFROWS_MASK
operator|)
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_SAMPLE_SPLIT
argument_list|(
operator|(
operator|(
name|ramcfg
operator|>>
name|R600_NOOFROWS_SHIFT
operator|)
operator|&
name|R600_NOOFROWS_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
name|gb_tiling_config
operator||=
name|R600_BANK_SWAPS
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|backend_map
operator|=
name|r600_get_tile_pipe_to_backend_map
argument_list|(
name|dev_priv
operator|->
name|r600_max_tile_pipes
argument_list|,
name|dev_priv
operator|->
name|r600_max_backends
argument_list|,
operator|(
literal|0xff
operator|<<
name|dev_priv
operator|->
name|r600_max_backends
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_BACKEND_MAP
argument_list|(
name|backend_map
argument_list|)
expr_stmt|;
name|cc_gc_shader_pipe_config
operator|=
name|R600_INACTIVE_QD_PIPES
argument_list|(
operator|(
name|R6XX_MAX_PIPES_MASK
operator|<<
name|dev_priv
operator|->
name|r600_max_pipes
operator|)
operator|&
name|R6XX_MAX_PIPES_MASK
argument_list|)
expr_stmt|;
name|cc_gc_shader_pipe_config
operator||=
name|R600_INACTIVE_SIMDS
argument_list|(
operator|(
name|R6XX_MAX_SIMDS_MASK
operator|<<
name|dev_priv
operator|->
name|r600_max_simds
operator|)
operator|&
name|R6XX_MAX_SIMDS_MASK
argument_list|)
expr_stmt|;
name|cc_rb_backend_disable
operator|=
name|R600_BACKEND_DISABLE
argument_list|(
operator|(
name|R6XX_MAX_BACKENDS_MASK
operator|<<
name|dev_priv
operator|->
name|r600_max_backends
operator|)
operator|&
name|R6XX_MAX_BACKENDS_MASK
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GB_TILING_CONFIG
argument_list|,
name|gb_tiling_config
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_DCP_TILING_CONFIG
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_HDP_TILING_CONFIG
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CC_RB_BACKEND_DISABLE
argument_list|,
name|cc_rb_backend_disable
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CC_GC_SHADER_PIPE_CONFIG
argument_list|,
name|cc_gc_shader_pipe_config
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GC_USER_SHADER_PIPE_CONFIG
argument_list|,
name|cc_gc_shader_pipe_config
argument_list|)
expr_stmt|;
name|num_qd_pipes
operator|=
name|R6XX_MAX_BACKENDS
operator|-
name|r600_count_pipe_bits
argument_list|(
name|cc_gc_shader_pipe_config
operator|&
name|R600_INACTIVE_QD_PIPES_MASK
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_OUT_DEALLOC_CNTL
argument_list|,
operator|(
name|num_qd_pipes
operator|*
literal|4
operator|)
operator|&
name|R600_DEALLOC_DIST_MASK
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_VERTEX_REUSE_BLOCK_CNTL
argument_list|,
operator|(
operator|(
name|num_qd_pipes
operator|*
literal|4
operator|)
operator|-
literal|2
operator|)
operator|&
name|R600_VTX_REUSE_DEPTH_MASK
argument_list|)
expr_stmt|;
comment|/* set HW defaults for 3D engine */
name|RADEON_WRITE
argument_list|(
name|R600_CP_QUEUE_THRESHOLDS
argument_list|,
operator|(
name|R600_ROQ_IB1_START
argument_list|(
literal|0x16
argument_list|)
operator||
name|R600_ROQ_IB2_START
argument_list|(
literal|0x2b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_MEQ_THRESHOLDS
argument_list|,
operator|(
name|R600_MEQ_END
argument_list|(
literal|0x40
argument_list|)
operator||
name|R600_ROQ_END
argument_list|(
literal|0x40
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_TA_CNTL_AUX
argument_list|,
operator|(
name|R600_DISABLE_CUBE_ANISO
operator||
name|R600_SYNC_GRADIENT
operator||
name|R600_SYNC_WALKER
operator||
name|R600_SYNC_ALIGNER
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV670
condition|)
name|RADEON_WRITE
argument_list|(
name|R600_ARB_GDEC_RD_CNTL
argument_list|,
literal|0x00000021
argument_list|)
expr_stmt|;
name|sx_debug_1
operator|=
name|RADEON_READ
argument_list|(
name|R600_SX_DEBUG_1
argument_list|)
expr_stmt|;
name|sx_debug_1
operator||=
name|R600_SMX_EVENT_RELEASE
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>
name|CHIP_R600
operator|)
condition|)
name|sx_debug_1
operator||=
name|R600_ENABLE_NEW_SMX_ADDRESS
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SX_DEBUG_1
argument_list|,
name|sx_debug_1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R600
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV630
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
name|RADEON_WRITE
argument_list|(
name|R600_DB_DEBUG
argument_list|,
name|R600_PREZ_MUST_WAIT_FOR_POSTZ_DONE
argument_list|)
expr_stmt|;
else|else
name|RADEON_WRITE
argument_list|(
name|R600_DB_DEBUG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_DB_WATERMARKS
argument_list|,
operator|(
name|R600_DEPTH_FREE
argument_list|(
literal|4
argument_list|)
operator||
name|R600_DEPTH_FLUSH
argument_list|(
literal|16
argument_list|)
operator||
name|R600_DEPTH_PENDING_FREE
argument_list|(
literal|4
argument_list|)
operator||
name|R600_DEPTH_CACHELINE_FREE
argument_list|(
literal|16
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_NUM_INSTANCES
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_CONFIG_CNTL
argument_list|,
name|R600_GPR_WRITE_PRIORITY
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_CONFIG_CNTL_1
argument_list|,
name|R600_VTX_DONE_DELAY
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|sq_ms_fifo_sizes
operator|=
name|RADEON_READ
argument_list|(
name|R600_SQ_MS_FIFO_SIZES
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
block|{
name|sq_ms_fifo_sizes
operator|=
operator|(
name|R600_CACHE_FIFO_SIZE
argument_list|(
literal|0xa
argument_list|)
operator||
name|R600_FETCH_FIFO_HIWATER
argument_list|(
literal|0xa
argument_list|)
operator||
name|R600_DONE_FIFO_HIWATER
argument_list|(
literal|0xe0
argument_list|)
operator||
name|R600_ALU_UPDATE_FIFO_HIWATER
argument_list|(
literal|0x8
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R600
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV630
operator|)
condition|)
block|{
name|sq_ms_fifo_sizes
operator|&=
operator|~
name|R600_DONE_FIFO_HIWATER
argument_list|(
literal|0xff
argument_list|)
expr_stmt|;
name|sq_ms_fifo_sizes
operator||=
name|R600_DONE_FIFO_HIWATER
argument_list|(
literal|0x4
argument_list|)
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_SQ_MS_FIFO_SIZES
argument_list|,
name|sq_ms_fifo_sizes
argument_list|)
expr_stmt|;
comment|/* SQ_CONFIG, SQ_GPR_RESOURCE_MGMT, SQ_THREAD_RESOURCE_MGMT, SQ_STACK_RESOURCE_MGMT 	 * should be adjusted as needed by the 2D/3D drivers.  This just sets default values 	 */
name|sq_config
operator|=
name|RADEON_READ
argument_list|(
name|R600_SQ_CONFIG
argument_list|)
expr_stmt|;
name|sq_config
operator|&=
operator|~
operator|(
name|R600_PS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|R600_VS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|R600_GS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|R600_ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
name|sq_config
operator||=
operator|(
name|R600_DX9_CONSTS
operator||
name|R600_VC_ENABLE
operator||
name|R600_PS_PRIO
argument_list|(
literal|0
argument_list|)
operator||
name|R600_VS_PRIO
argument_list|(
literal|1
argument_list|)
operator||
name|R600_GS_PRIO
argument_list|(
literal|2
argument_list|)
operator||
name|R600_ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R600
condition|)
block|{
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_GPRS
argument_list|(
literal|124
argument_list|)
operator||
name|R600_NUM_VS_GPRS
argument_list|(
literal|124
argument_list|)
operator||
name|R600_NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|4
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_GPRS
argument_list|(
literal|0
argument_list|)
operator||
name|R600_NUM_ES_GPRS
argument_list|(
literal|0
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|R600_NUM_PS_THREADS
argument_list|(
literal|136
argument_list|)
operator||
name|R600_NUM_VS_THREADS
argument_list|(
literal|48
argument_list|)
operator||
name|R600_NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|R600_NUM_ES_THREADS
argument_list|(
literal|4
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_STACK_ENTRIES
argument_list|(
literal|128
argument_list|)
operator||
name|R600_NUM_VS_STACK_ENTRIES
argument_list|(
literal|128
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_STACK_ENTRIES
argument_list|(
literal|0
argument_list|)
operator||
name|R600_NUM_ES_STACK_ENTRIES
argument_list|(
literal|0
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
block|{
comment|/* no vertex cache */
name|sq_config
operator|&=
operator|~
name|R600_VC_ENABLE
expr_stmt|;
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|R600_NUM_VS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|R600_NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_GPRS
argument_list|(
literal|17
argument_list|)
operator||
name|R600_NUM_ES_GPRS
argument_list|(
literal|17
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|R600_NUM_PS_THREADS
argument_list|(
literal|79
argument_list|)
operator||
name|R600_NUM_VS_THREADS
argument_list|(
literal|78
argument_list|)
operator||
name|R600_NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|R600_NUM_ES_THREADS
argument_list|(
literal|31
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator||
name|R600_NUM_VS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_STACK_ENTRIES
argument_list|(
literal|32
argument_list|)
operator||
name|R600_NUM_ES_STACK_ENTRIES
argument_list|(
literal|16
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV630
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV635
operator|)
condition|)
block|{
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|R600_NUM_VS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|R600_NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_GPRS
argument_list|(
literal|18
argument_list|)
operator||
name|R600_NUM_ES_GPRS
argument_list|(
literal|18
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|R600_NUM_PS_THREADS
argument_list|(
literal|79
argument_list|)
operator||
name|R600_NUM_VS_THREADS
argument_list|(
literal|78
argument_list|)
operator||
name|R600_NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|R600_NUM_ES_THREADS
argument_list|(
literal|31
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator||
name|R600_NUM_VS_STACK_ENTRIES
argument_list|(
literal|40
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_STACK_ENTRIES
argument_list|(
literal|32
argument_list|)
operator||
name|R600_NUM_ES_STACK_ENTRIES
argument_list|(
literal|16
argument_list|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV670
condition|)
block|{
name|sq_gpr_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|R600_NUM_VS_GPRS
argument_list|(
literal|44
argument_list|)
operator||
name|R600_NUM_CLAUSE_TEMP_GPRS
argument_list|(
literal|2
argument_list|)
operator|)
expr_stmt|;
name|sq_gpr_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_GPRS
argument_list|(
literal|17
argument_list|)
operator||
name|R600_NUM_ES_GPRS
argument_list|(
literal|17
argument_list|)
operator|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|R600_NUM_PS_THREADS
argument_list|(
literal|79
argument_list|)
operator||
name|R600_NUM_VS_THREADS
argument_list|(
literal|78
argument_list|)
operator||
name|R600_NUM_GS_THREADS
argument_list|(
literal|4
argument_list|)
operator||
name|R600_NUM_ES_THREADS
argument_list|(
literal|31
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_1
operator|=
operator|(
name|R600_NUM_PS_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator||
name|R600_NUM_VS_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator|)
expr_stmt|;
name|sq_stack_resource_mgmt_2
operator|=
operator|(
name|R600_NUM_GS_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator||
name|R600_NUM_ES_STACK_ENTRIES
argument_list|(
literal|64
argument_list|)
operator|)
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_SQ_CONFIG
argument_list|,
name|sq_config
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_GPR_RESOURCE_MGMT_1
argument_list|,
name|sq_gpr_resource_mgmt_1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_GPR_RESOURCE_MGMT_2
argument_list|,
name|sq_gpr_resource_mgmt_2
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_THREAD_RESOURCE_MGMT
argument_list|,
name|sq_thread_resource_mgmt
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_STACK_RESOURCE_MGMT_1
argument_list|,
name|sq_stack_resource_mgmt_1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_STACK_RESOURCE_MGMT_2
argument_list|,
name|sq_stack_resource_mgmt_2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV610
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV620
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS780
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS880
operator|)
condition|)
name|RADEON_WRITE
argument_list|(
name|R600_VGT_CACHE_INVALIDATION
argument_list|,
name|R600_CACHE_INVALIDATION
argument_list|(
name|R600_TC_ONLY
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|RADEON_WRITE
argument_list|(
name|R600_VGT_CACHE_INVALIDATION
argument_list|,
name|R600_CACHE_INVALIDATION
argument_list|(
name|R600_VC_AND_TC
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_AA_SAMPLE_LOCS_2S
argument_list|,
operator|(
name|R600_S0_X
argument_list|(
literal|0xc
argument_list|)
operator||
name|R600_S0_Y
argument_list|(
literal|0x4
argument_list|)
operator||
name|R600_S1_X
argument_list|(
literal|0x4
argument_list|)
operator||
name|R600_S1_Y
argument_list|(
literal|0xc
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_AA_SAMPLE_LOCS_4S
argument_list|,
operator|(
name|R600_S0_X
argument_list|(
literal|0xe
argument_list|)
operator||
name|R600_S0_Y
argument_list|(
literal|0xe
argument_list|)
operator||
name|R600_S1_X
argument_list|(
literal|0x2
argument_list|)
operator||
name|R600_S1_Y
argument_list|(
literal|0x2
argument_list|)
operator||
name|R600_S2_X
argument_list|(
literal|0xa
argument_list|)
operator||
name|R600_S2_Y
argument_list|(
literal|0x6
argument_list|)
operator||
name|R600_S3_X
argument_list|(
literal|0x6
argument_list|)
operator||
name|R600_S3_Y
argument_list|(
literal|0xa
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_AA_SAMPLE_LOCS_8S_WD0
argument_list|,
operator|(
name|R600_S0_X
argument_list|(
literal|0xe
argument_list|)
operator||
name|R600_S0_Y
argument_list|(
literal|0xb
argument_list|)
operator||
name|R600_S1_X
argument_list|(
literal|0x4
argument_list|)
operator||
name|R600_S1_Y
argument_list|(
literal|0xc
argument_list|)
operator||
name|R600_S2_X
argument_list|(
literal|0x1
argument_list|)
operator||
name|R600_S2_Y
argument_list|(
literal|0x6
argument_list|)
operator||
name|R600_S3_X
argument_list|(
literal|0xa
argument_list|)
operator||
name|R600_S3_Y
argument_list|(
literal|0xe
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_AA_SAMPLE_LOCS_8S_WD1
argument_list|,
operator|(
name|R600_S4_X
argument_list|(
literal|0x6
argument_list|)
operator||
name|R600_S4_Y
argument_list|(
literal|0x1
argument_list|)
operator||
name|R600_S5_X
argument_list|(
literal|0x0
argument_list|)
operator||
name|R600_S5_Y
argument_list|(
literal|0x0
argument_list|)
operator||
name|R600_S6_X
argument_list|(
literal|0xb
argument_list|)
operator||
name|R600_S6_Y
argument_list|(
literal|0x4
argument_list|)
operator||
name|R600_S7_X
argument_list|(
literal|0x7
argument_list|)
operator||
name|R600_S7_Y
argument_list|(
literal|0x8
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_R600
case|:
case|case
name|CHIP_RV630
case|:
case|case
name|CHIP_RV635
case|:
name|gs_prim_buffer_depth
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
case|case
name|CHIP_RV620
case|:
name|gs_prim_buffer_depth
operator|=
literal|32
expr_stmt|;
break|break;
case|case
name|CHIP_RV670
case|:
name|gs_prim_buffer_depth
operator|=
literal|128
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|num_gs_verts_per_thread
operator|=
name|dev_priv
operator|->
name|r600_max_pipes
operator|*
literal|16
expr_stmt|;
name|vgt_gs_per_es
operator|=
name|gs_prim_buffer_depth
operator|+
name|num_gs_verts_per_thread
expr_stmt|;
comment|/* Max value for this is 256 */
if|if
condition|(
name|vgt_gs_per_es
operator|>
literal|256
condition|)
name|vgt_gs_per_es
operator|=
literal|256
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_ES_PER_GS
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_GS_PER_ES
argument_list|,
name|vgt_gs_per_es
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_GS_PER_VS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_GS_VERTEX_REUSE
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* more default values. 2D/3D driver should adjust as needed */
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_LINE_STIPPLE_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_STRMOUT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SX_MISC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_MODE_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_AA_CONFIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_LINE_STIPPLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_INPUT_Z
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_PS_IN_CONTROL_0
argument_list|,
name|R600_NUM_INTERP
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR7_FRAG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear render buffer base addresses */
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR0_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR1_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR2_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR3_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR4_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR5_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR6_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR7_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_RV610
case|:
case|case
name|CHIP_RS780
case|:
case|case
name|CHIP_RS880
case|:
case|case
name|CHIP_RV620
case|:
name|tc_cntl
operator|=
name|R600_TC_L2_SIZE
argument_list|(
literal|8
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_RV630
case|:
case|case
name|CHIP_RV635
case|:
name|tc_cntl
operator|=
name|R600_TC_L2_SIZE
argument_list|(
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_R600
case|:
name|tc_cntl
operator|=
name|R600_TC_L2_SIZE
argument_list|(
literal|0
argument_list|)
operator||
name|R600_L2_DISABLE_LATE_HIT
expr_stmt|;
break|break;
default|default:
name|tc_cntl
operator|=
name|R600_TC_L2_SIZE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_TC_CNTL
argument_list|,
name|tc_cntl
argument_list|)
expr_stmt|;
name|hdp_host_path_cntl
operator|=
name|RADEON_READ
argument_list|(
name|R600_HDP_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_HDP_HOST_PATH_CNTL
argument_list|,
name|hdp_host_path_cntl
argument_list|)
expr_stmt|;
name|arb_pop
operator|=
name|RADEON_READ
argument_list|(
name|R600_ARB_POP
argument_list|)
expr_stmt|;
name|arb_pop
operator||=
name|R600_ENABLE_TC128
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_ARB_POP
argument_list|,
name|arb_pop
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_CL_ENHANCE
argument_list|,
operator|(
name|R600_CLIP_VTX_REORDER_ENA
operator||
name|R600_NUM_CLIP_SEQ
argument_list|(
literal|3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_ENHANCE
argument_list|,
name|R600_FORCE_EOV_MAX_CLK_CNT
argument_list|(
literal|4095
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|r700_get_tile_pipe_to_backend_map
parameter_list|(
name|u32
name|num_tile_pipes
parameter_list|,
name|u32
name|num_backends
parameter_list|,
name|u32
name|backend_disable_mask
parameter_list|)
block|{
name|u32
name|backend_map
init|=
literal|0
decl_stmt|;
name|u32
name|enabled_backends_mask
decl_stmt|;
name|u32
name|enabled_backends_count
decl_stmt|;
name|u32
name|cur_pipe
decl_stmt|;
name|u32
name|swizzle_pipe
index|[
name|R7XX_MAX_PIPES
index|]
decl_stmt|;
name|u32
name|cur_backend
decl_stmt|;
name|u32
name|i
decl_stmt|;
if|if
condition|(
name|num_tile_pipes
operator|>
name|R7XX_MAX_PIPES
condition|)
name|num_tile_pipes
operator|=
name|R7XX_MAX_PIPES
expr_stmt|;
if|if
condition|(
name|num_tile_pipes
operator|<
literal|1
condition|)
name|num_tile_pipes
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|num_backends
operator|>
name|R7XX_MAX_BACKENDS
condition|)
name|num_backends
operator|=
name|R7XX_MAX_BACKENDS
expr_stmt|;
if|if
condition|(
name|num_backends
operator|<
literal|1
condition|)
name|num_backends
operator|=
literal|1
expr_stmt|;
name|enabled_backends_mask
operator|=
literal|0
expr_stmt|;
name|enabled_backends_count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R7XX_MAX_BACKENDS
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|backend_disable_mask
operator|>>
name|i
operator|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|enabled_backends_mask
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
operator|++
name|enabled_backends_count
expr_stmt|;
block|}
if|if
condition|(
name|enabled_backends_count
operator|==
name|num_backends
condition|)
break|break;
block|}
if|if
condition|(
name|enabled_backends_count
operator|==
literal|0
condition|)
block|{
name|enabled_backends_mask
operator|=
literal|1
expr_stmt|;
name|enabled_backends_count
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|enabled_backends_count
operator|!=
name|num_backends
condition|)
name|num_backends
operator|=
name|enabled_backends_count
expr_stmt|;
name|memset
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|swizzle_pipe
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|*
name|R7XX_MAX_PIPES
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|num_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|3
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|5
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|3
expr_stmt|;
name|swizzle_pipe
index|[
literal|5
index|]
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|6
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|3
expr_stmt|;
name|swizzle_pipe
index|[
literal|5
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|6
index|]
operator|=
literal|5
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|swizzle_pipe
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|swizzle_pipe
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
name|swizzle_pipe
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
name|swizzle_pipe
index|[
literal|3
index|]
operator|=
literal|6
expr_stmt|;
name|swizzle_pipe
index|[
literal|4
index|]
operator|=
literal|3
expr_stmt|;
name|swizzle_pipe
index|[
literal|5
index|]
operator|=
literal|1
expr_stmt|;
name|swizzle_pipe
index|[
literal|6
index|]
operator|=
literal|7
expr_stmt|;
name|swizzle_pipe
index|[
literal|7
index|]
operator|=
literal|5
expr_stmt|;
break|break;
block|}
name|cur_backend
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|cur_pipe
operator|=
literal|0
init|;
name|cur_pipe
operator|<
name|num_tile_pipes
condition|;
operator|++
name|cur_pipe
control|)
block|{
while|while
condition|(
operator|(
operator|(
literal|1
operator|<<
name|cur_backend
operator|)
operator|&
name|enabled_backends_mask
operator|)
operator|==
literal|0
condition|)
name|cur_backend
operator|=
operator|(
name|cur_backend
operator|+
literal|1
operator|)
operator|%
name|R7XX_MAX_BACKENDS
expr_stmt|;
name|backend_map
operator||=
call|(
name|u32
call|)
argument_list|(
operator|(
operator|(
name|cur_backend
operator|&
literal|3
operator|)
operator|<<
operator|(
name|swizzle_pipe
index|[
name|cur_pipe
index|]
operator|*
literal|2
operator|)
operator|)
argument_list|)
expr_stmt|;
name|cur_backend
operator|=
operator|(
name|cur_backend
operator|+
literal|1
operator|)
operator|%
name|R7XX_MAX_BACKENDS
expr_stmt|;
block|}
return|return
name|backend_map
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r700_gfx_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|num_qd_pipes
decl_stmt|;
name|u32
name|sx_debug_1
decl_stmt|;
name|u32
name|smx_dc_ctl0
decl_stmt|;
name|u32
name|num_gs_verts_per_thread
decl_stmt|;
name|u32
name|vgt_gs_per_es
decl_stmt|;
name|u32
name|gs_prim_buffer_depth
init|=
literal|0
decl_stmt|;
name|u32
name|sq_ms_fifo_sizes
decl_stmt|;
name|u32
name|sq_config
decl_stmt|;
name|u32
name|sq_thread_resource_mgmt
decl_stmt|;
name|u32
name|hdp_host_path_cntl
decl_stmt|;
name|u32
name|sq_dyn_gpr_size_simd_ab_0
decl_stmt|;
name|u32
name|backend_map
decl_stmt|;
name|u32
name|gb_tiling_config
init|=
literal|0
decl_stmt|;
name|u32
name|cc_rb_backend_disable
init|=
literal|0
decl_stmt|;
name|u32
name|cc_gc_shader_pipe_config
init|=
literal|0
decl_stmt|;
name|u32
name|mc_arb_ramcfg
decl_stmt|;
name|u32
name|db_debug4
decl_stmt|;
comment|/* setup chip specs */
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_RV770
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|10
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|248
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|512
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|16
operator|*
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|112
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r700_sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_prim_fifo_size
operator|=
literal|0xF9
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
break|break;
case|case
name|CHIP_RV740
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|248
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|512
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|16
operator|*
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|32
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|224
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r700_sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_prim_fifo_size
operator|=
literal|0x100
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|>
literal|16
condition|)
block|{
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|-=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|+=
literal|16
expr_stmt|;
block|}
break|break;
case|case
name|CHIP_RV730
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|248
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|8
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|16
operator|*
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|32
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|224
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r700_sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_prim_fifo_size
operator|=
literal|0xf9
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|>
literal|16
condition|)
block|{
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|-=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|+=
literal|16
expr_stmt|;
block|}
break|break;
case|case
name|CHIP_RV710
case|:
name|dev_priv
operator|->
name|r600_max_pipes
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_tile_pipes
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_simds
operator|=
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_backends
operator|=
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gprs
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_threads
operator|=
literal|192
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|=
literal|256
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|=
literal|4
expr_stmt|;
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|=
literal|8
operator|*
literal|2
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|=
literal|128
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|=
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|=
literal|112
expr_stmt|;
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
operator|=
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|r700_sx_num_of_sets
operator|=
literal|7
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_prim_fifo_size
operator|=
literal|0x40
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_hiz_tile_fifo_size
operator|=
literal|0x30
expr_stmt|;
name|dev_priv
operator|->
name|r700_sc_earlyz_tile_fifo_fize
operator|=
literal|0x130
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* Initialize HDP */
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c14
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c18
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c1c
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c20
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
operator|(
literal|0x2c24
operator|+
name|j
operator|)
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|j
operator|+=
literal|0x18
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_CNTL
argument_list|,
name|R600_GRBM_READ_TIMEOUT
argument_list|(
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
comment|/* setup tiling, simd, pipe config */
name|mc_arb_ramcfg
operator|=
name|RADEON_READ
argument_list|(
name|R700_MC_ARB_RAMCFG
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|r600_max_tile_pipes
condition|)
block|{
case|case
literal|1
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|gb_tiling_config
operator||=
name|R600_PIPE_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV770
condition|)
name|gb_tiling_config
operator||=
name|R600_BANK_TILING
argument_list|(
literal|1
argument_list|)
expr_stmt|;
else|else
name|gb_tiling_config
operator||=
name|R600_BANK_TILING
argument_list|(
operator|(
name|mc_arb_ramcfg
operator|>>
name|R700_NOOFBANK_SHIFT
operator|)
operator|&
name|R700_NOOFBANK_MASK
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_GROUP_SIZE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mc_arb_ramcfg
operator|>>
name|R700_NOOFROWS_SHIFT
operator|)
operator|&
name|R700_NOOFROWS_MASK
operator|)
operator|>
literal|3
condition|)
block|{
name|gb_tiling_config
operator||=
name|R600_ROW_TILING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_SAMPLE_SPLIT
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gb_tiling_config
operator||=
name|R600_ROW_TILING
argument_list|(
operator|(
operator|(
name|mc_arb_ramcfg
operator|>>
name|R700_NOOFROWS_SHIFT
operator|)
operator|&
name|R700_NOOFROWS_MASK
operator|)
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_SAMPLE_SPLIT
argument_list|(
operator|(
operator|(
name|mc_arb_ramcfg
operator|>>
name|R700_NOOFROWS_SHIFT
operator|)
operator|&
name|R700_NOOFROWS_MASK
operator|)
argument_list|)
expr_stmt|;
block|}
name|gb_tiling_config
operator||=
name|R600_BANK_SWAPS
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|backend_map
operator|=
name|r700_get_tile_pipe_to_backend_map
argument_list|(
name|dev_priv
operator|->
name|r600_max_tile_pipes
argument_list|,
name|dev_priv
operator|->
name|r600_max_backends
argument_list|,
operator|(
literal|0xff
operator|<<
name|dev_priv
operator|->
name|r600_max_backends
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|gb_tiling_config
operator||=
name|R600_BACKEND_MAP
argument_list|(
name|backend_map
argument_list|)
expr_stmt|;
name|cc_gc_shader_pipe_config
operator|=
name|R600_INACTIVE_QD_PIPES
argument_list|(
operator|(
name|R7XX_MAX_PIPES_MASK
operator|<<
name|dev_priv
operator|->
name|r600_max_pipes
operator|)
operator|&
name|R7XX_MAX_PIPES_MASK
argument_list|)
expr_stmt|;
name|cc_gc_shader_pipe_config
operator||=
name|R600_INACTIVE_SIMDS
argument_list|(
operator|(
name|R7XX_MAX_SIMDS_MASK
operator|<<
name|dev_priv
operator|->
name|r600_max_simds
operator|)
operator|&
name|R7XX_MAX_SIMDS_MASK
argument_list|)
expr_stmt|;
name|cc_rb_backend_disable
operator|=
name|R600_BACKEND_DISABLE
argument_list|(
operator|(
name|R7XX_MAX_BACKENDS_MASK
operator|<<
name|dev_priv
operator|->
name|r600_max_backends
operator|)
operator|&
name|R7XX_MAX_BACKENDS_MASK
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GB_TILING_CONFIG
argument_list|,
name|gb_tiling_config
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_DCP_TILING_CONFIG
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_HDP_TILING_CONFIG
argument_list|,
operator|(
name|gb_tiling_config
operator|&
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CC_RB_BACKEND_DISABLE
argument_list|,
name|cc_rb_backend_disable
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CC_GC_SHADER_PIPE_CONFIG
argument_list|,
name|cc_gc_shader_pipe_config
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GC_USER_SHADER_PIPE_CONFIG
argument_list|,
name|cc_gc_shader_pipe_config
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_CC_SYS_RB_BACKEND_DISABLE
argument_list|,
name|cc_rb_backend_disable
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_CGTS_SYS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_CGTS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_CGTS_USER_SYS_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_CGTS_USER_TCC_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|num_qd_pipes
operator|=
name|R7XX_MAX_BACKENDS
operator|-
name|r600_count_pipe_bits
argument_list|(
name|cc_gc_shader_pipe_config
operator|&
name|R600_INACTIVE_QD_PIPES_MASK
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_OUT_DEALLOC_CNTL
argument_list|,
operator|(
name|num_qd_pipes
operator|*
literal|4
operator|)
operator|&
name|R600_DEALLOC_DIST_MASK
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_VERTEX_REUSE_BLOCK_CNTL
argument_list|,
operator|(
operator|(
name|num_qd_pipes
operator|*
literal|4
operator|)
operator|-
literal|2
operator|)
operator|&
name|R600_VTX_REUSE_DEPTH_MASK
argument_list|)
expr_stmt|;
comment|/* set HW defaults for 3D engine */
name|RADEON_WRITE
argument_list|(
name|R600_CP_QUEUE_THRESHOLDS
argument_list|,
operator|(
name|R600_ROQ_IB1_START
argument_list|(
literal|0x16
argument_list|)
operator||
name|R600_ROQ_IB2_START
argument_list|(
literal|0x2b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_MEQ_THRESHOLDS
argument_list|,
name|R700_STQ_SPLIT
argument_list|(
literal|0x30
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_TA_CNTL_AUX
argument_list|,
operator|(
name|R600_DISABLE_CUBE_ANISO
operator||
name|R600_SYNC_GRADIENT
operator||
name|R600_SYNC_WALKER
operator||
name|R600_SYNC_ALIGNER
operator|)
argument_list|)
expr_stmt|;
name|sx_debug_1
operator|=
name|RADEON_READ
argument_list|(
name|R700_SX_DEBUG_1
argument_list|)
expr_stmt|;
name|sx_debug_1
operator||=
name|R700_ENABLE_NEW_SMX_ADDRESS
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SX_DEBUG_1
argument_list|,
name|sx_debug_1
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|=
name|RADEON_READ
argument_list|(
name|R600_SMX_DC_CTL0
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator|&=
operator|~
name|R700_CACHE_DEPTH
argument_list|(
literal|0x1ff
argument_list|)
expr_stmt|;
name|smx_dc_ctl0
operator||=
name|R700_CACHE_DEPTH
argument_list|(
operator|(
name|dev_priv
operator|->
name|r700_sx_num_of_sets
operator|*
literal|64
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SMX_DC_CTL0
argument_list|,
name|smx_dc_ctl0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SMX_EVENT_CTL
argument_list|,
operator|(
name|R700_ES_FLUSH_CTL
argument_list|(
literal|4
argument_list|)
operator||
name|R700_GS_FLUSH_CTL
argument_list|(
literal|4
argument_list|)
operator||
name|R700_ACK_FLUSH_CTL
argument_list|(
literal|3
argument_list|)
operator||
name|R700_SYNC_FLUSH_CTL
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV770
condition|)
name|RADEON_WRITE
argument_list|(
name|R700_DB_DEBUG3
argument_list|,
name|R700_DB_CLK_OFF_DELAY
argument_list|(
literal|0x1f
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|db_debug4
operator|=
name|RADEON_READ
argument_list|(
name|RV700_DB_DEBUG4
argument_list|)
expr_stmt|;
name|db_debug4
operator||=
name|RV700_DISABLE_TILE_COVERED_FOR_PS_ITER
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RV700_DB_DEBUG4
argument_list|,
name|db_debug4
argument_list|)
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_SX_EXPORT_BUFFER_SIZES
argument_list|,
operator|(
name|R600_COLOR_BUFFER_SIZE
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_sx_max_export_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|R600_POSITION_BUFFER_SIZE
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_sx_max_export_pos_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator||
name|R600_SMX_BUFFER_SIZE
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_sx_max_export_smx_size
operator|/
literal|4
operator|)
operator|-
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_PA_SC_FIFO_SIZE_R7XX
argument_list|,
operator|(
name|R700_SC_PRIM_FIFO_SIZE
argument_list|(
name|dev_priv
operator|->
name|r700_sc_prim_fifo_size
argument_list|)
operator||
name|R700_SC_HIZ_TILE_FIFO_SIZE
argument_list|(
name|dev_priv
operator|->
name|r700_sc_hiz_tile_fifo_size
argument_list|)
operator||
name|R700_SC_EARLYZ_TILE_FIFO_SIZE
argument_list|(
name|dev_priv
operator|->
name|r700_sc_earlyz_tile_fifo_fize
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_NUM_INSTANCES
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_CONFIG_CNTL
argument_list|,
name|R600_GPR_WRITE_PRIORITY
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_CONFIG_CNTL_1
argument_list|,
name|R600_VTX_DONE_DELAY
argument_list|(
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_PERFMON_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sq_ms_fifo_sizes
operator|=
operator|(
name|R600_CACHE_FIFO_SIZE
argument_list|(
literal|16
operator|*
name|dev_priv
operator|->
name|r600_sq_num_cf_insts
argument_list|)
operator||
name|R600_DONE_FIFO_HIWATER
argument_list|(
literal|0xe0
argument_list|)
operator||
name|R600_ALU_UPDATE_FIFO_HIWATER
argument_list|(
literal|0x8
argument_list|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_RV770
case|:
name|sq_ms_fifo_sizes
operator||=
name|R600_FETCH_FIFO_HIWATER
argument_list|(
literal|0x1
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHIP_RV740
case|:
case|case
name|CHIP_RV730
case|:
case|case
name|CHIP_RV710
case|:
default|default:
name|sq_ms_fifo_sizes
operator||=
name|R600_FETCH_FIFO_HIWATER
argument_list|(
literal|0x4
argument_list|)
expr_stmt|;
break|break;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_SQ_MS_FIFO_SIZES
argument_list|,
name|sq_ms_fifo_sizes
argument_list|)
expr_stmt|;
comment|/* SQ_CONFIG, SQ_GPR_RESOURCE_MGMT, SQ_THREAD_RESOURCE_MGMT, SQ_STACK_RESOURCE_MGMT 	 * should be adjusted as needed by the 2D/3D drivers.  This just sets default values 	 */
name|sq_config
operator|=
name|RADEON_READ
argument_list|(
name|R600_SQ_CONFIG
argument_list|)
expr_stmt|;
name|sq_config
operator|&=
operator|~
operator|(
name|R600_PS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|R600_VS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|R600_GS_PRIO
argument_list|(
literal|3
argument_list|)
operator||
name|R600_ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
name|sq_config
operator||=
operator|(
name|R600_DX9_CONSTS
operator||
name|R600_VC_ENABLE
operator||
name|R600_EXPORT_SRC_C
operator||
name|R600_PS_PRIO
argument_list|(
literal|0
argument_list|)
operator||
name|R600_VS_PRIO
argument_list|(
literal|1
argument_list|)
operator||
name|R600_GS_PRIO
argument_list|(
literal|2
argument_list|)
operator||
name|R600_ES_PRIO
argument_list|(
literal|3
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV710
condition|)
comment|/* no vertex cache */
name|sq_config
operator|&=
operator|~
name|R600_VC_ENABLE
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_CONFIG
argument_list|,
name|sq_config
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_GPR_RESOURCE_MGMT_1
argument_list|,
operator|(
name|R600_NUM_PS_GPRS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|24
operator|)
operator|/
literal|64
argument_list|)
operator||
name|R600_NUM_VS_GPRS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|24
operator|)
operator|/
literal|64
argument_list|)
operator||
name|R600_NUM_CLAUSE_TEMP_GPRS
argument_list|(
operator|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|24
operator|)
operator|/
literal|64
operator|)
operator|/
literal|2
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_GPR_RESOURCE_MGMT_2
argument_list|,
operator|(
name|R600_NUM_GS_GPRS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|7
operator|)
operator|/
literal|64
argument_list|)
operator||
name|R600_NUM_ES_GPRS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|7
operator|)
operator|/
literal|64
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sq_thread_resource_mgmt
operator|=
operator|(
name|R600_NUM_PS_THREADS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_threads
operator|*
literal|4
operator|)
operator|/
literal|8
argument_list|)
operator||
name|R600_NUM_VS_THREADS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_threads
operator|*
literal|2
operator|)
operator|/
literal|8
argument_list|)
operator||
name|R600_NUM_ES_THREADS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_threads
operator|*
literal|1
operator|)
operator|/
literal|8
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|r600_max_threads
operator|*
literal|1
operator|)
operator|/
literal|8
operator|)
operator|>
name|dev_priv
operator|->
name|r600_max_gs_threads
condition|)
name|sq_thread_resource_mgmt
operator||=
name|R600_NUM_GS_THREADS
argument_list|(
name|dev_priv
operator|->
name|r600_max_gs_threads
argument_list|)
expr_stmt|;
else|else
name|sq_thread_resource_mgmt
operator||=
name|R600_NUM_GS_THREADS
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gs_threads
operator|*
literal|1
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_THREAD_RESOURCE_MGMT
argument_list|,
name|sq_thread_resource_mgmt
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_STACK_RESOURCE_MGMT_1
argument_list|,
operator|(
name|R600_NUM_PS_STACK_ENTRIES
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator||
name|R600_NUM_VS_STACK_ENTRIES
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SQ_STACK_RESOURCE_MGMT_2
argument_list|,
operator|(
name|R600_NUM_GS_STACK_ENTRIES
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator||
name|R600_NUM_ES_STACK_ENTRIES
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_stack_entries
operator|*
literal|1
operator|)
operator|/
literal|4
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sq_dyn_gpr_size_simd_ab_0
operator|=
operator|(
name|R700_SIMDA_RING0
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator||
name|R700_SIMDA_RING1
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator||
name|R700_SIMDB_RING0
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator||
name|R700_SIMDB_RING1
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_gprs
operator|*
literal|38
operator|)
operator|/
literal|64
argument_list|)
operator|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_0
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_1
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_2
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_3
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_4
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_5
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_6
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_SQ_DYN_GPR_SIZE_SIMD_AB_7
argument_list|,
name|sq_dyn_gpr_size_simd_ab_0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_PA_SC_FORCE_EOV_MAX_CNTS
argument_list|,
operator|(
name|R700_FORCE_EOV_MAX_CLK_CNT
argument_list|(
literal|4095
argument_list|)
operator||
name|R700_FORCE_EOV_MAX_REZ_CNT
argument_list|(
literal|255
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV710
condition|)
name|RADEON_WRITE
argument_list|(
name|R600_VGT_CACHE_INVALIDATION
argument_list|,
operator|(
name|R600_CACHE_INVALIDATION
argument_list|(
name|R600_TC_ONLY
argument_list|)
operator||
name|R700_AUTO_INVLD_EN
argument_list|(
name|R700_ES_AND_GS_AUTO
argument_list|)
operator|)
argument_list|)
expr_stmt|;
else|else
name|RADEON_WRITE
argument_list|(
name|R600_VGT_CACHE_INVALIDATION
argument_list|,
operator|(
name|R600_CACHE_INVALIDATION
argument_list|(
name|R600_VC_AND_TC
argument_list|)
operator||
name|R700_AUTO_INVLD_EN
argument_list|(
name|R700_ES_AND_GS_AUTO
argument_list|)
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_RV770
case|:
case|case
name|CHIP_RV740
case|:
case|case
name|CHIP_RV730
case|:
name|gs_prim_buffer_depth
operator|=
literal|384
expr_stmt|;
break|break;
case|case
name|CHIP_RV710
case|:
name|gs_prim_buffer_depth
operator|=
literal|128
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|num_gs_verts_per_thread
operator|=
name|dev_priv
operator|->
name|r600_max_pipes
operator|*
literal|16
expr_stmt|;
name|vgt_gs_per_es
operator|=
name|gs_prim_buffer_depth
operator|+
name|num_gs_verts_per_thread
expr_stmt|;
comment|/* Max value for this is 256 */
if|if
condition|(
name|vgt_gs_per_es
operator|>
literal|256
condition|)
name|vgt_gs_per_es
operator|=
literal|256
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_ES_PER_GS
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_GS_PER_ES
argument_list|,
name|vgt_gs_per_es
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_GS_PER_VS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* more default values. 2D/3D driver should adjust as needed */
name|RADEON_WRITE
argument_list|(
name|R600_VGT_GS_VERTEX_REUSE
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_LINE_STIPPLE_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_VGT_STRMOUT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SX_MISC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_MODE_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_PA_SC_EDGERULE
argument_list|,
literal|0xaaaaaaaa
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_AA_CONFIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_CLIPRECT_RULE
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_LINE_STIPPLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_INPUT_Z
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SPI_PS_IN_CONTROL_0
argument_list|,
name|R600_NUM_INTERP
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR7_FRAG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear render buffer base addresses */
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR0_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR1_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR2_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR3_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR4_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR5_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR6_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CB_COLOR7_BASE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R700_TCP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hdp_host_path_cntl
operator|=
name|RADEON_READ
argument_list|(
name|R600_HDP_HOST_PATH_CNTL
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_HDP_HOST_PATH_CNTL
argument_list|,
name|hdp_host_path_cntl
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_SC_MULTI_CHIP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_PA_CL_ENHANCE
argument_list|,
operator|(
name|R600_CLIP_VTX_REORDER_ENA
operator||
name|R600_NUM_CLIP_SEQ
argument_list|(
literal|3
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_cp_init_ring_buffer
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|u32
name|ring_start
decl_stmt|;
name|u64
name|rptr_addr
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
operator|)
condition|)
name|r700_gfx_init
argument_list|(
name|dev
argument_list|,
name|dev_priv
argument_list|)
expr_stmt|;
else|else
name|r600_gfx_init
argument_list|(
name|dev
argument_list|,
name|dev_priv
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
name|R600_SOFT_RESET_CP
argument_list|)
expr_stmt|;
name|RADEON_READ
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|15000
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_GRBM_SOFT_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set ring buffer size */
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|RADEON_BUF_SWAP_32BIT
operator||
name|RADEON_RB_NO_UPDATE
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
else|#
directive|else
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|RADEON_RB_NO_UPDATE
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|RADEON_WRITE
argument_list|(
name|R600_CP_SEM_WAIT_TIMER
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
comment|/* Set the write pointer delay */
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|RADEON_BUF_SWAP_32BIT
operator||
name|RADEON_RB_NO_UPDATE
operator||
name|RADEON_RB_RPTR_WR_ENA
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
else|#
directive|else
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|RADEON_RB_NO_UPDATE
operator||
name|RADEON_RB_RPTR_WR_ENA
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Initialize the ring buffer's read and write pointers */
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_RPTR_WR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_WPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SET_RING_HEAD
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|rptr_addr
operator|=
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|offset
operator|-
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|dev_priv
operator|->
name|gart_vm_start
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|rptr_addr
operator|=
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|offset
operator|-
operator|(
operator|(
name|unsigned
name|long
operator|)
name|dev
operator|->
name|sg
operator|->
name|virtual
operator|)
operator|+
name|dev_priv
operator|->
name|gart_vm_start
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_RPTR_ADDR
argument_list|,
name|rptr_addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_RPTR_ADDR_HI
argument_list|,
name|upper_32_bits
argument_list|(
name|rptr_addr
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
name|RADEON_BUF_SWAP_32BIT
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
else|#
directive|else
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_CNTL
argument_list|,
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
comment|/* XXX */
name|radeon_write_agp_base
argument_list|(
name|dev_priv
argument_list|,
name|dev
operator|->
name|agp
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* XXX */
name|radeon_write_agp_location
argument_list|(
name|dev_priv
argument_list|,
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|-
literal|1
operator|+
name|dev_priv
operator|->
name|gart_size
operator|)
operator|&
literal|0xffff0000
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ring_start
operator|=
operator|(
name|dev_priv
operator|->
name|cp_ring
operator|->
name|offset
operator|-
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|ring_start
operator|=
operator|(
name|dev_priv
operator|->
name|cp_ring
operator|->
name|offset
operator|-
operator|(
name|unsigned
name|long
operator|)
name|dev
operator|->
name|sg
operator|->
name|virtual
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_BASE
argument_list|,
name|ring_start
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_CNTL
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_DEBUG
argument_list|,
operator|(
literal|1
operator|<<
literal|27
operator|)
operator||
operator|(
literal|1
operator|<<
literal|28
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize the scratch register pointer.  This will cause 	 * the scratch register values to be written out to memory 	 * whenever they are updated. 	 * 	 * We simply put this behind the ring read pointer, this works 	 * with PCI GART as well as (whatever kind of) AGP GART 	 */
block|{
name|u64
name|scratch_addr
decl_stmt|;
name|scratch_addr
operator|=
name|RADEON_READ
argument_list|(
name|R600_CP_RB_RPTR_ADDR
argument_list|)
expr_stmt|;
name|scratch_addr
operator||=
operator|(
operator|(
name|u64
operator|)
name|RADEON_READ
argument_list|(
name|R600_CP_RB_RPTR_ADDR_HI
argument_list|)
operator|)
operator|<<
literal|32
expr_stmt|;
name|scratch_addr
operator|+=
name|R600_SCRATCH_REG_OFFSET
expr_stmt|;
name|scratch_addr
operator|>>=
literal|8
expr_stmt|;
name|scratch_addr
operator|&=
literal|0xffffffff
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_SCRATCH_ADDR
argument_list|,
operator|(
name|uint32_t
operator|)
name|scratch_addr
argument_list|)
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R600_SCRATCH_UMSK
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
comment|/* Turn on bus mastering */
name|radeon_enable_bm
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|radeon_write_ring_rptr
argument_list|(
name|dev_priv
argument_list|,
name|R600_SCRATCHOFF
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_LAST_FRAME_REG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_write_ring_rptr
argument_list|(
name|dev_priv
argument_list|,
name|R600_SCRATCHOFF
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_LAST_DISPATCH_REG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|radeon_write_ring_rptr
argument_list|(
name|dev_priv
argument_list|,
name|R600_SCRATCHOFF
argument_list|(
literal|2
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_LAST_CLEAR_REG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reset sarea copies of these */
if|if
condition|(
name|dev_priv
operator|->
name|sarea_priv
condition|)
block|{
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|=
literal|0
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|=
literal|0
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_clear
operator|=
literal|0
expr_stmt|;
block|}
name|r600_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_do_cleanup_cp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Make sure interrupts are disabled here because the uninstall ioctl 	 * may not have been called from userspace and after dev_private 	 * is freed, it's too late. 	 */
if|if
condition|(
name|dev
operator|->
name|irq_enabled
condition|)
name|drm_irq_uninstall
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
if|if
condition|(
name|dev_priv
operator|->
name|cp_ring
operator|!=
name|NULL
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
name|dev_priv
operator|->
name|cp_ring
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cp_ring
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dev_priv
operator|->
name|ring_rptr
operator|!=
name|NULL
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring_rptr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dev
operator|->
name|agp_buffer_map
operator|!=
name|NULL
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
name|dev
operator|->
name|agp_buffer_map
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev
operator|->
name|agp_buffer_map
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
condition|)
name|r600_page_table_cleanup
argument_list|(
name|dev
argument_list|,
operator|&
name|dev_priv
operator|->
name|gart_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_table_location
operator|==
name|DRM_ATI_GART_FB
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
operator|&
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|addr
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* only clear to the start of flags */
name|memset
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|,
name|offsetof
argument_list|(
name|drm_radeon_private_t
argument_list|,
name|flags
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r600_do_init_cp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_radeon_init_t
modifier|*
name|init
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* if we require new memory map but we don't have it fail */
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_NEW_MEMMAP
operator|)
operator|&&
operator|!
name|dev_priv
operator|->
name|new_memmap
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Cannot initialise DRM on this card\nThis card requires a new X.org DDX for 3D\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|init
operator|->
name|is_pci
operator|&&
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"Forcing AGP card to PCI mode\n"
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|flags
operator|&=
operator|~
name|RADEON_IS_AGP
expr_stmt|;
comment|/* The writeback test succeeds, but when writeback is enabled, 		 * the ring buffer read ptr update fails after first 128 bytes. 		 */
name|radeon_no_wb
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|dev_priv
operator|->
name|flags
operator|&
operator|(
name|RADEON_IS_AGP
operator||
name|RADEON_IS_PCI
operator||
name|RADEON_IS_PCIE
operator|)
operator|)
operator|&&
operator|!
name|init
operator|->
name|is_pci
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"Restoring AGP flag\n"
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|flags
operator||=
name|RADEON_IS_AGP
expr_stmt|;
block|}
name|dev_priv
operator|->
name|usec_timeout
operator|=
name|init
operator|->
name|usec_timeout
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|usec_timeout
operator|<
literal|1
operator|||
name|dev_priv
operator|->
name|usec_timeout
operator|>
name|RADEON_MAX_USEC_TIMEOUT
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"TIMEOUT problem!\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Enable vblank on CRTC1 for older X servers 	 */
name|dev_priv
operator|->
name|vblank_crtc
operator|=
name|DRM_RADEON_VBLANK_CRTC1
expr_stmt|;
name|dev_priv
operator|->
name|do_boxes
operator|=
literal|0
expr_stmt|;
name|dev_priv
operator|->
name|cp_mode
operator|=
name|init
operator|->
name|cp_mode
expr_stmt|;
comment|/* We don't support anything other than bus-mastering ring mode, 	 * but the ring can be in either AGP or PCI space for the ring 	 * read pointer. 	 */
if|if
condition|(
operator|(
name|init
operator|->
name|cp_mode
operator|!=
name|RADEON_CSQ_PRIBM_INDDIS
operator|)
operator|&&
operator|(
name|init
operator|->
name|cp_mode
operator|!=
name|RADEON_CSQ_PRIBM_INDBM
operator|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"BAD cp_mode (%x)!\n"
argument_list|,
name|init
operator|->
name|cp_mode
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|init
operator|->
name|fb_bpp
condition|)
block|{
case|case
literal|16
case|:
name|dev_priv
operator|->
name|color_fmt
operator|=
name|RADEON_COLOR_FORMAT_RGB565
expr_stmt|;
break|break;
case|case
literal|32
case|:
default|default:
name|dev_priv
operator|->
name|color_fmt
operator|=
name|RADEON_COLOR_FORMAT_ARGB8888
expr_stmt|;
break|break;
block|}
name|dev_priv
operator|->
name|front_offset
operator|=
name|init
operator|->
name|front_offset
expr_stmt|;
name|dev_priv
operator|->
name|front_pitch
operator|=
name|init
operator|->
name|front_pitch
expr_stmt|;
name|dev_priv
operator|->
name|back_offset
operator|=
name|init
operator|->
name|back_offset
expr_stmt|;
name|dev_priv
operator|->
name|back_pitch
operator|=
name|init
operator|->
name|back_pitch
expr_stmt|;
name|dev_priv
operator|->
name|ring_offset
operator|=
name|init
operator|->
name|ring_offset
expr_stmt|;
name|dev_priv
operator|->
name|ring_rptr_offset
operator|=
name|init
operator|->
name|ring_rptr_offset
expr_stmt|;
name|dev_priv
operator|->
name|buffers_offset
operator|=
name|init
operator|->
name|buffers_offset
expr_stmt|;
name|dev_priv
operator|->
name|gart_textures_offset
operator|=
name|init
operator|->
name|gart_textures_offset
expr_stmt|;
name|dev_priv
operator|->
name|sarea
operator|=
name|drm_getsarea
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|sarea
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find sarea!\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev_priv
operator|->
name|cp_ring
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|ring_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|cp_ring
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find cp ring region!\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev_priv
operator|->
name|ring_rptr
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|ring_rptr_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|ring_rptr
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find ring read pointer!\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev
operator|->
name|agp_buffer_token
operator|=
name|init
operator|->
name|buffers_offset
expr_stmt|;
name|dev
operator|->
name|agp_buffer_map
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|buffers_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|agp_buffer_map
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find dma buffer region!\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|init
operator|->
name|gart_textures_offset
condition|)
block|{
name|dev_priv
operator|->
name|gart_textures
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|gart_textures_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|gart_textures
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find GART texture region!\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|=
operator|(
name|drm_radeon_sarea_t
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|dev_priv
operator|->
name|sarea
operator|->
name|handle
operator|+
name|init
operator|->
name|sarea_priv_offset
operator|)
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
comment|/* XXX */
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|drm_core_ioremap_wc
argument_list|(
name|dev_priv
operator|->
name|cp_ring
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|drm_core_ioremap_wc
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|drm_core_ioremap_wc
argument_list|(
name|dev
operator|->
name|agp_buffer_map
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
operator|||
operator|!
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
operator|||
operator|!
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find ioremap agp regions!\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
operator|->
name|cp_ring
operator|->
name|offset
expr_stmt|;
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|offset
expr_stmt|;
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|offset
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->cp_ring->handle %p\n"
argument_list|,
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->ring_rptr->handle %p\n"
argument_list|,
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev->agp_buffer_map->handle %p\n"
argument_list|,
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
argument_list|)
expr_stmt|;
block|}
name|dev_priv
operator|->
name|fb_location
operator|=
operator|(
name|radeon_read_fb_location
argument_list|(
name|dev_priv
argument_list|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|24
expr_stmt|;
name|dev_priv
operator|->
name|fb_size
operator|=
operator|(
operator|(
operator|(
name|radeon_read_fb_location
argument_list|(
name|dev_priv
argument_list|)
operator|&
literal|0xffff0000u
operator|)
operator|<<
literal|8
operator|)
operator|+
literal|0x1000000
operator|)
operator|-
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
name|dev_priv
operator|->
name|front_pitch_offset
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|front_pitch
operator|/
literal|64
operator|)
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
name|dev_priv
operator|->
name|front_offset
operator|+
name|dev_priv
operator|->
name|fb_location
operator|)
operator|>>
literal|10
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|back_pitch_offset
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|back_pitch
operator|/
literal|64
operator|)
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
name|dev_priv
operator|->
name|back_offset
operator|+
name|dev_priv
operator|->
name|fb_location
operator|)
operator|>>
literal|10
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|depth_pitch_offset
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|depth_pitch
operator|/
literal|64
operator|)
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
name|dev_priv
operator|->
name|depth_offset
operator|+
name|dev_priv
operator|->
name|fb_location
operator|)
operator|>>
literal|10
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_size
operator|=
name|init
operator|->
name|gart_size
expr_stmt|;
comment|/* New let's set the memory map ... */
if|if
condition|(
name|dev_priv
operator|->
name|new_memmap
condition|)
block|{
name|u32
name|base
init|=
literal|0
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"Setting GART location based on new memory map\n"
argument_list|)
expr_stmt|;
comment|/* If using AGP, try to locate the AGP aperture at the same 		 * location in the card and on the bus, though we have to 		 * align it down. 		 */
if|#
directive|if
name|__OS_HAS_AGP
comment|/* XXX */
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|base
operator|=
name|dev
operator|->
name|agp
operator|->
name|base
expr_stmt|;
comment|/* Check if valid */
if|if
condition|(
operator|(
name|base
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
operator|)
operator|>=
name|dev_priv
operator|->
name|fb_location
operator|&&
name|base
operator|<
operator|(
name|dev_priv
operator|->
name|fb_location
operator|+
name|dev_priv
operator|->
name|fb_size
operator|-
literal|1
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Can't use AGP base @0x%08lx, won't fit\n"
argument_list|,
name|dev
operator|->
name|agp
operator|->
name|base
argument_list|)
expr_stmt|;
name|base
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* If not or if AGP is at 0 (Macs), try to put it elsewhere */
if|if
condition|(
name|base
operator|==
literal|0
condition|)
block|{
name|base
operator|=
name|dev_priv
operator|->
name|fb_location
operator|+
name|dev_priv
operator|->
name|fb_size
expr_stmt|;
if|if
condition|(
name|base
operator|<
name|dev_priv
operator|->
name|fb_location
operator|||
operator|(
operator|(
name|base
operator|+
name|dev_priv
operator|->
name|gart_size
operator|)
operator|&
literal|0xfffffffful
operator|)
operator|<
name|base
condition|)
name|base
operator|=
name|dev_priv
operator|->
name|fb_location
operator|-
name|dev_priv
operator|->
name|gart_size
expr_stmt|;
block|}
name|dev_priv
operator|->
name|gart_vm_start
operator|=
name|base
operator|&
literal|0xffc00000u
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|gart_vm_start
operator|!=
name|base
condition|)
name|DRM_INFO
argument_list|(
literal|"GART aligned down from 0x%08x to 0x%08x\n"
argument_list|,
name|base
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|__OS_HAS_AGP
comment|/* XXX */
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
name|dev_priv
operator|->
name|gart_buffers_offset
operator|=
operator|(
name|dev
operator|->
name|agp_buffer_map
operator|->
name|offset
operator|-
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
else|else
endif|#
directive|endif
name|dev_priv
operator|->
name|gart_buffers_offset
operator|=
operator|(
name|dev
operator|->
name|agp_buffer_map
operator|->
name|offset
operator|-
operator|(
name|unsigned
name|long
operator|)
name|dev
operator|->
name|sg
operator|->
name|virtual
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"fb 0x%08x size %d\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|dev_priv
operator|->
name|fb_location
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|dev_priv
operator|->
name|fb_size
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->gart_size %d\n"
argument_list|,
name|dev_priv
operator|->
name|gart_size
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->gart_vm_start 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->gart_buffers_offset 0x%08lx\n"
argument_list|,
name|dev_priv
operator|->
name|gart_buffers_offset
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|start
operator|=
operator|(
name|u32
operator|*
operator|)
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|end
operator|=
operator|(
operator|(
name|u32
operator|*
operator|)
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
operator|+
name|init
operator|->
name|ring_size
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|size
operator|=
name|init
operator|->
name|ring_size
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
operator|=
name|drm_order
argument_list|(
name|init
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update
operator|=
comment|/* init->rptr_update */
literal|4096
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|=
name|drm_order
argument_list|(
comment|/* init->rptr_update */
literal|4096
operator|/
literal|8
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|fetch_size
operator|=
comment|/* init->fetch_size */
literal|32
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|fetch_size_l2ow
operator|=
name|drm_order
argument_list|(
comment|/* init->fetch_size */
literal|32
operator|/
literal|16
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail_mask
operator|=
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|size
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|high_mark
operator|=
name|RADEON_RING_HIGH_MARK
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
comment|/* XXX turn off pcie gart */
block|}
else|else
endif|#
directive|endif
block|{
name|dev_priv
operator|->
name|gart_info
operator|.
name|table_mask
operator|=
name|DMA_BIT_MASK
argument_list|(
literal|32
argument_list|)
expr_stmt|;
comment|/* if we have an offset set from userspace */
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|pcigart_offset_set
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Need gart offset from userspace\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"Using gart offset 0x%08lx\n"
argument_list|,
name|dev_priv
operator|->
name|pcigart_offset
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
operator|=
name|dev_priv
operator|->
name|pcigart_offset
operator|+
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
operator|.
name|offset
operator|=
name|dev_priv
operator|->
name|pcigart_offset
operator|+
name|dev_priv
operator|->
name|fb_aper_offset
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
operator|.
name|size
operator|=
name|dev_priv
operator|->
name|gart_info
operator|.
name|table_size
expr_stmt|;
name|drm_core_ioremap_wc
argument_list|(
operator|&
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
operator|.
name|handle
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ioremap failed.\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev_priv
operator|->
name|gart_info
operator|.
name|addr
operator|=
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
operator|.
name|handle
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Setting phys_pci_gart to %p %08lX\n"
argument_list|,
name|dev_priv
operator|->
name|gart_info
operator|.
name|addr
argument_list|,
name|dev_priv
operator|->
name|pcigart_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r600_page_table_init
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Failed to init GART table\n"
argument_list|)
expr_stmt|;
name|r600_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
operator|)
condition|)
name|r700_vm_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
else|else
name|r600_vm_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
operator|)
condition|)
name|r700_cp_load_microcode
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
else|else
name|r600_cp_load_microcode
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|r600_cp_init_ring_buffer
argument_list|(
name|dev
argument_list|,
name|dev_priv
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|last_buf
operator|=
literal|0
expr_stmt|;
name|r600_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|r600_test_writeback
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|r600_cs_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|r600_do_resume_cp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
operator|)
condition|)
block|{
name|r700_vm_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|r700_cp_load_microcode
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r600_vm_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|r600_cp_load_microcode
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
name|r600_cp_init_ring_buffer
argument_list|(
name|dev
argument_list|,
name|dev_priv
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
name|r600_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Wait for the CP to go idle.  */
end_comment

begin_function
name|int
name|r600_do_cp_idle
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|R600_IT_EVENT_WRITE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R600_CACHE_FLUSH_AND_INV_EVENT
argument_list|)
expr_stmt|;
comment|/* wait for 3D idle clean */
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|R600_IT_SET_CONFIG_REG
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|R600_WAIT_UNTIL
operator|-
name|R600_SET_CONFIG_REG_OFFSET
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_WAIT_3D_IDLE
operator||
name|RADEON_WAIT_3D_IDLECLEAN
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
name|r600_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Start the Command Processor.  */
end_comment

begin_function
name|void
name|r600_do_cp_start
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|cp_me
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|R600_IT_ME_INITIALIZE
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0x00000001
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|<
name|CHIP_RV770
operator|)
condition|)
name|OUT_RING
argument_list|(
literal|0x00000003
argument_list|)
expr_stmt|;
else|else
name|OUT_RING
argument_list|(
literal|0x00000000
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|dev_priv
operator|->
name|r600_max_hw_contexts
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R600_ME_INITIALIZE_DEVICE_ID
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0x00000000
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0x00000000
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
comment|/* set the mux and reset the halt bit */
name|cp_me
operator|=
literal|0xff
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_CNTL
argument_list|,
name|cp_me
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cp_running
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r600_do_cp_reset
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|cur_read_ptr
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|cur_read_ptr
operator|=
name|RADEON_READ
argument_list|(
name|R600_CP_RB_RPTR
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_RB_WPTR
argument_list|,
name|cur_read_ptr
argument_list|)
expr_stmt|;
name|SET_RING_HEAD
argument_list|(
name|dev_priv
argument_list|,
name|cur_read_ptr
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail
operator|=
name|cur_read_ptr
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r600_do_cp_stop
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|uint32_t
name|cp_me
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|cp_me
operator|=
literal|0xff
operator||
name|R600_CP_ME_HALT
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R600_CP_ME_CNTL
argument_list|,
name|cp_me
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cp_running
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_cp_dispatch_indirect
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_buf
modifier|*
name|buf
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|end
condition|)
block|{
name|unsigned
name|long
name|offset
init|=
operator|(
name|dev_priv
operator|->
name|gart_buffers_offset
operator|+
name|buf
operator|->
name|offset
operator|+
name|start
operator|)
decl_stmt|;
name|int
name|dwords
init|=
operator|(
name|end
operator|-
name|start
operator|+
literal|3
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dwords:%d\n"
argument_list|,
name|dwords
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"offset 0x%lx\n"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
comment|/* Indirect buffer data must be a multiple of 16 dwords. 		 * pad the data with a Type-2 CP packet. 		 */
while|while
condition|(
name|dwords
operator|&
literal|0xf
condition|)
block|{
name|u32
modifier|*
name|data
init|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
operator|+
name|buf
operator|->
name|offset
operator|+
name|start
operator|)
decl_stmt|;
name|data
index|[
name|dwords
operator|++
index|]
operator|=
name|RADEON_CP_PACKET2
expr_stmt|;
block|}
comment|/* Fire off the indirect buffer */
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|R600_IT_INDIRECT_BUFFER
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|offset
operator|&
literal|0xfffffffc
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dwords
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r600_cp_dispatch_swap
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|struct
name|drm_clip_rect
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cpp
decl_stmt|,
name|src_pitch
decl_stmt|,
name|dst_pitch
decl_stmt|;
name|uint64_t
name|src
decl_stmt|,
name|dst
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|color_fmt
operator|==
name|RADEON_COLOR_FORMAT_ARGB8888
condition|)
name|cpp
operator|=
literal|4
expr_stmt|;
else|else
name|cpp
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|pfCurrentPage
operator|==
literal|0
condition|)
block|{
name|src_pitch
operator|=
name|dev_priv
operator|->
name|back_pitch
expr_stmt|;
name|dst_pitch
operator|=
name|dev_priv
operator|->
name|front_pitch
expr_stmt|;
name|src
operator|=
name|dev_priv
operator|->
name|back_offset
operator|+
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
name|dst
operator|=
name|dev_priv
operator|->
name|front_offset
operator|+
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
block|}
else|else
block|{
name|src_pitch
operator|=
name|dev_priv
operator|->
name|front_pitch
expr_stmt|;
name|dst_pitch
operator|=
name|dev_priv
operator|->
name|back_pitch
expr_stmt|;
name|src
operator|=
name|dev_priv
operator|->
name|front_offset
operator|+
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
name|dst
operator|=
name|dev_priv
operator|->
name|back_offset
operator|+
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
block|}
if|if
condition|(
name|r600_prepare_blit_copy
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"unable to allocate vertex buffer for swap buffer\n"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|int
name|x
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x1
decl_stmt|;
name|int
name|y
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y1
decl_stmt|;
name|int
name|w
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x2
operator|-
name|x
decl_stmt|;
name|int
name|h
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y2
operator|-
name|y
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%d,%d-%d,%d\n"
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|r600_blit_swap
argument_list|(
name|dev
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|src_pitch
argument_list|,
name|dst_pitch
argument_list|,
name|cpp
argument_list|)
expr_stmt|;
block|}
name|r600_done_blit_copy
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Increment the frame counter.  The client-side 3D driver must 	 * throttle the framerate by waiting for this value before 	 * performing the swapbuffer ioctl. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|++
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|R600_FRAME_AGE
argument_list|(
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r600_cp_dispatch_texture
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|drm_radeon_texture_t
modifier|*
name|tex
parameter_list|,
name|drm_radeon_tex_image_t
modifier|*
name|image
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
name|u32
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|u8
name|__user
modifier|*
name|data
decl_stmt|;
name|int
name|size
decl_stmt|,
name|pass_size
decl_stmt|;
name|u64
name|src_offset
decl_stmt|,
name|dst_offset
decl_stmt|;
if|if
condition|(
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
name|tex
operator|->
name|offset
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid destination offset\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* this might fail for zero-sized uploads - are those illegal? */
if|if
condition|(
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
name|tex
operator|->
name|offset
operator|+
name|tex
operator|->
name|height
operator|*
name|tex
operator|->
name|pitch
operator|-
literal|1
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid final destination offset\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|size
operator|=
name|tex
operator|->
name|height
operator|*
name|tex
operator|->
name|pitch
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|dst_offset
operator|=
name|tex
operator|->
name|offset
expr_stmt|;
name|r600_prepare_blit_copy
argument_list|(
name|dev
argument_list|)
expr_stmt|;
do|do
block|{
name|data
operator|=
operator|(
specifier|const
name|u8
name|__user
operator|*
operator|)
name|image
operator|->
name|data
expr_stmt|;
name|pass_size
operator|=
name|size
expr_stmt|;
name|buf
operator|=
name|radeon_freelist_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"EAGAIN\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
name|tex
operator|->
name|image
argument_list|,
name|image
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|image
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
return|return
operator|-
name|EAGAIN
return|;
block|}
if|if
condition|(
name|pass_size
operator|>
name|buf
operator|->
name|total
condition|)
name|pass_size
operator|=
name|buf
operator|->
name|total
expr_stmt|;
comment|/* Dispatch the indirect buffer. 		 */
name|buffer
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
operator|+
name|buf
operator|->
name|offset
operator|)
expr_stmt|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|buffer
argument_list|,
name|data
argument_list|,
name|pass_size
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"EFAULT on pad, %d bytes\n"
argument_list|,
name|pass_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
name|buf
operator|->
name|file_priv
operator|=
name|file_priv
expr_stmt|;
name|buf
operator|->
name|used
operator|=
name|pass_size
expr_stmt|;
name|src_offset
operator|=
name|dev_priv
operator|->
name|gart_buffers_offset
operator|+
name|buf
operator|->
name|offset
expr_stmt|;
name|r600_blit_copy
argument_list|(
name|dev
argument_list|,
name|src_offset
argument_list|,
name|dst_offset
argument_list|,
name|pass_size
argument_list|)
expr_stmt|;
name|radeon_cp_discard_buffer
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
comment|/* Update the input parameters for next time */
name|image
operator|->
name|data
operator|=
operator|(
specifier|const
name|u8
name|__user
operator|*
operator|)
name|image
operator|->
name|data
operator|+
name|pass_size
expr_stmt|;
name|dst_offset
operator|+=
name|pass_size
expr_stmt|;
name|size
operator|-=
name|pass_size
expr_stmt|;
block|}
do|while
condition|(
name|size
operator|>
literal|0
condition|)
do|;
name|r600_done_blit_copy
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


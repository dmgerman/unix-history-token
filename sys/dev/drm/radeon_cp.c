begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* radeon_cp.c -- CP support for Radeon -*- linux-c -*- */
end_comment

begin_comment
comment|/*-  * Copyright 2000 Precision Insight, Inc., Cedar Park, Texas.  * Copyright 2000 VA Linux Systems, Inc., Fremont, California.  * Copyright 2007 Advanced Micro Devices, Inc.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Kevin E. Martin<martin@valinux.com>  *    Gareth Hughes<gareth@valinux.com>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_drv.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/r300_reg.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_microcode.h"
end_include

begin_define
define|#
directive|define
name|RADEON_FIFO_DEBUG
value|0
end_define

begin_function_decl
specifier|static
name|int
name|radeon_do_cleanup_cp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|radeon_do_cp_start
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|u32
name|R500_READ_MCIND
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
name|u32
name|ret
decl_stmt|;
name|RADEON_WRITE
argument_list|(
name|R520_MC_IND_INDEX
argument_list|,
literal|0x7f0000
operator||
operator|(
name|addr
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RADEON_READ
argument_list|(
name|R520_MC_IND_DATA
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R520_MC_IND_INDEX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|RS480_READ_MCIND
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
name|u32
name|ret
decl_stmt|;
name|RADEON_WRITE
argument_list|(
name|RS480_NB_MC_INDEX
argument_list|,
name|addr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RADEON_READ
argument_list|(
name|RS480_NB_MC_DATA
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RS480_NB_MC_INDEX
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|RS690_READ_MCIND
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
name|u32
name|ret
decl_stmt|;
name|RADEON_WRITE
argument_list|(
name|RS690_MC_INDEX
argument_list|,
operator|(
name|addr
operator|&
name|RS690_MC_INDEX_MASK
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RADEON_READ
argument_list|(
name|RS690_MC_DATA
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RS690_MC_INDEX
argument_list|,
name|RS690_MC_INDEX_MASK
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|IGP_READ_MCIND
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
return|return
name|RS690_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|addr
argument_list|)
return|;
else|else
return|return
name|RS480_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
name|u32
name|radeon_read_fb_location
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV515
condition|)
return|return
name|R500_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RV515_MC_FB_LOCATION
argument_list|)
return|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
return|return
name|RS690_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RS690_MC_FB_LOCATION
argument_list|)
return|;
elseif|else
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>
name|CHIP_RV515
condition|)
return|return
name|R500_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|R520_MC_FB_LOCATION
argument_list|)
return|;
else|else
return|return
name|RADEON_READ
argument_list|(
name|RADEON_MC_FB_LOCATION
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_write_fb_location
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|u32
name|fb_loc
parameter_list|)
block|{
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV515
condition|)
name|R500_WRITE_MCIND
argument_list|(
name|RV515_MC_FB_LOCATION
argument_list|,
name|fb_loc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
name|RS690_WRITE_MCIND
argument_list|(
name|RS690_MC_FB_LOCATION
argument_list|,
name|fb_loc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>
name|CHIP_RV515
condition|)
name|R500_WRITE_MCIND
argument_list|(
name|R520_MC_FB_LOCATION
argument_list|,
name|fb_loc
argument_list|)
expr_stmt|;
else|else
name|RADEON_WRITE
argument_list|(
name|RADEON_MC_FB_LOCATION
argument_list|,
name|fb_loc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_write_agp_location
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|u32
name|agp_loc
parameter_list|)
block|{
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV515
condition|)
name|R500_WRITE_MCIND
argument_list|(
name|RV515_MC_AGP_LOCATION
argument_list|,
name|agp_loc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
name|RS690_WRITE_MCIND
argument_list|(
name|RS690_MC_AGP_LOCATION
argument_list|,
name|agp_loc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>
name|CHIP_RV515
condition|)
name|R500_WRITE_MCIND
argument_list|(
name|R520_MC_AGP_LOCATION
argument_list|,
name|agp_loc
argument_list|)
expr_stmt|;
else|else
name|RADEON_WRITE
argument_list|(
name|RADEON_MC_AGP_LOCATION
argument_list|,
name|agp_loc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_write_agp_base
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|u64
name|agp_base
parameter_list|)
block|{
name|u32
name|agp_base_hi
init|=
name|upper_32_bits
argument_list|(
name|agp_base
argument_list|)
decl_stmt|;
name|u32
name|agp_base_lo
init|=
name|agp_base
operator|&
literal|0xffffffff
decl_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV515
condition|)
block|{
name|R500_WRITE_MCIND
argument_list|(
name|RV515_MC_AGP_BASE
argument_list|,
name|agp_base_lo
argument_list|)
expr_stmt|;
name|R500_WRITE_MCIND
argument_list|(
name|RV515_MC_AGP_BASE_2
argument_list|,
name|agp_base_hi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
name|RS690_WRITE_MCIND
argument_list|(
name|RS690_MC_AGP_BASE
argument_list|,
name|agp_base_lo
argument_list|)
expr_stmt|;
name|RS690_WRITE_MCIND
argument_list|(
name|RS690_MC_AGP_BASE_2
argument_list|,
name|agp_base_hi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>
name|CHIP_RV515
condition|)
block|{
name|R500_WRITE_MCIND
argument_list|(
name|R520_MC_AGP_BASE
argument_list|,
name|agp_base_lo
argument_list|)
expr_stmt|;
name|R500_WRITE_MCIND
argument_list|(
name|R520_MC_AGP_BASE_2
argument_list|,
name|agp_base_hi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS480
operator|)
condition|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_AGP_BASE
argument_list|,
name|agp_base_lo
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RS480_AGP_BASE_2
argument_list|,
name|agp_base_hi
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_AGP_BASE
argument_list|,
name|agp_base_lo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_R200
condition|)
name|RADEON_WRITE
argument_list|(
name|RADEON_AGP_BASE_2
argument_list|,
name|agp_base_hi
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|RADEON_READ_PLL
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|RADEON_WRITE8
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|addr
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
return|return
name|RADEON_READ
argument_list|(
name|RADEON_CLOCK_CNTL_DATA
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|RADEON_READ_PCIE
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
name|RADEON_WRITE8
argument_list|(
name|RADEON_PCIE_INDEX
argument_list|,
name|addr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
return|return
name|RADEON_READ
argument_list|(
name|RADEON_PCIE_DATA
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|RADEON_FIFO_DEBUG
end_if

begin_function
specifier|static
name|void
name|radeon_status
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|printk
argument_list|(
literal|"%s:\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"RBBM_STATUS = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"CP_RB_RTPR = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_CP_RB_RPTR
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"CP_RB_WTPR = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"AIC_CNTL = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_AIC_CNTL
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"AIC_STAT = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_AIC_STAT
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"AIC_PT_BASE = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_AIC_PT_BASE
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"TLB_ADDR = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_AIC_TLB_ADDR
argument_list|)
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"TLB_DATA = 0x%08x\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|RADEON_READ
argument_list|(
name|RADEON_AIC_TLB_DATA
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ================================================================  * Engine, FIFO control  */
end_comment

begin_function
specifier|static
name|int
name|radeon_do_pixcache_flush
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev_priv
operator|->
name|stats
operator|.
name|boxes
operator||=
name|RADEON_BOX_WAIT_IDLE
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|<=
name|CHIP_RV280
condition|)
block|{
name|tmp
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_RB3D_DSTCACHE_CTLSTAT
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|RADEON_RB3D_DC_FLUSH_ALL
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_RB3D_DSTCACHE_CTLSTAT
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RADEON_READ
argument_list|(
name|RADEON_RB3D_DSTCACHE_CTLSTAT
argument_list|)
operator|&
name|RADEON_RB3D_DC_BUSY
operator|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* don't flush or purge cache here or lockup */
return|return
literal|0
return|;
block|}
if|#
directive|if
name|RADEON_FIFO_DEBUG
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
name|radeon_status
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|-
name|EBUSY
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_do_wait_for_fifo
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|entries
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|dev_priv
operator|->
name|stats
operator|.
name|boxes
operator||=
name|RADEON_BOX_WAIT_IDLE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|int
name|slots
init|=
operator|(
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
operator|&
name|RADEON_RBBM_FIFOCNT_MASK
operator|)
decl_stmt|;
if|if
condition|(
name|slots
operator|>=
name|entries
condition|)
return|return
literal|0
return|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"wait for fifo failed status : 0x%08X 0x%08X\n"
argument_list|,
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
argument_list|,
name|RADEON_READ
argument_list|(
name|R300_VAP_CNTL_STATUS
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|RADEON_FIFO_DEBUG
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
name|radeon_status
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|-
name|EBUSY
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_do_wait_for_idle
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|dev_priv
operator|->
name|stats
operator|.
name|boxes
operator||=
name|RADEON_BOX_WAIT_IDLE
expr_stmt|;
name|ret
operator|=
name|radeon_do_wait_for_fifo
argument_list|(
name|dev_priv
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
operator|&
name|RADEON_RBBM_ACTIVE
operator|)
condition|)
block|{
name|radeon_do_pixcache_flush
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|DRM_INFO
argument_list|(
literal|"wait idle failed status : 0x%08X 0x%08X\n"
argument_list|,
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_STATUS
argument_list|)
argument_list|,
name|RADEON_READ
argument_list|(
name|R300_VAP_CNTL_STATUS
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|RADEON_FIFO_DEBUG
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
name|radeon_status
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|-
name|EBUSY
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_init_pipes
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|uint32_t
name|gb_tile_config
decl_stmt|,
name|gb_pipe_sel
init|=
literal|0
decl_stmt|;
comment|/* RS4xx/RS6xx/R4xx/R5xx */
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_R420
condition|)
block|{
name|gb_pipe_sel
operator|=
name|RADEON_READ
argument_list|(
name|R400_GB_PIPE_SELECT
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|num_gb_pipes
operator|=
operator|(
operator|(
name|gb_pipe_sel
operator|>>
literal|12
operator|)
operator|&
literal|0x3
operator|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* R3xx */
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R300
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R350
operator|)
condition|)
block|{
name|dev_priv
operator|->
name|num_gb_pipes
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* R3Vxx */
name|dev_priv
operator|->
name|num_gb_pipes
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|DRM_INFO
argument_list|(
literal|"Num pipes: %d\n"
argument_list|,
name|dev_priv
operator|->
name|num_gb_pipes
argument_list|)
expr_stmt|;
name|gb_tile_config
operator|=
operator|(
name|R300_ENABLE_TILING
operator||
name|R300_TILE_SIZE_16
comment|/*| R300_SUBPIXEL_1_16*/
operator|)
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|num_gb_pipes
condition|)
block|{
case|case
literal|2
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R300
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R420_3P
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_R420
expr_stmt|;
break|break;
default|default:
case|case
literal|1
case|:
name|gb_tile_config
operator||=
name|R300_PIPE_COUNT_RV350
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV515
condition|)
block|{
name|RADEON_WRITE_PLL
argument_list|(
name|R500_DYN_SCLK_PWMEM_PIPE
argument_list|,
operator|(
literal|1
operator||
operator|(
operator|(
name|gb_pipe_sel
operator|>>
literal|8
operator|)
operator|&
literal|0xf
operator|)
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R500_SU_REG_DEST
argument_list|,
operator|(
operator|(
literal|1
operator|<<
name|dev_priv
operator|->
name|num_gb_pipes
operator|)
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
name|RADEON_WRITE
argument_list|(
name|R300_GB_TILE_CONFIG
argument_list|,
name|gb_tile_config
argument_list|)
expr_stmt|;
name|radeon_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|,
name|RADEON_READ
argument_list|(
name|R300_DST_PIPE_CONFIG
argument_list|)
operator||
name|R300_PIPE_AUTO_CONFIG
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|R300_RB2D_DSTCACHE_MODE
argument_list|,
operator|(
name|RADEON_READ
argument_list|(
name|R300_RB2D_DSTCACHE_MODE
argument_list|)
operator||
name|R300_DC_AUTOFLUSH_ENABLE
operator||
name|R300_DC_DC_DISABLE_IGNORE_PE
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ================================================================  * CP control, initialization  */
end_comment

begin_comment
comment|/* Load the microcode for the CP */
end_comment

begin_function
specifier|static
name|void
name|radeon_cp_load_microcode
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|radeon_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_ADDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R100
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV100
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV200
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS100
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS200
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R100 Microcode\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAH
argument_list|,
name|R100_cp_microcode
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAL
argument_list|,
name|R100_cp_microcode
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R200
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV250
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV280
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS300
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R200 Microcode\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAH
argument_list|,
name|R200_cp_microcode
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAL
argument_list|,
name|R200_cp_microcode
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R300
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R350
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV350
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV380
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS480
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R300 Microcode\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAH
argument_list|,
name|R300_cp_microcode
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAL
argument_list|,
name|R300_cp_microcode
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R420
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R423
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV410
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R400 Microcode\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAH
argument_list|,
name|R420_cp_microcode
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAL
argument_list|,
name|R420_cp_microcode
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading RS690/RS740 Microcode\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAH
argument_list|,
name|RS690_cp_microcode
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAL
argument_list|,
name|RS690_cp_microcode
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV515
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R520
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV530
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R580
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV560
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV570
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Loading R500 Microcode\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAH
argument_list|,
name|R520_cp_microcode
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_ME_RAM_DATAL
argument_list|,
name|R520_cp_microcode
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* Flush any pending commands to the CP.  This should only be used just  * prior to a wait for idle, as it informs the engine that the command  * stream is ending.  */
end_comment

begin_function
specifier|static
name|void
name|radeon_do_cp_flush
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|u32 tmp;  	tmp = RADEON_READ(RADEON_CP_RB_WPTR) | (1<< 31); 	RADEON_WRITE(RADEON_CP_RB_WPTR, tmp);
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Wait for the CP to go idle.  */
end_comment

begin_function
name|int
name|radeon_do_cp_idle
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|RADEON_PURGE_CACHE
argument_list|()
expr_stmt|;
name|RADEON_PURGE_ZCACHE
argument_list|()
expr_stmt|;
name|RADEON_WAIT_UNTIL_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
name|radeon_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Start the Command Processor.  */
end_comment

begin_function
specifier|static
name|void
name|radeon_do_cp_start
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|radeon_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
name|dev_priv
operator|->
name|cp_mode
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cp_running
operator|=
literal|1
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|8
argument_list|)
expr_stmt|;
comment|/* isync can only be written through cp on r5xx write it here */
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_ISYNC_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_ISYNC_ANY2D_IDLE3D
operator||
name|RADEON_ISYNC_ANY3D_IDLE2D
operator||
name|RADEON_ISYNC_WAIT_IDLEGUI
operator||
name|RADEON_ISYNC_CPSCRATCH_IDLEGUI
argument_list|)
expr_stmt|;
name|RADEON_PURGE_CACHE
argument_list|()
expr_stmt|;
name|RADEON_PURGE_ZCACHE
argument_list|()
expr_stmt|;
name|RADEON_WAIT_UNTIL_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
name|dev_priv
operator|->
name|track_flush
operator||=
name|RADEON_FLUSH_EMITED
operator||
name|RADEON_PURGE_EMITED
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Reset the Command Processor.  This will not flush any pending  * commands, so you must wait for the CP command stream to complete  * before calling this routine.  */
end_comment

begin_function
specifier|static
name|void
name|radeon_do_cp_reset
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|cur_read_ptr
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|cur_read_ptr
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_CP_RB_RPTR
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|,
name|cur_read_ptr
argument_list|)
expr_stmt|;
name|SET_RING_HEAD
argument_list|(
name|dev_priv
argument_list|,
name|cur_read_ptr
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail
operator|=
name|cur_read_ptr
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Stop the Command Processor.  This will not flush any pending  * commands, so you must flush the command stream and wait for the CP  * to go idle before calling this routine.  */
end_comment

begin_function
specifier|static
name|void
name|radeon_do_cp_stop
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_CSQ_CNTL
argument_list|,
name|RADEON_CSQ_PRIDIS_INDDIS
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cp_running
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Reset the engine.  This will stop the CP if it is running.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_do_engine_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|u32
name|clock_cntl_index
init|=
literal|0
decl_stmt|,
name|mclk_cntl
init|=
literal|0
decl_stmt|,
name|rbbm_soft_reset
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|radeon_do_pixcache_flush
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|<=
name|CHIP_RV410
condition|)
block|{
comment|/* may need something similar for newer chips */
name|clock_cntl_index
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|)
expr_stmt|;
name|mclk_cntl
operator|=
name|RADEON_READ_PLL
argument_list|(
name|dev
argument_list|,
name|RADEON_MCLK_CNTL
argument_list|)
expr_stmt|;
name|RADEON_WRITE_PLL
argument_list|(
name|RADEON_MCLK_CNTL
argument_list|,
operator|(
name|mclk_cntl
operator||
name|RADEON_FORCEON_MCLKA
operator||
name|RADEON_FORCEON_MCLKB
operator||
name|RADEON_FORCEON_YCLKA
operator||
name|RADEON_FORCEON_YCLKB
operator||
name|RADEON_FORCEON_MC
operator||
name|RADEON_FORCEON_AIC
operator|)
argument_list|)
expr_stmt|;
block|}
name|rbbm_soft_reset
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_RBBM_SOFT_RESET
argument_list|,
operator|(
name|rbbm_soft_reset
operator||
name|RADEON_SOFT_RESET_CP
operator||
name|RADEON_SOFT_RESET_HI
operator||
name|RADEON_SOFT_RESET_SE
operator||
name|RADEON_SOFT_RESET_RE
operator||
name|RADEON_SOFT_RESET_PP
operator||
name|RADEON_SOFT_RESET_E2
operator||
name|RADEON_SOFT_RESET_RB
operator|)
argument_list|)
expr_stmt|;
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_RBBM_SOFT_RESET
argument_list|,
operator|(
name|rbbm_soft_reset
operator|&
operator|~
operator|(
name|RADEON_SOFT_RESET_CP
operator||
name|RADEON_SOFT_RESET_HI
operator||
name|RADEON_SOFT_RESET_SE
operator||
name|RADEON_SOFT_RESET_RE
operator||
name|RADEON_SOFT_RESET_PP
operator||
name|RADEON_SOFT_RESET_E2
operator||
name|RADEON_SOFT_RESET_RB
operator|)
operator|)
argument_list|)
expr_stmt|;
name|RADEON_READ
argument_list|(
name|RADEON_RBBM_SOFT_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|<=
name|CHIP_RV410
condition|)
block|{
name|RADEON_WRITE_PLL
argument_list|(
name|RADEON_MCLK_CNTL
argument_list|,
name|mclk_cntl
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
argument_list|,
name|clock_cntl_index
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_RBBM_SOFT_RESET
argument_list|,
name|rbbm_soft_reset
argument_list|)
expr_stmt|;
block|}
comment|/* setup the raster pipes */
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_R300
condition|)
name|radeon_init_pipes
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* Reset the CP ring */
name|radeon_do_cp_reset
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* The CP is no longer running after an engine reset */
name|dev_priv
operator|->
name|cp_running
operator|=
literal|0
expr_stmt|;
comment|/* Reset any pending vertex, indirect buffers */
name|radeon_freelist_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_init_ring_buffer
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|ring_start
decl_stmt|,
name|cur_read_ptr
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
comment|/* Initialize the memory controller. With new memory map, the fb location 	 * is not changed, it should have been properly initialized already. Part 	 * of the problem is that the code below is bogus, assuming the GART is 	 * always appended to the fb which is not necessarily the case 	 */
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|new_memmap
condition|)
name|radeon_write_fb_location
argument_list|(
name|dev_priv
argument_list|,
operator|(
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|-
literal|1
operator|)
operator|&
literal|0xffff0000
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|fb_location
operator|>>
literal|16
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|radeon_write_agp_base
argument_list|(
name|dev_priv
argument_list|,
name|dev
operator|->
name|agp
operator|->
name|base
argument_list|)
expr_stmt|;
name|radeon_write_agp_location
argument_list|(
name|dev_priv
argument_list|,
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|-
literal|1
operator|+
name|dev_priv
operator|->
name|gart_size
operator|)
operator|&
literal|0xffff0000
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ring_start
operator|=
operator|(
name|dev_priv
operator|->
name|cp_ring
operator|->
name|offset
operator|-
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|ring_start
operator|=
operator|(
name|dev_priv
operator|->
name|cp_ring
operator|->
name|offset
operator|-
operator|(
name|unsigned
name|long
operator|)
name|dev
operator|->
name|sg
operator|->
name|virtual
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_BASE
argument_list|,
name|ring_start
argument_list|)
expr_stmt|;
comment|/* Set the write pointer delay */
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_WPTR_DELAY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize the ring buffer's read and write pointers */
name|cur_read_ptr
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_CP_RB_RPTR
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_WPTR
argument_list|,
name|cur_read_ptr
argument_list|)
expr_stmt|;
name|SET_RING_HEAD
argument_list|(
name|dev_priv
argument_list|,
name|cur_read_ptr
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail
operator|=
name|cur_read_ptr
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_RPTR_ADDR
argument_list|,
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|offset
operator|-
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|struct
name|drm_sg_mem
modifier|*
name|entry
init|=
name|dev
operator|->
name|sg
decl_stmt|;
name|unsigned
name|long
name|tmp_ofs
decl_stmt|,
name|page_ofs
decl_stmt|;
name|tmp_ofs
operator|=
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|offset
operator|-
operator|(
name|unsigned
name|long
operator|)
name|dev
operator|->
name|sg
operator|->
name|virtual
expr_stmt|;
name|page_ofs
operator|=
name|tmp_ofs
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_RPTR_ADDR
argument_list|,
name|entry
operator|->
name|busaddr
index|[
name|page_ofs
index|]
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"ring rptr: offset=0x%08lx handle=0x%08lx\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|entry
operator|->
name|busaddr
index|[
name|page_ofs
index|]
argument_list|,
name|entry
operator|->
name|handle
operator|+
name|tmp_ofs
argument_list|)
expr_stmt|;
block|}
comment|/* Set ring buffer size */
ifdef|#
directive|ifdef
name|__BIG_ENDIAN
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|RADEON_BUF_SWAP_32BIT
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|fetch_size_l2ow
operator|<<
literal|18
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
else|#
directive|else
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|fetch_size_l2ow
operator|<<
literal|18
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|<<
literal|8
operator|)
operator||
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Initialize the scratch register pointer.  This will cause 	 * the scratch register values to be written out to memory 	 * whenever they are updated. 	 * 	 * We simply put this behind the ring read pointer, this works 	 * with PCI GART as well as (whatever kind of) AGP GART 	 */
name|RADEON_WRITE
argument_list|(
name|RADEON_SCRATCH_ADDR
argument_list|,
name|RADEON_READ
argument_list|(
name|RADEON_CP_RB_RPTR_ADDR
argument_list|)
operator|+
name|RADEON_SCRATCH_REG_OFFSET
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|scratch
operator|=
operator|(
operator|(
specifier|__volatile__
name|u32
operator|*
operator|)
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
operator|+
operator|(
name|RADEON_SCRATCH_REG_OFFSET
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
operator|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_SCRATCH_UMSK
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
comment|/* Turn on bus mastering */
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS400
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
block|{
comment|/* rs400, rs690/rs740 */
name|tmp
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
operator|&
operator|~
name|RS400_BUS_MASTER_DIS
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RV380
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_R423
operator|)
operator|)
condition|)
block|{
comment|/* r1xx, r2xx, r300, r(v)350, r420/r481, rs480 */
name|tmp
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_BUS_CNTL
argument_list|)
operator|&
operator|~
name|RADEON_BUS_MASTER_DIS
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_BUS_CNTL
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* PCIE cards appears to not need this */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|=
name|dev_priv
operator|->
name|scratch
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_LAST_FRAME_REG
argument_list|,
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|=
name|dev_priv
operator|->
name|scratch
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_LAST_DISPATCH_REG
argument_list|,
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_clear
operator|=
name|dev_priv
operator|->
name|scratch
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_LAST_CLEAR_REG
argument_list|,
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_clear
argument_list|)
expr_stmt|;
name|radeon_do_wait_for_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* Sync everything up */
name|RADEON_WRITE
argument_list|(
name|RADEON_ISYNC_CNTL
argument_list|,
operator|(
name|RADEON_ISYNC_ANY2D_IDLE3D
operator||
name|RADEON_ISYNC_ANY3D_IDLE2D
operator||
name|RADEON_ISYNC_WAIT_IDLEGUI
operator||
name|RADEON_ISYNC_CPSCRATCH_IDLEGUI
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_test_writeback
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
comment|/* Writeback doesn't seem to work everywhere, test it here and possibly 	 * enable it if it appears to work 	 */
name|DRM_WRITE32
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|RADEON_SCRATCHOFF
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_SCRATCH_REG1
argument_list|,
literal|0xdeadbeef
argument_list|)
expr_stmt|;
for|for
control|(
name|tmp
operator|=
literal|0
init|;
name|tmp
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|tmp
operator|++
control|)
block|{
if|if
condition|(
name|DRM_READ32
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|RADEON_SCRATCHOFF
argument_list|(
literal|1
argument_list|)
argument_list|)
operator|==
literal|0xdeadbeef
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|)
block|{
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|1
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"writeback test succeeded in %d usecs\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|0
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"writeback test failed\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_no_wb
operator|==
literal|1
condition|)
block|{
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|0
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"writeback forced off\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|writeback_works
condition|)
block|{
comment|/* Disable writeback to avoid unnecessary bus master transfers */
name|RADEON_WRITE
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|,
name|RADEON_READ
argument_list|(
name|RADEON_CP_RB_CNTL
argument_list|)
operator||
name|RADEON_RB_NO_UPDATE
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_SCRATCH_UMSK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Enable or disable IGP GART on the chip */
end_comment

begin_function
specifier|static
name|void
name|radeon_set_igpgart
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|u32
name|temp
decl_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"programming igp gart %08X %08lX %08X\n"
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|,
operator|(
name|long
operator|)
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
argument_list|,
name|dev_priv
operator|->
name|gart_size
argument_list|)
expr_stmt|;
name|temp
operator|=
name|IGP_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RS480_MC_MISC_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
condition|)
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_MC_MISC_CNTL
argument_list|,
operator|(
name|RS480_GART_INDEX_REG_EN
operator||
name|RS690_BLOCK_GFX_D3_EN
operator|)
argument_list|)
expr_stmt|;
else|else
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_MC_MISC_CNTL
argument_list|,
name|RS480_GART_INDEX_REG_EN
argument_list|)
expr_stmt|;
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_AGP_ADDRESS_SPACE_SIZE
argument_list|,
operator|(
name|RS480_GART_EN
operator||
name|RS480_VA_SIZE_32MB
operator|)
argument_list|)
expr_stmt|;
name|temp
operator|=
name|IGP_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RS480_GART_FEATURE_ID
argument_list|)
expr_stmt|;
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_GART_FEATURE_ID
argument_list|,
operator|(
name|RS480_HANG_EN
operator||
name|RS480_TLB_ENABLE
operator||
name|RS480_GTW_LAC_EN
operator||
name|RS480_1LEVEL_GART
operator|)
argument_list|)
expr_stmt|;
name|temp
operator|=
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
operator|&
literal|0xfffff000
expr_stmt|;
name|temp
operator||=
operator|(
name|upper_32_bits
argument_list|(
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
argument_list|)
operator|&
literal|0xff
operator|)
operator|<<
literal|4
expr_stmt|;
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_GART_BASE
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|IGP_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RS480_AGP_MODE_CNTL
argument_list|)
expr_stmt|;
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_AGP_MODE_CNTL
argument_list|,
operator|(
operator|(
literal|1
operator|<<
name|RS480_REQ_TYPE_SNOOP_SHIFT
operator|)
operator||
name|RS480_REQ_TYPE_SNOOP_DIS
operator|)
argument_list|)
expr_stmt|;
name|radeon_write_agp_base
argument_list|(
name|dev_priv
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_size
operator|=
literal|32
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
name|temp
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|-
literal|1
operator|+
name|dev_priv
operator|->
name|gart_size
operator|)
operator|&
literal|0xffff0000
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|gart_vm_start
operator|>>
literal|16
operator|)
operator|)
expr_stmt|;
name|radeon_write_agp_location
argument_list|(
name|dev_priv
argument_list|,
name|temp
argument_list|)
expr_stmt|;
name|temp
operator|=
name|IGP_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RS480_AGP_ADDRESS_SPACE_SIZE
argument_list|)
expr_stmt|;
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_AGP_ADDRESS_SPACE_SIZE
argument_list|,
operator|(
name|RS480_GART_EN
operator||
name|RS480_VA_SIZE_32MB
operator|)
argument_list|)
expr_stmt|;
do|do
block|{
name|temp
operator|=
name|IGP_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RS480_GART_CACHE_CNTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|temp
operator|&
name|RS480_GART_CACHE_INVALIDATE
operator|)
operator|==
literal|0
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_GART_CACHE_CNTRL
argument_list|,
name|RS480_GART_CACHE_INVALIDATE
argument_list|)
expr_stmt|;
do|do
block|{
name|temp
operator|=
name|IGP_READ_MCIND
argument_list|(
name|dev_priv
argument_list|,
name|RS480_GART_CACHE_CNTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|temp
operator|&
name|RS480_GART_CACHE_INVALIDATE
operator|)
operator|==
literal|0
condition|)
break|break;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_GART_CACHE_CNTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|IGP_WRITE_MCIND
argument_list|(
name|RS480_AGP_ADDRESS_SPACE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_set_pciegart
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|u32
name|tmp
init|=
name|RADEON_READ_PCIE
argument_list|(
name|dev_priv
argument_list|,
name|RADEON_PCIE_TX_GART_CNTL
argument_list|)
decl_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"programming pcie %08X %08lX %08X\n"
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|,
operator|(
name|long
operator|)
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
argument_list|,
name|dev_priv
operator|->
name|gart_size
argument_list|)
expr_stmt|;
name|RADEON_WRITE_PCIE
argument_list|(
name|RADEON_PCIE_TX_DISCARD_RD_ADDR_LO
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
name|RADEON_WRITE_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_BASE
argument_list|,
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
argument_list|)
expr_stmt|;
name|RADEON_WRITE_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_START_LO
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
name|RADEON_WRITE_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_END_LO
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
argument_list|)
expr_stmt|;
name|radeon_write_agp_location
argument_list|(
name|dev_priv
argument_list|,
literal|0xffffffc0
argument_list|)
expr_stmt|;
comment|/* ?? */
name|RADEON_WRITE_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|,
name|RADEON_PCIE_TX_GART_EN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RADEON_WRITE_PCIE
argument_list|(
name|RADEON_PCIE_TX_GART_CNTL
argument_list|,
name|tmp
operator|&
operator|~
name|RADEON_PCIE_TX_GART_EN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Enable or disable PCI GART on the chip */
end_comment

begin_function
specifier|static
name|void
name|radeon_set_pcigart
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|u32
name|tmp
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS690
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_RS740
operator|)
operator|||
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_IGPGART
operator|)
condition|)
block|{
name|radeon_set_igpgart
argument_list|(
name|dev_priv
argument_list|,
name|on
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
block|{
name|radeon_set_pciegart
argument_list|(
name|dev_priv
argument_list|,
name|on
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmp
operator|=
name|RADEON_READ
argument_list|(
name|RADEON_AIC_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_AIC_CNTL
argument_list|,
name|tmp
operator||
name|RADEON_PCIGART_TRANSLATE_EN
argument_list|)
expr_stmt|;
comment|/* set PCI GART page-table base address 		 */
name|RADEON_WRITE
argument_list|(
name|RADEON_AIC_PT_BASE
argument_list|,
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
argument_list|)
expr_stmt|;
comment|/* set address range for PCI address translate 		 */
name|RADEON_WRITE
argument_list|(
name|RADEON_AIC_LO_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_AIC_HI_ADDR
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Turn off AGP aperture -- is this required for PCI GART? 		 */
name|radeon_write_agp_location
argument_list|(
name|dev_priv
argument_list|,
literal|0xffffffc0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_AGP_COMMAND
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* clear AGP_COMMAND */
block|}
else|else
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_AIC_CNTL
argument_list|,
name|tmp
operator|&
operator|~
name|RADEON_PCIGART_TRANSLATE_EN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_do_init_cp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_radeon_init_t
modifier|*
name|init
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* if we require new memory map but we don't have it fail */
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_NEW_MEMMAP
operator|)
operator|&&
operator|!
name|dev_priv
operator|->
name|new_memmap
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Cannot initialise DRM on this card\nThis card requires a new X.org DDX for 3D\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|init
operator|->
name|is_pci
operator|&&
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"Forcing AGP card to PCI mode\n"
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|flags
operator|&=
operator|~
name|RADEON_IS_AGP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|dev_priv
operator|->
name|flags
operator|&
operator|(
name|RADEON_IS_AGP
operator||
name|RADEON_IS_PCI
operator||
name|RADEON_IS_PCIE
operator|)
operator|)
operator|&&
operator|!
name|init
operator|->
name|is_pci
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"Restoring AGP flag\n"
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|flags
operator||=
name|RADEON_IS_AGP
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|!
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
operator|)
operator|&&
operator|!
name|dev
operator|->
name|sg
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"PCI GART memory not allocated!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev_priv
operator|->
name|usec_timeout
operator|=
name|init
operator|->
name|usec_timeout
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|usec_timeout
operator|<
literal|1
operator|||
name|dev_priv
operator|->
name|usec_timeout
operator|>
name|RADEON_MAX_USEC_TIMEOUT
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"TIMEOUT problem!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Enable vblank on CRTC1 for older X servers 	 */
name|dev_priv
operator|->
name|vblank_crtc
operator|=
name|DRM_RADEON_VBLANK_CRTC1
expr_stmt|;
name|dev_priv
operator|->
name|do_boxes
operator|=
literal|0
expr_stmt|;
name|dev_priv
operator|->
name|cp_mode
operator|=
name|init
operator|->
name|cp_mode
expr_stmt|;
comment|/* We don't support anything other than bus-mastering ring mode, 	 * but the ring can be in either AGP or PCI space for the ring 	 * read pointer. 	 */
if|if
condition|(
operator|(
name|init
operator|->
name|cp_mode
operator|!=
name|RADEON_CSQ_PRIBM_INDDIS
operator|)
operator|&&
operator|(
name|init
operator|->
name|cp_mode
operator|!=
name|RADEON_CSQ_PRIBM_INDBM
operator|)
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"BAD cp_mode (%x)!\n"
argument_list|,
name|init
operator|->
name|cp_mode
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|init
operator|->
name|fb_bpp
condition|)
block|{
case|case
literal|16
case|:
name|dev_priv
operator|->
name|color_fmt
operator|=
name|RADEON_COLOR_FORMAT_RGB565
expr_stmt|;
break|break;
case|case
literal|32
case|:
default|default:
name|dev_priv
operator|->
name|color_fmt
operator|=
name|RADEON_COLOR_FORMAT_ARGB8888
expr_stmt|;
break|break;
block|}
name|dev_priv
operator|->
name|front_offset
operator|=
name|init
operator|->
name|front_offset
expr_stmt|;
name|dev_priv
operator|->
name|front_pitch
operator|=
name|init
operator|->
name|front_pitch
expr_stmt|;
name|dev_priv
operator|->
name|back_offset
operator|=
name|init
operator|->
name|back_offset
expr_stmt|;
name|dev_priv
operator|->
name|back_pitch
operator|=
name|init
operator|->
name|back_pitch
expr_stmt|;
switch|switch
condition|(
name|init
operator|->
name|depth_bpp
condition|)
block|{
case|case
literal|16
case|:
name|dev_priv
operator|->
name|depth_fmt
operator|=
name|RADEON_DEPTH_FORMAT_16BIT_INT_Z
expr_stmt|;
break|break;
case|case
literal|32
case|:
default|default:
name|dev_priv
operator|->
name|depth_fmt
operator|=
name|RADEON_DEPTH_FORMAT_24BIT_INT_Z
expr_stmt|;
break|break;
block|}
name|dev_priv
operator|->
name|depth_offset
operator|=
name|init
operator|->
name|depth_offset
expr_stmt|;
name|dev_priv
operator|->
name|depth_pitch
operator|=
name|init
operator|->
name|depth_pitch
expr_stmt|;
comment|/* Hardware state for depth clears.  Remove this if/when we no 	 * longer clear the depth buffer with a 3D rectangle.  Hard-code 	 * all values to prevent unwanted 3D state from slipping through 	 * and screwing with the clear operation. 	 */
name|dev_priv
operator|->
name|depth_clear
operator|.
name|rb3d_cntl
operator|=
operator|(
name|RADEON_PLANE_MASK_ENABLE
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|10
operator|)
operator||
operator|(
name|dev_priv
operator|->
name|chip_family
operator|<
name|CHIP_R200
condition|?
name|RADEON_ZBLOCK16
else|:
literal|0
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|depth_clear
operator|.
name|rb3d_zstencilcntl
operator|=
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator||
name|RADEON_Z_TEST_ALWAYS
operator||
name|RADEON_STENCIL_TEST_ALWAYS
operator||
name|RADEON_STENCIL_S_FAIL_REPLACE
operator||
name|RADEON_STENCIL_ZPASS_REPLACE
operator||
name|RADEON_STENCIL_ZFAIL_REPLACE
operator||
name|RADEON_Z_WRITE_ENABLE
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|depth_clear
operator|.
name|se_cntl
operator|=
operator|(
name|RADEON_FFACE_CULL_CW
operator||
name|RADEON_BFACE_SOLID
operator||
name|RADEON_FFACE_SOLID
operator||
name|RADEON_FLAT_SHADE_VTX_LAST
operator||
name|RADEON_DIFFUSE_SHADE_FLAT
operator||
name|RADEON_ALPHA_SHADE_FLAT
operator||
name|RADEON_SPECULAR_SHADE_FLAT
operator||
name|RADEON_FOG_SHADE_FLAT
operator||
name|RADEON_VTX_PIX_CENTER_OGL
operator||
name|RADEON_ROUND_MODE_TRUNC
operator||
name|RADEON_ROUND_PREC_8TH_PIX
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|ring_offset
operator|=
name|init
operator|->
name|ring_offset
expr_stmt|;
name|dev_priv
operator|->
name|ring_rptr_offset
operator|=
name|init
operator|->
name|ring_rptr_offset
expr_stmt|;
name|dev_priv
operator|->
name|buffers_offset
operator|=
name|init
operator|->
name|buffers_offset
expr_stmt|;
name|dev_priv
operator|->
name|gart_textures_offset
operator|=
name|init
operator|->
name|gart_textures_offset
expr_stmt|;
name|dev_priv
operator|->
name|sarea
operator|=
name|drm_getsarea
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|sarea
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find sarea!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev_priv
operator|->
name|cp_ring
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|ring_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|cp_ring
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find cp ring region!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev_priv
operator|->
name|ring_rptr
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|ring_rptr_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|ring_rptr
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find ring read pointer!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|dev
operator|->
name|agp_buffer_token
operator|=
name|init
operator|->
name|buffers_offset
expr_stmt|;
name|dev
operator|->
name|agp_buffer_map
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|buffers_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|agp_buffer_map
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find dma buffer region!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|init
operator|->
name|gart_textures_offset
condition|)
block|{
name|dev_priv
operator|->
name|gart_textures
operator|=
name|drm_core_findmap
argument_list|(
name|dev
argument_list|,
name|init
operator|->
name|gart_textures_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|gart_textures
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find GART texture region!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|=
operator|(
name|drm_radeon_sarea_t
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|dev_priv
operator|->
name|sarea
operator|->
name|handle
operator|+
name|init
operator|->
name|sarea_priv_offset
operator|)
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|drm_core_ioremap
argument_list|(
name|dev_priv
operator|->
name|cp_ring
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|drm_core_ioremap
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|drm_core_ioremap
argument_list|(
name|dev
operator|->
name|agp_buffer_map
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
operator|||
operator|!
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
operator|||
operator|!
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"could not find ioremap agp regions!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
operator|->
name|cp_ring
operator|->
name|offset
expr_stmt|;
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|offset
expr_stmt|;
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|offset
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->cp_ring->handle %p\n"
argument_list|,
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->ring_rptr->handle %p\n"
argument_list|,
name|dev_priv
operator|->
name|ring_rptr
operator|->
name|handle
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev->agp_buffer_map->handle %p\n"
argument_list|,
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
argument_list|)
expr_stmt|;
block|}
name|dev_priv
operator|->
name|fb_location
operator|=
operator|(
name|radeon_read_fb_location
argument_list|(
name|dev_priv
argument_list|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
expr_stmt|;
name|dev_priv
operator|->
name|fb_size
operator|=
operator|(
operator|(
name|radeon_read_fb_location
argument_list|(
name|dev_priv
argument_list|)
operator|&
literal|0xffff0000u
operator|)
operator|+
literal|0x10000
operator|)
operator|-
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
name|dev_priv
operator|->
name|front_pitch_offset
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|front_pitch
operator|/
literal|64
operator|)
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
name|dev_priv
operator|->
name|front_offset
operator|+
name|dev_priv
operator|->
name|fb_location
operator|)
operator|>>
literal|10
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|back_pitch_offset
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|back_pitch
operator|/
literal|64
operator|)
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
name|dev_priv
operator|->
name|back_offset
operator|+
name|dev_priv
operator|->
name|fb_location
operator|)
operator|>>
literal|10
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|depth_pitch_offset
operator|=
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|depth_pitch
operator|/
literal|64
operator|)
operator|<<
literal|22
operator|)
operator||
operator|(
operator|(
name|dev_priv
operator|->
name|depth_offset
operator|+
name|dev_priv
operator|->
name|fb_location
operator|)
operator|>>
literal|10
operator|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_size
operator|=
name|init
operator|->
name|gart_size
expr_stmt|;
comment|/* New let's set the memory map ... */
if|if
condition|(
name|dev_priv
operator|->
name|new_memmap
condition|)
block|{
name|u32
name|base
init|=
literal|0
decl_stmt|;
name|DRM_INFO
argument_list|(
literal|"Setting GART location based on new memory map\n"
argument_list|)
expr_stmt|;
comment|/* If using AGP, try to locate the AGP aperture at the same 		 * location in the card and on the bus, though we have to 		 * align it down. 		 */
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
name|base
operator|=
name|dev
operator|->
name|agp
operator|->
name|base
expr_stmt|;
comment|/* Check if valid */
if|if
condition|(
operator|(
name|base
operator|+
name|dev_priv
operator|->
name|gart_size
operator|-
literal|1
operator|)
operator|>=
name|dev_priv
operator|->
name|fb_location
operator|&&
name|base
operator|<
operator|(
name|dev_priv
operator|->
name|fb_location
operator|+
name|dev_priv
operator|->
name|fb_size
operator|-
literal|1
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Can't use AGP base @0x%08lx, won't fit\n"
argument_list|,
name|dev
operator|->
name|agp
operator|->
name|base
argument_list|)
expr_stmt|;
name|base
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* If not or if AGP is at 0 (Macs), try to put it elsewhere */
if|if
condition|(
name|base
operator|==
literal|0
condition|)
block|{
name|base
operator|=
name|dev_priv
operator|->
name|fb_location
operator|+
name|dev_priv
operator|->
name|fb_size
expr_stmt|;
if|if
condition|(
name|base
operator|<
name|dev_priv
operator|->
name|fb_location
operator|||
operator|(
operator|(
name|base
operator|+
name|dev_priv
operator|->
name|gart_size
operator|)
operator|&
literal|0xfffffffful
operator|)
operator|<
name|base
condition|)
name|base
operator|=
name|dev_priv
operator|->
name|fb_location
operator|-
name|dev_priv
operator|->
name|gart_size
expr_stmt|;
block|}
name|dev_priv
operator|->
name|gart_vm_start
operator|=
name|base
operator|&
literal|0xffc00000u
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|gart_vm_start
operator|!=
name|base
condition|)
name|DRM_INFO
argument_list|(
literal|"GART aligned down from 0x%08x to 0x%08x\n"
argument_list|,
name|base
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"Setting GART location based on old memory map\n"
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_vm_start
operator|=
name|dev_priv
operator|->
name|fb_location
operator|+
name|RADEON_READ
argument_list|(
name|RADEON_CONFIG_APER_SIZE
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
name|dev_priv
operator|->
name|gart_buffers_offset
operator|=
operator|(
name|dev
operator|->
name|agp_buffer_map
operator|->
name|offset
operator|-
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
else|else
endif|#
directive|endif
name|dev_priv
operator|->
name|gart_buffers_offset
operator|=
operator|(
name|dev
operator|->
name|agp_buffer_map
operator|->
name|offset
operator|-
operator|(
name|unsigned
name|long
operator|)
name|dev
operator|->
name|sg
operator|->
name|virtual
operator|+
name|dev_priv
operator|->
name|gart_vm_start
operator|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->gart_size %d\n"
argument_list|,
name|dev_priv
operator|->
name|gart_size
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->gart_vm_start 0x%x\n"
argument_list|,
name|dev_priv
operator|->
name|gart_vm_start
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dev_priv->gart_buffers_offset 0x%lx\n"
argument_list|,
name|dev_priv
operator|->
name|gart_buffers_offset
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|start
operator|=
operator|(
name|u32
operator|*
operator|)
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|end
operator|=
operator|(
operator|(
name|u32
operator|*
operator|)
name|dev_priv
operator|->
name|cp_ring
operator|->
name|handle
operator|+
name|init
operator|->
name|ring_size
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|size
operator|=
name|init
operator|->
name|ring_size
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|size_l2qw
operator|=
name|drm_order
argument_list|(
name|init
operator|->
name|ring_size
operator|/
literal|8
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update
operator|=
comment|/* init->rptr_update */
literal|4096
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|rptr_update_l2qw
operator|=
name|drm_order
argument_list|(
comment|/* init->rptr_update */
literal|4096
operator|/
literal|8
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|fetch_size
operator|=
comment|/* init->fetch_size */
literal|32
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|fetch_size_l2ow
operator|=
name|drm_order
argument_list|(
comment|/* init->fetch_size */
literal|32
operator|/
literal|16
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|tail_mask
operator|=
operator|(
name|dev_priv
operator|->
name|ring
operator|.
name|size
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|ring
operator|.
name|high_mark
operator|=
name|RADEON_RING_HIGH_MARK
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
comment|/* Turn off PCI GART */
name|radeon_set_pcigart
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|dev_priv
operator|->
name|gart_info
operator|.
name|table_mask
operator|=
name|DMA_BIT_MASK
argument_list|(
literal|32
argument_list|)
expr_stmt|;
comment|/* if we have an offset set from userspace */
if|if
condition|(
name|dev_priv
operator|->
name|pcigart_offset_set
condition|)
block|{
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
operator|=
name|dev_priv
operator|->
name|pcigart_offset
operator|+
name|dev_priv
operator|->
name|fb_location
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
operator|.
name|offset
operator|=
name|dev_priv
operator|->
name|pcigart_offset
operator|+
name|dev_priv
operator|->
name|fb_aper_offset
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
operator|.
name|size
operator|=
name|dev_priv
operator|->
name|gart_info
operator|.
name|table_size
expr_stmt|;
name|drm_core_ioremap_wc
argument_list|(
operator|&
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|addr
operator|=
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
operator|.
name|handle
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_reg_if
operator|=
name|DRM_ATI_GART_PCIE
expr_stmt|;
else|else
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_reg_if
operator|=
name|DRM_ATI_GART_PCI
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_table_location
operator|=
name|DRM_ATI_GART_FB
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Setting phys_pci_gart to %p %08lX\n"
argument_list|,
name|dev_priv
operator|->
name|gart_info
operator|.
name|addr
argument_list|,
name|dev_priv
operator|->
name|pcigart_offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_IGPGART
condition|)
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_reg_if
operator|=
name|DRM_ATI_GART_IGP
expr_stmt|;
else|else
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_reg_if
operator|=
name|DRM_ATI_GART_PCI
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_table_location
operator|=
name|DRM_ATI_GART_MAIN
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|addr
operator|=
name|NULL
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Cannot use PCI Express without GART in FB memory\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
operator|!
name|drm_ati_pcigart_init
argument_list|(
name|dev
argument_list|,
operator|&
name|dev_priv
operator|->
name|gart_info
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"failed to init PCI GART!\n"
argument_list|)
expr_stmt|;
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
comment|/* Turn on PCI GART */
name|radeon_set_pcigart
argument_list|(
name|dev_priv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Start with assuming that writeback doesn't work */
name|dev_priv
operator|->
name|writeback_works
operator|=
literal|0
expr_stmt|;
name|radeon_cp_load_microcode
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|radeon_cp_init_ring_buffer
argument_list|(
name|dev
argument_list|,
name|dev_priv
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|last_buf
operator|=
literal|0
expr_stmt|;
name|radeon_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|radeon_test_writeback
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_do_cleanup_cp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* Make sure interrupts are disabled here because the uninstall ioctl 	 * may not have been called from userspace and after dev_private 	 * is freed, it's too late. 	 */
if|if
condition|(
name|dev
operator|->
name|irq_enabled
condition|)
name|drm_irq_uninstall
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
if|if
condition|(
name|dev_priv
operator|->
name|cp_ring
operator|!=
name|NULL
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
name|dev_priv
operator|->
name|cp_ring
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|cp_ring
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dev_priv
operator|->
name|ring_rptr
operator|!=
name|NULL
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
name|dev_priv
operator|->
name|ring_rptr
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|ring_rptr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|dev
operator|->
name|agp_buffer_map
operator|!=
name|NULL
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
name|dev
operator|->
name|agp_buffer_map
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev
operator|->
name|agp_buffer_map
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
if|if
condition|(
name|dev_priv
operator|->
name|gart_info
operator|.
name|bus_addr
condition|)
block|{
comment|/* Turn off PCI GART */
name|radeon_set_pcigart
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drm_ati_pcigart_cleanup
argument_list|(
name|dev
argument_list|,
operator|&
name|dev_priv
operator|->
name|gart_info
argument_list|)
condition|)
name|DRM_ERROR
argument_list|(
literal|"failed to cleanup PCI GART!\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dev_priv
operator|->
name|gart_info
operator|.
name|gart_table_location
operator|==
name|DRM_ATI_GART_FB
condition|)
block|{
name|drm_core_ioremapfree
argument_list|(
operator|&
name|dev_priv
operator|->
name|gart_info
operator|.
name|mapping
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|addr
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* only clear to the start of flags */
name|memset
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|,
name|offsetof
argument_list|(
name|drm_radeon_private_t
argument_list|,
name|flags
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* This code will reinit the Radeon CP hardware after a resume from disc.  * AFAIK, it would be very difficult to pickle the state at suspend time, so  * here we make sure that all Radeon hardware initialisation is re-done without  * affecting running applications.  *  * Charl P. Botha<http://cpbotha.net>  */
end_comment

begin_function
specifier|static
name|int
name|radeon_do_resume_cp
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Called with no initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"Starting radeon_do_resume_cp()\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|__OS_HAS_AGP
if|if
condition|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
condition|)
block|{
comment|/* Turn off PCI GART */
name|radeon_set_pcigart
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
comment|/* Turn on PCI GART */
name|radeon_set_pcigart
argument_list|(
name|dev_priv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|radeon_cp_load_microcode
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|radeon_cp_init_ring_buffer
argument_list|(
name|dev
argument_list|,
name|dev_priv
argument_list|)
expr_stmt|;
name|radeon_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|radeon_irq_set_state
argument_list|(
name|dev
argument_list|,
name|RADEON_SW_INT_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"radeon_do_resume_cp() complete\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_radeon_init_t
modifier|*
name|init
init|=
name|data
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
operator|->
name|func
operator|==
name|RADEON_INIT_R300_CP
condition|)
name|r300_init_reg_flags
argument_list|(
name|dev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|init
operator|->
name|func
condition|)
block|{
case|case
name|RADEON_INIT_CP
case|:
case|case
name|RADEON_INIT_R200_CP
case|:
case|case
name|RADEON_INIT_R300_CP
case|:
return|return
name|radeon_do_init_cp
argument_list|(
name|dev
argument_list|,
name|init
argument_list|)
return|;
case|case
name|RADEON_CLEANUP_CP
case|:
return|return
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
return|;
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_start
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|cp_running
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"while CP running\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|dev_priv
operator|->
name|cp_mode
operator|==
name|RADEON_CSQ_PRIDIS_INDDIS
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"called with bogus CP mode (%d)\n"
argument_list|,
name|dev_priv
operator|->
name|cp_mode
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|radeon_do_cp_start
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Stop the CP.  The engine must have been idled before calling this  * routine.  */
end_comment

begin_function
name|int
name|radeon_cp_stop
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_cp_stop_t
modifier|*
name|stop
init|=
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|cp_running
condition|)
return|return
literal|0
return|;
comment|/* Flush any pending CP commands.  This ensures any outstanding 	 * commands are exectuted by the engine before we turn it off. 	 */
if|if
condition|(
name|stop
operator|->
name|flush
condition|)
block|{
name|radeon_do_cp_flush
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
comment|/* If we fail to make the engine go idle, we return an error 	 * code so that the DRM ioctl wrapper can try again. 	 */
if|if
condition|(
name|stop
operator|->
name|idle
condition|)
block|{
name|ret
operator|=
name|radeon_do_cp_idle
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
comment|/* Finally, we can turn off the CP.  If the engine isn't idle, 	 * we will get some dropped triangles as they won't be fully 	 * rendered before the CP is shut down. 	 */
name|radeon_do_cp_stop
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* Reset the engine */
name|radeon_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radeon_do_release
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|dev_priv
condition|)
block|{
if|if
condition|(
name|dev_priv
operator|->
name|cp_running
condition|)
block|{
comment|/* Stop the cp */
while|while
condition|(
operator|(
name|ret
operator|=
name|radeon_do_cp_idle
argument_list|(
name|dev_priv
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"radeon_do_cp_idle %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|schedule
argument_list|()
expr_stmt|;
else|#
directive|else
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>
literal|500000
name|mtx_sleep
argument_list|(
operator|&
name|ret
argument_list|,
operator|&
name|dev
operator|->
name|dev_lock
argument_list|,
name|PZERO
argument_list|,
literal|"rdnrel"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
name|tsleep
argument_list|(
operator|&
name|ret
argument_list|,
name|PZERO
argument_list|,
literal|"rdnrel"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
block|}
name|radeon_do_cp_stop
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|radeon_do_engine_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* Disable *all* interrupts */
if|if
condition|(
name|dev_priv
operator|->
name|mmio
condition|)
comment|/* remove this after permanent addmaps */
name|RADEON_WRITE
argument_list|(
name|RADEON_GEN_INT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|mmio
condition|)
block|{
comment|/* remove all surfaces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_MAX_SURFACES
condition|;
name|i
operator|++
control|)
block|{
name|RADEON_WRITE
argument_list|(
name|RADEON_SURFACE0_INFO
operator|+
literal|16
operator|*
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_SURFACE0_LOWER_BOUND
operator|+
literal|16
operator|*
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RADEON_WRITE
argument_list|(
name|RADEON_SURFACE0_UPPER_BOUND
operator|+
literal|16
operator|*
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Free memory heap structures */
name|radeon_mem_takedown
argument_list|(
operator|&
operator|(
name|dev_priv
operator|->
name|gart_heap
operator|)
argument_list|)
expr_stmt|;
name|radeon_mem_takedown
argument_list|(
operator|&
operator|(
name|dev_priv
operator|->
name|fb_heap
operator|)
argument_list|)
expr_stmt|;
comment|/* deallocate kernel resources */
name|radeon_do_cleanup_cp
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Just reset the CP ring.  Called as part of an X Server engine reset.  */
end_comment

begin_function
name|int
name|radeon_cp_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"called before init done\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|radeon_do_cp_reset
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* The CP is no longer running after an engine reset */
name|dev_priv
operator|->
name|cp_running
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_idle
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
return|return
name|radeon_do_cp_idle
argument_list|(
name|dev_priv
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Added by Charl P. Botha to call radeon_do_resume_cp().  */
end_comment

begin_function
name|int
name|radeon_cp_resume
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
return|return
name|radeon_do_resume_cp
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|radeon_engine_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
return|return
name|radeon_do_engine_reset
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ================================================================  * Fullscreen mode  */
end_comment

begin_comment
comment|/* KW: Deprecated to say the least:  */
end_comment

begin_function
name|int
name|radeon_fullscreen
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ================================================================  * Freelist management  */
end_comment

begin_comment
comment|/* Original comment: FIXME: ROTATE_BUFS is a hack to cycle through  *   bufs until freelist code is used.  Note this hides a problem with  *   the scratch register * (used to keep track of last buffer  *   completed) being written to before * the last buffer has actually  *   completed rendering.  *  * KW:  It's also a good way to find free buffers quickly.  *  * KW: Ideally this loop wouldn't exist, and freelist_get wouldn't  * sleep.  However, bugs in older versions of radeon_accel.c mean that  * we essentially have to do this, else old clients will break.  *  * However, it does leave open a potential deadlock where all the  * buffers are held by other clients, which can't release them because  * they can't get the lock.  */
end_comment

begin_function
name|struct
name|drm_buf
modifier|*
name|radeon_freelist_get
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|t
decl_stmt|;
name|int
name|start
decl_stmt|;
if|if
condition|(
operator|++
name|dev_priv
operator|->
name|last_buf
operator|>=
name|dma
operator|->
name|buf_count
condition|)
name|dev_priv
operator|->
name|last_buf
operator|=
literal|0
expr_stmt|;
name|start
operator|=
name|dev_priv
operator|->
name|last_buf
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|t
operator|++
control|)
block|{
name|u32
name|done_age
init|=
name|GET_SCRATCH
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"done_age = %d\n"
argument_list|,
name|done_age
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
name|dma
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|i
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|file_priv
operator|==
name|NULL
operator|||
operator|(
name|buf
operator|->
name|pending
operator|&&
name|buf_priv
operator|->
name|age
operator|<=
name|done_age
operator|)
condition|)
block|{
name|dev_priv
operator|->
name|stats
operator|.
name|requested_bufs
operator|++
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
return|return
name|buf
return|;
block|}
name|start
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|t
condition|)
block|{
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|stats
operator|.
name|freelist_loops
operator|++
expr_stmt|;
block|}
block|}
name|DRM_DEBUG
argument_list|(
literal|"returning NULL!\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|struct drm_buf *radeon_freelist_get(struct drm_device * dev) { 	struct drm_device_dma *dma = dev->dma; 	drm_radeon_private_t *dev_priv = dev->dev_private; 	drm_radeon_buf_priv_t *buf_priv; 	struct drm_buf *buf; 	int i, t; 	int start; 	u32 done_age = DRM_READ32(dev_priv->ring_rptr, RADEON_SCRATCHOFF(1));  	if (++dev_priv->last_buf>= dma->buf_count) 		dev_priv->last_buf = 0;  	start = dev_priv->last_buf; 	dev_priv->stats.freelist_loops++;  	for (t = 0; t< 2; t++) { 		for (i = start; i< dma->buf_count; i++) { 			buf = dma->buflist[i]; 			buf_priv = buf->dev_private; 			if (buf->file_priv == 0 || (buf->pending&& 						    buf_priv->age<= 						    done_age)) { 				dev_priv->stats.requested_bufs++; 				buf->pending = 0; 				return buf; 			} 		} 		start = 0; 	}  	return NULL; }
endif|#
directive|endif
end_endif

begin_function
name|void
name|radeon_freelist_reset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev_priv
operator|->
name|last_buf
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dma
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|drm_buf
modifier|*
name|buf
init|=
name|dma
operator|->
name|buflist
index|[
name|i
index|]
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|buf_priv
operator|->
name|age
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ================================================================  * CP command submission  */
end_comment

begin_function
name|int
name|radeon_wait_ring
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|drm_radeon_ring_buffer_t
modifier|*
name|ring
init|=
operator|&
name|dev_priv
operator|->
name|ring
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u32
name|last_head
init|=
name|GET_RING_HEAD
argument_list|(
name|dev_priv
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev_priv
operator|->
name|usec_timeout
condition|;
name|i
operator|++
control|)
block|{
name|u32
name|head
init|=
name|GET_RING_HEAD
argument_list|(
name|dev_priv
argument_list|)
decl_stmt|;
name|ring
operator|->
name|space
operator|=
operator|(
name|head
operator|-
name|ring
operator|->
name|tail
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|space
operator|<=
literal|0
condition|)
name|ring
operator|->
name|space
operator|+=
name|ring
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|space
operator|>
name|n
condition|)
return|return
literal|0
return|;
name|dev_priv
operator|->
name|stats
operator|.
name|boxes
operator||=
name|RADEON_BOX_WAIT_IDLE
expr_stmt|;
if|if
condition|(
name|head
operator|!=
name|last_head
condition|)
name|i
operator|=
literal|0
expr_stmt|;
name|last_head
operator|=
name|head
expr_stmt|;
name|DRM_UDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* FIXME: This return value is ignored in the BEGIN_RING macro! */
if|#
directive|if
name|RADEON_FIFO_DEBUG
name|radeon_status
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"failed!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|-
name|EBUSY
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_cp_get_buffers
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|struct
name|drm_dma
modifier|*
name|d
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
for|for
control|(
name|i
operator|=
name|d
operator|->
name|granted_count
init|;
name|i
operator|<
name|d
operator|->
name|request_count
condition|;
name|i
operator|++
control|)
block|{
name|buf
operator|=
name|radeon_freelist_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
operator|-
name|EBUSY
return|;
comment|/* NOTE: broken client */
name|buf
operator|->
name|file_priv
operator|=
name|file_priv
expr_stmt|;
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|d
operator|->
name|request_indices
index|[
name|i
index|]
argument_list|,
operator|&
name|buf
operator|->
name|idx
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
operator|->
name|idx
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|d
operator|->
name|request_sizes
index|[
name|i
index|]
argument_list|,
operator|&
name|buf
operator|->
name|total
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
operator|->
name|total
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|d
operator|->
name|granted_count
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_buffers
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|drm_dma
modifier|*
name|d
init|=
name|data
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
comment|/* Please don't send us buffers. 	 */
if|if
condition|(
name|d
operator|->
name|send_count
operator|!=
literal|0
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Process %d trying to send %d buffers via drmDMA\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|d
operator|->
name|send_count
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* We'll send you buffers. 	 */
if|if
condition|(
name|d
operator|->
name|request_count
operator|<
literal|0
operator|||
name|d
operator|->
name|request_count
operator|>
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Process %d trying to get %d buffers (of %d max)\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|d
operator|->
name|request_count
argument_list|,
name|dma
operator|->
name|buf_count
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|d
operator|->
name|granted_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|request_count
condition|)
block|{
name|ret
operator|=
name|radeon_cp_get_buffers
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|,
name|d
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|radeon_driver_load
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|unsigned
name|long
name|flags
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|dev_priv
operator|=
name|drm_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|drm_radeon_private_t
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|memset
argument_list|(
name|dev_priv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|drm_radeon_private_t
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
operator|(
name|void
operator|*
operator|)
name|dev_priv
expr_stmt|;
name|dev_priv
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
switch|switch
condition|(
name|flags
operator|&
name|RADEON_FAMILY_MASK
condition|)
block|{
case|case
name|CHIP_R100
case|:
case|case
name|CHIP_RV200
case|:
case|case
name|CHIP_R200
case|:
case|case
name|CHIP_R300
case|:
case|case
name|CHIP_R350
case|:
case|case
name|CHIP_R420
case|:
case|case
name|CHIP_R423
case|:
case|case
name|CHIP_RV410
case|:
case|case
name|CHIP_RV515
case|:
case|case
name|CHIP_R520
case|:
case|case
name|CHIP_RV570
case|:
case|case
name|CHIP_R580
case|:
name|dev_priv
operator|->
name|flags
operator||=
name|RADEON_HAS_HIERZ
expr_stmt|;
break|break;
default|default:
comment|/* all other chips have no hierarchical z buffer */
break|break;
block|}
name|dev_priv
operator|->
name|chip_family
operator|=
name|flags
operator|&
name|RADEON_FAMILY_MASK
expr_stmt|;
if|if
condition|(
name|drm_device_is_agp
argument_list|(
name|dev
argument_list|)
condition|)
name|dev_priv
operator|->
name|flags
operator||=
name|RADEON_IS_AGP
expr_stmt|;
elseif|else
if|if
condition|(
name|drm_device_is_pcie
argument_list|(
name|dev
argument_list|)
condition|)
name|dev_priv
operator|->
name|flags
operator||=
name|RADEON_IS_PCIE
expr_stmt|;
else|else
name|dev_priv
operator|->
name|flags
operator||=
name|RADEON_IS_PCI
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s card detected\n"
argument_list|,
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_AGP
operator|)
condition|?
literal|"AGP"
else|:
operator|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_IS_PCIE
operator|)
condition|?
literal|"PCIE"
else|:
literal|"PCI"
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Create mappings for registers and framebuffer so userland doesn't necessarily  * have to find them.  */
end_comment

begin_function
name|int
name|radeon_driver_firstopen
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|drm_local_map_t
modifier|*
name|map
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|dev_priv
operator|->
name|gart_info
operator|.
name|table_size
operator|=
name|RADEON_PCIGART_TABLE_SIZE
expr_stmt|;
name|ret
operator|=
name|drm_addmap
argument_list|(
name|dev
argument_list|,
name|drm_get_resource_start
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|)
argument_list|,
name|drm_get_resource_len
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|)
argument_list|,
name|_DRM_REGISTERS
argument_list|,
name|_DRM_READ_ONLY
argument_list|,
operator|&
name|dev_priv
operator|->
name|mmio
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
name|ret
return|;
name|dev_priv
operator|->
name|fb_aper_offset
operator|=
name|drm_get_resource_start
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|drm_addmap
argument_list|(
name|dev
argument_list|,
name|dev_priv
operator|->
name|fb_aper_offset
argument_list|,
name|drm_get_resource_len
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
argument_list|,
name|_DRM_FRAME_BUFFER
argument_list|,
name|_DRM_WRITE_COMBINING
argument_list|,
operator|&
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
name|ret
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_driver_unload
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|dev_priv
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dev_priv
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_private
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


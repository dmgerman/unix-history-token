begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* radeon_state.c -- State support for Radeon -*- linux-c -*-  *  * Copyright 2000 VA Linux Systems, Inc., Fremont, California.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Gareth Hughes<gareth@valinux.com>  *    Kevin E. Martin<martin@valinux.com>  *  * $FreeBSD$  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_define
define|#
directive|define
name|__NO_VERSION__
end_define

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __linux__ */
end_comment

begin_include
include|#
directive|include
file|"dev/drm/radeon.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_drv.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drm.h"
end_include

begin_comment
comment|/* ================================================================  * CP hardware state programming functions  */
end_comment

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_clip_rect
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|drm_clip_rect_t
modifier|*
name|box
parameter_list|)
block|{
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"   box:  x1=%d y1=%d  x2=%d y2=%d\n"
argument_list|,
name|box
operator|->
name|x1
argument_list|,
name|box
operator|->
name|y1
argument_list|,
name|box
operator|->
name|x2
argument_list|,
name|box
operator|->
name|y2
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RE_TOP_LEFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|box
operator|->
name|y1
operator|<<
literal|16
operator|)
operator||
name|box
operator|->
name|x1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RE_WIDTH_HEIGHT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
operator|(
name|box
operator|->
name|y2
operator|-
literal|1
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|box
operator|->
name|x2
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_context
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|14
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_MISC
argument_list|,
literal|6
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|pp_misc
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|pp_fog_color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|re_solid_color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_blendcntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_depthoffset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_depthpitch
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_zstencilcntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_CNTL
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|pp_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_coloroffset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RB3D_COLORPITCH
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_colorpitch
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_vertfmt
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SE_COORD_FMT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_coord_fmt
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_line
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RE_LINE_PATTERN
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|re_line_pattern
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|re_line_state
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SE_LINE_WIDTH
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_line_width
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_bumpmap
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_LUM_MATRIX
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|pp_lum_matrix
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_ROT_MATRIX_0
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|pp_rot_matrix_0
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|pp_rot_matrix_1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_masks
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RB3D_STENCILREFMASK
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_stencilrefmask
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_ropcntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|rb3d_planemask
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_viewport
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SE_VPORT_XSCALE
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_vport_xscale
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_vport_xoffset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_vport_yscale
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_vport_yoffset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_vport_zscale
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_vport_zoffset
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_setup
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SE_CNTL_STATUS
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_cntl_status
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_tcl
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|TCL_ENABLE
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|29
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SE_TCL_MATERIAL_EMMISSIVE_RED
argument_list|,
literal|27
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_emmissive
operator|.
name|red
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_emmissive
operator|.
name|green
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_emmissive
operator|.
name|blue
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_emmissive
operator|.
name|alpha
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_ambient
operator|.
name|red
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_ambient
operator|.
name|green
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_ambient
operator|.
name|blue
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_ambient
operator|.
name|alpha
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_diffuse
operator|.
name|red
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_diffuse
operator|.
name|green
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_diffuse
operator|.
name|blue
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_diffuse
operator|.
name|alpha
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_specular
operator|.
name|red
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_specular
operator|.
name|green
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_specular
operator|.
name|blue
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_material_specular
operator|.
name|alpha
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_shininess
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_output_vtx_fmt
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_output_vtx_sel
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_matrix_select_0
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_matrix_select_1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_ucp_vert_blend_ctl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_texture_proc_ctl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_light_model_ctl
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|se_tcl_per_light_ctl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ADVANCE_RING
argument_list|()
expr_stmt|;
else|#
directive|else
name|DRM_ERROR
argument_list|(
literal|"TCL not enabled!\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_misc
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RE_MISC
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|re_misc
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_tex0
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|0
index|]
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s: offset=0x%x\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|tex
operator|->
name|pp_txoffset
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_TXFILTER_0
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txfilter
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txformat
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txoffset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txcblend
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txablend
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_tfactor
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_BORDER_COLOR_0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_border_color
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_tex1
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|1
index|]
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s: offset=0x%x\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|tex
operator|->
name|pp_txoffset
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_TXFILTER_1
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txfilter
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txformat
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txoffset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txcblend
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txablend
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_tfactor
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_BORDER_COLOR_1
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_border_color
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_tex2
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|2
index|]
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"    %s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_TXFILTER_2
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txfilter
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txformat
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txoffset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txcblend
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_txablend
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_tfactor
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_BORDER_COLOR_2
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|pp_border_color
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|radeon_emit_state
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|unsigned
name|int
name|dirty
init|=
name|sarea_priv
operator|->
name|dirty
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s: dirty=0x%08x\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|dirty
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_CONTEXT
condition|)
block|{
name|radeon_emit_context
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_CONTEXT
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_VERTFMT
condition|)
block|{
name|radeon_emit_vertfmt
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_VERTFMT
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_LINE
condition|)
block|{
name|radeon_emit_line
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_LINE
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_BUMPMAP
condition|)
block|{
name|radeon_emit_bumpmap
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_BUMPMAP
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_MASKS
condition|)
block|{
name|radeon_emit_masks
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_MASKS
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_VIEWPORT
condition|)
block|{
name|radeon_emit_viewport
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_VIEWPORT
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_SETUP
condition|)
block|{
name|radeon_emit_setup
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_SETUP
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_TCL
condition|)
block|{
ifdef|#
directive|ifdef
name|TCL_ENABLE
name|radeon_emit_tcl
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_TCL
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_MISC
condition|)
block|{
name|radeon_emit_misc
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_MISC
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_TEX0
condition|)
block|{
name|radeon_emit_tex0
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_TEX0
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_TEX1
condition|)
block|{
name|radeon_emit_tex1
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_TEX1
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|RADEON_UPLOAD_TEX2
condition|)
block|{
if|#
directive|if
literal|0
block|radeon_emit_tex2( dev_priv );
endif|#
directive|endif
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_TEX2
expr_stmt|;
block|}
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
operator|(
name|RADEON_UPLOAD_TEX0IMAGES
operator||
name|RADEON_UPLOAD_TEX1IMAGES
operator||
name|RADEON_UPLOAD_TEX2IMAGES
operator||
name|RADEON_REQUIRE_QUIESCENCE
operator|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|RADEON_PERFORMANCE_BOXES
end_if

begin_comment
comment|/* ================================================================  * Performance monitoring functions  */
end_comment

begin_function
specifier|static
name|void
name|radeon_clear_box
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|r
parameter_list|,
name|int
name|g
parameter_list|,
name|int
name|b
parameter_list|)
block|{
name|u32
name|pitch
decl_stmt|,
name|offset
decl_stmt|;
name|u32
name|color
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|color_fmt
condition|)
block|{
case|case
name|RADEON_COLOR_FORMAT_RGB565
case|:
name|color
operator|=
operator|(
operator|(
operator|(
name|r
operator|&
literal|0xf8
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|g
operator|&
literal|0xfc
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|b
operator|&
literal|0xf8
operator|)
operator|>>
literal|3
operator|)
operator|)
expr_stmt|;
break|break;
case|case
name|RADEON_COLOR_FORMAT_ARGB8888
case|:
default|default:
name|color
operator|=
operator|(
operator|(
operator|(
literal|0xff
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
name|r
operator|<<
literal|16
operator|)
operator||
operator|(
name|g
operator|<<
literal|8
operator|)
operator||
name|b
operator|)
expr_stmt|;
break|break;
block|}
name|offset
operator|=
name|dev_priv
operator|->
name|back_offset
expr_stmt|;
name|pitch
operator|=
name|dev_priv
operator|->
name|back_pitch
operator|>>
literal|3
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|RADEON_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|8
operator|)
operator||
name|RADEON_GMC_SRC_DATATYPE_COLOR
operator||
name|RADEON_ROP3_P
operator||
name|RADEON_GMC_CLR_CMP_CNTL_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|pitch
operator|<<
literal|22
operator|)
operator||
operator|(
name|offset
operator|>>
literal|5
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_performance_boxes
parameter_list|(
name|drm_radeon_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|dev_priv
operator|->
name|idle_count
argument_list|)
operator|==
literal|0
condition|)
block|{
name|radeon_clear_box
argument_list|(
name|dev_priv
argument_list|,
literal|64
argument_list|,
literal|4
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|atomic_set
argument_list|(
operator|&
name|dev_priv
operator|->
name|idle_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ================================================================  * CP command dispatch functions  */
end_comment

begin_function
specifier|static
name|void
name|radeon_print_dirty
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"%s: (0x%x) %s%s%s%s%s%s%s%s%s%s%s%s%s%s\n"
argument_list|,
name|msg
argument_list|,
name|flags
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_CONTEXT
operator|)
condition|?
literal|"context, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_VERTFMT
operator|)
condition|?
literal|"vertfmt, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_LINE
operator|)
condition|?
literal|"line, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_BUMPMAP
operator|)
condition|?
literal|"bumpmap, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_MASKS
operator|)
condition|?
literal|"masks, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_VIEWPORT
operator|)
condition|?
literal|"viewport, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_SETUP
operator|)
condition|?
literal|"setup, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_TCL
operator|)
condition|?
literal|"tcl, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_MISC
operator|)
condition|?
literal|"misc, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_TEX0
operator|)
condition|?
literal|"tex0, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_TEX1
operator|)
condition|?
literal|"tex1, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_TEX2
operator|)
condition|?
literal|"tex2, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_UPLOAD_CLIPRECTS
operator|)
condition|?
literal|"cliprects, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|RADEON_REQUIRE_QUIESCENCE
operator|)
condition|?
literal|"quiescence, "
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_dispatch_clear
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_radeon_clear_t
modifier|*
name|clear
parameter_list|,
name|drm_radeon_clear_rect_t
modifier|*
name|depth_boxes
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|drm_clip_rect_t
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|unsigned
name|int
name|flags
init|=
name|clear
operator|->
name|flags
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|page_flipping
operator|&&
name|dev_priv
operator|->
name|current_page
operator|==
literal|1
condition|)
block|{
name|unsigned
name|int
name|tmp
init|=
name|flags
decl_stmt|;
name|flags
operator|&=
operator|~
operator|(
name|RADEON_FRONT
operator||
name|RADEON_BACK
operator|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_FRONT
condition|)
name|flags
operator||=
name|RADEON_BACK
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_BACK
condition|)
name|flags
operator||=
name|RADEON_FRONT
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|int
name|x
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x1
decl_stmt|;
name|int
name|y
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y1
decl_stmt|;
name|int
name|w
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x2
operator|-
name|x
decl_stmt|;
name|int
name|h
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y2
operator|-
name|y
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dispatch clear %d,%d-%d,%d flags 0x%x\n"
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
operator|(
name|RADEON_FRONT
operator||
name|RADEON_BACK
operator|)
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
comment|/* Ensure the 3D stream is idle before doing a 			 * 2D fill to clear the front or back buffer. 			 */
name|RADEON_WAIT_UNTIL_3D_IDLE
argument_list|()
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_DP_WRITE_MASK
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|clear
operator|->
name|color_mask
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* Make sure we restore the 3D state next time. 			 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
operator|(
name|RADEON_UPLOAD_CONTEXT
operator||
name|RADEON_UPLOAD_MASKS
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|RADEON_FRONT
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|RADEON_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|8
operator|)
operator||
name|RADEON_GMC_SRC_DATATYPE_COLOR
operator||
name|RADEON_ROP3_P
operator||
name|RADEON_GMC_CLR_CMP_CNTL_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|front_pitch_offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|clear
operator|->
name|clear_color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|RADEON_BACK
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|RADEON_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|8
operator|)
operator||
name|RADEON_GMC_SRC_DATATYPE_COLOR
operator||
name|RADEON_ROP3_P
operator||
name|RADEON_GMC_CLR_CMP_CNTL_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|back_pitch_offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|clear
operator|->
name|clear_color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|RADEON_DEPTH
condition|)
block|{
name|drm_radeon_depth_clear_t
modifier|*
name|depth_clear
init|=
operator|&
name|dev_priv
operator|->
name|depth_clear
decl_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|dirty
operator|&
operator|~
name|RADEON_UPLOAD_CLIPRECTS
condition|)
block|{
name|radeon_emit_state
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
comment|/* FIXME: Render a rectangle to clear the depth 			 * buffer.  So much for those "fast Z clears"... 			 */
name|BEGIN_RING
argument_list|(
literal|23
argument_list|)
expr_stmt|;
name|RADEON_WAIT_UNTIL_2D_IDLE
argument_list|()
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_PP_CNTL
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0x00000000
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_clear
operator|->
name|rb3d_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RB3D_ZSTENCILCNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_clear
operator|->
name|rb3d_zstencilcntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RB3D_PLANEMASK
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0x00000000
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_SE_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_clear
operator|->
name|se_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|RADEON_3D_DRAW_IMMD
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_VTX_Z_PRESENT
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|RADEON_PRIM_TYPE_RECT_LIST
operator||
name|RADEON_PRIM_WALK_RING
operator||
name|RADEON_MAOS_ENABLE
operator||
name|RADEON_VTX_FMT_RADEON_MODE
operator||
operator|(
literal|3
operator|<<
name|RADEON_NUM_VERTICES_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_X1
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_Y1
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_DEPTH
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_X1
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_Y2
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_DEPTH
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_X2
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_Y2
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|depth_boxes
index|[
name|i
index|]
operator|.
name|ui
index|[
name|CLEAR_DEPTH
index|]
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* Make sure we restore the 3D state next time. 			 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
operator|(
name|RADEON_UPLOAD_CONTEXT
operator||
name|RADEON_UPLOAD_SETUP
operator||
name|RADEON_UPLOAD_MASKS
operator|)
expr_stmt|;
block|}
block|}
comment|/* Increment the clear counter.  The client-side 3D driver must 	 * wait on this value before performing the clear ioctl.  We 	 * need this because the card's so damned fast... 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_clear
operator|++
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|RADEON_CLEAR_AGE
argument_list|(
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_clear
argument_list|)
expr_stmt|;
name|RADEON_WAIT_UNTIL_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_dispatch_swap
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|drm_clip_rect_t
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
if|#
directive|if
name|RADEON_PERFORMANCE_BOXES
comment|/* Do some trivial performance monitoring... 	 */
name|radeon_cp_performance_boxes
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Wait for the 3D stream to idle before dispatching the bitblt. 	 * This will prevent data corruption between the two streams. 	 */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_WAIT_UNTIL_3D_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|int
name|x
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x1
decl_stmt|;
name|int
name|y
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y1
decl_stmt|;
name|int
name|w
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x2
operator|-
name|x
decl_stmt|;
name|int
name|h
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y2
operator|-
name|y
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dispatch swap %d,%d-%d,%d\n"
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|RADEON_CNTL_BITBLT_MULTI
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|RADEON_GMC_SRC_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_BRUSH_NONE
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|8
operator|)
operator||
name|RADEON_GMC_SRC_DATATYPE_COLOR
operator||
name|RADEON_ROP3_S
operator||
name|RADEON_DP_SRC_SOURCE_MEMORY
operator||
name|RADEON_GMC_CLR_CMP_CNTL_DIS
operator||
name|RADEON_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|back_pitch_offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|front_pitch_offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
comment|/* Increment the frame counter.  The client-side 3D driver must 	 * throttle the framerate by waiting for this value before 	 * performing the swapbuffer ioctl. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|++
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|RADEON_FRAME_AGE
argument_list|(
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
argument_list|)
expr_stmt|;
name|RADEON_WAIT_UNTIL_2D_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_dispatch_flip
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s: page=%d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|dev_priv
operator|->
name|current_page
argument_list|)
expr_stmt|;
if|#
directive|if
name|RADEON_PERFORMANCE_BOXES
comment|/* Do some trivial performance monitoring... 	 */
name|radeon_cp_performance_boxes
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|RADEON_WAIT_UNTIL_3D_IDLE
argument_list|()
expr_stmt|;
name|RADEON_WAIT_UNTIL_PAGE_FLIPPED
argument_list|()
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_CRTC_OFFSET
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|current_page
operator|==
literal|0
condition|)
block|{
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|back_offset
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|current_page
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|front_offset
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|current_page
operator|=
literal|0
expr_stmt|;
block|}
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* Increment the frame counter.  The client-side 3D driver must 	 * throttle the framerate by waiting for this value before 	 * performing the swapbuffer ioctl. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|++
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_FRAME_AGE
argument_list|(
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_dispatch_vertex
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_t
modifier|*
name|buf
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|format
init|=
name|sarea_priv
operator|->
name|vc_format
decl_stmt|;
name|int
name|offset
init|=
name|dev_priv
operator|->
name|agp_buffers_offset
operator|+
name|buf
operator|->
name|offset
decl_stmt|;
name|int
name|size
init|=
name|buf
operator|->
name|used
decl_stmt|;
name|int
name|prim
init|=
name|buf_priv
operator|->
name|prim
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s: nbox=%d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|sarea_priv
operator|->
name|nbox
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
condition|)
name|radeon_print_dirty
argument_list|(
literal|"dispatch_vertex"
argument_list|,
name|sarea_priv
operator|->
name|dirty
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|used
condition|)
block|{
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|dirty
operator|&
operator|~
name|RADEON_UPLOAD_CLIPRECTS
condition|)
block|{
name|radeon_emit_state
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
do|do
block|{
comment|/* Emit the next set of up to three cliprects */
if|if
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
block|{
name|radeon_emit_clip_rect
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|sarea_priv
operator|->
name|boxes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* Emit the vertex buffer rendering commands */
name|BEGIN_RING
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET3
argument_list|(
name|RADEON_3D_RNDR_GEN_INDX_PRIM
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|format
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|prim
operator||
name|RADEON_PRIM_WALK_LIST
operator||
name|RADEON_COLOR_ORDER_RGBA
operator||
name|RADEON_VTX_FMT_RADEON_MODE
operator||
operator|(
name|size
operator|<<
name|RADEON_NUM_VERTICES_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
do|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|buf_priv
operator|->
name|age
operator|=
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
expr_stmt|;
comment|/* Emit the vertex buffer age */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_DISPATCH_AGE
argument_list|(
name|buf_priv
operator|->
name|age
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
comment|/* FIXME: Check dispatched field */
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|++
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_CLIPRECTS
expr_stmt|;
name|sarea_priv
operator|->
name|nbox
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_dispatch_indirect
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_t
modifier|*
name|buf
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"indirect: buf=%d s=0x%x e=0x%x\n"
argument_list|,
name|buf
operator|->
name|idx
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|end
condition|)
block|{
name|int
name|offset
init|=
operator|(
name|dev_priv
operator|->
name|agp_buffers_offset
operator|+
name|buf
operator|->
name|offset
operator|+
name|start
operator|)
decl_stmt|;
name|int
name|dwords
init|=
operator|(
name|end
operator|-
name|start
operator|+
literal|3
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
decl_stmt|;
comment|/* Indirect buffer data must be an even number of 		 * dwords, so if we've been given an odd number we must 		 * pad the data with a Type-2 CP packet. 		 */
if|if
condition|(
name|dwords
operator|&
literal|1
condition|)
block|{
name|u32
modifier|*
name|data
init|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev_priv
operator|->
name|buffers
operator|->
name|handle
operator|+
name|buf
operator|->
name|offset
operator|+
name|start
operator|)
decl_stmt|;
name|data
index|[
name|dwords
operator|++
index|]
operator|=
name|RADEON_CP_PACKET2
expr_stmt|;
block|}
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
comment|/* Fire off the indirect buffer */
name|BEGIN_RING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_CP_IB_BASE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dwords
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|buf_priv
operator|->
name|age
operator|=
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
expr_stmt|;
comment|/* Emit the indirect buffer age */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_DISPATCH_AGE
argument_list|(
name|buf_priv
operator|->
name|age
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
comment|/* FIXME: Check dispatched field */
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_dispatch_indices
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_t
modifier|*
name|buf
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|format
init|=
name|sarea_priv
operator|->
name|vc_format
decl_stmt|;
name|int
name|offset
init|=
name|dev_priv
operator|->
name|agp_buffers_offset
decl_stmt|;
name|int
name|prim
init|=
name|buf_priv
operator|->
name|prim
decl_stmt|;
name|u32
modifier|*
name|data
decl_stmt|;
name|int
name|dwords
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"indices: s=%d e=%d c=%d\n"
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
condition|)
name|radeon_print_dirty
argument_list|(
literal|"dispatch_indices"
argument_list|,
name|sarea_priv
operator|->
name|dirty
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|end
condition|)
block|{
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|dirty
operator|&
operator|~
name|RADEON_UPLOAD_CLIPRECTS
condition|)
block|{
name|radeon_emit_state
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
name|dwords
operator|=
operator|(
name|end
operator|-
name|start
operator|+
literal|3
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev_priv
operator|->
name|buffers
operator|->
name|handle
operator|+
name|buf
operator|->
name|offset
operator|+
name|start
operator|)
expr_stmt|;
name|data
index|[
literal|0
index|]
operator|=
name|CP_PACKET3
argument_list|(
name|RADEON_3D_RNDR_GEN_INDX_PRIM
argument_list|,
name|dwords
operator|-
literal|2
argument_list|)
expr_stmt|;
name|data
index|[
literal|1
index|]
operator|=
name|offset
expr_stmt|;
name|data
index|[
literal|2
index|]
operator|=
name|RADEON_MAX_VB_VERTS
expr_stmt|;
name|data
index|[
literal|3
index|]
operator|=
name|format
expr_stmt|;
name|data
index|[
literal|4
index|]
operator|=
operator|(
name|prim
operator||
name|RADEON_PRIM_WALK_IND
operator||
name|RADEON_COLOR_ORDER_RGBA
operator||
name|RADEON_VTX_FMT_RADEON_MODE
operator||
operator|(
name|count
operator|<<
name|RADEON_NUM_VERTICES_SHIFT
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|count
operator|&
literal|0x1
condition|)
block|{
name|data
index|[
name|dwords
operator|-
literal|1
index|]
operator|&=
literal|0x0000ffff
expr_stmt|;
block|}
do|do
block|{
comment|/* Emit the next set of up to three cliprects */
if|if
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
block|{
name|radeon_emit_clip_rect
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|sarea_priv
operator|->
name|boxes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|radeon_cp_dispatch_indirect
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
do|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|buf_priv
operator|->
name|age
operator|=
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
expr_stmt|;
comment|/* Emit the vertex buffer age */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_DISPATCH_AGE
argument_list|(
name|buf_priv
operator|->
name|age
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|1
expr_stmt|;
comment|/* FIXME: Check dispatched field */
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|++
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|RADEON_UPLOAD_CLIPRECTS
expr_stmt|;
name|sarea_priv
operator|->
name|nbox
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|RADEON_MAX_TEXTURE_SIZE
value|(RADEON_BUFFER_SIZE - 8 * sizeof(u32))
end_define

begin_function
specifier|static
name|int
name|radeon_cp_dispatch_texture
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_radeon_texture_t
modifier|*
name|tex
parameter_list|,
name|drm_radeon_tex_image_t
modifier|*
name|image
parameter_list|,
name|int
name|pid
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|u32
name|format
decl_stmt|;
name|u32
modifier|*
name|buffer
decl_stmt|;
specifier|const
name|u8
modifier|*
name|data
decl_stmt|;
name|int
name|size
decl_stmt|,
name|dwords
decl_stmt|,
name|tex_width
decl_stmt|,
name|blit_width
decl_stmt|;
name|u32
name|y
decl_stmt|,
name|height
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
comment|/* FIXME: Be smarter about this... 	 */
name|buf
operator|=
name|radeon_freelist_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
name|DRM_OS_RETURN
argument_list|(
name|EAGAIN
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"tex: ofs=0x%x p=%d f=%d x=%hd y=%hd w=%hd h=%hd\n"
argument_list|,
name|tex
operator|->
name|offset
operator|>>
literal|10
argument_list|,
name|tex
operator|->
name|pitch
argument_list|,
name|tex
operator|->
name|format
argument_list|,
name|image
operator|->
name|x
argument_list|,
name|image
operator|->
name|y
argument_list|,
name|image
operator|->
name|width
argument_list|,
name|image
operator|->
name|height
argument_list|)
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
comment|/* The compiler won't optimize away a division by a variable, 	 * even if the only legal values are powers of two.  Thus, we'll 	 * use a shift instead. 	 */
switch|switch
condition|(
name|tex
operator|->
name|format
condition|)
block|{
case|case
name|RADEON_TXFORMAT_ARGB8888
case|:
case|case
name|RADEON_TXFORMAT_RGBA8888
case|:
name|format
operator|=
name|RADEON_COLOR_FORMAT_ARGB8888
expr_stmt|;
name|tex_width
operator|=
name|tex
operator|->
name|width
operator|*
literal|4
expr_stmt|;
name|blit_width
operator|=
name|image
operator|->
name|width
operator|*
literal|4
expr_stmt|;
break|break;
case|case
name|RADEON_TXFORMAT_AI88
case|:
case|case
name|RADEON_TXFORMAT_ARGB1555
case|:
case|case
name|RADEON_TXFORMAT_RGB565
case|:
case|case
name|RADEON_TXFORMAT_ARGB4444
case|:
name|format
operator|=
name|RADEON_COLOR_FORMAT_RGB565
expr_stmt|;
name|tex_width
operator|=
name|tex
operator|->
name|width
operator|*
literal|2
expr_stmt|;
name|blit_width
operator|=
name|image
operator|->
name|width
operator|*
literal|2
expr_stmt|;
break|break;
case|case
name|RADEON_TXFORMAT_I8
case|:
case|case
name|RADEON_TXFORMAT_RGB332
case|:
name|format
operator|=
name|RADEON_COLOR_FORMAT_CI8
expr_stmt|;
name|tex_width
operator|=
name|tex
operator|->
name|width
operator|*
literal|1
expr_stmt|;
name|blit_width
operator|=
name|image
operator|->
name|width
operator|*
literal|1
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"invalid texture format %d\n"
argument_list|,
name|tex
operator|->
name|format
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"   tex=%dx%d  blit=%d\n"
argument_list|,
name|tex_width
argument_list|,
name|tex
operator|->
name|height
argument_list|,
name|blit_width
argument_list|)
expr_stmt|;
comment|/* Flush the pixel cache.  This ensures no pixel data gets mixed 	 * up with the texture data from the host data blit, otherwise 	 * part of the texture image may be corrupted. 	 */
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|RADEON_FLUSH_CACHE
argument_list|()
expr_stmt|;
name|RADEON_WAIT_UNTIL_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* Make a copy of the parameters in case we have to update them 	 * for a multi-pass texture blit. 	 */
name|y
operator|=
name|image
operator|->
name|y
expr_stmt|;
name|height
operator|=
name|image
operator|->
name|height
expr_stmt|;
name|data
operator|=
name|image
operator|->
name|data
expr_stmt|;
name|size
operator|=
name|height
operator|*
name|blit_width
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|RADEON_MAX_TEXTURE_SIZE
condition|)
block|{
comment|/* Texture image is too large, do a multipass upload */
name|ret
operator|=
name|EAGAIN
expr_stmt|;
comment|/* Adjust the blit size to fit the indirect buffer */
name|height
operator|=
name|RADEON_MAX_TEXTURE_SIZE
operator|/
name|blit_width
expr_stmt|;
name|size
operator|=
name|height
operator|*
name|blit_width
expr_stmt|;
comment|/* Update the input parameters for next time */
name|image
operator|->
name|y
operator|+=
name|height
expr_stmt|;
name|image
operator|->
name|height
operator|-=
name|height
expr_stmt|;
name|image
operator|->
name|data
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|image
operator|->
name|data
operator|+
name|size
expr_stmt|;
if|if
condition|(
name|DRM_OS_COPYTOUSR
argument_list|(
name|tex
operator|->
name|image
argument_list|,
name|image
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|image
argument_list|)
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"EFAULT on tex->image\n"
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|size
operator|<
literal|4
operator|&&
name|size
operator|>
literal|0
condition|)
block|{
name|size
operator|=
literal|4
expr_stmt|;
block|}
name|dwords
operator|=
name|size
operator|/
literal|4
expr_stmt|;
comment|/* Dispatch the indirect buffer. 	 */
name|buffer
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev_priv
operator|->
name|buffers
operator|->
name|handle
operator|+
name|buf
operator|->
name|offset
operator|)
expr_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
name|CP_PACKET3
argument_list|(
name|RADEON_CNTL_HOSTDATA_BLT
argument_list|,
name|dwords
operator|+
literal|6
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|1
index|]
operator|=
operator|(
name|RADEON_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|RADEON_GMC_BRUSH_NONE
operator||
operator|(
name|format
operator|<<
literal|8
operator|)
operator||
name|RADEON_GMC_SRC_DATATYPE_COLOR
operator||
name|RADEON_ROP3_S
operator||
name|RADEON_DP_SRC_SOURCE_HOST_DATA
operator||
name|RADEON_GMC_CLR_CMP_CNTL_DIS
operator||
name|RADEON_GMC_WR_MSK_DIS
operator|)
expr_stmt|;
name|buffer
index|[
literal|2
index|]
operator|=
operator|(
name|tex
operator|->
name|pitch
operator|<<
literal|22
operator|)
operator||
operator|(
name|tex
operator|->
name|offset
operator|>>
literal|10
operator|)
expr_stmt|;
name|buffer
index|[
literal|3
index|]
operator|=
literal|0xffffffff
expr_stmt|;
name|buffer
index|[
literal|4
index|]
operator|=
literal|0xffffffff
expr_stmt|;
name|buffer
index|[
literal|5
index|]
operator|=
operator|(
name|y
operator|<<
literal|16
operator|)
operator||
name|image
operator|->
name|x
expr_stmt|;
name|buffer
index|[
literal|6
index|]
operator|=
operator|(
name|height
operator|<<
literal|16
operator|)
operator||
name|image
operator|->
name|width
expr_stmt|;
name|buffer
index|[
literal|7
index|]
operator|=
name|dwords
expr_stmt|;
name|buffer
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|tex_width
operator|>=
literal|32
condition|)
block|{
comment|/* Texture image width is larger than the minimum, so we 		 * can upload it directly. 		 */
if|if
condition|(
name|DRM_OS_COPYFROMUSR
argument_list|(
name|buffer
argument_list|,
name|data
argument_list|,
name|dwords
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"EFAULT on data, %d dwords\n"
argument_list|,
name|dwords
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Texture image width is less than the minimum, so we 		 * need to pad out each image scanline to the minimum 		 * width. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tex
operator|->
name|height
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|DRM_OS_COPYFROMUSR
argument_list|(
name|buffer
argument_list|,
name|data
argument_list|,
name|tex_width
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"EFAULT on pad, %d bytes\n"
argument_list|,
name|tex_width
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
block|}
name|buffer
operator|+=
literal|8
expr_stmt|;
name|data
operator|+=
name|tex_width
expr_stmt|;
block|}
block|}
name|buf
operator|->
name|pid
operator|=
name|pid
expr_stmt|;
name|buf
operator|->
name|used
operator|=
operator|(
name|dwords
operator|+
literal|8
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
literal|1
expr_stmt|;
name|radeon_cp_dispatch_indirect
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
comment|/* Flush the pixel cache after the blit completes.  This ensures 	 * the texture data is written out to memory before rendering 	 * continues. 	 */
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|RADEON_FLUSH_CACHE
argument_list|()
expr_stmt|;
name|RADEON_WAIT_UNTIL_2D_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_cp_dispatch_stipple
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|u32
modifier|*
name|stipple
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|35
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0
argument_list|(
name|RADEON_RE_STIPPLE_ADDR
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
literal|0x00000000
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CP_PACKET0_TABLE
argument_list|(
name|RADEON_RE_STIPPLE_DATA
argument_list|,
literal|31
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|OUT_RING
argument_list|(
name|stipple
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ================================================================  * IOCTL functions  */
end_comment

begin_function
name|int
name|radeon_cp_clear
parameter_list|(
name|DRM_OS_IOCTL
parameter_list|)
block|{
name|DRM_OS_DEVICE
expr_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_radeon_clear_t
name|clear
decl_stmt|;
name|drm_radeon_clear_rect_t
name|depth_boxes
index|[
name|RADEON_NR_SAREA_CLIPRECTS
index|]
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DRM_OS_KRNFROMUSR
argument_list|(
name|clear
argument_list|,
operator|(
name|drm_radeon_clear_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|clear
argument_list|)
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|RADEON_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|RADEON_NR_SAREA_CLIPRECTS
expr_stmt|;
if|if
condition|(
name|DRM_OS_COPYFROMUSR
argument_list|(
operator|&
name|depth_boxes
argument_list|,
name|clear
operator|.
name|depth_boxes
argument_list|,
name|sarea_priv
operator|->
name|nbox
operator|*
sizeof|sizeof
argument_list|(
name|depth_boxes
index|[
literal|0
index|]
argument_list|)
argument_list|)
condition|)
name|DRM_OS_RETURN
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
name|radeon_cp_dispatch_clear
argument_list|(
name|dev
argument_list|,
operator|&
name|clear
argument_list|,
name|depth_boxes
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_swap
parameter_list|(
name|DRM_OS_IOCTL
parameter_list|)
block|{
name|DRM_OS_DEVICE
expr_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|RADEON_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|RADEON_NR_SAREA_CLIPRECTS
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|page_flipping
condition|)
block|{
name|radeon_cp_dispatch_swap
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
operator|(
name|RADEON_UPLOAD_CONTEXT
operator||
name|RADEON_UPLOAD_MASKS
operator|)
expr_stmt|;
block|}
else|else
block|{
name|radeon_cp_dispatch_flip
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_vertex
parameter_list|(
name|DRM_OS_IOCTL
parameter_list|)
block|{
name|DRM_OS_DEVICE
expr_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_radeon_vertex_t
name|vertex
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"%s called with no initialization\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|DRM_OS_KRNFROMUSR
argument_list|(
name|vertex
argument_list|,
operator|(
name|drm_radeon_vertex_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|vertex
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s: pid=%d index=%d count=%d discard=%d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|DRM_OS_CURRENTPID
argument_list|,
name|vertex
operator|.
name|idx
argument_list|,
name|vertex
operator|.
name|count
argument_list|,
name|vertex
operator|.
name|discard
argument_list|)
expr_stmt|;
if|if
condition|(
name|vertex
operator|.
name|idx
operator|<
literal|0
operator|||
name|vertex
operator|.
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|vertex
operator|.
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vertex
operator|.
name|prim
operator|<
literal|0
operator|||
name|vertex
operator|.
name|prim
operator|>
name|RADEON_PRIM_TYPE_3VRT_LINE_LIST
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer prim %d\n"
argument_list|,
name|vertex
operator|.
name|prim
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|vertex
operator|.
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pid
operator|!=
name|DRM_OS_CURRENTPID
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"process %d using buffer owned by %d\n"
argument_list|,
name|DRM_OS_CURRENTPID
argument_list|,
name|buf
operator|->
name|pid
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"sending pending buffer %d\n"
argument_list|,
name|vertex
operator|.
name|idx
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|buf
operator|->
name|used
operator|=
name|vertex
operator|.
name|count
expr_stmt|;
name|buf_priv
operator|->
name|prim
operator|=
name|vertex
operator|.
name|prim
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|vertex
operator|.
name|discard
expr_stmt|;
name|radeon_cp_dispatch_vertex
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_indices
parameter_list|(
name|DRM_OS_IOCTL
parameter_list|)
block|{
name|DRM_OS_DEVICE
expr_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_radeon_indices_t
name|elts
decl_stmt|;
name|int
name|count
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"%s called with no initialization\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|DRM_OS_KRNFROMUSR
argument_list|(
name|elts
argument_list|,
operator|(
name|drm_radeon_indices_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|elts
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%s: pid=%d index=%d start=%d end=%d discard=%d\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|DRM_OS_CURRENTPID
argument_list|,
name|elts
operator|.
name|idx
argument_list|,
name|elts
operator|.
name|start
argument_list|,
name|elts
operator|.
name|end
argument_list|,
name|elts
operator|.
name|discard
argument_list|)
expr_stmt|;
if|if
condition|(
name|elts
operator|.
name|idx
operator|<
literal|0
operator|||
name|elts
operator|.
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|elts
operator|.
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|elts
operator|.
name|prim
operator|<
literal|0
operator|||
name|elts
operator|.
name|prim
operator|>
name|RADEON_PRIM_TYPE_3VRT_LINE_LIST
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer prim %d\n"
argument_list|,
name|elts
operator|.
name|prim
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|elts
operator|.
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pid
operator|!=
name|DRM_OS_CURRENTPID
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"process %d using buffer owned by %d\n"
argument_list|,
name|DRM_OS_CURRENTPID
argument_list|,
name|buf
operator|->
name|pid
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"sending pending buffer %d\n"
argument_list|,
name|elts
operator|.
name|idx
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|count
operator|=
operator|(
name|elts
operator|.
name|end
operator|-
name|elts
operator|.
name|start
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
name|elts
operator|.
name|start
operator|-=
name|RADEON_INDEX_PRIM_OFFSET
expr_stmt|;
if|if
condition|(
name|elts
operator|.
name|start
operator|&
literal|0x7
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"misaligned buffer 0x%x\n"
argument_list|,
name|elts
operator|.
name|start
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|elts
operator|.
name|start
operator|<
name|buf
operator|->
name|used
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"no header 0x%x - 0x%x\n"
argument_list|,
name|elts
operator|.
name|start
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|buf
operator|->
name|used
operator|=
name|elts
operator|.
name|end
expr_stmt|;
name|buf_priv
operator|->
name|prim
operator|=
name|elts
operator|.
name|prim
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|elts
operator|.
name|discard
expr_stmt|;
name|radeon_cp_dispatch_indices
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|elts
operator|.
name|start
argument_list|,
name|elts
operator|.
name|end
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_texture
parameter_list|(
name|DRM_OS_IOCTL
parameter_list|)
block|{
name|DRM_OS_DEVICE
expr_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_texture_t
name|tex
decl_stmt|;
name|drm_radeon_tex_image_t
name|image
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DRM_OS_KRNFROMUSR
argument_list|(
name|tex
argument_list|,
operator|(
name|drm_radeon_texture_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|tex
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tex
operator|.
name|image
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"null texture image!\n"
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|DRM_OS_COPYFROMUSR
argument_list|(
operator|&
name|image
argument_list|,
operator|(
name|drm_radeon_tex_image_t
operator|*
operator|)
name|tex
operator|.
name|image
argument_list|,
sizeof|sizeof
argument_list|(
name|image
argument_list|)
argument_list|)
condition|)
name|DRM_OS_RETURN
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
return|return
name|radeon_cp_dispatch_texture
argument_list|(
name|dev
argument_list|,
operator|&
name|tex
argument_list|,
operator|&
name|image
argument_list|,
name|DRM_OS_CURRENTPID
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_stipple
parameter_list|(
name|DRM_OS_IOCTL
parameter_list|)
block|{
name|DRM_OS_DEVICE
expr_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_radeon_stipple_t
name|stipple
decl_stmt|;
name|u32
name|mask
index|[
literal|32
index|]
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|DRM_OS_KRNFROMUSR
argument_list|(
name|stipple
argument_list|,
operator|(
name|drm_radeon_stipple_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|stipple
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|DRM_OS_COPYFROMUSR
argument_list|(
operator|&
name|mask
argument_list|,
name|stipple
operator|.
name|mask
argument_list|,
literal|32
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
condition|)
name|DRM_OS_RETURN
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|radeon_cp_dispatch_stipple
argument_list|(
name|dev
argument_list|,
name|mask
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|radeon_cp_indirect
parameter_list|(
name|DRM_OS_IOCTL
parameter_list|)
block|{
name|DRM_OS_DEVICE
expr_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|drm_radeon_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_radeon_indirect_t
name|indirect
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"%s called with no initialization\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|DRM_OS_KRNFROMUSR
argument_list|(
name|indirect
argument_list|,
operator|(
name|drm_radeon_indirect_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|indirect
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"indirect: idx=%d s=%d e=%d d=%d\n"
argument_list|,
name|indirect
operator|.
name|idx
argument_list|,
name|indirect
operator|.
name|start
argument_list|,
name|indirect
operator|.
name|end
argument_list|,
name|indirect
operator|.
name|discard
argument_list|)
expr_stmt|;
if|if
condition|(
name|indirect
operator|.
name|idx
operator|<
literal|0
operator|||
name|indirect
operator|.
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|indirect
operator|.
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|indirect
operator|.
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pid
operator|!=
name|DRM_OS_CURRENTPID
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"process %d using buffer owned by %d\n"
argument_list|,
name|DRM_OS_CURRENTPID
argument_list|,
name|buf
operator|->
name|pid
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"sending pending buffer %d\n"
argument_list|,
name|indirect
operator|.
name|idx
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|indirect
operator|.
name|start
operator|<
name|buf
operator|->
name|used
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"reusing indirect: start=0x%x actual=0x%x\n"
argument_list|,
name|indirect
operator|.
name|start
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
name|DRM_OS_RETURN
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|buf
operator|->
name|used
operator|=
name|indirect
operator|.
name|end
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|indirect
operator|.
name|discard
expr_stmt|;
comment|/* Wait for the 3D stream to idle before the indirect buffer 	 * containing 2D acceleration commands is processed. 	 */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|RADEON_WAIT_UNTIL_3D_IDLE
argument_list|()
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* Dispatch the indirect buffer full of commands from the 	 * X server.  This is insecure and is thus only available to 	 * privileged clients. 	 */
name|radeon_cp_dispatch_indirect
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|indirect
operator|.
name|start
argument_list|,
name|indirect
operator|.
name|end
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


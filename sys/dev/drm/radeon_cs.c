begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2008 Jerome Glisse.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Jerome Glisse<glisse@freedesktop.org>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/radeon_drv.h"
end_include

begin_comment
comment|/* regs */
end_comment

begin_define
define|#
directive|define
name|AVIVO_D1MODE_VLINE_START_END
value|0x6538
end_define

begin_define
define|#
directive|define
name|AVIVO_D2MODE_VLINE_START_END
value|0x6d38
end_define

begin_define
define|#
directive|define
name|R600_CP_COHER_BASE
value|0x85f8
end_define

begin_define
define|#
directive|define
name|R600_DB_DEPTH_BASE
value|0x2800c
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR0_BASE
value|0x28040
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR1_BASE
value|0x28044
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR2_BASE
value|0x28048
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR3_BASE
value|0x2804c
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR4_BASE
value|0x28050
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR5_BASE
value|0x28054
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR6_BASE
value|0x28058
end_define

begin_define
define|#
directive|define
name|R600_CB_COLOR7_BASE
value|0x2805c
end_define

begin_define
define|#
directive|define
name|R600_SQ_PGM_START_FS
value|0x28894
end_define

begin_define
define|#
directive|define
name|R600_SQ_PGM_START_ES
value|0x28880
end_define

begin_define
define|#
directive|define
name|R600_SQ_PGM_START_VS
value|0x28858
end_define

begin_define
define|#
directive|define
name|R600_SQ_PGM_START_GS
value|0x2886c
end_define

begin_define
define|#
directive|define
name|R600_SQ_PGM_START_PS
value|0x28840
end_define

begin_define
define|#
directive|define
name|R600_VGT_DMA_BASE
value|0x287e8
end_define

begin_define
define|#
directive|define
name|R600_VGT_DMA_BASE_HI
value|0x287e4
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_0
value|0x28b10
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_1
value|0x28b14
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_2
value|0x28b18
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_3
value|0x28b1c
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_0
value|0x28b44
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_1
value|0x28b48
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_2
value|0x28b4c
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_3
value|0x28b50
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_BASE_0
value|0x28ad8
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_BASE_1
value|0x28ae8
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_BASE_2
value|0x28af8
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_BASE_3
value|0x28b08
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_OFFSET_0
value|0x28adc
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_OFFSET_1
value|0x28aec
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_OFFSET_2
value|0x28afc
end_define

begin_define
define|#
directive|define
name|R600_VGT_STRMOUT_BUFFER_OFFSET_3
value|0x28b0c
end_define

begin_comment
comment|/* resource type */
end_comment

begin_define
define|#
directive|define
name|R600_SQ_TEX_VTX_INVALID_TEXTURE
value|0x0
end_define

begin_define
define|#
directive|define
name|R600_SQ_TEX_VTX_INVALID_BUFFER
value|0x1
end_define

begin_define
define|#
directive|define
name|R600_SQ_TEX_VTX_VALID_TEXTURE
value|0x2
end_define

begin_define
define|#
directive|define
name|R600_SQ_TEX_VTX_VALID_BUFFER
value|0x3
end_define

begin_comment
comment|/* packet 3 type offsets */
end_comment

begin_define
define|#
directive|define
name|R600_SET_CONFIG_REG_OFFSET
value|0x00008000
end_define

begin_define
define|#
directive|define
name|R600_SET_CONFIG_REG_END
value|0x0000ac00
end_define

begin_define
define|#
directive|define
name|R600_SET_CONTEXT_REG_OFFSET
value|0x00028000
end_define

begin_define
define|#
directive|define
name|R600_SET_CONTEXT_REG_END
value|0x00029000
end_define

begin_define
define|#
directive|define
name|R600_SET_ALU_CONST_OFFSET
value|0x00030000
end_define

begin_define
define|#
directive|define
name|R600_SET_ALU_CONST_END
value|0x00032000
end_define

begin_define
define|#
directive|define
name|R600_SET_RESOURCE_OFFSET
value|0x00038000
end_define

begin_define
define|#
directive|define
name|R600_SET_RESOURCE_END
value|0x0003c000
end_define

begin_define
define|#
directive|define
name|R600_SET_SAMPLER_OFFSET
value|0x0003c000
end_define

begin_define
define|#
directive|define
name|R600_SET_SAMPLER_END
value|0x0003cff0
end_define

begin_define
define|#
directive|define
name|R600_SET_CTL_CONST_OFFSET
value|0x0003cff0
end_define

begin_define
define|#
directive|define
name|R600_SET_CTL_CONST_END
value|0x0003e200
end_define

begin_define
define|#
directive|define
name|R600_SET_LOOP_CONST_OFFSET
value|0x0003e200
end_define

begin_define
define|#
directive|define
name|R600_SET_LOOP_CONST_END
value|0x0003e380
end_define

begin_define
define|#
directive|define
name|R600_SET_BOOL_CONST_OFFSET
value|0x0003e380
end_define

begin_define
define|#
directive|define
name|R600_SET_BOOL_CONST_END
value|0x00040000
end_define

begin_comment
comment|/* Packet 3 types */
end_comment

begin_define
define|#
directive|define
name|R600_IT_INDIRECT_BUFFER_END
value|0x00001700
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_PREDICATION
value|0x00002000
end_define

begin_define
define|#
directive|define
name|R600_IT_REG_RMW
value|0x00002100
end_define

begin_define
define|#
directive|define
name|R600_IT_COND_EXEC
value|0x00002200
end_define

begin_define
define|#
directive|define
name|R600_IT_PRED_EXEC
value|0x00002300
end_define

begin_define
define|#
directive|define
name|R600_IT_START_3D_CMDBUF
value|0x00002400
end_define

begin_define
define|#
directive|define
name|R600_IT_DRAW_INDEX_2
value|0x00002700
end_define

begin_define
define|#
directive|define
name|R600_IT_CONTEXT_CONTROL
value|0x00002800
end_define

begin_define
define|#
directive|define
name|R600_IT_DRAW_INDEX_IMMD_BE
value|0x00002900
end_define

begin_define
define|#
directive|define
name|R600_IT_INDEX_TYPE
value|0x00002A00
end_define

begin_define
define|#
directive|define
name|R600_IT_DRAW_INDEX
value|0x00002B00
end_define

begin_define
define|#
directive|define
name|R600_IT_DRAW_INDEX_AUTO
value|0x00002D00
end_define

begin_define
define|#
directive|define
name|R600_IT_DRAW_INDEX_IMMD
value|0x00002E00
end_define

begin_define
define|#
directive|define
name|R600_IT_NUM_INSTANCES
value|0x00002F00
end_define

begin_define
define|#
directive|define
name|R600_IT_STRMOUT_BUFFER_UPDATE
value|0x00003400
end_define

begin_define
define|#
directive|define
name|R600_IT_INDIRECT_BUFFER_MP
value|0x00003800
end_define

begin_define
define|#
directive|define
name|R600_IT_MEM_SEMAPHORE
value|0x00003900
end_define

begin_define
define|#
directive|define
name|R600_IT_MPEG_INDEX
value|0x00003A00
end_define

begin_define
define|#
directive|define
name|R600_IT_WAIT_REG_MEM
value|0x00003C00
end_define

begin_define
define|#
directive|define
name|R600_IT_MEM_WRITE
value|0x00003D00
end_define

begin_define
define|#
directive|define
name|R600_IT_INDIRECT_BUFFER
value|0x00003200
end_define

begin_define
define|#
directive|define
name|R600_IT_CP_INTERRUPT
value|0x00004000
end_define

begin_define
define|#
directive|define
name|R600_IT_SURFACE_SYNC
value|0x00004300
end_define

begin_define
define|#
directive|define
name|R600_IT_ME_INITIALIZE
value|0x00004400
end_define

begin_define
define|#
directive|define
name|R600_IT_COND_WRITE
value|0x00004500
end_define

begin_define
define|#
directive|define
name|R600_IT_EVENT_WRITE
value|0x00004600
end_define

begin_define
define|#
directive|define
name|R600_IT_EVENT_WRITE_EOP
value|0x00004700
end_define

begin_define
define|#
directive|define
name|R600_IT_ONE_REG_WRITE
value|0x00005700
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_CONFIG_REG
value|0x00006800
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_CONTEXT_REG
value|0x00006900
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_ALU_CONST
value|0x00006A00
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_BOOL_CONST
value|0x00006B00
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_LOOP_CONST
value|0x00006C00
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_RESOURCE
value|0x00006D00
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_SAMPLER
value|0x00006E00
end_define

begin_define
define|#
directive|define
name|R600_IT_SET_CTL_CONST
value|0x00006F00
end_define

begin_define
define|#
directive|define
name|R600_IT_SURFACE_BASE_UPDATE
value|0x00007300
end_define

begin_function
name|int
name|radeon_cs_ioctl
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|fpriv
parameter_list|)
block|{
name|struct
name|drm_radeon_cs_parser
name|parser
decl_stmt|;
name|struct
name|drm_radeon_private
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_radeon_cs
modifier|*
name|cs
init|=
name|data
decl_stmt|;
name|uint32_t
name|cs_id
decl_stmt|;
name|struct
name|drm_radeon_cs_chunk
name|__user
modifier|*
modifier|*
name|chunk_ptr
init|=
name|NULL
decl_stmt|;
name|uint64_t
modifier|*
name|chunk_array
decl_stmt|;
name|uint64_t
modifier|*
name|chunk_array_ptr
decl_stmt|;
name|long
name|size
decl_stmt|;
name|int
name|r
decl_stmt|,
name|i
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|dev_priv
operator|->
name|cs
operator|.
name|cs_mutex
argument_list|)
expr_stmt|;
comment|/* set command stream id to 0 which is fake id */
name|cs_id
operator|=
literal|0
expr_stmt|;
name|cs
operator|->
name|cs_id
operator|=
name|cs_id
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"called with no initialization\n"
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|cs
operator|.
name|cs_mutex
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|cs
operator|->
name|num_chunks
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|cs
operator|.
name|cs_mutex
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|chunk_array
operator|=
name|drm_calloc
argument_list|(
name|cs
operator|->
name|num_chunks
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chunk_array
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|cs
operator|.
name|cs_mutex
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|chunk_array_ptr
operator|=
operator|(
name|uint64_t
operator|*
operator|)
call|(
name|unsigned
name|long
call|)
argument_list|(
name|cs
operator|->
name|chunks
argument_list|)
expr_stmt|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|chunk_array
argument_list|,
name|chunk_array_ptr
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
name|cs
operator|->
name|num_chunks
argument_list|)
condition|)
block|{
name|r
operator|=
operator|-
name|EFAULT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|parser
operator|.
name|dev
operator|=
name|dev
expr_stmt|;
name|parser
operator|.
name|file_priv
operator|=
name|fpriv
expr_stmt|;
name|parser
operator|.
name|reloc_index
operator|=
operator|-
literal|1
expr_stmt|;
name|parser
operator|.
name|ib_index
operator|=
operator|-
literal|1
expr_stmt|;
name|parser
operator|.
name|num_chunks
operator|=
name|cs
operator|->
name|num_chunks
expr_stmt|;
comment|/* copy out the chunk headers */
name|parser
operator|.
name|chunks
operator|=
name|drm_calloc
argument_list|(
name|parser
operator|.
name|num_chunks
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|drm_radeon_kernel_chunk
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parser
operator|.
name|chunks
condition|)
block|{
name|r
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|parser
operator|.
name|num_chunks
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|drm_radeon_cs_chunk
name|user_chunk
decl_stmt|;
name|chunk_ptr
operator|=
operator|(
name|void
name|__user
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|chunk_array
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|user_chunk
argument_list|,
name|chunk_ptr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|drm_radeon_cs_chunk
argument_list|)
argument_list|)
condition|)
block|{
name|r
operator|=
operator|-
name|EFAULT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_id
operator|=
name|user_chunk
operator|.
name|chunk_id
expr_stmt|;
if|if
condition|(
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_id
operator|==
name|RADEON_CHUNK_ID_RELOCS
condition|)
name|parser
operator|.
name|reloc_index
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_id
operator|==
name|RADEON_CHUNK_ID_IB
condition|)
name|parser
operator|.
name|ib_index
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_id
operator|==
name|RADEON_CHUNK_ID_OLD
condition|)
block|{
name|parser
operator|.
name|ib_index
operator|=
name|i
expr_stmt|;
name|parser
operator|.
name|reloc_index
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|length_dw
operator|=
name|user_chunk
operator|.
name|length_dw
expr_stmt|;
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_data
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|user_chunk
operator|.
name|chunk_data
expr_stmt|;
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
operator|=
name|NULL
expr_stmt|;
name|size
operator|=
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|length_dw
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_id
condition|)
block|{
case|case
name|RADEON_CHUNK_ID_IB
case|:
case|case
name|RADEON_CHUNK_ID_OLD
case|:
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
case|case
name|RADEON_CHUNK_ID_RELOCS
case|:
if|if
condition|(
name|size
condition|)
block|{
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
operator|=
name|drm_alloc
argument_list|(
name|size
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
condition|)
block|{
name|r
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
argument_list|,
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_data
argument_list|,
name|size
argument_list|)
condition|)
block|{
name|r
operator|=
operator|-
name|EFAULT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|DRM_DEBUG
argument_list|(
literal|"chunk %d %d %d %p\n"
argument_list|,
name|i
argument_list|,
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_id
argument_list|,
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|length_dw
argument_list|,
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|chunk_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parser
operator|.
name|chunks
index|[
name|parser
operator|.
name|ib_index
index|]
operator|.
name|length_dw
operator|>
operator|(
literal|16
operator|*
literal|1024
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"cs->dwords too big: %d\n"
argument_list|,
name|parser
operator|.
name|chunks
index|[
name|parser
operator|.
name|ib_index
index|]
operator|.
name|length_dw
argument_list|)
expr_stmt|;
name|r
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* get ib */
name|r
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|ib_get
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"ib_get failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* now parse command stream */
name|r
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|parse
argument_list|(
operator|&
name|parser
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|dev_priv
operator|->
name|cs
operator|.
name|ib_free
argument_list|(
operator|&
name|parser
argument_list|,
name|r
argument_list|)
expr_stmt|;
comment|/* emit cs id sequence */
name|dev_priv
operator|->
name|cs
operator|.
name|id_emit
argument_list|(
operator|&
name|parser
argument_list|,
operator|&
name|cs_id
argument_list|)
expr_stmt|;
name|cs
operator|->
name|cs_id
operator|=
name|cs_id
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|dev_priv
operator|->
name|cs
operator|.
name|cs_mutex
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|parser
operator|.
name|num_chunks
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
condition|)
name|drm_free
argument_list|(
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|kdata
argument_list|,
name|parser
operator|.
name|chunks
index|[
name|i
index|]
operator|.
name|length_dw
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
block|}
name|drm_free
argument_list|(
name|parser
operator|.
name|chunks
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|drm_radeon_kernel_chunk
argument_list|)
operator|*
name|parser
operator|.
name|num_chunks
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|chunk_array
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
operator|*
name|parser
operator|.
name|num_chunks
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* for non-mm */
end_comment

begin_function
specifier|static
name|int
name|r600_nomm_relocate
parameter_list|(
name|struct
name|drm_radeon_cs_parser
modifier|*
name|parser
parameter_list|,
name|uint32_t
modifier|*
name|reloc
parameter_list|,
name|uint64_t
modifier|*
name|offset
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|parser
operator|->
name|dev
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_radeon_kernel_chunk
modifier|*
name|reloc_chunk
init|=
operator|&
name|parser
operator|->
name|chunks
index|[
name|parser
operator|->
name|reloc_index
index|]
decl_stmt|;
name|uint32_t
name|offset_dw
init|=
name|reloc
index|[
literal|1
index|]
decl_stmt|;
comment|//DRM_INFO("reloc: 0x%08x 0x%08x\n", reloc[0], reloc[1]);
comment|//DRM_INFO("length: %d\n", reloc_chunk->length_dw);
if|if
condition|(
operator|!
name|reloc_chunk
operator|->
name|kdata
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|offset_dw
operator|>
name|reloc_chunk
operator|->
name|length_dw
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Offset larger than chunk 0x%x %d\n"
argument_list|,
name|offset_dw
argument_list|,
name|reloc_chunk
operator|->
name|length_dw
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* 40 bit addr */
operator|*
name|offset
operator|=
name|reloc_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|3
index|]
expr_stmt|;
operator|*
name|offset
operator|<<=
literal|32
expr_stmt|;
operator|*
name|offset
operator||=
name|reloc_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|0
index|]
expr_stmt|;
comment|//DRM_INFO("offset 0x%lx\n", *offset);
if|if
condition|(
operator|!
name|radeon_check_offset
argument_list|(
name|dev_priv
argument_list|,
operator|*
name|offset
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad offset! 0x%lx\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
operator|*
name|offset
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|r600_cs_packet0
parameter_list|(
name|struct
name|drm_radeon_cs_parser
modifier|*
name|parser
parameter_list|,
name|uint32_t
modifier|*
name|offset_dw_p
parameter_list|)
block|{
name|uint32_t
name|hdr
decl_stmt|,
name|num_dw
decl_stmt|,
name|reg
decl_stmt|;
name|int
name|count_dw
init|=
literal|1
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|offset_dw
init|=
operator|*
name|offset_dw_p
decl_stmt|;
name|int
name|incr
init|=
literal|2
decl_stmt|;
name|hdr
operator|=
name|parser
operator|->
name|chunks
index|[
name|parser
operator|->
name|ib_index
index|]
operator|.
name|kdata
index|[
name|offset_dw
index|]
expr_stmt|;
name|num_dw
operator|=
operator|(
operator|(
name|hdr
operator|&
name|RADEON_CP_PACKET_COUNT_MASK
operator|)
operator|>>
literal|16
operator|)
operator|+
literal|2
expr_stmt|;
name|reg
operator|=
operator|(
name|hdr
operator|&
literal|0xffff
operator|)
operator|<<
literal|2
expr_stmt|;
while|while
condition|(
name|count_dw
operator|<
name|num_dw
condition|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|AVIVO_D1MODE_VLINE_START_END
case|:
case|case
name|AVIVO_D2MODE_VLINE_START_END
case|:
break|break;
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"bad packet 0 reg: 0x%08x\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
name|count_dw
operator|++
expr_stmt|;
name|reg
operator|+=
literal|4
expr_stmt|;
block|}
operator|*
name|offset_dw_p
operator|+=
name|incr
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|r600_cs_packet3
parameter_list|(
name|struct
name|drm_radeon_cs_parser
modifier|*
name|parser
parameter_list|,
name|uint32_t
modifier|*
name|offset_dw_p
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|parser
operator|->
name|dev
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|hdr
decl_stmt|,
name|num_dw
decl_stmt|,
name|start_reg
decl_stmt|,
name|end_reg
decl_stmt|,
name|reg
decl_stmt|;
name|uint32_t
modifier|*
name|reloc
decl_stmt|;
name|uint64_t
name|offset
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|offset_dw
init|=
operator|*
name|offset_dw_p
decl_stmt|;
name|int
name|incr
init|=
literal|2
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|drm_radeon_kernel_chunk
modifier|*
name|ib_chunk
decl_stmt|;
name|ib_chunk
operator|=
operator|&
name|parser
operator|->
name|chunks
index|[
name|parser
operator|->
name|ib_index
index|]
expr_stmt|;
name|hdr
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
index|]
expr_stmt|;
name|num_dw
operator|=
operator|(
operator|(
name|hdr
operator|&
name|RADEON_CP_PACKET_COUNT_MASK
operator|)
operator|>>
literal|16
operator|)
operator|+
literal|2
expr_stmt|;
comment|/* just the ones we use for now, add more later */
switch|switch
condition|(
name|hdr
operator|&
literal|0xff00
condition|)
block|{
case|case
name|R600_IT_START_3D_CMDBUF
case|:
comment|//DRM_INFO("R600_IT_START_3D_CMDBUF\n");
if|if
condition|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|num_dw
operator|!=
literal|2
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad START_3D\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_CONTEXT_CONTROL
case|:
comment|//DRM_INFO("R600_IT_CONTEXT_CONTROL\n");
if|if
condition|(
name|num_dw
operator|!=
literal|3
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad CONTEXT_CONTROL\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_INDEX_TYPE
case|:
case|case
name|R600_IT_NUM_INSTANCES
case|:
comment|//DRM_INFO("R600_IT_INDEX_TYPE/R600_IT_NUM_INSTANCES\n");
if|if
condition|(
name|num_dw
operator|!=
literal|2
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad INDEX_TYPE/NUM_INSTANCES\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_DRAW_INDEX
case|:
comment|//DRM_INFO("R600_IT_DRAW_INDEX\n");
if|if
condition|(
name|num_dw
operator|!=
literal|5
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|+=
operator|(
name|offset
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|2
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
case|case
name|R600_IT_DRAW_INDEX_AUTO
case|:
comment|//DRM_INFO("R600_IT_DRAW_INDEX_AUTO\n");
if|if
condition|(
name|num_dw
operator|!=
literal|3
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_AUTO\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_DRAW_INDEX_IMMD_BE
case|:
case|case
name|R600_IT_DRAW_INDEX_IMMD
case|:
comment|//DRM_INFO("R600_IT_DRAW_INDEX_IMMD\n");
if|if
condition|(
name|num_dw
operator|<
literal|4
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad DRAW_INDEX_IMMD\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_WAIT_REG_MEM
case|:
comment|//DRM_INFO("R600_IT_WAIT_REG_MEM\n");
if|if
condition|(
name|num_dw
operator|!=
literal|7
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
comment|/* bit 4 is reg (0) or mem (1) */
if|if
condition|(
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|&
literal|0x10
condition|)
block|{
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad WAIT_REG_MEM\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|2
index|]
operator|+=
operator|(
name|offset
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|3
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad WAIT_REG_MEM\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SURFACE_SYNC
case|:
comment|//DRM_INFO("R600_IT_SURFACE_SYNC\n");
if|if
condition|(
name|num_dw
operator|!=
literal|5
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
comment|/* 0xffffffff/0x0 is flush all cache flag */
elseif|else
if|if
condition|(
operator|(
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|2
index|]
operator|==
literal|0xffffffff
operator|)
operator|&&
operator|(
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|3
index|]
operator|==
literal|0
operator|)
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_SYNC\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|3
index|]
operator|+=
operator|(
operator|(
name|offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|R600_IT_EVENT_WRITE
case|:
comment|//DRM_INFO("R600_IT_EVENT_WRITE\n");
if|if
condition|(
operator|(
name|num_dw
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|num_dw
operator|!=
literal|2
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|num_dw
operator|>
literal|2
condition|)
block|{
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|2
index|]
operator|+=
operator|(
name|offset
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|3
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_EVENT_WRITE_EOP
case|:
comment|//DRM_INFO("R600_IT_EVENT_WRITE_EOP\n");
if|if
condition|(
name|num_dw
operator|!=
literal|6
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE_EOP\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad EVENT_WRITE_EOP\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|2
index|]
operator|+=
operator|(
name|offset
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|3
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_CONFIG_REG
case|:
comment|//DRM_INFO("R600_IT_SET_CONFIG_REG\n");
name|start_reg
operator|=
operator|(
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
operator|)
operator|+
name|R600_SET_CONFIG_REG_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_CONFIG_REG_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_CONFIG_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_CONFIG_REG_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|num_dw
operator|-
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|R600_CP_COHER_BASE
case|:
comment|/* use R600_IT_SURFACE_SYNC */
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_CONFIG_REG\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_CONTEXT_REG
case|:
comment|//DRM_INFO("R600_IT_SET_CONTEXT_REG\n");
name|start_reg
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
name|start_reg
operator|+=
name|R600_SET_CONTEXT_REG_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_CONTEXT_REG_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_CONTEXT_REG_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_CONTEXT_REG_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|num_dw
operator|-
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|start_reg
operator|+
operator|(
literal|4
operator|*
name|i
operator|)
expr_stmt|;
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
name|R600_DB_DEPTH_BASE
case|:
case|case
name|R600_CB_COLOR0_BASE
case|:
case|case
name|R600_CB_COLOR1_BASE
case|:
case|case
name|R600_CB_COLOR2_BASE
case|:
case|case
name|R600_CB_COLOR3_BASE
case|:
case|case
name|R600_CB_COLOR4_BASE
case|:
case|case
name|R600_CB_COLOR5_BASE
case|:
case|case
name|R600_CB_COLOR6_BASE
case|:
case|case
name|R600_CB_COLOR7_BASE
case|:
case|case
name|R600_SQ_PGM_START_FS
case|:
case|case
name|R600_SQ_PGM_START_ES
case|:
case|case
name|R600_SQ_PGM_START_VS
case|:
case|case
name|R600_SQ_PGM_START_GS
case|:
case|case
name|R600_SQ_PGM_START_PS
case|:
comment|//DRM_INFO("reg: 0x%08x\n", reg);
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"bad SET_CONTEXT_REG\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|2
operator|+
name|i
index|]
operator|+=
operator|(
operator|(
name|offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
break|break;
case|case
name|R600_VGT_DMA_BASE
case|:
case|case
name|R600_VGT_DMA_BASE_HI
case|:
comment|/* These should be handled by DRAW_INDEX packet 3 */
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_0
case|:
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_1
case|:
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_2
case|:
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_3
case|:
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_0
case|:
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_1
case|:
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_2
case|:
case|case
name|R600_VGT_STRMOUT_BASE_OFFSET_HI_3
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_BASE_0
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_BASE_1
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_BASE_2
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_BASE_3
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_OFFSET_0
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_OFFSET_1
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_OFFSET_2
case|:
case|case
name|R600_VGT_STRMOUT_BUFFER_OFFSET_3
case|:
comment|/* These should be handled by STRMOUT_BUFFER packet 3 */
name|DRM_ERROR
argument_list|(
literal|"bad context reg: 0x%08x\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_CONTEXT_REG\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_RESOURCE
case|:
comment|//DRM_INFO("R600_IT_SET_RESOURCE\n");
if|if
condition|(
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|%
literal|7
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|start_reg
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
name|start_reg
operator|+=
name|R600_SET_RESOURCE_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_RESOURCE_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_RESOURCE_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_RESOURCE_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|/
literal|7
operator|)
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
operator|(
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|6
operator|+
literal|2
index|]
operator|&
literal|0xc0000000
operator|)
operator|>>
literal|30
condition|)
block|{
case|case
name|R600_SQ_TEX_VTX_INVALID_TEXTURE
case|:
case|case
name|R600_SQ_TEX_VTX_INVALID_BUFFER
case|:
default|default:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
case|case
name|R600_SQ_TEX_VTX_VALID_TEXTURE
case|:
comment|/* tex base */
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|2
operator|+
literal|2
index|]
operator|+=
operator|(
operator|(
name|offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
comment|/* tex mip base */
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
operator|+
literal|2
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|3
operator|+
literal|2
index|]
operator|+=
operator|(
operator|(
name|offset
operator|>>
literal|8
operator|)
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
break|break;
case|case
name|R600_SQ_TEX_VTX_VALID_BUFFER
case|:
comment|/* vtx base */
name|reloc
operator|=
name|ib_chunk
operator|->
name|kdata
operator|+
name|offset_dw
operator|+
name|num_dw
operator|+
operator|(
name|i
operator|*
literal|2
operator|)
expr_stmt|;
name|ret
operator|=
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
argument_list|(
name|parser
argument_list|,
name|reloc
argument_list|,
operator|&
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|0
operator|+
literal|2
index|]
operator|+=
operator|(
name|offset
operator|&
literal|0xffffffff
operator|)
expr_stmt|;
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
operator|(
name|i
operator|*
literal|7
operator|)
operator|+
literal|2
operator|+
literal|2
index|]
operator|+=
operator|(
name|upper_32_bits
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xff
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ret
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_RESOURCE\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_ALU_CONST
case|:
comment|//DRM_INFO("R600_IT_SET_ALU_CONST\n");
name|start_reg
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
name|start_reg
operator|+=
name|R600_SET_ALU_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_ALU_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_ALU_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_ALU_CONST_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_ALU_CONST\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_BOOL_CONST
case|:
comment|//DRM_INFO("R600_IT_SET_BOOL_CONST\n");
name|start_reg
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
name|start_reg
operator|+=
name|R600_SET_BOOL_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_BOOL_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_BOOL_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_BOOL_CONST_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_BOOL_CONST\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_LOOP_CONST
case|:
comment|//DRM_INFO("R600_IT_SET_LOOP_CONST\n");
name|start_reg
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
name|start_reg
operator|+=
name|R600_SET_LOOP_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_LOOP_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_LOOP_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_LOOP_CONST_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_LOOP_CONST\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_CTL_CONST
case|:
comment|//DRM_INFO("R600_IT_SET_CTL_CONST\n");
name|start_reg
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
name|start_reg
operator|+=
name|R600_SET_CTL_CONST_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_CTL_CONST_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_CTL_CONST_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_CTL_CONST_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_CTL_CONST\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SET_SAMPLER
case|:
comment|//DRM_INFO("R600_IT_SET_SAMPLER\n");
if|if
condition|(
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|%
literal|3
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|start_reg
operator|=
name|ib_chunk
operator|->
name|kdata
index|[
name|offset_dw
operator|+
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
name|start_reg
operator|+=
name|R600_SET_SAMPLER_OFFSET
expr_stmt|;
name|end_reg
operator|=
literal|4
operator|*
operator|(
name|num_dw
operator|-
literal|2
operator|)
operator|+
name|start_reg
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|start_reg
operator|<
name|R600_SET_SAMPLER_OFFSET
operator|)
operator|||
operator|(
name|start_reg
operator|>=
name|R600_SET_SAMPLER_END
operator|)
operator|||
operator|(
name|end_reg
operator|>=
name|R600_SET_SAMPLER_END
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SET_SAMPLER\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|R600_IT_SURFACE_BASE_UPDATE
case|:
comment|//DRM_INFO("R600_IT_SURFACE_BASE_UPDATE\n");
if|if
condition|(
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|>=
name|CHIP_RV770
operator|)
operator|||
operator|(
operator|(
name|dev_priv
operator|->
name|flags
operator|&
name|RADEON_FAMILY_MASK
operator|)
operator|==
name|CHIP_R600
operator|)
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|num_dw
operator|!=
literal|2
condition|)
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|DRM_ERROR
argument_list|(
literal|"bad SURFACE_BASE_UPDATE\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_CP_NOP
case|:
comment|//DRM_INFO("NOP: %d\n", ib_chunk->kdata[offset_dw + 1]);
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"invalid packet 3 0x%08x\n"
argument_list|,
literal|0xff00
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
operator|*
name|offset_dw_p
operator|+=
name|incr
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_cs_parse
parameter_list|(
name|struct
name|drm_radeon_cs_parser
modifier|*
name|parser
parameter_list|)
block|{
specifier|volatile
name|int
name|rb
decl_stmt|;
name|struct
name|drm_radeon_kernel_chunk
modifier|*
name|ib_chunk
decl_stmt|;
comment|/* scan the packet for various things */
name|int
name|count_dw
init|=
literal|0
decl_stmt|,
name|size_dw
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ib_chunk
operator|=
operator|&
name|parser
operator|->
name|chunks
index|[
name|parser
operator|->
name|ib_index
index|]
expr_stmt|;
name|size_dw
operator|=
name|ib_chunk
operator|->
name|length_dw
expr_stmt|;
while|while
condition|(
name|count_dw
operator|<
name|size_dw
operator|&&
name|ret
operator|==
literal|0
condition|)
block|{
name|int
name|hdr
init|=
name|ib_chunk
operator|->
name|kdata
index|[
name|count_dw
index|]
decl_stmt|;
name|int
name|num_dw
init|=
operator|(
name|hdr
operator|&
name|RADEON_CP_PACKET_COUNT_MASK
operator|)
operator|>>
literal|16
decl_stmt|;
switch|switch
condition|(
name|hdr
operator|&
name|RADEON_CP_PACKET_MASK
condition|)
block|{
case|case
name|RADEON_CP_PACKET0
case|:
name|ret
operator|=
name|r600_cs_packet0
argument_list|(
name|parser
argument_list|,
operator|&
name|count_dw
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADEON_CP_PACKET1
case|:
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
case|case
name|RADEON_CP_PACKET2
case|:
name|DRM_DEBUG
argument_list|(
literal|"Packet 2\n"
argument_list|)
expr_stmt|;
name|num_dw
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|RADEON_CP_PACKET3
case|:
name|ret
operator|=
name|r600_cs_packet3
argument_list|(
name|parser
argument_list|,
operator|&
name|count_dw
argument_list|)
expr_stmt|;
break|break;
block|}
name|count_dw
operator|+=
name|num_dw
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* copy the packet into the IB */
name|memcpy
argument_list|(
name|parser
operator|->
name|ib
argument_list|,
name|ib_chunk
operator|->
name|kdata
argument_list|,
name|ib_chunk
operator|->
name|length_dw
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* read back last byte to flush WC buffers */
name|rb
operator|=
operator|*
operator|(
specifier|volatile
name|u_int32_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|vm_offset_t
operator|)
name|parser
operator|->
name|ib
operator|+
operator|(
name|ib_chunk
operator|->
name|length_dw
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|radeon_cs_id_get
parameter_list|(
name|struct
name|drm_radeon_private
modifier|*
name|radeon
parameter_list|)
block|{
comment|/* FIXME: protect with a spinlock */
comment|/* FIXME: check if wrap affect last reported wrap& sequence */
name|radeon
operator|->
name|cs
operator|.
name|id_scnt
operator|=
operator|(
name|radeon
operator|->
name|cs
operator|.
name|id_scnt
operator|+
literal|1
operator|)
operator|&
literal|0x00FFFFFF
expr_stmt|;
if|if
condition|(
operator|!
name|radeon
operator|->
name|cs
operator|.
name|id_scnt
condition|)
block|{
comment|/* increment wrap counter */
name|radeon
operator|->
name|cs
operator|.
name|id_wcnt
operator|+=
literal|0x01000000
expr_stmt|;
comment|/* valid sequence counter start at 1 */
name|radeon
operator|->
name|cs
operator|.
name|id_scnt
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|radeon
operator|->
name|cs
operator|.
name|id_scnt
operator||
name|radeon
operator|->
name|cs
operator|.
name|id_wcnt
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_cs_id_emit
parameter_list|(
name|struct
name|drm_radeon_cs_parser
modifier|*
name|parser
parameter_list|,
name|uint32_t
modifier|*
name|id
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|parser
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
comment|//dev_priv->irq_emitted = radeon_update_breadcrumb(parser->dev);
operator|*
name|id
operator|=
name|radeon_cs_id_get
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
comment|/* SCRATCH 2 */
name|BEGIN_RING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|R600_CLEAR_AGE
argument_list|(
operator|*
name|id
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|r600_cs_id_last_get
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
comment|//drm_radeon_private_t *dev_priv = dev->dev_private;
comment|//return GET_R600_SCRATCH(dev_priv, 2);
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r600_ib_get
parameter_list|(
name|struct
name|drm_radeon_cs_parser
modifier|*
name|parser
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|parser
operator|->
name|dev
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|radeon_freelist_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|dev_priv
operator|->
name|cs_buf
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
name|EBUSY
return|;
block|}
name|buf
operator|->
name|file_priv
operator|=
name|parser
operator|->
name|file_priv
expr_stmt|;
name|dev_priv
operator|->
name|cs_buf
operator|=
name|buf
expr_stmt|;
name|parser
operator|->
name|ib
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|vm_offset_t
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|virtual
operator|+
name|buf
operator|->
name|offset
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r600_ib_free
parameter_list|(
name|struct
name|drm_radeon_cs_parser
modifier|*
name|parser
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|parser
operator|->
name|dev
decl_stmt|;
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
init|=
name|dev_priv
operator|->
name|cs_buf
decl_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
if|if
condition|(
operator|!
name|error
condition|)
name|r600_cp_dispatch_indirect
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|parser
operator|->
name|chunks
index|[
name|parser
operator|->
name|ib_index
index|]
operator|.
name|length_dw
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_cp_discard_buffer
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|r600_cs_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_radeon_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|dev_priv
operator|->
name|cs
operator|.
name|ib_get
operator|=
name|r600_ib_get
expr_stmt|;
name|dev_priv
operator|->
name|cs
operator|.
name|ib_free
operator|=
name|r600_ib_free
expr_stmt|;
name|dev_priv
operator|->
name|cs
operator|.
name|id_emit
operator|=
name|r600_cs_id_emit
expr_stmt|;
name|dev_priv
operator|->
name|cs
operator|.
name|id_last_get
operator|=
name|r600_cs_id_last_get
expr_stmt|;
name|dev_priv
operator|->
name|cs
operator|.
name|parse
operator|=
name|r600_cs_parse
expr_stmt|;
name|dev_priv
operator|->
name|cs
operator|.
name|relocate
operator|=
name|r600_nomm_relocate
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


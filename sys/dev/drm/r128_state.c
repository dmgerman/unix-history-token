begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* r128_state.c -- State support for r128 -*- linux-c -*-  * Created: Thu Jan 27 02:53:43 2000 by gareth@valinux.com  */
end_comment

begin_comment
comment|/*-  * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Gareth Hughes<gareth@valinux.com>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/r128_drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/r128_drv.h"
end_include

begin_comment
comment|/* ================================================================  * CCE hardware state programming functions  */
end_comment

begin_function
specifier|static
name|void
name|r128_emit_clip_rects
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|,
name|struct
name|drm_clip_rect
modifier|*
name|boxes
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|u32
name|aux_sc_cntl
init|=
literal|0x00000000
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
operator|(
name|count
operator|<
literal|3
condition|?
name|count
else|:
literal|3
operator|)
operator|*
literal|5
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>=
literal|1
condition|)
block|{
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_AUX1_SC_LEFT
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|0
index|]
operator|.
name|x1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|0
index|]
operator|.
name|x2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|0
index|]
operator|.
name|y1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|0
index|]
operator|.
name|y2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|aux_sc_cntl
operator||=
operator|(
name|R128_AUX1_SC_EN
operator||
name|R128_AUX1_SC_MODE_OR
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>=
literal|2
condition|)
block|{
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_AUX2_SC_LEFT
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|1
index|]
operator|.
name|x1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|1
index|]
operator|.
name|x2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|1
index|]
operator|.
name|y1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|1
index|]
operator|.
name|y2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|aux_sc_cntl
operator||=
operator|(
name|R128_AUX2_SC_EN
operator||
name|R128_AUX2_SC_MODE_OR
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>=
literal|3
condition|)
block|{
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_AUX3_SC_LEFT
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|2
index|]
operator|.
name|x1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|2
index|]
operator|.
name|x2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|2
index|]
operator|.
name|y1
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|boxes
index|[
literal|2
index|]
operator|.
name|y2
operator|-
literal|1
argument_list|)
expr_stmt|;
name|aux_sc_cntl
operator||=
operator|(
name|R128_AUX3_SC_EN
operator||
name|R128_AUX3_SC_MODE_OR
operator|)
expr_stmt|;
block|}
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_AUX_SC_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|aux_sc_cntl
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|r128_emit_core
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_SCALE_3D_CNTL
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|scale_3d_cntl
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|r128_emit_context
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|13
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_DST_PITCH_OFFSET_C
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|dst_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|dp_gui_master_cntl_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|sc_top_left_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|sc_bottom_right_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|z_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|z_pitch_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|z_sten_cntl_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|tex_cntl_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|misc_3d_state_cntl_reg
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|texture_clr_cmp_clr_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|texture_clr_cmp_msk_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|fog_color_c
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|r128_emit_setup
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET1
argument_list|(
name|R128_SETUP_CNTL
argument_list|,
name|R128_PM4_VC_FPU_SETUP
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|setup_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|pm4_vc_fpu_setup
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|r128_emit_masks
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_DP_WRITE_MASK
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|dp_write_mask
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_STEN_REF_MASK_C
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|sten_ref_mask_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|plane_3d_mask_c
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|r128_emit_window
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_WINDOW_XY_OFFSET
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|window_xy_offset
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|r128_emit_tex0
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_context_regs_t
modifier|*
name|ctx
init|=
operator|&
name|sarea_priv
operator|->
name|context_state
decl_stmt|;
name|drm_r128_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|0
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|7
operator|+
name|R128_MAX_TEXTURE_LEVELS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_PRIM_TEX_CNTL_C
argument_list|,
literal|2
operator|+
name|R128_MAX_TEXTURE_LEVELS
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_combine_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|tex_size_pitch_c
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R128_MAX_TEXTURE_LEVELS
condition|;
name|i
operator|++
control|)
block|{
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_offset
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_CONSTANT_COLOR_C
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|ctx
operator|->
name|constant_color_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_border_color
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|r128_emit_tex1
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_texture_regs_t
modifier|*
name|tex
init|=
operator|&
name|sarea_priv
operator|->
name|tex_state
index|[
literal|1
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|5
operator|+
name|R128_MAX_TEXTURE_LEVELS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_SEC_TEX_CNTL_C
argument_list|,
literal|1
operator|+
name|R128_MAX_TEXTURE_LEVELS
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_cntl
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_combine_cntl
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R128_MAX_TEXTURE_LEVELS
condition|;
name|i
operator|++
control|)
block|{
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_offset
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_SEC_TEXTURE_BORDER_COLOR_C
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|tex
operator|->
name|tex_border_color
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_emit_state
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|unsigned
name|int
name|dirty
init|=
name|sarea_priv
operator|->
name|dirty
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dirty=0x%08x\n"
argument_list|,
name|dirty
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirty
operator|&
name|R128_UPLOAD_CORE
condition|)
block|{
name|r128_emit_core
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_CORE
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|R128_UPLOAD_CONTEXT
condition|)
block|{
name|r128_emit_context
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_CONTEXT
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|R128_UPLOAD_SETUP
condition|)
block|{
name|r128_emit_setup
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_SETUP
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|R128_UPLOAD_MASKS
condition|)
block|{
name|r128_emit_masks
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_MASKS
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|R128_UPLOAD_WINDOW
condition|)
block|{
name|r128_emit_window
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_WINDOW
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|R128_UPLOAD_TEX0
condition|)
block|{
name|r128_emit_tex0
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_TEX0
expr_stmt|;
block|}
if|if
condition|(
name|dirty
operator|&
name|R128_UPLOAD_TEX1
condition|)
block|{
name|r128_emit_tex1
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_TEX1
expr_stmt|;
block|}
comment|/* Turn off the texture cache flushing */
name|sarea_priv
operator|->
name|context_state
operator|.
name|tex_cntl_c
operator|&=
operator|~
name|R128_TEX_CACHE_FLUSH
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_REQUIRE_QUIESCENCE
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|R128_PERFORMANCE_BOXES
end_if

begin_comment
comment|/* ================================================================  * Performance monitoring functions  */
end_comment

begin_function
specifier|static
name|void
name|r128_clear_box
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|int
name|r
parameter_list|,
name|int
name|g
parameter_list|,
name|int
name|b
parameter_list|)
block|{
name|u32
name|pitch
decl_stmt|,
name|offset
decl_stmt|;
name|u32
name|fb_bpp
decl_stmt|,
name|color
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
switch|switch
condition|(
name|dev_priv
operator|->
name|fb_bpp
condition|)
block|{
case|case
literal|16
case|:
name|fb_bpp
operator|=
name|R128_GMC_DST_16BPP
expr_stmt|;
name|color
operator|=
operator|(
operator|(
operator|(
name|r
operator|&
literal|0xf8
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|g
operator|&
literal|0xfc
operator|)
operator|<<
literal|3
operator|)
operator||
operator|(
operator|(
name|b
operator|&
literal|0xf8
operator|)
operator|>>
literal|3
operator|)
operator|)
expr_stmt|;
break|break;
case|case
literal|24
case|:
name|fb_bpp
operator|=
name|R128_GMC_DST_24BPP
expr_stmt|;
name|color
operator|=
operator|(
operator|(
name|r
operator|<<
literal|16
operator|)
operator||
operator|(
name|g
operator|<<
literal|8
operator|)
operator||
name|b
operator|)
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|fb_bpp
operator|=
name|R128_GMC_DST_32BPP
expr_stmt|;
name|color
operator|=
operator|(
operator|(
operator|(
literal|0xff
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
name|r
operator|<<
literal|16
operator|)
operator||
operator|(
name|g
operator|<<
literal|8
operator|)
operator||
name|b
operator|)
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|offset
operator|=
name|dev_priv
operator|->
name|back_offset
expr_stmt|;
name|pitch
operator|=
name|dev_priv
operator|->
name|back_pitch
operator|>>
literal|3
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
name|fb_bpp
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_AUX_CLIP_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|pitch
operator|<<
literal|21
operator|)
operator||
operator|(
name|offset
operator|>>
literal|5
operator|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_performance_boxes
parameter_list|(
name|drm_r128_private_t
modifier|*
name|dev_priv
parameter_list|)
block|{
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|dev_priv
operator|->
name|idle_count
argument_list|)
operator|==
literal|0
condition|)
block|{
name|r128_clear_box
argument_list|(
name|dev_priv
argument_list|,
literal|64
argument_list|,
literal|4
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|,
literal|255
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|atomic_set
argument_list|(
operator|&
name|dev_priv
operator|->
name|idle_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ================================================================  * CCE command dispatch functions  */
end_comment

begin_function
specifier|static
name|void
name|r128_print_dirty
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
name|DRM_INFO
argument_list|(
literal|"%s: (0x%x) %s%s%s%s%s%s%s%s%s\n"
argument_list|,
name|msg
argument_list|,
name|flags
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_CORE
operator|)
condition|?
literal|"core, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_CONTEXT
operator|)
condition|?
literal|"context, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_SETUP
operator|)
condition|?
literal|"setup, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_TEX0
operator|)
condition|?
literal|"tex0, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_TEX1
operator|)
condition|?
literal|"tex1, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_MASKS
operator|)
condition|?
literal|"masks, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_WINDOW
operator|)
condition|?
literal|"window, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_UPLOAD_CLIPRECTS
operator|)
condition|?
literal|"cliprects, "
else|:
literal|""
argument_list|,
operator|(
name|flags
operator|&
name|R128_REQUIRE_QUIESCENCE
operator|)
condition|?
literal|"quiescence, "
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_dispatch_clear
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_r128_clear_t
modifier|*
name|clear
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|struct
name|drm_clip_rect
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|unsigned
name|int
name|flags
init|=
name|clear
operator|->
name|flags
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|page_flipping
operator|&&
name|dev_priv
operator|->
name|current_page
operator|==
literal|1
condition|)
block|{
name|unsigned
name|int
name|tmp
init|=
name|flags
decl_stmt|;
name|flags
operator|&=
operator|~
operator|(
name|R128_FRONT
operator||
name|R128_BACK
operator|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|R128_FRONT
condition|)
name|flags
operator||=
name|R128_BACK
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|R128_BACK
condition|)
name|flags
operator||=
name|R128_FRONT
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|int
name|x
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x1
decl_stmt|;
name|int
name|y
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y1
decl_stmt|;
name|int
name|w
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x2
operator|-
name|x
decl_stmt|;
name|int
name|h
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y2
operator|-
name|y
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dispatch clear %d,%d-%d,%d flags 0x%x\n"
argument_list|,
name|pbox
index|[
name|i
index|]
operator|.
name|x1
argument_list|,
name|pbox
index|[
name|i
index|]
operator|.
name|y1
argument_list|,
name|pbox
index|[
name|i
index|]
operator|.
name|x2
argument_list|,
name|pbox
index|[
name|i
index|]
operator|.
name|y2
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
operator|(
name|R128_FRONT
operator||
name|R128_BACK
operator|)
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_DP_WRITE_MASK
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|clear
operator|->
name|color_mask
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|R128_FRONT
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_AUX_CLIP_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|front_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|clear
operator|->
name|clear_color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|R128_BACK
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_AUX_CLIP_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|back_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|clear
operator|->
name|clear_color
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|R128_DEPTH
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_AUX_CLIP_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|depth_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|clear
operator|->
name|clear_depth
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_dispatch_swap
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|nbox
init|=
name|sarea_priv
operator|->
name|nbox
decl_stmt|;
name|struct
name|drm_clip_rect
modifier|*
name|pbox
init|=
name|sarea_priv
operator|->
name|boxes
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|R128_PERFORMANCE_BOXES
comment|/* Do some trivial performance monitoring... 	 */
name|r128_cce_performance_boxes
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbox
condition|;
name|i
operator|++
control|)
block|{
name|int
name|x
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x1
decl_stmt|;
name|int
name|y
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y1
decl_stmt|;
name|int
name|w
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|x2
operator|-
name|x
decl_stmt|;
name|int
name|h
init|=
name|pbox
index|[
name|i
index|]
operator|.
name|y2
operator|-
name|y
decl_stmt|;
name|BEGIN_RING
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_BITBLT_MULTI
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_SRC_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_NONE
operator||
operator|(
name|dev_priv
operator|->
name|color_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_S
operator||
name|R128_DP_SRC_SOURCE_MEMORY
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_AUX_CLIP_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
comment|/* Make this work even if front& back are flipped: 		 */
if|if
condition|(
name|dev_priv
operator|->
name|current_page
operator|==
literal|0
condition|)
block|{
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|back_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|front_pitch_offset_c
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|front_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|back_pitch_offset_c
argument_list|)
expr_stmt|;
block|}
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|w
operator|<<
literal|16
operator|)
operator||
name|h
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
comment|/* Increment the frame counter.  The client-side 3D driver must 	 * throttle the framerate by waiting for this value before 	 * performing the swapbuffer ioctl. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|++
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_LAST_FRAME_REG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_dispatch_flip
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"page=%d pfCurrentPage=%d\n"
argument_list|,
name|dev_priv
operator|->
name|current_page
argument_list|,
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|pfCurrentPage
argument_list|)
expr_stmt|;
if|#
directive|if
name|R128_PERFORMANCE_BOXES
comment|/* Do some trivial performance monitoring... 	 */
name|r128_cce_performance_boxes
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BEGIN_RING
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|R128_WAIT_UNTIL_PAGE_FLIPPED
argument_list|()
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_CRTC_OFFSET
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|current_page
operator|==
literal|0
condition|)
block|{
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|back_offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|front_offset
argument_list|)
expr_stmt|;
block|}
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* Increment the frame counter.  The client-side 3D driver must 	 * throttle the framerate by waiting for this value before 	 * performing the swapbuffer ioctl. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
operator|++
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|pfCurrentPage
operator|=
name|dev_priv
operator|->
name|current_page
operator|=
literal|1
operator|-
name|dev_priv
operator|->
name|current_page
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_LAST_FRAME_REG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_frame
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_dispatch_vertex
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_buf
modifier|*
name|buf
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|format
init|=
name|sarea_priv
operator|->
name|vc_format
decl_stmt|;
name|int
name|offset
init|=
name|buf
operator|->
name|bus_address
decl_stmt|;
name|int
name|size
init|=
name|buf
operator|->
name|used
decl_stmt|;
name|int
name|prim
init|=
name|buf_priv
operator|->
name|prim
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"buf=%d nbox=%d\n"
argument_list|,
name|buf
operator|->
name|idx
argument_list|,
name|sarea_priv
operator|->
name|nbox
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
condition|)
name|r128_print_dirty
argument_list|(
literal|"dispatch_vertex"
argument_list|,
name|sarea_priv
operator|->
name|dirty
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|used
condition|)
block|{
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|dirty
operator|&
operator|~
name|R128_UPLOAD_CLIPRECTS
condition|)
block|{
name|r128_emit_state
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
do|do
block|{
comment|/* Emit the next set of up to three cliprects */
if|if
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
block|{
name|r128_emit_clip_rects
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|sarea_priv
operator|->
name|boxes
index|[
name|i
index|]
argument_list|,
name|sarea_priv
operator|->
name|nbox
operator|-
name|i
argument_list|)
expr_stmt|;
block|}
comment|/* Emit the vertex buffer rendering commands */
name|BEGIN_RING
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_3D_RNDR_GEN_INDX_PRIM
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|format
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|prim
operator||
name|R128_CCE_VC_CNTL_PRIM_WALK_LIST
operator||
operator|(
name|size
operator|<<
name|R128_CCE_VC_CNTL_NUM_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|i
operator|+=
literal|3
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
do|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|buf_priv
operator|->
name|age
operator|=
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
expr_stmt|;
comment|/* Emit the vertex buffer age */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_LAST_DISPATCH_REG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|buf_priv
operator|->
name|age
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
comment|/* FIXME: Check dispatched field */
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|++
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_CLIPRECTS
expr_stmt|;
name|sarea_priv
operator|->
name|nbox
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_dispatch_indirect
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_buf
modifier|*
name|buf
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"indirect: buf=%d s=0x%x e=0x%x\n"
argument_list|,
name|buf
operator|->
name|idx
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|end
condition|)
block|{
name|int
name|offset
init|=
name|buf
operator|->
name|bus_address
operator|+
name|start
decl_stmt|;
name|int
name|dwords
init|=
operator|(
name|end
operator|-
name|start
operator|+
literal|3
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
decl_stmt|;
comment|/* Indirect buffer data must be an even number of 		 * dwords, so if we've been given an odd number we must 		 * pad the data with a Type-2 CCE packet. 		 */
if|if
condition|(
name|dwords
operator|&
literal|1
condition|)
block|{
name|u32
modifier|*
name|data
init|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|virtual
operator|+
name|buf
operator|->
name|offset
operator|+
name|start
operator|)
decl_stmt|;
name|data
index|[
name|dwords
operator|++
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|R128_CCE_PACKET2
argument_list|)
expr_stmt|;
block|}
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
comment|/* Fire off the indirect buffer */
name|BEGIN_RING
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_PM4_IW_INDOFF
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dwords
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|buf_priv
operator|->
name|age
operator|=
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
expr_stmt|;
comment|/* Emit the indirect buffer age */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_LAST_DISPATCH_REG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|buf_priv
operator|->
name|age
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
comment|/* FIXME: Check dispatched field */
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|r128_cce_dispatch_indices
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_buf
modifier|*
name|buf
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
init|=
name|buf
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|int
name|format
init|=
name|sarea_priv
operator|->
name|vc_format
decl_stmt|;
name|int
name|offset
init|=
name|dev
operator|->
name|agp_buffer_map
operator|->
name|offset
operator|-
name|dev_priv
operator|->
name|cce_buffers_offset
decl_stmt|;
name|int
name|prim
init|=
name|buf_priv
operator|->
name|prim
decl_stmt|;
name|u32
modifier|*
name|data
decl_stmt|;
name|int
name|dwords
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"indices: s=%d e=%d c=%d\n"
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
condition|)
name|r128_print_dirty
argument_list|(
literal|"dispatch_indices"
argument_list|,
name|sarea_priv
operator|->
name|dirty
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|end
condition|)
block|{
name|buf_priv
operator|->
name|dispatched
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|dirty
operator|&
operator|~
name|R128_UPLOAD_CLIPRECTS
condition|)
block|{
name|r128_emit_state
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
block|}
name|dwords
operator|=
operator|(
name|end
operator|-
name|start
operator|+
literal|3
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|virtual
operator|+
name|buf
operator|->
name|offset
operator|+
name|start
operator|)
expr_stmt|;
name|data
index|[
literal|0
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_3D_RNDR_GEN_INDX_PRIM
argument_list|,
name|dwords
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|data
index|[
literal|1
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|data
index|[
literal|2
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|R128_MAX_VB_VERTS
argument_list|)
expr_stmt|;
name|data
index|[
literal|3
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|format
argument_list|)
expr_stmt|;
name|data
index|[
literal|4
index|]
operator|=
name|cpu_to_le32
argument_list|(
operator|(
name|prim
operator||
name|R128_CCE_VC_CNTL_PRIM_WALK_IND
operator||
operator|(
name|count
operator|<<
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|&
literal|0x1
condition|)
block|{
ifdef|#
directive|ifdef
name|__LITTLE_ENDIAN
name|data
index|[
name|dwords
operator|-
literal|1
index|]
operator|&=
literal|0x0000ffff
expr_stmt|;
else|#
directive|else
name|data
index|[
name|dwords
operator|-
literal|1
index|]
operator|&=
literal|0xffff0000
expr_stmt|;
endif|#
directive|endif
block|}
do|do
block|{
comment|/* Emit the next set of up to three cliprects */
if|if
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
block|{
name|r128_emit_clip_rects
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|sarea_priv
operator|->
name|boxes
index|[
name|i
index|]
argument_list|,
name|sarea_priv
operator|->
name|nbox
operator|-
name|i
argument_list|)
expr_stmt|;
block|}
name|r128_cce_dispatch_indirect
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|i
operator|+=
literal|3
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
name|sarea_priv
operator|->
name|nbox
condition|)
do|;
block|}
if|if
condition|(
name|buf_priv
operator|->
name|discard
condition|)
block|{
name|buf_priv
operator|->
name|age
operator|=
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
expr_stmt|;
comment|/* Emit the vertex buffer age */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_LAST_DISPATCH_REG
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|buf_priv
operator|->
name|age
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|1
expr_stmt|;
comment|/* FIXME: Check dispatched field */
name|buf_priv
operator|->
name|dispatched
operator|=
literal|0
expr_stmt|;
block|}
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|last_dispatch
operator|++
expr_stmt|;
name|sarea_priv
operator|->
name|dirty
operator|&=
operator|~
name|R128_UPLOAD_CLIPRECTS
expr_stmt|;
name|sarea_priv
operator|->
name|nbox
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_dispatch_blit
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|,
name|drm_r128_blit_t
modifier|*
name|blit
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|u32
modifier|*
name|data
decl_stmt|;
name|int
name|dword_shift
decl_stmt|,
name|dwords
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* The compiler won't optimize away a division by a variable, 	 * even if the only legal values are powers of two.  Thus, we'll 	 * use a shift instead. 	 */
switch|switch
condition|(
name|blit
operator|->
name|format
condition|)
block|{
case|case
name|R128_DATATYPE_ARGB8888
case|:
name|dword_shift
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|R128_DATATYPE_ARGB1555
case|:
case|case
name|R128_DATATYPE_RGB565
case|:
case|case
name|R128_DATATYPE_ARGB4444
case|:
case|case
name|R128_DATATYPE_YVYU422
case|:
case|case
name|R128_DATATYPE_VYUY422
case|:
name|dword_shift
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|R128_DATATYPE_CI8
case|:
case|case
name|R128_DATATYPE_RGB8
case|:
name|dword_shift
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"invalid blit format %d\n"
argument_list|,
name|blit
operator|->
name|format
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* Flush the pixel cache, and mark the contents as Read Invalid. 	 * This ensures no pixel data gets mixed up with the texture 	 * data from the host data blit, otherwise part of the texture 	 * image may be corrupted. 	 */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_PC_GUI_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_PC_RI_GUI
operator||
name|R128_PC_FLUSH_GUI
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
comment|/* Dispatch the indirect buffer. 	 */
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|blit
operator|->
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|file_priv
operator|!=
name|file_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"process %d using buffer owned by %p\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|buf
operator|->
name|file_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"sending pending buffer %d\n"
argument_list|,
name|blit
operator|->
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|buf_priv
operator|->
name|discard
operator|=
literal|1
expr_stmt|;
name|dwords
operator|=
operator|(
name|blit
operator|->
name|width
operator|*
name|blit
operator|->
name|height
operator|)
operator|>>
name|dword_shift
expr_stmt|;
name|data
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|dev
operator|->
name|agp_buffer_map
operator|->
name|handle
operator|+
name|buf
operator|->
name|offset
operator|)
expr_stmt|;
name|data
index|[
literal|0
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_HOSTDATA_BLT
argument_list|,
name|dwords
operator|+
literal|6
argument_list|)
argument_list|)
expr_stmt|;
name|data
index|[
literal|1
index|]
operator|=
name|cpu_to_le32
argument_list|(
operator|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_NONE
operator||
operator|(
name|blit
operator|->
name|format
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_S
operator||
name|R128_DP_SRC_SOURCE_HOST_DATA
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_AUX_CLIP_DIS
operator||
name|R128_GMC_WR_MSK_DIS
operator|)
argument_list|)
expr_stmt|;
name|data
index|[
literal|2
index|]
operator|=
name|cpu_to_le32
argument_list|(
operator|(
name|blit
operator|->
name|pitch
operator|<<
literal|21
operator|)
operator||
operator|(
name|blit
operator|->
name|offset
operator|>>
literal|5
operator|)
argument_list|)
expr_stmt|;
name|data
index|[
literal|3
index|]
operator|=
name|cpu_to_le32
argument_list|(
literal|0xffffffff
argument_list|)
expr_stmt|;
name|data
index|[
literal|4
index|]
operator|=
name|cpu_to_le32
argument_list|(
literal|0xffffffff
argument_list|)
expr_stmt|;
name|data
index|[
literal|5
index|]
operator|=
name|cpu_to_le32
argument_list|(
operator|(
name|blit
operator|->
name|y
operator|<<
literal|16
operator|)
operator||
name|blit
operator|->
name|x
argument_list|)
expr_stmt|;
name|data
index|[
literal|6
index|]
operator|=
name|cpu_to_le32
argument_list|(
operator|(
name|blit
operator|->
name|height
operator|<<
literal|16
operator|)
operator||
name|blit
operator|->
name|width
argument_list|)
expr_stmt|;
name|data
index|[
literal|7
index|]
operator|=
name|cpu_to_le32
argument_list|(
name|dwords
argument_list|)
expr_stmt|;
name|buf
operator|->
name|used
operator|=
operator|(
name|dwords
operator|+
literal|8
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|r128_cce_dispatch_indirect
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
comment|/* Flush the pixel cache after the blit completes.  This ensures 	 * the texture data is written out to memory before rendering 	 * continues. 	 */
name|BEGIN_RING
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_PC_GUI_CTLSTAT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_PC_FLUSH_GUI
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ================================================================  * Tiled depth buffer management  *  * FIXME: These should all set the destination write mask for when we  * have hardware stencil support.  */
end_comment

begin_function
specifier|static
name|int
name|r128_cce_dispatch_write_span
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_r128_depth_t
modifier|*
name|depth
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|count
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|;
name|u32
modifier|*
name|buffer
decl_stmt|;
name|u8
modifier|*
name|mask
decl_stmt|;
name|int
name|i
decl_stmt|,
name|buffer_size
decl_stmt|,
name|mask_size
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|count
operator|=
name|depth
operator|->
name|n
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|4096
operator|||
name|count
operator|<=
literal|0
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|x
argument_list|,
name|depth
operator|->
name|x
argument_list|,
sizeof|sizeof
argument_list|(
name|x
argument_list|)
argument_list|)
condition|)
block|{
return|return
operator|-
name|EFAULT
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|y
argument_list|,
name|depth
operator|->
name|y
argument_list|,
sizeof|sizeof
argument_list|(
name|y
argument_list|)
argument_list|)
condition|)
block|{
return|return
operator|-
name|EFAULT
return|;
block|}
name|buffer_size
operator|=
name|depth
operator|->
name|n
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|drm_alloc
argument_list|(
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
operator|==
name|NULL
condition|)
return|return
operator|-
name|ENOMEM
return|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|buffer
argument_list|,
name|depth
operator|->
name|buffer
argument_list|,
name|buffer_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
name|mask_size
operator|=
name|depth
operator|->
name|n
operator|*
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|->
name|mask
condition|)
block|{
name|mask
operator|=
name|drm_alloc
argument_list|(
name|mask_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|==
name|NULL
condition|)
block|{
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|mask
argument_list|,
name|depth
operator|->
name|mask
argument_list|,
name|mask_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|mask
argument_list|,
name|mask_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
operator|,
name|x
operator|++
control|)
block|{
if|if
condition|(
name|mask
index|[
name|i
index|]
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|depth_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|buffer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
literal|1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
block|}
name|drm_free
argument_list|(
name|mask
argument_list|,
name|mask_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
operator|,
name|x
operator|++
control|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|depth_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|buffer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
literal|1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
block|}
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_dispatch_write_pixels
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_r128_depth_t
modifier|*
name|depth
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|count
decl_stmt|,
modifier|*
name|x
decl_stmt|,
modifier|*
name|y
decl_stmt|;
name|u32
modifier|*
name|buffer
decl_stmt|;
name|u8
modifier|*
name|mask
decl_stmt|;
name|int
name|i
decl_stmt|,
name|xbuf_size
decl_stmt|,
name|ybuf_size
decl_stmt|,
name|buffer_size
decl_stmt|,
name|mask_size
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|count
operator|=
name|depth
operator|->
name|n
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|4096
operator|||
name|count
operator|<=
literal|0
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
name|xbuf_size
operator|=
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|x
argument_list|)
expr_stmt|;
name|ybuf_size
operator|=
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|y
argument_list|)
expr_stmt|;
name|x
operator|=
name|drm_alloc
argument_list|(
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
name|ENOMEM
return|;
block|}
name|y
operator|=
name|drm_alloc
argument_list|(
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|NULL
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|x
argument_list|,
name|depth
operator|->
name|x
argument_list|,
name|xbuf_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|y
argument_list|,
name|depth
operator|->
name|y
argument_list|,
name|xbuf_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
name|buffer_size
operator|=
name|depth
operator|->
name|n
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|buffer
operator|=
name|drm_alloc
argument_list|(
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
operator|==
name|NULL
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|buffer
argument_list|,
name|depth
operator|->
name|buffer
argument_list|,
name|buffer_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
if|if
condition|(
name|depth
operator|->
name|mask
condition|)
block|{
name|mask_size
operator|=
name|depth
operator|->
name|n
operator|*
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
expr_stmt|;
name|mask
operator|=
name|drm_alloc
argument_list|(
name|mask_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|==
name|NULL
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|mask
argument_list|,
name|depth
operator|->
name|mask
argument_list|,
name|mask_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|mask
argument_list|,
name|mask_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mask
index|[
name|i
index|]
condition|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|depth_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|buffer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
index|[
name|i
index|]
operator|<<
literal|16
operator|)
operator||
name|y
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
literal|1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
block|}
name|drm_free
argument_list|(
name|mask
argument_list|,
name|mask_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|BEGIN_RING
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_PAINT_MULTI
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_SOLID_COLOR
operator||
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_P
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|depth_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|buffer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
index|[
name|i
index|]
operator|<<
literal|16
operator|)
operator||
name|y
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
literal|1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
block|}
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|buffer
argument_list|,
name|buffer_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_dispatch_read_span
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_r128_depth_t
modifier|*
name|depth
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|count
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|count
operator|=
name|depth
operator|->
name|n
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|4096
operator|||
name|count
operator|<=
literal|0
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|x
argument_list|,
name|depth
operator|->
name|x
argument_list|,
sizeof|sizeof
argument_list|(
name|x
argument_list|)
argument_list|)
condition|)
block|{
return|return
operator|-
name|EFAULT
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|y
argument_list|,
name|depth
operator|->
name|y
argument_list|,
sizeof|sizeof
argument_list|(
name|y
argument_list|)
argument_list|)
condition|)
block|{
return|return
operator|-
name|EFAULT
return|;
block|}
name|BEGIN_RING
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_BITBLT_MULTI
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_SRC_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_NONE
operator||
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_S
operator||
name|R128_DP_SRC_SOURCE_MEMORY
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|depth_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|span_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
literal|0
operator|<<
literal|16
operator|)
operator||
literal|0
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|count
operator|<<
literal|16
operator|)
operator||
literal|1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_dispatch_read_pixels
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|drm_r128_depth_t
modifier|*
name|depth
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|count
decl_stmt|,
modifier|*
name|x
decl_stmt|,
modifier|*
name|y
decl_stmt|;
name|int
name|i
decl_stmt|,
name|xbuf_size
decl_stmt|,
name|ybuf_size
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|count
operator|=
name|depth
operator|->
name|n
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|4096
operator|||
name|count
operator|<=
literal|0
condition|)
return|return
operator|-
name|EMSGSIZE
return|;
if|if
condition|(
name|count
operator|>
name|dev_priv
operator|->
name|depth_pitch
condition|)
block|{
name|count
operator|=
name|dev_priv
operator|->
name|depth_pitch
expr_stmt|;
block|}
name|xbuf_size
operator|=
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|x
argument_list|)
expr_stmt|;
name|ybuf_size
operator|=
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|y
argument_list|)
expr_stmt|;
name|x
operator|=
name|drm_alloc
argument_list|(
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
name|ENOMEM
return|;
block|}
name|y
operator|=
name|drm_alloc
argument_list|(
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|NULL
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|x
argument_list|,
name|depth
operator|->
name|x
argument_list|,
name|xbuf_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
name|y
argument_list|,
name|depth
operator|->
name|y
argument_list|,
name|ybuf_size
argument_list|)
condition|)
block|{
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|BEGIN_RING
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET3
argument_list|(
name|R128_CNTL_BITBLT_MULTI
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|R128_GMC_SRC_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_DST_PITCH_OFFSET_CNTL
operator||
name|R128_GMC_BRUSH_NONE
operator||
operator|(
name|dev_priv
operator|->
name|depth_fmt
operator|<<
literal|8
operator|)
operator||
name|R128_GMC_SRC_DATATYPE_COLOR
operator||
name|R128_ROP3_S
operator||
name|R128_DP_SRC_SOURCE_MEMORY
operator||
name|R128_GMC_CLR_CMP_CNTL_DIS
operator||
name|R128_GMC_WR_MSK_DIS
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|depth_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|dev_priv
operator|->
name|span_pitch_offset_c
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|x
index|[
name|i
index|]
operator|<<
literal|16
operator|)
operator||
name|y
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
name|i
operator|<<
literal|16
operator|)
operator||
literal|0
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
operator|(
literal|1
operator|<<
literal|16
operator|)
operator||
literal|1
argument_list|)
expr_stmt|;
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
name|drm_free
argument_list|(
name|x
argument_list|,
name|xbuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
name|drm_free
argument_list|(
name|y
argument_list|,
name|ybuf_size
argument_list|,
name|DRM_MEM_BUFS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ================================================================  * Polygon stipple  */
end_comment

begin_function
specifier|static
name|void
name|r128_cce_dispatch_stipple
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|u32
modifier|*
name|stipple
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RING_LOCALS
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|BEGIN_RING
argument_list|(
literal|33
argument_list|)
expr_stmt|;
name|OUT_RING
argument_list|(
name|CCE_PACKET0
argument_list|(
name|R128_BRUSH_DATA0
argument_list|,
literal|31
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|OUT_RING
argument_list|(
name|stipple
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ADVANCE_RING
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ================================================================  * IOCTL functions  */
end_comment

begin_function
specifier|static
name|int
name|r128_cce_clear
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|drm_r128_clear_t
modifier|*
name|clear
init|=
name|data
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|R128_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|R128_NR_SAREA_CLIPRECTS
expr_stmt|;
name|r128_cce_dispatch_clear
argument_list|(
name|dev
argument_list|,
name|clear
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
comment|/* Make sure we restore the 3D state next time. 	 */
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
name|R128_UPLOAD_CONTEXT
operator||
name|R128_UPLOAD_MASKS
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_do_init_pageflip
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|crtc_offset
operator|=
name|R128_READ
argument_list|(
name|R128_CRTC_OFFSET
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|crtc_offset_cntl
operator|=
name|R128_READ
argument_list|(
name|R128_CRTC_OFFSET_CNTL
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_CRTC_OFFSET
argument_list|,
name|dev_priv
operator|->
name|front_offset
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_CRTC_OFFSET_CNTL
argument_list|,
name|dev_priv
operator|->
name|crtc_offset_cntl
operator||
name|R128_CRTC_OFFSET_FLIP_CNTL
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|page_flipping
operator|=
literal|1
expr_stmt|;
name|dev_priv
operator|->
name|current_page
operator|=
literal|0
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|pfCurrentPage
operator|=
name|dev_priv
operator|->
name|current_page
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_do_cleanup_pageflip
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_CRTC_OFFSET
argument_list|,
name|dev_priv
operator|->
name|crtc_offset
argument_list|)
expr_stmt|;
name|R128_WRITE
argument_list|(
name|R128_CRTC_OFFSET_CNTL
argument_list|,
name|dev_priv
operator|->
name|crtc_offset_cntl
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|current_page
operator|!=
literal|0
condition|)
block|{
name|r128_cce_dispatch_flip
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
block|}
name|dev_priv
operator|->
name|page_flipping
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Swapping and flipping are different operations, need different ioctls.  * They can& should be intermixed to support multiple 3d windows.  */
end_comment

begin_function
specifier|static
name|int
name|r128_cce_flip
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
operator|->
name|page_flipping
condition|)
name|r128_do_init_pageflip
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|r128_cce_dispatch_flip
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_swap
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_sarea_t
modifier|*
name|sarea_priv
init|=
name|dev_priv
operator|->
name|sarea_priv
decl_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sarea_priv
operator|->
name|nbox
operator|>
name|R128_NR_SAREA_CLIPRECTS
condition|)
name|sarea_priv
operator|->
name|nbox
operator|=
name|R128_NR_SAREA_CLIPRECTS
expr_stmt|;
name|r128_cce_dispatch_swap
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev_priv
operator|->
name|sarea_priv
operator|->
name|dirty
operator||=
operator|(
name|R128_UPLOAD_CONTEXT
operator||
name|R128_UPLOAD_MASKS
operator|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_vertex
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_r128_vertex_t
modifier|*
name|vertex
init|=
name|data
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"called with no initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"pid=%d index=%d count=%d discard=%d\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|vertex
operator|->
name|idx
argument_list|,
name|vertex
operator|->
name|count
argument_list|,
name|vertex
operator|->
name|discard
argument_list|)
expr_stmt|;
if|if
condition|(
name|vertex
operator|->
name|idx
operator|<
literal|0
operator|||
name|vertex
operator|->
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|vertex
operator|->
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|vertex
operator|->
name|prim
operator|<
literal|0
operator|||
name|vertex
operator|->
name|prim
operator|>
name|R128_CCE_VC_CNTL_PRIM_TYPE_TRI_TYPE2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer prim %d\n"
argument_list|,
name|vertex
operator|->
name|prim
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|vertex
operator|->
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|file_priv
operator|!=
name|file_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"process %d using buffer owned by %p\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|buf
operator|->
name|file_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"sending pending buffer %d\n"
argument_list|,
name|vertex
operator|->
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|buf
operator|->
name|used
operator|=
name|vertex
operator|->
name|count
expr_stmt|;
name|buf_priv
operator|->
name|prim
operator|=
name|vertex
operator|->
name|prim
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|vertex
operator|->
name|discard
expr_stmt|;
name|r128_cce_dispatch_vertex
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_indices
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_r128_indices_t
modifier|*
name|elts
init|=
name|data
decl_stmt|;
name|int
name|count
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"called with no initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"pid=%d buf=%d s=%d e=%d d=%d\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|elts
operator|->
name|idx
argument_list|,
name|elts
operator|->
name|start
argument_list|,
name|elts
operator|->
name|end
argument_list|,
name|elts
operator|->
name|discard
argument_list|)
expr_stmt|;
if|if
condition|(
name|elts
operator|->
name|idx
operator|<
literal|0
operator|||
name|elts
operator|->
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|elts
operator|->
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|elts
operator|->
name|prim
operator|<
literal|0
operator|||
name|elts
operator|->
name|prim
operator|>
name|R128_CCE_VC_CNTL_PRIM_TYPE_TRI_TYPE2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer prim %d\n"
argument_list|,
name|elts
operator|->
name|prim
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|elts
operator|->
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|file_priv
operator|!=
name|file_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"process %d using buffer owned by %p\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|buf
operator|->
name|file_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"sending pending buffer %d\n"
argument_list|,
name|elts
operator|->
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|count
operator|=
operator|(
name|elts
operator|->
name|end
operator|-
name|elts
operator|->
name|start
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
name|elts
operator|->
name|start
operator|-=
name|R128_INDEX_PRIM_OFFSET
expr_stmt|;
if|if
condition|(
name|elts
operator|->
name|start
operator|&
literal|0x7
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"misaligned buffer 0x%x\n"
argument_list|,
name|elts
operator|->
name|start
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|elts
operator|->
name|start
operator|<
name|buf
operator|->
name|used
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"no header 0x%x - 0x%x\n"
argument_list|,
name|elts
operator|->
name|start
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|buf
operator|->
name|used
operator|=
name|elts
operator|->
name|end
expr_stmt|;
name|buf_priv
operator|->
name|prim
operator|=
name|elts
operator|->
name|prim
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|elts
operator|->
name|discard
expr_stmt|;
name|r128_cce_dispatch_indices
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|elts
operator|->
name|start
argument_list|,
name|elts
operator|->
name|end
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_blit
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_blit_t
modifier|*
name|blit
init|=
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"pid=%d index=%d\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|blit
operator|->
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|blit
operator|->
name|idx
operator|<
literal|0
operator|||
name|blit
operator|->
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|blit
operator|->
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|ret
operator|=
name|r128_cce_dispatch_blit
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|,
name|blit
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_depth
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_depth_t
modifier|*
name|depth
init|=
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
switch|switch
condition|(
name|depth
operator|->
name|func
condition|)
block|{
case|case
name|R128_WRITE_SPAN
case|:
name|ret
operator|=
name|r128_cce_dispatch_write_span
argument_list|(
name|dev
argument_list|,
name|depth
argument_list|)
expr_stmt|;
break|break;
case|case
name|R128_WRITE_PIXELS
case|:
name|ret
operator|=
name|r128_cce_dispatch_write_pixels
argument_list|(
name|dev
argument_list|,
name|depth
argument_list|)
expr_stmt|;
break|break;
case|case
name|R128_READ_SPAN
case|:
name|ret
operator|=
name|r128_cce_dispatch_read_span
argument_list|(
name|dev
argument_list|,
name|depth
argument_list|)
expr_stmt|;
break|break;
case|case
name|R128_READ_PIXELS
case|:
name|ret
operator|=
name|r128_cce_dispatch_read_pixels
argument_list|(
name|dev
argument_list|,
name|depth
argument_list|)
expr_stmt|;
break|break;
block|}
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_stipple
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_stipple_t
modifier|*
name|stipple
init|=
name|data
decl_stmt|;
name|u32
name|mask
index|[
literal|32
index|]
decl_stmt|;
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|mask
argument_list|,
name|stipple
operator|->
name|mask
argument_list|,
literal|32
operator|*
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EFAULT
return|;
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|r128_cce_dispatch_stipple
argument_list|(
name|dev
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_cce_indirect
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|drm_device_dma
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|struct
name|drm_buf
modifier|*
name|buf
decl_stmt|;
name|drm_r128_buf_priv_t
modifier|*
name|buf_priv
decl_stmt|;
name|drm_r128_indirect_t
modifier|*
name|indirect
init|=
name|data
decl_stmt|;
if|#
directive|if
literal|0
block|RING_LOCALS;
endif|#
directive|endif
name|LOCK_TEST_WITH_RETURN
argument_list|(
name|dev
argument_list|,
name|file_priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"called with no initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"idx=%d s=%d e=%d d=%d\n"
argument_list|,
name|indirect
operator|->
name|idx
argument_list|,
name|indirect
operator|->
name|start
argument_list|,
name|indirect
operator|->
name|end
argument_list|,
name|indirect
operator|->
name|discard
argument_list|)
expr_stmt|;
if|if
condition|(
name|indirect
operator|->
name|idx
operator|<
literal|0
operator|||
name|indirect
operator|->
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"buffer index %d (of %d max)\n"
argument_list|,
name|indirect
operator|->
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|indirect
operator|->
name|idx
index|]
expr_stmt|;
name|buf_priv
operator|=
name|buf
operator|->
name|dev_private
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|file_priv
operator|!=
name|file_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"process %d using buffer owned by %p\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|,
name|buf
operator|->
name|file_priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|buf
operator|->
name|pending
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"sending pending buffer %d\n"
argument_list|,
name|indirect
operator|->
name|idx
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|indirect
operator|->
name|start
operator|<
name|buf
operator|->
name|used
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"reusing indirect: start=0x%x actual=0x%x\n"
argument_list|,
name|indirect
operator|->
name|start
argument_list|,
name|buf
operator|->
name|used
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|RING_SPACE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|VB_AGE_TEST_WITH_RETURN
argument_list|(
name|dev_priv
argument_list|)
expr_stmt|;
name|buf
operator|->
name|used
operator|=
name|indirect
operator|->
name|end
expr_stmt|;
name|buf_priv
operator|->
name|discard
operator|=
name|indirect
operator|->
name|discard
expr_stmt|;
if|#
directive|if
literal|0
comment|/* Wait for the 3D stream to idle before the indirect buffer 	 * containing 2D acceleration commands is processed. 	 */
block|BEGIN_RING(2); 	RADEON_WAIT_UNTIL_3D_IDLE(); 	ADVANCE_RING();
endif|#
directive|endif
comment|/* Dispatch the indirect buffer full of commands from the 	 * X server.  This is insecure and is thus only available to 	 * privileged clients. 	 */
name|r128_cce_dispatch_indirect
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|indirect
operator|->
name|start
argument_list|,
name|indirect
operator|->
name|end
argument_list|)
expr_stmt|;
name|COMMIT_RING
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|r128_getparam
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_r128_getparam_t
modifier|*
name|param
init|=
name|data
decl_stmt|;
name|int
name|value
decl_stmt|;
if|if
condition|(
operator|!
name|dev_priv
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"called with no initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"pid=%d\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|param
operator|->
name|param
condition|)
block|{
case|case
name|R128_PARAM_IRQ_NR
case|:
name|value
operator|=
name|dev
operator|->
name|irq
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
name|param
operator|->
name|value
argument_list|,
operator|&
name|value
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"copy_to_user\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EFAULT
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|r128_driver_preclose
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|struct
name|drm_file
modifier|*
name|file_priv
parameter_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|dev_private
condition|)
block|{
name|drm_r128_private_t
modifier|*
name|dev_priv
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|dev_priv
operator|->
name|page_flipping
condition|)
block|{
name|r128_do_cleanup_pageflip
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|r128_driver_lastclose
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|r128_do_cleanup_cce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|drm_ioctl_desc
name|r128_ioctls
index|[]
init|=
block|{
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_INIT
argument_list|,
name|r128_cce_init
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_CCE_START
argument_list|,
name|r128_cce_start
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_CCE_STOP
argument_list|,
name|r128_cce_stop
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_CCE_RESET
argument_list|,
name|r128_cce_reset
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_CCE_IDLE
argument_list|,
name|r128_cce_idle
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_RESET
argument_list|,
name|r128_engine_reset
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_FULLSCREEN
argument_list|,
name|r128_fullscreen
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_SWAP
argument_list|,
name|r128_cce_swap
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_FLIP
argument_list|,
name|r128_cce_flip
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_CLEAR
argument_list|,
name|r128_cce_clear
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_VERTEX
argument_list|,
name|r128_cce_vertex
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_INDICES
argument_list|,
name|r128_cce_indices
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_BLIT
argument_list|,
name|r128_cce_blit
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_DEPTH
argument_list|,
name|r128_cce_depth
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_STIPPLE
argument_list|,
name|r128_cce_stipple
argument_list|,
name|DRM_AUTH
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_INDIRECT
argument_list|,
name|r128_cce_indirect
argument_list|,
name|DRM_AUTH
operator||
name|DRM_MASTER
operator||
name|DRM_ROOT_ONLY
argument_list|)
block|,
name|DRM_IOCTL_DEF
argument_list|(
name|DRM_R128_GETPARAM
argument_list|,
name|r128_getparam
argument_list|,
name|DRM_AUTH
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|r128_max_ioctl
init|=
name|DRM_ARRAY_SIZE
argument_list|(
name|r128_ioctls
argument_list|)
decl_stmt|;
end_decl_stmt

end_unit


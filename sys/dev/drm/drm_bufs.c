begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* drm_bufs.h -- Generic buffer template -*- linux-c -*-  * Created: Thu Nov 23 03:10:50 2000 by gareth@valinux.com  */
end_comment

begin_comment
comment|/*-  * Copyright 1999, 2000 Precision Insight, Inc., Cedar Park, Texas.  * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.  * All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the next  * paragraph) shall be included in all copies or substantial portions of the  * Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors:  *    Rickard E. (Rik) Faith<faith@valinux.com>  *    Gareth Hughes<gareth@valinux.com>  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_comment
comment|/*  * Compute order.  Can be made faster.  */
end_comment

begin_function
name|int
name|drm_order
parameter_list|(
name|unsigned
name|long
name|size
parameter_list|)
block|{
name|int
name|order
decl_stmt|;
name|unsigned
name|long
name|tmp
decl_stmt|;
for|for
control|(
name|order
operator|=
literal|0
operator|,
name|tmp
operator|=
name|size
init|;
name|tmp
operator|>>=
literal|1
condition|;
operator|++
name|order
control|)
empty_stmt|;
if|if
condition|(
name|size
operator|&
operator|~
operator|(
literal|1
operator|<<
name|order
operator|)
condition|)
operator|++
name|order
expr_stmt|;
return|return
name|order
return|;
block|}
end_function

begin_function
name|unsigned
name|long
name|drm_get_resource_start
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|unsigned
name|int
name|resource
parameter_list|)
block|{
name|struct
name|resource
modifier|*
name|bsr
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|resource
operator|=
name|resource
operator|*
literal|4
operator|+
literal|0x10
expr_stmt|;
name|bsr
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|resource
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsr
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Couldn't find resource 0x%x\n"
argument_list|,
name|resource
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|offset
operator|=
name|rman_get_start
argument_list|(
name|bsr
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|resource
argument_list|,
name|bsr
argument_list|)
expr_stmt|;
return|return
name|offset
return|;
block|}
end_function

begin_function
name|unsigned
name|long
name|drm_get_resource_len
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|unsigned
name|int
name|resource
parameter_list|)
block|{
name|struct
name|resource
modifier|*
name|bsr
decl_stmt|;
name|unsigned
name|long
name|len
decl_stmt|;
name|resource
operator|=
name|resource
operator|*
literal|4
operator|+
literal|0x10
expr_stmt|;
name|bsr
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|resource
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsr
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Couldn't find resource 0x%x\n"
argument_list|,
name|resource
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|len
operator|=
name|rman_get_size
argument_list|(
name|bsr
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|resource
argument_list|,
name|bsr
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|drm_initmap
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|unsigned
name|long
name|start
parameter_list|,
name|unsigned
name|long
name|len
parameter_list|,
name|unsigned
name|int
name|resource
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|drm_local_map_t
modifier|*
name|map
decl_stmt|;
name|struct
name|resource
modifier|*
name|bsr
decl_stmt|;
if|if
condition|(
name|type
operator|!=
name|_DRM_REGISTERS
operator|&&
name|type
operator|!=
name|_DRM_FRAME_BUFFER
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
name|EINVAL
return|;
name|map
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|map
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|map
operator|->
name|rid
operator|=
name|resource
operator|*
literal|4
operator|+
literal|0x10
expr_stmt|;
name|bsr
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|map
operator|->
name|rid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsr
operator|==
name|NULL
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Couldn't allocate %s resource\n"
argument_list|,
operator|(
operator|(
name|type
operator|==
name|_DRM_REGISTERS
operator|)
condition|?
literal|"mmio"
else|:
literal|"framebuffer"
operator|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|map
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|map
operator|->
name|kernel_owned
operator|=
literal|1
expr_stmt|;
name|map
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|map
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|map
operator|->
name|bsr
operator|=
name|bsr
expr_stmt|;
name|map
operator|->
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|bsr
argument_list|)
expr_stmt|;
name|map
operator|->
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|bsr
argument_list|)
expr_stmt|;
name|map
operator|->
name|offset
operator|=
name|start
expr_stmt|;
name|map
operator|->
name|size
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|_DRM_REGISTERS
condition|)
name|map
operator|->
name|handle
operator|=
name|rman_get_virtual
argument_list|(
name|bsr
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"initmap %d,0x%x@0x%lx/0x%lx\n"
argument_list|,
name|map
operator|->
name|type
argument_list|,
name|map
operator|->
name|flags
argument_list|,
name|map
operator|->
name|offset
argument_list|,
name|map
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|->
name|flags
operator|&
name|_DRM_WRITE_COMBINING
condition|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|drm_mtrr_add
argument_list|(
name|map
operator|->
name|offset
argument_list|,
name|map
operator|->
name|size
argument_list|,
name|DRM_MTRR_WC
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
name|map
operator|->
name|mtrr
operator|=
literal|1
expr_stmt|;
block|}
name|DRM_LOCK
argument_list|()
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|dev
operator|->
name|maplist
argument_list|,
name|map
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|drm_addmap
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_map_t
name|request
decl_stmt|;
name|drm_local_map_t
modifier|*
name|map
decl_stmt|;
name|dma_addr_t
name|bus_addr
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|dev
operator|->
name|flags
operator|&
operator|(
name|FREAD
operator||
name|FWRITE
operator|)
operator|)
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EACCES
argument_list|)
return|;
comment|/* Require read/write */
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|request
argument_list|,
operator|(
name|drm_map_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|drm_map_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Only allow shared memory to be removable since we only keep enough 	 * book keeping information about shared memory to allow for removal 	 * when processes fork. 	 */
if|if
condition|(
operator|(
name|request
operator|.
name|flags
operator|&
name|_DRM_REMOVABLE
operator|)
operator|&&
name|request
operator|.
name|type
operator|!=
name|_DRM_SHM
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|request
operator|.
name|offset
operator|&
name|PAGE_MASK
operator|)
operator|||
operator|(
name|request
operator|.
name|size
operator|&
name|PAGE_MASK
operator|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|request
operator|.
name|offset
operator|+
name|request
operator|.
name|size
operator|<
name|request
operator|.
name|offset
condition|)
return|return
name|EINVAL
return|;
name|DRM_DEBUG
argument_list|(
literal|"offset = 0x%08lx, size = 0x%08lx, type = %d\n"
argument_list|,
name|request
operator|.
name|offset
argument_list|,
name|request
operator|.
name|size
argument_list|,
name|request
operator|.
name|type
argument_list|)
expr_stmt|;
comment|/* Check if this is just another version of a kernel-allocated map, and 	 * just hand that back if so. 	 */
if|if
condition|(
name|request
operator|.
name|type
operator|==
name|_DRM_REGISTERS
operator|||
name|request
operator|.
name|type
operator|==
name|_DRM_FRAME_BUFFER
condition|)
block|{
name|DRM_LOCK
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|map
argument_list|,
argument|&dev->maplist
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|map
operator|->
name|kernel_owned
operator|&&
name|map
operator|->
name|type
operator|==
name|request
operator|.
name|type
operator|&&
name|map
operator|->
name|offset
operator|==
name|request
operator|.
name|offset
condition|)
block|{
comment|/* XXX: this size setting is questionable. */
name|map
operator|->
name|size
operator|=
name|request
operator|.
name|size
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Found kernel map %d\n"
argument_list|,
name|request
operator|.
name|type
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|DRM_UNLOCK
argument_list|()
expr_stmt|;
block|}
comment|/* Allocate a new map structure, fill it in, and do any type-specific 	 * initialization necessary. 	 */
name|map
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|map
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|map
condition|)
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|map
operator|->
name|offset
operator|=
name|request
operator|.
name|offset
expr_stmt|;
name|map
operator|->
name|size
operator|=
name|request
operator|.
name|size
expr_stmt|;
name|map
operator|->
name|type
operator|=
name|request
operator|.
name|type
expr_stmt|;
name|map
operator|->
name|flags
operator|=
name|request
operator|.
name|flags
expr_stmt|;
switch|switch
condition|(
name|map
operator|->
name|type
condition|)
block|{
case|case
name|_DRM_REGISTERS
case|:
name|drm_ioremap
argument_list|(
name|dev
argument_list|,
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|map
operator|->
name|flags
operator|&
name|_DRM_WRITE_COMBINING
operator|)
condition|)
break|break;
comment|/* FALLTHROUGH */
case|case
name|_DRM_FRAME_BUFFER
case|:
if|if
condition|(
name|drm_mtrr_add
argument_list|(
name|map
operator|->
name|offset
argument_list|,
name|map
operator|->
name|size
argument_list|,
name|DRM_MTRR_WC
argument_list|)
operator|==
literal|0
condition|)
name|map
operator|->
name|mtrr
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|_DRM_SHM
case|:
name|map
operator|->
name|handle
operator|=
name|malloc
argument_list|(
name|map
operator|->
name|size
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%lu %d %p\n"
argument_list|,
name|map
operator|->
name|size
argument_list|,
name|drm_order
argument_list|(
name|map
operator|->
name|size
argument_list|)
argument_list|,
name|map
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|map
operator|->
name|handle
condition|)
block|{
name|free
argument_list|(
name|map
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|map
operator|->
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
name|map
operator|->
name|handle
expr_stmt|;
if|if
condition|(
name|map
operator|->
name|flags
operator|&
name|_DRM_CONTAINS_LOCK
condition|)
block|{
comment|/* Prevent a 2nd X Server from creating a 2nd lock */
name|DRM_LOCK
argument_list|()
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|lock
operator|.
name|hw_lock
operator|!=
name|NULL
condition|)
block|{
name|DRM_UNLOCK
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|map
operator|->
name|handle
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|map
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EBUSY
argument_list|)
return|;
block|}
name|dev
operator|->
name|lock
operator|.
name|hw_lock
operator|=
name|map
operator|->
name|handle
expr_stmt|;
comment|/* Pointer to lock */
name|DRM_UNLOCK
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|_DRM_AGP
case|:
name|map
operator|->
name|offset
operator|+=
name|dev
operator|->
name|agp
operator|->
name|base
expr_stmt|;
name|map
operator|->
name|mtrr
operator|=
name|dev
operator|->
name|agp
operator|->
name|mtrr
expr_stmt|;
comment|/* for getmap */
break|break;
case|case
name|_DRM_SCATTER_GATHER
case|:
if|if
condition|(
operator|!
name|dev
operator|->
name|sg
condition|)
block|{
name|free
argument_list|(
name|map
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|map
operator|->
name|offset
operator|=
name|map
operator|->
name|offset
operator|+
name|dev
operator|->
name|sg
operator|->
name|handle
expr_stmt|;
break|break;
case|case
name|_DRM_CONSISTENT
case|:
name|map
operator|->
name|handle
operator|=
name|drm_pci_alloc
argument_list|(
name|dev
argument_list|,
name|map
operator|->
name|size
argument_list|,
name|map
operator|->
name|size
argument_list|,
literal|0xfffffffful
argument_list|,
operator|&
name|bus_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|->
name|handle
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|map
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|map
operator|->
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
name|bus_addr
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|map
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_LOCK
argument_list|()
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|dev
operator|->
name|maplist
argument_list|,
name|map
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|done
label|:
comment|/* Jumped to, with lock held, when a kernel map is found. */
name|request
operator|.
name|offset
operator|=
name|map
operator|->
name|offset
expr_stmt|;
name|request
operator|.
name|size
operator|=
name|map
operator|->
name|size
expr_stmt|;
name|request
operator|.
name|type
operator|=
name|map
operator|->
name|type
expr_stmt|;
name|request
operator|.
name|flags
operator|=
name|map
operator|->
name|flags
expr_stmt|;
name|request
operator|.
name|mtrr
operator|=
name|map
operator|->
name|mtrr
expr_stmt|;
name|request
operator|.
name|handle
operator|=
name|map
operator|->
name|handle
expr_stmt|;
name|DRM_UNLOCK
argument_list|()
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"Added map %d 0x%lx/0x%lx\n"
argument_list|,
name|request
operator|.
name|type
argument_list|,
name|request
operator|.
name|offset
argument_list|,
name|request
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|type
operator|!=
name|_DRM_SHM
condition|)
block|{
name|request
operator|.
name|handle
operator|=
operator|(
name|void
operator|*
operator|)
name|request
operator|.
name|offset
expr_stmt|;
block|}
name|DRM_COPY_TO_USER_IOCTL
argument_list|(
operator|(
name|drm_map_t
operator|*
operator|)
name|data
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
name|drm_map_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|drm_remove_map
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_local_map_t
modifier|*
name|map
parameter_list|)
block|{
name|DRM_SPINLOCK_ASSERT
argument_list|(
operator|&
name|dev
operator|->
name|dev_lock
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|dev
operator|->
name|maplist
argument_list|,
name|map
argument_list|,
name|link
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|map
operator|->
name|type
condition|)
block|{
case|case
name|_DRM_REGISTERS
case|:
if|if
condition|(
name|map
operator|->
name|bsr
operator|==
name|NULL
condition|)
name|drm_ioremapfree
argument_list|(
name|map
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|_DRM_FRAME_BUFFER
case|:
if|if
condition|(
name|map
operator|->
name|mtrr
condition|)
block|{
name|int
name|__unused
name|retcode
decl_stmt|;
name|retcode
operator|=
name|drm_mtrr_del
argument_list|(
name|map
operator|->
name|offset
argument_list|,
name|map
operator|->
name|size
argument_list|,
name|DRM_MTRR_WC
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"mtrr_del = %d\n"
argument_list|,
name|retcode
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|_DRM_SHM
case|:
name|free
argument_list|(
name|map
operator|->
name|handle
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
break|break;
case|case
name|_DRM_AGP
case|:
case|case
name|_DRM_SCATTER_GATHER
case|:
break|break;
case|case
name|_DRM_CONSISTENT
case|:
name|drm_pci_free
argument_list|(
name|dev
argument_list|,
name|map
operator|->
name|size
argument_list|,
name|map
operator|->
name|handle
argument_list|,
name|map
operator|->
name|offset
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|map
operator|->
name|bsr
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
operator|->
name|device
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|map
operator|->
name|rid
argument_list|,
name|map
operator|->
name|bsr
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|map
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Remove a map private from list and deallocate resources if the mapping  * isn't in use.  */
end_comment

begin_function
name|int
name|drm_rmmap
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_local_map_t
modifier|*
name|map
decl_stmt|;
name|drm_map_t
name|request
decl_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|request
argument_list|,
operator|(
name|drm_map_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_LOCK
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|map
argument_list|,
argument|&dev->maplist
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|map
operator|->
name|handle
operator|==
name|request
operator|.
name|handle
operator|&&
name|map
operator|->
name|flags
operator|&
name|_DRM_REMOVABLE
condition|)
break|break;
block|}
comment|/* No match found. */
if|if
condition|(
name|map
operator|==
name|NULL
condition|)
block|{
name|DRM_UNLOCK
argument_list|()
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|drm_remove_map
argument_list|(
name|dev
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|DRM_UNLOCK
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|drm_cleanup_buf_error
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_entry_t
modifier|*
name|entry
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|entry
operator|->
name|seg_count
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|->
name|seg_count
condition|;
name|i
operator|++
control|)
block|{
name|drm_pci_free
argument_list|(
name|dev
argument_list|,
name|entry
operator|->
name|buf_size
argument_list|,
operator|(
name|void
operator|*
operator|)
name|entry
operator|->
name|seglist
index|[
name|i
index|]
argument_list|,
name|entry
operator|->
name|seglist_bus
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|entry
operator|->
name|seglist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|entry
operator|->
name|seglist_bus
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
name|entry
operator|->
name|seg_count
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|buf_count
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|entry
operator|->
name|buflist
index|[
name|i
index|]
operator|.
name|dev_private
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|entry
operator|->
name|buflist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
name|entry
operator|->
name|buf_count
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|drm_addbufs_agp
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_desc_t
modifier|*
name|request
parameter_list|)
block|{
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_entry_t
modifier|*
name|entry
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|unsigned
name|long
name|agp_offset
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|order
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|alignment
decl_stmt|;
name|int
name|page_order
decl_stmt|;
name|int
name|total
decl_stmt|;
name|int
name|byte_count
decl_stmt|;
name|int
name|i
decl_stmt|;
name|drm_buf_t
modifier|*
modifier|*
name|temp_buflist
decl_stmt|;
name|count
operator|=
name|request
operator|->
name|count
expr_stmt|;
name|order
operator|=
name|drm_order
argument_list|(
name|request
operator|->
name|size
argument_list|)
expr_stmt|;
name|size
operator|=
literal|1
operator|<<
name|order
expr_stmt|;
name|alignment
operator|=
operator|(
name|request
operator|->
name|flags
operator|&
name|_DRM_PAGE_ALIGN
operator|)
condition|?
name|round_page
argument_list|(
name|size
argument_list|)
else|:
name|size
expr_stmt|;
name|page_order
operator|=
name|order
operator|-
name|PAGE_SHIFT
operator|>
literal|0
condition|?
name|order
operator|-
name|PAGE_SHIFT
else|:
literal|0
expr_stmt|;
name|total
operator|=
name|PAGE_SIZE
operator|<<
name|page_order
expr_stmt|;
name|byte_count
operator|=
literal|0
expr_stmt|;
name|agp_offset
operator|=
name|dev
operator|->
name|agp
operator|->
name|base
operator|+
name|request
operator|->
name|agp_start
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"count:      %d\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"order:      %d\n"
argument_list|,
name|order
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"size:       %d\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"agp_offset: 0x%lx\n"
argument_list|,
name|agp_offset
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"alignment:  %d\n"
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"page_order: %d\n"
argument_list|,
name|page_order
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"total:      %d\n"
argument_list|,
name|total
argument_list|)
expr_stmt|;
name|entry
operator|=
operator|&
name|dma
operator|->
name|bufs
index|[
name|order
index|]
expr_stmt|;
name|entry
operator|->
name|buflist
operator|=
name|malloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|entry
operator|->
name|buflist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|entry
operator|->
name|buflist
condition|)
block|{
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|entry
operator|->
name|buf_size
operator|=
name|size
expr_stmt|;
name|entry
operator|->
name|page_order
operator|=
name|page_order
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|entry
operator|->
name|buf_count
operator|<
name|count
condition|)
block|{
name|buf
operator|=
operator|&
name|entry
operator|->
name|buflist
index|[
name|entry
operator|->
name|buf_count
index|]
expr_stmt|;
name|buf
operator|->
name|idx
operator|=
name|dma
operator|->
name|buf_count
operator|+
name|entry
operator|->
name|buf_count
expr_stmt|;
name|buf
operator|->
name|total
operator|=
name|alignment
expr_stmt|;
name|buf
operator|->
name|order
operator|=
name|order
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|offset
operator|=
operator|(
name|dma
operator|->
name|byte_count
operator|+
name|offset
operator|)
expr_stmt|;
name|buf
operator|->
name|bus_address
operator|=
name|agp_offset
operator|+
name|offset
expr_stmt|;
name|buf
operator|->
name|address
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|agp_offset
operator|+
name|offset
operator|)
expr_stmt|;
name|buf
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|filp
operator|=
name|NULL
expr_stmt|;
name|buf
operator|->
name|dev_priv_size
operator|=
name|dev
operator|->
name|dev_priv_size
expr_stmt|;
name|buf
operator|->
name|dev_private
operator|=
name|malloc
argument_list|(
name|buf
operator|->
name|dev_priv_size
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|dev_private
operator|==
name|NULL
condition|)
block|{
comment|/* Set count correctly so we free the proper amount. */
name|entry
operator|->
name|buf_count
operator|=
name|count
expr_stmt|;
name|drm_cleanup_buf_error
argument_list|(
name|dev
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|offset
operator|+=
name|alignment
expr_stmt|;
name|entry
operator|->
name|buf_count
operator|++
expr_stmt|;
name|byte_count
operator|+=
name|PAGE_SIZE
operator|<<
name|page_order
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"byte_count: %d\n"
argument_list|,
name|byte_count
argument_list|)
expr_stmt|;
name|temp_buflist
operator|=
name|realloc
argument_list|(
name|dma
operator|->
name|buflist
argument_list|,
operator|(
name|dma
operator|->
name|buf_count
operator|+
name|entry
operator|->
name|buf_count
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|dma
operator|->
name|buflist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp_buflist
operator|==
name|NULL
condition|)
block|{
comment|/* Free the entry because it isn't valid */
name|drm_cleanup_buf_error
argument_list|(
name|dev
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|dma
operator|->
name|buflist
operator|=
name|temp_buflist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|dma
operator|->
name|buflist
index|[
name|i
operator|+
name|dma
operator|->
name|buf_count
index|]
operator|=
operator|&
name|entry
operator|->
name|buflist
index|[
name|i
index|]
expr_stmt|;
block|}
name|dma
operator|->
name|buf_count
operator|+=
name|entry
operator|->
name|buf_count
expr_stmt|;
name|dma
operator|->
name|byte_count
operator|+=
name|byte_count
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dma->buf_count : %d\n"
argument_list|,
name|dma
operator|->
name|buf_count
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"entry->buf_count : %d\n"
argument_list|,
name|entry
operator|->
name|buf_count
argument_list|)
expr_stmt|;
name|request
operator|->
name|count
operator|=
name|entry
operator|->
name|buf_count
expr_stmt|;
name|request
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|dma
operator|->
name|flags
operator|=
name|_DRM_DMA_USE_AGP
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|drm_addbufs_pci
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_desc_t
modifier|*
name|request
parameter_list|)
block|{
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|order
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|total
decl_stmt|;
name|int
name|page_order
decl_stmt|;
name|drm_buf_entry_t
modifier|*
name|entry
decl_stmt|;
name|vm_offset_t
name|vaddr
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|int
name|alignment
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|byte_count
decl_stmt|;
name|int
name|page_count
decl_stmt|;
name|unsigned
name|long
modifier|*
name|temp_pagelist
decl_stmt|;
name|drm_buf_t
modifier|*
modifier|*
name|temp_buflist
decl_stmt|;
name|dma_addr_t
name|bus_addr
decl_stmt|;
name|count
operator|=
name|request
operator|->
name|count
expr_stmt|;
name|order
operator|=
name|drm_order
argument_list|(
name|request
operator|->
name|size
argument_list|)
expr_stmt|;
name|size
operator|=
literal|1
operator|<<
name|order
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"count=%d, size=%d (%d), order=%d\n"
argument_list|,
name|request
operator|->
name|count
argument_list|,
name|request
operator|->
name|size
argument_list|,
name|size
argument_list|,
name|order
argument_list|)
expr_stmt|;
name|alignment
operator|=
operator|(
name|request
operator|->
name|flags
operator|&
name|_DRM_PAGE_ALIGN
operator|)
condition|?
name|round_page
argument_list|(
name|size
argument_list|)
else|:
name|size
expr_stmt|;
name|page_order
operator|=
name|order
operator|-
name|PAGE_SHIFT
operator|>
literal|0
condition|?
name|order
operator|-
name|PAGE_SHIFT
else|:
literal|0
expr_stmt|;
name|total
operator|=
name|PAGE_SIZE
operator|<<
name|page_order
expr_stmt|;
name|entry
operator|=
operator|&
name|dma
operator|->
name|bufs
index|[
name|order
index|]
expr_stmt|;
name|entry
operator|->
name|buflist
operator|=
name|malloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|entry
operator|->
name|buflist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|entry
operator|->
name|seglist
operator|=
name|malloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|entry
operator|->
name|seglist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|entry
operator|->
name|seglist_bus
operator|=
name|malloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|entry
operator|->
name|seglist_bus
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
comment|/* Keep the original pagelist until we know all the allocations 	 * have succeeded 	 */
name|temp_pagelist
operator|=
name|malloc
argument_list|(
operator|(
name|dma
operator|->
name|page_count
operator|+
operator|(
name|count
operator|<<
name|page_order
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|dma
operator|->
name|pagelist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|buflist
operator|==
name|NULL
operator|||
name|entry
operator|->
name|seglist
operator|==
name|NULL
operator|||
name|entry
operator|->
name|seglist_bus
operator|==
name|NULL
operator|||
name|temp_pagelist
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|entry
operator|->
name|buflist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|entry
operator|->
name|seglist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|entry
operator|->
name|seglist_bus
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|memcpy
argument_list|(
name|temp_pagelist
argument_list|,
name|dma
operator|->
name|pagelist
argument_list|,
name|dma
operator|->
name|page_count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|dma
operator|->
name|pagelist
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"pagelist: %d entries\n"
argument_list|,
name|dma
operator|->
name|page_count
operator|+
operator|(
name|count
operator|<<
name|page_order
operator|)
argument_list|)
expr_stmt|;
name|entry
operator|->
name|buf_size
operator|=
name|size
expr_stmt|;
name|entry
operator|->
name|page_order
operator|=
name|page_order
expr_stmt|;
name|byte_count
operator|=
literal|0
expr_stmt|;
name|page_count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|entry
operator|->
name|buf_count
operator|<
name|count
condition|)
block|{
name|vaddr
operator|=
operator|(
name|vm_offset_t
operator|)
name|drm_pci_alloc
argument_list|(
name|dev
argument_list|,
name|size
argument_list|,
name|alignment
argument_list|,
literal|0xfffffffful
argument_list|,
operator|&
name|bus_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|vaddr
operator|==
literal|0
condition|)
block|{
comment|/* Set count correctly so we free the proper amount. */
name|entry
operator|->
name|buf_count
operator|=
name|count
expr_stmt|;
name|entry
operator|->
name|seg_count
operator|=
name|count
expr_stmt|;
name|drm_cleanup_buf_error
argument_list|(
name|dev
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|temp_pagelist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|entry
operator|->
name|seglist_bus
index|[
name|entry
operator|->
name|seg_count
index|]
operator|=
name|bus_addr
expr_stmt|;
name|entry
operator|->
name|seglist
index|[
name|entry
operator|->
name|seg_count
operator|++
index|]
operator|=
name|vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
literal|1
operator|<<
name|page_order
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|DRM_DEBUG
argument_list|(
literal|"page %d @ 0x%08lx\n"
argument_list|,
name|dma
operator|->
name|page_count
operator|+
name|page_count
argument_list|,
operator|(
name|long
operator|)
name|vaddr
operator|+
name|PAGE_SIZE
operator|*
name|i
argument_list|)
expr_stmt|;
name|temp_pagelist
index|[
name|dma
operator|->
name|page_count
operator|+
name|page_count
operator|++
index|]
operator|=
name|vaddr
operator|+
name|PAGE_SIZE
operator|*
name|i
expr_stmt|;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|+
name|size
operator|<=
name|total
operator|&&
name|entry
operator|->
name|buf_count
operator|<
name|count
condition|;
name|offset
operator|+=
name|alignment
operator|,
operator|++
name|entry
operator|->
name|buf_count
control|)
block|{
name|buf
operator|=
operator|&
name|entry
operator|->
name|buflist
index|[
name|entry
operator|->
name|buf_count
index|]
expr_stmt|;
name|buf
operator|->
name|idx
operator|=
name|dma
operator|->
name|buf_count
operator|+
name|entry
operator|->
name|buf_count
expr_stmt|;
name|buf
operator|->
name|total
operator|=
name|alignment
expr_stmt|;
name|buf
operator|->
name|order
operator|=
name|order
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|offset
operator|=
operator|(
name|dma
operator|->
name|byte_count
operator|+
name|byte_count
operator|+
name|offset
operator|)
expr_stmt|;
name|buf
operator|->
name|address
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|vaddr
operator|+
name|offset
operator|)
expr_stmt|;
name|buf
operator|->
name|bus_address
operator|=
name|bus_addr
operator|+
name|offset
expr_stmt|;
name|buf
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|filp
operator|=
name|NULL
expr_stmt|;
name|buf
operator|->
name|dev_priv_size
operator|=
name|dev
operator|->
name|dev_priv_size
expr_stmt|;
name|buf
operator|->
name|dev_private
operator|=
name|malloc
argument_list|(
name|buf
operator|->
name|dev_priv_size
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|dev_private
operator|==
name|NULL
condition|)
block|{
comment|/* Set count correctly so we free the proper amount. */
name|entry
operator|->
name|buf_count
operator|=
name|count
expr_stmt|;
name|entry
operator|->
name|seg_count
operator|=
name|count
expr_stmt|;
name|drm_cleanup_buf_error
argument_list|(
name|dev
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|temp_pagelist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"buffer %d @ %p\n"
argument_list|,
name|entry
operator|->
name|buf_count
argument_list|,
name|buf
operator|->
name|address
argument_list|)
expr_stmt|;
block|}
name|byte_count
operator|+=
name|PAGE_SIZE
operator|<<
name|page_order
expr_stmt|;
block|}
name|temp_buflist
operator|=
name|realloc
argument_list|(
name|dma
operator|->
name|buflist
argument_list|,
operator|(
name|dma
operator|->
name|buf_count
operator|+
name|entry
operator|->
name|buf_count
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|dma
operator|->
name|buflist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp_buflist
operator|==
name|NULL
condition|)
block|{
comment|/* Free the entry because it isn't valid */
name|drm_cleanup_buf_error
argument_list|(
name|dev
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|temp_pagelist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|dma
operator|->
name|buflist
operator|=
name|temp_buflist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|dma
operator|->
name|buflist
index|[
name|i
operator|+
name|dma
operator|->
name|buf_count
index|]
operator|=
operator|&
name|entry
operator|->
name|buflist
index|[
name|i
index|]
expr_stmt|;
block|}
comment|/* No allocations failed, so now we can replace the orginal pagelist 	 * with the new one. 	 */
name|free
argument_list|(
name|dma
operator|->
name|pagelist
argument_list|,
name|M_DRM
argument_list|)
expr_stmt|;
name|dma
operator|->
name|pagelist
operator|=
name|temp_pagelist
expr_stmt|;
name|dma
operator|->
name|buf_count
operator|+=
name|entry
operator|->
name|buf_count
expr_stmt|;
name|dma
operator|->
name|seg_count
operator|+=
name|entry
operator|->
name|seg_count
expr_stmt|;
name|dma
operator|->
name|page_count
operator|+=
name|entry
operator|->
name|seg_count
operator|<<
name|page_order
expr_stmt|;
name|dma
operator|->
name|byte_count
operator|+=
name|PAGE_SIZE
operator|*
operator|(
name|entry
operator|->
name|seg_count
operator|<<
name|page_order
operator|)
expr_stmt|;
name|request
operator|->
name|count
operator|=
name|entry
operator|->
name|buf_count
expr_stmt|;
name|request
operator|->
name|size
operator|=
name|size
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|drm_addbufs_sg
parameter_list|(
name|drm_device_t
modifier|*
name|dev
parameter_list|,
name|drm_buf_desc_t
modifier|*
name|request
parameter_list|)
block|{
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_entry_t
modifier|*
name|entry
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|unsigned
name|long
name|offset
decl_stmt|;
name|unsigned
name|long
name|agp_offset
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|order
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|alignment
decl_stmt|;
name|int
name|page_order
decl_stmt|;
name|int
name|total
decl_stmt|;
name|int
name|byte_count
decl_stmt|;
name|int
name|i
decl_stmt|;
name|drm_buf_t
modifier|*
modifier|*
name|temp_buflist
decl_stmt|;
name|count
operator|=
name|request
operator|->
name|count
expr_stmt|;
name|order
operator|=
name|drm_order
argument_list|(
name|request
operator|->
name|size
argument_list|)
expr_stmt|;
name|size
operator|=
literal|1
operator|<<
name|order
expr_stmt|;
name|alignment
operator|=
operator|(
name|request
operator|->
name|flags
operator|&
name|_DRM_PAGE_ALIGN
operator|)
condition|?
name|round_page
argument_list|(
name|size
argument_list|)
else|:
name|size
expr_stmt|;
name|page_order
operator|=
name|order
operator|-
name|PAGE_SHIFT
operator|>
literal|0
condition|?
name|order
operator|-
name|PAGE_SHIFT
else|:
literal|0
expr_stmt|;
name|total
operator|=
name|PAGE_SIZE
operator|<<
name|page_order
expr_stmt|;
name|byte_count
operator|=
literal|0
expr_stmt|;
name|agp_offset
operator|=
name|request
operator|->
name|agp_start
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"count:      %d\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"order:      %d\n"
argument_list|,
name|order
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"size:       %d\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"agp_offset: %ld\n"
argument_list|,
name|agp_offset
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"alignment:  %d\n"
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"page_order: %d\n"
argument_list|,
name|page_order
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"total:      %d\n"
argument_list|,
name|total
argument_list|)
expr_stmt|;
name|entry
operator|=
operator|&
name|dma
operator|->
name|bufs
index|[
name|order
index|]
expr_stmt|;
name|entry
operator|->
name|buflist
operator|=
name|malloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|entry
operator|->
name|buflist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|buflist
operator|==
name|NULL
condition|)
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
name|entry
operator|->
name|buf_size
operator|=
name|size
expr_stmt|;
name|entry
operator|->
name|page_order
operator|=
name|page_order
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|entry
operator|->
name|buf_count
operator|<
name|count
condition|)
block|{
name|buf
operator|=
operator|&
name|entry
operator|->
name|buflist
index|[
name|entry
operator|->
name|buf_count
index|]
expr_stmt|;
name|buf
operator|->
name|idx
operator|=
name|dma
operator|->
name|buf_count
operator|+
name|entry
operator|->
name|buf_count
expr_stmt|;
name|buf
operator|->
name|total
operator|=
name|alignment
expr_stmt|;
name|buf
operator|->
name|order
operator|=
name|order
expr_stmt|;
name|buf
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|offset
operator|=
operator|(
name|dma
operator|->
name|byte_count
operator|+
name|offset
operator|)
expr_stmt|;
name|buf
operator|->
name|bus_address
operator|=
name|agp_offset
operator|+
name|offset
expr_stmt|;
name|buf
operator|->
name|address
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|agp_offset
operator|+
name|offset
operator|+
name|dev
operator|->
name|sg
operator|->
name|handle
operator|)
expr_stmt|;
name|buf
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|buf
operator|->
name|pending
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|filp
operator|=
name|NULL
expr_stmt|;
name|buf
operator|->
name|dev_priv_size
operator|=
name|dev
operator|->
name|dev_priv_size
expr_stmt|;
name|buf
operator|->
name|dev_private
operator|=
name|malloc
argument_list|(
name|buf
operator|->
name|dev_priv_size
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|dev_private
operator|==
name|NULL
condition|)
block|{
comment|/* Set count correctly so we free the proper amount. */
name|entry
operator|->
name|buf_count
operator|=
name|count
expr_stmt|;
name|drm_cleanup_buf_error
argument_list|(
name|dev
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"buffer %d @ %p\n"
argument_list|,
name|entry
operator|->
name|buf_count
argument_list|,
name|buf
operator|->
name|address
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|alignment
expr_stmt|;
name|entry
operator|->
name|buf_count
operator|++
expr_stmt|;
name|byte_count
operator|+=
name|PAGE_SIZE
operator|<<
name|page_order
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"byte_count: %d\n"
argument_list|,
name|byte_count
argument_list|)
expr_stmt|;
name|temp_buflist
operator|=
name|realloc
argument_list|(
name|dma
operator|->
name|buflist
argument_list|,
operator|(
name|dma
operator|->
name|buf_count
operator|+
name|entry
operator|->
name|buf_count
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|dma
operator|->
name|buflist
argument_list|)
argument_list|,
name|M_DRM
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp_buflist
operator|==
name|NULL
condition|)
block|{
comment|/* Free the entry because it isn't valid */
name|drm_cleanup_buf_error
argument_list|(
name|dev
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
name|dma
operator|->
name|buflist
operator|=
name|temp_buflist
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
name|dma
operator|->
name|buflist
index|[
name|i
operator|+
name|dma
operator|->
name|buf_count
index|]
operator|=
operator|&
name|entry
operator|->
name|buflist
index|[
name|i
index|]
expr_stmt|;
block|}
name|dma
operator|->
name|buf_count
operator|+=
name|entry
operator|->
name|buf_count
expr_stmt|;
name|dma
operator|->
name|byte_count
operator|+=
name|byte_count
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"dma->buf_count : %d\n"
argument_list|,
name|dma
operator|->
name|buf_count
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"entry->buf_count : %d\n"
argument_list|,
name|entry
operator|->
name|buf_count
argument_list|)
expr_stmt|;
name|request
operator|->
name|count
operator|=
name|entry
operator|->
name|buf_count
expr_stmt|;
name|request
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|dma
operator|->
name|flags
operator|=
name|_DRM_DMA_USE_SG
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|drm_addbufs
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_buf_desc_t
name|request
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|order
decl_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|request
argument_list|,
operator|(
name|drm_buf_desc_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|count
operator|<
literal|0
operator|||
name|request
operator|.
name|count
operator|>
literal|4096
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|order
operator|=
name|drm_order
argument_list|(
name|request
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|order
operator|<
name|DRM_MIN_ORDER
operator|||
name|order
operator|>
name|DRM_MAX_ORDER
condition|)
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
name|DRM_SPINLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
comment|/* No more allocations after first buffer-using ioctl. */
if|if
condition|(
name|dev
operator|->
name|buf_use
operator|!=
literal|0
condition|)
block|{
name|DRM_SPINUNLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|EBUSY
argument_list|)
return|;
block|}
comment|/* No more than one allocation per order */
if|if
condition|(
name|dev
operator|->
name|dma
operator|->
name|bufs
index|[
name|order
index|]
operator|.
name|buf_count
operator|!=
literal|0
condition|)
block|{
name|DRM_SPINUNLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|ENOMEM
argument_list|)
return|;
block|}
if|if
condition|(
name|request
operator|.
name|flags
operator|&
name|_DRM_AGP_BUFFER
condition|)
name|err
operator|=
name|drm_addbufs_agp
argument_list|(
name|dev
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|request
operator|.
name|flags
operator|&
name|_DRM_SG_BUFFER
condition|)
name|err
operator|=
name|drm_addbufs_sg
argument_list|(
name|dev
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|drm_addbufs_pci
argument_list|(
name|dev
argument_list|,
operator|&
name|request
argument_list|)
expr_stmt|;
name|DRM_SPINUNLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
name|DRM_COPY_TO_USER_IOCTL
argument_list|(
operator|(
name|drm_buf_desc_t
operator|*
operator|)
name|data
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|drm_infobufs
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_info_t
name|request
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|retcode
init|=
literal|0
decl_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|request
argument_list|,
operator|(
name|drm_buf_info_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_SPINLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
operator|++
name|dev
operator|->
name|buf_use
expr_stmt|;
comment|/* Can't allocate more after this call */
name|DRM_SPINUNLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|count
operator|=
literal|0
init|;
name|i
operator|<
name|DRM_MAX_ORDER
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|buf_count
condition|)
operator|++
name|count
expr_stmt|;
block|}
name|DRM_DEBUG
argument_list|(
literal|"count = %d\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|count
operator|>=
name|count
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|count
operator|=
literal|0
init|;
name|i
operator|<
name|DRM_MAX_ORDER
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|buf_count
condition|)
block|{
name|drm_buf_desc_t
name|from
decl_stmt|;
name|from
operator|.
name|count
operator|=
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|buf_count
expr_stmt|;
name|from
operator|.
name|size
operator|=
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|buf_size
expr_stmt|;
name|from
operator|.
name|low_mark
operator|=
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|freelist
operator|.
name|low_mark
expr_stmt|;
name|from
operator|.
name|high_mark
operator|=
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|freelist
operator|.
name|high_mark
expr_stmt|;
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|request
operator|.
name|list
index|[
name|count
index|]
argument_list|,
operator|&
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|drm_buf_desc_t
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|retcode
operator|=
name|DRM_ERR
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
break|break;
block|}
name|DRM_DEBUG
argument_list|(
literal|"%d %d %d %d %d\n"
argument_list|,
name|i
argument_list|,
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|buf_count
argument_list|,
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|buf_size
argument_list|,
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|freelist
operator|.
name|low_mark
argument_list|,
name|dma
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|freelist
operator|.
name|high_mark
argument_list|)
expr_stmt|;
operator|++
name|count
expr_stmt|;
block|}
block|}
block|}
name|request
operator|.
name|count
operator|=
name|count
expr_stmt|;
name|DRM_COPY_TO_USER_IOCTL
argument_list|(
operator|(
name|drm_buf_info_t
operator|*
operator|)
name|data
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|retcode
return|;
block|}
end_function

begin_function
name|int
name|drm_markbufs
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_desc_t
name|request
decl_stmt|;
name|int
name|order
decl_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|request
argument_list|,
operator|(
name|drm_buf_desc_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%d, %d, %d\n"
argument_list|,
name|request
operator|.
name|size
argument_list|,
name|request
operator|.
name|low_mark
argument_list|,
name|request
operator|.
name|high_mark
argument_list|)
expr_stmt|;
name|order
operator|=
name|drm_order
argument_list|(
name|request
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|order
operator|<
name|DRM_MIN_ORDER
operator|||
name|order
operator|>
name|DRM_MAX_ORDER
operator|||
name|request
operator|.
name|low_mark
operator|<
literal|0
operator|||
name|request
operator|.
name|high_mark
operator|<
literal|0
condition|)
block|{
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|DRM_SPINLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|low_mark
operator|>
name|dma
operator|->
name|bufs
index|[
name|order
index|]
operator|.
name|buf_count
operator|||
name|request
operator|.
name|high_mark
operator|>
name|dma
operator|->
name|bufs
index|[
name|order
index|]
operator|.
name|buf_count
condition|)
block|{
return|return
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
return|;
block|}
name|dma
operator|->
name|bufs
index|[
name|order
index|]
operator|.
name|freelist
operator|.
name|low_mark
operator|=
name|request
operator|.
name|low_mark
expr_stmt|;
name|dma
operator|->
name|bufs
index|[
name|order
index|]
operator|.
name|freelist
operator|.
name|high_mark
operator|=
name|request
operator|.
name|high_mark
expr_stmt|;
name|DRM_SPINUNLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|drm_freebufs
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|drm_buf_free_t
name|request
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|drm_buf_t
modifier|*
name|buf
decl_stmt|;
name|int
name|retcode
init|=
literal|0
decl_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|request
argument_list|,
operator|(
name|drm_buf_free_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%d\n"
argument_list|,
name|request
operator|.
name|count
argument_list|)
expr_stmt|;
name|DRM_SPINLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|request
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|DRM_COPY_FROM_USER
argument_list|(
operator|&
name|idx
argument_list|,
operator|&
name|request
operator|.
name|list
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|idx
argument_list|)
argument_list|)
condition|)
block|{
name|retcode
operator|=
name|DRM_ERR
argument_list|(
name|EFAULT
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|idx
operator|<
literal|0
operator|||
name|idx
operator|>=
name|dma
operator|->
name|buf_count
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Index %d (of %d max)\n"
argument_list|,
name|idx
argument_list|,
name|dma
operator|->
name|buf_count
operator|-
literal|1
argument_list|)
expr_stmt|;
name|retcode
operator|=
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
break|break;
block|}
name|buf
operator|=
name|dma
operator|->
name|buflist
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|filp
operator|!=
name|filp
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Process %d freeing buffer not owned\n"
argument_list|,
name|DRM_CURRENTPID
argument_list|)
expr_stmt|;
name|retcode
operator|=
name|DRM_ERR
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
break|break;
block|}
name|drm_free_buffer
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|DRM_SPINUNLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
return|return
name|retcode
return|;
block|}
end_function

begin_function
name|int
name|drm_mapbufs
parameter_list|(
name|DRM_IOCTL_ARGS
parameter_list|)
block|{
name|DRM_DEVICE
expr_stmt|;
name|drm_device_dma_t
modifier|*
name|dma
init|=
name|dev
operator|->
name|dma
decl_stmt|;
name|int
name|retcode
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|zero
init|=
literal|0
decl_stmt|;
name|vm_offset_t
name|address
decl_stmt|;
name|struct
name|vmspace
modifier|*
name|vms
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|vm_ooffset_t
name|foff
decl_stmt|;
name|vm_size_t
name|size
decl_stmt|;
name|vm_offset_t
name|vaddr
decl_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
name|struct
name|vnode
modifier|*
name|vn
decl_stmt|;
name|vm_size_t
name|size
decl_stmt|;
name|vaddr_t
name|vaddr
decl_stmt|;
endif|#
directive|endif
comment|/* __NetBSD__ || __OpenBSD__ */
name|drm_buf_map_t
name|request
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DRM_COPY_FROM_USER_IOCTL
argument_list|(
name|request
argument_list|,
operator|(
name|drm_buf_map_t
operator|*
operator|)
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
if|if
condition|(
operator|!
name|vfinddev
argument_list|(
name|kdev
argument_list|,
name|VCHR
argument_list|,
operator|&
name|vn
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* FIXME: Shouldn't this be EINVAL or something? */
endif|#
directive|endif
comment|/* __NetBSD__ || __OpenBSD */
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>=
literal|500000
name|vms
operator|=
name|p
operator|->
name|td_proc
operator|->
name|p_vmspace
expr_stmt|;
else|#
directive|else
name|vms
operator|=
name|p
operator|->
name|p_vmspace
expr_stmt|;
endif|#
directive|endif
name|DRM_SPINLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|buf_use
operator|++
expr_stmt|;
comment|/* Can't allocate more after this call */
name|DRM_SPINUNLOCK
argument_list|(
operator|&
name|dev
operator|->
name|dma_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|count
operator|<
name|dma
operator|->
name|buf_count
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
operator|(
name|dev
operator|->
name|use_agp
operator|&&
operator|(
name|dma
operator|->
name|flags
operator|&
name|_DRM_DMA_USE_AGP
operator|)
operator|)
operator|||
operator|(
name|dev
operator|->
name|use_sg
operator|&&
operator|(
name|dma
operator|->
name|flags
operator|&
name|_DRM_DMA_USE_SG
operator|)
operator|)
condition|)
block|{
name|drm_local_map_t
modifier|*
name|map
init|=
name|dev
operator|->
name|agp_buffer_map
decl_stmt|;
if|if
condition|(
name|map
operator|==
name|NULL
condition|)
block|{
name|retcode
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|size
operator|=
name|round_page
argument_list|(
name|map
operator|->
name|size
argument_list|)
expr_stmt|;
name|foff
operator|=
name|map
operator|->
name|offset
expr_stmt|;
block|}
else|else
block|{
name|size
operator|=
name|round_page
argument_list|(
name|dma
operator|->
name|byte_count
argument_list|)
operator|,
name|foff
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
name|vaddr
operator|=
name|round_page
argument_list|(
operator|(
name|vm_offset_t
operator|)
name|vms
operator|->
name|vm_daddr
operator|+
name|MAXDSIZ
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|600023
name|retcode
operator|=
name|vm_mmap
argument_list|(
operator|&
name|vms
operator|->
name|vm_map
argument_list|,
operator|&
name|vaddr
argument_list|,
name|size
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|VM_PROT_ALL
argument_list|,
name|MAP_SHARED
argument_list|,
name|OBJT_DEVICE
argument_list|,
name|kdev
argument_list|,
name|foff
argument_list|)
expr_stmt|;
else|#
directive|else
name|retcode
operator|=
name|vm_mmap
argument_list|(
operator|&
name|vms
operator|->
name|vm_map
argument_list|,
operator|&
name|vaddr
argument_list|,
name|size
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|VM_PROT_ALL
argument_list|,
name|MAP_SHARED
argument_list|,
name|SLIST_FIRST
argument_list|(
operator|&
name|kdev
operator|->
name|si_hlist
argument_list|)
argument_list|,
name|foff
argument_list|)
expr_stmt|;
endif|#
directive|endif
elif|#
directive|elif
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
name|vaddr
operator|=
name|round_page
argument_list|(
operator|(
name|vaddr_t
operator|)
name|vms
operator|->
name|vm_daddr
operator|+
name|MAXDSIZ
argument_list|)
expr_stmt|;
name|retcode
operator|=
name|uvm_mmap
argument_list|(
operator|&
name|vms
operator|->
name|vm_map
argument_list|,
operator|&
name|vaddr
argument_list|,
name|size
argument_list|,
name|UVM_PROT_READ
operator||
name|UVM_PROT_WRITE
argument_list|,
name|UVM_PROT_ALL
argument_list|,
name|MAP_SHARED
argument_list|,
operator|&
name|vn
operator|->
name|v_uobj
argument_list|,
name|foff
argument_list|,
name|p
operator|->
name|p_rlimit
index|[
name|RLIMIT_MEMLOCK
index|]
operator|.
name|rlim_cur
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __NetBSD__ || __OpenBSD */
if|if
condition|(
name|retcode
condition|)
goto|goto
name|done
goto|;
name|request
operator|.
name|virtual
operator|=
operator|(
name|void
operator|*
operator|)
name|vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dma
operator|->
name|buf_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|request
operator|.
name|list
index|[
name|i
index|]
operator|.
name|idx
argument_list|,
operator|&
name|dma
operator|->
name|buflist
index|[
name|i
index|]
operator|->
name|idx
argument_list|,
sizeof|sizeof
argument_list|(
name|request
operator|.
name|list
index|[
literal|0
index|]
operator|.
name|idx
argument_list|)
argument_list|)
condition|)
block|{
name|retcode
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|request
operator|.
name|list
index|[
name|i
index|]
operator|.
name|total
argument_list|,
operator|&
name|dma
operator|->
name|buflist
index|[
name|i
index|]
operator|->
name|total
argument_list|,
sizeof|sizeof
argument_list|(
name|request
operator|.
name|list
index|[
literal|0
index|]
operator|.
name|total
argument_list|)
argument_list|)
condition|)
block|{
name|retcode
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|request
operator|.
name|list
index|[
name|i
index|]
operator|.
name|used
argument_list|,
operator|&
name|zero
argument_list|,
sizeof|sizeof
argument_list|(
name|zero
argument_list|)
argument_list|)
condition|)
block|{
name|retcode
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|address
operator|=
name|vaddr
operator|+
name|dma
operator|->
name|buflist
index|[
name|i
index|]
operator|->
name|offset
expr_stmt|;
comment|/* *** */
if|if
condition|(
name|DRM_COPY_TO_USER
argument_list|(
operator|&
name|request
operator|.
name|list
index|[
name|i
index|]
operator|.
name|address
argument_list|,
operator|&
name|address
argument_list|,
sizeof|sizeof
argument_list|(
name|address
argument_list|)
argument_list|)
condition|)
block|{
name|retcode
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|done
label|:
name|request
operator|.
name|count
operator|=
name|dma
operator|->
name|buf_count
expr_stmt|;
name|DRM_DEBUG
argument_list|(
literal|"%d buffers, retcode = %d\n"
argument_list|,
name|request
operator|.
name|count
argument_list|,
name|retcode
argument_list|)
expr_stmt|;
name|DRM_COPY_TO_USER_IOCTL
argument_list|(
operator|(
name|drm_buf_map_t
operator|*
operator|)
name|data
argument_list|,
name|request
argument_list|,
sizeof|sizeof
argument_list|(
name|request
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|DRM_ERR
argument_list|(
name|retcode
argument_list|)
return|;
block|}
end_function

end_unit


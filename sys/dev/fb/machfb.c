begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002 Bang Jun-Young  * Copyright (c) 2005 Marius Strobl<marius@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  *	from: NetBSD: machfb.c,v 1.23 2005/03/07 21:45:24 martin Exp  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for ATI Mach64 graphics chips.  Some code is derived from the  * ATI Rage Pro and Derivatives Programmer's Guide.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_private.h>
end_include

begin_include
include|#
directive|include
file|<machine/ofw_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/sc_machdep.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/gfb.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/machfbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/syscons/syscons.h>
end_include

begin_comment
comment|/* #define MACHFB_DEBUG */
end_comment

begin_define
define|#
directive|define
name|MACHFB_DRIVER_NAME
value|"machfb"
end_define

begin_define
define|#
directive|define
name|MACH64_REG_OFF
value|0x7ffc00
end_define

begin_define
define|#
directive|define
name|MACH64_REG_SIZE
value|1024
end_define

begin_struct
struct|struct
name|machfb_softc
block|{
name|video_adapter_t
name|sc_va
decl_stmt|;
comment|/* must be first */
name|phandle_t
name|sc_node
decl_stmt|;
name|uint16_t
name|sc_chip_id
decl_stmt|;
name|uint8_t
name|sc_chip_rev
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_memres
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_vmemres
decl_stmt|;
name|bus_space_tag_t
name|sc_memt
decl_stmt|;
name|bus_space_tag_t
name|sc_regt
decl_stmt|;
name|bus_space_handle_t
name|sc_memh
decl_stmt|;
name|bus_space_handle_t
name|sc_regh
decl_stmt|;
name|u_long
name|sc_mem
decl_stmt|;
name|u_long
name|sc_vmem
decl_stmt|;
name|u_int
name|sc_height
decl_stmt|;
name|u_int
name|sc_width
decl_stmt|;
name|u_int
name|sc_depth
decl_stmt|;
name|u_int
name|sc_xmargin
decl_stmt|;
name|u_int
name|sc_ymargin
decl_stmt|;
name|size_t
name|sc_memsize
decl_stmt|;
name|u_int
name|sc_memtype
decl_stmt|;
name|u_int
name|sc_mem_freq
decl_stmt|;
name|u_int
name|sc_ramdac_freq
decl_stmt|;
name|u_int
name|sc_ref_freq
decl_stmt|;
name|u_int
name|sc_ref_div
decl_stmt|;
name|u_int
name|sc_mclk_post_div
decl_stmt|;
name|u_int
name|sc_mclk_fb_div
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|sc_font
decl_stmt|;
name|u_int
name|sc_cbwidth
decl_stmt|;
name|vm_offset_t
name|sc_curoff
decl_stmt|;
name|int
name|sc_bg_cache
decl_stmt|;
name|int
name|sc_fg_cache
decl_stmt|;
name|u_int
name|sc_draw_cache
decl_stmt|;
define|#
directive|define
name|MACHFB_DRAW_CHAR
value|(1<< 0)
define|#
directive|define
name|MACHFB_DRAW_FILLRECT
value|(1<< 1)
name|u_int
name|sc_flags
decl_stmt|;
define|#
directive|define
name|MACHFB_CONSOLE
value|(1<< 0)
define|#
directive|define
name|MACHFB_CUREN
value|(1<< 1)
define|#
directive|define
name|MACHFB_DSP
value|(1<< 2)
define|#
directive|define
name|MACHFB_SWAP
value|(1<< 3)
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|uint16_t
name|chip_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|uint32_t
name|ramdac_freq
decl_stmt|;
block|}
decl|const
name|machfb_info
index|[]
init|=
block|{
block|{
name|ATI_MACH64_CT
block|,
literal|"ATI Mach64 CT"
block|,
literal|135000
block|}
block|,
block|{
name|ATI_RAGE_PRO_AGP
block|,
literal|"ATI 3D Rage Pro (AGP)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_PRO_AGP1X
block|,
literal|"ATI 3D Rage Pro (AGP 1x)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_PRO_PCI_B
block|,
literal|"ATI 3D Rage Pro Turbo"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_XC_PCI66
block|,
literal|"ATI Rage XL (PCI66)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_XL_AGP
block|,
literal|"ATI Rage XL (AGP)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_XC_AGP
block|,
literal|"ATI Rage XC (AGP)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_XL_PCI66
block|,
literal|"ATI Rage XL (PCI66)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_PRO_PCI_P
block|,
literal|"ATI 3D Rage Pro"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_PRO_PCI_L
block|,
literal|"ATI 3D Rage Pro (limited 3D)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_XL_PCI
block|,
literal|"ATI Rage XL"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_XC_PCI
block|,
literal|"ATI Rage XC"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_II
block|,
literal|"ATI 3D Rage I/II"
block|,
literal|135000
block|}
block|,
block|{
name|ATI_RAGE_IIP
block|,
literal|"ATI 3D Rage II+"
block|,
literal|200000
block|}
block|,
block|{
name|ATI_RAGE_IIC_PCI
block|,
literal|"ATI 3D Rage IIC"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_IIC_AGP_B
block|,
literal|"ATI 3D Rage IIC (AGP)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_IIC_AGP_P
block|,
literal|"ATI 3D Rage IIC (AGP)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_LT_PRO_AGP
block|,
literal|"ATI 3D Rage LT Pro (AGP 133MHz)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_MOB_M3_PCI
block|,
literal|"ATI Rage Mobility M3"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_MOB_M3_AGP
block|,
literal|"ATI Rage Mobility M3 (AGP)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_LT
block|,
literal|"ATI 3D Rage LT"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_LT_PRO_PCI
block|,
literal|"ATI 3D Rage LT Pro"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_MOBILITY
block|,
literal|"ATI Rage Mobility"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_L_MOBILITY
block|,
literal|"ATI Rage L Mobility"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_LT_PRO
block|,
literal|"ATI 3D Rage LT Pro"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_LT_PRO2
block|,
literal|"ATI 3D Rage LT Pro"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_MOB_M1_PCI
block|,
literal|"ATI Rage Mobility M1 (PCI)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_RAGE_L_MOB_M1_PCI
block|,
literal|"ATI Rage L Mobility (PCI)"
block|,
literal|230000
block|}
block|,
block|{
name|ATI_MACH64_VT
block|,
literal|"ATI Mach64 VT"
block|,
literal|170000
block|}
block|,
block|{
name|ATI_MACH64_VTB
block|,
literal|"ATI Mach64 VTB"
block|,
literal|200000
block|}
block|,
block|{
name|ATI_MACH64_VT4
block|,
literal|"ATI Mach64 VT4"
block|,
literal|230000
block|}
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
name|machfb_cmap
block|{
name|uint8_t
name|red
decl_stmt|;
name|uint8_t
name|green
decl_stmt|;
name|uint8_t
name|blue
decl_stmt|;
block|}
decl|const
name|machfb_default_cmap
index|[
literal|16
index|]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* black */
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0xff
block|}
block|,
comment|/* blue */
block|{
literal|0x00
block|,
literal|0xff
block|,
literal|0x00
block|}
block|,
comment|/* green */
block|{
literal|0x00
block|,
literal|0xc0
block|,
literal|0xc0
block|}
block|,
comment|/* cyan */
block|{
literal|0xff
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* red */
block|{
literal|0xc0
block|,
literal|0x00
block|,
literal|0xc0
block|}
block|,
comment|/* magenta */
block|{
literal|0xc0
block|,
literal|0xc0
block|,
literal|0x00
block|}
block|,
comment|/* brown */
block|{
literal|0xc0
block|,
literal|0xc0
block|,
literal|0xc0
block|}
block|,
comment|/* light grey */
block|{
literal|0x80
block|,
literal|0x80
block|,
literal|0x80
block|}
block|,
comment|/* dark grey */
block|{
literal|0x80
block|,
literal|0x80
block|,
literal|0xff
block|}
block|,
comment|/* light blue */
block|{
literal|0x80
block|,
literal|0xff
block|,
literal|0x80
block|}
block|,
comment|/* light green */
block|{
literal|0x80
block|,
literal|0xff
block|,
literal|0xff
block|}
block|,
comment|/* light cyan */
block|{
literal|0xff
block|,
literal|0x80
block|,
literal|0x80
block|}
block|,
comment|/* light red */
block|{
literal|0xff
block|,
literal|0x80
block|,
literal|0xff
block|}
block|,
comment|/* light magenta */
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0x80
block|}
block|,
comment|/* yellow */
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
comment|/* white */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|MACHFB_CMAP_OFF
value|16
end_define

begin_decl_stmt
specifier|static
specifier|const
name|u_char
specifier|const
name|machfb_mouse_pointer_bits
index|[
literal|64
index|]
index|[
literal|8
index|]
init|=
block|{
block|{
literal|0x00
block|,
literal|0x00
block|, }
block|,
comment|/* ............ */
block|{
literal|0x80
block|,
literal|0x00
block|, }
block|,
comment|/* *........... */
block|{
literal|0xc0
block|,
literal|0x00
block|, }
block|,
comment|/* **.......... */
block|{
literal|0xe0
block|,
literal|0x00
block|, }
block|,
comment|/* ***......... */
block|{
literal|0xf0
block|,
literal|0x00
block|, }
block|,
comment|/* ****........ */
block|{
literal|0xf8
block|,
literal|0x00
block|, }
block|,
comment|/* *****....... */
block|{
literal|0xfc
block|,
literal|0x00
block|, }
block|,
comment|/* ******...... */
block|{
literal|0xfe
block|,
literal|0x00
block|, }
block|,
comment|/* *******..... */
block|{
literal|0xff
block|,
literal|0x00
block|, }
block|,
comment|/* ********.... */
block|{
literal|0xff
block|,
literal|0x80
block|, }
block|,
comment|/* *********... */
block|{
literal|0xfc
block|,
literal|0xc0
block|, }
block|,
comment|/* ******..**.. */
block|{
literal|0xdc
block|,
literal|0x00
block|, }
block|,
comment|/* **.***...... */
block|{
literal|0x8e
block|,
literal|0x00
block|, }
block|,
comment|/* *...***..... */
block|{
literal|0x0e
block|,
literal|0x00
block|, }
block|,
comment|/* ....***..... */
block|{
literal|0x07
block|,
literal|0x00
block|, }
block|,
comment|/* .....***.... */
block|{
literal|0x04
block|,
literal|0x00
block|, }
block|,
comment|/* .....*...... */
block|{
literal|0x00
block|,
literal|0x00
block|, }
block|,
comment|/* ............ */
block|{
literal|0x00
block|,
literal|0x00
block|, }
block|,
comment|/* ............ */
block|{
literal|0x00
block|,
literal|0x00
block|, }
block|,
comment|/* ............ */
block|{
literal|0x00
block|,
literal|0x00
block|, }
block|,
comment|/* ............ */
block|{
literal|0x00
block|,
literal|0x00
block|, }
block|,
comment|/* ............ */
block|{
literal|0x00
block|,
literal|0x00
block|, }
block|,
comment|/* ............ */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Lookup table to perform a bit-swap of the mouse pointer bits,  * map set bits to CUR_CLR0 and unset bits to transparent.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|u_char
specifier|const
name|machfb_mouse_pointer_lut
index|[]
init|=
block|{
literal|0xaa
block|,
literal|0x2a
block|,
literal|0x8a
block|,
literal|0x0a
block|,
literal|0xa2
block|,
literal|0x22
block|,
literal|0x82
block|,
literal|0x02
block|,
literal|0xa8
block|,
literal|0x28
block|,
literal|0x88
block|,
literal|0x08
block|,
literal|0xa0
block|,
literal|0x20
block|,
literal|0x80
block|,
literal|0x00
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|machfb_memtype_names
index|[]
init|=
block|{
literal|"(N/A)"
block|,
literal|"DRAM"
block|,
literal|"EDO DRAM"
block|,
literal|"EDO DRAM"
block|,
literal|"SDRAM"
block|,
literal|"SGRAM"
block|,
literal|"WRAM"
block|,
literal|"(unknown type)"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
specifier|const
name|struct
name|gfb_font
name|gallant12x22
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|machfb_softc
name|machfb_softc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|bus_space_tag
name|machfb_bst_store
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_probe_t
name|machfb_pci_probe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|machfb_pci_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_detach_t
name|machfb_pci_detach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|machfb_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|machfb_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|machfb_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|machfb_pci_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|machfb_pci_driver
init|=
block|{
name|MACHFB_DRIVER_NAME
block|,
name|machfb_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|machfb_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|machfb_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|machfb
argument_list|,
name|pci
argument_list|,
name|machfb_pci_driver
argument_list|,
name|machfb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|machfb
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|void
name|machfb_cursor_enable
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|machfb_cursor_install
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|machfb_get_memsize
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|machfb_reset_engine
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|machfb_init_engine
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void machfb_adjust_frame(struct machfb_softc *, int, int);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|machfb_shutdown_final
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|machfb_shutdown_reset
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|machfb_configure
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|vi_probe_t
name|machfb_probe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_init_t
name|machfb_init
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_get_info_t
name|machfb_get_info
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_query_mode_t
name|machfb_query_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_mode_t
name|machfb_set_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_font_t
name|machfb_save_font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_font_t
name|machfb_load_font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_show_font_t
name|machfb_show_font
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_palette_t
name|machfb_save_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_palette_t
name|machfb_load_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_border_t
name|machfb_set_border
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_state_t
name|machfb_save_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_state_t
name|machfb_load_state
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_win_org_t
name|machfb_set_win_org
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_read_hw_cursor_t
name|machfb_read_hw_cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_hw_cursor_t
name|machfb_set_hw_cursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_set_hw_cursor_shape_t
name|machfb_set_hw_cursor_shape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_blank_display_t
name|machfb_blank_display
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_mmap_t
name|machfb_mmap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_ioctl_t
name|machfb_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_clear_t
name|machfb_clear
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_fill_rect_t
name|machfb_fill_rect
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_bitblt_t
name|machfb_bitblt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_diag_t
name|machfb_diag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_save_cursor_palette_t
name|machfb_save_cursor_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_load_cursor_palette_t
name|machfb_load_cursor_palette
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_copy_t
name|machfb_copy
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_putp_t
name|machfb_putp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_putc_t
name|machfb_putc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_puts_t
name|machfb_puts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vi_putm_t
name|machfb_putm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|video_switch_t
name|machfbvidsw
init|=
block|{
operator|.
name|probe
operator|=
name|machfb_probe
block|,
operator|.
name|init
operator|=
name|machfb_init
block|,
operator|.
name|get_info
operator|=
name|machfb_get_info
block|,
operator|.
name|query_mode
operator|=
name|machfb_query_mode
block|,
operator|.
name|set_mode
operator|=
name|machfb_set_mode
block|,
operator|.
name|save_font
operator|=
name|machfb_save_font
block|,
operator|.
name|load_font
operator|=
name|machfb_load_font
block|,
operator|.
name|show_font
operator|=
name|machfb_show_font
block|,
operator|.
name|save_palette
operator|=
name|machfb_save_palette
block|,
operator|.
name|load_palette
operator|=
name|machfb_load_palette
block|,
operator|.
name|set_border
operator|=
name|machfb_set_border
block|,
operator|.
name|save_state
operator|=
name|machfb_save_state
block|,
operator|.
name|load_state
operator|=
name|machfb_load_state
block|,
operator|.
name|set_win_org
operator|=
name|machfb_set_win_org
block|,
operator|.
name|read_hw_cursor
operator|=
name|machfb_read_hw_cursor
block|,
operator|.
name|set_hw_cursor
operator|=
name|machfb_set_hw_cursor
block|,
operator|.
name|set_hw_cursor_shape
operator|=
name|machfb_set_hw_cursor_shape
block|,
operator|.
name|blank_display
operator|=
name|machfb_blank_display
block|,
operator|.
name|mmap
operator|=
name|machfb_mmap
block|,
operator|.
name|ioctl
operator|=
name|machfb_ioctl
block|,
operator|.
name|clear
operator|=
name|machfb_clear
block|,
operator|.
name|fill_rect
operator|=
name|machfb_fill_rect
block|,
operator|.
name|bitblt
operator|=
name|machfb_bitblt
block|,
operator|.
name|diag
operator|=
name|machfb_diag
block|,
operator|.
name|save_cursor_palette
operator|=
name|machfb_save_cursor_palette
block|,
operator|.
name|load_cursor_palette
operator|=
name|machfb_load_cursor_palette
block|,
operator|.
name|copy
operator|=
name|machfb_copy
block|,
operator|.
name|putp
operator|=
name|machfb_putp
block|,
operator|.
name|putc
operator|=
name|machfb_putc
block|,
operator|.
name|puts
operator|=
name|machfb_puts
block|,
operator|.
name|putm
operator|=
name|machfb_putm
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|VIDEO_DRIVER
argument_list|(
name|machfb
argument_list|,
name|machfbvidsw
argument_list|,
name|machfb_configure
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|extern
name|sc_rndr_sw_t
name|txtrndrsw
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|machfb
argument_list|,
literal|0
argument_list|,
name|txtrndrsw
argument_list|,
name|gfb_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RENDERER_MODULE
argument_list|(
name|machfb
argument_list|,
name|gfb_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Inline functions for getting access to register aperture.  */
end_comment

begin_function_decl
specifier|static
specifier|inline
name|uint32_t
name|regr
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|uint8_t
name|regrb
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|regw
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|regwb
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|regwb_pll
parameter_list|(
name|struct
name|machfb_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
specifier|inline
name|uint32_t
name|regr
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|index
parameter_list|)
block|{
return|return
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_regh
argument_list|,
name|index
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|uint8_t
name|regrb
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|index
parameter_list|)
block|{
return|return
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_regh
argument_list|,
name|index
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|regw
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|index
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_regh
argument_list|,
name|index
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|bus_space_barrier
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_regh
argument_list|,
name|index
argument_list|,
literal|4
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|regwb
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|index
parameter_list|,
name|uint8_t
name|data
parameter_list|)
block|{
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_regh
argument_list|,
name|index
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|bus_space_barrier
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_regh
argument_list|,
name|index
argument_list|,
literal|1
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|regwb_pll
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|index
parameter_list|,
name|uint8_t
name|data
parameter_list|)
block|{
name|regwb
argument_list|(
name|sc
argument_list|,
name|CLOCK_CNTL
operator|+
literal|1
argument_list|,
operator|(
name|index
operator|<<
literal|2
operator|)
operator||
name|PLL_WR_EN
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|CLOCK_CNTL
operator|+
literal|2
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|CLOCK_CNTL
operator|+
literal|1
argument_list|,
operator|(
name|index
operator|<<
literal|2
operator|)
operator|&
operator|~
name|PLL_WR_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wait_for_fifo
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|v
parameter_list|)
block|{
while|while
condition|(
operator|(
name|regr
argument_list|(
name|sc
argument_list|,
name|FIFO_STAT
argument_list|)
operator|&
literal|0xffff
operator|)
operator|>
operator|(
literal|0x8000
operator|>>
name|v
operator|)
condition|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wait_for_idle
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|16
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|regr
argument_list|(
name|sc
argument_list|,
name|GUI_STAT
argument_list|)
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
empty_stmt|;
block|}
end_function

begin_comment
comment|/*  * Inline functions for setting the background and foreground colors.  */
end_comment

begin_function_decl
specifier|static
specifier|inline
name|void
name|machfb_setbg
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|bg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|machfb_setfg
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|fg
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
specifier|inline
name|void
name|machfb_setbg
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|bg
parameter_list|)
block|{
if|if
condition|(
name|bg
operator|==
name|sc
operator|->
name|sc_bg_cache
condition|)
return|return;
name|sc
operator|->
name|sc_bg_cache
operator|=
name|bg
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_BKGD_CLR
argument_list|,
name|bg
operator|+
name|MACHFB_CMAP_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|machfb_setfg
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|fg
parameter_list|)
block|{
if|if
condition|(
name|fg
operator|==
name|sc
operator|->
name|sc_fg_cache
condition|)
return|return;
name|sc
operator|->
name|sc_fg_cache
operator|=
name|fg
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_FRGD_CLR
argument_list|,
name|fg
operator|+
name|MACHFB_CMAP_OFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * video driver interface  */
end_comment

begin_function
specifier|static
name|int
name|machfb_configure
parameter_list|(
name|int
name|flags
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|phandle_t
name|chosen
decl_stmt|,
name|output
decl_stmt|;
name|ihandle_t
name|stdout
decl_stmt|;
name|bus_addr_t
name|addr
decl_stmt|;
name|uint32_t
name|id
decl_stmt|;
name|int
name|i
decl_stmt|,
name|space
decl_stmt|;
comment|/* 	 * For the high-level console probing return the number of 	 * registered adapters. 	 */
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|VIO_PROBE_ONLY
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|vid_find_adapter
argument_list|(
name|MACHFB_DRIVER_NAME
argument_list|,
name|i
argument_list|)
operator|>=
literal|0
condition|;
name|i
operator|++
control|)
empty_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
comment|/* Low-level console probing and initialization. */
name|sc
operator|=
operator|&
name|machfb_softc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_va
operator|.
name|va_flags
operator|&
name|V_ADP_REGISTERED
condition|)
goto|goto
name|found
goto|;
if|if
condition|(
operator|(
name|chosen
operator|=
name|OF_finddevice
argument_list|(
literal|"/chosen"
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
comment|/* Quis contra nos? */
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|chosen
argument_list|,
literal|"stdout"
argument_list|,
operator|&
name|stdout
argument_list|,
sizeof|sizeof
argument_list|(
name|stdout
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|output
operator|=
name|OF_instance_to_package
argument_list|(
name|stdout
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|OF_getprop
argument_list|(
name|output
argument_list|,
literal|"vendor-id"
argument_list|,
operator|&
name|id
argument_list|,
sizeof|sizeof
argument_list|(
name|id
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
operator|)
operator|||
name|id
operator|!=
name|ATI_VENDOR
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|output
argument_list|,
literal|"device-id"
argument_list|,
operator|&
name|id
argument_list|,
sizeof|sizeof
argument_list|(
name|id
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|machfb_info
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|machfb_info
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|id
operator|==
name|machfb_info
index|[
name|i
index|]
operator|.
name|chip_id
condition|)
block|{
name|sc
operator|->
name|sc_flags
operator|=
name|MACHFB_CONSOLE
expr_stmt|;
name|sc
operator|->
name|sc_node
operator|=
name|output
expr_stmt|;
name|sc
operator|->
name|sc_chip_id
operator|=
name|id
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_CONSOLE
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|output
argument_list|,
literal|"revision-id"
argument_list|,
operator|&
name|sc
operator|->
name|sc_chip_rev
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_chip_rev
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|OF_decode_addr
argument_list|(
name|output
argument_list|,
literal|0
argument_list|,
operator|&
name|space
argument_list|,
operator|&
name|addr
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sc
operator|->
name|sc_memt
operator|=
operator|&
name|machfb_bst_store
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|sc_memh
operator|=
name|sparc64_fake_bustag
argument_list|(
name|space
argument_list|,
name|addr
argument_list|,
name|sc
operator|->
name|sc_memt
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_regt
operator|=
name|sc
operator|->
name|sc_memt
expr_stmt|;
name|bus_space_subregion
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_memh
argument_list|,
name|MACH64_REG_OFF
argument_list|,
name|MACH64_REG_SIZE
argument_list|,
operator|&
name|sc
operator|->
name|sc_regh
argument_list|)
expr_stmt|;
if|if
condition|(
name|machfb_init
argument_list|(
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|sc_va
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|found
label|:
comment|/* Return number of found adapters. */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_probe
parameter_list|(
name|int
name|unit
parameter_list|,
name|video_adapter_t
modifier|*
modifier|*
name|adpp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_init
parameter_list|(
name|int
name|unit
parameter_list|,
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|phandle_t
name|options
decl_stmt|;
name|video_info_t
modifier|*
name|vi
decl_stmt|;
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|dac_mask
decl_stmt|,
name|dac_rindex
decl_stmt|,
name|dac_windex
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|vi
operator|=
operator|&
name|adp
operator|->
name|va_info
expr_stmt|;
if|if
condition|(
operator|(
name|regr
argument_list|(
name|sc
argument_list|,
name|CONFIG_CHIP_ID
argument_list|)
operator|&
literal|0xffff
operator|)
operator|!=
name|sc
operator|->
name|sc_chip_id
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|->
name|sc_ramdac_freq
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|machfb_info
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|machfb_info
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_chip_id
operator|==
name|machfb_info
index|[
name|i
index|]
operator|.
name|chip_id
condition|)
block|{
name|sc
operator|->
name|sc_ramdac_freq
operator|=
name|machfb_info
index|[
name|i
index|]
operator|.
name|ramdac_freq
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|sc_ramdac_freq
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|sc_chip_id
operator|==
name|ATI_RAGE_II
operator|&&
name|sc
operator|->
name|sc_chip_rev
operator|&
literal|0x07
condition|)
name|sc
operator|->
name|sc_ramdac_freq
operator|=
literal|170000
expr_stmt|;
name|vid_init_struct
argument_list|(
name|adp
argument_list|,
name|MACHFB_DRIVER_NAME
argument_list|,
operator|-
literal|1
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
literal|"height"
argument_list|,
operator|&
name|sc
operator|->
name|sc_height
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_height
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
literal|"width"
argument_list|,
operator|&
name|sc
operator|->
name|sc_width
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_width
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
literal|"depth"
argument_list|,
operator|&
name|sc
operator|->
name|sc_depth
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_depth
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|(
name|options
operator|=
name|OF_finddevice
argument_list|(
literal|"/options"
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|options
argument_list|,
literal|"screen-#rows"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|vi
operator|->
name|vi_height
operator|=
name|strtol
argument_list|(
name|buf
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|OF_getprop
argument_list|(
name|options
argument_list|,
literal|"screen-#columns"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|vi
operator|->
name|vi_width
operator|=
name|strtol
argument_list|(
name|buf
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|vi
operator|->
name|vi_cwidth
operator|=
name|gallant12x22
operator|.
name|width
expr_stmt|;
name|vi
operator|->
name|vi_cheight
operator|=
name|gallant12x22
operator|.
name|height
expr_stmt|;
name|vi
operator|->
name|vi_flags
operator|=
name|V_INFO_COLOR
expr_stmt|;
name|vi
operator|->
name|vi_mem_model
operator|=
name|V_INFO_MM_OTHER
expr_stmt|;
name|sc
operator|->
name|sc_font
operator|=
name|gallant12x22
operator|.
name|data
expr_stmt|;
name|sc
operator|->
name|sc_cbwidth
operator|=
name|howmany
argument_list|(
name|vi
operator|->
name|vi_cwidth
argument_list|,
name|NBBY
argument_list|)
expr_stmt|;
comment|/* width in bytes */
name|sc
operator|->
name|sc_xmargin
operator|=
operator|(
name|sc
operator|->
name|sc_width
operator|-
operator|(
name|vi
operator|->
name|vi_width
operator|*
name|vi
operator|->
name|vi_cwidth
operator|)
operator|)
operator|/
literal|2
expr_stmt|;
name|sc
operator|->
name|sc_ymargin
operator|=
operator|(
name|sc
operator|->
name|sc_height
operator|-
operator|(
name|vi
operator|->
name|vi_height
operator|*
name|vi
operator|->
name|vi_cheight
operator|)
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_chip_id
operator|!=
name|ATI_MACH64_CT
operator|&&
operator|!
operator|(
operator|(
name|sc
operator|->
name|sc_chip_id
operator|==
name|ATI_MACH64_VT
operator|||
name|sc
operator|->
name|sc_chip_id
operator|==
name|ATI_RAGE_II
operator|)
operator|&&
operator|(
name|sc
operator|->
name|sc_chip_rev
operator|&
literal|0x07
operator|)
operator|==
literal|0
operator|)
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|MACHFB_DSP
expr_stmt|;
name|sc
operator|->
name|sc_memsize
operator|=
name|machfb_get_memsize
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_memsize
operator|==
literal|8192
condition|)
comment|/* The last page is used as register aperture. */
name|sc
operator|->
name|sc_memsize
operator|-=
literal|4
expr_stmt|;
name|sc
operator|->
name|sc_memtype
operator|=
name|regr
argument_list|(
name|sc
argument_list|,
name|CONFIG_STAT0
argument_list|)
operator|&
literal|0x07
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_chip_id
operator|>=
name|ATI_RAGE_XC_PCI66
operator|&&
name|sc
operator|->
name|sc_chip_id
operator|<=
name|ATI_RAGE_XL_PCI66
operator|)
operator|||
operator|(
name|sc
operator|->
name|sc_chip_id
operator|>=
name|ATI_RAGE_XL_PCI
operator|&&
name|sc
operator|->
name|sc_chip_id
operator|<=
name|ATI_RAGE_XC_PCI
operator|)
condition|)
name|sc
operator|->
name|sc_ref_freq
operator|=
literal|29498
expr_stmt|;
else|else
name|sc
operator|->
name|sc_ref_freq
operator|=
literal|14318
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|CLOCK_CNTL
operator|+
literal|1
argument_list|,
name|PLL_REF_DIV
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_ref_div
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|CLOCK_CNTL
operator|+
literal|2
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|CLOCK_CNTL
operator|+
literal|1
argument_list|,
name|MCLK_FB_DIV
operator|<<
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mclk_fb_div
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|CLOCK_CNTL
operator|+
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mem_freq
operator|=
operator|(
literal|2
operator|*
name|sc
operator|->
name|sc_ref_freq
operator|*
name|sc
operator|->
name|sc_mclk_fb_div
operator|)
operator|/
operator|(
name|sc
operator|->
name|sc_ref_div
operator|*
literal|2
operator|)
expr_stmt|;
name|sc
operator|->
name|sc_mclk_post_div
operator|=
operator|(
name|sc
operator|->
name|sc_mclk_fb_div
operator|*
literal|2
operator|*
name|sc
operator|->
name|sc_ref_freq
operator|)
operator|/
operator|(
name|sc
operator|->
name|sc_mem_freq
operator|*
name|sc
operator|->
name|sc_ref_div
operator|)
expr_stmt|;
name|machfb_init_engine
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|machfb_adjust_frame(0, 0);
endif|#
directive|endif
name|machfb_set_mode
argument_list|(
name|adp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Install our 16-color color map.  This is done only once and with 	 * an offset of 16 on sparc64 as there the OBP driver expects white 	 * to be at index 0 and black at 255 (some versions also use 1 - 8 	 * for color text support or the full palette for the boot banner 	 * logo but no versions seems to use the ISO 6429-1983 color map). 	 * Otherwise the colors are inverted when back in the OFW. 	 */
name|dac_rindex
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_RINDEX
argument_list|)
expr_stmt|;
name|dac_windex
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|)
expr_stmt|;
name|dac_mask
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|,
name|MACHFB_CMAP_OFF
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_DATA
argument_list|,
name|machfb_default_cmap
index|[
name|i
index|]
operator|.
name|red
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_DATA
argument_list|,
name|machfb_default_cmap
index|[
name|i
index|]
operator|.
name|green
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_DATA
argument_list|,
name|machfb_default_cmap
index|[
name|i
index|]
operator|.
name|blue
argument_list|)
expr_stmt|;
block|}
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|,
name|dac_mask
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_RINDEX
argument_list|,
name|dac_rindex
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|,
name|dac_windex
argument_list|)
expr_stmt|;
name|machfb_blank_display
argument_list|(
name|adp
argument_list|,
name|V_DISPLAY_ON
argument_list|)
expr_stmt|;
name|machfb_clear
argument_list|(
name|adp
argument_list|)
expr_stmt|;
comment|/* 	 * Setting V_ADP_MODECHANGE serves as hack so machfb_set_mode() 	 * (which will invalidate our caches) is called as a precaution 	 * when the X server shuts down. 	 */
name|adp
operator|->
name|va_flags
operator||=
name|V_ADP_COLOR
operator||
name|V_ADP_MODECHANGE
operator||
name|V_ADP_PALETTE
operator||
name|V_ADP_BORDER
operator||
name|V_ADP_INITIALIZED
expr_stmt|;
if|if
condition|(
name|vid_register
argument_list|(
name|adp
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|adp
operator|->
name|va_flags
operator||=
name|V_ADP_REGISTERED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_get_info
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|,
name|video_info_t
modifier|*
name|info
parameter_list|)
block|{
name|bcopy
argument_list|(
operator|&
name|adp
operator|->
name|va_info
argument_list|,
name|info
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_query_mode
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|video_info_t
modifier|*
name|info
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_set_mode
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|sc
operator|->
name|sc_bg_cache
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_fg_cache
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_draw_cache
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_save_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|width
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_load_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|width
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|count
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_show_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_save_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|dac_mask
decl_stmt|,
name|dac_rindex
decl_stmt|,
name|dac_windex
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|dac_rindex
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_RINDEX
argument_list|)
expr_stmt|;
name|dac_windex
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|)
expr_stmt|;
name|dac_mask
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_RINDEX
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
operator|*
literal|3
condition|;
name|i
operator|++
control|)
name|palette
index|[
name|i
index|]
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_DATA
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|,
name|dac_mask
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_RINDEX
argument_list|,
name|dac_rindex
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|,
name|dac_windex
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_load_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|dac_mask
decl_stmt|,
name|dac_rindex
decl_stmt|,
name|dac_windex
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|dac_rindex
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_RINDEX
argument_list|)
expr_stmt|;
name|dac_windex
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|)
expr_stmt|;
name|dac_mask
operator|=
name|regrb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
operator|*
literal|3
condition|;
name|i
operator|++
control|)
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_DATA
argument_list|,
name|palette
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_MASK
argument_list|,
name|dac_mask
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_RINDEX
argument_list|,
name|dac_rindex
argument_list|)
expr_stmt|;
name|regwb
argument_list|(
name|sc
argument_list|,
name|DAC_WINDEX
argument_list|,
name|dac_windex
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_set_border
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|border
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|machfb_fill_rect
argument_list|(
name|adp
argument_list|,
name|border
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_width
argument_list|,
name|sc
operator|->
name|sc_ymargin
argument_list|)
expr_stmt|;
name|machfb_fill_rect
argument_list|(
name|adp
argument_list|,
name|border
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_height
operator|-
name|sc
operator|->
name|sc_ymargin
argument_list|,
name|sc
operator|->
name|sc_width
argument_list|,
name|sc
operator|->
name|sc_ymargin
argument_list|)
expr_stmt|;
name|machfb_fill_rect
argument_list|(
name|adp
argument_list|,
name|border
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_xmargin
argument_list|,
name|sc
operator|->
name|sc_height
argument_list|)
expr_stmt|;
name|machfb_fill_rect
argument_list|(
name|adp
argument_list|,
name|border
argument_list|,
name|sc
operator|->
name|sc_width
operator|-
name|sc
operator|->
name|sc_xmargin
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_xmargin
argument_list|,
name|sc
operator|->
name|sc_height
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_save_state
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|void
modifier|*
name|p
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_load_state
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_set_win_org
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|off_t
name|offset
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_read_hw_cursor
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
modifier|*
name|col
parameter_list|,
name|int
modifier|*
name|row
parameter_list|)
block|{
operator|*
name|col
operator|=
literal|0
expr_stmt|;
operator|*
name|row
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_set_hw_cursor
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|col
parameter_list|,
name|int
name|row
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_set_hw_cursor_shape
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|base
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|celsize
parameter_list|,
name|int
name|blink
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_blank_display
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|crtc_gen_cntl
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|crtc_gen_cntl
operator|=
operator|(
name|regr
argument_list|(
name|sc
argument_list|,
name|CRTC_GEN_CNTL
argument_list|)
operator||
name|CRTC_EXT_DISP_EN
operator||
name|CRTC_EN
operator|)
operator|&
operator|~
operator|(
name|CRTC_HSYNC_DIS
operator||
name|CRTC_VSYNC_DIS
operator||
name|CRTC_DISPLAY_DIS
operator|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|V_DISPLAY_ON
case|:
break|break;
case|case
name|V_DISPLAY_BLANK
case|:
name|crtc_gen_cntl
operator||=
name|CRTC_HSYNC_DIS
operator||
name|CRTC_VSYNC_DIS
operator||
name|CRTC_DISPLAY_DIS
expr_stmt|;
break|break;
case|case
name|V_DISPLAY_STAND_BY
case|:
name|crtc_gen_cntl
operator||=
name|CRTC_HSYNC_DIS
operator||
name|CRTC_DISPLAY_DIS
expr_stmt|;
break|break;
case|case
name|V_DISPLAY_SUSPEND
case|:
name|crtc_gen_cntl
operator||=
name|CRTC_VSYNC_DIS
operator||
name|CRTC_DISPLAY_DIS
expr_stmt|;
break|break;
block|}
name|regw
argument_list|(
name|sc
argument_list|,
name|CRTC_GEN_CNTL
argument_list|,
name|crtc_gen_cntl
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_mmap
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_ooffset_t
name|offset
parameter_list|,
name|vm_paddr_t
modifier|*
name|paddr
parameter_list|,
name|int
name|prot
parameter_list|,
name|vm_memattr_t
modifier|*
name|memattr
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|video_info_t
modifier|*
name|vi
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|vi
operator|=
operator|&
name|adp
operator|->
name|va_info
expr_stmt|;
comment|/* BAR 2 - VGA memory */
if|if
condition|(
name|sc
operator|->
name|sc_vmem
operator|!=
literal|0
operator|&&
name|offset
operator|>=
name|sc
operator|->
name|sc_vmem
operator|&&
name|offset
operator|<
name|sc
operator|->
name|sc_vmem
operator|+
name|vi
operator|->
name|vi_registers_size
condition|)
block|{
operator|*
name|paddr
operator|=
name|vi
operator|->
name|vi_registers
operator|+
name|offset
operator|-
name|sc
operator|->
name|sc_vmem
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* BAR 0 - framebuffer */
if|if
condition|(
name|offset
operator|>=
name|sc
operator|->
name|sc_mem
operator|&&
name|offset
operator|<
name|sc
operator|->
name|sc_mem
operator|+
name|vi
operator|->
name|vi_buffer_size
condition|)
block|{
operator|*
name|paddr
operator|=
name|vi
operator|->
name|vi_buffer
operator|+
name|offset
operator|-
name|sc
operator|->
name|sc_mem
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 'regular' framebuffer mmap()ing */
if|if
condition|(
name|offset
operator|<
name|adp
operator|->
name|va_window_size
condition|)
block|{
operator|*
name|paddr
operator|=
name|vi
operator|->
name|vi_window
operator|+
name|offset
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_ioctl
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|fbcursor
modifier|*
name|fbc
decl_stmt|;
name|struct
name|fbtype
modifier|*
name|fb
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|FBIOGTYPE
case|:
name|fb
operator|=
operator|(
expr|struct
name|fbtype
operator|*
operator|)
name|data
expr_stmt|;
name|fb
operator|->
name|fb_type
operator|=
name|FBTYPE_PCIMISC
expr_stmt|;
name|fb
operator|->
name|fb_height
operator|=
name|sc
operator|->
name|sc_height
expr_stmt|;
name|fb
operator|->
name|fb_width
operator|=
name|sc
operator|->
name|sc_width
expr_stmt|;
name|fb
operator|->
name|fb_depth
operator|=
name|sc
operator|->
name|sc_depth
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_depth
operator|<=
literal|1
operator|||
name|sc
operator|->
name|sc_depth
operator|>
literal|8
condition|)
name|fb
operator|->
name|fb_cmsize
operator|=
literal|0
expr_stmt|;
else|else
name|fb
operator|->
name|fb_cmsize
operator|=
literal|1
operator|<<
name|sc
operator|->
name|sc_depth
expr_stmt|;
name|fb
operator|->
name|fb_size
operator|=
name|adp
operator|->
name|va_buffer_size
expr_stmt|;
break|break;
case|case
name|FBIOSCURSOR
case|:
name|fbc
operator|=
operator|(
expr|struct
name|fbcursor
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|fbc
operator|->
name|set
operator|&
name|FB_CUR_SETCUR
operator|&&
name|fbc
operator|->
name|enable
operator|==
literal|0
condition|)
block|{
name|machfb_cursor_enable
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|MACHFB_CUREN
expr_stmt|;
block|}
else|else
return|return
operator|(
name|ENODEV
operator|)
return|;
break|break;
default|default:
return|return
operator|(
name|fb_commonioctl
argument_list|(
name|adp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_clear
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
name|machfb_fill_rect
argument_list|(
name|adp
argument_list|,
operator|(
name|SC_NORM_ATTR
operator|>>
literal|4
operator|)
operator|&
literal|0xf
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_width
argument_list|,
name|sc
operator|->
name|sc_height
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_fill_rect
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|val
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|cx
parameter_list|,
name|int
name|cy
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_draw_cache
operator|!=
name|MACHFB_DRAW_FILLRECT
condition|)
block|{
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_WRITE_MASK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_PIX_WIDTH
argument_list|,
name|DST_8BPP
operator||
name|SRC_8BPP
operator||
name|HOST_8BPP
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_SRC
argument_list|,
name|FRGD_SRC_FRGD_CLR
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_MIX
argument_list|,
name|MIX_SRC
operator|<<
literal|16
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CLR_CMP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* no transparency */
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_CNTL
argument_list|,
name|SRC_LINE_X_LEFT_TO_RIGHT
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_CNTL
argument_list|,
name|DST_X_LEFT_TO_RIGHT
operator||
name|DST_Y_TOP_TO_BOTTOM
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_draw_cache
operator|=
name|MACHFB_DRAW_FILLRECT
expr_stmt|;
block|}
name|machfb_setfg
argument_list|(
name|sc
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_Y_X
argument_list|,
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_WIDTH1
argument_list|,
name|cx
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_Y_X
argument_list|,
operator|(
name|x
operator|<<
literal|16
operator|)
operator||
name|y
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_HEIGHT_WIDTH
argument_list|,
operator|(
name|cx
operator|<<
literal|16
operator|)
operator||
name|cy
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_bitblt
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
modifier|...
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_diag
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|video_info_t
name|info
decl_stmt|;
name|fb_dump_adp_info
argument_list|(
name|adp
operator|->
name|va_name
argument_list|,
name|adp
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|machfb_get_info
argument_list|(
name|adp
argument_list|,
literal|0
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|fb_dump_mode_info
argument_list|(
name|adp
operator|->
name|va_name
argument_list|,
name|adp
argument_list|,
operator|&
name|info
argument_list|,
name|level
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_save_cursor_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_load_cursor_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_copy
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|src
parameter_list|,
name|vm_offset_t
name|dst
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_putp
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|uint32_t
name|p
parameter_list|,
name|uint32_t
name|a
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|bpp
parameter_list|,
name|int
name|bit_ltor
parameter_list|,
name|int
name|byte_ltor
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_putc
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|uint8_t
name|c
parameter_list|,
name|uint8_t
name|a
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_draw_cache
operator|!=
name|MACHFB_DRAW_CHAR
condition|)
block|{
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_WRITE_MASK
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* XXX only good for 8 bit */
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_PIX_WIDTH
argument_list|,
name|DST_8BPP
operator||
name|SRC_1BPP
operator||
name|HOST_1BPP
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_SRC
argument_list|,
name|MONO_SRC_HOST
operator||
name|BKGD_SRC_BKGD_CLR
operator||
name|FRGD_SRC_FRGD_CLR
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_MIX
argument_list|,
operator|(
operator|(
name|MIX_SRC
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
operator|)
operator||
name|MIX_SRC
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CLR_CMP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* no transparency */
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_CNTL
argument_list|,
name|SRC_LINE_X_LEFT_TO_RIGHT
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_CNTL
argument_list|,
name|DST_Y_TOP_TO_BOTTOM
operator||
name|DST_X_LEFT_TO_RIGHT
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|HOST_CNTL
argument_list|,
name|HOST_BYTE_ALIGN
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_draw_cache
operator|=
name|MACHFB_DRAW_CHAR
expr_stmt|;
block|}
name|machfb_setbg
argument_list|(
name|sc
argument_list|,
operator|(
name|a
operator|>>
literal|4
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|machfb_setfg
argument_list|(
name|sc
argument_list|,
name|a
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|4
operator|+
operator|(
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|/
name|sc
operator|->
name|sc_cbwidth
operator|)
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_Y_X
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_WIDTH1
argument_list|,
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_Y_X
argument_list|,
operator|(
operator|(
operator|(
operator|(
name|off
operator|%
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|)
operator|+
name|sc
operator|->
name|sc_xmargin
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|off
operator|/
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|)
operator|+
name|sc
operator|->
name|sc_ymargin
operator|)
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_HEIGHT_WIDTH
argument_list|,
operator|(
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|<<
literal|16
operator|)
operator||
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
argument_list|)
expr_stmt|;
name|p
operator|=
name|sc
operator|->
name|sc_font
operator|+
operator|(
name|c
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|*
name|sc
operator|->
name|sc_cbwidth
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|*
name|sc
operator|->
name|sc_cbwidth
condition|;
name|i
operator|+=
literal|4
control|)
name|regw
argument_list|(
name|sc
argument_list|,
name|HOST_DATA0
operator|+
name|i
argument_list|,
operator|(
name|p
index|[
name|i
operator|+
literal|3
index|]
operator|<<
literal|24
operator||
name|p
index|[
name|i
operator|+
literal|2
index|]
operator|<<
literal|16
operator||
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|<<
literal|8
operator||
name|p
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_puts
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|uint16_t
modifier|*
name|s
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|blanks
decl_stmt|,
name|i
decl_stmt|,
name|x1
decl_stmt|,
name|x2
decl_stmt|,
name|y1
decl_stmt|,
name|y2
decl_stmt|;
name|uint8_t
name|a
decl_stmt|,
name|c
decl_stmt|,
name|color1
decl_stmt|,
name|color2
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
define|#
directive|define
name|MACHFB_BLANK
value|machfb_fill_rect(adp, color1, x1, y1,		\ 			    blanks * adp->va_info.vi_cwidth,		\ 			    adp->va_info.vi_cheight)
name|blanks
operator|=
name|color1
operator|=
name|x1
operator|=
name|y1
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
comment|/* 		 * Accelerate continuous blanks by drawing a respective 		 * rectangle instead.  Drawing a rectangle of any size 		 * takes about the same number of operations as drawing 		 * a single character. 		 */
name|c
operator|=
name|s
index|[
name|i
index|]
operator|&
literal|0xff
expr_stmt|;
name|a
operator|=
operator|(
name|s
index|[
name|i
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0x00
operator|||
name|c
operator|==
literal|0x20
operator|||
name|c
operator|==
literal|0xdb
operator|||
name|c
operator|==
literal|0xff
condition|)
block|{
name|color2
operator|=
operator|(
name|a
operator|>>
operator|(
name|c
operator|==
literal|0xdb
condition|?
literal|0
else|:
literal|4
operator|)
operator|&
literal|0xf
operator|)
expr_stmt|;
name|x2
operator|=
operator|(
operator|(
operator|(
name|off
operator|+
name|i
operator|)
operator|%
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|)
operator|+
name|sc
operator|->
name|sc_xmargin
expr_stmt|;
name|y2
operator|=
operator|(
operator|(
operator|(
name|off
operator|+
name|i
operator|)
operator|/
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|)
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|)
operator|+
name|sc
operator|->
name|sc_ymargin
expr_stmt|;
if|if
condition|(
name|blanks
operator|==
literal|0
condition|)
block|{
name|color1
operator|=
name|color2
expr_stmt|;
name|x1
operator|=
name|x2
expr_stmt|;
name|y1
operator|=
name|y2
expr_stmt|;
name|blanks
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|color1
operator|!=
name|color2
operator|||
name|y1
operator|!=
name|y2
condition|)
block|{
name|MACHFB_BLANK
expr_stmt|;
name|color1
operator|=
name|color2
expr_stmt|;
name|x1
operator|=
name|x2
expr_stmt|;
name|y1
operator|=
name|y2
expr_stmt|;
name|blanks
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|blanks
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|blanks
operator|!=
literal|0
condition|)
block|{
name|MACHFB_BLANK
expr_stmt|;
name|blanks
operator|=
literal|0
expr_stmt|;
block|}
name|vidd_putc
argument_list|(
name|adp
argument_list|,
name|off
operator|+
name|i
argument_list|,
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|blanks
operator|!=
literal|0
condition|)
name|MACHFB_BLANK
expr_stmt|;
undef|#
directive|undef
name|MACHFB_BLANK
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_putm
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|uint8_t
modifier|*
name|pixel_image
parameter_list|,
name|uint32_t
name|pixel_mask
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|width
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|adp
expr_stmt|;
if|if
condition|(
operator|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_CUREN
operator|)
operator|)
operator|&&
operator|(
name|error
operator|=
name|machfb_cursor_install
argument_list|(
name|sc
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
else|else
block|{
comment|/* 		 * The hardware cursor always must be disabled when 		 * fiddling with its bits otherwise some artifacts 		 * may appear on the screen. 		 */
name|machfb_cursor_enable
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|regw
argument_list|(
name|sc
argument_list|,
name|CUR_HORZ_VERT_OFF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regr
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|)
operator|&
name|CRTC_DBL_SCAN_EN
operator|)
operator|!=
literal|0
condition|)
name|y
operator|<<=
literal|1
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CUR_HORZ_VERT_POSN
argument_list|,
operator|(
operator|(
name|y
operator|+
name|sc
operator|->
name|sc_ymargin
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
name|x
operator|+
name|sc
operator|->
name|sc_xmargin
operator|)
argument_list|)
expr_stmt|;
name|machfb_cursor_enable
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|MACHFB_CUREN
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * PCI bus interface  */
end_comment

begin_function
specifier|static
name|int
name|machfb_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|pci_get_class
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCIC_DISPLAY
operator|||
name|pci_get_subclass
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCIS_DISPLAY_VGA
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|machfb_info
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|machfb_info
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|machfb_info
index|[
name|i
index|]
operator|.
name|chip_id
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|machfb_info
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
decl_stmt|;
name|video_adapter_t
modifier|*
name|adp
decl_stmt|;
name|video_switch_t
modifier|*
name|sw
decl_stmt|;
name|video_info_t
modifier|*
name|vi
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|rid
decl_stmt|;
name|uint32_t
modifier|*
name|p32
decl_stmt|,
name|u32
decl_stmt|;
name|uint8_t
modifier|*
name|p
decl_stmt|;
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|=
operator|(
expr|struct
name|machfb_softc
operator|*
operator|)
name|vid_get_adapter
argument_list|(
name|vid_find_adapter
argument_list|(
name|MACHFB_DRIVER_NAME
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
name|sc
operator|->
name|sc_node
operator|==
name|node
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"console\n"
argument_list|)
expr_stmt|;
name|device_set_softc
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_node
operator|=
name|node
expr_stmt|;
name|sc
operator|->
name|sc_chip_id
operator|=
name|pci_get_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_chip_rev
operator|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|adp
operator|=
operator|&
name|sc
operator|->
name|sc_va
expr_stmt|;
name|vi
operator|=
operator|&
name|adp
operator|->
name|va_info
expr_stmt|;
comment|/* 	 * Allocate resources regardless of whether we are the console 	 * and already obtained the bus tag and handle for the framebuffer 	 * in machfb_configure() or not so the resources are marked as 	 * taken in the respective RMAN. 	 */
comment|/* Enable memory and IO access. */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
operator||
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_MEMEN
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* 	 * NB: we need to take care that the framebuffer isn't mapped 	 * in twice as besides wasting resources this isn't possible with 	 * all MMUs. 	 */
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_memres
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate memory resources\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|OF_getprop
argument_list|(
name|sc
operator|->
name|sc_node
argument_list|,
literal|"address"
argument_list|,
operator|&
name|u32
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|)
operator|>
literal|0
operator|&&
name|vtophys
argument_list|(
name|u32
argument_list|)
operator|==
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
condition|)
name|adp
operator|->
name|va_mem_base
operator|=
name|u32
expr_stmt|;
else|else
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_memres
argument_list|)
expr_stmt|;
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_memres
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate memory resources\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|adp
operator|->
name|va_mem_base
operator|=
operator|(
name|vm_offset_t
operator|)
name|rman_get_virtual
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_memt
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_memh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_regt
operator|=
name|sc
operator|->
name|sc_memt
expr_stmt|;
name|bus_space_subregion
argument_list|(
name|sc
operator|->
name|sc_regt
argument_list|,
name|sc
operator|->
name|sc_memh
argument_list|,
name|MACH64_REG_OFF
argument_list|,
name|MACH64_REG_SIZE
argument_list|,
operator|&
name|sc
operator|->
name|sc_regh
argument_list|)
expr_stmt|;
name|adp
operator|->
name|va_mem_size
operator|=
name|rman_get_size
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
expr_stmt|;
name|adp
operator|->
name|va_buffer
operator|=
name|adp
operator|->
name|va_mem_base
expr_stmt|;
name|adp
operator|->
name|va_buffer_size
operator|=
name|adp
operator|->
name|va_mem_size
expr_stmt|;
name|sc
operator|->
name|sc_mem
operator|=
name|rman_get_start
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
expr_stmt|;
name|vi
operator|->
name|vi_buffer
operator|=
name|sc
operator|->
name|sc_memh
expr_stmt|;
name|vi
operator|->
name|vi_buffer_size
operator|=
name|adp
operator|->
name|va_buffer_size
expr_stmt|;
comment|/* 	 * Depending on the firmware version the VGA I/O and/or memory 	 * resources of the Mach64 chips come up disabled.  We generally 	 * enable them above (pci(4) actually already did this unless 	 * pci_enable_io_modes is not set) but this doesn't necessarily 	 * mean that we get valid ones.  Invalid resources seem to have 	 * in common that they start at address 0.  We don't allocate 	 * them in this case in order to avoid warnings in apb(4) and 	 * crashes when using these invalid resources.  X.Org is aware 	 * of this and doesn't use the VGA resources in this case (but 	 * demands them if they are valid). 	 */
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_get_resource_start
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_vmemres
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate VGA memory resources\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail_memres
goto|;
block|}
name|adp
operator|->
name|va_registers
operator|=
operator|(
name|vm_offset_t
operator|)
name|rman_get_virtual
argument_list|(
name|sc
operator|->
name|sc_vmemres
argument_list|)
expr_stmt|;
name|adp
operator|->
name|va_registers_size
operator|=
name|rman_get_size
argument_list|(
name|sc
operator|->
name|sc_vmemres
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_vmem
operator|=
name|rman_get_start
argument_list|(
name|sc
operator|->
name|sc_vmemres
argument_list|)
expr_stmt|;
name|vi
operator|->
name|vi_registers
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|sc_vmemres
argument_list|)
expr_stmt|;
name|vi
operator|->
name|vi_registers_size
operator|=
name|adp
operator|->
name|va_registers_size
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_CONSOLE
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|sw
operator|=
name|vid_get_switch
argument_list|(
name|MACHFB_DRIVER_NAME
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot get video switch\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENODEV
expr_stmt|;
goto|goto
name|fail_vmemres
goto|;
block|}
comment|/* 		 * During device configuration we don't necessarily probe 		 * the adapter which is the console first so we can't use 		 * the device unit number for the video adapter unit.  The 		 * worst case would be that we use the video adapter unit 		 * 0 twice.  As it doesn't really matter which unit number 		 * the corresponding video adapter has just use the next 		 * unused one. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|devclass_get_maxunit
argument_list|(
name|machfb_devclass
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|vid_find_adapter
argument_list|(
name|MACHFB_DRIVER_NAME
argument_list|,
name|i
argument_list|)
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|error
operator|=
name|sw
operator|->
name|init
argument_list|(
name|i
argument_list|,
name|adp
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot initialize adapter\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail_vmemres
goto|;
block|}
block|}
comment|/* 	 * Test whether the aperture is byte swapped or not, set 	 * va_window and va_window_size as appropriate.  Note that 	 * the aperture could be mapped either big or little endian 	 * on independently of the endianess of the host so this 	 * has to be a runtime test. 	 */
name|p32
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|adp
operator|->
name|va_buffer
expr_stmt|;
name|u32
operator|=
operator|*
name|p32
expr_stmt|;
name|p
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|adp
operator|->
name|va_buffer
expr_stmt|;
operator|*
name|p32
operator|=
literal|0x12345678
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
index|[
literal|0
index|]
operator|==
literal|0x12
operator|&&
name|p
index|[
literal|1
index|]
operator|==
literal|0x34
operator|&&
name|p
index|[
literal|2
index|]
operator|==
literal|0x56
operator|&&
name|p
index|[
literal|3
index|]
operator|==
literal|0x78
operator|)
condition|)
block|{
name|adp
operator|->
name|va_window
operator|=
name|adp
operator|->
name|va_buffer
operator|+
literal|0x800000
expr_stmt|;
name|adp
operator|->
name|va_window_size
operator|=
name|adp
operator|->
name|va_buffer_size
operator|-
literal|0x800000
expr_stmt|;
name|vi
operator|->
name|vi_window
operator|=
name|vi
operator|->
name|vi_buffer
operator|+
literal|0x800000
expr_stmt|;
name|vi
operator|->
name|vi_window_size
operator|=
name|vi
operator|->
name|vi_buffer_size
operator|-
literal|0x800000
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|MACHFB_SWAP
expr_stmt|;
block|}
else|else
block|{
name|adp
operator|->
name|va_window
operator|=
name|adp
operator|->
name|va_buffer
expr_stmt|;
name|adp
operator|->
name|va_window_size
operator|=
name|adp
operator|->
name|va_buffer_size
expr_stmt|;
name|vi
operator|->
name|vi_window
operator|=
name|vi
operator|->
name|vi_buffer
expr_stmt|;
name|vi
operator|->
name|vi_window_size
operator|=
name|vi
operator|->
name|vi_buffer_size
expr_stmt|;
block|}
operator|*
name|p32
operator|=
name|u32
expr_stmt|;
name|adp
operator|->
name|va_window_gran
operator|=
name|adp
operator|->
name|va_window_size
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%d MB aperture at %p %sswapped\n"
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|adp
operator|->
name|va_window_size
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|adp
operator|->
name|va_window
argument_list|,
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_SWAP
operator|)
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%ld KB %s %d.%d MHz, maximum RAMDAC clock %d MHz, %sDSP\n"
argument_list|,
operator|(
name|u_long
operator|)
name|sc
operator|->
name|sc_memsize
argument_list|,
name|machfb_memtype_names
index|[
name|sc
operator|->
name|sc_memtype
index|]
argument_list|,
name|sc
operator|->
name|sc_mem_freq
operator|/
literal|1000
argument_list|,
name|sc
operator|->
name|sc_mem_freq
operator|%
literal|1000
argument_list|,
name|sc
operator|->
name|sc_ramdac_freq
operator|/
literal|1000
argument_list|,
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_DSP
operator|)
condition|?
literal|""
else|:
literal|"no "
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"resolution %dx%d at %d bpp\n"
argument_list|,
name|sc
operator|->
name|sc_width
argument_list|,
name|sc
operator|->
name|sc_height
argument_list|,
name|sc
operator|->
name|sc_depth
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate one page for the mouse pointer image at the end of 	 * the little endian aperture, right before the memory mapped 	 * registers that might also reside there.  Must be done after 	 * sc_memsize was set and possibly adjusted to account for the 	 * memory mapped registers. 	 */
name|sc
operator|->
name|sc_curoff
operator|=
operator|(
name|sc
operator|->
name|sc_memsize
operator|*
literal|1024
operator|)
operator|-
name|PAGE_SIZE
expr_stmt|;
name|sc
operator|->
name|sc_memsize
operator|-=
name|PAGE_SIZE
operator|/
literal|1024
expr_stmt|;
name|machfb_cursor_enable
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize with an all transparent image. */
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|adp
operator|->
name|va_buffer
operator|+
name|sc
operator|->
name|sc_curoff
operator|)
argument_list|,
literal|0xaa
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
comment|/* 	 * Register a handler that performs some cosmetic surgery like 	 * turning off the mouse pointer on halt in preparation for 	 * handing the screen over to the OFW.  Register another handler 	 * that turns off the CRTC when resetting, otherwise the OFW 	 * boot command issued by cpu_reset() just doesn't work. 	 */
name|EVENTHANDLER_REGISTER
argument_list|(
name|shutdown_final
argument_list|,
name|machfb_shutdown_final
argument_list|,
name|sc
argument_list|,
name|SHUTDOWN_PRI_DEFAULT
argument_list|)
expr_stmt|;
name|EVENTHANDLER_REGISTER
argument_list|(
name|shutdown_reset
argument_list|,
name|machfb_shutdown_reset
argument_list|,
name|sc
argument_list|,
name|SHUTDOWN_PRI_DEFAULT
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail_vmemres
label|:
if|if
condition|(
name|sc
operator|->
name|sc_vmemres
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|sc_vmemres
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_vmemres
argument_list|)
expr_stmt|;
name|fail_memres
label|:
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|sc_memres
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_memres
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * internal functions  */
end_comment

begin_function
specifier|static
name|void
name|machfb_cursor_enable
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|onoff
parameter_list|)
block|{
if|if
condition|(
name|onoff
condition|)
name|regw
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|,
name|regr
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|)
operator||
name|HWCURSOR_ENABLE
argument_list|)
expr_stmt|;
else|else
name|regw
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|,
name|regr
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|)
operator|&
operator|~
name|HWCURSOR_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_cursor_install
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
modifier|*
name|p
decl_stmt|,
name|v
decl_stmt|;
name|uint8_t
name|fg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_curoff
operator|==
literal|0
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|machfb_cursor_enable
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CUR_OFFSET
argument_list|,
name|sc
operator|->
name|sc_curoff
operator|>>
literal|3
argument_list|)
expr_stmt|;
name|fg
operator|=
name|SC_NORM_ATTR
operator|&
literal|0xf
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CUR_CLR0
argument_list|,
name|machfb_default_cmap
index|[
name|fg
index|]
operator|.
name|red
operator|<<
literal|24
operator||
name|machfb_default_cmap
index|[
name|fg
index|]
operator|.
name|green
operator|<<
literal|16
operator||
name|machfb_default_cmap
index|[
name|fg
index|]
operator|.
name|blue
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|uint16_t
operator|*
operator|)
operator|(
name|sc
operator|->
name|sc_va
operator|.
name|va_buffer
operator|+
name|sc
operator|->
name|sc_curoff
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|v
operator|=
name|machfb_mouse_pointer_lut
index|[
name|machfb_mouse_pointer_bits
index|[
name|i
index|]
index|[
name|j
index|]
operator|>>
literal|4
index|]
operator|<<
literal|8
operator||
name|machfb_mouse_pointer_lut
index|[
name|machfb_mouse_pointer_bits
index|[
name|i
index|]
index|[
name|j
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_SWAP
condition|)
operator|*
operator|(
name|p
operator|++
operator|)
operator|=
name|bswap16
argument_list|(
name|v
argument_list|)
expr_stmt|;
else|else
operator|*
operator|(
name|p
operator|++
operator|)
operator|=
name|v
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|machfb_get_memsize
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|tmp
decl_stmt|,
name|memsize
decl_stmt|;
specifier|const
name|int
specifier|const
name|mem_tab
index|[]
init|=
block|{
literal|512
block|,
literal|1024
block|,
literal|2048
block|,
literal|4096
block|,
literal|6144
block|,
literal|8192
block|,
literal|12288
block|,
literal|16384
block|}
decl_stmt|;
name|tmp
operator|=
name|regr
argument_list|(
name|sc
argument_list|,
name|MEM_CNTL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MACHFB_DEBUG
name|printf
argument_list|(
literal|"memcntl=0x%08x\n"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_DSP
condition|)
block|{
name|tmp
operator|&=
literal|0x0000000f
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|8
condition|)
name|memsize
operator|=
operator|(
name|tmp
operator|+
literal|1
operator|)
operator|*
literal|512
expr_stmt|;
elseif|else
if|if
condition|(
name|tmp
operator|<
literal|12
condition|)
name|memsize
operator|=
operator|(
name|tmp
operator|-
literal|3
operator|)
operator|*
literal|1024
expr_stmt|;
else|else
name|memsize
operator|=
operator|(
name|tmp
operator|-
literal|7
operator|)
operator|*
literal|2048
expr_stmt|;
block|}
else|else
name|memsize
operator|=
name|mem_tab
index|[
name|tmp
operator|&
literal|0x07
index|]
expr_stmt|;
return|return
operator|(
name|memsize
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|machfb_reset_engine
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Reset engine.*/
name|regw
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|,
name|regr
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|)
operator|&
operator|~
name|GUI_ENGINE_ENABLE
argument_list|)
expr_stmt|;
comment|/* Enable engine. */
name|regw
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|,
name|regr
argument_list|(
name|sc
argument_list|,
name|GEN_TEST_CNTL
argument_list|)
operator||
name|GUI_ENGINE_ENABLE
argument_list|)
expr_stmt|;
comment|/* 	 * Ensure engine is not locked up by clearing any FIFO or 	 * host errors. 	 */
name|regw
argument_list|(
name|sc
argument_list|,
name|BUS_CNTL
argument_list|,
name|regr
argument_list|(
name|sc
argument_list|,
name|BUS_CNTL
argument_list|)
operator||
name|BUS_HOST_ERR_ACK
operator||
name|BUS_FIFO_ERR_ACK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|machfb_init_engine
parameter_list|(
name|struct
name|machfb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|pitch_value
decl_stmt|;
name|pitch_value
operator|=
name|sc
operator|->
name|sc_width
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_depth
operator|==
literal|24
condition|)
name|pitch_value
operator|*=
literal|3
expr_stmt|;
name|machfb_reset_engine
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CONTEXT_MASK
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_OFF_PITCH
argument_list|,
operator|(
name|pitch_value
operator|/
literal|8
operator|)
operator|<<
literal|22
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_Y_X
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_HEIGHT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_BRES_ERR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_BRES_INC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_BRES_DEC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DST_CNTL
argument_list|,
name|DST_LAST_PEL
operator||
name|DST_X_LEFT_TO_RIGHT
operator||
name|DST_Y_TOP_TO_BOTTOM
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_OFF_PITCH
argument_list|,
operator|(
name|pitch_value
operator|/
literal|8
operator|)
operator|<<
literal|22
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_Y_X
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_HEIGHT1_WIDTH1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_Y_X_START
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_HEIGHT2_WIDTH2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SRC_CNTL
argument_list|,
name|SRC_LINE_X_LEFT_TO_RIGHT
argument_list|)
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|13
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|HOST_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|PAT_REG0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|PAT_REG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|PAT_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SC_LEFT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SC_TOP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SC_BOTTOM
argument_list|,
name|sc
operator|->
name|sc_height
operator|-
literal|1
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|SC_RIGHT
argument_list|,
name|pitch_value
operator|-
literal|1
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_BKGD_CLR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_FRGD_CLR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_WRITE_MASK
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_MIX
argument_list|,
operator|(
name|MIX_SRC
operator|<<
literal|16
operator|)
operator||
name|MIX_DST
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_SRC
argument_list|,
name|FRGD_SRC_FRGD_CLR
argument_list|)
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CLR_CMP_CLR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CLR_CMP_MASK
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CLR_CMP_CNTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_depth
condition|)
block|{
case|case
literal|8
case|:
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_PIX_WIDTH
argument_list|,
name|HOST_8BPP
operator||
name|SRC_8BPP
operator||
name|DST_8BPP
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DP_CHAIN_MASK
argument_list|,
name|DP_CHAIN_8BPP
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|DAC_CNTL
argument_list|,
name|regr
argument_list|(
name|sc
argument_list|,
name|DAC_CNTL
argument_list|)
operator||
name|DAC_8BIT_EN
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
literal|0
block|case 32: 		regw(sc, DP_PIX_WIDTH, HOST_32BPP | SRC_32BPP | DST_32BPP); 		regw(sc, DP_CHAIN_MASK, DP_CHAIN_32BPP); 		regw(sc, DAC_CNTL, regr(sc, DAC_CNTL) | DAC_8BIT_EN); 		break;
endif|#
directive|endif
block|}
name|wait_for_fifo
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|CRTC_INT_CNTL
argument_list|,
name|regr
argument_list|(
name|sc
argument_list|,
name|CRTC_INT_CNTL
argument_list|)
operator|&
operator|~
literal|0x20
argument_list|)
expr_stmt|;
name|regw
argument_list|(
name|sc
argument_list|,
name|GUI_TRAJ_CNTL
argument_list|,
name|DST_X_LEFT_TO_RIGHT
operator||
name|DST_Y_TOP_TO_BOTTOM
argument_list|)
expr_stmt|;
name|wait_for_idle
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void machfb_adjust_frame(struct machfb_softc *sc, int x, int y) { 	int offset;  	offset = ((x + y * sc->sc_width) * (sc->sc_depth>> 3))>> 3;  	regw(sc, CRTC_OFF_PITCH, (regr(sc, CRTC_OFF_PITCH)& 0xfff00000) | 	    offset); }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|machfb_shutdown_final
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
init|=
name|v
decl_stmt|;
name|machfb_cursor_enable
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * In case this is the console set the cursor of the stdout 	 * instance to the start of the last line so OFW output ends 	 * up beneath what FreeBSD left on the screen. 	 */
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|MACHFB_CONSOLE
condition|)
block|{
name|OF_interpret
argument_list|(
literal|"stdout @ is my-self 0 to column#"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OF_interpret
argument_list|(
literal|"stdout @ is my-self #lines 1 - to line#"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|machfb_shutdown_reset
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|machfb_softc
modifier|*
name|sc
init|=
name|v
decl_stmt|;
name|machfb_blank_display
argument_list|(
operator|&
name|sc
operator|->
name|sc_va
argument_list|,
name|V_DISPLAY_STAND_BY
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


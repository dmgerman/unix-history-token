begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001 Andrew Miklic  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*-  * Copyright (c) 1995, 1996 Carnegie-Mellon University.  * All rights reserved.  *  * Author: Chris G. Demetriou  *   * Permission to use, copy, modify and distribute this software and  * its documentation is hereby granted, provided that both the copyright  * notice and this permission notice appear in all copies of the  * software, derivative works or modified versions, and any portions  * thereof, and that both notices appear in supporting documentation.  *   * CARNEGIE MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS"   * CONDITION.  CARNEGIE MELLON DISCLAIMS ANY LIABILITY OF ANY KIND   * FOR ANY DAMAGES WHATSOEVER RESULTING FROM THE USE OF THIS SOFTWARE.  *   * Carnegie Mellon requests users of this software to return to  *  *  Software Distribution Coordinator  or  Software.Distribution@CS.CMU.EDU  *  School of Computer Science  *  Carnegie Mellon University  *  Pittsburgh PA 15213-3890  *  * any improvements or extensions that they make and grant Carnegie the  * rights to redistribute these changes.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/pc/bios.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/pc/vesa.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/rpb.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/gfb.h>
end_include

begin_include
include|#
directive|include
file|<dev/gfb/gfb_pci.h>
end_include

begin_include
include|#
directive|include
file|"opt_gfb.h"
end_include

begin_decl_stmt
name|struct
name|gfb_softc
modifier|*
name|gfb_device_softcs
index|[
literal|2
index|]
index|[
name|MAX_NUM_GFB_CARDS
index|]
init|=
block|{
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    The following 9 variables exist only because we need statically    allocated structures very early in boot to support gfb_configure()... */
end_comment

begin_decl_stmt
name|struct
name|gfb_softc
name|console
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|video_adapter_t
name|console_adp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|gfb_conf
name|console_gfbc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|console_palette_red
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|console_palette_green
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|console_palette_blue
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|console_cursor_palette_red
index|[
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|console_cursor_palette_green
index|[
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|console_cursor_palette_blue
index|[
literal|3
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|gfb_font
name|bold8x16
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  *  * FB-generic functions  *  ****************************************************************************/
end_comment

begin_function
name|int
name|gfb_probe
parameter_list|(
name|int
name|unit
parameter_list|,
name|video_adapter_t
modifier|*
modifier|*
name|adpp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
comment|/* Assume the best... */
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|adpp
operator|=
name|vid_get_adapter
argument_list|(
name|vid_find_adapter
argument_list|(
operator|(
name|char
operator|*
operator|)
name|arg
argument_list|,
name|unit
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|error
operator|=
name|ENODEV
expr_stmt|;
else|else
operator|(
operator|*
name|adpp
operator|)
operator|->
name|va_flags
operator||=
name|V_ADP_PROBED
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_init
parameter_list|(
name|int
name|unit
parameter_list|,
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|gfb_conf
modifier|*
name|gfbc
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Assume the best... */
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|init_done
argument_list|(
name|adp
argument_list|)
condition|)
block|{
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|unit
index|]
expr_stmt|;
name|gfbc
operator|=
name|sc
operator|->
name|gfbc
expr_stmt|;
comment|/* Initialize the RAMDAC... */
call|(
modifier|*
name|gfbc
operator|->
name|ramdac_init
call|)
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Initialize the palettes... */
call|(
modifier|*
name|gfbc
operator|->
name|ramdac_load_palette
call|)
argument_list|(
name|sc
operator|->
name|adp
argument_list|,
operator|&
name|sc
operator|->
name|gfbc
operator|->
name|palette
argument_list|)
expr_stmt|;
call|(
modifier|*
name|gfbc
operator|->
name|ramdac_load_cursor_palette
call|)
argument_list|(
name|sc
operator|->
name|adp
argument_list|,
operator|&
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
argument_list|)
expr_stmt|;
comment|/* Prepare the default font... */
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|load_font
operator|)
operator|(
name|adp
operator|,
literal|0
operator|,
name|bold8x16
operator|.
name|height
operator|,
name|bold8x16
operator|.
name|width
operator|,
name|bold8x16
operator|.
name|data
operator|,
literal|0
operator|,
literal|256
operator|)
expr_stmt|;
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|=
name|gfbc
operator|->
name|fonts
index|[
literal|0
index|]
operator|.
name|width
expr_stmt|;
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|=
name|gfbc
operator|->
name|fonts
index|[
literal|0
index|]
operator|.
name|height
expr_stmt|;
comment|/* 		   Normalize vi_width and vi_height to be in terms of 		   on-screen characters, rather than pixels (*_init() 		   leaves them in terms of pixels... 		*/
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|/=
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
expr_stmt|;
name|adp
operator|->
name|va_info
operator|.
name|vi_height
operator|/=
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
expr_stmt|;
comment|/* Enable the default font... */
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|show_font
operator|)
operator|(
name|adp
operator|,
literal|0
operator|)
expr_stmt|;
comment|/* Enable future font-loading... */
name|adp
operator|->
name|va_flags
operator||=
name|V_ADP_FONT
expr_stmt|;
comment|/* Flag this initialization for this adapter... */
name|adp
operator|->
name|va_flags
operator||=
name|V_ADP_INITIALIZED
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_get_info
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|,
name|video_info_t
modifier|*
name|info
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
comment|/* Assume the best... */
name|error
operator|=
literal|0
expr_stmt|;
comment|/* 	   The info for GFB adapters does not depend on its mode, 	   so just copy it indiscriminantly (actually, we originally 	   checked the mode, but the current fb framework is somewhat 	   sloppily done in places, and assumes VGA in several places, 	   which makes such checks always fail for such GFBs as TGA)... 	*/
name|bcopy
argument_list|(
operator|&
name|adp
operator|->
name|va_info
argument_list|,
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|video_info_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_set_mode
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|adp
operator|->
name|va_mode
operator|=
name|mode
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_save_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|,
name|int
name|fontsize
parameter_list|,
name|int
name|fontwidth
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|int
name|ch
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|i
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* Check the font information... */
if|if
condition|(
operator|(
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|height
operator|!=
name|fontsize
operator|)
operator|||
operator|(
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|width
operator|!=
name|fontwidth
operator|)
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
else|else
comment|/* 		   Copy the character pixel array from our 		   very own private cache... 		*/
for|for
control|(
name|i
operator|=
name|ch
init|;
name|i
operator|<
name|count
operator|*
name|fontsize
condition|;
name|i
operator|++
control|)
name|data
index|[
name|i
index|]
operator|=
name|adp
operator|->
name|va_little_bitian
condition|?
name|BIT_REVERSE
argument_list|(
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|data
index|[
name|i
index|]
argument_list|)
else|:
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|data
index|[
name|i
index|]
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_load_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|,
name|int
name|fontsize
parameter_list|,
name|int
name|fontwidth
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|int
name|ch
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|i
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* Copy the character pixel array into our very own private cache... */
for|for
control|(
name|i
operator|=
name|ch
init|;
name|i
operator|<
name|count
operator|*
name|fontsize
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|data
index|[
name|i
index|]
operator|=
name|adp
operator|->
name|va_little_bitian
condition|?
name|BIT_REVERSE
argument_list|(
name|data
index|[
name|i
index|]
argument_list|)
else|:
name|data
index|[
name|i
index|]
expr_stmt|;
comment|/* Save the font information... */
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|height
operator|=
name|fontsize
expr_stmt|;
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|width
operator|=
name|fontwidth
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_show_font
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|page
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* Normalize adapter values... */
name|adp
operator|->
name|va_info
operator|.
name|vi_height
operator|*=
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
expr_stmt|;
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|*=
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
expr_stmt|;
comment|/* Set the current font pixels... */
name|sc
operator|->
name|gfbc
operator|->
name|font
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|data
expr_stmt|;
comment|/* Set the current font width... */
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|width
expr_stmt|;
comment|/* Set the current font height... */
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|fonts
index|[
name|page
index|]
operator|.
name|height
expr_stmt|;
comment|/* Recompute adapter values... */
name|adp
operator|->
name|va_info
operator|.
name|vi_height
operator|/=
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
expr_stmt|;
name|adp
operator|->
name|va_info
operator|.
name|vi_width
operator|/=
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_save_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|i
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
if|#
directive|if
literal|0
comment|/* If we have a RAMDAC-specific counterpart, use it... */
block|if(sc->gfbc->ramdac_save_palette) 		error = sc->gfbc->ramdac_save_palette(adp,&sc->gfbc->palette);  	else
comment|/* Otherwise, use the built-in functionality... */
block|error = sc->gfbc->builtin_save_palette(adp,&sc->gfbc->palette);
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
index|]
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|red
index|[
name|i
index|]
expr_stmt|;
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|1
index|]
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|green
index|[
name|i
index|]
expr_stmt|;
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|2
index|]
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|blue
index|[
name|i
index|]
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_load_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|i
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|red
index|[
name|i
index|]
operator|=
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
index|]
expr_stmt|;
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|green
index|[
name|i
index|]
operator|=
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|1
index|]
expr_stmt|;
name|sc
operator|->
name|gfbc
operator|->
name|palette
operator|.
name|blue
index|[
name|i
index|]
operator|=
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|2
index|]
expr_stmt|;
block|}
comment|/* If we have a RAMDAC-specific counterpart, use it... */
if|if
condition|(
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_load_palette
condition|)
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_load_palette
argument_list|(
name|adp
argument_list|,
operator|&
name|sc
operator|->
name|gfbc
operator|->
name|palette
argument_list|)
expr_stmt|;
else|else
comment|/* Otherwise, use the built-in functionality... */
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|builtin_load_palette
argument_list|(
name|adp
argument_list|,
operator|&
name|sc
operator|->
name|gfbc
operator|->
name|palette
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_set_border
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|color
parameter_list|)
block|{
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_save_state
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|void
modifier|*
name|p
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
modifier|*
name|regs
decl_stmt|;
name|regs
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|p
expr_stmt|;
name|regs
index|[
literal|0
index|]
operator|=
name|size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|size
condition|;
name|i
operator|++
control|)
name|regs
index|[
name|i
index|]
operator|=
name|READ_GFB_REGISTER
argument_list|(
name|adp
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_load_state
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int32_t
modifier|*
name|regs
decl_stmt|;
name|regs
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|p
expr_stmt|;
name|size
operator|=
name|regs
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|size
condition|;
name|i
operator|++
control|)
name|WRITE_GFB_REGISTER
argument_list|(
name|adp
argument_list|,
name|i
argument_list|,
name|regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_set_win_org
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|off_t
name|offset
parameter_list|)
block|{
name|adp
operator|->
name|va_window_orig
operator|=
name|offset
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_read_hw_cursor
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
modifier|*
name|col
parameter_list|,
name|int
modifier|*
name|row
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* If we have a RAMDAC-specific counterpart, use it... */
if|if
condition|(
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_read_hw_cursor
condition|)
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_read_hw_cursor
argument_list|(
name|adp
argument_list|,
name|col
argument_list|,
name|row
argument_list|)
expr_stmt|;
else|else
comment|/* Otherwise, use the built-in functionality... */
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|builtin_read_hw_cursor
argument_list|(
name|adp
argument_list|,
name|col
argument_list|,
name|row
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_set_hw_cursor
parameter_list|(
name|adp
parameter_list|,
name|col
parameter_list|,
name|row
parameter_list|)
name|video_adapter_t
modifier|*
name|adp
decl_stmt|;
name|int
name|col
decl_stmt|;
name|int
name|row
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* If we have a RAMDAC-specific counterpart, use it... */
if|if
condition|(
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_set_hw_cursor
condition|)
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_set_hw_cursor
argument_list|(
name|adp
argument_list|,
name|col
argument_list|,
name|row
argument_list|)
expr_stmt|;
comment|/* Otherwise, use the built-in functionality... */
else|else
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|builtin_set_hw_cursor
argument_list|(
name|adp
argument_list|,
name|col
argument_list|,
name|row
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_set_hw_cursor_shape
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|base
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|cellsize
parameter_list|,
name|int
name|blink
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* If we have a RAMDAC-specific counterpart, use it... */
if|if
condition|(
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_set_hw_cursor_shape
condition|)
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_set_hw_cursor_shape
argument_list|(
name|adp
argument_list|,
name|base
argument_list|,
name|height
argument_list|,
name|cellsize
argument_list|,
name|blink
argument_list|)
expr_stmt|;
else|else
comment|/* Otherwise, use the built-in functionality... */
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|builtin_set_hw_cursor_shape
argument_list|(
name|adp
argument_list|,
name|base
argument_list|,
name|height
argument_list|,
name|cellsize
argument_list|,
name|blink
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_mmap
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|offset
parameter_list|,
name|vm_offset_t
modifier|*
name|paddr
parameter_list|,
name|int
name|prot
parameter_list|)
block|{
comment|/* XXX */
if|if
condition|(
name|offset
operator|>
name|adp
operator|->
name|va_window_size
operator|-
name|PAGE_SIZE
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
operator|*
name|paddr
operator|=
name|adp
operator|->
name|va_info
operator|.
name|vi_window
operator|+
name|offset
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_ioctl
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|arg
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|FBIOPUTCMAP
case|:
comment|/* FALLTHROUGH */
case|case
name|FBIO_GETWINORG
case|:
comment|/* FALLTHROUGH */
case|case
name|FBIO_SETWINORG
case|:
comment|/* FALLTHROUGH */
case|case
name|FBIO_SETDISPSTART
case|:
comment|/* FALLTHROUGH */
case|case
name|FBIO_SETLINEWIDTH
case|:
comment|/* FALLTHROUGH */
case|case
name|FBIO_GETPALETTE
case|:
comment|/* FALLTHROUGH */
case|case
name|FBIOGTYPE
case|:
comment|/* FALLTHROUGH */
case|case
name|FBIOGETCMAP
case|:
comment|/* FALLTHROUGH */
default|default:
name|error
operator|=
name|fb_commonioctl
argument_list|(
name|adp
argument_list|,
name|cmd
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_fill_rect
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|val
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|cx
parameter_list|,
name|int
name|cy
parameter_list|)
block|{
name|int
name|off
decl_stmt|;
comment|/* 	   Just traverse the buffer, one pixel span at a time, setting 	   each pixel to the block-color... 	*/
for|for
control|(
name|off
operator|=
operator|(
name|x
operator|*
name|y
operator|)
init|;
name|off
operator|<
operator|(
operator|(
name|x
operator|+
name|cx
operator|)
operator|*
operator|(
name|y
operator|+
name|cy
operator|)
operator|)
condition|;
name|off
operator|++
control|)
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|putp
operator|)
operator|(
name|adp
operator|,
name|off
operator|,
literal|0x000007ff
operator|,
literal|0xffffffff
operator|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|,
literal|1
operator|,
literal|0
operator|,
literal|0
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_bitblt
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|vm_offset_t
name|src
decl_stmt|,
name|dst
decl_stmt|;
name|int
name|count
decl_stmt|,
name|i
decl_stmt|;
name|u_int32_t
name|val
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|adp
argument_list|)
expr_stmt|;
name|src
operator|=
operator|(
name|va_arg
argument_list|(
name|args
argument_list|,
name|vm_offset_t
argument_list|)
operator|+
name|adp
operator|->
name|va_window_orig
operator|)
operator|&
literal|0x0000000000fffff8
expr_stmt|;
name|dst
operator|=
operator|(
name|va_arg
argument_list|(
name|args
argument_list|,
name|vm_offset_t
argument_list|)
operator|+
name|adp
operator|->
name|va_window_orig
operator|)
operator|&
literal|0x0000000000fffff8
expr_stmt|;
name|count
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|int
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
operator|,
name|src
operator|++
operator|,
name|dst
operator|++
control|)
block|{
name|val
operator|=
name|READ_GFB_BUFFER
argument_list|(
name|adp
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|WRITE_GFB_BUFFER
argument_list|(
name|adp
argument_list|,
name|dst
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
comment|/*gfb_clear(video_adapter_t *adp, int n)*/
name|gfb_clear
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|)
block|{
name|int
name|off
decl_stmt|;
if|#
directive|if
literal|0
block|if(n == 0) 		return(0);
endif|#
directive|endif
comment|/* 	   Just traverse the buffer, one 2K-pixel span at a time, clearing 	   each pixel... 	*/
comment|/* for(off = 0; off< (n * adp->va_line_width); off += (2 KB)) */
for|for
control|(
name|off
operator|=
literal|0
init|;
name|off
operator|<
name|adp
operator|->
name|va_window_size
condition|;
name|off
operator|++
control|)
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|putp
operator|)
operator|(
name|adp
operator|,
name|off
operator|,
literal|0x000007ff
operator|,
literal|0xffffffff
operator|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|,
literal|1
operator|,
literal|0
operator|,
literal|0
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_diag
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|video_info_t
name|info
decl_stmt|;
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* Just dump everything we know about the adapter to the screen... */
name|fb_dump_adp_info
argument_list|(
name|sc
operator|->
name|driver_name
argument_list|,
name|adp
argument_list|,
name|level
argument_list|)
expr_stmt|;
comment|/* Try to get the info on this adapter... */
if|if
condition|(
operator|!
operator|(
name|error
operator|=
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|get_info
operator|)
operator|(
name|adp
operator|,
name|adp
operator|->
name|va_initial_mode
operator|,
operator|&
name|info
operator|)
operator|)
condition|)
comment|/* 		   Just dump everything we know about the adapter's mode 		   to the screen... 		*/
name|fb_dump_mode_info
argument_list|(
name|sc
operator|->
name|driver_name
argument_list|,
name|adp
argument_list|,
operator|&
name|info
argument_list|,
name|level
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_save_cursor_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
if|#
directive|if
literal|0
comment|/* If we have a RAMDAC-specific counterpart, use it... */
block|if(sc->gfbc->ramdac_save_cursor_palette) 		error = sc->gfbc->ramdac_save_cursor_palette(adp,&sc->gfbc->cursor_palette);  	else
comment|/* Otherwise, use the built-in functionality... */
block|error = sc->gfbc->builtin_save_cursor_palette(adp,&sc->gfbc->cursor_palette);
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
index|]
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|red
index|[
name|i
index|]
expr_stmt|;
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|1
index|]
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|green
index|[
name|i
index|]
expr_stmt|;
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|2
index|]
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|blue
index|[
name|i
index|]
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_load_cursor_palette
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|u_char
modifier|*
name|palette
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|red
index|[
name|i
index|]
operator|=
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
index|]
expr_stmt|;
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|green
index|[
name|i
index|]
operator|=
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|1
index|]
expr_stmt|;
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
operator|.
name|blue
index|[
name|i
index|]
operator|=
name|palette
index|[
operator|(
literal|3
operator|*
name|i
operator|)
operator|+
literal|2
index|]
expr_stmt|;
block|}
comment|/* If we have a RAMDAC-specific counterpart, use it... */
if|if
condition|(
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_load_cursor_palette
condition|)
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|ramdac_load_cursor_palette
argument_list|(
name|adp
argument_list|,
operator|&
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
argument_list|)
expr_stmt|;
else|else
comment|/* Otherwise, use the built-in functionality... */
name|error
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|builtin_load_cursor_palette
argument_list|(
name|adp
argument_list|,
operator|&
name|sc
operator|->
name|gfbc
operator|->
name|cursor_palette
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_copy
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|src
parameter_list|,
name|vm_offset_t
name|dst
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|num_pixels
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|num_pixels
operator|=
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|*
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|error
operator|=
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|bitblt
operator|)
operator|(
name|adp
operator|,
name|src
operator|*
name|num_pixels
operator|,
name|dst
operator|*
name|num_pixels
operator|,
name|n
operator|*
name|num_pixels
operator|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_putp
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|u_int32_t
name|p
parameter_list|,
name|u_int32_t
name|a
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|bpp
parameter_list|,
name|int
name|bit_ltor
parameter_list|,
name|int
name|byte_ltor
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|num_shifts
decl_stmt|;
name|u_int32_t
name|_p
decl_stmt|,
name|val
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|bpp
operator|<
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* 	    If we don't display bits right-to-left (little-bitian?), 	    then perform a bit-swap on p...     	*/
if|if
condition|(
name|bit_ltor
condition|)
block|{
name|num_shifts
operator|=
literal|8
operator|*
name|size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|_p
operator|=
literal|0
init|;
name|i
operator|<
name|num_shifts
condition|;
name|i
operator|++
operator|,
name|p
operator|>>=
literal|1
control|)
block|{
name|_p
operator|<<=
literal|1
expr_stmt|;
name|_p
operator||=
operator|(
name|p
operator|&
literal|0x00000001
operator|)
expr_stmt|;
block|}
block|}
else|else
name|_p
operator|=
name|p
expr_stmt|;
switch|switch
condition|(
name|bpp
condition|)
block|{
comment|/* Accelerate the simplest cases... */
case|case
literal|1
case|:
if|if
condition|(
operator|(
name|a
operator|&
literal|0x00000001
operator|)
operator|==
literal|0
condition|)
name|val
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|size
operator|<=
literal|0
condition|)
name|val
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|size
operator|==
literal|1
condition|)
name|val
index|[
literal|0
index|]
operator|=
name|_p
operator|&
literal|0x000000ff
expr_stmt|;
elseif|else
if|if
condition|(
name|size
operator|==
literal|2
condition|)
name|val
index|[
literal|0
index|]
operator|=
name|_p
operator|&
literal|0x0000ffff
expr_stmt|;
elseif|else
if|if
condition|(
name|size
operator|==
literal|3
condition|)
name|val
index|[
literal|0
index|]
operator|=
name|_p
operator|&
literal|0x00ffffff
expr_stmt|;
elseif|else
if|if
condition|(
name|size
operator|==
literal|4
condition|)
name|val
index|[
literal|0
index|]
operator|=
name|_p
operator|&
literal|0xffffffff
expr_stmt|;
break|break;
comment|/* Only do the following if we are not a simple case... */
case|case
literal|8
case|:
if|if
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|a
operator|&=
literal|0x000000ff
expr_stmt|;
name|val
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000001
condition|)
name|val
index|[
literal|0
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000002
condition|)
name|val
index|[
literal|0
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000004
condition|)
name|val
index|[
literal|0
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000008
condition|)
name|val
index|[
literal|0
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
name|val
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000010
condition|)
name|val
index|[
literal|1
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000020
condition|)
name|val
index|[
literal|1
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000040
condition|)
name|val
index|[
literal|1
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000080
condition|)
name|val
index|[
literal|1
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|1
condition|)
block|{
name|val
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000100
condition|)
name|val
index|[
literal|2
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000200
condition|)
name|val
index|[
literal|2
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000400
condition|)
name|val
index|[
literal|2
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000800
condition|)
name|val
index|[
literal|2
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
name|val
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00001000
condition|)
name|val
index|[
literal|3
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00002000
condition|)
name|val
index|[
literal|3
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00004000
condition|)
name|val
index|[
literal|3
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00008000
condition|)
name|val
index|[
literal|3
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|2
condition|)
block|{
name|val
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00010000
condition|)
name|val
index|[
literal|4
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00020000
condition|)
name|val
index|[
literal|4
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00040000
condition|)
name|val
index|[
literal|4
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00080000
condition|)
name|val
index|[
literal|4
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
name|val
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00100000
condition|)
name|val
index|[
literal|5
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00200000
condition|)
name|val
index|[
literal|5
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00400000
condition|)
name|val
index|[
literal|5
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00800080
condition|)
name|val
index|[
literal|5
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|3
condition|)
block|{
name|val
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x01000000
condition|)
name|val
index|[
literal|6
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x02000000
condition|)
name|val
index|[
literal|6
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x04000000
condition|)
name|val
index|[
literal|6
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x08000000
condition|)
name|val
index|[
literal|6
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
name|val
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x10000000
condition|)
name|val
index|[
literal|7
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x20000000
condition|)
name|val
index|[
literal|7
index|]
operator||=
operator|(
name|a
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x40000000
condition|)
name|val
index|[
literal|7
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x80000000
condition|)
name|val
index|[
literal|7
index|]
operator||=
operator|(
name|a
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
break|break;
case|case
literal|16
case|:
if|if
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|a
operator|&=
literal|0x0000ffff
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000001
condition|)
name|val
index|[
literal|0
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000002
condition|)
name|val
index|[
literal|0
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000004
condition|)
name|val
index|[
literal|1
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000008
condition|)
name|val
index|[
literal|1
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000010
condition|)
name|val
index|[
literal|2
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000020
condition|)
name|val
index|[
literal|2
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000040
condition|)
name|val
index|[
literal|3
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000080
condition|)
name|val
index|[
literal|3
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|_p
operator|&
literal|0x00000100
condition|)
name|val
index|[
literal|4
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000200
condition|)
name|val
index|[
literal|4
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000400
condition|)
name|val
index|[
literal|5
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000800
condition|)
name|val
index|[
literal|5
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00001000
condition|)
name|val
index|[
literal|6
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00002000
condition|)
name|val
index|[
literal|6
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00004000
condition|)
name|val
index|[
literal|7
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00008000
condition|)
name|val
index|[
literal|7
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|_p
operator|&
literal|0x00010000
condition|)
name|val
index|[
literal|8
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00020000
condition|)
name|val
index|[
literal|8
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00040000
condition|)
name|val
index|[
literal|9
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00080000
condition|)
name|val
index|[
literal|9
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00100000
condition|)
name|val
index|[
literal|10
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00200000
condition|)
name|val
index|[
literal|10
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00400000
condition|)
name|val
index|[
literal|11
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00800000
condition|)
name|val
index|[
literal|11
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|3
condition|)
block|{
if|if
condition|(
name|_p
operator|&
literal|0x01000000
condition|)
name|val
index|[
literal|12
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x02000000
condition|)
name|val
index|[
literal|12
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x04000000
condition|)
name|val
index|[
literal|13
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x08000000
condition|)
name|val
index|[
literal|13
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x10000000
condition|)
name|val
index|[
literal|14
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x20000000
condition|)
name|val
index|[
literal|14
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x40000000
condition|)
name|val
index|[
literal|15
index|]
operator||=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x80000000
condition|)
name|val
index|[
literal|15
index|]
operator||=
operator|(
name|a
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
break|break;
case|case
literal|32
case|:
if|if
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|a
operator|&=
literal|0xffffffff
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000001
condition|)
name|val
index|[
literal|0
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000002
condition|)
name|val
index|[
literal|1
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000004
condition|)
name|val
index|[
literal|2
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000008
condition|)
name|val
index|[
literal|3
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000010
condition|)
name|val
index|[
literal|4
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000020
condition|)
name|val
index|[
literal|5
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000040
condition|)
name|val
index|[
literal|6
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000080
condition|)
name|val
index|[
literal|7
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|_p
operator|&
literal|0x00000100
condition|)
name|val
index|[
literal|8
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000200
condition|)
name|val
index|[
literal|9
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000400
condition|)
name|val
index|[
literal|10
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00000800
condition|)
name|val
index|[
literal|11
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00001000
condition|)
name|val
index|[
literal|12
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00002000
condition|)
name|val
index|[
literal|13
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00004000
condition|)
name|val
index|[
literal|14
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00008000
condition|)
name|val
index|[
literal|15
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|_p
operator|&
literal|0x00010000
condition|)
name|val
index|[
literal|16
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00020000
condition|)
name|val
index|[
literal|17
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00040000
condition|)
name|val
index|[
literal|18
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00080000
condition|)
name|val
index|[
literal|19
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00100000
condition|)
name|val
index|[
literal|20
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00200000
condition|)
name|val
index|[
literal|21
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00400000
condition|)
name|val
index|[
literal|22
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x00800000
condition|)
name|val
index|[
literal|23
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>
literal|3
condition|)
block|{
if|if
condition|(
name|_p
operator|&
literal|0x01000000
condition|)
name|val
index|[
literal|24
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x02000000
condition|)
name|val
index|[
literal|25
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x04000000
condition|)
name|val
index|[
literal|26
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x08000000
condition|)
name|val
index|[
literal|27
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x10000000
condition|)
name|val
index|[
literal|28
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x20000000
condition|)
name|val
index|[
literal|29
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x40000000
condition|)
name|val
index|[
literal|30
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
if|if
condition|(
name|_p
operator|&
literal|0x80000000
condition|)
name|val
index|[
literal|31
index|]
operator|=
operator|(
name|a
operator|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
name|j
operator|=
operator|(
name|bpp
operator|==
literal|1
operator|)
condition|?
literal|1
else|:
name|bpp
operator|*
name|size
operator|/
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
expr_stmt|;
comment|/* 	    If we don't display bytes right-to-left (little-endian), 	    then perform a byte-swap on p (we don't have to swap if 	    bpp == 1 and val[0] == 0)... 	*/
if|if
condition|(
operator|(
name|byte_ltor
operator|)
operator|&&
operator|(
name|j
operator|>
literal|1
operator|)
operator|&&
operator|(
name|val
index|[
name|j
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|j
operator|-
name|i
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|_p
operator|=
name|val
index|[
name|j
operator|-
name|i
index|]
expr_stmt|;
name|val
index|[
name|j
operator|-
name|i
index|]
operator|=
name|val
index|[
name|i
index|]
expr_stmt|;
name|val
index|[
name|i
index|]
operator|=
name|_p
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
name|_p
operator|=
name|val
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
operator|,
name|val
index|[
name|i
index|]
operator|=
literal|0
init|;
name|k
operator|<
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
condition|;
name|k
operator|++
operator|,
name|_p
operator|>>=
literal|8
control|)
block|{
name|val
index|[
name|i
index|]
operator|<<=
literal|8
expr_stmt|;
name|val
index|[
name|i
index|]
operator||=
operator|(
name|_p
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
comment|/* Write the pixel-row... */
name|WRITE_GFB_BUFFER
argument_list|(
name|adp
argument_list|,
operator|(
name|off
operator|+
name|i
operator|)
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_putc
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|u_int8_t
name|c
parameter_list|,
name|u_int8_t
name|a
parameter_list|)
block|{
name|vm_offset_t
name|poff
decl_stmt|;
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|pixel_size
decl_stmt|;
name|u_int
name|row
decl_stmt|,
name|col
decl_stmt|;
name|u_int8_t
modifier|*
name|pixel
decl_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
name|pixel_size
operator|=
name|adp
operator|->
name|va_info
operator|.
name|vi_depth
operator|/
literal|8
expr_stmt|;
comment|/* Get the start of the array of pixels rows for this character... */
name|pixel
operator|=
name|sc
operator|->
name|gfbc
operator|->
name|font
operator|+
operator|(
name|c
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|)
expr_stmt|;
comment|/* Calculate the new cursor position... */
name|row
operator|=
name|off
operator|/
name|adp
operator|->
name|va_info
operator|.
name|vi_width
expr_stmt|;
name|col
operator|=
name|off
operator|%
name|adp
operator|->
name|va_info
operator|.
name|vi_width
expr_stmt|;
comment|/* Iterate over all the pixel rows for this character... */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get the address of the character's pixel-row... */
name|poff
operator|=
operator|(
operator|(
name|col
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cwidth
operator|*
name|pixel_size
operator|)
operator|+
operator|(
operator|(
operator|(
name|row
operator|*
name|adp
operator|->
name|va_info
operator|.
name|vi_cheight
operator|)
operator|+
name|i
operator|)
operator|*
name|adp
operator|->
name|va_line_width
operator|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
expr_stmt|;
comment|/* Now display the current pixel row... */
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|putp
operator|)
operator|(
name|adp
operator|,
name|poff
operator|,
name|pixel
index|[
name|i
index|]
operator|,
name|a
operator|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
operator|,
literal|1
operator|,
literal|1
operator|,
literal|0
operator|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_puts
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|vm_offset_t
name|off
parameter_list|,
name|u_int16_t
modifier|*
name|s
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|gfb_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|gfb_device_softcs
index|[
name|adp
operator|->
name|va_model
index|]
index|[
name|adp
operator|->
name|va_unit
index|]
expr_stmt|;
comment|/* If the string in empty, just return now... */
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|putc
operator|)
operator|(
name|adp
operator|,
name|off
operator|+
name|i
operator|,
name|s
index|[
name|i
index|]
operator|&
literal|0x00ff
operator|,
operator|(
name|s
index|[
name|i
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_putm
parameter_list|(
name|video_adapter_t
modifier|*
name|adp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|u_int8_t
modifier|*
name|pixel_image
parameter_list|,
name|u_int32_t
name|pixel_mask
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|width
parameter_list|)
block|{
name|vm_offset_t
name|poff
decl_stmt|;
name|int
name|i
decl_stmt|,
name|pixel_size
decl_stmt|;
name|pixel_size
operator|=
name|adp
operator|->
name|va_info
operator|.
name|vi_depth
operator|/
literal|8
expr_stmt|;
comment|/* Iterate over all the pixel rows for the mouse pointer... */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get the address of the mouse pointer's pixel-row... */
name|poff
operator|=
operator|(
operator|(
name|x
operator|*
name|pixel_size
operator|)
operator|+
operator|(
operator|(
name|y
operator|+
name|i
operator|)
operator|*
name|adp
operator|->
name|va_line_width
operator|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
expr_stmt|;
comment|/* Now display the current pixel-row... */
operator|(
operator|*
name|vidsw
index|[
name|adp
operator|->
name|va_index
index|]
operator|->
name|putp
operator|)
operator|(
name|adp
operator|,
name|poff
operator|,
name|pixel_image
index|[
name|i
index|]
operator|,
name|pixel_mask
operator|,
sizeof|sizeof
argument_list|(
name|u_int8_t
argument_list|)
operator|,
literal|1
operator|,
literal|1
operator|,
literal|0
operator|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|gfb_error
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


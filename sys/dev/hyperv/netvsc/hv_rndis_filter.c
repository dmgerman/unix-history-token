begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2012 Microsoft Corp.  * Copyright (c) 2010-2012 Citrix Inc.  * Copyright (c) 2012 NetApp Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/hyperv.h>
end_include

begin_include
include|#
directive|include
file|"hv_net_vsc.h"
end_include

begin_include
include|#
directive|include
file|"hv_rndis.h"
end_include

begin_include
include|#
directive|include
file|"hv_rndis_filter.h"
end_include

begin_comment
comment|/*  * Forward declarations  */
end_comment

begin_function_decl
specifier|static
name|int
name|hv_rf_send_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|,
name|uint32_t
name|message_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_response
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|message
parameter_list|,
name|netvsc_packet
modifier|*
name|pkt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_query_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
name|void
modifier|*
name|result
parameter_list|,
name|uint32_t
modifier|*
name|result_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_set_packet_filter
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|new_filter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_open_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_close_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_on_send_request_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_on_send_request_halt_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|hv_rf_send_offload_request
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|rndis_offload_params
modifier|*
name|offloads
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Set the Per-Packet-Info with the specified type  */
end_comment

begin_function
name|void
modifier|*
name|hv_set_rppi_data
parameter_list|(
name|rndis_msg
modifier|*
name|rndis_mesg
parameter_list|,
name|uint32_t
name|rppi_size
parameter_list|,
name|int
name|pkt_type
parameter_list|)
block|{
name|rndis_packet
modifier|*
name|rndis_pkt
decl_stmt|;
name|rndis_per_packet_info
modifier|*
name|rppi
decl_stmt|;
name|rndis_pkt
operator|=
operator|&
name|rndis_mesg
operator|->
name|msg
operator|.
name|packet
expr_stmt|;
name|rndis_pkt
operator|->
name|data_offset
operator|+=
name|rppi_size
expr_stmt|;
name|rppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rndis_pkt
operator|+
name|rndis_pkt
operator|->
name|per_pkt_info_offset
operator|+
name|rndis_pkt
operator|->
name|per_pkt_info_length
operator|)
expr_stmt|;
name|rppi
operator|->
name|size
operator|=
name|rppi_size
expr_stmt|;
name|rppi
operator|->
name|type
operator|=
name|pkt_type
expr_stmt|;
name|rppi
operator|->
name|per_packet_info_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
expr_stmt|;
name|rndis_pkt
operator|->
name|per_pkt_info_length
operator|+=
name|rppi_size
expr_stmt|;
return|return
operator|(
name|rppi
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get the Per-Packet-Info with the specified type  * return NULL if not found.  */
end_comment

begin_function
name|void
modifier|*
name|hv_get_ppi_data
parameter_list|(
name|rndis_packet
modifier|*
name|rpkt
parameter_list|,
name|uint32_t
name|type
parameter_list|)
block|{
name|rndis_per_packet_info
modifier|*
name|ppi
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|rpkt
operator|->
name|per_pkt_info_offset
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|rpkt
operator|+
name|rpkt
operator|->
name|per_pkt_info_offset
operator|)
expr_stmt|;
name|len
operator|=
name|rpkt
operator|->
name|per_pkt_info_length
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ppi
operator|->
name|type
operator|==
name|type
condition|)
return|return
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|ppi
operator|+
name|ppi
operator|->
name|per_packet_info_offset
operator|)
return|;
name|len
operator|-=
name|ppi
operator|->
name|size
expr_stmt|;
name|ppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|ppi
operator|+
name|ppi
operator|->
name|size
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allow module_param to work and override to switch to promiscuous mode.  */
end_comment

begin_function
specifier|static
specifier|inline
name|rndis_device
modifier|*
name|hv_get_rndis_device
parameter_list|(
name|void
parameter_list|)
block|{
name|rndis_device
modifier|*
name|device
decl_stmt|;
name|device
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rndis_device
argument_list|)
argument_list|,
name|M_NETVSC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|,
literal|"HV-FRL"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
comment|/* Same effect as STAILQ_HEAD_INITIALIZER() static initializer */
name|STAILQ_INIT
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|)
expr_stmt|;
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
return|return
operator|(
name|device
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|hv_put_rndis_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|device
argument_list|,
name|M_NETVSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|rndis_request
modifier|*
name|hv_rndis_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|message_type
parameter_list|,
name|uint32_t
name|message_length
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_msg
modifier|*
name|rndis_mesg
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|request
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rndis_request
argument_list|)
argument_list|,
name|M_NETVSC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|0
argument_list|,
literal|"rndis sema"
argument_list|)
expr_stmt|;
name|rndis_mesg
operator|=
operator|&
name|request
operator|->
name|request_msg
expr_stmt|;
name|rndis_mesg
operator|->
name|ndis_msg_type
operator|=
name|message_type
expr_stmt|;
name|rndis_mesg
operator|->
name|msg_len
operator|=
name|message_length
expr_stmt|;
comment|/* 	 * Set the request id. This field is always after the rndis header 	 * for request/response packet types so we just use the set_request 	 * as a template. 	 */
name|set
operator|=
operator|&
name|rndis_mesg
operator|->
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|request_id
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|device
operator|->
name|new_request_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Increment to get the new value (call above returns old value) */
name|set
operator|->
name|request_id
operator|+=
literal|1
expr_stmt|;
comment|/* Add to the request list */
name|mtx_lock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|,
name|request
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|request
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|hv_put_rndis_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
comment|/* Fixme:  Has O(n) performance */
comment|/* 	 * XXXKYS: Use Doubly linked lists. 	 */
name|STAILQ_REMOVE
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|,
name|request
argument_list|,
name|rndis_request_
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|sema_destroy
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|request
argument_list|,
name|M_NETVSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_send_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|,
name|uint32_t
name|message_type
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|netvsc_packet
modifier|*
name|packet
decl_stmt|;
comment|/* Set up the packet to send it */
name|packet
operator|=
operator|&
name|request
operator|->
name|pkt
expr_stmt|;
name|packet
operator|->
name|is_data_pkt
operator|=
name|FALSE
expr_stmt|;
name|packet
operator|->
name|tot_data_buf_len
operator|=
name|request
operator|->
name|request_msg
operator|.
name|msg_len
expr_stmt|;
name|packet
operator|->
name|page_buf_count
operator|=
literal|1
expr_stmt|;
name|packet
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|pfn
operator|=
name|hv_get_phys_addr
argument_list|(
operator|&
name|request
operator|->
name|request_msg
argument_list|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|packet
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|request
operator|->
name|request_msg
operator|.
name|msg_len
expr_stmt|;
name|packet
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|request
operator|->
name|request_msg
operator|&
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|send_completion_context
operator|=
name|request
expr_stmt|;
comment|/* packet */
if|if
condition|(
name|message_type
operator|!=
name|REMOTE_NDIS_HALT_MSG
condition|)
block|{
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|on_send_completion
operator|=
name|hv_rf_on_send_request_completion
expr_stmt|;
block|}
else|else
block|{
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|on_send_completion
operator|=
name|hv_rf_on_send_request_halt_completion
expr_stmt|;
block|}
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|send_completion_tid
operator|=
operator|(
name|unsigned
name|long
operator|)
name|device
expr_stmt|;
name|packet
operator|->
name|send_buf_section_idx
operator|=
name|NVSP_1_CHIMNEY_SEND_INVALID_SECTION_INDEX
expr_stmt|;
name|packet
operator|->
name|send_buf_section_size
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|hv_nv_on_send
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
name|packet
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive response  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_response
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|rndis_request
modifier|*
name|next_request
decl_stmt|;
name|boolean_t
name|found
init|=
name|FALSE
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|request
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * All request/response message contains request_id as the 		 * first field 		 */
if|if
condition|(
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|init_request
operator|.
name|request_id
operator|==
name|response
operator|->
name|msg
operator|.
name|init_complete
operator|.
name|request_id
condition|)
block|{
name|found
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|next_request
operator|=
name|STAILQ_NEXT
argument_list|(
name|request
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|request
operator|=
name|next_request
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|found
condition|)
block|{
if|if
condition|(
name|response
operator|->
name|msg_len
operator|<=
sizeof|sizeof
argument_list|(
name|rndis_msg
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|request
operator|->
name|response_msg
argument_list|,
name|response
argument_list|,
name|response
operator|->
name|msg_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|response
operator|->
name|ndis_msg_type
operator|==
name|REMOTE_NDIS_RESET_CMPLT
condition|)
block|{
comment|/* Does not have a request id field */
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|reset_complete
operator|.
name|status
operator|=
name|STATUS_BUFFER_OVERFLOW
expr_stmt|;
block|}
else|else
block|{
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|init_complete
operator|.
name|status
operator|=
name|STATUS_BUFFER_OVERFLOW
expr_stmt|;
block|}
block|}
name|sema_post
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|hv_rf_send_offload_request
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|rndis_offload_params
modifier|*
name|offloads
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|rndis_offload_params
modifier|*
name|offload_req
decl_stmt|;
name|rndis_set_complete
modifier|*
name|set_complete
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|device_t
name|dev
init|=
name|device
operator|->
name|device
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
name|uint32_t
name|vsp_version
init|=
name|net_dev
operator|->
name|nvsp_version
decl_stmt|;
name|uint32_t
name|extlen
init|=
sizeof|sizeof
argument_list|(
name|rndis_offload_params
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|vsp_version
operator|<=
name|NVSP_PROTOCOL_VERSION_4
condition|)
block|{
name|extlen
operator|=
name|VERSION_4_OFFLOAD_SIZE
expr_stmt|;
comment|/* On NVSP_PROTOCOL_VERSION_4 and below, we do not support 		 * UDP checksum offload. 		 */
name|offloads
operator|->
name|udp_ipv4_csum
operator|=
literal|0
expr_stmt|;
name|offloads
operator|->
name|udp_ipv6_csum
operator|=
literal|0
expr_stmt|;
block|}
name|rndis_dev
operator|=
name|net_dev
operator|->
name|extension
expr_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|rndis_dev
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_set_request
argument_list|)
operator|+
name|extlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|set
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|oid
operator|=
name|RNDIS_OID_TCP_OFFLOAD_PARAMETERS
expr_stmt|;
name|set
operator|->
name|info_buffer_length
operator|=
name|extlen
expr_stmt|;
name|set
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
expr_stmt|;
name|set
operator|->
name|device_vc_handle
operator|=
literal|0
expr_stmt|;
name|offload_req
operator|=
operator|(
name|rndis_offload_params
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|set
operator|+
name|set
operator|->
name|info_buffer_offset
operator|)
expr_stmt|;
operator|*
name|offload_req
operator|=
operator|*
name|offloads
expr_stmt|;
name|offload_req
operator|->
name|header
operator|.
name|type
operator|=
name|RNDIS_OBJECT_TYPE_DEFAULT
expr_stmt|;
name|offload_req
operator|->
name|header
operator|.
name|revision
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_REVISION_3
expr_stmt|;
name|offload_req
operator|->
name|header
operator|.
name|size
operator|=
name|extlen
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|rndis_dev
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv send offload request failed, ret=%d!\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|ret
operator|=
name|sema_timedwait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|5
operator|*
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv send offload request timeout\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|set_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|set_complete
expr_stmt|;
if|if
condition|(
name|set_complete
operator|->
name|status
operator|==
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv send offload request succeeded\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|set_complete
operator|->
name|status
operator|==
name|STATUS_NOT_SUPPORTED
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"HV Not support offload\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|set_complete
operator|->
name|status
expr_stmt|;
block|}
block|}
name|cleanup
label|:
if|if
condition|(
name|request
condition|)
name|hv_put_rndis_request
argument_list|(
name|rndis_dev
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive indicate status  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
block|{
name|rndis_indicate_status
modifier|*
name|indicate
init|=
operator|&
name|response
operator|->
name|msg
operator|.
name|indicate_status
decl_stmt|;
switch|switch
condition|(
name|indicate
operator|->
name|status
condition|)
block|{
case|case
name|RNDIS_STATUS_MEDIA_CONNECT
case|:
name|netvsc_linkstatus_callback
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RNDIS_STATUS_MEDIA_DISCONNECT
case|:
name|netvsc_linkstatus_callback
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* TODO: */
name|device_printf
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
operator|->
name|device
argument_list|,
literal|"unknown status %d received\n"
argument_list|,
name|indicate
operator|->
name|status
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive data  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|message
parameter_list|,
name|netvsc_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|rndis_packet
modifier|*
name|rndis_pkt
decl_stmt|;
name|ndis_8021q_info
modifier|*
name|rppi_vlan_info
decl_stmt|;
name|uint32_t
name|data_offset
decl_stmt|;
name|rndis_tcp_ip_csum_info
modifier|*
name|csum_info
init|=
name|NULL
decl_stmt|;
name|device_t
name|dev
init|=
name|device
operator|->
name|net_dev
operator|->
name|dev
operator|->
name|device
decl_stmt|;
name|rndis_pkt
operator|=
operator|&
name|message
operator|->
name|msg
operator|.
name|packet
expr_stmt|;
comment|/* 	 * Fixme:  Handle multiple rndis pkt msgs that may be enclosed in this 	 * netvsc packet (ie tot_data_buf_len != message_length) 	 */
comment|/* Remove rndis header, then pass data packet up the stack */
name|data_offset
operator|=
name|RNDIS_HEADER_SIZE
operator|+
name|rndis_pkt
operator|->
name|data_offset
expr_stmt|;
name|pkt
operator|->
name|tot_data_buf_len
operator|-=
name|data_offset
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|tot_data_buf_len
operator|<
name|rndis_pkt
operator|->
name|data_length
condition|)
block|{
name|pkt
operator|->
name|status
operator|=
name|nvsp_status_failure
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"total length %u is less than data length %u\n"
argument_list|,
name|pkt
operator|->
name|tot_data_buf_len
argument_list|,
name|rndis_pkt
operator|->
name|data_length
argument_list|)
expr_stmt|;
return|return;
block|}
name|pkt
operator|->
name|tot_data_buf_len
operator|=
name|rndis_pkt
operator|->
name|data_length
expr_stmt|;
name|pkt
operator|->
name|data
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|pkt
operator|->
name|data
operator|+
name|data_offset
operator|)
expr_stmt|;
name|rppi_vlan_info
operator|=
name|hv_get_ppi_data
argument_list|(
name|rndis_pkt
argument_list|,
name|ieee_8021q_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rppi_vlan_info
condition|)
block|{
name|pkt
operator|->
name|vlan_tci
operator|=
name|rppi_vlan_info
operator|->
name|u1
operator|.
name|s1
operator|.
name|vlan_id
expr_stmt|;
block|}
else|else
block|{
name|pkt
operator|->
name|vlan_tci
operator|=
literal|0
expr_stmt|;
block|}
name|csum_info
operator|=
name|hv_get_ppi_data
argument_list|(
name|rndis_pkt
argument_list|,
name|tcpip_chksum_info
argument_list|)
expr_stmt|;
name|netvsc_recv
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
name|pkt
argument_list|,
name|csum_info
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on receive  */
end_comment

begin_function
name|int
name|hv_rf_on_receive
parameter_list|(
name|netvsc_dev
modifier|*
name|net_dev
parameter_list|,
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|netvsc_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|rndis_msg
modifier|*
name|rndis_hdr
decl_stmt|;
comment|/* Make sure the rndis device state is initialized */
if|if
condition|(
name|net_dev
operator|->
name|extension
operator|==
name|NULL
condition|)
block|{
name|pkt
operator|->
name|status
operator|=
name|nvsp_status_failure
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
name|rndis_dev
operator|=
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
expr_stmt|;
if|if
condition|(
name|rndis_dev
operator|->
name|state
operator|==
name|RNDIS_DEV_UNINITIALIZED
condition|)
block|{
name|pkt
operator|->
name|status
operator|=
name|nvsp_status_failure
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|rndis_hdr
operator|=
name|pkt
operator|->
name|data
expr_stmt|;
switch|switch
condition|(
name|rndis_hdr
operator|->
name|ndis_msg_type
condition|)
block|{
comment|/* data message */
case|case
name|REMOTE_NDIS_PACKET_MSG
case|:
name|hv_rf_receive_data
argument_list|(
name|rndis_dev
argument_list|,
name|rndis_hdr
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
break|break;
comment|/* completion messages */
case|case
name|REMOTE_NDIS_INITIALIZE_CMPLT
case|:
case|case
name|REMOTE_NDIS_QUERY_CMPLT
case|:
case|case
name|REMOTE_NDIS_SET_CMPLT
case|:
case|case
name|REMOTE_NDIS_RESET_CMPLT
case|:
case|case
name|REMOTE_NDIS_KEEPALIVE_CMPLT
case|:
name|hv_rf_receive_response
argument_list|(
name|rndis_dev
argument_list|,
name|rndis_hdr
argument_list|)
expr_stmt|;
break|break;
comment|/* notification message */
case|case
name|REMOTE_NDIS_INDICATE_STATUS_MSG
case|:
name|hv_rf_receive_indicate_status
argument_list|(
name|rndis_dev
argument_list|,
name|rndis_hdr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"hv_rf_on_receive():  Unknown msg_type 0x%x\n"
argument_list|,
name|rndis_hdr
operator|->
name|ndis_msg_type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_query_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
name|void
modifier|*
name|result
parameter_list|,
name|uint32_t
modifier|*
name|result_size
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|uint32_t
name|in_result_size
init|=
operator|*
name|result_size
decl_stmt|;
name|rndis_query_request
modifier|*
name|query
decl_stmt|;
name|rndis_query_complete
modifier|*
name|query_complete
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
operator|*
name|result_size
operator|=
literal|0
expr_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_QUERY_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_query_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis query */
name|query
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|query_request
expr_stmt|;
name|query
operator|->
name|oid
operator|=
name|oid
expr_stmt|;
name|query
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_query_request
argument_list|)
expr_stmt|;
name|query
operator|->
name|info_buffer_length
operator|=
literal|0
expr_stmt|;
name|query
operator|->
name|device_vc_handle
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_QUERY_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* Fixme:  printf added */
name|printf
argument_list|(
literal|"RNDISFILTER request failed to Send!\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|sema_wait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
comment|/* Copy the response back */
name|query_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|query_complete
expr_stmt|;
if|if
condition|(
name|query_complete
operator|->
name|info_buffer_length
operator|>
name|in_result_size
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|memcpy
argument_list|(
name|result
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|query_complete
operator|+
name|query_complete
operator|->
name|info_buffer_offset
operator|)
argument_list|,
name|query_complete
operator|->
name|info_buffer_length
argument_list|)
expr_stmt|;
operator|*
name|result_size
operator|=
name|query_complete
operator|->
name|info_buffer_length
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device MAC address  */
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|uint32_t
name|size
init|=
name|HW_MACADDR_LEN
decl_stmt|;
return|return
operator|(
name|hv_rf_query_device
argument_list|(
name|device
argument_list|,
name|RNDIS_OID_802_3_PERMANENT_ADDRESS
argument_list|,
name|device
operator|->
name|hw_mac_addr
argument_list|,
operator|&
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device link status  */
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|uint32_t
name|size
init|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
decl_stmt|;
return|return
operator|(
name|hv_rf_query_device
argument_list|(
name|device
argument_list|,
name|RNDIS_OID_GEN_MEDIA_CONNECT_STATUS
argument_list|,
operator|&
name|device
operator|->
name|link_status
argument_list|,
operator|&
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter set packet filter  * Sends an rndis request with the new filter, then waits for a response  * from the host.  * Returns zero on success, non-zero on failure.  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_set_packet_filter
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|new_filter
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|rndis_set_complete
modifier|*
name|set_complete
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_set_request
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis set */
name|set
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|oid
operator|=
name|RNDIS_OID_GEN_CURRENT_PACKET_FILTER
expr_stmt|;
name|set
operator|->
name|info_buffer_length
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|set
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|set
operator|+
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
operator|)
argument_list|,
operator|&
name|new_filter
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Wait for the response from the host.  Another thread will signal 	 * us when the response has arrived.  In the failure case, 	 * sema_timedwait() returns a non-zero status after waiting 5 seconds. 	 */
name|ret
operator|=
name|sema_timedwait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|5
operator|*
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
comment|/* Response received, check status */
name|set_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|set_complete
expr_stmt|;
name|status
operator|=
name|set_complete
operator|->
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
comment|/* Bad response status, return error */
name|ret
operator|=
operator|-
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * We cannot deallocate the request since we may still 		 * receive a send completion for it. 		 */
goto|goto
name|exit
goto|;
block|}
name|cleanup
label|:
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
name|exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter init device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_initialize_request
modifier|*
name|init
decl_stmt|;
name|rndis_initialize_complete
modifier|*
name|init_complete
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_INITIALIZE_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_initialize_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis set */
name|init
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|init_request
expr_stmt|;
name|init
operator|->
name|major_version
operator|=
name|RNDIS_MAJOR_VERSION
expr_stmt|;
name|init
operator|->
name|minor_version
operator|=
name|RNDIS_MINOR_VERSION
expr_stmt|;
comment|/* 	 * Per the RNDIS document, this should be set to the max MTU 	 * plus the header size.  However, 2048 works fine, so leaving 	 * it as is. 	 */
name|init
operator|->
name|max_xfer_size
operator|=
literal|2048
expr_stmt|;
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZING
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_INITIALIZE_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|sema_wait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
name|init_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|init_complete
expr_stmt|;
name|status
operator|=
name|init_complete
operator|->
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZED
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|cleanup
label|:
if|if
condition|(
name|request
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|HALT_COMPLETION_WAIT_COUNT
value|25
end_define

begin_comment
comment|/*  * RNDIS filter halt device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_halt_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_halt_request
modifier|*
name|halt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
comment|/* Attempt to do a rndis device halt */
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_HALT_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_halt_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* initialize "poor man's semaphore" */
name|request
operator|->
name|halt_complete_flag
operator|=
literal|0
expr_stmt|;
comment|/* Set up the rndis set */
name|halt
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|halt_request
expr_stmt|;
name|halt
operator|->
name|request_id
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|device
operator|->
name|new_request_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Increment to get the new value (call above returns old value) */
name|halt
operator|->
name|request_id
operator|+=
literal|1
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_HALT_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Wait for halt response from halt callback.  We must wait for 	 * the transaction response before freeing the request and other 	 * resources. 	 */
for|for
control|(
name|i
operator|=
name|HALT_COMPLETION_WAIT_COUNT
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|request
operator|->
name|halt_complete_flag
operator|!=
literal|0
condition|)
block|{
break|break;
block|}
name|DELAY
argument_list|(
literal|400
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter open device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_open_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|device
operator|->
name|state
operator|!=
name|RNDIS_DEV_INITIALIZED
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|hv_promisc_mode
operator|!=
literal|1
condition|)
block|{
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
name|NDIS_PACKET_TYPE_BROADCAST
operator||
name|NDIS_PACKET_TYPE_ALL_MULTICAST
operator||
name|NDIS_PACKET_TYPE_DIRECTED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
name|NDIS_PACKET_TYPE_PROMISCUOUS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_DATAINITIALIZED
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter close device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_close_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|device
operator|->
name|state
operator|!=
name|RNDIS_DEV_DATAINITIALIZED
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZED
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device add  */
end_comment

begin_function
name|int
name|hv_rf_on_device_add
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|void
modifier|*
name|additl_info
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|rndis_offload_params
name|offloads
decl_stmt|;
name|netvsc_device_info
modifier|*
name|dev_info
init|=
operator|(
name|netvsc_device_info
operator|*
operator|)
name|additl_info
decl_stmt|;
name|device_t
name|dev
init|=
name|device
operator|->
name|device
decl_stmt|;
name|rndis_dev
operator|=
name|hv_get_rndis_device
argument_list|()
expr_stmt|;
if|if
condition|(
name|rndis_dev
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* 	 * Let the inner driver handle this first to create the netvsc channel 	 * NOTE! Once the channel is created, we may get a receive callback  	 * (hv_rf_on_receive()) before this call is completed. 	 * Note:  Earlier code used a function pointer here. 	 */
name|net_dev
operator|=
name|hv_nv_on_device_add
argument_list|(
name|device
argument_list|,
name|additl_info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|net_dev
condition|)
block|{
name|hv_put_rndis_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* 	 * Initialize the rndis device 	 */
name|net_dev
operator|->
name|extension
operator|=
name|rndis_dev
expr_stmt|;
name|rndis_dev
operator|->
name|net_dev
operator|=
name|net_dev
expr_stmt|;
comment|/* Send the rndis initialization message */
name|ret
operator|=
name|hv_rf_init_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* 		 * TODO: If rndis init failed, we will need to shut down 		 * the channel 		 */
block|}
comment|/* Get the mac address */
name|ret
operator|=
name|hv_rf_query_device_mac
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* TODO: shut down rndis device and the channel */
block|}
comment|/* config csum offload and send request to host */
name|memset
argument_list|(
operator|&
name|offloads
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|offloads
argument_list|)
argument_list|)
expr_stmt|;
name|offloads
operator|.
name|ipv4_csum
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_TX_RX_ENABLED
expr_stmt|;
name|offloads
operator|.
name|tcp_ipv4_csum
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_TX_RX_ENABLED
expr_stmt|;
name|offloads
operator|.
name|udp_ipv4_csum
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_TX_RX_ENABLED
expr_stmt|;
name|offloads
operator|.
name|tcp_ipv6_csum
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_TX_RX_ENABLED
expr_stmt|;
name|offloads
operator|.
name|udp_ipv6_csum
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_TX_RX_ENABLED
expr_stmt|;
name|offloads
operator|.
name|lso_v2_ipv4
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_LSOV2_ENABLED
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_offload_request
argument_list|(
name|device
argument_list|,
operator|&
name|offloads
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* TODO: shut down rndis device and the channel */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv_rf_send_offload_request failed, ret=%d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|dev_info
operator|->
name|mac_addr
argument_list|,
name|rndis_dev
operator|->
name|hw_mac_addr
argument_list|,
name|HW_MACADDR_LEN
argument_list|)
expr_stmt|;
name|hv_rf_query_device_link_status
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|dev_info
operator|->
name|link_state
operator|=
name|rndis_dev
operator|->
name|link_status
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device remove  */
end_comment

begin_function
name|int
name|hv_rf_on_device_remove
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|boolean_t
name|destroy_channel
parameter_list|)
block|{
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
init|=
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Halt and release the rndis device */
name|ret
operator|=
name|hv_rf_halt_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|hv_put_rndis_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|net_dev
operator|->
name|extension
operator|=
name|NULL
expr_stmt|;
comment|/* Pass control to inner driver to remove the device */
name|ret
operator||=
name|hv_nv_on_device_remove
argument_list|(
name|device
argument_list|,
name|destroy_channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on open  */
end_comment

begin_function
name|int
name|hv_rf_on_open
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|)
block|{
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
return|return
operator|(
name|hv_rf_open_device
argument_list|(
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on close  */
end_comment

begin_function
name|int
name|hv_rf_on_close
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|)
block|{
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
return|return
operator|(
name|hv_rf_close_device
argument_list|(
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on send request completion callback  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_on_send_request_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*  * RNDIS filter on send request (halt only) completion callback  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_on_send_request_halt_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
init|=
name|context
decl_stmt|;
comment|/* 	 * Notify hv_rf_halt_device() about halt completion. 	 * The halt code must wait for completion before freeing 	 * the transaction resources. 	 */
name|request
operator|->
name|halt_complete_flag
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter when "all" reception is done  */
end_comment

begin_function
name|void
name|hv_rf_receive_rollup
parameter_list|(
name|netvsc_dev
modifier|*
name|net_dev
parameter_list|)
block|{
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|rndis_dev
operator|=
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
expr_stmt|;
name|netvsc_recv_rollup
argument_list|(
name|rndis_dev
operator|->
name|net_dev
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hv_rf_channel_rollup
parameter_list|(
name|netvsc_dev
modifier|*
name|net_dev
parameter_list|)
block|{
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|rndis_dev
operator|=
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
expr_stmt|;
comment|/* 	 * This could be called pretty early, so we need 	 * to make sure everything has been setup. 	 */
if|if
condition|(
name|rndis_dev
operator|==
name|NULL
operator|||
name|rndis_dev
operator|->
name|net_dev
operator|==
name|NULL
operator|||
name|rndis_dev
operator|->
name|net_dev
operator|->
name|dev
operator|==
name|NULL
condition|)
return|return;
name|netvsc_channel_rollup
argument_list|(
name|rndis_dev
operator|->
name|net_dev
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


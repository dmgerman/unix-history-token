begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2012,2016 Microsoft Corp.  * Copyright (c) 2010-2012 Citrix Inc.  * Copyright (c) 2012 NetApp Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/hyperv.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/vmbus_xact.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hv_net_vsc.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hv_rndis.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hv_rndis_filter.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/if_hnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/ndis.h>
end_include

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_VLAN
value|0x1
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_CSUM
value|0x2
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_HASHINF
value|0x4
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_HASHVAL
value|0x8
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_ALL
define|\
value|(HV_RF_RECVINFO_VLAN |		\ 	 HV_RF_RECVINFO_CSUM |		\ 	 HV_RF_RECVINFO_HASHINF |	\ 	 HV_RF_RECVINFO_HASHVAL)
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_RID_COMPAT_MASK
value|0xffff
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_RID_COMPAT_MAX
value|HN_RNDIS_RID_COMPAT_MASK
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_XFER_SIZE
value|2048
end_define

begin_comment
comment|/*  * Forward declarations  */
end_comment

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|eaddr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
modifier|*
name|link_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_query
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|idata
parameter_list|,
name|size_t
name|idlen
parameter_list|,
name|void
modifier|*
name|odata
parameter_list|,
name|size_t
modifier|*
name|odlen0
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_set
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|dlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_conf_offload
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_get_rsscaps
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|int
modifier|*
name|rxr_cnt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_conf_rss
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|nchan
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|__inline
name|uint32_t
name|hn_rndis_rid
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|rid
decl_stmt|;
name|again
label|:
name|rid
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|sc
operator|->
name|hn_rndis_rid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rid
operator|==
literal|0
condition|)
goto|goto
name|again
goto|;
comment|/* Use upper 16 bits for non-compat RNDIS messages. */
return|return
operator|(
operator|(
name|rid
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set the Per-Packet-Info with the specified type  */
end_comment

begin_function
name|void
modifier|*
name|hv_set_rppi_data
parameter_list|(
name|rndis_msg
modifier|*
name|rndis_mesg
parameter_list|,
name|uint32_t
name|rppi_size
parameter_list|,
name|int
name|pkt_type
parameter_list|)
block|{
name|rndis_packet
modifier|*
name|rndis_pkt
decl_stmt|;
name|rndis_per_packet_info
modifier|*
name|rppi
decl_stmt|;
name|rndis_pkt
operator|=
operator|&
name|rndis_mesg
operator|->
name|msg
operator|.
name|packet
expr_stmt|;
name|rndis_pkt
operator|->
name|data_offset
operator|+=
name|rppi_size
expr_stmt|;
name|rppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rndis_pkt
operator|+
name|rndis_pkt
operator|->
name|per_pkt_info_offset
operator|+
name|rndis_pkt
operator|->
name|per_pkt_info_length
operator|)
expr_stmt|;
name|rppi
operator|->
name|size
operator|=
name|rppi_size
expr_stmt|;
name|rppi
operator|->
name|type
operator|=
name|pkt_type
expr_stmt|;
name|rppi
operator|->
name|per_packet_info_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
expr_stmt|;
name|rndis_pkt
operator|->
name|per_pkt_info_length
operator|+=
name|rppi_size
expr_stmt|;
return|return
operator|(
name|rppi
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive indicate status  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
block|{
specifier|const
name|struct
name|rndis_status_msg
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
name|dlen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS status\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|msg
operator|=
name|data
expr_stmt|;
switch|switch
condition|(
name|msg
operator|->
name|rm_status
condition|)
block|{
case|case
name|RNDIS_STATUS_MEDIA_CONNECT
case|:
name|netvsc_linkstatus_callback
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RNDIS_STATUS_MEDIA_DISCONNECT
case|:
name|netvsc_linkstatus_callback
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* TODO: */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"unknown RNDIS status 0x%08x\n"
argument_list|,
name|msg
operator|->
name|rm_status
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_rxinfo
parameter_list|(
specifier|const
name|void
modifier|*
name|info_data
parameter_list|,
name|int
name|info_dlen
parameter_list|,
name|struct
name|hn_recvinfo
modifier|*
name|info
parameter_list|)
block|{
specifier|const
name|struct
name|rndis_pktinfo
modifier|*
name|pi
init|=
name|info_data
decl_stmt|;
name|uint32_t
name|mask
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|info_dlen
operator|!=
literal|0
condition|)
block|{
specifier|const
name|void
modifier|*
name|data
decl_stmt|;
name|uint32_t
name|dlen
decl_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|info_dlen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|pi
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|__predict_false
argument_list|(
name|info_dlen
operator|<
name|pi
operator|->
name|rm_size
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|info_dlen
operator|-=
name|pi
operator|->
name|rm_size
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|pi
operator|->
name|rm_size
operator|&
name|RNDIS_PKTINFO_SIZE_ALIGNMASK
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|__predict_false
argument_list|(
name|pi
operator|->
name|rm_size
operator|<
name|pi
operator|->
name|rm_pktinfooffset
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|dlen
operator|=
name|pi
operator|->
name|rm_size
operator|-
name|pi
operator|->
name|rm_pktinfooffset
expr_stmt|;
name|data
operator|=
name|pi
operator|->
name|rm_data
expr_stmt|;
switch|switch
condition|(
name|pi
operator|->
name|rm_type
condition|)
block|{
case|case
name|NDIS_PKTINFO_TYPE_VLAN
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|dlen
operator|<
name|NDIS_VLAN_INFO_SIZE
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|info
operator|->
name|vlan_info
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint32_t
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_VLAN
expr_stmt|;
break|break;
case|case
name|NDIS_PKTINFO_TYPE_CSUM
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|dlen
operator|<
name|NDIS_RXCSUM_INFO_SIZE
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|info
operator|->
name|csum_info
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint32_t
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_CSUM
expr_stmt|;
break|break;
case|case
name|HN_NDIS_PKTINFO_TYPE_HASHVAL
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|dlen
operator|<
name|HN_NDIS_HASH_VALUE_SIZE
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|info
operator|->
name|hash_value
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint32_t
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_HASHVAL
expr_stmt|;
break|break;
case|case
name|HN_NDIS_PKTINFO_TYPE_HASHINF
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|dlen
operator|<
name|HN_NDIS_HASH_INFO_SIZE
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|info
operator|->
name|hash_info
operator|=
operator|*
operator|(
operator|(
specifier|const
name|uint32_t
operator|*
operator|)
name|data
operator|)
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_HASHINF
expr_stmt|;
break|break;
default|default:
goto|goto
name|next
goto|;
block|}
if|if
condition|(
name|mask
operator|==
name|HV_RF_RECVINFO_ALL
condition|)
block|{
comment|/* All found; done */
break|break;
block|}
name|next
label|:
name|pi
operator|=
operator|(
specifier|const
expr|struct
name|rndis_pktinfo
operator|*
operator|)
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|pi
operator|+
name|pi
operator|->
name|rm_size
operator|)
expr_stmt|;
block|}
comment|/* 	 * Final fixup. 	 * - If there is no hash value, invalidate the hash info. 	 */
if|if
condition|(
operator|(
name|mask
operator|&
name|HV_RF_RECVINFO_HASHVAL
operator|)
operator|==
literal|0
condition|)
name|info
operator|->
name|hash_info
operator|=
name|HN_NDIS_HASH_INFO_INVALID
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|bool
name|hn_rndis_check_overlap
parameter_list|(
name|int
name|off
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|check_off
parameter_list|,
name|int
name|check_len
parameter_list|)
block|{
if|if
condition|(
name|off
operator|<
name|check_off
condition|)
block|{
if|if
condition|(
name|__predict_true
argument_list|(
name|off
operator|+
name|len
operator|<=
name|check_off
argument_list|)
condition|)
return|return
operator|(
name|false
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|off
operator|>
name|check_off
condition|)
block|{
if|if
condition|(
name|__predict_true
argument_list|(
name|check_off
operator|+
name|check_len
operator|<=
name|off
argument_list|)
condition|)
return|return
operator|(
name|false
operator|)
return|;
block|}
return|return
operator|(
name|true
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive data  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
block|{
specifier|const
name|struct
name|rndis_packet_msg
modifier|*
name|pkt
decl_stmt|;
name|struct
name|hn_recvinfo
name|info
decl_stmt|;
name|int
name|data_off
decl_stmt|,
name|pktinfo_off
decl_stmt|,
name|data_len
decl_stmt|,
name|pktinfo_len
decl_stmt|;
comment|/* 	 * Check length. 	 */
if|if
condition|(
name|__predict_false
argument_list|(
name|dlen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|pkt
argument_list|)
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pkt
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|dlen
operator|<
name|pkt
operator|->
name|rm_len
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"truncated RNDIS packet msg, "
literal|"dlen %d, msglen %u\n"
argument_list|,
name|dlen
argument_list|,
name|pkt
operator|->
name|rm_len
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|pkt
operator|->
name|rm_len
operator|<
name|pkt
operator|->
name|rm_datalen
operator|+
name|pkt
operator|->
name|rm_oobdatalen
operator|+
name|pkt
operator|->
name|rm_pktinfolen
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msglen, "
literal|"msglen %u, data %u, oob %u, pktinfo %u\n"
argument_list|,
name|pkt
operator|->
name|rm_len
argument_list|,
name|pkt
operator|->
name|rm_datalen
argument_list|,
name|pkt
operator|->
name|rm_oobdatalen
argument_list|,
name|pkt
operator|->
name|rm_pktinfolen
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|pkt
operator|->
name|rm_datalen
operator|==
literal|0
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, no data\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Check offests. 	 */
define|#
directive|define
name|IS_OFFSET_INVALID
parameter_list|(
name|ofs
parameter_list|)
define|\
value|((ofs)< RNDIS_PACKET_MSG_OFFSET_MIN ||	\ 	 ((ofs)& RNDIS_PACKET_MSG_OFFSET_ALIGNMASK))
comment|/* XXX Hyper-V does not meet data offset alignment requirement */
if|if
condition|(
name|__predict_false
argument_list|(
name|pkt
operator|->
name|rm_dataoffset
operator|<
name|RNDIS_PACKET_MSG_OFFSET_MIN
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"data offset %u\n"
argument_list|,
name|pkt
operator|->
name|rm_dataoffset
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|pkt
operator|->
name|rm_oobdataoffset
operator|>
literal|0
operator|&&
name|IS_OFFSET_INVALID
argument_list|(
name|pkt
operator|->
name|rm_oobdataoffset
argument_list|)
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"oob offset %u\n"
argument_list|,
name|pkt
operator|->
name|rm_oobdataoffset
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|__predict_true
argument_list|(
name|pkt
operator|->
name|rm_pktinfooffset
operator|>
literal|0
argument_list|)
operator|&&
name|__predict_false
argument_list|(
name|IS_OFFSET_INVALID
argument_list|(
name|pkt
operator|->
name|rm_pktinfooffset
argument_list|)
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"pktinfo offset %u\n"
argument_list|,
name|pkt
operator|->
name|rm_pktinfooffset
argument_list|)
expr_stmt|;
return|return;
block|}
undef|#
directive|undef
name|IS_OFFSET_INVALID
name|data_off
operator|=
name|RNDIS_PACKET_MSG_OFFSET_ABS
argument_list|(
name|pkt
operator|->
name|rm_dataoffset
argument_list|)
expr_stmt|;
name|data_len
operator|=
name|pkt
operator|->
name|rm_datalen
expr_stmt|;
name|pktinfo_off
operator|=
name|RNDIS_PACKET_MSG_OFFSET_ABS
argument_list|(
name|pkt
operator|->
name|rm_pktinfooffset
argument_list|)
expr_stmt|;
name|pktinfo_len
operator|=
name|pkt
operator|->
name|rm_pktinfolen
expr_stmt|;
comment|/* 	 * Check OOB coverage. 	 */
if|if
condition|(
name|__predict_false
argument_list|(
name|pkt
operator|->
name|rm_oobdatalen
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|int
name|oob_off
decl_stmt|,
name|oob_len
decl_stmt|;
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"got oobdata\n"
argument_list|)
expr_stmt|;
name|oob_off
operator|=
name|RNDIS_PACKET_MSG_OFFSET_ABS
argument_list|(
name|pkt
operator|->
name|rm_oobdataoffset
argument_list|)
expr_stmt|;
name|oob_len
operator|=
name|pkt
operator|->
name|rm_oobdatalen
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|oob_off
operator|+
name|oob_len
operator|>
name|pkt
operator|->
name|rm_len
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"oob overflow, msglen %u, oob abs %d len %d\n"
argument_list|,
name|pkt
operator|->
name|rm_len
argument_list|,
name|oob_off
argument_list|,
name|oob_len
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Check against data. 		 */
if|if
condition|(
name|hn_rndis_check_overlap
argument_list|(
name|oob_off
argument_list|,
name|oob_len
argument_list|,
name|data_off
argument_list|,
name|data_len
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"oob overlaps data, oob abs %d len %d, "
literal|"data abs %d len %d\n"
argument_list|,
name|oob_off
argument_list|,
name|oob_len
argument_list|,
name|data_off
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Check against pktinfo. 		 */
if|if
condition|(
name|pktinfo_len
operator|!=
literal|0
operator|&&
name|hn_rndis_check_overlap
argument_list|(
name|oob_off
argument_list|,
name|oob_len
argument_list|,
name|pktinfo_off
argument_list|,
name|pktinfo_len
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"oob overlaps pktinfo, oob abs %d len %d, "
literal|"pktinfo abs %d len %d\n"
argument_list|,
name|oob_off
argument_list|,
name|oob_len
argument_list|,
name|pktinfo_off
argument_list|,
name|pktinfo_len
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Check per-packet-info coverage and find useful per-packet-info. 	 */
name|info
operator|.
name|vlan_info
operator|=
name|HN_NDIS_VLAN_INFO_INVALID
expr_stmt|;
name|info
operator|.
name|csum_info
operator|=
name|HN_NDIS_RXCSUM_INFO_INVALID
expr_stmt|;
name|info
operator|.
name|hash_info
operator|=
name|HN_NDIS_HASH_INFO_INVALID
expr_stmt|;
if|if
condition|(
name|__predict_true
argument_list|(
name|pktinfo_len
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|bool
name|overlap
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|pktinfo_off
operator|+
name|pktinfo_len
operator|>
name|pkt
operator|->
name|rm_len
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"pktinfo overflow, msglen %u, "
literal|"pktinfo abs %d len %d\n"
argument_list|,
name|pkt
operator|->
name|rm_len
argument_list|,
name|pktinfo_off
argument_list|,
name|pktinfo_len
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Check packet info coverage. 		 */
name|overlap
operator|=
name|hn_rndis_check_overlap
argument_list|(
name|pktinfo_off
argument_list|,
name|pktinfo_len
argument_list|,
name|data_off
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|overlap
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"pktinfo overlap data, pktinfo abs %d len %d, "
literal|"data abs %d len %d\n"
argument_list|,
name|pktinfo_off
argument_list|,
name|pktinfo_len
argument_list|,
name|data_off
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Find useful per-packet-info. 		 */
name|error
operator|=
name|hn_rndis_rxinfo
argument_list|(
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|pkt
operator|)
operator|+
name|pktinfo_off
argument_list|,
name|pktinfo_len
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|error
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg "
literal|"pktinfo\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|__predict_false
argument_list|(
name|data_off
operator|+
name|data_len
operator|>
name|pkt
operator|->
name|rm_len
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS packet msg, "
literal|"data overflow, msglen %u, data abs %d len %d\n"
argument_list|,
name|pkt
operator|->
name|rm_len
argument_list|,
name|data_off
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|netvsc_recv
argument_list|(
name|rxr
argument_list|,
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|pkt
operator|)
operator|+
name|data_off
argument_list|,
name|data_len
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on receive  */
end_comment

begin_function
name|void
name|hv_rf_on_receive
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
block|{
specifier|const
name|struct
name|rndis_comp_hdr
modifier|*
name|comp
decl_stmt|;
specifier|const
name|struct
name|rndis_msghdr
modifier|*
name|hdr
decl_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|dlen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS msg\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdr
operator|=
name|data
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|rm_type
condition|)
block|{
case|case
name|REMOTE_NDIS_PACKET_MSG
case|:
name|hv_rf_receive_data
argument_list|(
name|rxr
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|REMOTE_NDIS_INITIALIZE_CMPLT
case|:
case|case
name|REMOTE_NDIS_QUERY_CMPLT
case|:
case|case
name|REMOTE_NDIS_SET_CMPLT
case|:
case|case
name|REMOTE_NDIS_KEEPALIVE_CMPLT
case|:
comment|/* unused */
if|if
condition|(
name|dlen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS cmplt\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|comp
operator|=
name|data
expr_stmt|;
name|KASSERT
argument_list|(
name|comp
operator|->
name|rm_rid
operator|>
name|HN_RNDIS_RID_COMPAT_MAX
argument_list|,
operator|(
literal|"invalid RNDIS rid 0x%08x\n"
operator|,
name|comp
operator|->
name|rm_rid
operator|)
argument_list|)
expr_stmt|;
name|vmbus_xact_ctx_wakeup
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|comp
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|REMOTE_NDIS_INDICATE_STATUS_MSG
case|:
name|hv_rf_receive_indicate_status
argument_list|(
name|sc
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|REMOTE_NDIS_RESET_CMPLT
case|:
comment|/* 		 * Reset completed, no rid. 		 * 		 * NOTE: 		 * RESET is not issued by hn(4), so this message should 		 * _not_ be observed. 		 */
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"RESET cmplt received\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"unknown RNDIS msg 0x%x\n"
argument_list|,
name|hdr
operator|->
name|rm_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device MAC address  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|eaddr
parameter_list|)
block|{
name|size_t
name|eaddr_len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|eaddr_len
operator|=
name|ETHER_ADDR_LEN
expr_stmt|;
name|error
operator|=
name|hn_rndis_query
argument_list|(
name|sc
argument_list|,
name|OID_802_3_PERMANENT_ADDRESS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|eaddr
argument_list|,
operator|&
name|eaddr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|eaddr_len
operator|!=
name|ETHER_ADDR_LEN
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid eaddr len %zu\n"
argument_list|,
name|eaddr_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device link status  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
modifier|*
name|link_status
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|link_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|hn_rndis_query
argument_list|(
name|sc
argument_list|,
name|OID_GEN_MEDIA_CONNECT_STATUS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|link_status
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|size
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid link status len %zu\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint8_t
name|netvsc_hash_key
index|[
name|NDIS_HASH_KEYSIZE_TOEPLITZ
index|]
init|=
block|{
literal|0x6d
block|,
literal|0x5a
block|,
literal|0x56
block|,
literal|0xda
block|,
literal|0x25
block|,
literal|0x5b
block|,
literal|0x0e
block|,
literal|0xc2
block|,
literal|0x41
block|,
literal|0x67
block|,
literal|0x25
block|,
literal|0x3d
block|,
literal|0x43
block|,
literal|0xa3
block|,
literal|0x8f
block|,
literal|0xb0
block|,
literal|0xd0
block|,
literal|0xca
block|,
literal|0x2b
block|,
literal|0xcb
block|,
literal|0xae
block|,
literal|0x7b
block|,
literal|0x30
block|,
literal|0xb4
block|,
literal|0x77
block|,
literal|0xcb
block|,
literal|0x2d
block|,
literal|0xa3
block|,
literal|0x80
block|,
literal|0x30
block|,
literal|0xf2
block|,
literal|0x0c
block|,
literal|0x6a
block|,
literal|0x42
block|,
literal|0xb7
block|,
literal|0x3b
block|,
literal|0xbe
block|,
literal|0xac
block|,
literal|0x01
block|,
literal|0xfa
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|void
modifier|*
name|hn_rndis_xact_exec1
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_xact
modifier|*
name|xact
parameter_list|,
name|size_t
name|reqlen
parameter_list|,
name|struct
name|hn_send_ctx
modifier|*
name|sndc
parameter_list|,
name|size_t
modifier|*
name|comp_len
parameter_list|)
block|{
name|struct
name|vmbus_gpa
name|gpa
index|[
name|HN_XACT_REQ_PGCNT
index|]
decl_stmt|;
name|int
name|gpa_cnt
decl_stmt|,
name|error
decl_stmt|;
name|bus_addr_t
name|paddr
decl_stmt|;
name|KASSERT
argument_list|(
name|reqlen
operator|<=
name|HN_XACT_REQ_SIZE
operator|&&
name|reqlen
operator|>
literal|0
argument_list|,
operator|(
literal|"invalid request length %zu"
operator|,
name|reqlen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Setup the SG list. 	 */
name|paddr
operator|=
name|vmbus_xact_req_paddr
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|paddr
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"vmbus xact request is not page aligned 0x%jx"
operator|,
operator|(
name|uintmax_t
operator|)
name|paddr
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|gpa_cnt
operator|=
literal|0
init|;
name|gpa_cnt
operator|<
name|HN_XACT_REQ_PGCNT
condition|;
operator|++
name|gpa_cnt
control|)
block|{
name|int
name|len
init|=
name|PAGE_SIZE
decl_stmt|;
if|if
condition|(
name|reqlen
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|reqlen
operator|<
name|len
condition|)
name|len
operator|=
name|reqlen
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_page
operator|=
name|atop
argument_list|(
name|paddr
argument_list|)
operator|+
name|gpa_cnt
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_len
operator|=
name|len
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_ofs
operator|=
literal|0
expr_stmt|;
name|reqlen
operator|-=
name|len
expr_stmt|;
block|}
name|KASSERT
argument_list|(
name|reqlen
operator|==
literal|0
argument_list|,
operator|(
literal|"still have %zu request data left"
operator|,
name|reqlen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Send this RNDIS control message and wait for its completion 	 * message. 	 */
name|vmbus_xact_activate
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|error
operator|=
name|hv_nv_on_send
argument_list|(
name|sc
operator|->
name|hn_prichan
argument_list|,
name|HN_NVS_RNDIS_MTYPE_CTRL
argument_list|,
name|sndc
argument_list|,
name|gpa
argument_list|,
name|gpa_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vmbus_xact_deactivate
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS ctrl send failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|vmbus_xact_wait
argument_list|(
name|xact
argument_list|,
name|comp_len
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|void
modifier|*
name|hn_rndis_xact_execute
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_xact
modifier|*
name|xact
parameter_list|,
name|uint32_t
name|rid
parameter_list|,
name|size_t
name|reqlen
parameter_list|,
name|size_t
modifier|*
name|comp_len0
parameter_list|,
name|uint32_t
name|comp_type
parameter_list|)
block|{
specifier|const
name|struct
name|rndis_comp_hdr
modifier|*
name|comp
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|,
name|min_complen
init|=
operator|*
name|comp_len0
decl_stmt|;
name|KASSERT
argument_list|(
name|rid
operator|>
name|HN_RNDIS_RID_COMPAT_MAX
argument_list|,
operator|(
literal|"invalid rid %u\n"
operator|,
name|rid
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|min_complen
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
argument_list|,
operator|(
literal|"invalid minimum complete len %zu"
operator|,
name|min_complen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Execute the xact setup by the caller. 	 */
name|comp
operator|=
name|hn_rndis_xact_exec1
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|reqlen
argument_list|,
operator|&
name|hn_send_ctx_none
argument_list|,
operator|&
name|comp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* 	 * Check this RNDIS complete message. 	 */
if|if
condition|(
name|comp_len
operator|<
name|min_complen
condition|)
block|{
if|if
condition|(
name|comp_len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
condition|)
block|{
comment|/* rm_status field is valid */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp len %zu, "
literal|"status 0x%08x\n"
argument_list|,
name|comp_len
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp len %zu\n"
argument_list|,
name|comp_len
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_len
operator|<
name|min_complen
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp msglen %u\n"
argument_list|,
name|comp
operator|->
name|rm_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_type
operator|!=
name|comp_type
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"unexpected RNDIS comp 0x%08x, "
literal|"expect 0x%08x\n"
argument_list|,
name|comp
operator|->
name|rm_type
argument_list|,
name|comp_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_rid
operator|!=
name|rid
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS comp rid mismatch %u, "
literal|"expect %u\n"
argument_list|,
name|comp
operator|->
name|rm_rid
argument_list|,
name|rid
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* All pass! */
operator|*
name|comp_len0
operator|=
name|comp_len
expr_stmt|;
return|return
operator|(
name|comp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_query
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|idata
parameter_list|,
name|size_t
name|idlen
parameter_list|,
name|void
modifier|*
name|odata
parameter_list|,
name|size_t
modifier|*
name|odlen0
parameter_list|)
block|{
name|struct
name|rndis_query_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_query_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|,
name|odlen
init|=
operator|*
name|odlen0
decl_stmt|,
name|comp_len
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ofs
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|reqlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
name|idlen
expr_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|reqlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS query 0x%08x\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_QUERY_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
name|reqlen
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_oid
operator|=
name|oid
expr_stmt|;
comment|/* 	 * XXX 	 * This is _not_ RNDIS Spec conforming: 	 * "This MUST be set to 0 when there is no input data 	 *  associated with the OID." 	 * 	 * If this field was set to 0 according to the RNDIS Spec, 	 * Hyper-V would set non-SUCCESS status in the query 	 * completion. 	 */
name|req
operator|->
name|rm_infobufoffset
operator|=
name|RNDIS_QUERY_REQ_INFOBUFOFFSET
expr_stmt|;
if|if
condition|(
name|idlen
operator|>
literal|0
condition|)
block|{
name|req
operator|->
name|rm_infobuflen
operator|=
name|idlen
expr_stmt|;
comment|/* Input data immediately follows RNDIS query. */
name|memcpy
argument_list|(
name|req
operator|+
literal|1
argument_list|,
name|idata
argument_list|,
name|idlen
argument_list|)
expr_stmt|;
block|}
name|comp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
operator|+
name|odlen
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
name|reqlen
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_QUERY_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS query 0x%08x failed\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query 0x%08x failed: "
literal|"status 0x%08x\n"
argument_list|,
name|oid
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_infobuflen
operator|==
literal|0
operator|||
name|comp
operator|->
name|rm_infobufoffset
operator|==
literal|0
condition|)
block|{
comment|/* No output data! */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query 0x%08x, no data\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
operator|*
name|odlen0
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Check output data length and offset. 	 */
comment|/* ofs is the offset from the beginning of comp. */
name|ofs
operator|=
name|RNDIS_QUERY_COMP_INFOBUFOFFSET_ABS
argument_list|(
name|comp
operator|->
name|rm_infobufoffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofs
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
operator|||
name|ofs
operator|+
name|comp
operator|->
name|rm_infobuflen
operator|>
name|comp_len
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query invalid comp ib off/len, "
literal|"%u/%u\n"
argument_list|,
name|comp
operator|->
name|rm_infobufoffset
argument_list|,
name|comp
operator|->
name|rm_infobuflen
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Save output data. 	 */
if|if
condition|(
name|comp
operator|->
name|rm_infobuflen
operator|<
name|odlen
condition|)
name|odlen
operator|=
name|comp
operator|->
name|rm_infobuflen
expr_stmt|;
name|memcpy
argument_list|(
name|odata
argument_list|,
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|comp
operator|)
operator|+
name|ofs
argument_list|,
name|odlen
argument_list|)
expr_stmt|;
operator|*
name|odlen0
operator|=
name|odlen
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_get_rsscaps
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|int
modifier|*
name|rxr_cnt
parameter_list|)
block|{
name|struct
name|ndis_rss_caps
name|in
decl_stmt|,
name|caps
decl_stmt|;
name|size_t
name|caps_len
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* 	 * Only NDIS 6.30+ is supported. 	 */
name|KASSERT
argument_list|(
name|sc
operator|->
name|hn_ndis_ver
operator|>=
name|NDIS_VERSION_6_30
argument_list|,
operator|(
literal|"NDIS 6.30+ is required, NDIS version 0x%08x"
operator|,
name|sc
operator|->
name|hn_ndis_ver
operator|)
argument_list|)
expr_stmt|;
operator|*
name|rxr_cnt
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_RSS_CAPS
expr_stmt|;
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_RSS_CAPS_REV_2
expr_stmt|;
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|=
name|NDIS_RSS_CAPS_SIZE
expr_stmt|;
name|caps_len
operator|=
name|NDIS_RSS_CAPS_SIZE
expr_stmt|;
name|error
operator|=
name|hn_rndis_query
argument_list|(
name|sc
argument_list|,
name|OID_GEN_RECEIVE_SCALE_CAPABILITIES
argument_list|,
operator|&
name|in
argument_list|,
name|NDIS_RSS_CAPS_SIZE
argument_list|,
operator|&
name|caps
argument_list|,
operator|&
name|caps_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|caps_len
operator|<
name|NDIS_RSS_CAPS_SIZE_6_0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS RSS caps len %zu"
argument_list|,
name|caps_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|caps
operator|.
name|ndis_nrxr
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"0 RX rings!?\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
operator|*
name|rxr_cnt
operator|=
name|caps
operator|.
name|ndis_nrxr
expr_stmt|;
if|if
condition|(
name|caps_len
operator|==
name|NDIS_RSS_CAPS_SIZE
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS indirect table size %u\n"
argument_list|,
name|caps
operator|.
name|ndis_nind
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_set
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|dlen
parameter_list|)
block|{
name|struct
name|rndis_set_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_set_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|,
name|comp_len
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|int
name|error
decl_stmt|;
name|KASSERT
argument_list|(
name|dlen
operator|>
literal|0
argument_list|,
operator|(
literal|"invalid dlen %zu"
operator|,
name|dlen
operator|)
argument_list|)
expr_stmt|;
name|reqlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
name|dlen
expr_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|reqlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS set 0x%08x\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_SET_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
name|reqlen
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_oid
operator|=
name|oid
expr_stmt|;
name|req
operator|->
name|rm_infobuflen
operator|=
name|dlen
expr_stmt|;
name|req
operator|->
name|rm_infobufoffset
operator|=
name|RNDIS_SET_REQ_INFOBUFOFFSET
expr_stmt|;
comment|/* Data immediately follows RNDIS set. */
name|memcpy
argument_list|(
name|req
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|comp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
name|reqlen
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_SET_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS set 0x%08x failed\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS set 0x%08x failed: "
literal|"status 0x%08x\n"
argument_list|,
name|oid
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_conf_offload
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ndis_offload_params
name|params
decl_stmt|;
name|size_t
name|paramsz
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* NOTE: 0 means "no change" */
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_DEFAULT
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|<
name|NDIS_VERSION_6_30
condition|)
block|{
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_PARAMS_REV_2
expr_stmt|;
name|paramsz
operator|=
name|NDIS_OFFLOAD_PARAMS_SIZE_6_1
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_PARAMS_REV_3
expr_stmt|;
name|paramsz
operator|=
name|NDIS_OFFLOAD_PARAMS_SIZE
expr_stmt|;
block|}
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|=
name|paramsz
expr_stmt|;
name|params
operator|.
name|ndis_ip4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
name|params
operator|.
name|ndis_tcp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
name|params
operator|.
name|ndis_tcp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|>=
name|NDIS_VERSION_6_30
condition|)
block|{
name|params
operator|.
name|ndis_udp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
name|params
operator|.
name|ndis_udp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
block|}
name|params
operator|.
name|ndis_lsov2_ip4
operator|=
name|NDIS_OFFLOAD_LSOV2_ON
expr_stmt|;
comment|/* XXX ndis_lsov2_ip6 = NDIS_OFFLOAD_LSOV2_ON */
name|error
operator|=
name|hn_rndis_set
argument_list|(
name|sc
argument_list|,
name|OID_TCP_OFFLOAD_PARAMETERS
argument_list|,
operator|&
name|params
argument_list|,
name|paramsz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload config failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload config done\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_conf_rss
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|nchan
parameter_list|)
block|{
name|struct
name|ndis_rssprm_toeplitz
modifier|*
name|rss
init|=
operator|&
name|sc
operator|->
name|hn_rss
decl_stmt|;
name|struct
name|ndis_rss_params
modifier|*
name|prm
init|=
operator|&
name|rss
operator|->
name|rss_params
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
comment|/* 	 * Only NDIS 6.30+ is supported. 	 */
name|KASSERT
argument_list|(
name|sc
operator|->
name|hn_ndis_ver
operator|>=
name|NDIS_VERSION_6_30
argument_list|,
operator|(
literal|"NDIS 6.30+ is required, NDIS version 0x%08x"
operator|,
name|sc
operator|->
name|hn_ndis_ver
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|rss
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rss
argument_list|)
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_RSS_PARAMS
expr_stmt|;
name|prm
operator|->
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_RSS_PARAMS_REV_2
expr_stmt|;
name|prm
operator|->
name|ndis_hdr
operator|.
name|ndis_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|rss
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_hash
operator|=
name|NDIS_HASH_FUNCTION_TOEPLITZ
operator||
name|NDIS_HASH_IPV4
operator||
name|NDIS_HASH_TCP_IPV4
operator||
name|NDIS_HASH_IPV6
operator||
name|NDIS_HASH_TCP_IPV6
expr_stmt|;
comment|/* TODO: Take ndis_rss_caps.ndis_nind into account */
name|prm
operator|->
name|ndis_indsize
operator|=
sizeof|sizeof
argument_list|(
name|rss
operator|->
name|rss_ind
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_indoffset
operator|=
name|__offsetof
argument_list|(
expr|struct
name|ndis_rssprm_toeplitz
argument_list|,
name|rss_ind
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_keysize
operator|=
sizeof|sizeof
argument_list|(
name|rss
operator|->
name|rss_key
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_keyoffset
operator|=
name|__offsetof
argument_list|(
expr|struct
name|ndis_rssprm_toeplitz
argument_list|,
name|rss_key
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* Setup RSS key */
name|memcpy
argument_list|(
name|rss
operator|->
name|rss_key
argument_list|,
name|netvsc_hash_key
argument_list|,
sizeof|sizeof
argument_list|(
name|rss
operator|->
name|rss_key
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setup RSS indirect table */
comment|/* TODO: Take ndis_rss_caps.ndis_nind into account */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NDIS_HASH_INDCNT
condition|;
operator|++
name|i
control|)
name|rss
operator|->
name|rss_ind
index|[
name|i
index|]
operator|=
name|i
operator|%
name|nchan
expr_stmt|;
name|error
operator|=
name|hn_rndis_set
argument_list|(
name|sc
argument_list|,
name|OID_GEN_RECEIVE_SCALE_PARAMETERS
argument_list|,
name|rss
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS config failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS config done\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_set_rxfilter
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|filter
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|hn_rndis_set
argument_list|(
name|sc
argument_list|,
name|OID_GEN_CURRENT_PACKET_FILTER
argument_list|,
operator|&
name|filter
argument_list|,
sizeof|sizeof
argument_list|(
name|filter
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"set RX filter 0x%08x failed: %d\n"
argument_list|,
name|filter
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"set RX filter 0x%08x done\n"
argument_list|,
name|filter
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter init device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|rndis_init_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_init_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|int
name|error
decl_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS init\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_INITIALIZE_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_ver_major
operator|=
name|RNDIS_VERSION_MAJOR
expr_stmt|;
name|req
operator|->
name|rm_ver_minor
operator|=
name|RNDIS_VERSION_MINOR
expr_stmt|;
name|req
operator|->
name|rm_max_xfersz
operator|=
name|HN_RNDIS_XFER_SIZE
expr_stmt|;
name|comp_len
operator|=
name|RNDIS_INIT_COMP_SIZE_MIN
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_INITIALIZE_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS init failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS init failed: status 0x%08x\n"
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS ver %u.%u, pktsz %u, pktcnt %u, "
literal|"align %u\n"
argument_list|,
name|comp
operator|->
name|rm_ver_major
argument_list|,
name|comp
operator|->
name|rm_ver_minor
argument_list|,
name|comp
operator|->
name|rm_pktmaxsz
argument_list|,
name|comp
operator|->
name|rm_pktmaxcnt
argument_list|,
literal|1U
operator|<<
name|comp
operator|->
name|rm_align
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter halt device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_halt_device
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|struct
name|rndis_halt_req
modifier|*
name|halt
decl_stmt|;
name|struct
name|hn_send_ctx
name|sndc
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|halt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS halt\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|halt
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|halt
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_HALT_MSG
expr_stmt|;
name|halt
operator|->
name|rm_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|halt
argument_list|)
expr_stmt|;
name|halt
operator|->
name|rm_rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* No RNDIS completion; rely on NVS message send completion */
name|hn_send_ctx_init_simple
argument_list|(
operator|&
name|sndc
argument_list|,
name|hn_nvs_sent_xact
argument_list|,
name|xact
argument_list|)
expr_stmt|;
name|hn_rndis_xact_exec1
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|halt
argument_list|)
argument_list|,
operator|&
name|sndc
argument_list|,
operator|&
name|comp_len
argument_list|)
expr_stmt|;
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS halt done\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device add  */
end_comment

begin_function
name|int
name|hv_rf_on_device_add
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|additl_info
parameter_list|,
name|int
modifier|*
name|nchan0
parameter_list|,
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|netvsc_device_info
modifier|*
name|dev_info
init|=
operator|(
name|netvsc_device_info
operator|*
operator|)
name|additl_info
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|hn_dev
decl_stmt|;
name|struct
name|hn_nvs_subch_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|hn_nvs_subch_resp
modifier|*
name|resp
decl_stmt|;
name|size_t
name|resp_len
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|status
decl_stmt|,
name|nsubch
decl_stmt|;
name|int
name|nchan
init|=
operator|*
name|nchan0
decl_stmt|;
name|int
name|rxr_cnt
decl_stmt|;
comment|/* 	 * Let the inner driver handle this first to create the netvsc channel 	 * NOTE! Once the channel is created, we may get a receive callback  	 * (hv_rf_on_receive()) before this call is completed. 	 * Note:  Earlier code used a function pointer here. 	 */
name|ret
operator|=
name|hv_nv_on_device_add
argument_list|(
name|sc
argument_list|,
name|rxr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
return|return
operator|(
name|ret
operator|)
return|;
comment|/* 	 * Initialize the rndis device 	 */
comment|/* Send the rndis initialization message */
name|ret
operator|=
name|hv_rf_init_device
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* 		 * TODO: If rndis init failed, we will need to shut down 		 * the channel 		 */
block|}
comment|/* Get the mac address */
name|ret
operator|=
name|hv_rf_query_device_mac
argument_list|(
name|sc
argument_list|,
name|dev_info
operator|->
name|mac_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* TODO: shut down rndis device and the channel */
block|}
comment|/* Configure NDIS offload settings */
name|hn_rndis_conf_offload
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|hv_rf_query_device_link_status
argument_list|(
name|sc
argument_list|,
operator|&
name|dev_info
operator|->
name|link_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|<
name|NDIS_VERSION_6_30
operator|||
name|nchan
operator|==
literal|1
condition|)
block|{
comment|/* 		 * Either RSS is not supported, or multiple RX/TX rings 		 * are not requested. 		 */
operator|*
name|nchan0
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 	 * Get RSS capabilities, e.g. # of RX rings, and # of indirect 	 * table entries. 	 */
name|ret
operator|=
name|hn_rndis_get_rsscaps
argument_list|(
name|sc
argument_list|,
operator|&
name|rxr_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
comment|/* No RSS; this is benign. */
operator|*
name|nchan0
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|nchan
operator|>
name|rxr_cnt
condition|)
name|nchan
operator|=
name|rxr_cnt
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RX rings offered %u, requested %d\n"
argument_list|,
name|rxr_cnt
argument_list|,
name|nchan
argument_list|)
expr_stmt|;
if|if
condition|(
name|nchan
operator|==
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"only 1 channel is supported, no vRSS\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Ask NVS to allocate sub-channels. 	 */
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for nvs subch req\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|nvs_type
operator|=
name|HN_NVS_TYPE_SUBCH_REQ
expr_stmt|;
name|req
operator|->
name|nvs_op
operator|=
name|HN_NVS_SUBCH_OP_ALLOC
expr_stmt|;
name|req
operator|->
name|nvs_nsubch
operator|=
name|nchan
operator|-
literal|1
expr_stmt|;
name|resp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
expr_stmt|;
name|resp
operator|=
name|hn_nvs_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|req
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|,
operator|&
name|resp_len
argument_list|,
name|HN_NVS_TYPE_SUBCH_RESP
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec subch failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|status
operator|=
name|resp
operator|->
name|nvs_status
expr_stmt|;
name|nsubch
operator|=
name|resp
operator|->
name|nvs_nsubch
expr_stmt|;
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|xact
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|HN_NVS_STATUS_OK
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"subch req failed: %x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|nsubch
operator|>
name|nchan
operator|-
literal|1
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"%u subchans are allocated, requested %u\n"
argument_list|,
name|nsubch
argument_list|,
name|nchan
operator|-
literal|1
argument_list|)
expr_stmt|;
name|nsubch
operator|=
name|nchan
operator|-
literal|1
expr_stmt|;
block|}
name|nchan
operator|=
name|nsubch
operator|+
literal|1
expr_stmt|;
name|ret
operator|=
name|hn_rndis_conf_rss
argument_list|(
name|sc
argument_list|,
name|nchan
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
operator|*
name|nchan0
operator|=
literal|1
expr_stmt|;
else|else
operator|*
name|nchan0
operator|=
name|nchan
expr_stmt|;
name|out
label|:
if|if
condition|(
name|xact
operator|!=
name|NULL
condition|)
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device remove  */
end_comment

begin_function
name|int
name|hv_rf_on_device_remove
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
comment|/* Halt and release the rndis device */
name|ret
operator|=
name|hv_rf_halt_device
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Pass control to inner driver to remove the device */
name|ret
operator||=
name|hv_nv_on_device_remove
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on open  */
end_comment

begin_function
name|int
name|hv_rf_on_open
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|filter
decl_stmt|;
comment|/* XXX */
if|if
condition|(
name|hv_promisc_mode
operator|!=
literal|1
condition|)
block|{
name|filter
operator|=
name|NDIS_PACKET_TYPE_BROADCAST
operator||
name|NDIS_PACKET_TYPE_ALL_MULTICAST
operator||
name|NDIS_PACKET_TYPE_DIRECTED
expr_stmt|;
block|}
else|else
block|{
name|filter
operator|=
name|NDIS_PACKET_TYPE_PROMISCUOUS
expr_stmt|;
block|}
return|return
operator|(
name|hn_rndis_set_rxfilter
argument_list|(
name|sc
argument_list|,
name|filter
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on close  */
end_comment

begin_function
name|int
name|hv_rf_on_close
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
name|hn_rndis_set_rxfilter
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|hv_rf_channel_rollup
parameter_list|(
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
name|struct
name|hn_tx_ring
modifier|*
name|txr
parameter_list|)
block|{
name|netvsc_channel_rollup
argument_list|(
name|rxr
argument_list|,
name|txr
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


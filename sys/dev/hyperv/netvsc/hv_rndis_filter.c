begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2012,2016 Microsoft Corp.  * Copyright (c) 2010-2012 Citrix Inc.  * Copyright (c) 2012 NetApp Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/hyperv.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/vmbus_xact.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hv_net_vsc.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hv_rndis.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hv_rndis_filter.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/if_hnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/ndis.h>
end_include

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_VLAN
value|0x1
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_CSUM
value|0x2
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_HASHINF
value|0x4
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_HASHVAL
value|0x8
end_define

begin_define
define|#
directive|define
name|HV_RF_RECVINFO_ALL
define|\
value|(HV_RF_RECVINFO_VLAN |		\ 	 HV_RF_RECVINFO_CSUM |		\ 	 HV_RF_RECVINFO_HASHINF |	\ 	 HV_RF_RECVINFO_HASHVAL)
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_RID_COMPAT_MASK
value|0xffff
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_RID_COMPAT_MAX
value|HN_RNDIS_RID_COMPAT_MASK
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_XFER_SIZE
value|2048
end_define

begin_comment
comment|/*  * Forward declarations  */
end_comment

begin_function_decl
specifier|static
name|int
name|hv_rf_send_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|,
name|uint32_t
name|message_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_response
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
specifier|const
name|rndis_msg
modifier|*
name|response
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
specifier|const
name|rndis_msg
modifier|*
name|response
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_query_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
name|void
modifier|*
name|result
parameter_list|,
name|uint32_t
modifier|*
name|result_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_set_packet_filter
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|new_filter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_open_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_close_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|hv_rf_send_offload_request
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|rndis_offload_params
modifier|*
name|offloads
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hn_rndis_sent_halt
parameter_list|(
name|struct
name|hn_send_ctx
modifier|*
name|sndc
parameter_list|,
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_channel
modifier|*
name|chan
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hn_rndis_sent_cb
parameter_list|(
name|struct
name|hn_send_ctx
modifier|*
name|sndc
parameter_list|,
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_channel
modifier|*
name|chan
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_query
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|idata
parameter_list|,
name|size_t
name|idlen
parameter_list|,
name|void
modifier|*
name|odata
parameter_list|,
name|size_t
modifier|*
name|odlen0
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_set
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|dlen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_conf_offload
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|__inline
name|uint32_t
name|hn_rndis_rid
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|rid
decl_stmt|;
name|again
label|:
name|rid
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|sc
operator|->
name|hn_rndis_rid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rid
operator|==
literal|0
condition|)
goto|goto
name|again
goto|;
comment|/* Use upper 16 bits for non-compat RNDIS messages. */
return|return
operator|(
operator|(
name|rid
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set the Per-Packet-Info with the specified type  */
end_comment

begin_function
name|void
modifier|*
name|hv_set_rppi_data
parameter_list|(
name|rndis_msg
modifier|*
name|rndis_mesg
parameter_list|,
name|uint32_t
name|rppi_size
parameter_list|,
name|int
name|pkt_type
parameter_list|)
block|{
name|rndis_packet
modifier|*
name|rndis_pkt
decl_stmt|;
name|rndis_per_packet_info
modifier|*
name|rppi
decl_stmt|;
name|rndis_pkt
operator|=
operator|&
name|rndis_mesg
operator|->
name|msg
operator|.
name|packet
expr_stmt|;
name|rndis_pkt
operator|->
name|data_offset
operator|+=
name|rppi_size
expr_stmt|;
name|rppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rndis_pkt
operator|+
name|rndis_pkt
operator|->
name|per_pkt_info_offset
operator|+
name|rndis_pkt
operator|->
name|per_pkt_info_length
operator|)
expr_stmt|;
name|rppi
operator|->
name|size
operator|=
name|rppi_size
expr_stmt|;
name|rppi
operator|->
name|type
operator|=
name|pkt_type
expr_stmt|;
name|rppi
operator|->
name|per_packet_info_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
expr_stmt|;
name|rndis_pkt
operator|->
name|per_pkt_info_length
operator|+=
name|rppi_size
expr_stmt|;
return|return
operator|(
name|rppi
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get the Per-Packet-Info with the specified type  * return NULL if not found.  */
end_comment

begin_function
name|void
modifier|*
name|hv_get_ppi_data
parameter_list|(
name|rndis_packet
modifier|*
name|rpkt
parameter_list|,
name|uint32_t
name|type
parameter_list|)
block|{
name|rndis_per_packet_info
modifier|*
name|ppi
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|rpkt
operator|->
name|per_pkt_info_offset
operator|==
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|rpkt
operator|+
name|rpkt
operator|->
name|per_pkt_info_offset
operator|)
expr_stmt|;
name|len
operator|=
name|rpkt
operator|->
name|per_pkt_info_length
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ppi
operator|->
name|type
operator|==
name|type
condition|)
return|return
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|ppi
operator|+
name|ppi
operator|->
name|per_packet_info_offset
operator|)
return|;
name|len
operator|-=
name|ppi
operator|->
name|size
expr_stmt|;
name|ppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|ppi
operator|+
name|ppi
operator|->
name|size
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allow module_param to work and override to switch to promiscuous mode.  */
end_comment

begin_function
specifier|static
specifier|inline
name|rndis_device
modifier|*
name|hv_get_rndis_device
parameter_list|(
name|void
parameter_list|)
block|{
name|rndis_device
modifier|*
name|device
decl_stmt|;
name|device
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rndis_device
argument_list|)
argument_list|,
name|M_NETVSC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|,
literal|"HV-FRL"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
comment|/* Same effect as STAILQ_HEAD_INITIALIZER() static initializer */
name|STAILQ_INIT
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|)
expr_stmt|;
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
return|return
operator|(
name|device
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|hv_put_rndis_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|device
argument_list|,
name|M_NETVSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|rndis_request
modifier|*
name|hv_rndis_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|message_type
parameter_list|,
name|uint32_t
name|message_length
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_msg
modifier|*
name|rndis_mesg
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|request
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rndis_request
argument_list|)
argument_list|,
name|M_NETVSC
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|0
argument_list|,
literal|"rndis sema"
argument_list|)
expr_stmt|;
name|rndis_mesg
operator|=
operator|&
name|request
operator|->
name|request_msg
expr_stmt|;
name|rndis_mesg
operator|->
name|ndis_msg_type
operator|=
name|message_type
expr_stmt|;
name|rndis_mesg
operator|->
name|msg_len
operator|=
name|message_length
expr_stmt|;
comment|/* 	 * Set the request id. This field is always after the rndis header 	 * for request/response packet types so we just use the set_request 	 * as a template. 	 */
name|set
operator|=
operator|&
name|rndis_mesg
operator|->
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|request_id
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|device
operator|->
name|new_request_id
argument_list|,
literal|1
argument_list|)
operator|&
name|HN_RNDIS_RID_COMPAT_MASK
expr_stmt|;
comment|/* Add to the request list */
name|mtx_lock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|,
name|request
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|request
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|hv_put_rndis_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
comment|/* Fixme:  Has O(n) performance */
comment|/* 	 * XXXKYS: Use Doubly linked lists. 	 */
name|STAILQ_REMOVE
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|,
name|request
argument_list|,
name|rndis_request_
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|sema_destroy
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|request
argument_list|,
name|M_NETVSC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_send_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|,
name|uint32_t
name|message_type
parameter_list|)
block|{
name|struct
name|hn_softc
modifier|*
name|sc
init|=
name|device
operator|->
name|sc
decl_stmt|;
name|uint32_t
name|send_buf_section_idx
decl_stmt|,
name|tot_data_buf_len
decl_stmt|;
name|struct
name|vmbus_gpa
name|gpa
index|[
literal|2
index|]
decl_stmt|;
name|int
name|gpa_cnt
decl_stmt|,
name|send_buf_section_size
decl_stmt|;
name|hn_sent_callback_t
name|cb
decl_stmt|;
comment|/* Set up the packet to send it */
name|tot_data_buf_len
operator|=
name|request
operator|->
name|request_msg
operator|.
name|msg_len
expr_stmt|;
name|gpa_cnt
operator|=
literal|1
expr_stmt|;
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_page
operator|=
name|hv_get_phys_addr
argument_list|(
operator|&
name|request
operator|->
name|request_msg
argument_list|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_len
operator|=
name|request
operator|->
name|request_msg
operator|.
name|msg_len
expr_stmt|;
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_ofs
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|request
operator|->
name|request_msg
operator|&
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_ofs
operator|+
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_len
operator|>
name|PAGE_SIZE
condition|)
block|{
name|gpa_cnt
operator|=
literal|2
expr_stmt|;
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_len
operator|=
name|PAGE_SIZE
operator|-
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_ofs
expr_stmt|;
name|gpa
index|[
literal|1
index|]
operator|.
name|gpa_page
operator|=
name|hv_get_phys_addr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|request
operator|->
name|request_msg
operator|+
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_len
argument_list|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|gpa
index|[
literal|1
index|]
operator|.
name|gpa_ofs
operator|=
literal|0
expr_stmt|;
name|gpa
index|[
literal|1
index|]
operator|.
name|gpa_len
operator|=
name|request
operator|->
name|request_msg
operator|.
name|msg_len
operator|-
name|gpa
index|[
literal|0
index|]
operator|.
name|gpa_len
expr_stmt|;
block|}
if|if
condition|(
name|message_type
operator|!=
name|REMOTE_NDIS_HALT_MSG
condition|)
name|cb
operator|=
name|hn_rndis_sent_cb
expr_stmt|;
else|else
name|cb
operator|=
name|hn_rndis_sent_halt
expr_stmt|;
if|if
condition|(
name|tot_data_buf_len
operator|<
name|sc
operator|->
name|hn_chim_szmax
condition|)
block|{
name|send_buf_section_idx
operator|=
name|hn_chim_alloc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_buf_section_idx
operator|!=
name|HN_NVS_CHIM_IDX_INVALID
condition|)
block|{
name|uint8_t
modifier|*
name|dest
init|=
name|sc
operator|->
name|hn_chim
operator|+
operator|(
name|send_buf_section_idx
operator|*
name|sc
operator|->
name|hn_chim_szmax
operator|)
decl_stmt|;
name|memcpy
argument_list|(
name|dest
argument_list|,
operator|&
name|request
operator|->
name|request_msg
argument_list|,
name|request
operator|->
name|request_msg
operator|.
name|msg_len
argument_list|)
expr_stmt|;
name|send_buf_section_size
operator|=
name|tot_data_buf_len
expr_stmt|;
name|gpa_cnt
operator|=
literal|0
expr_stmt|;
goto|goto
name|sendit
goto|;
block|}
comment|/* Failed to allocate chimney send buffer; move on */
block|}
name|send_buf_section_idx
operator|=
name|HN_NVS_CHIM_IDX_INVALID
expr_stmt|;
name|send_buf_section_size
operator|=
literal|0
expr_stmt|;
name|sendit
label|:
name|hn_send_ctx_init
argument_list|(
operator|&
name|request
operator|->
name|send_ctx
argument_list|,
name|cb
argument_list|,
name|request
argument_list|,
name|send_buf_section_idx
argument_list|,
name|send_buf_section_size
argument_list|)
expr_stmt|;
return|return
name|hv_nv_on_send
argument_list|(
name|sc
operator|->
name|hn_prichan
argument_list|,
name|HN_NVS_RNDIS_MTYPE_CTRL
argument_list|,
operator|&
name|request
operator|->
name|send_ctx
argument_list|,
name|gpa
argument_list|,
name|gpa_cnt
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive response  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_response
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
specifier|const
name|rndis_msg
modifier|*
name|response
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|rndis_request
modifier|*
name|next_request
decl_stmt|;
name|boolean_t
name|found
init|=
name|FALSE
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|request
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * All request/response message contains request_id as the 		 * first field 		 */
if|if
condition|(
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|init_request
operator|.
name|request_id
operator|==
name|response
operator|->
name|msg
operator|.
name|init_complete
operator|.
name|request_id
condition|)
block|{
name|found
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|next_request
operator|=
name|STAILQ_NEXT
argument_list|(
name|request
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|request
operator|=
name|next_request
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|found
condition|)
block|{
if|if
condition|(
name|response
operator|->
name|msg_len
operator|<=
sizeof|sizeof
argument_list|(
name|rndis_msg
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|request
operator|->
name|response_msg
argument_list|,
name|response
argument_list|,
name|response
operator|->
name|msg_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|init_complete
operator|.
name|status
operator|=
name|RNDIS_STATUS_BUFFER_OVERFLOW
expr_stmt|;
block|}
name|sema_post
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|hv_rf_send_offload_request
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|rndis_offload_params
modifier|*
name|offloads
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|rndis_offload_params
modifier|*
name|offload_req
decl_stmt|;
name|rndis_set_complete
modifier|*
name|set_complete
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
init|=
name|sc
operator|->
name|rndis_dev
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|hn_dev
decl_stmt|;
name|uint32_t
name|extlen
init|=
sizeof|sizeof
argument_list|(
name|rndis_offload_params
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_nvs_ver
operator|<=
name|NVSP_PROTOCOL_VERSION_4
condition|)
block|{
name|extlen
operator|=
name|VERSION_4_OFFLOAD_SIZE
expr_stmt|;
comment|/* On NVSP_PROTOCOL_VERSION_4 and below, we do not support 		 * UDP checksum offload. 		 */
name|offloads
operator|->
name|udp_ipv4_csum
operator|=
literal|0
expr_stmt|;
name|offloads
operator|->
name|udp_ipv6_csum
operator|=
literal|0
expr_stmt|;
block|}
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|rndis_dev
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_set_request
argument_list|)
operator|+
name|extlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|set
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|oid
operator|=
name|RNDIS_OID_TCP_OFFLOAD_PARAMETERS
expr_stmt|;
name|set
operator|->
name|info_buffer_length
operator|=
name|extlen
expr_stmt|;
name|set
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
expr_stmt|;
name|set
operator|->
name|device_vc_handle
operator|=
literal|0
expr_stmt|;
name|offload_req
operator|=
operator|(
name|rndis_offload_params
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|set
operator|+
name|set
operator|->
name|info_buffer_offset
operator|)
expr_stmt|;
operator|*
name|offload_req
operator|=
operator|*
name|offloads
expr_stmt|;
name|offload_req
operator|->
name|header
operator|.
name|type
operator|=
name|RNDIS_OBJECT_TYPE_DEFAULT
expr_stmt|;
name|offload_req
operator|->
name|header
operator|.
name|revision
operator|=
name|RNDIS_OFFLOAD_PARAMETERS_REVISION_3
expr_stmt|;
name|offload_req
operator|->
name|header
operator|.
name|size
operator|=
name|extlen
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|rndis_dev
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv send offload request failed, ret=%d!\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|ret
operator|=
name|sema_timedwait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|5
operator|*
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv send offload request timeout\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|set_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|set_complete
expr_stmt|;
if|if
condition|(
name|set_complete
operator|->
name|status
operator|==
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv send offload request succeeded\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|set_complete
operator|->
name|status
operator|==
name|RNDIS_STATUS_NOT_SUPPORTED
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"HV Not support offload\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|set_complete
operator|->
name|status
expr_stmt|;
block|}
block|}
name|cleanup
label|:
name|hv_put_rndis_request
argument_list|(
name|rndis_dev
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive indicate status  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
specifier|const
name|rndis_msg
modifier|*
name|response
parameter_list|)
block|{
specifier|const
name|rndis_indicate_status
modifier|*
name|indicate
init|=
operator|&
name|response
operator|->
name|msg
operator|.
name|indicate_status
decl_stmt|;
switch|switch
condition|(
name|indicate
operator|->
name|status
condition|)
block|{
case|case
name|RNDIS_STATUS_MEDIA_CONNECT
case|:
name|netvsc_linkstatus_callback
argument_list|(
name|device
operator|->
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RNDIS_STATUS_MEDIA_DISCONNECT
case|:
name|netvsc_linkstatus_callback
argument_list|(
name|device
operator|->
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* TODO: */
name|device_printf
argument_list|(
name|device
operator|->
name|sc
operator|->
name|hn_dev
argument_list|,
literal|"unknown status %d received\n"
argument_list|,
name|indicate
operator|->
name|status
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hv_rf_find_recvinfo
parameter_list|(
specifier|const
name|rndis_packet
modifier|*
name|rpkt
parameter_list|,
name|struct
name|hn_recvinfo
modifier|*
name|info
parameter_list|)
block|{
specifier|const
name|rndis_per_packet_info
modifier|*
name|ppi
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|,
name|len
decl_stmt|;
name|info
operator|->
name|vlan_info
operator|=
name|NULL
expr_stmt|;
name|info
operator|->
name|csum_info
operator|=
name|NULL
expr_stmt|;
name|info
operator|->
name|hash_info
operator|=
name|NULL
expr_stmt|;
name|info
operator|->
name|hash_value
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|rpkt
operator|->
name|per_pkt_info_offset
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|ppi
operator|=
operator|(
specifier|const
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|rpkt
operator|+
name|rpkt
operator|->
name|per_pkt_info_offset
operator|)
expr_stmt|;
name|len
operator|=
name|rpkt
operator|->
name|per_pkt_info_length
expr_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
specifier|const
name|void
modifier|*
name|ppi_dptr
decl_stmt|;
name|uint32_t
name|ppi_dlen
decl_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|ppi
operator|->
name|size
operator|<
name|ppi
operator|->
name|per_packet_info_offset
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|ppi_dlen
operator|=
name|ppi
operator|->
name|size
operator|-
name|ppi
operator|->
name|per_packet_info_offset
expr_stmt|;
name|ppi_dptr
operator|=
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|ppi
operator|+
name|ppi
operator|->
name|per_packet_info_offset
expr_stmt|;
switch|switch
condition|(
name|ppi
operator|->
name|type
condition|)
block|{
case|case
name|ieee_8021q_info
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|ppi_dlen
operator|<
sizeof|sizeof
argument_list|(
name|ndis_8021q_info
argument_list|)
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|info
operator|->
name|vlan_info
operator|=
name|ppi_dptr
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_VLAN
expr_stmt|;
break|break;
case|case
name|tcpip_chksum_info
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|ppi_dlen
operator|<
sizeof|sizeof
argument_list|(
name|rndis_tcp_ip_csum_info
argument_list|)
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|info
operator|->
name|csum_info
operator|=
name|ppi_dptr
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_CSUM
expr_stmt|;
break|break;
case|case
name|nbl_hash_value
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|ppi_dlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|rndis_hash_value
argument_list|)
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|info
operator|->
name|hash_value
operator|=
name|ppi_dptr
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_HASHVAL
expr_stmt|;
break|break;
case|case
name|nbl_hash_info
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|ppi_dlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|rndis_hash_info
argument_list|)
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|info
operator|->
name|hash_info
operator|=
name|ppi_dptr
expr_stmt|;
name|mask
operator||=
name|HV_RF_RECVINFO_HASHINF
expr_stmt|;
break|break;
default|default:
goto|goto
name|skip
goto|;
block|}
if|if
condition|(
name|mask
operator|==
name|HV_RF_RECVINFO_ALL
condition|)
block|{
comment|/* All found; done */
break|break;
block|}
name|skip
label|:
if|if
condition|(
name|__predict_false
argument_list|(
name|len
operator|<
name|ppi
operator|->
name|size
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|len
operator|-=
name|ppi
operator|->
name|size
expr_stmt|;
name|ppi
operator|=
operator|(
specifier|const
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|ppi
operator|+
name|ppi
operator|->
name|size
operator|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive data  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
block|{
specifier|const
name|rndis_msg
modifier|*
name|message
init|=
name|data
decl_stmt|;
specifier|const
name|rndis_packet
modifier|*
name|rndis_pkt
decl_stmt|;
name|uint32_t
name|data_offset
decl_stmt|;
name|struct
name|hn_recvinfo
name|info
decl_stmt|;
name|rndis_pkt
operator|=
operator|&
name|message
operator|->
name|msg
operator|.
name|packet
expr_stmt|;
comment|/* 	 * Fixme:  Handle multiple rndis pkt msgs that may be enclosed in this 	 * netvsc packet (ie tot_data_buf_len != message_length) 	 */
comment|/* Remove rndis header, then pass data packet up the stack */
name|data_offset
operator|=
name|RNDIS_HEADER_SIZE
operator|+
name|rndis_pkt
operator|->
name|data_offset
expr_stmt|;
name|dlen
operator|-=
name|data_offset
expr_stmt|;
if|if
condition|(
name|dlen
operator|<
name|rndis_pkt
operator|->
name|data_length
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"total length %u is less than data length %u\n"
argument_list|,
name|dlen
argument_list|,
name|rndis_pkt
operator|->
name|data_length
argument_list|)
expr_stmt|;
return|return;
block|}
name|dlen
operator|=
name|rndis_pkt
operator|->
name|data_length
expr_stmt|;
name|data
operator|=
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|data
operator|+
name|data_offset
expr_stmt|;
if|if
condition|(
name|hv_rf_find_recvinfo
argument_list|(
name|rndis_pkt
argument_list|,
operator|&
name|info
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|rxr
operator|->
name|hn_ifp
argument_list|,
literal|"recvinfo parsing failed\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|netvsc_recv
argument_list|(
name|rxr
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on receive  */
end_comment

begin_function
name|int
name|hv_rf_on_receive
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
block|{
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
specifier|const
name|rndis_msg
modifier|*
name|rndis_hdr
decl_stmt|;
specifier|const
name|struct
name|rndis_comp_hdr
modifier|*
name|comp
decl_stmt|;
name|rndis_dev
operator|=
name|sc
operator|->
name|rndis_dev
expr_stmt|;
if|if
condition|(
name|rndis_dev
operator|->
name|state
operator|==
name|RNDIS_DEV_UNINITIALIZED
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rndis_hdr
operator|=
name|data
expr_stmt|;
switch|switch
condition|(
name|rndis_hdr
operator|->
name|ndis_msg_type
condition|)
block|{
comment|/* data message */
case|case
name|REMOTE_NDIS_PACKET_MSG
case|:
name|hv_rf_receive_data
argument_list|(
name|rxr
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
break|break;
comment|/* completion messages */
case|case
name|REMOTE_NDIS_INITIALIZE_CMPLT
case|:
case|case
name|REMOTE_NDIS_QUERY_CMPLT
case|:
case|case
name|REMOTE_NDIS_SET_CMPLT
case|:
case|case
name|REMOTE_NDIS_KEEPALIVE_CMPLT
case|:
name|comp
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|comp
operator|->
name|rm_rid
operator|<=
name|HN_RNDIS_RID_COMPAT_MAX
condition|)
block|{
comment|/* Transition time compat code */
name|hv_rf_receive_response
argument_list|(
name|rndis_dev
argument_list|,
name|rndis_hdr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vmbus_xact_ctx_wakeup
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
block|}
break|break;
comment|/* notification message */
case|case
name|REMOTE_NDIS_INDICATE_STATUS_MSG
case|:
name|hv_rf_receive_indicate_status
argument_list|(
name|rndis_dev
argument_list|,
name|rndis_hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|REMOTE_NDIS_RESET_CMPLT
case|:
comment|/* 		 * Reset completed, no rid. 		 * 		 * NOTE: 		 * RESET is not issued by hn(4), so this message should 		 * _not_ be observed. 		 */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RESET CMPLT received\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"unknown RNDIS message 0x%x\n"
argument_list|,
name|rndis_hdr
operator|->
name|ndis_msg_type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_query_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
name|void
modifier|*
name|result
parameter_list|,
name|uint32_t
modifier|*
name|result_size
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|uint32_t
name|in_result_size
init|=
operator|*
name|result_size
decl_stmt|;
name|rndis_query_request
modifier|*
name|query
decl_stmt|;
name|rndis_query_complete
modifier|*
name|query_complete
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
operator|*
name|result_size
operator|=
literal|0
expr_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_QUERY_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_query_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis query */
name|query
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|query_request
expr_stmt|;
name|query
operator|->
name|oid
operator|=
name|oid
expr_stmt|;
name|query
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_query_request
argument_list|)
expr_stmt|;
name|query
operator|->
name|info_buffer_length
operator|=
literal|0
expr_stmt|;
name|query
operator|->
name|device_vc_handle
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|oid
operator|==
name|RNDIS_OID_GEN_RSS_CAPABILITIES
condition|)
block|{
name|struct
name|rndis_recv_scale_cap
modifier|*
name|cap
decl_stmt|;
name|request
operator|->
name|request_msg
operator|.
name|msg_len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|rndis_recv_scale_cap
argument_list|)
expr_stmt|;
name|query
operator|->
name|info_buffer_length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|rndis_recv_scale_cap
argument_list|)
expr_stmt|;
name|cap
operator|=
operator|(
expr|struct
name|rndis_recv_scale_cap
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|query
operator|+
name|query
operator|->
name|info_buffer_offset
operator|)
expr_stmt|;
name|cap
operator|->
name|hdr
operator|.
name|type
operator|=
name|RNDIS_OBJECT_TYPE_RSS_CAPABILITIES
expr_stmt|;
name|cap
operator|->
name|hdr
operator|.
name|rev
operator|=
name|RNDIS_RECEIVE_SCALE_CAPABILITIES_REVISION_2
expr_stmt|;
name|cap
operator|->
name|hdr
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|rndis_recv_scale_cap
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_QUERY_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* Fixme:  printf added */
name|printf
argument_list|(
literal|"RNDISFILTER request failed to Send!\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|sema_wait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
comment|/* Copy the response back */
name|query_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|query_complete
expr_stmt|;
if|if
condition|(
name|query_complete
operator|->
name|info_buffer_length
operator|>
name|in_result_size
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|memcpy
argument_list|(
name|result
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|query_complete
operator|+
name|query_complete
operator|->
name|info_buffer_offset
operator|)
argument_list|,
name|query_complete
operator|->
name|info_buffer_length
argument_list|)
expr_stmt|;
operator|*
name|result_size
operator|=
name|query_complete
operator|->
name|info_buffer_length
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device MAC address  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|hn_softc
modifier|*
name|sc
init|=
name|device
operator|->
name|sc
decl_stmt|;
name|size_t
name|hwaddr_len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|hwaddr_len
operator|=
name|ETHER_ADDR_LEN
expr_stmt|;
name|error
operator|=
name|hn_rndis_query
argument_list|(
name|sc
argument_list|,
name|OID_802_3_PERMANENT_ADDRESS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|device
operator|->
name|hw_mac_addr
argument_list|,
operator|&
name|hwaddr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
name|hwaddr_len
operator|!=
name|ETHER_ADDR_LEN
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid hwaddr len %zu\n"
argument_list|,
name|hwaddr_len
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device link status  */
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|uint32_t
name|size
init|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
decl_stmt|;
return|return
operator|(
name|hv_rf_query_device
argument_list|(
name|device
argument_list|,
name|RNDIS_OID_GEN_MEDIA_CONNECT_STATUS
argument_list|,
operator|&
name|device
operator|->
name|link_status
argument_list|,
operator|&
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint8_t
name|netvsc_hash_key
index|[
name|HASH_KEYLEN
index|]
init|=
block|{
literal|0x6d
block|,
literal|0x5a
block|,
literal|0x56
block|,
literal|0xda
block|,
literal|0x25
block|,
literal|0x5b
block|,
literal|0x0e
block|,
literal|0xc2
block|,
literal|0x41
block|,
literal|0x67
block|,
literal|0x25
block|,
literal|0x3d
block|,
literal|0x43
block|,
literal|0xa3
block|,
literal|0x8f
block|,
literal|0xb0
block|,
literal|0xd0
block|,
literal|0xca
block|,
literal|0x2b
block|,
literal|0xcb
block|,
literal|0xae
block|,
literal|0x7b
block|,
literal|0x30
block|,
literal|0xb4
block|,
literal|0x77
block|,
literal|0xcb
block|,
literal|0x2d
block|,
literal|0xa3
block|,
literal|0x80
block|,
literal|0x30
block|,
literal|0xf2
block|,
literal|0x0c
block|,
literal|0x6a
block|,
literal|0x42
block|,
literal|0xb7
block|,
literal|0x3b
block|,
literal|0xbe
block|,
literal|0xac
block|,
literal|0x01
block|,
literal|0xfa
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * RNDIS set vRSS parameters  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_set_rss_param
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|int
name|num_queue
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|rndis_set_complete
modifier|*
name|set_complete
decl_stmt|;
name|rndis_recv_scale_param
modifier|*
name|rssp
decl_stmt|;
name|uint32_t
name|extlen
init|=
sizeof|sizeof
argument_list|(
name|rndis_recv_scale_param
argument_list|)
operator|+
operator|(
literal|4
operator|*
name|ITAB_NUM
operator|)
operator|+
name|HASH_KEYLEN
decl_stmt|;
name|uint32_t
modifier|*
name|itab
decl_stmt|,
name|status
decl_stmt|;
name|uint8_t
modifier|*
name|keyp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_set_request
argument_list|)
operator|+
name|extlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"Netvsc: No memory to set vRSS parameters.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|set
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|oid
operator|=
name|RNDIS_OID_GEN_RSS_PARAMETERS
expr_stmt|;
name|set
operator|->
name|info_buffer_length
operator|=
name|extlen
expr_stmt|;
name|set
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
expr_stmt|;
name|set
operator|->
name|device_vc_handle
operator|=
literal|0
expr_stmt|;
comment|/* Fill out the rssp parameter structure */
name|rssp
operator|=
operator|(
name|rndis_recv_scale_param
operator|*
operator|)
operator|(
name|set
operator|+
literal|1
operator|)
expr_stmt|;
name|rssp
operator|->
name|hdr
operator|.
name|type
operator|=
name|RNDIS_OBJECT_TYPE_RSS_PARAMETERS
expr_stmt|;
name|rssp
operator|->
name|hdr
operator|.
name|rev
operator|=
name|RNDIS_RECEIVE_SCALE_PARAMETERS_REVISION_2
expr_stmt|;
name|rssp
operator|->
name|hdr
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
name|rndis_recv_scale_param
argument_list|)
expr_stmt|;
name|rssp
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
name|rssp
operator|->
name|hashinfo
operator|=
name|RNDIS_HASH_FUNC_TOEPLITZ
operator||
name|RNDIS_HASH_IPV4
operator||
name|RNDIS_HASH_TCP_IPV4
operator||
name|RNDIS_HASH_IPV6
operator||
name|RNDIS_HASH_TCP_IPV6
expr_stmt|;
name|rssp
operator|->
name|indirect_tabsize
operator|=
literal|4
operator|*
name|ITAB_NUM
expr_stmt|;
name|rssp
operator|->
name|indirect_taboffset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_recv_scale_param
argument_list|)
expr_stmt|;
name|rssp
operator|->
name|hashkey_size
operator|=
name|HASH_KEYLEN
expr_stmt|;
name|rssp
operator|->
name|hashkey_offset
operator|=
name|rssp
operator|->
name|indirect_taboffset
operator|+
name|rssp
operator|->
name|indirect_tabsize
expr_stmt|;
comment|/* Set indirection table entries */
name|itab
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|rssp
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ITAB_NUM
condition|;
name|i
operator|++
control|)
name|itab
index|[
name|i
index|]
operator|=
name|i
operator|%
name|num_queue
expr_stmt|;
comment|/* Set hash key values */
name|keyp
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|rssp
operator|+
name|rssp
operator|->
name|hashkey_offset
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|HASH_KEYLEN
condition|;
name|i
operator|++
control|)
name|keyp
index|[
name|i
index|]
operator|=
name|netvsc_hash_key
index|[
name|i
index|]
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Wait for the response from the host.  Another thread will signal 	 * us when the response has arrived.  In the failure case, 	 * sema_timedwait() returns a non-zero status after waiting 5 seconds. 	 */
name|ret
operator|=
name|sema_timedwait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|5
operator|*
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
comment|/* Response received, check status */
name|set_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|set_complete
expr_stmt|;
name|status
operator|=
name|set_complete
operator|->
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
comment|/* Bad response status, return error */
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"Netvsc: Failed to set vRSS "
literal|"parameters.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|2
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"Netvsc: Successfully set vRSS "
literal|"parameters.\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * We cannot deallocate the request since we may still 		 * receive a send completion for it. 		 */
name|printf
argument_list|(
literal|"Netvsc: vRSS set timeout, id = %u, ret = %d\n"
argument_list|,
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|init_request
operator|.
name|request_id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|cleanup
label|:
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
name|exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter set packet filter  * Sends an rndis request with the new filter, then waits for a response  * from the host.  * Returns zero on success, non-zero on failure.  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_set_packet_filter
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|new_filter
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|rndis_set_complete
modifier|*
name|set_complete
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_set_request
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis set */
name|set
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|oid
operator|=
name|RNDIS_OID_GEN_CURRENT_PACKET_FILTER
expr_stmt|;
name|set
operator|->
name|info_buffer_length
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|set
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|set
operator|+
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
operator|)
argument_list|,
operator|&
name|new_filter
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Wait for the response from the host.  Another thread will signal 	 * us when the response has arrived.  In the failure case, 	 * sema_timedwait() returns a non-zero status after waiting 5 seconds. 	 */
name|ret
operator|=
name|sema_timedwait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|5
operator|*
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
comment|/* Response received, check status */
name|set_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|set_complete
expr_stmt|;
name|status
operator|=
name|set_complete
operator|->
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
comment|/* Bad response status, return error */
name|ret
operator|=
operator|-
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * We cannot deallocate the request since we may still 		 * receive a send completion for it. 		 */
goto|goto
name|exit
goto|;
block|}
name|cleanup
label|:
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
name|exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|void
modifier|*
name|hn_rndis_xact_execute
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_xact
modifier|*
name|xact
parameter_list|,
name|uint32_t
name|rid
parameter_list|,
name|size_t
name|reqlen
parameter_list|,
name|size_t
modifier|*
name|comp_len0
parameter_list|,
name|uint32_t
name|comp_type
parameter_list|)
block|{
name|struct
name|vmbus_gpa
name|gpa
index|[
name|HN_XACT_REQ_PGCNT
index|]
decl_stmt|;
specifier|const
name|struct
name|rndis_comp_hdr
modifier|*
name|comp
decl_stmt|;
name|bus_addr_t
name|paddr
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|,
name|min_complen
init|=
operator|*
name|comp_len0
decl_stmt|;
name|int
name|gpa_cnt
decl_stmt|,
name|error
decl_stmt|;
name|KASSERT
argument_list|(
name|rid
operator|>
name|HN_RNDIS_RID_COMPAT_MAX
argument_list|,
operator|(
literal|"invalid rid %u\n"
operator|,
name|rid
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|reqlen
operator|<=
name|HN_XACT_REQ_SIZE
operator|&&
name|reqlen
operator|>
literal|0
argument_list|,
operator|(
literal|"invalid request length %zu"
operator|,
name|reqlen
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|min_complen
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
argument_list|,
operator|(
literal|"invalid minimum complete len %zu"
operator|,
name|min_complen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Setup the SG list. 	 */
name|paddr
operator|=
name|vmbus_xact_req_paddr
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|paddr
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"vmbus xact request is not page aligned 0x%jx"
operator|,
operator|(
name|uintmax_t
operator|)
name|paddr
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|gpa_cnt
operator|=
literal|0
init|;
name|gpa_cnt
operator|<
name|HN_XACT_REQ_PGCNT
condition|;
operator|++
name|gpa_cnt
control|)
block|{
name|int
name|len
init|=
name|PAGE_SIZE
decl_stmt|;
if|if
condition|(
name|reqlen
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|reqlen
operator|<
name|len
condition|)
name|len
operator|=
name|reqlen
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_page
operator|=
name|atop
argument_list|(
name|paddr
argument_list|)
operator|+
name|gpa_cnt
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_len
operator|=
name|len
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_ofs
operator|=
literal|0
expr_stmt|;
name|reqlen
operator|-=
name|len
expr_stmt|;
block|}
name|KASSERT
argument_list|(
name|reqlen
operator|==
literal|0
argument_list|,
operator|(
literal|"still have %zu request data left"
operator|,
name|reqlen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Send this RNDIS control message and wait for its completion 	 * message. 	 */
name|vmbus_xact_activate
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|error
operator|=
name|hv_nv_on_send
argument_list|(
name|sc
operator|->
name|hn_prichan
argument_list|,
name|HN_NVS_RNDIS_MTYPE_CTRL
argument_list|,
operator|&
name|hn_send_ctx_none
argument_list|,
name|gpa
argument_list|,
name|gpa_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vmbus_xact_deactivate
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS ctrl send failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|comp
operator|=
name|vmbus_xact_wait
argument_list|(
name|xact
argument_list|,
operator|&
name|comp_len
argument_list|)
expr_stmt|;
comment|/* 	 * Check this RNDIS complete message. 	 */
if|if
condition|(
name|comp_len
operator|<
name|min_complen
condition|)
block|{
if|if
condition|(
name|comp_len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
condition|)
block|{
comment|/* rm_status field is valid */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp len %zu, "
literal|"status 0x%08x\n"
argument_list|,
name|comp_len
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp len %zu\n"
argument_list|,
name|comp_len
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_len
operator|<
name|min_complen
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp msglen %u\n"
argument_list|,
name|comp
operator|->
name|rm_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_type
operator|!=
name|comp_type
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"unexpected RNDIS comp 0x%08x, "
literal|"expect 0x%08x\n"
argument_list|,
name|comp
operator|->
name|rm_type
argument_list|,
name|comp_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_rid
operator|!=
name|rid
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS comp rid mismatch %u, "
literal|"expect %u\n"
argument_list|,
name|comp
operator|->
name|rm_rid
argument_list|,
name|rid
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* All pass! */
operator|*
name|comp_len0
operator|=
name|comp_len
expr_stmt|;
return|return
operator|(
name|comp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_query
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|idata
parameter_list|,
name|size_t
name|idlen
parameter_list|,
name|void
modifier|*
name|odata
parameter_list|,
name|size_t
modifier|*
name|odlen0
parameter_list|)
block|{
name|struct
name|rndis_query_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_query_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|,
name|odlen
init|=
operator|*
name|odlen0
decl_stmt|,
name|comp_len
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ofs
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|reqlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
name|idlen
expr_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|reqlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS query 0x%08x\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_QUERY_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
name|reqlen
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_oid
operator|=
name|oid
expr_stmt|;
comment|/* 	 * XXX 	 * This is _not_ RNDIS Spec conforming: 	 * "This MUST be set to 0 when there is no input data 	 *  associated with the OID." 	 * 	 * If this field was set to 0 according to the RNDIS Spec, 	 * Hyper-V would set non-SUCCESS status in the query 	 * completion. 	 */
name|req
operator|->
name|rm_infobufoffset
operator|=
name|RNDIS_QUERY_REQ_INFOBUFOFFSET
expr_stmt|;
if|if
condition|(
name|idlen
operator|>
literal|0
condition|)
block|{
name|req
operator|->
name|rm_infobuflen
operator|=
name|idlen
expr_stmt|;
comment|/* Input data immediately follows RNDIS query. */
name|memcpy
argument_list|(
name|req
operator|+
literal|1
argument_list|,
name|idata
argument_list|,
name|idlen
argument_list|)
expr_stmt|;
block|}
name|comp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
operator|+
name|odlen
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
name|reqlen
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_QUERY_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS query 0x%08x failed\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query 0x%08x failed: "
literal|"status 0x%08x\n"
argument_list|,
name|oid
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_infobuflen
operator|==
literal|0
operator|||
name|comp
operator|->
name|rm_infobufoffset
operator|==
literal|0
condition|)
block|{
comment|/* No output data! */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query 0x%08x, no data\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
operator|*
name|odlen0
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Check output data length and offset. 	 */
comment|/* ofs is the offset from the beginning of comp. */
name|ofs
operator|=
name|RNDIS_QUERY_COMP_INFOBUFABS
argument_list|(
name|comp
operator|->
name|rm_infobufoffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofs
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
operator|||
name|ofs
operator|+
name|comp
operator|->
name|rm_infobuflen
operator|>
name|comp_len
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query invalid comp ib off/len, "
literal|"%u/%u\n"
argument_list|,
name|comp
operator|->
name|rm_infobufoffset
argument_list|,
name|comp
operator|->
name|rm_infobuflen
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Save output data. 	 */
if|if
condition|(
name|comp
operator|->
name|rm_infobuflen
operator|<
name|odlen
condition|)
name|odlen
operator|=
name|comp
operator|->
name|rm_infobuflen
expr_stmt|;
name|memcpy
argument_list|(
name|odata
argument_list|,
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|comp
operator|)
operator|+
name|ofs
argument_list|,
name|odlen
argument_list|)
expr_stmt|;
operator|*
name|odlen0
operator|=
name|odlen
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_set
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|dlen
parameter_list|)
block|{
name|struct
name|rndis_set_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_set_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|,
name|comp_len
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|int
name|error
decl_stmt|;
name|KASSERT
argument_list|(
name|dlen
operator|>
literal|0
argument_list|,
operator|(
literal|"invalid dlen %zu"
operator|,
name|dlen
operator|)
argument_list|)
expr_stmt|;
name|reqlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
name|dlen
expr_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|reqlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS set 0x%08x\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_SET_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
name|reqlen
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_oid
operator|=
name|oid
expr_stmt|;
name|req
operator|->
name|rm_infobuflen
operator|=
name|dlen
expr_stmt|;
name|req
operator|->
name|rm_infobufoffset
operator|=
name|RNDIS_SET_REQ_INFOBUFOFFSET
expr_stmt|;
comment|/* Data immediately follows RNDIS set. */
name|memcpy
argument_list|(
name|req
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|comp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
name|reqlen
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_SET_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS set 0x%08x failed\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS set 0x%08x failed: "
literal|"status 0x%08x\n"
argument_list|,
name|oid
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_conf_offload
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ndis_offload_params
name|params
decl_stmt|;
name|size_t
name|paramsz
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* NOTE: 0 means "no change" */
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_DEFAULT
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|<
name|NDIS_VERSION_6_30
condition|)
block|{
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_PARAMS_REV_2
expr_stmt|;
name|paramsz
operator|=
name|NDIS_OFFLOAD_PARAMS_SIZE_6_1
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_PARAMS_REV_3
expr_stmt|;
name|paramsz
operator|=
name|NDIS_OFFLOAD_PARAMS_SIZE
expr_stmt|;
block|}
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|=
name|paramsz
expr_stmt|;
name|params
operator|.
name|ndis_ip4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
name|params
operator|.
name|ndis_tcp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
name|params
operator|.
name|ndis_tcp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|>=
name|NDIS_VERSION_6_30
condition|)
block|{
name|params
operator|.
name|ndis_udp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
name|params
operator|.
name|ndis_udp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
block|}
name|params
operator|.
name|ndis_lsov2_ip4
operator|=
name|NDIS_OFFLOAD_LSOV2_ON
expr_stmt|;
comment|/* XXX ndis_lsov2_ip6 = NDIS_OFFLOAD_LSOV2_ON */
name|error
operator|=
name|hn_rndis_set
argument_list|(
name|sc
argument_list|,
name|OID_TCP_OFFLOAD_PARAMETERS
argument_list|,
operator|&
name|params
argument_list|,
name|paramsz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload config failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload config done\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter init device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|hn_softc
modifier|*
name|sc
init|=
name|device
operator|->
name|sc
decl_stmt|;
name|struct
name|rndis_init_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_init_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* XXX */
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZED
expr_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS init\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_INITIALIZE_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_ver_major
operator|=
name|RNDIS_VERSION_MAJOR
expr_stmt|;
name|req
operator|->
name|rm_ver_minor
operator|=
name|RNDIS_VERSION_MINOR
expr_stmt|;
name|req
operator|->
name|rm_max_xfersz
operator|=
name|HN_RNDIS_XFER_SIZE
expr_stmt|;
name|comp_len
operator|=
name|RNDIS_INIT_COMP_SIZE_MIN
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_INITIALIZE_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS init failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS init failed: status 0x%08x\n"
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS ver %u.%u, pktsz %u, pktcnt %u\n"
argument_list|,
name|comp
operator|->
name|rm_ver_major
argument_list|,
name|comp
operator|->
name|rm_ver_minor
argument_list|,
name|comp
operator|->
name|rm_pktmaxsz
argument_list|,
name|comp
operator|->
name|rm_pktmaxcnt
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
if|if
condition|(
name|xact
operator|!=
name|NULL
condition|)
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|HALT_COMPLETION_WAIT_COUNT
value|25
end_define

begin_comment
comment|/*  * RNDIS filter halt device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_halt_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
comment|/* Attempt to do a rndis device halt */
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_HALT_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_halt_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* initialize "poor man's semaphore" */
name|request
operator|->
name|halt_complete_flag
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_HALT_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Wait for halt response from halt callback.  We must wait for 	 * the transaction response before freeing the request and other 	 * resources. 	 */
for|for
control|(
name|i
operator|=
name|HALT_COMPLETION_WAIT_COUNT
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|request
operator|->
name|halt_complete_flag
operator|!=
literal|0
condition|)
block|{
break|break;
block|}
name|DELAY
argument_list|(
literal|400
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter open device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_open_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|device
operator|->
name|state
operator|!=
name|RNDIS_DEV_INITIALIZED
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|hv_promisc_mode
operator|!=
literal|1
condition|)
block|{
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
name|NDIS_PACKET_TYPE_BROADCAST
operator||
name|NDIS_PACKET_TYPE_ALL_MULTICAST
operator||
name|NDIS_PACKET_TYPE_DIRECTED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
name|NDIS_PACKET_TYPE_PROMISCUOUS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_DATAINITIALIZED
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter close device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_close_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|device
operator|->
name|state
operator|!=
name|RNDIS_DEV_DATAINITIALIZED
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZED
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device add  */
end_comment

begin_function
name|int
name|hv_rf_on_device_add
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|additl_info
parameter_list|,
name|int
modifier|*
name|nchan0
parameter_list|,
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|struct
name|rndis_recv_scale_cap
name|rsscaps
decl_stmt|;
name|uint32_t
name|rsscaps_size
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|rndis_recv_scale_cap
argument_list|)
decl_stmt|;
name|netvsc_device_info
modifier|*
name|dev_info
init|=
operator|(
name|netvsc_device_info
operator|*
operator|)
name|additl_info
decl_stmt|;
name|device_t
name|dev
init|=
name|sc
operator|->
name|hn_dev
decl_stmt|;
name|struct
name|hn_nvs_subch_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|hn_nvs_subch_resp
modifier|*
name|resp
decl_stmt|;
name|size_t
name|resp_len
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|status
decl_stmt|,
name|nsubch
decl_stmt|;
name|int
name|nchan
init|=
operator|*
name|nchan0
decl_stmt|;
name|rndis_dev
operator|=
name|hv_get_rndis_device
argument_list|()
expr_stmt|;
if|if
condition|(
name|rndis_dev
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|sc
operator|->
name|rndis_dev
operator|=
name|rndis_dev
expr_stmt|;
name|rndis_dev
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
comment|/* 	 * Let the inner driver handle this first to create the netvsc channel 	 * NOTE! Once the channel is created, we may get a receive callback  	 * (hv_rf_on_receive()) before this call is completed. 	 * Note:  Earlier code used a function pointer here. 	 */
name|ret
operator|=
name|hv_nv_on_device_add
argument_list|(
name|sc
argument_list|,
name|rxr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|hv_put_rndis_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
comment|/* 	 * Initialize the rndis device 	 */
comment|/* Send the rndis initialization message */
name|ret
operator|=
name|hv_rf_init_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* 		 * TODO: If rndis init failed, we will need to shut down 		 * the channel 		 */
block|}
comment|/* Get the mac address */
name|ret
operator|=
name|hv_rf_query_device_mac
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* TODO: shut down rndis device and the channel */
block|}
comment|/* Configure NDIS offload settings */
name|hn_rndis_conf_offload
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dev_info
operator|->
name|mac_addr
argument_list|,
name|rndis_dev
operator|->
name|hw_mac_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|hv_rf_query_device_link_status
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|dev_info
operator|->
name|link_state
operator|=
name|rndis_dev
operator|->
name|link_status
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_nvs_ver
operator|<
name|NVSP_PROTOCOL_VERSION_5
operator|||
name|nchan
operator|==
literal|1
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|memset
argument_list|(
operator|&
name|rsscaps
argument_list|,
literal|0
argument_list|,
name|rsscaps_size
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hv_rf_query_device
argument_list|(
name|rndis_dev
argument_list|,
name|RNDIS_OID_GEN_RSS_CAPABILITIES
argument_list|,
operator|&
name|rsscaps
argument_list|,
operator|&
name|rsscaps_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|!=
literal|0
operator|)
operator|||
operator|(
name|rsscaps
operator|.
name|num_recv_que
operator|<
literal|2
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"hv_rf_query_device failed or "
literal|"rsscaps.num_recv_que< 2 \n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"channel, offered %u, requested %d\n"
argument_list|,
name|rsscaps
operator|.
name|num_recv_que
argument_list|,
name|nchan
argument_list|)
expr_stmt|;
if|if
condition|(
name|nchan
operator|>
name|rsscaps
operator|.
name|num_recv_que
condition|)
name|nchan
operator|=
name|rsscaps
operator|.
name|num_recv_que
expr_stmt|;
if|if
condition|(
name|nchan
operator|==
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"only 1 channel is supported, no vRSS\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Ask NVS to allocate sub-channels. 	 */
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for nvs subch req\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|nvs_type
operator|=
name|HN_NVS_TYPE_SUBCH_REQ
expr_stmt|;
name|req
operator|->
name|nvs_op
operator|=
name|HN_NVS_SUBCH_OP_ALLOC
expr_stmt|;
name|req
operator|->
name|nvs_nsubch
operator|=
name|nchan
operator|-
literal|1
expr_stmt|;
name|resp
operator|=
name|hn_nvs_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|req
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|,
operator|&
name|resp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec subch failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|resp_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid subch resp length %zu\n"
argument_list|,
name|resp_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|resp
operator|->
name|nvs_type
operator|!=
name|HN_NVS_TYPE_SUBCH_RESP
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"not subch resp, type %u\n"
argument_list|,
name|resp
operator|->
name|nvs_type
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|status
operator|=
name|resp
operator|->
name|nvs_status
expr_stmt|;
name|nsubch
operator|=
name|resp
operator|->
name|nvs_nsubch
expr_stmt|;
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|xact
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|HN_NVS_STATUS_OK
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"subch req failed: %x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|nsubch
operator|>
name|nchan
operator|-
literal|1
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"%u subchans are allocated, requested %u\n"
argument_list|,
name|nsubch
argument_list|,
name|nchan
operator|-
literal|1
argument_list|)
expr_stmt|;
name|nsubch
operator|=
name|nchan
operator|-
literal|1
expr_stmt|;
block|}
name|nchan
operator|=
name|nsubch
operator|+
literal|1
expr_stmt|;
name|ret
operator|=
name|hv_rf_set_rss_param
argument_list|(
name|rndis_dev
argument_list|,
name|nchan
argument_list|)
expr_stmt|;
operator|*
name|nchan0
operator|=
name|nchan
expr_stmt|;
name|out
label|:
if|if
condition|(
name|xact
operator|!=
name|NULL
condition|)
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device remove  */
end_comment

begin_function
name|int
name|hv_rf_on_device_remove
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|boolean_t
name|destroy_channel
parameter_list|)
block|{
name|rndis_device
modifier|*
name|rndis_dev
init|=
name|sc
operator|->
name|rndis_dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Halt and release the rndis device */
name|ret
operator|=
name|hv_rf_halt_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rndis_dev
operator|=
name|NULL
expr_stmt|;
name|hv_put_rndis_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
comment|/* Pass control to inner driver to remove the device */
name|ret
operator||=
name|hv_nv_on_device_remove
argument_list|(
name|sc
argument_list|,
name|destroy_channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on open  */
end_comment

begin_function
name|int
name|hv_rf_on_open
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
name|hv_rf_open_device
argument_list|(
name|sc
operator|->
name|rndis_dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on close  */
end_comment

begin_function
name|int
name|hv_rf_on_close
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
name|hv_rf_close_device
argument_list|(
name|sc
operator|->
name|rndis_dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hn_rndis_sent_cb
parameter_list|(
name|struct
name|hn_send_ctx
modifier|*
name|sndc
parameter_list|,
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_channel
modifier|*
name|chan
name|__unused
parameter_list|,
specifier|const
name|void
modifier|*
name|data
name|__unused
parameter_list|,
name|int
name|dlen
name|__unused
parameter_list|)
block|{
if|if
condition|(
name|sndc
operator|->
name|hn_chim_idx
operator|!=
name|HN_NVS_CHIM_IDX_INVALID
condition|)
name|hn_chim_free
argument_list|(
name|sc
argument_list|,
name|sndc
operator|->
name|hn_chim_idx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hn_rndis_sent_halt
parameter_list|(
name|struct
name|hn_send_ctx
modifier|*
name|sndc
parameter_list|,
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_channel
modifier|*
name|chan
name|__unused
parameter_list|,
specifier|const
name|void
modifier|*
name|data
name|__unused
parameter_list|,
name|int
name|dlen
name|__unused
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
init|=
name|sndc
operator|->
name|hn_cbarg
decl_stmt|;
if|if
condition|(
name|sndc
operator|->
name|hn_chim_idx
operator|!=
name|HN_NVS_CHIM_IDX_INVALID
condition|)
name|hn_chim_free
argument_list|(
name|sc
argument_list|,
name|sndc
operator|->
name|hn_chim_idx
argument_list|)
expr_stmt|;
comment|/* 	 * Notify hv_rf_halt_device() about halt completion. 	 * The halt code must wait for completion before freeing 	 * the transaction resources. 	 */
name|request
operator|->
name|halt_complete_flag
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hv_rf_channel_rollup
parameter_list|(
name|struct
name|hn_rx_ring
modifier|*
name|rxr
parameter_list|,
name|struct
name|hn_tx_ring
modifier|*
name|txr
parameter_list|)
block|{
name|netvsc_channel_rollup
argument_list|(
name|rxr
argument_list|,
name|txr
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


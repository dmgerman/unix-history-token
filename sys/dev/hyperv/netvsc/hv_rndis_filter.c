begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2012 Microsoft Corp.  * Copyright (c) 2010-2012 Citrix Inc.  * Copyright (c) 2012 NetApp Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/hyperv.h>
end_include

begin_include
include|#
directive|include
file|"hv_net_vsc.h"
end_include

begin_include
include|#
directive|include
file|"hv_rndis.h"
end_include

begin_include
include|#
directive|include
file|"hv_rndis_filter.h"
end_include

begin_comment
comment|/*  * Forward declarations  */
end_comment

begin_function_decl
specifier|static
name|int
name|hv_rf_send_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|,
name|uint32_t
name|message_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_response
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|message
parameter_list|,
name|netvsc_packet
modifier|*
name|pkt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_query_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
name|void
modifier|*
name|result
parameter_list|,
name|uint32_t
modifier|*
name|result_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_set_packet_filter
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|new_filter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_open_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hv_rf_close_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_on_send_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_on_send_request_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hv_rf_on_send_request_halt_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Allow module_param to work and override to switch to promiscuous mode.  */
end_comment

begin_function
specifier|static
specifier|inline
name|rndis_device
modifier|*
name|hv_get_rndis_device
parameter_list|(
name|void
parameter_list|)
block|{
name|rndis_device
modifier|*
name|device
decl_stmt|;
name|device
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rndis_device
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|device
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|mtx_init
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|,
literal|"HV-FRL"
argument_list|,
name|NULL
argument_list|,
name|MTX_SPIN
operator||
name|MTX_RECURSE
argument_list|)
expr_stmt|;
comment|/* Same effect as STAILQ_HEAD_INITIALIZER() static initializer */
name|STAILQ_INIT
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|)
expr_stmt|;
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
return|return
operator|(
name|device
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|hv_put_rndis_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|device
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|rndis_request
modifier|*
name|hv_rndis_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|message_type
parameter_list|,
name|uint32_t
name|message_length
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_msg
modifier|*
name|rndis_mesg
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|request
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rndis_request
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|sema_init
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|0
argument_list|,
literal|"rndis sema"
argument_list|)
expr_stmt|;
name|rndis_mesg
operator|=
operator|&
name|request
operator|->
name|request_msg
expr_stmt|;
name|rndis_mesg
operator|->
name|ndis_msg_type
operator|=
name|message_type
expr_stmt|;
name|rndis_mesg
operator|->
name|msg_len
operator|=
name|message_length
expr_stmt|;
comment|/* 	 * Set the request id. This field is always after the rndis header 	 * for request/response packet types so we just use the set_request 	 * as a template. 	 */
name|set
operator|=
operator|&
name|rndis_mesg
operator|->
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|request_id
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|device
operator|->
name|new_request_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Increment to get the new value (call above returns old value) */
name|set
operator|->
name|request_id
operator|+=
literal|1
expr_stmt|;
comment|/* Add to the request list */
name|mtx_lock_spin
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|,
name|request
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|mtx_unlock_spin
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|request
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|hv_put_rndis_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|)
block|{
name|mtx_lock_spin
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
comment|/* Fixme:  Has O(n) performance */
comment|/* 	 * XXXKYS: Use Doubly linked lists. 	 */
name|STAILQ_REMOVE
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|,
name|request
argument_list|,
name|rndis_request_
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|mtx_unlock_spin
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|sema_destroy
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|request
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_send_request
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_request
modifier|*
name|request
parameter_list|,
name|uint32_t
name|message_type
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|netvsc_packet
modifier|*
name|packet
decl_stmt|;
comment|/* Set up the packet to send it */
name|packet
operator|=
operator|&
name|request
operator|->
name|pkt
expr_stmt|;
name|packet
operator|->
name|is_data_pkt
operator|=
name|FALSE
expr_stmt|;
name|packet
operator|->
name|tot_data_buf_len
operator|=
name|request
operator|->
name|request_msg
operator|.
name|msg_len
expr_stmt|;
name|packet
operator|->
name|page_buf_count
operator|=
literal|1
expr_stmt|;
name|packet
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|pfn
operator|=
name|hv_get_phys_addr
argument_list|(
operator|&
name|request
operator|->
name|request_msg
argument_list|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|packet
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|request
operator|->
name|request_msg
operator|.
name|msg_len
expr_stmt|;
name|packet
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|&
name|request
operator|->
name|request_msg
operator|&
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|send_completion_context
operator|=
name|request
expr_stmt|;
comment|/* packet */
if|if
condition|(
name|message_type
operator|!=
name|REMOTE_NDIS_HALT_MSG
condition|)
block|{
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|on_send_completion
operator|=
name|hv_rf_on_send_request_completion
expr_stmt|;
block|}
else|else
block|{
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|on_send_completion
operator|=
name|hv_rf_on_send_request_halt_completion
expr_stmt|;
block|}
name|packet
operator|->
name|compl
operator|.
name|send
operator|.
name|send_completion_tid
operator|=
operator|(
name|unsigned
name|long
operator|)
name|device
expr_stmt|;
name|ret
operator|=
name|hv_nv_on_send
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
name|packet
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive response  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_response
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|rndis_request
modifier|*
name|next_request
decl_stmt|;
name|boolean_t
name|found
init|=
name|FALSE
decl_stmt|;
name|mtx_lock_spin
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
name|request
operator|=
name|STAILQ_FIRST
argument_list|(
operator|&
name|device
operator|->
name|myrequest_list
argument_list|)
expr_stmt|;
while|while
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * All request/response message contains request_id as the 		 * first field 		 */
if|if
condition|(
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|init_request
operator|.
name|request_id
operator|==
name|response
operator|->
name|msg
operator|.
name|init_complete
operator|.
name|request_id
condition|)
block|{
name|found
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
name|next_request
operator|=
name|STAILQ_NEXT
argument_list|(
name|request
argument_list|,
name|mylist_entry
argument_list|)
expr_stmt|;
name|request
operator|=
name|next_request
expr_stmt|;
block|}
name|mtx_unlock_spin
argument_list|(
operator|&
name|device
operator|->
name|req_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|found
condition|)
block|{
if|if
condition|(
name|response
operator|->
name|msg_len
operator|<=
sizeof|sizeof
argument_list|(
name|rndis_msg
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|request
operator|->
name|response_msg
argument_list|,
name|response
argument_list|,
name|response
operator|->
name|msg_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|response
operator|->
name|ndis_msg_type
operator|==
name|REMOTE_NDIS_RESET_CMPLT
condition|)
block|{
comment|/* Does not have a request id field */
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|reset_complete
operator|.
name|status
operator|=
name|STATUS_BUFFER_OVERFLOW
expr_stmt|;
block|}
else|else
block|{
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|init_complete
operator|.
name|status
operator|=
name|STATUS_BUFFER_OVERFLOW
expr_stmt|;
block|}
block|}
name|sema_post
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive indicate status  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_indicate_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|response
parameter_list|)
block|{
name|rndis_indicate_status
modifier|*
name|indicate
init|=
operator|&
name|response
operator|->
name|msg
operator|.
name|indicate_status
decl_stmt|;
if|if
condition|(
name|indicate
operator|->
name|status
operator|==
name|RNDIS_STATUS_MEDIA_CONNECT
condition|)
block|{
name|netvsc_linkstatus_callback
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|indicate
operator|->
name|status
operator|==
name|RNDIS_STATUS_MEDIA_DISCONNECT
condition|)
block|{
name|netvsc_linkstatus_callback
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* TODO: */
block|}
block|}
end_function

begin_comment
comment|/*  * RNDIS filter receive data  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_receive_data
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|rndis_msg
modifier|*
name|message
parameter_list|,
name|netvsc_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|rndis_packet
modifier|*
name|rndis_pkt
decl_stmt|;
name|rndis_per_packet_info
modifier|*
name|rppi
decl_stmt|;
name|ndis_8021q_info
modifier|*
name|rppi_vlan_info
decl_stmt|;
name|uint32_t
name|data_offset
decl_stmt|;
name|rndis_pkt
operator|=
operator|&
name|message
operator|->
name|msg
operator|.
name|packet
expr_stmt|;
comment|/* 	 * Fixme:  Handle multiple rndis pkt msgs that may be enclosed in this 	 * netvsc packet (ie tot_data_buf_len != message_length) 	 */
comment|/* Remove rndis header, then pass data packet up the stack */
name|data_offset
operator|=
name|RNDIS_HEADER_SIZE
operator|+
name|rndis_pkt
operator|->
name|data_offset
expr_stmt|;
comment|/* L2 frame length, with L2 header, not including CRC */
name|pkt
operator|->
name|tot_data_buf_len
operator|=
name|rndis_pkt
operator|->
name|data_length
expr_stmt|;
name|pkt
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|offset
operator|+=
name|data_offset
expr_stmt|;
comment|/* Buffer length now L2 frame length plus trailing junk */
name|pkt
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|length
operator|-=
name|data_offset
expr_stmt|;
name|pkt
operator|->
name|is_data_pkt
operator|=
name|TRUE
expr_stmt|;
name|pkt
operator|->
name|vlan_tci
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Read the VLAN ID if supplied by the Hyper-V infrastructure. 	 * Let higher-level driver code decide if it wants to use it. 	 * Ignore CFI, priority for now as FreeBSD does not support these. 	 */
if|if
condition|(
name|rndis_pkt
operator|->
name|per_pkt_info_offset
operator|!=
literal|0
condition|)
block|{
comment|/* rppi struct exists; compute its address */
name|rppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|rndis_pkt
operator|+
name|rndis_pkt
operator|->
name|per_pkt_info_offset
operator|)
expr_stmt|;
comment|/* if VLAN ppi struct, get the VLAN ID */
if|if
condition|(
name|rppi
operator|->
name|type
operator|==
name|ieee_8021q_info
condition|)
block|{
name|rppi_vlan_info
operator|=
operator|(
name|ndis_8021q_info
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|rppi
operator|+
name|rppi
operator|->
name|per_packet_info_offset
operator|)
expr_stmt|;
name|pkt
operator|->
name|vlan_tci
operator|=
name|rppi_vlan_info
operator|->
name|u1
operator|.
name|s1
operator|.
name|vlan_id
expr_stmt|;
block|}
block|}
name|netvsc_recv
argument_list|(
name|device
operator|->
name|net_dev
operator|->
name|dev
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on receive  */
end_comment

begin_function
name|int
name|hv_rf_on_receive
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|netvsc_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|rndis_msg
name|rndis_mesg
decl_stmt|;
name|rndis_msg
modifier|*
name|rndis_hdr
decl_stmt|;
comment|/* Make sure the rndis device state is initialized */
if|if
condition|(
name|net_dev
operator|->
name|extension
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
name|rndis_dev
operator|=
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
expr_stmt|;
if|if
condition|(
name|rndis_dev
operator|->
name|state
operator|==
name|RNDIS_DEV_UNINITIALIZED
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Shift virtual page number to form virtual page address */
name|rndis_hdr
operator|=
operator|(
name|rndis_msg
operator|*
operator|)
call|(
name|uintptr_t
call|)
argument_list|(
name|pkt
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|pfn
operator|<<
name|PAGE_SHIFT
argument_list|)
expr_stmt|;
name|rndis_hdr
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|rndis_hdr
operator|+
name|pkt
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|offset
operator|)
expr_stmt|;
comment|/* 	 * Make sure we got a valid rndis message 	 * Fixme:  There seems to be a bug in set completion msg where 	 * its msg_len is 16 bytes but the byte_count field in the 	 * xfer page range shows 52 bytes 	 */
if|#
directive|if
literal|0
block|if (pkt->tot_data_buf_len != rndis_hdr->msg_len) { 		DPRINT_ERR(NETVSC, "invalid rndis message? (expected %u " 		    "bytes got %u)... dropping this message!", 		    rndis_hdr->msg_len, pkt->tot_data_buf_len); 		DPRINT_EXIT(NETVSC);  		return (-1); 	}
endif|#
directive|endif
name|memcpy
argument_list|(
operator|&
name|rndis_mesg
argument_list|,
name|rndis_hdr
argument_list|,
operator|(
name|rndis_hdr
operator|->
name|msg_len
operator|>
sizeof|sizeof
argument_list|(
name|rndis_msg
argument_list|)
operator|)
condition|?
sizeof|sizeof
argument_list|(
name|rndis_msg
argument_list|)
else|:
name|rndis_hdr
operator|->
name|msg_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rndis_mesg
operator|.
name|ndis_msg_type
condition|)
block|{
comment|/* data message */
case|case
name|REMOTE_NDIS_PACKET_MSG
case|:
name|hv_rf_receive_data
argument_list|(
name|rndis_dev
argument_list|,
operator|&
name|rndis_mesg
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
break|break;
comment|/* completion messages */
case|case
name|REMOTE_NDIS_INITIALIZE_CMPLT
case|:
case|case
name|REMOTE_NDIS_QUERY_CMPLT
case|:
case|case
name|REMOTE_NDIS_SET_CMPLT
case|:
case|case
name|REMOTE_NDIS_RESET_CMPLT
case|:
case|case
name|REMOTE_NDIS_KEEPALIVE_CMPLT
case|:
name|hv_rf_receive_response
argument_list|(
name|rndis_dev
argument_list|,
operator|&
name|rndis_mesg
argument_list|)
expr_stmt|;
break|break;
comment|/* notification message */
case|case
name|REMOTE_NDIS_INDICATE_STATUS_MSG
case|:
name|hv_rf_receive_indicate_status
argument_list|(
name|rndis_dev
argument_list|,
operator|&
name|rndis_mesg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"hv_rf_on_receive():  Unknown msg_type 0x%x\n"
argument_list|,
name|rndis_mesg
operator|.
name|ndis_msg_type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_query_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
name|void
modifier|*
name|result
parameter_list|,
name|uint32_t
modifier|*
name|result_size
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|uint32_t
name|in_result_size
init|=
operator|*
name|result_size
decl_stmt|;
name|rndis_query_request
modifier|*
name|query
decl_stmt|;
name|rndis_query_complete
modifier|*
name|query_complete
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
operator|*
name|result_size
operator|=
literal|0
expr_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_QUERY_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_query_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis query */
name|query
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|query_request
expr_stmt|;
name|query
operator|->
name|oid
operator|=
name|oid
expr_stmt|;
name|query
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_query_request
argument_list|)
expr_stmt|;
name|query
operator|->
name|info_buffer_length
operator|=
literal|0
expr_stmt|;
name|query
operator|->
name|device_vc_handle
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_QUERY_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* Fixme:  printf added */
name|printf
argument_list|(
literal|"RNDISFILTER request failed to Send!\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|sema_wait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
comment|/* Copy the response back */
name|query_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|query_complete
expr_stmt|;
if|if
condition|(
name|query_complete
operator|->
name|info_buffer_length
operator|>
name|in_result_size
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|memcpy
argument_list|(
name|result
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|query_complete
operator|+
name|query_complete
operator|->
name|info_buffer_offset
operator|)
argument_list|,
name|query_complete
operator|->
name|info_buffer_length
argument_list|)
expr_stmt|;
operator|*
name|result_size
operator|=
name|query_complete
operator|->
name|info_buffer_length
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device MAC address  */
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_mac
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|uint32_t
name|size
init|=
name|HW_MACADDR_LEN
decl_stmt|;
return|return
operator|(
name|hv_rf_query_device
argument_list|(
name|device
argument_list|,
name|RNDIS_OID_802_3_PERMANENT_ADDRESS
argument_list|,
name|device
operator|->
name|hw_mac_addr
argument_list|,
operator|&
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter query device link status  */
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|hv_rf_query_device_link_status
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|uint32_t
name|size
init|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
decl_stmt|;
return|return
operator|(
name|hv_rf_query_device
argument_list|(
name|device
argument_list|,
name|RNDIS_OID_GEN_MEDIA_CONNECT_STATUS
argument_list|,
operator|&
name|device
operator|->
name|link_status
argument_list|,
operator|&
name|size
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter set packet filter  * Sends an rndis request with the new filter, then waits for a response  * from the host.  * Returns zero on success, non-zero on failure.  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_set_packet_filter
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|,
name|uint32_t
name|new_filter
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_set_request
modifier|*
name|set
decl_stmt|;
name|rndis_set_complete
modifier|*
name|set_complete
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_set_request
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis set */
name|set
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|set_request
expr_stmt|;
name|set
operator|->
name|oid
operator|=
name|RNDIS_OID_GEN_CURRENT_PACKET_FILTER
expr_stmt|;
name|set
operator|->
name|info_buffer_length
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|set
operator|->
name|info_buffer_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|long
operator|)
name|set
operator|+
sizeof|sizeof
argument_list|(
name|rndis_set_request
argument_list|)
operator|)
argument_list|,
operator|&
name|new_filter
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_SET_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* 	 * Wait for the response from the host.  Another thread will signal 	 * us when the response has arrived.  In the failure case, 	 * sema_timedwait() returns a non-zero status after waiting 5 seconds. 	 */
name|ret
operator|=
name|sema_timedwait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|,
literal|500
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
comment|/* Response received, check status */
name|set_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|set_complete
expr_stmt|;
name|status
operator|=
name|set_complete
operator|->
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
comment|/* Bad response status, return error */
name|ret
operator|=
operator|-
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * We cannot deallocate the request since we may still 		 * receive a send completion for it. 		 */
goto|goto
name|exit
goto|;
block|}
name|cleanup
label|:
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
name|exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter init device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_init_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_initialize_request
modifier|*
name|init
decl_stmt|;
name|rndis_initialize_complete
modifier|*
name|init_complete
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_INITIALIZE_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_initialize_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|request
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the rndis set */
name|init
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|init_request
expr_stmt|;
name|init
operator|->
name|major_version
operator|=
name|RNDIS_MAJOR_VERSION
expr_stmt|;
name|init
operator|->
name|minor_version
operator|=
name|RNDIS_MINOR_VERSION
expr_stmt|;
comment|/* 	 * Per the RNDIS document, this should be set to the max MTU 	 * plus the header size.  However, 2048 works fine, so leaving 	 * it as is. 	 */
name|init
operator|->
name|max_xfer_size
operator|=
literal|2048
expr_stmt|;
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZING
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_INITIALIZE_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|sema_wait
argument_list|(
operator|&
name|request
operator|->
name|wait_sema
argument_list|)
expr_stmt|;
name|init_complete
operator|=
operator|&
name|request
operator|->
name|response_msg
operator|.
name|msg
operator|.
name|init_complete
expr_stmt|;
name|status
operator|=
name|init_complete
operator|->
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZED
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|cleanup
label|:
if|if
condition|(
name|request
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|HALT_COMPLETION_WAIT_COUNT
value|25
end_define

begin_comment
comment|/*  * RNDIS filter halt device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_halt_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
decl_stmt|;
name|rndis_halt_request
modifier|*
name|halt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
comment|/* Attempt to do a rndis device halt */
name|request
operator|=
name|hv_rndis_request
argument_list|(
name|device
argument_list|,
name|REMOTE_NDIS_HALT_MSG
argument_list|,
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_halt_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* initialize "poor man's semaphore" */
name|request
operator|->
name|halt_complete_flag
operator|=
literal|0
expr_stmt|;
comment|/* Set up the rndis set */
name|halt
operator|=
operator|&
name|request
operator|->
name|request_msg
operator|.
name|msg
operator|.
name|halt_request
expr_stmt|;
name|halt
operator|->
name|request_id
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|device
operator|->
name|new_request_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Increment to get the new value (call above returns old value) */
name|halt
operator|->
name|request_id
operator|+=
literal|1
expr_stmt|;
name|ret
operator|=
name|hv_rf_send_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|,
name|REMOTE_NDIS_HALT_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* 	 * Wait for halt response from halt callback.  We must wait for 	 * the transaction response before freeing the request and other 	 * resources. 	 */
for|for
control|(
name|i
operator|=
name|HALT_COMPLETION_WAIT_COUNT
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|request
operator|->
name|halt_complete_flag
operator|!=
literal|0
condition|)
block|{
break|break;
block|}
name|DELAY
argument_list|(
literal|400
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_UNINITIALIZED
expr_stmt|;
if|if
condition|(
name|request
operator|!=
name|NULL
condition|)
block|{
name|hv_put_rndis_request
argument_list|(
name|device
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter open device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_open_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|device
operator|->
name|state
operator|!=
name|RNDIS_DEV_INITIALIZED
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|hv_promisc_mode
operator|!=
literal|1
condition|)
block|{
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
name|NDIS_PACKET_TYPE_BROADCAST
operator||
name|NDIS_PACKET_TYPE_ALL_MULTICAST
operator||
name|NDIS_PACKET_TYPE_DIRECTED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
name|NDIS_PACKET_TYPE_PROMISCUOUS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_DATAINITIALIZED
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter close device  */
end_comment

begin_function
specifier|static
name|int
name|hv_rf_close_device
parameter_list|(
name|rndis_device
modifier|*
name|device
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|device
operator|->
name|state
operator|!=
name|RNDIS_DEV_DATAINITIALIZED
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ret
operator|=
name|hv_rf_set_packet_filter
argument_list|(
name|device
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|device
operator|->
name|state
operator|=
name|RNDIS_DEV_INITIALIZED
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device add  */
end_comment

begin_function
name|int
name|hv_rf_on_device_add
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|void
modifier|*
name|additl_info
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
decl_stmt|;
name|netvsc_device_info
modifier|*
name|dev_info
init|=
operator|(
name|netvsc_device_info
operator|*
operator|)
name|additl_info
decl_stmt|;
name|rndis_dev
operator|=
name|hv_get_rndis_device
argument_list|()
expr_stmt|;
if|if
condition|(
name|rndis_dev
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* 	 * Let the inner driver handle this first to create the netvsc channel 	 * NOTE! Once the channel is created, we may get a receive callback  	 * (hv_rf_on_receive()) before this call is completed. 	 * Note:  Earlier code used a function pointer here. 	 */
name|net_dev
operator|=
name|hv_nv_on_device_add
argument_list|(
name|device
argument_list|,
name|additl_info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|net_dev
condition|)
block|{
name|hv_put_rndis_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* 	 * Initialize the rndis device 	 */
name|net_dev
operator|->
name|extension
operator|=
name|rndis_dev
expr_stmt|;
name|rndis_dev
operator|->
name|net_dev
operator|=
name|net_dev
expr_stmt|;
comment|/* Send the rndis initialization message */
name|ret
operator|=
name|hv_rf_init_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* 		 * TODO: If rndis init failed, we will need to shut down 		 * the channel 		 */
block|}
comment|/* Get the mac address */
name|ret
operator|=
name|hv_rf_query_device_mac
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
comment|/* TODO: shut down rndis device and the channel */
block|}
name|memcpy
argument_list|(
name|dev_info
operator|->
name|mac_addr
argument_list|,
name|rndis_dev
operator|->
name|hw_mac_addr
argument_list|,
name|HW_MACADDR_LEN
argument_list|)
expr_stmt|;
name|hv_rf_query_device_link_status
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|dev_info
operator|->
name|link_state
operator|=
name|rndis_dev
operator|->
name|link_status
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on device remove  */
end_comment

begin_function
name|int
name|hv_rf_on_device_remove
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|boolean_t
name|destroy_channel
parameter_list|)
block|{
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
name|rndis_device
modifier|*
name|rndis_dev
init|=
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Halt and release the rndis device */
name|ret
operator|=
name|hv_rf_halt_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|hv_put_rndis_device
argument_list|(
name|rndis_dev
argument_list|)
expr_stmt|;
name|net_dev
operator|->
name|extension
operator|=
name|NULL
expr_stmt|;
comment|/* Pass control to inner driver to remove the device */
name|ret
operator||=
name|hv_nv_on_device_remove
argument_list|(
name|device
argument_list|,
name|destroy_channel
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on open  */
end_comment

begin_function
name|int
name|hv_rf_on_open
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|)
block|{
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
return|return
operator|(
name|hv_rf_open_device
argument_list|(
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on close  */
end_comment

begin_function
name|int
name|hv_rf_on_close
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|)
block|{
name|hn_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|device
operator|->
name|device
argument_list|)
decl_stmt|;
name|netvsc_dev
modifier|*
name|net_dev
init|=
name|sc
operator|->
name|net_dev
decl_stmt|;
return|return
operator|(
name|hv_rf_close_device
argument_list|(
operator|(
name|rndis_device
operator|*
operator|)
name|net_dev
operator|->
name|extension
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on send  */
end_comment

begin_function
name|int
name|hv_rf_on_send
parameter_list|(
name|struct
name|hv_device
modifier|*
name|device
parameter_list|,
name|netvsc_packet
modifier|*
name|pkt
parameter_list|)
block|{
name|rndis_filter_packet
modifier|*
name|filter_pkt
decl_stmt|;
name|rndis_msg
modifier|*
name|rndis_mesg
decl_stmt|;
name|rndis_packet
modifier|*
name|rndis_pkt
decl_stmt|;
name|rndis_per_packet_info
modifier|*
name|rppi
decl_stmt|;
name|ndis_8021q_info
modifier|*
name|rppi_vlan_info
decl_stmt|;
name|uint32_t
name|rndis_msg_size
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
comment|/* Add the rndis header */
name|filter_pkt
operator|=
operator|(
name|rndis_filter_packet
operator|*
operator|)
name|pkt
operator|->
name|extension
expr_stmt|;
name|memset
argument_list|(
name|filter_pkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rndis_filter_packet
argument_list|)
argument_list|)
expr_stmt|;
name|rndis_mesg
operator|=
operator|&
name|filter_pkt
operator|->
name|message
expr_stmt|;
name|rndis_msg_size
operator|=
name|RNDIS_MESSAGE_SIZE
argument_list|(
name|rndis_packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|vlan_tci
operator|!=
literal|0
condition|)
block|{
name|rndis_msg_size
operator|+=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ndis_8021q_info
argument_list|)
expr_stmt|;
block|}
name|rndis_mesg
operator|->
name|ndis_msg_type
operator|=
name|REMOTE_NDIS_PACKET_MSG
expr_stmt|;
name|rndis_mesg
operator|->
name|msg_len
operator|=
name|pkt
operator|->
name|tot_data_buf_len
operator|+
name|rndis_msg_size
expr_stmt|;
name|rndis_pkt
operator|=
operator|&
name|rndis_mesg
operator|->
name|msg
operator|.
name|packet
expr_stmt|;
name|rndis_pkt
operator|->
name|data_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_packet
argument_list|)
expr_stmt|;
name|rndis_pkt
operator|->
name|data_length
operator|=
name|pkt
operator|->
name|tot_data_buf_len
expr_stmt|;
name|pkt
operator|->
name|is_data_pkt
operator|=
name|TRUE
expr_stmt|;
name|pkt
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|pfn
operator|=
name|hv_get_phys_addr
argument_list|(
name|rndis_mesg
argument_list|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|pkt
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
name|rndis_mesg
operator|&
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|pkt
operator|->
name|page_buffers
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|rndis_msg_size
expr_stmt|;
comment|/* Save the packet context */
name|filter_pkt
operator|->
name|completion_context
operator|=
name|pkt
operator|->
name|compl
operator|.
name|send
operator|.
name|send_completion_context
expr_stmt|;
comment|/* Use ours */
name|pkt
operator|->
name|compl
operator|.
name|send
operator|.
name|on_send_completion
operator|=
name|hv_rf_on_send_completion
expr_stmt|;
name|pkt
operator|->
name|compl
operator|.
name|send
operator|.
name|send_completion_context
operator|=
name|filter_pkt
expr_stmt|;
comment|/* 	 * If there is a VLAN tag, we need to set up some additional 	 * fields so the Hyper-V infrastructure will stuff the VLAN tag 	 * into the frame. 	 */
if|if
condition|(
name|pkt
operator|->
name|vlan_tci
operator|!=
literal|0
condition|)
block|{
comment|/* Move data offset past end of rppi + VLAN structs */
name|rndis_pkt
operator|->
name|data_offset
operator|+=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ndis_8021q_info
argument_list|)
expr_stmt|;
comment|/* must be set when we have rppi, VLAN info */
name|rndis_pkt
operator|->
name|per_pkt_info_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_packet
argument_list|)
expr_stmt|;
name|rndis_pkt
operator|->
name|per_pkt_info_length
operator|=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ndis_8021q_info
argument_list|)
expr_stmt|;
comment|/* rppi immediately follows rndis_pkt */
name|rppi
operator|=
operator|(
name|rndis_per_packet_info
operator|*
operator|)
operator|(
name|rndis_pkt
operator|+
literal|1
operator|)
expr_stmt|;
name|rppi
operator|->
name|size
operator|=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ndis_8021q_info
argument_list|)
expr_stmt|;
name|rppi
operator|->
name|type
operator|=
name|ieee_8021q_info
expr_stmt|;
name|rppi
operator|->
name|per_packet_info_offset
operator|=
sizeof|sizeof
argument_list|(
name|rndis_per_packet_info
argument_list|)
expr_stmt|;
comment|/* VLAN info immediately follows rppi struct */
name|rppi_vlan_info
operator|=
operator|(
name|ndis_8021q_info
operator|*
operator|)
operator|(
name|rppi
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* FreeBSD does not support CFI or priority */
name|rppi_vlan_info
operator|->
name|u1
operator|.
name|s1
operator|.
name|vlan_id
operator|=
name|pkt
operator|->
name|vlan_tci
operator|&
literal|0xfff
expr_stmt|;
block|}
comment|/* 	 * Invoke netvsc send.  If return status is bad, the caller now 	 * resets the context pointers before retrying. 	 */
name|ret
operator|=
name|hv_nv_on_send
argument_list|(
name|device
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on send completion callback  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_on_send_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
block|{
name|rndis_filter_packet
modifier|*
name|filter_pkt
init|=
operator|(
name|rndis_filter_packet
operator|*
operator|)
name|context
decl_stmt|;
comment|/* Pass it back to the original handler */
name|netvsc_xmit_completion
argument_list|(
name|filter_pkt
operator|->
name|completion_context
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RNDIS filter on send request completion callback  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_on_send_request_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*  * RNDIS filter on send request (halt only) completion callback  */
end_comment

begin_function
specifier|static
name|void
name|hv_rf_on_send_request_halt_completion
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
block|{
name|rndis_request
modifier|*
name|request
init|=
name|context
decl_stmt|;
comment|/* 	 * Notify hv_rf_halt_device() about halt completion. 	 * The halt code must wait for completion before freeing 	 * the transaction resources. 	 */
name|request
operator|->
name|halt_complete_flag
operator|=
literal|1
expr_stmt|;
block|}
end_function

end_unit


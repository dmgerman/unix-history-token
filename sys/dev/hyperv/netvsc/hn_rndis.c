begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2012,2016-2017 Microsoft Corp.  * Copyright (c) 2010-2012 Citrix Inc.  * Copyright (c) 2012 NetApp Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/rndis.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_lro.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/hyperv.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/hyperv_busdma.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/vmbus.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/include/vmbus_xact.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/ndis.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/if_hnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/if_hnvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hn_nvs.h>
end_include

begin_include
include|#
directive|include
file|<dev/hyperv/netvsc/hn_rndis.h>
end_include

begin_define
define|#
directive|define
name|HN_RNDIS_RID_COMPAT_MASK
value|0xffff
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_RID_COMPAT_MAX
value|HN_RNDIS_RID_COMPAT_MASK
end_define

begin_define
define|#
directive|define
name|HN_RNDIS_XFER_SIZE
value|2048
end_define

begin_define
define|#
directive|define
name|HN_NDIS_TXCSUM_CAP_IP4
define|\
value|(NDIS_TXCSUM_CAP_IP4 | NDIS_TXCSUM_CAP_IP4OPT)
end_define

begin_define
define|#
directive|define
name|HN_NDIS_TXCSUM_CAP_TCP4
define|\
value|(NDIS_TXCSUM_CAP_TCP4 | NDIS_TXCSUM_CAP_TCP4OPT)
end_define

begin_define
define|#
directive|define
name|HN_NDIS_TXCSUM_CAP_TCP6
define|\
value|(NDIS_TXCSUM_CAP_TCP6 | NDIS_TXCSUM_CAP_TCP6OPT | \ 	 NDIS_TXCSUM_CAP_IP6EXT)
end_define

begin_define
define|#
directive|define
name|HN_NDIS_TXCSUM_CAP_UDP6
define|\
value|(NDIS_TXCSUM_CAP_UDP6 | NDIS_TXCSUM_CAP_IP6EXT)
end_define

begin_define
define|#
directive|define
name|HN_NDIS_LSOV2_CAP_IP6
define|\
value|(NDIS_LSOV2_CAP_IP6EXT | NDIS_LSOV2_CAP_TCP6OPT)
end_define

begin_function_decl
specifier|static
specifier|const
name|void
modifier|*
name|hn_rndis_xact_exec1
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|,
name|struct
name|vmbus_xact
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|struct
name|hn_nvs_sendctx
modifier|*
parameter_list|,
name|size_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|void
modifier|*
name|hn_rndis_xact_execute
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|,
name|struct
name|vmbus_xact
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|size_t
parameter_list|,
name|size_t
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_query
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_query2
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_set
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_init
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_halt
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_conf_offload
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hn_rndis_query_hwcaps
parameter_list|(
name|struct
name|hn_softc
modifier|*
parameter_list|,
name|struct
name|ndis_offload
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|__inline
name|uint32_t
name|hn_rndis_rid
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|rid
decl_stmt|;
name|again
label|:
name|rid
operator|=
name|atomic_fetchadd_int
argument_list|(
operator|&
name|sc
operator|->
name|hn_rndis_rid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rid
operator|==
literal|0
condition|)
goto|goto
name|again
goto|;
comment|/* Use upper 16 bits for non-compat RNDIS messages. */
return|return
operator|(
operator|(
name|rid
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
operator|)
return|;
block|}
end_function

begin_function
name|void
name|hn_rndis_rx_ctrl
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|dlen
parameter_list|)
block|{
specifier|const
name|struct
name|rndis_comp_hdr
modifier|*
name|comp
decl_stmt|;
specifier|const
name|struct
name|rndis_msghdr
modifier|*
name|hdr
decl_stmt|;
name|KASSERT
argument_list|(
name|dlen
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|,
operator|(
literal|"invalid RNDIS msg\n"
operator|)
argument_list|)
expr_stmt|;
name|hdr
operator|=
name|data
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|rm_type
condition|)
block|{
case|case
name|REMOTE_NDIS_INITIALIZE_CMPLT
case|:
case|case
name|REMOTE_NDIS_QUERY_CMPLT
case|:
case|case
name|REMOTE_NDIS_SET_CMPLT
case|:
case|case
name|REMOTE_NDIS_KEEPALIVE_CMPLT
case|:
comment|/* unused */
if|if
condition|(
name|dlen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS cmplt\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|comp
operator|=
name|data
expr_stmt|;
name|KASSERT
argument_list|(
name|comp
operator|->
name|rm_rid
operator|>
name|HN_RNDIS_RID_COMPAT_MAX
argument_list|,
operator|(
literal|"invalid RNDIS rid 0x%08x\n"
operator|,
name|comp
operator|->
name|rm_rid
operator|)
argument_list|)
expr_stmt|;
name|vmbus_xact_ctx_wakeup
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|comp
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|REMOTE_NDIS_RESET_CMPLT
case|:
comment|/* 		 * Reset completed, no rid. 		 * 		 * NOTE: 		 * RESET is not issued by hn(4), so this message should 		 * _not_ be observed. 		 */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RESET cmplt received\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"unknown RNDIS msg 0x%x\n"
argument_list|,
name|hdr
operator|->
name|rm_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|hn_rndis_get_eaddr
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|eaddr
parameter_list|)
block|{
name|size_t
name|eaddr_len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|eaddr_len
operator|=
name|ETHER_ADDR_LEN
expr_stmt|;
name|error
operator|=
name|hn_rndis_query
argument_list|(
name|sc
argument_list|,
name|OID_802_3_PERMANENT_ADDRESS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|eaddr
argument_list|,
operator|&
name|eaddr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|eaddr_len
operator|!=
name|ETHER_ADDR_LEN
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid eaddr len %zu\n"
argument_list|,
name|eaddr_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hn_rndis_get_linkstatus
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
modifier|*
name|link_status
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|link_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|hn_rndis_query
argument_list|(
name|sc
argument_list|,
name|OID_GEN_MEDIA_CONNECT_STATUS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|link_status
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|size
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid link status len %zu\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hn_rndis_get_mtu
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
modifier|*
name|mtu
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|mtu
argument_list|)
expr_stmt|;
name|error
operator|=
name|hn_rndis_query
argument_list|(
name|sc
argument_list|,
name|OID_GEN_MAXIMUM_FRAME_SIZE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|mtu
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|size
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid mtu len %zu\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|void
modifier|*
name|hn_rndis_xact_exec1
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_xact
modifier|*
name|xact
parameter_list|,
name|size_t
name|reqlen
parameter_list|,
name|struct
name|hn_nvs_sendctx
modifier|*
name|sndc
parameter_list|,
name|size_t
modifier|*
name|comp_len
parameter_list|)
block|{
name|struct
name|vmbus_gpa
name|gpa
index|[
name|HN_XACT_REQ_PGCNT
index|]
decl_stmt|;
name|int
name|gpa_cnt
decl_stmt|,
name|error
decl_stmt|;
name|bus_addr_t
name|paddr
decl_stmt|;
name|KASSERT
argument_list|(
name|reqlen
operator|<=
name|HN_XACT_REQ_SIZE
operator|&&
name|reqlen
operator|>
literal|0
argument_list|,
operator|(
literal|"invalid request length %zu"
operator|,
name|reqlen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Setup the SG list. 	 */
name|paddr
operator|=
name|vmbus_xact_req_paddr
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|paddr
operator|&
name|PAGE_MASK
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"vmbus xact request is not page aligned 0x%jx"
operator|,
operator|(
name|uintmax_t
operator|)
name|paddr
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|gpa_cnt
operator|=
literal|0
init|;
name|gpa_cnt
operator|<
name|HN_XACT_REQ_PGCNT
condition|;
operator|++
name|gpa_cnt
control|)
block|{
name|int
name|len
init|=
name|PAGE_SIZE
decl_stmt|;
if|if
condition|(
name|reqlen
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|reqlen
operator|<
name|len
condition|)
name|len
operator|=
name|reqlen
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_page
operator|=
name|atop
argument_list|(
name|paddr
argument_list|)
operator|+
name|gpa_cnt
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_len
operator|=
name|len
expr_stmt|;
name|gpa
index|[
name|gpa_cnt
index|]
operator|.
name|gpa_ofs
operator|=
literal|0
expr_stmt|;
name|reqlen
operator|-=
name|len
expr_stmt|;
block|}
name|KASSERT
argument_list|(
name|reqlen
operator|==
literal|0
argument_list|,
operator|(
literal|"still have %zu request data left"
operator|,
name|reqlen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Send this RNDIS control message and wait for its completion 	 * message. 	 */
name|vmbus_xact_activate
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|error
operator|=
name|hn_nvs_send_rndis_ctrl
argument_list|(
name|sc
operator|->
name|hn_prichan
argument_list|,
name|sndc
argument_list|,
name|gpa
argument_list|,
name|gpa_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vmbus_xact_deactivate
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS ctrl send failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|vmbus_chan_xact_wait
argument_list|(
name|sc
operator|->
name|hn_prichan
argument_list|,
name|xact
argument_list|,
name|comp_len
argument_list|,
name|HN_CAN_SLEEP
argument_list|(
name|sc
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|void
modifier|*
name|hn_rndis_xact_execute
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmbus_xact
modifier|*
name|xact
parameter_list|,
name|uint32_t
name|rid
parameter_list|,
name|size_t
name|reqlen
parameter_list|,
name|size_t
modifier|*
name|comp_len0
parameter_list|,
name|uint32_t
name|comp_type
parameter_list|)
block|{
specifier|const
name|struct
name|rndis_comp_hdr
modifier|*
name|comp
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|,
name|min_complen
init|=
operator|*
name|comp_len0
decl_stmt|;
name|KASSERT
argument_list|(
name|rid
operator|>
name|HN_RNDIS_RID_COMPAT_MAX
argument_list|,
operator|(
literal|"invalid rid %u\n"
operator|,
name|rid
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|min_complen
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
argument_list|,
operator|(
literal|"invalid minimum complete len %zu"
operator|,
name|min_complen
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Execute the xact setup by the caller. 	 */
name|comp
operator|=
name|hn_rndis_xact_exec1
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|reqlen
argument_list|,
operator|&
name|hn_nvs_sendctx_none
argument_list|,
operator|&
name|comp_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* 	 * Check this RNDIS complete message. 	 */
if|if
condition|(
name|comp_len
operator|<
name|min_complen
condition|)
block|{
if|if
condition|(
name|comp_len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
condition|)
block|{
comment|/* rm_status field is valid */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp len %zu, "
literal|"status 0x%08x\n"
argument_list|,
name|comp_len
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp len %zu\n"
argument_list|,
name|comp_len
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_len
operator|<
name|min_complen
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid RNDIS comp msglen %u\n"
argument_list|,
name|comp
operator|->
name|rm_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_type
operator|!=
name|comp_type
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"unexpected RNDIS comp 0x%08x, "
literal|"expect 0x%08x\n"
argument_list|,
name|comp
operator|->
name|rm_type
argument_list|,
name|comp_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_rid
operator|!=
name|rid
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS comp rid mismatch %u, "
literal|"expect %u\n"
argument_list|,
name|comp
operator|->
name|rm_rid
argument_list|,
name|rid
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* All pass! */
operator|*
name|comp_len0
operator|=
name|comp_len
expr_stmt|;
return|return
operator|(
name|comp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_query
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|idata
parameter_list|,
name|size_t
name|idlen
parameter_list|,
name|void
modifier|*
name|odata
parameter_list|,
name|size_t
modifier|*
name|odlen0
parameter_list|)
block|{
return|return
operator|(
name|hn_rndis_query2
argument_list|(
name|sc
argument_list|,
name|oid
argument_list|,
name|idata
argument_list|,
name|idlen
argument_list|,
name|odata
argument_list|,
name|odlen0
argument_list|,
operator|*
name|odlen0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_query2
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|idata
parameter_list|,
name|size_t
name|idlen
parameter_list|,
name|void
modifier|*
name|odata
parameter_list|,
name|size_t
modifier|*
name|odlen0
parameter_list|,
name|size_t
name|min_odlen
parameter_list|)
block|{
name|struct
name|rndis_query_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_query_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|,
name|odlen
init|=
operator|*
name|odlen0
decl_stmt|,
name|comp_len
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ofs
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|reqlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
name|idlen
expr_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|reqlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS query 0x%08x\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_QUERY_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
name|reqlen
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_oid
operator|=
name|oid
expr_stmt|;
comment|/* 	 * XXX 	 * This is _not_ RNDIS Spec conforming: 	 * "This MUST be set to 0 when there is no input data 	 *  associated with the OID." 	 * 	 * If this field was set to 0 according to the RNDIS Spec, 	 * Hyper-V would set non-SUCCESS status in the query 	 * completion. 	 */
name|req
operator|->
name|rm_infobufoffset
operator|=
name|RNDIS_QUERY_REQ_INFOBUFOFFSET
expr_stmt|;
if|if
condition|(
name|idlen
operator|>
literal|0
condition|)
block|{
name|req
operator|->
name|rm_infobuflen
operator|=
name|idlen
expr_stmt|;
comment|/* Input data immediately follows RNDIS query. */
name|memcpy
argument_list|(
name|req
operator|+
literal|1
argument_list|,
name|idata
argument_list|,
name|idlen
argument_list|)
expr_stmt|;
block|}
name|comp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
operator|+
name|min_odlen
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
name|reqlen
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_QUERY_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS query 0x%08x failed\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query 0x%08x failed: "
literal|"status 0x%08x\n"
argument_list|,
name|oid
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_infobuflen
operator|==
literal|0
operator|||
name|comp
operator|->
name|rm_infobufoffset
operator|==
literal|0
condition|)
block|{
comment|/* No output data! */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query 0x%08x, no data\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
operator|*
name|odlen0
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Check output data length and offset. 	 */
comment|/* ofs is the offset from the beginning of comp. */
name|ofs
operator|=
name|RNDIS_QUERY_COMP_INFOBUFOFFSET_ABS
argument_list|(
name|comp
operator|->
name|rm_infobufoffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|ofs
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
operator|||
name|ofs
operator|+
name|comp
operator|->
name|rm_infobuflen
operator|>
name|comp_len
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS query invalid comp ib off/len, "
literal|"%u/%u\n"
argument_list|,
name|comp
operator|->
name|rm_infobufoffset
argument_list|,
name|comp
operator|->
name|rm_infobuflen
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * Save output data. 	 */
if|if
condition|(
name|comp
operator|->
name|rm_infobuflen
operator|<
name|odlen
condition|)
name|odlen
operator|=
name|comp
operator|->
name|rm_infobuflen
expr_stmt|;
name|memcpy
argument_list|(
name|odata
argument_list|,
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|comp
operator|)
operator|+
name|ofs
argument_list|,
name|odlen
argument_list|)
expr_stmt|;
operator|*
name|odlen0
operator|=
name|odlen
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hn_rndis_query_rsscaps
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|int
modifier|*
name|rxr_cnt0
parameter_list|)
block|{
name|struct
name|ndis_rss_caps
name|in
decl_stmt|,
name|caps
decl_stmt|;
name|size_t
name|caps_len
decl_stmt|;
name|int
name|error
decl_stmt|,
name|indsz
decl_stmt|,
name|rxr_cnt
decl_stmt|,
name|hash_fnidx
decl_stmt|;
name|uint32_t
name|hash_func
init|=
literal|0
decl_stmt|,
name|hash_types
init|=
literal|0
decl_stmt|;
operator|*
name|rxr_cnt0
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|<
name|HN_NDIS_VERSION_6_20
condition|)
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
name|memset
argument_list|(
operator|&
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_RSS_CAPS
expr_stmt|;
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_RSS_CAPS_REV_2
expr_stmt|;
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|=
name|NDIS_RSS_CAPS_SIZE
expr_stmt|;
name|caps_len
operator|=
name|NDIS_RSS_CAPS_SIZE
expr_stmt|;
name|error
operator|=
name|hn_rndis_query2
argument_list|(
name|sc
argument_list|,
name|OID_GEN_RECEIVE_SCALE_CAPABILITIES
argument_list|,
operator|&
name|in
argument_list|,
name|NDIS_RSS_CAPS_SIZE
argument_list|,
operator|&
name|caps
argument_list|,
operator|&
name|caps_len
argument_list|,
name|NDIS_RSS_CAPS_SIZE_6_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Preliminary verification. 	 */
if|if
condition|(
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_type
operator|!=
name|NDIS_OBJTYPE_RSS_CAPS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objtype 0x%02x\n"
argument_list|,
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|<
name|NDIS_RSS_CAPS_REV_1
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objrev 0x%02x\n"
argument_list|,
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|>
name|caps_len
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objsize %u, "
literal|"data size %zu\n"
argument_list|,
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_size
argument_list|,
name|caps_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|<
name|NDIS_RSS_CAPS_SIZE_6_0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objsize %u\n"
argument_list|,
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* 	 * Save information for later RSS configuration. 	 */
if|if
condition|(
name|caps
operator|.
name|ndis_nrxr
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"0 RX rings!?\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"%u RX rings\n"
argument_list|,
name|caps
operator|.
name|ndis_nrxr
argument_list|)
expr_stmt|;
name|rxr_cnt
operator|=
name|caps
operator|.
name|ndis_nrxr
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|==
name|NDIS_RSS_CAPS_SIZE
operator|&&
name|caps
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|>=
name|NDIS_RSS_CAPS_REV_2
condition|)
block|{
if|if
condition|(
name|caps
operator|.
name|ndis_nind
operator|>
name|NDIS_HASH_INDCNT
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"too many RSS indirect table entries %u\n"
argument_list|,
name|caps
operator|.
name|ndis_nind
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|powerof2
argument_list|(
name|caps
operator|.
name|ndis_nind
argument_list|)
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS indirect table size is not "
literal|"power-of-2 %u\n"
argument_list|,
name|caps
operator|.
name|ndis_nind
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS indirect table size %u\n"
argument_list|,
name|caps
operator|.
name|ndis_nind
argument_list|)
expr_stmt|;
block|}
name|indsz
operator|=
name|caps
operator|.
name|ndis_nind
expr_stmt|;
block|}
else|else
block|{
name|indsz
operator|=
name|NDIS_HASH_INDCNT
expr_stmt|;
block|}
if|if
condition|(
name|indsz
operator|<
name|rxr_cnt
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"# of RX rings (%d)> "
literal|"RSS indirect table size %d\n"
argument_list|,
name|rxr_cnt
argument_list|,
name|indsz
argument_list|)
expr_stmt|;
name|rxr_cnt
operator|=
name|indsz
expr_stmt|;
block|}
comment|/* 	 * NOTE: 	 * Toeplitz is at the lowest bit, and it is prefered; so ffs(), 	 * instead of fls(), is used here. 	 */
name|hash_fnidx
operator|=
name|ffs
argument_list|(
name|caps
operator|.
name|ndis_caps
operator|&
name|NDIS_RSS_CAP_HASHFUNC_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|hash_fnidx
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no hash functions, caps 0x%08x\n"
argument_list|,
name|caps
operator|.
name|ndis_caps
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
name|hash_func
operator|=
literal|1
operator|<<
operator|(
name|hash_fnidx
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* ffs is 1-based */
if|if
condition|(
name|caps
operator|.
name|ndis_caps
operator|&
name|NDIS_RSS_CAP_IPV4
condition|)
name|hash_types
operator||=
name|NDIS_HASH_IPV4
operator||
name|NDIS_HASH_TCP_IPV4
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|ndis_caps
operator|&
name|NDIS_RSS_CAP_IPV6
condition|)
name|hash_types
operator||=
name|NDIS_HASH_IPV6
operator||
name|NDIS_HASH_TCP_IPV6
expr_stmt|;
if|if
condition|(
name|caps
operator|.
name|ndis_caps
operator|&
name|NDIS_RSS_CAP_IPV6_EX
condition|)
name|hash_types
operator||=
name|NDIS_HASH_IPV6_EX
operator||
name|NDIS_HASH_TCP_IPV6_EX
expr_stmt|;
if|if
condition|(
name|hash_types
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no hash types, caps 0x%08x\n"
argument_list|,
name|caps
operator|.
name|ndis_caps
argument_list|)
expr_stmt|;
return|return
operator|(
name|EOPNOTSUPP
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS caps %#x\n"
argument_list|,
name|caps
operator|.
name|ndis_caps
argument_list|)
expr_stmt|;
comment|/* Commit! */
name|sc
operator|->
name|hn_rss_ind_size
operator|=
name|indsz
expr_stmt|;
name|sc
operator|->
name|hn_rss_hcap
operator|=
name|hash_func
operator||
name|hash_types
expr_stmt|;
operator|*
name|rxr_cnt0
operator|=
name|rxr_cnt
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_set
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|oid
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|dlen
parameter_list|)
block|{
name|struct
name|rndis_set_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_set_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|,
name|comp_len
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|int
name|error
decl_stmt|;
name|KASSERT
argument_list|(
name|dlen
operator|>
literal|0
argument_list|,
operator|(
literal|"invalid dlen %zu"
operator|,
name|dlen
operator|)
argument_list|)
expr_stmt|;
name|reqlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|+
name|dlen
expr_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
name|reqlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS set 0x%08x\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_SET_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
name|reqlen
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_oid
operator|=
name|oid
expr_stmt|;
name|req
operator|->
name|rm_infobuflen
operator|=
name|dlen
expr_stmt|;
name|req
operator|->
name|rm_infobufoffset
operator|=
name|RNDIS_SET_REQ_INFOBUFOFFSET
expr_stmt|;
comment|/* Data immediately follows RNDIS set. */
name|memcpy
argument_list|(
name|req
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|comp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|comp
argument_list|)
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
name|reqlen
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_SET_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS set 0x%08x failed\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS set 0x%08x failed: "
literal|"status 0x%08x\n"
argument_list|,
name|oid
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_conf_offload
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mtu
parameter_list|)
block|{
name|struct
name|ndis_offload
name|hwcaps
decl_stmt|;
name|struct
name|ndis_offload_params
name|params
decl_stmt|;
name|uint32_t
name|caps
init|=
literal|0
decl_stmt|;
name|size_t
name|paramsz
decl_stmt|;
name|int
name|error
decl_stmt|,
name|tso_maxsz
decl_stmt|,
name|tso_minsg
decl_stmt|;
name|error
operator|=
name|hn_rndis_query_hwcaps
argument_list|(
name|sc
argument_list|,
operator|&
name|hwcaps
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"hwcaps query failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* NOTE: 0 means "no change" */
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_DEFAULT
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|<
name|HN_NDIS_VERSION_6_30
condition|)
block|{
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_PARAMS_REV_2
expr_stmt|;
name|paramsz
operator|=
name|NDIS_OFFLOAD_PARAMS_SIZE_6_1
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_PARAMS_REV_3
expr_stmt|;
name|paramsz
operator|=
name|NDIS_OFFLOAD_PARAMS_SIZE
expr_stmt|;
block|}
name|params
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|=
name|paramsz
expr_stmt|;
comment|/* 	 * TSO4/TSO6 setup. 	 */
name|tso_maxsz
operator|=
name|IP_MAXPACKET
expr_stmt|;
name|tso_minsg
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip4_encap
operator|&
name|NDIS_OFFLOAD_ENCAP_8023
condition|)
block|{
name|caps
operator||=
name|HN_CAP_TSO4
expr_stmt|;
name|params
operator|.
name|ndis_lsov2_ip4
operator|=
name|NDIS_OFFLOAD_LSOV2_ON
expr_stmt|;
if|if
condition|(
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip4_maxsz
operator|<
name|tso_maxsz
condition|)
name|tso_maxsz
operator|=
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip4_maxsz
expr_stmt|;
if|if
condition|(
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip4_minsg
operator|>
name|tso_minsg
condition|)
name|tso_minsg
operator|=
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip4_minsg
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip6_encap
operator|&
name|NDIS_OFFLOAD_ENCAP_8023
operator|)
operator|&&
operator|(
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip6_opts
operator|&
name|HN_NDIS_LSOV2_CAP_IP6
operator|)
operator|==
name|HN_NDIS_LSOV2_CAP_IP6
condition|)
block|{
name|caps
operator||=
name|HN_CAP_TSO6
expr_stmt|;
name|params
operator|.
name|ndis_lsov2_ip6
operator|=
name|NDIS_OFFLOAD_LSOV2_ON
expr_stmt|;
if|if
condition|(
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip6_maxsz
operator|<
name|tso_maxsz
condition|)
name|tso_maxsz
operator|=
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip6_maxsz
expr_stmt|;
if|if
condition|(
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip6_minsg
operator|>
name|tso_minsg
condition|)
name|tso_minsg
operator|=
name|hwcaps
operator|.
name|ndis_lsov2
operator|.
name|ndis_ip6_minsg
expr_stmt|;
block|}
name|sc
operator|->
name|hn_ndis_tso_szmax
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|hn_ndis_tso_sgmin
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|caps
operator|&
operator|(
name|HN_CAP_TSO4
operator||
name|HN_CAP_TSO6
operator|)
condition|)
block|{
name|KASSERT
argument_list|(
name|tso_maxsz
operator|<=
name|IP_MAXPACKET
argument_list|,
operator|(
literal|"invalid NDIS TSO maxsz %d"
operator|,
name|tso_maxsz
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|tso_minsg
operator|>=
literal|2
argument_list|,
operator|(
literal|"invalid NDIS TSO minsg %d"
operator|,
name|tso_minsg
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tso_maxsz
operator|<
name|tso_minsg
operator|*
name|mtu
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS TSO config: "
literal|"maxsz %d, minsg %d, mtu %d; "
literal|"disable TSO4 and TSO6\n"
argument_list|,
name|tso_maxsz
argument_list|,
name|tso_minsg
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
name|caps
operator|&=
operator|~
operator|(
name|HN_CAP_TSO4
operator||
name|HN_CAP_TSO6
operator|)
expr_stmt|;
name|params
operator|.
name|ndis_lsov2_ip4
operator|=
name|NDIS_OFFLOAD_LSOV2_OFF
expr_stmt|;
name|params
operator|.
name|ndis_lsov2_ip6
operator|=
name|NDIS_OFFLOAD_LSOV2_OFF
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|hn_ndis_tso_szmax
operator|=
name|tso_maxsz
expr_stmt|;
name|sc
operator|->
name|hn_ndis_tso_sgmin
operator|=
name|tso_minsg
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"NDIS TSO "
literal|"szmax %d sgmin %d\n"
argument_list|,
name|sc
operator|->
name|hn_ndis_tso_szmax
argument_list|,
name|sc
operator|->
name|hn_ndis_tso_sgmin
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* IPv4 checksum */
if|if
condition|(
operator|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip4_txcsum
operator|&
name|HN_NDIS_TXCSUM_CAP_IP4
operator|)
operator|==
name|HN_NDIS_TXCSUM_CAP_IP4
condition|)
block|{
name|caps
operator||=
name|HN_CAP_IPCS
expr_stmt|;
name|params
operator|.
name|ndis_ip4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TX
expr_stmt|;
block|}
if|if
condition|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip4_rxcsum
operator|&
name|NDIS_RXCSUM_CAP_IP4
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|ndis_ip4csum
operator|==
name|NDIS_OFFLOAD_PARAM_TX
condition|)
name|params
operator|.
name|ndis_ip4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
else|else
name|params
operator|.
name|ndis_ip4csum
operator|=
name|NDIS_OFFLOAD_PARAM_RX
expr_stmt|;
block|}
comment|/* TCP4 checksum */
if|if
condition|(
operator|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip4_txcsum
operator|&
name|HN_NDIS_TXCSUM_CAP_TCP4
operator|)
operator|==
name|HN_NDIS_TXCSUM_CAP_TCP4
condition|)
block|{
name|caps
operator||=
name|HN_CAP_TCP4CS
expr_stmt|;
name|params
operator|.
name|ndis_tcp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TX
expr_stmt|;
block|}
if|if
condition|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip4_rxcsum
operator|&
name|NDIS_RXCSUM_CAP_TCP4
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|ndis_tcp4csum
operator|==
name|NDIS_OFFLOAD_PARAM_TX
condition|)
name|params
operator|.
name|ndis_tcp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
else|else
name|params
operator|.
name|ndis_tcp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_RX
expr_stmt|;
block|}
comment|/* UDP4 checksum */
if|if
condition|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip4_txcsum
operator|&
name|NDIS_TXCSUM_CAP_UDP4
condition|)
block|{
name|caps
operator||=
name|HN_CAP_UDP4CS
expr_stmt|;
name|params
operator|.
name|ndis_udp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TX
expr_stmt|;
block|}
if|if
condition|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip4_rxcsum
operator|&
name|NDIS_RXCSUM_CAP_UDP4
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|ndis_udp4csum
operator|==
name|NDIS_OFFLOAD_PARAM_TX
condition|)
name|params
operator|.
name|ndis_udp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
else|else
name|params
operator|.
name|ndis_udp4csum
operator|=
name|NDIS_OFFLOAD_PARAM_RX
expr_stmt|;
block|}
comment|/* TCP6 checksum */
if|if
condition|(
operator|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip6_txcsum
operator|&
name|HN_NDIS_TXCSUM_CAP_TCP6
operator|)
operator|==
name|HN_NDIS_TXCSUM_CAP_TCP6
condition|)
block|{
name|caps
operator||=
name|HN_CAP_TCP6CS
expr_stmt|;
name|params
operator|.
name|ndis_tcp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TX
expr_stmt|;
block|}
if|if
condition|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip6_rxcsum
operator|&
name|NDIS_RXCSUM_CAP_TCP6
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|ndis_tcp6csum
operator|==
name|NDIS_OFFLOAD_PARAM_TX
condition|)
name|params
operator|.
name|ndis_tcp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
else|else
name|params
operator|.
name|ndis_tcp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_RX
expr_stmt|;
block|}
comment|/* UDP6 checksum */
if|if
condition|(
operator|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip6_txcsum
operator|&
name|HN_NDIS_TXCSUM_CAP_UDP6
operator|)
operator|==
name|HN_NDIS_TXCSUM_CAP_UDP6
condition|)
block|{
name|caps
operator||=
name|HN_CAP_UDP6CS
expr_stmt|;
name|params
operator|.
name|ndis_udp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TX
expr_stmt|;
block|}
if|if
condition|(
name|hwcaps
operator|.
name|ndis_csum
operator|.
name|ndis_ip6_rxcsum
operator|&
name|NDIS_RXCSUM_CAP_UDP6
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|ndis_udp6csum
operator|==
name|NDIS_OFFLOAD_PARAM_TX
condition|)
name|params
operator|.
name|ndis_udp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_TXRX
expr_stmt|;
else|else
name|params
operator|.
name|ndis_udp6csum
operator|=
name|NDIS_OFFLOAD_PARAM_RX
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload csum: "
literal|"ip4 %u, tcp4 %u, udp4 %u, tcp6 %u, udp6 %u\n"
argument_list|,
name|params
operator|.
name|ndis_ip4csum
argument_list|,
name|params
operator|.
name|ndis_tcp4csum
argument_list|,
name|params
operator|.
name|ndis_udp4csum
argument_list|,
name|params
operator|.
name|ndis_tcp6csum
argument_list|,
name|params
operator|.
name|ndis_udp6csum
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload lsov2: ip4 %u, ip6 %u\n"
argument_list|,
name|params
operator|.
name|ndis_lsov2_ip4
argument_list|,
name|params
operator|.
name|ndis_lsov2_ip6
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|hn_rndis_set
argument_list|(
name|sc
argument_list|,
name|OID_TCP_OFFLOAD_PARAMETERS
argument_list|,
operator|&
name|params
argument_list|,
name|paramsz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload config failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"offload config done\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hn_caps
operator||=
name|caps
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hn_rndis_conf_rss
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
block|{
name|struct
name|ndis_rssprm_toeplitz
modifier|*
name|rss
init|=
operator|&
name|sc
operator|->
name|hn_rss
decl_stmt|;
name|struct
name|ndis_rss_params
modifier|*
name|prm
init|=
operator|&
name|rss
operator|->
name|rss_params
decl_stmt|;
name|int
name|error
decl_stmt|,
name|rss_size
decl_stmt|;
comment|/* 	 * Only NDIS 6.20+ is supported: 	 * We only support 4bytes element in indirect table, which has been 	 * adopted since NDIS 6.20. 	 */
name|KASSERT
argument_list|(
name|sc
operator|->
name|hn_ndis_ver
operator|>=
name|HN_NDIS_VERSION_6_20
argument_list|,
operator|(
literal|"NDIS 6.20+ is required, NDIS version 0x%08x"
operator|,
name|sc
operator|->
name|hn_ndis_ver
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX only one can be specified through, popcnt? */
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|hn_rss_hash
operator|&
name|NDIS_HASH_FUNCTION_MASK
operator|)
argument_list|,
operator|(
literal|"no hash func"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|sc
operator|->
name|hn_rss_hash
operator|&
name|NDIS_HASH_TYPE_MASK
operator|)
argument_list|,
operator|(
literal|"no hash types"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|hn_rss_ind_size
operator|>
literal|0
argument_list|,
operator|(
literal|"no indirect table size"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS indirect table size %d, "
literal|"hash 0x%08x\n"
argument_list|,
name|sc
operator|->
name|hn_rss_ind_size
argument_list|,
name|sc
operator|->
name|hn_rss_hash
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * NOTE: 	 * DO NOT whack rss_key and rss_ind, which are setup by the caller. 	 */
name|memset
argument_list|(
name|prm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|prm
argument_list|)
argument_list|)
expr_stmt|;
name|rss_size
operator|=
name|NDIS_RSSPRM_TOEPLITZ_SIZE
argument_list|(
name|sc
operator|->
name|hn_rss_ind_size
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_RSS_PARAMS
expr_stmt|;
name|prm
operator|->
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_RSS_PARAMS_REV_2
expr_stmt|;
name|prm
operator|->
name|ndis_hdr
operator|.
name|ndis_size
operator|=
name|rss_size
expr_stmt|;
name|prm
operator|->
name|ndis_flags
operator|=
name|flags
expr_stmt|;
name|prm
operator|->
name|ndis_hash
operator|=
name|sc
operator|->
name|hn_rss_hash
expr_stmt|;
name|prm
operator|->
name|ndis_indsize
operator|=
sizeof|sizeof
argument_list|(
name|rss
operator|->
name|rss_ind
index|[
literal|0
index|]
argument_list|)
operator|*
name|sc
operator|->
name|hn_rss_ind_size
expr_stmt|;
name|prm
operator|->
name|ndis_indoffset
operator|=
name|__offsetof
argument_list|(
expr|struct
name|ndis_rssprm_toeplitz
argument_list|,
name|rss_ind
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_keysize
operator|=
sizeof|sizeof
argument_list|(
name|rss
operator|->
name|rss_key
argument_list|)
expr_stmt|;
name|prm
operator|->
name|ndis_keyoffset
operator|=
name|__offsetof
argument_list|(
expr|struct
name|ndis_rssprm_toeplitz
argument_list|,
name|rss_key
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|error
operator|=
name|hn_rndis_set
argument_list|(
name|sc
argument_list|,
name|OID_GEN_RECEIVE_SCALE_PARAMETERS
argument_list|,
name|rss
argument_list|,
name|rss_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS config failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RSS config done\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hn_rndis_set_rxfilter
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|filter
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|hn_rndis_set
argument_list|(
name|sc
argument_list|,
name|OID_GEN_CURRENT_PACKET_FILTER
argument_list|,
operator|&
name|filter
argument_list|,
sizeof|sizeof
argument_list|(
name|filter
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"set RX filter 0x%08x failed: %d\n"
argument_list|,
name|filter
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"set RX filter 0x%08x done\n"
argument_list|,
name|filter
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_init
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|rndis_init_req
modifier|*
name|req
decl_stmt|;
specifier|const
name|struct
name|rndis_init_comp
modifier|*
name|comp
decl_stmt|;
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|;
name|uint32_t
name|rid
decl_stmt|;
name|int
name|error
decl_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS init\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|req
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_INITIALIZE_MSG
expr_stmt|;
name|req
operator|->
name|rm_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|req
operator|->
name|rm_rid
operator|=
name|rid
expr_stmt|;
name|req
operator|->
name|rm_ver_major
operator|=
name|RNDIS_VERSION_MAJOR
expr_stmt|;
name|req
operator|->
name|rm_ver_minor
operator|=
name|RNDIS_VERSION_MINOR
expr_stmt|;
name|req
operator|->
name|rm_max_xfersz
operator|=
name|HN_RNDIS_XFER_SIZE
expr_stmt|;
name|comp_len
operator|=
name|RNDIS_INIT_COMP_SIZE_MIN
expr_stmt|;
name|comp
operator|=
name|hn_rndis_xact_execute
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
name|rid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|,
operator|&
name|comp_len
argument_list|,
name|REMOTE_NDIS_INITIALIZE_CMPLT
argument_list|)
expr_stmt|;
if|if
condition|(
name|comp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"exec RNDIS init failed\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|comp
operator|->
name|rm_status
operator|!=
name|RNDIS_STATUS_SUCCESS
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS init failed: status 0x%08x\n"
argument_list|,
name|comp
operator|->
name|rm_status
argument_list|)
expr_stmt|;
name|error
operator|=
name|EIO
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|sc
operator|->
name|hn_rndis_agg_size
operator|=
name|comp
operator|->
name|rm_pktmaxsz
expr_stmt|;
name|sc
operator|->
name|hn_rndis_agg_pkts
operator|=
name|comp
operator|->
name|rm_pktmaxcnt
expr_stmt|;
name|sc
operator|->
name|hn_rndis_agg_align
operator|=
literal|1U
operator|<<
name|comp
operator|->
name|rm_align
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_rndis_agg_align
operator|<
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
block|{
comment|/* 		 * The RNDIS packet messsage encap assumes that the RNDIS 		 * packet message is at least 4 bytes aligned.  Fix up the 		 * alignment here, if the remote side sets the alignment 		 * too low. 		 */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"fixup RNDIS aggpkt align: %u -> %zu\n"
argument_list|,
name|sc
operator|->
name|hn_rndis_agg_align
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hn_rndis_agg_align
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS ver %u.%u, "
literal|"aggpkt size %u, aggpkt cnt %u, aggpkt align %u\n"
argument_list|,
name|comp
operator|->
name|rm_ver_major
argument_list|,
name|comp
operator|->
name|rm_ver_minor
argument_list|,
name|sc
operator|->
name|hn_rndis_agg_size
argument_list|,
name|sc
operator|->
name|hn_rndis_agg_pkts
argument_list|,
name|sc
operator|->
name|hn_rndis_agg_align
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_halt
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmbus_xact
modifier|*
name|xact
decl_stmt|;
name|struct
name|rndis_halt_req
modifier|*
name|halt
decl_stmt|;
name|struct
name|hn_nvs_sendctx
name|sndc
decl_stmt|;
name|size_t
name|comp_len
decl_stmt|;
name|xact
operator|=
name|vmbus_xact_get
argument_list|(
name|sc
operator|->
name|hn_xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|halt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|xact
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"no xact for RNDIS halt\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|halt
operator|=
name|vmbus_xact_req_data
argument_list|(
name|xact
argument_list|)
expr_stmt|;
name|halt
operator|->
name|rm_type
operator|=
name|REMOTE_NDIS_HALT_MSG
expr_stmt|;
name|halt
operator|->
name|rm_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|halt
argument_list|)
expr_stmt|;
name|halt
operator|->
name|rm_rid
operator|=
name|hn_rndis_rid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* No RNDIS completion; rely on NVS message send completion */
name|hn_nvs_sendctx_init
argument_list|(
operator|&
name|sndc
argument_list|,
name|hn_nvs_sent_xact
argument_list|,
name|xact
argument_list|)
expr_stmt|;
name|hn_rndis_xact_exec1
argument_list|(
name|sc
argument_list|,
name|xact
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|halt
argument_list|)
argument_list|,
operator|&
name|sndc
argument_list|,
operator|&
name|comp_len
argument_list|)
expr_stmt|;
name|vmbus_xact_put
argument_list|(
name|xact
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"RNDIS halt done\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hn_rndis_query_hwcaps
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ndis_offload
modifier|*
name|caps
parameter_list|)
block|{
name|struct
name|ndis_offload
name|in
decl_stmt|;
name|size_t
name|caps_len
decl_stmt|,
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|memset
argument_list|(
operator|&
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_type
operator|=
name|NDIS_OBJTYPE_OFFLOAD
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|>=
name|HN_NDIS_VERSION_6_30
condition|)
block|{
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_REV_3
expr_stmt|;
name|size
operator|=
name|NDIS_OFFLOAD_SIZE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|hn_ndis_ver
operator|>=
name|HN_NDIS_VERSION_6_1
condition|)
block|{
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_REV_2
expr_stmt|;
name|size
operator|=
name|NDIS_OFFLOAD_SIZE_6_1
expr_stmt|;
block|}
else|else
block|{
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_rev
operator|=
name|NDIS_OFFLOAD_REV_1
expr_stmt|;
name|size
operator|=
name|NDIS_OFFLOAD_SIZE_6_0
expr_stmt|;
block|}
name|in
operator|.
name|ndis_hdr
operator|.
name|ndis_size
operator|=
name|size
expr_stmt|;
name|caps_len
operator|=
name|NDIS_OFFLOAD_SIZE
expr_stmt|;
name|error
operator|=
name|hn_rndis_query2
argument_list|(
name|sc
argument_list|,
name|OID_TCP_OFFLOAD_HARDWARE_CAPABILITIES
argument_list|,
operator|&
name|in
argument_list|,
name|size
argument_list|,
name|caps
argument_list|,
operator|&
name|caps_len
argument_list|,
name|NDIS_OFFLOAD_SIZE_6_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Preliminary verification. 	 */
if|if
condition|(
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_type
operator|!=
name|NDIS_OBJTYPE_OFFLOAD
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objtype 0x%02x\n"
argument_list|,
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_rev
operator|<
name|NDIS_OFFLOAD_REV_1
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objrev 0x%02x\n"
argument_list|,
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_rev
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_size
operator|>
name|caps_len
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objsize %u, "
literal|"data size %zu\n"
argument_list|,
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_size
argument_list|,
name|caps_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_size
operator|<
name|NDIS_OFFLOAD_SIZE_6_0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"invalid NDIS objsize %u\n"
argument_list|,
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
comment|/* 		 * NOTE: 		 * caps->ndis_hdr.ndis_size MUST be checked before accessing 		 * NDIS 6.1+ specific fields. 		 */
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"hwcaps rev %u\n"
argument_list|,
name|caps
operator|->
name|ndis_hdr
operator|.
name|ndis_rev
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"hwcaps csum: "
literal|"ip4 tx 0x%x/0x%x rx 0x%x/0x%x, "
literal|"ip6 tx 0x%x/0x%x rx 0x%x/0x%x\n"
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip4_txcsum
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip4_txenc
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip4_rxcsum
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip4_rxenc
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip6_txcsum
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip6_txenc
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip6_rxcsum
argument_list|,
name|caps
operator|->
name|ndis_csum
operator|.
name|ndis_ip6_rxenc
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|hn_ifp
argument_list|,
literal|"hwcaps lsov2: "
literal|"ip4 maxsz %u minsg %u encap 0x%x, "
literal|"ip6 maxsz %u minsg %u encap 0x%x opts 0x%x\n"
argument_list|,
name|caps
operator|->
name|ndis_lsov2
operator|.
name|ndis_ip4_maxsz
argument_list|,
name|caps
operator|->
name|ndis_lsov2
operator|.
name|ndis_ip4_minsg
argument_list|,
name|caps
operator|->
name|ndis_lsov2
operator|.
name|ndis_ip4_encap
argument_list|,
name|caps
operator|->
name|ndis_lsov2
operator|.
name|ndis_ip6_maxsz
argument_list|,
name|caps
operator|->
name|ndis_lsov2
operator|.
name|ndis_ip6_minsg
argument_list|,
name|caps
operator|->
name|ndis_lsov2
operator|.
name|ndis_ip6_encap
argument_list|,
name|caps
operator|->
name|ndis_lsov2
operator|.
name|ndis_ip6_opts
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|hn_rndis_attach
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mtu
parameter_list|,
name|int
modifier|*
name|init_done
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
operator|*
name|init_done
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Initialize RNDIS. 	 */
name|error
operator|=
name|hn_rndis_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
operator|*
name|init_done
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Configure NDIS offload settings. 	 */
name|hn_rndis_conf_offload
argument_list|(
name|sc
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|hn_rndis_detach
parameter_list|(
name|struct
name|hn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Halt the RNDIS. */
name|hn_rndis_halt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


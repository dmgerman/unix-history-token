begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1997-2001 Gerd Knorr<kraxel@bytesex.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * programming the msp34* sound processor family  *  * (c) 1997-2001 Gerd Knorr<kraxel@bytesex.org>  *  * what works and what doesn't:  *  *  AM-Mono  *      Support for Hauppauge cards added (decoding handled by tuner) added by  *      Frederic Crozat<fcrozat@mail.dotcom.fr>  *  *  FM-Mono  *      should work. The stereo modes are backward compatible to FM-mono,  *      therefore FM-Mono should be allways available.  *  *  FM-Stereo (B/G, used in germany)  *      should work, with autodetect  *  *  FM-Stereo (satellite)  *      should work, no autodetect (i.e. default is mono, but you can  *      switch to stereo -- untested)  *  *  NICAM (B/G, L , used in UK, Scandinavia, Spain and France)  *      should work, with autodetect. Support for NICAM was added by  *      Pekka Pietikainen<pp@netppl.fi>  *  *  * TODO:  *   - better SAT support  *  *  * 980623  Thomas Sailer (sailer@ife.ee.ethz.ch)  *         using soundcore instead of OSS  *  *  * The FreeBSD modifications by Alexander Langer<alex@FreeBSD.org>  * are in the public domain.  Please contact me (Alex) and not Gerd for  * any problems you encounter under FreeBSD.  *   * FreeBSD TODO:   * - mutex handling (currently not mp-safe)  * - the various options here as loader tunables or compile time or whatever  * - how does the new dolby flag work with the current dpl_* stuff?  *   Maybe it's just enough to set the dolby flag to 1 and it works.  *   As I don't have a dolby card myself, I can't test it, though.  */
end_comment

begin_include
include|#
directive|include
file|"opt_bktr.h"
end_include

begin_comment
comment|/* Include any kernel config options */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BKTR_NEW_MSP34XX_DRIVER
end_ifdef

begin_comment
comment|/* file only needed for new driver */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_comment
comment|/* required by bktr_reg.h */
end_comment

begin_include
include|#
directive|include
file|<dev/bktr/ioctl_meteor.h>
end_include

begin_include
include|#
directive|include
file|<dev/bktr/ioctl_bt848.h>
end_include

begin_comment
comment|/* extensions to ioctl_meteor.h */
end_comment

begin_include
include|#
directive|include
file|<dev/bktr/bktr_reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/bktr/bktr_tuner.h>
end_include

begin_include
include|#
directive|include
file|<dev/bktr/bktr_audio.h>
end_include

begin_include
include|#
directive|include
file|<dev/bktr/bktr_core.h>
end_include

begin_define
define|#
directive|define
name|VIDEO_MODE_PAL
value|0
end_define

begin_define
define|#
directive|define
name|VIDEO_MODE_NTSC
value|1
end_define

begin_define
define|#
directive|define
name|VIDEO_MODE_SECAM
value|2
end_define

begin_define
define|#
directive|define
name|VIDEO_MODE_AUTO
value|3
end_define

begin_define
define|#
directive|define
name|VIDEO_SOUND_MONO
value|1
end_define

begin_define
define|#
directive|define
name|VIDEO_SOUND_STEREO
value|2
end_define

begin_define
define|#
directive|define
name|VIDEO_SOUND_LANG1
value|4
end_define

begin_define
define|#
directive|define
name|VIDEO_SOUND_LANG2
value|8
end_define

begin_define
define|#
directive|define
name|DFP_COUNT
value|0x41
end_define

begin_decl_stmt
specifier|static
specifier|const
name|int
name|bl_dfp
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x01
block|,
literal|0x02
block|,
literal|0x03
block|,
literal|0x06
block|,
literal|0x08
block|,
literal|0x09
block|,
literal|0x0a
block|,
literal|0x0b
block|,
literal|0x0d
block|,
literal|0x0e
block|,
literal|0x10
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|msp3400c
block|{
name|int
name|simple
decl_stmt|;
name|int
name|nicam
decl_stmt|;
name|int
name|mode
decl_stmt|;
name|int
name|norm
decl_stmt|;
name|int
name|stereo
decl_stmt|;
name|int
name|nicam_on
decl_stmt|;
name|int
name|acb
decl_stmt|;
name|int
decl|main
decl_stmt|,
name|second
decl_stmt|;
comment|/* sound carrier */
name|int
name|input
decl_stmt|;
name|int
name|muted
decl_stmt|;
name|int
name|left
decl_stmt|,
name|right
decl_stmt|;
comment|/* volume */
name|int
name|bass
decl_stmt|,
name|treble
decl_stmt|;
comment|/* shadow register set */
name|int
name|dfp_regs
index|[
name|DFP_COUNT
index|]
decl_stmt|;
comment|/* thread */
name|struct
name|proc
modifier|*
name|kthread
decl_stmt|;
name|char
modifier|*
name|threaddesc
decl_stmt|;
name|int
name|active
decl_stmt|,
name|restart
decl_stmt|,
name|rmmod
decl_stmt|;
name|int
name|watch_stereo
decl_stmt|;
name|int
name|halt_thread
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|VIDEO_MODE_RADIO
value|16
end_define

begin_comment
comment|/* norm magic for radio mode */
end_comment

begin_comment
comment|/* ---------------------------------------------------------------------- */
end_comment

begin_define
define|#
directive|define
name|dprintk
parameter_list|(
modifier|...
parameter_list|)
value|do {						\ 	if (bootverbose) {						\ 		printf("%s: ", bktr_name(client));			\ 		printf(__VA_ARGS__);					\ 	}								\ } while (0)
end_define

begin_comment
comment|/* ---------------------------------------------------------------------- */
end_comment

begin_define
define|#
directive|define
name|I2C_MSP3400C
value|0x80
end_define

begin_define
define|#
directive|define
name|I2C_MSP3400C_DEM
value|0x10
end_define

begin_define
define|#
directive|define
name|I2C_MSP3400C_DFP
value|0x12
end_define

begin_comment
comment|/* ----------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* functions for talking to the MSP3400C Sound processor                   */
end_comment

begin_function
specifier|static
name|int
name|msp3400c_reset
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|)
block|{
comment|/* use our own which handles config(8) options */
name|msp_dpl_reset
argument_list|(
name|client
argument_list|,
name|client
operator|->
name|msp_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|msp3400c_read
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|dev
parameter_list|,
name|int
name|addr
parameter_list|)
block|{
comment|/* use our own */
return|return
operator|(
name|msp_dpl_read
argument_list|(
name|client
argument_list|,
name|client
operator|->
name|msp_addr
argument_list|,
name|dev
argument_list|,
name|addr
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|msp3400c_write
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|dev
parameter_list|,
name|int
name|addr
parameter_list|,
name|int
name|val
parameter_list|)
block|{
comment|/* use our own */
name|msp_dpl_write
argument_list|(
name|client
argument_list|,
name|client
operator|->
name|msp_addr
argument_list|,
name|dev
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ------------------------------------------------------------------------ */
end_comment

begin_comment
comment|/* This macro is allowed for *constants* only, gcc must calculate it    at compile time.  Remember -- no floats in kernel mode */
end_comment

begin_define
define|#
directive|define
name|MSP_CARRIER
parameter_list|(
name|freq
parameter_list|)
value|((int)((float)(freq/18.432)*(1<<24)))
end_define

begin_define
define|#
directive|define
name|MSP_MODE_AM_DETECT
value|0
end_define

begin_define
define|#
directive|define
name|MSP_MODE_FM_RADIO
value|2
end_define

begin_define
define|#
directive|define
name|MSP_MODE_FM_TERRA
value|3
end_define

begin_define
define|#
directive|define
name|MSP_MODE_FM_SAT
value|4
end_define

begin_define
define|#
directive|define
name|MSP_MODE_FM_NICAM1
value|5
end_define

begin_define
define|#
directive|define
name|MSP_MODE_FM_NICAM2
value|6
end_define

begin_define
define|#
directive|define
name|MSP_MODE_AM_NICAM
value|7
end_define

begin_define
define|#
directive|define
name|MSP_MODE_BTSC
value|8
end_define

begin_define
define|#
directive|define
name|MSP_MODE_EXTERN
value|9
end_define

begin_struct
specifier|static
struct|struct
name|MSP_INIT_DATA_DEM
block|{
name|int
name|fir1
index|[
literal|6
index|]
decl_stmt|;
name|int
name|fir2
index|[
literal|6
index|]
decl_stmt|;
name|int
name|cdo1
decl_stmt|;
name|int
name|cdo2
decl_stmt|;
name|int
name|ad_cv
decl_stmt|;
name|int
name|mode_reg
decl_stmt|;
name|int
name|dfp_src
decl_stmt|;
name|int
name|dfp_matrix
decl_stmt|;
block|}
name|msp_init_data
index|[]
init|=
block|{
comment|/* AM (for carrier detect / msp3400) */
block|{
block|{
literal|75
block|,
literal|19
block|,
literal|36
block|,
literal|35
block|,
literal|39
block|,
literal|40
block|}
block|,
block|{
literal|75
block|,
literal|19
block|,
literal|36
block|,
literal|35
block|,
literal|39
block|,
literal|40
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
literal|0x00d0
block|,
literal|0x0500
block|,
literal|0x0020
block|,
literal|0x3000
block|}
block|,
comment|/* AM (for carrier detect / msp3410) */
block|{
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|8
block|,
literal|2
block|,
literal|59
block|,
literal|126
block|}
block|,
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|8
block|,
literal|2
block|,
literal|59
block|,
literal|126
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
literal|0x00d0
block|,
literal|0x0100
block|,
literal|0x0020
block|,
literal|0x3000
block|}
block|,
comment|/* FM Radio */
block|{
block|{
operator|-
literal|8
block|,
operator|-
literal|8
block|,
literal|4
block|,
literal|6
block|,
literal|78
block|,
literal|107
block|}
block|,
block|{
operator|-
literal|8
block|,
operator|-
literal|8
block|,
literal|4
block|,
literal|6
block|,
literal|78
block|,
literal|107
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|10.7
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|10.7
argument_list|)
block|,
literal|0x00d0
block|,
literal|0x0480
block|,
literal|0x0020
block|,
literal|0x3000
block|}
block|,
comment|/* Terrestial FM-mono + FM-stereo */
block|{
block|{
literal|3
block|,
literal|18
block|,
literal|27
block|,
literal|48
block|,
literal|66
block|,
literal|72
block|}
block|,
block|{
literal|3
block|,
literal|18
block|,
literal|27
block|,
literal|48
block|,
literal|66
block|,
literal|72
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
literal|0x00d0
block|,
literal|0x0480
block|,
literal|0x0030
block|,
literal|0x3000
block|}
block|,
comment|/* Sat FM-mono */
block|{
block|{
literal|1
block|,
literal|9
block|,
literal|14
block|,
literal|24
block|,
literal|33
block|,
literal|37
block|}
block|,
block|{
literal|3
block|,
literal|18
block|,
literal|27
block|,
literal|48
block|,
literal|66
block|,
literal|72
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
literal|0x00c6
block|,
literal|0x0480
block|,
literal|0x0000
block|,
literal|0x3000
block|}
block|,
comment|/* NICAM/FM --  B/G (5.5/5.85), D/K (6.5/5.85) */
block|{
block|{
operator|-
literal|2
block|,
operator|-
literal|8
block|,
operator|-
literal|10
block|,
literal|10
block|,
literal|50
block|,
literal|86
block|}
block|,
block|{
literal|3
block|,
literal|18
block|,
literal|27
block|,
literal|48
block|,
literal|66
block|,
literal|72
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
literal|0x00d0
block|,
literal|0x0040
block|,
literal|0x0120
block|,
literal|0x3000
block|}
block|,
comment|/* NICAM/FM -- I (6.0/6.552) */
block|{
block|{
literal|2
block|,
literal|4
block|,
operator|-
literal|6
block|,
operator|-
literal|4
block|,
literal|40
block|,
literal|94
block|}
block|,
block|{
literal|3
block|,
literal|18
block|,
literal|27
block|,
literal|48
block|,
literal|66
block|,
literal|72
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|6.0
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.0
argument_list|)
block|,
literal|0x00d0
block|,
literal|0x0040
block|,
literal|0x0120
block|,
literal|0x3000
block|}
block|,
comment|/* NICAM/AM -- L (6.5/5.85) */
block|{
block|{
operator|-
literal|2
block|,
operator|-
literal|8
block|,
operator|-
literal|10
block|,
literal|10
block|,
literal|50
block|,
literal|86
block|}
block|,
block|{
operator|-
literal|4
block|,
operator|-
literal|12
block|,
operator|-
literal|9
block|,
literal|23
block|,
literal|79
block|,
literal|126
block|}
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
literal|0x00c6
block|,
literal|0x0140
block|,
literal|0x0120
block|,
literal|0x7c03
block|}
block|, }
struct|;
end_struct

begin_struct
struct|struct
name|CARRIER_DETECT
block|{
name|int
name|cdo
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|CARRIER_DETECT
name|carrier_detect_main
index|[]
init|=
block|{
comment|/* main carrier */
block|{
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
literal|"4.5   NTSC"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
literal|"5.5   PAL B/G"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|6.0
argument_list|)
block|,
literal|"6.0   PAL I"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
literal|"6.5   PAL D/K + SAT + SECAM"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|CARRIER_DETECT
name|carrier_detect_55
index|[]
init|=
block|{
comment|/* PAL B/G */
block|{
name|MSP_CARRIER
argument_list|(
literal|5.7421875
argument_list|)
block|,
literal|"5.742 PAL B/G FM-stereo"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|5.85
argument_list|)
block|,
literal|"5.85  PAL B/G NICAM"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|CARRIER_DETECT
name|carrier_detect_65
index|[]
init|=
block|{
comment|/* PAL SAT / SECAM */
block|{
name|MSP_CARRIER
argument_list|(
literal|5.85
argument_list|)
block|,
literal|"5.85  PAL D/K + SECAM NICAM"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|6.2578125
argument_list|)
block|,
literal|"6.25  PAL D/K1 FM-stereo"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|6.7421875
argument_list|)
block|,
literal|"6.74  PAL D/K2 FM-stereo"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|7.02
argument_list|)
block|,
literal|"7.02  PAL SAT FM-stereo s/b"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|7.20
argument_list|)
block|,
literal|"7.20  PAL SAT FM-stereo s"
block|}
block|,
block|{
name|MSP_CARRIER
argument_list|(
literal|7.38
argument_list|)
block|,
literal|"7.38  PAL SAT FM-stereo b"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CARRIER_COUNT
parameter_list|(
name|x
parameter_list|)
value|(sizeof(x)/sizeof(struct CARRIER_DETECT))
end_define

begin_comment
comment|/* ----------------------------------------------------------------------- */
end_comment

begin_define
define|#
directive|define
name|SCART_MASK
value|0
end_define

begin_define
define|#
directive|define
name|SCART_IN1
value|1
end_define

begin_define
define|#
directive|define
name|SCART_IN2
value|2
end_define

begin_define
define|#
directive|define
name|SCART_IN1_DA
value|3
end_define

begin_define
define|#
directive|define
name|SCART_IN2_DA
value|4
end_define

begin_define
define|#
directive|define
name|SCART_IN3
value|5
end_define

begin_define
define|#
directive|define
name|SCART_IN4
value|6
end_define

begin_define
define|#
directive|define
name|SCART_MONO
value|7
end_define

begin_define
define|#
directive|define
name|SCART_MUTE
value|8
end_define

begin_decl_stmt
specifier|static
name|int
name|scarts
index|[
literal|3
index|]
index|[
literal|9
index|]
init|=
block|{
comment|/* MASK    IN1     IN2     IN1_DA  IN2_DA  IN3     IN4     MONO    MUTE   */
block|{
literal|0x0320
block|,
literal|0x0000
block|,
literal|0x0200
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|0x0300
block|,
literal|0x0020
block|,
literal|0x0100
block|,
literal|0x0320
block|}
block|,
block|{
literal|0x0c40
block|,
literal|0x0440
block|,
literal|0x0400
block|,
literal|0x0c00
block|,
literal|0x0040
block|,
literal|0x0000
block|,
literal|0x0840
block|,
literal|0x0800
block|,
literal|0x0c40
block|}
block|,
block|{
literal|0x3080
block|,
literal|0x1000
block|,
literal|0x1080
block|,
literal|0x0000
block|,
literal|0x0080
block|,
literal|0x2080
block|,
literal|0x3080
block|,
literal|0x2000
block|,
literal|0x3000
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|scart_names
index|[]
init|=
block|{
literal|"mask"
block|,
literal|"in1"
block|,
literal|"in2"
block|,
literal|"in1 da"
block|,
literal|"in2 da"
block|,
literal|"in3"
block|,
literal|"in4"
block|,
literal|"mono"
block|,
literal|"mute"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|msp3400c_set_scart
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|in
parameter_list|,
name|int
name|out
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
name|client
operator|->
name|msp3400c_info
decl_stmt|;
if|if
condition|(
operator|-
literal|1
operator|==
name|scarts
index|[
name|out
index|]
index|[
name|in
index|]
condition|)
return|return;
name|dprintk
argument_list|(
literal|"msp34xx: scart switch: %s => %d\n"
argument_list|,
name|scart_names
index|[
name|in
index|]
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|msp
operator|->
name|acb
operator|&=
operator|~
name|scarts
index|[
name|out
index|]
index|[
name|SCART_MASK
index|]
expr_stmt|;
name|msp
operator|->
name|acb
operator||=
name|scarts
index|[
name|out
index|]
index|[
name|in
index|]
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0013
argument_list|,
name|msp
operator|->
name|acb
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ------------------------------------------------------------------------ */
end_comment

begin_function
specifier|static
name|void
name|msp3400c_setcarrier
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|cdo1
parameter_list|,
name|int
name|cdo2
parameter_list|)
block|{
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0093
argument_list|,
name|cdo1
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x009b
argument_list|,
name|cdo1
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x00a3
argument_list|,
name|cdo2
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x00ab
argument_list|,
name|cdo2
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0056
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*LOAD_REG_1/2*/
block|}
end_function

begin_function
specifier|static
name|void
name|msp3400c_setvolume
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|muted
parameter_list|,
name|int
name|left
parameter_list|,
name|int
name|right
parameter_list|)
block|{
name|int
name|vol
init|=
literal|0
decl_stmt|,
name|val
init|=
literal|0
decl_stmt|,
name|balance
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|muted
condition|)
block|{
name|vol
operator|=
operator|(
name|left
operator|>
name|right
operator|)
condition|?
name|left
else|:
name|right
expr_stmt|;
name|val
operator|=
operator|(
name|vol
operator|*
literal|0x73
operator|/
literal|65535
operator|)
operator|<<
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|vol
operator|>
literal|0
condition|)
block|{
name|balance
operator|=
operator|(
operator|(
name|right
operator|-
name|left
operator|)
operator|*
literal|127
operator|)
operator|/
name|vol
expr_stmt|;
block|}
name|dprintk
argument_list|(
literal|"msp34xx: setvolume: mute=%s %d:%d  v=0x%02x b=0x%02x\n"
argument_list|,
name|muted
condition|?
literal|"on"
else|:
literal|"off"
argument_list|,
name|left
argument_list|,
name|right
argument_list|,
name|val
operator|>>
literal|8
argument_list|,
name|balance
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0000
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* loudspeaker */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0006
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* headphones  */
comment|/* scart - on/off only */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0007
argument_list|,
name|val
condition|?
literal|0x4000
else|:
literal|0
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0001
argument_list|,
name|balance
operator|<<
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|msp3400c_setbass
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|bass
parameter_list|)
block|{
name|int
name|val
init|=
operator|(
operator|(
name|bass
operator|-
literal|32768
operator|)
operator|*
literal|0x60
operator|/
literal|65535
operator|)
operator|<<
literal|8
decl_stmt|;
name|dprintk
argument_list|(
literal|"msp34xx: setbass: %d 0x%02x\n"
argument_list|,
name|bass
argument_list|,
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0002
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* loudspeaker */
block|}
end_function

begin_function
specifier|static
name|void
name|msp3400c_settreble
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|treble
parameter_list|)
block|{
name|int
name|val
init|=
operator|(
operator|(
name|treble
operator|-
literal|32768
operator|)
operator|*
literal|0x60
operator|/
literal|65535
operator|)
operator|<<
literal|8
decl_stmt|;
name|dprintk
argument_list|(
literal|"msp34xx: settreble: %d 0x%02x\n"
argument_list|,
name|treble
argument_list|,
name|val
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0003
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* loudspeaker */
block|}
end_function

begin_function
specifier|static
name|void
name|msp3400c_setmode
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dprintk
argument_list|(
literal|"msp3400: setmode: %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|msp
operator|->
name|mode
operator|=
name|type
expr_stmt|;
name|msp
operator|->
name|stereo
operator|=
name|VIDEO_SOUND_MONO
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x00bb
argument_list|,
comment|/* ad_cv */
name|msp_init_data
index|[
name|type
index|]
operator|.
name|ad_cv
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|5
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
comment|/* fir 1 */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0001
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|fir1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0005
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
comment|/* fir 2 */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0005
argument_list|,
literal|0x0040
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0005
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|5
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0005
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|fir2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0083
argument_list|,
comment|/* MODE_REG */
name|msp_init_data
index|[
name|type
index|]
operator|.
name|mode_reg
argument_list|)
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|cdo1
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|cdo2
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x0056
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/*LOAD_REG_1/2*/
if|if
condition|(
name|client
operator|->
name|dolby
condition|)
block|{
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0008
argument_list|,
literal|0x0520
argument_list|)
expr_stmt|;
comment|/* I2S1 */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0009
argument_list|,
literal|0x0620
argument_list|)
expr_stmt|;
comment|/* I2S2 */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000b
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|dfp_src
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0008
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|dfp_src
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0009
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|dfp_src
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000b
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|dfp_src
argument_list|)
expr_stmt|;
block|}
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000a
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|dfp_src
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000e
argument_list|,
name|msp_init_data
index|[
name|type
index|]
operator|.
name|dfp_matrix
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|nicam
condition|)
block|{
comment|/* nicam prescale */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0010
argument_list|,
literal|0x5a00
argument_list|)
expr_stmt|;
comment|/* was: 0x3000 */
block|}
block|}
end_function

begin_comment
comment|/* turn on/off nicam + stereo */
end_comment

begin_function
specifier|static
name|void
name|msp3400c_setstereo
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|strmode
index|[]
init|=
block|{
literal|"0"
block|,
literal|"mono"
block|,
literal|"stereo"
block|,
literal|"3"
block|,
literal|"lang1"
block|,
literal|"5"
block|,
literal|"6"
block|,
literal|"7"
block|,
literal|"lang2"
block|}
decl_stmt|;
name|struct
name|msp3400c
modifier|*
name|msp
init|=
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|int
name|nicam
init|=
literal|0
decl_stmt|;
comment|/* channel source: FM/AM or nicam */
name|int
name|src
init|=
literal|0
decl_stmt|;
comment|/* switch demodulator */
switch|switch
condition|(
name|msp
operator|->
name|mode
condition|)
block|{
case|case
name|MSP_MODE_FM_TERRA
case|:
name|dprintk
argument_list|(
literal|"msp3400: FM setstereo: %s\n"
argument_list|,
name|strmode
index|[
name|mode
index|]
argument_list|)
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|second
argument_list|,
name|msp
operator|->
expr|main
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|VIDEO_SOUND_STEREO
case|:
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000e
argument_list|,
literal|0x3001
argument_list|)
expr_stmt|;
break|break;
case|case
name|VIDEO_SOUND_MONO
case|:
case|case
name|VIDEO_SOUND_LANG1
case|:
case|case
name|VIDEO_SOUND_LANG2
case|:
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000e
argument_list|,
literal|0x3000
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|MSP_MODE_FM_SAT
case|:
name|dprintk
argument_list|(
literal|"msp3400: SAT setstereo: %s\n"
argument_list|,
name|strmode
index|[
name|mode
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|VIDEO_SOUND_MONO
case|:
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|VIDEO_SOUND_STEREO
case|:
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|7.2
argument_list|)
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|7.02
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|VIDEO_SOUND_LANG1
case|:
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|7.38
argument_list|)
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|7.02
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|VIDEO_SOUND_LANG2
case|:
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|7.38
argument_list|)
argument_list|,
name|MSP_CARRIER
argument_list|(
literal|7.02
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|MSP_MODE_FM_NICAM1
case|:
case|case
name|MSP_MODE_FM_NICAM2
case|:
case|case
name|MSP_MODE_AM_NICAM
case|:
name|dprintk
argument_list|(
literal|"msp3400: NICAM setstereo: %s\n"
argument_list|,
name|strmode
index|[
name|mode
index|]
argument_list|)
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|second
argument_list|,
name|msp
operator|->
expr|main
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|nicam_on
condition|)
name|nicam
operator|=
literal|0x0100
expr_stmt|;
break|break;
case|case
name|MSP_MODE_BTSC
case|:
name|dprintk
argument_list|(
literal|"msp3400: BTSC setstereo: %s\n"
argument_list|,
name|strmode
index|[
name|mode
index|]
argument_list|)
expr_stmt|;
name|nicam
operator|=
literal|0x0300
expr_stmt|;
break|break;
case|case
name|MSP_MODE_EXTERN
case|:
name|dprintk
argument_list|(
literal|"msp3400: extern setstereo: %s\n"
argument_list|,
name|strmode
index|[
name|mode
index|]
argument_list|)
expr_stmt|;
name|nicam
operator|=
literal|0x0200
expr_stmt|;
break|break;
case|case
name|MSP_MODE_FM_RADIO
case|:
name|dprintk
argument_list|(
literal|"msp3400: FM-Radio setstereo: %s\n"
argument_list|,
name|strmode
index|[
name|mode
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dprintk
argument_list|(
literal|"msp3400: mono setstereo\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* switch audio */
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|VIDEO_SOUND_STEREO
case|:
name|src
operator|=
literal|0x0020
operator||
name|nicam
expr_stmt|;
if|#
directive|if
literal|0
comment|/* spatial effect */
block|msp3400c_write(client,I2C_MSP3400C_DFP, 0x0005,0x4000);
endif|#
directive|endif
break|break;
case|case
name|VIDEO_SOUND_MONO
case|:
if|if
condition|(
name|msp
operator|->
name|mode
operator|==
name|MSP_MODE_AM_NICAM
condition|)
block|{
name|dprintk
argument_list|(
literal|"msp3400: switching to AM mono\n"
argument_list|)
expr_stmt|;
comment|/* AM mono decoding is handled by tuner, not MSP chip */
comment|/* SCART switching control register */
name|msp3400c_set_scart
argument_list|(
name|client
argument_list|,
name|SCART_MONO
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|src
operator|=
literal|0x0200
expr_stmt|;
break|break;
block|}
case|case
name|VIDEO_SOUND_LANG1
case|:
name|src
operator|=
literal|0x0000
operator||
name|nicam
expr_stmt|;
break|break;
case|case
name|VIDEO_SOUND_LANG2
case|:
name|src
operator|=
literal|0x0010
operator||
name|nicam
expr_stmt|;
break|break;
block|}
name|dprintk
argument_list|(
literal|"msp3400: setstereo final source/matrix = 0x%x\n"
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|dolby
condition|)
block|{
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0008
argument_list|,
literal|0x0520
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0009
argument_list|,
literal|0x0620
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000a
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000b
argument_list|,
name|src
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0008
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0009
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000a
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000b
argument_list|,
name|src
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|msp3400c_print_mode
parameter_list|(
name|struct
name|msp3400c
modifier|*
name|msp
parameter_list|)
block|{
if|if
condition|(
name|msp
operator|->
expr|main
operator|==
name|msp
operator|->
name|second
condition|)
block|{
name|printf
argument_list|(
literal|"bktr: msp3400: mono sound carrier: %d.%03d MHz\n"
argument_list|,
name|msp
operator|->
expr|main
operator|/
literal|910000
argument_list|,
operator|(
name|msp
operator|->
expr|main
operator|/
literal|910
operator|)
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"bktr: msp3400: main sound carrier: %d.%03d MHz\n"
argument_list|,
name|msp
operator|->
expr|main
operator|/
literal|910000
argument_list|,
operator|(
name|msp
operator|->
expr|main
operator|/
literal|910
operator|)
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|msp
operator|->
name|mode
operator|==
name|MSP_MODE_FM_NICAM1
operator|||
name|msp
operator|->
name|mode
operator|==
name|MSP_MODE_FM_NICAM2
condition|)
name|printf
argument_list|(
literal|"bktr: msp3400: NICAM/FM carrier   : %d.%03d MHz\n"
argument_list|,
name|msp
operator|->
name|second
operator|/
literal|910000
argument_list|,
operator|(
name|msp
operator|->
name|second
operator|/
literal|910
operator|)
operator|%
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|mode
operator|==
name|MSP_MODE_AM_NICAM
condition|)
name|printf
argument_list|(
literal|"bktr: msp3400: NICAM/AM carrier   : %d.%03d MHz\n"
argument_list|,
name|msp
operator|->
name|second
operator|/
literal|910000
argument_list|,
operator|(
name|msp
operator|->
name|second
operator|/
literal|910
operator|)
operator|%
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|mode
operator|==
name|MSP_MODE_FM_TERRA
operator|&&
name|msp
operator|->
expr|main
operator|!=
name|msp
operator|->
name|second
condition|)
block|{
name|printf
argument_list|(
literal|"bktr: msp3400: FM-stereo carrier : %d.%03d MHz\n"
argument_list|,
name|msp
operator|->
name|second
operator|/
literal|910000
argument_list|,
operator|(
name|msp
operator|->
name|second
operator|/
literal|910
operator|)
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|msp3400c_restore_dfp
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DFP_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|-
literal|1
operator|==
name|msp
operator|->
name|dfp_regs
index|[
name|i
index|]
condition|)
continue|continue;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
name|i
argument_list|,
name|msp
operator|->
name|dfp_regs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ----------------------------------------------------------------------- */
end_comment

begin_struct
struct|struct
name|REGISTER_DUMP
block|{
name|int
name|addr
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|REGISTER_DUMP
name|d1
index|[]
init|=
block|{
block|{
literal|0x007e
block|,
literal|"autodetect"
block|}
block|,
block|{
literal|0x0023
block|,
literal|"C_AD_BITS "
block|}
block|,
block|{
literal|0x0038
block|,
literal|"ADD_BITS  "
block|}
block|,
block|{
literal|0x003e
block|,
literal|"CIB_BITS  "
block|}
block|,
block|{
literal|0x0057
block|,
literal|"ERROR_RATE"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|autodetect_stereo
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|newstereo
init|=
name|msp
operator|->
name|stereo
decl_stmt|;
name|int
name|newnicam
init|=
name|msp
operator|->
name|nicam_on
decl_stmt|;
name|int
name|update
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|msp
operator|->
name|mode
condition|)
block|{
case|case
name|MSP_MODE_FM_TERRA
case|:
name|val
operator|=
name|msp3400c_read
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x18
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|32767
condition|)
name|val
operator|-=
literal|65536
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp34xx: stereo detect register: %d\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|4096
condition|)
block|{
name|newstereo
operator|=
name|VIDEO_SOUND_STEREO
operator||
name|VIDEO_SOUND_MONO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|val
operator|<
operator|-
literal|4096
condition|)
block|{
name|newstereo
operator|=
name|VIDEO_SOUND_LANG1
operator||
name|VIDEO_SOUND_LANG2
expr_stmt|;
block|}
else|else
block|{
name|newstereo
operator|=
name|VIDEO_SOUND_MONO
expr_stmt|;
block|}
name|newnicam
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|MSP_MODE_FM_NICAM1
case|:
case|case
name|MSP_MODE_FM_NICAM2
case|:
case|case
name|MSP_MODE_AM_NICAM
case|:
name|val
operator|=
name|msp3400c_read
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp34xx: nicam sync=%d, mode=%d\n"
argument_list|,
name|val
operator|&
literal|1
argument_list|,
operator|(
name|val
operator|&
literal|0x1e
operator|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
literal|1
condition|)
block|{
comment|/* nicam synced */
switch|switch
condition|(
operator|(
name|val
operator|&
literal|0x1e
operator|)
operator|>>
literal|1
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|8
case|:
name|newstereo
operator|=
name|VIDEO_SOUND_STEREO
expr_stmt|;
break|break;
case|case
literal|1
case|:
case|case
literal|9
case|:
name|newstereo
operator|=
name|VIDEO_SOUND_MONO
operator||
name|VIDEO_SOUND_LANG1
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|10
case|:
name|newstereo
operator|=
name|VIDEO_SOUND_MONO
operator||
name|VIDEO_SOUND_LANG1
operator||
name|VIDEO_SOUND_LANG2
expr_stmt|;
break|break;
default|default:
name|newstereo
operator|=
name|VIDEO_SOUND_MONO
expr_stmt|;
break|break;
block|}
name|newnicam
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|newnicam
operator|=
literal|0
expr_stmt|;
name|newstereo
operator|=
name|VIDEO_SOUND_MONO
expr_stmt|;
block|}
break|break;
case|case
name|MSP_MODE_BTSC
case|:
name|val
operator|=
name|msp3400c_read
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp3410: status=0x%x (pri=%s, sec=%s, %s%s%s)\n"
argument_list|,
name|val
argument_list|,
operator|(
name|val
operator|&
literal|0x0002
operator|)
condition|?
literal|"no"
else|:
literal|"yes"
argument_list|,
operator|(
name|val
operator|&
literal|0x0004
operator|)
condition|?
literal|"no"
else|:
literal|"yes"
argument_list|,
operator|(
name|val
operator|&
literal|0x0040
operator|)
condition|?
literal|"stereo"
else|:
literal|"mono"
argument_list|,
operator|(
name|val
operator|&
literal|0x0080
operator|)
condition|?
literal|", nicam 2nd mono"
else|:
literal|""
argument_list|,
operator|(
name|val
operator|&
literal|0x0100
operator|)
condition|?
literal|", bilingual/SAP"
else|:
literal|""
argument_list|)
expr_stmt|;
name|newstereo
operator|=
name|VIDEO_SOUND_MONO
expr_stmt|;
if|if
condition|(
name|val
operator|&
literal|0x0040
condition|)
name|newstereo
operator||=
name|VIDEO_SOUND_STEREO
expr_stmt|;
if|if
condition|(
name|val
operator|&
literal|0x0100
condition|)
name|newstereo
operator||=
name|VIDEO_SOUND_LANG1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|newstereo
operator|!=
name|msp
operator|->
name|stereo
condition|)
block|{
name|update
operator|=
literal|1
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp34xx: watch: stereo %d => %d\n"
argument_list|,
name|msp
operator|->
name|stereo
argument_list|,
name|newstereo
argument_list|)
expr_stmt|;
name|msp
operator|->
name|stereo
operator|=
name|newstereo
expr_stmt|;
block|}
if|if
condition|(
name|newnicam
operator|!=
name|msp
operator|->
name|nicam_on
condition|)
block|{
name|update
operator|=
literal|1
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp34xx: watch: nicam %d => %d\n"
argument_list|,
name|msp
operator|->
name|nicam_on
argument_list|,
name|newnicam
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
name|newnicam
expr_stmt|;
block|}
return|return
name|update
return|;
block|}
end_function

begin_comment
comment|/*  * A kernel thread for msp3400 control -- we don't want to block the  * in the ioctl while doing the sound carrier& stereo detect  */
end_comment

begin_comment
comment|/* stereo/multilang monitoring */
end_comment

begin_function
specifier|static
name|void
name|watch_stereo
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
if|if
condition|(
name|autodetect_stereo
argument_list|(
name|client
argument_list|)
condition|)
block|{
if|if
condition|(
name|msp
operator|->
name|stereo
operator|&
name|VIDEO_SOUND_STEREO
condition|)
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_STEREO
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|msp
operator|->
name|stereo
operator|&
name|VIDEO_SOUND_LANG1
condition|)
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_LANG1
argument_list|)
expr_stmt|;
else|else
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_MONO
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client
operator|->
name|stereo_once
condition|)
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|msp3400c_thread
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|bktr_ptr_t
name|client
init|=
name|data
decl_stmt|;
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|struct
name|CARRIER_DETECT
modifier|*
name|cd
decl_stmt|;
name|int
name|count
decl_stmt|,
name|max1
decl_stmt|,
name|max2
decl_stmt|,
name|val1
decl_stmt|,
name|val2
decl_stmt|,
name|val
decl_stmt|,
name|this
decl_stmt|;
name|dprintk
argument_list|(
literal|"msp3400: thread started\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|msp
operator|->
name|rmmod
condition|)
goto|goto
name|done
goto|;
name|tsleep
argument_list|(
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"idle"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|rmmod
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|msp
operator|->
name|halt_thread
condition|)
block|{
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|halt_thread
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|VIDEO_MODE_RADIO
operator|==
name|msp
operator|->
name|norm
operator|||
name|MSP_MODE_EXTERN
operator|==
name|msp
operator|->
name|mode
condition|)
continue|continue;
comment|/* nothing to do */
name|msp
operator|->
name|active
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|watch_stereo
condition|)
block|{
name|watch_stereo
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|msp
operator|->
name|active
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
comment|/* some time for the tuner to sync */
name|tsleep
argument_list|(
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"tuner sync"
argument_list|,
name|hz
operator|/
literal|2
argument_list|)
expr_stmt|;
name|restart
label|:
if|if
condition|(
name|VIDEO_MODE_RADIO
operator|==
name|msp
operator|->
name|norm
operator|||
name|MSP_MODE_EXTERN
operator|==
name|msp
operator|->
name|mode
condition|)
continue|continue;
comment|/* nothing to do */
name|msp
operator|->
name|restart
operator|=
literal|0
expr_stmt|;
name|msp3400c_setvolume
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|muted
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_AM_DETECT
comment|/* +1 */
argument_list|)
expr_stmt|;
name|val1
operator|=
name|val2
operator|=
literal|0
expr_stmt|;
name|max1
operator|=
name|max2
operator|=
operator|-
literal|1
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
comment|/* carrier detect pass #1 -- main carrier */
name|cd
operator|=
name|carrier_detect_main
expr_stmt|;
name|count
operator|=
name|CARRIER_COUNT
argument_list|(
name|carrier_detect_main
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|amsound
operator|&&
operator|(
name|msp
operator|->
name|norm
operator|==
name|VIDEO_MODE_SECAM
operator|)
condition|)
block|{
comment|/* autodetect doesn't work well with AM ... */
name|max1
operator|=
literal|3
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp3400: AM sound override\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|this
operator|=
literal|0
init|;
name|this
operator|<
name|count
condition|;
name|this
operator|++
control|)
block|{
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|cd
index|[
name|this
index|]
operator|.
name|cdo
argument_list|,
name|cd
index|[
name|this
index|]
operator|.
name|cdo
argument_list|)
expr_stmt|;
name|tsleep
argument_list|(
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"carrier detect"
argument_list|,
name|hz
operator|/
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|restart
condition|)
name|msp
operator|->
name|restart
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|msp3400c_read
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x1b
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|32767
condition|)
name|val
operator|-=
literal|65536
expr_stmt|;
if|if
condition|(
name|val1
operator|<
name|val
condition|)
name|val1
operator|=
name|val
operator|,
name|max1
operator|=
name|this
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp3400: carrier1 val: %5d / %s\n"
argument_list|,
name|val
argument_list|,
name|cd
index|[
name|this
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
comment|/* carrier detect pass #2 -- second (stereo) carrier */
switch|switch
condition|(
name|max1
condition|)
block|{
case|case
literal|1
case|:
comment|/* 5.5 */
name|cd
operator|=
name|carrier_detect_55
expr_stmt|;
name|count
operator|=
name|CARRIER_COUNT
argument_list|(
name|carrier_detect_55
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 6.5 */
name|cd
operator|=
name|carrier_detect_65
expr_stmt|;
name|count
operator|=
name|CARRIER_COUNT
argument_list|(
name|carrier_detect_65
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
comment|/* 4.5 */
case|case
literal|2
case|:
comment|/* 6.0 */
default|default:
name|cd
operator|=
name|NULL
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|client
operator|->
name|amsound
operator|&&
operator|(
name|msp
operator|->
name|norm
operator|==
name|VIDEO_MODE_SECAM
operator|)
condition|)
block|{
comment|/* autodetect doesn't work well with AM ... */
name|cd
operator|=
name|NULL
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|max2
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|this
operator|=
literal|0
init|;
name|this
operator|<
name|count
condition|;
name|this
operator|++
control|)
block|{
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|cd
index|[
name|this
index|]
operator|.
name|cdo
argument_list|,
name|cd
index|[
name|this
index|]
operator|.
name|cdo
argument_list|)
expr_stmt|;
name|tsleep
argument_list|(
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"carrier detection"
argument_list|,
name|hz
operator|/
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|restart
condition|)
goto|goto
name|restart
goto|;
name|val
operator|=
name|msp3400c_read
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x1b
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
literal|32767
condition|)
name|val
operator|-=
literal|65536
expr_stmt|;
if|if
condition|(
name|val2
operator|<
name|val
condition|)
name|val2
operator|=
name|val
operator|,
name|max2
operator|=
name|this
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp3400: carrier2 val: %5d / %s\n"
argument_list|,
name|val
argument_list|,
name|cd
index|[
name|this
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
comment|/* programm the msp3400 according to the results */
name|msp
operator|->
expr|main
operator|=
name|carrier_detect_main
index|[
name|max1
index|]
operator|.
name|cdo
expr_stmt|;
switch|switch
condition|(
name|max1
condition|)
block|{
case|case
literal|1
case|:
comment|/* 5.5 */
if|if
condition|(
name|max2
operator|==
literal|0
condition|)
block|{
comment|/* B/G FM-stereo */
name|msp
operator|->
name|second
operator|=
name|carrier_detect_55
index|[
name|max2
index|]
operator|.
name|cdo
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_FM_TERRA
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|0
expr_stmt|;
comment|/* XXX why mono? this probably can do stereo... - Alex*/
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_MONO
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|max2
operator|==
literal|1
operator|&&
name|msp
operator|->
name|nicam
condition|)
block|{
comment|/* B/G NICAM */
name|msp
operator|->
name|second
operator|=
name|carrier_detect_55
index|[
name|max2
index|]
operator|.
name|cdo
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_FM_NICAM1
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|1
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|second
argument_list|,
name|msp
operator|->
expr|main
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|no_second
goto|;
block|}
break|break;
case|case
literal|2
case|:
comment|/* 6.0 */
comment|/* PAL I NICAM */
name|msp
operator|->
name|second
operator|=
name|MSP_CARRIER
argument_list|(
literal|6.552
argument_list|)
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_FM_NICAM2
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|1
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|second
argument_list|,
name|msp
operator|->
expr|main
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 6.5 */
if|if
condition|(
name|max2
operator|==
literal|1
operator|||
name|max2
operator|==
literal|2
condition|)
block|{
comment|/* D/K FM-stereo */
name|msp
operator|->
name|second
operator|=
name|carrier_detect_65
index|[
name|max2
index|]
operator|.
name|cdo
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_FM_TERRA
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|0
expr_stmt|;
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_MONO
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|max2
operator|==
literal|0
operator|&&
name|msp
operator|->
name|norm
operator|==
name|VIDEO_MODE_SECAM
condition|)
block|{
comment|/* L NICAM or AM-mono */
name|msp
operator|->
name|second
operator|=
name|carrier_detect_65
index|[
name|max2
index|]
operator|.
name|cdo
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_AM_NICAM
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|0
expr_stmt|;
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_MONO
argument_list|)
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|second
argument_list|,
name|msp
operator|->
expr|main
argument_list|)
expr_stmt|;
comment|/* volume prescale for SCART (AM mono input) */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x000d
argument_list|,
literal|0x1900
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|max2
operator|==
literal|0
operator|&&
name|msp
operator|->
name|nicam
condition|)
block|{
comment|/* D/K NICAM */
name|msp
operator|->
name|second
operator|=
name|carrier_detect_65
index|[
name|max2
index|]
operator|.
name|cdo
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_FM_NICAM1
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|1
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|second
argument_list|,
name|msp
operator|->
expr|main
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|no_second
goto|;
block|}
break|break;
case|case
literal|0
case|:
comment|/* 4.5 */
default|default:
name|no_second
label|:
name|msp
operator|->
name|second
operator|=
name|carrier_detect_main
index|[
name|max1
index|]
operator|.
name|cdo
expr_stmt|;
name|msp3400c_setmode
argument_list|(
name|client
argument_list|,
name|MSP_MODE_FM_TERRA
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|0
expr_stmt|;
name|msp3400c_setcarrier
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|second
argument_list|,
name|msp
operator|->
expr|main
argument_list|)
expr_stmt|;
name|msp
operator|->
name|stereo
operator|=
name|VIDEO_SOUND_MONO
expr_stmt|;
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_MONO
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|msp
operator|->
name|watch_stereo
condition|)
name|watch_stereo
argument_list|(
name|client
argument_list|)
expr_stmt|;
comment|/* unmute + restore dfp registers */
name|msp3400c_setvolume
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|muted
argument_list|,
name|msp
operator|->
name|left
argument_list|,
name|msp
operator|->
name|right
argument_list|)
expr_stmt|;
name|msp3400c_restore_dfp
argument_list|(
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|msp3400c_print_mode
argument_list|(
name|msp
argument_list|)
expr_stmt|;
name|msp
operator|->
name|active
operator|=
literal|0
expr_stmt|;
block|}
name|done
label|:
name|dprintk
argument_list|(
literal|"msp3400: thread: exit\n"
argument_list|)
expr_stmt|;
name|msp
operator|->
name|active
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|kthread
operator|=
name|NULL
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|msp
operator|->
name|kthread
argument_list|)
expr_stmt|;
name|kthread_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ----------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* this one uses the automatic sound standard detection of newer           */
end_comment

begin_comment
comment|/* msp34xx chip versions                                                   */
end_comment

begin_struct
specifier|static
struct|struct
name|MODES
block|{
name|int
name|retval
decl_stmt|;
name|int
decl|main
decl_stmt|,
name|second
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|modelist
index|[]
init|=
block|{
block|{
literal|0x0000
block|,
literal|0
block|,
literal|0
block|,
literal|"ERROR"
block|}
block|,
block|{
literal|0x0001
block|,
literal|0
block|,
literal|0
block|,
literal|"autodetect start"
block|}
block|,
block|{
literal|0x0002
block|,
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|4.72
argument_list|)
block|,
literal|"4.5/4.72  M Dual FM-Stereo"
block|}
block|,
block|{
literal|0x0003
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.7421875
argument_list|)
block|,
literal|"5.5/5.74  B/G Dual FM-Stereo"
block|}
block|,
block|{
literal|0x0004
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.2578125
argument_list|)
block|,
literal|"6.5/6.25  D/K1 Dual FM-Stereo"
block|}
block|,
block|{
literal|0x0005
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.7421875
argument_list|)
block|,
literal|"6.5/6.74  D/K2 Dual FM-Stereo"
block|}
block|,
block|{
literal|0x0006
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
literal|"6.5  D/K FM-Mono (HDEV3)"
block|}
block|,
block|{
literal|0x0008
block|,
name|MSP_CARRIER
argument_list|(
literal|5.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.85
argument_list|)
block|,
literal|"5.5/5.85  B/G NICAM FM"
block|}
block|,
block|{
literal|0x0009
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.85
argument_list|)
block|,
literal|"6.5/5.85  L NICAM AM"
block|}
block|,
block|{
literal|0x000a
block|,
name|MSP_CARRIER
argument_list|(
literal|6.0
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.55
argument_list|)
block|,
literal|"6.0/6.55  I NICAM FM"
block|}
block|,
block|{
literal|0x000b
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.85
argument_list|)
block|,
literal|"6.5/5.85  D/K NICAM FM"
block|}
block|,
block|{
literal|0x000c
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|5.85
argument_list|)
block|,
literal|"6.5/5.85  D/K NICAM FM (HDEV2)"
block|}
block|,
block|{
literal|0x0020
block|,
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
literal|"4.5  M BTSC-Stereo"
block|}
block|,
block|{
literal|0x0021
block|,
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
literal|"4.5  M BTSC-Mono + SAP"
block|}
block|,
block|{
literal|0x0030
block|,
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|4.5
argument_list|)
block|,
literal|"4.5  M EIA-J Japan Stereo"
block|}
block|,
block|{
literal|0x0040
block|,
name|MSP_CARRIER
argument_list|(
literal|10.7
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|10.7
argument_list|)
block|,
literal|"10.7  FM-Stereo Radio"
block|}
block|,
block|{
literal|0x0050
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|6.5
argument_list|)
block|,
literal|"6.5  SAT-Mono"
block|}
block|,
block|{
literal|0x0051
block|,
name|MSP_CARRIER
argument_list|(
literal|7.02
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|7.20
argument_list|)
block|,
literal|"7.02/7.20  SAT-Stereo"
block|}
block|,
block|{
literal|0x0060
block|,
name|MSP_CARRIER
argument_list|(
literal|7.2
argument_list|)
block|,
name|MSP_CARRIER
argument_list|(
literal|7.2
argument_list|)
block|,
literal|"7.2  SAT ADR"
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|,
comment|/* EOF */
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|msp3410d_thread
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|bktr_ptr_t
name|client
init|=
name|data
decl_stmt|;
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|int
name|mode
decl_stmt|,
name|val
decl_stmt|,
name|i
decl_stmt|,
name|std
decl_stmt|;
name|int
name|timo
init|=
literal|0
decl_stmt|;
name|dprintk
argument_list|(
literal|"msp3410: thread started\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|msp
operator|->
name|rmmod
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
operator|!
name|msp
operator|->
name|watch_stereo
condition|)
name|timo
operator|=
literal|0
expr_stmt|;
else|else
name|timo
operator|=
literal|10
operator|*
name|hz
expr_stmt|;
name|tsleep
argument_list|(
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"idle"
argument_list|,
name|timo
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|rmmod
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|msp
operator|->
name|halt_thread
condition|)
block|{
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|halt_thread
operator|=
literal|0
expr_stmt|;
name|dprintk
argument_list|(
literal|"msp3410: thread halted\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|msp
operator|->
name|mode
operator|==
name|MSP_MODE_EXTERN
condition|)
continue|continue;
name|msp
operator|->
name|active
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|watch_stereo
condition|)
block|{
name|watch_stereo
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|msp
operator|->
name|active
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
comment|/* some time for the tuner to sync */
name|tsleep
argument_list|(
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"tuner sync"
argument_list|,
name|hz
operator|/
literal|2
argument_list|)
expr_stmt|;
name|restart
label|:
if|if
condition|(
name|msp
operator|->
name|mode
operator|==
name|MSP_MODE_EXTERN
condition|)
continue|continue;
name|msp
operator|->
name|restart
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
comment|/* put into sane state (and mute) */
name|msp3400c_reset
argument_list|(
name|client
argument_list|)
expr_stmt|;
comment|/* start autodetect */
switch|switch
condition|(
name|msp
operator|->
name|norm
condition|)
block|{
case|case
name|VIDEO_MODE_PAL
case|:
name|mode
operator|=
literal|0x1003
expr_stmt|;
name|std
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|VIDEO_MODE_NTSC
case|:
comment|/* BTSC */
name|mode
operator|=
literal|0x2003
expr_stmt|;
name|std
operator|=
literal|0x0020
expr_stmt|;
break|break;
case|case
name|VIDEO_MODE_SECAM
case|:
name|mode
operator|=
literal|0x0003
expr_stmt|;
name|std
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|VIDEO_MODE_RADIO
case|:
name|mode
operator|=
literal|0x0003
expr_stmt|;
name|std
operator|=
literal|0x0040
expr_stmt|;
break|break;
default|default:
name|mode
operator|=
literal|0x0003
expr_stmt|;
name|std
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x30
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x20
argument_list|,
name|std
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|modelist
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|modelist
index|[
name|i
index|]
operator|.
name|retval
operator|==
name|std
condition|)
break|break;
name|dprintk
argument_list|(
literal|"msp3410: setting mode: %s (0x%04x)\n"
argument_list|,
name|modelist
index|[
name|i
index|]
operator|.
name|name
condition|?
name|modelist
index|[
name|i
index|]
operator|.
name|name
else|:
literal|"unknown"
argument_list|,
name|std
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|std
operator|!=
literal|1
condition|)
block|{
comment|/* programmed some specific mode */
name|val
operator|=
name|std
expr_stmt|;
block|}
else|else
block|{
comment|/* triggered autodetect */
for|for
control|(
init|;
condition|;
control|)
block|{
name|tsleep
argument_list|(
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"autodetection"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|restart
condition|)
goto|goto
name|restart
goto|;
comment|/* check results */
name|val
operator|=
name|msp3400c_read
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x7e
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|0x07ff
condition|)
break|break;
name|dprintk
argument_list|(
literal|"msp3410: detection still in progress\n"
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|modelist
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|modelist
index|[
name|i
index|]
operator|.
name|retval
operator|==
name|val
condition|)
break|break;
name|dprintk
argument_list|(
literal|"msp3410: current mode: %s (0x%04x)\n"
argument_list|,
name|modelist
index|[
name|i
index|]
operator|.
name|name
condition|?
name|modelist
index|[
name|i
index|]
operator|.
name|name
else|:
literal|"unknown"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|msp
operator|->
expr|main
operator|=
name|modelist
index|[
name|i
index|]
operator|.
expr|main
expr_stmt|;
name|msp
operator|->
name|second
operator|=
name|modelist
index|[
name|i
index|]
operator|.
name|second
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|amsound
operator|&&
operator|(
name|msp
operator|->
name|norm
operator|==
name|VIDEO_MODE_SECAM
operator|)
operator|&&
operator|(
name|val
operator|!=
literal|0x0009
operator|)
condition|)
block|{
comment|/* autodetection has failed, let backup */
name|dprintk
argument_list|(
literal|"msp3410: autodetection failed, switching to backup mode: %s (0x%04x)\n"
argument_list|,
name|modelist
index|[
literal|8
index|]
operator|.
name|name
condition|?
name|modelist
index|[
literal|8
index|]
operator|.
name|name
else|:
literal|"unknown"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0x0009
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DEM
argument_list|,
literal|0x20
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* set various prescales */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0d
argument_list|,
literal|0x1900
argument_list|)
expr_stmt|;
comment|/* scart */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0e
argument_list|,
literal|0x2403
argument_list|)
expr_stmt|;
comment|/* FM */
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x10
argument_list|,
literal|0x5a00
argument_list|)
expr_stmt|;
comment|/* nicam */
comment|/* set stereo */
switch|switch
condition|(
name|val
condition|)
block|{
case|case
literal|0x0008
case|:
comment|/* B/G NICAM */
case|case
literal|0x000a
case|:
comment|/* I NICAM */
if|if
condition|(
name|val
operator|==
literal|0x0008
condition|)
name|msp
operator|->
name|mode
operator|=
name|MSP_MODE_FM_NICAM1
expr_stmt|;
else|else
name|msp
operator|->
name|mode
operator|=
name|MSP_MODE_FM_NICAM2
expr_stmt|;
comment|/* just turn on stereo */
name|msp
operator|->
name|stereo
operator|=
name|VIDEO_SOUND_STEREO
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|1
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_STEREO
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0009
case|:
name|msp
operator|->
name|mode
operator|=
name|MSP_MODE_AM_NICAM
expr_stmt|;
name|msp
operator|->
name|stereo
operator|=
name|VIDEO_SOUND_MONO
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|1
expr_stmt|;
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_MONO
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x0020
case|:
comment|/* BTSC */
comment|/* just turn on stereo */
name|msp
operator|->
name|mode
operator|=
name|MSP_MODE_BTSC
expr_stmt|;
name|msp
operator|->
name|stereo
operator|=
name|VIDEO_SOUND_STEREO
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_STEREO
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0040
case|:
comment|/* FM radio */
name|msp
operator|->
name|mode
operator|=
name|MSP_MODE_FM_RADIO
expr_stmt|;
name|msp
operator|->
name|stereo
operator|=
name|VIDEO_SOUND_STEREO
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
comment|/* scart routing */
name|msp3400c_set_scart
argument_list|(
name|client
argument_list|,
name|SCART_IN2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x08
argument_list|,
literal|0x0220
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x09
argument_list|,
literal|0x0220
argument_list|)
expr_stmt|;
name|msp3400c_write
argument_list|(
name|client
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x0b
argument_list|,
literal|0x0220
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0003
case|:
name|msp
operator|->
name|mode
operator|=
name|MSP_MODE_FM_TERRA
expr_stmt|;
name|msp
operator|->
name|stereo
operator|=
name|VIDEO_SOUND_STEREO
expr_stmt|;
name|msp
operator|->
name|nicam_on
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|1
expr_stmt|;
name|msp3400c_setstereo
argument_list|(
name|client
argument_list|,
name|VIDEO_SOUND_STEREO
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|msp
operator|->
name|watch_stereo
condition|)
name|watch_stereo
argument_list|(
name|client
argument_list|)
expr_stmt|;
comment|/* unmute + restore dfp registers */
name|msp3400c_setbass
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|bass
argument_list|)
expr_stmt|;
name|msp3400c_settreble
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|treble
argument_list|)
expr_stmt|;
name|msp3400c_setvolume
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|muted
argument_list|,
name|msp
operator|->
name|left
argument_list|,
name|msp
operator|->
name|right
argument_list|)
expr_stmt|;
name|msp3400c_restore_dfp
argument_list|(
name|client
argument_list|)
expr_stmt|;
name|msp
operator|->
name|active
operator|=
literal|0
expr_stmt|;
block|}
name|done
label|:
name|dprintk
argument_list|(
literal|"msp3410: thread: exit\n"
argument_list|)
expr_stmt|;
name|msp
operator|->
name|active
operator|=
literal|0
expr_stmt|;
name|msp
operator|->
name|kthread
operator|=
name|NULL
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|msp
operator|->
name|kthread
argument_list|)
expr_stmt|;
name|kthread_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|msp_attach
parameter_list|(
name|bktr_ptr_t
name|bktr
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
decl_stmt|;
name|int
name|rev1
decl_stmt|,
name|rev2
decl_stmt|,
name|i
decl_stmt|;
name|int
name|err
decl_stmt|;
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|msp
operator|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|msp3400c
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|bktr
operator|->
name|msp3400c_info
operator|=
name|msp
expr_stmt|;
name|memset
argument_list|(
name|msp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|msp3400c
argument_list|)
argument_list|)
expr_stmt|;
name|msp
operator|->
name|left
operator|=
literal|65535
expr_stmt|;
name|msp
operator|->
name|right
operator|=
literal|65535
expr_stmt|;
name|msp
operator|->
name|bass
operator|=
literal|32768
expr_stmt|;
name|msp
operator|->
name|treble
operator|=
literal|32768
expr_stmt|;
name|msp
operator|->
name|input
operator|=
operator|-
literal|1
expr_stmt|;
name|msp
operator|->
name|threaddesc
operator|=
name|malloc
argument_list|(
literal|15
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|threaddesc
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|msp
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|snprintf
argument_list|(
name|msp
operator|->
name|threaddesc
argument_list|,
literal|14
argument_list|,
literal|"%s_msp34xx_thread"
argument_list|,
name|bktr
operator|->
name|bktr_xname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DFP_COUNT
condition|;
name|i
operator|++
control|)
name|msp
operator|->
name|dfp_regs
index|[
name|i
index|]
operator|=
operator|-
literal|1
expr_stmt|;
name|msp3400c_reset
argument_list|(
name|bktr
argument_list|)
expr_stmt|;
name|rev1
operator|=
name|msp3400c_read
argument_list|(
name|bktr
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x1e
argument_list|)
expr_stmt|;
if|if
condition|(
operator|-
literal|1
operator|!=
name|rev1
condition|)
name|rev2
operator|=
name|msp3400c_read
argument_list|(
name|bktr
argument_list|,
name|I2C_MSP3400C_DFP
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|-
literal|1
operator|==
name|rev1
operator|)
operator|||
operator|(
literal|0
operator|==
name|rev1
operator|&&
literal|0
operator|==
name|rev2
operator|)
condition|)
block|{
name|free
argument_list|(
name|msp
operator|->
name|threaddesc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msp
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|bktr
operator|->
name|msp3400c_info
operator|=
name|NULL
expr_stmt|;
name|printf
argument_list|(
literal|"%s: msp3400: error while reading chip version\n"
argument_list|,
name|bktr_name
argument_list|(
name|bktr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|#
directive|if
literal|0
comment|/* this will turn on a 1kHz beep - might be useful for debugging... */
block|msp3400c_write(bktr,I2C_MSP3400C_DFP, 0x0014, 0x1040);
endif|#
directive|endif
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"MSP34%02d%c-%c%d"
argument_list|,
operator|(
name|rev2
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|rev1
operator|&
literal|0xff
operator|)
operator|+
literal|'@'
argument_list|,
operator|(
operator|(
name|rev1
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|+
literal|'@'
argument_list|,
name|rev2
operator|&
literal|0x1f
argument_list|)
expr_stmt|;
name|msp
operator|->
name|nicam
operator|=
operator|(
operator|(
operator|(
name|rev2
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
operator|!=
literal|00
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|bktr
operator|->
name|mspsimple
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* default mode */
comment|/* msp->simple = (((rev2>>8)&0xff) == 0) ? 0 : 1; */
name|msp
operator|->
name|simple
operator|=
operator|(
operator|(
name|rev1
operator|&
literal|0xff
operator|)
operator|+
literal|'@'
operator|>
literal|'C'
operator|)
expr_stmt|;
block|}
else|else
block|{
comment|/* use kenv value */
name|msp
operator|->
name|simple
operator|=
name|bktr
operator|->
name|mspsimple
expr_stmt|;
block|}
comment|/* hello world :-) */
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"%s: msp34xx: init: chip=%s"
argument_list|,
name|bktr_name
argument_list|(
name|bktr
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|nicam
condition|)
name|printf
argument_list|(
literal|", has NICAM support"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
comment|/* startup control thread */
name|err
operator|=
name|kthread_create
argument_list|(
name|msp
operator|->
name|simple
condition|?
name|msp3410d_thread
else|:
name|msp3400c_thread
argument_list|,
name|bktr
argument_list|,
operator|&
name|msp
operator|->
name|kthread
argument_list|,
operator|(
name|RFFDG
operator||
name|RFPROC
operator|)
argument_list|,
literal|0
argument_list|,
name|msp
operator|->
name|threaddesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Error returned by kthread_create: %d"
argument_list|,
name|bktr_name
argument_list|(
name|bktr
argument_list|)
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msp
operator|->
name|threaddesc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|msp
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|bktr
operator|->
name|msp3400c_info
operator|=
name|NULL
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|wakeup
argument_list|(
name|msp
operator|->
name|kthread
argument_list|)
expr_stmt|;
comment|/* done */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|msp_detach
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
comment|/* shutdown control thread */
if|if
condition|(
name|msp
operator|->
name|kthread
condition|)
block|{
comment|/* XXX mutex lock required */
name|msp
operator|->
name|rmmod
operator|=
literal|1
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
name|msp
operator|->
name|kthread
argument_list|)
expr_stmt|;
while|while
condition|(
name|msp
operator|->
name|kthread
condition|)
name|tsleep
argument_list|(
operator|&
name|msp
operator|->
name|kthread
argument_list|,
name|PRIBIO
argument_list|,
literal|"wait for kthread"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client
operator|->
name|msp3400c_info
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|client
operator|->
name|msp3400c_info
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|client
operator|->
name|msp3400c_info
operator|=
name|NULL
expr_stmt|;
block|}
name|msp3400c_reset
argument_list|(
name|client
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|msp_wake_thread
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|msp3400c_setvolume
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|muted
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|msp
operator|->
name|watch_stereo
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|active
condition|)
name|msp
operator|->
name|restart
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
name|msp
operator|->
name|kthread
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|msp_halt_thread
parameter_list|(
name|bktr_ptr_t
name|client
parameter_list|)
block|{
name|struct
name|msp3400c
modifier|*
name|msp
init|=
operator|(
expr|struct
name|msp3400c
operator|*
operator|)
name|client
operator|->
name|msp3400c_info
decl_stmt|;
name|msp3400c_setvolume
argument_list|(
name|client
argument_list|,
name|msp
operator|->
name|muted
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|active
condition|)
name|msp
operator|->
name|restart
operator|=
literal|1
expr_stmt|;
name|msp
operator|->
name|halt_thread
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
name|msp
operator|->
name|kthread
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* BKTR_NEW_MSP34XX_DRIVER */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_txp.c,v 1.48 2001/06/27 06:34:50 kjc Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2001  *	Jason L. Wright<jason@thought.net>, Theo de Raadt, and  *	Aaron Campbell<aaron@monkey.org>.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Jason L. Wright,  *	Theo de Raadt and Aaron Campbell.  * 4. Neither the name of the author nor the names of any co-contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL Bill Paul OR THE VOICES IN HIS HEAD  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Driver for 3c990 (Typhoon) Ethernet ASIC  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<machine/in_cksum.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_comment
comment|/* for vtophys */
end_comment

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_comment
comment|/* for vtophys */
end_comment

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_comment
comment|/* for DELAY */
end_comment

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_memio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_define
define|#
directive|define
name|TXP_USEIOSPACE
end_define

begin_define
define|#
directive|define
name|__STRICT_ALIGNMENT
end_define

begin_include
include|#
directive|include
file|<dev/txp/if_txpreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/txp/3c990img.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Various supported device vendors/types and their names.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|txp_type
name|txp_devs
index|[]
init|=
block|{
block|{
name|TXP_VENDORID_3COM
block|,
name|TXP_DEVICEID_3CR990_TX_95
block|,
literal|"3Com 3cR990-TX-95 Etherlink with 3XP Processor"
block|}
block|,
block|{
name|TXP_VENDORID_3COM
block|,
name|TXP_DEVICEID_3CR990_TX_97
block|,
literal|"3Com 3cR990-TX-97 Etherlink with 3XP Processor"
block|}
block|,
block|{
name|TXP_VENDORID_3COM
block|,
name|TXP_DEVICEID_3CR990B_TXM
block|,
literal|"3Com 3cR990B-TXM Etherlink with 3XP Processor"
block|}
block|,
block|{
name|TXP_VENDORID_3COM
block|,
name|TXP_DEVICEID_3CR990_SRV_95
block|,
literal|"3Com 3cR990-SRV-95 Etherlink Server with 3XP Processor"
block|}
block|,
block|{
name|TXP_VENDORID_3COM
block|,
name|TXP_DEVICEID_3CR990_SRV_97
block|,
literal|"3Com 3cR990-SRV-97 Etherlink Server with 3XP Processor"
block|}
block|,
block|{
name|TXP_VENDORID_3COM
block|,
name|TXP_DEVICEID_3CR990B_SRV
block|,
literal|"3Com 3cR990B-SRV Etherlink Server with 3XP Processor"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|txp_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_tick
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_stop
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_release_resources
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_chip_init
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_reset_adapter
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_download_fw
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_download_fw_wait
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_download_fw_section
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|,
name|struct
name|txp_fw_section_header
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_alloc_rings
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_rxring_fill
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_rxring_empty
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_set_filter
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_cmd_desc_numfree
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_command
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int32_t
modifier|*
parameter_list|,
name|u_int32_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_command2
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|struct
name|txp_ext_desc
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|struct
name|txp_rsp_desc
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_response
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|txp_rsp_desc
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_rsp_fixup
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|,
name|struct
name|txp_rsp_desc
modifier|*
parameter_list|,
name|struct
name|txp_rsp_desc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_capabilities
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|txp_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|TXP_DEBUG
end_ifdef

begin_function_decl
specifier|static
name|void
name|txp_show_descriptor
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|txp_tx_reclaim
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|,
name|struct
name|txp_tx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_rxbuf_reclaim
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|txp_rx_reclaim
parameter_list|(
name|struct
name|txp_softc
modifier|*
parameter_list|,
name|struct
name|txp_rx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|TXP_USEIOSPACE
end_ifdef

begin_define
define|#
directive|define
name|TXP_RES
value|SYS_RES_IOPORT
end_define

begin_define
define|#
directive|define
name|TXP_RID
value|TXP_PCI_LOIO
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|TXP_RES
value|SYS_RES_MEMORY
end_define

begin_define
define|#
directive|define
name|TXP_RID
value|TXP_PCI_LOMEM
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|device_method_t
name|txp_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|txp_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|txp_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|txp_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|txp_shutdown
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|txp_driver
init|=
block|{
literal|"txp"
block|,
name|txp_methods
block|,
expr|sizeof
operator|(
expr|struct
name|txp_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|txp_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|txp
argument_list|,
name|pci
argument_list|,
name|txp_driver
argument_list|,
name|txp_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|txp
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|txp
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|txp_probe
parameter_list|(
name|dev
parameter_list|)
name|device_t
name|dev
decl_stmt|;
block|{
name|struct
name|txp_type
modifier|*
name|t
decl_stmt|;
name|t
operator|=
name|txp_devs
expr_stmt|;
while|while
condition|(
name|t
operator|->
name|txp_name
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
name|t
operator|->
name|txp_vid
operator|)
operator|&&
operator|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|t
operator|->
name|txp_did
operator|)
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|t
operator|->
name|txp_name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|t
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_attach
parameter_list|(
name|dev
parameter_list|)
name|device_t
name|dev
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_int16_t
name|p1
decl_stmt|;
name|u_int32_t
name|p2
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|rid
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_cold
operator|=
literal|1
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
operator||
name|MTX_RECURSE
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|BURN_BRIDGES
comment|/* 	 * Handle power management nonsense. 	 */
if|if
condition|(
name|pci_get_powerstate
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCI_POWERSTATE_D0
condition|)
block|{
name|u_int32_t
name|iobase
decl_stmt|,
name|membase
decl_stmt|,
name|irq
decl_stmt|;
comment|/* Save important PCI config data. */
name|iobase
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|TXP_PCI_LOIO
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|membase
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|TXP_PCI_LOMEM
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|irq
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|TXP_PCI_INTLINE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Reset the power state. */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"chip is in D%d power mode "
literal|"-- setting to D0\n"
argument_list|,
name|pci_get_powerstate
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|pci_set_powerstate
argument_list|(
name|dev
argument_list|,
name|PCI_POWERSTATE_D0
argument_list|)
expr_stmt|;
comment|/* Restore PCI config data. */
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|TXP_PCI_LOIO
argument_list|,
name|iobase
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|TXP_PCI_LOMEM
argument_list|,
name|membase
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|TXP_PCI_INTLINE
argument_list|,
name|irq
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 	 * Map control/status registers. 	 */
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|rid
operator|=
name|TXP_RID
expr_stmt|;
name|sc
operator|->
name|sc_res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|TXP_RES
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"couldn't map ports/memory\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|sc_bt
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|sc_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|sc_res
argument_list|)
expr_stmt|;
comment|/* Allocate interrupt */
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_irq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"couldn't map interrupt\n"
argument_list|)
expr_stmt|;
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|txp_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_intrhand
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"couldn't set up irq\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|txp_chip_init
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|sc_fwbuf
operator|=
name|contigmalloc
argument_list|(
literal|32768
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0
argument_list|,
literal|0xffffffff
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|txp_download_fw
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|contigfree
argument_list|(
name|sc
operator|->
name|sc_fwbuf
argument_list|,
literal|32768
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_fwbuf
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|sc_ldata
operator|=
name|contigmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|txp_ldata
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0
argument_list|,
literal|0xffffffff
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sc
operator|->
name|sc_ldata
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|txp_ldata
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|txp_alloc_rings
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_MAX_PKT_SIZE_WRITE
argument_list|,
name|TXP_MAX_PKTLEN
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_STATION_ADDRESS_READ
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|p1
argument_list|,
operator|&
name|p2
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|txp_set_filter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p1
operator|)
index|[
literal|1
index|]
expr_stmt|;
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p1
operator|)
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|3
index|]
expr_stmt|;
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|3
index|]
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|2
index|]
expr_stmt|;
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|4
index|]
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|1
index|]
expr_stmt|;
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|5
index|]
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|0
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"txp%d: Ethernet address %6D\n"
argument_list|,
name|unit
argument_list|,
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cold
operator|=
literal|0
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
literal|0
argument_list|,
name|txp_ifmedia_upd
argument_list|,
name|txp_ifmedia_sts
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10_T
operator||
name|IFM_HDX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_10_T
operator||
name|IFM_FDX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100_TX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100_TX
operator||
name|IFM_HDX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_100_TX
operator||
name|IFM_FDX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_xcvr
operator|=
name|TXP_XCVR_AUTO
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_XCVR_SELECT
argument_list|,
name|TXP_XCVR_AUTO
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_unit
operator|=
name|unit
expr_stmt|;
name|ifp
operator|->
name|if_name
operator|=
literal|"txp"
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|txp_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_output
operator|=
name|ether_output
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|txp_start
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|txp_watchdog
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|txp_init
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
literal|100000000
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|TX_ENTRIES
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
name|txp_capabilities
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * Attach us everywhere 	 */
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
argument_list|)
expr_stmt|;
name|callout_handle_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_detach
parameter_list|(
name|dev
parameter_list|)
name|device_t
name|dev
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
expr_stmt|;
name|txp_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|txp_shutdown
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifmedia_removeall
argument_list|(
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RXBUF_ENTRIES
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_sd
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|txp_release_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_release_resources
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|sc_dev
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_intrhand
operator|!=
name|NULL
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|,
name|sc
operator|->
name|sc_intrhand
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_irq
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|TXP_RES
argument_list|,
name|TXP_RID
argument_list|,
name|sc
operator|->
name|sc_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ldata
operator|!=
name|NULL
condition|)
name|contigfree
argument_list|(
name|sc
operator|->
name|sc_ldata
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|txp_ldata
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_chip_init
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
comment|/* disable interrupts */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|TXP_INT_SELF
operator||
name|TXP_INT_PCI_TABORT
operator||
name|TXP_INT_PCI_MABORT
operator||
name|TXP_INT_DMA3
operator||
name|TXP_INT_DMA2
operator||
name|TXP_INT_DMA1
operator||
name|TXP_INT_DMA0
operator||
name|TXP_INT_LATCH
argument_list|)
expr_stmt|;
comment|/* ack all interrupts */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|,
name|TXP_INT_RESERVED
operator||
name|TXP_INT_LATCH
operator||
name|TXP_INT_A2H_7
operator||
name|TXP_INT_A2H_6
operator||
name|TXP_INT_A2H_5
operator||
name|TXP_INT_A2H_4
operator||
name|TXP_INT_SELF
operator||
name|TXP_INT_PCI_TABORT
operator||
name|TXP_INT_PCI_MABORT
operator||
name|TXP_INT_DMA3
operator||
name|TXP_INT_DMA2
operator||
name|TXP_INT_DMA1
operator||
name|TXP_INT_DMA0
operator||
name|TXP_INT_A2H_3
operator||
name|TXP_INT_A2H_2
operator||
name|TXP_INT_A2H_1
operator||
name|TXP_INT_A2H_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|txp_reset_adapter
argument_list|(
name|sc
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* disable interrupts */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|TXP_INT_SELF
operator||
name|TXP_INT_PCI_TABORT
operator||
name|TXP_INT_PCI_MABORT
operator||
name|TXP_INT_DMA3
operator||
name|TXP_INT_DMA2
operator||
name|TXP_INT_DMA1
operator||
name|TXP_INT_DMA0
operator||
name|TXP_INT_LATCH
argument_list|)
expr_stmt|;
comment|/* ack all interrupts */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|,
name|TXP_INT_RESERVED
operator||
name|TXP_INT_LATCH
operator||
name|TXP_INT_A2H_7
operator||
name|TXP_INT_A2H_6
operator||
name|TXP_INT_A2H_5
operator||
name|TXP_INT_A2H_4
operator||
name|TXP_INT_SELF
operator||
name|TXP_INT_PCI_TABORT
operator||
name|TXP_INT_PCI_MABORT
operator||
name|TXP_INT_DMA3
operator||
name|TXP_INT_DMA2
operator||
name|TXP_INT_DMA1
operator||
name|TXP_INT_DMA0
operator||
name|TXP_INT_A2H_3
operator||
name|TXP_INT_A2H_2
operator||
name|TXP_INT_A2H_1
operator||
name|TXP_INT_A2H_0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_reset_adapter
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int32_t
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_SRR
argument_list|,
name|TXP_SRR_ALL
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_SRR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Should wait max 6 seconds */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6000
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_A2H_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|STAT_WAITING_FOR_HOST_REQUEST
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
name|STAT_WAITING_FOR_HOST_REQUEST
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"reset hung\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_download_fw
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|txp_fw_file_header
modifier|*
name|fileheader
decl_stmt|;
name|struct
name|txp_fw_section_header
modifier|*
name|secthead
decl_stmt|;
name|int
name|sect
decl_stmt|;
name|u_int32_t
name|r
decl_stmt|,
name|i
decl_stmt|,
name|ier
decl_stmt|,
name|imr
decl_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
name|ier
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IER
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IER
argument_list|,
name|ier
operator||
name|TXP_INT_A2H_0
argument_list|)
expr_stmt|;
name|imr
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|imr
operator||
name|TXP_INT_A2H_0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10000
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_A2H_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|STAT_WAITING_FOR_HOST_REQUEST
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
name|STAT_WAITING_FOR_HOST_REQUEST
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"not waiting for host request\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Ack the status */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|,
name|TXP_INT_A2H_0
argument_list|)
expr_stmt|;
name|fileheader
operator|=
operator|(
expr|struct
name|txp_fw_file_header
operator|*
operator|)
name|tc990image
expr_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
literal|"TYPHOON"
argument_list|,
name|fileheader
operator|->
name|magicid
argument_list|,
sizeof|sizeof
argument_list|(
name|fileheader
operator|->
name|magicid
argument_list|)
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw invalid magic\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Tell boot firmware to get ready for image */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_1
argument_list|,
name|fileheader
operator|->
name|addr
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_0
argument_list|,
name|TXP_BOOTCMD_RUNTIME_IMAGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|txp_download_fw_wait
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw wait failed, initial\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|secthead
operator|=
operator|(
expr|struct
name|txp_fw_section_header
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|tc990image
operator|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|txp_fw_file_header
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|sect
operator|=
literal|0
init|;
name|sect
operator|<
name|fileheader
operator|->
name|nsections
condition|;
name|sect
operator|++
control|)
block|{
if|if
condition|(
name|txp_download_fw_section
argument_list|(
name|sc
argument_list|,
name|secthead
argument_list|,
name|sect
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|secthead
operator|=
operator|(
expr|struct
name|txp_fw_section_header
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|secthead
operator|)
operator|+
name|secthead
operator|->
name|nbytes
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|secthead
argument_list|)
operator|)
expr_stmt|;
block|}
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_0
argument_list|,
name|TXP_BOOTCMD_DOWNLOAD_COMPLETE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10000
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_A2H_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|STAT_WAITING_FOR_BOOT
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
name|STAT_WAITING_FOR_BOOT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"not waiting for boot\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IER
argument_list|,
name|ier
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|imr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_download_fw_wait
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int32_t
name|i
decl_stmt|,
name|r
decl_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10000
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|TXP_INT_A2H_0
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|r
operator|&
name|TXP_INT_A2H_0
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw wait failed comm0\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|,
name|TXP_INT_A2H_0
argument_list|)
expr_stmt|;
name|r
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_A2H_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|!=
name|STAT_WAITING_FOR_SEGMENT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw not waiting for segment\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_download_fw_section
parameter_list|(
name|sc
parameter_list|,
name|sect
parameter_list|,
name|sectnum
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|txp_fw_section_header
modifier|*
name|sect
decl_stmt|;
name|int
name|sectnum
decl_stmt|;
block|{
name|vm_offset_t
name|dma
decl_stmt|;
name|int
name|rseg
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|struct
name|mbuf
name|m
decl_stmt|;
name|u_int16_t
name|csum
decl_stmt|;
comment|/* Skip zero length sections */
if|if
condition|(
name|sect
operator|->
name|nbytes
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Make sure we aren't past the end of the image */
name|rseg
operator|=
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sect
operator|)
operator|-
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|tc990image
operator|)
expr_stmt|;
if|if
condition|(
name|rseg
operator|>=
sizeof|sizeof
argument_list|(
name|tc990image
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw invalid section address, "
literal|"section %d\n"
argument_list|,
name|sectnum
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Make sure this section doesn't go past the end */
name|rseg
operator|+=
name|sect
operator|->
name|nbytes
expr_stmt|;
if|if
condition|(
name|rseg
operator|>=
sizeof|sizeof
argument_list|(
name|tc990image
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw truncated section %d\n"
argument_list|,
name|sectnum
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bcopy
argument_list|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sect
operator|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|sect
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_fwbuf
argument_list|,
name|sect
operator|->
name|nbytes
argument_list|)
expr_stmt|;
name|dma
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|sc_fwbuf
argument_list|)
expr_stmt|;
comment|/* 	 * dummy up mbuf and verify section checksum 	 */
name|m
operator|.
name|m_type
operator|=
name|MT_DATA
expr_stmt|;
name|m
operator|.
name|m_next
operator|=
name|m
operator|.
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
name|m
operator|.
name|m_len
operator|=
name|sect
operator|->
name|nbytes
expr_stmt|;
name|m
operator|.
name|m_data
operator|=
name|sc
operator|->
name|sc_fwbuf
expr_stmt|;
name|m
operator|.
name|m_flags
operator|=
literal|0
expr_stmt|;
name|csum
operator|=
name|in_cksum
argument_list|(
operator|&
name|m
argument_list|,
name|sect
operator|->
name|nbytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|csum
operator|!=
name|sect
operator|->
name|cksum
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw section %d, bad "
literal|"cksum (expected 0x%x got 0x%x)\n"
argument_list|,
name|sectnum
argument_list|,
name|sect
operator|->
name|cksum
argument_list|,
name|csum
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_1
argument_list|,
name|sect
operator|->
name|nbytes
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_2
argument_list|,
name|sect
operator|->
name|cksum
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_3
argument_list|,
name|sect
operator|->
name|addr
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_5
argument_list|,
name|dma
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_0
argument_list|,
name|TXP_BOOTCMD_SEGMENT_AVAILABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|txp_download_fw_wait
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw wait failed, "
literal|"section %d\n"
argument_list|,
name|sectnum
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|bail
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_intr
parameter_list|(
name|vsc
parameter_list|)
name|void
modifier|*
name|vsc
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
init|=
name|vsc
decl_stmt|;
name|struct
name|txp_hostvar
modifier|*
name|hv
init|=
name|sc
operator|->
name|sc_hostvar
decl_stmt|;
name|u_int32_t
name|isr
decl_stmt|;
comment|/* mask all interrupts */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|TXP_INT_RESERVED
operator||
name|TXP_INT_SELF
operator||
name|TXP_INT_A2H_7
operator||
name|TXP_INT_A2H_6
operator||
name|TXP_INT_A2H_5
operator||
name|TXP_INT_A2H_4
operator||
name|TXP_INT_A2H_2
operator||
name|TXP_INT_A2H_1
operator||
name|TXP_INT_A2H_0
operator||
name|TXP_INT_DMA3
operator||
name|TXP_INT_DMA2
operator||
name|TXP_INT_DMA1
operator||
name|TXP_INT_DMA0
operator||
name|TXP_INT_PCI_TABORT
operator||
name|TXP_INT_PCI_MABORT
operator||
name|TXP_INT_LATCH
argument_list|)
expr_stmt|;
name|isr
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|)
expr_stmt|;
while|while
condition|(
name|isr
condition|)
block|{
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|,
name|isr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|sc
operator|->
name|sc_rxhir
operator|.
name|r_roff
operator|)
operator|!=
operator|(
operator|*
name|sc
operator|->
name|sc_rxhir
operator|.
name|r_woff
operator|)
condition|)
name|txp_rx_reclaim
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxhir
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|sc
operator|->
name|sc_rxlor
operator|.
name|r_roff
operator|)
operator|!=
operator|(
operator|*
name|sc
operator|->
name|sc_rxlor
operator|.
name|r_woff
operator|)
condition|)
name|txp_rx_reclaim
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxlor
argument_list|)
expr_stmt|;
if|if
condition|(
name|hv
operator|->
name|hv_rx_buf_write_idx
operator|==
name|hv
operator|->
name|hv_rx_buf_read_idx
condition|)
name|txp_rxbuf_reclaim
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txhir
operator|.
name|r_cnt
operator|&&
operator|(
name|sc
operator|->
name|sc_txhir
operator|.
name|r_cons
operator|!=
name|TXP_OFFSET2IDX
argument_list|(
operator|*
operator|(
name|sc
operator|->
name|sc_txhir
operator|.
name|r_off
operator|)
argument_list|)
operator|)
condition|)
name|txp_tx_reclaim
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_txhir
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_txlor
operator|.
name|r_cnt
operator|&&
operator|(
name|sc
operator|->
name|sc_txlor
operator|.
name|r_cons
operator|!=
name|TXP_OFFSET2IDX
argument_list|(
operator|*
operator|(
name|sc
operator|->
name|sc_txlor
operator|.
name|r_off
operator|)
argument_list|)
operator|)
condition|)
name|txp_tx_reclaim
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_txlor
argument_list|)
expr_stmt|;
name|isr
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_ISR
argument_list|)
expr_stmt|;
block|}
comment|/* unmask all interrupts */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|TXP_INT_A2H_3
argument_list|)
expr_stmt|;
name|txp_start
argument_list|(
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_rx_reclaim
parameter_list|(
name|sc
parameter_list|,
name|r
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|txp_rx_ring
modifier|*
name|r
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
decl_stmt|;
name|struct
name|txp_rx_desc
modifier|*
name|rxd
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|txp_swdesc
modifier|*
name|sd
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|roff
decl_stmt|,
name|woff
decl_stmt|;
name|roff
operator|=
operator|*
name|r
operator|->
name|r_roff
expr_stmt|;
name|woff
operator|=
operator|*
name|r
operator|->
name|r_woff
expr_stmt|;
name|rxd
operator|=
name|r
operator|->
name|r_desc
operator|+
operator|(
name|roff
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rx_desc
argument_list|)
operator|)
expr_stmt|;
while|while
condition|(
name|roff
operator|!=
name|woff
condition|)
block|{
if|if
condition|(
name|rxd
operator|->
name|rx_flags
operator|&
name|RX_FLAGS_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"error 0x%x\n"
argument_list|,
name|rxd
operator|->
name|rx_stat
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|next
goto|;
block|}
comment|/* retrieve stashed pointer */
name|sd
operator|=
name|rxd
operator|->
name|rx_sd
expr_stmt|;
name|m
operator|=
name|sd
operator|->
name|sd_mbuf
expr_stmt|;
name|sd
operator|->
name|sd_mbuf
operator|=
name|NULL
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|rxd
operator|->
name|rx_len
expr_stmt|;
ifdef|#
directive|ifdef
name|__STRICT_ALIGNMENT
block|{
comment|/* 			 * XXX Nice chip, except it won't accept "off by 2" 			 * buffers, so we're force to copy.  Supposedly 			 * this will be fixed in a newer firmware rev 			 * and this will be temporary. 			 */
name|struct
name|mbuf
modifier|*
name|mnew
decl_stmt|;
name|MGETHDR
argument_list|(
name|mnew
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|mnew
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
if|if
condition|(
name|m
operator|->
name|m_len
operator|>
operator|(
name|MHLEN
operator|-
literal|2
operator|)
condition|)
block|{
name|MCLGET
argument_list|(
name|mnew
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mnew
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|mnew
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|next
goto|;
block|}
block|}
name|mnew
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m_adj
argument_list|(
name|mnew
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|mnew
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|mnew
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
name|m_copydata
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|mtod
argument_list|(
name|mnew
argument_list|,
name|caddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|m
operator|=
name|mnew
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|rxd
operator|->
name|rx_stat
operator|&
name|RX_STAT_IPCKSUMBAD
condition|)
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
expr_stmt|;
elseif|else
if|if
condition|(
name|rxd
operator|->
name|rx_stat
operator|&
name|RX_STAT_IPCKSUMGOOD
condition|)
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
expr_stmt|;
if|if
condition|(
operator|(
name|rxd
operator|->
name|rx_stat
operator|&
name|RX_STAT_TCPCKSUMGOOD
operator|)
operator|||
operator|(
name|rxd
operator|->
name|rx_stat
operator|&
name|RX_STAT_UDPCKSUMGOOD
operator|)
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xffff
expr_stmt|;
block|}
if|if
condition|(
name|rxd
operator|->
name|rx_stat
operator|&
name|RX_STAT_VLAN
condition|)
block|{
name|VLAN_INPUT_TAG
argument_list|(
argument|ifp
argument_list|,
argument|m
argument_list|,
argument|htons(rxd->rx_vlan>>
literal|16
argument|)
argument_list|,
argument|goto next
argument_list|)
empty_stmt|;
block|}
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|next
label|:
name|roff
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rx_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|roff
operator|==
operator|(
name|RX_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rx_desc
argument_list|)
operator|)
condition|)
block|{
name|roff
operator|=
literal|0
expr_stmt|;
name|rxd
operator|=
name|r
operator|->
name|r_desc
expr_stmt|;
block|}
else|else
name|rxd
operator|++
expr_stmt|;
name|woff
operator|=
operator|*
name|r
operator|->
name|r_woff
expr_stmt|;
block|}
operator|*
name|r
operator|->
name|r_roff
operator|=
name|woff
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_rxbuf_reclaim
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
decl_stmt|;
name|struct
name|txp_hostvar
modifier|*
name|hv
init|=
name|sc
operator|->
name|sc_hostvar
decl_stmt|;
name|struct
name|txp_rxbuf_desc
modifier|*
name|rbd
decl_stmt|;
name|struct
name|txp_swdesc
modifier|*
name|sd
decl_stmt|;
name|u_int32_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
condition|)
return|return;
name|i
operator|=
name|sc
operator|->
name|sc_rxbufprod
expr_stmt|;
name|rbd
operator|=
name|sc
operator|->
name|sc_rxbufs
operator|+
name|i
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|sd
operator|=
name|rbd
operator|->
name|rb_sd
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_mbuf
operator|!=
name|NULL
condition|)
break|break;
name|MGETHDR
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_mbuf
operator|==
name|NULL
condition|)
goto|goto
name|err_sd
goto|;
name|MCLGET
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
operator|==
literal|0
condition|)
goto|goto
name|err_mbuf
goto|;
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_len
operator|=
name|MCLBYTES
expr_stmt|;
name|rbd
operator|->
name|rb_paddrlo
operator|=
name|vtophys
argument_list|(
name|mtod
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
operator|&
literal|0xffffffff
expr_stmt|;
name|rbd
operator|->
name|rb_paddrhi
operator|=
literal|0
expr_stmt|;
name|hv
operator|->
name|hv_rx_buf_write_idx
operator|=
name|TXP_IDX2OFFSET
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|i
operator|==
name|RXBUF_ENTRIES
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
name|rbd
operator|=
name|sc
operator|->
name|sc_rxbufs
expr_stmt|;
block|}
else|else
name|rbd
operator|++
expr_stmt|;
block|}
name|sc
operator|->
name|sc_rxbufprod
operator|=
name|i
expr_stmt|;
return|return;
name|err_mbuf
label|:
name|m_freem
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|)
expr_stmt|;
name|err_sd
label|:
name|free
argument_list|(
name|sd
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reclaim mbufs and entries from a transmit ring.  */
end_comment

begin_function
specifier|static
name|void
name|txp_tx_reclaim
parameter_list|(
name|sc
parameter_list|,
name|r
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|txp_tx_ring
modifier|*
name|r
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
decl_stmt|;
name|u_int32_t
name|idx
init|=
name|TXP_OFFSET2IDX
argument_list|(
operator|*
operator|(
name|r
operator|->
name|r_off
operator|)
argument_list|)
decl_stmt|;
name|u_int32_t
name|cons
init|=
name|r
operator|->
name|r_cons
decl_stmt|,
name|cnt
init|=
name|r
operator|->
name|r_cnt
decl_stmt|;
name|struct
name|txp_tx_desc
modifier|*
name|txd
init|=
name|r
operator|->
name|r_desc
operator|+
name|cons
decl_stmt|;
name|struct
name|txp_swdesc
modifier|*
name|sd
init|=
name|sc
operator|->
name|sc_txd
operator|+
name|cons
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
while|while
condition|(
name|cons
operator|!=
name|idx
condition|)
block|{
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|txd
operator|->
name|tx_flags
operator|&
name|TX_FLAGS_TYPE_M
operator|)
operator|==
name|TX_FLAGS_TYPE_DATA
condition|)
block|{
name|m
operator|=
name|sd
operator|->
name|sd_mbuf
expr_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|txd
operator|->
name|tx_addrlo
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|tx_addrhi
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
block|}
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
if|if
condition|(
operator|++
name|cons
operator|==
name|TX_ENTRIES
condition|)
block|{
name|txd
operator|=
name|r
operator|->
name|r_desc
expr_stmt|;
name|cons
operator|=
literal|0
expr_stmt|;
name|sd
operator|=
name|sc
operator|->
name|sc_txd
expr_stmt|;
block|}
else|else
block|{
name|txd
operator|++
expr_stmt|;
name|sd
operator|++
expr_stmt|;
block|}
name|cnt
operator|--
expr_stmt|;
block|}
name|r
operator|->
name|r_cons
operator|=
name|cons
expr_stmt|;
name|r
operator|->
name|r_cnt
operator|=
name|cnt
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_shutdown
parameter_list|(
name|dev
parameter_list|)
name|device_t
name|dev
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* mask all interrupts */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|TXP_INT_SELF
operator||
name|TXP_INT_PCI_TABORT
operator||
name|TXP_INT_PCI_MABORT
operator||
name|TXP_INT_DMA3
operator||
name|TXP_INT_DMA2
operator||
name|TXP_INT_DMA1
operator||
name|TXP_INT_DMA0
operator||
name|TXP_INT_LATCH
argument_list|)
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_TX_DISABLE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_RX_DISABLE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_HALT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_alloc_rings
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|txp_boot_record
modifier|*
name|boot
decl_stmt|;
name|struct
name|txp_ldata
modifier|*
name|ld
decl_stmt|;
name|u_int32_t
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
name|ld
operator|=
name|sc
operator|->
name|sc_ldata
expr_stmt|;
name|boot
operator|=
operator|&
name|ld
operator|->
name|txp_boot
expr_stmt|;
comment|/* boot record */
name|sc
operator|->
name|sc_boot
operator|=
name|boot
expr_stmt|;
comment|/* host variables */
name|bzero
argument_list|(
operator|&
name|ld
operator|->
name|txp_hostvar
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|txp_hostvar
argument_list|)
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_hostvar_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_hostvar
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_hostvar_hi
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_hostvar
operator|=
operator|(
expr|struct
name|txp_hostvar
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_hostvar
expr_stmt|;
comment|/* hi priority tx ring */
name|boot
operator|->
name|br_txhipri_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_txhiring
argument_list|)
expr_stmt|;
empty_stmt|;
name|boot
operator|->
name|br_txhipri_hi
operator|=
literal|0
expr_stmt|;
name|boot
operator|->
name|br_txhipri_siz
operator|=
name|TX_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_tx_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txhir
operator|.
name|r_reg
operator|=
name|TXP_H2A_1
expr_stmt|;
name|sc
operator|->
name|sc_txhir
operator|.
name|r_desc
operator|=
operator|(
expr|struct
name|txp_tx_desc
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_txhiring
expr_stmt|;
name|sc
operator|->
name|sc_txhir
operator|.
name|r_cons
operator|=
name|sc
operator|->
name|sc_txhir
operator|.
name|r_prod
operator|=
name|sc
operator|->
name|sc_txhir
operator|.
name|r_cnt
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_txhir
operator|.
name|r_off
operator|=
operator|&
name|sc
operator|->
name|sc_hostvar
operator|->
name|hv_tx_hi_desc_read_idx
expr_stmt|;
comment|/* lo priority tx ring */
name|boot
operator|->
name|br_txlopri_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_txloring
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_txlopri_hi
operator|=
literal|0
expr_stmt|;
name|boot
operator|->
name|br_txlopri_siz
operator|=
name|TX_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_tx_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txlor
operator|.
name|r_reg
operator|=
name|TXP_H2A_3
expr_stmt|;
name|sc
operator|->
name|sc_txlor
operator|.
name|r_desc
operator|=
operator|(
expr|struct
name|txp_tx_desc
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_txloring
expr_stmt|;
name|sc
operator|->
name|sc_txlor
operator|.
name|r_cons
operator|=
name|sc
operator|->
name|sc_txlor
operator|.
name|r_prod
operator|=
name|sc
operator|->
name|sc_txlor
operator|.
name|r_cnt
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_txlor
operator|.
name|r_off
operator|=
operator|&
name|sc
operator|->
name|sc_hostvar
operator|->
name|hv_tx_lo_desc_read_idx
expr_stmt|;
comment|/* high priority rx ring */
name|boot
operator|->
name|br_rxhipri_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_rxhiring
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_rxhipri_hi
operator|=
literal|0
expr_stmt|;
name|boot
operator|->
name|br_rxhipri_siz
operator|=
name|RX_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rx_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxhir
operator|.
name|r_desc
operator|=
operator|(
expr|struct
name|txp_rx_desc
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_rxhiring
expr_stmt|;
name|sc
operator|->
name|sc_rxhir
operator|.
name|r_roff
operator|=
operator|&
name|sc
operator|->
name|sc_hostvar
operator|->
name|hv_rx_hi_read_idx
expr_stmt|;
name|sc
operator|->
name|sc_rxhir
operator|.
name|r_woff
operator|=
operator|&
name|sc
operator|->
name|sc_hostvar
operator|->
name|hv_rx_hi_write_idx
expr_stmt|;
comment|/* low priority rx ring */
name|boot
operator|->
name|br_rxlopri_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_rxloring
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_rxlopri_hi
operator|=
literal|0
expr_stmt|;
name|boot
operator|->
name|br_rxlopri_siz
operator|=
name|RX_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rx_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxlor
operator|.
name|r_desc
operator|=
operator|(
expr|struct
name|txp_rx_desc
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_rxloring
expr_stmt|;
name|sc
operator|->
name|sc_rxlor
operator|.
name|r_roff
operator|=
operator|&
name|sc
operator|->
name|sc_hostvar
operator|->
name|hv_rx_lo_read_idx
expr_stmt|;
name|sc
operator|->
name|sc_rxlor
operator|.
name|r_woff
operator|=
operator|&
name|sc
operator|->
name|sc_hostvar
operator|->
name|hv_rx_lo_write_idx
expr_stmt|;
comment|/* command ring */
name|bzero
argument_list|(
operator|&
name|ld
operator|->
name|txp_cmdring
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
operator|*
name|CMD_ENTRIES
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_cmd_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_cmdring
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_cmd_hi
operator|=
literal|0
expr_stmt|;
name|boot
operator|->
name|br_cmd_siz
operator|=
name|CMD_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cmdring
operator|.
name|base
operator|=
operator|(
expr|struct
name|txp_cmd_desc
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_cmdring
expr_stmt|;
name|sc
operator|->
name|sc_cmdring
operator|.
name|size
operator|=
name|CMD_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cmdring
operator|.
name|lastwrite
operator|=
literal|0
expr_stmt|;
comment|/* response ring */
name|bzero
argument_list|(
operator|&
name|ld
operator|->
name|txp_rspring
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rsp_desc
argument_list|)
operator|*
name|RSP_ENTRIES
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_resp_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_rspring
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_resp_hi
operator|=
literal|0
expr_stmt|;
name|boot
operator|->
name|br_resp_siz
operator|=
name|CMD_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rsp_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rspring
operator|.
name|base
operator|=
operator|(
expr|struct
name|txp_rsp_desc
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_rspring
expr_stmt|;
name|sc
operator|->
name|sc_rspring
operator|.
name|size
operator|=
name|RSP_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rsp_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rspring
operator|.
name|lastwrite
operator|=
literal|0
expr_stmt|;
comment|/* receive buffer ring */
name|boot
operator|->
name|br_rxbuf_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_rxbufs
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_rxbuf_hi
operator|=
literal|0
expr_stmt|;
name|boot
operator|->
name|br_rxbuf_siz
operator|=
name|RXBUF_ENTRIES
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rxbuf_desc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxbufs
operator|=
operator|(
expr|struct
name|txp_rxbuf_desc
operator|*
operator|)
operator|&
name|ld
operator|->
name|txp_rxbufs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RXBUF_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|txp_swdesc
modifier|*
name|sd
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_sd
operator|!=
name|NULL
condition|)
continue|continue;
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_sd
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|txp_swdesc
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_sd
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|sd
operator|=
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_sd
expr_stmt|;
name|sd
operator|->
name|sd_mbuf
operator|=
name|NULL
expr_stmt|;
block|}
name|sc
operator|->
name|sc_rxbufprod
operator|=
literal|0
expr_stmt|;
comment|/* zero dma */
name|bzero
argument_list|(
operator|&
name|ld
operator|->
name|txp_zero
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_zero_lo
operator|=
name|vtophys
argument_list|(
operator|&
name|ld
operator|->
name|txp_zero
argument_list|)
expr_stmt|;
name|boot
operator|->
name|br_zero_hi
operator|=
literal|0
expr_stmt|;
comment|/* See if it's waiting for boot, and try to boot it */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10000
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_A2H_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|STAT_WAITING_FOR_BOOT
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
name|STAT_WAITING_FOR_BOOT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"not waiting for boot\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_1
argument_list|,
name|vtophys
argument_list|(
name|sc
operator|->
name|sc_boot
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_0
argument_list|,
name|TXP_BOOTCMD_REGISTER_BOOT_RECORD
argument_list|)
expr_stmt|;
comment|/* See if it booted */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10000
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|READ_REG
argument_list|(
name|sc
argument_list|,
name|TXP_A2H_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|STAT_RUNNING
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
name|STAT_RUNNING
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fw not running\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Clear TX and CMD ring write registers */
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_1
argument_list|,
name|TXP_BOOTCMD_NULL
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_2
argument_list|,
name|TXP_BOOTCMD_NULL
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_3
argument_list|,
name|TXP_BOOTCMD_NULL
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_0
argument_list|,
name|TXP_BOOTCMD_NULL
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_ioctl
parameter_list|(
name|ifp
parameter_list|,
name|command
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|command
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
name|txp_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
name|txp_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
comment|/* 		 * Multicast list has changed; set the hardware 		 * filter accordingly. 		 */
name|txp_set_filter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SIOCGIFMEDIA
case|:
case|case
name|SIOCSIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|sc_ifmedia
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_rxring_fill
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|txp_swdesc
modifier|*
name|sd
decl_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RXBUF_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|sd
operator|=
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_sd
expr_stmt|;
name|MGETHDR
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|sd_mbuf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|MCLGET
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
operator|==
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_len
operator|=
name|MCLBYTES
expr_stmt|;
name|sd
operator|->
name|sd_mbuf
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_paddrlo
operator|=
name|vtophys
argument_list|(
name|mtod
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_paddrhi
operator|=
literal|0
expr_stmt|;
block|}
name|sc
operator|->
name|sc_hostvar
operator|->
name|hv_rx_buf_write_idx
operator|=
operator|(
name|RXBUF_ENTRIES
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rxbuf_desc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_rxring_empty
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|struct
name|txp_swdesc
modifier|*
name|sd
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_rxbufs
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RXBUF_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|&
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|sd
operator|=
name|sc
operator|->
name|sc_rxbufs
index|[
name|i
index|]
operator|.
name|rb_sd
expr_stmt|;
if|if
condition|(
name|sd
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|sd
operator|->
name|sd_mbuf
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|sd
operator|->
name|sd_mbuf
argument_list|)
expr_stmt|;
name|sd
operator|->
name|sd_mbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_init
parameter_list|(
name|xsc
parameter_list|)
name|void
modifier|*
name|xsc
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_int16_t
name|p1
decl_stmt|;
name|u_int32_t
name|p2
decl_stmt|;
name|int
name|s
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
return|return;
name|txp_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_MAX_PKT_SIZE_WRITE
argument_list|,
name|TXP_MAX_PKTLEN
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Set station address. */
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p1
operator|)
index|[
literal|1
index|]
operator|=
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|0
index|]
expr_stmt|;
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p1
operator|)
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|1
index|]
expr_stmt|;
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|3
index|]
operator|=
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|2
index|]
expr_stmt|;
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|2
index|]
operator|=
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|3
index|]
expr_stmt|;
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|1
index|]
operator|=
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|4
index|]
expr_stmt|;
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|p2
operator|)
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_enaddr
index|[
literal|5
index|]
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_STATION_ADDRESS_WRITE
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|txp_set_filter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|txp_rxring_fill
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_TX_ENABLE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_RX_ENABLE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IER
argument_list|,
name|TXP_INT_RESERVED
operator||
name|TXP_INT_SELF
operator||
name|TXP_INT_A2H_7
operator||
name|TXP_INT_A2H_6
operator||
name|TXP_INT_A2H_5
operator||
name|TXP_INT_A2H_4
operator||
name|TXP_INT_A2H_2
operator||
name|TXP_INT_A2H_1
operator||
name|TXP_INT_A2H_0
operator||
name|TXP_INT_DMA3
operator||
name|TXP_INT_DMA2
operator||
name|TXP_INT_DMA1
operator||
name|TXP_INT_DMA0
operator||
name|TXP_INT_PCI_TABORT
operator||
name|TXP_INT_PCI_MABORT
operator||
name|TXP_INT_LATCH
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_IMR
argument_list|,
name|TXP_INT_A2H_3
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_tick
operator|=
name|timeout
argument_list|(
name|txp_tick
argument_list|,
name|sc
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_tick
parameter_list|(
name|vsc
parameter_list|)
name|void
modifier|*
name|vsc
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
init|=
name|vsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
decl_stmt|;
name|struct
name|txp_rsp_desc
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
name|struct
name|txp_ext_desc
modifier|*
name|ext
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|txp_rxbuf_reclaim
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|txp_command2
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_READ_STATISTICS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rsp
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|rsp
operator|->
name|rsp_numdesc
operator|!=
literal|6
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_CLEAR_STATISTICS
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|ext
operator|=
operator|(
expr|struct
name|txp_ext_desc
operator|*
operator|)
operator|(
name|rsp
operator|+
literal|1
operator|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|+=
name|ext
index|[
literal|3
index|]
operator|.
name|ext_2
operator|+
name|ext
index|[
literal|3
index|]
operator|.
name|ext_3
operator|+
name|ext
index|[
literal|3
index|]
operator|.
name|ext_4
operator|+
name|ext
index|[
literal|4
index|]
operator|.
name|ext_1
operator|+
name|ext
index|[
literal|4
index|]
operator|.
name|ext_4
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|+=
name|ext
index|[
literal|0
index|]
operator|.
name|ext_1
operator|+
name|ext
index|[
literal|1
index|]
operator|.
name|ext_1
operator|+
name|ext
index|[
literal|1
index|]
operator|.
name|ext_4
operator|+
name|ext
index|[
literal|2
index|]
operator|.
name|ext_1
expr_stmt|;
name|ifp
operator|->
name|if_collisions
operator|+=
name|ext
index|[
literal|0
index|]
operator|.
name|ext_2
operator|+
name|ext
index|[
literal|0
index|]
operator|.
name|ext_3
operator|+
name|ext
index|[
literal|1
index|]
operator|.
name|ext_2
operator|+
name|ext
index|[
literal|1
index|]
operator|.
name|ext_3
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|+=
name|rsp
operator|->
name|rsp_par2
expr_stmt|;
name|ifp
operator|->
name|if_ipackets
operator|+=
name|ext
index|[
literal|2
index|]
operator|.
name|ext_3
expr_stmt|;
name|out
label|:
if|if
condition|(
name|rsp
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|rsp
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tick
operator|=
name|timeout
argument_list|(
name|txp_tick
argument_list|,
name|sc
argument_list|,
name|hz
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_start
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|txp_tx_ring
modifier|*
name|r
init|=
operator|&
name|sc
operator|->
name|sc_txhir
decl_stmt|;
name|struct
name|txp_tx_desc
modifier|*
name|txd
decl_stmt|;
name|struct
name|txp_frag_desc
modifier|*
name|fxd
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
name|struct
name|txp_swdesc
modifier|*
name|sd
decl_stmt|;
name|u_int32_t
name|firstprod
decl_stmt|,
name|firstcnt
decl_stmt|,
name|prod
decl_stmt|,
name|cnt
decl_stmt|;
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
operator|(
name|IFF_RUNNING
operator||
name|IFF_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_RUNNING
condition|)
return|return;
name|prod
operator|=
name|r
operator|->
name|r_prod
expr_stmt|;
name|cnt
operator|=
name|r
operator|->
name|r_cnt
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|firstprod
operator|=
name|prod
expr_stmt|;
name|firstcnt
operator|=
name|cnt
expr_stmt|;
name|sd
operator|=
name|sc
operator|->
name|sc_txd
operator|+
name|prod
expr_stmt|;
name|sd
operator|->
name|sd_mbuf
operator|=
name|m
expr_stmt|;
if|if
condition|(
operator|(
name|TX_ENTRIES
operator|-
name|cnt
operator|)
operator|<
literal|4
condition|)
goto|goto
name|oactive
goto|;
name|txd
operator|=
name|r
operator|->
name|r_desc
operator|+
name|prod
expr_stmt|;
name|txd
operator|->
name|tx_flags
operator|=
name|TX_FLAGS_TYPE_DATA
expr_stmt|;
name|txd
operator|->
name|tx_numdesc
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|tx_addrlo
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|tx_addrhi
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|tx_totlen
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|tx_pflags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|prod
operator|==
name|TX_ENTRIES
condition|)
name|prod
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|cnt
operator|>=
operator|(
name|TX_ENTRIES
operator|-
literal|4
operator|)
condition|)
goto|goto
name|oactive
goto|;
name|mtag
operator|=
name|VLAN_OUTPUT_TAG
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|!=
name|NULL
condition|)
block|{
name|txd
operator|->
name|tx_pflags
operator|=
name|TX_PFLAGS_VLAN
operator||
operator|(
name|htons
argument_list|(
name|VLAN_TAG_VALUE
argument_list|(
name|mtag
argument_list|)
argument_list|)
operator|<<
name|TX_PFLAGS_VLANTAG_S
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP
condition|)
name|txd
operator|->
name|tx_pflags
operator||=
name|TX_PFLAGS_IPCKSUM
expr_stmt|;
if|#
directive|if
literal|0
block|if (m->m_pkthdr.csum_flags& CSUM_TCP) 			txd->tx_pflags |= TX_PFLAGS_TCPCKSUM; 		if (m->m_pkthdr.csum_flags& CSUM_UDP) 			txd->tx_pflags |= TX_PFLAGS_UDPCKSUM;
endif|#
directive|endif
name|fxd
operator|=
operator|(
expr|struct
name|txp_frag_desc
operator|*
operator|)
operator|(
name|r
operator|->
name|r_desc
operator|+
name|prod
operator|)
expr_stmt|;
for|for
control|(
name|m0
operator|=
name|m
init|;
name|m0
operator|!=
name|NULL
condition|;
name|m0
operator|=
name|m0
operator|->
name|m_next
control|)
block|{
if|if
condition|(
name|m0
operator|->
name|m_len
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|++
name|cnt
operator|>=
operator|(
name|TX_ENTRIES
operator|-
literal|4
operator|)
condition|)
goto|goto
name|oactive
goto|;
name|txd
operator|->
name|tx_numdesc
operator|++
expr_stmt|;
name|fxd
operator|->
name|frag_flags
operator|=
name|FRAG_FLAGS_TYPE_FRAG
expr_stmt|;
name|fxd
operator|->
name|frag_rsvd1
operator|=
literal|0
expr_stmt|;
name|fxd
operator|->
name|frag_len
operator|=
name|m0
operator|->
name|m_len
expr_stmt|;
name|fxd
operator|->
name|frag_addrlo
operator|=
name|vtophys
argument_list|(
name|mtod
argument_list|(
name|m0
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
expr_stmt|;
name|fxd
operator|->
name|frag_addrhi
operator|=
literal|0
expr_stmt|;
name|fxd
operator|->
name|frag_rsvd2
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|prod
operator|==
name|TX_ENTRIES
condition|)
block|{
name|fxd
operator|=
operator|(
expr|struct
name|txp_frag_desc
operator|*
operator|)
name|r
operator|->
name|r_desc
expr_stmt|;
name|prod
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|fxd
operator|++
expr_stmt|;
block|}
name|ifp
operator|->
name|if_timer
operator|=
literal|5
expr_stmt|;
name|BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|r
operator|->
name|r_reg
argument_list|,
name|TXP_IDX2OFFSET
argument_list|(
name|prod
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|r
operator|->
name|r_prod
operator|=
name|prod
expr_stmt|;
name|r
operator|->
name|r_cnt
operator|=
name|cnt
expr_stmt|;
return|return;
name|oactive
label|:
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
name|r
operator|->
name|r_prod
operator|=
name|firstprod
expr_stmt|;
name|r
operator|->
name|r_cnt
operator|=
name|firstcnt
expr_stmt|;
name|IF_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Handle simple commands sent to the typhoon  */
end_comment

begin_function
specifier|static
name|int
name|txp_command
parameter_list|(
name|sc
parameter_list|,
name|id
parameter_list|,
name|in1
parameter_list|,
name|in2
parameter_list|,
name|in3
parameter_list|,
name|out1
parameter_list|,
name|out2
parameter_list|,
name|out3
parameter_list|,
name|wait
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|u_int16_t
name|id
decl_stmt|,
name|in1
decl_stmt|,
decl|*
name|out1
decl_stmt|;
end_function

begin_decl_stmt
name|u_int32_t
name|in2
decl_stmt|,
name|in3
decl_stmt|,
modifier|*
name|out2
decl_stmt|,
modifier|*
name|out3
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wait
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|txp_rsp_desc
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|txp_command2
argument_list|(
name|sc
argument_list|,
name|id
argument_list|,
name|in1
argument_list|,
name|in2
argument_list|,
name|in3
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rsp
argument_list|,
name|wait
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|!
name|wait
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|out1
operator|!=
name|NULL
condition|)
operator|*
name|out1
operator|=
name|rsp
operator|->
name|rsp_par1
expr_stmt|;
if|if
condition|(
name|out2
operator|!=
name|NULL
condition|)
operator|*
name|out2
operator|=
name|rsp
operator|->
name|rsp_par2
expr_stmt|;
if|if
condition|(
name|out3
operator|!=
name|NULL
condition|)
operator|*
name|out3
operator|=
name|rsp
operator|->
name|rsp_par3
expr_stmt|;
name|free
argument_list|(
name|rsp
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|txp_command2
parameter_list|(
name|sc
parameter_list|,
name|id
parameter_list|,
name|in1
parameter_list|,
name|in2
parameter_list|,
name|in3
parameter_list|,
name|in_extp
parameter_list|,
name|in_extn
parameter_list|,
name|rspp
parameter_list|,
name|wait
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|u_int16_t
name|id
decl_stmt|,
name|in1
decl_stmt|;
name|u_int32_t
name|in2
decl_stmt|,
name|in3
decl_stmt|;
name|struct
name|txp_ext_desc
modifier|*
name|in_extp
decl_stmt|;
name|u_int8_t
name|in_extn
decl_stmt|;
name|struct
name|txp_rsp_desc
modifier|*
modifier|*
name|rspp
decl_stmt|;
name|int
name|wait
decl_stmt|;
block|{
name|struct
name|txp_hostvar
modifier|*
name|hv
init|=
name|sc
operator|->
name|sc_hostvar
decl_stmt|;
name|struct
name|txp_cmd_desc
modifier|*
name|cmd
decl_stmt|;
name|struct
name|txp_ext_desc
modifier|*
name|ext
decl_stmt|;
name|u_int32_t
name|idx
decl_stmt|,
name|i
decl_stmt|;
name|u_int16_t
name|seq
decl_stmt|;
if|if
condition|(
name|txp_cmd_desc_numfree
argument_list|(
name|sc
argument_list|)
operator|<
operator|(
name|in_extn
operator|+
literal|1
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"no free cmd descriptors\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|idx
operator|=
name|sc
operator|->
name|sc_cmdring
operator|.
name|lastwrite
expr_stmt|;
name|cmd
operator|=
operator|(
expr|struct
name|txp_cmd_desc
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|sc_cmdring
operator|.
name|base
operator|)
operator|+
name|idx
operator|)
expr_stmt|;
name|bzero
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|cmd_numdesc
operator|=
name|in_extn
expr_stmt|;
name|cmd
operator|->
name|cmd_seq
operator|=
name|seq
operator|=
name|sc
operator|->
name|sc_seq
operator|++
expr_stmt|;
name|cmd
operator|->
name|cmd_id
operator|=
name|id
expr_stmt|;
name|cmd
operator|->
name|cmd_par1
operator|=
name|in1
expr_stmt|;
name|cmd
operator|->
name|cmd_par2
operator|=
name|in2
expr_stmt|;
name|cmd
operator|->
name|cmd_par3
operator|=
name|in3
expr_stmt|;
name|cmd
operator|->
name|cmd_flags
operator|=
name|CMD_FLAGS_TYPE_CMD
operator||
operator|(
name|wait
condition|?
name|CMD_FLAGS_RESP
else|:
literal|0
operator|)
operator||
name|CMD_FLAGS_VALID
expr_stmt|;
name|idx
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|==
name|sc
operator|->
name|sc_cmdring
operator|.
name|size
condition|)
name|idx
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|in_extn
condition|;
name|i
operator|++
control|)
block|{
name|ext
operator|=
operator|(
expr|struct
name|txp_ext_desc
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|sc_cmdring
operator|.
name|base
operator|)
operator|+
name|idx
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|in_extp
argument_list|,
name|ext
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|txp_ext_desc
argument_list|)
argument_list|)
expr_stmt|;
name|in_extp
operator|++
expr_stmt|;
name|idx
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|==
name|sc
operator|->
name|sc_cmdring
operator|.
name|size
condition|)
name|idx
operator|=
literal|0
expr_stmt|;
block|}
name|sc
operator|->
name|sc_cmdring
operator|.
name|lastwrite
operator|=
name|idx
expr_stmt|;
name|WRITE_REG
argument_list|(
name|sc
argument_list|,
name|TXP_H2A_2
argument_list|,
name|sc
operator|->
name|sc_cmdring
operator|.
name|lastwrite
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wait
condition|)
return|return
operator|(
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10000
condition|;
name|i
operator|++
control|)
block|{
name|idx
operator|=
name|hv
operator|->
name|hv_resp_read_idx
expr_stmt|;
if|if
condition|(
name|idx
operator|!=
name|hv
operator|->
name|hv_resp_write_idx
condition|)
block|{
operator|*
name|rspp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|txp_response
argument_list|(
name|sc
argument_list|,
name|idx
argument_list|,
name|id
argument_list|,
name|seq
argument_list|,
name|rspp
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|*
name|rspp
operator|!=
name|NULL
condition|)
break|break;
block|}
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|1000
operator|||
operator|(
operator|*
name|rspp
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"0x%x command failed\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_response
parameter_list|(
name|sc
parameter_list|,
name|ridx
parameter_list|,
name|id
parameter_list|,
name|seq
parameter_list|,
name|rspp
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|u_int32_t
name|ridx
decl_stmt|;
name|u_int16_t
name|id
decl_stmt|;
name|u_int16_t
name|seq
decl_stmt|;
name|struct
name|txp_rsp_desc
modifier|*
modifier|*
name|rspp
decl_stmt|;
block|{
name|struct
name|txp_hostvar
modifier|*
name|hv
init|=
name|sc
operator|->
name|sc_hostvar
decl_stmt|;
name|struct
name|txp_rsp_desc
modifier|*
name|rsp
decl_stmt|;
while|while
condition|(
name|ridx
operator|!=
name|hv
operator|->
name|hv_resp_write_idx
condition|)
block|{
name|rsp
operator|=
operator|(
expr|struct
name|txp_rsp_desc
operator|*
operator|)
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|sc
operator|->
name|sc_rspring
operator|.
name|base
operator|)
operator|+
name|ridx
operator|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|rsp
operator|->
name|rsp_id
operator|&&
name|rsp
operator|->
name|rsp_seq
operator|==
name|seq
condition|)
block|{
operator|*
name|rspp
operator|=
operator|(
expr|struct
name|txp_rsp_desc
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rsp_desc
argument_list|)
operator|*
operator|(
name|rsp
operator|->
name|rsp_numdesc
operator|+
literal|1
operator|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|rspp
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|txp_rsp_fixup
argument_list|(
name|sc
argument_list|,
name|rsp
argument_list|,
operator|*
name|rspp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|rsp
operator|->
name|rsp_flags
operator|&
name|RSP_FLAGS_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"response error!\n"
argument_list|)
expr_stmt|;
name|txp_rsp_fixup
argument_list|(
name|sc
argument_list|,
name|rsp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ridx
operator|=
name|hv
operator|->
name|hv_resp_read_idx
expr_stmt|;
continue|continue;
block|}
switch|switch
condition|(
name|rsp
operator|->
name|rsp_id
condition|)
block|{
case|case
name|TXP_CMD_CYCLE_STATISTICS
case|:
case|case
name|TXP_CMD_MEDIA_STATUS_READ
case|:
break|break;
case|case
name|TXP_CMD_HELLO_RESPONSE
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"hello\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"unknown id(0x%x)\n"
argument_list|,
name|rsp
operator|->
name|rsp_id
argument_list|)
expr_stmt|;
block|}
name|txp_rsp_fixup
argument_list|(
name|sc
argument_list|,
name|rsp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ridx
operator|=
name|hv
operator|->
name|hv_resp_read_idx
expr_stmt|;
name|hv
operator|->
name|hv_resp_read_idx
operator|=
name|ridx
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_rsp_fixup
parameter_list|(
name|sc
parameter_list|,
name|rsp
parameter_list|,
name|dst
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|txp_rsp_desc
modifier|*
name|rsp
decl_stmt|,
decl|*
name|dst
decl_stmt|;
end_function

begin_block
block|{
name|struct
name|txp_rsp_desc
modifier|*
name|src
init|=
name|rsp
decl_stmt|;
name|struct
name|txp_hostvar
modifier|*
name|hv
init|=
name|sc
operator|->
name|sc_hostvar
decl_stmt|;
name|u_int32_t
name|i
decl_stmt|,
name|ridx
decl_stmt|;
name|ridx
operator|=
name|hv
operator|->
name|hv_resp_read_idx
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rsp
operator|->
name|rsp_numdesc
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dst
operator|!=
name|NULL
condition|)
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
operator|++
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rsp_desc
argument_list|)
argument_list|)
expr_stmt|;
name|ridx
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|txp_rsp_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ridx
operator|==
name|sc
operator|->
name|sc_rspring
operator|.
name|size
condition|)
block|{
name|src
operator|=
name|sc
operator|->
name|sc_rspring
operator|.
name|base
expr_stmt|;
name|ridx
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|src
operator|++
expr_stmt|;
name|sc
operator|->
name|sc_rspring
operator|.
name|lastwrite
operator|=
name|hv
operator|->
name|hv_resp_read_idx
operator|=
name|ridx
expr_stmt|;
block|}
name|hv
operator|->
name|hv_resp_read_idx
operator|=
name|ridx
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|int
name|txp_cmd_desc_numfree
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|txp_hostvar
modifier|*
name|hv
init|=
name|sc
operator|->
name|sc_hostvar
decl_stmt|;
name|struct
name|txp_boot_record
modifier|*
name|br
init|=
name|sc
operator|->
name|sc_boot
decl_stmt|;
name|u_int32_t
name|widx
decl_stmt|,
name|ridx
decl_stmt|,
name|nfree
decl_stmt|;
name|widx
operator|=
name|sc
operator|->
name|sc_cmdring
operator|.
name|lastwrite
expr_stmt|;
name|ridx
operator|=
name|hv
operator|->
name|hv_cmd_read_idx
expr_stmt|;
if|if
condition|(
name|widx
operator|==
name|ridx
condition|)
block|{
comment|/* Ring is completely free */
name|nfree
operator|=
name|br
operator|->
name|br_cmd_siz
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|widx
operator|>
name|ridx
condition|)
name|nfree
operator|=
name|br
operator|->
name|br_cmd_siz
operator|-
operator|(
name|widx
operator|-
name|ridx
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
operator|)
expr_stmt|;
else|else
name|nfree
operator|=
name|ridx
operator|-
name|widx
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|nfree
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|txp_cmd_desc
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_stop
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
operator|(
name|IFF_RUNNING
operator||
name|IFF_OACTIVE
operator|)
expr_stmt|;
name|untimeout
argument_list|(
name|txp_tick
argument_list|,
name|sc
argument_list|,
name|sc
operator|->
name|sc_tick
argument_list|)
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_TX_DISABLE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_RX_DISABLE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|txp_rxring_empty
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_watchdog
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|txp_ifmedia_upd
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
init|=
operator|&
name|sc
operator|->
name|sc_ifmedia
decl_stmt|;
name|u_int16_t
name|new_xcvr
decl_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|==
name|IFM_10_T
condition|)
block|{
if|if
condition|(
operator|(
name|ifm
operator|->
name|ifm_media
operator|&
name|IFM_GMASK
operator|)
operator|==
name|IFM_FDX
condition|)
name|new_xcvr
operator|=
name|TXP_XCVR_10_FDX
expr_stmt|;
else|else
name|new_xcvr
operator|=
name|TXP_XCVR_10_HDX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|==
name|IFM_100_TX
condition|)
block|{
if|if
condition|(
operator|(
name|ifm
operator|->
name|ifm_media
operator|&
name|IFM_GMASK
operator|)
operator|==
name|IFM_FDX
condition|)
name|new_xcvr
operator|=
name|TXP_XCVR_100_FDX
expr_stmt|;
else|else
name|new_xcvr
operator|=
name|TXP_XCVR_100_HDX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|==
name|IFM_AUTO
condition|)
block|{
name|new_xcvr
operator|=
name|TXP_XCVR_AUTO
expr_stmt|;
block|}
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* nothing to do */
if|if
condition|(
name|sc
operator|->
name|sc_xcvr
operator|==
name|new_xcvr
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_XCVR_SELECT
argument_list|,
name|new_xcvr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_xcvr
operator|=
name|new_xcvr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_ifmedia_sts
parameter_list|(
name|ifp
parameter_list|,
name|ifmr
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmediareq
modifier|*
name|ifmr
decl_stmt|;
block|{
name|struct
name|txp_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
init|=
operator|&
name|sc
operator|->
name|sc_ifmedia
decl_stmt|;
name|u_int16_t
name|bmsr
decl_stmt|,
name|bmcr
decl_stmt|,
name|anlpar
decl_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
expr_stmt|;
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_PHY_MGMT_READ
argument_list|,
literal|0
argument_list|,
name|MII_BMSR
argument_list|,
literal|0
argument_list|,
operator|&
name|bmsr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|bail
goto|;
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_PHY_MGMT_READ
argument_list|,
literal|0
argument_list|,
name|MII_BMSR
argument_list|,
literal|0
argument_list|,
operator|&
name|bmsr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|bail
goto|;
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_PHY_MGMT_READ
argument_list|,
literal|0
argument_list|,
name|MII_BMCR
argument_list|,
literal|0
argument_list|,
operator|&
name|bmcr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|bail
goto|;
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_PHY_MGMT_READ
argument_list|,
literal|0
argument_list|,
name|MII_ANLPAR
argument_list|,
literal|0
argument_list|,
operator|&
name|anlpar
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|bail
goto|;
if|if
condition|(
name|bmsr
operator|&
name|BMSR_LINK
condition|)
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
if|if
condition|(
name|bmcr
operator|&
name|BMCR_ISO
condition|)
block|{
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_NONE
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bmcr
operator|&
name|BMCR_LOOP
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_LOOP
expr_stmt|;
if|if
condition|(
name|bmcr
operator|&
name|BMCR_AUTOEN
condition|)
block|{
if|if
condition|(
operator|(
name|bmsr
operator|&
name|BMSR_ACOMP
operator|)
operator|==
literal|0
condition|)
block|{
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_NONE
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|anlpar
operator|&
name|ANLPAR_T4
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100_T4
expr_stmt|;
elseif|else
if|if
condition|(
name|anlpar
operator|&
name|ANLPAR_TX_FD
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100_TX
operator||
name|IFM_FDX
expr_stmt|;
elseif|else
if|if
condition|(
name|anlpar
operator|&
name|ANLPAR_TX
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_100_TX
expr_stmt|;
elseif|else
if|if
condition|(
name|anlpar
operator|&
name|ANLPAR_10_FD
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10_T
operator||
name|IFM_FDX
expr_stmt|;
elseif|else
if|if
condition|(
name|anlpar
operator|&
name|ANLPAR_10
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_10_T
expr_stmt|;
else|else
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_NONE
expr_stmt|;
block|}
else|else
name|ifmr
operator|->
name|ifm_active
operator|=
name|ifm
operator|->
name|ifm_cur
operator|->
name|ifm_media
expr_stmt|;
return|return;
name|bail
label|:
name|ifmr
operator|->
name|ifm_active
operator||=
name|IFM_NONE
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|&=
operator|~
name|IFM_AVALID
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|TXP_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|txp_show_descriptor
parameter_list|(
name|d
parameter_list|)
name|void
modifier|*
name|d
decl_stmt|;
block|{
name|struct
name|txp_cmd_desc
modifier|*
name|cmd
init|=
name|d
decl_stmt|;
name|struct
name|txp_rsp_desc
modifier|*
name|rsp
init|=
name|d
decl_stmt|;
name|struct
name|txp_tx_desc
modifier|*
name|txd
init|=
name|d
decl_stmt|;
name|struct
name|txp_frag_desc
modifier|*
name|frgd
init|=
name|d
decl_stmt|;
switch|switch
condition|(
name|cmd
operator|->
name|cmd_flags
operator|&
name|CMD_FLAGS_TYPE_M
condition|)
block|{
case|case
name|CMD_FLAGS_TYPE_CMD
case|:
comment|/* command descriptor */
name|printf
argument_list|(
literal|"[cmd flags 0x%x num %d id %d seq %d par1 0x%x par2 0x%x par3 0x%x]\n"
argument_list|,
name|cmd
operator|->
name|cmd_flags
argument_list|,
name|cmd
operator|->
name|cmd_numdesc
argument_list|,
name|cmd
operator|->
name|cmd_id
argument_list|,
name|cmd
operator|->
name|cmd_seq
argument_list|,
name|cmd
operator|->
name|cmd_par1
argument_list|,
name|cmd
operator|->
name|cmd_par2
argument_list|,
name|cmd
operator|->
name|cmd_par3
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_FLAGS_TYPE_RESP
case|:
comment|/* response descriptor */
name|printf
argument_list|(
literal|"[rsp flags 0x%x num %d id %d seq %d par1 0x%x par2 0x%x par3 0x%x]\n"
argument_list|,
name|rsp
operator|->
name|rsp_flags
argument_list|,
name|rsp
operator|->
name|rsp_numdesc
argument_list|,
name|rsp
operator|->
name|rsp_id
argument_list|,
name|rsp
operator|->
name|rsp_seq
argument_list|,
name|rsp
operator|->
name|rsp_par1
argument_list|,
name|rsp
operator|->
name|rsp_par2
argument_list|,
name|rsp
operator|->
name|rsp_par3
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_FLAGS_TYPE_DATA
case|:
comment|/* data header (assuming tx for now) */
name|printf
argument_list|(
literal|"[data flags 0x%x num %d totlen %d addr 0x%x/0x%x pflags 0x%x]"
argument_list|,
name|txd
operator|->
name|tx_flags
argument_list|,
name|txd
operator|->
name|tx_numdesc
argument_list|,
name|txd
operator|->
name|tx_totlen
argument_list|,
name|txd
operator|->
name|tx_addrlo
argument_list|,
name|txd
operator|->
name|tx_addrhi
argument_list|,
name|txd
operator|->
name|tx_pflags
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_FLAGS_TYPE_FRAG
case|:
comment|/* fragment descriptor */
name|printf
argument_list|(
literal|"[frag flags 0x%x rsvd1 0x%x len %d addr 0x%x/0x%x rsvd2 0x%x]"
argument_list|,
name|frgd
operator|->
name|frag_flags
argument_list|,
name|frgd
operator|->
name|frag_rsvd1
argument_list|,
name|frgd
operator|->
name|frag_len
argument_list|,
name|frgd
operator|->
name|frag_addrlo
argument_list|,
name|frgd
operator|->
name|frag_addrhi
argument_list|,
name|frgd
operator|->
name|frag_rsvd2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"[unknown(%x) flags 0x%x num %d id %d seq %d par1 0x%x par2 0x%x par3 0x%x]\n"
argument_list|,
name|cmd
operator|->
name|cmd_flags
operator|&
name|CMD_FLAGS_TYPE_M
argument_list|,
name|cmd
operator|->
name|cmd_flags
argument_list|,
name|cmd
operator|->
name|cmd_numdesc
argument_list|,
name|cmd
operator|->
name|cmd_id
argument_list|,
name|cmd
operator|->
name|cmd_seq
argument_list|,
name|cmd
operator|->
name|cmd_par1
argument_list|,
name|cmd
operator|->
name|cmd_par2
argument_list|,
name|cmd
operator|->
name|cmd_par3
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|txp_set_filter
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
decl_stmt|;
name|u_int32_t
name|crc
decl_stmt|,
name|carry
decl_stmt|,
name|hashbit
decl_stmt|,
name|hash
index|[
literal|2
index|]
decl_stmt|;
name|u_int16_t
name|filter
decl_stmt|;
name|u_int8_t
name|octet
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|mcnt
init|=
literal|0
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|char
modifier|*
name|enm
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
block|{
name|filter
operator|=
name|TXP_RXFILT_PROMISC
expr_stmt|;
goto|goto
name|setit
goto|;
block|}
name|filter
operator|=
name|TXP_RXFILT_DIRECT
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_BROADCAST
condition|)
name|filter
operator||=
name|TXP_RXFILT_BROADCAST
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
condition|)
name|filter
operator||=
name|TXP_RXFILT_ALLMULTI
expr_stmt|;
else|else
block|{
name|hash
index|[
literal|0
index|]
operator|=
name|hash
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|enm
operator|=
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
expr_stmt|;
name|mcnt
operator|++
expr_stmt|;
name|crc
operator|=
literal|0xffffffff
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
block|{
name|octet
operator|=
name|enm
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|carry
operator|=
operator|(
operator|(
name|crc
operator|&
literal|0x80000000
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
operator|^
operator|(
name|octet
operator|&
literal|1
operator|)
expr_stmt|;
name|crc
operator|<<=
literal|1
expr_stmt|;
name|octet
operator|>>=
literal|1
expr_stmt|;
if|if
condition|(
name|carry
condition|)
name|crc
operator|=
operator|(
name|crc
operator|^
name|TXP_POLYNOMIAL
operator|)
operator||
name|carry
expr_stmt|;
block|}
block|}
name|hashbit
operator|=
call|(
name|u_int16_t
call|)
argument_list|(
name|crc
operator|&
operator|(
literal|64
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|hash
index|[
name|hashbit
operator|/
literal|32
index|]
operator||=
operator|(
literal|1
operator|<<
name|hashbit
operator|%
literal|32
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|mcnt
operator|>
literal|0
condition|)
block|{
name|filter
operator||=
name|TXP_RXFILT_HASHMULTI
expr_stmt|;
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_MCAST_HASH_MASK_WRITE
argument_list|,
literal|2
argument_list|,
name|hash
index|[
literal|0
index|]
argument_list|,
name|hash
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|setit
label|:
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_RX_FILTER_WRITE
argument_list|,
name|filter
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|txp_capabilities
parameter_list|(
name|sc
parameter_list|)
name|struct
name|txp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|sc_arpcom
operator|.
name|ac_if
decl_stmt|;
name|struct
name|txp_rsp_desc
modifier|*
name|rsp
init|=
name|NULL
decl_stmt|;
name|struct
name|txp_ext_desc
modifier|*
name|ext
decl_stmt|;
if|if
condition|(
name|txp_command2
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_OFFLOAD_READ
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|rsp
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|rsp
operator|->
name|rsp_numdesc
operator|!=
literal|1
condition|)
goto|goto
name|out
goto|;
name|ext
operator|=
operator|(
expr|struct
name|txp_ext_desc
operator|*
operator|)
operator|(
name|rsp
operator|+
literal|1
operator|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_capability
operator|=
name|ext
operator|->
name|ext_1
operator|&
name|OFFLOAD_MASK
expr_stmt|;
name|sc
operator|->
name|sc_rx_capability
operator|=
name|ext
operator|->
name|ext_2
operator|&
name|OFFLOAD_MASK
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|rsp_par2
operator|&
name|rsp
operator|->
name|rsp_par3
operator|&
name|OFFLOAD_VLAN
condition|)
block|{
name|sc
operator|->
name|sc_tx_capability
operator||=
name|OFFLOAD_VLAN
expr_stmt|;
name|sc
operator|->
name|sc_rx_capability
operator||=
name|OFFLOAD_VLAN
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* not ready yet */
block|if (rsp->rsp_par2& rsp->rsp_par3& OFFLOAD_IPSEC) { 		sc->sc_tx_capability |= OFFLOAD_IPSEC; 		sc->sc_rx_capability |= OFFLOAD_IPSEC; 		ifp->if_capabilities |= IFCAP_IPSEC; 	}
endif|#
directive|endif
if|if
condition|(
name|rsp
operator|->
name|rsp_par2
operator|&
name|rsp
operator|->
name|rsp_par3
operator|&
name|OFFLOAD_IPCKSUM
condition|)
block|{
name|sc
operator|->
name|sc_tx_capability
operator||=
name|OFFLOAD_IPCKSUM
expr_stmt|;
name|sc
operator|->
name|sc_rx_capability
operator||=
name|OFFLOAD_IPCKSUM
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_IP
expr_stmt|;
block|}
if|if
condition|(
name|rsp
operator|->
name|rsp_par2
operator|&
name|rsp
operator|->
name|rsp_par3
operator|&
name|OFFLOAD_TCPCKSUM
condition|)
block|{
if|#
directive|if
literal|0
block|sc->sc_tx_capability |= OFFLOAD_TCPCKSUM;
endif|#
directive|endif
name|sc
operator|->
name|sc_rx_capability
operator||=
name|OFFLOAD_TCPCKSUM
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
expr_stmt|;
block|}
if|if
condition|(
name|rsp
operator|->
name|rsp_par2
operator|&
name|rsp
operator|->
name|rsp_par3
operator|&
name|OFFLOAD_UDPCKSUM
condition|)
block|{
if|#
directive|if
literal|0
block|sc->sc_tx_capability |= OFFLOAD_UDPCKSUM;
endif|#
directive|endif
name|sc
operator|->
name|sc_rx_capability
operator||=
name|OFFLOAD_UDPCKSUM
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
expr_stmt|;
block|}
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
if|if
condition|(
name|txp_command
argument_list|(
name|sc
argument_list|,
name|TXP_CMD_OFFLOAD_WRITE
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_tx_capability
argument_list|,
name|sc
operator|->
name|sc_rx_capability
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|out
label|:
if|if
condition|(
name|rsp
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|rsp
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


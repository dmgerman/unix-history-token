begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1999-2001, Ivan Sharov, Vitaly Belekhov.  * Copyright (c) 2004 Stanislav Svirid.  * All rights reserved.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *   * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * $RISS: if_arl/dev/arl/if_arl.c,v 1.7 2004/03/16 04:43:27 count Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_define
define|#
directive|define
name|ARLCACHE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<dev/arl/if_arlreg.h>
end_include

begin_comment
comment|/*#define DEBUG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|D
parameter_list|(
name|x
parameter_list|)
value|{printf("arl%d: ", sc->arl_unit); printf x; }
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|D
parameter_list|(
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * channel attention  */
end_comment

begin_define
define|#
directive|define
name|ARL_CHANNEL
parameter_list|(
name|sc
parameter_list|)
define|\
value|{ \ 		D(("channel ctrl %x reg %x\n", sc->arl_control, ar->controlRegister)); \ 		ar->controlRegister = (sc->arl_control ^= ARL_CHANNEL_ATTENTION); \ 	}
end_define

begin_comment
comment|/*  * Check registration  */
end_comment

begin_define
define|#
directive|define
name|ARL_CHECKREG
parameter_list|(
name|sc
parameter_list|)
value|(ar->registrationMode&& ar->registrationStatus == 0)
end_define

begin_define
define|#
directive|define
name|GET_ARL_PARAM
parameter_list|(
name|name
parameter_list|)
value|(arcfg.name = ar->name)
end_define

begin_define
define|#
directive|define
name|SET_ARL_PARAM
parameter_list|(
name|name
parameter_list|)
value|(ar->name = arcfg.name)
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|BPF_MTAP
end_ifndef

begin_define
define|#
directive|define
name|BPF_MTAP
parameter_list|(
name|_ifp
parameter_list|,
name|_m
parameter_list|)
define|\
value|do {							\ 		if ((_ifp)->if_bpf)				\ 			bpf_mtap((_ifp), (_m));			\ 	} while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|500100
end_if

begin_define
define|#
directive|define
name|BROADCASTADDR
value|(etherbroadcastaddr)
end_define

begin_define
define|#
directive|define
name|_ARL_CURPROC
value|(curproc)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|BROADCASTADDR
value|(sc->arl_ifp->if_broadcastaddr)
end_define

begin_define
define|#
directive|define
name|_ARL_CURPROC
value|(curthread)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|arl_hwreset
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_reset
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|arl_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_waitreg
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_enable
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_config
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|arl_command
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_put
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_read
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|,
name|caddr_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_recv
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|mbuf
modifier|*
name|arl_get
parameter_list|(
name|caddr_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|ARLCACHE
end_ifdef

begin_function_decl
specifier|static
name|void
name|arl_cache_store
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|,
name|struct
name|ether_header
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|arl_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|arl_read_config
parameter_list|(
name|struct
name|arl_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|devclass_t
name|arl_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int8_t
name|rate2media
index|[
literal|4
index|]
init|=
block|{
name|IFM_IEEE80211_DS354k
block|,
name|IFM_IEEE80211_DS512k
block|,
name|IFM_IEEE80211_DS1
block|,
name|IFM_IEEE80211_DS2
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Copy config values to local cache  */
end_comment

begin_function
specifier|static
name|void
name|arl_read_config
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|bzero
argument_list|(
operator|&
name|arcfg
argument_list|,
sizeof|sizeof
argument_list|(
name|arcfg
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ar
operator|->
name|lanCardNodeId
argument_list|,
name|arcfg
operator|.
name|lanCardNodeId
argument_list|,
sizeof|sizeof
argument_list|(
name|ar
operator|->
name|lanCardNodeId
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ar
operator|->
name|specifiedRouter
argument_list|,
name|arcfg
operator|.
name|specifiedRouter
argument_list|,
sizeof|sizeof
argument_list|(
name|ar
operator|->
name|specifiedRouter
argument_list|)
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|hardwareType
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|majorHardwareVersion
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|minorHardwareVersion
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|radioModule
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|channelSet
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arcfg
operator|.
name|channelSet
condition|)
name|arcfg
operator|.
name|channelSet
operator|=
name|ar
operator|->
name|defaultChannelSet
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|channelNumber
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|spreadingCode
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|priority
argument_list|)
expr_stmt|;
name|GET_ARL_PARAM
argument_list|(
name|receiveMode
argument_list|)
expr_stmt|;
name|arcfg
operator|.
name|registrationMode
operator|=
literal|1
expr_stmt|;
comment|/* set default TMA mode */
name|arcfg
operator|.
name|txRetry
operator|=
literal|0
expr_stmt|;
name|bcopy
argument_list|(
name|ar
operator|->
name|name
argument_list|,
name|arcfg
operator|.
name|name
argument_list|,
name|ARLAN_NAME_SIZE
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ar
operator|->
name|systemId
argument_list|,
name|arcfg
operator|.
name|sid
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|arcfg
operator|.
name|sid
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Attach device  */
end_comment

begin_function
name|int
name|arl_attach
parameter_list|(
name|dev
parameter_list|)
name|device_t
name|dev
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|attached
decl_stmt|,
name|configured
init|=
literal|0
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"attach\n"
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|arl_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOSPC
operator|)
return|;
name|configured
operator|=
name|ar
operator|->
name|configuredStatusFlag
expr_stmt|;
name|attached
operator|=
operator|(
name|ifp
operator|->
name|if_softc
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|configured
operator|&&
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"card is not configured\n"
argument_list|)
expr_stmt|;
else|else
name|arl_read_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|arl_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Read config for default values if card was not configured */
if|if
condition|(
operator|!
name|configured
condition|)
name|arl_read_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Initialize ifnet structure. */
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|502000
name|ifp
operator|->
name|if_unit
operator|=
name|sc
operator|->
name|arl_unit
expr_stmt|;
name|ifp
operator|->
name|if_name
operator|=
literal|"arl"
expr_stmt|;
else|#
directive|else
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
operator||
name|IFF_NEEDSGIANT
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|arl_start
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|arl_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|arl_watchdog
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|arl_init
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
literal|2000000
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|arl_ifmedia
argument_list|,
literal|0
argument_list|,
name|arl_media_change
argument_list|,
name|arl_media_status
argument_list|)
expr_stmt|;
define|#
directive|define
name|ADD
parameter_list|(
name|s
parameter_list|,
name|o
parameter_list|)
value|ifmedia_add(&sc->arl_ifmedia, \ 	IFM_MAKEWORD(IFM_IEEE80211, (s), (o), 0), 0, NULL)
name|ADD
argument_list|(
name|IFM_IEEE80211_DS354k
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|IFM_IEEE80211_DS354k
argument_list|,
name|IFM_IEEE80211_ADHOC
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|IFM_IEEE80211_DS512k
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|IFM_IEEE80211_DS512k
argument_list|,
name|IFM_IEEE80211_ADHOC
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|IFM_IEEE80211_DS1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|IFM_IEEE80211_DS1
argument_list|,
name|IFM_IEEE80211_ADHOC
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|IFM_IEEE80211_DS2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ADD
argument_list|(
name|IFM_IEEE80211_DS2
argument_list|,
name|IFM_IEEE80211_ADHOC
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|arl_ifmedia
argument_list|,
name|IFM_MAKEWORD
argument_list|(
name|IFM_IEEE80211
argument_list|,
name|rate2media
index|[
name|arcfg
operator|.
name|spreadingCode
operator|-
literal|1
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|ADD
comment|/* 	 * Attach the interface 	 */
if|if
condition|(
operator|!
name|attached
condition|)
block|{
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|500100
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|ETHER_BPF_SUPPORTED
argument_list|)
expr_stmt|;
else|#
directive|else
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|ar
operator|->
name|lanCardNodeId
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Hardware reset  * reset all setting to default (setted ARLANDGS)  */
end_comment

begin_function
specifier|static
name|void
name|arl_hwreset
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|D
argument_list|(
operator|(
literal|"hw reset\n"
operator|)
argument_list|)
expr_stmt|;
name|ar
operator|->
name|controlRegister
operator|=
literal|1
expr_stmt|;
name|DELAY
argument_list|(
name|ARDELAY1
argument_list|)
expr_stmt|;
if|if
condition|(
name|arl_wait_reset
argument_list|(
name|sc
argument_list|,
literal|0x24
argument_list|,
name|ARDELAY1
argument_list|)
condition|)
name|arl_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ar
operator|->
name|controlRegister
operator|=
operator|(
name|sc
operator|->
name|arl_control
operator|=
literal|1
operator|)
expr_stmt|;
name|DELAY
argument_list|(
name|ARDELAY1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * wait arlan command  */
end_comment

begin_function
specifier|static
name|int
name|arl_command
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
comment|/* long stuppid delay ??? */
name|D
argument_list|(
operator|(
literal|"commandByte %x\n"
operator|,
name|ar
operator|->
name|commandByte
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|100000
init|;
name|ar
operator|->
name|commandByte
operator|&&
name|i
condition|;
name|i
operator|--
control|)
empty_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|ar
operator|->
name|commandByte
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|i
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Enable for recieveng  */
end_comment

begin_function
specifier|static
name|void
name|arl_enable
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|D
argument_list|(
operator|(
literal|"enable\n"
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|arl_control
operator|=
operator|(
name|ARL_INTERRUPT_ENABLE
operator||
name|ARL_CLEAR_INTERRUPT
operator|)
expr_stmt|;
name|ar
operator|->
name|controlRegister
operator|=
name|sc
operator|->
name|arl_control
expr_stmt|;
name|arl_command
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ar
operator|->
name|rxStatusVector
operator|=
literal|0
expr_stmt|;
name|ar
operator|->
name|commandByte
operator|=
literal|0x83
expr_stmt|;
name|ar
operator|->
name|commandParameter
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|ARL_CHANNEL
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|arl_command
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * reset and set user parameters  */
end_comment

begin_function
specifier|static
name|void
name|arl_reset
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|D
argument_list|(
operator|(
literal|"reset\n"
operator|)
argument_list|)
expr_stmt|;
name|arl_hwreset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ar
operator|->
name|resetFlag1
operator|=
literal|1
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|ar
operator|)
argument_list|,
literal|0x1FF0
argument_list|)
expr_stmt|;
comment|/* fill memory board with 0 */
name|ar
operator|->
name|resetFlag1
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|arl_control
operator|=
literal|0
expr_stmt|;
comment|/*	if (arl_wait_reset(sc, 0x168, ARDELAY1)) 		return;  */
if|#
directive|if
literal|1
block|{
name|int
name|cnt
init|=
literal|0x168
decl_stmt|;
name|int
name|delay
init|=
name|ARDELAY1
decl_stmt|;
name|ar
operator|->
name|resetFlag
operator|=
literal|0xFF
expr_stmt|;
comment|/* wish reset */
name|ar
operator|->
name|controlRegister
operator|=
literal|0
expr_stmt|;
comment|/* unreeze - do it */
while|while
condition|(
name|ar
operator|->
name|resetFlag
operator|&&
name|cnt
operator|--
condition|)
name|DELAY
argument_list|(
name|delay
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"arl%d: reset timeout\n"
argument_list|,
name|sc
operator|->
name|arl_unit
argument_list|)
expr_stmt|;
return|return;
block|}
name|D
argument_list|(
operator|(
literal|"reset wait %d\n"
operator|,
literal|0x168
operator|-
name|cnt
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|ar
operator|->
name|diagnosticInfo
operator|!=
literal|0xff
condition|)
block|{
name|printf
argument_list|(
literal|"arl%d: reset error\n"
argument_list|,
name|sc
operator|->
name|arl_unit
argument_list|)
expr_stmt|;
return|return;
block|}
name|arl_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * configure radio parameters  */
end_comment

begin_function
specifier|static
name|void
name|arl_config
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"config\n"
operator|)
argument_list|)
expr_stmt|;
name|SET_ARL_PARAM
argument_list|(
name|spreadingCode
argument_list|)
expr_stmt|;
name|SET_ARL_PARAM
argument_list|(
name|channelNumber
argument_list|)
expr_stmt|;
name|SET_ARL_PARAM
argument_list|(
name|channelSet
argument_list|)
expr_stmt|;
name|SET_ARL_PARAM
argument_list|(
name|registrationMode
argument_list|)
expr_stmt|;
name|SET_ARL_PARAM
argument_list|(
name|priority
argument_list|)
expr_stmt|;
name|SET_ARL_PARAM
argument_list|(
name|receiveMode
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arcfg
operator|.
name|sid
argument_list|,
name|ar
operator|->
name|systemId
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|ar
operator|->
name|systemId
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arcfg
operator|.
name|specifiedRouter
argument_list|,
name|ar
operator|->
name|specifiedRouter
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|arcfg
operator|.
name|lanCardNodeId
argument_list|,
name|ar
operator|->
name|lanCardNodeId
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ar
operator|->
name|name
argument_list|,
name|ARLAN_NAME_SIZE
argument_list|)
expr_stmt|;
comment|/* clear name */
name|strncpy
argument_list|(
name|ar
operator|->
name|name
argument_list|,
name|arcfg
operator|.
name|name
argument_list|,
name|ARLAN_NAME_SIZE
argument_list|)
expr_stmt|;
name|ar
operator|->
name|diagnosticInfo
operator|=
literal|0
expr_stmt|;
name|ar
operator|->
name|commandByte
operator|=
literal|1
expr_stmt|;
name|ARL_CHANNEL
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|ARDELAY1
argument_list|)
expr_stmt|;
if|if
condition|(
name|arl_command
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|D
argument_list|(
operator|(
literal|"config failed\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0x168
init|;
name|ar
operator|->
name|diagnosticInfo
operator|==
literal|0
operator|&&
name|i
condition|;
name|i
operator|--
control|)
name|DELAY
argument_list|(
name|ARDELAY1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|D
argument_list|(
operator|(
literal|"config timeout\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ar
operator|->
name|diagnosticInfo
operator|!=
literal|0xff
condition|)
block|{
name|D
argument_list|(
operator|(
literal|"config error\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|D
argument_list|(
operator|(
literal|"config lanCardNodeId %6D\n"
operator|,
name|ar
operator|->
name|lanCardNodeId
operator|,
literal|":"
operator|)
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"config channel set %d, frequency %d, spread %d, mode %d\n"
operator|,
name|ar
operator|->
name|channelSet
operator|,
name|ar
operator|->
name|channelNumber
operator|,
name|ar
operator|->
name|spreadingCode
operator|,
name|ar
operator|->
name|registrationMode
operator|)
argument_list|)
expr_stmt|;
comment|/* clear quality stat */
name|bzero
argument_list|(
name|sc
operator|->
name|arl_sigcache
argument_list|,
name|MAXARLCACHE
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|arl_sigcache
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Socket Ioctl's.  */
end_comment

begin_function
specifier|static
name|int
name|arl_ioctl
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|ieee80211req
modifier|*
name|ireq
init|=
operator|(
expr|struct
name|ieee80211req
operator|*
operator|)
name|data
decl_stmt|;
name|d_thread_t
modifier|*
name|td
init|=
name|_ARL_CURPROC
decl_stmt|;
name|struct
name|arl_req
name|arlan_io
decl_stmt|;
name|int
name|count
decl_stmt|,
name|s
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|tmpstr
index|[
name|IEEE80211_NWID_LEN
operator|*
literal|2
index|]
decl_stmt|;
name|u_int8_t
modifier|*
name|tmpptr
decl_stmt|;
name|u_int32_t
name|newsid
decl_stmt|;
name|caddr_t
name|user
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"ioctl %lx\n"
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFADDR
case|:
case|case
name|SIOCGIFADDR
case|:
case|case
name|SIOCSIFMTU
case|:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
name|arl_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|arl_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|arl_ifmedia
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCG80211
case|:
switch|switch
condition|(
name|ireq
operator|->
name|i_type
condition|)
block|{
case|case
name|IEEE80211_IOC_SSID
case|:
if|if
condition|(
name|ireq
operator|->
name|i_val
operator|!=
operator|-
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|bzero
argument_list|(
name|tmpstr
argument_list|,
name|IEEE80211_NWID_LEN
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|tmpstr
argument_list|,
name|IEEE80211_NWID_LEN
operator|-
literal|1
argument_list|,
literal|"0x%08x"
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|arcfg
operator|.
name|sid
argument_list|)
expr_stmt|;
name|ireq
operator|->
name|i_len
operator|=
name|IEEE80211_NWID_LEN
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|tmpstr
argument_list|,
name|ireq
operator|->
name|i_data
argument_list|,
name|IEEE80211_NWID_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_IOC_STATIONNAME
case|:
name|ireq
operator|->
name|i_len
operator|=
sizeof|sizeof
argument_list|(
name|arcfg
operator|.
name|name
argument_list|)
expr_stmt|;
name|tmpptr
operator|=
name|arcfg
operator|.
name|name
expr_stmt|;
name|bzero
argument_list|(
name|tmpstr
argument_list|,
name|IEEE80211_NWID_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|tmpptr
argument_list|,
name|tmpstr
argument_list|,
name|ireq
operator|->
name|i_len
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|tmpstr
argument_list|,
name|ireq
operator|->
name|i_data
argument_list|,
name|IEEE80211_NWID_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_IOC_CHANNEL
case|:
name|ireq
operator|->
name|i_val
operator|=
name|arcfg
operator|.
name|channelNumber
expr_stmt|;
break|break;
case|case
name|IEEE80211_IOC_POWERSAVE
case|:
name|ireq
operator|->
name|i_val
operator|=
operator|(
name|arcfg
operator|.
name|registrationMode
operator|==
literal|2
condition|?
name|IEEE80211_POWERSAVE_PSP
else|:
name|IEEE80211_POWERSAVE_OFF
operator|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIOCS80211
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|suser
argument_list|(
name|td
argument_list|)
operator|)
condition|)
break|break;
switch|switch
condition|(
name|ireq
operator|->
name|i_type
condition|)
block|{
case|case
name|IEEE80211_IOC_SSID
case|:
if|if
condition|(
name|ireq
operator|->
name|i_len
operator|>
literal|4
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|bzero
argument_list|(
operator|&
name|newsid
argument_list|,
sizeof|sizeof
argument_list|(
name|newsid
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|ireq
operator|->
name|i_data
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|(
operator|&
name|newsid
operator|)
operator|+
literal|4
operator|-
name|ireq
operator|->
name|i_len
argument_list|,
name|ireq
operator|->
name|i_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|newsid
operator|=
name|htonl
argument_list|(
name|newsid
argument_list|)
expr_stmt|;
if|if
condition|(
name|newsid
operator|<
literal|0
operator|||
name|newsid
operator|%
literal|2
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
operator|&
name|newsid
argument_list|,
name|arcfg
operator|.
name|sid
argument_list|,
sizeof|sizeof
argument_list|(
name|arcfg
operator|.
name|sid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_IOC_STATIONNAME
case|:
if|if
condition|(
name|ireq
operator|->
name|i_len
operator|>
name|ARLAN_NAME_SIZE
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|bzero
argument_list|(
name|arcfg
operator|.
name|name
argument_list|,
name|ARLAN_NAME_SIZE
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|ireq
operator|->
name|i_data
argument_list|,
name|arcfg
operator|.
name|name
argument_list|,
name|ireq
operator|->
name|i_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_IOC_CHANNEL
case|:
if|if
condition|(
name|ireq
operator|->
name|i_val
operator|<
literal|0
operator|||
name|ireq
operator|->
name|i_val
operator|>
literal|5
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|arcfg
operator|.
name|channelNumber
operator|=
name|ireq
operator|->
name|i_val
expr_stmt|;
break|break;
case|case
name|IEEE80211_IOC_POWERSAVE
case|:
switch|switch
condition|(
name|ireq
operator|->
name|i_val
condition|)
block|{
case|case
name|IEEE80211_POWERSAVE_OFF
case|:
if|if
condition|(
name|arcfg
operator|.
name|registrationMode
operator|==
literal|2
condition|)
name|arcfg
operator|.
name|registrationMode
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IEEE80211_POWERSAVE_ON
case|:
case|case
name|IEEE80211_POWERSAVE_PSP
case|:
name|arcfg
operator|.
name|registrationMode
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|error
condition|)
name|arl_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
define|#
directive|define
name|GET_PARAM
parameter_list|(
name|name
parameter_list|)
value|(arlan_io.cfg.name = arcfg.name)
define|#
directive|define
name|GET_COPY_PARAM
parameter_list|(
name|name
parameter_list|)
define|\
value|{								\ 		bzero(arlan_io.cfg.name, sizeof(arlan_io.cfg.name));	\ 		bcopy(arcfg.name, arlan_io.cfg.name, sizeof(arlan_io.cfg.name)); \ 	}
case|case
name|SIOCGARLALL
case|:
name|bzero
argument_list|(
operator|&
name|arlan_io
argument_list|,
sizeof|sizeof
argument_list|(
name|arlan_io
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|suser
argument_list|(
name|td
argument_list|)
condition|)
block|{
name|bcopy
argument_list|(
name|ar
operator|->
name|systemId
argument_list|,
name|arlan_io
operator|.
name|cfg
operator|.
name|sid
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|GET_COPY_PARAM
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|GET_COPY_PARAM
argument_list|(
name|lanCardNodeId
argument_list|)
expr_stmt|;
name|GET_COPY_PARAM
argument_list|(
name|specifiedRouter
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|channelNumber
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|channelSet
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|spreadingCode
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|registrationMode
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|hardwareType
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|majorHardwareVersion
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|minorHardwareVersion
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|radioModule
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|priority
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|receiveMode
argument_list|)
expr_stmt|;
name|GET_PARAM
argument_list|(
name|txRetry
argument_list|)
expr_stmt|;
name|user
operator|=
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
sizeof|sizeof
argument_list|(
name|arlan_io
argument_list|)
condition|;
name|count
operator|++
control|)
if|if
condition|(
name|subyte
argument_list|(
name|user
operator|+
name|count
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|arlan_io
operator|)
index|[
name|count
index|]
argument_list|)
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
break|break;
define|#
directive|define
name|SET_PARAM
parameter_list|(
name|name
parameter_list|)
define|\
value|do {								\ 		if (arlan_io.what_set& ARLAN_SET_##name)		\ 			arcfg.name = arlan_io.cfg.name;			\ 	} while (0)
define|#
directive|define
name|SET_COPY_PARAM
parameter_list|(
name|name
parameter_list|)
define|\
value|do {								\ 		if (arlan_io.what_set& ARLAN_SET_##name) {		\ 			bzero(arcfg.name, sizeof(arcfg.name));		\ 			bcopy(arlan_io.cfg.name, arcfg.name, sizeof(arcfg.name)); \ 		}							\ 	} while (0)
case|case
name|SIOCSARLALL
case|:
if|if
condition|(
name|suser
argument_list|(
name|td
argument_list|)
condition|)
break|break;
name|user
operator|=
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
sizeof|sizeof
argument_list|(
name|arlan_io
argument_list|)
condition|;
name|count
operator|++
control|)
block|{
if|if
condition|(
name|fubyte
argument_list|(
name|user
operator|+
name|count
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
block|}
name|bcopy
argument_list|(
name|user
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|arlan_io
argument_list|,
sizeof|sizeof
argument_list|(
name|arlan_io
argument_list|)
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"need set 0x%04x\n"
operator|,
name|arlan_io
operator|.
name|what_set
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|arlan_io
operator|.
name|what_set
condition|)
block|{
name|SET_COPY_PARAM
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|SET_COPY_PARAM
argument_list|(
name|sid
argument_list|)
expr_stmt|;
name|SET_COPY_PARAM
argument_list|(
name|specifiedRouter
argument_list|)
expr_stmt|;
name|SET_COPY_PARAM
argument_list|(
name|lanCardNodeId
argument_list|)
expr_stmt|;
name|SET_PARAM
argument_list|(
name|channelSet
argument_list|)
expr_stmt|;
name|SET_PARAM
argument_list|(
name|channelNumber
argument_list|)
expr_stmt|;
name|SET_PARAM
argument_list|(
name|spreadingCode
argument_list|)
expr_stmt|;
name|SET_PARAM
argument_list|(
name|registrationMode
argument_list|)
expr_stmt|;
name|SET_PARAM
argument_list|(
name|priority
argument_list|)
expr_stmt|;
name|SET_PARAM
argument_list|(
name|receiveMode
argument_list|)
expr_stmt|;
name|SET_PARAM
argument_list|(
name|txRetry
argument_list|)
expr_stmt|;
name|arl_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|SET_COPY_PARAM
undef|#
directive|undef
name|SET_PARAM
undef|#
directive|undef
name|GET_COPY_PARAM
undef|#
directive|undef
name|GET_PARAM
break|break;
ifdef|#
directive|ifdef
name|ARLCACHE
case|case
name|SIOCGARLQLT
case|:
name|user
operator|=
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|arl_sigcache
argument_list|)
condition|;
name|count
operator|++
control|)
block|{
if|if
condition|(
name|fubyte
argument_list|(
name|user
operator|+
name|count
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
block|}
while|while
condition|(
name|ar
operator|->
name|interruptInProgress
condition|)
empty_stmt|;
comment|/* wait */
name|bcopy
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|arl_sigcache
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|arl_sigcache
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|SIOCGARLSTB
case|:
name|user
operator|=
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|arl_stats
argument_list|)
condition|;
name|count
operator|++
control|)
block|{
if|if
condition|(
name|fubyte
argument_list|(
name|user
operator|+
name|count
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|EFAULT
operator|)
return|;
block|}
while|while
condition|(
name|ar
operator|->
name|lancpuLock
condition|)
empty_stmt|;
name|ar
operator|->
name|hostcpuLock
operator|=
literal|1
expr_stmt|;
name|bcopy
argument_list|(
operator|&
operator|(
name|ar
operator|->
name|stat
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|arl_stats
argument_list|)
argument_list|)
expr_stmt|;
name|ar
operator|->
name|hostcpuLock
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Wait registration  */
end_comment

begin_function
specifier|static
name|void
name|arl_waitreg
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"wait reg\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
name|ARL_CHECKREG
argument_list|(
name|sc
argument_list|)
condition|)
block|{
comment|/* wait registration */
name|D
argument_list|(
operator|(
literal|"wait registration\n"
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|arl_waitreg
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
comment|/* registration restored */
name|D
argument_list|(
operator|(
literal|"registration restored\n"
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|arl_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Handle transmit timeouts.  */
end_comment

begin_function
specifier|static
name|void
name|arl_watchdog
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
name|D
argument_list|(
operator|(
literal|"device timeout\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ARL_CHECKREG
argument_list|(
name|sc
argument_list|)
condition|)
block|{
comment|/* Lost registratoin */
name|D
argument_list|(
operator|(
literal|"timeout lost registration\n"
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|arl_waitreg
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Initialize  */
end_comment

begin_function
specifier|static
name|void
name|arl_init
parameter_list|(
name|xsc
parameter_list|)
name|void
modifier|*
name|xsc
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|arl_ifp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|D
argument_list|(
operator|(
literal|"init\n"
operator|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
if|if
condition|(
name|ARL_CHECKREG
argument_list|(
name|sc
argument_list|)
condition|)
name|arl_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|arl_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* set flags */
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|arl_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"init done\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Put buffer into arlan buffer and start transmit  */
end_comment

begin_function
specifier|static
name|void
name|arl_put
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|arl_tx_param
name|txp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ARL_CHECKREG
argument_list|(
name|sc
argument_list|)
condition|)
name|sc
operator|->
name|arl_ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
comment|/* copy dst adr */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|txp
operator|.
name|dest
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|arl_tx
index|[
name|i
index|]
expr_stmt|;
name|txp
operator|.
name|clear
operator|=
literal|0
expr_stmt|;
name|txp
operator|.
name|retries
operator|=
name|arcfg
operator|.
name|txRetry
expr_stmt|;
comment|/* use default value */
name|txp
operator|.
name|routing
operator|=
literal|1
expr_stmt|;
name|txp
operator|.
name|scrambled
operator|=
literal|0
expr_stmt|;
name|txp
operator|.
name|offset
operator|=
operator|(
name|intptr_t
operator|)
name|ar
operator|->
name|txBuffer
operator|-
call|(
name|intptr_t
call|)
argument_list|(
name|ar
argument_list|)
expr_stmt|;
name|txp
operator|.
name|length
operator|=
name|sc
operator|->
name|tx_len
operator|-
name|ARLAN_HEADER_SIZE
expr_stmt|;
ifdef|#
directive|ifdef
name|SEND_ARLAN_HEADER
if|if
condition|(
name|ar
operator|->
name|registrationMode
operator|!=
literal|1
condition|)
name|txp
operator|.
name|length
operator|=
name|sc
operator|->
name|tx_len
expr_stmt|;
endif|#
directive|endif
comment|/* copy from internal buffer to adapter memory */
ifdef|#
directive|ifdef
name|SEND_ARLAN_HEADER
if|if
condition|(
name|ar
operator|->
name|registrationMode
condition|)
endif|#
directive|endif
name|bcopy
argument_list|(
name|sc
operator|->
name|arl_tx
operator|+
name|ARLAN_HEADER_SIZE
argument_list|,
name|ar
operator|->
name|txBuffer
argument_list|,
name|sc
operator|->
name|tx_len
operator|-
name|ARLAN_HEADER_SIZE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SEND_ARLAN_MODE
else|else
name|bcopy
argument_list|(
name|sc
operator|->
name|arl_tx
argument_list|,
name|ar
operator|->
name|txBuffer
argument_list|,
name|sc
operator|->
name|tx_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* copy command parametr */
name|bcopy
argument_list|(
operator|&
name|txp
argument_list|,
name|ar
operator|->
name|commandParameter
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|ar
operator|->
name|commandByte
operator|=
literal|0x85
expr_stmt|;
comment|/* send command */
name|ARL_CHANNEL
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|arl_command
argument_list|(
name|sc
argument_list|)
condition|)
name|sc
operator|->
name|arl_ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * start output  */
end_comment

begin_function
specifier|static
name|void
name|arl_start
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
init|=
name|NULL
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"start\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* Don't do anything if output is active */
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
condition|)
return|return;
comment|/* Dequeue the next datagram */
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
comment|/* If there's nothing to send, return. */
if|if
condition|(
name|m0
operator|!=
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
comment|/* Copy the datagram to the buffer. */
name|sc
operator|->
name|tx_len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|m
operator|=
name|m0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|==
literal|0
condition|)
continue|continue;
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|sc
operator|->
name|arl_tx
operator|+
name|sc
operator|->
name|tx_len
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_len
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
comment|/* if packet size is less than minimum ethernet frame size, 		 * pad it with zeroes to that size */
if|if
condition|(
name|sc
operator|->
name|tx_len
operator|<
name|ETHER_MIN_LEN
condition|)
block|{
name|bzero
argument_list|(
name|sc
operator|->
name|arl_tx
operator|+
name|sc
operator|->
name|tx_len
argument_list|,
name|ETHER_MIN_LEN
operator|-
name|sc
operator|->
name|tx_len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_len
operator|=
name|ETHER_MIN_LEN
expr_stmt|;
block|}
comment|/* Give the packet to the bpf, if any */
name|BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
comment|/* Now transmit the datagram */
name|ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
comment|/* wait 1 sec */
name|ifp
operator|->
name|if_watchdog
operator|=
name|arl_watchdog
expr_stmt|;
name|arl_put
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * stop interface  */
end_comment

begin_function
name|void
name|arl_stop
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|arl_ifp
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
comment|/* disable timer */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
comment|/*  arl_hwreset(unit);  */
name|sc
operator|->
name|rx_len
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_len
operator|=
literal|0
expr_stmt|;
comment|/* disable interrupt */
name|ar
operator|->
name|controlRegister
operator|=
literal|0
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Pull read data off a interface.  * Len is length of data, with local net header stripped.  */
end_comment

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|arl_get
parameter_list|(
name|buf
parameter_list|,
name|totlen
parameter_list|,
name|off0
parameter_list|,
name|ifp
parameter_list|)
name|caddr_t
name|buf
decl_stmt|;
name|int
name|totlen
decl_stmt|;
name|int
name|off0
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|mbuf
modifier|*
name|top
decl_stmt|,
modifier|*
modifier|*
name|mp
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|int
name|off
init|=
name|off0
decl_stmt|,
name|len
decl_stmt|;
name|caddr_t
name|cp
init|=
name|buf
decl_stmt|;
name|char
modifier|*
name|epkt
decl_stmt|;
name|cp
operator|=
name|buf
expr_stmt|;
name|epkt
operator|=
name|cp
operator|+
name|totlen
expr_stmt|;
if|if
condition|(
name|off
condition|)
block|{
name|cp
operator|+=
name|off
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
expr_stmt|;
name|totlen
operator|-=
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
expr_stmt|;
block|}
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|totlen
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|MHLEN
expr_stmt|;
name|top
operator|=
literal|0
expr_stmt|;
name|mp
operator|=
operator|&
name|top
expr_stmt|;
while|while
condition|(
name|totlen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|top
condition|)
block|{
name|MGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|top
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|m
operator|->
name|m_len
operator|=
name|MLEN
expr_stmt|;
block|}
name|len
operator|=
name|min
argument_list|(
name|totlen
argument_list|,
name|epkt
operator|-
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|MINCLSIZE
condition|)
block|{
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
condition|)
name|m
operator|->
name|m_len
operator|=
name|len
operator|=
name|min
argument_list|(
name|len
argument_list|,
name|MCLBYTES
argument_list|)
expr_stmt|;
else|else
name|len
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 *			  * Place initial small packet/header at end of mbuf. 			 *						   */
if|if
condition|(
name|len
operator|<
name|m
operator|->
name|m_len
condition|)
block|{
if|if
condition|(
name|top
operator|==
literal|0
operator|&&
name|len
operator|+
name|max_linkhdr
operator|<=
name|m
operator|->
name|m_len
condition|)
name|m
operator|->
name|m_data
operator|+=
name|max_linkhdr
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
block|}
else|else
name|len
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|cp
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
operator|(
name|unsigned
operator|)
name|len
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|len
expr_stmt|;
operator|*
name|mp
operator|=
name|m
expr_stmt|;
name|mp
operator|=
operator|&
name|m
operator|->
name|m_next
expr_stmt|;
name|totlen
operator|-=
name|len
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|epkt
condition|)
name|cp
operator|=
name|buf
expr_stmt|;
block|}
return|return
operator|(
name|top
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ------------------------------------------------------------------  *  * Pass a packet up to the higher levels.  *   */
end_comment

begin_function
specifier|static
name|void
name|arl_read
parameter_list|(
name|sc
parameter_list|,
name|buf
parameter_list|,
name|len
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
name|caddr_t
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
specifier|register
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|arl_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|eh
operator|=
operator|(
expr|struct
name|ether_header
operator|*
operator|)
name|buf
expr_stmt|;
comment|/* 	 * Check if there's a bpf filter listening on this interface. 	 * If so, hand off the raw packet to bpf. 	 */
if|if
condition|(
name|bpf_peers_present
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|)
condition|)
block|{
comment|/* 		 * Note that the interface cannot be in promiscuous mode if 		 * there are no bpf listeners.  And if el are in promiscuous 		 * mode, el have to check if this packet is really ours. 		 * 		 * This test does not support multicasts. 		 */
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
operator|&&
name|bcmp
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|IFP2ENADDR
argument_list|(
name|sc
operator|->
name|arl_ifp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|)
argument_list|)
operator|!=
literal|0
operator|&&
name|bcmp
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|BROADCASTADDR
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
return|return;
block|}
comment|/* 	 * Pull packet off interface. 	 */
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|500100
name|buf
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|m
operator|=
name|arl_get
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
return|return;
ifdef|#
directive|ifdef
name|ARLCACHE
name|arl_cache_store
argument_list|(
name|sc
argument_list|,
name|eh
argument_list|,
name|ar
operator|->
name|rxQuality
operator|&
literal|0x0f
argument_list|,
operator|(
name|ar
operator|->
name|rxQuality
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
argument_list|,
name|ARLCACHE_RX
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|500100
name|ether_input
argument_list|(
name|ifp
argument_list|,
name|eh
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|#
directive|else
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * get packet from adapter  */
end_comment

begin_function
specifier|static
name|void
name|arl_recv
parameter_list|(
name|sc
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|sc
operator|->
name|rx_len
operator|=
name|ar
operator|->
name|rxLength
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rx_len
condition|)
block|{
ifdef|#
directive|ifdef
name|SEND_ARLAN_HEADER
if|if
condition|(
name|ar
operator|->
name|registrationMode
operator|==
literal|1
condition|)
block|{
endif|#
directive|endif
name|bcopy
argument_list|(
name|ar
operator|->
name|ultimateDestAddress
argument_list|,
name|sc
operator|->
name|arl_rx
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ar
operator|->
name|rxSrc
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sc
operator|->
name|arl_rx
operator|+
literal|6
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ar
operator|)
operator|+
name|ar
operator|->
name|rxOffset
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sc
operator|->
name|arl_rx
operator|+
literal|12
argument_list|,
name|sc
operator|->
name|rx_len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_len
operator|+=
name|ARLAN_HEADER_SIZE
expr_stmt|;
ifdef|#
directive|ifdef
name|SEND_ARLAN_HEADER
block|}
else|else
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ar
operator|)
operator|+
name|ar
operator|->
name|rxOffset
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sc
operator|->
name|arl_rx
argument_list|,
name|sc
operator|->
name|rx_len
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
end_function

begin_comment
comment|/*  * Ethernet interface interrupt processor  */
end_comment

begin_function
name|void
name|arl_intr
parameter_list|(
name|arg
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
block|{
specifier|register
name|struct
name|arl_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|arl_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|arl_ifp
decl_stmt|;
comment|/* enable interrupt */
name|ar
operator|->
name|controlRegister
operator|=
operator|(
name|sc
operator|->
name|arl_control
operator|&
operator|~
name|ARL_CLEAR_INTERRUPT
operator|)
expr_stmt|;
name|ar
operator|->
name|controlRegister
operator|=
operator|(
name|sc
operator|->
name|arl_control
operator||
name|ARL_CLEAR_INTERRUPT
operator|)
expr_stmt|;
if|if
condition|(
name|ar
operator|->
name|txStatusVector
condition|)
block|{
if|if
condition|(
name|ar
operator|->
name|txStatusVector
operator|!=
literal|1
condition|)
name|sc
operator|->
name|arl_ifp
operator|->
name|if_collisions
operator|++
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
comment|/* disable timer */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|arl_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ar
operator|->
name|txStatusVector
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|ARLCACHE
name|arl_cache_store
argument_list|(
name|sc
argument_list|,
operator|(
expr|struct
name|ether_header
operator|*
operator|)
operator|(
name|sc
operator|->
name|arl_tx
operator|)
argument_list|,
name|ar
operator|->
name|txAckQuality
operator|&
literal|0x0f
argument_list|,
operator|(
name|ar
operator|->
name|txAckQuality
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
argument_list|,
name|ARLCACHE_TX
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|ar
operator|->
name|rxStatusVector
condition|)
block|{
if|if
condition|(
name|ar
operator|->
name|rxStatusVector
operator|==
literal|1
condition|)
block|{
comment|/* it is data frame */
name|arl_recv
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|arl_read
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|arl_rx
argument_list|,
name|sc
operator|->
name|rx_len
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
name|ar
operator|->
name|rxStatusVector
operator|=
literal|0
expr_stmt|;
name|ar
operator|->
name|commandByte
operator|=
literal|0x83
expr_stmt|;
name|ar
operator|->
name|commandParameter
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|ARL_CHANNEL
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|arl_command
argument_list|(
name|sc
argument_list|)
condition|)
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * waiting for resetFlag dropped  */
end_comment

begin_function
name|int
name|arl_wait_reset
parameter_list|(
name|sc
parameter_list|,
name|cnt
parameter_list|,
name|delay
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|cnt
decl_stmt|;
name|int
name|delay
decl_stmt|;
block|{
name|D
argument_list|(
operator|(
literal|"wait_reset cnt=%d delay=%d\n"
operator|,
name|cnt
operator|,
name|delay
operator|)
argument_list|)
expr_stmt|;
name|ar
operator|->
name|resetFlag
operator|=
literal|1
expr_stmt|;
comment|/* wish reset */
name|ar
operator|->
name|controlRegister
operator|=
literal|0
expr_stmt|;
comment|/* unreeze - do it */
while|while
condition|(
name|ar
operator|->
name|resetFlag
operator|&&
name|cnt
operator|--
condition|)
name|DELAY
argument_list|(
name|delay
argument_list|)
expr_stmt|;
name|D
argument_list|(
operator|(
literal|"reset done. %d cycles left\n"
operator|,
name|cnt
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"arl%d: reset failed\n"
argument_list|,
name|sc
operator|->
name|arl_unit
argument_list|)
expr_stmt|;
return|return
operator|(
name|cnt
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allocate an irq resource with the given resource id  */
end_comment

begin_function
name|int
name|arl_alloc_irq
parameter_list|(
name|dev
parameter_list|,
name|rid
parameter_list|,
name|flags
parameter_list|)
name|device_t
name|dev
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|int
name|flags
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
name|res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
operator|(
name|RF_ACTIVE
operator||
name|flags
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|sc
operator|->
name|irq_rid
operator|=
name|rid
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|res
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allocate an memory resource with the given resource id  */
end_comment

begin_function
name|int
name|arl_alloc_memory
parameter_list|(
name|dev
parameter_list|,
name|rid
parameter_list|,
name|size
parameter_list|)
name|device_t
name|dev
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|int
name|size
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
name|res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0ul
argument_list|,
operator|~
literal|0ul
argument_list|,
name|size
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|sc
operator|->
name|mem_rid
operator|=
name|rid
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|res
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Release all resources  */
end_comment

begin_function
name|void
name|arl_release_resources
parameter_list|(
name|dev
parameter_list|)
name|device_t
name|dev
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|mem_rid
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|irq_res
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irq_rid
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|ARLCACHE
end_ifdef

begin_function
specifier|static
name|void
name|arl_cache_store
parameter_list|(
name|sc
parameter_list|,
name|eh
parameter_list|,
name|level
parameter_list|,
name|quality
parameter_list|,
name|dir
parameter_list|)
name|struct
name|arl_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|u_int8_t
name|level
decl_stmt|;
name|u_int8_t
name|quality
decl_stmt|;
name|int
name|dir
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
specifier|static
name|int
name|cache_slot
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|wrapindex
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|zero
index|[
literal|6
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|u_char
modifier|*
name|mac
decl_stmt|;
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|eh
operator|->
name|ether_type
argument_list|)
operator|!=
name|ETHERTYPE_IP
operator|)
condition|)
block|{
return|return;
block|}
name|mac
operator|=
operator|(
name|dir
operator|==
name|ARLCACHE_RX
condition|?
name|eh
operator|->
name|ether_shost
else|:
name|eh
operator|->
name|ether_dhost
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXARLCACHE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|bcmp
argument_list|(
name|zero
argument_list|,
name|sc
operator|->
name|arl_sigcache
index|[
name|i
index|]
operator|.
name|macsrc
argument_list|,
literal|6
argument_list|)
operator|||
operator|!
name|bcmp
argument_list|(
name|mac
argument_list|,
name|sc
operator|->
name|arl_sigcache
index|[
name|i
index|]
operator|.
name|macsrc
argument_list|,
literal|6
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|<
name|MAXARLCACHE
condition|)
name|cache_slot
operator|=
name|i
expr_stmt|;
else|else
block|{
if|if
condition|(
name|wrapindex
operator|==
name|MAXARLCACHE
condition|)
name|wrapindex
operator|=
literal|0
expr_stmt|;
name|cache_slot
operator|=
name|wrapindex
operator|++
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|dir
operator|==
name|ARLCACHE_RX
condition|?
name|eh
operator|->
name|ether_shost
else|:
name|eh
operator|->
name|ether_dhost
argument_list|,
name|sc
operator|->
name|arl_sigcache
index|[
name|cache_slot
index|]
operator|.
name|macsrc
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|sc
operator|->
name|arl_sigcache
index|[
name|cache_slot
index|]
operator|.
name|level
index|[
name|dir
index|]
operator|=
name|level
expr_stmt|;
name|sc
operator|->
name|arl_sigcache
index|[
name|cache_slot
index|]
operator|.
name|quality
index|[
name|dir
index|]
operator|=
name|quality
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|arl_media_change
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|otype
init|=
name|arcfg
operator|.
name|registrationMode
decl_stmt|;
name|int
name|orate
init|=
name|arcfg
operator|.
name|spreadingCode
decl_stmt|;
name|int
name|nrate
decl_stmt|,
name|i
decl_stmt|;
name|nrate
operator|=
name|IFM_SUBTYPE
argument_list|(
name|sc
operator|->
name|arl_ifmedia
operator|.
name|ifm_cur
operator|->
name|ifm_media
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rate2media
index|[
name|i
operator|-
literal|1
index|]
operator|==
name|nrate
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|5
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|arcfg
operator|.
name|spreadingCode
operator|=
name|i
expr_stmt|;
comment|/* XXX Need fix for PSP mode */
if|if
condition|(
operator|(
name|sc
operator|->
name|arl_ifmedia
operator|.
name|ifm_cur
operator|->
name|ifm_media
operator|&
name|IFM_IEEE80211_ADHOC
operator|)
operator|!=
literal|0
condition|)
name|arcfg
operator|.
name|registrationMode
operator|=
literal|0
expr_stmt|;
else|else
name|arcfg
operator|.
name|registrationMode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|otype
operator|!=
name|arcfg
operator|.
name|registrationMode
operator|||
name|orate
operator|!=
name|arcfg
operator|.
name|spreadingCode
condition|)
name|arl_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|arl_media_status
parameter_list|(
name|ifp
parameter_list|,
name|imr
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmediareq
modifier|*
name|imr
decl_stmt|;
block|{
name|struct
name|arl_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|imr
operator|->
name|ifm_active
operator|=
name|IFM_IEEE80211
expr_stmt|;
if|if
condition|(
name|arcfg
operator|.
name|registrationMode
operator|==
literal|0
condition|)
name|imr
operator|->
name|ifm_active
operator||=
name|IFM_IEEE80211_ADHOC
expr_stmt|;
name|imr
operator|->
name|ifm_active
operator||=
name|IFM_MAKEWORD
argument_list|(
name|IFM_IEEE80211
argument_list|,
name|rate2media
index|[
name|arcfg
operator|.
name|spreadingCode
operator|-
literal|1
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|imr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
if|if
condition|(
operator|!
name|ARL_CHECKREG
argument_list|(
name|sc
argument_list|)
condition|)
name|imr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
block|}
end_function

end_unit


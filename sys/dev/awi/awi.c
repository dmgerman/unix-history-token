begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: awi.c,v 1.12 2000/03/23 05:26:00 mycroft Exp $	*/
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2000 The NetBSD Foundation, Inc.  * All rights reserved.  *  * This code is derived from software contributed to The NetBSD Foundation  * by Atsushi Onoe.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the NetBSD  *	Foundation, Inc. and its contributors.  * 4. Neither the name of The NetBSD Foundation nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Driver for AMD 802.11 PCnetMobile firmware.  * Uses am79c930 chip driver to talk to firmware running on the am79c930.  *  * The awi device driver first appeared in NetBSD 1.5.  *  * The initial version of the driver was written by  * Bill Sommerfeld<sommerfeld@netbsd.org>.  * Then the driver module completely rewritten to support cards with DS phy  * and to support adhoc mode by Atsushi Onoe<onoe@netbsd.org>  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_ns.h"
end_include

begin_include
include|#
directive|include
file|"bpfilter.h"
end_include

begin_include
include|#
directive|include
file|"rnd.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_if
if|#
directive|if
name|__FreeBSD__
operator|>=
literal|3
end_if

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|__FreeBSD__
operator|>=
literal|4
end_if

begin_define
define|#
directive|define
name|NBPFILTER
value|1
end_define

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"bpfilter.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD__
operator|>=
literal|4
end_if

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|NRND
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/rnd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<net/if_ether.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net/if_ieee80211.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<netinet/if_inarp.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|NS
end_ifdef

begin_include
include|#
directive|include
file|<netns/ns.h>
end_include

begin_include
include|#
directive|include
file|<netns/ns_if.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/bpfdesc.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/ic/am79c930reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/am79c930var.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/awireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/awivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/awictl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/awi/am79c930reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/awi/am79c930var.h>
end_include

begin_include
include|#
directive|include
file|<dev/awi/awireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/awi/awivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/awi/awictl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|awi_ioctl
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|,
name|u_long
name|cmd
operator|,
name|caddr_t
name|data
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|IFM_IEEE80211
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|awi_media_rate2opt
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
name|int
name|rate
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_media_opt2rate
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
name|int
name|opt
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_media_change
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_media_status
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|,
expr|struct
name|ifmediareq
operator|*
name|imr
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|awi_drvget
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|,
name|u_long
name|cmd
operator|,
name|caddr_t
name|data
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_drvset
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|,
name|u_long
name|cmd
operator|,
name|caddr_t
name|data
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_init
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_stop
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_watchdog
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_start
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_txint
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mbuf
modifier|*
name|awi_fix_txhdr
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
expr|struct
name|mbuf
operator|*
name|m0
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mbuf
modifier|*
name|awi_fix_rxhdr
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
expr|struct
name|mbuf
operator|*
name|m0
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_input
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
expr|struct
name|mbuf
operator|*
name|m
operator|,
name|u_int32_t
name|rxts
operator|,
name|u_int8_t
name|rssi
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_rxint
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|mbuf
modifier|*
name|awi_devget
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
name|u_int32_t
name|off
operator|,
name|u_int16_t
name|len
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_init_hw
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_init_mibs
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_init_txrx
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_stop_txrx
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_init_region
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_start_scan
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_next_scan
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_stop_scan
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_recv_beacon
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
expr|struct
name|mbuf
operator|*
name|m0
operator|,
name|u_int32_t
name|rxts
operator|,
name|u_int8_t
name|rssi
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_set_ss
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_try_sync
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_sync_done
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_send_deauth
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_send_auth
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_recv_auth
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
expr|struct
name|mbuf
operator|*
name|m0
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_send_asreq
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
name|int
name|reassoc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_recv_asresp
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
expr|struct
name|mbuf
operator|*
name|m0
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_mib
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
name|u_int8_t
name|cmd
operator|,
name|u_int8_t
name|mib
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_cmd_scan
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_cmd
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
name|u_int8_t
name|cmd
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_cmd_done
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_next_txd
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
name|int
name|len
operator|,
name|u_int32_t
operator|*
name|framep
operator|,
name|u_int32_t
operator|*
name|ntxdp
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_lock
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_unlock
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_intr_lock
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|awi_intr_unlock
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_cmd_wait
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|AWI_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|void
name|awi_dump_pkt
name|__P
argument_list|(
operator|(
expr|struct
name|awi_softc
operator|*
name|sc
operator|,
expr|struct
name|mbuf
operator|*
name|m
operator|,
name|u_int8_t
name|rssi
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|awi_verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|awi_dump
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AWI_DUMP_MASK
parameter_list|(
name|fc0
parameter_list|)
value|(1<< (((fc0)& IEEE80211_FC0_SUBTYPE_MASK)>> 4))
end_define

begin_decl_stmt
name|int
name|awi_dump_mask
init|=
name|AWI_DUMP_MASK
argument_list|(
name|IEEE80211_FC0_SUBTYPE_BEACON
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|awi_dump_hdr
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|awi_dump_len
init|=
literal|28
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
end_if

begin_define
define|#
directive|define
name|AWI_BPF_NORM
value|0
end_define

begin_define
define|#
directive|define
name|AWI_BPF_RAW
value|1
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_define
define|#
directive|define
name|AWI_BPF_MTAP
parameter_list|(
name|sc
parameter_list|,
name|m
parameter_list|,
name|raw
parameter_list|)
value|do {					\ 	if ((sc)->sc_ifp->if_bpf&& (sc)->sc_rawbpf == (raw))		\ 		bpf_mtap((sc)->sc_ifp, (m));				\ } while (0);
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|AWI_BPF_MTAP
parameter_list|(
name|sc
parameter_list|,
name|m
parameter_list|,
name|raw
parameter_list|)
value|do {					\ 	if ((sc)->sc_ifp->if_bpf&& (sc)->sc_rawbpf == (raw))		\ 		bpf_mtap((sc)->sc_ifp->if_bpf, (m));			\ } while (0);
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|AWI_BPF_MTAP
parameter_list|(
name|sc
parameter_list|,
name|m
parameter_list|,
name|raw
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|llc_snap
end_ifndef

begin_define
define|#
directive|define
name|llc_snap
value|llc_un.type_snap
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_if
if|#
directive|if
name|__FreeBSD__
operator|>=
literal|4
end_if

begin_decl_stmt
name|devclass_t
name|awi_devclass
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NetBSD compatible functions  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ether_sprintf
name|__P
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|ether_sprintf
parameter_list|(
name|enaddr
parameter_list|)
name|u_int8_t
modifier|*
name|enaddr
decl_stmt|;
block|{
specifier|static
name|char
name|strbuf
index|[
literal|18
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|strbuf
argument_list|,
literal|"%6D"
argument_list|,
name|enaddr
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
return|return
name|strbuf
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|awi_attach
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
ifdef|#
directive|ifdef
name|IFM_IEEE80211
name|int
name|i
decl_stmt|;
name|u_int8_t
modifier|*
name|phy_rates
decl_stmt|;
name|int
name|mword
decl_stmt|;
name|struct
name|ifmediareq
name|imr
decl_stmt|;
endif|#
directive|endif
name|int
name|s
decl_stmt|;
name|int
name|error
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
comment|/* 	 * Even if we can sleep in initialization state, 	 * all other processes (e.g. ifconfig) have to wait for 	 * completion of attaching interface. 	 */
name|sc
operator|->
name|sc_busy
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_INIT
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init_hw
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|sc
operator|->
name|sc_invalid
operator|=
literal|1
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|error
operator|=
name|awi_init_mibs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|sc
operator|->
name|sc_invalid
operator|=
literal|1
expr_stmt|;
return|return
name|error
return|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|awi_start
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|awi_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|awi_watchdog
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
ifdef|#
directive|ifdef
name|IFF_NOTRAILERS
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_NOTRAILERS
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|__NetBSD__
name|memcpy
argument_list|(
name|ifp
operator|->
name|if_xname
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|__FreeBSD__
name|ifp
operator|->
name|if_output
operator|=
name|ether_output
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|ifqmaxlen
expr_stmt|;
name|memcpy
argument_list|(
name|sc
operator|->
name|sc_ec
operator|.
name|ac_enaddr
argument_list|,
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aMAC_Address
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"%s: IEEE802.11 (%s %dMbps) address %s\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|?
literal|"FH"
else|:
literal|"DS"
argument_list|,
name|sc
operator|->
name|sc_tx_rate
operator|/
literal|10
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aMAC_Address
argument_list|)
argument_list|)
expr_stmt|;
name|if_attach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|ether_ifattach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
name|bpfattach
argument_list|(
name|ifp
argument_list|,
name|DLT_EN10MB
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aMAC_Address
argument_list|)
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
name|bpfattach
argument_list|(
operator|&
name|ifp
operator|->
name|if_bpf
argument_list|,
name|ifp
argument_list|,
name|DLT_EN10MB
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|IFM_IEEE80211
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_media
argument_list|,
literal|0
argument_list|,
name|awi_media_change
argument_list|,
name|awi_media_status
argument_list|)
expr_stmt|;
name|phy_rates
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aSuprt_Data_Rates
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|phy_rates
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
name|mword
operator|=
name|awi_media_rate2opt
argument_list|(
name|sc
argument_list|,
name|AWI_80211_RATE
argument_list|(
name|phy_rates
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mword
operator|==
literal|0
condition|)
continue|continue;
name|mword
operator||=
name|IFM_IEEE80211
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_media
argument_list|,
name|mword
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_media
argument_list|,
name|mword
operator||
name|IFM_IEEE80211_ADHOC
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|sc_media
argument_list|,
name|mword
operator||
name|IFM_IEEE80211_ADHOC
operator||
name|IFM_FLAG0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|awi_media_status
argument_list|(
name|ifp
argument_list|,
operator|&
name|imr
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|sc_media
argument_list|,
name|imr
operator|.
name|ifm_active
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ready to accept ioctl */
name|awi_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_function
name|int
name|awi_detach
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|sc
operator|->
name|sc_invalid
operator|=
literal|1
expr_stmt|;
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|sc_sleep_cnt
operator|>
literal|0
condition|)
block|{
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PWAIT
argument_list|,
literal|"awidet"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
name|bpfdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|IFM_IEEE80211
name|ifmedia_delete_instance
argument_list|(
operator|&
name|sc
operator|->
name|sc_media
argument_list|,
name|IFM_INST_ANY
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|if_detach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_disable
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_disable
call|)
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_enabled
operator|=
literal|0
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|awi_activate
parameter_list|(
name|self
parameter_list|,
name|act
parameter_list|)
name|struct
name|device
modifier|*
name|self
decl_stmt|;
name|enum
name|devact
name|act
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|awi_softc
operator|*
operator|)
name|self
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|act
condition|)
block|{
case|case
name|DVACT_ACTIVATE
case|:
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
break|break;
case|case
name|DVACT_DEACTIVATE
case|:
name|sc
operator|->
name|sc_invalid
operator|=
literal|1
expr_stmt|;
name|if_deactivate
argument_list|(
name|sc
operator|->
name|sc_ifp
argument_list|)
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __NetBSD__ */
end_comment

begin_function
name|void
name|awi_reset
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_enabled
condition|)
return|return;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
name|sc
operator|->
name|sc_invalid
operator|=
literal|1
expr_stmt|;
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_disable
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_disable
call|)
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_enabled
operator|=
literal|0
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_invalid
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_ioctl
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
init|=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
decl_stmt|;
name|size_t
name|nwidlen
decl_stmt|;
name|u_int8_t
name|nwid
index|[
name|IEEE80211_NWID_LEN
operator|+
literal|1
index|]
decl_stmt|;
name|u_int8_t
modifier|*
name|p
decl_stmt|;
name|s
operator|=
name|splnet
argument_list|()
expr_stmt|;
comment|/* serialize ioctl */
name|error
operator|=
name|awi_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|cantlock
goto|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFADDR
case|:
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_UP
expr_stmt|;
switch|switch
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|arp_ifinit
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ifp
argument_list|,
name|ifa
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
comment|/* FALLTHROUGH */
case|case
name|SIOCSIFFLAGS
case|:
name|sc
operator|->
name|sc_format_llc
operator|=
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_disable
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_disable
call|)
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_enabled
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
ifdef|#
directive|ifdef
name|__FreeBSD__
name|error
operator|=
name|ENETRESET
expr_stmt|;
comment|/*XXX*/
else|#
directive|else
name|error
operator|=
operator|(
name|cmd
operator|==
name|SIOCADDMULTI
operator|)
condition|?
name|ether_addmulti
argument_list|(
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|sc_ec
argument_list|)
else|:
name|ether_delmulti
argument_list|(
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|sc_ec
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
operator|==
name|ENETRESET
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMTU
case|:
if|if
condition|(
name|ifr
operator|->
name|ifr_mtu
operator|>
name|ETHERMTU
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
else|else
name|ifp
operator|->
name|if_mtu
operator|=
name|ifr
operator|->
name|ifr_mtu
expr_stmt|;
break|break;
case|case
name|SIOCS80211NWID
case|:
name|error
operator|=
name|copyinstr
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
name|nwid
argument_list|,
sizeof|sizeof
argument_list|(
name|nwid
argument_list|)
argument_list|,
operator|&
name|nwidlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|nwidlen
operator|--
expr_stmt|;
comment|/* eliminate trailing '\0' */
if|if
condition|(
name|nwidlen
operator|>
name|IEEE80211_NWID_LEN
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|1
index|]
operator|==
name|nwidlen
operator|&&
name|memcmp
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|2
index|]
argument_list|,
name|nwid
argument_list|,
name|nwidlen
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|memset
argument_list|(
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
argument_list|,
literal|0
argument_list|,
name|AWI_ESS_ID_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|0
index|]
operator|=
name|IEEE80211_ELEMID_SSID
expr_stmt|;
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|1
index|]
operator|=
name|nwidlen
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|2
index|]
argument_list|,
name|nwid
argument_list|,
name|nwidlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCG80211NWID
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
name|p
operator|=
name|sc
operator|->
name|sc_bss
operator|.
name|essid
expr_stmt|;
else|else
name|p
operator|=
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|p
operator|+
literal|2
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
name|IEEE80211_NWID_LEN
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|IFM_IEEE80211
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|sc_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|SIOCGDRVSPEC
case|:
name|error
operator|=
name|awi_drvget
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSDRVSPEC
case|:
name|error
operator|=
name|awi_drvset
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|awi_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|cantlock
label|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|IFM_IEEE80211
end_ifdef

begin_function
specifier|static
name|int
name|awi_media_rate2opt
parameter_list|(
name|sc
parameter_list|,
name|rate
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rate
decl_stmt|;
block|{
name|int
name|mword
decl_stmt|;
name|mword
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|rate
condition|)
block|{
case|case
literal|10
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
name|mword
operator|=
name|IFM_IEEE80211_FH1
expr_stmt|;
else|else
name|mword
operator|=
name|IFM_IEEE80211_DS1
expr_stmt|;
break|break;
case|case
literal|20
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
name|mword
operator|=
name|IFM_IEEE80211_FH2
expr_stmt|;
else|else
name|mword
operator|=
name|IFM_IEEE80211_DS2
expr_stmt|;
break|break;
case|case
literal|55
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_DS
condition|)
name|mword
operator|=
name|IFM_IEEE80211_DS5
expr_stmt|;
break|break;
case|case
literal|110
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_DS
condition|)
name|mword
operator|=
name|IFM_IEEE80211_DS11
expr_stmt|;
break|break;
block|}
return|return
name|mword
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_media_opt2rate
parameter_list|(
name|sc
parameter_list|,
name|opt
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|opt
decl_stmt|;
block|{
name|int
name|rate
decl_stmt|;
name|rate
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|opt
argument_list|)
condition|)
block|{
case|case
name|IFM_IEEE80211_FH1
case|:
case|case
name|IFM_IEEE80211_FH2
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|!=
name|AWI_PHY_TYPE_FH
condition|)
return|return
literal|0
return|;
break|break;
case|case
name|IFM_IEEE80211_DS1
case|:
case|case
name|IFM_IEEE80211_DS2
case|:
case|case
name|IFM_IEEE80211_DS5
case|:
case|case
name|IFM_IEEE80211_DS11
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|!=
name|AWI_PHY_TYPE_DS
condition|)
return|return
literal|0
return|;
break|break;
block|}
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|opt
argument_list|)
condition|)
block|{
case|case
name|IFM_IEEE80211_FH1
case|:
case|case
name|IFM_IEEE80211_DS1
case|:
name|rate
operator|=
literal|10
expr_stmt|;
break|break;
case|case
name|IFM_IEEE80211_FH2
case|:
case|case
name|IFM_IEEE80211_DS2
case|:
name|rate
operator|=
literal|20
expr_stmt|;
break|break;
case|case
name|IFM_IEEE80211_DS5
case|:
name|rate
operator|=
literal|55
expr_stmt|;
break|break;
case|case
name|IFM_IEEE80211_DS11
case|:
name|rate
operator|=
literal|110
expr_stmt|;
break|break;
block|}
return|return
name|rate
return|;
block|}
end_function

begin_comment
comment|/*  * Called from ifmedia_ioctl via awi_ioctl with lock obtained.  */
end_comment

begin_function
specifier|static
name|int
name|awi_media_change
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifmedia_entry
modifier|*
name|ime
decl_stmt|;
name|u_int8_t
modifier|*
name|phy_rates
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rate
decl_stmt|,
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|ime
operator|=
name|sc
operator|->
name|sc_media
operator|.
name|ifm_cur
expr_stmt|;
name|rate
operator|=
name|awi_media_opt2rate
argument_list|(
name|sc
argument_list|,
name|ime
operator|->
name|ifm_media
argument_list|)
expr_stmt|;
if|if
condition|(
name|rate
operator|==
literal|0
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|rate
operator|!=
name|sc
operator|->
name|sc_tx_rate
condition|)
block|{
name|phy_rates
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aSuprt_Data_Rates
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|phy_rates
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rate
operator|==
name|AWI_80211_RATE
argument_list|(
name|phy_rates
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|phy_rates
index|[
literal|1
index|]
condition|)
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|ime
operator|->
name|ifm_media
operator|&
name|IFM_IEEE80211_ADHOC
condition|)
block|{
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_no_bssid
operator|=
operator|(
name|ime
operator|->
name|ifm_media
operator|&
name|IFM_FLAG0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_media_status
parameter_list|(
name|ifp
parameter_list|,
name|imr
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmediareq
modifier|*
name|imr
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|imr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
name|imr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
name|imr
operator|->
name|ifm_active
operator|=
name|IFM_IEEE80211
expr_stmt|;
name|imr
operator|->
name|ifm_active
operator||=
name|awi_media_rate2opt
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_tx_rate
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|==
literal|0
condition|)
block|{
name|imr
operator|->
name|ifm_active
operator||=
name|IFM_IEEE80211_ADHOC
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_no_bssid
condition|)
name|imr
operator|->
name|ifm_active
operator||=
name|IFM_FLAG0
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IFM_IEEE80211 */
end_comment

begin_function
specifier|static
name|int
name|awi_drvget
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifdrv
modifier|*
name|ifd
init|=
operator|(
expr|struct
name|ifdrv
operator|*
operator|)
name|data
decl_stmt|;
name|u_int8_t
name|buf
index|[
name|AWICTL_BUFSIZE
index|]
decl_stmt|;
name|u_int8_t
modifier|*
name|essid
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|ifd
operator|->
name|ifd_cmd
condition|)
block|{
case|case
name|AWICTL_REGION
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|<
literal|1
condition|)
return|return
name|ENOSPC
return|;
name|ifd
operator|->
name|ifd_len
operator|=
literal|1
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
expr_stmt|;
break|break;
case|case
name|AWICTL_CHANSET
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|<
literal|3
condition|)
return|return
name|ENOSPC
return|;
name|ifd
operator|->
name|ifd_len
operator|=
literal|3
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_bss
operator|.
name|chanset
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|sc
operator|->
name|sc_scan_min
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|sc
operator|->
name|sc_scan_max
expr_stmt|;
break|break;
case|case
name|AWICTL_RAWBPF
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|<
literal|1
condition|)
return|return
name|ENOSPC
return|;
name|ifd
operator|->
name|ifd_len
operator|=
literal|1
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_rawbpf
expr_stmt|;
break|break;
case|case
name|AWICTL_DESSID
case|:
case|case
name|AWICTL_CESSID
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_cmd
operator|==
name|AWICTL_DESSID
condition|)
name|essid
operator|=
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
expr_stmt|;
else|else
name|essid
operator|=
name|sc
operator|->
name|sc_bss
operator|.
name|essid
expr_stmt|;
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|<
name|essid
index|[
literal|1
index|]
condition|)
return|return
name|ENOSPC
return|;
name|ifd
operator|->
name|ifd_len
operator|=
name|essid
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|>
literal|0
condition|)
name|memcpy
argument_list|(
name|buf
argument_list|,
name|essid
argument_list|,
name|ifd
operator|->
name|ifd_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWICTL_MODE
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|<
literal|1
condition|)
return|return
name|ENOSPC
return|;
name|ifd
operator|->
name|ifd_len
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_no_bssid
condition|)
name|buf
index|[
literal|0
index|]
operator|=
name|AWICTL_MODE_NOBSSID
expr_stmt|;
else|else
name|buf
index|[
literal|0
index|]
operator|=
name|AWICTL_MODE_ADHOC
expr_stmt|;
block|}
else|else
name|buf
index|[
literal|0
index|]
operator|=
name|AWICTL_MODE_INFRA
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
name|ifd
operator|->
name|ifd_len
operator|>
literal|0
condition|)
name|error
operator|=
name|copyout
argument_list|(
name|ifd
operator|->
name|ifd_data
argument_list|,
name|buf
argument_list|,
name|ifd
operator|->
name|ifd_len
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_drvset
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifdrv
modifier|*
name|ifd
init|=
operator|(
expr|struct
name|ifdrv
operator|*
operator|)
name|data
decl_stmt|;
name|u_int8_t
name|buf
index|[
name|AWICTL_BUFSIZE
index|]
decl_stmt|;
name|u_int8_t
name|oregion
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|error
operator|=
name|copyin
argument_list|(
name|ifd
operator|->
name|ifd_data
argument_list|,
name|buf
argument_list|,
name|ifd
operator|->
name|ifd_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
switch|switch
condition|(
name|ifd
operator|->
name|ifd_cmd
condition|)
block|{
case|case
name|AWICTL_REGION
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|!=
literal|1
condition|)
return|return
name|EINVAL
return|;
name|oregion
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
name|oregion
condition|)
break|break;
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|error
operator|=
name|awi_init_region
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
operator|=
name|oregion
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|AWICTL_CHANSET
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|!=
literal|3
condition|)
return|return
name|EINVAL
return|;
comment|/* reset scan min/max */
name|awi_init_region
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|<
name|sc
operator|->
name|sc_scan_min
operator|||
name|buf
index|[
literal|0
index|]
operator|>
name|sc
operator|->
name|sc_scan_max
operator|||
name|buf
index|[
literal|1
index|]
operator|<
name|sc
operator|->
name|sc_scan_min
operator|||
name|buf
index|[
literal|1
index|]
operator|>
name|sc
operator|->
name|sc_scan_max
operator|||
name|buf
index|[
literal|2
index|]
operator|<
name|sc
operator|->
name|sc_scan_min
operator|||
name|buf
index|[
literal|2
index|]
operator|>
name|sc
operator|->
name|sc_scan_max
condition|)
return|return
name|EINVAL
return|;
name|sc
operator|->
name|sc_scan_cur
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|sc_scan_min
operator|=
name|buf
index|[
literal|1
index|]
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
name|buf
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
name|sc
operator|->
name|sc_scan_set
operator|=
name|sc
operator|->
name|sc_scan_cur
operator|%
literal|3
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|AWICTL_RAWBPF
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|!=
literal|1
condition|)
return|return
name|EINVAL
return|;
name|sc
operator|->
name|sc_rawbpf
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|AWICTL_DESSID
case|:
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|>
name|IEEE80211_NWID_LEN
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|1
index|]
operator|==
name|ifd
operator|->
name|ifd_len
operator|&&
name|memcmp
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|2
index|]
argument_list|,
name|buf
argument_list|,
name|ifd
operator|->
name|ifd_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|memset
argument_list|(
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
argument_list|,
literal|0
argument_list|,
name|AWI_ESS_ID_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|0
index|]
operator|=
name|IEEE80211_ELEMID_SSID
expr_stmt|;
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|1
index|]
operator|=
name|ifd
operator|->
name|ifd_len
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|2
index|]
argument_list|,
name|buf
argument_list|,
name|ifd
operator|->
name|ifd_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|AWICTL_CESSID
case|:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
case|case
name|AWICTL_MODE
case|:
switch|switch
condition|(
name|buf
index|[
literal|0
index|]
condition|)
block|{
case|case
name|AWICTL_MODE_INFRA
case|:
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_no_bssid
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|AWICTL_MODE_ADHOC
case|:
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_no_bssid
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|AWICTL_MODE_NOBSSID
case|:
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_no_bssid
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|awi_intr
parameter_list|(
name|arg
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|u_int16_t
name|status
decl_stmt|;
name|int
name|error
decl_stmt|,
name|handled
init|=
literal|0
decl_stmt|,
name|ocansleep
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_invalid
condition|)
return|return
literal|0
return|;
name|am79c930_gcr_setbits
argument_list|(
operator|&
name|sc
operator|->
name|sc_chip
argument_list|,
name|AM79C930_GCR_DISPWDN
operator||
name|AM79C930_GCR_ECINT
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_DIS_PWRDN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ocansleep
operator|=
name|sc
operator|->
name|sc_cansleep
expr_stmt|;
name|sc
operator|->
name|sc_cansleep
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|error
operator|=
name|awi_intr_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|status
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTSTAT
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTSTAT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTSTAT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|status
operator||=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTSTAT2
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTSTAT2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|awi_intr_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_cmd_inprog
condition|)
name|status
operator|&=
operator|~
name|AWI_INT_CMD
expr_stmt|;
comment|/* make sure */
if|if
condition|(
name|status
operator|==
literal|0
condition|)
break|break;
name|handled
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|AWI_INT_RX
condition|)
name|awi_rxint
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|AWI_INT_TX
condition|)
name|awi_txint
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|AWI_INT_CMD
condition|)
name|awi_cmd_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|AWI_INT_SCAN_CMPLT
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_status
operator|==
name|AWI_ST_SCAN
operator|&&
name|sc
operator|->
name|sc_mgt_timer
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|awi_next_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|sc_cansleep
operator|=
name|ocansleep
expr_stmt|;
name|am79c930_gcr_clearbits
argument_list|(
operator|&
name|sc
operator|->
name|sc_chip
argument_list|,
name|AM79C930_GCR_DISPWDN
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_DIS_PWRDN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|handled
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_init
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|error
decl_stmt|,
name|ostatus
decl_stmt|;
name|int
name|n
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
else|#
directive|else
name|struct
name|ether_multi
modifier|*
name|enm
decl_stmt|;
name|struct
name|ether_multistep
name|step
decl_stmt|;
endif|#
directive|endif
name|n
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_ALLMULTI
expr_stmt|;
name|sc
operator|->
name|sc_mib_local
operator|.
name|Accept_All_Multicast_Dis
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
block|{
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aPromiscuous_Enable
operator|=
literal|1
expr_stmt|;
goto|goto
name|set_mib
goto|;
block|}
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aPromiscuous_Enable
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_ALLMULTI
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|ifp
operator|->
name|if_amcount
operator|!=
literal|0
condition|)
goto|goto
name|set_mib
goto|;
for|for
control|(
name|ifma
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|ifp
operator|->
name|if_multiaddrs
argument_list|)
init|;
name|ifma
operator|!=
name|NULL
condition|;
name|ifma
operator|=
name|LIST_NEXT
argument_list|(
name|ifma
argument_list|,
name|ifma_link
argument_list|)
control|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
name|n
operator|==
name|AWI_GROUP_ADDR_SIZE
condition|)
goto|goto
name|set_mib
goto|;
name|memcpy
argument_list|(
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aGroup_Addresses
index|[
name|n
index|]
argument_list|,
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
else|#
directive|else
name|ETHER_FIRST_MULTI
argument_list|(
name|step
argument_list|,
operator|&
name|sc
operator|->
name|sc_ec
argument_list|,
name|enm
argument_list|)
expr_stmt|;
while|while
condition|(
name|enm
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|n
operator|==
name|AWI_GROUP_ADDR_SIZE
operator|||
name|memcmp
argument_list|(
name|enm
operator|->
name|enm_addrlo
argument_list|,
name|enm
operator|->
name|enm_addrhi
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|set_mib
goto|;
name|memcpy
argument_list|(
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aGroup_Addresses
index|[
name|n
index|]
argument_list|,
name|enm
operator|->
name|enm_addrlo
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
name|ETHER_NEXT_MULTI
argument_list|(
name|step
argument_list|,
name|enm
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_ALLMULTI
expr_stmt|;
name|sc
operator|->
name|sc_mib_local
operator|.
name|Accept_All_Multicast_Dis
operator|=
literal|1
expr_stmt|;
name|set_mib
label|:
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|sc
operator|->
name|sc_enabled
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_enable
condition|)
call|(
modifier|*
name|sc
operator|->
name|sc_enable
call|)
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_INIT
expr_stmt|;
name|error
operator|=
name|awi_init_hw
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
block|}
name|ostatus
operator|=
name|sc
operator|->
name|sc_status
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_INIT
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SET_MIB
argument_list|,
name|AWI_MIB_LOCAL
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SET_MIB
argument_list|,
name|AWI_MIB_ADDR
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SET_MIB
argument_list|,
name|AWI_MIB_MAC
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SET_MIB
argument_list|,
name|AWI_MIB_MGT
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SET_MIB
argument_list|,
name|AWI_MIB_PHY
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_RUNNING
expr_stmt|;
else|else
block|{
if|if
condition|(
name|ostatus
operator|==
name|AWI_ST_INIT
condition|)
block|{
name|error
operator|=
name|awi_init_txrx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
block|}
name|error
operator|=
name|awi_start_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_stop
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_INIT
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_invalid
condition|)
block|{
operator|(
name|void
operator|)
name|awi_cmd_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|&&
name|sc
operator|->
name|sc_status
operator|>
name|AWI_ST_AUTH
condition|)
name|awi_send_deauth
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|awi_stop_txrx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
operator|(
name|IFF_RUNNING
operator||
name|IFF_OACTIVE
operator|)
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_tx_timer
operator|=
name|sc
operator|->
name|sc_rx_timer
operator|=
name|sc
operator|->
name|sc_mgt_timer
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_mgtq
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|bp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|,
name|bp
argument_list|,
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_watchdog
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|ocansleep
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_invalid
condition|)
block|{
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|ocansleep
operator|=
name|sc
operator|->
name|sc_cansleep
expr_stmt|;
name|sc
operator|->
name|sc_cansleep
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tx_timer
operator|&&
operator|--
name|sc
operator|->
name|sc_tx_timer
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: transmit timeout\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
name|awi_txint
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rx_timer
operator|&&
operator|--
name|sc
operator|->
name|sc_rx_timer
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: no recent beacons from %s; rescanning\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|awi_start_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_mgt_timer
operator|&&
operator|--
name|sc
operator|->
name|sc_mgt_timer
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|sc_status
condition|)
block|{
case|case
name|AWI_ST_SCAN
case|:
name|awi_stop_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWI_ST_AUTH
case|:
case|case
name|AWI_ST_ASSOC
case|:
comment|/* restart scan */
name|awi_start_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|sc_tx_timer
operator|==
literal|0
operator|&&
name|sc
operator|->
name|sc_rx_timer
operator|==
literal|0
operator|&&
name|sc
operator|->
name|sc_mgt_timer
operator|==
literal|0
condition|)
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
else|else
name|ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_cansleep
operator|=
name|ocansleep
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_start
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|awi_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|u_int32_t
name|txd
decl_stmt|,
name|frame
decl_stmt|,
name|ntxd
decl_stmt|;
name|u_int8_t
name|rate
decl_stmt|;
name|int
name|len
decl_stmt|,
name|sent
init|=
literal|0
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|txd
operator|=
name|sc
operator|->
name|sc_txnext
expr_stmt|;
name|IF_DEQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_mgtq
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|awi_next_txd
argument_list|(
name|sc
argument_list|,
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
operator|&
name|frame
argument_list|,
operator|&
name|ntxd
argument_list|)
condition|)
block|{
name|IF_PREPEND
argument_list|(
operator|&
name|sc
operator|->
name|sc_mgtq
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
condition|)
break|break;
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|awi_next_txd
argument_list|(
name|sc
argument_list|,
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
argument_list|,
operator|&
name|frame
argument_list|,
operator|&
name|ntxd
argument_list|)
condition|)
block|{
name|IF_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
break|break;
block|}
name|AWI_BPF_MTAP
argument_list|(
name|sc
argument_list|,
name|m0
argument_list|,
name|AWI_BPF_NORM
argument_list|)
expr_stmt|;
name|m0
operator|=
name|awi_fix_txhdr
argument_list|(
name|sc
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
continue|continue;
block|}
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
name|AWI_BPF_MTAP
argument_list|(
name|sc
argument_list|,
name|m0
argument_list|,
name|AWI_BPF_RAW
argument_list|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|m
operator|=
name|m0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|awi_write_bytes
argument_list|(
name|sc
argument_list|,
name|frame
operator|+
name|len
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|len
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|rate
operator|=
name|sc
operator|->
name|sc_tx_rate
expr_stmt|;
comment|/*XXX*/
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|ntxd
operator|+
name|AWI_TXD_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|txd
operator|+
name|AWI_TXD_START
argument_list|,
name|frame
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|txd
operator|+
name|AWI_TXD_NEXT
argument_list|,
name|ntxd
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|txd
operator|+
name|AWI_TXD_LENGTH
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|txd
operator|+
name|AWI_TXD_RATE
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|txd
operator|+
name|AWI_TXD_NDA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|txd
operator|+
name|AWI_TXD_NRA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|txd
operator|+
name|AWI_TXD_STATE
argument_list|,
name|AWI_TXD_ST_OWN
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_txnext
operator|=
name|ntxd
expr_stmt|;
name|sent
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sent
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_tx_timer
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|5
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
name|printf
argument_list|(
literal|"awi_start: sent %d txdone %d txnext %d txbase %d txend %d\n"
argument_list|,
name|sent
argument_list|,
name|sc
operator|->
name|sc_txdone
argument_list|,
name|sc
operator|->
name|sc_txnext
argument_list|,
name|sc
operator|->
name|sc_txbase
argument_list|,
name|sc
operator|->
name|sc_txend
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|awi_txint
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|u_int8_t
name|flags
decl_stmt|;
while|while
condition|(
name|sc
operator|->
name|sc_txdone
operator|!=
name|sc
operator|->
name|sc_txnext
condition|)
block|{
name|flags
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txdone
operator|+
name|AWI_TXD_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|AWI_TXD_ST_OWN
operator|)
operator|||
operator|!
operator|(
name|flags
operator|&
name|AWI_TXD_ST_DONE
operator|)
condition|)
break|break;
if|if
condition|(
name|flags
operator|&
name|AWI_TXD_ST_ERROR
condition|)
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|sc
operator|->
name|sc_txdone
operator|=
name|awi_read_4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txdone
operator|+
name|AWI_TXD_NEXT
argument_list|)
operator|&
literal|0x7fff
expr_stmt|;
block|}
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
name|printf
argument_list|(
literal|"awi_txint: txdone %d txnext %d txbase %d txend %d\n"
argument_list|,
name|sc
operator|->
name|sc_txdone
argument_list|,
name|sc
operator|->
name|sc_txnext
argument_list|,
name|sc
operator|->
name|sc_txbase
argument_list|,
name|sc
operator|->
name|sc_txend
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|awi_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|awi_fix_txhdr
parameter_list|(
name|sc
parameter_list|,
name|m0
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
block|{
name|struct
name|ether_header
name|eh
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|llc
modifier|*
name|llc
decl_stmt|;
if|if
condition|(
name|m0
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
name|eh
argument_list|)
condition|)
block|{
name|m0
operator|=
name|m_pullup
argument_list|(
name|m0
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|eh
argument_list|,
name|mtod
argument_list|(
name|m0
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_format_llc
condition|)
block|{
name|m_adj
argument_list|(
name|m0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|llc
argument_list|)
argument_list|)
expr_stmt|;
name|llc
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|llc
operator|*
argument_list|)
expr_stmt|;
name|llc
operator|->
name|llc_dsap
operator|=
name|llc
operator|->
name|llc_ssap
operator|=
name|LLC_SNAP_LSAP
expr_stmt|;
name|llc
operator|->
name|llc_control
operator|=
name|LLC_UI
expr_stmt|;
name|llc
operator|->
name|llc_snap
operator|.
name|org_code
index|[
literal|0
index|]
operator|=
name|llc
operator|->
name|llc_snap
operator|.
name|org_code
index|[
literal|1
index|]
operator|=
name|llc
operator|->
name|llc_snap
operator|.
name|org_code
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|llc
operator|->
name|llc_snap
operator|.
name|ether_type
operator|=
name|eh
operator|.
name|ether_type
expr_stmt|;
block|}
name|M_PREPEND
argument_list|(
name|m0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|=
name|IEEE80211_FC0_VERSION_0
operator||
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_dur
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
block|{
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|=
name|IEEE80211_FC1_DIR_TODS
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|eh
operator|.
name|ether_shost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|eh
operator|.
name|ether_dhost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|=
name|IEEE80211_FC1_DIR_NODS
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|eh
operator|.
name|ether_dhost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|eh
operator|.
name|ether_shost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
block|}
return|return
name|m0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|awi_fix_rxhdr
parameter_list|(
name|sc
parameter_list|,
name|m0
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
block|{
name|struct
name|ieee80211_frame
name|wh
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|llc
modifier|*
name|llc
decl_stmt|;
if|if
condition|(
name|m0
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
name|wh
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|llc
operator|=
operator|(
expr|struct
name|llc
operator|*
operator|)
operator|(
name|mtod
argument_list|(
name|m0
argument_list|,
name|caddr_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|wh
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|llc
operator|->
name|llc_dsap
operator|==
name|LLC_SNAP_LSAP
operator|&&
name|llc
operator|->
name|llc_ssap
operator|==
name|LLC_SNAP_LSAP
operator|&&
name|llc
operator|->
name|llc_control
operator|==
name|LLC_UI
operator|&&
name|llc
operator|->
name|llc_snap
operator|.
name|org_code
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|llc
operator|->
name|llc_snap
operator|.
name|org_code
index|[
literal|1
index|]
operator|==
literal|0
operator|&&
name|llc
operator|->
name|llc_snap
operator|.
name|org_code
index|[
literal|2
index|]
operator|==
literal|0
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|wh
argument_list|,
name|mtod
argument_list|(
name|m0
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
argument_list|)
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m0
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|llc
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
argument_list|)
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|wh
operator|.
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_MASK
condition|)
block|{
case|case
name|IEEE80211_FC1_DIR_NODS
case|:
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|wh
operator|.
name|i_addr1
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_shost
argument_list|,
name|wh
operator|.
name|i_addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC1_DIR_TODS
case|:
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|wh
operator|.
name|i_addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_shost
argument_list|,
name|wh
operator|.
name|i_addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC1_DIR_FROMDS
case|:
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|wh
operator|.
name|i_addr1
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_shost
argument_list|,
name|wh
operator|.
name|i_addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC1_DIR_DSTODS
case|:
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
comment|/* assuming ethernet encapsulation, just strip 802.11 header */
name|m_adj
argument_list|(
name|m0
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|m0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_input
parameter_list|(
name|sc
parameter_list|,
name|m
parameter_list|,
name|rxts
parameter_list|,
name|rssi
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|u_int32_t
name|rxts
decl_stmt|;
name|u_int8_t
name|rssi
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
ifndef|#
directive|ifndef
name|__NetBSD__
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
endif|#
directive|endif
name|AWI_BPF_MTAP
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|AWI_BPF_RAW
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_VERSION_MASK
operator|)
operator|!=
name|IEEE80211_FC0_VERSION_0
condition|)
block|{
name|printf
argument_list|(
literal|"%s; receive packet with wrong version: %x\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_dump
condition|)
name|awi_dump_pkt
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|||
operator|!
name|sc
operator|->
name|sc_no_bssid
operator|)
operator|&&
name|sc
operator|->
name|sc_status
operator|==
name|AWI_ST_RUNNING
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_rx_timer
operator|=
literal|10
expr_stmt|;
name|sc
operator|->
name|sc_bss
operator|.
name|rssi
operator|=
name|rssi
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_TYPE_DATA
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
block|{
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_MASK
operator|)
operator|!=
name|IEEE80211_FC1_DIR_FROMDS
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_MASK
operator|)
operator|!=
name|IEEE80211_FC1_DIR_NODS
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|m
operator|=
name|awi_fix_rxhdr
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
break|break;
block|}
name|ifp
operator|->
name|if_ipackets
operator|++
expr_stmt|;
ifndef|#
directive|ifndef
name|__FreeBSD__
name|AWI_BPF_MTAP
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|AWI_BPF_NORM
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|__NetBSD__
name|m
operator|->
name|m_flags
operator||=
name|M_HASFCS
expr_stmt|;
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|#
directive|else
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
operator|-
name|ETHER_CRC_LEN
argument_list|)
expr_stmt|;
name|ether_input
argument_list|(
name|ifp
argument_list|,
name|eh
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|IEEE80211_FC0_TYPE_MGT
case|:
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_MASK
operator|)
operator|!=
name|IEEE80211_FC1_DIR_NODS
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
case|:
case|case
name|IEEE80211_FC0_SUBTYPE_BEACON
case|:
name|awi_recv_beacon
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|rxts
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_AUTH
case|:
name|awi_recv_auth
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
case|:
case|case
name|IEEE80211_FC0_SUBTYPE_REASSOC_RESP
case|:
name|awi_recv_asresp
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_DEAUTH
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
name|awi_send_auth
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_DISASSOC
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
name|awi_send_asreq
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_TYPE_CTL
case|:
default|default:
comment|/* should not come here */
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|awi_rxint
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int8_t
name|state
decl_stmt|,
name|rate
decl_stmt|,
name|rssi
decl_stmt|;
name|u_int16_t
name|len
decl_stmt|;
name|u_int32_t
name|frame
decl_stmt|,
name|next
decl_stmt|,
name|rxts
decl_stmt|,
name|rxoff
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|rxoff
operator|=
name|sc
operator|->
name|sc_rxdoff
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|state
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_HOST_DESC_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|&
name|AWI_RXD_ST_OWN
condition|)
break|break;
if|if
condition|(
operator|!
operator|(
name|state
operator|&
name|AWI_RXD_ST_CONSUMED
operator|)
condition|)
block|{
if|if
condition|(
name|state
operator|&
name|AWI_RXD_ST_RXERROR
condition|)
name|sc
operator|->
name|sc_ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
else|else
block|{
name|len
operator|=
name|awi_read_2
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_LEN
argument_list|)
expr_stmt|;
name|rate
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_RATE
argument_list|)
expr_stmt|;
name|rssi
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_RSSI
argument_list|)
expr_stmt|;
name|frame
operator|=
name|awi_read_4
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_START_FRAME
argument_list|)
operator|&
literal|0x7fff
expr_stmt|;
name|rxts
operator|=
name|awi_read_4
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_LOCALTIME
argument_list|)
expr_stmt|;
name|m
operator|=
name|awi_devget
argument_list|(
name|sc
argument_list|,
name|frame
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|&
name|AWI_RXD_ST_LF
condition|)
name|awi_input
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|rxts
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|sc_rxpend
operator|=
name|m
expr_stmt|;
block|}
name|state
operator||=
name|AWI_RXD_ST_CONSUMED
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_HOST_DESC_STATE
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
name|next
operator|=
name|awi_read_4
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_NEXT
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|&
name|AWI_RXD_NEXT_LAST
condition|)
break|break;
comment|/* make sure the next pointer is correct */
if|if
condition|(
name|next
operator|!=
name|awi_read_4
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_NEXT
argument_list|)
condition|)
break|break;
name|state
operator||=
name|AWI_RXD_ST_OWN
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|rxoff
operator|+
name|AWI_RXD_HOST_DESC_STATE
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|rxoff
operator|=
name|next
operator|&
literal|0x7fff
expr_stmt|;
block|}
name|sc
operator|->
name|sc_rxdoff
operator|=
name|rxoff
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|mbuf
modifier|*
name|awi_devget
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|len
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|u_int32_t
name|off
decl_stmt|;
name|u_int16_t
name|len
decl_stmt|;
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|top
decl_stmt|,
modifier|*
modifier|*
name|mp
init|=
operator|&
name|top
decl_stmt|;
name|u_int
name|tlen
decl_stmt|;
name|top
operator|=
name|sc
operator|->
name|sc_rxpend
expr_stmt|;
if|if
condition|(
name|top
operator|!=
name|NULL
condition|)
block|{
name|sc
operator|->
name|sc_rxpend
operator|=
name|NULL
expr_stmt|;
name|top
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|len
expr_stmt|;
name|m
operator|=
name|top
expr_stmt|;
while|while
condition|(
operator|*
name|mp
operator|!=
name|NULL
condition|)
block|{
name|m
operator|=
operator|*
name|mp
expr_stmt|;
name|mp
operator|=
operator|&
name|m
operator|->
name|m_next
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
condition|)
name|tlen
operator|=
name|m
operator|->
name|m_ext
operator|.
name|ext_size
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_PKTHDR
condition|)
name|tlen
operator|=
name|MHLEN
expr_stmt|;
else|else
name|tlen
operator|=
name|MLEN
expr_stmt|;
name|tlen
operator|-=
name|m
operator|->
name|m_len
expr_stmt|;
if|if
condition|(
name|tlen
operator|>
name|len
condition|)
name|tlen
operator|=
name|len
expr_stmt|;
name|awi_read_bytes
argument_list|(
name|sc
argument_list|,
name|off
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|+
name|m
operator|->
name|m_len
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|off
operator|+=
name|tlen
expr_stmt|;
name|len
operator|-=
name|tlen
expr_stmt|;
block|}
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|top
operator|==
name|NULL
condition|)
block|{
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|sc
operator|->
name|sc_ifp
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|MHLEN
expr_stmt|;
block|}
else|else
block|{
name|MGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|top
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|m
operator|->
name|m_len
operator|=
name|MLEN
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|>=
name|MINCLSIZE
condition|)
block|{
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
condition|)
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_ext
operator|.
name|ext_size
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_len
operator|>
name|len
condition|)
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
name|awi_read_bytes
argument_list|(
name|sc
argument_list|,
name|off
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|off
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
name|len
operator|-=
name|m
operator|->
name|m_len
expr_stmt|;
operator|*
name|mp
operator|=
name|m
expr_stmt|;
name|mp
operator|=
operator|&
name|m
operator|->
name|m_next
expr_stmt|;
block|}
return|return
name|top
return|;
block|}
end_function

begin_comment
comment|/*  * Initialize hardware and start firmware to accept commands.  * Called everytime after power on firmware.  */
end_comment

begin_function
specifier|static
name|int
name|awi_init_hw
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int8_t
name|status
decl_stmt|;
name|u_int16_t
name|intmask
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|u_int8_t
name|banner
index|[
name|AWI_BANNER_LEN
index|]
decl_stmt|;
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_RESET
argument_list|)
expr_stmt|;
comment|/* reset firmware */
name|am79c930_gcr_setbits
argument_list|(
operator|&
name|sc
operator|->
name|sc_chip
argument_list|,
name|AM79C930_GCR_CORESET
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_SELFTEST
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|am79c930_gcr_clearbits
argument_list|(
operator|&
name|sc
operator|->
name|sc_chip
argument_list|,
name|AM79C930_GCR_CORESET
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* wait for selftest completion */
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|AWI_SELFTEST_TIMEOUT
operator|*
name|hz
operator|/
literal|1000
condition|)
block|{
name|printf
argument_list|(
literal|"%s: failed to complete selftest (timeout)\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|status
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_SELFTEST
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
literal|0xf0
operator|)
operator|==
literal|0xf0
condition|)
break|break;
if|if
condition|(
name|sc
operator|->
name|sc_cansleep
condition|)
block|{
name|sc
operator|->
name|sc_sleep_cnt
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PWAIT
argument_list|,
literal|"awitst"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sleep_cnt
operator|--
expr_stmt|;
block|}
else|else
block|{
name|DELAY
argument_list|(
literal|1000
operator|*
literal|1000
operator|/
name|hz
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|status
operator|!=
name|AWI_SELFTEST_PASSED
condition|)
block|{
name|printf
argument_list|(
literal|"%s: failed to complete selftest (code %x)\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* check banner to confirm firmware write it */
name|awi_read_bytes
argument_list|(
name|sc
argument_list|,
name|AWI_BANNER
argument_list|,
name|banner
argument_list|,
name|AWI_BANNER_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|banner
argument_list|,
literal|"PCnetMobile:"
argument_list|,
literal|12
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: failed to complete selftest (bad banner)\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AWI_BANNER_LEN
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%s%02x"
argument_list|,
name|i
condition|?
literal|":"
else|:
literal|"\t"
argument_list|,
name|banner
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* initializing interrupt */
name|error
operator|=
name|awi_intr_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|intmask
operator|=
name|AWI_INT_GROGGY
operator||
name|AWI_INT_SCAN_CMPLT
operator||
name|AWI_INT_TX
operator||
name|AWI_INT_RX
operator||
name|AWI_INT_CMD
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTMASK
argument_list|,
operator|~
name|intmask
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTMASK2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTSTAT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_INTSTAT2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_intr_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|am79c930_gcr_setbits
argument_list|(
operator|&
name|sc
operator|->
name|sc_chip
argument_list|,
name|AM79C930_GCR_ENECINT
argument_list|)
expr_stmt|;
comment|/* issueing interface test command */
name|error
operator|=
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_NOP
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"%s: failed to complete selftest"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|EWOULDBLOCK
condition|)
name|printf
argument_list|(
literal|" (error %d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|sc_cansleep
condition|)
name|printf
argument_list|(
literal|" (lost interrupt)\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" (command timeout)\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Extract the factory default MIB value from firmware and assign the driver  * default value.  * Called once at attaching the interface.  */
end_comment

begin_function
specifier|static
name|int
name|awi_init_mibs
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|u_int8_t
modifier|*
name|rate
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_GET_MIB
argument_list|,
name|AWI_MIB_LOCAL
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_GET_MIB
argument_list|,
name|AWI_MIB_ADDR
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_GET_MIB
argument_list|,
name|AWI_MIB_MAC
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_GET_MIB
argument_list|,
name|AWI_MIB_MGT
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_GET_MIB
argument_list|,
name|AWI_MIB_PHY
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: failed to get default mib value (error %d)\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|rate
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aSuprt_Data_Rates
expr_stmt|;
name|sc
operator|->
name|sc_tx_rate
operator|=
name|AWI_RATE_1MBIT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rate
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|AWI_80211_RATE
argument_list|(
name|rate
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
operator|>
name|sc
operator|->
name|sc_tx_rate
condition|)
name|sc
operator|->
name|sc_tx_rate
operator|=
name|AWI_80211_RATE
argument_list|(
name|rate
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|awi_init_region
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
argument_list|,
literal|0
argument_list|,
name|AWI_ESS_ID_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|0
index|]
operator|=
name|IEEE80211_ELEMID_SSID
expr_stmt|;
name|sc
operator|->
name|sc_mib_local
operator|.
name|Fragmentation_Dis
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_mib_local
operator|.
name|Accept_All_Multicast_Dis
operator|=
literal|1
expr_stmt|;
comment|/* allocate buffers */
name|sc
operator|->
name|sc_txbase
operator|=
name|AWI_BUFFERS
expr_stmt|;
name|sc
operator|->
name|sc_txend
operator|=
name|sc
operator|->
name|sc_txbase
operator|+
operator|(
name|AWI_TXD_SIZE
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|+
name|ETHERMTU
operator|)
operator|*
name|AWI_NTXBUFS
expr_stmt|;
name|LE_WRITE_4
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_local
operator|.
name|Tx_Buffer_Offset
argument_list|,
name|sc
operator|->
name|sc_txbase
argument_list|)
expr_stmt|;
name|LE_WRITE_4
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_local
operator|.
name|Tx_Buffer_Size
argument_list|,
name|sc
operator|->
name|sc_txend
operator|-
name|sc
operator|->
name|sc_txbase
argument_list|)
expr_stmt|;
name|LE_WRITE_4
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_local
operator|.
name|Rx_Buffer_Offset
argument_list|,
name|sc
operator|->
name|sc_txend
argument_list|)
expr_stmt|;
name|LE_WRITE_4
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_local
operator|.
name|Rx_Buffer_Size
argument_list|,
name|AWI_BUFFERS_END
operator|-
name|sc
operator|->
name|sc_txend
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_mib_local
operator|.
name|Acting_as_AP
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Start transmitter and receiver of firmware  * Called after awi_init_hw() to start operation.  */
end_comment

begin_function
specifier|static
name|int
name|awi_init_txrx
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
comment|/* start transmitter */
name|sc
operator|->
name|sc_txdone
operator|=
name|sc
operator|->
name|sc_txnext
operator|=
name|sc
operator|->
name|sc_txbase
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txbase
operator|+
name|AWI_TXD_START
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txbase
operator|+
name|AWI_TXD_NEXT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txbase
operator|+
name|AWI_TXD_LENGTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txbase
operator|+
name|AWI_TXD_RATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txbase
operator|+
name|AWI_TXD_NDA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txbase
operator|+
name|AWI_TXD_NRA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_txbase
operator|+
name|AWI_TXD_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_TX_DATA
argument_list|,
name|sc
operator|->
name|sc_txbase
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_TX_MGT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_TX_BCAST
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_TX_PS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_TX_CF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_INIT_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
comment|/* start receiver */
if|if
condition|(
name|sc
operator|->
name|sc_rxpend
condition|)
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|sc_rxpend
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxpend
operator|=
name|NULL
expr_stmt|;
block|}
name|error
operator|=
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_INIT_RX
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|sc
operator|->
name|sc_rxdoff
operator|=
name|awi_read_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_IRX_DATA_DESC
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rxmoff
operator|=
name|awi_read_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_IRX_PS_DESC
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_stop_txrx
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_KILL_RX
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_FTX_DATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_FTX_MGT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_FTX_BCAST
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_FTX_PS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_FTX_CF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_FLUSH_TX
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_init_region
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
block|{
switch|switch
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
condition|)
block|{
case|case
name|AWI_REG_DOMAIN_US
case|:
case|case
name|AWI_REG_DOMAIN_CA
case|:
case|case
name|AWI_REG_DOMAIN_EU
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|77
expr_stmt|;
break|break;
case|case
name|AWI_REG_DOMAIN_ES
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|26
expr_stmt|;
break|break;
case|case
name|AWI_REG_DOMAIN_FR
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|32
expr_stmt|;
break|break;
case|case
name|AWI_REG_DOMAIN_JP
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|6
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|17
expr_stmt|;
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
name|sc
operator|->
name|sc_scan_cur
operator|=
name|sc
operator|->
name|sc_scan_min
expr_stmt|;
name|sc
operator|->
name|sc_scan_set
operator|=
name|sc
operator|->
name|sc_scan_cur
operator|%
literal|3
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
condition|)
block|{
case|case
name|AWI_REG_DOMAIN_US
case|:
case|case
name|AWI_REG_DOMAIN_CA
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|11
expr_stmt|;
name|sc
operator|->
name|sc_scan_cur
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|AWI_REG_DOMAIN_EU
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|13
expr_stmt|;
name|sc
operator|->
name|sc_scan_cur
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|AWI_REG_DOMAIN_ES
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|10
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|11
expr_stmt|;
name|sc
operator|->
name|sc_scan_cur
operator|=
literal|10
expr_stmt|;
break|break;
case|case
name|AWI_REG_DOMAIN_FR
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|10
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|13
expr_stmt|;
name|sc
operator|->
name|sc_scan_cur
operator|=
literal|10
expr_stmt|;
break|break;
case|case
name|AWI_REG_DOMAIN_JP
case|:
name|sc
operator|->
name|sc_scan_min
operator|=
literal|14
expr_stmt|;
name|sc
operator|->
name|sc_scan_max
operator|=
literal|14
expr_stmt|;
name|sc
operator|->
name|sc_scan_cur
operator|=
literal|14
expr_stmt|;
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_start_scan
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|&&
name|sc
operator|->
name|sc_no_bssid
condition|)
block|{
name|memset
argument_list|(
operator|&
name|sc
operator|->
name|sc_bss
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_bss
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_bss
operator|.
name|rxtime
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|essid
argument_list|,
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|essid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
block|{
name|sc
operator|->
name|sc_bss
operator|.
name|chanset
operator|=
name|sc
operator|->
name|sc_scan_set
expr_stmt|;
name|sc
operator|->
name|sc_bss
operator|.
name|pattern
operator|=
name|sc
operator|->
name|sc_scan_cur
expr_stmt|;
name|sc
operator|->
name|sc_bss
operator|.
name|index
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_bss
operator|.
name|dwell_time
operator|=
literal|19
expr_stmt|;
comment|/*XXX*/
block|}
else|else
name|sc
operator|->
name|sc_bss
operator|.
name|chanset
operator|=
name|sc
operator|->
name|sc_scan_cur
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_SETSS
expr_stmt|;
name|error
operator|=
name|awi_set_ss
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_INFSC
argument_list|)
expr_stmt|;
else|else
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_ADHSC
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_start_bss
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_active_scan
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_mgt_timer
operator|=
name|AWI_ASCAN_WAIT
operator|/
literal|1000
expr_stmt|;
name|sc
operator|->
name|sc_ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_SCAN
expr_stmt|;
name|error
operator|=
name|awi_cmd_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_next_scan
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* 		 * The pattern parameter for FH phy should be incremented 		 * by 3.  But BayStack 650 Access Points apparently always 		 * assign hop pattern set parameter to 1 for any pattern. 		 * So we try all combinations of pattern/set parameters. 		 * Since this causes no error, it may be a bug of 		 * PCnetMobile firmware. 		 */
name|sc
operator|->
name|sc_scan_cur
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_scan_cur
operator|>
name|sc
operator|->
name|sc_scan_max
condition|)
block|{
name|sc
operator|->
name|sc_scan_cur
operator|=
name|sc
operator|->
name|sc_scan_min
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
name|sc
operator|->
name|sc_scan_set
operator|=
operator|(
name|sc
operator|->
name|sc_scan_set
operator|+
literal|1
operator|)
operator|%
literal|3
expr_stmt|;
block|}
name|error
operator|=
name|awi_cmd_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|EINVAL
condition|)
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_stop_scan
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|,
modifier|*
name|sbp
decl_stmt|;
name|bp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
block|{
name|notfound
label|:
if|if
condition|(
name|sc
operator|->
name|sc_active_scan
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"%s: entering passive scan mode\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_active_scan
operator|=
literal|0
expr_stmt|;
block|}
name|sc
operator|->
name|sc_mgt_timer
operator|=
name|AWI_PSCAN_WAIT
operator|/
literal|1000
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|awi_next_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|sbp
operator|=
name|NULL
expr_stmt|;
for|for
control|(
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|TAILQ_NEXT
argument_list|(
name|bp
argument_list|,
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|bp
operator|->
name|fails
condition|)
block|{
comment|/* 			 * The configuration of the access points may change 			 * during my scan.  So we retries to associate with 			 * it unless there are any suitable AP. 			 */
if|if
condition|(
name|bp
operator|->
name|fails
operator|<
literal|3
condition|)
continue|continue;
name|bp
operator|->
name|fails
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|1
index|]
operator|!=
literal|0
operator|&&
name|memcmp
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
argument_list|,
name|bp
operator|->
name|essid
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|essid
argument_list|)
operator|!=
literal|0
argument_list|)
condition|)
continue|continue;
comment|/* 		 * Since the firmware apparently scans not only the specified 		 * channel of SCAN command but all available channel within 		 * the region, we should filter out unnecessary responses here. 		 */
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
block|{
if|if
condition|(
name|bp
operator|->
name|pattern
operator|<
name|sc
operator|->
name|sc_scan_min
operator|||
name|bp
operator|->
name|pattern
operator|>
name|sc
operator|->
name|sc_scan_max
condition|)
continue|continue;
block|}
else|else
block|{
if|if
condition|(
name|bp
operator|->
name|chanset
operator|<
name|sc
operator|->
name|sc_scan_min
operator|||
name|bp
operator|->
name|chanset
operator|>
name|sc
operator|->
name|sc_scan_max
condition|)
continue|continue;
block|}
if|if
condition|(
name|sbp
operator|==
name|NULL
operator|||
name|bp
operator|->
name|rssi
operator|>
name|sbp
operator|->
name|rssi
condition|)
name|sbp
operator|=
name|bp
expr_stmt|;
block|}
if|if
condition|(
name|sbp
operator|==
name|NULL
condition|)
goto|goto
name|notfound
goto|;
name|sc
operator|->
name|sc_bss
operator|=
operator|*
name|sbp
expr_stmt|;
operator|(
name|void
operator|)
name|awi_set_ss
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_recv_beacon
parameter_list|(
name|sc
parameter_list|,
name|m0
parameter_list|,
name|rxts
parameter_list|,
name|rssi
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
name|u_int32_t
name|rxts
decl_stmt|;
name|u_int8_t
name|rssi
decl_stmt|;
block|{
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|;
name|u_int8_t
modifier|*
name|frame
decl_stmt|,
modifier|*
name|eframe
decl_stmt|;
name|u_int8_t
modifier|*
name|tstamp
decl_stmt|,
modifier|*
name|capinfo
decl_stmt|,
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|rates
decl_stmt|,
modifier|*
name|parms
decl_stmt|;
name|u_int16_t
name|bintval
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_status
operator|!=
name|AWI_ST_SCAN
condition|)
return|return;
name|wh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|frame
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|wh
index|[
literal|1
index|]
expr_stmt|;
name|eframe
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|+
name|m0
operator|->
name|m_len
expr_stmt|;
comment|/* 	 * XXX: 	 *	timestamp [8] 	 *	beacon interval [2] 	 *	capability information [2] 	 *	ssid [tlv] 	 *	supported rates [tlv] 	 *	parameter set [tlv] 	 *	... 	 */
if|if
condition|(
name|frame
operator|+
literal|12
operator|>
name|eframe
condition|)
block|{
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
name|printf
argument_list|(
literal|"awi_recv_beacon: frame too short \n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
name|tstamp
operator|=
name|frame
expr_stmt|;
name|frame
operator|+=
literal|8
expr_stmt|;
name|bintval
operator|=
name|LE_READ_2
argument_list|(
name|frame
argument_list|)
expr_stmt|;
name|frame
operator|+=
literal|2
expr_stmt|;
name|capinfo
operator|=
name|frame
expr_stmt|;
name|frame
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|capinfo
index|[
literal|0
index|]
operator|&
name|IEEE80211_CAPINFO_ESS
operator|)
operator|||
operator|(
name|capinfo
index|[
literal|0
index|]
operator|&
name|IEEE80211_CAPINFO_IBSS
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
name|printf
argument_list|(
literal|"awi_recv_beacon: non ESS \n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|capinfo
index|[
literal|0
index|]
operator|&
name|IEEE80211_CAPINFO_ESS
operator|)
operator|||
operator|!
operator|(
name|capinfo
index|[
literal|0
index|]
operator|&
name|IEEE80211_CAPINFO_IBSS
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
name|printf
argument_list|(
literal|"awi_recv_beacon: non IBSS \n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
block|}
name|ssid
operator|=
name|rates
operator|=
name|parms
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|frame
operator|<
name|eframe
condition|)
block|{
switch|switch
condition|(
operator|*
name|frame
condition|)
block|{
case|case
name|IEEE80211_ELEMID_SSID
case|:
name|ssid
operator|=
name|frame
expr_stmt|;
break|break;
case|case
name|IEEE80211_ELEMID_RATES
case|:
name|rates
operator|=
name|frame
expr_stmt|;
break|break;
case|case
name|IEEE80211_ELEMID_FHPARMS
case|:
case|case
name|IEEE80211_ELEMID_DSPARMS
case|:
name|parms
operator|=
name|frame
expr_stmt|;
break|break;
block|}
name|frame
operator|+=
name|frame
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|rates
operator|==
name|NULL
operator|||
name|parms
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
name|printf
argument_list|(
literal|"awi_recv_beacon: ssid=%p, rates=%p, parms=%p\n"
argument_list|,
name|ssid
argument_list|,
name|rates
argument_list|,
name|parms
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
name|ssid
index|[
literal|1
index|]
operator|>
name|IEEE80211_NWID_LEN
condition|)
block|{
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
name|printf
argument_list|(
literal|"awi_recv_beacon: bad ssid len: %d from %s\n"
argument_list|,
name|ssid
index|[
literal|1
index|]
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
for|for
control|(
name|bp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|TAILQ_NEXT
argument_list|(
name|bp
argument_list|,
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|bp
operator|->
name|esrc
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|==
literal|0
operator|&&
name|memcmp
argument_list|(
name|bp
operator|->
name|bssid
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
block|{
name|bp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|awi_bss
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
return|return;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|,
name|bp
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bp
operator|->
name|esrc
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bp
operator|->
name|bssid
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|bp
operator|->
name|essid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|essid
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|bp
operator|->
name|essid
argument_list|,
name|ssid
argument_list|,
literal|2
operator|+
name|ssid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|bp
operator|->
name|rssi
operator|=
name|rssi
expr_stmt|;
name|bp
operator|->
name|rxtime
operator|=
name|rxts
expr_stmt|;
name|memcpy
argument_list|(
name|bp
operator|->
name|timestamp
argument_list|,
name|tstamp
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
operator|->
name|timestamp
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|->
name|interval
operator|=
name|bintval
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
block|{
name|bp
operator|->
name|chanset
operator|=
name|parms
index|[
literal|4
index|]
expr_stmt|;
name|bp
operator|->
name|pattern
operator|=
name|parms
index|[
literal|5
index|]
expr_stmt|;
name|bp
operator|->
name|index
operator|=
name|parms
index|[
literal|6
index|]
expr_stmt|;
name|bp
operator|->
name|dwell_time
operator|=
name|LE_READ_2
argument_list|(
name|parms
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bp
operator|->
name|chanset
operator|=
name|parms
index|[
literal|2
index|]
expr_stmt|;
name|bp
operator|->
name|pattern
operator|=
literal|0
expr_stmt|;
name|bp
operator|->
name|index
operator|=
literal|0
expr_stmt|;
name|bp
operator|->
name|dwell_time
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_mgt_timer
operator|==
literal|0
condition|)
name|awi_stop_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_set_ss
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_SETSS
expr_stmt|;
name|bp
operator|=
operator|&
name|sc
operator|->
name|sc_bss
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
block|{
name|printf
argument_list|(
literal|"%s: ch %d pat %d id %d dw %d iv %d bss %s ssid \"%s\"\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|bp
operator|->
name|chanset
argument_list|,
name|bp
operator|->
name|pattern
argument_list|,
name|bp
operator|->
name|index
argument_list|,
name|bp
operator|->
name|dwell_time
argument_list|,
name|bp
operator|->
name|interval
argument_list|,
name|ether_sprintf
argument_list|(
name|bp
operator|->
name|bssid
argument_list|)
argument_list|,
name|bp
operator|->
name|essid
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mgt
operator|.
name|aCurrent_BSS_ID
argument_list|,
name|bp
operator|->
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mgt
operator|.
name|aCurrent_ESS_ID
argument_list|,
name|bp
operator|->
name|essid
argument_list|,
name|AWI_ESS_ID_SIZE
argument_list|)
expr_stmt|;
name|LE_WRITE_2
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mgt
operator|.
name|aBeacon_Period
argument_list|,
name|bp
operator|->
name|interval
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SET_MIB
argument_list|,
name|AWI_MIB_MGT
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_try_sync
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_SYNC
expr_stmt|;
name|bp
operator|=
operator|&
name|sc
operator|->
name|sc_bss
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_cmd_inprog
condition|)
block|{
if|if
condition|(
name|awi_cmd_wait
argument_list|(
name|sc
argument_list|)
condition|)
return|return;
block|}
name|sc
operator|->
name|sc_cmd_inprog
operator|=
literal|1
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_SET
argument_list|,
name|bp
operator|->
name|chanset
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_PATTERN
argument_list|,
name|bp
operator|->
name|pattern
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_IDX
argument_list|,
name|bp
operator|->
name|index
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_STARTBSS
argument_list|,
name|sc
operator|->
name|sc_start_bss
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|awi_write_2
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_DWELL
argument_list|,
name|bp
operator|->
name|dwell_time
argument_list|)
expr_stmt|;
name|awi_write_2
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_MBZ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_bytes
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_TIMESTAMP
argument_list|,
name|bp
operator|->
name|timestamp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|awi_write_4
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SYNC_REFTIME
argument_list|,
name|bp
operator|->
name|rxtime
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SYNC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_sync_done
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
block|{
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_INFSY
argument_list|)
expr_stmt|;
name|awi_send_auth
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s: synced with %s ssid \"%s\" at chanset %d\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|essid
operator|+
literal|2
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|chanset
argument_list|)
expr_stmt|;
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_ADHSY
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_RUNNING
expr_stmt|;
name|awi_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|awi_send_deauth
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|u_int8_t
modifier|*
name|deauth
decl_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"%s: sending deauth to %s\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|=
name|IEEE80211_FC0_VERSION_0
operator||
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_AUTH
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|=
name|IEEE80211_FC1_DIR_NODS
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_dur
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aMAC_Address
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|deauth
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|wh
index|[
literal|1
index|]
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|deauth
argument_list|,
name|IEEE80211_REASON_AUTH_LEAVE
argument_list|)
expr_stmt|;
name|deauth
operator|+=
literal|2
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|deauth
operator|-
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
expr_stmt|;
name|IF_ENQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_mgtq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|awi_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_INFTOSS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_send_auth
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|u_int8_t
modifier|*
name|auth
decl_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_AUTH
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"%s: sending auth to %s\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|=
name|IEEE80211_FC0_VERSION_0
operator||
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_AUTH
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|=
name|IEEE80211_FC1_DIR_NODS
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_dur
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aMAC_Address
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|auth
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|wh
index|[
literal|1
index|]
expr_stmt|;
comment|/* algorithm number */
name|LE_WRITE_2
argument_list|(
name|auth
argument_list|,
name|IEEE80211_AUTH_ALG_OPEN
argument_list|)
expr_stmt|;
name|auth
operator|+=
literal|2
expr_stmt|;
comment|/* sequence number */
name|LE_WRITE_2
argument_list|(
name|auth
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|auth
operator|+=
literal|2
expr_stmt|;
comment|/* status */
name|LE_WRITE_2
argument_list|(
name|auth
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|auth
operator|+=
literal|2
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|auth
operator|-
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
expr_stmt|;
name|IF_ENQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_mgtq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|awi_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mgt_timer
operator|=
name|AWI_TRANS_TIMEOUT
operator|/
literal|1000
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_recv_auth
parameter_list|(
name|sc
parameter_list|,
name|m0
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
block|{
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|u_int8_t
modifier|*
name|auth
decl_stmt|,
modifier|*
name|eframe
decl_stmt|;
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|;
name|u_int16_t
name|status
decl_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|auth
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|wh
index|[
literal|1
index|]
expr_stmt|;
name|eframe
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|+
name|m0
operator|->
name|m_len
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"%s: receive auth from %s\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
block|{
comment|/* XXX: 802.11 allow auth for IBSS */
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_status
operator|!=
name|AWI_ST_AUTH
condition|)
return|return;
comment|/* algorithm number */
if|if
condition|(
name|LE_READ_2
argument_list|(
name|auth
argument_list|)
operator|!=
name|IEEE80211_AUTH_ALG_OPEN
condition|)
return|return;
name|auth
operator|+=
literal|2
expr_stmt|;
comment|/* sequence number */
if|if
condition|(
name|LE_READ_2
argument_list|(
name|auth
argument_list|)
operator|!=
literal|2
condition|)
return|return;
name|auth
operator|+=
literal|2
expr_stmt|;
comment|/* status */
name|status
operator|=
name|LE_READ_2
argument_list|(
name|auth
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: authentication failed (reason %d)\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|status
argument_list|)
expr_stmt|;
for|for
control|(
name|bp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|TAILQ_NEXT
argument_list|(
name|bp
argument_list|,
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|bp
operator|->
name|esrc
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|esrc
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bp
operator|->
name|fails
operator|++
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
name|sc
operator|->
name|sc_mgt_timer
operator|=
literal|0
expr_stmt|;
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_INFAUTH
argument_list|)
expr_stmt|;
name|awi_send_asreq
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_send_asreq
parameter_list|(
name|sc
parameter_list|,
name|reassoc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|reassoc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|sc_ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|u_int16_t
name|lintval
decl_stmt|;
name|u_int8_t
modifier|*
name|asreq
decl_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_ASSOC
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"%s: sending %sassoc req to %s\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|reassoc
condition|?
literal|"re"
else|:
literal|""
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|=
name|IEEE80211_FC0_VERSION_0
operator||
name|IEEE80211_FC0_TYPE_MGT
expr_stmt|;
if|if
condition|(
name|reassoc
condition|)
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_SUBTYPE_REASSOC_REQ
expr_stmt|;
else|else
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_SUBTYPE_ASSOC_REQ
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|=
name|IEEE80211_FC1_DIR_NODS
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_dur
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|wh
operator|->
name|i_seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aMAC_Address
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|asreq
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|wh
index|[
literal|1
index|]
expr_stmt|;
comment|/* capability info */
name|LE_WRITE_2
argument_list|(
name|asreq
argument_list|,
name|IEEE80211_CAPINFO_CF_POLLABLE
argument_list|)
expr_stmt|;
name|asreq
operator|+=
literal|2
expr_stmt|;
comment|/* listen interval */
name|lintval
operator|=
name|LE_READ_2
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mgt
operator|.
name|aListen_Interval
argument_list|)
expr_stmt|;
name|LE_WRITE_2
argument_list|(
name|asreq
argument_list|,
name|lintval
argument_list|)
expr_stmt|;
name|asreq
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|reassoc
condition|)
block|{
comment|/* current AP address */
name|memcpy
argument_list|(
name|asreq
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|asreq
operator|+=
name|ETHER_ADDR_LEN
expr_stmt|;
block|}
comment|/* ssid */
name|memcpy
argument_list|(
name|asreq
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|essid
argument_list|,
literal|2
operator|+
name|sc
operator|->
name|sc_bss
operator|.
name|essid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|asreq
operator|+=
literal|2
operator|+
name|asreq
index|[
literal|1
index|]
expr_stmt|;
comment|/* supported rates */
name|memcpy
argument_list|(
name|asreq
argument_list|,
operator|&
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aSuprt_Data_Rates
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|asreq
operator|+=
literal|2
operator|+
name|asreq
index|[
literal|1
index|]
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|asreq
operator|-
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
expr_stmt|;
name|IF_ENQUEUE
argument_list|(
operator|&
name|sc
operator|->
name|sc_mgtq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|awi_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mgt_timer
operator|=
name|AWI_TRANS_TIMEOUT
operator|/
literal|1000
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_recv_asresp
parameter_list|(
name|sc
parameter_list|,
name|m0
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
block|{
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|u_int8_t
modifier|*
name|asresp
decl_stmt|,
modifier|*
name|eframe
decl_stmt|;
name|u_int16_t
name|status
decl_stmt|;
name|u_int8_t
name|rate
decl_stmt|,
modifier|*
name|phy_rates
decl_stmt|;
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|asresp
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|wh
index|[
literal|1
index|]
expr_stmt|;
name|eframe
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
name|u_int8_t
operator|*
argument_list|)
operator|+
name|m0
operator|->
name|m_len
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ifp
operator|->
name|if_flags
operator|&
name|IFF_DEBUG
condition|)
name|printf
argument_list|(
literal|"%s: receive assoc resp from %s\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|sc_status
operator|!=
name|AWI_ST_ASSOC
condition|)
return|return;
comment|/* capability info */
name|asresp
operator|+=
literal|2
expr_stmt|;
comment|/* status */
name|status
operator|=
name|LE_READ_2
argument_list|(
name|asresp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: association failed (reason %d)\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|status
argument_list|)
expr_stmt|;
for|for
control|(
name|bp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
init|;
name|bp
operator|!=
name|NULL
condition|;
name|bp
operator|=
name|TAILQ_NEXT
argument_list|(
name|bp
argument_list|,
name|list
argument_list|)
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|bp
operator|->
name|esrc
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|esrc
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bp
operator|->
name|fails
operator|++
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
name|asresp
operator|+=
literal|2
expr_stmt|;
comment|/* association id */
name|asresp
operator|+=
literal|2
expr_stmt|;
comment|/* supported rates */
name|rate
operator|=
name|AWI_RATE_1MBIT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|asresp
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|AWI_80211_RATE
argument_list|(
name|asresp
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
operator|<=
name|rate
condition|)
continue|continue;
name|phy_rates
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aSuprt_Data_Rates
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|phy_rates
index|[
literal|1
index|]
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|AWI_80211_RATE
argument_list|(
name|asresp
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
operator|==
name|AWI_80211_RATE
argument_list|(
name|phy_rates
index|[
literal|2
operator|+
name|j
index|]
argument_list|)
condition|)
name|rate
operator|=
name|AWI_80211_RATE
argument_list|(
name|asresp
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"%s: associated with %s ssid \"%s\""
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|ether_sprintf
argument_list|(
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|essid
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
name|printf
argument_list|(
literal|" chanset %d pattern %d"
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|chanset
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|pattern
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" channel %d"
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|chanset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" signal %d\n"
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|rssi
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_rate
operator|=
name|rate
expr_stmt|;
name|sc
operator|->
name|sc_mgt_timer
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_rx_timer
operator|=
literal|10
expr_stmt|;
name|sc
operator|->
name|sc_ifp
operator|->
name|if_timer
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_status
operator|=
name|AWI_ST_RUNNING
expr_stmt|;
name|sc
operator|->
name|sc_ifp
operator|->
name|if_flags
operator||=
name|IFF_RUNNING
expr_stmt|;
name|awi_drvstate
argument_list|(
name|sc
argument_list|,
name|AWI_DRV_INFASSOC
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|bp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|,
name|bp
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|awi_start
argument_list|(
name|sc
operator|->
name|sc_ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_mib
parameter_list|(
name|sc
parameter_list|,
name|cmd
parameter_list|,
name|mib
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|u_int8_t
name|cmd
decl_stmt|;
name|u_int8_t
name|mib
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|u_int8_t
name|size
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
switch|switch
condition|(
name|mib
condition|)
block|{
case|case
name|AWI_MIB_LOCAL
case|:
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_mib_local
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_mib_local
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWI_MIB_ADDR
case|:
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_mib_addr
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_mib_addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWI_MIB_MAC
case|:
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_mib_mac
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_mib_mac
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWI_MIB_STAT
case|:
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_mib_stat
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_mib_stat
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWI_MIB_MGT
case|:
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_mib_mgt
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_mib_mgt
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWI_MIB_PHY
case|:
name|ptr
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_mib_phy
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_mib_phy
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_cmd_inprog
condition|)
block|{
name|error
operator|=
name|awi_cmd_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"awi_mib: cmd %d inprog\n"
argument_list|,
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
name|sc
operator|->
name|sc_cmd_inprog
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|AWI_CMD_SET_MIB
condition|)
name|awi_write_bytes
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_MIB_DATA
argument_list|,
name|ptr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_MIB_TYPE
argument_list|,
name|mib
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_MIB_SIZE
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_MIB_INDEX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
name|cmd
operator|==
name|AWI_CMD_GET_MIB
condition|)
block|{
name|awi_read_bytes
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_MIB_DATA
argument_list|,
name|ptr
argument_list|,
name|size
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AWI_DEBUG
if|if
condition|(
name|awi_verbose
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"awi_mib: #%d:"
argument_list|,
name|mib
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %02x"
argument_list|,
name|ptr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_cmd_scan
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|u_int8_t
name|scan_mode
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_active_scan
condition|)
name|scan_mode
operator|=
name|AWI_SCAN_ACTIVE
expr_stmt|;
else|else
name|scan_mode
operator|=
name|AWI_SCAN_PASSIVE
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_mgt
operator|.
name|aScan_Mode
operator|!=
name|scan_mode
condition|)
block|{
name|sc
operator|->
name|sc_mib_mgt
operator|.
name|aScan_Mode
operator|=
name|scan_mode
expr_stmt|;
name|error
operator|=
name|awi_mib
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SET_MIB
argument_list|,
name|AWI_MIB_MGT
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_cmd_inprog
condition|)
block|{
name|error
operator|=
name|awi_cmd_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
block|}
name|sc
operator|->
name|sc_cmd_inprog
operator|=
literal|1
expr_stmt|;
name|awi_write_2
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_DURATION
argument_list|,
name|sc
operator|->
name|sc_active_scan
condition|?
name|AWI_ASCAN_DURATION
else|:
name|AWI_PSCAN_DURATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
block|{
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_SET
argument_list|,
name|sc
operator|->
name|sc_scan_set
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_PATTERN
argument_list|,
name|sc
operator|->
name|sc_scan_cur
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_IDX
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_SET
argument_list|,
name|sc
operator|->
name|sc_scan_cur
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_PATTERN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_IDX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_PARAMS
operator|+
name|AWI_CA_SCAN_SUSP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|awi_cmd
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_SCAN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_cmd
parameter_list|(
name|sc
parameter_list|,
name|cmd
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|u_int8_t
name|cmd
decl_stmt|;
block|{
name|u_int8_t
name|status
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|sc
operator|->
name|sc_cmd_inprog
operator|=
literal|1
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_STATUS
argument_list|,
name|AWI_STAT_IDLE
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_status
operator|!=
name|AWI_ST_INIT
condition|)
return|return
literal|0
return|;
name|error
operator|=
name|awi_cmd_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|status
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_STATUS
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|AWI_STAT_OK
case|:
break|break;
case|case
name|AWI_STAT_BADPARM
case|:
return|return
name|EINVAL
return|;
default|default:
name|printf
argument_list|(
literal|"%s: command %d failed %x\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|cmd
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_cmd_done
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int8_t
name|cmd
decl_stmt|,
name|status
decl_stmt|;
name|status
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AWI_STAT_IDLE
condition|)
return|return;
comment|/* stray interrupt */
name|sc
operator|->
name|sc_cmd_inprog
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_status
operator|==
name|AWI_ST_INIT
condition|)
block|{
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|cmd
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD
argument_list|)
expr_stmt|;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|AWI_STAT_OK
condition|)
block|{
name|printf
argument_list|(
literal|"%s: command %d failed %x\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|,
name|cmd
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|sc
operator|->
name|sc_status
condition|)
block|{
case|case
name|AWI_ST_SCAN
case|:
if|if
condition|(
name|cmd
operator|==
name|AWI_CMD_SET_MIB
condition|)
name|awi_cmd_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* retry */
break|break;
case|case
name|AWI_ST_SETSS
case|:
name|awi_try_sync
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|AWI_ST_SYNC
case|:
name|awi_sync_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|awi_next_txd
parameter_list|(
name|sc
parameter_list|,
name|len
parameter_list|,
name|framep
parameter_list|,
name|ntxdp
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|len
decl_stmt|;
name|u_int32_t
modifier|*
name|framep
decl_stmt|,
decl|*
name|ntxdp
decl_stmt|;
end_function

begin_block
block|{
name|u_int32_t
name|txd
decl_stmt|,
name|ntxd
decl_stmt|,
name|frame
decl_stmt|;
name|txd
operator|=
name|sc
operator|->
name|sc_txnext
expr_stmt|;
name|frame
operator|=
name|txd
operator|+
name|AWI_TXD_SIZE
expr_stmt|;
if|if
condition|(
name|frame
operator|+
name|len
operator|>
name|sc
operator|->
name|sc_txend
condition|)
name|frame
operator|=
name|sc
operator|->
name|sc_txbase
expr_stmt|;
name|ntxd
operator|=
name|frame
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|ntxd
operator|+
name|AWI_TXD_SIZE
operator|>
name|sc
operator|->
name|sc_txend
condition|)
name|ntxd
operator|=
name|sc
operator|->
name|sc_txbase
expr_stmt|;
operator|*
name|framep
operator|=
name|frame
expr_stmt|;
operator|*
name|ntxdp
operator|=
name|ntxd
expr_stmt|;
comment|/* 	 * Determine if there are any room in ring buffer. 	 *		--- send wait,  === new data,  +++ conflict (ENOBUFS) 	 *   base........................end 	 *	   done----txd=====ntxd		OK 	 *	 --txd=====done++++ntxd--	full 	 *	 --txd=====ntxd    done--	OK 	 *	 ==ntxd    done----txd===	OK 	 *	 ==done++++ntxd----txd===	full 	 *	 ++ntxd    txd=====done++	full 	 */
if|if
condition|(
name|txd
operator|<
name|ntxd
condition|)
block|{
if|if
condition|(
name|txd
operator|<
name|sc
operator|->
name|sc_txdone
operator|&&
name|ntxd
operator|+
name|AWI_TXD_SIZE
operator|>
name|sc
operator|->
name|sc_txdone
condition|)
return|return
name|ENOBUFS
return|;
block|}
else|else
block|{
if|if
condition|(
name|txd
operator|<
name|sc
operator|->
name|sc_txdone
operator|||
name|ntxd
operator|+
name|AWI_TXD_SIZE
operator|>
name|sc
operator|->
name|sc_txdone
condition|)
return|return
name|ENOBUFS
return|;
block|}
return|return
literal|0
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|awi_lock
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_invalid
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|curproc
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * XXX 		 * Though driver ioctl should be called with context, 		 * KAME ipv6 stack calls ioctl in interrupt for now. 		 * We simply abort the request if there are other 		 * ioctl requests in progress. 		 */
if|if
condition|(
name|sc
operator|->
name|sc_busy
condition|)
return|return
name|EWOULDBLOCK
return|;
name|sc
operator|->
name|sc_busy
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_cansleep
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
name|sc
operator|->
name|sc_busy
condition|)
block|{
name|sc
operator|->
name|sc_sleep_cnt
operator|++
expr_stmt|;
name|error
operator|=
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PWAIT
operator||
name|PCATCH
argument_list|,
literal|"awilck"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sleep_cnt
operator|--
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
name|sc
operator|->
name|sc_invalid
condition|)
return|return
name|ENXIO
return|;
block|}
name|sc
operator|->
name|sc_busy
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_cansleep
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_unlock
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|sc
operator|->
name|sc_busy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_cansleep
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_sleep_cnt
condition|)
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_intr_lock
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int8_t
name|status
decl_stmt|;
name|int
name|i
decl_stmt|,
name|retry
decl_stmt|;
name|status
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|retry
operator|=
literal|0
init|;
name|retry
operator|<
literal|10
condition|;
name|retry
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AWI_LOCKOUT_TIMEOUT
operator|*
literal|1000
operator|/
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_LOCKOUT_HOST
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
break|break;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_LOCKOUT_MAC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_LOCKOUT_HOST
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
break|break;
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_LOCKOUT_MAC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: failed to lock interrupt\n"
argument_list|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_xname
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|awi_intr_unlock
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|awi_write_1
argument_list|(
name|sc
argument_list|,
name|AWI_LOCKOUT_MAC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_cmd_wait
parameter_list|(
name|sc
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|sc_cmd_inprog
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_invalid
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|sc
operator|->
name|sc_cansleep
condition|)
block|{
name|sc
operator|->
name|sc_sleep_cnt
operator|++
expr_stmt|;
name|error
operator|=
name|tsleep
argument_list|(
name|sc
argument_list|,
name|PWAIT
argument_list|,
literal|"awicmd"
argument_list|,
name|AWI_CMD_TIMEOUT
operator|*
name|hz
operator|/
literal|1000
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sleep_cnt
operator|--
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|awi_read_1
argument_list|(
name|sc
argument_list|,
name|AWI_CMD_STATUS
argument_list|)
operator|!=
name|AWI_STAT_IDLE
condition|)
block|{
name|awi_cmd_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|++
operator|>=
name|AWI_CMD_TIMEOUT
operator|*
literal|1000
operator|/
literal|10
condition|)
name|error
operator|=
name|EWOULDBLOCK
expr_stmt|;
else|else
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|AWI_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|awi_dump_pkt
parameter_list|(
name|sc
parameter_list|,
name|m
parameter_list|,
name|rssi
parameter_list|)
name|struct
name|awi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|u_int8_t
name|rssi
decl_stmt|;
block|{
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|int
name|i
decl_stmt|,
name|l
decl_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|awi_dump_mask
operator|!=
literal|0
operator|&&
operator|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_MASK
operator|)
operator|==
name|IEEE80211_FC1_DIR_NODS
operator|)
operator|&&
operator|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
operator|)
operator|==
name|IEEE80211_FC0_TYPE_MGT
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|AWI_DUMP_MASK
argument_list|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
argument_list|)
operator|&
name|awi_dump_mask
operator|)
operator|!=
literal|0
condition|)
return|return;
block|}
if|if
condition|(
name|awi_dump_mask
operator|<
literal|0
operator|&&
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
operator|)
operator|==
name|IEEE80211_FC0_TYPE_DATA
condition|)
return|return;
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_MASK
condition|)
block|{
case|case
name|IEEE80211_FC1_DIR_NODS
case|:
name|printf
argument_list|(
literal|"rx: NODS %s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"->%s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC1_DIR_TODS
case|:
name|printf
argument_list|(
literal|"rx: TODS %s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"->%s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC1_DIR_FROMDS
case|:
name|printf
argument_list|(
literal|"rx: FRDS %s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"->%s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC1_DIR_DSTODS
case|:
name|printf
argument_list|(
literal|"rx: DSDS %s"
argument_list|,
name|ether_sprintf
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|wh
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"->%s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"(%s"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"->%s)"
argument_list|,
name|ether_sprintf
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_TYPE_DATA
case|:
name|printf
argument_list|(
literal|" data"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_TYPE_MGT
case|:
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_SUBTYPE_PROBE_REQ
case|:
name|printf
argument_list|(
literal|" probe_req"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
case|:
name|printf
argument_list|(
literal|" probe_resp"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_BEACON
case|:
name|printf
argument_list|(
literal|" beacon"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_AUTH
case|:
name|printf
argument_list|(
literal|" auth"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_ASSOC_REQ
case|:
name|printf
argument_list|(
literal|" assoc_req"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
case|:
name|printf
argument_list|(
literal|" assoc_resp"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_REASSOC_REQ
case|:
name|printf
argument_list|(
literal|" reassoc_req"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_REASSOC_RESP
case|:
name|printf
argument_list|(
literal|" reassoc_resp"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_DEAUTH
case|:
name|printf
argument_list|(
literal|" deauth"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_DISASSOC
case|:
name|printf
argument_list|(
literal|" disassoc"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" mgt#%d"
argument_list|,
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|" type#%d"
argument_list|,
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|" +%d\n"
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
if|if
condition|(
name|awi_dump_len
operator|>
literal|0
condition|)
block|{
name|l
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
if|if
condition|(
name|l
operator|>
name|awi_dump_len
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
condition|)
name|l
operator|=
name|awi_dump_len
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|i
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
if|if
condition|(
name|awi_dump_hdr
condition|)
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|u_int8_t
operator|*
argument_list|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


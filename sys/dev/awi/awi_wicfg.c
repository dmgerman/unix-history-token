begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: awi_wicfg.c,v 1.3 2000/07/06 17:22:25 onoe Exp $	*/
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2000 The NetBSD Foundation, Inc.  * All rights reserved.  *  * This code is derived from software contributed to The NetBSD Foundation  * by Atsushi Onoe.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the NetBSD  *	Foundation, Inc. and its contributors.  * 4. Neither the name of The NetBSD Foundation nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * WaveLAN compatible configuration support routines for the awi driver.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD__
operator|>=
literal|4
end_if

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<net/if_ether.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_ieee80211.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/ic/am79c930reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/am79c930var.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/awireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/awivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pcmcia/if_wi_ieee.h>
end_include

begin_comment
comment|/* XXX */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<dev/awi/am79c930reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/awi/am79c930var.h>
end_include

begin_undef
undef|#
directive|undef
name|_KERNEL
end_undef

begin_comment
comment|/* XXX */
end_comment

begin_include
include|#
directive|include
file|<i386/include/if_wavelan_ieee.h>
end_include

begin_comment
comment|/* XXX */
end_comment

begin_define
define|#
directive|define
name|_KERNEL
end_define

begin_comment
comment|/* XXX */
end_comment

begin_include
include|#
directive|include
file|<dev/awi/awireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/awi/awivar.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|awi_cfgget
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|,
name|u_long
name|cmd
operator|,
name|caddr_t
name|data
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|awi_cfgset
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
name|ifp
operator|,
name|u_long
name|cmd
operator|,
name|caddr_t
name|data
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|awi_wicfg
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCGWAVELAN
case|:
name|error
operator|=
name|awi_cfgget
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSWAVELAN
case|:
ifdef|#
directive|ifdef
name|__FreeBSD__
name|error
operator|=
name|suser
argument_list|(
name|curproc
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|suser
argument_list|(
name|curproc
operator|->
name|p_ucred
argument_list|,
operator|&
name|curproc
operator|->
name|p_acflag
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
condition|)
break|break;
name|error
operator|=
name|awi_cfgset
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_cfgget
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|keylen
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|struct
name|awi_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|awi_softc
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|wi_ltv_keys
modifier|*
name|keys
decl_stmt|;
name|struct
name|wi_key
modifier|*
name|k
decl_stmt|;
name|struct
name|wi_req
name|wreq
decl_stmt|;
ifdef|#
directive|ifdef
name|WICACHE
name|struct
name|wi_sigcache
name|wsc
decl_stmt|;
name|struct
name|awi_bss
modifier|*
name|bp
decl_stmt|;
endif|#
directive|endif
comment|/* WICACHE */
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|wreq
argument_list|,
sizeof|sizeof
argument_list|(
name|wreq
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
switch|switch
condition|(
name|wreq
operator|.
name|wi_type
condition|)
block|{
case|case
name|WI_RID_SERIALNO
case|:
name|memcpy
argument_list|(
name|wreq
operator|.
name|wi_val
argument_list|,
name|sc
operator|->
name|sc_banner
argument_list|,
name|AWI_BANNER_LEN
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
operator|(
name|AWI_BANNER_LEN
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_NODENAME
case|:
name|strcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|strlen
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
operator|(
literal|1
operator|+
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_OWN_SSID
case|:
name|p
operator|=
name|sc
operator|->
name|sc_ownssid
expr_stmt|;
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
argument_list|,
name|p
operator|+
literal|2
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
operator|(
literal|1
operator|+
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_CURRENT_SSID
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
block|{
name|p
operator|=
name|sc
operator|->
name|sc_bss
operator|.
name|essid
expr_stmt|;
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
argument_list|,
name|p
operator|+
literal|2
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|wreq
operator|.
name|wi_len
operator|=
operator|(
literal|1
operator|+
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_DESIRED_SSID
case|:
name|p
operator|=
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
expr_stmt|;
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|p
index|[
literal|1
index|]
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
argument_list|,
name|p
operator|+
literal|2
argument_list|,
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
operator|(
literal|1
operator|+
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_CURRENT_BSSID
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
name|memcpy
argument_list|(
name|wreq
operator|.
name|wi_val
argument_list|,
name|sc
operator|->
name|sc_bss
operator|.
name|bssid
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|wreq
operator|.
name|wi_val
argument_list|,
literal|0
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
name|ETHER_ADDR_LEN
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_CHANNEL_LIST
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
block|{
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_scan_min
expr_stmt|;
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
operator|=
name|sc
operator|->
name|sc_scan_max
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|sc
operator|->
name|sc_scan_min
init|;
name|i
operator|<=
name|sc
operator|->
name|sc_scan_max
condition|;
name|i
operator|++
control|)
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator||=
literal|1
operator|<<
operator|(
name|i
operator|-
literal|1
operator|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|WI_RID_OWN_CHNL
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_ownch
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_CURRENT_CHAN
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_bss
operator|.
name|pattern
expr_stmt|;
else|else
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_bss
operator|.
name|chanset
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_COMMS_QUALITY
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* quality */
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
operator|=
name|sc
operator|->
name|sc_bss
operator|.
name|rssi
expr_stmt|;
comment|/* signal */
name|wreq
operator|.
name|wi_val
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* noise */
name|wreq
operator|.
name|wi_len
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|WI_RID_PROMISC
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aPromiscuous_Enable
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_PORTTYPE
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_no_bssid
condition|)
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|2
expr_stmt|;
else|else
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|3
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_MAC_NODE
case|:
name|memcpy
argument_list|(
name|wreq
operator|.
name|wi_val
argument_list|,
name|sc
operator|->
name|sc_mib_addr
operator|.
name|aMAC_Address
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
name|ETHER_ADDR_LEN
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_TX_RATE
case|:
case|case
name|WI_RID_CUR_TX_RATE
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_tx_rate
operator|/
literal|10
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_RTS_THRESH
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|LE_READ_2
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aRTS_Threshold
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_CREATE_IBSS
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_start_bss
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_SYSTEM_SCALE
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
comment|/* low density ... not supported */
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_PM_ENABLED
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_mib_local
operator|.
name|Power_Saving_Mode_Dis
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_MAX_SLEEP
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* not implemented */
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_WEP_AVAIL
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_ENCRYPTION
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|awi_wep_getalgo
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_TX_CRYPT_KEY
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|sc_wep_defkid
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_DEFLT_CRYPT_KEYS
case|:
name|keys
operator|=
operator|(
expr|struct
name|wi_ltv_keys
operator|*
operator|)
operator|&
name|wreq
expr_stmt|;
comment|/* do not show keys to non-root user */
ifdef|#
directive|ifdef
name|__FreeBSD__
name|error
operator|=
name|suser
argument_list|(
name|curproc
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|suser
argument_list|(
name|curproc
operator|->
name|p_ucred
argument_list|,
operator|&
name|curproc
operator|->
name|p_acflag
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
condition|)
block|{
name|memset
argument_list|(
name|keys
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IEEE80211_WEP_NKID
condition|;
name|i
operator|++
control|)
block|{
name|k
operator|=
operator|&
name|keys
operator|->
name|wi_keys
index|[
name|i
index|]
expr_stmt|;
name|keylen
operator|=
sizeof|sizeof
argument_list|(
name|k
operator|->
name|wi_keydat
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_wep_getkey
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|k
operator|->
name|wi_keydat
argument_list|,
operator|&
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|k
operator|->
name|wi_keylen
operator|=
name|keylen
expr_stmt|;
block|}
name|wreq
operator|.
name|wi_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
operator|/
literal|2
expr_stmt|;
break|break;
case|case
name|WI_RID_MAX_DATALEN
case|:
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|=
name|LE_READ_2
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aMax_Frame_Length
argument_list|)
expr_stmt|;
name|wreq
operator|.
name|wi_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WI_RID_IFACE_STATS
case|:
comment|/* not implemented yet */
name|wreq
operator|.
name|wi_len
operator|=
literal|0
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|WICACHE
case|case
name|WI_RID_READ_CACHE
case|:
for|for
control|(
name|bp
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|sc_scan
argument_list|)
operator|,
name|i
operator|=
literal|0
init|;
name|bp
operator|!=
name|NULL
operator|&&
name|i
operator|<
name|MAXWICACHE
condition|;
name|bp
operator|=
name|TAILQ_NEXT
argument_list|(
name|bp
argument_list|,
name|list
argument_list|)
operator|,
name|i
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|wsc
operator|.
name|macsrc
argument_list|,
name|bp
operator|->
name|esrc
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
comment|/*XXX*/
name|memcpy
argument_list|(
operator|&
name|wsc
operator|.
name|ipsrc
argument_list|,
name|bp
operator|->
name|bssid
argument_list|,
sizeof|sizeof
argument_list|(
name|wsc
operator|.
name|ipsrc
argument_list|)
argument_list|)
expr_stmt|;
name|wsc
operator|.
name|signal
operator|=
name|bp
operator|->
name|rssi
expr_stmt|;
name|wsc
operator|.
name|noise
operator|=
literal|0
expr_stmt|;
name|wsc
operator|.
name|quality
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|caddr_t
operator|)
name|wreq
operator|.
name|wi_val
operator|+
sizeof|sizeof
argument_list|(
name|wsc
argument_list|)
operator|*
name|i
argument_list|,
operator|&
name|wsc
argument_list|,
sizeof|sizeof
argument_list|(
name|wsc
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wreq
operator|.
name|wi_len
operator|=
sizeof|sizeof
argument_list|(
name|wsc
argument_list|)
operator|*
name|i
operator|/
literal|2
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* WICACHE */
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|wreq
operator|.
name|wi_len
operator|++
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|wreq
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|wreq
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|awi_cfgset
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|rate
decl_stmt|,
name|oregion
decl_stmt|;
name|u_int8_t
modifier|*
name|phy_rates
decl_stmt|;
name|struct
name|awi_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|awi_softc
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|wi_ltv_keys
modifier|*
name|keys
decl_stmt|;
name|struct
name|wi_key
modifier|*
name|k
decl_stmt|;
name|struct
name|wi_req
name|wreq
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|wreq
argument_list|,
sizeof|sizeof
argument_list|(
name|wreq
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|--
operator|<
literal|1
condition|)
return|return
name|EINVAL
return|;
switch|switch
condition|(
name|wreq
operator|.
name|wi_type
condition|)
block|{
case|case
name|WI_RID_SERIALNO
case|:
case|case
name|WI_RID_NODENAME
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_OWN_SSID
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|<
operator|(
literal|1
operator|+
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|/
literal|2
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|>
name|IEEE80211_NWID_LEN
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|memset
argument_list|(
name|sc
operator|->
name|sc_ownssid
argument_list|,
literal|0
argument_list|,
name|AWI_ESS_ID_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_ownssid
index|[
literal|0
index|]
operator|=
name|IEEE80211_ELEMID_SSID
expr_stmt|;
name|sc
operator|->
name|sc_ownssid
index|[
literal|1
index|]
operator|=
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_ownssid
index|[
literal|2
index|]
argument_list|,
operator|&
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
argument_list|,
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|&&
operator|!
name|sc
operator|->
name|sc_no_bssid
operator|&&
name|sc
operator|->
name|sc_start_bss
condition|)
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
name|WI_RID_CURRENT_SSID
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_DESIRED_SSID
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|<
operator|(
literal|1
operator|+
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|/
literal|2
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|>
name|IEEE80211_NWID_LEN
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|memset
argument_list|(
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
argument_list|,
literal|0
argument_list|,
name|AWI_ESS_ID_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|0
index|]
operator|=
name|IEEE80211_ELEMID_SSID
expr_stmt|;
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|1
index|]
operator|=
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aDesired_ESS_ID
index|[
literal|2
index|]
argument_list|,
operator|&
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
argument_list|,
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|||
operator|!
name|sc
operator|->
name|sc_no_bssid
condition|)
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
name|WI_RID_CURRENT_BSSID
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_CHANNEL_LIST
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|oregion
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
expr_stmt|;
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|==
name|oregion
condition|)
break|break;
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
operator|=
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
expr_stmt|;
name|error
operator|=
name|awi_init_region
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aCurrent_Reg_Domain
operator|=
name|oregion
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
name|WI_RID_OWN_CHNL
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|<
name|sc
operator|->
name|sc_scan_min
operator|||
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|>
name|sc
operator|->
name|sc_scan_max
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_ownch
operator|=
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
condition|)
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
name|WI_RID_CURRENT_CHAN
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_COMMS_QUALITY
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_PROMISC
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
block|{
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_PROMISC
expr_stmt|;
name|error
operator|=
name|ENETRESET
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_PROMISC
expr_stmt|;
name|error
operator|=
name|ENETRESET
expr_stmt|;
block|}
block|}
break|break;
case|case
name|WI_RID_PORTTYPE
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|1
case|:
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_no_bssid
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_no_bssid
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
literal|3
case|:
if|if
condition|(
name|sc
operator|->
name|sc_mib_phy
operator|.
name|IEEE_PHY_Type
operator|==
name|AWI_PHY_TYPE_FH
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_mib_local
operator|.
name|Network_Mode
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_no_bssid
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|WI_RID_MAC_NODE
case|:
comment|/* XXX: should be implemented? */
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_TX_RATE
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|phy_rates
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aSuprt_Data_Rates
expr_stmt|;
switch|switch
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
condition|)
block|{
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|5
case|:
case|case
literal|11
case|:
name|rate
operator|=
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|*
literal|10
expr_stmt|;
if|if
condition|(
name|rate
operator|==
literal|50
condition|)
name|rate
operator|+=
literal|5
expr_stmt|;
comment|/*XXX*/
break|break;
case|case
literal|3
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
comment|/* auto rate */
name|phy_rates
operator|=
name|sc
operator|->
name|sc_mib_phy
operator|.
name|aSuprt_Data_Rates
expr_stmt|;
name|rate
operator|=
name|AWI_RATE_1MBIT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|phy_rates
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|AWI_80211_RATE
argument_list|(
name|phy_rates
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
operator|>
name|rate
condition|)
name|rate
operator|=
name|AWI_80211_RATE
argument_list|(
name|phy_rates
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|rate
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|error
condition|)
break|break;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|phy_rates
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rate
operator|==
name|AWI_80211_RATE
argument_list|(
name|phy_rates
index|[
literal|2
operator|+
name|i
index|]
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|phy_rates
index|[
literal|1
index|]
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_tx_rate
operator|=
name|rate
expr_stmt|;
break|break;
case|case
name|WI_RID_CUR_TX_RATE
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_RTS_THRESH
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|LE_WRITE_2
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aRTS_Threshold
argument_list|,
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
name|WI_RID_CREATE_IBSS
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_start_bss
operator|=
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
name|WI_RID_SYSTEM_SCALE
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|!=
literal|1
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
comment|/* not supported */
break|break;
case|case
name|WI_RID_PM_ENABLED
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
comment|/* not implemented */
break|break;
case|case
name|WI_RID_MAX_SLEEP
case|:
name|error
operator|=
name|EINVAL
expr_stmt|;
comment|/* not implemented */
break|break;
case|case
name|WI_RID_WEP_AVAIL
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
case|case
name|WI_RID_ENCRYPTION
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|awi_wep_setalgo
argument_list|(
name|sc
argument_list|,
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|error
operator|=
name|ENETRESET
expr_stmt|;
break|break;
case|case
name|WI_RID_TX_CRYPT_KEY
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|>=
name|IEEE80211_WEP_NKID
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|sc
operator|->
name|sc_wep_defkid
operator|=
name|wreq
operator|.
name|wi_val
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|WI_RID_DEFLT_CRYPT_KEYS
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
operator|/
literal|2
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|keys
operator|=
operator|(
expr|struct
name|wi_ltv_keys
operator|*
operator|)
operator|&
name|wreq
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IEEE80211_WEP_NKID
condition|;
name|i
operator|++
control|)
block|{
name|k
operator|=
operator|&
name|keys
operator|->
name|wi_keys
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|awi_wep_setkey
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|k
operator|->
name|wi_keydat
argument_list|,
name|k
operator|->
name|wi_keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
block|}
break|break;
case|case
name|WI_RID_MAX_DATALEN
case|:
if|if
condition|(
name|wreq
operator|.
name|wi_len
operator|!=
literal|1
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|<
literal|350
operator|||
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
operator|>
literal|2304
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|LE_WRITE_2
argument_list|(
operator|&
name|sc
operator|->
name|sc_mib_mac
operator|.
name|aMax_Frame_Length
argument_list|,
name|wreq
operator|.
name|wi_val
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|WI_RID_IFACE_STATS
case|:
name|error
operator|=
name|EPERM
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|error
operator|==
name|ENETRESET
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_enabled
condition|)
block|{
name|awi_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|awi_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

end_unit


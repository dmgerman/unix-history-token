begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1999 Kazutaka YOKOTA<yokota@zodiac.mech.utsunomiya-u.ac.jp>  * Copyright (c) 1992-1998 SÃ¸ren Schmidt  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer as  *    the first lines of this file unmodified.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_syscons.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<machine/pc/display.h>
end_include

begin_include
include|#
directive|include
file|<dev/syscons/syscons.h>
end_include

begin_include
include|#
directive|include
file|<dev/syscons/sctermvar.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|SC_DUMB_TERMINAL
end_ifndef

begin_define
define|#
directive|define
name|MAX_ESC_PAR
value|5
end_define

begin_comment
comment|/* attribute flags */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|u_short
name|fg
decl_stmt|;
comment|/* foreground color */
name|u_short
name|bg
decl_stmt|;
comment|/* background color */
block|}
name|color_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
name|flags
decl_stmt|;
define|#
directive|define
name|SCTERM_BUSY
value|(1<< 0)
name|int
name|esc
decl_stmt|;
name|int
name|num_param
decl_stmt|;
name|int
name|last_param
decl_stmt|;
name|int
name|param
index|[
name|MAX_ESC_PAR
index|]
decl_stmt|;
name|int
name|saved_xpos
decl_stmt|;
name|int
name|saved_ypos
decl_stmt|;
name|int
name|attr_mask
decl_stmt|;
comment|/* current logical attr mask */
define|#
directive|define
name|NORMAL_ATTR
value|0x00
define|#
directive|define
name|BLINK_ATTR
value|0x01
define|#
directive|define
name|BOLD_ATTR
value|0x02
define|#
directive|define
name|UNDERLINE_ATTR
value|0x04
define|#
directive|define
name|REVERSE_ATTR
value|0x08
define|#
directive|define
name|FG_CHANGED
value|0x10
define|#
directive|define
name|BG_CHANGED
value|0x20
name|int
name|cur_attr
decl_stmt|;
comment|/* current hardware attr word */
name|color_t
name|cur_color
decl_stmt|;
comment|/* current hardware color */
name|color_t
name|std_color
decl_stmt|;
comment|/* normal hardware color */
name|color_t
name|rev_color
decl_stmt|;
comment|/* reverse hardware color */
name|color_t
name|dflt_std_color
decl_stmt|;
comment|/* default normal color */
name|color_t
name|dflt_rev_color
decl_stmt|;
comment|/* default reverse color */
block|}
name|term_stat
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|sc_term_init_t
name|scterm_init
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_term_t
name|scterm_term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_puts_t
name|scterm_puts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_ioctl_t
name|scterm_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_reset_t
name|scterm_reset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_default_attr_t
name|scterm_default_attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_clear_t
name|scterm_clear
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_notify_t
name|scterm_notify
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_input_t
name|scterm_input
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_sw_t
name|sc_term_sc
init|=
block|{
block|{
name|NULL
block|,
name|NULL
block|}
block|,
literal|"sc"
block|,
comment|/* emulator name */
literal|"syscons terminal"
block|,
comment|/* description */
literal|"*"
block|,
comment|/* matching renderer, any :-) */
sizeof|sizeof
argument_list|(
name|term_stat
argument_list|)
block|,
comment|/* softc size */
literal|0
block|,
name|scterm_init
block|,
name|scterm_term
block|,
name|scterm_puts
block|,
name|scterm_ioctl
block|,
name|scterm_reset
block|,
name|scterm_default_attr
block|,
name|scterm_clear
block|,
name|scterm_notify
block|,
name|scterm_input
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SCTERM_MODULE
argument_list|(
name|sc
argument_list|,
name|sc_term_sc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|term_stat
name|reserved_term_stat
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|scterm_scan_esc
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|term_stat
modifier|*
name|tcp
parameter_list|,
name|u_char
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mask2attr
parameter_list|(
name|term_stat
modifier|*
name|tcp
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|scterm_init
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|void
modifier|*
modifier|*
name|softc
parameter_list|,
name|int
name|code
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
decl_stmt|;
if|if
condition|(
operator|*
name|softc
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|reserved_term_stat
operator|.
name|flags
operator|&
name|SCTERM_BUSY
condition|)
return|return
name|EINVAL
return|;
operator|*
name|softc
operator|=
operator|&
name|reserved_term_stat
expr_stmt|;
block|}
name|tcp
operator|=
operator|*
name|softc
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|SC_TE_COLD_INIT
case|:
name|bzero
argument_list|(
name|tcp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|flags
operator|=
name|SCTERM_BUSY
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|saved_xpos
operator|=
operator|-
literal|1
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
operator|-
literal|1
expr_stmt|;
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
comment|/* XXX */
name|tcp
operator|->
name|dflt_std_color
operator|.
name|fg
operator|=
name|SC_NORM_ATTR
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_std_color
operator|.
name|bg
operator|=
operator|(
name|SC_NORM_ATTR
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|fg
operator|=
name|SC_NORM_REV_ATTR
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|bg
operator|=
operator|(
name|SC_NORM_REV_ATTR
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
operator|++
name|sc_term_sc
operator|.
name|te_refcount
expr_stmt|;
break|break;
case|case
name|SC_TE_WARM_INIT
case|:
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|saved_xpos
operator|=
operator|-
literal|1
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
operator|-
literal|1
expr_stmt|;
if|#
directive|if
literal|0
block|tcp->std_color = tcp->dflt_std_color; 		tcp->rev_color = tcp->dflt_rev_color;
endif|#
directive|endif
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_term
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|void
modifier|*
modifier|*
name|softc
parameter_list|)
block|{
if|if
condition|(
operator|*
name|softc
operator|==
operator|&
name|reserved_term_stat
condition|)
block|{
operator|*
name|softc
operator|=
name|NULL
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|reserved_term_stat
argument_list|,
sizeof|sizeof
argument_list|(
name|reserved_term_stat
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|--
name|sc_term_sc
operator|.
name|te_refcount
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_scan_esc
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|term_stat
modifier|*
name|tcp
parameter_list|,
name|u_char
name|c
parameter_list|)
block|{
specifier|static
name|u_char
name|ansi_col
index|[
literal|16
index|]
init|=
block|{
ifdef|#
directive|ifdef
name|__alpha__
comment|/* 		 * DEC is evil.  They switch the red and blue attributes in 		 * the palette in the system console.  As a simple work-around, 		 * re-map the ANSI colors appropriately. 		 */
name|FG_BLACK
block|,
name|FG_BLUE
block|,
name|FG_GREEN
block|,
name|FG_CYAN
block|,
name|FG_RED
block|,
name|FG_MAGENTA
block|,
name|FG_BROWN
block|,
name|FG_LIGHTGREY
block|,
name|FG_DARKGREY
block|,
name|FG_LIGHTBLUE
block|,
name|FG_LIGHTGREEN
block|,
name|FG_LIGHTCYAN
block|,
name|FG_LIGHTRED
block|,
name|FG_LIGHTMAGENTA
block|,
name|FG_YELLOW
block|,
name|FG_WHITE
else|#
directive|else
name|FG_BLACK
block|,
name|FG_RED
block|,
name|FG_GREEN
block|,
name|FG_BROWN
block|,
name|FG_BLUE
block|,
name|FG_MAGENTA
block|,
name|FG_CYAN
block|,
name|FG_LIGHTGREY
block|,
name|FG_DARKGREY
block|,
name|FG_LIGHTRED
block|,
name|FG_LIGHTGREEN
block|,
name|FG_YELLOW
block|,
name|FG_LIGHTBLUE
block|,
name|FG_LIGHTMAGENTA
block|,
name|FG_LIGHTCYAN
block|,
name|FG_WHITE
endif|#
directive|endif
block|}
decl_stmt|;
name|sc_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|i
operator|=
name|n
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|scp
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|1
condition|)
block|{
comment|/* seen ESC */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'7'
case|:
comment|/* Save cursor position */
name|tcp
operator|->
name|saved_xpos
operator|=
name|scp
operator|->
name|xpos
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
name|scp
operator|->
name|ypos
expr_stmt|;
break|break;
case|case
literal|'8'
case|:
comment|/* Restore saved cursor position */
if|if
condition|(
name|tcp
operator|->
name|saved_xpos
operator|>=
literal|0
operator|&&
name|tcp
operator|->
name|saved_ypos
operator|>=
literal|0
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|saved_xpos
argument_list|,
name|tcp
operator|->
name|saved_ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'['
case|:
comment|/* Start ESC [ sequence */
name|tcp
operator|->
name|esc
operator|=
literal|2
expr_stmt|;
name|tcp
operator|->
name|last_param
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|tcp
operator|->
name|num_param
init|;
name|i
operator|<
name|MAX_ESC_PAR
condition|;
name|i
operator|++
control|)
name|tcp
operator|->
name|param
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|tcp
operator|->
name|num_param
operator|=
literal|0
expr_stmt|;
return|return;
case|case
literal|'M'
case|:
comment|/* Move cursor up 1 line, scroll if at top */
name|sc_term_up_scroll
argument_list|(
name|scp
argument_list|,
literal|1
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|notyet
case|case
literal|'Q'
case|:
name|tcp
operator|->
name|esc
operator|=
literal|4
expr_stmt|;
return|return;
endif|#
directive|endif
case|case
literal|'c'
case|:
comment|/* reset */
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
name|sc_clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'('
case|:
comment|/* iso-2022: designate 94 character set to G0 */
name|tcp
operator|->
name|esc
operator|=
literal|5
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|2
condition|)
block|{
comment|/* seen ESC [ */
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|last_param
operator|!=
name|tcp
operator|->
name|num_param
condition|)
block|{
name|tcp
operator|->
name|last_param
operator|=
name|tcp
operator|->
name|num_param
expr_stmt|;
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|*=
literal|10
expr_stmt|;
block|}
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
return|return;
block|}
block|}
name|tcp
operator|->
name|num_param
operator|=
name|tcp
operator|->
name|last_param
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|';'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
return|return;
break|break;
case|case
literal|'='
case|:
name|tcp
operator|->
name|esc
operator|=
literal|3
expr_stmt|;
name|tcp
operator|->
name|last_param
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|tcp
operator|->
name|num_param
init|;
name|i
operator|<
name|MAX_ESC_PAR
condition|;
name|i
operator|++
control|)
name|tcp
operator|->
name|param
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|tcp
operator|->
name|num_param
operator|=
literal|0
expr_stmt|;
return|return;
case|case
literal|'A'
case|:
comment|/* up n rows */
name|sc_term_up
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* down n rows */
name|sc_term_down
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* right n columns */
name|sc_term_right
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* left n columns */
name|sc_term_left
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
comment|/* cursor to start of line n lines down */
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|scp
operator|->
name|ypos
operator|+
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* cursor to start of line n lines up */
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|scp
operator|->
name|ypos
operator|-
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* Cursor move */
case|case
literal|'H'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|2
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|-
literal|1
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
comment|/* Clear all or part of display */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|sc_term_clr_eos
argument_list|(
name|scp
argument_list|,
name|n
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
comment|/* Clear all or part of line */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|sc_term_clr_eol
argument_list|(
name|scp
argument_list|,
name|n
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
comment|/* Insert n lines */
name|sc_term_ins_line
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|ypos
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* Delete n lines */
name|sc_term_del_line
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|ypos
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* Delete n chars */
name|sc_term_del_char
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'@'
case|:
comment|/* Insert n chars */
name|sc_term_ins_char
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* scroll up n lines */
name|sc_term_del_line
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* scroll down n lines */
name|sc_term_ins_line
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
comment|/* erase n characters in line */
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
condition|)
name|n
operator|=
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
expr_stmt|;
name|sc_vtb_erase
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|,
name|n
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
operator|+
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
comment|/* move n tabs backwards */
name|sc_term_backtab
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'`'
case|:
comment|/* move cursor to column n */
name|sc_term_col
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
comment|/* move cursor n columns to the right */
name|sc_term_right
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
comment|/* move cursor to row n */
name|sc_term_row
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
comment|/* move cursor n rows down */
name|sc_term_down
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* change attribute */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
block|{
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tcp
operator|->
name|num_param
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|n
operator|=
name|tcp
operator|->
name|param
index|[
name|i
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* back to normal */
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* bold */
name|tcp
operator|->
name|attr_mask
operator||=
name|BOLD_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* underline */
name|tcp
operator|->
name|attr_mask
operator||=
name|UNDERLINE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* blink */
name|tcp
operator|->
name|attr_mask
operator||=
name|BLINK_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* reverse */
name|tcp
operator|->
name|attr_mask
operator||=
name|REVERSE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|22
case|:
comment|/* remove bold (or dim) */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BOLD_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/* remove underline */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|UNDERLINE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|25
case|:
comment|/* remove blink */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BLINK_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|27
case|:
comment|/* remove reverse */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|REVERSE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|30
case|:
case|case
literal|31
case|:
comment|/* set ansi fg color */
case|case
literal|32
case|:
case|case
literal|33
case|:
case|case
literal|34
case|:
case|case
literal|35
case|:
case|case
literal|36
case|:
case|case
literal|37
case|:
name|tcp
operator|->
name|attr_mask
operator||=
name|FG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|ansi_col
index|[
name|n
operator|-
literal|30
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|39
case|:
comment|/* restore fg color back to normal */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
operator|(
name|FG_CHANGED
operator||
name|BOLD_ATTR
operator|)
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|40
case|:
case|case
literal|41
case|:
comment|/* set ansi bg color */
case|case
literal|42
case|:
case|case
literal|43
case|:
case|case
literal|44
case|:
case|case
literal|45
case|:
case|case
literal|46
case|:
case|case
literal|47
case|:
name|tcp
operator|->
name|attr_mask
operator||=
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|ansi_col
index|[
name|n
operator|-
literal|40
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|49
case|:
comment|/* restore bg color back to normal */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
literal|'s'
case|:
comment|/* Save cursor position */
name|tcp
operator|->
name|saved_xpos
operator|=
name|scp
operator|->
name|xpos
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
name|scp
operator|->
name|ypos
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
comment|/* Restore saved cursor position */
if|if
condition|(
name|tcp
operator|->
name|saved_xpos
operator|>=
literal|0
operator|&&
name|tcp
operator|->
name|saved_ypos
operator|>=
literal|0
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|saved_xpos
argument_list|,
name|tcp
operator|->
name|saved_ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
comment|/* reset colors and attributes back to normal */
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* set ansi background */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* set ansi foreground */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|FG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* set adapter attribute directly */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
operator|(
name|FG_CHANGED
operator||
name|BG_CHANGED
operator|)
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
operator|=
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* set ansi reverse background */
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* set ansi reverse foreground */
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* set adapter reverse attribute directly */
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|=
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'z'
case|:
comment|/* switch to (virtual) console n */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
name|sc_switch_scr
argument_list|(
name|sc
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|3
condition|)
block|{
comment|/* seen ESC [0-9]+ = */
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|last_param
operator|!=
name|tcp
operator|->
name|num_param
condition|)
block|{
name|tcp
operator|->
name|last_param
operator|=
name|tcp
operator|->
name|num_param
expr_stmt|;
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|*=
literal|10
expr_stmt|;
block|}
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
return|return;
block|}
block|}
name|tcp
operator|->
name|num_param
operator|=
name|tcp
operator|->
name|last_param
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|';'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
return|return;
break|break;
case|case
literal|'A'
case|:
comment|/* set display border color */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|scp
operator|->
name|border
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|sc
operator|->
name|cur_scp
condition|)
name|sc_set_border
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'B'
case|:
comment|/* set bell pitch and duration */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|2
condition|)
block|{
name|scp
operator|->
name|bell_pitch
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|scp
operator|->
name|bell_duration
operator|=
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|*
name|hz
operator|+
literal|99
operator|)
operator|/
literal|100
expr_stmt|;
block|}
break|break;
case|case
literal|'C'
case|:
comment|/* set cursor type& shape */
name|i
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ISGRAPHSC
argument_list|(
name|sc
operator|->
name|cur_scp
argument_list|)
condition|)
name|sc_remove_cursor_image
argument_list|(
name|sc
operator|->
name|cur_scp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x01
condition|)
name|sc
operator|->
name|flags
operator||=
name|SC_BLINK_CURSOR
expr_stmt|;
else|else
name|sc
operator|->
name|flags
operator|&=
operator|~
name|SC_BLINK_CURSOR
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x02
condition|)
name|sc
operator|->
name|flags
operator||=
name|SC_CHAR_CURSOR
expr_stmt|;
else|else
name|sc
operator|->
name|flags
operator|&=
operator|~
name|SC_CHAR_CURSOR
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|2
condition|)
block|{
name|sc
operator|->
name|cursor_base
operator|=
name|scp
operator|->
name|font_size
operator|-
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x1F
operator|)
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|cursor_height
operator|=
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x1F
operator|)
operator|-
operator|(
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x1F
operator|)
operator|+
literal|1
expr_stmt|;
block|}
comment|/*  			 * The cursor shape is global property;  			 * all virtual consoles are affected.  			 * Update the cursor in the current console... 			 */
if|if
condition|(
operator|!
name|ISGRAPHSC
argument_list|(
name|sc
operator|->
name|cur_scp
argument_list|)
condition|)
block|{
name|sc_set_cursor_image
argument_list|(
name|sc
operator|->
name|cur_scp
argument_list|)
expr_stmt|;
name|sc_draw_cursor_image
argument_list|(
name|sc
operator|->
name|cur_scp
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* set adapter foreground */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|FG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'G'
case|:
comment|/* set adapter background */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'H'
case|:
comment|/* set adapter reverse foreground */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'I'
case|:
comment|/* set adapter reverse background */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|#
directive|if
name|notyet
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|4
condition|)
block|{
comment|/* seen ESC Q */
comment|/* to be filled */
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|5
condition|)
block|{
comment|/* seen ESC ( */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'B'
case|:
comment|/* iso-2022: desginate ASCII into G0 */
break|break;
comment|/* other items to be filled */
default|default:
break|break;
block|}
block|}
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_puts
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
decl_stmt|;
name|tcp
operator|=
name|scp
operator|->
name|ts
expr_stmt|;
name|outloop
label|:
name|scp
operator|->
name|sc
operator|->
name|write_in_progress
operator|++
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|esc
condition|)
block|{
name|scterm_scan_esc
argument_list|(
name|scp
argument_list|,
name|tcp
argument_list|,
operator|*
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
operator|*
name|buf
condition|)
block|{
case|case
literal|0x1b
case|:
name|tcp
operator|->
name|esc
operator|=
literal|1
expr_stmt|;
name|tcp
operator|->
name|num_param
operator|=
literal|0
expr_stmt|;
name|buf
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
break|break;
default|default:
name|sc_term_gen_print
argument_list|(
name|scp
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|sc_term_gen_scroll
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
name|scp
operator|->
name|sc
operator|->
name|write_in_progress
operator|--
expr_stmt|;
if|if
condition|(
name|len
condition|)
goto|goto
name|outloop
goto|;
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_ioctl
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
init|=
name|scp
operator|->
name|ts
decl_stmt|;
name|vid_info_t
modifier|*
name|vi
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|GIO_ATTR
case|:
comment|/* get current attributes */
comment|/* FIXME: */
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
operator|(
name|tcp
operator|->
name|cur_attr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_GETINFO
case|:
comment|/* get current (virtual) console info */
name|vi
operator|=
operator|(
name|vid_info_t
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|vi
operator|->
name|size
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|vid_info
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|vi
operator|->
name|mv_norm
operator|.
name|fore
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
expr_stmt|;
name|vi
operator|->
name|mv_norm
operator|.
name|back
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
expr_stmt|;
name|vi
operator|->
name|mv_rev
operator|.
name|fore
operator|=
name|tcp
operator|->
name|rev_color
operator|.
name|fg
expr_stmt|;
name|vi
operator|->
name|mv_rev
operator|.
name|back
operator|=
name|tcp
operator|->
name|rev_color
operator|.
name|bg
expr_stmt|;
comment|/* 		 * The other fields are filled by the upper routine. XXX 		 */
return|return
name|ENOIOCTL
return|;
block|}
return|return
name|ENOIOCTL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_reset
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|code
parameter_list|)
block|{
comment|/* FIXME */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_default_attr
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|color
parameter_list|,
name|int
name|rev_color
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
init|=
name|scp
operator|->
name|ts
decl_stmt|;
name|tcp
operator|->
name|dflt_std_color
operator|.
name|fg
operator|=
name|color
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_std_color
operator|.
name|bg
operator|=
operator|(
name|color
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|fg
operator|=
name|rev_color
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|bg
operator|=
operator|(
name|rev_color
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_clear
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
init|=
name|scp
operator|->
name|ts
decl_stmt|;
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc_vtb_clear
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|scp
operator|->
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
name|mark_all
argument_list|(
name|scp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_notify
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|event
parameter_list|)
block|{
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|SC_TE_NOTIFY_VTSWITCH_IN
case|:
break|break;
case|case
name|SC_TE_NOTIFY_VTSWITCH_OUT
case|:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_input
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|c
parameter_list|,
name|struct
name|tty
modifier|*
name|tp
parameter_list|)
block|{
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/*  * Calculate hardware attributes word using logical attributes mask and  * hardware colors  */
end_comment

begin_comment
comment|/* FIXME */
end_comment

begin_function
specifier|static
name|int
name|mask2attr
parameter_list|(
name|term_stat
modifier|*
name|tcp
parameter_list|)
block|{
name|int
name|attr
decl_stmt|,
name|mask
init|=
name|tcp
operator|->
name|attr_mask
decl_stmt|;
if|if
condition|(
name|mask
operator|&
name|REVERSE_ATTR
condition|)
block|{
name|attr
operator|=
operator|(
operator|(
name|mask
operator|&
name|FG_CHANGED
operator|)
condition|?
name|tcp
operator|->
name|cur_color
operator|.
name|bg
else|:
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|)
operator||
operator|(
operator|(
operator|(
name|mask
operator|&
name|BG_CHANGED
operator|)
condition|?
name|tcp
operator|->
name|cur_color
operator|.
name|fg
else|:
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
block|}
else|else
name|attr
operator|=
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator||
operator|(
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|<<
literal|4
operator|)
expr_stmt|;
comment|/* XXX: underline mapping for Hercules adapter can be better */
if|if
condition|(
name|mask
operator|&
operator|(
name|BOLD_ATTR
operator||
name|UNDERLINE_ATTR
operator|)
condition|)
name|attr
operator|^=
literal|0x08
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|BLINK_ATTR
condition|)
name|attr
operator|^=
literal|0x80
expr_stmt|;
return|return
operator|(
name|attr
operator|<<
literal|8
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_DUMB_TERMINAL */
end_comment

end_unit


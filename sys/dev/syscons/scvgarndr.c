begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1999 Kazutaka YOKOTA<yokota@zodiac.mech.utsunomiya-u.ac.jp>  * All rights reserved.  *  * This code is derived from software contributed to The DragonFly Project  * by Sascha Wildner<saw@online.de>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer as  *    the first lines of this file unmodified.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_syscons.h"
end_include

begin_include
include|#
directive|include
file|"opt_vga.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/vgareg.h>
end_include

begin_include
include|#
directive|include
file|<dev/syscons/syscons.h>
end_include

begin_include
include|#
directive|include
file|<isa/isareg.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|SC_RENDER_DEBUG
end_ifndef

begin_define
define|#
directive|define
name|SC_RENDER_DEBUG
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|vr_clear_t
name|vga_txtclear
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_border_t
name|vga_txtborder
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_t
name|vga_txtdraw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_set_cursor_t
name|vga_txtcursor_shape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_cursor_t
name|vga_txtcursor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_blink_cursor_t
name|vga_txtblink
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
end_ifndef

begin_decl_stmt
specifier|static
name|vr_draw_mouse_t
name|vga_txtmouse
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|vga_txtmouse
value|(vr_draw_mouse_t *)vga_nop
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SC_PIXEL_MODE
end_ifdef

begin_decl_stmt
specifier|static
name|vr_init_t
name|vga_rndrinit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_clear_t
name|vga_pxlclear_direct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_clear_t
name|vga_pxlclear_planar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_border_t
name|vga_pxlborder_direct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_border_t
name|vga_pxlborder_planar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_t
name|vga_egadraw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_t
name|vga_vgadraw_direct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_t
name|vga_vgadraw_planar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_set_cursor_t
name|vga_pxlcursor_shape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_cursor_t
name|vga_pxlcursor_direct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_cursor_t
name|vga_pxlcursor_planar
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_blink_cursor_t
name|vga_pxlblink_direct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_blink_cursor_t
name|vga_pxlblink_planar
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
end_ifndef

begin_decl_stmt
specifier|static
name|vr_draw_mouse_t
name|vga_pxlmouse_direct
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|vr_draw_mouse_t
name|vga_pxlmouse_planar
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|vga_pxlmouse_direct
value|(vr_draw_mouse_t *)vga_nop
end_define

begin_define
define|#
directive|define
name|vga_pxlmouse_planar
value|(vr_draw_mouse_t *)vga_nop
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_PIXEL_MODE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_MODE_CHANGE
end_ifndef

begin_decl_stmt
specifier|static
name|vr_draw_border_t
name|vga_grborder
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|vga_nop
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|sc_rndr_sw_t
name|txtrndrsw
init|=
block|{
operator|(
name|vr_init_t
operator|*
operator|)
name|vga_nop
block|,
name|vga_txtclear
block|,
name|vga_txtborder
block|,
name|vga_txtdraw
block|,
name|vga_txtcursor_shape
block|,
name|vga_txtcursor
block|,
name|vga_txtblink
block|,
operator|(
name|vr_set_mouse_t
operator|*
operator|)
name|vga_nop
block|,
name|vga_txtmouse
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|mda
argument_list|,
literal|0
argument_list|,
name|txtrndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|cga
argument_list|,
literal|0
argument_list|,
name|txtrndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|ega
argument_list|,
literal|0
argument_list|,
name|txtrndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|vga
argument_list|,
literal|0
argument_list|,
name|txtrndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SC_PIXEL_MODE
end_ifdef

begin_decl_stmt
specifier|static
name|sc_rndr_sw_t
name|vgarndrsw
init|=
block|{
name|vga_rndrinit
block|,
operator|(
name|vr_clear_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_draw_border_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_draw_t
operator|*
operator|)
name|vga_nop
block|,
name|vga_pxlcursor_shape
block|,
operator|(
name|vr_draw_cursor_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_blink_cursor_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_set_mouse_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_draw_mouse_t
operator|*
operator|)
name|vga_nop
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|ega
argument_list|,
name|PIXEL_MODE
argument_list|,
name|vgarndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|vga
argument_list|,
name|PIXEL_MODE
argument_list|,
name|vgarndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_PIXEL_MODE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_MODE_CHANGE
end_ifndef

begin_decl_stmt
specifier|static
name|sc_rndr_sw_t
name|grrndrsw
init|=
block|{
operator|(
name|vr_init_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_clear_t
operator|*
operator|)
name|vga_nop
block|,
name|vga_grborder
block|,
operator|(
name|vr_draw_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_set_cursor_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_draw_cursor_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_blink_cursor_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_set_mouse_t
operator|*
operator|)
name|vga_nop
block|,
operator|(
name|vr_draw_mouse_t
operator|*
operator|)
name|vga_nop
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|cga
argument_list|,
name|GRAPHICS_MODE
argument_list|,
name|grrndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|ega
argument_list|,
name|GRAPHICS_MODE
argument_list|,
name|grrndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RENDERER
argument_list|(
name|vga
argument_list|,
name|GRAPHICS_MODE
argument_list|,
name|grrndrsw
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_NO_MODE_CHANGE */
end_comment

begin_expr_stmt
name|RENDERER_MODULE
argument_list|(
name|vga
argument_list|,
name|vga_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
end_ifndef

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|SC_ALT_MOUSE_IMAGE
argument_list|)
operator|||
name|defined
argument_list|(
name|SC_PIXEL_MODE
argument_list|)
end_if

begin_struct
struct|struct
name|mousedata
block|{
name|u_short
name|md_border
index|[
literal|16
index|]
decl_stmt|;
name|u_short
name|md_interior
index|[
literal|16
index|]
decl_stmt|;
name|u_short
name|md_width
decl_stmt|;
name|u_short
name|md_height
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|mousedata
name|mouse9x13
init|=
block|{
block|{
literal|0xc000
block|,
literal|0xa000
block|,
literal|0x9000
block|,
literal|0x8800
block|,
literal|0x8400
block|,
literal|0x8200
block|,
literal|0x8100
block|,
literal|0x9780
block|,
literal|0xf200
block|,
literal|0x1200
block|,
literal|0x1900
block|,
literal|0x0900
block|,
literal|0x0f00
block|,
literal|0x0000
block|,
literal|0x0000
block|,
literal|0x0000
block|, }
block|,
block|{
literal|0x0000
block|,
literal|0x4000
block|,
literal|0x6000
block|,
literal|0x7000
block|,
literal|0x7800
block|,
literal|0x7c00
block|,
literal|0x7e00
block|,
literal|0x6800
block|,
literal|0x0c00
block|,
literal|0x0c00
block|,
literal|0x0600
block|,
literal|0x0600
block|,
literal|0x0000
block|,
literal|0x0000
block|,
literal|0x0000
block|,
literal|0x0000
block|, }
block|,
literal|9
block|,
literal|13
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|mousedata
name|mouse10x16
init|=
block|{
block|{
literal|0xc000
block|,
literal|0xa000
block|,
literal|0x9000
block|,
literal|0x8800
block|,
literal|0x8400
block|,
literal|0x8200
block|,
literal|0x8100
block|,
literal|0x8080
block|,
literal|0x8040
block|,
literal|0x83c0
block|,
literal|0x9200
block|,
literal|0xa900
block|,
literal|0xc900
block|,
literal|0x0480
block|,
literal|0x0480
block|,
literal|0x0300
block|, }
block|,
block|{
literal|0x0000
block|,
literal|0x4000
block|,
literal|0x6000
block|,
literal|0x7000
block|,
literal|0x7800
block|,
literal|0x7c00
block|,
literal|0x7e00
block|,
literal|0x7f00
block|,
literal|0x7f80
block|,
literal|0x7c00
block|,
literal|0x6c00
block|,
literal|0x4600
block|,
literal|0x0600
block|,
literal|0x0300
block|,
literal|0x0300
block|,
literal|0x0000
block|, }
block|,
literal|10
block|,
literal|16
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SC_PIXEL_MODE
end_ifdef

begin_define
define|#
directive|define
name|GET_PIXEL
parameter_list|(
name|scp
parameter_list|,
name|pos
parameter_list|,
name|x
parameter_list|,
name|w
parameter_list|)
define|\
value|({									\ 	(scp)->sc->adp->va_window +					\ 	    (x) * (scp)->xoff +						\ 	    (scp)->yoff * (scp)->font_size * (w) +			\ 	    (x) * ((pos) % (scp)->xsize) +				\ 	    (scp)->font_size * (w) * ((pos) / (scp)->xsize);		\ })
end_define

begin_define
define|#
directive|define
name|DRAW_PIXEL
parameter_list|(
name|scp
parameter_list|,
name|pos
parameter_list|,
name|color
parameter_list|)
value|do {				\ 	switch ((scp)->sc->adp->va_info.vi_depth) {			\ 	case 32:							\ 		writel((pos), vga_palette32[color]);			\ 		break;							\ 	case 24:							\ 		if (((pos)& 1) == 0) {					\ 			writew((pos), vga_palette32[color]);		\ 			writeb((pos) + 2, vga_palette32[color]>> 16);	\ 		} else {						\ 			writeb((pos), vga_palette32[color]);		\ 			writew((pos) + 1, vga_palette32[color]>> 8);	\ 		}							\ 		break;							\ 	case 16:							\ 		if ((scp)->sc->adp->va_info.vi_pixel_fsizes[1] == 5)	\ 			writew((pos), vga_palette15[color]);		\ 		else							\ 			writew((pos), vga_palette16[color]);		\ 		break;							\ 	case 15:							\ 		writew((pos), vga_palette15[color]);			\ 		break;							\ 	case 8:								\ 		writeb((pos), (uint8_t)(color));			\ 	}								\ } while (0)
end_define

begin_decl_stmt
specifier|static
name|uint32_t
name|vga_palette32
index|[
literal|16
index|]
init|=
block|{
literal|0x000000
block|,
literal|0x0000ad
block|,
literal|0x00ad00
block|,
literal|0x00adad
block|,
literal|0xad0000
block|,
literal|0xad00ad
block|,
literal|0xad5200
block|,
literal|0xadadad
block|,
literal|0x525252
block|,
literal|0x5252ff
block|,
literal|0x52ff52
block|,
literal|0x52ffff
block|,
literal|0xff5252
block|,
literal|0xff52ff
block|,
literal|0xffff52
block|,
literal|0xffffff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|vga_palette16
index|[
literal|16
index|]
init|=
block|{
literal|0x0000
block|,
literal|0x0016
block|,
literal|0x0560
block|,
literal|0x0576
block|,
literal|0xb000
block|,
literal|0xb016
block|,
literal|0xb2a0
block|,
literal|0xb576
block|,
literal|0x52aa
block|,
literal|0x52bf
block|,
literal|0x57ea
block|,
literal|0x57ff
block|,
literal|0xfaaa
block|,
literal|0xfabf
block|,
literal|0xffea
block|,
literal|0xffff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint16_t
name|vga_palette15
index|[
literal|16
index|]
init|=
block|{
literal|0x0000
block|,
literal|0x0016
block|,
literal|0x02c0
block|,
literal|0x02d6
block|,
literal|0x5800
block|,
literal|0x5816
block|,
literal|0x5940
block|,
literal|0x5ad6
block|,
literal|0x294a
block|,
literal|0x295f
block|,
literal|0x2bea
block|,
literal|0x2bff
block|,
literal|0x7d4a
block|,
literal|0x7d5f
block|,
literal|0x7fea
block|,
literal|0x7fff
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|vga_nop
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{ }
end_function

begin_comment
comment|/* text mode renderer */
end_comment

begin_function
specifier|static
name|void
name|vga_txtclear
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|sc_vtb_clear
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|c
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_txtborder
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|color
parameter_list|)
block|{
name|vidd_set_border
argument_list|(
name|scp
operator|->
name|sc
operator|->
name|adp
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_txtdraw
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|from
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|vm_offset_t
name|p
decl_stmt|;
name|int
name|c
decl_stmt|;
name|int
name|a
decl_stmt|;
if|if
condition|(
name|from
operator|+
name|count
operator|>
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
condition|)
name|count
operator|=
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|-
name|from
expr_stmt|;
if|if
condition|(
name|flip
condition|)
block|{
for|for
control|(
name|p
operator|=
name|sc_vtb_pointer
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|from
argument_list|)
init|;
name|count
operator|--
operator|>
literal|0
condition|;
operator|++
name|from
control|)
block|{
name|c
operator|=
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|a
operator|&
literal|0x8800
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x7000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x0700
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|p
operator|=
name|sc_vtb_putchar
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|p
argument_list|,
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sc_vtb_copy
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|from
argument_list|,
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|from
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vga_txtcursor_shape
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|base
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|blink
parameter_list|)
block|{
if|if
condition|(
name|base
operator|<
literal|0
operator|||
name|base
operator|>=
name|scp
operator|->
name|font_size
condition|)
return|return;
comment|/* the caller may set height<= 0 in order to disable the cursor */
if|#
directive|if
literal|0
block|scp->curs_attr.base = base; 	scp->curs_attr.height = height;
endif|#
directive|endif
name|vidd_set_hw_cursor_shape
argument_list|(
name|scp
operator|->
name|sc
operator|->
name|adp
argument_list|,
name|base
argument_list|,
name|height
argument_list|,
name|scp
operator|->
name|font_size
argument_list|,
name|blink
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|draw_txtcharcursor
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|u_short
name|c
parameter_list|,
name|u_short
name|a
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|sc_softc_t
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|scp
operator|->
name|sc
expr_stmt|;
ifndef|#
directive|ifndef
name|SC_NO_FONT_LOADING
if|if
condition|(
name|scp
operator|->
name|curs_attr
operator|.
name|flags
operator|&
name|CONS_CHAR_CURSOR
condition|)
block|{
name|unsigned
name|char
modifier|*
name|font
decl_stmt|;
name|int
name|h
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|scp
operator|->
name|font_size
operator|<
literal|14
condition|)
block|{
name|font
operator|=
name|sc
operator|->
name|font_8
expr_stmt|;
name|h
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|scp
operator|->
name|font_size
operator|>=
literal|16
condition|)
block|{
name|font
operator|=
name|sc
operator|->
name|font_16
expr_stmt|;
name|h
operator|=
literal|16
expr_stmt|;
block|}
else|else
block|{
name|font
operator|=
name|sc
operator|->
name|font_14
expr_stmt|;
name|h
operator|=
literal|14
expr_stmt|;
block|}
if|if
condition|(
name|scp
operator|->
name|curs_attr
operator|.
name|base
operator|>=
name|h
condition|)
return|return;
if|if
condition|(
name|flip
condition|)
name|a
operator|=
operator|(
name|a
operator|&
literal|0x8800
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x7000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x0700
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|bcopy
argument_list|(
name|font
operator|+
name|c
operator|*
name|h
argument_list|,
name|font
operator|+
name|sc
operator|->
name|cursor_char
operator|*
name|h
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|font
operator|=
name|font
operator|+
name|sc
operator|->
name|cursor_char
operator|*
name|h
expr_stmt|;
for|for
control|(
name|i
operator|=
name|imax
argument_list|(
name|h
operator|-
name|scp
operator|->
name|curs_attr
operator|.
name|base
operator|-
name|scp
operator|->
name|curs_attr
operator|.
name|height
argument_list|,
literal|0
argument_list|)
init|;
name|i
operator|<
name|h
operator|-
name|scp
operator|->
name|curs_attr
operator|.
name|base
condition|;
operator|++
name|i
control|)
block|{
name|font
index|[
name|i
index|]
operator|^=
literal|0xff
expr_stmt|;
block|}
comment|/* XXX */
name|vidd_load_font
argument_list|(
name|sc
operator|->
name|adp
argument_list|,
literal|0
argument_list|,
name|h
argument_list|,
literal|8
argument_list|,
name|font
argument_list|,
name|sc
operator|->
name|cursor_char
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|at
argument_list|,
name|sc
operator|->
name|cursor_char
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
comment|/* SC_NO_FONT_LOADING */
block|{
if|if
condition|(
operator|(
name|a
operator|&
literal|0x7000
operator|)
operator|==
literal|0x7000
condition|)
block|{
name|a
operator|&=
literal|0x8f00
expr_stmt|;
if|if
condition|(
operator|(
name|a
operator|&
literal|0x0700
operator|)
operator|==
literal|0
condition|)
name|a
operator||=
literal|0x0700
expr_stmt|;
block|}
else|else
block|{
name|a
operator||=
literal|0x7000
expr_stmt|;
if|if
condition|(
operator|(
name|a
operator|&
literal|0x0700
operator|)
operator|==
literal|0x0700
condition|)
name|a
operator|&=
literal|0xf000
expr_stmt|;
block|}
if|if
condition|(
name|flip
condition|)
name|a
operator|=
operator|(
name|a
operator|&
literal|0x8800
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x7000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x0700
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|at
argument_list|,
name|c
argument_list|,
name|a
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vga_txtcursor
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|blink
parameter_list|,
name|int
name|on
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|video_adapter_t
modifier|*
name|adp
decl_stmt|;
name|int
name|cursor_attr
decl_stmt|;
if|if
condition|(
name|scp
operator|->
name|curs_attr
operator|.
name|height
operator|<=
literal|0
condition|)
comment|/* the text cursor is disabled */
return|return;
name|adp
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
expr_stmt|;
if|if
condition|(
name|blink
condition|)
block|{
name|scp
operator|->
name|status
operator||=
name|VR_CURSOR_BLINK
expr_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|scp
operator|->
name|status
operator||=
name|VR_CURSOR_ON
expr_stmt|;
name|vidd_set_hw_cursor
argument_list|(
name|adp
argument_list|,
name|at
operator|%
name|scp
operator|->
name|xsize
argument_list|,
name|at
operator|/
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
condition|)
name|vidd_set_hw_cursor
argument_list|(
name|adp
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|VR_CURSOR_ON
expr_stmt|;
block|}
block|}
else|else
block|{
name|scp
operator|->
name|status
operator|&=
operator|~
name|VR_CURSOR_BLINK
expr_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|scp
operator|->
name|status
operator||=
name|VR_CURSOR_ON
expr_stmt|;
name|draw_txtcharcursor
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
argument_list|,
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
argument_list|,
name|flip
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cursor_attr
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
expr_stmt|;
if|if
condition|(
name|flip
condition|)
name|cursor_attr
operator|=
operator|(
name|cursor_attr
operator|&
literal|0x8800
operator|)
operator||
operator|(
operator|(
name|cursor_attr
operator|&
literal|0x7000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|cursor_attr
operator|&
literal|0x0700
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
condition|)
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|at
argument_list|,
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
argument_list|,
name|cursor_attr
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|VR_CURSOR_ON
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vga_txtblink
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|flip
parameter_list|)
block|{ }
end_function

begin_decl_stmt
name|int
name|sc_txtmouse_no_retrace_wait
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
end_ifndef

begin_function
specifier|static
name|void
name|draw_txtmouse
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|SC_ALT_MOUSE_IMAGE
if|if
condition|(
name|ISMOUSEAVAIL
argument_list|(
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_flags
argument_list|)
condition|)
block|{
specifier|const
name|struct
name|mousedata
modifier|*
name|mdp
decl_stmt|;
name|uint32_t
name|border
decl_stmt|,
name|interior
decl_stmt|;
name|u_char
name|font_buf
index|[
literal|128
index|]
decl_stmt|;
name|u_short
name|cursor
index|[
literal|32
index|]
decl_stmt|;
name|u_char
name|c
decl_stmt|;
name|int
name|pos
decl_stmt|;
name|int
name|xoffset
decl_stmt|,
name|yoffset
decl_stmt|;
name|int
name|crtc_addr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mdp
operator|=
operator|(
name|scp
operator|->
name|font_size
operator|<
literal|14
operator|)
condition|?
operator|&
name|mouse9x13
else|:
operator|&
name|mouse10x16
expr_stmt|;
comment|/* prepare mousepointer char's bitmaps */
name|pos
operator|=
operator|(
name|y
operator|/
name|scp
operator|->
name|font_size
operator|-
name|scp
operator|->
name|yoff
operator|)
operator|*
name|scp
operator|->
name|xsize
operator|+
name|x
operator|/
literal|8
operator|-
name|scp
operator|->
name|xoff
expr_stmt|;
name|bcopy
argument_list|(
name|scp
operator|->
name|font
operator|+
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
argument_list|)
operator|*
name|scp
operator|->
name|font_size
argument_list|,
operator|&
name|font_buf
index|[
literal|0
index|]
argument_list|,
name|scp
operator|->
name|font_size
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|scp
operator|->
name|font
operator|+
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
literal|1
argument_list|)
operator|*
name|scp
operator|->
name|font_size
argument_list|,
operator|&
name|font_buf
index|[
literal|32
index|]
argument_list|,
name|scp
operator|->
name|font_size
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|scp
operator|->
name|font
operator|+
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
name|scp
operator|->
name|xsize
argument_list|)
operator|*
name|scp
operator|->
name|font_size
argument_list|,
operator|&
name|font_buf
index|[
literal|64
index|]
argument_list|,
name|scp
operator|->
name|font_size
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|scp
operator|->
name|font
operator|+
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
name|scp
operator|->
name|xsize
operator|+
literal|1
argument_list|)
operator|*
name|scp
operator|->
name|font_size
argument_list|,
operator|&
name|font_buf
index|[
literal|96
index|]
argument_list|,
name|scp
operator|->
name|font_size
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scp
operator|->
name|font_size
condition|;
operator|++
name|i
control|)
block|{
name|cursor
index|[
name|i
index|]
operator|=
name|font_buf
index|[
name|i
index|]
operator|<<
literal|8
operator||
name|font_buf
index|[
name|i
operator|+
literal|32
index|]
expr_stmt|;
name|cursor
index|[
name|i
operator|+
name|scp
operator|->
name|font_size
index|]
operator|=
name|font_buf
index|[
name|i
operator|+
literal|64
index|]
operator|<<
literal|8
operator||
name|font_buf
index|[
name|i
operator|+
literal|96
index|]
expr_stmt|;
block|}
comment|/* now and-or in the mousepointer image */
name|xoffset
operator|=
name|x
operator|%
literal|8
expr_stmt|;
name|yoffset
operator|=
name|y
operator|%
name|scp
operator|->
name|font_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
name|border
operator|=
name|mdp
operator|->
name|md_border
index|[
name|i
index|]
operator|<<
literal|8
expr_stmt|;
comment|/* avoid right shifting out */
name|interior
operator|=
name|mdp
operator|->
name|md_interior
index|[
name|i
index|]
operator|<<
literal|8
expr_stmt|;
name|border
operator|>>=
name|xoffset
expr_stmt|;
comment|/* normalize */
name|interior
operator|>>=
name|xoffset
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_flags
operator|&
name|V_ADP_CWIDTH9
condition|)
block|{
comment|/* skip gaps between characters */
name|border
operator|=
operator|(
name|border
operator|&
literal|0xff0000
operator|)
operator||
operator|(
name|border
operator|&
literal|0x007f80
operator|)
operator|<<
literal|1
operator||
operator|(
name|border
operator|&
literal|0x00003f
operator|)
operator|<<
literal|2
expr_stmt|;
name|interior
operator|=
operator|(
name|interior
operator|&
literal|0xff0000
operator|)
operator||
operator|(
name|interior
operator|&
literal|0x007f80
operator|)
operator|<<
literal|1
operator||
operator|(
name|interior
operator|&
literal|0x00003f
operator|)
operator|<<
literal|2
expr_stmt|;
block|}
name|border
operator|>>=
literal|8
expr_stmt|;
comment|/* back to normal position */
name|interior
operator|>>=
literal|8
expr_stmt|;
name|cursor
index|[
name|i
operator|+
name|yoffset
index|]
operator|=
operator|(
name|cursor
index|[
name|i
operator|+
name|yoffset
index|]
operator|&
operator|~
name|border
operator|)
operator||
name|interior
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scp
operator|->
name|font_size
condition|;
operator|++
name|i
control|)
block|{
name|font_buf
index|[
name|i
index|]
operator|=
operator|(
name|cursor
index|[
name|i
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|font_buf
index|[
name|i
operator|+
literal|32
index|]
operator|=
name|cursor
index|[
name|i
index|]
operator|&
literal|0xff
expr_stmt|;
name|font_buf
index|[
name|i
operator|+
literal|64
index|]
operator|=
operator|(
name|cursor
index|[
name|i
operator|+
name|scp
operator|->
name|font_size
index|]
operator|&
literal|0xff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|font_buf
index|[
name|i
operator|+
literal|96
index|]
operator|=
name|cursor
index|[
name|i
operator|+
name|scp
operator|->
name|font_size
index|]
operator|&
literal|0xff
expr_stmt|;
block|}
if|#
directive|if
literal|1
comment|/* wait for vertical retrace to avoid jitter on some videocards */
name|crtc_addr
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_crtc_addr
expr_stmt|;
while|while
condition|(
operator|!
name|sc_txtmouse_no_retrace_wait
operator|&&
operator|!
operator|(
name|inb
argument_list|(
name|crtc_addr
operator|+
literal|6
argument_list|)
operator|&
literal|0x08
operator|)
condition|)
comment|/* idle */
empty_stmt|;
endif|#
directive|endif
name|c
operator|=
name|scp
operator|->
name|sc
operator|->
name|mouse_char
expr_stmt|;
name|vidd_load_font
argument_list|(
name|scp
operator|->
name|sc
operator|->
name|adp
argument_list|,
literal|0
argument_list|,
literal|32
argument_list|,
literal|8
argument_list|,
name|font_buf
argument_list|,
name|c
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
argument_list|,
name|c
argument_list|,
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FIXME: may be out of range! */
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
name|scp
operator|->
name|xsize
argument_list|,
name|c
operator|+
literal|2
argument_list|,
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
name|scp
operator|->
name|xsize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|<
operator|(
name|scp
operator|->
name|xsize
operator|-
literal|1
operator|)
operator|*
literal|8
condition|)
block|{
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|c
operator|+
literal|1
argument_list|,
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
name|scp
operator|->
name|xsize
operator|+
literal|1
argument_list|,
name|c
operator|+
literal|3
argument_list|,
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
operator|+
name|scp
operator|->
name|xsize
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
endif|#
directive|endif
comment|/* SC_ALT_MOUSE_IMAGE */
block|{
comment|/* Red, magenta and brown are mapped to green to to keep it readable */
specifier|static
specifier|const
name|int
name|col_conv
index|[
literal|16
index|]
init|=
block|{
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|6
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|6
block|,
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|10
block|,
literal|10
block|,
literal|10
block|,
literal|14
block|}
decl_stmt|;
name|int
name|pos
decl_stmt|;
name|int
name|color
decl_stmt|;
name|int
name|a
decl_stmt|;
name|pos
operator|=
operator|(
name|y
operator|/
name|scp
operator|->
name|font_size
operator|-
name|scp
operator|->
name|yoff
operator|)
operator|*
name|scp
operator|->
name|xsize
operator|+
name|x
operator|/
literal|8
operator|-
name|scp
operator|->
name|xoff
expr_stmt|;
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_flags
operator|&
name|V_ADP_COLOR
condition|)
name|color
operator|=
operator|(
name|col_conv
index|[
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
index|]
operator|<<
literal|12
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x0f00
operator|)
operator||
literal|0x0800
operator|)
expr_stmt|;
else|else
name|color
operator|=
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|a
operator|&
literal|0x0f00
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|sc_vtb_putc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
argument_list|,
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|scr
argument_list|,
name|pos
argument_list|)
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|remove_txtmouse
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|vga_txtmouse
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
condition|)
name|draw_txtmouse
argument_list|(
name|scp
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
else|else
name|remove_txtmouse
argument_list|(
name|scp
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_NO_CUTPASTE */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SC_PIXEL_MODE
end_ifdef

begin_comment
comment|/* pixel (raster text) mode renderer */
end_comment

begin_function
specifier|static
name|void
name|vga_rndrinit
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{
if|if
condition|(
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_mem_model
operator|==
name|V_INFO_MM_PLANAR
condition|)
block|{
name|scp
operator|->
name|rndr
operator|->
name|clear
operator|=
name|vga_pxlclear_planar
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|draw_border
operator|=
name|vga_pxlborder_planar
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_type
operator|==
name|KD_VGA
condition|)
name|scp
operator|->
name|rndr
operator|->
name|draw
operator|=
name|vga_egadraw
expr_stmt|;
else|else
name|scp
operator|->
name|rndr
operator|->
name|draw
operator|=
name|vga_vgadraw_planar
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|draw_cursor
operator|=
name|vga_pxlcursor_planar
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|blink_cursor
operator|=
name|vga_pxlblink_planar
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|draw_mouse
operator|=
name|vga_pxlmouse_planar
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_mem_model
operator|==
name|V_INFO_MM_DIRECT
operator|||
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_mem_model
operator|==
name|V_INFO_MM_PACKED
condition|)
block|{
name|scp
operator|->
name|rndr
operator|->
name|clear
operator|=
name|vga_pxlclear_direct
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|draw_border
operator|=
name|vga_pxlborder_direct
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|draw
operator|=
name|vga_vgadraw_direct
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|draw_cursor
operator|=
name|vga_pxlcursor_direct
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|blink_cursor
operator|=
name|vga_pxlblink_direct
expr_stmt|;
name|scp
operator|->
name|rndr
operator|->
name|draw_mouse
operator|=
name|vga_pxlmouse_direct
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlclear_direct
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|vm_offset_t
name|p
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|pixel_size
decl_stmt|;
name|int
name|lines
decl_stmt|;
name|int
name|i
decl_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|pixel_size
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_pixel_size
expr_stmt|;
name|lines
operator|=
name|scp
operator|->
name|ysize
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|line_width
operator|*
name|scp
operator|->
name|yoff
operator|*
name|scp
operator|->
name|font_size
operator|+
name|scp
operator|->
name|xoff
operator|*
literal|8
operator|*
name|pixel_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lines
condition|;
operator|++
name|i
control|)
block|{
name|bzero_io
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
name|scp
operator|->
name|xsize
operator|*
literal|8
operator|*
name|pixel_size
argument_list|)
expr_stmt|;
name|p
operator|+=
name|line_width
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlclear_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|attr
parameter_list|)
block|{
name|vm_offset_t
name|p
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|lines
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* XXX: we are just filling the screen with the background color... */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0f01
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
operator|(
operator|(
name|attr
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|lines
operator|=
name|scp
operator|->
name|ysize
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|line_width
operator|*
name|scp
operator|->
name|yoff
operator|*
name|scp
operator|->
name|font_size
operator|+
name|scp
operator|->
name|xoff
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lines
condition|;
operator|++
name|i
control|)
block|{
name|bzero_io
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
name|scp
operator|->
name|xsize
argument_list|)
expr_stmt|;
name|p
operator|+=
name|line_width
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlborder_direct
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|color
parameter_list|)
block|{
name|vm_offset_t
name|s
decl_stmt|;
name|vm_offset_t
name|e
decl_stmt|;
name|vm_offset_t
name|f
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|pixel_size
decl_stmt|;
name|int
name|x
decl_stmt|;
name|int
name|y
decl_stmt|;
name|int
name|i
decl_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|pixel_size
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_pixel_size
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|yoff
operator|>
literal|0
condition|)
block|{
name|s
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
expr_stmt|;
name|e
operator|=
name|s
operator|+
name|line_width
operator|*
name|scp
operator|->
name|yoff
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
for|for
control|(
name|f
operator|=
name|s
init|;
name|f
operator|<
name|e
condition|;
name|f
operator|+=
name|pixel_size
control|)
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|f
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
name|y
operator|=
operator|(
name|scp
operator|->
name|yoff
operator|+
name|scp
operator|->
name|ysize
operator|)
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|ypixel
operator|>
name|y
condition|)
block|{
name|s
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|line_width
operator|*
name|y
expr_stmt|;
name|e
operator|=
name|s
operator|+
name|line_width
operator|*
operator|(
name|scp
operator|->
name|ypixel
operator|-
name|y
operator|)
expr_stmt|;
for|for
control|(
name|f
operator|=
name|s
init|;
name|f
operator|<
name|e
condition|;
name|f
operator|+=
name|pixel_size
control|)
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|f
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
name|y
operator|=
name|scp
operator|->
name|yoff
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
name|x
operator|=
name|scp
operator|->
name|xpixel
operator|/
literal|8
operator|-
name|scp
operator|->
name|xoff
operator|-
name|scp
operator|->
name|xsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scp
operator|->
name|ysize
operator|*
name|scp
operator|->
name|font_size
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|scp
operator|->
name|xoff
operator|>
literal|0
condition|)
block|{
name|s
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|line_width
operator|*
operator|(
name|y
operator|+
name|i
operator|)
expr_stmt|;
name|e
operator|=
name|s
operator|+
name|scp
operator|->
name|xoff
operator|*
literal|8
operator|*
name|pixel_size
expr_stmt|;
for|for
control|(
name|f
operator|=
name|s
init|;
name|f
operator|<
name|e
condition|;
name|f
operator|+=
name|pixel_size
control|)
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|f
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|>
literal|0
condition|)
block|{
name|s
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|line_width
operator|*
operator|(
name|y
operator|+
name|i
operator|)
operator|+
name|scp
operator|->
name|xoff
operator|*
literal|8
operator|*
name|pixel_size
operator|+
name|scp
operator|->
name|xsize
operator|*
literal|8
operator|*
name|pixel_size
expr_stmt|;
name|e
operator|=
name|s
operator|+
name|x
operator|*
literal|8
operator|*
name|pixel_size
expr_stmt|;
for|for
control|(
name|f
operator|=
name|s
init|;
name|f
operator|<
name|e
condition|;
name|f
operator|+=
name|pixel_size
control|)
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|f
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlborder_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|color
parameter_list|)
block|{
name|vm_offset_t
name|p
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|x
decl_stmt|;
name|int
name|y
decl_stmt|;
name|int
name|i
decl_stmt|;
name|vidd_set_border
argument_list|(
name|scp
operator|->
name|sc
operator|->
name|adp
argument_list|,
name|color
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0f01
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
operator|(
name|color
operator|<<
literal|8
operator|)
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|yoff
operator|>
literal|0
condition|)
name|bzero_io
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
name|line_width
operator|*
name|scp
operator|->
name|yoff
operator|*
name|scp
operator|->
name|font_size
argument_list|)
expr_stmt|;
name|y
operator|=
operator|(
name|scp
operator|->
name|yoff
operator|+
name|scp
operator|->
name|ysize
operator|)
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|ypixel
operator|>
name|y
condition|)
name|bzero_io
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|p
operator|+
name|line_width
operator|*
name|y
operator|)
argument_list|,
name|line_width
operator|*
operator|(
name|scp
operator|->
name|ypixel
operator|-
name|y
operator|)
argument_list|)
expr_stmt|;
name|y
operator|=
name|scp
operator|->
name|yoff
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
name|x
operator|=
name|scp
operator|->
name|xpixel
operator|/
literal|8
operator|-
name|scp
operator|->
name|xoff
operator|-
name|scp
operator|->
name|xsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scp
operator|->
name|ysize
operator|*
name|scp
operator|->
name|font_size
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|scp
operator|->
name|xoff
operator|>
literal|0
condition|)
name|bzero_io
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|p
operator|+
name|line_width
operator|*
operator|(
name|y
operator|+
name|i
operator|)
operator|)
argument_list|,
name|scp
operator|->
name|xoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|>
literal|0
condition|)
name|bzero_io
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|p
operator|+
name|line_width
operator|*
operator|(
name|y
operator|+
name|i
operator|)
operator|+
name|scp
operator|->
name|xoff
operator|+
name|scp
operator|->
name|xsize
operator|)
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
block|}
end_function

begin_function
specifier|static
name|void
name|vga_egadraw
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|from
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|vm_offset_t
name|d
decl_stmt|;
name|vm_offset_t
name|e
decl_stmt|;
name|u_char
modifier|*
name|f
decl_stmt|;
name|u_short
name|bg
decl_stmt|;
name|u_short
name|col1
decl_stmt|,
name|col2
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|a
decl_stmt|;
name|u_char
name|c
decl_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|d
operator|=
name|GET_PIXEL
argument_list|(
name|scp
argument_list|,
name|from
argument_list|,
literal|1
argument_list|,
name|line_width
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0f01
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|bg
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|from
operator|+
name|count
operator|>
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
condition|)
name|count
operator|=
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|-
name|from
expr_stmt|;
for|for
control|(
name|i
operator|=
name|from
init|;
name|count
operator|--
operator|>
literal|0
condition|;
operator|++
name|i
control|)
block|{
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|flip
condition|)
block|{
name|col1
operator|=
operator|(
operator|(
name|a
operator|&
literal|0x7000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
name|a
operator|&
literal|0x0800
operator|)
expr_stmt|;
name|col2
operator|=
operator|(
operator|(
name|a
operator|&
literal|0x8000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
name|a
operator|&
literal|0x0700
operator|)
expr_stmt|;
block|}
else|else
block|{
name|col1
operator|=
operator|(
name|a
operator|&
literal|0x0f00
operator|)
expr_stmt|;
name|col2
operator|=
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
expr_stmt|;
block|}
comment|/* set background color in EGA/VGA latch */
if|if
condition|(
name|bg
operator|!=
name|col2
condition|)
block|{
name|bg
operator|=
name|col2
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
name|bg
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|writeb
argument_list|(
name|d
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|c
operator|=
name|readb
argument_list|(
name|d
argument_list|)
expr_stmt|;
comment|/* set bg color in the latch */
block|}
comment|/* foreground color */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
name|col1
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|e
operator|=
name|d
expr_stmt|;
name|f
operator|=
operator|&
operator|(
name|scp
operator|->
name|font
index|[
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|i
argument_list|)
operator|*
name|scp
operator|->
name|font_size
index|]
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|scp
operator|->
name|font_size
condition|;
operator|++
name|j
operator|,
operator|++
name|f
control|)
block|{
name|outw
argument_list|(
name|GDCIDX
argument_list|,
operator|(
operator|*
name|f
operator|<<
literal|8
operator|)
operator||
literal|0x08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|writeb
argument_list|(
name|e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|e
operator|+=
name|line_width
expr_stmt|;
block|}
operator|++
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
name|scp
operator|->
name|xsize
operator|)
operator|==
name|scp
operator|->
name|xsize
operator|-
literal|1
condition|)
name|d
operator|+=
name|scp
operator|->
name|font_size
operator|*
name|line_width
operator|-
name|scp
operator|->
name|xsize
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
block|}
end_function

begin_function
specifier|static
name|void
name|vga_vgadraw_direct
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|from
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|vm_offset_t
name|d
decl_stmt|;
name|vm_offset_t
name|e
decl_stmt|;
name|u_char
modifier|*
name|f
decl_stmt|;
name|u_short
name|col1
decl_stmt|,
name|col2
decl_stmt|,
name|color
decl_stmt|;
name|int
name|line_width
decl_stmt|,
name|pixel_size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|int
name|a
decl_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|pixel_size
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_pixel_size
expr_stmt|;
name|d
operator|=
name|GET_PIXEL
argument_list|(
name|scp
argument_list|,
name|from
argument_list|,
literal|8
operator|*
name|pixel_size
argument_list|,
name|line_width
argument_list|)
expr_stmt|;
if|if
condition|(
name|from
operator|+
name|count
operator|>
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
condition|)
name|count
operator|=
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|-
name|from
expr_stmt|;
for|for
control|(
name|i
operator|=
name|from
init|;
name|count
operator|--
operator|>
literal|0
condition|;
operator|++
name|i
control|)
block|{
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|flip
condition|)
block|{
name|col1
operator|=
operator|(
operator|(
operator|(
name|a
operator|&
literal|0x7000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
name|a
operator|&
literal|0x0800
operator|)
operator|)
operator|>>
literal|8
expr_stmt|;
name|col2
operator|=
operator|(
operator|(
operator|(
name|a
operator|&
literal|0x8000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
name|a
operator|&
literal|0x0700
operator|)
operator|)
operator|>>
literal|8
expr_stmt|;
block|}
else|else
block|{
name|col1
operator|=
operator|(
name|a
operator|&
literal|0x0f00
operator|)
operator|>>
literal|8
expr_stmt|;
name|col2
operator|=
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|12
expr_stmt|;
block|}
name|e
operator|=
name|d
expr_stmt|;
name|f
operator|=
operator|&
operator|(
name|scp
operator|->
name|font
index|[
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|i
argument_list|)
operator|*
name|scp
operator|->
name|font_size
index|]
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|scp
operator|->
name|font_size
condition|;
operator|++
name|j
operator|,
operator|++
name|f
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|8
condition|;
operator|++
name|k
control|)
block|{
name|color
operator|=
operator|*
name|f
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|7
operator|-
name|k
operator|)
operator|)
condition|?
name|col1
else|:
name|col2
expr_stmt|;
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|e
operator|+
name|pixel_size
operator|*
name|k
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
name|e
operator|+=
name|line_width
expr_stmt|;
block|}
name|d
operator|+=
literal|8
operator|*
name|pixel_size
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
name|scp
operator|->
name|xsize
operator|)
operator|==
name|scp
operator|->
name|xsize
operator|-
literal|1
condition|)
name|d
operator|+=
name|scp
operator|->
name|font_size
operator|*
name|line_width
operator|-
name|scp
operator|->
name|xsize
operator|*
literal|8
operator|*
name|pixel_size
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vga_vgadraw_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|from
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|vm_offset_t
name|d
decl_stmt|;
name|vm_offset_t
name|e
decl_stmt|;
name|u_char
modifier|*
name|f
decl_stmt|;
name|u_short
name|bg
decl_stmt|;
name|u_short
name|col1
decl_stmt|,
name|col2
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|a
decl_stmt|;
name|u_char
name|c
decl_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|d
operator|=
name|GET_PIXEL
argument_list|(
name|scp
argument_list|,
name|from
argument_list|,
literal|1
argument_list|,
name|line_width
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0305
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 3 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0f01
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|bg
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|from
operator|+
name|count
operator|>
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
condition|)
name|count
operator|=
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
operator|-
name|from
expr_stmt|;
for|for
control|(
name|i
operator|=
name|from
init|;
name|count
operator|--
operator|>
literal|0
condition|;
operator|++
name|i
control|)
block|{
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|flip
condition|)
block|{
name|col1
operator|=
operator|(
operator|(
name|a
operator|&
literal|0x7000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
name|a
operator|&
literal|0x0800
operator|)
expr_stmt|;
name|col2
operator|=
operator|(
operator|(
name|a
operator|&
literal|0x8000
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
name|a
operator|&
literal|0x0700
operator|)
expr_stmt|;
block|}
else|else
block|{
name|col1
operator|=
operator|(
name|a
operator|&
literal|0x0f00
operator|)
expr_stmt|;
name|col2
operator|=
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
expr_stmt|;
block|}
comment|/* set background color in EGA/VGA latch */
if|if
condition|(
name|bg
operator|!=
name|col2
condition|)
block|{
name|bg
operator|=
name|col2
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
name|bg
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|writeb
argument_list|(
name|d
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|c
operator|=
name|readb
argument_list|(
name|d
argument_list|)
expr_stmt|;
comment|/* set bg color in the latch */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0305
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 3 */
block|}
comment|/* foreground color */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
name|col1
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|e
operator|=
name|d
expr_stmt|;
name|f
operator|=
operator|&
operator|(
name|scp
operator|->
name|font
index|[
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|i
argument_list|)
operator|*
name|scp
operator|->
name|font_size
index|]
operator|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|scp
operator|->
name|font_size
condition|;
operator|++
name|j
operator|,
operator|++
name|f
control|)
block|{
name|writeb
argument_list|(
name|e
argument_list|,
operator|*
name|f
argument_list|)
expr_stmt|;
name|e
operator|+=
name|line_width
expr_stmt|;
block|}
operator|++
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
name|scp
operator|->
name|xsize
operator|)
operator|==
name|scp
operator|->
name|xsize
operator|-
literal|1
condition|)
name|d
operator|+=
name|scp
operator|->
name|font_size
operator|*
name|line_width
operator|-
name|scp
operator|->
name|xsize
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlcursor_shape
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|base
parameter_list|,
name|int
name|height
parameter_list|,
name|int
name|blink
parameter_list|)
block|{
if|if
condition|(
name|base
operator|<
literal|0
operator|||
name|base
operator|>=
name|scp
operator|->
name|font_size
condition|)
return|return;
comment|/* the caller may set height<= 0 in order to disable the cursor */
if|#
directive|if
literal|0
block|scp->curs_attr.base = base; 	scp->curs_attr.height = height;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|draw_pxlcursor_direct
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|on
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|vm_offset_t
name|d
decl_stmt|;
name|u_char
modifier|*
name|f
decl_stmt|;
name|int
name|line_width
decl_stmt|,
name|pixel_size
decl_stmt|;
name|int
name|height
decl_stmt|;
name|int
name|col1
decl_stmt|,
name|col2
decl_stmt|,
name|color
decl_stmt|;
name|int
name|a
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|pixel_size
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_pixel_size
expr_stmt|;
name|d
operator|=
name|GET_PIXEL
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
literal|8
operator|*
name|pixel_size
argument_list|,
name|line_width
argument_list|)
operator|+
operator|(
name|scp
operator|->
name|font_size
operator|-
name|scp
operator|->
name|curs_attr
operator|.
name|base
operator|-
literal|1
operator|)
operator|*
name|line_width
expr_stmt|;
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
expr_stmt|;
if|if
condition|(
name|flip
condition|)
block|{
name|col1
operator|=
operator|(
operator|(
name|on
operator|)
condition|?
operator|(
name|a
operator|&
literal|0x0f00
operator|)
else|:
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
operator|)
operator|>>
literal|8
expr_stmt|;
name|col2
operator|=
operator|(
operator|(
name|on
operator|)
condition|?
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
else|:
operator|(
name|a
operator|&
literal|0x0f00
operator|)
operator|)
operator|>>
literal|8
expr_stmt|;
block|}
else|else
block|{
name|col1
operator|=
operator|(
operator|(
name|on
operator|)
condition|?
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
else|:
operator|(
name|a
operator|&
literal|0x0f00
operator|)
operator|)
operator|>>
literal|8
expr_stmt|;
name|col2
operator|=
operator|(
operator|(
name|on
operator|)
condition|?
operator|(
name|a
operator|&
literal|0x0f00
operator|)
else|:
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
operator|)
operator|>>
literal|8
expr_stmt|;
block|}
name|f
operator|=
operator|&
operator|(
name|scp
operator|->
name|font
index|[
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
operator|*
name|scp
operator|->
name|font_size
operator|+
name|scp
operator|->
name|font_size
operator|-
name|scp
operator|->
name|curs_attr
operator|.
name|base
operator|-
literal|1
index|]
operator|)
expr_stmt|;
name|height
operator|=
name|imin
argument_list|(
name|scp
operator|->
name|curs_attr
operator|.
name|height
argument_list|,
name|scp
operator|->
name|font_size
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
operator|++
name|i
operator|,
operator|--
name|f
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
operator|++
name|j
control|)
block|{
name|color
operator|=
operator|*
name|f
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|7
operator|-
name|j
operator|)
operator|)
condition|?
name|col1
else|:
name|col2
expr_stmt|;
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|d
operator|+
name|pixel_size
operator|*
name|j
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
name|d
operator|-=
name|line_width
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|draw_pxlcursor_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|on
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
name|vm_offset_t
name|d
decl_stmt|;
name|u_char
modifier|*
name|f
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|height
decl_stmt|;
name|int
name|col
decl_stmt|;
name|int
name|a
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_char
name|c
decl_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|d
operator|=
name|GET_PIXEL
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
literal|1
argument_list|,
name|line_width
argument_list|)
operator|+
operator|(
name|scp
operator|->
name|font_size
operator|-
name|scp
operator|->
name|curs_attr
operator|.
name|base
operator|-
literal|1
operator|)
operator|*
name|line_width
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0f01
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
comment|/* set background color in EGA/VGA latch */
name|a
operator|=
name|sc_vtb_geta
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
expr_stmt|;
if|if
condition|(
name|flip
condition|)
name|col
operator|=
operator|(
name|on
operator|)
condition|?
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
else|:
operator|(
name|a
operator|&
literal|0x0f00
operator|)
expr_stmt|;
else|else
name|col
operator|=
operator|(
name|on
operator|)
condition|?
operator|(
name|a
operator|&
literal|0x0f00
operator|)
else|:
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
name|col
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|writeb
argument_list|(
name|d
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|c
operator|=
name|readb
argument_list|(
name|d
argument_list|)
expr_stmt|;
comment|/* set bg color in the latch */
comment|/* foreground color */
if|if
condition|(
name|flip
condition|)
name|col
operator|=
operator|(
name|on
operator|)
condition|?
operator|(
name|a
operator|&
literal|0x0f00
operator|)
else|:
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
else|else
name|col
operator|=
operator|(
name|on
operator|)
condition|?
operator|(
operator|(
name|a
operator|&
literal|0xf000
operator|)
operator|>>
literal|4
operator|)
else|:
operator|(
name|a
operator|&
literal|0x0f00
operator|)
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
name|col
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|f
operator|=
operator|&
operator|(
name|scp
operator|->
name|font
index|[
name|sc_vtb_getc
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|at
argument_list|)
operator|*
name|scp
operator|->
name|font_size
operator|+
name|scp
operator|->
name|font_size
operator|-
name|scp
operator|->
name|curs_attr
operator|.
name|base
operator|-
literal|1
index|]
operator|)
expr_stmt|;
name|height
operator|=
name|imin
argument_list|(
name|scp
operator|->
name|curs_attr
operator|.
name|height
argument_list|,
name|scp
operator|->
name|font_size
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|height
condition|;
operator|++
name|i
operator|,
operator|--
name|f
control|)
block|{
name|outw
argument_list|(
name|GDCIDX
argument_list|,
operator|(
operator|*
name|f
operator|<<
literal|8
operator|)
operator||
literal|0x08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|writeb
argument_list|(
name|d
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|d
operator|-=
name|line_width
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|pxlblinkrate
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|vga_pxlcursor_direct
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|blink
parameter_list|,
name|int
name|on
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
if|if
condition|(
name|scp
operator|->
name|curs_attr
operator|.
name|height
operator|<=
literal|0
condition|)
comment|/* the text cursor is disabled */
return|return;
if|if
condition|(
name|on
condition|)
block|{
if|if
condition|(
operator|!
name|blink
condition|)
block|{
name|scp
operator|->
name|status
operator||=
name|VR_CURSOR_ON
expr_stmt|;
name|draw_pxlcursor_direct
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|on
argument_list|,
name|flip
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|++
name|pxlblinkrate
operator|&
literal|4
condition|)
block|{
name|pxlblinkrate
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|status
operator|^=
name|VR_CURSOR_ON
expr_stmt|;
name|draw_pxlcursor_direct
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
argument_list|,
name|flip
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
condition|)
name|draw_pxlcursor_direct
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|on
argument_list|,
name|flip
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|VR_CURSOR_ON
expr_stmt|;
block|}
if|if
condition|(
name|blink
condition|)
name|scp
operator|->
name|status
operator||=
name|VR_CURSOR_BLINK
expr_stmt|;
else|else
name|scp
operator|->
name|status
operator|&=
operator|~
name|VR_CURSOR_BLINK
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlcursor_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|blink
parameter_list|,
name|int
name|on
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
if|if
condition|(
name|scp
operator|->
name|curs_attr
operator|.
name|height
operator|<=
literal|0
condition|)
comment|/* the text cursor is disabled */
return|return;
if|if
condition|(
name|on
condition|)
block|{
if|if
condition|(
operator|!
name|blink
condition|)
block|{
name|scp
operator|->
name|status
operator||=
name|VR_CURSOR_ON
expr_stmt|;
name|draw_pxlcursor_planar
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|on
argument_list|,
name|flip
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|++
name|pxlblinkrate
operator|&
literal|4
condition|)
block|{
name|pxlblinkrate
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|status
operator|^=
name|VR_CURSOR_ON
expr_stmt|;
name|draw_pxlcursor_planar
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
argument_list|,
name|flip
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
condition|)
name|draw_pxlcursor_planar
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|on
argument_list|,
name|flip
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|VR_CURSOR_ON
expr_stmt|;
block|}
if|if
condition|(
name|blink
condition|)
name|scp
operator|->
name|status
operator||=
name|VR_CURSOR_BLINK
expr_stmt|;
else|else
name|scp
operator|->
name|status
operator|&=
operator|~
name|VR_CURSOR_BLINK
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlblink_direct
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_BLINK
operator|)
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
operator|++
name|pxlblinkrate
operator|&
literal|4
operator|)
condition|)
return|return;
name|pxlblinkrate
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|status
operator|^=
name|VR_CURSOR_ON
expr_stmt|;
name|draw_pxlcursor_direct
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
argument_list|,
name|flip
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlblink_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|at
parameter_list|,
name|int
name|flip
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_BLINK
operator|)
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
operator|++
name|pxlblinkrate
operator|&
literal|4
operator|)
condition|)
return|return;
name|pxlblinkrate
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|status
operator|^=
name|VR_CURSOR_ON
expr_stmt|;
name|draw_pxlcursor_planar
argument_list|(
name|scp
argument_list|,
name|at
argument_list|,
name|scp
operator|->
name|status
operator|&
name|VR_CURSOR_ON
argument_list|,
name|flip
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_CUTPASTE
end_ifndef

begin_function
specifier|static
name|void
name|draw_pxlmouse_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
specifier|const
name|struct
name|mousedata
modifier|*
name|mdp
decl_stmt|;
name|vm_offset_t
name|p
decl_stmt|;
name|int
name|line_width
decl_stmt|;
name|int
name|xoff
decl_stmt|,
name|yoff
decl_stmt|;
name|int
name|ymax
decl_stmt|;
name|uint32_t
name|m
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|uint8_t
name|m1
decl_stmt|;
name|mdp
operator|=
operator|(
name|scp
operator|->
name|font_size
operator|<
literal|14
operator|)
condition|?
operator|&
name|mouse9x13
else|:
operator|&
name|mouse10x16
expr_stmt|;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|xoff
operator|=
operator|(
name|x
operator|-
name|scp
operator|->
name|xoff
operator|*
literal|8
operator|)
operator|%
literal|8
expr_stmt|;
name|yoff
operator|=
name|y
operator|-
name|rounddown
argument_list|(
name|y
argument_list|,
name|line_width
argument_list|)
expr_stmt|;
name|ymax
operator|=
name|imin
argument_list|(
name|y
operator|+
name|mdp
operator|->
name|md_height
argument_list|,
name|scp
operator|->
name|ypixel
argument_list|)
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0803
argument_list|)
expr_stmt|;
comment|/* data rotate/function select (and) */
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|line_width
operator|*
name|y
operator|+
name|x
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
name|y
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|ymax
condition|;
operator|++
name|i
operator|,
operator|++
name|j
control|)
block|{
name|m
operator|=
operator|~
operator|(
name|mdp
operator|->
name|md_border
index|[
name|j
index|]
operator|<<
literal|8
operator|>>
name|xoff
operator|)
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|3
condition|;
operator|++
name|k
control|)
block|{
name|m1
operator|=
name|m
operator|>>
operator|(
literal|8
operator|*
operator|(
literal|2
operator|-
name|k
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|m1
operator|!=
literal|0xff
operator|&&
name|x
operator|+
literal|8
operator|*
name|k
operator|<
name|scp
operator|->
name|xpixel
condition|)
block|{
name|readb
argument_list|(
name|p
operator|+
name|k
argument_list|)
expr_stmt|;
name|writeb
argument_list|(
name|p
operator|+
name|k
argument_list|,
name|m1
argument_list|)
expr_stmt|;
block|}
block|}
name|p
operator|+=
name|line_width
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x1003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select (or) */
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|line_width
operator|*
name|y
operator|+
name|x
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
name|y
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|ymax
condition|;
operator|++
name|i
operator|,
operator|++
name|j
control|)
block|{
name|m
operator|=
name|mdp
operator|->
name|md_interior
index|[
name|j
index|]
operator|<<
literal|8
operator|>>
name|xoff
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|3
condition|;
operator|++
name|k
control|)
block|{
name|m1
operator|=
name|m
operator|>>
operator|(
literal|8
operator|*
operator|(
literal|2
operator|-
name|k
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|m1
operator|!=
literal|0
operator|&&
name|x
operator|+
literal|8
operator|*
name|k
operator|<
name|scp
operator|->
name|xpixel
condition|)
block|{
name|readb
argument_list|(
name|p
operator|+
name|k
argument_list|)
expr_stmt|;
name|writeb
argument_list|(
name|p
operator|+
name|k
argument_list|,
name|m1
argument_list|)
expr_stmt|;
block|}
block|}
name|p
operator|+=
name|line_width
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select */
block|}
end_function

begin_function
specifier|static
name|void
name|remove_pxlmouse_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|)
block|{
specifier|const
name|struct
name|mousedata
modifier|*
name|mdp
decl_stmt|;
name|vm_offset_t
name|p
decl_stmt|;
name|int
name|bx
decl_stmt|,
name|by
decl_stmt|,
name|i
decl_stmt|,
name|line_width
decl_stmt|,
name|xend
decl_stmt|,
name|xoff
decl_stmt|,
name|yend
decl_stmt|,
name|yoff
decl_stmt|;
name|mdp
operator|=
operator|(
name|scp
operator|->
name|font_size
operator|<
literal|14
operator|)
condition|?
operator|&
name|mouse9x13
else|:
operator|&
name|mouse10x16
expr_stmt|;
comment|/* 	 * It is only necessary to remove the mouse image where it overlaps 	 * the border.  Determine the overlap, and do nothing if it is empty. 	 */
name|bx
operator|=
operator|(
name|scp
operator|->
name|xoff
operator|+
name|scp
operator|->
name|xsize
operator|)
operator|*
literal|8
expr_stmt|;
name|by
operator|=
operator|(
name|scp
operator|->
name|yoff
operator|+
name|scp
operator|->
name|ysize
operator|)
operator|*
name|scp
operator|->
name|font_size
expr_stmt|;
name|xend
operator|=
name|imin
argument_list|(
name|x
operator|+
name|mdp
operator|->
name|md_width
argument_list|,
name|scp
operator|->
name|xpixel
argument_list|)
expr_stmt|;
name|yend
operator|=
name|imin
argument_list|(
name|y
operator|+
name|mdp
operator|->
name|md_height
argument_list|,
name|scp
operator|->
name|ypixel
argument_list|)
expr_stmt|;
if|if
condition|(
name|xend
operator|<=
name|bx
operator|&&
name|yend
operator|<=
name|by
condition|)
return|return;
comment|/* Repaint the non-empty overlap. */
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0005
argument_list|)
expr_stmt|;
comment|/* read mode 0, write mode 0 */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0003
argument_list|)
expr_stmt|;
comment|/* data rotate/function select */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0f01
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0xff08
argument_list|)
expr_stmt|;
comment|/* bit mask */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
operator|(
name|scp
operator|->
name|border
operator|<<
literal|8
operator|)
operator||
literal|0x00
argument_list|)
expr_stmt|;
comment|/* set/reset */
for|for
control|(
name|i
operator|=
name|x
operator|/
literal|8
operator|,
name|xoff
operator|=
name|i
operator|*
literal|8
init|;
name|xoff
operator|<
name|xend
condition|;
operator|++
name|i
operator|,
name|xoff
operator|+=
literal|8
control|)
block|{
name|yoff
operator|=
operator|(
name|xoff
operator|>=
name|bx
operator|)
condition|?
name|y
else|:
name|by
expr_stmt|;
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|yoff
operator|*
name|line_width
operator|+
name|i
expr_stmt|;
for|for
control|(
init|;
name|yoff
operator|<
name|yend
condition|;
operator|++
name|yoff
operator|,
name|p
operator|+=
name|line_width
control|)
name|writeb
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* set/reset */
name|outw
argument_list|(
name|GDCIDX
argument_list|,
literal|0x0001
argument_list|)
expr_stmt|;
comment|/* set/reset enable */
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlmouse_direct
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|on
parameter_list|)
block|{
specifier|const
name|struct
name|mousedata
modifier|*
name|mdp
decl_stmt|;
name|vm_offset_t
name|p
decl_stmt|;
name|int
name|line_width
decl_stmt|,
name|pixel_size
decl_stmt|;
name|int
name|xend
decl_stmt|,
name|yend
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|mdp
operator|=
operator|(
name|scp
operator|->
name|font_size
operator|<
literal|14
operator|)
condition|?
operator|&
name|mouse9x13
else|:
operator|&
name|mouse10x16
expr_stmt|;
comment|/* 	 * Determine overlap with the border and then if removing, do nothing 	 * if the overlap is empty. 	 */
name|xend
operator|=
name|imin
argument_list|(
name|x
operator|+
name|mdp
operator|->
name|md_width
argument_list|,
name|scp
operator|->
name|xpixel
argument_list|)
expr_stmt|;
name|yend
operator|=
name|imin
argument_list|(
name|y
operator|+
name|mdp
operator|->
name|md_height
argument_list|,
name|scp
operator|->
name|ypixel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|on
operator|&&
name|xend
operator|<=
operator|(
name|scp
operator|->
name|xoff
operator|+
name|scp
operator|->
name|xsize
operator|)
operator|*
literal|8
operator|&&
name|yend
operator|<=
operator|(
name|scp
operator|->
name|yoff
operator|+
name|scp
operator|->
name|ysize
operator|)
operator|*
name|scp
operator|->
name|font_size
condition|)
return|return;
name|line_width
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
name|pixel_size
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_info
operator|.
name|vi_pixel_size
expr_stmt|;
if|if
condition|(
name|on
condition|)
goto|goto
name|do_on
goto|;
comment|/* Repaint overlap with the border (mess up the corner a little). */
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|y
operator|*
name|line_width
operator|+
name|x
operator|*
name|pixel_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|yend
operator|-
name|y
condition|;
name|i
operator|++
operator|,
name|p
operator|+=
name|line_width
control|)
for|for
control|(
name|j
operator|=
name|xend
operator|-
name|x
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|p
operator|+
name|j
operator|*
name|pixel_size
argument_list|,
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
return|return;
name|do_on
label|:
name|p
operator|=
name|scp
operator|->
name|sc
operator|->
name|adp
operator|->
name|va_window
operator|+
name|y
operator|*
name|line_width
operator|+
name|x
operator|*
name|pixel_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|yend
operator|-
name|y
condition|;
name|i
operator|++
operator|,
name|p
operator|+=
name|line_width
control|)
for|for
control|(
name|j
operator|=
name|xend
operator|-
name|x
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
if|if
condition|(
name|mdp
operator|->
name|md_interior
index|[
name|i
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|15
operator|-
name|j
operator|)
operator|)
condition|)
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|p
operator|+
name|j
operator|*
name|pixel_size
argument_list|,
literal|15
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mdp
operator|->
name|md_border
index|[
name|i
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|15
operator|-
name|j
operator|)
operator|)
condition|)
name|DRAW_PIXEL
argument_list|(
name|scp
argument_list|,
name|p
operator|+
name|j
operator|*
name|pixel_size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vga_pxlmouse_planar
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
condition|)
name|draw_pxlmouse_planar
argument_list|(
name|scp
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
else|else
name|remove_pxlmouse_planar
argument_list|(
name|scp
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_NO_CUTPASTE */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_PIXEL_MODE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|SC_NO_MODE_CHANGE
end_ifndef

begin_comment
comment|/* graphics mode renderer */
end_comment

begin_function
specifier|static
name|void
name|vga_grborder
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|color
parameter_list|)
block|{
name|vidd_set_border
argument_list|(
name|scp
operator|->
name|sc
operator|->
name|adp
argument_list|,
name|color
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


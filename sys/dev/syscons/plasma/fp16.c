begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Dag-Erling SmÃ¸rgrav  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|_KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"fp16.h"
end_include

begin_comment
comment|/*  * Compute the quare root of x, using Newton's method with 2^(log2(x)/2)  * as the initial estimate.  */
end_comment

begin_function
name|fp16_t
name|fp16_sqrt
parameter_list|(
name|fp16_t
name|x
parameter_list|)
block|{
name|fp16_t
name|y
decl_stmt|,
name|delta
decl_stmt|;
name|signed
name|int
name|log2x
decl_stmt|;
comment|/* special case */
if|if
condition|(
name|x
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* shift toward 0 by half the logarithm */
name|log2x
operator|=
name|flsl
argument_list|(
name|x
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|log2x
operator|>=
literal|16
condition|)
block|{
name|y
operator|=
name|x
operator|>>
operator|(
name|log2x
operator|-
literal|16
operator|)
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
if|#
directive|if
literal|0
block|y = x<< (16 - log2x) / 2;
else|#
directive|else
comment|/* XXX for now, return 0 for anything< 1 */
return|return
operator|(
literal|0
operator|)
return|;
endif|#
directive|endif
block|}
while|while
condition|(
name|y
operator|>
literal|0
condition|)
block|{
comment|/* delta = y^2 / 2y */
name|delta
operator|=
name|fp16_div
argument_list|(
name|fp16_sub
argument_list|(
name|fp16_mul
argument_list|(
name|y
argument_list|,
name|y
argument_list|)
argument_list|,
name|x
argument_list|)
argument_list|,
name|y
operator|*
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|==
literal|0
condition|)
break|break;
name|y
operator|=
name|fp16_sub
argument_list|(
name|y
argument_list|,
name|delta
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|y
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|fp16_t
name|fp16_cos_table
index|[
literal|256
index|]
init|=
block|{
literal|65536
block|,
literal|65534
block|,
literal|65531
block|,
literal|65524
block|,
literal|65516
block|,
literal|65505
block|,
literal|65491
block|,
literal|65475
block|,
literal|65457
block|,
literal|65436
block|,
literal|65412
block|,
literal|65386
block|,
literal|65358
block|,
literal|65327
block|,
literal|65294
block|,
literal|65258
block|,
literal|65220
block|,
literal|65179
block|,
literal|65136
block|,
literal|65091
block|,
literal|65043
block|,
literal|64992
block|,
literal|64939
block|,
literal|64884
block|,
literal|64826
block|,
literal|64766
block|,
literal|64703
block|,
literal|64638
block|,
literal|64571
block|,
literal|64501
block|,
literal|64428
block|,
literal|64353
block|,
literal|64276
block|,
literal|64197
block|,
literal|64115
block|,
literal|64030
block|,
literal|63943
block|,
literal|63854
block|,
literal|63762
block|,
literal|63668
block|,
literal|63571
block|,
literal|63473
block|,
literal|63371
block|,
literal|63268
block|,
literal|63162
block|,
literal|63053
block|,
literal|62942
block|,
literal|62829
block|,
literal|62714
block|,
literal|62596
block|,
literal|62475
block|,
literal|62353
block|,
literal|62228
block|,
literal|62100
block|,
literal|61971
block|,
literal|61839
block|,
literal|61705
block|,
literal|61568
block|,
literal|61429
block|,
literal|61288
block|,
literal|61144
block|,
literal|60998
block|,
literal|60850
block|,
literal|60700
block|,
literal|60547
block|,
literal|60392
block|,
literal|60235
block|,
literal|60075
block|,
literal|59913
block|,
literal|59749
block|,
literal|59583
block|,
literal|59414
block|,
literal|59243
block|,
literal|59070
block|,
literal|58895
block|,
literal|58718
block|,
literal|58538
block|,
literal|58356
block|,
literal|58172
block|,
literal|57986
block|,
literal|57797
block|,
literal|57606
block|,
literal|57414
block|,
literal|57219
block|,
literal|57022
block|,
literal|56822
block|,
literal|56621
block|,
literal|56417
block|,
literal|56212
block|,
literal|56004
block|,
literal|55794
block|,
literal|55582
block|,
literal|55368
block|,
literal|55152
block|,
literal|54933
block|,
literal|54713
block|,
literal|54491
block|,
literal|54266
block|,
literal|54040
block|,
literal|53811
block|,
literal|53581
block|,
literal|53348
block|,
literal|53114
block|,
literal|52877
block|,
literal|52639
block|,
literal|52398
block|,
literal|52155
block|,
literal|51911
block|,
literal|51665
block|,
literal|51416
block|,
literal|51166
block|,
literal|50914
block|,
literal|50660
block|,
literal|50403
block|,
literal|50146
block|,
literal|49886
block|,
literal|49624
block|,
literal|49360
block|,
literal|49095
block|,
literal|48828
block|,
literal|48558
block|,
literal|48288
block|,
literal|48015
block|,
literal|47740
block|,
literal|47464
block|,
literal|47186
block|,
literal|46906
block|,
literal|46624
block|,
literal|46340
block|,
literal|46055
block|,
literal|45768
block|,
literal|45480
block|,
literal|45189
block|,
literal|44897
block|,
literal|44603
block|,
literal|44308
block|,
literal|44011
block|,
literal|43712
block|,
literal|43412
block|,
literal|43110
block|,
literal|42806
block|,
literal|42501
block|,
literal|42194
block|,
literal|41885
block|,
literal|41575
block|,
literal|41263
block|,
literal|40950
block|,
literal|40636
block|,
literal|40319
block|,
literal|40002
block|,
literal|39682
block|,
literal|39362
block|,
literal|39039
block|,
literal|38716
block|,
literal|38390
block|,
literal|38064
block|,
literal|37736
block|,
literal|37406
block|,
literal|37075
block|,
literal|36743
block|,
literal|36409
block|,
literal|36074
block|,
literal|35738
block|,
literal|35400
block|,
literal|35061
block|,
literal|34721
block|,
literal|34379
block|,
literal|34036
block|,
literal|33692
block|,
literal|33346
block|,
literal|32999
block|,
literal|32651
block|,
literal|32302
block|,
literal|31952
block|,
literal|31600
block|,
literal|31247
block|,
literal|30893
block|,
literal|30538
block|,
literal|30181
block|,
literal|29824
block|,
literal|29465
block|,
literal|29105
block|,
literal|28745
block|,
literal|28383
block|,
literal|28020
block|,
literal|27656
block|,
literal|27291
block|,
literal|26925
block|,
literal|26557
block|,
literal|26189
block|,
literal|25820
block|,
literal|25450
block|,
literal|25079
block|,
literal|24707
block|,
literal|24334
block|,
literal|23960
block|,
literal|23586
block|,
literal|23210
block|,
literal|22833
block|,
literal|22456
block|,
literal|22078
block|,
literal|21699
block|,
literal|21319
block|,
literal|20938
block|,
literal|20557
block|,
literal|20175
block|,
literal|19792
block|,
literal|19408
block|,
literal|19024
block|,
literal|18638
block|,
literal|18253
block|,
literal|17866
block|,
literal|17479
block|,
literal|17091
block|,
literal|16702
block|,
literal|16313
block|,
literal|15923
block|,
literal|15533
block|,
literal|15142
block|,
literal|14751
block|,
literal|14359
block|,
literal|13966
block|,
literal|13573
block|,
literal|13179
block|,
literal|12785
block|,
literal|12390
block|,
literal|11995
block|,
literal|11600
block|,
literal|11204
block|,
literal|10807
block|,
literal|10410
block|,
literal|10013
block|,
literal|9616
block|,
literal|9218
block|,
literal|8819
block|,
literal|8421
block|,
literal|8022
block|,
literal|7623
block|,
literal|7223
block|,
literal|6823
block|,
literal|6423
block|,
literal|6023
block|,
literal|5622
block|,
literal|5222
block|,
literal|4821
block|,
literal|4420
block|,
literal|4018
block|,
literal|3617
block|,
literal|3215
block|,
literal|2814
block|,
literal|2412
block|,
literal|2010
block|,
literal|1608
block|,
literal|1206
block|,
literal|804
block|,
literal|402
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Compute the cosine of theta.  */
end_comment

begin_function
name|fp16_t
name|fp16_cos
parameter_list|(
name|fp16_t
name|theta
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|i
operator|=
literal|1024
operator|*
operator|(
name|theta
operator|%
name|FP16_2PI
operator|)
operator|/
name|FP16_2PI
expr_stmt|;
switch|switch
condition|(
name|i
operator|/
literal|256
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|(
name|fp16_cos_table
index|[
name|i
operator|%
literal|256
index|]
operator|)
return|;
case|case
literal|1
case|:
return|return
operator|(
operator|-
name|fp16_cos_table
index|[
literal|255
operator|-
name|i
operator|%
literal|256
index|]
operator|)
return|;
case|case
literal|2
case|:
return|return
operator|(
operator|-
name|fp16_cos_table
index|[
name|i
operator|%
literal|256
index|]
operator|)
return|;
case|case
literal|3
case|:
return|return
operator|(
name|fp16_cos_table
index|[
literal|255
operator|-
name|i
operator|%
literal|256
index|]
operator|)
return|;
default|default:
comment|/* inconceivable! */
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$Id: cardbus.c,v 1.1.2.1 1999/02/16 16:44:35 haya Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 1997 and 1998 HAYAKAWA Koichi.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by HAYAKAWA Koichi.  * 4. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/* FreeBSD/newconfig version. UCHIYAMA Yasushi 1999 */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_define
define|#
directive|define
name|CARDBUS_DEBUG
end_define

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/cardbus/pccardcis.h>
end_include

begin_include
include|#
directive|include
file|<dev/cardbus/cardbusreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/cardbus/cardbusvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pcmcia/pcmciareg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pcmcia/pcmciavar.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/i82365reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/ic/i82365reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pccbbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pccbbvar.h>
end_include

begin_if
if|#
directive|if
name|defined
name|CARDBUS_DEBUG
end_if

begin_define
define|#
directive|define
name|STATIC
end_define

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|a
parameter_list|)
value|printf a
end_define

begin_define
define|#
directive|define
name|DDELAY
parameter_list|(
name|x
parameter_list|)
value|delay((x)*1000*1000)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|STATIC
value|static
end_define

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|a
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|STATIC
name|void
name|cardbusattach
name|__P
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|,
expr|struct
name|device
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STATIC
name|int
name|cardbusmatch
name|__P
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|,
expr|struct
name|cfdata
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|cardbussubmatch
name|__P
argument_list|(
operator|(
expr|struct
name|device
operator|*
operator|,
expr|struct
name|cfdata
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|cardbusprint
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
specifier|const
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int8_t
modifier|*
name|decode_tuple
name|__P
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|decode_tuples
name|__P
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tuple_name
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|cfattach
name|cardbus_ca
init|=
block|{
sizeof|sizeof
argument_list|(
expr|struct
name|cardbus_softc
argument_list|)
block|,
name|cardbusmatch
block|,
name|cardbusattach
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|STATIC
name|int
name|cardbusmatch
parameter_list|(
name|parent
parameter_list|,
name|cf
parameter_list|,
name|aux
parameter_list|)
name|struct
name|device
modifier|*
name|parent
decl_stmt|;
name|struct
name|cfdata
modifier|*
name|cf
decl_stmt|;
name|void
modifier|*
name|aux
decl_stmt|;
block|{
name|struct
name|cbslot_attach_args
modifier|*
name|cba
init|=
name|aux
decl_stmt|;
comment|/* which slot? */
if|if
condition|(
name|cf
operator|->
name|cbslotcf_slot
operator|!=
name|CBSLOT_UNK_SLOT
operator|&&
name|cf
operator|->
name|cbslotcf_slot
operator|!=
name|cba
operator|->
name|cba_function
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"cardbusmatch: function differs %d<=> %d\n"
operator|,
name|cf
operator|->
name|cbslotcf_slot
operator|,
name|cba
operator|->
name|cba_function
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|cba
operator|->
name|cba_function
operator|<
literal|0
operator|||
name|cba
operator|->
name|cba_function
operator|>
literal|255
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|cardslot_if_setup
parameter_list|(
name|struct
name|cardbus_softc
modifier|*
name|csc
parameter_list|)
block|{
name|csc
operator|->
name|sc_if
operator|.
name|if_card_attach
operator|=
name|cardbus_attach_card
expr_stmt|;
block|}
end_function

begin_function
name|STATIC
name|void
name|cardbusattach
parameter_list|(
name|parent
parameter_list|,
name|self
parameter_list|,
name|aux
parameter_list|)
name|struct
name|device
modifier|*
name|parent
decl_stmt|;
name|struct
name|device
modifier|*
name|self
decl_stmt|;
name|void
modifier|*
name|aux
decl_stmt|;
block|{
name|struct
name|pccbb_softc
modifier|*
name|psc
init|=
operator|(
expr|struct
name|pccbb_softc
operator|*
operator|)
name|parent
decl_stmt|;
name|struct
name|cardbus_softc
modifier|*
name|sc
init|=
operator|(
name|void
operator|*
operator|)
name|self
decl_stmt|;
name|struct
name|cbslot_attach_args
modifier|*
name|cba
init|=
name|aux
decl_stmt|;
name|int
name|cdstatus
decl_stmt|;
name|sc
operator|->
name|sc_bus
operator|=
name|cba
operator|->
name|cba_bus
expr_stmt|;
name|sc
operator|->
name|sc_device
operator|=
name|cba
operator|->
name|cba_function
expr_stmt|;
name|sc
operator|->
name|sc_intrline
operator|=
name|cba
operator|->
name|cba_intrline
expr_stmt|;
name|printf
argument_list|(
literal|" bus %d device %d\n"
argument_list|,
name|sc
operator|->
name|sc_bus
argument_list|,
name|sc
operator|->
name|sc_device
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_iot
operator|=
name|cba
operator|->
name|cba_iot
expr_stmt|;
comment|/* CardBus I/O space tag */
name|sc
operator|->
name|sc_memt
operator|=
name|cba
operator|->
name|cba_memt
expr_stmt|;
comment|/* CardBus MEM space tag */
name|sc
operator|->
name|sc_dmat
operator|=
name|cba
operator|->
name|cba_dmat
expr_stmt|;
comment|/* DMA tag */
name|sc
operator|->
name|sc_cc
operator|=
name|cba
operator|->
name|cba_cc
expr_stmt|;
name|sc
operator|->
name|sc_cf
operator|=
name|cba
operator|->
name|cba_cf
expr_stmt|;
name|cardslot_if_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|cdstatus
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|cdstatus
operator|=
call|(
name|sc
operator|->
name|sc_cf
operator|->
name|cardbus_ctrl
call|)
argument_list|(
name|sc
operator|->
name|sc_cc
argument_list|,
name|CARDBUS_CD
argument_list|)
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"cardbusattach: CardBus card found [0x%x]\n"
operator|,
name|cdstatus
operator|)
argument_list|)
expr_stmt|;
name|psc
operator|->
name|sc_cbdev
operator|=
name|cardbus_attach_card
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/********************************************************************** * int cardbus_attach_card(struct cardbus_softc *sc) *    This functions attaches the card on the slot: turns on power, *    reads and analyses tuple, sets consifuration index. ***********************************************************************/
end_comment

begin_function
name|struct
name|device
modifier|*
name|cardbus_attach_card
parameter_list|(
name|sc
parameter_list|)
name|struct
name|cardbus_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|device
modifier|*
name|attached_device
init|=
name|NULL
decl_stmt|;
name|cardbus_chipset_tag_t
name|cc
decl_stmt|;
name|cardbus_function_tag_t
name|cf
decl_stmt|;
name|int
name|cdstatus
decl_stmt|;
name|cardbustag_t
name|tag
decl_stmt|;
name|cardbusreg_t
name|id
decl_stmt|,
name|class
decl_stmt|,
name|cis_ptr
decl_stmt|,
name|bhlcr
decl_stmt|;
name|u_int8_t
name|tuple
index|[
literal|2048
index|]
decl_stmt|;
name|int
name|function
decl_stmt|,
name|max_func
decl_stmt|,
name|device
decl_stmt|;
name|cc
operator|=
name|sc
operator|->
name|sc_cc
expr_stmt|;
name|cf
operator|=
name|sc
operator|->
name|sc_cf
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"cardbus_attach_card: cb%d start\n"
operator|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_unit
operator|)
argument_list|)
expr_stmt|;
comment|/* inspect initial voltage */
if|if
condition|(
literal|0
operator|==
operator|(
name|cdstatus
operator|=
call|(
name|cf
operator|->
name|cardbus_ctrl
call|)
argument_list|(
name|cc
argument_list|,
name|CARDBUS_CD
argument_list|)
operator|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"cardbusattach: no CardBus card on cb%d\n"
operator|,
name|sc
operator|->
name|sc_dev
operator|.
name|dv_unit
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|cdstatus
operator|&
name|CARDBUS_3V_CARD
condition|)
block|{
name|cf
operator|->
name|cardbus_power
argument_list|(
name|cc
argument_list|,
name|CARDBUS_VCC_3V
argument_list|)
expr_stmt|;
block|}
call|(
name|cf
operator|->
name|cardbus_ctrl
call|)
argument_list|(
name|cc
argument_list|,
name|CARDBUS_RESET
argument_list|)
expr_stmt|;
name|device
operator|=
literal|0
expr_stmt|;
comment|/* Only one card can attach cardbus slot */
name|function
operator|=
literal|0
expr_stmt|;
name|tag
operator|=
name|cardbus_make_tag
argument_list|(
name|cc
argument_list|,
name|cf
argument_list|,
name|sc
operator|->
name|sc_bus
argument_list|,
name|device
argument_list|,
name|function
argument_list|)
expr_stmt|;
name|bhlcr
operator|=
call|(
name|cf
operator|->
name|cardbus_conf_read
call|)
argument_list|(
name|cc
argument_list|,
name|tag
argument_list|,
name|CARDBUS_BHLC_REG
argument_list|)
expr_stmt|;
name|max_func
operator|=
name|CARDBUS_HDRTYPE_MULTIFN
argument_list|(
name|bhlcr
argument_list|)
condition|?
literal|8
else|:
literal|1
expr_stmt|;
for|for
control|(
name|function
operator|=
literal|0
init|;
name|function
operator|<
name|max_func
condition|;
name|function
operator|++
control|)
block|{
if|if
condition|(
name|function
condition|)
name|tag
operator|=
name|cardbus_make_tag
argument_list|(
name|cc
argument_list|,
name|cf
argument_list|,
name|sc
operator|->
name|sc_bus
argument_list|,
name|device
argument_list|,
name|function
argument_list|)
expr_stmt|;
name|id
operator|=
call|(
name|cf
operator|->
name|cardbus_conf_read
call|)
argument_list|(
name|cc
argument_list|,
name|tag
argument_list|,
name|CARDBUS_ID_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|CARDBUS_VENDOR
argument_list|(
name|id
argument_list|)
operator|==
literal|0xffff
operator|||
name|CARDBUS_VENDOR
argument_list|(
name|id
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cardbus_free_tag
argument_list|(
name|cc
argument_list|,
name|cf
argument_list|,
name|tag
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|class
operator|=
call|(
name|cf
operator|->
name|cardbus_conf_read
call|)
argument_list|(
name|cc
argument_list|,
name|tag
argument_list|,
name|CARDBUS_CLASS_REG
argument_list|)
expr_stmt|;
name|cis_ptr
operator|=
call|(
name|cf
operator|->
name|cardbus_conf_read
call|)
argument_list|(
name|cc
argument_list|,
name|tag
argument_list|,
name|CARDBUS_CIS_REG
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"cardbus_attach_card: Vendor 0x%x, Product 0x%x, CIS 0x%x\n"
operator|,
name|CARDBUS_VENDOR
argument_list|(
name|id
argument_list|)
operator|,
name|CARDBUS_PRODUCT
argument_list|(
name|id
argument_list|)
operator|,
name|cis_ptr
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|tuple
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
operator|==
operator|(
name|cis_ptr
operator|&
name|CARDBUS_CIS_ASIMASK
operator|)
condition|)
block|{
name|int
name|i
init|=
name|cis_ptr
operator|&
name|CARDBUS_CIS_ADDRMASK
decl_stmt|;
name|int
name|j
init|=
literal|0
decl_stmt|;
for|for
control|(
init|;
name|i
operator|<
literal|0xff
condition|;
name|i
operator|+=
literal|4
control|)
block|{
name|u_int32_t
name|e
init|=
call|(
name|cf
operator|->
name|cardbus_conf_read
call|)
argument_list|(
name|cc
argument_list|,
name|tag
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|tuple
index|[
name|j
index|]
operator|=
literal|0xff
operator|&
name|e
expr_stmt|;
name|e
operator|>>=
literal|8
expr_stmt|;
name|tuple
index|[
name|j
operator|+
literal|1
index|]
operator|=
literal|0xff
operator|&
name|e
expr_stmt|;
name|e
operator|>>=
literal|8
expr_stmt|;
name|tuple
index|[
name|j
operator|+
literal|2
index|]
operator|=
literal|0xff
operator|&
name|e
expr_stmt|;
name|e
operator|>>=
literal|8
expr_stmt|;
name|tuple
index|[
name|j
operator|+
literal|3
index|]
operator|=
literal|0xff
operator|&
name|e
expr_stmt|;
name|j
operator|+=
literal|4
expr_stmt|;
block|}
block|}
name|decode_tuples
argument_list|(
name|tuple
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
if|if
condition|(
name|function
operator|==
literal|0
condition|)
block|{
name|struct
name|cardbus_attach_args
name|ca
decl_stmt|;
name|cardbusreg_t
name|intr
init|=
name|cardbus_conf_read
argument_list|(
name|cc
argument_list|,
name|cf
argument_list|,
name|tag
argument_list|,
name|CARDBUS_INTERRUPT_REG
argument_list|)
decl_stmt|;
name|ca
operator|.
name|ca_unit
operator|=
name|sc
operator|->
name|sc_dev
operator|.
name|dv_unit
expr_stmt|;
name|ca
operator|.
name|ca_cc
operator|=
name|sc
operator|->
name|sc_cc
expr_stmt|;
name|ca
operator|.
name|ca_cf
operator|=
name|sc
operator|->
name|sc_cf
expr_stmt|;
name|ca
operator|.
name|ca_iot
operator|=
name|sc
operator|->
name|sc_iot
expr_stmt|;
name|ca
operator|.
name|ca_memt
operator|=
name|sc
operator|->
name|sc_memt
expr_stmt|;
name|ca
operator|.
name|ca_dmat
operator|=
name|sc
operator|->
name|sc_dmat
expr_stmt|;
name|ca
operator|.
name|ca_tag
operator|=
name|tag
expr_stmt|;
name|ca
operator|.
name|ca_device
operator|=
name|device
expr_stmt|;
name|ca
operator|.
name|ca_function
operator|=
name|function
expr_stmt|;
name|ca
operator|.
name|ca_id
operator|=
name|id
expr_stmt|;
name|ca
operator|.
name|ca_class
operator|=
name|class
expr_stmt|;
name|ca
operator|.
name|ca_intrline
operator|=
name|sc
operator|->
name|sc_intrline
expr_stmt|;
name|attached_device
operator|=
name|config_found_sm
argument_list|(
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
operator|&
name|ca
argument_list|,
name|cardbusprint
argument_list|,
name|cardbussubmatch
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"cardbus_attach_card: XXX Multi-function can't handle. function 0 only.\n"
argument_list|)
expr_stmt|;
block|}
name|cardbus_free_tag
argument_list|(
name|cc
argument_list|,
name|cf
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|attached_device
condition|)
name|cf
operator|->
name|cardbus_power
argument_list|(
name|cc
argument_list|,
name|CARDBUS_VCC_0V
argument_list|)
expr_stmt|;
return|return
name|attached_device
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cardbussubmatch
parameter_list|(
name|parent
parameter_list|,
name|cf
parameter_list|,
name|aux
parameter_list|)
name|struct
name|device
modifier|*
name|parent
decl_stmt|;
name|struct
name|cfdata
modifier|*
name|cf
decl_stmt|;
name|void
modifier|*
name|aux
decl_stmt|;
block|{
name|struct
name|cardbus_attach_args
modifier|*
name|ca
init|=
name|aux
decl_stmt|;
if|if
condition|(
name|cf
operator|->
name|cardbuscf_dev
operator|!=
name|CARDBUS_UNK_DEV
operator|&&
name|cf
operator|->
name|cardbuscf_dev
operator|!=
name|ca
operator|->
name|ca_unit
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|cf
operator|->
name|cardbuscf_function
operator|!=
name|CARDBUS_UNK_FUNCTION
operator|&&
name|cf
operator|->
name|cardbuscf_function
operator|!=
name|ca
operator|->
name|ca_function
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
operator|(
call|(
modifier|*
name|cf
operator|->
name|cf_attach
operator|->
name|ca_match
call|)
argument_list|(
name|parent
argument_list|,
name|cf
argument_list|,
name|aux
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cardbusprint
parameter_list|(
name|aux
parameter_list|,
name|pnp
parameter_list|)
name|void
modifier|*
name|aux
decl_stmt|;
specifier|const
name|char
modifier|*
name|pnp
decl_stmt|;
block|{
specifier|register
name|struct
name|cardbus_attach_args
modifier|*
name|ca
init|=
name|aux
decl_stmt|;
name|char
name|devinfo
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|pnp
condition|)
block|{
name|printf
argument_list|(
literal|"vendor 0x%04x id 0x%04x at %s"
argument_list|,
name|CARDBUS_VENDOR
argument_list|(
name|ca
operator|->
name|ca_id
argument_list|)
argument_list|,
name|CARDBUS_PRODUCT
argument_list|(
name|ca
operator|->
name|ca_id
argument_list|)
argument_list|,
name|pnp
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" dev %d function %d"
argument_list|,
name|ca
operator|->
name|ca_device
argument_list|,
name|ca
operator|->
name|ca_function
argument_list|)
expr_stmt|;
return|return
name|UNCONF
return|;
block|}
end_function

begin_comment
comment|/********************************************************************** * void *cardbus_intr_establish(cc, cf, irq, level, func, arg) *   Interrupt handler of pccard. *  args: *   cardbus_chipset_tag_t *cc *   int irq:  **********************************************************************/
end_comment

begin_function_decl
name|void
modifier|*
name|cardbus_intr_establish
parameter_list|(
name|cc
parameter_list|,
name|cf
parameter_list|,
name|irq
parameter_list|,
name|level
parameter_list|,
name|func
parameter_list|,
name|arg
parameter_list|)
name|cardbus_chipset_tag_t
name|cc
decl_stmt|;
name|cardbus_function_tag_t
name|cf
decl_stmt|;
name|cardbus_intr_handle_t
name|irq
decl_stmt|;
name|int
name|level
decl_stmt|;
function_decl|int
parameter_list|(
function_decl|*func
end_function_decl

begin_expr_stmt
unit|)
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|void
modifier|*
name|arg
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"- cardbus_intr_establish: irq %d\n"
operator|,
name|irq
operator|)
argument_list|)
expr_stmt|;
return|return
call|(
modifier|*
name|cf
operator|->
name|cardbus_intr_establish
call|)
argument_list|(
name|cc
argument_list|,
name|irq
argument_list|,
name|level
argument_list|,
name|func
argument_list|,
name|arg
argument_list|)
return|;
block|}
end_block

begin_comment
comment|/********************************************************************** * void cardbus_intr_disestablish(cc, cf, handler) *   Interrupt handler of pccard. *  args: *   cardbus_chipset_tag_t *cc **********************************************************************/
end_comment

begin_function
name|void
name|cardbus_intr_disestablish
parameter_list|(
name|cc
parameter_list|,
name|cf
parameter_list|,
name|handler
parameter_list|)
name|cardbus_chipset_tag_t
name|cc
decl_stmt|;
name|cardbus_function_tag_t
name|cf
decl_stmt|;
name|void
modifier|*
name|handler
decl_stmt|;
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"- cardbus_intr_disestablish\n"
operator|)
argument_list|)
expr_stmt|;
call|(
modifier|*
name|cf
operator|->
name|cardbus_intr_disestablish
call|)
argument_list|(
name|cc
argument_list|,
name|handler
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/********************************************************************** * below this line, there are some functions for decoding tuples. * They should go out from this file. **********************************************************************/
end_comment

begin_function
specifier|static
name|int
name|decode_tuples
parameter_list|(
name|tuple
parameter_list|,
name|buflen
parameter_list|)
name|u_int8_t
modifier|*
name|tuple
decl_stmt|;
name|int
name|buflen
decl_stmt|;
block|{
name|u_int8_t
modifier|*
name|tp
init|=
name|tuple
decl_stmt|;
if|if
condition|(
name|CISTPL_LINKTARGET
operator|!=
operator|*
name|tuple
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"WRONG TUPLE\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
name|NULL
operator|!=
operator|(
name|tp
operator|=
name|decode_tuple
argument_list|(
name|tp
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|tuple
operator|+
name|buflen
operator|<
name|tp
condition|)
block|{
break|break;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|u_int8_t
modifier|*
name|decode_tuple
parameter_list|(
name|tuple
parameter_list|)
name|u_int8_t
modifier|*
name|tuple
decl_stmt|;
block|{
name|u_int8_t
name|type
decl_stmt|;
name|u_int8_t
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
name|type
operator|=
name|tuple
index|[
literal|0
index|]
expr_stmt|;
name|len
operator|=
name|tuple
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|"tuple: %s len %d\n"
argument_list|,
name|tuple_name
argument_list|(
name|type
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|CISTPL_END
operator|==
name|type
condition|)
block|{
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|16
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"  0x%2x:"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %x"
argument_list|,
name|tuple
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|%
literal|16
operator|==
literal|15
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|%
literal|16
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
name|tuple
operator|+
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|tuple_name
parameter_list|(
name|type
parameter_list|)
name|int
name|type
decl_stmt|;
block|{
specifier|static
name|char
modifier|*
name|tuple_name_s
index|[]
init|=
block|{
literal|"TPL_NULL"
block|,
literal|"TPL_DEVICE"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 0-3 */
literal|"CONFIG_CB"
block|,
literal|"CFTABLE_ENTRY_CB"
block|,
literal|"Reserved"
block|,
literal|"BAR"
block|,
comment|/* 4-7 */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 8-B */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* C-F */
literal|"CHECKSUM"
block|,
literal|"LONGLINK_A"
block|,
literal|"LONGLINK_C"
block|,
literal|"LINKTARGET"
block|,
comment|/* 10-13 */
literal|"NO_LINK"
block|,
literal|"VERS_1"
block|,
literal|"ALTSTR"
block|,
literal|"DEVICE_A"
block|,
literal|"JEDEC_C"
block|,
literal|"JEDEC_A"
block|,
literal|"CONFIG"
block|,
literal|"CFTABLE_ENTRY"
block|,
literal|"DEVICE_OC"
block|,
literal|"DEVICE_OA"
block|,
literal|"DEVICE_GEO"
block|,
literal|"DEVICE_GEO_A"
block|,
literal|"MANFID"
block|,
literal|"FUNCID"
block|,
literal|"FUNCE"
block|,
literal|"SWIL"
block|,
comment|/* 20-23 */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 24-27 */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 28-2B */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 2C-2F */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 30-33 */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 34-37 */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 38-3B */
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
literal|"Reserved"
block|,
comment|/* 3C-3F */
literal|"VERS_2"
block|,
literal|"FORMAT"
block|,
literal|"GEOMETRY"
block|,
literal|"BYTEORDER"
block|,
literal|"DATE"
block|,
literal|"BATTERY"
block|,
literal|"ORG"
block|}
decl_stmt|;
define|#
directive|define
name|NAME_LEN
parameter_list|(
name|x
parameter_list|)
value|(sizeof x / sizeof(x[0]))
if|if
condition|(
name|type
operator|>
literal|0
operator|&&
name|type
operator|<
name|NAME_LEN
argument_list|(
name|tuple_name_s
argument_list|)
condition|)
block|{
return|return
name|tuple_name_s
index|[
name|type
index|]
return|;
block|}
elseif|else
if|if
condition|(
literal|0xff
operator|==
name|type
condition|)
block|{
return|return
literal|"END"
return|;
block|}
else|else
block|{
return|return
literal|"Reserved"
return|;
block|}
block|}
end_function

end_unit


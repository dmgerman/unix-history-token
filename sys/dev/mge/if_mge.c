begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2008 MARVELL INTERNATIONAL LTD.  * All rights reserved.  *  * Developed by Semihalf.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of MARVELL nor the names of contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_KERNEL_OPTION_HEADERS
end_ifdef

begin_include
include|#
directive|include
file|"opt_device_polling.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/mge/if_mgevar.h>
end_include

begin_include
include|#
directive|include
file|<arm/mv/mvreg.h>
end_include

begin_include
include|#
directive|include
file|<arm/mv/mvvar.h>
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_comment
comment|/* PHY registers are in the address space of the first mge unit */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|mge_softc
modifier|*
name|sc_mge0
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|mge_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_init_locked
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_watchdog
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|mge_tfut_ipg
parameter_list|(
name|uint32_t
name|val
parameter_list|,
name|int
name|ver
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|mge_rx_ipg
parameter_list|(
name|uint32_t
name|val
parameter_list|,
name|int
name|ver
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_ver_params
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_intrs_ctrl
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|int
name|enable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_intr_rx
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_intr_rx_locked
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|int
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_intr_tx
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_intr_tx_locked
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_intr_misc
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_intr_sum
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_intr_err
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_stop
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_tick
parameter_list|(
name|void
modifier|*
name|msc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|mge_set_port_serial_control
parameter_list|(
name|uint32_t
name|media
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_get_mac_address
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_set_mac_address
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_set_ucast_address
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|last_byte
parameter_list|,
name|uint8_t
name|queue
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_set_prom_mode
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|queue
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_allocate_dma
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_alloc_desc_dma
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mge_desc_wrapper
modifier|*
name|desc_tab
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|bus_dma_tag_t
modifier|*
name|buffer_tag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_new_rxbuf
parameter_list|(
name|bus_dma_tag_t
name|tag
parameter_list|,
name|bus_dmamap_t
name|map
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mbufp
parameter_list|,
name|bus_addr_t
modifier|*
name|paddr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_get_dma_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_free_dma
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_free_desc
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mge_desc_wrapper
modifier|*
name|tab
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|bus_dma_tag_t
name|buffer_tag
parameter_list|,
name|uint8_t
name|free_mbufs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_offload_process_frame
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|frame
parameter_list|,
name|uint32_t
name|status
parameter_list|,
name|uint16_t
name|bufsize
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_offload_setup_descriptor
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|mge_crc8
parameter_list|(
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_setup_multicast
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_set_rxic
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_set_txic
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mge_add_sysctls
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mge_sysctl_ic
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|mge_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|mge_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|mge_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|mge_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|mge_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|mge_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|mge_resume
argument_list|)
block|,
comment|/* MII interface */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|mge_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|mge_miibus_writereg
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|mge_driver
init|=
block|{
literal|"mge"
block|,
name|mge_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|mge_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|mge_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|mge
argument_list|,
name|simplebus
argument_list|,
name|mge_driver
argument_list|,
name|mge_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|mge
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mge
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mge
argument_list|,
name|miibus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|res_spec
index|[]
init|=
block|{
block|{
name|SYS_RES_MEMORY
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|0
block|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|1
block|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|2
block|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|3
block|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|4
block|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|driver_intr_t
modifier|*
name|handler
decl_stmt|;
name|char
modifier|*
name|description
decl_stmt|;
block|}
name|mge_intrs
index|[
name|MGE_INTR_COUNT
index|]
init|=
block|{
block|{
name|mge_intr_rx
block|,
literal|"GbE receive interrupt"
block|}
block|,
block|{
name|mge_intr_tx
block|,
literal|"GbE transmit interrupt"
block|}
block|,
block|{
name|mge_intr_misc
block|,
literal|"GbE misc interrupt"
block|}
block|,
block|{
name|mge_intr_sum
block|,
literal|"GbE summary interrupt"
block|}
block|,
block|{
name|mge_intr_err
block|,
literal|"GbE error interrupt"
block|}
block|, }
struct|;
end_struct

begin_function
specifier|static
name|void
name|mge_get_mac_address
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|uint32_t
name|mac_l
decl_stmt|,
name|mac_h
decl_stmt|;
name|uint8_t
name|lmac
index|[
literal|6
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|valid
decl_stmt|;
comment|/* 	 * Retrieve hw address from the device tree. 	 */
name|i
operator|=
name|OF_getprop
argument_list|(
name|sc
operator|->
name|node
argument_list|,
literal|"local-mac-address"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|lmac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|6
condition|)
block|{
name|valid
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|lmac
index|[
name|i
index|]
operator|!=
literal|0
condition|)
block|{
name|valid
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|valid
condition|)
block|{
name|bcopy
argument_list|(
name|lmac
argument_list|,
name|addr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* 	 * Fall back -- use the currently programmed address. 	 */
name|mac_l
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_MAC_ADDR_L
argument_list|)
expr_stmt|;
name|mac_h
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_MAC_ADDR_H
argument_list|)
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|mac_h
operator|&
literal|0xff000000
operator|)
operator|>>
literal|24
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
operator|(
name|mac_h
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
operator|(
name|mac_h
operator|&
literal|0x0000ff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
operator|(
name|mac_h
operator|&
literal|0x000000ff
operator|)
expr_stmt|;
name|addr
index|[
literal|4
index|]
operator|=
operator|(
name|mac_l
operator|&
literal|0x0000ff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|addr
index|[
literal|5
index|]
operator|=
operator|(
name|mac_l
operator|&
literal|0x000000ff
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mge_tfut_ipg
parameter_list|(
name|uint32_t
name|val
parameter_list|,
name|int
name|ver
parameter_list|)
block|{
switch|switch
condition|(
name|ver
condition|)
block|{
case|case
literal|1
case|:
return|return
operator|(
operator|(
name|val
operator|&
literal|0x3fff
operator|)
operator|<<
literal|4
operator|)
return|;
case|case
literal|2
case|:
default|default:
return|return
operator|(
operator|(
name|val
operator|&
literal|0xffff
operator|)
operator|<<
literal|4
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mge_rx_ipg
parameter_list|(
name|uint32_t
name|val
parameter_list|,
name|int
name|ver
parameter_list|)
block|{
switch|switch
condition|(
name|ver
condition|)
block|{
case|case
literal|1
case|:
return|return
operator|(
operator|(
name|val
operator|&
literal|0x3fff
operator|)
operator|<<
literal|8
operator|)
return|;
case|case
literal|2
case|:
default|default:
return|return
operator|(
operator|(
operator|(
name|val
operator|&
literal|0x8000
operator|)
operator|<<
literal|10
operator|)
operator||
operator|(
operator|(
name|val
operator|&
literal|0x7fff
operator|)
operator|<<
literal|7
operator|)
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_ver_params
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|d
decl_stmt|,
name|r
decl_stmt|;
name|soc_id
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|MV_DEV_88F6281
operator|||
name|d
operator|==
name|MV_DEV_MV78100
operator|||
name|d
operator|==
name|MV_DEV_MV78100_Z0
condition|)
block|{
name|sc
operator|->
name|mge_ver
operator|=
literal|2
expr_stmt|;
name|sc
operator|->
name|mge_mtu
operator|=
literal|0x4e8
expr_stmt|;
name|sc
operator|->
name|mge_tfut_ipg_max
operator|=
literal|0xFFFF
expr_stmt|;
name|sc
operator|->
name|mge_rx_ipg_max
operator|=
literal|0xFFFF
expr_stmt|;
name|sc
operator|->
name|mge_tx_arb_cfg
operator|=
literal|0xFC0000FF
expr_stmt|;
name|sc
operator|->
name|mge_tx_tok_cfg
operator|=
literal|0xFFFF7FFF
expr_stmt|;
name|sc
operator|->
name|mge_tx_tok_cnt
operator|=
literal|0x3FFFFFFF
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|mge_ver
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|mge_mtu
operator|=
literal|0x458
expr_stmt|;
name|sc
operator|->
name|mge_tfut_ipg_max
operator|=
literal|0x3FFF
expr_stmt|;
name|sc
operator|->
name|mge_rx_ipg_max
operator|=
literal|0x3FFF
expr_stmt|;
name|sc
operator|->
name|mge_tx_arb_cfg
operator|=
literal|0x000000FF
expr_stmt|;
name|sc
operator|->
name|mge_tx_tok_cfg
operator|=
literal|0x3FFFFFFF
expr_stmt|;
name|sc
operator|->
name|mge_tx_tok_cnt
operator|=
literal|0x3FFFFFFF
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_set_mac_address
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|char
modifier|*
name|if_mac
decl_stmt|;
name|uint32_t
name|mac_l
decl_stmt|,
name|mac_h
decl_stmt|;
name|MGE_GLOBAL_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|if_mac
operator|=
operator|(
name|char
operator|*
operator|)
name|IF_LLADDR
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|mac_l
operator|=
operator|(
name|if_mac
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|if_mac
index|[
literal|5
index|]
operator|)
expr_stmt|;
name|mac_h
operator|=
operator|(
name|if_mac
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|if_mac
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|if_mac
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|if_mac
index|[
literal|3
index|]
operator|<<
literal|0
operator|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_MAC_ADDR_L
argument_list|,
name|mac_l
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_MAC_ADDR_H
argument_list|,
name|mac_h
argument_list|)
expr_stmt|;
name|mge_set_ucast_address
argument_list|(
name|sc
argument_list|,
name|if_mac
index|[
literal|5
index|]
argument_list|,
name|MGE_RX_DEFAULT_QUEUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_set_ucast_address
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|last_byte
parameter_list|,
name|uint8_t
name|queue
parameter_list|)
block|{
name|uint32_t
name|reg_idx
decl_stmt|,
name|reg_off
decl_stmt|,
name|reg_val
decl_stmt|,
name|i
decl_stmt|;
name|last_byte
operator|&=
literal|0xf
expr_stmt|;
name|reg_idx
operator|=
name|last_byte
operator|/
name|MGE_UCAST_REG_NUMBER
expr_stmt|;
name|reg_off
operator|=
operator|(
name|last_byte
operator|%
name|MGE_UCAST_REG_NUMBER
operator|)
operator|*
literal|8
expr_stmt|;
name|reg_val
operator|=
operator|(
literal|1
operator||
operator|(
name|queue
operator|<<
literal|1
operator|)
operator|)
operator|<<
name|reg_off
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_UCAST_REG_NUMBER
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|reg_idx
condition|)
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_UCAST
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
else|else
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_UCAST
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_set_prom_mode
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|queue
parameter_list|)
block|{
name|uint32_t
name|port_config
decl_stmt|;
name|uint32_t
name|reg_val
decl_stmt|,
name|i
decl_stmt|;
comment|/* Enable or disable promiscuous mode as needed */
if|if
condition|(
name|sc
operator|->
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
block|{
name|port_config
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_CONFIG
argument_list|)
expr_stmt|;
name|port_config
operator||=
name|PORT_CONFIG_UPM
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_CONFIG
argument_list|,
name|port_config
argument_list|)
expr_stmt|;
name|reg_val
operator|=
operator|(
operator|(
literal|1
operator||
operator|(
name|queue
operator|<<
literal|1
operator|)
operator|)
operator||
operator|(
literal|1
operator||
operator|(
name|queue
operator|<<
literal|1
operator|)
operator|)
operator|<<
literal|8
operator||
operator|(
literal|1
operator||
operator|(
name|queue
operator|<<
literal|1
operator|)
operator|)
operator|<<
literal|16
operator||
operator|(
literal|1
operator||
operator|(
name|queue
operator|<<
literal|1
operator|)
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_MCAST_REG_NUMBER
condition|;
name|i
operator|++
control|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_SPEC_MCAST
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_OTH_MCAST
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_UCAST_REG_NUMBER
condition|;
name|i
operator|++
control|)
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_UCAST
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|port_config
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_CONFIG
argument_list|)
expr_stmt|;
name|port_config
operator|&=
operator|~
name|PORT_CONFIG_UPM
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_CONFIG
argument_list|,
name|port_config
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_MCAST_REG_NUMBER
condition|;
name|i
operator|++
control|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_SPEC_MCAST
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_OTH_MCAST
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|mge_set_mac_address
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_get_dma_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|paddr
decl_stmt|;
name|KASSERT
argument_list|(
name|nseg
operator|==
literal|1
argument_list|,
operator|(
literal|"wrong number of segments, should be 1"
operator|)
argument_list|)
expr_stmt|;
name|paddr
operator|=
name|arg
expr_stmt|;
operator|*
name|paddr
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_new_rxbuf
parameter_list|(
name|bus_dma_tag_t
name|tag
parameter_list|,
name|bus_dmamap_t
name|map
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mbufp
parameter_list|,
name|bus_addr_t
modifier|*
name|paddr
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|new_mbuf
decl_stmt|;
name|bus_dma_segment_t
name|seg
index|[
literal|1
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|KASSERT
argument_list|(
name|mbufp
operator|!=
name|NULL
argument_list|,
operator|(
literal|"NULL mbuf pointer!"
operator|)
argument_list|)
expr_stmt|;
name|new_mbuf
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_mbuf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|new_mbuf
operator|->
name|m_len
operator|=
name|new_mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|new_mbuf
operator|->
name|m_ext
operator|.
name|ext_size
expr_stmt|;
if|if
condition|(
operator|*
name|mbufp
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|tag
argument_list|,
name|map
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|tag
argument_list|,
name|map
argument_list|,
name|new_mbuf
argument_list|,
name|seg
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"Too many segments returned!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsegs
operator|!=
literal|1
operator|||
name|error
condition|)
name|panic
argument_list|(
literal|"mge_new_rxbuf(): nsegs(%d), error(%d)"
argument_list|,
name|nsegs
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
operator|(
operator|*
name|mbufp
operator|)
operator|=
name|new_mbuf
expr_stmt|;
operator|(
operator|*
name|paddr
operator|)
operator|=
name|seg
operator|->
name|ds_addr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_alloc_desc_dma
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mge_desc_wrapper
modifier|*
name|tab
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|bus_dma_tag_t
modifier|*
name|buffer_tag
parameter_list|)
block|{
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
name|bus_addr_t
name|desc_paddr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|desc_paddr
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|size
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|dw
operator|=
operator|&
operator|(
name|tab
index|[
name|i
index|]
operator|)
expr_stmt|;
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
operator|(
name|dw
operator|->
name|mge_desc
operator|)
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_COHERENT
argument_list|,
operator|&
operator|(
name|dw
operator|->
name|desc_dmap
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"failed to allocate DMA memory\n"
argument_list|)
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|dw
operator|->
name|mge_desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mge_desc
argument_list|)
argument_list|,
name|mge_get_dma_addr
argument_list|,
operator|&
operator|(
name|dw
operator|->
name|mge_desc_paddr
operator|)
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"can't load descriptor\n"
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|mge_desc
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|)
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Chain descriptors */
name|dw
operator|->
name|mge_desc
operator|->
name|next_desc
operator|=
name|desc_paddr
expr_stmt|;
name|desc_paddr
operator|=
name|dw
operator|->
name|mge_desc_paddr
expr_stmt|;
block|}
name|tab
index|[
name|size
operator|-
literal|1
index|]
operator|.
name|mge_desc
operator|->
name|next_desc
operator|=
name|desc_paddr
expr_stmt|;
comment|/* Allocate a busdma tag for mbufs. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|8
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filtfunc, filtfuncarg */
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsz, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
name|buffer_tag
argument_list|)
expr_stmt|;
comment|/* dmat */
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"failed to create busdma tag for mbufs\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Create TX busdma maps */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
name|dw
operator|=
operator|&
operator|(
name|tab
index|[
name|i
index|]
operator|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
operator|*
name|buffer_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|dw
operator|->
name|buffer_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"failed to create map for mbuf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|dw
operator|->
name|buffer
operator|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
name|NULL
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|->
name|buffer
operator|=
operator|(
name|bus_addr_t
operator|)
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_allocate_dma
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Allocate a busdma tag and DMA safe memory for TX/RX descriptors. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|16
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filtfunc, filtfuncarg */
sizeof|sizeof
argument_list|(
expr|struct
name|mge_desc
argument_list|)
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
sizeof|sizeof
argument_list|(
expr|struct
name|mge_desc
argument_list|)
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsz, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
operator|&
name|sc
operator|->
name|mge_desc_dtag
argument_list|)
expr_stmt|;
comment|/* dmat */
name|mge_alloc_desc_dma
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|mge_tx_desc
argument_list|,
name|MGE_TX_DESC_NUM
argument_list|,
operator|&
name|sc
operator|->
name|mge_tx_dtag
argument_list|)
expr_stmt|;
name|mge_alloc_desc_dma
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|mge_rx_desc
argument_list|,
name|MGE_RX_DESC_NUM
argument_list|,
operator|&
name|sc
operator|->
name|mge_rx_dtag
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_RX_DESC_NUM
condition|;
name|i
operator|++
control|)
block|{
name|dw
operator|=
operator|&
operator|(
name|sc
operator|->
name|mge_rx_desc
index|[
name|i
index|]
operator|)
expr_stmt|;
name|mge_new_rxbuf
argument_list|(
name|sc
operator|->
name|mge_rx_dtag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|,
operator|&
name|dw
operator|->
name|buffer
argument_list|,
operator|&
name|dw
operator|->
name|mge_desc
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|tx_desc_start
operator|=
name|sc
operator|->
name|mge_tx_desc
index|[
literal|0
index|]
operator|.
name|mge_desc_paddr
expr_stmt|;
name|sc
operator|->
name|rx_desc_start
operator|=
name|sc
operator|->
name|mge_rx_desc
index|[
literal|0
index|]
operator|.
name|mge_desc_paddr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_free_desc
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mge_desc_wrapper
modifier|*
name|tab
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|bus_dma_tag_t
name|buffer_tag
parameter_list|,
name|uint8_t
name|free_mbufs
parameter_list|)
block|{
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
comment|/* Free RX mbuf */
name|dw
operator|=
operator|&
operator|(
name|tab
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|buffer_dmap
condition|)
block|{
if|if
condition|(
name|free_mbufs
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|buffer_tag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|buffer_tag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_destroy
argument_list|(
name|buffer_tag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_mbufs
condition|)
name|m_freem
argument_list|(
name|dw
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
comment|/* Free RX descriptors */
if|if
condition|(
name|dw
operator|->
name|desc_dmap
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|mge_desc
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_free_dma
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Free desciptors and mbufs */
name|mge_free_desc
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|mge_rx_desc
argument_list|,
name|MGE_RX_DESC_NUM
argument_list|,
name|sc
operator|->
name|mge_rx_dtag
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mge_free_desc
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|mge_tx_desc
argument_list|,
name|MGE_TX_DESC_NUM
argument_list|,
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Destroy mbuf dma tag */
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|mge_rx_dtag
argument_list|)
expr_stmt|;
comment|/* Destroy descriptors tag */
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_reinit_rx
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
name|int
name|i
decl_stmt|;
name|MGE_RECEIVE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_free_desc
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|mge_rx_desc
argument_list|,
name|MGE_RX_DESC_NUM
argument_list|,
name|sc
operator|->
name|mge_rx_dtag
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mge_alloc_desc_dma
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|mge_rx_desc
argument_list|,
name|MGE_RX_DESC_NUM
argument_list|,
operator|&
name|sc
operator|->
name|mge_rx_dtag
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_RX_DESC_NUM
condition|;
name|i
operator|++
control|)
block|{
name|dw
operator|=
operator|&
operator|(
name|sc
operator|->
name|mge_rx_desc
index|[
name|i
index|]
operator|)
expr_stmt|;
name|mge_new_rxbuf
argument_list|(
name|sc
operator|->
name|mge_rx_dtag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|,
operator|&
name|dw
operator|->
name|buffer
argument_list|,
operator|&
name|dw
operator|->
name|mge_desc
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|rx_desc_start
operator|=
name|sc
operator|->
name|mge_rx_desc
index|[
literal|0
index|]
operator|.
name|mge_desc_paddr
expr_stmt|;
name|sc
operator|->
name|rx_desc_curr
operator|=
literal|0
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_RX_CUR_DESC_PTR
argument_list|(
name|MGE_RX_DEFAULT_QUEUE
argument_list|)
argument_list|,
name|sc
operator|->
name|rx_desc_start
argument_list|)
expr_stmt|;
comment|/* Enable RX queue */
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_RX_QUEUE_CMD
argument_list|,
name|MGE_ENABLE_RXQ
argument_list|(
name|MGE_RX_DEFAULT_QUEUE
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEVICE_POLLING
end_ifdef

begin_decl_stmt
specifier|static
name|poll_handler_t
name|mge_poll
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mge_poll
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|enum
name|poll_cmd
name|cmd
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|uint32_t
name|int_cause
decl_stmt|,
name|int_cause_ext
decl_stmt|;
name|int
name|rx_npkts
init|=
literal|0
decl_stmt|;
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rx_npkts
operator|)
return|;
block|}
if|if
condition|(
name|cmd
operator|==
name|POLL_AND_CHECK_STATUS
condition|)
block|{
name|int_cause
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE
argument_list|)
expr_stmt|;
name|int_cause_ext
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE_EXT
argument_list|)
expr_stmt|;
comment|/* Check for resource error */
if|if
condition|(
name|int_cause
operator|&
name|MGE_PORT_INT_RXERRQ0
condition|)
name|mge_reinit_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|int_cause
operator|||
name|int_cause_ext
condition|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE
argument_list|,
operator|~
name|int_cause
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE_EXT
argument_list|,
operator|~
name|int_cause_ext
argument_list|)
expr_stmt|;
block|}
block|}
name|mge_intr_tx_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rx_npkts
operator|=
name|mge_intr_rx_locked
argument_list|(
name|sc
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rx_npkts
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DEVICE_POLLING */
end_comment

begin_function
specifier|static
name|int
name|mge_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_softc
modifier|*
name|miisc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint8_t
name|hwaddr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|phy
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|==
literal|0
condition|)
name|sc_mge0
operator|=
name|sc
expr_stmt|;
comment|/* Set chip version-dependent parameters */
name|mge_ver_params
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Get phy address from fdt */
if|if
condition|(
name|fdt_get_phyaddr
argument_list|(
name|sc
operator|->
name|node
argument_list|,
operator|&
name|phy
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Initialize mutexes */
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|transmit_lock
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"mge TX lock"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|receive_lock
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"mge RX lock"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
comment|/* Allocate IO and IRQ resources */
name|error
operator|=
name|bus_alloc_resources
argument_list|(
name|dev
argument_list|,
name|res_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate resources\n"
argument_list|)
expr_stmt|;
name|mge_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Allocate DMA, buffers, buffer descriptors */
name|error
operator|=
name|mge_allocate_dma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mge_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|tx_desc_curr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rx_desc_curr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_desc_used_idx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_desc_used_count
operator|=
literal|0
expr_stmt|;
comment|/* Configure defaults for interrupts coalescing */
name|sc
operator|->
name|rx_ic_time
operator|=
literal|768
expr_stmt|;
name|sc
operator|->
name|tx_ic_time
operator|=
literal|768
expr_stmt|;
name|mge_add_sysctls
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Allocate network interface */
name|ifp
operator|=
name|sc
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"if_alloc() failed\n"
argument_list|)
expr_stmt|;
name|mge_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
operator||
name|IFF_BROADCAST
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
name|IFCAP_HWCSUM
operator||
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
name|MGE_CHECKSUM_FEATURES
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
comment|/* Advertise that polling is supported */
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_POLLING
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_init
operator|=
name|mge_init
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|mge_start
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|mge_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|MGE_TX_DESC_NUM
operator|-
literal|1
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
argument_list|)
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|mge_get_mac_address
argument_list|(
name|sc
argument_list|,
name|hwaddr
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|hwaddr
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|sc
operator|->
name|wd_callout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Attach PHY(s) */
name|error
operator|=
name|mii_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|miibus
argument_list|,
name|ifp
argument_list|,
name|mge_ifmedia_upd
argument_list|,
name|mge_ifmedia_sts
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|phy
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"attaching PHYs failed\n"
argument_list|)
expr_stmt|;
name|mge_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sc
operator|->
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
argument_list|)
expr_stmt|;
comment|/* Tell the MAC where to find the PHY so autoneg works */
name|miisc
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|mii
operator|->
name|mii_phys
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_REG_PHYDEV
argument_list|,
name|miisc
operator|->
name|mii_phy
argument_list|)
expr_stmt|;
comment|/* Attach interrupt handlers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
operator|++
name|i
control|)
block|{
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|res
index|[
literal|1
operator|+
name|i
index|]
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
operator|*
name|mge_intrs
index|[
name|i
index|]
operator|.
name|handler
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ih_cookie
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not setup %s\n"
argument_list|,
name|mge_intrs
index|[
name|i
index|]
operator|.
name|description
argument_list|)
expr_stmt|;
name|mge_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Stop controller and free TX queue */
if|if
condition|(
name|sc
operator|->
name|ifp
condition|)
name|mge_shutdown
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Wait for stopping ticks */
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|wd_callout
argument_list|)
expr_stmt|;
comment|/* Stop and release all interrupts */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|!
name|sc
operator|->
name|ih_cookie
index|[
name|i
index|]
condition|)
continue|continue;
name|error
operator|=
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|res
index|[
literal|1
operator|+
name|i
index|]
argument_list|,
name|sc
operator|->
name|ih_cookie
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not release %s\n"
argument_list|,
name|mge_intrs
index|[
name|i
index|]
operator|.
name|description
argument_list|)
expr_stmt|;
block|}
comment|/* Detach network interface */
if|if
condition|(
name|sc
operator|->
name|ifp
condition|)
block|{
name|ether_ifdetach
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
block|}
comment|/* Free DMA resources */
name|mge_free_dma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Free IO memory handler */
name|bus_release_resources
argument_list|(
name|dev
argument_list|,
name|res_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
expr_stmt|;
comment|/* Destroy mutexes */
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|receive_lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|transmit_lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|MGE_TRANSMIT_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii
operator|=
name|sc
operator|->
name|mii
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
name|MGE_TRANSMIT_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|mge_set_port_serial_control
parameter_list|(
name|uint32_t
name|media
parameter_list|)
block|{
name|uint32_t
name|port_config
decl_stmt|;
name|port_config
operator|=
name|PORT_SERIAL_RES_BIT9
operator||
name|PORT_SERIAL_FORCE_LINK_FAIL
operator||
name|PORT_SERIAL_MRU
argument_list|(
name|PORT_SERIAL_MRU_1552
argument_list|)
expr_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|media
argument_list|)
operator|==
name|IFM_ETHER
condition|)
block|{
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|media
argument_list|)
condition|)
block|{
case|case
name|IFM_AUTO
case|:
break|break;
case|case
name|IFM_1000_T
case|:
name|port_config
operator||=
operator|(
name|PORT_SERIAL_GMII_SPEED_1000
operator||
name|PORT_SERIAL_AUTONEG
operator||
name|PORT_SERIAL_AUTONEG_FC
operator||
name|PORT_SERIAL_SPEED_AUTONEG
operator|)
expr_stmt|;
break|break;
case|case
name|IFM_100_TX
case|:
name|port_config
operator||=
operator|(
name|PORT_SERIAL_MII_SPEED_100
operator||
name|PORT_SERIAL_AUTONEG
operator||
name|PORT_SERIAL_AUTONEG_FC
operator||
name|PORT_SERIAL_SPEED_AUTONEG
operator|)
expr_stmt|;
break|break;
case|case
name|IFM_10_T
case|:
name|port_config
operator||=
operator|(
name|PORT_SERIAL_AUTONEG
operator||
name|PORT_SERIAL_AUTONEG_FC
operator||
name|PORT_SERIAL_SPEED_AUTONEG
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|media
operator|&
name|IFM_FDX
condition|)
name|port_config
operator||=
name|PORT_SERIAL_FULL_DUPLEX
expr_stmt|;
block|}
return|return
operator|(
name|port_config
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mge_media_status
operator|=
name|sc
operator|->
name|mii
operator|->
name|mii_media
operator|.
name|ifm_media
expr_stmt|;
name|mii_mediachg
argument_list|(
name|sc
operator|->
name|mii
argument_list|)
expr_stmt|;
name|mge_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_init_locked
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_init_locked
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
specifier|volatile
name|uint32_t
name|reg_val
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
decl_stmt|;
name|MGE_GLOBAL_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Stop interface */
name|mge_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Disable interrupts */
name|mge_intrs_ctrl
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set MAC address */
name|mge_set_mac_address
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Setup multicast filters */
name|mge_setup_multicast
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mge_ver
operator|==
literal|2
condition|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_SERIAL_CTRL1
argument_list|,
name|MGE_RGMII_EN
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_FIXED_PRIO_CONF
argument_list|,
name|MGE_FIXED_PRIO_EN
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize TX queue configuration registers */
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_TOKEN_COUNT
argument_list|(
literal|0
argument_list|)
argument_list|,
name|sc
operator|->
name|mge_tx_tok_cnt
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_TOKEN_CONF
argument_list|(
literal|0
argument_list|)
argument_list|,
name|sc
operator|->
name|mge_tx_tok_cfg
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_ARBITER_CONF
argument_list|(
literal|0
argument_list|)
argument_list|,
name|sc
operator|->
name|mge_tx_arb_cfg
argument_list|)
expr_stmt|;
comment|/* Clear TX queue configuration registers for unused queues */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_TOKEN_COUNT
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_TOKEN_CONF
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_ARBITER_CONF
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Set default MTU */
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|mge_mtu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Port configuration */
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_CONFIG
argument_list|,
name|PORT_CONFIG_RXCS
operator||
name|PORT_CONFIG_DFLT_RXQ
argument_list|(
literal|0
argument_list|)
operator||
name|PORT_CONFIG_ARO_RXQ
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_EXT_CONFIG
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Setup port configuration */
name|reg_val
operator|=
name|mge_set_port_serial_control
argument_list|(
name|sc
operator|->
name|mge_media_status
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_SERIAL_CTRL
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
comment|/* Setup SDMA configuration */
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_SDMA_CONFIG
argument_list|,
name|MGE_SDMA_RX_BYTE_SWAP
operator||
name|MGE_SDMA_TX_BYTE_SWAP
operator||
name|MGE_SDMA_RX_BURST_SIZE
argument_list|(
name|MGE_SDMA_BURST_16_WORD
argument_list|)
operator||
name|MGE_SDMA_TX_BURST_SIZE
argument_list|(
name|MGE_SDMA_BURST_16_WORD
argument_list|)
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_FIFO_URGENT_TRSH
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_CUR_DESC_PTR
argument_list|,
name|sc
operator|->
name|tx_desc_start
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_RX_CUR_DESC_PTR
argument_list|(
name|MGE_RX_DEFAULT_QUEUE
argument_list|)
argument_list|,
name|sc
operator|->
name|rx_desc_start
argument_list|)
expr_stmt|;
comment|/* Reset descriptor indexes */
name|sc
operator|->
name|tx_desc_curr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rx_desc_curr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_desc_used_idx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_desc_used_count
operator|=
literal|0
expr_stmt|;
comment|/* Enable RX descriptors */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_RX_DESC_NUM
condition|;
name|i
operator|++
control|)
block|{
name|dw
operator|=
operator|&
name|sc
operator|->
name|mge_rx_desc
index|[
name|i
index|]
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|->
name|cmd_status
operator|=
name|MGE_RX_ENABLE_INT
operator||
name|MGE_DMA_OWNED
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|->
name|buff_size
operator|=
name|MCLBYTES
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
comment|/* Enable RX queue */
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_RX_QUEUE_CMD
argument_list|,
name|MGE_ENABLE_RXQ
argument_list|(
name|MGE_RX_DEFAULT_QUEUE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Enable port */
name|reg_val
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_SERIAL_CTRL
argument_list|)
expr_stmt|;
name|reg_val
operator||=
name|PORT_SERIAL_ENABLE
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_SERIAL_CTRL
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0x100000
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|reg_val
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg_val
operator|&
name|MGE_STATUS_LINKUP
condition|)
break|break;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|count
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"Timeout on link-up\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Setup interrupts coalescing */
name|mge_set_rxic
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_set_txic
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable interrupts */
ifdef|#
directive|ifdef
name|DEVICE_POLLING
comment|/* 	 * * ...only if polling is not turned on. Disable interrupts explicitly 	 * if polling is enabled. 	 */
if|if
condition|(
name|sc
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
name|mge_intrs_ctrl
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
comment|/* DEVICE_POLLING */
name|mge_intrs_ctrl
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Activate network interface */
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|sc
operator|->
name|wd_timer
operator|=
literal|0
expr_stmt|;
comment|/* Schedule watchdog timeout */
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|wd_callout
argument_list|,
name|hz
argument_list|,
name|mge_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_intr_err
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_intr_misc
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_intr_rx
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|uint32_t
name|int_cause
decl_stmt|,
name|int_cause_ext
decl_stmt|;
name|MGE_RECEIVE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|sc
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
block|{
name|MGE_RECEIVE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* Get interrupt cause */
name|int_cause
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE
argument_list|)
expr_stmt|;
name|int_cause_ext
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE_EXT
argument_list|)
expr_stmt|;
comment|/* Check for resource error */
if|if
condition|(
name|int_cause
operator|&
name|MGE_PORT_INT_RXERRQ0
condition|)
block|{
name|mge_reinit_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE
argument_list|,
name|int_cause
operator|&
operator|~
name|MGE_PORT_INT_RXERRQ0
argument_list|)
expr_stmt|;
block|}
name|int_cause
operator|&=
name|MGE_PORT_INT_RXQ0
expr_stmt|;
name|int_cause_ext
operator|&=
name|MGE_PORT_INT_EXT_RXOR
expr_stmt|;
if|if
condition|(
name|int_cause
operator|||
name|int_cause_ext
condition|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE
argument_list|,
operator|~
name|int_cause
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE_EXT
argument_list|,
operator|~
name|int_cause_ext
argument_list|)
expr_stmt|;
name|mge_intr_rx_locked
argument_list|(
name|sc
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|MGE_RECEIVE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_intr_rx_locked
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|uint16_t
name|bufsize
decl_stmt|;
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|int
name|rx_npkts
init|=
literal|0
decl_stmt|;
name|MGE_RECEIVE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|count
operator|!=
literal|0
condition|)
block|{
name|dw
operator|=
operator|&
name|sc
operator|->
name|mge_rx_desc
index|[
name|sc
operator|->
name|rx_desc_curr
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
comment|/* Get status */
name|status
operator|=
name|dw
operator|->
name|mge_desc
operator|->
name|cmd_status
expr_stmt|;
name|bufsize
operator|=
name|dw
operator|->
name|mge_desc
operator|->
name|buff_size
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|MGE_DMA_OWNED
operator|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|dw
operator|->
name|mge_desc
operator|->
name|byte_count
operator|&&
operator|~
operator|(
name|status
operator|&
name|MGE_ERR_SUMMARY
operator|)
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_rx_dtag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|mb
operator|=
name|m_devget
argument_list|(
name|dw
operator|->
name|buffer
operator|->
name|m_data
argument_list|,
name|dw
operator|->
name|mge_desc
operator|->
name|byte_count
operator|-
name|ETHER_CRC_LEN
argument_list|,
literal|0
argument_list|,
name|ifp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
comment|/* Give up if no mbufs */
break|break;
name|mb
operator|->
name|m_len
operator|-=
literal|2
expr_stmt|;
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|-=
literal|2
expr_stmt|;
name|mb
operator|->
name|m_data
operator|+=
literal|2
expr_stmt|;
name|mge_offload_process_frame
argument_list|(
name|ifp
argument_list|,
name|mb
argument_list|,
name|status
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
name|MGE_RECEIVE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|MGE_RECEIVE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rx_npkts
operator|++
expr_stmt|;
block|}
name|dw
operator|->
name|mge_desc
operator|->
name|byte_count
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|->
name|cmd_status
operator|=
name|MGE_RX_ENABLE_INT
operator||
name|MGE_DMA_OWNED
expr_stmt|;
name|sc
operator|->
name|rx_desc_curr
operator|=
operator|(
operator|++
name|sc
operator|->
name|rx_desc_curr
operator|%
name|MGE_RX_DESC_NUM
operator|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
name|count
operator|-=
literal|1
expr_stmt|;
block|}
return|return
operator|(
name|rx_npkts
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_intr_sum
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_intr_tx
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|uint32_t
name|int_cause_ext
decl_stmt|;
name|MGE_TRANSMIT_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|sc
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
block|{
name|MGE_TRANSMIT_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* Ack the interrupt */
name|int_cause_ext
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE_EXT
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE_EXT
argument_list|,
name|int_cause_ext
operator|&
operator|~
name|MGE_PORT_INT_EXT_TXBUF0
argument_list|)
expr_stmt|;
name|mge_intr_tx_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MGE_TRANSMIT_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_intr_tx_locked
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
name|struct
name|mge_desc
modifier|*
name|desc
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|int
name|send
init|=
literal|0
decl_stmt|;
name|MGE_TRANSMIT_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Disable watchdog */
name|sc
operator|->
name|wd_timer
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|tx_desc_used_count
condition|)
block|{
comment|/* Get the descriptor */
name|dw
operator|=
operator|&
name|sc
operator|->
name|mge_tx_desc
index|[
name|sc
operator|->
name|tx_desc_used_idx
index|]
expr_stmt|;
name|desc
operator|=
name|dw
operator|->
name|mge_desc
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
comment|/* Get descriptor status */
name|status
operator|=
name|desc
operator|->
name|cmd_status
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|MGE_DMA_OWNED
condition|)
break|break;
name|sc
operator|->
name|tx_desc_used_idx
operator|=
operator|(
operator|++
name|sc
operator|->
name|tx_desc_used_idx
operator|)
operator|%
name|MGE_TX_DESC_NUM
expr_stmt|;
name|sc
operator|->
name|tx_desc_used_count
operator|--
expr_stmt|;
comment|/* Update collision statistics */
if|if
condition|(
name|status
operator|&
name|MGE_ERR_SUMMARY
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|&
name|MGE_ERR_MASK
operator|)
operator|==
name|MGE_TX_ERROR_LC
condition|)
name|ifp
operator|->
name|if_collisions
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|MGE_ERR_MASK
operator|)
operator|==
name|MGE_TX_ERROR_RL
condition|)
name|ifp
operator|->
name|if_collisions
operator|+=
literal|16
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|dw
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|dw
operator|->
name|buffer
operator|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
name|NULL
expr_stmt|;
name|send
operator|++
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|send
condition|)
block|{
comment|/* Now send anything that was pending */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|mge_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mge_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|mask
decl_stmt|,
name|error
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|flags
operator|=
name|ifp
operator|->
name|if_flags
operator|^
name|sc
operator|->
name|mge_if_flags
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|IFF_PROMISC
condition|)
name|mge_set_prom_mode
argument_list|(
name|sc
argument_list|,
name|MGE_RX_DEFAULT_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|IFF_ALLMULTI
condition|)
name|mge_setup_multicast
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
name|mge_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|mge_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mge_if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_setup_multicast
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFCAP
case|:
name|mask
operator|=
name|ifp
operator|->
name|if_capenable
operator|^
name|ifr
operator|->
name|ifr_reqcap
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_HWCSUM
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator||=
name|IFCAP_HWCSUM
operator|&
name|ifr
operator|->
name|ifr_reqcap
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
condition|)
name|ifp
operator|->
name|if_hwassist
operator|=
name|MGE_CHECKSUM_FEATURES
expr_stmt|;
else|else
name|ifp
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|mask
operator|&
name|IFCAP_POLLING
condition|)
block|{
if|if
condition|(
name|ifr
operator|->
name|ifr_reqcap
operator|&
name|IFCAP_POLLING
condition|)
block|{
name|error
operator|=
name|ether_poll_register
argument_list|(
name|mge_poll
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_intrs_ctrl
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator||=
name|IFCAP_POLLING
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|ether_poll_deregister
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_intrs_ctrl
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_POLLING
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
break|break;
case|case
name|SIOCGIFMEDIA
case|:
comment|/* fall through */
case|case
name|SIOCSIFMEDIA
case|:
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifr
operator|->
name|ifr_media
argument_list|)
operator|==
name|IFM_1000_T
operator|&&
operator|!
operator|(
name|ifr
operator|->
name|ifr_media
operator|&
name|IFM_FDX
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"1000baseTX half-duplex unsupported\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|mii
operator|->
name|mii_media
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|retries
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc_mge0
argument_list|,
name|MGE_REG_SMI
argument_list|,
literal|0x1fffffff
operator|&
operator|(
name|MGE_SMI_READ
operator||
operator|(
name|reg
operator|<<
literal|21
operator|)
operator||
operator|(
name|phy
operator|<<
literal|16
operator|)
operator|)
argument_list|)
expr_stmt|;
name|retries
operator|=
name|MGE_SMI_READ_RETRIES
expr_stmt|;
while|while
condition|(
operator|--
name|retries
operator|&&
operator|!
operator|(
name|MGE_READ
argument_list|(
name|sc_mge0
argument_list|,
name|MGE_REG_SMI
argument_list|)
operator|&
name|MGE_SMI_READVALID
operator|)
condition|)
name|DELAY
argument_list|(
name|MGE_SMI_READ_DELAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|retries
operator|==
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Timeout while reading from PHY\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MGE_READ
argument_list|(
name|sc_mge0
argument_list|,
name|MGE_REG_SMI
argument_list|)
operator|&
literal|0xffff
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|retries
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc_mge0
argument_list|,
name|MGE_REG_SMI
argument_list|,
literal|0x1fffffff
operator|&
operator|(
name|MGE_SMI_WRITE
operator||
operator|(
name|reg
operator|<<
literal|21
operator|)
operator||
operator|(
name|phy
operator|<<
literal|16
operator|)
operator||
operator|(
name|value
operator|&
literal|0xffff
operator|)
operator|)
argument_list|)
expr_stmt|;
name|retries
operator|=
name|MGE_SMI_WRITE_RETRIES
expr_stmt|;
while|while
condition|(
operator|--
name|retries
operator|&&
name|MGE_READ
argument_list|(
name|sc_mge0
argument_list|,
name|MGE_REG_SMI
argument_list|)
operator|&
name|MGE_SMI_BUSY
condition|)
name|DELAY
argument_list|(
name|MGE_SMI_WRITE_DELAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|retries
operator|==
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Timeout while writing to PHY\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"mrvl,ge"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Marvell Gigabit Ethernet controller"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|sc
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
name|ether_poll_deregister
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|mge_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_encap
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m0
parameter_list|)
block|{
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
init|=
name|NULL
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|MGE_TX_DESC_NUM
index|]
decl_stmt|;
name|bus_dmamap_t
name|mapp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|seg
decl_stmt|,
name|nsegs
decl_stmt|;
name|int
name|desc_no
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
comment|/* Check for free descriptors */
if|if
condition|(
name|sc
operator|->
name|tx_desc_used_count
operator|+
literal|1
operator|>=
name|MGE_TX_DESC_NUM
condition|)
block|{
comment|/* No free descriptors */
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Fetch unused map */
name|desc_no
operator|=
name|sc
operator|->
name|tx_desc_curr
expr_stmt|;
name|dw
operator|=
operator|&
name|sc
operator|->
name|mge_tx_desc
index|[
name|desc_no
index|]
expr_stmt|;
name|mapp
operator|=
name|dw
operator|->
name|buffer_dmap
expr_stmt|;
comment|/* Create mapping in DMA memory */
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
name|mapp
argument_list|,
name|m0
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|nsegs
operator|!=
literal|1
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
name|mapp
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|error
operator|!=
literal|0
operator|)
condition|?
name|error
else|:
operator|-
literal|1
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
name|mapp
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Everything is ok, now we can send buffers */
for|for
control|(
name|seg
operator|=
literal|0
init|;
name|seg
operator|<
name|nsegs
condition|;
name|seg
operator|++
control|)
block|{
name|dw
operator|->
name|mge_desc
operator|->
name|byte_count
operator|=
name|segs
index|[
name|seg
index|]
operator|.
name|ds_len
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|->
name|buffer
operator|=
name|segs
index|[
name|seg
index|]
operator|.
name|ds_addr
expr_stmt|;
name|dw
operator|->
name|buffer
operator|=
name|m0
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|->
name|cmd_status
operator|=
name|MGE_TX_LAST
operator||
name|MGE_TX_FIRST
operator||
name|MGE_TX_ETH_CRC
operator||
name|MGE_TX_EN_INT
operator||
name|MGE_TX_PADDING
operator||
name|MGE_DMA_OWNED
expr_stmt|;
if|if
condition|(
name|seg
operator|==
literal|0
condition|)
name|mge_offload_setup_descriptor
argument_list|(
name|sc
argument_list|,
name|dw
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_desc_curr
operator|=
operator|(
operator|++
name|sc
operator|->
name|tx_desc_curr
operator|)
operator|%
name|MGE_TX_DESC_NUM
expr_stmt|;
name|sc
operator|->
name|tx_desc_used_count
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_tick
parameter_list|(
name|void
modifier|*
name|msc
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|msc
decl_stmt|;
comment|/* Check for TX timeout */
name|mge_watchdog
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii_tick
argument_list|(
name|sc
operator|->
name|mii
argument_list|)
expr_stmt|;
comment|/* Check for media type change */
if|if
condition|(
name|sc
operator|->
name|mge_media_status
operator|!=
name|sc
operator|->
name|mii
operator|->
name|mii_media
operator|.
name|ifm_media
condition|)
name|mge_ifmedia_upd
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
comment|/* Schedule another timeout one second from now */
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|wd_callout
argument_list|,
name|hz
argument_list|,
name|mge_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_watchdog
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|wd_timer
operator|==
literal|0
operator|||
operator|--
name|sc
operator|->
name|wd_timer
condition|)
block|{
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"watchdog timeout\n"
argument_list|)
expr_stmt|;
name|mge_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|MGE_TRANSMIT_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mge_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|MGE_TRANSMIT_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|,
modifier|*
name|mtmp
decl_stmt|;
name|uint32_t
name|reg_val
decl_stmt|,
name|queued
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|MGE_TRANSMIT_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
return|return;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* Get packet from the queue */
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
break|break;
name|mtmp
operator|=
name|m_defrag
argument_list|(
name|m0
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtmp
condition|)
name|m0
operator|=
name|mtmp
expr_stmt|;
if|if
condition|(
name|mge_encap
argument_list|(
name|sc
argument_list|,
name|m0
argument_list|)
condition|)
block|{
name|IF_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
name|queued
operator|++
expr_stmt|;
name|BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|queued
condition|)
block|{
comment|/* Enable transmitter and watchdog timer */
name|reg_val
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_TX_QUEUE_CMD
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_QUEUE_CMD
argument_list|,
name|reg_val
operator||
name|MGE_ENABLE_TXQ
argument_list|)
expr_stmt|;
name|sc
operator|->
name|wd_timer
operator|=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_stop
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
specifier|volatile
name|uint32_t
name|reg_val
decl_stmt|,
name|status
decl_stmt|;
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
decl_stmt|;
name|struct
name|mge_desc
modifier|*
name|desc
decl_stmt|;
name|int
name|count
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
comment|/* Stop tick engine */
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|wd_callout
argument_list|)
expr_stmt|;
comment|/* Disable interface */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|sc
operator|->
name|wd_timer
operator|=
literal|0
expr_stmt|;
comment|/* Disable interrupts */
name|mge_intrs_ctrl
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable Rx and Tx */
name|reg_val
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_TX_QUEUE_CMD
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_QUEUE_CMD
argument_list|,
name|reg_val
operator||
name|MGE_DISABLE_TXQ
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_RX_QUEUE_CMD
argument_list|,
name|MGE_DISABLE_RXQ_ALL
argument_list|)
expr_stmt|;
comment|/* Remove pending data from TX queue */
while|while
condition|(
name|sc
operator|->
name|tx_desc_used_idx
operator|!=
name|sc
operator|->
name|tx_desc_curr
operator|&&
name|sc
operator|->
name|tx_desc_used_count
condition|)
block|{
comment|/* Get the descriptor */
name|dw
operator|=
operator|&
name|sc
operator|->
name|mge_tx_desc
index|[
name|sc
operator|->
name|tx_desc_used_idx
index|]
expr_stmt|;
name|desc
operator|=
name|dw
operator|->
name|mge_desc
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_desc_dtag
argument_list|,
name|dw
operator|->
name|desc_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
comment|/* Get descriptor status */
name|status
operator|=
name|desc
operator|->
name|cmd_status
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|MGE_DMA_OWNED
condition|)
break|break;
name|sc
operator|->
name|tx_desc_used_idx
operator|=
operator|(
operator|++
name|sc
operator|->
name|tx_desc_used_idx
operator|)
operator|%
name|MGE_TX_DESC_NUM
expr_stmt|;
name|sc
operator|->
name|tx_desc_used_count
operator|--
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|mge_tx_dtag
argument_list|,
name|dw
operator|->
name|buffer_dmap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|dw
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|dw
operator|->
name|buffer
operator|=
operator|(
expr|struct
name|mbuf
operator|*
operator|)
name|NULL
expr_stmt|;
block|}
comment|/* Wait for end of transmission */
name|count
operator|=
literal|0x100000
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|reg_val
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg_val
operator|&
name|MGE_STATUS_TX_IN_PROG
operator|)
operator|&&
operator|(
name|reg_val
operator|&
name|MGE_STATUS_TX_FIFO_EMPTY
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|count
condition|)
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: timeout while waiting for end of transmission\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|reg_val
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_SERIAL_CTRL
argument_list|)
expr_stmt|;
name|reg_val
operator|&=
operator|~
operator|(
name|PORT_SERIAL_ENABLE
operator|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_SERIAL_CTRL
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_offload_process_frame
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|frame
parameter_list|,
name|uint32_t
name|status
parameter_list|,
name|uint16_t
name|bufsize
parameter_list|)
block|{
name|int
name|csum_flags
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_RXCSUM
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|&
name|MGE_RX_L3_IS_IP
operator|)
operator|&&
operator|(
name|status
operator|&
name|MGE_RX_IP_OK
operator|)
condition|)
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
expr_stmt|;
if|if
condition|(
operator|(
name|bufsize
operator|&
name|MGE_RX_IP_FRAGMENT
operator|)
operator|==
literal|0
operator|&&
operator|(
name|MGE_RX_L4_IS_TCP
argument_list|(
name|status
argument_list|)
operator|||
name|MGE_RX_L4_IS_UDP
argument_list|(
name|status
argument_list|)
operator|)
operator|&&
operator|(
name|status
operator|&
name|MGE_RX_L4_CSUM_OK
operator|)
condition|)
block|{
name|csum_flags
operator||=
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
name|frame
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xFFFF
expr_stmt|;
block|}
name|frame
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|csum_flags
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_offload_setup_descriptor
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mge_desc_wrapper
modifier|*
name|dw
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m0
init|=
name|dw
operator|->
name|buffer
decl_stmt|;
name|struct
name|ether_vlan_header
modifier|*
name|eh
init|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
decl_stmt|;
name|int
name|csum_flags
init|=
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum_flags
decl_stmt|;
name|int
name|cmd_status
init|=
literal|0
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|int
name|ehlen
decl_stmt|,
name|etype
decl_stmt|;
if|if
condition|(
name|csum_flags
condition|)
block|{
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
name|ehlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|csum_flags
operator||=
name|MGE_TX_VLAN_TAGGED
expr_stmt|;
block|}
else|else
block|{
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
name|ehlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
block|}
if|if
condition|(
name|etype
operator|!=
name|ETHERTYPE_IP
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"TCP/IP Offload enabled for unsupported "
literal|"protocol!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|m0
operator|->
name|m_data
operator|+
name|ehlen
operator|)
expr_stmt|;
name|cmd_status
operator||=
name|MGE_TX_IP_HDR_SIZE
argument_list|(
name|ip
operator|->
name|ip_hl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|m0
operator|->
name|m_flags
operator|&
name|M_FRAG
operator|)
operator|==
literal|0
condition|)
name|cmd_status
operator||=
name|MGE_TX_NOT_FRAGMENT
expr_stmt|;
block|}
if|if
condition|(
name|csum_flags
operator|&
name|CSUM_IP
condition|)
name|cmd_status
operator||=
name|MGE_TX_GEN_IP_CSUM
expr_stmt|;
if|if
condition|(
name|csum_flags
operator|&
name|CSUM_TCP
condition|)
name|cmd_status
operator||=
name|MGE_TX_GEN_L4_CSUM
expr_stmt|;
if|if
condition|(
name|csum_flags
operator|&
name|CSUM_UDP
condition|)
name|cmd_status
operator||=
name|MGE_TX_GEN_L4_CSUM
operator||
name|MGE_TX_UDP
expr_stmt|;
name|dw
operator|->
name|mge_desc
operator|->
name|cmd_status
operator||=
name|cmd_status
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_intrs_ctrl
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
if|if
condition|(
name|enable
condition|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_MASK
argument_list|,
name|MGE_PORT_INT_RXQ0
operator||
name|MGE_PORT_INT_EXTEND
operator||
name|MGE_PORT_INT_RXERRQ0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_MASK_EXT
argument_list|,
name|MGE_PORT_INT_EXT_TXERR0
operator||
name|MGE_PORT_INT_EXT_RXOR
operator||
name|MGE_PORT_INT_EXT_TXUR
operator||
name|MGE_PORT_INT_EXT_TXBUF0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_INT_CAUSE
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_INT_MASK
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_CAUSE_EXT
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_MASK
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_PORT_INT_MASK_EXT
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|mge_crc8
parameter_list|(
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|uint8_t
name|crc
init|=
literal|0
decl_stmt|;
specifier|static
specifier|const
name|uint8_t
name|ct
index|[
literal|256
index|]
init|=
block|{
literal|0x00
block|,
literal|0x07
block|,
literal|0x0E
block|,
literal|0x09
block|,
literal|0x1C
block|,
literal|0x1B
block|,
literal|0x12
block|,
literal|0x15
block|,
literal|0x38
block|,
literal|0x3F
block|,
literal|0x36
block|,
literal|0x31
block|,
literal|0x24
block|,
literal|0x23
block|,
literal|0x2A
block|,
literal|0x2D
block|,
literal|0x70
block|,
literal|0x77
block|,
literal|0x7E
block|,
literal|0x79
block|,
literal|0x6C
block|,
literal|0x6B
block|,
literal|0x62
block|,
literal|0x65
block|,
literal|0x48
block|,
literal|0x4F
block|,
literal|0x46
block|,
literal|0x41
block|,
literal|0x54
block|,
literal|0x53
block|,
literal|0x5A
block|,
literal|0x5D
block|,
literal|0xE0
block|,
literal|0xE7
block|,
literal|0xEE
block|,
literal|0xE9
block|,
literal|0xFC
block|,
literal|0xFB
block|,
literal|0xF2
block|,
literal|0xF5
block|,
literal|0xD8
block|,
literal|0xDF
block|,
literal|0xD6
block|,
literal|0xD1
block|,
literal|0xC4
block|,
literal|0xC3
block|,
literal|0xCA
block|,
literal|0xCD
block|,
literal|0x90
block|,
literal|0x97
block|,
literal|0x9E
block|,
literal|0x99
block|,
literal|0x8C
block|,
literal|0x8B
block|,
literal|0x82
block|,
literal|0x85
block|,
literal|0xA8
block|,
literal|0xAF
block|,
literal|0xA6
block|,
literal|0xA1
block|,
literal|0xB4
block|,
literal|0xB3
block|,
literal|0xBA
block|,
literal|0xBD
block|,
literal|0xC7
block|,
literal|0xC0
block|,
literal|0xC9
block|,
literal|0xCE
block|,
literal|0xDB
block|,
literal|0xDC
block|,
literal|0xD5
block|,
literal|0xD2
block|,
literal|0xFF
block|,
literal|0xF8
block|,
literal|0xF1
block|,
literal|0xF6
block|,
literal|0xE3
block|,
literal|0xE4
block|,
literal|0xED
block|,
literal|0xEA
block|,
literal|0xB7
block|,
literal|0xB0
block|,
literal|0xB9
block|,
literal|0xBE
block|,
literal|0xAB
block|,
literal|0xAC
block|,
literal|0xA5
block|,
literal|0xA2
block|,
literal|0x8F
block|,
literal|0x88
block|,
literal|0x81
block|,
literal|0x86
block|,
literal|0x93
block|,
literal|0x94
block|,
literal|0x9D
block|,
literal|0x9A
block|,
literal|0x27
block|,
literal|0x20
block|,
literal|0x29
block|,
literal|0x2E
block|,
literal|0x3B
block|,
literal|0x3C
block|,
literal|0x35
block|,
literal|0x32
block|,
literal|0x1F
block|,
literal|0x18
block|,
literal|0x11
block|,
literal|0x16
block|,
literal|0x03
block|,
literal|0x04
block|,
literal|0x0D
block|,
literal|0x0A
block|,
literal|0x57
block|,
literal|0x50
block|,
literal|0x59
block|,
literal|0x5E
block|,
literal|0x4B
block|,
literal|0x4C
block|,
literal|0x45
block|,
literal|0x42
block|,
literal|0x6F
block|,
literal|0x68
block|,
literal|0x61
block|,
literal|0x66
block|,
literal|0x73
block|,
literal|0x74
block|,
literal|0x7D
block|,
literal|0x7A
block|,
literal|0x89
block|,
literal|0x8E
block|,
literal|0x87
block|,
literal|0x80
block|,
literal|0x95
block|,
literal|0x92
block|,
literal|0x9B
block|,
literal|0x9C
block|,
literal|0xB1
block|,
literal|0xB6
block|,
literal|0xBF
block|,
literal|0xB8
block|,
literal|0xAD
block|,
literal|0xAA
block|,
literal|0xA3
block|,
literal|0xA4
block|,
literal|0xF9
block|,
literal|0xFE
block|,
literal|0xF7
block|,
literal|0xF0
block|,
literal|0xE5
block|,
literal|0xE2
block|,
literal|0xEB
block|,
literal|0xEC
block|,
literal|0xC1
block|,
literal|0xC6
block|,
literal|0xCF
block|,
literal|0xC8
block|,
literal|0xDD
block|,
literal|0xDA
block|,
literal|0xD3
block|,
literal|0xD4
block|,
literal|0x69
block|,
literal|0x6E
block|,
literal|0x67
block|,
literal|0x60
block|,
literal|0x75
block|,
literal|0x72
block|,
literal|0x7B
block|,
literal|0x7C
block|,
literal|0x51
block|,
literal|0x56
block|,
literal|0x5F
block|,
literal|0x58
block|,
literal|0x4D
block|,
literal|0x4A
block|,
literal|0x43
block|,
literal|0x44
block|,
literal|0x19
block|,
literal|0x1E
block|,
literal|0x17
block|,
literal|0x10
block|,
literal|0x05
block|,
literal|0x02
block|,
literal|0x0B
block|,
literal|0x0C
block|,
literal|0x21
block|,
literal|0x26
block|,
literal|0x2F
block|,
literal|0x28
block|,
literal|0x3D
block|,
literal|0x3A
block|,
literal|0x33
block|,
literal|0x34
block|,
literal|0x4E
block|,
literal|0x49
block|,
literal|0x40
block|,
literal|0x47
block|,
literal|0x52
block|,
literal|0x55
block|,
literal|0x5C
block|,
literal|0x5B
block|,
literal|0x76
block|,
literal|0x71
block|,
literal|0x78
block|,
literal|0x7F
block|,
literal|0x6A
block|,
literal|0x6D
block|,
literal|0x64
block|,
literal|0x63
block|,
literal|0x3E
block|,
literal|0x39
block|,
literal|0x30
block|,
literal|0x37
block|,
literal|0x22
block|,
literal|0x25
block|,
literal|0x2C
block|,
literal|0x2B
block|,
literal|0x06
block|,
literal|0x01
block|,
literal|0x08
block|,
literal|0x0F
block|,
literal|0x1A
block|,
literal|0x1D
block|,
literal|0x14
block|,
literal|0x13
block|,
literal|0xAE
block|,
literal|0xA9
block|,
literal|0xA0
block|,
literal|0xA7
block|,
literal|0xB2
block|,
literal|0xB5
block|,
literal|0xBC
block|,
literal|0xBB
block|,
literal|0x96
block|,
literal|0x91
block|,
literal|0x98
block|,
literal|0x9F
block|,
literal|0x8A
block|,
literal|0x8D
block|,
literal|0x84
block|,
literal|0x83
block|,
literal|0xDE
block|,
literal|0xD9
block|,
literal|0xD0
block|,
literal|0xD7
block|,
literal|0xC2
block|,
literal|0xC5
block|,
literal|0xCC
block|,
literal|0xCB
block|,
literal|0xE6
block|,
literal|0xE1
block|,
literal|0xE8
block|,
literal|0xEF
block|,
literal|0xFA
block|,
literal|0xFD
block|,
literal|0xF4
block|,
literal|0xF3
block|}
decl_stmt|;
while|while
condition|(
name|size
operator|--
condition|)
name|crc
operator|=
name|ct
index|[
name|crc
operator|^
operator|*
operator|(
name|data
operator|++
operator|)
index|]
expr_stmt|;
return|return
operator|(
name|crc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_setup_multicast
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|special
index|[
literal|5
index|]
init|=
block|{
literal|0x01
block|,
literal|0x00
block|,
literal|0x5E
block|,
literal|0x00
block|,
literal|0x00
block|}
decl_stmt|;
name|uint8_t
name|v
init|=
operator|(
name|MGE_RX_DEFAULT_QUEUE
operator|<<
literal|1
operator|)
operator||
literal|1
decl_stmt|;
name|uint32_t
name|smt
index|[
name|MGE_MCAST_REG_NUMBER
index|]
decl_stmt|;
name|uint32_t
name|omt
index|[
name|MGE_MCAST_REG_NUMBER
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|uint8_t
modifier|*
name|mac
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_MCAST_REG_NUMBER
condition|;
name|i
operator|++
control|)
name|smt
index|[
name|i
index|]
operator|=
name|omt
index|[
name|i
index|]
operator|=
operator|(
name|v
operator|<<
literal|24
operator|)
operator||
operator|(
name|v
operator|<<
literal|16
operator|)
operator||
operator|(
name|v
operator|<<
literal|8
operator|)
operator||
name|v
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
name|smt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|smt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|omt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|omt
argument_list|)
argument_list|)
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|mac
operator|=
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|mac
argument_list|,
name|special
argument_list|,
sizeof|sizeof
argument_list|(
name|special
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|i
operator|=
name|mac
index|[
literal|5
index|]
expr_stmt|;
name|smt
index|[
name|i
operator|>>
literal|2
index|]
operator||=
name|v
operator|<<
operator|(
operator|(
name|i
operator|&
literal|0x03
operator|)
operator|<<
literal|3
operator|)
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|mge_crc8
argument_list|(
name|mac
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|omt
index|[
name|i
operator|>>
literal|2
index|]
operator||=
name|v
operator|<<
operator|(
operator|(
name|i
operator|&
literal|0x03
operator|)
operator|<<
literal|3
operator|)
expr_stmt|;
block|}
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MGE_MCAST_REG_NUMBER
condition|;
name|i
operator|++
control|)
block|{
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_SPEC_MCAST
argument_list|(
name|i
argument_list|)
argument_list|,
name|smt
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_DA_FILTER_OTH_MCAST
argument_list|(
name|i
argument_list|)
argument_list|,
name|omt
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mge_set_rxic
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|rx_ic_time
operator|>
name|sc
operator|->
name|mge_rx_ipg_max
condition|)
name|sc
operator|->
name|rx_ic_time
operator|=
name|sc
operator|->
name|mge_rx_ipg_max
expr_stmt|;
name|reg
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_SDMA_CONFIG
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|mge_rx_ipg
argument_list|(
name|sc
operator|->
name|mge_rx_ipg_max
argument_list|,
name|sc
operator|->
name|mge_ver
argument_list|)
expr_stmt|;
name|reg
operator||=
name|mge_rx_ipg
argument_list|(
name|sc
operator|->
name|rx_ic_time
argument_list|,
name|sc
operator|->
name|mge_ver
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_SDMA_CONFIG
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_set_txic
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|tx_ic_time
operator|>
name|sc
operator|->
name|mge_tfut_ipg_max
condition|)
name|sc
operator|->
name|tx_ic_time
operator|=
name|sc
operator|->
name|mge_tfut_ipg_max
expr_stmt|;
name|reg
operator|=
name|MGE_READ
argument_list|(
name|sc
argument_list|,
name|MGE_TX_FIFO_URGENT_TRSH
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|mge_tfut_ipg
argument_list|(
name|sc
operator|->
name|mge_tfut_ipg_max
argument_list|,
name|sc
operator|->
name|mge_ver
argument_list|)
expr_stmt|;
name|reg
operator||=
name|mge_tfut_ipg
argument_list|(
name|sc
operator|->
name|tx_ic_time
argument_list|,
name|sc
operator|->
name|mge_ver
argument_list|)
expr_stmt|;
name|MGE_WRITE
argument_list|(
name|sc
argument_list|,
name|MGE_TX_FIFO_URGENT_TRSH
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mge_sysctl_ic
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mge_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|mge_softc
operator|*
operator|)
name|arg1
decl_stmt|;
name|uint32_t
name|time
decl_stmt|;
name|int
name|error
decl_stmt|;
name|time
operator|=
operator|(
name|arg2
operator|==
name|MGE_IC_RX
operator|)
condition|?
name|sc
operator|->
name|rx_ic_time
else|:
name|sc
operator|->
name|tx_ic_time
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|time
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|MGE_GLOBAL_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg2
operator|==
name|MGE_IC_RX
condition|)
block|{
name|sc
operator|->
name|rx_ic_time
operator|=
name|time
expr_stmt|;
name|mge_set_rxic
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|tx_ic_time
operator|=
name|time
expr_stmt|;
name|mge_set_txic
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|MGE_GLOBAL_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mge_add_sysctls
parameter_list|(
name|struct
name|mge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|children
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"int_coal"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"MGE Interrupts coalescing"
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_time"
argument_list|,
name|CTLTYPE_UINT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
name|MGE_IC_RX
argument_list|,
name|mge_sysctl_ic
argument_list|,
literal|"I"
argument_list|,
literal|"IC RX time threshold"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_time"
argument_list|,
name|CTLTYPE_UINT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
name|MGE_IC_TX
argument_list|,
name|mge_sysctl_ic
argument_list|,
literal|"I"
argument_list|,
literal|"IC TX time threshold"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


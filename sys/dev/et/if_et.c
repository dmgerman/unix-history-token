begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007 Sepherosa Ziehau.  All rights reserved.  *  * This code is derived from software contributed to The DragonFly Project  * by Sepherosa Ziehau<sepherosa@gmail.com>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  * 3. Neither the name of The DragonFly Project nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific, prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $DragonFly: src/sys/dev/netif/et/if_et.c,v 1.10 2008/05/18 07:47:14 sephe Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/et/if_etreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/et/if_etvar.h>
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|et
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|et
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|et
argument_list|,
name|miibus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Tunables. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|msi_disable
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.et.msi_disable"
argument_list|,
operator|&
name|msi_disable
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|ET_CSUM_FEATURES
value|(CSUM_IP | CSUM_TCP | CSUM_UDP)
end_define

begin_function_decl
specifier|static
name|int
name|et_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_suspend
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_resume
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_miibus_readreg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_miibus_writereg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_miibus_statchg
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_init_locked
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_watchdog
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_ifmedia_upd_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_add_sysctls
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_sysctl_rx_intr_npkts
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_sysctl_rx_intr_delay
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_rxeof
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_txeof
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_dma_alloc
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_dma_free
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_dma_map_addr
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_dma_ring_alloc
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|,
name|bus_size_t
parameter_list|,
name|bus_size_t
parameter_list|,
name|bus_dma_tag_t
modifier|*
parameter_list|,
name|uint8_t
modifier|*
modifier|*
parameter_list|,
name|bus_dmamap_t
modifier|*
parameter_list|,
name|bus_addr_t
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_dma_ring_free
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|,
name|bus_dma_tag_t
modifier|*
parameter_list|,
name|uint8_t
modifier|*
modifier|*
parameter_list|,
name|bus_dmamap_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_init_tx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_init_rx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_free_tx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_free_rx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_encap
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_newbuf_cluster
parameter_list|(
name|struct
name|et_rxbuf_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_newbuf_hdr
parameter_list|(
name|struct
name|et_rxbuf_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_rxbuf_discard
parameter_list|(
name|struct
name|et_rxbuf_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_stop
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_chip_init
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_chip_attach
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_init_mac
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_init_rxmac
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_init_txmac
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_init_rxdma
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_init_txdma
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_start_rxdma
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_start_txdma
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_stop_rxdma
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_stop_txdma
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_reset
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|et_bus_config
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_get_eaddr
parameter_list|(
name|device_t
parameter_list|,
name|uint8_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_setmulti
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_tick
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|et_stats_update
parameter_list|(
name|struct
name|et_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_struct
specifier|static
specifier|const
struct|struct
name|et_dev
block|{
name|uint16_t
name|vid
decl_stmt|;
name|uint16_t
name|did
decl_stmt|;
specifier|const
name|char
modifier|*
name|desc
decl_stmt|;
block|}
name|et_devices
index|[]
init|=
block|{
block|{
name|PCI_VENDOR_LUCENT
block|,
name|PCI_PRODUCT_LUCENT_ET1310
block|,
literal|"Agere ET1310 Gigabit Ethernet"
block|}
block|,
block|{
name|PCI_VENDOR_LUCENT
block|,
name|PCI_PRODUCT_LUCENT_ET1310_FAST
block|,
literal|"Agere ET1310 Fast Ethernet"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|device_method_t
name|et_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|et_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|et_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|et_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|et_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|et_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|et_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|et_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|et_miibus_writereg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_statchg
argument_list|,
name|et_miibus_statchg
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|et_driver
init|=
block|{
literal|"et"
block|,
name|et_methods
block|,
expr|sizeof
operator|(
expr|struct
name|et_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|et_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|et
argument_list|,
name|pci
argument_list|,
name|et_driver
argument_list|,
name|et_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|et
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|et_rx_intr_npkts
init|=
literal|32
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|et_rx_intr_delay
init|=
literal|20
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* x10 usec */
end_comment

begin_decl_stmt
specifier|static
name|int
name|et_tx_intr_nsegs
init|=
literal|126
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|et_timer
init|=
literal|1000
operator|*
literal|1000
operator|*
literal|1000
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* nanosec */
end_comment

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.et.timer"
argument_list|,
operator|&
name|et_timer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.et.rx_intr_npkts"
argument_list|,
operator|&
name|et_rx_intr_npkts
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.et.rx_intr_delay"
argument_list|,
operator|&
name|et_rx_intr_delay
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.et.tx_intr_nsegs"
argument_list|,
operator|&
name|et_tx_intr_nsegs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|et_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|const
name|struct
name|et_dev
modifier|*
name|d
decl_stmt|;
name|uint16_t
name|did
decl_stmt|,
name|vid
decl_stmt|;
name|vid
operator|=
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|did
operator|=
name|pci_get_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|d
operator|=
name|et_devices
init|;
name|d
operator|->
name|desc
operator|!=
name|NULL
condition|;
operator|++
name|d
control|)
block|{
if|if
condition|(
name|vid
operator|==
name|d
operator|->
name|vid
operator|&&
name|did
operator|==
name|d
operator|->
name|did
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|d
operator|->
name|desc
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint8_t
name|eaddr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|int
name|cap
decl_stmt|,
name|error
decl_stmt|,
name|msic
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can not if_alloc()\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOSPC
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* 	 * Initialize tunables 	 */
name|sc
operator|->
name|sc_rx_intr_npkts
operator|=
name|et_rx_intr_npkts
expr_stmt|;
name|sc
operator|->
name|sc_rx_intr_delay
operator|=
name|et_rx_intr_delay
expr_stmt|;
name|sc
operator|->
name|sc_tx_intr_nsegs
operator|=
name|et_tx_intr_nsegs
expr_stmt|;
name|sc
operator|->
name|sc_timer
operator|=
name|et_timer
expr_stmt|;
comment|/* Enable bus mastering */
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate IO memory 	 */
name|sc
operator|->
name|sc_mem_rid
operator|=
name|ET_PCIR_BAR
expr_stmt|;
name|sc
operator|->
name|sc_mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|sc_mem_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't allocate IO memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|msic
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pci_find_cap
argument_list|(
name|dev
argument_list|,
name|PCIY_EXPRESS
argument_list|,
operator|&
name|cap
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_expcap
operator|=
name|cap
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|ET_FLAG_PCIE
expr_stmt|;
name|msic
operator|=
name|pci_msi_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"MSI count: %d\n"
argument_list|,
name|msic
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|msic
operator|>
literal|0
operator|&&
name|msi_disable
operator|==
literal|0
condition|)
block|{
name|msic
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pci_alloc_msi
argument_list|(
name|dev
argument_list|,
operator|&
name|msic
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|msic
operator|==
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Using %d MSI message\n"
argument_list|,
name|msic
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|ET_FLAG_MSI
expr_stmt|;
block|}
else|else
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Allocate IRQ 	 */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_MSI
operator|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_irq_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|sc_irq_rid
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_irq_rid
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|sc_irq_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't allocate irq\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|PCI_PRODUCT_LUCENT_ET1310_FAST
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|ET_FLAG_FASTETHER
expr_stmt|;
name|error
operator|=
name|et_bus_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|et_get_eaddr
argument_list|(
name|dev
argument_list|,
name|eaddr
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_PM
argument_list|,
name|ET_PM_SYSCLK_GATE
operator||
name|ET_PM_TXCLK_GATE
operator||
name|ET_PM_RXCLK_GATE
argument_list|)
expr_stmt|;
name|et_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|et_dma_alloc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|et_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|et_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|et_start
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
name|IFCAP_TXCSUM
operator||
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|ET_TX_NDESC
operator|-
literal|1
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ET_TX_NDESC
operator|-
literal|1
argument_list|)
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|et_chip_attach
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|mii_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|sc_miibus
argument_list|,
name|ifp
argument_list|,
name|et_ifmedia_upd
argument_list|,
name|et_ifmedia_sts
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|MII_PHY_ANY
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"attaching PHYs failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|eaddr
argument_list|)
expr_stmt|;
comment|/* Tell the upper layer(s) we support long frames. */
name|ifp
operator|->
name|if_hdrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq_res
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|et_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_irq_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't setup intr\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|et_add_sysctls
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|et_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|ether_ifdetach
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_miibus
operator|!=
name|NULL
condition|)
name|device_delete_child
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_miibus
argument_list|)
expr_stmt|;
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_irq_handle
operator|!=
name|NULL
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq_res
argument_list|,
name|sc
operator|->
name|sc_irq_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_irq_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|sc_irq_res
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_irq_res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_MSI
operator|)
operator|!=
literal|0
condition|)
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mem_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|sc_mem_res
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_mem_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifp
operator|!=
name|NULL
condition|)
name|if_free
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|et_dma_free
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
comment|/* Stop any pending operations */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|phy
operator|<<
name|ET_MII_ADDR_PHY_SHIFT
operator|)
operator|&
name|ET_MII_ADDR_PHY_MASK
expr_stmt|;
name|val
operator||=
operator|(
name|reg
operator|<<
name|ET_MII_ADDR_REG_SHIFT
operator|)
operator|&
name|ET_MII_ADDR_REG_MASK
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_ADDR
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Start reading */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CMD
argument_list|,
name|ET_MII_CMD_READ
argument_list|)
expr_stmt|;
define|#
directive|define
name|NRETRY
value|50
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NRETRY
condition|;
operator|++
name|i
control|)
block|{
name|val
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_IND
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
operator|(
name|ET_MII_IND_BUSY
operator||
name|ET_MII_IND_INVALID
operator|)
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|NRETRY
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"read phy %d, reg %d timed out\n"
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|back
goto|;
block|}
undef|#
directive|undef
name|NRETRY
name|val
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_STAT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|val
operator|&
name|ET_MII_STAT_VALUE_MASK
expr_stmt|;
name|back
label|:
comment|/* Make sure that the current operation is stopped */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|val0
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Stop any pending operations */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|phy
operator|<<
name|ET_MII_ADDR_PHY_SHIFT
operator|)
operator|&
name|ET_MII_ADDR_PHY_MASK
expr_stmt|;
name|val
operator||=
operator|(
name|reg
operator|<<
name|ET_MII_ADDR_REG_SHIFT
operator|)
operator|&
name|ET_MII_ADDR_REG_MASK
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_ADDR
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Start writing */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CTRL
argument_list|,
operator|(
name|val0
operator|<<
name|ET_MII_CTRL_VALUE_SHIFT
operator|)
operator|&
name|ET_MII_CTRL_VALUE_MASK
argument_list|)
expr_stmt|;
define|#
directive|define
name|NRETRY
value|100
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NRETRY
condition|;
operator|++
name|i
control|)
block|{
name|val
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_IND
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|ET_MII_IND_BUSY
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|NRETRY
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"write phy %d, reg %d timed out\n"
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|et_miibus_readreg
argument_list|(
name|dev
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|NRETRY
comment|/* Make sure that the current operation is stopped */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_miibus_statchg
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|cfg1
decl_stmt|,
name|cfg2
decl_stmt|,
name|ctrl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|sc_miibus
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|mii
operator|==
name|NULL
operator|||
name|ifp
operator|==
name|NULL
operator|||
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|ET_FLAG_LINK
expr_stmt|;
if|if
condition|(
operator|(
name|mii
operator|->
name|mii_media_status
operator|&
operator|(
name|IFM_ACTIVE
operator||
name|IFM_AVALID
operator|)
operator|)
operator|==
operator|(
name|IFM_ACTIVE
operator||
name|IFM_AVALID
operator|)
condition|)
block|{
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
condition|)
block|{
case|case
name|IFM_10_T
case|:
case|case
name|IFM_100_TX
case|:
name|sc
operator|->
name|sc_flags
operator||=
name|ET_FLAG_LINK
expr_stmt|;
break|break;
case|case
name|IFM_1000_T
case|:
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_FASTETHER
operator|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|ET_FLAG_LINK
expr_stmt|;
break|break;
block|}
block|}
comment|/* XXX Stop TX/RX MAC? */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_LINK
operator|)
operator|==
literal|0
condition|)
return|return;
comment|/* Program MACs with resolved speed/duplex/flow-control. */
name|ctrl
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CTRL
argument_list|)
expr_stmt|;
name|ctrl
operator|&=
operator|~
operator|(
name|ET_MAC_CTRL_GHDX
operator||
name|ET_MAC_CTRL_MODE_MII
operator|)
expr_stmt|;
name|cfg1
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|)
expr_stmt|;
name|cfg1
operator|&=
operator|~
operator|(
name|ET_MAC_CFG1_TXFLOW
operator||
name|ET_MAC_CFG1_RXFLOW
operator||
name|ET_MAC_CFG1_LOOPBACK
operator|)
expr_stmt|;
name|cfg2
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG2
argument_list|)
expr_stmt|;
name|cfg2
operator|&=
operator|~
operator|(
name|ET_MAC_CFG2_MODE_MII
operator||
name|ET_MAC_CFG2_MODE_GMII
operator||
name|ET_MAC_CFG2_FDX
operator||
name|ET_MAC_CFG2_BIGFRM
operator|)
expr_stmt|;
name|cfg2
operator||=
name|ET_MAC_CFG2_LENCHK
operator||
name|ET_MAC_CFG2_CRC
operator||
name|ET_MAC_CFG2_PADCRC
operator||
operator|(
operator|(
literal|7
operator|<<
name|ET_MAC_CFG2_PREAMBLE_LEN_SHIFT
operator|)
operator|&
name|ET_MAC_CFG2_PREAMBLE_LEN_MASK
operator|)
expr_stmt|;
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|==
name|IFM_1000_T
condition|)
name|cfg2
operator||=
name|ET_MAC_CFG2_MODE_GMII
expr_stmt|;
else|else
block|{
name|cfg2
operator||=
name|ET_MAC_CFG2_MODE_MII
expr_stmt|;
name|ctrl
operator||=
name|ET_MAC_CTRL_MODE_MII
expr_stmt|;
block|}
if|if
condition|(
name|IFM_OPTIONS
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|&
name|IFM_FDX
condition|)
block|{
name|cfg2
operator||=
name|ET_MAC_CFG2_FDX
expr_stmt|;
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
name|IFM_OPTIONS
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|&
name|IFM_ETH_TXPAUSE
condition|)
name|cfg1
operator||=
name|ET_MAC_CFG1_TXFLOW
expr_stmt|;
if|if
condition|(
name|IFM_OPTIONS
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|&
name|IFM_ETH_RXPAUSE
condition|)
name|cfg1
operator||=
name|ET_MAC_CFG1_RXFLOW
expr_stmt|;
endif|#
directive|endif
block|}
else|else
name|ctrl
operator||=
name|ET_MAC_CTRL_GHDX
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CTRL
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG2
argument_list|,
name|cfg2
argument_list|)
expr_stmt|;
name|cfg1
operator||=
name|ET_MAC_CFG1_TXEN
operator||
name|ET_MAC_CFG1_RXEN
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
name|cfg1
argument_list|)
expr_stmt|;
define|#
directive|define
name|NRETRY
value|50
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NRETRY
condition|;
operator|++
name|i
control|)
block|{
name|cfg1
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cfg1
operator|&
operator|(
name|ET_MAC_CFG1_SYNC_TXEN
operator||
name|ET_MAC_CFG1_SYNC_RXEN
operator|)
operator|)
operator|==
operator|(
name|ET_MAC_CFG1_SYNC_TXEN
operator||
name|ET_MAC_CFG1_SYNC_RXEN
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|NRETRY
condition|)
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"can't enable RX/TX\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator||=
name|ET_FLAG_TXRX_ENABLED
expr_stmt|;
undef|#
directive|undef
name|NRETRY
block|}
end_function

begin_function
specifier|static
name|int
name|et_ifmedia_upd_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|sc_miibus
argument_list|)
decl_stmt|;
name|struct
name|mii_softc
modifier|*
name|miisc
decl_stmt|;
name|LIST_FOREACH
argument_list|(
argument|miisc
argument_list|,
argument|&mii->mii_phys
argument_list|,
argument|mii_list
argument_list|)
name|PHY_RESET
argument_list|(
name|miisc
argument_list|)
expr_stmt|;
return|return
operator|(
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|res
decl_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|res
operator|=
name|et_ifmedia_upd_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|==
literal|0
condition|)
block|{
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|sc_miibus
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_stop
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick
argument_list|)
expr_stmt|;
comment|/* Disable interrupts. */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_INTR_MASK
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|)
operator|&
operator|~
operator|(
name|ET_MAC_CFG1_TXEN
operator||
name|ET_MAC_CFG1_RXEN
operator|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|et_stop_rxdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_stop_txdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_stats_update
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_free_tx_ring
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_free_rx_ring
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_tx_intr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|ET_FLAG_TXRX_ENABLED
expr_stmt|;
name|sc
operator|->
name|watchdog_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_bus_config
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|,
name|max_plsz
decl_stmt|;
name|uint16_t
name|ack_latency
decl_stmt|,
name|replay_timer
decl_stmt|;
comment|/* 	 * Test whether EEPROM is valid 	 * NOTE: Read twice to get the correct value 	 */
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_EEPROM_STATUS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|val
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_EEPROM_STATUS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|ET_PCIM_EEPROM_STATUS_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"EEPROM status error 0x%02x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* TODO: LED */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_PCIE
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Configure ACK latency and replay timer according to 	 * max playload size 	 */
name|val
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|sc_expcap
operator|+
name|PCIR_EXPRESS_DEVICE_CAP
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|max_plsz
operator|=
name|val
operator|&
name|PCIM_EXP_CAP_MAX_PAYLOAD
expr_stmt|;
switch|switch
condition|(
name|max_plsz
condition|)
block|{
case|case
name|ET_PCIV_DEVICE_CAPS_PLSZ_128
case|:
name|ack_latency
operator|=
name|ET_PCIV_ACK_LATENCY_128
expr_stmt|;
name|replay_timer
operator|=
name|ET_PCIV_REPLAY_TIMER_128
expr_stmt|;
break|break;
case|case
name|ET_PCIV_DEVICE_CAPS_PLSZ_256
case|:
name|ack_latency
operator|=
name|ET_PCIV_ACK_LATENCY_256
expr_stmt|;
name|replay_timer
operator|=
name|ET_PCIV_REPLAY_TIMER_256
expr_stmt|;
break|break;
default|default:
name|ack_latency
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_ACK_LATENCY
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|replay_timer
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_REPLAY_TIMER
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ack latency %u, replay timer %u\n"
argument_list|,
name|ack_latency
argument_list|,
name|replay_timer
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ack_latency
operator|!=
literal|0
condition|)
block|{
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_ACK_LATENCY
argument_list|,
name|ack_latency
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_REPLAY_TIMER
argument_list|,
name|replay_timer
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Set L0s and L1 latency timer to 2us 	 */
name|val
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_L0S_L1_LATENCY
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|PCIM_LINK_CAP_L0S_EXIT
operator||
name|PCIM_LINK_CAP_L1_EXIT
operator|)
expr_stmt|;
comment|/* L0s exit latency : 2us */
name|val
operator||=
literal|0x00005000
expr_stmt|;
comment|/* L1 exit latency : 2us */
name|val
operator||=
literal|0x00028000
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|ET_PCIR_L0S_L1_LATENCY
argument_list|,
name|val
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* 	 * Set max read request size to 2048 bytes 	 */
name|val
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|sc_expcap
operator|+
name|PCIR_EXPRESS_DEVICE_CTL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|PCIM_EXP_CTL_MAX_READ_REQUEST
expr_stmt|;
name|val
operator||=
name|ET_PCIV_DEVICE_CTRL_RRSZ_2K
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|sc_expcap
operator|+
name|PCIR_EXPRESS_DEVICE_CTL
argument_list|,
name|val
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_get_eaddr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
name|eaddr
index|[]
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
name|val
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|ET_PCIR_MAC_ADDR0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|eaddr
index|[
name|i
index|]
operator|=
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
name|i
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
name|val
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|ET_PCIR_MAC_ADDR1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
operator|++
name|i
control|)
name|eaddr
index|[
name|i
index|]
operator|=
operator|(
name|val
operator|>>
operator|(
literal|8
operator|*
operator|(
name|i
operator|-
literal|4
operator|)
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_reset
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
name|ET_MAC_CFG1_RST_TXFUNC
operator||
name|ET_MAC_CFG1_RST_RXFUNC
operator||
name|ET_MAC_CFG1_RST_TXMC
operator||
name|ET_MAC_CFG1_RST_RXMC
operator||
name|ET_MAC_CFG1_SIM_RST
operator||
name|ET_MAC_CFG1_SOFT_RST
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_SWRST
argument_list|,
name|ET_SWRST_TXDMA
operator||
name|ET_SWRST_RXDMA
operator||
name|ET_SWRST_TXMAC
operator||
name|ET_SWRST_RXMAC
operator||
name|ET_SWRST_MAC
operator||
name|ET_SWRST_MAC_STAT
operator||
name|ET_SWRST_MMC
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
name|ET_MAC_CFG1_RST_TXFUNC
operator||
name|ET_MAC_CFG1_RST_RXFUNC
operator||
name|ET_MAC_CFG1_RST_TXMC
operator||
name|ET_MAC_CFG1_RST_RXMC
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable interrupts. */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_INTR_MASK
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|et_dmamap_arg
block|{
name|bus_addr_t
name|et_busaddr
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|et_dma_map_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|et_dmamap_arg
modifier|*
name|ctx
decl_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
name|KASSERT
argument_list|(
name|nseg
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: %d segments returned!"
operator|,
name|__func__
operator|,
name|nseg
operator|)
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|arg
expr_stmt|;
name|ctx
operator|->
name|et_busaddr
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_dma_ring_alloc
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|,
name|bus_size_t
name|alignment
parameter_list|,
name|bus_size_t
name|maxsize
parameter_list|,
name|bus_dma_tag_t
modifier|*
name|tag
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|ring
parameter_list|,
name|bus_dmamap_t
modifier|*
name|map
parameter_list|,
name|bus_addr_t
modifier|*
name|paddr
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|et_dmamap_arg
name|ctx
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_dtag
argument_list|,
name|alignment
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|maxsize
argument_list|,
literal|1
argument_list|,
name|maxsize
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create %s dma tag\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Allocate DMA'able memory for ring. */
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
operator|*
name|tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
name|ring
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_COHERENT
argument_list|,
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate DMA'able memory for %s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Load the address of the ring. */
name|ctx
operator|.
name|et_busaddr
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
operator|*
name|tag
argument_list|,
operator|*
name|map
argument_list|,
operator|*
name|ring
argument_list|,
name|maxsize
argument_list|,
name|et_dma_map_addr
argument_list|,
operator|&
name|ctx
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not load DMA'able memory for %s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
operator|*
name|paddr
operator|=
name|ctx
operator|.
name|et_busaddr
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_dma_ring_free
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|,
name|bus_dma_tag_t
modifier|*
name|tag
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|ring
parameter_list|,
name|bus_dmamap_t
modifier|*
name|map
parameter_list|)
block|{
if|if
condition|(
operator|*
name|map
operator|!=
name|NULL
condition|)
name|bus_dmamap_unload
argument_list|(
operator|*
name|tag
argument_list|,
operator|*
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|map
operator|!=
name|NULL
operator|&&
operator|*
name|ring
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamem_free
argument_list|(
operator|*
name|tag
argument_list|,
operator|*
name|ring
argument_list|,
operator|*
name|map
argument_list|)
expr_stmt|;
operator|*
name|ring
operator|=
name|NULL
expr_stmt|;
operator|*
name|map
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|tag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
operator|*
name|tag
argument_list|)
expr_stmt|;
operator|*
name|tag
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|et_dma_alloc
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|et_rxdesc_ring
modifier|*
name|rx_ring
decl_stmt|;
name|struct
name|et_rxstat_ring
modifier|*
name|rxst_ring
decl_stmt|;
name|struct
name|et_rxstatus_data
modifier|*
name|rxsd
decl_stmt|;
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
decl_stmt|;
name|struct
name|et_txbuf_data
modifier|*
name|tbd
decl_stmt|;
name|struct
name|et_txstatus_data
modifier|*
name|txsd
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|sc_dtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate parent dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* TX ring. */
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_tx_ring
expr_stmt|;
name|error
operator|=
name|et_dma_ring_alloc
argument_list|(
name|sc
argument_list|,
name|ET_RING_ALIGN
argument_list|,
name|ET_TX_RING_SIZE
argument_list|,
operator|&
name|tx_ring
operator|->
name|tr_dtag
argument_list|,
operator|(
name|uint8_t
operator|*
operator|*
operator|)
operator|&
name|tx_ring
operator|->
name|tr_desc
argument_list|,
operator|&
name|tx_ring
operator|->
name|tr_dmap
argument_list|,
operator|&
name|tx_ring
operator|->
name|tr_paddr
argument_list|,
literal|"TX ring"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* TX status block. */
name|txsd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_status
expr_stmt|;
name|error
operator|=
name|et_dma_ring_alloc
argument_list|(
name|sc
argument_list|,
name|ET_STATUS_ALIGN
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
operator|&
name|txsd
operator|->
name|txsd_dtag
argument_list|,
operator|(
name|uint8_t
operator|*
operator|*
operator|)
operator|&
name|txsd
operator|->
name|txsd_status
argument_list|,
operator|&
name|txsd
operator|->
name|txsd_dmap
argument_list|,
operator|&
name|txsd
operator|->
name|txsd_paddr
argument_list|,
literal|"TX status block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* RX ring 0, used as to recive small sized frames. */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|0
index|]
expr_stmt|;
name|error
operator|=
name|et_dma_ring_alloc
argument_list|(
name|sc
argument_list|,
name|ET_RING_ALIGN
argument_list|,
name|ET_RX_RING_SIZE
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dtag
argument_list|,
operator|(
name|uint8_t
operator|*
operator|*
operator|)
operator|&
name|rx_ring
operator|->
name|rr_desc
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dmap
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_paddr
argument_list|,
literal|"RX ring 0"
argument_list|)
expr_stmt|;
name|rx_ring
operator|->
name|rr_posreg
operator|=
name|ET_RX_RING0_POS
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* RX ring 1, used as to store normal sized frames. */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|1
index|]
expr_stmt|;
name|error
operator|=
name|et_dma_ring_alloc
argument_list|(
name|sc
argument_list|,
name|ET_RING_ALIGN
argument_list|,
name|ET_RX_RING_SIZE
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dtag
argument_list|,
operator|(
name|uint8_t
operator|*
operator|*
operator|)
operator|&
name|rx_ring
operator|->
name|rr_desc
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dmap
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_paddr
argument_list|,
literal|"RX ring 1"
argument_list|)
expr_stmt|;
name|rx_ring
operator|->
name|rr_posreg
operator|=
name|ET_RX_RING1_POS
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* RX stat ring. */
name|rxst_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rxstat_ring
expr_stmt|;
name|error
operator|=
name|et_dma_ring_alloc
argument_list|(
name|sc
argument_list|,
name|ET_RING_ALIGN
argument_list|,
name|ET_RXSTAT_RING_SIZE
argument_list|,
operator|&
name|rxst_ring
operator|->
name|rsr_dtag
argument_list|,
operator|(
name|uint8_t
operator|*
operator|*
operator|)
operator|&
name|rxst_ring
operator|->
name|rsr_stat
argument_list|,
operator|&
name|rxst_ring
operator|->
name|rsr_dmap
argument_list|,
operator|&
name|rxst_ring
operator|->
name|rsr_paddr
argument_list|,
literal|"RX stat ring"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* RX status block. */
name|rxsd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_status
expr_stmt|;
name|error
operator|=
name|et_dma_ring_alloc
argument_list|(
name|sc
argument_list|,
name|ET_STATUS_ALIGN
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|et_rxstatus
argument_list|)
argument_list|,
operator|&
name|rxsd
operator|->
name|rxsd_dtag
argument_list|,
operator|(
name|uint8_t
operator|*
operator|*
operator|)
operator|&
name|rxsd
operator|->
name|rxsd_status
argument_list|,
operator|&
name|rxsd
operator|->
name|rxsd_dmap
argument_list|,
operator|&
name|rxsd
operator|->
name|rxsd_paddr
argument_list|,
literal|"RX status block"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Create parent DMA tag for mbufs. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|sc_mbuf_dtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate parent dma tag for mbuf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Create DMA tag for mini RX mbufs to use RX ring 0. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_mbuf_dtag
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MHLEN
argument_list|,
literal|1
argument_list|,
name|MHLEN
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create mini RX dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Create DMA tag for standard RX mbufs to use RX ring 1. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_mbuf_dtag
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create RX dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Create DMA tag for TX mbufs. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_mbuf_dtag
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MCLBYTES
operator|*
name|ET_NSEG_MAX
argument_list|,
name|ET_NSEG_MAX
argument_list|,
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create TX dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Initialize RX ring 0. */
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
literal|0
index|]
expr_stmt|;
name|rbd
operator|->
name|rbd_bufsize
operator|=
name|ET_RXDMA_CTRL_RING0_128
expr_stmt|;
name|rbd
operator|->
name|rbd_newbuf
operator|=
name|et_newbuf_hdr
expr_stmt|;
name|rbd
operator|->
name|rbd_discard
operator|=
name|et_rxbuf_discard
expr_stmt|;
name|rbd
operator|->
name|rbd_softc
operator|=
name|sc
expr_stmt|;
name|rbd
operator|->
name|rbd_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|0
index|]
expr_stmt|;
comment|/* Create DMA maps for mini RX buffers, ring 0. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_RX_NDESC
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create DMA map for mini RX mbufs\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
comment|/* Create a spare DMA map for mini RX buffers, ring 0. */
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx_mini_sparemap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create spare DMA map for mini RX mbuf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Initialize RX ring 1. */
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
literal|1
index|]
expr_stmt|;
name|rbd
operator|->
name|rbd_bufsize
operator|=
name|ET_RXDMA_CTRL_RING1_2048
expr_stmt|;
name|rbd
operator|->
name|rbd_newbuf
operator|=
name|et_newbuf_cluster
expr_stmt|;
name|rbd
operator|->
name|rbd_discard
operator|=
name|et_rxbuf_discard
expr_stmt|;
name|rbd
operator|->
name|rbd_softc
operator|=
name|sc
expr_stmt|;
name|rbd
operator|->
name|rbd_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|1
index|]
expr_stmt|;
comment|/* Create DMA maps for standard RX buffers, ring 1. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_RX_NDESC
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create DMA map for mini RX mbufs\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
comment|/* Create a spare DMA map for standard RX buffers, ring 1. */
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|sc_rx_sparemap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create spare DMA map for RX mbuf\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Create DMA maps for TX buffers. */
name|tbd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_TX_NDESC
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|tbd
operator|->
name|tbd_buf
index|[
name|i
index|]
operator|.
name|tb_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create DMA map for TX mbufs\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_dma_free
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|et_rxdesc_ring
modifier|*
name|rx_ring
decl_stmt|;
name|struct
name|et_txstatus_data
modifier|*
name|txsd
decl_stmt|;
name|struct
name|et_rxstat_ring
modifier|*
name|rxst_ring
decl_stmt|;
name|struct
name|et_rxstatus_data
modifier|*
name|rxsd
decl_stmt|;
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
decl_stmt|;
name|struct
name|et_txbuf_data
modifier|*
name|tbd
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Destroy DMA maps for mini RX buffers, ring 0. */
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_RX_NDESC
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
argument_list|)
expr_stmt|;
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rx_mini_sparemap
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|sc
operator|->
name|sc_rx_mini_sparemap
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rx_mini_sparemap
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rx_mini_tag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rx_mini_tag
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Destroy DMA maps for standard RX buffers, ring 1. */
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_RX_NDESC
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
argument_list|)
expr_stmt|;
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
operator|.
name|rb_dmap
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rx_sparemap
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|sc
operator|->
name|sc_rx_sparemap
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rx_sparemap
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rx_tag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rx_tag
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Destroy DMA maps for TX buffers. */
name|tbd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_TX_NDESC
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tbd
operator|->
name|tbd_buf
index|[
name|i
index|]
operator|.
name|tb_dmap
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|tbd
operator|->
name|tbd_buf
index|[
name|i
index|]
operator|.
name|tb_dmap
argument_list|)
expr_stmt|;
name|tbd
operator|->
name|tbd_buf
index|[
name|i
index|]
operator|.
name|tb_dmap
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|sc_tx_tag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tx_tag
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Destroy mini RX ring, ring 0. */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|0
index|]
expr_stmt|;
name|et_dma_ring_free
argument_list|(
name|sc
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dtag
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|rx_ring
operator|->
name|rr_desc
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dmap
argument_list|)
expr_stmt|;
comment|/* Destroy standard RX ring, ring 1. */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|1
index|]
expr_stmt|;
name|et_dma_ring_free
argument_list|(
name|sc
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dtag
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|rx_ring
operator|->
name|rr_desc
argument_list|,
operator|&
name|rx_ring
operator|->
name|rr_dmap
argument_list|)
expr_stmt|;
comment|/* Destroy RX stat ring. */
name|rxst_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rxstat_ring
expr_stmt|;
name|et_dma_ring_free
argument_list|(
name|sc
argument_list|,
operator|&
name|rxst_ring
operator|->
name|rsr_dtag
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|rxst_ring
operator|->
name|rsr_stat
argument_list|,
operator|&
name|rxst_ring
operator|->
name|rsr_dmap
argument_list|)
expr_stmt|;
comment|/* Destroy RX status block. */
name|rxsd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_status
expr_stmt|;
name|et_dma_ring_free
argument_list|(
name|sc
argument_list|,
operator|&
name|rxst_ring
operator|->
name|rsr_dtag
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|rxst_ring
operator|->
name|rsr_stat
argument_list|,
operator|&
name|rxst_ring
operator|->
name|rsr_dmap
argument_list|)
expr_stmt|;
comment|/* Destroy TX ring. */
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_tx_ring
expr_stmt|;
name|et_dma_ring_free
argument_list|(
name|sc
argument_list|,
operator|&
name|tx_ring
operator|->
name|tr_dtag
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|tx_ring
operator|->
name|tr_desc
argument_list|,
operator|&
name|tx_ring
operator|->
name|tr_dmap
argument_list|)
expr_stmt|;
comment|/* Destroy TX status block. */
name|txsd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_status
expr_stmt|;
name|et_dma_ring_free
argument_list|(
name|sc
argument_list|,
operator|&
name|txsd
operator|->
name|txsd_dtag
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|txsd
operator|->
name|txsd_status
argument_list|,
operator|&
name|txsd
operator|->
name|txsd_dmap
argument_list|)
expr_stmt|;
comment|/* Destroy the parent tag. */
if|if
condition|(
name|sc
operator|->
name|sc_dtag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|sc_dtag
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dtag
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|et_chip_attach
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
comment|/* 	 * Perform minimal initialization 	 */
comment|/* Disable loopback */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_LOOPBACK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reset MAC */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
name|ET_MAC_CFG1_RST_TXFUNC
operator||
name|ET_MAC_CFG1_RST_RXFUNC
operator||
name|ET_MAC_CFG1_RST_TXMC
operator||
name|ET_MAC_CFG1_RST_RXMC
operator||
name|ET_MAC_CFG1_SIM_RST
operator||
name|ET_MAC_CFG1_SOFT_RST
argument_list|)
expr_stmt|;
comment|/* 	 * Setup half duplex mode 	 */
name|val
operator|=
operator|(
literal|10
operator|<<
name|ET_MAC_HDX_ALT_BEB_TRUNC_SHIFT
operator|)
operator||
operator|(
literal|15
operator|<<
name|ET_MAC_HDX_REXMIT_MAX_SHIFT
operator|)
operator||
operator|(
literal|55
operator|<<
name|ET_MAC_HDX_COLLWIN_SHIFT
operator|)
operator||
name|ET_MAC_HDX_EXC_DEFER
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_HDX
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Clear MAC control */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reset MII */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CFG
argument_list|,
name|ET_MII_CFG_CLKRST
argument_list|)
expr_stmt|;
comment|/* Bring MAC out of reset state */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Enable memory controllers */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MMC_CTRL
argument_list|,
name|ET_MMC_CTRL_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|intrs
decl_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Disable further interrupts. */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_INTR_MASK
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|intrs
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_INTR_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|intrs
operator|&
name|ET_INTRS
operator|)
operator|==
literal|0
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|intrs
operator|&
name|ET_INTR_RXEOF
condition|)
name|et_rxeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrs
operator|&
operator|(
name|ET_INTR_TXEOF
operator||
name|ET_INTR_TIMER
operator|)
condition|)
name|et_txeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|intrs
operator|&
name|ET_INTR_TIMER
condition|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TIMER
argument_list|,
name|sc
operator|->
name|sc_timer
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_INTR_MASK
argument_list|,
operator|~
name|ET_INTRS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|et_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_init_locked
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
return|return;
name|et_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_init_tx_ring
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|et_init_rx_ring
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
name|error
operator|=
name|et_chip_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * Start TX/RX DMA engine 	 */
name|error
operator|=
name|et_start_rxdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
name|error
operator|=
name|et_start_txdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
comment|/* Enable interrupts. */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_INTR_MASK
argument_list|,
operator|~
name|ET_INTRS
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TIMER
argument_list|,
name|sc
operator|->
name|sc_timer
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|ET_FLAG_LINK
expr_stmt|;
name|et_ifmedia_upd_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick
argument_list|,
name|hz
argument_list|,
name|et_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|error
condition|)
name|et_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_init
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|sc_miibus
argument_list|)
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|mask
decl_stmt|,
name|max_framelen
decl_stmt|;
comment|/* XXX LOCKSUSED */
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|sc
operator|->
name|sc_if_flags
operator|)
operator|&
operator|(
name|IFF_ALLMULTI
operator||
name|IFF_PROMISC
operator||
name|IFF_BROADCAST
operator|)
condition|)
name|et_setmulti
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|et_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|et_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_setmulti
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMTU
case|:
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if (sc->sc_flags& ET_FLAG_JUMBO) 			max_framelen = ET_JUMBO_FRAMELEN; 		else
endif|#
directive|endif
name|max_framelen
operator|=
name|MCLBYTES
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ET_FRAMELEN
argument_list|(
name|ifr
operator|->
name|ifr_mtu
argument_list|)
operator|>
name|max_framelen
condition|)
block|{
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ifp
operator|->
name|if_mtu
operator|!=
name|ifr
operator|->
name|ifr_mtu
condition|)
block|{
name|ifp
operator|->
name|if_mtu
operator|=
name|ifr
operator|->
name|ifr_mtu
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|et_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mask
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
expr_stmt|;
if|if
condition|(
operator|(
name|mask
operator|&
name|IFCAP_TXCSUM
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|IFCAP_TXCSUM
operator|&
name|ifp
operator|->
name|if_capabilities
operator|)
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM
expr_stmt|;
if|if
condition|(
operator|(
name|IFCAP_TXCSUM
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
operator|!=
literal|0
condition|)
name|ifp
operator|->
name|if_hwassist
operator||=
name|ET_CSUM_FEATURES
expr_stmt|;
else|else
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|ET_CSUM_FEATURES
expr_stmt|;
block|}
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_head
init|=
name|NULL
decl_stmt|;
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|et_txbuf_data
modifier|*
name|tbd
decl_stmt|;
name|uint32_t
name|tx_ready_pos
decl_stmt|;
name|int
name|enq
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
operator|||
operator|(
name|sc
operator|->
name|sc_flags
operator|&
operator|(
name|ET_FLAG_LINK
operator||
name|ET_FLAG_TXRX_ENABLED
operator|)
operator|)
operator|!=
operator|(
name|ET_FLAG_LINK
operator||
name|ET_FLAG_TXRX_ENABLED
operator|)
condition|)
return|return;
comment|/* 	 * Driver does not request TX completion interrupt for every 	 * queued frames to prevent generating excessive interrupts. 	 * This means driver may wait for TX completion interrupt even 	 * though some frames were sucessfully transmitted.  Reclaiming 	 * transmitted frames will ensure driver see all available 	 * descriptors. 	 */
name|tbd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_data
expr_stmt|;
if|if
condition|(
name|tbd
operator|->
name|tbd_used
operator|>
operator|(
name|ET_TX_NDESC
operator|*
literal|2
operator|)
operator|/
literal|3
condition|)
name|et_txeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|enq
operator|=
literal|0
init|;
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|;
control|)
block|{
if|if
condition|(
name|tbd
operator|->
name|tbd_used
operator|+
name|ET_NSEG_SPARE
operator|>=
name|ET_TX_NDESC
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|et_encap
argument_list|(
name|sc
argument_list|,
operator|&
name|m_head
argument_list|)
condition|)
block|{
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
break|break;
block|}
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|tbd
operator|->
name|tbd_used
operator|>
literal|0
condition|)
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
name|enq
operator|++
expr_stmt|;
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|enq
operator|>
literal|0
condition|)
block|{
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_tx_ring
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|tx_ring
operator|->
name|tr_dtag
argument_list|,
name|tx_ring
operator|->
name|tr_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|tx_ready_pos
operator|=
name|tx_ring
operator|->
name|tr_ready_index
operator|&
name|ET_TX_READY_POS_INDEX_MASK
expr_stmt|;
if|if
condition|(
name|tx_ring
operator|->
name|tr_ready_wrap
condition|)
name|tx_ready_pos
operator||=
name|ET_TX_READY_POS_WRAP
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_READY_POS
argument_list|,
name|tx_ready_pos
argument_list|)
expr_stmt|;
name|sc
operator|->
name|watchdog_timer
operator|=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|et_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|et_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_watchdog
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|watchdog_timer
operator|==
literal|0
operator|||
operator|--
name|sc
operator|->
name|watchdog_timer
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_tx_status
operator|.
name|txsd_dtag
argument_list|,
name|sc
operator|->
name|sc_tx_status
operator|.
name|txsd_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|status
operator|=
name|le32toh
argument_list|(
operator|*
operator|(
name|sc
operator|->
name|sc_tx_status
operator|.
name|txsd_status
operator|)
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"watchdog timed out (0x%08x) -- resetting\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|et_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EJUSTRETURN
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_stop_rxdma
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXDMA_CTRL
argument_list|,
name|ET_RXDMA_CTRL_HALT
operator||
name|ET_RXDMA_CTRL_RING1_ENABLE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_RXDMA_CTRL
argument_list|)
operator|&
name|ET_RXDMA_CTRL_HALTED
operator|)
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"can't stop RX DMA engine\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_stop_txdma
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TXDMA_CTRL
argument_list|,
name|ET_TXDMA_CTRL_HALT
operator||
name|ET_TXDMA_CTRL_SINGLE_EPKT
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_free_tx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|et_txbuf_data
modifier|*
name|tbd
decl_stmt|;
name|struct
name|et_txbuf
modifier|*
name|tb
decl_stmt|;
name|int
name|i
decl_stmt|;
name|tbd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_data
expr_stmt|;
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_tx_ring
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_TX_NDESC
condition|;
operator|++
name|i
control|)
block|{
name|tb
operator|=
operator|&
name|tbd
operator|->
name|tbd_buf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|tb
operator|->
name|tb_mbuf
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|tb
operator|->
name|tb_dmap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_mbuf_dtag
argument_list|,
name|tb
operator|->
name|tb_dmap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tb
operator|->
name|tb_mbuf
argument_list|)
expr_stmt|;
name|tb
operator|->
name|tb_mbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|et_free_rx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
decl_stmt|;
name|struct
name|et_rxdesc_ring
modifier|*
name|rx_ring
decl_stmt|;
name|struct
name|et_rxbuf
modifier|*
name|rb
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Ring 0 */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|0
index|]
expr_stmt|;
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_RX_NDESC
condition|;
operator|++
name|i
control|)
block|{
name|rb
operator|=
operator|&
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rb
operator|->
name|rb_mbuf
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|rx_ring
operator|->
name|rr_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rb
operator|->
name|rb_mbuf
argument_list|)
expr_stmt|;
name|rb
operator|->
name|rb_mbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
comment|/* Ring 1 */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|1
index|]
expr_stmt|;
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_RX_NDESC
condition|;
operator|++
name|i
control|)
block|{
name|rb
operator|=
operator|&
name|rbd
operator|->
name|rbd_buf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rb
operator|->
name|rb_mbuf
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|rx_ring
operator|->
name|rr_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rb
operator|->
name|rb_mbuf
argument_list|)
expr_stmt|;
name|rb
operator|->
name|rb_mbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|et_setmulti
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|hash
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|uint32_t
name|rxmac_ctrl
decl_stmt|,
name|pktfilt
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
decl_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|pktfilt
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_PKTFILT
argument_list|)
expr_stmt|;
name|rxmac_ctrl
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_CTRL
argument_list|)
expr_stmt|;
name|pktfilt
operator|&=
operator|~
operator|(
name|ET_PKTFILT_BCAST
operator||
name|ET_PKTFILT_MCAST
operator||
name|ET_PKTFILT_UCAST
operator|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
operator|(
name|IFF_PROMISC
operator||
name|IFF_ALLMULTI
operator|)
condition|)
block|{
name|rxmac_ctrl
operator||=
name|ET_RXMAC_CTRL_NO_PKTFILT
expr_stmt|;
goto|goto
name|back
goto|;
block|}
name|count
operator|=
literal|0
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
name|uint32_t
modifier|*
name|hp
decl_stmt|,
name|h
decl_stmt|;
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|h
operator|=
name|ether_crc32_be
argument_list|(
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|h
operator|=
operator|(
name|h
operator|&
literal|0x3f800000
operator|)
operator|>>
literal|23
expr_stmt|;
name|hp
operator|=
operator|&
name|hash
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|h
operator|>=
literal|32
operator|&&
name|h
operator|<
literal|64
condition|)
block|{
name|h
operator|-=
literal|32
expr_stmt|;
name|hp
operator|=
operator|&
name|hash
index|[
literal|1
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|h
operator|>=
literal|64
operator|&&
name|h
operator|<
literal|96
condition|)
block|{
name|h
operator|-=
literal|64
expr_stmt|;
name|hp
operator|=
operator|&
name|hash
index|[
literal|2
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|h
operator|>=
literal|96
condition|)
block|{
name|h
operator|-=
literal|96
expr_stmt|;
name|hp
operator|=
operator|&
name|hash
index|[
literal|3
index|]
expr_stmt|;
block|}
operator|*
name|hp
operator||=
operator|(
literal|1
operator|<<
name|h
operator|)
expr_stmt|;
operator|++
name|count
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MULTI_HASH
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
name|hash
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
name|pktfilt
operator||=
name|ET_PKTFILT_MCAST
expr_stmt|;
name|rxmac_ctrl
operator|&=
operator|~
name|ET_RXMAC_CTRL_NO_PKTFILT
expr_stmt|;
name|back
label|:
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_PKTFILT
argument_list|,
name|pktfilt
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_CTRL
argument_list|,
name|rxmac_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_chip_init
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|uint32_t
name|rxq_end
decl_stmt|;
name|int
name|error
decl_stmt|,
name|frame_len
decl_stmt|,
name|rxmem_size
decl_stmt|;
comment|/* 	 * Split 16Kbytes internal memory between TX and RX 	 * according to frame length. 	 */
name|frame_len
operator|=
name|ET_FRAMELEN
argument_list|(
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame_len
operator|<
literal|2048
condition|)
block|{
name|rxmem_size
operator|=
name|ET_MEM_RXSIZE_DEFAULT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|frame_len
operator|<=
name|ET_RXMAC_CUT_THRU_FRMLEN
condition|)
block|{
name|rxmem_size
operator|=
name|ET_MEM_SIZE
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
name|rxmem_size
operator|=
name|ET_MEM_SIZE
operator|-
name|roundup
argument_list|(
name|frame_len
operator|+
name|ET_MEM_TXSIZE_EX
argument_list|,
name|ET_MEM_UNIT
argument_list|)
expr_stmt|;
block|}
name|rxq_end
operator|=
name|ET_QUEUE_ADDR
argument_list|(
name|rxmem_size
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXQUEUE_START
argument_list|,
name|ET_QUEUE_ADDR_START
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXQUEUE_END
argument_list|,
name|rxq_end
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TXQUEUE_START
argument_list|,
name|rxq_end
operator|+
literal|1
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TXQUEUE_END
argument_list|,
name|ET_QUEUE_ADDR_END
argument_list|)
expr_stmt|;
comment|/* No loopback */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_LOOPBACK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Clear MSI configure */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_MSI
operator|)
operator|==
literal|0
condition|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MSI_CFG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable timer */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TIMER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize MAC */
name|et_init_mac
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable memory controllers */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MMC_CTRL
argument_list|,
name|ET_MMC_CTRL_ENABLE
argument_list|)
expr_stmt|;
comment|/* Initialize RX MAC */
name|et_init_rxmac
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Initialize TX MAC */
name|et_init_txmac
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Initialize RX DMA engine */
name|error
operator|=
name|et_init_rxdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Initialize TX DMA engine */
name|error
operator|=
name|et_init_txdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_init_tx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|et_txbuf_data
modifier|*
name|tbd
decl_stmt|;
name|struct
name|et_txstatus_data
modifier|*
name|txsd
decl_stmt|;
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_tx_ring
expr_stmt|;
name|bzero
argument_list|(
name|tx_ring
operator|->
name|tr_desc
argument_list|,
name|ET_TX_RING_SIZE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|tx_ring
operator|->
name|tr_dtag
argument_list|,
name|tx_ring
operator|->
name|tr_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|tbd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_data
expr_stmt|;
name|tbd
operator|->
name|tbd_start_index
operator|=
literal|0
expr_stmt|;
name|tbd
operator|->
name|tbd_start_wrap
operator|=
literal|0
expr_stmt|;
name|tbd
operator|->
name|tbd_used
operator|=
literal|0
expr_stmt|;
name|txsd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_status
expr_stmt|;
name|bzero
argument_list|(
name|txsd
operator|->
name|txsd_status
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|txsd
operator|->
name|txsd_dtag
argument_list|,
name|txsd
operator|->
name|txsd_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_init_rx_ring
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_rxstatus_data
modifier|*
name|rxsd
decl_stmt|;
name|struct
name|et_rxstat_ring
modifier|*
name|rxst_ring
decl_stmt|;
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|ET_RX_NRING
condition|;
operator|++
name|n
control|)
block|{
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
name|n
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ET_RX_NDESC
condition|;
operator|++
name|i
control|)
block|{
name|error
operator|=
name|rbd
operator|->
name|rbd_newbuf
argument_list|(
name|rbd
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"%d ring %d buf, "
literal|"newbuf failed: %d\n"
argument_list|,
name|n
argument_list|,
name|i
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
block|}
name|rxsd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_status
expr_stmt|;
name|bzero
argument_list|(
name|rxsd
operator|->
name|rxsd_status
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|et_rxstatus
argument_list|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rxsd
operator|->
name|rxsd_dtag
argument_list|,
name|rxsd
operator|->
name|rxsd_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|rxst_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rxstat_ring
expr_stmt|;
name|bzero
argument_list|(
name|rxst_ring
operator|->
name|rsr_stat
argument_list|,
name|ET_RXSTAT_RING_SIZE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rxst_ring
operator|->
name|rsr_dtag
argument_list|,
name|rxst_ring
operator|->
name|rsr_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_init_rxdma
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_rxstatus_data
modifier|*
name|rxsd
init|=
operator|&
name|sc
operator|->
name|sc_rx_status
decl_stmt|;
name|struct
name|et_rxstat_ring
modifier|*
name|rxst_ring
init|=
operator|&
name|sc
operator|->
name|sc_rxstat_ring
decl_stmt|;
name|struct
name|et_rxdesc_ring
modifier|*
name|rx_ring
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|et_stop_rxdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"can't init RX DMA engine\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 	 * Install RX status 	 */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_STATUS_HI
argument_list|,
name|ET_ADDR_HI
argument_list|(
name|rxsd
operator|->
name|rxsd_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_STATUS_LO
argument_list|,
name|ET_ADDR_LO
argument_list|(
name|rxsd
operator|->
name|rxsd_paddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Install RX stat ring 	 */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXSTAT_HI
argument_list|,
name|ET_ADDR_HI
argument_list|(
name|rxst_ring
operator|->
name|rsr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXSTAT_LO
argument_list|,
name|ET_ADDR_LO
argument_list|(
name|rxst_ring
operator|->
name|rsr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXSTAT_CNT
argument_list|,
name|ET_RX_NSTAT
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXSTAT_POS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXSTAT_MINCNT
argument_list|,
operator|(
operator|(
name|ET_RX_NSTAT
operator|*
literal|15
operator|)
operator|/
literal|100
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Match ET_RXSTAT_POS */
name|rxst_ring
operator|->
name|rsr_index
operator|=
literal|0
expr_stmt|;
name|rxst_ring
operator|->
name|rsr_wrap
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Install the 2nd RX descriptor ring 	 */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|1
index|]
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING1_HI
argument_list|,
name|ET_ADDR_HI
argument_list|(
name|rx_ring
operator|->
name|rr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING1_LO
argument_list|,
name|ET_ADDR_LO
argument_list|(
name|rx_ring
operator|->
name|rr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING1_CNT
argument_list|,
name|ET_RX_NDESC
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING1_POS
argument_list|,
name|ET_RX_RING1_POS_WRAP
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING1_MINCNT
argument_list|,
operator|(
operator|(
name|ET_RX_NDESC
operator|*
literal|15
operator|)
operator|/
literal|100
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Match ET_RX_RING1_POS */
name|rx_ring
operator|->
name|rr_index
operator|=
literal|0
expr_stmt|;
name|rx_ring
operator|->
name|rr_wrap
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Install the 1st RX descriptor ring 	 */
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
literal|0
index|]
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING0_HI
argument_list|,
name|ET_ADDR_HI
argument_list|(
name|rx_ring
operator|->
name|rr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING0_LO
argument_list|,
name|ET_ADDR_LO
argument_list|(
name|rx_ring
operator|->
name|rr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING0_CNT
argument_list|,
name|ET_RX_NDESC
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING0_POS
argument_list|,
name|ET_RX_RING0_POS_WRAP
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_RING0_MINCNT
argument_list|,
operator|(
operator|(
name|ET_RX_NDESC
operator|*
literal|15
operator|)
operator|/
literal|100
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Match ET_RX_RING0_POS */
name|rx_ring
operator|->
name|rr_index
operator|=
literal|0
expr_stmt|;
name|rx_ring
operator|->
name|rr_wrap
operator|=
literal|1
expr_stmt|;
comment|/* 	 * RX intr moderation 	 */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_INTR_NPKTS
argument_list|,
name|sc
operator|->
name|sc_rx_intr_npkts
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_INTR_DELAY
argument_list|,
name|sc
operator|->
name|sc_rx_intr_delay
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_init_txdma
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
init|=
operator|&
name|sc
operator|->
name|sc_tx_ring
decl_stmt|;
name|struct
name|et_txstatus_data
modifier|*
name|txsd
init|=
operator|&
name|sc
operator|->
name|sc_tx_status
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|et_stop_txdma
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"can't init TX DMA engine\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 	 * Install TX descriptor ring 	 */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_RING_HI
argument_list|,
name|ET_ADDR_HI
argument_list|(
name|tx_ring
operator|->
name|tr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_RING_LO
argument_list|,
name|ET_ADDR_LO
argument_list|(
name|tx_ring
operator|->
name|tr_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_RING_CNT
argument_list|,
name|ET_TX_NDESC
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Install TX status 	 */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_STATUS_HI
argument_list|,
name|ET_ADDR_HI
argument_list|(
name|txsd
operator|->
name|txsd_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_STATUS_LO
argument_list|,
name|ET_ADDR_LO
argument_list|(
name|txsd
operator|->
name|txsd_paddr
argument_list|)
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_READY_POS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Match ET_TX_READY_POS */
name|tx_ring
operator|->
name|tr_ready_index
operator|=
literal|0
expr_stmt|;
name|tx_ring
operator|->
name|tr_ready_wrap
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_init_mac
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|eaddr
init|=
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* Reset MAC */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
name|ET_MAC_CFG1_RST_TXFUNC
operator||
name|ET_MAC_CFG1_RST_RXFUNC
operator||
name|ET_MAC_CFG1_RST_TXMC
operator||
name|ET_MAC_CFG1_RST_RXMC
operator||
name|ET_MAC_CFG1_SIM_RST
operator||
name|ET_MAC_CFG1_SOFT_RST
argument_list|)
expr_stmt|;
comment|/* 	 * Setup inter packet gap 	 */
name|val
operator|=
operator|(
literal|56
operator|<<
name|ET_IPG_NONB2B_1_SHIFT
operator|)
operator||
operator|(
literal|88
operator|<<
name|ET_IPG_NONB2B_2_SHIFT
operator|)
operator||
operator|(
literal|80
operator|<<
name|ET_IPG_MINIFG_SHIFT
operator|)
operator||
operator|(
literal|96
operator|<<
name|ET_IPG_B2B_SHIFT
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_IPG
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* 	 * Setup half duplex mode 	 */
name|val
operator|=
operator|(
literal|10
operator|<<
name|ET_MAC_HDX_ALT_BEB_TRUNC_SHIFT
operator|)
operator||
operator|(
literal|15
operator|<<
name|ET_MAC_HDX_REXMIT_MAX_SHIFT
operator|)
operator||
operator|(
literal|55
operator|<<
name|ET_MAC_HDX_COLLWIN_SHIFT
operator|)
operator||
name|ET_MAC_HDX_EXC_DEFER
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_HDX
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Clear MAC control */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reset MII */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MII_CFG
argument_list|,
name|ET_MII_CFG_CLKRST
argument_list|)
expr_stmt|;
comment|/* 	 * Set MAC address 	 */
name|val
operator|=
name|eaddr
index|[
literal|2
index|]
operator||
operator|(
name|eaddr
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|eaddr
index|[
literal|4
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|eaddr
index|[
literal|5
index|]
operator|<<
literal|24
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_ADDR1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|eaddr
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|eaddr
index|[
literal|1
index|]
operator|<<
literal|24
operator|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_ADDR2
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Set max frame length */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAX_FRMLEN
argument_list|,
name|ET_FRAMELEN
argument_list|(
name|ifp
operator|->
name|if_mtu
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Bring MAC out of reset state */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_MAC_CFG1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_init_rxmac
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|eaddr
init|=
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Disable RX MAC and WOL */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_CTRL
argument_list|,
name|ET_RXMAC_CTRL_WOL_DISABLE
argument_list|)
expr_stmt|;
comment|/* 	 * Clear all WOL related registers 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
operator|++
name|i
control|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_WOL_CRC
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
operator|++
name|i
control|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_WOL_MASK
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Set WOL source address.  XXX is this necessary? 	 */
name|val
operator|=
operator|(
name|eaddr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|eaddr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|eaddr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|eaddr
index|[
literal|5
index|]
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_WOL_SA_LO
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|eaddr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|eaddr
index|[
literal|1
index|]
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_WOL_SA_HI
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Clear packet filters */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_PKTFILT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* No ucast filtering */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_UCAST_FILTADDR1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_UCAST_FILTADDR2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_UCAST_FILTADDR3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ET_FRAMELEN
argument_list|(
name|ifp
operator|->
name|if_mtu
argument_list|)
operator|>
name|ET_RXMAC_CUT_THRU_FRMLEN
condition|)
block|{
comment|/* 		 * In order to transmit jumbo packets greater than 		 * ET_RXMAC_CUT_THRU_FRMLEN bytes, the FIFO between 		 * RX MAC and RX DMA needs to be reduced in size to 		 * (ET_MEM_SIZE - ET_MEM_TXSIZE_EX - framelen).  In 		 * order to implement this, we must use "cut through" 		 * mode in the RX MAC, which chops packets down into 		 * segments.  In this case we selected 256 bytes, 		 * since this is the size of the PCI-Express TLP's 		 * that the ET1310 uses. 		 */
name|val
operator|=
operator|(
name|ET_RXMAC_SEGSZ
argument_list|(
literal|256
argument_list|)
operator|&
name|ET_RXMAC_MC_SEGSZ_MAX_MASK
operator|)
operator||
name|ET_RXMAC_MC_SEGSZ_ENABLE
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
literal|0
expr_stmt|;
block|}
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_MC_SEGSZ
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_MC_WATERMARK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize RX MAC management register */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_MGT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_SPACE_AVL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_MGT
argument_list|,
name|ET_RXMAC_MGT_PASS_ECRC
operator||
name|ET_RXMAC_MGT_PASS_ELEN
operator||
name|ET_RXMAC_MGT_PASS_ETRUNC
operator||
name|ET_RXMAC_MGT_CHECK_PKT
argument_list|)
expr_stmt|;
comment|/* 	 * Configure runt filtering (may not work on certain chip generation) 	 */
name|val
operator|=
operator|(
name|ETHER_MIN_LEN
operator|<<
name|ET_PKTFILT_MINLEN_SHIFT
operator|)
operator|&
name|ET_PKTFILT_MINLEN_MASK
expr_stmt|;
name|val
operator||=
name|ET_PKTFILT_FRAG
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_PKTFILT
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Enable RX MAC but leave WOL disabled */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXMAC_CTRL
argument_list|,
name|ET_RXMAC_CTRL_WOL_DISABLE
operator||
name|ET_RXMAC_CTRL_ENABLE
argument_list|)
expr_stmt|;
comment|/* 	 * Setup multicast hash and allmulti/promisc mode 	 */
name|et_setmulti
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_init_txmac
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Disable TX MAC and FC(?) */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TXMAC_CTRL
argument_list|,
name|ET_TXMAC_CTRL_FC_DISABLE
argument_list|)
expr_stmt|;
comment|/* No flow control yet */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TXMAC_FLOWCTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Enable TX MAC but leave FC(?) diabled */
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TXMAC_CTRL
argument_list|,
name|ET_TXMAC_CTRL_ENABLE
operator||
name|ET_TXMAC_CTRL_FC_DISABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_start_rxdma
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|val
operator||=
operator|(
name|sc
operator|->
name|sc_rx_data
index|[
literal|0
index|]
operator|.
name|rbd_bufsize
operator|&
name|ET_RXDMA_CTRL_RING0_SIZE_MASK
operator|)
operator||
name|ET_RXDMA_CTRL_RING0_ENABLE
expr_stmt|;
name|val
operator||=
operator|(
name|sc
operator|->
name|sc_rx_data
index|[
literal|1
index|]
operator|.
name|rbd_bufsize
operator|&
name|ET_RXDMA_CTRL_RING1_SIZE_MASK
operator|)
operator||
name|ET_RXDMA_CTRL_RING1_ENABLE
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXDMA_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_RXDMA_CTRL
argument_list|)
operator|&
name|ET_RXDMA_CTRL_HALTED
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|ifp
argument_list|,
literal|"can't start RX DMA engine\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_start_txdma
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_TXDMA_CTRL
argument_list|,
name|ET_TXDMA_CTRL_SINGLE_EPKT
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_rxeof
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_rxstatus_data
modifier|*
name|rxsd
decl_stmt|;
name|struct
name|et_rxstat_ring
modifier|*
name|rxst_ring
decl_stmt|;
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
decl_stmt|;
name|struct
name|et_rxdesc_ring
modifier|*
name|rx_ring
decl_stmt|;
name|struct
name|et_rxstat
modifier|*
name|st
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint32_t
name|rxstat_pos
decl_stmt|,
name|rxring_pos
decl_stmt|;
name|uint32_t
name|rxst_info1
decl_stmt|,
name|rxst_info2
decl_stmt|,
name|rxs_stat_ring
decl_stmt|;
name|int
name|buflen
decl_stmt|,
name|buf_idx
decl_stmt|,
name|npost
index|[
literal|2
index|]
decl_stmt|,
name|ring_idx
decl_stmt|;
name|int
name|rxst_index
decl_stmt|,
name|rxst_wrap
decl_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|rxsd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_status
expr_stmt|;
name|rxst_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rxstat_ring
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_TXRX_ENABLED
operator|)
operator|==
literal|0
condition|)
return|return;
name|bus_dmamap_sync
argument_list|(
name|rxsd
operator|->
name|rxsd_dtag
argument_list|,
name|rxsd
operator|->
name|rxsd_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rxst_ring
operator|->
name|rsr_dtag
argument_list|,
name|rxst_ring
operator|->
name|rsr_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|npost
index|[
literal|0
index|]
operator|=
name|npost
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|rxs_stat_ring
operator|=
name|le32toh
argument_list|(
name|rxsd
operator|->
name|rxsd_status
operator|->
name|rxs_stat_ring
argument_list|)
expr_stmt|;
name|rxst_wrap
operator|=
operator|(
name|rxs_stat_ring
operator|&
name|ET_RXS_STATRING_WRAP
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rxst_index
operator|=
operator|(
name|rxs_stat_ring
operator|&
name|ET_RXS_STATRING_INDEX_MASK
operator|)
operator|>>
name|ET_RXS_STATRING_INDEX_SHIFT
expr_stmt|;
while|while
condition|(
name|rxst_index
operator|!=
name|rxst_ring
operator|->
name|rsr_index
operator|||
name|rxst_wrap
operator|!=
name|rxst_ring
operator|->
name|rsr_wrap
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
break|break;
name|MPASS
argument_list|(
name|rxst_ring
operator|->
name|rsr_index
operator|<
name|ET_RX_NSTAT
argument_list|)
expr_stmt|;
name|st
operator|=
operator|&
name|rxst_ring
operator|->
name|rsr_stat
index|[
name|rxst_ring
operator|->
name|rsr_index
index|]
expr_stmt|;
name|rxst_info1
operator|=
name|le32toh
argument_list|(
name|st
operator|->
name|rxst_info1
argument_list|)
expr_stmt|;
name|rxst_info2
operator|=
name|le32toh
argument_list|(
name|st
operator|->
name|rxst_info2
argument_list|)
expr_stmt|;
name|buflen
operator|=
operator|(
name|rxst_info2
operator|&
name|ET_RXST_INFO2_LEN_MASK
operator|)
operator|>>
name|ET_RXST_INFO2_LEN_SHIFT
expr_stmt|;
name|buf_idx
operator|=
operator|(
name|rxst_info2
operator|&
name|ET_RXST_INFO2_BUFIDX_MASK
operator|)
operator|>>
name|ET_RXST_INFO2_BUFIDX_SHIFT
expr_stmt|;
name|ring_idx
operator|=
operator|(
name|rxst_info2
operator|&
name|ET_RXST_INFO2_RINGIDX_MASK
operator|)
operator|>>
name|ET_RXST_INFO2_RINGIDX_SHIFT
expr_stmt|;
if|if
condition|(
operator|++
name|rxst_ring
operator|->
name|rsr_index
operator|==
name|ET_RX_NSTAT
condition|)
block|{
name|rxst_ring
operator|->
name|rsr_index
operator|=
literal|0
expr_stmt|;
name|rxst_ring
operator|->
name|rsr_wrap
operator|^=
literal|1
expr_stmt|;
block|}
name|rxstat_pos
operator|=
name|rxst_ring
operator|->
name|rsr_index
operator|&
name|ET_RXSTAT_POS_INDEX_MASK
expr_stmt|;
if|if
condition|(
name|rxst_ring
operator|->
name|rsr_wrap
condition|)
name|rxstat_pos
operator||=
name|ET_RXSTAT_POS_WRAP
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RXSTAT_POS
argument_list|,
name|rxstat_pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring_idx
operator|>=
name|ET_RX_NRING
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"invalid ring index %d\n"
argument_list|,
name|ring_idx
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|buf_idx
operator|>=
name|ET_RX_NDESC
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"invalid buf index %d\n"
argument_list|,
name|buf_idx
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|rbd
operator|=
operator|&
name|sc
operator|->
name|sc_rx_data
index|[
name|ring_idx
index|]
expr_stmt|;
name|m
operator|=
name|rbd
operator|->
name|rbd_buf
index|[
name|buf_idx
index|]
operator|.
name|rb_mbuf
expr_stmt|;
if|if
condition|(
operator|(
name|rxst_info1
operator|&
name|ET_RXST_INFO1_OK
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Discard errored frame. */
name|rbd
operator|->
name|rbd_discard
argument_list|(
name|rbd
argument_list|,
name|buf_idx
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rbd
operator|->
name|rbd_newbuf
argument_list|(
name|rbd
argument_list|,
name|buf_idx
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* No available mbufs, discard it. */
name|ifp
operator|->
name|if_iqdrops
operator|++
expr_stmt|;
name|rbd
operator|->
name|rbd_discard
argument_list|(
name|rbd
argument_list|,
name|buf_idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|buflen
operator|-=
name|ETHER_CRC_LEN
expr_stmt|;
if|if
condition|(
name|buflen
operator|<
name|ETHER_HDR_LEN
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
block|}
else|else
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|buflen
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_input
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|rx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_rx_ring
index|[
name|ring_idx
index|]
expr_stmt|;
if|if
condition|(
name|buf_idx
operator|!=
name|rx_ring
operator|->
name|rr_index
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"WARNING!! ring %d, buf_idx %d, rr_idx %d\n"
argument_list|,
name|ring_idx
argument_list|,
name|buf_idx
argument_list|,
name|rx_ring
operator|->
name|rr_index
argument_list|)
expr_stmt|;
block|}
name|MPASS
argument_list|(
name|rx_ring
operator|->
name|rr_index
operator|<
name|ET_RX_NDESC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|rx_ring
operator|->
name|rr_index
operator|==
name|ET_RX_NDESC
condition|)
block|{
name|rx_ring
operator|->
name|rr_index
operator|=
literal|0
expr_stmt|;
name|rx_ring
operator|->
name|rr_wrap
operator|^=
literal|1
expr_stmt|;
block|}
name|rxring_pos
operator|=
name|rx_ring
operator|->
name|rr_index
operator|&
name|ET_RX_RING_POS_INDEX_MASK
expr_stmt|;
if|if
condition|(
name|rx_ring
operator|->
name|rr_wrap
condition|)
name|rxring_pos
operator||=
name|ET_RX_RING_POS_WRAP
expr_stmt|;
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|rx_ring
operator|->
name|rr_posreg
argument_list|,
name|rxring_pos
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|rxsd
operator|->
name|rxsd_dtag
argument_list|,
name|rxsd
operator|->
name|rxsd_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rxst_ring
operator|->
name|rsr_dtag
argument_list|,
name|rxst_ring
operator|->
name|rsr_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_encap
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|)
block|{
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|et_txbuf_data
modifier|*
name|tbd
decl_stmt|;
name|struct
name|et_txdesc
modifier|*
name|td
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|ET_NSEG_MAX
index|]
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|uint32_t
name|csum_flags
decl_stmt|,
name|last_td_ctrl2
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|first_idx
decl_stmt|,
name|last_idx
decl_stmt|,
name|nsegs
decl_stmt|;
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_tx_ring
expr_stmt|;
name|MPASS
argument_list|(
name|tx_ring
operator|->
name|tr_ready_index
operator|<
name|ET_TX_NDESC
argument_list|)
expr_stmt|;
name|tbd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_data
expr_stmt|;
name|first_idx
operator|=
name|tx_ring
operator|->
name|tr_ready_index
expr_stmt|;
name|map
operator|=
name|tbd
operator|->
name|tbd_buf
index|[
name|first_idx
index|]
operator|.
name|tb_dmap
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|map
argument_list|,
operator|*
name|m0
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|EFBIG
condition|)
block|{
name|m
operator|=
name|m_collapse
argument_list|(
operator|*
name|m0
argument_list|,
name|M_DONTWAIT
argument_list|,
name|ET_NSEG_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m0
argument_list|)
expr_stmt|;
operator|*
name|m0
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
operator|*
name|m0
operator|=
name|m
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|map
argument_list|,
operator|*
name|m0
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m0
argument_list|)
expr_stmt|;
operator|*
name|m0
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Check for descriptor overruns. */
if|if
condition|(
name|tbd
operator|->
name|tbd_used
operator|+
name|nsegs
operator|>
name|ET_TX_NDESC
operator|-
literal|1
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|map
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|last_td_ctrl2
operator|=
name|ET_TDCTRL2_LAST_FRAG
expr_stmt|;
name|sc
operator|->
name|sc_tx
operator|+=
name|nsegs
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tx
operator|/
name|sc
operator|->
name|sc_tx_intr_nsegs
operator|!=
name|sc
operator|->
name|sc_tx_intr
condition|)
block|{
name|sc
operator|->
name|sc_tx_intr
operator|=
name|sc
operator|->
name|sc_tx
operator|/
name|sc
operator|->
name|sc_tx_intr_nsegs
expr_stmt|;
name|last_td_ctrl2
operator||=
name|ET_TDCTRL2_INTR
expr_stmt|;
block|}
name|m
operator|=
operator|*
name|m0
expr_stmt|;
name|csum_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|ET_CSUM_FEATURES
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP
operator|)
operator|!=
literal|0
condition|)
name|csum_flags
operator||=
name|ET_TDCTRL2_CSUM_IP
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_UDP
operator|)
operator|!=
literal|0
condition|)
name|csum_flags
operator||=
name|ET_TDCTRL2_CSUM_UDP
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TCP
operator|)
operator|!=
literal|0
condition|)
name|csum_flags
operator||=
name|ET_TDCTRL2_CSUM_TCP
expr_stmt|;
block|}
name|last_idx
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
operator|++
name|i
control|)
block|{
name|idx
operator|=
operator|(
name|first_idx
operator|+
name|i
operator|)
operator|%
name|ET_TX_NDESC
expr_stmt|;
name|td
operator|=
operator|&
name|tx_ring
operator|->
name|tr_desc
index|[
name|idx
index|]
expr_stmt|;
name|td
operator|->
name|td_addr_hi
operator|=
name|htole32
argument_list|(
name|ET_ADDR_HI
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
argument_list|)
expr_stmt|;
name|td
operator|->
name|td_addr_lo
operator|=
name|htole32
argument_list|(
name|ET_ADDR_LO
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
argument_list|)
expr_stmt|;
name|td
operator|->
name|td_ctrl1
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
operator|&
name|ET_TDCTRL1_LEN_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|nsegs
operator|-
literal|1
condition|)
block|{
comment|/* Last frag */
name|td
operator|->
name|td_ctrl2
operator|=
name|htole32
argument_list|(
name|last_td_ctrl2
operator||
name|csum_flags
argument_list|)
expr_stmt|;
name|last_idx
operator|=
name|idx
expr_stmt|;
block|}
else|else
name|td
operator|->
name|td_ctrl2
operator|=
name|htole32
argument_list|(
name|csum_flags
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|tx_ring
operator|->
name|tr_ready_index
operator|<
name|ET_TX_NDESC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|tx_ring
operator|->
name|tr_ready_index
operator|==
name|ET_TX_NDESC
condition|)
block|{
name|tx_ring
operator|->
name|tr_ready_index
operator|=
literal|0
expr_stmt|;
name|tx_ring
operator|->
name|tr_ready_wrap
operator|^=
literal|1
expr_stmt|;
block|}
block|}
name|td
operator|=
operator|&
name|tx_ring
operator|->
name|tr_desc
index|[
name|first_idx
index|]
expr_stmt|;
comment|/* First frag */
name|td
operator|->
name|td_ctrl2
operator||=
name|htole32
argument_list|(
name|ET_TDCTRL2_FIRST_FRAG
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|last_idx
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|tbd
operator|->
name|tbd_buf
index|[
name|first_idx
index|]
operator|.
name|tb_dmap
operator|=
name|tbd
operator|->
name|tbd_buf
index|[
name|last_idx
index|]
operator|.
name|tb_dmap
expr_stmt|;
name|tbd
operator|->
name|tbd_buf
index|[
name|last_idx
index|]
operator|.
name|tb_dmap
operator|=
name|map
expr_stmt|;
name|tbd
operator|->
name|tbd_buf
index|[
name|last_idx
index|]
operator|.
name|tb_mbuf
operator|=
name|m
expr_stmt|;
name|tbd
operator|->
name|tbd_used
operator|+=
name|nsegs
expr_stmt|;
name|MPASS
argument_list|(
name|tbd
operator|->
name|tbd_used
operator|<=
name|ET_TX_NDESC
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_txeof
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|et_txdesc_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|et_txbuf_data
modifier|*
name|tbd
decl_stmt|;
name|struct
name|et_txbuf
modifier|*
name|tb
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|tx_done
decl_stmt|;
name|int
name|end
decl_stmt|,
name|wrap
decl_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|sc_tx_ring
expr_stmt|;
name|tbd
operator|=
operator|&
name|sc
operator|->
name|sc_tx_data
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|ET_FLAG_TXRX_ENABLED
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|tbd
operator|->
name|tbd_used
operator|==
literal|0
condition|)
return|return;
name|bus_dmamap_sync
argument_list|(
name|tx_ring
operator|->
name|tr_dtag
argument_list|,
name|tx_ring
operator|->
name|tr_dmap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|tx_done
operator|=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_TX_DONE_POS
argument_list|)
expr_stmt|;
name|end
operator|=
name|tx_done
operator|&
name|ET_TX_DONE_POS_INDEX_MASK
expr_stmt|;
name|wrap
operator|=
operator|(
name|tx_done
operator|&
name|ET_TX_DONE_POS_WRAP
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
while|while
condition|(
name|tbd
operator|->
name|tbd_start_index
operator|!=
name|end
operator|||
name|tbd
operator|->
name|tbd_start_wrap
operator|!=
name|wrap
condition|)
block|{
name|MPASS
argument_list|(
name|tbd
operator|->
name|tbd_start_index
operator|<
name|ET_TX_NDESC
argument_list|)
expr_stmt|;
name|tb
operator|=
operator|&
name|tbd
operator|->
name|tbd_buf
index|[
name|tbd
operator|->
name|tbd_start_index
index|]
expr_stmt|;
if|if
condition|(
name|tb
operator|->
name|tb_mbuf
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|tb
operator|->
name|tb_dmap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_tx_tag
argument_list|,
name|tb
operator|->
name|tb_dmap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tb
operator|->
name|tb_mbuf
argument_list|)
expr_stmt|;
name|tb
operator|->
name|tb_mbuf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|++
name|tbd
operator|->
name|tbd_start_index
operator|==
name|ET_TX_NDESC
condition|)
block|{
name|tbd
operator|->
name|tbd_start_index
operator|=
literal|0
expr_stmt|;
name|tbd
operator|->
name|tbd_start_wrap
operator|^=
literal|1
expr_stmt|;
block|}
name|MPASS
argument_list|(
name|tbd
operator|->
name|tbd_used
operator|>
literal|0
argument_list|)
expr_stmt|;
name|tbd
operator|->
name|tbd_used
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|tbd
operator|->
name|tbd_used
operator|==
literal|0
condition|)
name|sc
operator|->
name|watchdog_timer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tbd
operator|->
name|tbd_used
operator|+
name|ET_NSEG_SPARE
operator|<
name|ET_TX_NDESC
condition|)
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_tick
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|ET_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|sc_miibus
argument_list|)
expr_stmt|;
name|mii_tick
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|et_stats_update
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|et_watchdog
argument_list|(
name|sc
argument_list|)
operator|==
name|EJUSTRETURN
condition|)
return|return;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|sc_tick
argument_list|,
name|hz
argument_list|,
name|et_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_newbuf_cluster
parameter_list|(
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
parameter_list|,
name|int
name|buf_idx
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|et_rxdesc
modifier|*
name|desc
decl_stmt|;
name|struct
name|et_rxbuf
modifier|*
name|rb
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|bus_dmamap_t
name|dmap
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|MPASS
argument_list|(
name|buf_idx
operator|<
name|ET_RX_NDESC
argument_list|)
expr_stmt|;
name|m
operator|=
name|m_getcl
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MCLBYTES
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|ETHER_ALIGN
argument_list|)
expr_stmt|;
name|sc
operator|=
name|rbd
operator|->
name|rbd_softc
expr_stmt|;
name|rb
operator|=
operator|&
name|rbd
operator|->
name|rbd_buf
index|[
name|buf_idx
index|]
expr_stmt|;
if|if
condition|(
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|sc
operator|->
name|sc_rx_sparemap
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: %d segments returned!"
operator|,
name|__func__
operator|,
name|nsegs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rb
operator|->
name|rb_mbuf
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|)
expr_stmt|;
block|}
name|dmap
operator|=
name|rb
operator|->
name|rb_dmap
expr_stmt|;
name|rb
operator|->
name|rb_dmap
operator|=
name|sc
operator|->
name|sc_rx_sparemap
expr_stmt|;
name|sc
operator|->
name|sc_rx_sparemap
operator|=
name|dmap
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_rx_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|rb
operator|->
name|rb_mbuf
operator|=
name|m
expr_stmt|;
name|desc
operator|=
operator|&
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_desc
index|[
name|buf_idx
index|]
expr_stmt|;
name|desc
operator|->
name|rd_addr_hi
operator|=
name|htole32
argument_list|(
name|ET_ADDR_HI
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|rd_addr_lo
operator|=
name|htole32
argument_list|(
name|ET_ADDR_LO
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|rd_ctrl
operator|=
name|htole32
argument_list|(
name|buf_idx
operator|&
name|ET_RDCTRL_BUFIDX_MASK
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_dtag
argument_list|,
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_rxbuf_discard
parameter_list|(
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
parameter_list|,
name|int
name|buf_idx
parameter_list|)
block|{
name|struct
name|et_rxdesc
modifier|*
name|desc
decl_stmt|;
name|desc
operator|=
operator|&
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_desc
index|[
name|buf_idx
index|]
expr_stmt|;
name|desc
operator|->
name|rd_ctrl
operator|=
name|htole32
argument_list|(
name|buf_idx
operator|&
name|ET_RDCTRL_BUFIDX_MASK
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_dtag
argument_list|,
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_newbuf_hdr
parameter_list|(
name|struct
name|et_rxbuf_data
modifier|*
name|rbd
parameter_list|,
name|int
name|buf_idx
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|et_rxdesc
modifier|*
name|desc
decl_stmt|;
name|struct
name|et_rxbuf
modifier|*
name|rb
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|bus_dmamap_t
name|dmap
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|MPASS
argument_list|(
name|buf_idx
operator|<
name|ET_RX_NDESC
argument_list|)
expr_stmt|;
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MHLEN
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|ETHER_ALIGN
argument_list|)
expr_stmt|;
name|sc
operator|=
name|rbd
operator|->
name|rbd_softc
expr_stmt|;
name|rb
operator|=
operator|&
name|rbd
operator|->
name|rbd_buf
index|[
name|buf_idx
index|]
expr_stmt|;
if|if
condition|(
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|sc
operator|->
name|sc_rx_mini_sparemap
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: %d segments returned!"
operator|,
name|__func__
operator|,
name|nsegs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rb
operator|->
name|rb_mbuf
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|)
expr_stmt|;
block|}
name|dmap
operator|=
name|rb
operator|->
name|rb_dmap
expr_stmt|;
name|rb
operator|->
name|rb_dmap
operator|=
name|sc
operator|->
name|sc_rx_mini_sparemap
expr_stmt|;
name|sc
operator|->
name|sc_rx_mini_sparemap
operator|=
name|dmap
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|sc_rx_mini_tag
argument_list|,
name|rb
operator|->
name|rb_dmap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|rb
operator|->
name|rb_mbuf
operator|=
name|m
expr_stmt|;
name|desc
operator|=
operator|&
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_desc
index|[
name|buf_idx
index|]
expr_stmt|;
name|desc
operator|->
name|rd_addr_hi
operator|=
name|htole32
argument_list|(
name|ET_ADDR_HI
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|rd_addr_lo
operator|=
name|htole32
argument_list|(
name|ET_ADDR_LO
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|rd_ctrl
operator|=
name|htole32
argument_list|(
name|buf_idx
operator|&
name|ET_RDCTRL_BUFIDX_MASK
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_dtag
argument_list|,
name|rbd
operator|->
name|rbd_ring
operator|->
name|rr_dmap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ET_SYSCTL_STAT_ADD32
parameter_list|(
name|c
parameter_list|,
name|h
parameter_list|,
name|n
parameter_list|,
name|p
parameter_list|,
name|d
parameter_list|)
define|\
value|SYSCTL_ADD_UINT(c, h, OID_AUTO, n, CTLFLAG_RD, p, 0, d)
end_define

begin_define
define|#
directive|define
name|ET_SYSCTL_STAT_ADD64
parameter_list|(
name|c
parameter_list|,
name|h
parameter_list|,
name|n
parameter_list|,
name|p
parameter_list|,
name|d
parameter_list|)
define|\
value|SYSCTL_ADD_UQUAD(c, h, OID_AUTO, n, CTLFLAG_RD, p, d)
end_define

begin_comment
comment|/*  * Create sysctl tree  */
end_comment

begin_function
specifier|static
name|void
name|et_add_sysctls
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|children
decl_stmt|,
modifier|*
name|parent
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
decl_stmt|;
name|struct
name|et_hw_stats
modifier|*
name|stats
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_intr_npkts"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|et_sysctl_rx_intr_npkts
argument_list|,
literal|"I"
argument_list|,
literal|"RX IM, # packets per RX interrupt"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_intr_delay"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|et_sysctl_rx_intr_delay
argument_list|,
literal|"I"
argument_list|,
literal|"RX IM, RX interrupt delay (x10 usec)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_intr_nsegs"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|sc
operator|->
name|sc_tx_intr_nsegs
argument_list|,
literal|0
argument_list|,
literal|"TX IM, # segments per TX interrupt"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"timer"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|sc
operator|->
name|sc_timer
argument_list|,
literal|0
argument_list|,
literal|"TX timer"
argument_list|)
expr_stmt|;
name|tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stats"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"ET statistics"
argument_list|)
expr_stmt|;
name|parent
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
expr_stmt|;
comment|/* TX/RX statistics. */
name|stats
operator|=
operator|&
name|sc
operator|->
name|sc_stats
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
literal|"frames_64"
argument_list|,
operator|&
name|stats
operator|->
name|pkts_64
argument_list|,
literal|"0 to 64 bytes frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
literal|"frames_65_127"
argument_list|,
operator|&
name|stats
operator|->
name|pkts_65
argument_list|,
literal|"65 to 127 bytes frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
literal|"frames_128_255"
argument_list|,
operator|&
name|stats
operator|->
name|pkts_128
argument_list|,
literal|"128 to 255 bytes frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
literal|"frames_256_511"
argument_list|,
operator|&
name|stats
operator|->
name|pkts_256
argument_list|,
literal|"256 to 511 bytes frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
literal|"frames_512_1023"
argument_list|,
operator|&
name|stats
operator|->
name|pkts_512
argument_list|,
literal|"512 to 1023 bytes frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
literal|"frames_1024_1518"
argument_list|,
operator|&
name|stats
operator|->
name|pkts_1024
argument_list|,
literal|"1024 to 1518 bytes frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
literal|"frames_1519_1522"
argument_list|,
operator|&
name|stats
operator|->
name|pkts_1519
argument_list|,
literal|"1519 to 1522 bytes frames"
argument_list|)
expr_stmt|;
comment|/* RX statistics. */
name|tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"RX MAC statistics"
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"bytes"
argument_list|,
operator|&
name|stats
operator|->
name|rx_bytes
argument_list|,
literal|"Good bytes"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"frames"
argument_list|,
operator|&
name|stats
operator|->
name|rx_frames
argument_list|,
literal|"Good frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"crc_errs"
argument_list|,
operator|&
name|stats
operator|->
name|rx_crcerrs
argument_list|,
literal|"CRC errors"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"mcast_frames"
argument_list|,
operator|&
name|stats
operator|->
name|rx_mcast
argument_list|,
literal|"Multicast frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"bcast_frames"
argument_list|,
operator|&
name|stats
operator|->
name|rx_bcast
argument_list|,
literal|"Broadcast frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"control"
argument_list|,
operator|&
name|stats
operator|->
name|rx_control
argument_list|,
literal|"Control frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"pause"
argument_list|,
operator|&
name|stats
operator|->
name|rx_pause
argument_list|,
literal|"Pause frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"unknown_control"
argument_list|,
operator|&
name|stats
operator|->
name|rx_unknown_control
argument_list|,
literal|"Unknown control frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"align_errs"
argument_list|,
operator|&
name|stats
operator|->
name|rx_alignerrs
argument_list|,
literal|"Alignment errors"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"len_errs"
argument_list|,
operator|&
name|stats
operator|->
name|rx_lenerrs
argument_list|,
literal|"Frames with length mismatched"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"code_errs"
argument_list|,
operator|&
name|stats
operator|->
name|rx_codeerrs
argument_list|,
literal|"Frames with code error"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"cs_errs"
argument_list|,
operator|&
name|stats
operator|->
name|rx_cserrs
argument_list|,
literal|"Frames with carrier sense error"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"runts"
argument_list|,
operator|&
name|stats
operator|->
name|rx_runts
argument_list|,
literal|"Too short frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"oversize"
argument_list|,
operator|&
name|stats
operator|->
name|rx_oversize
argument_list|,
literal|"Oversized frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"fragments"
argument_list|,
operator|&
name|stats
operator|->
name|rx_fragments
argument_list|,
literal|"Fragmented frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"jabbers"
argument_list|,
operator|&
name|stats
operator|->
name|rx_jabbers
argument_list|,
literal|"Frames with jabber error"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"drop"
argument_list|,
operator|&
name|stats
operator|->
name|rx_drop
argument_list|,
literal|"Dropped frames"
argument_list|)
expr_stmt|;
comment|/* TX statistics. */
name|tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"TX MAC statistics"
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"bytes"
argument_list|,
operator|&
name|stats
operator|->
name|tx_bytes
argument_list|,
literal|"Good bytes"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"frames"
argument_list|,
operator|&
name|stats
operator|->
name|tx_frames
argument_list|,
literal|"Good frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"mcast_frames"
argument_list|,
operator|&
name|stats
operator|->
name|tx_mcast
argument_list|,
literal|"Multicast frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"bcast_frames"
argument_list|,
operator|&
name|stats
operator|->
name|tx_bcast
argument_list|,
literal|"Broadcast frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"pause"
argument_list|,
operator|&
name|stats
operator|->
name|tx_pause
argument_list|,
literal|"Pause frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"deferred"
argument_list|,
operator|&
name|stats
operator|->
name|tx_deferred
argument_list|,
literal|"Deferred frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"excess_deferred"
argument_list|,
operator|&
name|stats
operator|->
name|tx_excess_deferred
argument_list|,
literal|"Excessively deferred frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"single_colls"
argument_list|,
operator|&
name|stats
operator|->
name|tx_single_colls
argument_list|,
literal|"Single collisions"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"multi_colls"
argument_list|,
operator|&
name|stats
operator|->
name|tx_multi_colls
argument_list|,
literal|"Multiple collisions"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"late_colls"
argument_list|,
operator|&
name|stats
operator|->
name|tx_late_colls
argument_list|,
literal|"Late collisions"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"excess_colls"
argument_list|,
operator|&
name|stats
operator|->
name|tx_excess_colls
argument_list|,
literal|"Excess collisions"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"total_colls"
argument_list|,
operator|&
name|stats
operator|->
name|tx_total_colls
argument_list|,
literal|"Total collisions"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"pause_honored"
argument_list|,
operator|&
name|stats
operator|->
name|tx_pause_honored
argument_list|,
literal|"Honored pause frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"drop"
argument_list|,
operator|&
name|stats
operator|->
name|tx_drop
argument_list|,
literal|"Dropped frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"jabbers"
argument_list|,
operator|&
name|stats
operator|->
name|tx_jabbers
argument_list|,
literal|"Frames with jabber errors"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"crc_errs"
argument_list|,
operator|&
name|stats
operator|->
name|tx_crcerrs
argument_list|,
literal|"Frames with CRC errors"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"control"
argument_list|,
operator|&
name|stats
operator|->
name|tx_control
argument_list|,
literal|"Control frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD64
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"oversize"
argument_list|,
operator|&
name|stats
operator|->
name|tx_oversize
argument_list|,
literal|"Oversized frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"undersize"
argument_list|,
operator|&
name|stats
operator|->
name|tx_undersize
argument_list|,
literal|"Undersized frames"
argument_list|)
expr_stmt|;
name|ET_SYSCTL_STAT_ADD32
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
literal|"fragments"
argument_list|,
operator|&
name|stats
operator|->
name|tx_fragments
argument_list|,
literal|"Fragmented frames"
argument_list|)
expr_stmt|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|ET_SYSCTL_STAT_ADD32
end_undef

begin_undef
undef|#
directive|undef
name|ET_SYSCTL_STAT_ADD64
end_undef

begin_function
specifier|static
name|int
name|et_sysctl_rx_intr_npkts
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|v
decl_stmt|;
name|v
operator|=
name|sc
operator|->
name|sc_rx_intr_npkts
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
goto|goto
name|back
goto|;
if|if
condition|(
name|v
operator|<=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|back
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rx_intr_npkts
operator|!=
name|v
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_INTR_NPKTS
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rx_intr_npkts
operator|=
name|v
expr_stmt|;
block|}
name|back
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_sysctl_rx_intr_delay
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|v
decl_stmt|;
name|v
operator|=
name|sc
operator|->
name|sc_rx_intr_delay
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|v
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
goto|goto
name|back
goto|;
if|if
condition|(
name|v
operator|<=
literal|0
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|back
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_rx_intr_delay
operator|!=
name|v
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|CSR_WRITE_4
argument_list|(
name|sc
argument_list|,
name|ET_RX_INTR_DELAY
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_rx_intr_delay
operator|=
name|v
expr_stmt|;
block|}
name|back
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|et_stats_update
parameter_list|(
name|struct
name|et_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|et_hw_stats
modifier|*
name|stats
decl_stmt|;
name|stats
operator|=
operator|&
name|sc
operator|->
name|sc_stats
expr_stmt|;
name|stats
operator|->
name|pkts_64
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_PKTS_64
argument_list|)
expr_stmt|;
name|stats
operator|->
name|pkts_65
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_PKTS_65_127
argument_list|)
expr_stmt|;
name|stats
operator|->
name|pkts_128
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_PKTS_128_255
argument_list|)
expr_stmt|;
name|stats
operator|->
name|pkts_256
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_PKTS_256_511
argument_list|)
expr_stmt|;
name|stats
operator|->
name|pkts_512
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_PKTS_512_1023
argument_list|)
expr_stmt|;
name|stats
operator|->
name|pkts_1024
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_PKTS_1024_1518
argument_list|)
expr_stmt|;
name|stats
operator|->
name|pkts_1519
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_PKTS_1519_1522
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_bytes
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_BYTES
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_frames
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_FRAMES
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_crcerrs
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_CRC_ERR
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_mcast
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_MCAST
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_bcast
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_BCAST
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_control
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_CTL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_pause
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_PAUSE
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_unknown_control
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_UNKNOWN_CTL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_alignerrs
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_ALIGN_ERR
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_lenerrs
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_LEN_ERR
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_codeerrs
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_CODE_ERR
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_cserrs
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_CS_ERR
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_runts
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_RUNT
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_oversize
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_OVERSIZE
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_fragments
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_FRAG
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_jabbers
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_JABBER
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rx_drop
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_RX_DROP
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_bytes
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_BYTES
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_frames
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_FRAMES
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_mcast
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_MCAST
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_bcast
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_BCAST
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_pause
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_PAUSE
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_deferred
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_DEFER
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_excess_deferred
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_EXCESS_DEFER
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_single_colls
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_SINGLE_COL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_multi_colls
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_MULTI_COL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_late_colls
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_LATE_COL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_excess_colls
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_EXCESS_COL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_total_colls
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_TOTAL_COL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_pause_honored
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_PAUSE_HONOR
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_drop
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_DROP
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_jabbers
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_JABBER
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_crcerrs
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_CRC_ERR
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_control
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_CTL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_oversize
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_OVERSIZE
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_undersize
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_UNDERSIZE
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_fragments
operator|+=
name|CSR_READ_4
argument_list|(
name|sc
argument_list|,
name|ET_STAT_TX_FRAG
argument_list|)
expr_stmt|;
comment|/* Update ifnet counters. */
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|=
operator|(
name|u_long
operator|)
name|stats
operator|->
name|tx_frames
expr_stmt|;
name|ifp
operator|->
name|if_collisions
operator|=
name|stats
operator|->
name|tx_total_colls
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|=
name|stats
operator|->
name|tx_drop
operator|+
name|stats
operator|->
name|tx_jabbers
operator|+
name|stats
operator|->
name|tx_crcerrs
operator|+
name|stats
operator|->
name|tx_excess_deferred
operator|+
name|stats
operator|->
name|tx_late_colls
expr_stmt|;
name|ifp
operator|->
name|if_ipackets
operator|=
operator|(
name|u_long
operator|)
name|stats
operator|->
name|rx_frames
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|=
name|stats
operator|->
name|rx_crcerrs
operator|+
name|stats
operator|->
name|rx_alignerrs
operator|+
name|stats
operator|->
name|rx_lenerrs
operator|+
name|stats
operator|->
name|rx_codeerrs
operator|+
name|stats
operator|->
name|rx_cserrs
operator|+
name|stats
operator|->
name|rx_runts
operator|+
name|stats
operator|->
name|rx_jabbers
operator|+
name|stats
operator|->
name|rx_drop
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
name|et_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|et_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|et_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ET_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|!=
literal|0
condition|)
name|et_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ET_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


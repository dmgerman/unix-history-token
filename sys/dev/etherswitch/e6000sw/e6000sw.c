begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Semihalf  * Copyright (c) 2015 Stormshield  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<arm/mv/mvwin.h>
end_include

begin_include
include|#
directive|include
file|<arm/mv/mvreg.h>
end_include

begin_include
include|#
directive|include
file|<arm/mv/mvvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/etherswitch/etherswitch.h>
end_include

begin_include
include|#
directive|include
file|<dev/mdio/mdio.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/mge/if_mgevar.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|"e6000swreg.h"
end_include

begin_include
include|#
directive|include
file|"etherswitch_if.h"
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_include
include|#
directive|include
file|"mdio_if.h"
end_include

begin_expr_stmt
name|MALLOC_DECLARE
argument_list|(
name|M_E6000SW
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_E6000SW
argument_list|,
literal|"e6000sw"
argument_list|,
literal|"e6000sw switch"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|E6000SW_LOCK
parameter_list|(
name|_sc
parameter_list|)
define|\
value|sx_xlock(&(_sc)->sx)
end_define

begin_define
define|#
directive|define
name|E6000SW_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
define|\
value|sx_unlock(&(_sc)->sx)
end_define

begin_define
define|#
directive|define
name|E6000SW_LOCK_ASSERT
parameter_list|(
name|_sc
parameter_list|,
name|_what
parameter_list|)
define|\
value|sx_assert(&(_sc)->sx, (_what))
end_define

begin_define
define|#
directive|define
name|E6000SW_TRYLOCK
parameter_list|(
name|_sc
parameter_list|)
define|\
value|sx_tryxlock(&(_sc)->sx)
end_define

begin_typedef
typedef|typedef
struct|struct
name|e6000sw_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|struct
name|sx
name|sx
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
index|[
name|E6000SW_MAX_PORTS
index|]
decl_stmt|;
name|char
modifier|*
name|ifname
index|[
name|E6000SW_MAX_PORTS
index|]
decl_stmt|;
name|device_t
name|miibus
index|[
name|E6000SW_MAX_PORTS
index|]
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
index|[
name|E6000SW_MAX_PORTS
index|]
decl_stmt|;
name|struct
name|callout
name|tick_callout
decl_stmt|;
name|uint32_t
name|cpuports_mask
decl_stmt|;
name|uint32_t
name|fixed_mask
decl_stmt|;
name|int
name|sw_addr
decl_stmt|;
name|int
name|num_ports
decl_stmt|;
name|boolean_t
name|multi_chip
decl_stmt|;
name|int
name|vid
index|[
name|E6000SW_NUM_VGROUPS
index|]
decl_stmt|;
name|int
name|members
index|[
name|E6000SW_NUM_VGROUPS
index|]
decl_stmt|;
name|int
name|vgroup
index|[
name|E6000SW_MAX_PORTS
index|]
decl_stmt|;
block|}
name|e6000sw_softc_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|etherswitch_info_t
name|etherswitch_info
init|=
block|{
operator|.
name|es_nports
operator|=
literal|0
block|,
operator|.
name|es_nvlangroups
operator|=
name|E6000SW_NUM_VGROUPS
block|,
operator|.
name|es_name
operator|=
literal|"Marvell 6000 series switch"
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|e6000sw_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_readphy
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_writephy
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|etherswitch_info_t
modifier|*
name|e6000sw_getinfo
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e6000sw_lock
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e6000sw_unlock
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_getport
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_port_t
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_setport
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_port_t
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_readreg_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|addr_reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_writereg_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|addr_reg
parameter_list|,
name|int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_readphy_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_writephy_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_getvgroup_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_setvgroup_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_setvgroup
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_getvgroup
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e6000sw_setup
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e6000sw_port_vlan_conf
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e6000sw_tick
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e6000sw_set_atustat
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|bin
parameter_list|,
name|int
name|flag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_atu_flush
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|flag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|void
name|e6000sw_writereg
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|addr
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|uint32_t
name|e6000sw_readreg
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|addr
parameter_list|,
name|int
name|reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|e6000sw_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_atu_mac_table
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|struct
name|atu_opt
modifier|*
name|atu
parameter_list|,
name|int
name|flag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_get_pvid
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|,
name|int
modifier|*
name|pvid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|e6000sw_set_pvid
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|pvid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|int
name|e6000sw_is_cpuport
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|int
name|e6000sw_is_fixedport
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|int
name|e6000sw_is_phyport
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
specifier|static
name|__inline
expr|struct
name|mii_data
operator|*
name|e6000sw_miiforphy
argument_list|(
argument|e6000sw_softc_t *sc
argument_list|,
argument|unsigned int phy
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|proc
modifier|*
name|e6000sw_kproc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|e6000sw_methods
index|[]
init|=
block|{
comment|/* device interface */
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|e6000sw_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|e6000sw_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|e6000sw_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|e6000sw_detach
argument_list|)
block|,
comment|/* bus interface */
name|DEVMETHOD
argument_list|(
name|bus_add_child
argument_list|,
name|device_add_child_ordered
argument_list|)
block|,
comment|/* mii interface */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|e6000sw_readphy
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|e6000sw_writephy
argument_list|)
block|,
comment|/* etherswitch interface */
name|DEVMETHOD
argument_list|(
name|etherswitch_getinfo
argument_list|,
name|e6000sw_getinfo
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_lock
argument_list|,
name|e6000sw_lock
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_unlock
argument_list|,
name|e6000sw_unlock
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_getport
argument_list|,
name|e6000sw_getport
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_setport
argument_list|,
name|e6000sw_setport
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_readreg
argument_list|,
name|e6000sw_readreg_wrapper
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_writereg
argument_list|,
name|e6000sw_writereg_wrapper
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_readphyreg
argument_list|,
name|e6000sw_readphy_wrapper
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_writephyreg
argument_list|,
name|e6000sw_writephy_wrapper
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_setvgroup
argument_list|,
name|e6000sw_setvgroup_wrapper
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|etherswitch_getvgroup
argument_list|,
name|e6000sw_getvgroup_wrapper
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|e6000sw_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DEFINE_CLASS_0
argument_list|(
name|e6000sw
argument_list|,
name|e6000sw_driver
argument_list|,
name|e6000sw_methods
argument_list|,
sizeof|sizeof
argument_list|(
name|e6000sw_softc_t
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|e6000sw
argument_list|,
name|mdio
argument_list|,
name|e6000sw_driver
argument_list|,
name|e6000sw_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|etherswitch
argument_list|,
name|e6000sw
argument_list|,
name|etherswitch_driver
argument_list|,
name|etherswitch_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|e6000sw
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|e6000sw
argument_list|,
name|mdio
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|SMI_CMD
value|0
end_define

begin_define
define|#
directive|define
name|SMI_CMD_BUSY
value|(1<<15)
end_define

begin_define
define|#
directive|define
name|SMI_CMD_OP_READ
value|((2<<10)|SMI_CMD_BUSY|(1<<12))
end_define

begin_define
define|#
directive|define
name|SMI_CMD_OP_WRITE
value|((1<<10)|SMI_CMD_BUSY|(1<<12))
end_define

begin_define
define|#
directive|define
name|SMI_DATA
value|1
end_define

begin_define
define|#
directive|define
name|MDIO_READ
parameter_list|(
name|dev
parameter_list|,
name|addr
parameter_list|,
name|reg
parameter_list|)
value|MDIO_READREG(device_get_parent(dev), (addr), (reg))
end_define

begin_define
define|#
directive|define
name|MDIO_WRITE
parameter_list|(
name|dev
parameter_list|,
name|addr
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|MDIO_WRITEREG(device_get_parent(dev), (addr), (reg), (val))
end_define

begin_function
specifier|static
name|void
name|e6000sw_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
if|if
condition|(
name|device_find_child
argument_list|(
name|parent
argument_list|,
literal|"e6000sw"
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|NULL
condition|)
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
literal|"e6000sw"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
specifier|const
name|char
modifier|*
name|description
decl_stmt|;
name|unsigned
name|int
name|id
decl_stmt|;
name|phandle_t
name|dsa_node
decl_stmt|,
name|switch_node
decl_stmt|;
name|dsa_node
operator|=
name|fdt_find_compatible
argument_list|(
name|OF_finddevice
argument_list|(
literal|"/"
argument_list|)
argument_list|,
literal|"marvell,dsa"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|switch_node
operator|=
name|OF_child
argument_list|(
name|dsa_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|switch_node
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
name|e6000sw_softc_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|node
operator|=
name|switch_node
expr_stmt|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|sc
operator|->
name|node
argument_list|,
literal|"reg"
argument_list|,
operator|&
name|sc
operator|->
name|sw_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sw_addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|sw_addr
operator|!=
literal|0
operator|&&
operator|(
name|sc
operator|->
name|sw_addr
operator|%
literal|2
operator|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|multi_chip
operator|=
name|true
expr_stmt|;
comment|/* Lock is necessary due to assertions. */
name|sx_init
argument_list|(
operator|&
name|sc
operator|->
name|sx
argument_list|,
literal|"e6000sw"
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|id
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
literal|0
argument_list|)
argument_list|,
name|SWITCH_ID
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|id
operator|&
literal|0xfff0
condition|)
block|{
case|case
literal|0x3520
case|:
name|description
operator|=
literal|"Marvell 88E6352"
expr_stmt|;
break|break;
case|case
literal|0x1720
case|:
name|description
operator|=
literal|"Marvell 88E6172"
expr_stmt|;
break|break;
case|case
literal|0x1760
case|:
name|description
operator|=
literal|"Marvell 88E6176"
expr_stmt|;
break|break;
default|default:
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sx
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unrecognized device, id 0x%x.\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|description
argument_list|)
expr_stmt|;
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_parse_child_fdt
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|phandle_t
name|child
parameter_list|,
name|uint32_t
modifier|*
name|fixed_mask
parameter_list|,
name|uint32_t
modifier|*
name|cpu_mask
parameter_list|,
name|int
modifier|*
name|pport
parameter_list|,
name|int
modifier|*
name|pvlangroup
parameter_list|)
block|{
name|char
name|portlabel
index|[
literal|100
index|]
decl_stmt|;
name|uint32_t
name|port
decl_stmt|,
name|vlangroup
decl_stmt|;
name|boolean_t
name|fixed_link
decl_stmt|;
if|if
condition|(
name|fixed_mask
operator|==
name|NULL
operator|||
name|cpu_mask
operator|==
name|NULL
operator|||
name|pport
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|OF_getprop
argument_list|(
name|child
argument_list|,
literal|"label"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|portlabel
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|OF_getencprop
argument_list|(
name|child
argument_list|,
literal|"reg"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|port
argument_list|,
sizeof|sizeof
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|child
argument_list|,
literal|"vlangroup"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|vlangroup
argument_list|,
sizeof|sizeof
argument_list|(
name|vlangroup
argument_list|)
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|vlangroup
operator|>=
name|E6000SW_NUM_VGROUPS
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
operator|*
name|pvlangroup
operator|=
name|vlangroup
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pvlangroup
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|port
operator|>=
name|E6000SW_MAX_PORTS
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
operator|*
name|pport
operator|=
name|port
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|portlabel
argument_list|,
literal|"cpu"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"CPU port at %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
operator|*
name|cpu_mask
operator||=
operator|(
literal|1
operator|<<
name|port
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|fixed_link
operator|=
name|OF_child
argument_list|(
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|fixed_link
condition|)
block|{
operator|*
name|fixed_mask
operator||=
operator|(
literal|1
operator|<<
name|port
operator|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"fixed port at %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"PHY at %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_init_interface
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|char
name|name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
name|IFNAMSIZ
argument_list|,
literal|"%sport"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ifp
index|[
name|port
index|]
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifp
index|[
name|port
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|sc
operator|->
name|ifp
index|[
name|port
index|]
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|ifp
index|[
name|port
index|]
operator|->
name|if_flags
operator||=
name|IFF_UP
operator||
name|IFF_BROADCAST
operator||
name|IFF_DRV_RUNNING
operator||
name|IFF_SIMPLEX
expr_stmt|;
name|sc
operator|->
name|ifname
index|[
name|port
index|]
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|,
name|M_E6000SW
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifname
index|[
name|port
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|memcpy
argument_list|(
name|sc
operator|->
name|ifname
index|[
name|port
index|]
argument_list|,
name|name
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|if_initname
argument_list|(
name|sc
operator|->
name|ifp
index|[
name|port
index|]
argument_list|,
name|sc
operator|->
name|ifname
index|[
name|port
index|]
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_attach_miibus
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mii_attach
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|miibus
index|[
name|port
index|]
argument_list|,
name|sc
operator|->
name|ifp
index|[
name|port
index|]
argument_list|,
name|e6000sw_ifmedia_upd
argument_list|,
name|e6000sw_ifmedia_sts
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|port
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|sc
operator|->
name|mii
index|[
name|port
index|]
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
index|[
name|port
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|phandle_t
name|child
decl_stmt|;
name|int
name|err
decl_stmt|,
name|port
decl_stmt|,
name|vlangroup
decl_stmt|;
name|int
name|member_ports
index|[
name|E6000SW_NUM_VGROUPS
index|]
decl_stmt|;
name|etherswitch_vlangroup_t
name|vg
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|multi_chip
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"multi-chip addressing mode\n"
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"single-chip addressing mode\n"
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|e6000sw_setup
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|member_ports
argument_list|,
sizeof|sizeof
argument_list|(
name|member_ports
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|child
operator|=
name|OF_child
argument_list|(
name|sc
operator|->
name|node
argument_list|)
init|;
name|child
operator|!=
literal|0
condition|;
name|child
operator|=
name|OF_peer
argument_list|(
name|child
argument_list|)
control|)
block|{
name|err
operator|=
name|e6000sw_parse_child_fdt
argument_list|(
name|dev
argument_list|,
name|child
argument_list|,
operator|&
name|sc
operator|->
name|fixed_mask
argument_list|,
operator|&
name|sc
operator|->
name|cpuports_mask
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|vlangroup
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to parse DTS\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_fail
goto|;
block|}
if|if
condition|(
name|vlangroup
operator|!=
operator|-
literal|1
condition|)
name|member_ports
index|[
name|vlangroup
index|]
operator||=
operator|(
literal|1
operator|<<
name|port
operator|)
expr_stmt|;
name|sc
operator|->
name|num_ports
operator|++
expr_stmt|;
name|err
operator|=
name|e6000sw_init_interface
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to init interface\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_fail
goto|;
block|}
comment|/* Don't attach miibus at CPU/fixed ports */
if|if
condition|(
operator|!
name|e6000sw_is_phyport
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
condition|)
continue|continue;
name|err
operator|=
name|e6000sw_attach_miibus
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to attach miibus\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_fail
goto|;
block|}
block|}
name|etherswitch_info
operator|.
name|es_nports
operator|=
name|sc
operator|->
name|num_ports
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|port
operator|++
control|)
name|sc
operator|->
name|vgroup
index|[
name|port
index|]
operator|=
name|E6000SW_PORT_NO_VGROUP
expr_stmt|;
comment|/* Set VLAN configuration */
name|e6000sw_port_vlan_conf
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set vlangroups */
for|for
control|(
name|vlangroup
operator|=
literal|0
init|;
name|vlangroup
operator|<
name|E6000SW_NUM_VGROUPS
condition|;
name|vlangroup
operator|++
control|)
if|if
condition|(
name|member_ports
index|[
name|vlangroup
index|]
operator|!=
literal|0
condition|)
block|{
name|vg
operator|.
name|es_vlangroup
operator|=
name|vg
operator|.
name|es_vid
operator|=
name|vlangroup
expr_stmt|;
name|vg
operator|.
name|es_member_ports
operator|=
name|vg
operator|.
name|es_untagged_ports
operator|=
name|member_ports
index|[
name|vlangroup
index|]
expr_stmt|;
name|e6000sw_setvgroup
argument_list|(
name|dev
argument_list|,
operator|&
name|vg
argument_list|)
expr_stmt|;
block|}
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bus_generic_probe
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|kproc_create
argument_list|(
name|e6000sw_tick
argument_list|,
name|sc
argument_list|,
operator|&
name|e6000sw_kproc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|"e6000sw tick kproc"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|out_fail
label|:
name|e6000sw_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|e6000sw_poll_done
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|)
block|{
while|while
condition|(
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|PHY_CMD
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|PHY_CMD_SMI_BUSY
operator|)
condition|)
continue|continue;
block|}
end_function

begin_comment
comment|/*  * PHY registers are paged. Put page index in reg 22 (accessible from every  * page), then access specific register.  */
end_comment

begin_function
specifier|static
name|int
name|e6000sw_readphy
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|e6000sw_is_phyport
argument_list|(
name|sc
argument_list|,
name|phy
argument_list|)
operator|||
name|reg
operator|>=
name|E6000SW_NUM_PHY_REGS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Wrong register address.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_XLOCKED
argument_list|)
expr_stmt|;
name|e6000sw_poll_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator||=
literal|1
operator|<<
name|PHY_CMD_SMI_BUSY
expr_stmt|;
name|val
operator||=
name|PHY_CMD_MODE_MDIO
operator|<<
name|PHY_CMD_MODE
expr_stmt|;
name|val
operator||=
name|PHY_CMD_OPCODE_READ
operator|<<
name|PHY_CMD_OPCODE
expr_stmt|;
name|val
operator||=
operator|(
name|reg
operator|<<
name|PHY_CMD_REG_ADDR
operator|)
operator|&
name|PHY_CMD_REG_ADDR_MASK
expr_stmt|;
name|val
operator||=
operator|(
name|phy
operator|<<
name|PHY_CMD_DEV_ADDR
operator|)
operator|&
name|PHY_CMD_DEV_ADDR_MASK
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|SMI_PHY_CMD_REG
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|e6000sw_poll_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|SMI_PHY_DATA_REG
argument_list|)
operator|&
name|PHY_DATA_MASK
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_writephy
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|e6000sw_is_phyport
argument_list|(
name|sc
argument_list|,
name|phy
argument_list|)
operator|||
name|reg
operator|>=
name|E6000SW_NUM_PHY_REGS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Wrong register address.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_XLOCKED
argument_list|)
expr_stmt|;
name|e6000sw_poll_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator||=
name|PHY_CMD_MODE_MDIO
operator|<<
name|PHY_CMD_MODE
expr_stmt|;
name|val
operator||=
literal|1
operator|<<
name|PHY_CMD_SMI_BUSY
expr_stmt|;
name|val
operator||=
name|PHY_CMD_OPCODE_WRITE
operator|<<
name|PHY_CMD_OPCODE
expr_stmt|;
name|val
operator||=
operator|(
name|reg
operator|<<
name|PHY_CMD_REG_ADDR
operator|)
operator|&
name|PHY_CMD_REG_ADDR_MASK
expr_stmt|;
name|val
operator||=
operator|(
name|phy
operator|<<
name|PHY_CMD_DEV_ADDR
operator|)
operator|&
name|PHY_CMD_DEV_ADDR_MASK
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|SMI_PHY_DATA_REG
argument_list|,
name|data
operator|&
name|PHY_DATA_MASK
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|SMI_PHY_CMD_REG
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|e6000sw_poll_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|phy
decl_stmt|;
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|sx
argument_list|)
expr_stmt|;
for|for
control|(
name|phy
operator|=
literal|0
init|;
name|phy
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|phy
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|miibus
index|[
name|phy
index|]
operator|!=
name|NULL
condition|)
name|device_delete_child
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|miibus
index|[
name|phy
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifp
index|[
name|phy
index|]
operator|!=
name|NULL
condition|)
name|if_free
argument_list|(
name|sc
operator|->
name|ifp
index|[
name|phy
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifname
index|[
name|phy
index|]
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|sc
operator|->
name|ifname
index|[
name|phy
index|]
argument_list|,
name|M_E6000SW
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|etherswitch_info_t
modifier|*
name|e6000sw_getinfo
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
operator|&
name|etherswitch_info
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|e6000sw_lock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|e6000sw_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|e6000sw_unlock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|e6000sw_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_XLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_getport
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_port_t
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|ifmediareq
modifier|*
name|ifmr
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|e6000sw_softc_t
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|es_port
operator|>=
name|sc
operator|->
name|num_ports
operator|||
name|p
operator|->
name|es_port
operator|<
literal|0
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|e6000sw_get_pvid
argument_list|(
name|sc
argument_list|,
name|p
operator|->
name|es_port
argument_list|,
operator|&
name|p
operator|->
name|es_pvid
argument_list|)
expr_stmt|;
if|if
condition|(
name|e6000sw_is_cpuport
argument_list|(
name|sc
argument_list|,
name|p
operator|->
name|es_port
argument_list|)
condition|)
block|{
name|p
operator|->
name|es_flags
operator||=
name|ETHERSWITCH_PORT_CPU
expr_stmt|;
name|ifmr
operator|=
operator|&
name|p
operator|->
name|es_ifmr
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_ACTIVE
operator||
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_count
operator|=
literal|0
expr_stmt|;
name|ifmr
operator|->
name|ifm_current
operator|=
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
operator||
name|IFM_1000_T
operator||
name|IFM_FDX
expr_stmt|;
name|ifmr
operator|->
name|ifm_mask
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|e6000sw_is_fixedport
argument_list|(
name|sc
argument_list|,
name|p
operator|->
name|es_port
argument_list|)
condition|)
block|{
name|ifmr
operator|=
operator|&
name|p
operator|->
name|es_ifmr
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_ACTIVE
operator||
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_count
operator|=
literal|0
expr_stmt|;
name|ifmr
operator|->
name|ifm_current
operator|=
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
operator||
name|IFM_1000_T
operator||
name|IFM_FDX
expr_stmt|;
name|ifmr
operator|->
name|ifm_mask
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|mii
operator|=
name|e6000sw_miiforphy
argument_list|(
name|sc
argument_list|,
name|p
operator|->
name|es_port
argument_list|)
expr_stmt|;
name|err
operator|=
name|ifmedia_ioctl
argument_list|(
name|mii
operator|->
name|mii_ifp
argument_list|,
operator|&
name|p
operator|->
name|es_ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|SIOCGIFMEDIA
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_setport
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_port_t
modifier|*
name|p
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|es_port
operator|>=
name|sc
operator|->
name|num_ports
operator|||
name|p
operator|->
name|es_port
operator|<
literal|0
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|p
operator|->
name|es_pvid
operator|!=
literal|0
condition|)
name|e6000sw_set_pvid
argument_list|(
name|sc
argument_list|,
name|p
operator|->
name|es_port
argument_list|,
name|p
operator|->
name|es_pvid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|e6000sw_is_cpuport
argument_list|(
name|sc
argument_list|,
name|p
operator|->
name|es_port
argument_list|)
condition|)
block|{
name|mii
operator|=
name|e6000sw_miiforphy
argument_list|(
name|sc
argument_list|,
name|p
operator|->
name|es_port
argument_list|)
expr_stmt|;
name|err
operator|=
name|ifmedia_ioctl
argument_list|(
name|mii
operator|->
name|mii_ifp
argument_list|,
operator|&
name|p
operator|->
name|es_ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|SIOCSIFMEDIA
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Registers in this switch are divided into sections, specified in  * documentation. So as to access any of them, section index and reg index  * is necessary. etherswitchcfg uses only one variable, so indexes were  * compressed into addr_reg: 32 * section_index + reg_index.  */
end_comment

begin_function
specifier|static
name|int
name|e6000sw_readreg_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|addr_reg
parameter_list|)
block|{
if|if
condition|(
operator|(
name|addr_reg
operator|>
operator|(
name|REG_GLOBAL2
operator|*
literal|32
operator|+
name|REG_NUM_MAX
operator|)
operator|)
operator|||
operator|(
name|addr_reg
operator|<
operator|(
name|REG_PORT
argument_list|(
literal|0
argument_list|)
operator|*
literal|32
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Wrong register address.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
name|e6000sw_readreg
argument_list|(
name|device_get_softc
argument_list|(
name|dev
argument_list|)
argument_list|,
name|addr_reg
operator|/
literal|32
argument_list|,
name|addr_reg
operator|%
literal|32
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_writereg_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|addr_reg
parameter_list|,
name|int
name|val
parameter_list|)
block|{
if|if
condition|(
operator|(
name|addr_reg
operator|>
operator|(
name|REG_GLOBAL2
operator|*
literal|32
operator|+
name|REG_NUM_MAX
operator|)
operator|)
operator|||
operator|(
name|addr_reg
operator|<
operator|(
name|REG_PORT
argument_list|(
literal|0
argument_list|)
operator|*
literal|32
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Wrong register address.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|e6000sw_writereg
argument_list|(
name|device_get_softc
argument_list|(
name|dev
argument_list|)
argument_list|,
name|addr_reg
operator|/
literal|5
argument_list|,
name|addr_reg
operator|%
literal|32
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * These wrappers are necessary because PHY accesses from etherswitchcfg  * need to be synchronized with locks, while miibus PHY accesses do not.  */
end_comment

begin_function
specifier|static
name|int
name|e6000sw_readphy_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ret
operator|=
name|e6000sw_readphy
argument_list|(
name|dev
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_writephy_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ret
operator|=
name|e6000sw_writephy
argument_list|(
name|dev
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * setvgroup/getvgroup called from etherswitchfcg need to be locked,  * while internal calls do not.  */
end_comment

begin_function
specifier|static
name|int
name|e6000sw_setvgroup_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ret
operator|=
name|e6000sw_setvgroup
argument_list|(
name|dev
argument_list|,
name|vg
argument_list|)
expr_stmt|;
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_getvgroup_wrapper
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ret
operator|=
name|e6000sw_getvgroup
argument_list|(
name|dev
argument_list|,
name|vg
argument_list|)
expr_stmt|;
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|e6000sw_flush_port
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VLAN_MAP
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|PORT_VLAN_MAP_TABLE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|PORT_VLAN_MAP_FID_MASK
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VLAN_MAP
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vgroup
index|[
name|port
index|]
operator|!=
name|E6000SW_PORT_NO_VGROUP
condition|)
block|{
comment|/* 		 * If port belonged somewhere, owner-group 		 * should have its entry removed. 		 */
name|sc
operator|->
name|members
index|[
name|sc
operator|->
name|vgroup
index|[
name|port
index|]
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|port
operator|)
expr_stmt|;
name|sc
operator|->
name|vgroup
index|[
name|port
index|]
operator|=
name|E6000SW_PORT_NO_VGROUP
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|e6000sw_port_assign_vgroup
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|fid
parameter_list|,
name|int
name|vgroup
parameter_list|,
name|int
name|members
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VLAN_MAP
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|PORT_VLAN_MAP_TABLE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|PORT_VLAN_MAP_FID_MASK
expr_stmt|;
name|reg
operator||=
name|members
operator|&
operator|~
operator|(
literal|1
operator|<<
name|port
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
name|fid
operator|<<
name|PORT_VLAN_MAP_FID
operator|)
operator|&
name|PORT_VLAN_MAP_FID_MASK
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VLAN_MAP
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vgroup
index|[
name|port
index|]
operator|=
name|vgroup
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_setvgroup
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|port
decl_stmt|,
name|fid
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_XLOCKED
argument_list|)
expr_stmt|;
if|if
condition|(
name|vg
operator|->
name|es_vlangroup
operator|>=
name|E6000SW_NUM_VGROUPS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|vg
operator|->
name|es_member_ports
operator|!=
name|vg
operator|->
name|es_untagged_ports
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Tagged ports not supported.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|vg
operator|->
name|es_untagged_ports
operator|&=
name|PORT_VLAN_MAP_TABLE_MASK
expr_stmt|;
name|fid
operator|=
name|vg
operator|->
name|es_vlangroup
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|port
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|members
index|[
name|vg
operator|->
name|es_vlangroup
index|]
operator|&
operator|(
literal|1
operator|<<
name|port
operator|)
operator|)
operator|||
operator|(
name|vg
operator|->
name|es_untagged_ports
operator|&
operator|(
literal|1
operator|<<
name|port
operator|)
operator|)
condition|)
name|e6000sw_flush_port
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|vg
operator|->
name|es_untagged_ports
operator|&
operator|(
literal|1
operator|<<
name|port
operator|)
condition|)
name|e6000sw_port_assign_vgroup
argument_list|(
name|sc
argument_list|,
name|port
argument_list|,
name|fid
argument_list|,
name|vg
operator|->
name|es_vlangroup
argument_list|,
name|vg
operator|->
name|es_untagged_ports
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|vid
index|[
name|vg
operator|->
name|es_vlangroup
index|]
operator|=
name|vg
operator|->
name|es_vid
expr_stmt|;
name|sc
operator|->
name|members
index|[
name|vg
operator|->
name|es_vlangroup
index|]
operator|=
name|vg
operator|->
name|es_untagged_ports
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_getvgroup
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|etherswitch_vlangroup_t
modifier|*
name|vg
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_XLOCKED
argument_list|)
expr_stmt|;
if|if
condition|(
name|vg
operator|->
name|es_vlangroup
operator|>=
name|E6000SW_NUM_VGROUPS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|vg
operator|->
name|es_untagged_ports
operator|=
name|vg
operator|->
name|es_member_ports
operator|=
name|sc
operator|->
name|members
index|[
name|vg
operator|->
name|es_vlangroup
index|]
expr_stmt|;
name|vg
operator|->
name|es_vid
operator|=
name|ETHERSWITCH_VID_VALID
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|__inline
expr|struct
name|mii_data
operator|*
name|e6000sw_miiforphy
argument_list|(
argument|e6000sw_softc_t *sc
argument_list|,
argument|unsigned int phy
argument_list|)
block|{
if|if
condition|(
operator|!
name|e6000sw_is_phyport
argument_list|(
name|sc
argument_list|,
name|phy
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
end_expr_stmt

begin_return
return|return
operator|(
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
index|[
name|phy
index|]
argument_list|)
operator|)
return|;
end_return

begin_function
unit|}  static
name|int
name|e6000sw_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|mii
operator|=
name|e6000sw_miiforphy
argument_list|(
name|sc
argument_list|,
name|ifp
operator|->
name|if_dunit
argument_list|)
expr_stmt|;
if|if
condition|(
name|mii
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|e6000sw_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|mii
operator|=
name|e6000sw_miiforphy
argument_list|(
name|sc
argument_list|,
name|ifp
operator|->
name|if_dunit
argument_list|)
expr_stmt|;
if|if
condition|(
name|mii
operator|==
name|NULL
condition|)
return|return;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_smi_waitready
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|phy
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|E6000SW_SMI_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|MDIO_READ
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|phy
argument_list|,
name|SMI_CMD
argument_list|)
operator|&
name|SMI_CMD_BUSY
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|uint32_t
name|e6000sw_readreg
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|addr
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_XLOCKED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|multi_chip
condition|)
return|return
operator|(
name|MDIO_READ
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|addr
argument_list|,
name|reg
argument_list|)
operator|&
literal|0xffff
operator|)
return|;
if|if
condition|(
name|e6000sw_smi_waitready
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"e6000sw: readreg timeout\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffff
operator|)
return|;
block|}
name|MDIO_WRITE
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|,
name|SMI_CMD
argument_list|,
name|SMI_CMD_OP_READ
operator||
operator|(
name|addr
operator|<<
literal|5
operator|)
operator||
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|e6000sw_smi_waitready
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"e6000sw: readreg timeout\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xffff
operator|)
return|;
block|}
return|return
operator|(
name|MDIO_READ
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|,
name|SMI_DATA
argument_list|)
operator|&
literal|0xffff
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|e6000sw_writereg
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|addr
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_XLOCKED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|multi_chip
condition|)
block|{
name|MDIO_WRITE
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|addr
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|e6000sw_smi_waitready
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"e6000sw: readreg timeout\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|MDIO_WRITE
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|,
name|SMI_DATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MDIO_WRITE
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|,
name|SMI_CMD
argument_list|,
name|SMI_CMD_OP_WRITE
operator||
operator|(
name|addr
operator|<<
literal|5
operator|)
operator||
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|e6000sw_smi_waitready
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sw_addr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"e6000sw: readreg timeout\n"
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|e6000sw_is_cpuport
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
block|{
return|return
operator|(
name|sc
operator|->
name|cpuports_mask
operator|&
operator|(
literal|1
operator|<<
name|port
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|e6000sw_is_fixedport
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
block|{
return|return
operator|(
name|sc
operator|->
name|fixed_mask
operator|&
operator|(
literal|1
operator|<<
name|port
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|e6000sw_is_phyport
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|uint32_t
name|phy_mask
decl_stmt|;
name|phy_mask
operator|=
operator|~
operator|(
name|sc
operator|->
name|fixed_mask
operator||
name|sc
operator|->
name|cpuports_mask
operator|)
expr_stmt|;
return|return
operator|(
name|phy_mask
operator|&
operator|(
literal|1
operator|<<
name|port
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|e6000sw_set_pvid
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|,
name|int
name|pvid
parameter_list|)
block|{
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VID
argument_list|,
name|pvid
operator|&
name|PORT_VID_DEF_VID_MASK
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|e6000sw_get_pvid
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|port
parameter_list|,
name|int
modifier|*
name|pvid
parameter_list|)
block|{
if|if
condition|(
name|pvid
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
operator|*
name|pvid
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VID
argument_list|)
operator|&
name|PORT_VID_DEF_VID_MASK
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|e6000sw_tick
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|e6000sw_softc_t
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_softc
modifier|*
name|miisc
decl_stmt|;
name|int
name|port
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|E6000SW_LOCK_ASSERT
argument_list|(
name|sc
argument_list|,
name|SA_UNLOCKED
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|E6000SW_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|port
operator|++
control|)
block|{
comment|/* Tick only on PHY ports */
if|if
condition|(
operator|!
name|e6000sw_is_phyport
argument_list|(
name|sc
argument_list|,
name|port
argument_list|)
condition|)
continue|continue;
name|mii_tick
argument_list|(
name|sc
operator|->
name|mii
index|[
name|port
index|]
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|miisc
argument_list|,
argument|&sc->mii[port]->mii_phys
argument_list|,
argument|mii_list
argument_list|)
block|{
if|if
condition|(
name|IFM_INST
argument_list|(
name|sc
operator|->
name|mii
index|[
name|port
index|]
operator|->
name|mii_media
operator|.
name|ifm_cur
operator|->
name|ifm_media
argument_list|)
operator|!=
name|miisc
operator|->
name|mii_inst
condition|)
continue|continue;
name|mii_phy_update
argument_list|(
name|miisc
argument_list|,
name|MII_POLLSTAT
argument_list|)
expr_stmt|;
block|}
block|}
name|E6000SW_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|pause
argument_list|(
literal|"e6000sw tick"
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|e6000sw_setup
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|atu_ctrl
decl_stmt|,
name|atu_age
decl_stmt|;
comment|/* Set aging time */
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_CONTROL
argument_list|,
operator|(
name|E6000SW_DEFAULT_AGETIME
operator|<<
name|ATU_CONTROL_AGETIME
operator|)
operator||
operator|(
literal|1
operator|<<
name|ATU_CONTROL_LEARN2ALL
operator|)
argument_list|)
expr_stmt|;
comment|/* Send all with specific mac address to cpu port */
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|MGMT_EN_2x
argument_list|,
name|MGMT_EN_ALL
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|MGMT_EN_0x
argument_list|,
name|MGMT_EN_ALL
argument_list|)
expr_stmt|;
comment|/* Disable Remote Management */
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|SWITCH_GLOBAL_CONTROL2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable loopback filter and flow control messages */
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|SWITCH_MGMT
argument_list|,
name|SWITCH_MGMT_PRI_MASK
operator||
operator|(
literal|1
operator|<<
name|SWITCH_MGMT_RSVD2CPU
operator|)
operator||
name|SWITCH_MGMT_FC_PRI_MASK
operator||
operator|(
literal|1
operator|<<
name|SWITCH_MGMT_FORCEFLOW
operator|)
argument_list|)
expr_stmt|;
name|e6000sw_atu_flush
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
name|NO_OPERATION
argument_list|)
expr_stmt|;
name|e6000sw_atu_mac_table
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
name|NULL
argument_list|,
name|NO_OPERATION
argument_list|)
expr_stmt|;
name|e6000sw_set_atustat
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|COUNT_ALL
argument_list|)
expr_stmt|;
comment|/* Set ATU AgeTime to 15 seconds */
name|atu_age
operator|=
literal|1
expr_stmt|;
name|atu_ctrl
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_CONTROL
argument_list|)
expr_stmt|;
comment|/* Set new AgeTime field */
name|atu_ctrl
operator|&=
operator|~
name|ATU_CONTROL_AGETIME_MASK
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_CONTROL
argument_list|,
name|atu_ctrl
operator||
operator|(
name|atu_age
operator|<<
name|ATU_CONTROL_AGETIME
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|e6000sw_port_vlan_conf
parameter_list|(
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|port
decl_stmt|,
name|ret
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|dev
expr_stmt|;
comment|/* Disable all ports */
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|port
operator|++
control|)
block|{
name|ret
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_CONTROL
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_CONTROL
argument_list|,
operator|(
name|ret
operator|&
operator|~
name|PORT_CONTROL_ENABLE
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Set port priority */
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|port
operator|++
control|)
block|{
name|ret
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VID
argument_list|)
expr_stmt|;
name|ret
operator|&=
operator|~
name|PORT_VID_PRIORITY_MASK
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VID
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
comment|/* Set VID map */
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|port
operator|++
control|)
block|{
name|ret
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VID
argument_list|)
expr_stmt|;
name|ret
operator|&=
operator|~
name|PORT_VID_DEF_VID_MASK
expr_stmt|;
name|ret
operator||=
operator|(
name|port
operator|+
literal|1
operator|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_VID
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
comment|/* Enable all ports */
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|sc
operator|->
name|num_ports
condition|;
name|port
operator|++
control|)
block|{
name|ret
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_CONTROL
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_PORT
argument_list|(
name|port
argument_list|)
argument_list|,
name|PORT_CONTROL
argument_list|,
operator|(
name|ret
operator||
name|PORT_CONTROL_ENABLE
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|e6000sw_set_atustat
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|bin
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|uint16_t
name|ret
decl_stmt|;
name|ret
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|ATU_STATS
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|ATU_STATS
argument_list|,
operator|(
name|bin
operator|<<
name|ATU_STATS_BIN
operator|)
operator||
operator|(
name|flag
operator|<<
name|ATU_STATS_FLAG
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_atu_mac_table
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|struct
name|atu_opt
modifier|*
name|atu
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|uint16_t
name|ret_opt
decl_stmt|;
name|uint16_t
name|ret_data
decl_stmt|;
name|int
name|retries
decl_stmt|;
if|if
condition|(
name|flag
operator|==
name|NO_OPERATION
condition|)
return|return
operator|(
literal|0
operator|)
return|;
elseif|else
if|if
condition|(
operator|(
name|flag
operator|&
operator|(
name|LOAD_FROM_FIB
operator||
name|PURGE_FROM_FIB
operator||
name|GET_NEXT_IN_FIB
operator||
name|GET_VIOLATION_DATA
operator||
name|CLEAR_VIOLATION_DATA
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Wrong Opcode for ATU operation\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|ret_opt
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_OPERATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_opt
operator|&
name|ATU_UNIT_BUSY
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ATU unit is busy, cannot access"
literal|"register\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|flag
operator|&
name|LOAD_FROM_FIB
condition|)
block|{
name|ret_data
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_DATA
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL2
argument_list|,
name|ATU_DATA
argument_list|,
operator|(
name|ret_data
operator|&
operator|~
name|ENTRY_STATE
operator|)
argument_list|)
expr_stmt|;
block|}
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_MAC_ADDR01
argument_list|,
name|atu
operator|->
name|mac_01
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_MAC_ADDR23
argument_list|,
name|atu
operator|->
name|mac_23
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_MAC_ADDR45
argument_list|,
name|atu
operator|->
name|mac_45
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_FID
argument_list|,
name|atu
operator|->
name|fid
argument_list|)
expr_stmt|;
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_OPERATION
argument_list|,
operator|(
name|ret_opt
operator||
name|ATU_UNIT_BUSY
operator||
name|flag
operator|)
argument_list|)
expr_stmt|;
name|retries
operator|=
name|E6000SW_RETRIES
expr_stmt|;
while|while
condition|(
operator|--
name|retries
operator|&
operator|(
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_OPERATION
argument_list|)
operator|&
name|ATU_UNIT_BUSY
operator|)
condition|)
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|retries
operator|==
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Timeout while flushing\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flag
operator|&
name|GET_NEXT_IN_FIB
condition|)
block|{
name|atu
operator|->
name|mac_01
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_MAC_ADDR01
argument_list|)
expr_stmt|;
name|atu
operator|->
name|mac_23
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_MAC_ADDR23
argument_list|)
expr_stmt|;
name|atu
operator|->
name|mac_45
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_MAC_ADDR45
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e6000sw_atu_flush
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|e6000sw_softc_t
modifier|*
name|sc
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|uint16_t
name|ret
decl_stmt|;
name|int
name|retries
decl_stmt|;
if|if
condition|(
name|flag
operator|==
name|NO_OPERATION
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ret
operator|=
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_OPERATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&
name|ATU_UNIT_BUSY
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Atu unit is busy, cannot flush\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
else|else
block|{
name|e6000sw_writereg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_OPERATION
argument_list|,
operator|(
name|ret
operator||
name|ATU_UNIT_BUSY
operator||
name|flag
operator|)
argument_list|)
expr_stmt|;
name|retries
operator|=
name|E6000SW_RETRIES
expr_stmt|;
while|while
condition|(
operator|--
name|retries
operator|&
operator|(
name|e6000sw_readreg
argument_list|(
name|sc
argument_list|,
name|REG_GLOBAL
argument_list|,
name|ATU_OPERATION
argument_list|)
operator|&
name|ATU_UNIT_BUSY
operator|)
condition|)
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|retries
operator|==
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Timeout while flushing\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


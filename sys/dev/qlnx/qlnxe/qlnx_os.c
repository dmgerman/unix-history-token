begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2017-2018 Cavium, Inc.   * All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * File: qlnx_os.c  * Author : David C Somayajulu, Cavium, Inc., San Jose, CA 95131.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"qlnx_os.h"
end_include

begin_include
include|#
directive|include
file|"bcm_osal.h"
end_include

begin_include
include|#
directive|include
file|"reg_addr.h"
end_include

begin_include
include|#
directive|include
file|"ecore_gtt_reg_addr.h"
end_include

begin_include
include|#
directive|include
file|"ecore.h"
end_include

begin_include
include|#
directive|include
file|"ecore_chain.h"
end_include

begin_include
include|#
directive|include
file|"ecore_status.h"
end_include

begin_include
include|#
directive|include
file|"ecore_hw.h"
end_include

begin_include
include|#
directive|include
file|"ecore_rt_defs.h"
end_include

begin_include
include|#
directive|include
file|"ecore_init_ops.h"
end_include

begin_include
include|#
directive|include
file|"ecore_int.h"
end_include

begin_include
include|#
directive|include
file|"ecore_cxt.h"
end_include

begin_include
include|#
directive|include
file|"ecore_spq.h"
end_include

begin_include
include|#
directive|include
file|"ecore_init_fw_funcs.h"
end_include

begin_include
include|#
directive|include
file|"ecore_sp_commands.h"
end_include

begin_include
include|#
directive|include
file|"ecore_dev_api.h"
end_include

begin_include
include|#
directive|include
file|"ecore_l2_api.h"
end_include

begin_include
include|#
directive|include
file|"ecore_mcp.h"
end_include

begin_include
include|#
directive|include
file|"ecore_hw_defs.h"
end_include

begin_include
include|#
directive|include
file|"mcp_public.h"
end_include

begin_include
include|#
directive|include
file|"ecore_iro.h"
end_include

begin_include
include|#
directive|include
file|"nvm_cfg.h"
end_include

begin_include
include|#
directive|include
file|"ecore_dev_api.h"
end_include

begin_include
include|#
directive|include
file|"ecore_dbg_fw_funcs.h"
end_include

begin_include
include|#
directive|include
file|"qlnx_ioctl.h"
end_include

begin_include
include|#
directive|include
file|"qlnx_def.h"
end_include

begin_include
include|#
directive|include
file|"qlnx_ver.h"
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_comment
comment|/*  * static functions  */
end_comment

begin_comment
comment|/*  * ioctl related functions  */
end_comment

begin_function_decl
specifier|static
name|void
name|qlnx_add_sysctls
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * main driver  */
end_comment

begin_function_decl
specifier|static
name|void
name|qlnx_release
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_fp_isr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_init_ifnet
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_init_locked
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_set_multi
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|add_multi
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_set_promisc
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_set_allmulti
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_stop
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_send
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m_headp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_get_ifq_snd_maxlen
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|qlnx_get_optics
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_link_output
modifier|*
name|if_link
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_qflush
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_alloc_parent_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_free_parent_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_alloc_tx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_free_tx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_alloc_rx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_free_rx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_get_mfw_version
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|mfw_ver
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_get_flash_size
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|flash_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_nic_setup
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|,
name|struct
name|ecore_pf_params
modifier|*
name|func_params
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_nic_start
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_slowpath_start
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_slowpath_stop
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_init_hw
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_set_id
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|,
name|char
name|name
index|[
name|NAME_SIZE
index|]
parameter_list|,
name|char
name|ver_str
index|[
name|VER_SIZE
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_unload
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_load
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_hw_set_multi
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|,
name|uint32_t
name|mcnt
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_dump_buf8
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|dbuf
parameter_list|,
name|uint32_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_alloc_rx_buffer
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_reuse_rx_data
parameter_list|(
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_update_rx_prod
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_set_rx_accept_filter
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
name|filter
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_grc_dumpsize
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|num_dwords
parameter_list|,
name|int
name|hwfn_index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_idle_chk_size
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|num_dwords
parameter_list|,
name|int
name|hwfn_index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_timer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_alloc_tx_br
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_free_tx_br
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_trigger_dump
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_tx_int
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_rx_int
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|int
name|budget
parameter_list|,
name|int
name|lro_enable
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_fp_taskqueue
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_sample_storm_stats
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_alloc_tpa_mbuf
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|rx_buf_size
parameter_list|,
name|struct
name|qlnx_agg_info
modifier|*
name|tpa
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qlnx_free_tpa_mbuf
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_agg_info
modifier|*
name|tpa
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
end_if

begin_function_decl
specifier|static
name|uint64_t
name|qlnx_get_counter
parameter_list|(
name|if_t
name|ifp
parameter_list|,
name|ift_counter
name|cnt
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Hooks to the Operating Systems  */
end_comment

begin_function_decl
specifier|static
name|int
name|qlnx_pci_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_pci_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qlnx_pci_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|qlnx_pci_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|qlnx_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|qlnx_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|qlnx_pci_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|qlnx_pci_driver
init|=
block|{
literal|"ql"
block|,
name|qlnx_pci_methods
block|,
sizeof|sizeof
argument_list|(
name|qlnx_host_t
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|qlnx_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|if_qlnxe
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|if_qlnxe
argument_list|,
name|pci
argument_list|,
name|qlnx_pci_driver
argument_list|,
name|qlnx_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|if_qlnxe
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|if_qlnxe
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_QLNXBUF
argument_list|,
literal|"qlnxbuf"
argument_list|,
literal|"Buffers for qlnx driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
name|qlnx_dev_str
index|[
literal|64
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|qlnx_ver_str
index|[
name|VER_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|qlnx_name_str
index|[
name|NAME_SIZE
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Some PCI Configuration Space Related Defines  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|PCI_VENDOR_QLOGIC
end_ifndef

begin_define
define|#
directive|define
name|PCI_VENDOR_QLOGIC
value|0x1077
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* 40G Adapter QLE45xxx*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|QLOGIC_PCI_DEVICE_ID_1634
end_ifndef

begin_define
define|#
directive|define
name|QLOGIC_PCI_DEVICE_ID_1634
value|0x1634
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* 100G Adapter QLE45xxx*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|QLOGIC_PCI_DEVICE_ID_1644
end_ifndef

begin_define
define|#
directive|define
name|QLOGIC_PCI_DEVICE_ID_1644
value|0x1644
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* 25G Adapter QLE45xxx*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|QLOGIC_PCI_DEVICE_ID_1656
end_ifndef

begin_define
define|#
directive|define
name|QLOGIC_PCI_DEVICE_ID_1656
value|0x1656
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* 50G Adapter QLE45xxx*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|QLOGIC_PCI_DEVICE_ID_1654
end_ifndef

begin_define
define|#
directive|define
name|QLOGIC_PCI_DEVICE_ID_1654
value|0x1654
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* 10G/25G/40G Adapter QLE41xxx*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|QLOGIC_PCI_DEVICE_ID_8070
end_ifndef

begin_define
define|#
directive|define
name|QLOGIC_PCI_DEVICE_ID_8070
value|0x8070
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|qlnx_valid_device
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|uint16_t
name|device_id
decl_stmt|;
name|device_id
operator|=
name|pci_get_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1634
operator|)
operator|||
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1644
operator|)
operator|||
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1656
operator|)
operator|||
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1654
operator|)
operator|||
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_8070
operator|)
condition|)
return|return
literal|0
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Name:	qlnx_pci_probe  * Function:	Validate the PCI device to be a QLA80XX device  */
end_comment

begin_function
specifier|static
name|int
name|qlnx_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|snprintf
argument_list|(
name|qlnx_ver_str
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_ver_str
argument_list|)
argument_list|,
literal|"v%d.%d.%d"
argument_list|,
name|QLNX_VERSION_MAJOR
argument_list|,
name|QLNX_VERSION_MINOR
argument_list|,
name|QLNX_VERSION_BUILD
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|qlnx_name_str
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_name_str
argument_list|)
argument_list|,
literal|"qlnx"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|!=
name|PCI_VENDOR_QLOGIC
condition|)
block|{
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
switch|switch
condition|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
name|QLOGIC_PCI_DEVICE_ID_1644
case|:
name|snprintf
argument_list|(
name|qlnx_dev_str
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_dev_str
argument_list|)
argument_list|,
literal|"%s v%d.%d.%d"
argument_list|,
literal|"Qlogic 100GbE PCI CNA Adapter-Ethernet Function"
argument_list|,
name|QLNX_VERSION_MAJOR
argument_list|,
name|QLNX_VERSION_MINOR
argument_list|,
name|QLNX_VERSION_BUILD
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|qlnx_dev_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|QLOGIC_PCI_DEVICE_ID_1634
case|:
name|snprintf
argument_list|(
name|qlnx_dev_str
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_dev_str
argument_list|)
argument_list|,
literal|"%s v%d.%d.%d"
argument_list|,
literal|"Qlogic 40GbE PCI CNA Adapter-Ethernet Function"
argument_list|,
name|QLNX_VERSION_MAJOR
argument_list|,
name|QLNX_VERSION_MINOR
argument_list|,
name|QLNX_VERSION_BUILD
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|qlnx_dev_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|QLOGIC_PCI_DEVICE_ID_1656
case|:
name|snprintf
argument_list|(
name|qlnx_dev_str
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_dev_str
argument_list|)
argument_list|,
literal|"%s v%d.%d.%d"
argument_list|,
literal|"Qlogic 25GbE PCI CNA Adapter-Ethernet Function"
argument_list|,
name|QLNX_VERSION_MAJOR
argument_list|,
name|QLNX_VERSION_MINOR
argument_list|,
name|QLNX_VERSION_BUILD
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|qlnx_dev_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|QLOGIC_PCI_DEVICE_ID_1654
case|:
name|snprintf
argument_list|(
name|qlnx_dev_str
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_dev_str
argument_list|)
argument_list|,
literal|"%s v%d.%d.%d"
argument_list|,
literal|"Qlogic 50GbE PCI CNA Adapter-Ethernet Function"
argument_list|,
name|QLNX_VERSION_MAJOR
argument_list|,
name|QLNX_VERSION_MINOR
argument_list|,
name|QLNX_VERSION_BUILD
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|qlnx_dev_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|QLOGIC_PCI_DEVICE_ID_8070
case|:
name|snprintf
argument_list|(
name|qlnx_dev_str
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_dev_str
argument_list|)
argument_list|,
literal|"%s v%d.%d.%d"
argument_list|,
literal|"Qlogic 10GbE/25GbE/40GbE PCI CNA (AH) "
literal|"Adapter-Ethernet Function"
argument_list|,
name|QLNX_VERSION_MAJOR
argument_list|,
name|QLNX_VERSION_MINOR
argument_list|,
name|QLNX_VERSION_BUILD
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|qlnx_dev_str
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_sp_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|int
name|i
decl_stmt|;
name|p_hwfn
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|p_hwfn
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: spurious slowpath intr\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|p_hwfn
operator|->
name|p_dev
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
name|i
index|]
operator|==
name|p_hwfn
condition|)
block|{
name|taskqueue_enqueue
argument_list|(
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
argument_list|,
operator|&
name|ha
operator|->
name|sp_task
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_sp_taskqueue
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|p_hwfn
operator|=
name|context
expr_stmt|;
if|if
condition|(
name|p_hwfn
operator|!=
name|NULL
condition|)
block|{
name|qlnx_sp_isr
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_create_sp_taskqueues
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint8_t
name|tq_name
index|[
literal|32
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|bzero
argument_list|(
name|tq_name
argument_list|,
sizeof|sizeof
argument_list|(
name|tq_name
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|tq_name
argument_list|,
sizeof|sizeof
argument_list|(
name|tq_name
argument_list|)
argument_list|,
literal|"ql_sp_tq_%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|ha
operator|->
name|sp_task
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
name|qlnx_sp_taskqueue
argument_list|,
name|p_hwfn
argument_list|)
expr_stmt|;
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
operator|=
name|taskqueue_create_fast
argument_list|(
name|tq_name
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s"
argument_list|,
name|tq_name
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"%p\n"
argument_list|,
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_destroy_sp_taskqueues
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|taskqueue_drain
argument_list|(
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
argument_list|,
operator|&
name|ha
operator|->
name|sp_task
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|ha
operator|->
name|sp_taskqueue
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_fp_taskqueue
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|thread
modifier|*
name|cthread
decl_stmt|;
ifdef|#
directive|ifdef
name|QLNX_RCV_IN_TASKQ
name|int
name|lro_enable
decl_stmt|;
name|int
name|rx_int
init|=
literal|0
decl_stmt|,
name|total_rx_count
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* #ifdef QLNX_RCV_IN_TASKQ */
name|fp
operator|=
name|context
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return;
name|cthread
operator|=
name|curthread
expr_stmt|;
name|thread_lock
argument_list|(
name|cthread
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sched_is_bound
argument_list|(
name|cthread
argument_list|)
condition|)
name|sched_bind
argument_list|(
name|cthread
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|thread_unlock
argument_list|(
name|cthread
argument_list|)
expr_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|fp
operator|->
name|edev
expr_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
ifdef|#
directive|ifdef
name|QLNX_RCV_IN_TASKQ
block|{
name|lro_enable
operator|=
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
expr_stmt|;
name|rx_int
operator|=
name|qlnx_rx_int
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|ha
operator|->
name|rx_pkt_threshold
argument_list|,
name|lro_enable
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_int
condition|)
block|{
name|fp
operator|->
name|rx_pkts
operator|+=
name|rx_int
expr_stmt|;
name|total_rx_count
operator|+=
name|rx_int
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|QLNX_SOFT_LRO
block|{
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
name|lro
operator|=
operator|&
name|fp
operator|->
name|rxq
operator|->
name|lro
expr_stmt|;
if|if
condition|(
name|lro_enable
operator|&&
name|total_rx_count
condition|)
block|{
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100101
operator|)
operator|||
operator|(
name|defined
name|QLNX_QSORT_LRO
operator|)
if|if
condition|(
name|ha
operator|->
name|dbg_trace_lro_cnt
condition|)
block|{
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|1023
condition|)
name|fp
operator|->
name|lro_cnt_1024
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|511
condition|)
name|fp
operator|->
name|lro_cnt_512
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|255
condition|)
name|fp
operator|->
name|lro_cnt_256
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|127
condition|)
name|fp
operator|->
name|lro_cnt_128
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|63
condition|)
name|fp
operator|->
name|lro_cnt_64
operator|++
expr_stmt|;
block|}
name|tcp_lro_flush_all
argument_list|(
name|lro
argument_list|)
expr_stmt|;
else|#
directive|else
name|struct
name|lro_entry
modifier|*
name|queued
decl_stmt|;
while|while
condition|(
operator|(
operator|!
name|SLIST_EMPTY
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|)
operator|)
condition|)
block|{
name|queued
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|)
expr_stmt|;
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|tcp_lro_flush
argument_list|(
name|lro
argument_list|,
name|queued
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* #if (__FreeBSD_version>= 1100101) || (defined QLNX_QSORT_LRO) */
block|}
block|}
endif|#
directive|endif
comment|/* #ifdef QLNX_SOFT_LRO */
name|ecore_sb_update_sb_idx
argument_list|(
name|fp
operator|->
name|sb_info
argument_list|)
expr_stmt|;
name|rmb
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* #ifdef QLNX_RCV_IN_TASKQ */
name|mtx_lock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
operator|)
operator|||
operator|(
operator|!
name|ha
operator|->
name|link_up
operator|)
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_fp_taskqueue_exit
goto|;
block|}
name|mp
operator|=
name|drbr_peek
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|)
expr_stmt|;
while|while
condition|(
name|mp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|ret
operator|=
name|qlnx_send
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
operator|&
name|mp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|mp
operator|!=
name|NULL
condition|)
block|{
name|drbr_putback
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|,
name|mp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fp
operator|->
name|tx_pkts_processed
operator|++
expr_stmt|;
name|drbr_advance
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_fp_taskqueue_exit
goto|;
block|}
else|else
block|{
name|drbr_advance
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_pkts_transmitted
operator|++
expr_stmt|;
name|fp
operator|->
name|tx_pkts_processed
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|tx_ring_full
condition|)
break|break;
name|mp
operator|=
name|drbr_peek
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
name|qlnx_fp_taskqueue_exit
label|:
ifdef|#
directive|ifdef
name|QLNX_RCV_IN_TASKQ
if|if
condition|(
name|rx_int
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|fp_taskqueue
operator|!=
name|NULL
condition|)
name|taskqueue_enqueue
argument_list|(
name|fp
operator|->
name|fp_taskqueue
argument_list|,
operator|&
name|fp
operator|->
name|fp_task
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fp
operator|->
name|tx_ring_full
condition|)
block|{
name|qlnx_mdelay
argument_list|(
name|__func__
argument_list|,
literal|100
argument_list|)
expr_stmt|;
block|}
name|ecore_sb_ack
argument_list|(
name|fp
operator|->
name|sb_info
argument_list|,
name|IGU_INT_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* #ifdef QLNX_RCV_IN_TASKQ */
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit ret = %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_create_fp_taskqueues
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint8_t
name|tq_name
index|[
literal|32
index|]
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
name|bzero
argument_list|(
name|tq_name
argument_list|,
sizeof|sizeof
argument_list|(
name|tq_name
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|tq_name
argument_list|,
sizeof|sizeof
argument_list|(
name|tq_name
argument_list|)
argument_list|,
literal|"ql_fp_tq_%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|fp
operator|->
name|fp_task
argument_list|,
literal|0
argument_list|,
name|qlnx_fp_taskqueue
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fp_taskqueue
operator|=
name|taskqueue_create_fast
argument_list|(
name|tq_name
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|fp
operator|->
name|fp_taskqueue
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fp_taskqueue
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|taskqueue_start_threads
argument_list|(
operator|&
name|fp
operator|->
name|fp_taskqueue
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s"
argument_list|,
name|tq_name
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"%p\n"
argument_list|,
name|fp
operator|->
name|fp_taskqueue
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_destroy_fp_taskqueues
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fp_taskqueue
operator|!=
name|NULL
condition|)
block|{
name|taskqueue_drain
argument_list|(
name|fp
operator|->
name|fp_taskqueue
argument_list|,
operator|&
name|fp
operator|->
name|fp_task
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|fp
operator|->
name|fp_taskqueue
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fp_taskqueue
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_drain_fp_taskqueues
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fp_taskqueue
operator|!=
name|NULL
condition|)
block|{
name|QLNX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|fp
operator|->
name|fp_taskqueue
argument_list|,
operator|&
name|fp
operator|->
name|fp_task
argument_list|)
expr_stmt|;
name|QLNX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * Name:	qlnx_pci_attach  * Function:	attaches the device to the operating system  */
end_comment

begin_function
specifier|static
name|int
name|qlnx_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|rsrc_len_reg
init|=
literal|0
decl_stmt|;
name|uint32_t
name|rsrc_len_dbells
init|=
literal|0
decl_stmt|;
name|uint32_t
name|rsrc_len_msix
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|mfw_ver
decl_stmt|;
if|if
condition|(
operator|(
name|ha
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot get softc\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|memset
argument_list|(
name|ha
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_host_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qlnx_valid_device
argument_list|(
name|dev
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"device is not valid device\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|ha
operator|->
name|pci_func
operator|=
name|pci_get_function
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ha
operator|->
name|pci_dev
operator|=
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|ha
operator|->
name|hw_lock
argument_list|,
literal|"qlnx_hw_lock"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|lock_init
operator|=
literal|1
expr_stmt|;
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * map the PCI BARs 	 */
name|ha
operator|->
name|reg_rid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ha
operator|->
name|pci_reg
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|ha
operator|->
name|reg_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|pci_reg
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map BAR0\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
name|rsrc_len_reg
operator|=
operator|(
name|uint32_t
operator|)
name|bus_get_resource_count
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|reg_rid
argument_list|)
expr_stmt|;
name|ha
operator|->
name|dbells_rid
operator|=
name|PCIR_BAR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|ha
operator|->
name|pci_dbells
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|ha
operator|->
name|dbells_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|pci_dbells
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map BAR1\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
name|rsrc_len_dbells
operator|=
operator|(
name|uint32_t
operator|)
name|bus_get_resource_count
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|dbells_rid
argument_list|)
expr_stmt|;
name|ha
operator|->
name|dbells_phys_addr
operator|=
operator|(
name|uint64_t
operator|)
name|bus_get_resource_start
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|dbells_rid
argument_list|)
expr_stmt|;
empty_stmt|;
name|ha
operator|->
name|dbells_size
operator|=
name|rsrc_len_dbells
expr_stmt|;
name|ha
operator|->
name|msix_rid
operator|=
name|PCIR_BAR
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|ha
operator|->
name|msix_bar
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|ha
operator|->
name|msix_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|msix_bar
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map BAR2\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
name|rsrc_len_msix
operator|=
operator|(
name|uint32_t
operator|)
name|bus_get_resource_count
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|msix_rid
argument_list|)
expr_stmt|;
comment|/* 	 * allocate dma tags 	 */
if|if
condition|(
name|qlnx_alloc_parent_dma_tag
argument_list|(
name|ha
argument_list|)
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
if|if
condition|(
name|qlnx_alloc_tx_dma_tag
argument_list|(
name|ha
argument_list|)
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
if|if
condition|(
name|qlnx_alloc_rx_dma_tag
argument_list|(
name|ha
argument_list|)
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
if|if
condition|(
name|qlnx_init_hw
argument_list|(
name|ha
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
comment|/* 	 * Allocate MSI-x vectors 	 */
name|ha
operator|->
name|num_rss
operator|=
name|QLNX_MAX_RSS
expr_stmt|;
name|ha
operator|->
name|num_tc
operator|=
name|QLNX_MAX_TC
expr_stmt|;
name|ha
operator|->
name|msix_count
operator|=
name|pci_msix_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|msix_count
operator|>
operator|(
name|mp_ncpus
operator|+
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
operator|)
condition|)
name|ha
operator|->
name|msix_count
operator|=
name|mp_ncpus
operator|+
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
expr_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|msix_count
operator|||
operator|(
name|ha
operator|->
name|msix_count
operator|<
operator|(
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
operator|+
literal|1
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: msix_count[%d] not enough\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|msix_count
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
if|if
condition|(
name|ha
operator|->
name|msix_count
operator|>
operator|(
name|ha
operator|->
name|num_rss
operator|+
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
operator|)
condition|)
name|ha
operator|->
name|msix_count
operator|=
name|ha
operator|->
name|num_rss
operator|+
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
expr_stmt|;
else|else
name|ha
operator|->
name|num_rss
operator|=
name|ha
operator|->
name|msix_count
operator|-
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"\n\t\t\tpci_reg [%p, 0x%08x 0x%08x]"
literal|"\n\t\t\tdbells [%p, 0x%08x 0x%08x]"
literal|"\n\t\t\tmsix [%p, 0x%08x 0x%08x 0x%x 0x%x]"
literal|"\n\t\t\t[ncpus = %d][num_rss = 0x%x] [num_tc = 0x%x]\n"
argument_list|,
name|ha
operator|->
name|pci_reg
argument_list|,
name|rsrc_len_reg
argument_list|,
name|ha
operator|->
name|reg_rid
argument_list|,
name|ha
operator|->
name|pci_dbells
argument_list|,
name|rsrc_len_dbells
argument_list|,
name|ha
operator|->
name|dbells_rid
argument_list|,
name|ha
operator|->
name|msix_bar
argument_list|,
name|rsrc_len_msix
argument_list|,
name|ha
operator|->
name|msix_rid
argument_list|,
name|pci_msix_count
argument_list|(
name|dev
argument_list|)
argument_list|,
name|ha
operator|->
name|msix_count
argument_list|,
name|mp_ncpus
argument_list|,
name|ha
operator|->
name|num_rss
argument_list|,
name|ha
operator|->
name|num_tc
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_alloc_msix
argument_list|(
name|dev
argument_list|,
operator|&
name|ha
operator|->
name|msix_count
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: pci_alloc_msix[%d] failed\n"
argument_list|,
name|__func__
argument_list|,
name|ha
operator|->
name|msix_count
argument_list|)
expr_stmt|;
name|ha
operator|->
name|msix_count
operator|=
literal|0
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
comment|/* 	 * Initialize slow path interrupt and task queue 	 */
if|if
condition|(
name|qlnx_create_sp_taskqueues
argument_list|(
name|ha
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|ha
operator|->
name|sp_irq_rid
index|[
name|i
index|]
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|ha
operator|->
name|sp_irq_rid
index|[
name|i
index|]
argument_list|,
operator|(
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate mbx interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
if|if
condition|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
argument_list|,
operator|(
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
operator|)
argument_list|,
name|NULL
argument_list|,
name|qlnx_sp_intr
argument_list|,
name|p_hwfn
argument_list|,
operator|&
name|ha
operator|->
name|sp_handle
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not setup slow path interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"p_hwfn [%p] sp_irq_rid %d"
literal|" sp_irq %p sp_handle %p\n"
argument_list|,
name|p_hwfn
argument_list|,
name|ha
operator|->
name|sp_irq_rid
index|[
name|i
index|]
argument_list|,
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
argument_list|,
name|ha
operator|->
name|sp_handle
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * initialize fast path interrupt 	 */
if|if
condition|(
name|qlnx_create_fp_taskqueues
argument_list|(
name|ha
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|rss_idx
operator|=
name|i
expr_stmt|;
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|ha
operator|=
name|ha
expr_stmt|;
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq_rid
operator|=
operator|(
literal|1
operator|+
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
operator|)
operator|+
name|i
expr_stmt|;
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq_rid
argument_list|,
operator|(
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate interrupt[%d]\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
if|if
condition|(
name|qlnx_alloc_tx_br
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate tx_br[%d]\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
block|}
name|callout_init
argument_list|(
operator|&
name|ha
operator|->
name|qlnx_callout
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|callout_init
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|qlnx_grc_dumpsize
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|grcdump_size
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
if|if
condition|(
name|ha
operator|->
name|grcdump_size
index|[
name|i
index|]
operator|==
literal|0
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
name|ha
operator|->
name|grcdump_size
index|[
name|i
index|]
operator|=
name|ha
operator|->
name|grcdump_size
index|[
name|i
index|]
operator|<<
literal|2
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"grcdump_size[%d] = 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|ha
operator|->
name|grcdump_size
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ha
operator|->
name|grcdump
index|[
name|i
index|]
operator|=
name|qlnx_zalloc
argument_list|(
name|ha
operator|->
name|grcdump_size
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|grcdump
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"grcdump alloc[%d] failed\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
if|if
condition|(
name|qlnx_idle_chk_size
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|idle_chk_size
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
if|if
condition|(
name|ha
operator|->
name|idle_chk_size
index|[
name|i
index|]
operator|==
literal|0
condition|)
goto|goto
name|qlnx_pci_attach_err
goto|;
name|ha
operator|->
name|idle_chk_size
index|[
name|i
index|]
operator|=
name|ha
operator|->
name|idle_chk_size
index|[
name|i
index|]
operator|<<
literal|2
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"idle_chk_size[%d] = 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|ha
operator|->
name|idle_chk_size
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ha
operator|->
name|idle_chk
index|[
name|i
index|]
operator|=
name|qlnx_zalloc
argument_list|(
name|ha
operator|->
name|idle_chk_size
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|idle_chk
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"idle_chk alloc failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
block|}
if|if
condition|(
name|qlnx_slowpath_start
argument_list|(
name|ha
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|qlnx_mdelay
argument_list|(
name|__func__
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|qlnx_trigger_dump
argument_list|(
name|ha
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err0
goto|;
block|}
else|else
name|ha
operator|->
name|flags
operator|.
name|slowpath_start
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|qlnx_get_flash_size
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|flash_size
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|qlnx_mdelay
argument_list|(
name|__func__
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|qlnx_trigger_dump
argument_list|(
name|ha
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err0
goto|;
block|}
if|if
condition|(
name|qlnx_get_mfw_version
argument_list|(
name|ha
argument_list|,
operator|&
name|mfw_ver
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|qlnx_mdelay
argument_list|(
name|__func__
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|qlnx_trigger_dump
argument_list|(
name|ha
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err0
goto|;
block|}
name|snprintf
argument_list|(
name|ha
operator|->
name|mfw_ver
argument_list|,
sizeof|sizeof
argument_list|(
name|ha
operator|->
name|mfw_ver
argument_list|)
argument_list|,
literal|"%d.%d.%d.%d"
argument_list|,
operator|(
operator|(
name|mfw_ver
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
operator|)
argument_list|,
operator|(
operator|(
name|mfw_ver
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
operator|)
argument_list|,
operator|(
operator|(
name|mfw_ver
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
operator|)
argument_list|,
operator|(
name|mfw_ver
operator|&
literal|0xFF
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|ha
operator|->
name|stormfw_ver
argument_list|,
sizeof|sizeof
argument_list|(
name|ha
operator|->
name|stormfw_ver
argument_list|)
argument_list|,
literal|"%d.%d.%d.%d"
argument_list|,
name|FW_MAJOR_VERSION
argument_list|,
name|FW_MINOR_VERSION
argument_list|,
name|FW_REVISION_VERSION
argument_list|,
name|FW_ENGINEERING_VERSION
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"STORM_FW version %s MFW version %s\n"
argument_list|,
name|ha
operator|->
name|stormfw_ver
argument_list|,
name|ha
operator|->
name|mfw_ver
argument_list|)
expr_stmt|;
name|qlnx_init_ifnet
argument_list|(
name|dev
argument_list|,
name|ha
argument_list|)
expr_stmt|;
comment|/* 	 * add sysctls 	 */
name|qlnx_add_sysctls
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_pci_attach_err0
label|:
comment|/* 	 * create ioctl device interface 	 */
if|if
condition|(
name|qlnx_make_cdev
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: ql_make_cdev failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_pci_attach_err
goto|;
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"success\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|qlnx_pci_attach_err
label|:
name|qlnx_release
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name:	qlnx_pci_detach  * Function:	Unhooks the device from the operating system  */
end_comment

begin_function
specifier|static
name|int
name|qlnx_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|ha
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot get softc\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|QLNX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_stop
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QLNX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_release
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_init_hw
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rval
init|=
literal|0
decl_stmt|;
name|struct
name|ecore_hw_prepare_params
name|params
decl_stmt|;
name|ecore_init_struct
argument_list|(
operator|&
name|ha
operator|->
name|cdev
argument_list|)
expr_stmt|;
comment|/* ha->dp_module = ECORE_MSG_PROBE | 				ECORE_MSG_INTR | 				ECORE_MSG_SP | 				ECORE_MSG_LINK | 				ECORE_MSG_SPQ | 				ECORE_MSG_RDMA; 	ha->dp_level = ECORE_LEVEL_VERBOSE;*/
name|ha
operator|->
name|dp_level
operator|=
name|ECORE_LEVEL_NOTICE
expr_stmt|;
name|ecore_init_dp
argument_list|(
operator|&
name|ha
operator|->
name|cdev
argument_list|,
name|ha
operator|->
name|dp_module
argument_list|,
name|ha
operator|->
name|dp_level
argument_list|,
name|ha
operator|->
name|pci_dev
argument_list|)
expr_stmt|;
name|ha
operator|->
name|cdev
operator|.
name|regview
operator|=
name|ha
operator|->
name|pci_reg
expr_stmt|;
name|ha
operator|->
name|cdev
operator|.
name|doorbells
operator|=
name|ha
operator|->
name|pci_dbells
expr_stmt|;
name|ha
operator|->
name|cdev
operator|.
name|db_phys_addr
operator|=
name|ha
operator|->
name|dbells_phys_addr
expr_stmt|;
name|ha
operator|->
name|cdev
operator|.
name|db_size
operator|=
name|ha
operator|->
name|dbells_size
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|params
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_hw_prepare_params
argument_list|)
argument_list|)
expr_stmt|;
name|ha
operator|->
name|personality
operator|=
name|ECORE_PCI_DEFAULT
expr_stmt|;
name|params
operator|.
name|personality
operator|=
name|ha
operator|->
name|personality
expr_stmt|;
name|params
operator|.
name|drv_resc_alloc
operator|=
name|false
expr_stmt|;
name|params
operator|.
name|chk_reg_fifo
operator|=
name|false
expr_stmt|;
name|params
operator|.
name|initiate_pf_flr
operator|=
name|true
expr_stmt|;
name|params
operator|.
name|epoch
operator|=
literal|0
expr_stmt|;
name|ecore_hw_prepare
argument_list|(
operator|&
name|ha
operator|->
name|cdev
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|qlnx_set_id
argument_list|(
operator|&
name|ha
operator|->
name|cdev
argument_list|,
name|qlnx_name_str
argument_list|,
name|qlnx_ver_str
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_release
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QLNX_MAX_HW_FUNCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|idle_chk
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ha
operator|->
name|idle_chk
index|[
name|i
index|]
argument_list|,
name|M_QLNXBUF
argument_list|)
expr_stmt|;
name|ha
operator|->
name|idle_chk
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|grcdump
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ha
operator|->
name|grcdump
index|[
name|i
index|]
argument_list|,
name|M_QLNXBUF
argument_list|)
expr_stmt|;
name|ha
operator|->
name|grcdump
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|callout_init
condition|)
name|callout_drain
argument_list|(
operator|&
name|ha
operator|->
name|qlnx_callout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|slowpath_start
condition|)
block|{
name|qlnx_slowpath_stop
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
name|ecore_hw_remove
argument_list|(
operator|&
name|ha
operator|->
name|cdev
argument_list|)
expr_stmt|;
name|qlnx_del_cdev
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|ifp
operator|!=
name|NULL
condition|)
name|ether_ifdetach
argument_list|(
name|ha
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|qlnx_free_tx_dma_tag
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_free_rx_dma_tag
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_free_parent_dma_tag
argument_list|(
name|ha
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|qlnx_fastpath
modifier|*
name|fp
init|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
condition|)
block|{
operator|(
name|void
operator|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
condition|)
block|{
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq_rid
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|)
expr_stmt|;
block|}
name|qlnx_free_tx_br
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
name|qlnx_destroy_fp_taskqueues
argument_list|(
name|ha
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|sp_handle
index|[
name|i
index|]
condition|)
operator|(
name|void
operator|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
argument_list|,
name|ha
operator|->
name|sp_handle
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
condition|)
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ha
operator|->
name|sp_irq_rid
index|[
name|i
index|]
argument_list|,
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|qlnx_destroy_sp_taskqueues
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|msix_count
condition|)
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|lock_init
condition|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|ha
operator|->
name|hw_lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|pci_reg
condition|)
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|reg_rid
argument_list|,
name|ha
operator|->
name|pci_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|pci_dbells
condition|)
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|dbells_rid
argument_list|,
name|ha
operator|->
name|pci_dbells
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|msix_bar
condition|)
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ha
operator|->
name|msix_rid
argument_list|,
name|ha
operator|->
name|msix_bar
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_trigger_dump
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ha
operator|->
name|ifp
operator|!=
name|NULL
condition|)
name|ha
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_OACTIVE
operator||
name|IFF_DRV_RUNNING
operator|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
name|qlnx_grc_dump
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|grcdump_dwords
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|qlnx_idle_chk
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|idle_chk_dwords
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_trigger_dump_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ret
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
block|{
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
name|qlnx_trigger_dump
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_tx_coalesce
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|,
name|usecs
init|=
literal|0
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|usecs
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
operator|||
operator|!
name|usecs
operator|||
operator|(
name|usecs
operator|>
literal|255
operator|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
operator|(
name|i
operator|%
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
operator|)
index|]
expr_stmt|;
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|txq
index|[
literal|0
index|]
operator|->
name|handle
operator|!=
name|NULL
condition|)
block|{
name|ret
operator|=
name|ecore_set_queue_coalesce
argument_list|(
name|p_hwfn
argument_list|,
literal|0
argument_list|,
operator|(
name|uint16_t
operator|)
name|usecs
argument_list|,
name|fp
operator|->
name|txq
index|[
literal|0
index|]
operator|->
name|handle
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ret
condition|)
name|ha
operator|->
name|tx_coalesce_usecs
operator|=
operator|(
name|uint8_t
operator|)
name|usecs
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_rx_coalesce
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|,
name|usecs
init|=
literal|0
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|usecs
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
operator|||
operator|!
name|usecs
operator|||
operator|(
name|usecs
operator|>
literal|255
operator|)
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
operator|(
name|i
operator|%
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
operator|)
index|]
expr_stmt|;
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|rxq
operator|->
name|handle
operator|!=
name|NULL
condition|)
block|{
name|ret
operator|=
name|ecore_set_queue_coalesce
argument_list|(
name|p_hwfn
argument_list|,
operator|(
name|uint16_t
operator|)
name|usecs
argument_list|,
literal|0
argument_list|,
name|fp
operator|->
name|rxq
operator|->
name|handle
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ret
condition|)
name|ha
operator|->
name|rx_coalesce_usecs
operator|=
operator|(
name|uint8_t
operator|)
name|usecs
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_add_sp_stats_sysctls
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|children
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|ctx_oid
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
argument_list|)
expr_stmt|;
name|ctx_oid
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"spstat"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"spstat"
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ctx_oid
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sp_interrupts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|sp_interrupts
argument_list|,
literal|"No. of slowpath interrupts"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_add_fp_stats_sysctls
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|children
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|node_children
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|ctx_oid
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint8_t
name|name_str
index|[
literal|16
index|]
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
argument_list|)
expr_stmt|;
name|ctx_oid
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fpstat"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"fpstat"
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ctx_oid
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|bzero
argument_list|(
name|name_str
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
name|name_str
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name_str
argument_list|,
sizeof|sizeof
argument_list|(
name|name_str
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ctx_oid
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
name|name_str
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
name|name_str
argument_list|)
expr_stmt|;
name|node_children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ctx_oid
argument_list|)
expr_stmt|;
comment|/* Tx Related */
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pkts_processed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_pkts_processed
argument_list|,
literal|"No. of packets processed for transmission"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pkts_freed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_pkts_freed
argument_list|,
literal|"No. of freed packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pkts_transmitted"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_pkts_transmitted
argument_list|,
literal|"No. of transmitted packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pkts_completed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_pkts_completed
argument_list|,
literal|"No. of transmit completions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_lso_wnd_min_len"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_lso_wnd_min_len
argument_list|,
literal|"tx_lso_wnd_min_len"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_defrag"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_defrag
argument_list|,
literal|"tx_defrag"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_nsegs_gt_elem_left"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_nsegs_gt_elem_left
argument_list|,
literal|"tx_nsegs_gt_elem_left"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_tso_max_nsegs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_max_nsegs
argument_list|,
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_max_nsegs
argument_list|,
literal|"tx_tso_max_nsegs"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_tso_min_nsegs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_min_nsegs
argument_list|,
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_min_nsegs
argument_list|,
literal|"tx_tso_min_nsegs"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_tso_max_pkt_len"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_max_pkt_len
argument_list|,
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_max_pkt_len
argument_list|,
literal|"tx_tso_max_pkt_len"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_tso_min_pkt_len"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_min_pkt_len
argument_list|,
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_tso_min_pkt_len
argument_list|,
literal|"tx_tso_min_pkt_len"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|QLNX_FP_MAX_SEGS
condition|;
name|j
operator|++
control|)
block|{
name|bzero
argument_list|(
name|name_str
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
name|name_str
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name_str
argument_list|,
sizeof|sizeof
argument_list|(
name|name_str
argument_list|)
argument_list|,
literal|"tx_pkts_nseg_%02d"
argument_list|,
operator|(
name|j
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
name|name_str
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tx_pkts
index|[
name|j
index|]
argument_list|,
name|name_str
argument_list|)
expr_stmt|;
block|}
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_nsegs_gt_elem_left"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_nsegs_gt_elem_left
argument_list|,
literal|"err_tx_nsegs_gt_elem_left"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_dmamap_create"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_dmamap_create
argument_list|,
literal|"err_tx_dmamap_create"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_defrag_dmamap_load"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_defrag_dmamap_load
argument_list|,
literal|"err_tx_defrag_dmamap_load"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_non_tso_max_seg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_non_tso_max_seg
argument_list|,
literal|"err_tx_non_tso_max_seg"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_dmamap_load"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_dmamap_load
argument_list|,
literal|"err_tx_dmamap_load"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_defrag"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_defrag
argument_list|,
literal|"err_tx_defrag"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_free_pkt_null"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_free_pkt_null
argument_list|,
literal|"err_tx_free_pkt_null"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_tx_cons_idx_conflict"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_tx_cons_idx_conflict
argument_list|,
literal|"err_tx_cons_idx_conflict"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_cnt_64"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|lro_cnt_64
argument_list|,
literal|"lro_cnt_64"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_cnt_128"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|lro_cnt_128
argument_list|,
literal|"lro_cnt_128"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_cnt_256"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|lro_cnt_256
argument_list|,
literal|"lro_cnt_256"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_cnt_512"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|lro_cnt_512
argument_list|,
literal|"lro_cnt_512"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_cnt_1024"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|lro_cnt_1024
argument_list|,
literal|"lro_cnt_1024"
argument_list|)
expr_stmt|;
comment|/* Rx Related */
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|rx_pkts
argument_list|,
literal|"No. of received packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_start"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tpa_start
argument_list|,
literal|"No. of tpa_start packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_cont"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tpa_cont
argument_list|,
literal|"No. of tpa_cont packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_end"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|tpa_end
argument_list|,
literal|"No. of tpa_end packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_m_getcl"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_m_getcl
argument_list|,
literal|"err_m_getcl"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_m_getjcl"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_m_getjcl
argument_list|,
literal|"err_m_getjcl"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_rx_hw_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_rx_hw_errors
argument_list|,
literal|"err_rx_hw_errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_rx_alloc_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
operator|.
name|err_rx_alloc_errors
argument_list|,
literal|"err_rx_alloc_errors"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_add_hw_stats_sysctls
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|children
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|ctx_oid
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
argument_list|)
expr_stmt|;
name|ctx_oid
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"hwstat"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"hwstat"
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ctx_oid
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"no_buff_discards"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|no_buff_discards
argument_list|,
literal|"No. of packets discarded due to lack of buffer"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"packet_too_big_discard"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|packet_too_big_discard
argument_list|,
literal|"No. of packets discarded because packet was too big"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ttl0_discard"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|ttl0_discard
argument_list|,
literal|"ttl0_discard"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_ucast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_ucast_bytes
argument_list|,
literal|"rx_ucast_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mcast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mcast_bytes
argument_list|,
literal|"rx_mcast_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_bcast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_bcast_bytes
argument_list|,
literal|"rx_bcast_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_ucast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_ucast_pkts
argument_list|,
literal|"rx_ucast_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mcast_pkts
argument_list|,
literal|"rx_mcast_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_bcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_bcast_pkts
argument_list|,
literal|"rx_bcast_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mftag_filter_discards"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|mftag_filter_discards
argument_list|,
literal|"mftag_filter_discards"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mac_filter_discards"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|mac_filter_discards
argument_list|,
literal|"mac_filter_discards"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_ucast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_ucast_bytes
argument_list|,
literal|"tx_ucast_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_mcast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mcast_bytes
argument_list|,
literal|"tx_mcast_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_bcast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_bcast_bytes
argument_list|,
literal|"tx_bcast_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_ucast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_ucast_pkts
argument_list|,
literal|"tx_ucast_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_mcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mcast_pkts
argument_list|,
literal|"tx_mcast_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_bcast_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_bcast_pkts
argument_list|,
literal|"tx_bcast_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_err_drop_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_err_drop_pkts
argument_list|,
literal|"tx_err_drop_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_coalesced_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tpa_coalesced_pkts
argument_list|,
literal|"tpa_coalesced_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_coalesced_events"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tpa_coalesced_events
argument_list|,
literal|"tpa_coalesced_events"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_aborts_num"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tpa_aborts_num
argument_list|,
literal|"tpa_aborts_num"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_not_coalesced_pkts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tpa_not_coalesced_pkts
argument_list|,
literal|"tpa_not_coalesced_pkts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tpa_coalesced_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tpa_coalesced_bytes
argument_list|,
literal|"tpa_coalesced_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_64_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_64_byte_packets
argument_list|,
literal|"rx_64_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_65_to_127_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_65_to_127_byte_packets
argument_list|,
literal|"rx_65_to_127_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_128_to_255_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_128_to_255_byte_packets
argument_list|,
literal|"rx_128_to_255_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_256_to_511_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_256_to_511_byte_packets
argument_list|,
literal|"rx_256_to_511_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_512_to_1023_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_512_to_1023_byte_packets
argument_list|,
literal|"rx_512_to_1023_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_1024_to_1518_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_1024_to_1518_byte_packets
argument_list|,
literal|"rx_1024_to_1518_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_1519_to_1522_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|rx_1519_to_1522_byte_packets
argument_list|,
literal|"rx_1519_to_1522_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_1523_to_2047_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|rx_1519_to_2047_byte_packets
argument_list|,
literal|"rx_1523_to_2047_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_2048_to_4095_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|rx_2048_to_4095_byte_packets
argument_list|,
literal|"rx_2048_to_4095_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_4096_to_9216_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|rx_4096_to_9216_byte_packets
argument_list|,
literal|"rx_4096_to_9216_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_9217_to_16383_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|rx_9217_to_16383_byte_packets
argument_list|,
literal|"rx_9217_to_16383_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_crc_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_crc_errors
argument_list|,
literal|"rx_crc_errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mac_crtl_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mac_crtl_frames
argument_list|,
literal|"rx_mac_crtl_frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_pause_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_pause_frames
argument_list|,
literal|"rx_pause_frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_pfc_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_pfc_frames
argument_list|,
literal|"rx_pfc_frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_align_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_align_errors
argument_list|,
literal|"rx_align_errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_carrier_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_carrier_errors
argument_list|,
literal|"rx_carrier_errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_oversize_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_oversize_packets
argument_list|,
literal|"rx_oversize_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_jabbers"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_jabbers
argument_list|,
literal|"rx_jabbers"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_undersize_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_undersize_packets
argument_list|,
literal|"rx_undersize_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_fragments"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_fragments
argument_list|,
literal|"rx_fragments"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_64_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_64_byte_packets
argument_list|,
literal|"tx_64_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_65_to_127_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_65_to_127_byte_packets
argument_list|,
literal|"tx_65_to_127_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_128_to_255_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_128_to_255_byte_packets
argument_list|,
literal|"tx_128_to_255_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_256_to_511_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_256_to_511_byte_packets
argument_list|,
literal|"tx_256_to_511_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_512_to_1023_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_512_to_1023_byte_packets
argument_list|,
literal|"tx_512_to_1023_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_1024_to_1518_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_1024_to_1518_byte_packets
argument_list|,
literal|"tx_1024_to_1518_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_1519_to_2047_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|tx_1519_to_2047_byte_packets
argument_list|,
literal|"tx_1519_to_2047_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_2048_to_4095_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|tx_2048_to_4095_byte_packets
argument_list|,
literal|"tx_2048_to_4095_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_4096_to_9216_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|tx_4096_to_9216_byte_packets
argument_list|,
literal|"tx_4096_to_9216_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_9217_to_16383_byte_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|tx_9217_to_16383_byte_packets
argument_list|,
literal|"tx_9217_to_16383_byte_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pause_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_pause_frames
argument_list|,
literal|"tx_pause_frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pfc_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_pfc_frames
argument_list|,
literal|"tx_pfc_frames"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_lpi_entry_count"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|tx_lpi_entry_count
argument_list|,
literal|"tx_lpi_entry_count"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_total_collisions"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|bb
operator|.
name|tx_total_collisions
argument_list|,
literal|"tx_total_collisions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"brb_truncates"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|brb_truncates
argument_list|,
literal|"brb_truncates"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"brb_discards"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|brb_discards
argument_list|,
literal|"brb_discards"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mac_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mac_bytes
argument_list|,
literal|"rx_mac_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mac_uc_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mac_uc_packets
argument_list|,
literal|"rx_mac_uc_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mac_mc_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mac_mc_packets
argument_list|,
literal|"rx_mac_mc_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mac_bc_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mac_bc_packets
argument_list|,
literal|"rx_mac_bc_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_mac_frames_ok"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mac_frames_ok
argument_list|,
literal|"rx_mac_frames_ok"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_mac_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mac_bytes
argument_list|,
literal|"tx_mac_bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_mac_uc_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mac_uc_packets
argument_list|,
literal|"tx_mac_uc_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_mac_mc_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mac_mc_packets
argument_list|,
literal|"tx_mac_mc_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_mac_bc_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mac_bc_packets
argument_list|,
literal|"tx_mac_bc_packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_mac_ctrl_frames"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mac_ctrl_frames
argument_list|,
literal|"tx_mac_ctrl_frames"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_add_sysctls
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|children
decl_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|qlnx_add_fp_stats_sysctls
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_add_sp_stats_sysctls
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_add_hw_stats_sysctls
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Driver_Version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|qlnx_ver_str
argument_list|,
literal|0
argument_list|,
literal|"Driver Version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"STORMFW_Version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|ha
operator|->
name|stormfw_ver
argument_list|,
literal|0
argument_list|,
literal|"STORM Firmware Version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"MFW_Version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|ha
operator|->
name|mfw_ver
argument_list|,
literal|0
argument_list|,
literal|"Management Firmware Version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"personality"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|personality
argument_list|,
name|ha
operator|->
name|personality
argument_list|,
literal|"\tpersonality = 0 => Ethernet Only\n"
literal|"\tpersonality = 3 => Ethernet and RoCE\n"
literal|"\tpersonality = 4 => Ethernet and iWARP\n"
literal|"\tpersonality = 6 => Default in Shared Memory\n"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|dbg_level
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|dbg_level
argument_list|,
name|ha
operator|->
name|dbg_level
argument_list|,
literal|"Debug Level"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|dp_level
operator|=
literal|0x01
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dp_level"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|dp_level
argument_list|,
name|ha
operator|->
name|dp_level
argument_list|,
literal|"DP Level"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|dbg_trace_lro_cnt
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dbg_trace_lro_cnt"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|dbg_trace_lro_cnt
argument_list|,
name|ha
operator|->
name|dbg_trace_lro_cnt
argument_list|,
literal|"Trace LRO Counts"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|dbg_trace_tso_pkt_len
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dbg_trace_tso_pkt_len"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|dbg_trace_tso_pkt_len
argument_list|,
name|ha
operator|->
name|dbg_trace_tso_pkt_len
argument_list|,
literal|"Trace TSO packet lengths"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|dp_module
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dp_module"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|dp_module
argument_list|,
name|ha
operator|->
name|dp_module
argument_list|,
literal|"DP Module"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|err_inject
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_inject"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|err_inject
argument_list|,
name|ha
operator|->
name|err_inject
argument_list|,
literal|"Error Inject"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|storm_stats_enable
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"storm_stats_enable"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|storm_stats_enable
argument_list|,
name|ha
operator|->
name|storm_stats_enable
argument_list|,
literal|"Enable Storm Statistics Gathering"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|storm_stats_index
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"storm_stats_index"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|storm_stats_index
argument_list|,
name|ha
operator|->
name|storm_stats_index
argument_list|,
literal|"Enable Storm Statistics Gathering Current Index"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|grcdump_taken
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"grcdump_taken"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|grcdump_taken
argument_list|,
name|ha
operator|->
name|grcdump_taken
argument_list|,
literal|"grcdump_taken"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|idle_chk_taken
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"idle_chk_taken"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|idle_chk_taken
argument_list|,
name|ha
operator|->
name|idle_chk_taken
argument_list|,
literal|"idle_chk_taken"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_coalesce_usecs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|rx_coalesce_usecs
argument_list|,
name|ha
operator|->
name|rx_coalesce_usecs
argument_list|,
literal|"rx_coalesce_usecs"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_coalesce_usecs"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|tx_coalesce_usecs
argument_list|,
name|ha
operator|->
name|tx_coalesce_usecs
argument_list|,
literal|"tx_coalesce_usecs"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_pkt_threshold
operator|=
literal|128
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_pkt_threshold"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|rx_pkt_threshold
argument_list|,
name|ha
operator|->
name|rx_pkt_threshold
argument_list|,
literal|"No. of Rx Pkts to process at a time"
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_jumbo_buf_eq_mtu
operator|=
literal|0
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_jumbo_buf_eq_mtu"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ha
operator|->
name|rx_jumbo_buf_eq_mtu
argument_list|,
name|ha
operator|->
name|rx_jumbo_buf_eq_mtu
argument_list|,
literal|"== 0 => Rx Jumbo buffers are capped to 4Kbytes\n"
literal|"otherwise Rx Jumbo buffers are set to>= MTU size\n"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"trigger_dump"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qlnx_trigger_dump_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"trigger_dump"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"set_rx_coalesce_usecs"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qlnx_set_rx_coalesce
argument_list|,
literal|"I"
argument_list|,
literal|"rx interrupt coalesce period microseconds"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"set_tx_coalesce_usecs"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qlnx_set_tx_coalesce
argument_list|,
literal|"I"
argument_list|,
literal|"tx interrupt coalesce period microseconds"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_illegal_intr"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|err_illegal_intr
argument_list|,
literal|"err_illegal_intr"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_fp_null"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|err_fp_null
argument_list|,
literal|"err_fp_null"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"err_get_proto_invalid_type"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|err_get_proto_invalid_type
argument_list|,
literal|"err_get_proto_invalid_type"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************  * Operating System Network Interface Functions  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|qlnx_init_ifnet
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint16_t
name|device_id
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"%s: cannot if_alloc()\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|device_id
operator|=
name|pci_get_device
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1000000
if|if
condition|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1634
condition|)
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|40
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1656
operator|)
operator|||
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_8070
operator|)
condition|)
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|25
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1654
condition|)
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|50
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1644
condition|)
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
name|IFCAP_LINKSTATE
expr_stmt|;
else|#
directive|else
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
operator|(
literal|1
operator|*
literal|1000
operator|*
literal|1000
operator|*
literal|1000
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/* #if __FreeBSD_version>= 1000000 */
name|ifp
operator|->
name|if_init
operator|=
name|qlnx_init
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|ha
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|qlnx_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_transmit
operator|=
name|qlnx_transmit
expr_stmt|;
name|ifp
operator|->
name|if_qflush
operator|=
name|qlnx_qflush
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|qlnx_get_ifq_snd_maxlen
argument_list|(
name|ha
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|qlnx_get_ifq_snd_maxlen
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100036
name|if_setgetcounterfn
argument_list|(
name|ifp
argument_list|,
name|qlnx_get_counter
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ha
operator|->
name|max_frame_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|ha
operator|->
name|primary_mac
argument_list|,
name|qlnx_get_mac_addr
argument_list|(
name|ha
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|ha
operator|->
name|primary_mac
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|IF_LLADDR
argument_list|(
name|ha
operator|->
name|ifp
argument_list|)
argument_list|,
name|ha
operator|->
name|primary_mac
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
name|IFCAP_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_JUMBO_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTSO
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO4
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO6
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_LRO
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
name|CSUM_IP
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TCP
operator||
name|CSUM_UDP
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TCP_IPV6
operator||
name|CSUM_UDP_IPV6
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
name|IFM_IMASK
argument_list|,
name|qlnx_media_change
argument_list|,\
name|qlnx_media_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1634
condition|)
block|{
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_40G_LR4
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_40G_SR4
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_40G_CR4
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1656
operator|)
operator|||
operator|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_8070
operator|)
condition|)
block|{
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|QLNX_IFM_25G_SR
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|QLNX_IFM_25G_CR
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1654
condition|)
block|{
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_50G_KR2
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_50G_CR2
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|device_id
operator|==
name|QLOGIC_PCI_DEVICE_ID_1644
condition|)
block|{
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|QLNX_IFM_100G_LR4
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|QLNX_IFM_100G_SR4
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|QLNX_IFM_100G_CR4
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_FDX
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_AUTO
operator|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|ha
operator|->
name|media
argument_list|,
operator|(
name|IFM_ETHER
operator||
name|IFM_AUTO
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_init_locked
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Driver Initialization start \n"
argument_list|)
expr_stmt|;
name|qlnx_stop
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|qlnx_load
argument_list|(
name|ha
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|arg
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
name|QLNX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_init_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QLNX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_config_mcast_mac_addr
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
block|{
name|struct
name|ecore_filter_mcast
modifier|*
name|mcast
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|mcast
operator|=
operator|&
name|ha
operator|->
name|ecore_mcast
expr_stmt|;
name|bzero
argument_list|(
name|mcast
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_filter_mcast
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|add_mac
condition|)
name|mcast
operator|->
name|opcode
operator|=
name|ECORE_FILTER_ADD
expr_stmt|;
else|else
name|mcast
operator|->
name|opcode
operator|=
name|ECORE_FILTER_REMOVE
expr_stmt|;
name|mcast
operator|->
name|num_mc_addrs
operator|=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|mcast
operator|->
name|mac
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_filter_mcast_cmd
argument_list|(
name|cdev
argument_list|,
name|mcast
argument_list|,
name|ECORE_SPQ_MODE_CB
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_hw_add_mcast
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QLNX_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|QL_MAC_CMP
argument_list|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|mta
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* its been already added */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QLNX_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|qlnx_config_mcast_mac_addr
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|bcopy
argument_list|(
name|mta
argument_list|,
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ha
operator|->
name|nmcast
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_hw_del_mcast
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QLNX_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|QL_MAC_CMP
argument_list|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|mta
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|qlnx_config_mcast_mac_addr
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|nmcast
operator|--
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_hw_set_multi  * Function: Sets the Multicast Addresses provided the host O.S into the  *      hardware (for the given interface)  */
end_comment

begin_function
specifier|static
name|void
name|qlnx_hw_set_multi
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|,
name|uint32_t
name|mcnt
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|add_mac
condition|)
block|{
if|if
condition|(
name|qlnx_hw_add_mcast
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|)
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
name|qlnx_hw_del_mcast
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|)
condition|)
break|break;
block|}
name|mta
operator|+=
name|ETHER_HDR_LEN
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_define
define|#
directive|define
name|QLNX_MCAST_ADDRS_SIZE
value|(QLNX_MAX_NUM_MULTICAST_ADDRS * ETHER_HDR_LEN)
end_define

begin_function
specifier|static
name|int
name|qlnx_set_multi
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|add_multi
parameter_list|)
block|{
name|uint8_t
name|mta
index|[
name|QLNX_MCAST_ADDRS_SIZE
index|]
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|int
name|mcnt
init|=
literal|0
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
name|mcnt
operator|==
name|QLNX_MAX_NUM_MULTICAST_ADDRS
condition|)
break|break;
name|bcopy
argument_list|(
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|,
operator|&
name|mta
index|[
name|mcnt
operator|*
name|ETHER_HDR_LEN
index|]
argument_list|,
name|ETHER_HDR_LEN
argument_list|)
expr_stmt|;
name|mcnt
operator|++
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|QLNX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_hw_set_multi
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
name|mcnt
argument_list|,
name|add_multi
argument_list|)
expr_stmt|;
name|QLNX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_promisc
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|filter
decl_stmt|;
name|filter
operator|=
name|ha
operator|->
name|filter
expr_stmt|;
name|filter
operator||=
name|ECORE_ACCEPT_MCAST_UNMATCHED
expr_stmt|;
name|filter
operator||=
name|ECORE_ACCEPT_UCAST_UNMATCHED
expr_stmt|;
name|rc
operator|=
name|qlnx_set_rx_accept_filter
argument_list|(
name|ha
argument_list|,
name|filter
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_allmulti
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|filter
decl_stmt|;
name|filter
operator|=
name|ha
operator|->
name|filter
expr_stmt|;
name|filter
operator||=
name|ECORE_ACCEPT_MCAST_UNMATCHED
expr_stmt|;
name|rc
operator|=
name|qlnx_set_rx_accept_filter
argument_list|(
name|ha
argument_list|,
name|filter
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|mask
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
init|=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|data
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFADDR
case|:
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"SIOCSIFADDR (0x%lx)\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_UP
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|QLNX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_init_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QLNX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"SIOCSIFADDR (0x%lx) ipv4 [0x%08x]\n"
argument_list|,
name|cmd
argument_list|,
name|ntohl
argument_list|(
name|IA_SIN
argument_list|(
name|ifa
argument_list|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
name|arp_ifinit
argument_list|(
name|ifp
argument_list|,
name|ifa
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMTU
case|:
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"SIOCSIFMTU (0x%lx)\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifr
operator|->
name|ifr_mtu
operator|>
name|QLNX_MAX_MTU
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|QLNX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ifr
operator|->
name|ifr_mtu
expr_stmt|;
name|ha
operator|->
name|max_frame_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|qlnx_init_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
name|QLNX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFFLAGS
case|:
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"SIOCSIFFLAGS (0x%lx)\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|QLNX_LOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|ha
operator|->
name|if_flags
operator|)
operator|&
name|IFF_PROMISC
condition|)
block|{
name|ret
operator|=
name|qlnx_set_promisc
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|ha
operator|->
name|if_flags
operator|)
operator|&
name|IFF_ALLMULTI
condition|)
block|{
name|ret
operator|=
name|qlnx_set_allmulti
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ha
operator|->
name|max_frame_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|ETHER_HDR_LEN
operator|+
name|ETHER_CRC_LEN
expr_stmt|;
name|qlnx_init_locked
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|qlnx_stop
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ha
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
block|}
name|QLNX_UNLOCK
argument_list|(
name|ha
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"%s (0x%lx)\n"
argument_list|,
literal|"SIOCADDMULTI"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
name|qlnx_set_multi
argument_list|(
name|ha
argument_list|,
literal|1
argument_list|)
condition|)
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|SIOCDELMULTI
case|:
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"%s (0x%lx)\n"
argument_list|,
literal|"SIOCDELMULTI"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
name|qlnx_set_multi
argument_list|(
name|ha
argument_list|,
literal|0
argument_list|)
condition|)
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"SIOCSIFMEDIA/SIOCGIFMEDIA (0x%lx)\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|ha
operator|->
name|media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
name|mask
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
expr_stmt|;
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"SIOCSIFCAP (0x%lx)\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_HWCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_HWCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO4
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO6
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO6
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTSO
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTSO
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_LRO
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_LRO
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
name|qlnx_init
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|VLAN_CAPABILITIES
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100101
operator|)
case|case
name|SIOCGI2C
case|:
block|{
name|struct
name|ifi2creq
name|i2c
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
decl_stmt|;
name|ret
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|i2c
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
if|if
condition|(
operator|(
name|i2c
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|i2c
operator|.
name|data
argument_list|)
operator|)
operator|||
operator|(
name|i2c
operator|.
name|dev_addr
operator|!=
literal|0xA0
operator|&&
name|i2c
operator|.
name|dev_addr
operator|!=
literal|0xA2
operator|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|p_ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_ptt
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"ecore_ptt_acquire failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|ret
operator|=
name|ecore_mcp_phy_sfp_read
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
argument_list|,
name|i2c
operator|.
name|dev_addr
argument_list|,
name|i2c
operator|.
name|offset
argument_list|,
name|i2c
operator|.
name|len
argument_list|,
operator|&
name|i2c
operator|.
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|ret
operator|=
name|copyout
argument_list|(
operator|&
name|i2c
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
argument_list|)
argument_list|)
expr_stmt|;
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
literal|"SIOCGI2C copyout ret = %d \ 			 len = %d addr = 0x%02x offset = 0x%04x \ 			 data[0..7]=0x%02x 0x%02x 0x%02x 0x%02x 0x%02x \ 			 0x%02x 0x%02x 0x%02x\n"
argument_list|,
name|ret
argument_list|,
name|i2c
operator|.
name|len
argument_list|,
name|i2c
operator|.
name|dev_addr
argument_list|,
name|i2c
operator|.
name|offset
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|0
index|]
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|1
index|]
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|2
index|]
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|3
index|]
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|4
index|]
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|5
index|]
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|6
index|]
argument_list|,
name|i2c
operator|.
name|data
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* #if (__FreeBSD_version>= 1100101) */
default|default:
name|QL_DPRINT4
argument_list|(
name|ha
argument_list|,
literal|"default (0x%lx)\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
name|ifm
operator|=
operator|&
name|ha
operator|->
name|media
expr_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|link_up
condition|)
block|{
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator||=
operator|(
name|IFM_FDX
operator||
name|qlnx_get_optics
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|if_link
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|if_link
operator|.
name|link_partner_caps
operator|&
operator|(
name|QLNX_LINK_CAP_Pause
operator||
name|QLNX_LINK_CAP_Asym_Pause
operator|)
condition|)
name|ifmr
operator|->
name|ifm_active
operator||=
operator|(
name|IFM_ETH_RXPAUSE
operator||
name|IFM_ETH_TXPAUSE
operator|)
expr_stmt|;
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit (%s)\n"
argument_list|,
operator|(
name|ha
operator|->
name|link_up
condition|?
literal|"link_up"
else|:
literal|"link_down"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_tx_pkt
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
parameter_list|)
block|{
name|u16
name|idx
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|eth_tx_bd
modifier|*
name|tx_data_bd
decl_stmt|;
name|struct
name|eth_tx_1st_bd
modifier|*
name|first_bd
decl_stmt|;
name|int
name|nbds
init|=
literal|0
decl_stmt|;
name|idx
operator|=
name|txq
operator|->
name|sw_tx_cons
expr_stmt|;
name|mp
operator|=
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|mp
expr_stmt|;
name|map
operator|=
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|map
expr_stmt|;
if|if
condition|(
operator|(
name|mp
operator|==
name|NULL
operator|)
operator|||
name|QL_ERR_INJECT
argument_list|(
name|ha
argument_list|,
name|QL_ERR_INJCT_TX_INT_MBUF_NULL
argument_list|)
condition|)
block|{
name|QL_RESET_ERR_INJECT
argument_list|(
name|ha
argument_list|,
name|QL_ERR_INJCT_TX_INT_MBUF_NULL
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"(mp == NULL) "
literal|" tx_idx = 0x%x"
literal|" ecore_prod_idx = 0x%x"
literal|" ecore_cons_idx = 0x%x"
literal|" hw_bd_cons = 0x%x"
literal|" txq_db_last = 0x%x"
literal|" elem_left = 0x%x\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|ecore_chain_get_prod_idx
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|,
name|ecore_chain_get_cons_idx
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|,
name|le16toh
argument_list|(
operator|*
name|txq
operator|->
name|hw_cons_ptr
argument_list|)
argument_list|,
name|txq
operator|->
name|tx_db
operator|.
name|raw
argument_list|,
name|ecore_chain_get_elem_left
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_tx_free_pkt_null
operator|++
expr_stmt|;
comment|//DEBUG
name|qlnx_trigger_dump
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|QLNX_INC_OPACKETS
argument_list|(
operator|(
name|ha
operator|->
name|ifp
operator|)
argument_list|)
expr_stmt|;
name|QLNX_INC_OBYTES
argument_list|(
operator|(
name|ha
operator|->
name|ifp
operator|)
argument_list|,
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_pkts_freed
operator|++
expr_stmt|;
name|fp
operator|->
name|tx_pkts_completed
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
name|first_bd
operator|=
operator|(
expr|struct
name|eth_tx_1st_bd
operator|*
operator|)
name|ecore_chain_consume
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|nbds
operator|=
name|first_bd
operator|->
name|data
operator|.
name|nbds
expr_stmt|;
comment|//	BD_SET_UNMAP_ADDR_LEN(first_bd, 0, 0);
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|nbds
condition|;
name|i
operator|++
control|)
block|{
name|tx_data_bd
operator|=
name|ecore_chain_consume
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
comment|//		BD_SET_UNMAP_ADDR_LEN(tx_data_bd, 0, 0);
block|}
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|mp
operator|=
name|NULL
expr_stmt|;
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|map
operator|=
operator|(
name|bus_dmamap_t
operator|)
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_tx_int
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
parameter_list|)
block|{
name|u16
name|hw_bd_cons
decl_stmt|;
name|u16
name|ecore_cons_idx
decl_stmt|;
name|uint16_t
name|diff
decl_stmt|;
name|hw_bd_cons
operator|=
name|le16toh
argument_list|(
operator|*
name|txq
operator|->
name|hw_cons_ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|hw_bd_cons
operator|!=
operator|(
name|ecore_cons_idx
operator|=
name|ecore_chain_get_cons_idx
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|hw_bd_cons
operator|<
name|ecore_cons_idx
condition|)
block|{
name|diff
operator|=
operator|(
literal|1
operator|<<
literal|16
operator|)
operator|-
operator|(
name|ecore_cons_idx
operator|-
name|hw_bd_cons
operator|)
expr_stmt|;
block|}
else|else
block|{
name|diff
operator|=
name|hw_bd_cons
operator|-
name|ecore_cons_idx
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|diff
operator|>
name|TX_RING_SIZE
operator|)
operator|||
name|QL_ERR_INJECT
argument_list|(
name|ha
argument_list|,
name|QL_ERR_INJCT_TX_INT_DIFF
argument_list|)
condition|)
block|{
name|QL_RESET_ERR_INJECT
argument_list|(
name|ha
argument_list|,
name|QL_ERR_INJCT_TX_INT_DIFF
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"(diff = 0x%x) "
literal|" tx_idx = 0x%x"
literal|" ecore_prod_idx = 0x%x"
literal|" ecore_cons_idx = 0x%x"
literal|" hw_bd_cons = 0x%x"
literal|" txq_db_last = 0x%x"
literal|" elem_left = 0x%x\n"
argument_list|,
name|diff
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|ecore_chain_get_prod_idx
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|,
name|ecore_chain_get_cons_idx
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|,
name|le16toh
argument_list|(
operator|*
name|txq
operator|->
name|hw_cons_ptr
argument_list|)
argument_list|,
name|txq
operator|->
name|tx_db
operator|.
name|raw
argument_list|,
name|ecore_chain_get_elem_left
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_tx_cons_idx_conflict
operator|++
expr_stmt|;
comment|//DEBUG
name|qlnx_trigger_dump
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
name|qlnx_free_tx_pkt
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|txq
argument_list|)
expr_stmt|;
name|txq
operator|->
name|sw_tx_cons
operator|=
operator|(
name|txq
operator|->
name|sw_tx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|TX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
init|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|int
name|rss_id
init|=
literal|0
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
if|if
condition|(
name|M_HASHTYPE_GET
argument_list|(
name|mp
argument_list|)
operator|!=
name|M_HASHTYPE_NONE
condition|)
else|#
directive|else
if|if
condition|(
name|mp
operator|->
name|m_flags
operator|&
name|M_FLOWID
condition|)
endif|#
directive|endif
name|rss_id
operator|=
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|%
name|ECORE_RSS_IND_TABLE_SIZE
operator|)
operator|%
name|ha
operator|->
name|num_rss
expr_stmt|;
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|rss_id
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|tx_br
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|qlnx_transmit_exit
goto|;
block|}
if|if
condition|(
name|mp
operator|!=
name|NULL
condition|)
block|{
name|ret
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|,
name|mp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fp
operator|->
name|fp_taskqueue
operator|!=
name|NULL
condition|)
name|taskqueue_enqueue
argument_list|(
name|fp
operator|->
name|fp_taskqueue
argument_list|,
operator|&
name|fp
operator|->
name|fp_task
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|qlnx_transmit_exit
label|:
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit ret = %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_qflush
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|int
name|rss_id
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|rss_id
operator|=
literal|0
init|;
name|rss_id
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|rss_id
operator|++
control|)
block|{
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|rss_id
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|fp
operator|->
name|tx_br
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|mp
operator|=
name|drbr_dequeue
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|fp
operator|->
name|tx_pkts_freed
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
block|}
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_txq_doorbell_wr32
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|void
modifier|*
name|reg_addr
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|offset
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|reg_addr
operator|-
operator|(
name|uint8_t
operator|*
operator|)
name|cdev
operator|->
name|doorbells
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|ha
operator|->
name|pci_dbells
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|bus_barrier
argument_list|(
name|ha
operator|->
name|pci_reg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_BARRIER_READ
argument_list|)
expr_stmt|;
name|bus_barrier
argument_list|(
name|ha
operator|->
name|pci_dbells
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_BARRIER_READ
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|qlnx_tcp_offset
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
init|=
name|NULL
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
init|=
name|NULL
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|NULL
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|ehdrlen
init|=
literal|0
decl_stmt|,
name|ip_hlen
init|=
literal|0
decl_stmt|,
name|offset
init|=
literal|0
decl_stmt|;
name|uint16_t
name|etype
init|=
literal|0
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|uint8_t
name|buf
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
index|]
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|ehdrlen
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|buf
expr_stmt|;
block|}
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
name|offset
operator|=
name|ip_hlen
operator|+
name|ehdrlen
operator|+
operator|(
name|th
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
break|break;
case|case
name|ETHERTYPE_IPV6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|ehdrlen
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|buf
expr_stmt|;
block|}
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|ip6
operator|+
literal|1
operator|)
expr_stmt|;
name|offset
operator|=
name|ip_hlen
operator|+
name|ehdrlen
operator|+
operator|(
name|th
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|offset
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|qlnx_tso_check
parameter_list|(
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint32_t
name|sum
decl_stmt|,
name|nbds_in_hdr
init|=
literal|1
decl_stmt|;
name|bus_dma_segment_t
modifier|*
name|t_segs
init|=
name|segs
decl_stmt|;
comment|/* count the number of segments spanned by TCP header */
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|<
name|nsegs
operator|)
operator|&&
operator|(
name|offset
operator|>
name|t_segs
operator|->
name|ds_len
operator|)
condition|)
block|{
name|nbds_in_hdr
operator|++
expr_stmt|;
name|offset
operator|=
name|offset
operator|-
name|t_segs
operator|->
name|ds_len
expr_stmt|;
name|t_segs
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|nsegs
operator|>=
name|QLNX_MAX_SEGMENTS_NON_TSO
condition|)
block|{
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|ETH_TX_LSO_WINDOW_BDS_NUM
operator|-
name|nbds_in_hdr
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|sum
operator|+=
name|segs
operator|->
name|ds_len
expr_stmt|;
name|segs
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sum
operator|<
name|ETH_TX_LSO_WINDOW_MIN_LEN
condition|)
block|{
name|fp
operator|->
name|tx_lso_wnd_min_len
operator|++
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nsegs
operator|-=
name|QLNX_MAX_SEGMENTS_NON_TSO
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_send
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m_headp
parameter_list|)
block|{
name|bus_dma_segment_t
modifier|*
name|segs
decl_stmt|;
name|bus_dmamap_t
name|map
init|=
literal|0
decl_stmt|;
name|uint32_t
name|nsegs
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_head
init|=
operator|*
name|m_headp
decl_stmt|;
name|uint16_t
name|idx
init|=
literal|0
decl_stmt|;
name|uint16_t
name|elem_left
decl_stmt|;
name|uint8_t
name|nbd
init|=
literal|0
decl_stmt|;
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
decl_stmt|;
name|struct
name|eth_tx_1st_bd
modifier|*
name|first_bd
decl_stmt|;
name|struct
name|eth_tx_2nd_bd
modifier|*
name|second_bd
decl_stmt|;
name|struct
name|eth_tx_3rd_bd
modifier|*
name|third_bd
decl_stmt|;
name|struct
name|eth_tx_bd
modifier|*
name|tx_data_bd
decl_stmt|;
name|int
name|seg_idx
init|=
literal|0
decl_stmt|;
name|uint32_t
name|nbds_in_hdr
init|=
literal|0
decl_stmt|;
name|uint32_t
name|offset
init|=
literal|0
decl_stmt|;
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|link_up
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|first_bd
operator|=
name|NULL
expr_stmt|;
name|second_bd
operator|=
name|NULL
expr_stmt|;
name|third_bd
operator|=
name|NULL
expr_stmt|;
name|tx_data_bd
operator|=
name|NULL
expr_stmt|;
name|txq
operator|=
name|fp
operator|->
name|txq
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|tx_ring_full
condition|)
block|{
name|elem_left
operator|=
name|ecore_chain_get_elem_left
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
if|if
condition|(
name|elem_left
operator|<
operator|(
name|TX_RING_SIZE
operator|>>
literal|4
operator|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
else|else
name|fp
operator|->
name|tx_ring_full
operator|=
literal|0
expr_stmt|;
block|}
name|idx
operator|=
name|txq
operator|->
name|sw_tx_prod
expr_stmt|;
name|map
operator|=
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|map
expr_stmt|;
name|segs
operator|=
name|txq
operator|->
name|segs
expr_stmt|;
name|ret
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|,
name|m_head
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|dbg_trace_tso_pkt_len
condition|)
block|{
if|if
condition|(
operator|!
name|fp
operator|->
name|tx_tso_min_pkt_len
condition|)
block|{
name|fp
operator|->
name|tx_tso_min_pkt_len
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|fp
operator|->
name|tx_tso_min_pkt_len
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|fp
operator|->
name|tx_tso_min_pkt_len
operator|>
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
condition|)
name|fp
operator|->
name|tx_tso_min_pkt_len
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|tx_tso_max_pkt_len
operator|<
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
condition|)
name|fp
operator|->
name|tx_tso_max_pkt_len
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
name|offset
operator|=
name|qlnx_tcp_offset
argument_list|(
name|ha
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|==
name|EFBIG
operator|)
operator|||
operator|(
operator|(
name|nsegs
operator|>
name|QLNX_MAX_SEGMENTS_NON_TSO
operator|)
operator|&&
operator|(
operator|(
operator|!
operator|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
operator|)
operator|)
operator|||
operator|(
operator|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
operator|)
operator|&&
name|qlnx_tso_check
argument_list|(
name|fp
argument_list|,
name|segs
argument_list|,
name|nsegs
argument_list|,
name|offset
argument_list|)
operator|)
operator|)
operator|)
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
literal|"EFBIG [%d]\n"
argument_list|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_defrag
operator|++
expr_stmt|;
name|m
operator|=
name|m_defrag
argument_list|(
name|m_head
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|fp
operator|->
name|err_tx_defrag
operator|++
expr_stmt|;
name|fp
operator|->
name|tx_pkts_freed
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"m_defrag() = NULL [%d]\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|m_head
operator|=
name|m
expr_stmt|;
operator|*
name|m_headp
operator|=
name|m_head
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|,
name|m_head
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
operator|)
condition|)
block|{
name|fp
operator|->
name|err_tx_defrag_dmamap_load
operator|++
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"bus_dmamap_load_mbuf_sg failed0 [%d, %d]\n"
argument_list|,
name|ret
argument_list|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_pkts_freed
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|nsegs
operator|>
name|QLNX_MAX_SEGMENTS_NON_TSO
operator|)
operator|&&
operator|!
operator|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
operator|)
condition|)
block|{
name|fp
operator|->
name|err_tx_non_tso_max_seg
operator|++
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"(%d) nsegs too many for non-TSO [%d, %d]\n"
argument_list|,
name|ret
argument_list|,
name|nsegs
argument_list|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_pkts_freed
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
if|if
condition|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
name|offset
operator|=
name|qlnx_tcp_offset
argument_list|(
name|ha
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
condition|)
block|{
name|fp
operator|->
name|err_tx_dmamap_load
operator|++
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"bus_dmamap_load_mbuf_sg failed1 [%d, %d]\n"
argument_list|,
name|ret
argument_list|,
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_pkts_freed
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_headp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|QL_ASSERT
argument_list|(
name|ha
argument_list|,
operator|(
name|nsegs
operator|!=
literal|0
operator|)
argument_list|,
operator|(
literal|"qlnx_send: empty packet"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|dbg_trace_tso_pkt_len
condition|)
block|{
if|if
condition|(
name|nsegs
operator|<
name|QLNX_FP_MAX_SEGS
condition|)
name|fp
operator|->
name|tx_pkts
index|[
operator|(
name|nsegs
operator|-
literal|1
operator|)
index|]
operator|++
expr_stmt|;
else|else
name|fp
operator|->
name|tx_pkts
index|[
operator|(
name|QLNX_FP_MAX_SEGS
operator|-
literal|1
operator|)
index|]
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nsegs
operator|+
name|QLNX_TX_ELEM_RESERVE
operator|)
operator|>
call|(
name|int
call|)
argument_list|(
name|elem_left
operator|=
name|ecore_chain_get_elem_left
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"(%d, 0x%x) insuffient BDs"
literal|" in chain[%d] trying to free packets\n"
argument_list|,
name|nsegs
argument_list|,
name|elem_left
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_nsegs_gt_elem_left
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|qlnx_tx_int
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nsegs
operator|+
name|QLNX_TX_ELEM_RESERVE
operator|)
operator|>
call|(
name|int
call|)
argument_list|(
name|elem_left
operator|=
name|ecore_chain_get_elem_left
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"(%d, 0x%x) insuffient BDs in chain[%d]\n"
argument_list|,
name|nsegs
argument_list|,
name|elem_left
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_tx_nsegs_gt_elem_left
operator|++
expr_stmt|;
name|fp
operator|->
name|tx_ring_full
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|storm_stats_enable
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
block|}
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|mp
operator|=
name|m_head
expr_stmt|;
name|first_bd
operator|=
operator|(
expr|struct
name|eth_tx_1st_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|first_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|first_bd
argument_list|)
argument_list|)
expr_stmt|;
name|first_bd
operator|->
name|data
operator|.
name|bd_flags
operator|.
name|bitfields
operator|=
literal|1
operator|<<
name|ETH_TX_1ST_BD_FLAGS_START_BD_SHIFT
expr_stmt|;
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|first_bd
argument_list|,
name|segs
operator|->
name|ds_addr
argument_list|,
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
if|if
condition|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP
condition|)
block|{
name|first_bd
operator|->
name|data
operator|.
name|bd_flags
operator|.
name|bitfields
operator||=
operator|(
literal|1
operator|<<
name|ETH_TX_1ST_BD_FLAGS_IP_CSUM_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
operator|(
name|CSUM_UDP
operator||
name|CSUM_TCP
operator||
name|CSUM_TCP_IPV6
operator||
name|CSUM_UDP_IPV6
operator|)
condition|)
block|{
name|first_bd
operator|->
name|data
operator|.
name|bd_flags
operator|.
name|bitfields
operator||=
operator|(
literal|1
operator|<<
name|ETH_TX_1ST_BD_FLAGS_L4_CSUM_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|m_head
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
name|first_bd
operator|->
name|data
operator|.
name|vlan
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
expr_stmt|;
name|first_bd
operator|->
name|data
operator|.
name|bd_flags
operator|.
name|bitfields
operator||=
operator|(
literal|1
operator|<<
name|ETH_TX_1ST_BD_FLAGS_VLAN_INSERTION_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
name|first_bd
operator|->
name|data
operator|.
name|bd_flags
operator|.
name|bitfields
operator||=
operator|(
literal|1
operator|<<
name|ETH_TX_1ST_BD_FLAGS_LSO_SHIFT
operator|)
expr_stmt|;
name|first_bd
operator|->
name|data
operator|.
name|bd_flags
operator|.
name|bitfields
operator||=
operator|(
literal|1
operator|<<
name|ETH_TX_1ST_BD_FLAGS_IP_CSUM_SHIFT
operator|)
expr_stmt|;
name|nbds_in_hdr
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|offset
operator|==
name|segs
operator|->
name|ds_len
condition|)
block|{
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|first_bd
argument_list|,
name|segs
operator|->
name|ds_addr
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|seg_idx
operator|++
expr_stmt|;
name|second_bd
operator|=
operator|(
expr|struct
name|eth_tx_2nd_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|second_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|second_bd
argument_list|)
argument_list|)
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
if|if
condition|(
name|seg_idx
operator|<
name|nsegs
condition|)
block|{
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|second_bd
argument_list|, \
operator|(
name|segs
operator|->
name|ds_addr
operator|)
argument_list|,
operator|(
name|segs
operator|->
name|ds_len
operator|)
argument_list|)
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|seg_idx
operator|++
expr_stmt|;
block|}
name|third_bd
operator|=
operator|(
expr|struct
name|eth_tx_3rd_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|third_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|third_bd
argument_list|)
argument_list|)
expr_stmt|;
name|third_bd
operator|->
name|data
operator|.
name|lso_mss
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
name|third_bd
operator|->
name|data
operator|.
name|bitfields
operator||=
operator|(
name|nbds_in_hdr
operator|<<
name|ETH_TX_DATA_3RD_BD_HDR_NBD_SHIFT
operator|)
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
if|if
condition|(
name|seg_idx
operator|<
name|nsegs
condition|)
block|{
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|third_bd
argument_list|, \
operator|(
name|segs
operator|->
name|ds_addr
operator|)
argument_list|,
operator|(
name|segs
operator|->
name|ds_len
operator|)
argument_list|)
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|seg_idx
operator|++
expr_stmt|;
block|}
for|for
control|(
init|;
name|seg_idx
operator|<
name|nsegs
condition|;
name|seg_idx
operator|++
control|)
block|{
name|tx_data_bd
operator|=
operator|(
expr|struct
name|eth_tx_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tx_data_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tx_data_bd
argument_list|)
argument_list|)
expr_stmt|;
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|tx_data_bd
argument_list|, \
name|segs
operator|->
name|ds_addr
argument_list|,\
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|offset
operator|<
name|segs
operator|->
name|ds_len
condition|)
block|{
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|first_bd
argument_list|,
name|segs
operator|->
name|ds_addr
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|second_bd
operator|=
operator|(
expr|struct
name|eth_tx_2nd_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|second_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|second_bd
argument_list|)
argument_list|)
expr_stmt|;
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|second_bd
argument_list|, \
operator|(
name|segs
operator|->
name|ds_addr
operator|+
name|offset
operator|)
argument_list|,\
operator|(
name|segs
operator|->
name|ds_len
operator|-
name|offset
operator|)
argument_list|)
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|third_bd
operator|=
operator|(
expr|struct
name|eth_tx_3rd_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|third_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|third_bd
argument_list|)
argument_list|)
expr_stmt|;
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|third_bd
argument_list|, \
name|segs
operator|->
name|ds_addr
argument_list|,\
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|third_bd
operator|->
name|data
operator|.
name|lso_mss
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
name|third_bd
operator|->
name|data
operator|.
name|bitfields
operator||=
operator|(
name|nbds_in_hdr
operator|<<
name|ETH_TX_DATA_3RD_BD_HDR_NBD_SHIFT
operator|)
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
for|for
control|(
name|seg_idx
operator|=
literal|2
init|;
name|seg_idx
operator|<
name|nsegs
condition|;
name|seg_idx
operator|++
control|)
block|{
name|tx_data_bd
operator|=
operator|(
expr|struct
name|eth_tx_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tx_data_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tx_data_bd
argument_list|)
argument_list|)
expr_stmt|;
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|tx_data_bd
argument_list|, \
name|segs
operator|->
name|ds_addr
argument_list|,\
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|offset
operator|=
name|offset
operator|-
name|segs
operator|->
name|ds_len
expr_stmt|;
name|segs
operator|++
expr_stmt|;
for|for
control|(
name|seg_idx
operator|=
literal|1
init|;
name|seg_idx
operator|<
name|nsegs
condition|;
name|seg_idx
operator|++
control|)
block|{
if|if
condition|(
name|offset
condition|)
name|nbds_in_hdr
operator|++
expr_stmt|;
name|tx_data_bd
operator|=
operator|(
expr|struct
name|eth_tx_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tx_data_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tx_data_bd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|second_bd
operator|==
name|NULL
condition|)
block|{
name|second_bd
operator|=
operator|(
expr|struct
name|eth_tx_2nd_bd
operator|*
operator|)
name|tx_data_bd
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|third_bd
operator|==
name|NULL
condition|)
block|{
name|third_bd
operator|=
operator|(
expr|struct
name|eth_tx_3rd_bd
operator|*
operator|)
name|tx_data_bd
expr_stmt|;
block|}
if|if
condition|(
name|offset
operator|&&
operator|(
name|offset
operator|<
name|segs
operator|->
name|ds_len
operator|)
condition|)
block|{
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|tx_data_bd
argument_list|,\
name|segs
operator|->
name|ds_addr
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|tx_data_bd
operator|=
operator|(
expr|struct
name|eth_tx_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tx_data_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tx_data_bd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|second_bd
operator|==
name|NULL
condition|)
block|{
name|second_bd
operator|=
operator|(
expr|struct
name|eth_tx_2nd_bd
operator|*
operator|)
name|tx_data_bd
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|third_bd
operator|==
name|NULL
condition|)
block|{
name|third_bd
operator|=
operator|(
expr|struct
name|eth_tx_3rd_bd
operator|*
operator|)
name|tx_data_bd
expr_stmt|;
block|}
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|tx_data_bd
argument_list|,\
operator|(
name|segs
operator|->
name|ds_addr
operator|+
name|offset
operator|)
argument_list|, \
operator|(
name|segs
operator|->
name|ds_len
operator|-
name|offset
operator|)
argument_list|)
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|offset
condition|)
name|offset
operator|=
name|offset
operator|-
name|segs
operator|->
name|ds_len
expr_stmt|;
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|tx_data_bd
argument_list|,\
name|segs
operator|->
name|ds_addr
argument_list|,
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
block|}
name|segs
operator|++
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|third_bd
operator|==
name|NULL
condition|)
block|{
name|third_bd
operator|=
operator|(
expr|struct
name|eth_tx_3rd_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|third_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|third_bd
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|third_bd
operator|->
name|data
operator|.
name|lso_mss
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
name|third_bd
operator|->
name|data
operator|.
name|bitfields
operator||=
operator|(
name|nbds_in_hdr
operator|<<
name|ETH_TX_DATA_3RD_BD_HDR_NBD_SHIFT
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|segs
operator|++
expr_stmt|;
for|for
control|(
name|seg_idx
operator|=
literal|1
init|;
name|seg_idx
operator|<
name|nsegs
condition|;
name|seg_idx
operator|++
control|)
block|{
name|tx_data_bd
operator|=
operator|(
expr|struct
name|eth_tx_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tx_data_bd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tx_data_bd
argument_list|)
argument_list|)
expr_stmt|;
name|BD_SET_UNMAP_ADDR_LEN
argument_list|(
name|tx_data_bd
argument_list|,
name|segs
operator|->
name|ds_addr
argument_list|,\
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|nbd
operator|++
expr_stmt|;
block|}
name|first_bd
operator|->
name|data
operator|.
name|bitfields
operator|=
operator|(
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
operator|&
name|ETH_TX_DATA_1ST_BD_PKT_LEN_MASK
operator|)
operator|<<
name|ETH_TX_DATA_1ST_BD_PKT_LEN_SHIFT
expr_stmt|;
name|first_bd
operator|->
name|data
operator|.
name|bitfields
operator|=
name|htole16
argument_list|(
name|first_bd
operator|->
name|data
operator|.
name|bitfields
argument_list|)
expr_stmt|;
block|}
name|first_bd
operator|->
name|data
operator|.
name|nbds
operator|=
name|nbd
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|dbg_trace_tso_pkt_len
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|tx_tso_max_nsegs
operator|<
name|nsegs
condition|)
name|fp
operator|->
name|tx_tso_max_nsegs
operator|=
name|nsegs
expr_stmt|;
if|if
condition|(
operator|(
name|nsegs
operator|<
name|fp
operator|->
name|tx_tso_min_nsegs
operator|)
operator|||
operator|(
operator|!
name|fp
operator|->
name|tx_tso_min_nsegs
operator|)
condition|)
name|fp
operator|->
name|tx_tso_min_nsegs
operator|=
name|nsegs
expr_stmt|;
block|}
name|txq
operator|->
name|sw_tx_ring
index|[
name|idx
index|]
operator|.
name|nsegs
operator|=
name|nsegs
expr_stmt|;
name|txq
operator|->
name|sw_tx_prod
operator|=
operator|(
name|txq
operator|->
name|sw_tx_prod
operator|+
literal|1
operator|)
operator|&
operator|(
name|TX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|txq
operator|->
name|tx_db
operator|.
name|data
operator|.
name|bd_prod
operator|=
name|htole16
argument_list|(
name|ecore_chain_get_prod_idx
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|)
expr_stmt|;
name|qlnx_txq_doorbell_wr32
argument_list|(
name|ha
argument_list|,
name|txq
operator|->
name|doorbell_addr
argument_list|,
name|txq
operator|->
name|tx_db
operator|.
name|raw
argument_list|)
expr_stmt|;
name|QL_DPRINT8
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_stop
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_OACTIVE
operator||
name|IFF_DRV_RUNNING
operator|)
expr_stmt|;
comment|/* 	 * We simply lock and unlock each fp->tx_mtx to 	 * propagate the if_drv_flags 	 * state to each tx thread 	 */
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"QLNX STATE = %d\n"
argument_list|,
name|ha
operator|->
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|state
operator|==
name|QLNX_STATE_OPEN
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|qlnx_fastpath
modifier|*
name|fp
init|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fp_taskqueue
operator|!=
name|NULL
condition|)
name|taskqueue_enqueue
argument_list|(
name|fp
operator|->
name|fp_taskqueue
argument_list|,
operator|&
name|fp
operator|->
name|fp_task
argument_list|)
expr_stmt|;
block|}
block|}
name|qlnx_unload
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_get_ifq_snd_maxlen
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
return|return
operator|(
name|TX_RING_SIZE
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|uint8_t
modifier|*
name|qlnx_get_mac_addr
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
literal|0
index|]
expr_stmt|;
return|return
operator|(
name|p_hwfn
operator|->
name|hw_info
operator|.
name|hw_mac_addr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|qlnx_get_optics
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_link_output
modifier|*
name|if_link
parameter_list|)
block|{
name|uint32_t
name|ifm_type
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|if_link
operator|->
name|media_type
condition|)
block|{
case|case
name|MEDIA_MODULE_FIBER
case|:
case|case
name|MEDIA_UNSPECIFIED
case|:
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|100
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
name|QLNX_IFM_100G_SR4
expr_stmt|;
elseif|else
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|40
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
name|IFM_40G_SR4
expr_stmt|;
elseif|else
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|25
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
name|QLNX_IFM_25G_SR
expr_stmt|;
elseif|else
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|10
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
operator|(
name|IFM_10G_LR
operator||
name|IFM_10G_SR
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|1
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
operator|(
name|IFM_1000_SX
operator||
name|IFM_1000_LX
operator|)
expr_stmt|;
break|break;
case|case
name|MEDIA_DA_TWINAX
case|:
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|100
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
name|QLNX_IFM_100G_CR4
expr_stmt|;
elseif|else
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|40
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
name|IFM_40G_CR4
expr_stmt|;
elseif|else
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|25
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
name|QLNX_IFM_25G_CR
expr_stmt|;
elseif|else
if|if
condition|(
name|if_link
operator|->
name|speed
operator|==
operator|(
literal|10
operator|*
literal|1000
operator|)
condition|)
name|ifm_type
operator|=
name|IFM_10G_TWINAX
expr_stmt|;
break|break;
default|default :
name|ifm_type
operator|=
name|IFM_UNKNOWN
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ifm_type
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  * Interrupt Service Functions  *****************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|qlnx_rx_jumbo_chain
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp_head
parameter_list|,
name|uint16_t
name|len
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|,
modifier|*
name|mpf
decl_stmt|,
modifier|*
name|mpl
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data
decl_stmt|;
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
decl_stmt|;
name|uint16_t
name|len_in_buffer
decl_stmt|;
name|rxq
operator|=
name|fp
operator|->
name|rxq
expr_stmt|;
name|mpf
operator|=
name|mpl
operator|=
name|mp
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_cons
index|]
expr_stmt|;
name|mp
operator|=
name|sw_rx_data
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"mp = NULL\n"
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_mp_null
operator|++
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|sw_rx_data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|qlnx_alloc_rx_buffer
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"New buffer allocation failed, dropping"
literal|" incoming packet and reusing its buffer\n"
argument_list|)
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_alloc_errors
operator|++
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|rxq
operator|->
name|rx_buf_size
condition|)
name|len_in_buffer
operator|=
name|rxq
operator|->
name|rx_buf_size
expr_stmt|;
else|else
name|len_in_buffer
operator|=
name|len
expr_stmt|;
name|len
operator|=
name|len
operator|-
name|len_in_buffer
expr_stmt|;
name|mp
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
name|mp
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
name|mp
operator|->
name|m_len
operator|=
name|len_in_buffer
expr_stmt|;
if|if
condition|(
name|mpf
operator|==
name|NULL
condition|)
name|mpf
operator|=
name|mpl
operator|=
name|mp
expr_stmt|;
else|else
block|{
name|mpl
operator|->
name|m_next
operator|=
name|mp
expr_stmt|;
name|mpl
operator|=
name|mp
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|mp_head
operator|->
name|m_next
operator|=
name|mpf
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_tpa_start
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|,
name|struct
name|eth_fast_path_rx_tpa_start_cqe
modifier|*
name|cqe
parameter_list|)
block|{
name|uint32_t
name|agg_index
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mpf
init|=
name|NULL
decl_stmt|,
modifier|*
name|mpl
init|=
name|NULL
decl_stmt|,
modifier|*
name|mpc
init|=
name|NULL
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data
decl_stmt|;
name|dma_addr_t
name|addr
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|struct
name|eth_rx_bd
modifier|*
name|rx_bd
decl_stmt|;
name|int
name|i
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
name|uint8_t
name|hash_type
decl_stmt|;
endif|#
directive|endif
comment|/* #if __FreeBSD_version>= 1100000 */
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|agg_index
operator|=
name|cqe
operator|->
name|tpa_agg_index
expr_stmt|;
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[rss_id = %d]: enter\n \                 \t type = 0x%x\n \                 \t bitfields = 0x%x\n \                 \t seg_len = 0x%x\n \                 \t pars_flags = 0x%x\n \                 \t vlan_tag = 0x%x\n \                 \t rss_hash = 0x%x\n \                 \t len_on_first_bd = 0x%x\n \                 \t placement_offset = 0x%x\n \                 \t tpa_agg_index = 0x%x\n \                 \t header_len = 0x%x\n \                 \t ext_bd_len_list[0] = 0x%x\n \                 \t ext_bd_len_list[1] = 0x%x\n \                 \t ext_bd_len_list[2] = 0x%x\n \                 \t ext_bd_len_list[3] = 0x%x\n \                 \t ext_bd_len_list[4] = 0x%x\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|cqe
operator|->
name|type
argument_list|,
name|cqe
operator|->
name|bitfields
argument_list|,
name|cqe
operator|->
name|seg_len
argument_list|,
name|cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|,
name|cqe
operator|->
name|vlan_tag
argument_list|,
name|cqe
operator|->
name|rss_hash
argument_list|,
name|cqe
operator|->
name|len_on_first_bd
argument_list|,
name|cqe
operator|->
name|placement_offset
argument_list|,
name|cqe
operator|->
name|tpa_agg_index
argument_list|,
name|cqe
operator|->
name|header_len
argument_list|,
name|cqe
operator|->
name|ext_bd_len_list
index|[
literal|0
index|]
argument_list|,
name|cqe
operator|->
name|ext_bd_len_list
index|[
literal|1
index|]
argument_list|,
name|cqe
operator|->
name|ext_bd_len_list
index|[
literal|2
index|]
argument_list|,
name|cqe
operator|->
name|ext_bd_len_list
index|[
literal|3
index|]
argument_list|,
name|cqe
operator|->
name|ext_bd_len_list
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|agg_index
operator|>=
name|ETH_TPA_MAX_AGGS_NUM
condition|)
block|{
name|fp
operator|->
name|err_rx_tpa_invalid_agg_num
operator|++
expr_stmt|;
return|return;
block|}
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_cons
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|sw_rx_data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|mp
operator|=
name|sw_rx_data
operator|->
name|data
expr_stmt|;
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[rss_id = %d]: mp = %p \n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|mp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: mp = NULL\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_mp_null
operator|++
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|le16toh
argument_list|(
name|cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
operator|)
operator|&
name|CQE_FLAGS_ERR
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: CQE in CONS = %u has error,"
literal|" flags = %x, dropping incoming packet\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|rxq
operator|->
name|sw_rx_cons
argument_list|,
name|le16toh
argument_list|(
name|cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_hw_errors
operator|++
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|QLNX_INC_IERRORS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|qlnx_alloc_rx_buffer
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: New buffer allocation failed,"
literal|" dropping incoming packet and reusing its buffer\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_alloc_errors
operator|++
expr_stmt|;
name|QLNX_INC_IQDROPS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* 		 * Load the tpa mbuf into the rx ring and save the  		 * posted mbuf 		 */
name|map
operator|=
name|sw_rx_data
operator|->
name|map
expr_stmt|;
name|addr
operator|=
name|sw_rx_data
operator|->
name|dma_addr
expr_stmt|;
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_prod
index|]
expr_stmt|;
name|sw_rx_data
operator|->
name|data
operator|=
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|rx_buf
operator|.
name|data
expr_stmt|;
name|sw_rx_data
operator|->
name|dma_addr
operator|=
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|rx_buf
operator|.
name|dma_addr
expr_stmt|;
name|sw_rx_data
operator|->
name|map
operator|=
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|rx_buf
operator|.
name|map
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|rx_buf
operator|.
name|data
operator|=
name|mp
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|rx_buf
operator|.
name|dma_addr
operator|=
name|addr
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|rx_buf
operator|.
name|map
operator|=
name|map
expr_stmt|;
name|rx_bd
operator|=
operator|(
expr|struct
name|eth_rx_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rx_bd
operator|->
name|addr
operator|.
name|hi
operator|=
name|htole32
argument_list|(
name|U64_HI
argument_list|(
name|sw_rx_data
operator|->
name|dma_addr
argument_list|)
argument_list|)
expr_stmt|;
name|rx_bd
operator|->
name|addr
operator|.
name|lo
operator|=
name|htole32
argument_list|(
name|U64_LO
argument_list|(
name|sw_rx_data
operator|->
name|dma_addr
argument_list|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|sw_rx_data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_prod
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_prod
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
comment|/* Now reuse any buffers posted in ext_bd_len_list */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_TPA_CQE_START_LEN_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cqe
operator|->
name|ext_bd_len_list
index|[
name|i
index|]
operator|==
literal|0
condition|)
break|break;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
block|}
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|!=
name|QLNX_AGG_STATE_NONE
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: invalid aggregation state,"
literal|" dropping incoming packet and reusing its buffer\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|QLNX_INC_IQDROPS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* if we already have mbuf head in aggregation free it */
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
condition|)
block|{
name|m_freem
argument_list|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|NULL
expr_stmt|;
block|}
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
operator|=
name|mp
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
comment|/* Now reuse any buffers posted in ext_bd_len_list */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_TPA_CQE_START_LEN_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cqe
operator|->
name|ext_bd_len_list
index|[
name|i
index|]
operator|==
literal|0
condition|)
break|break;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
block|}
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
return|return;
block|}
comment|/* 	 * first process the ext_bd_len_list  	 * if this fails then we simply drop the packet 	 */
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_TPA_CQE_START_LEN_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 4\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|cqe
operator|->
name|ext_bd_len_list
index|[
name|i
index|]
operator|==
literal|0
condition|)
break|break;
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_cons
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|sw_rx_data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|mpc
operator|=
name|sw_rx_data
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|mpc
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: mpc = NULL\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_mp_null
operator|++
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
name|mpf
operator|=
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|qlnx_alloc_rx_buffer
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: New buffer allocation failed,"
literal|" dropping incoming packet and reusing its"
literal|" buffer\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
name|mpf
operator|=
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
continue|continue;
block|}
name|mpc
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
name|mpc
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
name|mpc
operator|->
name|m_len
operator|=
name|cqe
operator|->
name|ext_bd_len_list
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mpf
operator|==
name|NULL
condition|)
block|{
name|mpf
operator|=
name|mpl
operator|=
name|mpc
expr_stmt|;
block|}
else|else
block|{
name|mpl
operator|->
name|m_len
operator|=
name|ha
operator|->
name|rx_buf_size
expr_stmt|;
name|mpl
operator|->
name|m_next
operator|=
name|mpc
expr_stmt|;
name|mpl
operator|=
name|mpc
expr_stmt|;
block|}
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|!=
name|QLNX_AGG_STATE_NONE
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: invalid aggregation state, dropping"
literal|" incoming packet and reusing its buffer\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|QLNX_INC_IQDROPS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
operator|=
name|mp
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|placement_offset
operator|=
name|cqe
operator|->
name|placement_offset
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
block|{
name|mp
operator|->
name|m_len
operator|=
name|ha
operator|->
name|rx_buf_size
expr_stmt|;
name|mp
operator|->
name|m_next
operator|=
name|mpf
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
operator|=
name|mp
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|mpl
expr_stmt|;
block|}
else|else
block|{
name|mp
operator|->
name|m_len
operator|=
name|cqe
operator|->
name|len_on_first_bd
operator|+
name|cqe
operator|->
name|placement_offset
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
operator|=
name|mp
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|mp
expr_stmt|;
name|mp
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
block|}
name|mp
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
comment|/* assign packet to this interface interface */
name|mp
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
comment|/* assume no hardware checksum has complated */
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
literal|0
expr_stmt|;
comment|//mp->m_pkthdr.flowid = fp->rss_id;
name|mp
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|cqe
operator|->
name|rss_hash
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
name|hash_type
operator|=
name|cqe
operator|->
name|bitfields
operator|&
operator|(
name|ETH_FAST_PATH_RX_REG_CQE_RSS_HASH_TYPE_MASK
operator|<<
name|ETH_FAST_PATH_RX_REG_CQE_RSS_HASH_TYPE_SHIFT
operator|)
expr_stmt|;
switch|switch
condition|(
name|hash_type
condition|)
block|{
case|case
name|RSS_HASH_TYPE_IPV4
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSS_HASH_TYPE_TCP_IPV4
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSS_HASH_TYPE_IPV6
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_IPV6
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSS_HASH_TYPE_TCP_IPV6
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV6
argument_list|)
expr_stmt|;
break|break;
default|default:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
break|break;
block|}
else|#
directive|else
name|mp
operator|->
name|m_flags
operator||=
name|M_FLOWID
expr_stmt|;
endif|#
directive|endif
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
operator|(
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
operator||
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
operator|)
expr_stmt|;
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|CQE_HAS_VLAN
argument_list|(
name|cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
condition|)
block|{
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|le16toh
argument_list|(
name|cqe
operator|->
name|vlan_tag
argument_list|)
expr_stmt|;
name|mp
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_START
expr_stmt|;
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 5\n\tagg_state = %d\n\t mpf = %p mpl = %p\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
argument_list|,
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
argument_list|,
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_tpa_cont
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|,
name|struct
name|eth_fast_path_rx_tpa_cont_cqe
modifier|*
name|cqe
parameter_list|)
block|{
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mpf
init|=
name|NULL
decl_stmt|,
modifier|*
name|mpl
init|=
name|NULL
decl_stmt|,
modifier|*
name|mpc
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|uint32_t
name|agg_index
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: enter\n \                 \t type = 0x%x\n \                 \t tpa_agg_index = 0x%x\n \                 \t len_list[0] = 0x%x\n \                 \t len_list[1] = 0x%x\n \                 \t len_list[2] = 0x%x\n \                 \t len_list[3] = 0x%x\n \                 \t len_list[4] = 0x%x\n \                 \t len_list[5] = 0x%x\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|cqe
operator|->
name|type
argument_list|,
name|cqe
operator|->
name|tpa_agg_index
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|0
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|1
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|2
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|3
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|4
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|agg_index
operator|=
name|cqe
operator|->
name|tpa_agg_index
expr_stmt|;
if|if
condition|(
name|agg_index
operator|>=
name|ETH_TPA_MAX_AGGS_NUM
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 0\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_tpa_invalid_agg_num
operator|++
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_TPA_CQE_CONT_LEN_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 1\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|cqe
operator|->
name|len_list
index|[
name|i
index|]
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|!=
name|QLNX_AGG_STATE_START
condition|)
block|{
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_cons
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|sw_rx_data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|mpc
operator|=
name|sw_rx_data
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|mpc
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: mpc = NULL\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_mp_null
operator|++
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
name|mpf
operator|=
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|qlnx_alloc_rx_buffer
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: New buffer allocation failed,"
literal|" dropping incoming packet and reusing its"
literal|" buffer\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
name|mpf
operator|=
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
continue|continue;
block|}
name|mpc
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
name|mpc
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
name|mpc
operator|->
name|m_len
operator|=
name|cqe
operator|->
name|len_list
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mpf
operator|==
name|NULL
condition|)
block|{
name|mpf
operator|=
name|mpl
operator|=
name|mpc
expr_stmt|;
block|}
else|else
block|{
name|mpl
operator|->
name|m_len
operator|=
name|ha
operator|->
name|rx_buf_size
expr_stmt|;
name|mpl
operator|->
name|m_next
operator|=
name|mpc
expr_stmt|;
name|mpl
operator|=
name|mpc
expr_stmt|;
block|}
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 2\n"
literal|"\tmpf = %p mpl = %p\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|mpf
argument_list|,
name|mpl
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
block|{
name|mp
operator|=
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
expr_stmt|;
name|mp
operator|->
name|m_len
operator|=
name|ha
operator|->
name|rx_buf_size
expr_stmt|;
name|mp
operator|->
name|m_next
operator|=
name|mpf
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|mpl
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_tpa_end
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|,
name|struct
name|eth_fast_path_rx_tpa_end_cqe
modifier|*
name|cqe
parameter_list|)
block|{
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mpf
init|=
name|NULL
decl_stmt|,
modifier|*
name|mpl
init|=
name|NULL
decl_stmt|,
modifier|*
name|mpc
init|=
name|NULL
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|uint32_t
name|agg_index
decl_stmt|;
name|uint32_t
name|len
init|=
literal|0
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: enter\n \                 \t type = 0x%x\n \                 \t tpa_agg_index = 0x%x\n \                 \t total_packet_len = 0x%x\n \                 \t num_of_bds = 0x%x\n \                 \t end_reason = 0x%x\n \                 \t num_of_coalesced_segs = 0x%x\n \                 \t ts_delta = 0x%x\n \                 \t len_list[0] = 0x%x\n \                 \t len_list[1] = 0x%x\n \                 \t len_list[2] = 0x%x\n \                 \t len_list[3] = 0x%x\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|cqe
operator|->
name|type
argument_list|,
name|cqe
operator|->
name|tpa_agg_index
argument_list|,
name|cqe
operator|->
name|total_packet_len
argument_list|,
name|cqe
operator|->
name|num_of_bds
argument_list|,
name|cqe
operator|->
name|end_reason
argument_list|,
name|cqe
operator|->
name|num_of_coalesced_segs
argument_list|,
name|cqe
operator|->
name|ts_delta
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|0
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|1
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|2
index|]
argument_list|,
name|cqe
operator|->
name|len_list
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|agg_index
operator|=
name|cqe
operator|->
name|tpa_agg_index
expr_stmt|;
if|if
condition|(
name|agg_index
operator|>=
name|ETH_TPA_MAX_AGGS_NUM
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 0\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_tpa_invalid_agg_num
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_TPA_CQE_END_LEN_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 1\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|cqe
operator|->
name|len_list
index|[
name|i
index|]
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|!=
name|QLNX_AGG_STATE_START
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 2\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_cons
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|sw_rx_data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|mpc
operator|=
name|sw_rx_data
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|mpc
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: mpc = NULL\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_mp_null
operator|++
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
name|mpf
operator|=
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|qlnx_alloc_rx_buffer
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: New buffer allocation failed,"
literal|" dropping incoming packet and reusing its"
literal|" buffer\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|mpf
argument_list|)
expr_stmt|;
name|mpf
operator|=
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_ERROR
expr_stmt|;
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
continue|continue;
block|}
name|mpc
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
name|mpc
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
name|mpc
operator|->
name|m_len
operator|=
name|cqe
operator|->
name|len_list
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mpf
operator|==
name|NULL
condition|)
block|{
name|mpf
operator|=
name|mpl
operator|=
name|mpc
expr_stmt|;
block|}
else|else
block|{
name|mpl
operator|->
name|m_len
operator|=
name|ha
operator|->
name|rx_buf_size
expr_stmt|;
name|mpl
operator|->
name|m_next
operator|=
name|mpc
expr_stmt|;
name|mpl
operator|=
name|mpc
expr_stmt|;
block|}
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 5\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|mpf
operator|!=
name|NULL
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 6\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|mp
operator|=
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
expr_stmt|;
name|mp
operator|->
name|m_len
operator|=
name|ha
operator|->
name|rx_buf_size
expr_stmt|;
name|mp
operator|->
name|m_next
operator|=
name|mpf
expr_stmt|;
block|}
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|!=
name|QLNX_AGG_STATE_START
condition|)
block|{
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 7\n "
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_NONE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|mp
operator|=
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
expr_stmt|;
name|m_adj
argument_list|(
name|mp
argument_list|,
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|placement_offset
argument_list|)
expr_stmt|;
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|cqe
operator|->
name|total_packet_len
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_next
operator|==
name|NULL
condition|)
name|mp
operator|->
name|m_len
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
else|else
block|{
comment|/* compute the total packet length */
name|mpf
operator|=
name|mp
expr_stmt|;
while|while
condition|(
name|mpf
operator|!=
name|NULL
condition|)
block|{
name|len
operator|+=
name|mpf
operator|->
name|m_len
expr_stmt|;
name|mpf
operator|=
name|mpf
operator|->
name|m_next
expr_stmt|;
block|}
if|if
condition|(
name|cqe
operator|->
name|total_packet_len
operator|>
name|len
condition|)
block|{
name|mpl
operator|=
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
expr_stmt|;
name|mpl
operator|->
name|m_len
operator|+=
operator|(
name|cqe
operator|->
name|total_packet_len
operator|-
name|len
operator|)
expr_stmt|;
block|}
block|}
name|QLNX_INC_IPACKETS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|QLNX_INC_IBYTES
argument_list|(
name|ifp
argument_list|,
operator|(
name|cqe
operator|->
name|total_packet_len
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT7
argument_list|(
name|ha
argument_list|,
literal|"[%d]: 8 csum_data = 0x%x csum_flags = 0x%lx\n \ 		m_len = 0x%x m_pkthdr_len = 0x%x\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_data
argument_list|,
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
argument_list|,
name|mp
operator|->
name|m_len
argument_list|,
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|mp
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpf
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|mpl
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|tpa_info
index|[
name|agg_index
index|]
operator|.
name|agg_state
operator|=
name|QLNX_AGG_STATE_NONE
expr_stmt|;
return|return
operator|(
name|cqe
operator|->
name|num_of_coalesced_segs
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_rx_int
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|int
name|budget
parameter_list|,
name|int
name|lro_enable
parameter_list|)
block|{
name|uint16_t
name|hw_comp_cons
decl_stmt|,
name|sw_comp_cons
decl_stmt|;
name|int
name|rx_pkt
init|=
literal|0
decl_stmt|;
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
init|=
name|fp
operator|->
name|rxq
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
init|=
operator|&
name|ha
operator|->
name|cdev
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
ifdef|#
directive|ifdef
name|QLNX_SOFT_LRO
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
name|lro
operator|=
operator|&
name|rxq
operator|->
name|lro
expr_stmt|;
endif|#
directive|endif
comment|/* #ifdef QLNX_SOFT_LRO */
name|hw_comp_cons
operator|=
name|le16toh
argument_list|(
operator|*
name|rxq
operator|->
name|hw_cons_ptr
argument_list|)
expr_stmt|;
name|sw_comp_cons
operator|=
name|ecore_chain_get_cons_idx
argument_list|(
operator|&
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
expr_stmt|;
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
operator|(
name|fp
operator|->
name|rss_id
operator|%
name|cdev
operator|->
name|num_hwfns
operator|)
index|]
expr_stmt|;
comment|/* Memory barrier to prevent the CPU from doing speculative reads of CQE          * / BD in the while-loop before reading hw_comp_cons. If the CQE is          * read before it is written by FW, then FW writes CQE and SB, and then          * the CPU reads the hw_comp_cons, it will use an old CQE.          */
comment|/* Loop to complete all indicated BDs */
while|while
condition|(
name|sw_comp_cons
operator|!=
name|hw_comp_cons
condition|)
block|{
name|union
name|eth_rx_cqe
modifier|*
name|cqe
decl_stmt|;
name|struct
name|eth_fast_path_rx_reg_cqe
modifier|*
name|fp_cqe
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data
decl_stmt|;
specifier|register
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|enum
name|eth_rx_cqe_type
name|cqe_type
decl_stmt|;
name|uint16_t
name|len
decl_stmt|,
name|pad
decl_stmt|,
name|len_on_first_bd
decl_stmt|;
name|uint8_t
modifier|*
name|data
decl_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
name|uint8_t
name|hash_type
decl_stmt|;
endif|#
directive|endif
comment|/* #if __FreeBSD_version>= 1100000 */
comment|/* Get the CQE from the completion ring */
name|cqe
operator|=
operator|(
expr|union
name|eth_rx_cqe
operator|*
operator|)
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
expr_stmt|;
name|cqe_type
operator|=
name|cqe
operator|->
name|fast_path_regular
operator|.
name|type
expr_stmt|;
if|if
condition|(
name|cqe_type
operator|==
name|ETH_RX_CQE_TYPE_SLOW_PATH
condition|)
block|{
name|QL_DPRINT3
argument_list|(
name|ha
argument_list|,
literal|"Got a slowath CQE\n"
argument_list|)
expr_stmt|;
name|ecore_eth_cqe_completion
argument_list|(
name|p_hwfn
argument_list|,
operator|(
expr|struct
name|eth_slow_path_rx_cqe
operator|*
operator|)
name|cqe
argument_list|)
expr_stmt|;
goto|goto
name|next_cqe
goto|;
block|}
if|if
condition|(
name|cqe_type
operator|!=
name|ETH_RX_CQE_TYPE_REGULAR
condition|)
block|{
switch|switch
condition|(
name|cqe_type
condition|)
block|{
case|case
name|ETH_RX_CQE_TYPE_TPA_START
case|:
name|qlnx_tpa_start
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|rxq
argument_list|,
operator|&
name|cqe
operator|->
name|fast_path_tpa_start
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tpa_start
operator|++
expr_stmt|;
break|break;
case|case
name|ETH_RX_CQE_TYPE_TPA_CONT
case|:
name|qlnx_tpa_cont
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|rxq
argument_list|,
operator|&
name|cqe
operator|->
name|fast_path_tpa_cont
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tpa_cont
operator|++
expr_stmt|;
break|break;
case|case
name|ETH_RX_CQE_TYPE_TPA_END
case|:
name|rx_pkt
operator|+=
name|qlnx_tpa_end
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|rxq
argument_list|,
operator|&
name|cqe
operator|->
name|fast_path_tpa_end
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tpa_end
operator|++
expr_stmt|;
break|break;
default|default:
break|break;
block|}
goto|goto
name|next_cqe
goto|;
block|}
comment|/* Get the data from the SW ring */
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_cons
index|]
expr_stmt|;
name|mp
operator|=
name|sw_rx_data
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"mp = NULL\n"
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_mp_null
operator|++
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
goto|goto
name|next_cqe
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|sw_rx_data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
comment|/* non GRO */
name|fp_cqe
operator|=
operator|&
name|cqe
operator|->
name|fast_path_regular
expr_stmt|;
comment|/* MK CR TPA check assembly */
name|len
operator|=
name|le16toh
argument_list|(
name|fp_cqe
operator|->
name|pkt_len
argument_list|)
expr_stmt|;
name|pad
operator|=
name|fp_cqe
operator|->
name|placement_offset
expr_stmt|;
name|QL_DPRINT3
argument_list|(
name|ha
argument_list|,
literal|"CQE type = %x, flags = %x, vlan = %x,"
literal|" len %u, parsing flags = %d pad  = %d\n"
argument_list|,
name|cqe_type
argument_list|,
name|fp_cqe
operator|->
name|bitfields
argument_list|,
name|le16toh
argument_list|(
name|fp_cqe
operator|->
name|vlan_tag
argument_list|)
argument_list|,
name|len
argument_list|,
name|le16toh
argument_list|(
name|fp_cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
argument_list|,
name|pad
argument_list|)
expr_stmt|;
name|data
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
name|uint8_t
operator|*
argument_list|)
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|pad
expr_stmt|;
if|if
condition|(
literal|0
condition|)
name|qlnx_dump_buf8
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* For every Rx BD consumed, we allocate a new BD so the BD ring                  * is always with a fixed size. If allocation fails, we take the                  * consumed BD and return it to the ring in the PROD position.                  * The packet that was received on that BD will be dropped (and                  * not passed to the upper stack).                  */
comment|/* If this is an error packet then drop it */
if|if
condition|(
operator|(
name|le16toh
argument_list|(
name|cqe
operator|->
name|fast_path_regular
operator|.
name|pars_flags
operator|.
name|flags
argument_list|)
operator|)
operator|&
name|CQE_FLAGS_ERR
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"CQE in CONS = %u has error, flags = %x,"
literal|" dropping incoming packet\n"
argument_list|,
name|sw_comp_cons
argument_list|,
name|le16toh
argument_list|(
name|cqe
operator|->
name|fast_path_regular
operator|.
name|pars_flags
operator|.
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_hw_errors
operator|++
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|QLNX_INC_IERRORS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
goto|goto
name|next_cqe
goto|;
block|}
if|if
condition|(
name|qlnx_alloc_rx_buffer
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"New buffer allocation failed, dropping"
literal|" incoming packet and reusing its buffer\n"
argument_list|)
expr_stmt|;
name|qlnx_reuse_rx_data
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|fp
operator|->
name|err_rx_alloc_errors
operator|++
expr_stmt|;
name|QLNX_INC_IQDROPS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
goto|goto
name|next_cqe
goto|;
block|}
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|len_on_first_bd
operator|=
name|fp_cqe
operator|->
name|len_on_first_bd
expr_stmt|;
name|m_adj
argument_list|(
name|mp
argument_list|,
name|pad
argument_list|)
expr_stmt|;
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"len = %d len_on_first_bd = %d\n"
argument_list|,
name|len
argument_list|,
name|len_on_first_bd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|>
literal|60
operator|)
operator|&&
operator|(
name|len
operator|>
name|len_on_first_bd
operator|)
condition|)
block|{
name|mp
operator|->
name|m_len
operator|=
name|len_on_first_bd
expr_stmt|;
if|if
condition|(
name|qlnx_rx_jumbo_chain
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|mp
argument_list|,
operator|(
name|len
operator|-
name|len_on_first_bd
operator|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|QLNX_INC_IQDROPS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
goto|goto
name|next_cqe
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|len_on_first_bd
operator|<
name|len
condition|)
block|{
name|fp
operator|->
name|err_rx_jumbo_chain_pkts
operator|++
expr_stmt|;
block|}
else|else
block|{
name|mp
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
block|}
name|mp
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
comment|/* assign packet to this interface interface */
name|mp
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
comment|/* assume no hardware checksum has complated */
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
literal|0
expr_stmt|;
name|mp
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|fp_cqe
operator|->
name|rss_hash
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
name|hash_type
operator|=
name|fp_cqe
operator|->
name|bitfields
operator|&
operator|(
name|ETH_FAST_PATH_RX_REG_CQE_RSS_HASH_TYPE_MASK
operator|<<
name|ETH_FAST_PATH_RX_REG_CQE_RSS_HASH_TYPE_SHIFT
operator|)
expr_stmt|;
switch|switch
condition|(
name|hash_type
condition|)
block|{
case|case
name|RSS_HASH_TYPE_IPV4
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSS_HASH_TYPE_TCP_IPV4
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSS_HASH_TYPE_IPV6
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_IPV6
argument_list|)
expr_stmt|;
break|break;
case|case
name|RSS_HASH_TYPE_TCP_IPV6
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV6
argument_list|)
expr_stmt|;
break|break;
default|default:
name|M_HASHTYPE_SET
argument_list|(
name|mp
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
break|break;
block|}
else|#
directive|else
name|mp
operator|->
name|m_flags
operator||=
name|M_FLOWID
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|CQE_L3_PACKET
argument_list|(
name|fp_cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
condition|)
block|{
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|CQE_IP_HDR_ERR
argument_list|(
name|fp_cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
operator|)
condition|)
block|{
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_VALID
expr_stmt|;
block|}
if|if
condition|(
name|CQE_L4_HAS_CSUM
argument_list|(
name|fp_cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
condition|)
block|{
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xFFFF
expr_stmt|;
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
operator|(
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|CQE_HAS_VLAN
argument_list|(
name|fp_cqe
operator|->
name|pars_flags
operator|.
name|flags
argument_list|)
condition|)
block|{
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|le16toh
argument_list|(
name|fp_cqe
operator|->
name|vlan_tag
argument_list|)
expr_stmt|;
name|mp
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
name|QLNX_INC_IPACKETS
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|QLNX_INC_IBYTES
argument_list|(
name|ifp
argument_list|,
name|len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|QLNX_SOFT_LRO
if|if
condition|(
name|lro_enable
condition|)
block|{
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100101
operator|)
operator|||
operator|(
name|defined
name|QLNX_QSORT_LRO
operator|)
name|tcp_lro_queue_mbuf
argument_list|(
name|lro
argument_list|,
name|mp
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|tcp_lro_rx
argument_list|(
name|lro
argument_list|,
name|mp
argument_list|,
literal|0
argument_list|)
condition|)
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|mp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* #if (__FreeBSD_version>= 1100101) || (defined QLNX_QSORT_LRO) */
block|}
else|else
block|{
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|mp
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|mp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* #ifdef QLNX_SOFT_LRO */
name|rx_pkt
operator|++
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|next_cqe
label|:
comment|/* don't consume bd rx buffer */
name|ecore_chain_recycle_consumed
argument_list|(
operator|&
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
expr_stmt|;
name|sw_comp_cons
operator|=
name|ecore_chain_get_cons_idx
argument_list|(
operator|&
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
expr_stmt|;
comment|/* CR TPA - revisit how to handle budget in TPA perhaps 		   increase on "end" */
if|if
condition|(
name|rx_pkt
operator|==
name|budget
condition|)
break|break;
block|}
comment|/* repeat while sw_comp_cons != hw_comp_cons... */
comment|/* Update producers */
name|qlnx_update_rx_prod
argument_list|(
name|p_hwfn
argument_list|,
name|rxq
argument_list|)
expr_stmt|;
return|return
name|rx_pkt
return|;
block|}
end_function

begin_comment
comment|/*  * fast path interrupt  */
end_comment

begin_function
specifier|static
name|void
name|qlnx_fp_isr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|qlnx_ivec_t
modifier|*
name|ivec
init|=
name|arg
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
init|=
name|NULL
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|ha
operator|=
name|ivec
operator|->
name|ha
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|state
operator|!=
name|QLNX_STATE_OPEN
condition|)
block|{
return|return;
block|}
name|idx
operator|=
name|ivec
operator|->
name|rss_idx
expr_stmt|;
if|if
condition|(
operator|(
name|idx
operator|=
name|ivec
operator|->
name|rss_idx
operator|)
operator|>=
name|ha
operator|->
name|num_rss
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"illegal interrupt[%d]\n"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|ha
operator|->
name|err_illegal_intr
operator|++
expr_stmt|;
return|return;
block|}
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
block|{
name|ha
operator|->
name|err_fp_null
operator|++
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|QLNX_RCV_IN_TASKQ
name|ecore_sb_ack
argument_list|(
name|fp
operator|->
name|sb_info
argument_list|,
name|IGU_INT_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fp_taskqueue
operator|!=
name|NULL
condition|)
name|taskqueue_enqueue
argument_list|(
name|fp
operator|->
name|fp_taskqueue
argument_list|,
operator|&
name|fp
operator|->
name|fp_task
argument_list|)
expr_stmt|;
else|#
directive|else
name|int
name|rx_int
init|=
literal|0
decl_stmt|,
name|total_rx_count
init|=
literal|0
decl_stmt|;
name|int
name|lro_enable
decl_stmt|,
name|tc
decl_stmt|;
name|lro_enable
operator|=
name|ha
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
expr_stmt|;
name|ecore_sb_ack
argument_list|(
name|fp
operator|->
name|sb_info
argument_list|,
name|IGU_INT_DISABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
do|do
block|{
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|ha
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
if|if
condition|(
name|mtx_trylock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
condition|)
block|{
name|qlnx_tx_int
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|fp
operator|->
name|txq
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
block|}
block|}
name|rx_int
operator|=
name|qlnx_rx_int
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|ha
operator|->
name|rx_pkt_threshold
argument_list|,
name|lro_enable
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_int
condition|)
block|{
name|fp
operator|->
name|rx_pkts
operator|+=
name|rx_int
expr_stmt|;
name|total_rx_count
operator|+=
name|rx_int
expr_stmt|;
block|}
block|}
do|while
condition|(
name|rx_int
condition|)
do|;
ifdef|#
directive|ifdef
name|QLNX_SOFT_LRO
block|{
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
name|lro
operator|=
operator|&
name|fp
operator|->
name|rxq
operator|->
name|lro
expr_stmt|;
if|if
condition|(
name|lro_enable
operator|&&
name|total_rx_count
condition|)
block|{
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100101
operator|)
operator|||
operator|(
name|defined
name|QLNX_QSORT_LRO
operator|)
ifdef|#
directive|ifdef
name|QLNX_TRACE_LRO_CNT
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|1023
condition|)
name|fp
operator|->
name|lro_cnt_1024
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|511
condition|)
name|fp
operator|->
name|lro_cnt_512
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|255
condition|)
name|fp
operator|->
name|lro_cnt_256
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|127
condition|)
name|fp
operator|->
name|lro_cnt_128
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|lro
operator|->
name|lro_mbuf_count
operator|&
operator|~
literal|63
condition|)
name|fp
operator|->
name|lro_cnt_64
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* #ifdef QLNX_TRACE_LRO_CNT */
name|tcp_lro_flush_all
argument_list|(
name|lro
argument_list|)
expr_stmt|;
else|#
directive|else
name|struct
name|lro_entry
modifier|*
name|queued
decl_stmt|;
while|while
condition|(
operator|(
operator|!
name|SLIST_EMPTY
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|)
operator|)
condition|)
block|{
name|queued
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|)
expr_stmt|;
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|, \
name|next
argument_list|)
expr_stmt|;
name|tcp_lro_flush
argument_list|(
name|lro
argument_list|,
name|queued
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* #if (__FreeBSD_version>= 1100101) || (defined QLNX_QSORT_LRO) */
block|}
block|}
endif|#
directive|endif
comment|/* #ifdef QLNX_SOFT_LRO */
name|ecore_sb_update_sb_idx
argument_list|(
name|fp
operator|->
name|sb_info
argument_list|)
expr_stmt|;
name|rmb
argument_list|()
expr_stmt|;
name|ecore_sb_ack
argument_list|(
name|fp
operator|->
name|sb_info
argument_list|,
name|IGU_INT_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* #ifdef QLNX_RCV_IN_TASKQ */
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * slow path interrupt processing function  * can be invoked in polled mode or in interrupt mode via taskqueue.  */
end_comment

begin_function
name|void
name|qlnx_sp_isr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|p_hwfn
operator|=
name|arg
expr_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|p_hwfn
operator|->
name|p_dev
expr_stmt|;
name|ha
operator|->
name|sp_interrupts
operator|++
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
name|ecore_int_sp_dpc
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*****************************************************************************  * Support Functions for DMA'able Memory  *****************************************************************************/
end_comment

begin_function
specifier|static
name|void
name|qlnx_dmamap_callback
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|)
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"%s: bus_dmamap_load failed (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
operator|(
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|)
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_dmabuf
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|qlnx_dma_t
modifier|*
name|dma_buf
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|bus_addr_t
name|b_addr
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|ret
operator|=
name|bus_dma_tag_create
argument_list|(
name|ha
operator|->
name|parent_tag
argument_list|,
comment|/* parent */
name|dma_buf
operator|->
name|alignment
argument_list|,
operator|(
call|(
name|bus_size_t
call|)
argument_list|(
literal|1ULL
operator|<<
literal|32
argument_list|)
operator|)
argument_list|,
comment|/* boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|dma_buf
operator|->
name|size
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|dma_buf
operator|->
name|size
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"could not create dma tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_alloc_dmabuf_exit
goto|;
block|}
name|ret
operator|=
name|bus_dmamem_alloc
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|dma_buf
operator|->
name|dma_b
argument_list|,
operator|(
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_NOWAIT
operator|)
argument_list|,
operator|&
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"bus_dmamem_alloc failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_alloc_dmabuf_exit
goto|;
block|}
name|ret
operator|=
name|bus_dmamap_load
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|,
name|dma_buf
operator|->
name|dma_b
argument_list|,
name|dma_buf
operator|->
name|size
argument_list|,
name|qlnx_dmamap_callback
argument_list|,
operator|&
name|b_addr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|!
name|b_addr
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_b
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|qlnx_alloc_dmabuf_exit
goto|;
block|}
name|dma_buf
operator|->
name|dma_addr
operator|=
name|b_addr
expr_stmt|;
name|qlnx_alloc_dmabuf_exit
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_dmabuf
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|qlnx_dma_t
modifier|*
name|dma_buf
parameter_list|)
block|{
name|bus_dmamap_unload
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|,
name|dma_buf
operator|->
name|dma_b
argument_list|,
name|dma_buf
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|dma_buf
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
modifier|*
name|qlnx_dma_alloc_coherent
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|bus_addr_t
modifier|*
name|phys
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|qlnx_dma_t
name|dma_buf
decl_stmt|;
name|qlnx_dma_t
modifier|*
name|dma_p
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
expr_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|size
operator|=
operator|(
name|size
operator|+
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dma_buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_dma_t
argument_list|)
argument_list|)
expr_stmt|;
name|dma_buf
operator|.
name|size
operator|=
name|size
operator|+
name|PAGE_SIZE
expr_stmt|;
name|dma_buf
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
if|if
condition|(
name|qlnx_alloc_dmabuf
argument_list|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
argument_list|,
operator|&
name|dma_buf
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|bzero
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|dma_buf
operator|.
name|dma_b
argument_list|,
name|dma_buf
operator|.
name|size
argument_list|)
expr_stmt|;
operator|*
name|phys
operator|=
name|dma_buf
operator|.
name|dma_addr
expr_stmt|;
name|dma_p
operator|=
operator|(
name|qlnx_dma_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|dma_buf
operator|.
name|dma_b
operator|+
name|size
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|dma_p
argument_list|,
operator|&
name|dma_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|qlnx_dma_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	QL_DPRINT5(ha, "[%p %p %p %p 0x%08x ]\n", 		(void *)dma_buf.dma_map, (void *)dma_buf.dma_tag, 		dma_buf.dma_b, (void *)dma_buf.dma_addr, size); */
return|return
operator|(
name|dma_buf
operator|.
name|dma_b
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qlnx_dma_free_coherent
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|void
modifier|*
name|v_addr
parameter_list|,
name|bus_addr_t
name|phys
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|qlnx_dma_t
name|dma_buf
decl_stmt|,
modifier|*
name|dma_p
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
expr_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
if|if
condition|(
name|v_addr
operator|==
name|NULL
condition|)
return|return;
name|size
operator|=
operator|(
name|size
operator|+
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|dma_p
operator|=
operator|(
name|qlnx_dma_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|v_addr
operator|+
name|size
operator|)
expr_stmt|;
comment|/* 	QL_DPRINT5(ha, "[%p %p %p %p 0x%08x ]\n", 		(void *)dma_p->dma_map, (void *)dma_p->dma_tag, 		dma_p->dma_b, (void *)dma_p->dma_addr, size); */
name|dma_buf
operator|=
operator|*
name|dma_p
expr_stmt|;
name|qlnx_free_dmabuf
argument_list|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
argument_list|,
operator|&
name|dma_buf
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_parent_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
comment|/*          * Allocate parent DMA Tag          */
name|ret
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
comment|/* parent */
literal|1
argument_list|,
operator|(
call|(
name|bus_size_t
call|)
argument_list|(
literal|1ULL
operator|<<
literal|32
argument_list|)
operator|)
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsize */
literal|0
argument_list|,
comment|/* nsegments */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|ha
operator|->
name|parent_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"could not create parent dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ha
operator|->
name|flags
operator|.
name|parent_tag
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_parent_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|ha
operator|->
name|parent_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|parent_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|parent_tag
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_tx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|QLNX_MAX_TSO_FRAME_SIZE
argument_list|,
comment|/* maxsize */
name|QLNX_MAX_SEGMENTS
argument_list|,
comment|/* nsegments */
operator|(
name|PAGE_SIZE
operator|*
literal|4
operator|)
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|ha
operator|->
name|tx_tag
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"tx_tag alloc failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_tx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|ha
operator|->
name|tx_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|tx_tag
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_rx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MJUM9BYTES
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|MJUM9BYTES
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|ha
operator|->
name|rx_tag
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|" rx_tag alloc failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_rx_dma_tag
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|ha
operator|->
name|rx_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_tag
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*********************************  * Exported functions  *********************************/
end_comment

begin_function
name|uint32_t
name|qlnx_pci_bus_get_bar_size
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|uint8_t
name|bar_id
parameter_list|)
block|{
name|uint32_t
name|bar_size
decl_stmt|;
name|bar_id
operator|=
name|bar_id
operator|*
literal|2
expr_stmt|;
name|bar_size
operator|=
name|bus_get_resource_count
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
operator|)
operator|->
name|pci_dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|PCIR_BAR
argument_list|(
name|bar_id
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|bar_size
operator|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|qlnx_pci_read_config_byte
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|uint32_t
name|pci_reg
parameter_list|,
name|uint8_t
modifier|*
name|reg_value
parameter_list|)
block|{
operator|*
name|reg_value
operator|=
name|pci_read_config
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
operator|)
operator|->
name|pci_dev
argument_list|,
name|pci_reg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|uint32_t
name|qlnx_pci_read_config_word
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|uint32_t
name|pci_reg
parameter_list|,
name|uint16_t
modifier|*
name|reg_value
parameter_list|)
block|{
operator|*
name|reg_value
operator|=
name|pci_read_config
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
operator|)
operator|->
name|pci_dev
argument_list|,
name|pci_reg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|uint32_t
name|qlnx_pci_read_config_dword
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|uint32_t
name|pci_reg
parameter_list|,
name|uint32_t
modifier|*
name|reg_value
parameter_list|)
block|{
operator|*
name|reg_value
operator|=
name|pci_read_config
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
operator|)
operator|->
name|pci_dev
argument_list|,
name|pci_reg
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|qlnx_pci_write_config_byte
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|uint32_t
name|pci_reg
parameter_list|,
name|uint8_t
name|reg_value
parameter_list|)
block|{
name|pci_write_config
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
operator|)
operator|->
name|pci_dev
argument_list|,
name|pci_reg
argument_list|,
name|reg_value
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|qlnx_pci_write_config_word
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|uint32_t
name|pci_reg
parameter_list|,
name|uint16_t
name|reg_value
parameter_list|)
block|{
name|pci_write_config
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
operator|)
operator|->
name|pci_dev
argument_list|,
name|pci_reg
argument_list|,
name|reg_value
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|qlnx_pci_write_config_dword
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|uint32_t
name|pci_reg
parameter_list|,
name|uint32_t
name|reg_value
parameter_list|)
block|{
name|pci_write_config
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|ecore_dev
operator|)
operator|->
name|pci_dev
argument_list|,
name|pci_reg
argument_list|,
name|reg_value
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|qlnx_pci_find_capability
parameter_list|(
name|void
modifier|*
name|ecore_dev
parameter_list|,
name|int
name|cap
parameter_list|)
block|{
name|int
name|reg
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
name|ecore_dev
expr_stmt|;
if|if
condition|(
name|pci_find_cap
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
name|PCIY_EXPRESS
argument_list|,
operator|&
name|reg
argument_list|)
operator|==
literal|0
condition|)
return|return
name|reg
return|;
else|else
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|uint32_t
name|qlnx_reg_rd32
parameter_list|(
name|void
modifier|*
name|hwfn
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|)
block|{
name|uint32_t
name|data32
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|p_hwfn
operator|=
name|hwfn
expr_stmt|;
name|cdev
operator|=
name|p_hwfn
operator|->
name|p_dev
expr_stmt|;
name|reg_addr
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|p_hwfn
operator|->
name|regview
operator|)
operator|-
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cdev
operator|->
name|regview
operator|)
argument_list|)
operator|+
name|reg_addr
expr_stmt|;
name|data32
operator|=
name|bus_read_4
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
operator|->
name|pci_reg
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
return|return
operator|(
name|data32
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qlnx_reg_wr32
parameter_list|(
name|void
modifier|*
name|hwfn
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|p_hwfn
operator|=
name|hwfn
expr_stmt|;
name|cdev
operator|=
name|p_hwfn
operator|->
name|p_dev
expr_stmt|;
name|reg_addr
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|p_hwfn
operator|->
name|regview
operator|)
operator|-
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cdev
operator|->
name|regview
operator|)
argument_list|)
operator|+
name|reg_addr
expr_stmt|;
name|bus_write_4
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
operator|->
name|pci_reg
argument_list|,
name|reg_addr
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|qlnx_reg_wr16
parameter_list|(
name|void
modifier|*
name|hwfn
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|p_hwfn
operator|=
name|hwfn
expr_stmt|;
name|cdev
operator|=
name|p_hwfn
operator|->
name|p_dev
expr_stmt|;
name|reg_addr
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|p_hwfn
operator|->
name|regview
operator|)
operator|-
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cdev
operator|->
name|regview
operator|)
argument_list|)
operator|+
name|reg_addr
expr_stmt|;
name|bus_write_2
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
operator|->
name|pci_reg
argument_list|,
name|reg_addr
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|qlnx_dbell_wr32
parameter_list|(
name|void
modifier|*
name|hwfn
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|p_hwfn
operator|=
name|hwfn
expr_stmt|;
name|cdev
operator|=
name|p_hwfn
operator|->
name|p_dev
expr_stmt|;
name|reg_addr
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|p_hwfn
operator|->
name|doorbells
operator|)
operator|-
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cdev
operator|->
name|doorbells
operator|)
argument_list|)
operator|+
name|reg_addr
expr_stmt|;
name|bus_write_4
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
operator|->
name|pci_dbells
argument_list|,
name|reg_addr
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|uint32_t
name|qlnx_direct_reg_rd32
parameter_list|(
name|void
modifier|*
name|p_hwfn
parameter_list|,
name|uint32_t
modifier|*
name|reg_addr
parameter_list|)
block|{
name|uint32_t
name|data32
decl_stmt|;
name|uint32_t
name|offset
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|(
operator|(
expr|struct
name|ecore_hwfn
operator|*
operator|)
name|p_hwfn
operator|)
operator|->
name|p_dev
expr_stmt|;
name|offset
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|reg_addr
operator|-
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cdev
operator|->
name|regview
operator|)
argument_list|)
expr_stmt|;
name|data32
operator|=
name|bus_read_4
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
operator|->
name|pci_reg
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|(
name|data32
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qlnx_direct_reg_wr32
parameter_list|(
name|void
modifier|*
name|p_hwfn
parameter_list|,
name|void
modifier|*
name|reg_addr
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|uint32_t
name|offset
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|(
operator|(
expr|struct
name|ecore_hwfn
operator|*
operator|)
name|p_hwfn
operator|)
operator|->
name|p_dev
expr_stmt|;
name|offset
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|reg_addr
operator|-
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cdev
operator|->
name|regview
operator|)
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
operator|->
name|pci_reg
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|qlnx_direct_reg_wr64
parameter_list|(
name|void
modifier|*
name|p_hwfn
parameter_list|,
name|void
modifier|*
name|reg_addr
parameter_list|,
name|uint64_t
name|value
parameter_list|)
block|{
name|uint32_t
name|offset
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|(
operator|(
expr|struct
name|ecore_hwfn
operator|*
operator|)
name|p_hwfn
operator|)
operator|->
name|p_dev
expr_stmt|;
name|offset
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|reg_addr
operator|-
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|cdev
operator|->
name|regview
operator|)
argument_list|)
expr_stmt|;
name|bus_write_8
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
operator|->
name|pci_reg
argument_list|,
name|offset
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
modifier|*
name|qlnx_zalloc
parameter_list|(
name|uint32_t
name|size
parameter_list|)
block|{
name|caddr_t
name|va
decl_stmt|;
name|va
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
name|long
operator|)
name|size
argument_list|,
name|M_QLNXBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|va
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
name|va
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qlnx_barrier
parameter_list|(
name|void
modifier|*
name|p_hwfn
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
operator|(
operator|(
expr|struct
name|ecore_hwfn
operator|*
operator|)
name|p_hwfn
operator|)
operator|->
name|p_dev
expr_stmt|;
name|bus_barrier
argument_list|(
name|ha
operator|->
name|pci_reg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|qlnx_link_update
parameter_list|(
name|void
modifier|*
name|p_hwfn
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|int
name|prev_link_state
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
operator|(
operator|(
expr|struct
name|ecore_hwfn
operator|*
operator|)
name|p_hwfn
operator|)
operator|->
name|p_dev
expr_stmt|;
name|qlnx_fill_link
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|ha
operator|->
name|if_link
argument_list|)
expr_stmt|;
name|prev_link_state
operator|=
name|ha
operator|->
name|link_up
expr_stmt|;
name|ha
operator|->
name|link_up
operator|=
name|ha
operator|->
name|if_link
operator|.
name|link_up
expr_stmt|;
if|if
condition|(
name|prev_link_state
operator|!=
name|ha
operator|->
name|link_up
condition|)
block|{
if|if
condition|(
name|ha
operator|->
name|link_up
condition|)
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
name|void
name|qlnx_fill_link
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|hwfn
parameter_list|,
name|struct
name|qlnx_link_output
modifier|*
name|if_link
parameter_list|)
block|{
name|struct
name|ecore_mcp_link_params
name|link_params
decl_stmt|;
name|struct
name|ecore_mcp_link_state
name|link_state
decl_stmt|;
name|memset
argument_list|(
name|if_link
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|if_link
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|link_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_mcp_link_params
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|link_state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_mcp_link_state
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Prepare source inputs */
comment|/* we only deal with physical functions */
name|memcpy
argument_list|(
operator|&
name|link_params
argument_list|,
name|ecore_mcp_get_link_params
argument_list|(
name|hwfn
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|link_params
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|link_state
argument_list|,
name|ecore_mcp_get_link_state
argument_list|(
name|hwfn
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|link_state
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_mcp_get_media_type
argument_list|(
name|hwfn
operator|->
name|p_dev
argument_list|,
operator|&
name|if_link
operator|->
name|media_type
argument_list|)
expr_stmt|;
comment|/* Set the link parameters to pass to protocol driver */
if|if
condition|(
name|link_state
operator|.
name|link_up
condition|)
block|{
name|if_link
operator|->
name|link_up
operator|=
name|true
expr_stmt|;
name|if_link
operator|->
name|speed
operator|=
name|link_state
operator|.
name|speed
expr_stmt|;
block|}
name|if_link
operator|->
name|supported_caps
operator|=
name|QLNX_LINK_CAP_FIBRE
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|speed
operator|.
name|autoneg
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_Autoneg
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|pause
operator|.
name|autoneg
operator|||
operator|(
name|link_params
operator|.
name|pause
operator|.
name|forced_rx
operator|&&
name|link_params
operator|.
name|pause
operator|.
name|forced_tx
operator|)
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_Asym_Pause
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|pause
operator|.
name|autoneg
operator|||
name|link_params
operator|.
name|pause
operator|.
name|forced_rx
operator|||
name|link_params
operator|.
name|pause
operator|.
name|forced_tx
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_Pause
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|speed
operator|.
name|advertised_speeds
operator|&
name|NVM_CFG1_PORT_DRV_SPEED_CAPABILITY_MASK_1G
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_1000baseT_Half
operator||
name|QLNX_LINK_CAP_1000baseT_Full
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|speed
operator|.
name|advertised_speeds
operator|&
name|NVM_CFG1_PORT_DRV_SPEED_CAPABILITY_MASK_10G
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_10000baseKR_Full
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|speed
operator|.
name|advertised_speeds
operator|&
name|NVM_CFG1_PORT_DRV_SPEED_CAPABILITY_MASK_25G
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_25000baseKR_Full
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|speed
operator|.
name|advertised_speeds
operator|&
name|NVM_CFG1_PORT_DRV_LINK_SPEED_40G
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_40000baseLR4_Full
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|speed
operator|.
name|advertised_speeds
operator|&
name|NVM_CFG1_PORT_DRV_SPEED_CAPABILITY_MASK_50G
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_50000baseKR2_Full
expr_stmt|;
if|if
condition|(
name|link_params
operator|.
name|speed
operator|.
name|advertised_speeds
operator|&
name|NVM_CFG1_PORT_DRV_SPEED_CAPABILITY_MASK_BB_100G
condition|)
name|if_link
operator|->
name|supported_caps
operator||=
name|QLNX_LINK_CAP_100000baseKR4_Full
expr_stmt|;
name|if_link
operator|->
name|advertised_caps
operator|=
name|if_link
operator|->
name|supported_caps
expr_stmt|;
name|if_link
operator|->
name|autoneg
operator|=
name|link_params
operator|.
name|speed
operator|.
name|autoneg
expr_stmt|;
name|if_link
operator|->
name|duplex
operator|=
name|QLNX_LINK_DUPLEX
expr_stmt|;
comment|/* Link partner capabilities */
if|if
condition|(
name|link_state
operator|.
name|partner_adv_speed
operator|&
name|ECORE_LINK_PARTNER_SPEED_1G_HD
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_1000baseT_Half
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|partner_adv_speed
operator|&
name|ECORE_LINK_PARTNER_SPEED_1G_FD
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_1000baseT_Full
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|partner_adv_speed
operator|&
name|ECORE_LINK_PARTNER_SPEED_10G
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_10000baseKR_Full
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|partner_adv_speed
operator|&
name|ECORE_LINK_PARTNER_SPEED_25G
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_25000baseKR_Full
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|partner_adv_speed
operator|&
name|ECORE_LINK_PARTNER_SPEED_40G
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_40000baseLR4_Full
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|partner_adv_speed
operator|&
name|ECORE_LINK_PARTNER_SPEED_50G
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_50000baseKR2_Full
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|partner_adv_speed
operator|&
name|ECORE_LINK_PARTNER_SPEED_100G
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_100000baseKR4_Full
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|an_complete
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_Autoneg
expr_stmt|;
if|if
condition|(
name|link_state
operator|.
name|partner_adv_pause
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_Pause
expr_stmt|;
if|if
condition|(
operator|(
name|link_state
operator|.
name|partner_adv_pause
operator|==
name|ECORE_LINK_PARTNER_ASYMMETRIC_PAUSE
operator|)
operator|||
operator|(
name|link_state
operator|.
name|partner_adv_pause
operator|==
name|ECORE_LINK_PARTNER_BOTH_PAUSE
operator|)
condition|)
name|if_link
operator|->
name|link_partner_caps
operator||=
name|QLNX_LINK_CAP_Asym_Pause
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_nic_setup
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|,
name|struct
name|ecore_pf_params
modifier|*
name|func_params
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cdev
operator|->
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|p_hwfn
operator|->
name|pf_params
operator|=
operator|*
name|func_params
expr_stmt|;
block|}
name|rc
operator|=
name|ecore_resc_alloc
argument_list|(
name|cdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|qlnx_nic_setup_exit
goto|;
name|ecore_resc_setup
argument_list|(
name|cdev
argument_list|)
expr_stmt|;
name|qlnx_nic_setup_exit
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_nic_start
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|ecore_hw_init_params
name|params
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|params
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_hw_init_params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|p_tunn
operator|=
name|NULL
expr_stmt|;
name|params
operator|.
name|b_hw_start
operator|=
name|true
expr_stmt|;
name|params
operator|.
name|int_mode
operator|=
name|cdev
operator|->
name|int_mode
expr_stmt|;
name|params
operator|.
name|allow_npar_tx_switch
operator|=
name|true
expr_stmt|;
name|params
operator|.
name|bin_fw_data
operator|=
name|NULL
expr_stmt|;
name|rc
operator|=
name|ecore_hw_init
argument_list|(
name|cdev
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|ecore_resc_free
argument_list|(
name|cdev
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_slowpath_start
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|ecore_pf_params
name|pf_params
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pf_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_pf_params
argument_list|)
argument_list|)
expr_stmt|;
name|pf_params
operator|.
name|eth_pf_params
operator|.
name|num_cons
operator|=
operator|(
name|ha
operator|->
name|num_rss
operator|)
operator|*
operator|(
name|ha
operator|->
name|num_tc
operator|+
literal|1
operator|)
expr_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|rc
operator|=
name|qlnx_nic_setup
argument_list|(
name|cdev
argument_list|,
operator|&
name|pf_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|qlnx_slowpath_start_exit
goto|;
name|cdev
operator|->
name|int_mode
operator|=
name|ECORE_INT_MODE_MSIX
expr_stmt|;
name|cdev
operator|->
name|int_coalescing_mode
operator|=
name|ECORE_COAL_MODE_ENABLE
expr_stmt|;
ifdef|#
directive|ifdef
name|QLNX_MAX_COALESCE
name|cdev
operator|->
name|rx_coalesce_usecs
operator|=
literal|255
expr_stmt|;
name|cdev
operator|->
name|tx_coalesce_usecs
operator|=
literal|255
expr_stmt|;
endif|#
directive|endif
name|rc
operator|=
name|qlnx_nic_start
argument_list|(
name|cdev
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_coalesce_usecs
operator|=
name|cdev
operator|->
name|rx_coalesce_usecs
expr_stmt|;
name|ha
operator|->
name|tx_coalesce_usecs
operator|=
name|cdev
operator|->
name|tx_coalesce_usecs
expr_stmt|;
name|qlnx_slowpath_start_exit
label|:
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_slowpath_stop
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|ecore_hw_stop
argument_list|(
name|cdev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|cdev
operator|.
name|num_hwfns
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|sp_handle
index|[
name|i
index|]
condition|)
operator|(
name|void
operator|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
argument_list|,
name|ha
operator|->
name|sp_handle
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ha
operator|->
name|sp_handle
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
condition|)
operator|(
name|void
operator|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ha
operator|->
name|sp_irq_rid
index|[
name|i
index|]
argument_list|,
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ha
operator|->
name|sp_irq
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|ecore_resc_free
argument_list|(
name|cdev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_set_id
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|,
name|char
name|name
index|[
name|NAME_SIZE
index|]
parameter_list|,
name|char
name|ver_str
index|[
name|VER_SIZE
index|]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|memcpy
argument_list|(
name|cdev
operator|->
name|name
argument_list|,
name|name
argument_list|,
name|NAME_SIZE
argument_list|)
expr_stmt|;
name|for_each_hwfn
argument_list|(
argument|cdev
argument_list|,
argument|i
argument_list|)
block|{
name|snprintf
argument_list|(
name|cdev
operator|->
name|hwfns
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|NAME_SIZE
argument_list|,
literal|"%s-%d"
argument_list|,
name|name
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|cdev
operator|->
name|drv_type
operator|=
name|DRV_ID_DRV_TYPE_FREEBSD
expr_stmt|;
return|return ;
block|}
end_function

begin_function
name|void
name|qlnx_get_protocol_stats
parameter_list|(
name|void
modifier|*
name|cdev
parameter_list|,
name|int
name|proto_type
parameter_list|,
name|void
modifier|*
name|proto_stats
parameter_list|)
block|{
name|enum
name|ecore_mcp_protocol_type
name|type
decl_stmt|;
name|union
name|ecore_mcp_protocol_stats
modifier|*
name|stats
decl_stmt|;
name|struct
name|ecore_eth_stats
name|eth_stats
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
name|cdev
expr_stmt|;
name|stats
operator|=
name|proto_stats
expr_stmt|;
name|type
operator|=
name|proto_type
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ECORE_MCP_LAN_STATS
case|:
name|ecore_get_vport_stats
argument_list|(
operator|(
expr|struct
name|ecore_dev
operator|*
operator|)
name|cdev
argument_list|,
operator|&
name|eth_stats
argument_list|)
expr_stmt|;
name|stats
operator|->
name|lan_stats
operator|.
name|ucast_rx_pkts
operator|=
name|eth_stats
operator|.
name|common
operator|.
name|rx_ucast_pkts
expr_stmt|;
name|stats
operator|->
name|lan_stats
operator|.
name|ucast_tx_pkts
operator|=
name|eth_stats
operator|.
name|common
operator|.
name|tx_ucast_pkts
expr_stmt|;
name|stats
operator|->
name|lan_stats
operator|.
name|fcs_err
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|ha
operator|->
name|err_get_proto_invalid_type
operator|++
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"invalid protocol type 0x%x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_get_mfw_version
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|mfw_ver
parameter_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
decl_stmt|;
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
literal|0
index|]
expr_stmt|;
name|p_ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_ptt
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"ecore_ptt_acquire failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ecore_mcp_get_mfw_ver
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|mfw_ver
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_get_flash_size
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|flash_size
parameter_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
decl_stmt|;
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
literal|0
index|]
expr_stmt|;
name|p_ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_ptt
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"ecore_ptt_acquire failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ecore_mcp_get_flash_size
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|flash_size
argument_list|)
expr_stmt|;
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_mem_arrays
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ha
operator|->
name|txq_array
index|[
literal|0
index|]
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|qlnx_tx_queue
argument_list|)
operator|*
name|QLNX_MAX_RSS
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ha
operator|->
name|rxq_array
index|[
literal|0
index|]
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|qlnx_rx_queue
argument_list|)
operator|*
name|QLNX_MAX_RSS
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ha
operator|->
name|sb_array
index|[
literal|0
index|]
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_sb_info
argument_list|)
operator|*
name|QLNX_MAX_RSS
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_init_fp
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rss_id
decl_stmt|,
name|txq_array_index
decl_stmt|,
name|tc
decl_stmt|;
for|for
control|(
name|rss_id
operator|=
literal|0
init|;
name|rss_id
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|rss_id
operator|++
control|)
block|{
name|struct
name|qlnx_fastpath
modifier|*
name|fp
init|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|rss_id
index|]
decl_stmt|;
name|fp
operator|->
name|rss_id
operator|=
name|rss_id
expr_stmt|;
name|fp
operator|->
name|edev
operator|=
name|ha
expr_stmt|;
name|fp
operator|->
name|sb_info
operator|=
operator|&
name|ha
operator|->
name|sb_array
index|[
name|rss_id
index|]
expr_stmt|;
name|fp
operator|->
name|rxq
operator|=
operator|&
name|ha
operator|->
name|rxq_array
index|[
name|rss_id
index|]
expr_stmt|;
name|fp
operator|->
name|rxq
operator|->
name|rxq_id
operator|=
name|rss_id
expr_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|ha
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|txq_array_index
operator|=
name|tc
operator|*
name|ha
operator|->
name|num_rss
operator|+
name|rss_id
expr_stmt|;
name|fp
operator|->
name|txq
index|[
name|tc
index|]
operator|=
operator|&
name|ha
operator|->
name|txq_array
index|[
name|txq_array_index
index|]
expr_stmt|;
name|fp
operator|->
name|txq
index|[
name|tc
index|]
operator|->
name|index
operator|=
name|txq_array_index
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|fp
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|fp
operator|->
name|name
argument_list|)
argument_list|,
literal|"%s-fp-%d"
argument_list|,
name|qlnx_name_str
argument_list|,
name|rss_id
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_ring_full
operator|=
literal|0
expr_stmt|;
comment|/* reset all the statistics counters */
name|fp
operator|->
name|tx_pkts_processed
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_pkts_freed
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_pkts_transmitted
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_pkts_completed
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_lso_wnd_min_len
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_defrag
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_nsegs_gt_elem_left
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_tso_max_nsegs
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|tx_tso_min_nsegs
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_nsegs_gt_elem_left
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_dmamap_create
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_defrag_dmamap_load
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_non_tso_max_seg
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_dmamap_load
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_defrag
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_free_pkt_null
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_tx_cons_idx_conflict
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|rx_pkts
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_m_getcl
operator|=
literal|0
expr_stmt|;
name|fp
operator|->
name|err_m_getjcl
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_mem_sb
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|ecore_sb_info
modifier|*
name|sb_info
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
if|if
condition|(
name|sb_info
operator|->
name|sb_virt
condition|)
block|{
name|OSAL_DMA_FREE_COHERENT
argument_list|(
name|cdev
argument_list|,
operator|(
operator|(
name|void
operator|*
operator|)
name|sb_info
operator|->
name|sb_virt
operator|)
argument_list|,
operator|(
name|sb_info
operator|->
name|sb_phys
operator|)
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
operator|*
name|sb_info
operator|->
name|sb_virt
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sb_info
operator|->
name|sb_virt
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_sb_init
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|,
name|struct
name|ecore_sb_info
modifier|*
name|sb_info
parameter_list|,
name|void
modifier|*
name|sb_virt_addr
parameter_list|,
name|bus_addr_t
name|sb_phy_addr
parameter_list|,
name|u16
name|sb_id
parameter_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|int
name|hwfn_index
decl_stmt|,
name|rc
decl_stmt|;
name|u16
name|rel_sb_id
decl_stmt|;
name|hwfn_index
operator|=
name|sb_id
operator|%
name|cdev
operator|->
name|num_hwfns
expr_stmt|;
name|p_hwfn
operator|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
name|hwfn_index
index|]
expr_stmt|;
name|rel_sb_id
operator|=
name|sb_id
operator|/
name|cdev
operator|->
name|num_hwfns
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
operator|)
argument_list|,
literal|"hwfn_index = %d p_hwfn = %p sb_id = 0x%x rel_sb_id = 0x%x \                 sb_info = %p sb_virt_addr = %p sb_phy_addr = %p\n"
argument_list|,
name|hwfn_index
argument_list|,
name|p_hwfn
argument_list|,
name|sb_id
argument_list|,
name|rel_sb_id
argument_list|,
name|sb_info
argument_list|,
name|sb_virt_addr
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sb_phy_addr
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_int_sb_init
argument_list|(
name|p_hwfn
argument_list|,
name|p_hwfn
operator|->
name|p_main_ptt
argument_list|,
name|sb_info
argument_list|,
name|sb_virt_addr
argument_list|,
name|sb_phy_addr
argument_list|,
name|rel_sb_id
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/* This function allocates fast-path status block memory */
end_comment

begin_function
specifier|static
name|int
name|qlnx_alloc_mem_sb
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|ecore_sb_info
modifier|*
name|sb_info
parameter_list|,
name|u16
name|sb_id
parameter_list|)
block|{
name|struct
name|status_block_e4
modifier|*
name|sb_virt
decl_stmt|;
name|bus_addr_t
name|sb_phys
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sb_virt
argument_list|)
expr_stmt|;
name|sb_virt
operator|=
name|OSAL_DMA_ALLOC_COHERENT
argument_list|(
name|cdev
argument_list|,
operator|(
operator|&
name|sb_phys
operator|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sb_virt
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Status block allocation failed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|rc
operator|=
name|qlnx_sb_init
argument_list|(
name|cdev
argument_list|,
name|sb_info
argument_list|,
name|sb_virt
argument_list|,
name|sb_phys
argument_list|,
name|sb_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|OSAL_DMA_FREE_COHERENT
argument_list|(
name|cdev
argument_list|,
name|sb_virt
argument_list|,
name|sb_phys
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_rx_buffers
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|rx_buf
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rxq
operator|->
name|num_rx_buffers
condition|;
name|i
operator|++
control|)
block|{
name|rx_buf
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rx_buf
operator|->
name|data
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rx_buf
operator|->
name|map
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rx_buf
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rx_buf
operator|->
name|map
argument_list|)
expr_stmt|;
name|rx_buf
operator|->
name|map
operator|=
name|NULL
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|rx_buf
operator|->
name|data
argument_list|)
expr_stmt|;
name|rx_buf
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_mem_rxq
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|qlnx_free_rx_buffers
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_TPA_MAX_AGGS_NUM
condition|;
name|i
operator|++
control|)
block|{
name|qlnx_free_tpa_mbuf
argument_list|(
name|ha
argument_list|,
operator|&
name|rxq
operator|->
name|tpa_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxq
operator|->
name|tpa_info
index|[
name|i
index|]
operator|.
name|mpf
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|rxq
operator|->
name|tpa_info
index|[
name|i
index|]
operator|.
name|mpf
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
literal|0
index|]
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sw_rx_data
argument_list|)
operator|*
name|RX_RING_SIZE
operator|)
argument_list|)
expr_stmt|;
comment|/* Free the real RQ ring used by FW */
if|if
condition|(
name|rxq
operator|->
name|rx_bd_ring
operator|.
name|p_virt_addr
condition|)
block|{
name|ecore_chain_free
argument_list|(
name|cdev
argument_list|,
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|rx_bd_ring
operator|.
name|p_virt_addr
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Free the real completion ring used by FW */
if|if
condition|(
name|rxq
operator|->
name|rx_comp_ring
operator|.
name|p_virt_addr
operator|&&
name|rxq
operator|->
name|rx_comp_ring
operator|.
name|pbl_sp
operator|.
name|p_virt_table
condition|)
block|{
name|ecore_chain_free
argument_list|(
name|cdev
argument_list|,
operator|&
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|rx_comp_ring
operator|.
name|p_virt_addr
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|rx_comp_ring
operator|.
name|pbl_sp
operator|.
name|p_virt_table
operator|=
name|NULL
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|QLNX_SOFT_LRO
block|{
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
name|lro
operator|=
operator|&
name|rxq
operator|->
name|lro
expr_stmt|;
name|tcp_lro_free
argument_list|(
name|lro
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* #ifdef QLNX_SOFT_LRO */
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_rx_buffer
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
block|{
specifier|register
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|uint16_t
name|rx_buf_size
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data
decl_stmt|;
name|struct
name|eth_rx_bd
modifier|*
name|rx_bd
decl_stmt|;
name|dma_addr_t
name|dma_addr
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|rx_buf_size
operator|=
name|rxq
operator|->
name|rx_buf_size
expr_stmt|;
name|mp
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|rx_buf_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to allocate Rx data\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|mp
operator|->
name|m_len
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|rx_buf_size
expr_stmt|;
name|map
operator|=
operator|(
name|bus_dmamap_t
operator|)
literal|0
expr_stmt|;
name|ret
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|map
argument_list|,
name|mp
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
name|dma_addr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|!
name|dma_addr
operator|||
operator|(
name|nsegs
operator|!=
literal|1
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"bus_dmamap_load failed[%d, 0x%016llx, %d]\n"
argument_list|,
name|ret
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|dma_addr
argument_list|,
name|nsegs
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|sw_rx_data
operator|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_prod
index|]
expr_stmt|;
name|sw_rx_data
operator|->
name|data
operator|=
name|mp
expr_stmt|;
name|sw_rx_data
operator|->
name|dma_addr
operator|=
name|dma_addr
expr_stmt|;
name|sw_rx_data
operator|->
name|map
operator|=
name|map
expr_stmt|;
comment|/* Advance PROD and get BD pointer */
name|rx_bd
operator|=
operator|(
expr|struct
name|eth_rx_bd
operator|*
operator|)
name|ecore_chain_produce
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|rx_bd
operator|->
name|addr
operator|.
name|hi
operator|=
name|htole32
argument_list|(
name|U64_HI
argument_list|(
name|dma_addr
argument_list|)
argument_list|)
expr_stmt|;
name|rx_bd
operator|->
name|addr
operator|.
name|lo
operator|=
name|htole32
argument_list|(
name|U64_LO
argument_list|(
name|dma_addr
argument_list|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_prod
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_prod
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_tpa_mbuf
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint16_t
name|rx_buf_size
parameter_list|,
name|struct
name|qlnx_agg_info
modifier|*
name|tpa
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|dma_addr_t
name|dma_addr
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|rx_buf
decl_stmt|;
name|mp
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|rx_buf_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to allocate Rx data\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|mp
operator|->
name|m_len
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|rx_buf_size
expr_stmt|;
name|map
operator|=
operator|(
name|bus_dmamap_t
operator|)
literal|0
expr_stmt|;
name|ret
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|map
argument_list|,
name|mp
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
name|dma_addr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
if|if
condition|(
name|ret
operator|||
operator|!
name|dma_addr
operator|||
operator|(
name|nsegs
operator|!=
literal|1
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|mp
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"bus_dmamap_load failed[%d, 0x%016llx, %d]\n"
argument_list|,
name|ret
argument_list|,
operator|(
name|long
name|long
name|unsigned
name|int
operator|)
name|dma_addr
argument_list|,
name|nsegs
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|rx_buf
operator|=
operator|&
name|tpa
operator|->
name|rx_buf
expr_stmt|;
name|memset
argument_list|(
name|rx_buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sw_rx_data
argument_list|)
argument_list|)
expr_stmt|;
name|rx_buf
operator|->
name|data
operator|=
name|mp
expr_stmt|;
name|rx_buf
operator|->
name|dma_addr
operator|=
name|dma_addr
expr_stmt|;
name|rx_buf
operator|->
name|map
operator|=
name|map
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_tpa_mbuf
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_agg_info
modifier|*
name|tpa
parameter_list|)
block|{
name|struct
name|sw_rx_data
modifier|*
name|rx_buf
decl_stmt|;
name|rx_buf
operator|=
operator|&
name|tpa
operator|->
name|rx_buf
expr_stmt|;
if|if
condition|(
name|rx_buf
operator|->
name|data
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rx_buf
operator|->
name|map
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rx_buf
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|,
name|rx_buf
operator|->
name|map
argument_list|)
expr_stmt|;
name|rx_buf
operator|->
name|map
operator|=
name|NULL
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|rx_buf
operator|->
name|data
argument_list|)
expr_stmt|;
name|rx_buf
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* This function allocates all memory needed per Rx queue */
end_comment

begin_function
specifier|static
name|int
name|qlnx_alloc_mem_rxq
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|,
name|num_allocated
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
name|rxq
operator|->
name|num_rx_buffers
operator|=
name|RX_RING_SIZE
expr_stmt|;
name|rxq
operator|->
name|rx_buf_size
operator|=
name|ha
operator|->
name|rx_buf_size
expr_stmt|;
comment|/* Allocate the parallel driver ring for Rx buffers */
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
literal|0
index|]
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sw_rx_data
argument_list|)
operator|*
name|RX_RING_SIZE
operator|)
argument_list|)
expr_stmt|;
comment|/* Allocate FW Rx ring  */
name|rc
operator|=
name|ecore_chain_alloc
argument_list|(
name|cdev
argument_list|,
name|ECORE_CHAIN_USE_TO_CONSUME_PRODUCE
argument_list|,
name|ECORE_CHAIN_MODE_NEXT_PTR
argument_list|,
name|ECORE_CHAIN_CNT_TYPE_U16
argument_list|,
name|RX_RING_SIZE
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eth_rx_bd
argument_list|)
argument_list|,
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* Allocate FW completion ring */
name|rc
operator|=
name|ecore_chain_alloc
argument_list|(
name|cdev
argument_list|,
name|ECORE_CHAIN_USE_TO_CONSUME
argument_list|,
name|ECORE_CHAIN_MODE_PBL
argument_list|,
name|ECORE_CHAIN_CNT_TYPE_U16
argument_list|,
name|RX_RING_SIZE
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|eth_rx_cqe
argument_list|)
argument_list|,
operator|&
name|rxq
operator|->
name|rx_comp_ring
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
comment|/* Allocate buffers for the Rx ring */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_TPA_MAX_AGGS_NUM
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|qlnx_alloc_tpa_mbuf
argument_list|(
name|ha
argument_list|,
name|rxq
operator|->
name|rx_buf_size
argument_list|,
operator|&
name|rxq
operator|->
name|tpa_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rxq
operator|->
name|num_rx_buffers
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|qlnx_alloc_rx_buffer
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
break|break;
block|}
name|num_allocated
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|!
name|num_allocated
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Rx buffers allocation failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|num_allocated
operator|<
name|rxq
operator|->
name|num_rx_buffers
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Allocated less buffers than"
literal|" desired (%d allocated)\n"
argument_list|,
name|num_allocated
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|QLNX_SOFT_LRO
block|{
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
name|lro
operator|=
operator|&
name|rxq
operator|->
name|lro
expr_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100101
operator|)
operator|||
operator|(
name|defined
name|QLNX_QSORT_LRO
operator|)
if|if
condition|(
name|tcp_lro_init_args
argument_list|(
name|lro
argument_list|,
name|ifp
argument_list|,
literal|0
argument_list|,
name|rxq
operator|->
name|num_rx_buffers
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"tcp_lro_init[%d] failed\n"
argument_list|,
name|rxq
operator|->
name|rxq_id
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|#
directive|else
if|if
condition|(
name|tcp_lro_init
argument_list|(
name|lro
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"tcp_lro_init[%d] failed\n"
argument_list|,
name|rxq
operator|->
name|rxq_id
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
endif|#
directive|endif
comment|/* #if (__FreeBSD_version>= 1100101) || (defined QLNX_QSORT_LRO) */
name|lro
operator|->
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* #ifdef QLNX_SOFT_LRO */
return|return
literal|0
return|;
name|err
label|:
name|qlnx_free_mem_rxq
argument_list|(
name|ha
argument_list|,
name|rxq
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_mem_txq
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|txq
operator|->
name|sw_tx_ring
index|[
literal|0
index|]
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sw_tx_bd
argument_list|)
operator|*
name|TX_RING_SIZE
operator|)
argument_list|)
expr_stmt|;
comment|/* Free the real RQ ring used by FW */
if|if
condition|(
name|txq
operator|->
name|tx_pbl
operator|.
name|p_virt_addr
condition|)
block|{
name|ecore_chain_free
argument_list|(
name|cdev
argument_list|,
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
expr_stmt|;
name|txq
operator|->
name|tx_pbl
operator|.
name|p_virt_addr
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/* This function allocates all memory needed per Tx queue */
end_comment

begin_function
specifier|static
name|int
name|qlnx_alloc_mem_txq
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
parameter_list|)
block|{
name|int
name|ret
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|union
name|eth_tx_bd_types
modifier|*
name|p_virt
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|txq
operator|->
name|sw_tx_ring
index|[
literal|0
index|]
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sw_tx_bd
argument_list|)
operator|*
name|TX_RING_SIZE
operator|)
argument_list|)
expr_stmt|;
comment|/* Allocate the real Tx ring to be used by FW */
name|ret
operator|=
name|ecore_chain_alloc
argument_list|(
name|cdev
argument_list|,
name|ECORE_CHAIN_USE_TO_CONSUME_PRODUCE
argument_list|,
name|ECORE_CHAIN_MODE_PBL
argument_list|,
name|ECORE_CHAIN_CNT_TYPE_U16
argument_list|,
name|TX_RING_SIZE
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_virt
argument_list|)
argument_list|,
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
goto|goto
name|err
goto|;
block|}
name|txq
operator|->
name|num_tx_buffers
operator|=
name|TX_RING_SIZE
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
name|qlnx_free_mem_txq
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|txq
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_tx_br
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mp
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|ha
operator|->
name|ifp
decl_stmt|;
if|if
condition|(
name|mtx_initialized
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
condition|)
block|{
if|if
condition|(
name|fp
operator|->
name|tx_br
operator|!=
name|NULL
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|mp
operator|=
name|drbr_dequeue
argument_list|(
name|ifp
argument_list|,
name|fp
operator|->
name|tx_br
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|fp
operator|->
name|tx_pkts_freed
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|mp
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
name|buf_ring_free
argument_list|(
name|fp
operator|->
name|tx_br
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_br
operator|=
name|NULL
expr_stmt|;
block|}
name|mtx_destroy
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_mem_fp
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|tc
decl_stmt|;
name|qlnx_free_mem_sb
argument_list|(
name|ha
argument_list|,
name|fp
operator|->
name|sb_info
argument_list|)
expr_stmt|;
name|qlnx_free_mem_rxq
argument_list|(
name|ha
argument_list|,
name|fp
operator|->
name|rxq
argument_list|)
expr_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|ha
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
name|qlnx_free_mem_txq
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|fp
operator|->
name|txq
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_tx_br
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|)
block|{
name|snprintf
argument_list|(
name|fp
operator|->
name|tx_mtx_name
argument_list|,
sizeof|sizeof
argument_list|(
name|fp
operator|->
name|tx_mtx_name
argument_list|)
argument_list|,
literal|"qlnx%d_fp%d_tx_mq_lock"
argument_list|,
name|ha
operator|->
name|dev_unit
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|,
name|fp
operator|->
name|tx_mtx_name
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|fp
operator|->
name|tx_br
operator|=
name|buf_ring_alloc
argument_list|(
name|TX_RING_SIZE
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|tx_br
operator|==
name|NULL
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"buf_ring_alloc failed for fp[%d, %d]\n"
argument_list|,
name|ha
operator|->
name|dev_unit
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_mem_fp
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|tc
decl_stmt|;
name|rc
operator|=
name|qlnx_alloc_mem_sb
argument_list|(
name|ha
argument_list|,
name|fp
operator|->
name|sb_info
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|ha
operator|->
name|rx_jumbo_buf_eq_mtu
condition|)
block|{
if|if
condition|(
name|ha
operator|->
name|max_frame_size
operator|<=
name|MCLBYTES
condition|)
name|ha
operator|->
name|rx_buf_size
operator|=
name|MCLBYTES
expr_stmt|;
elseif|else
if|if
condition|(
name|ha
operator|->
name|max_frame_size
operator|<=
name|MJUMPAGESIZE
condition|)
name|ha
operator|->
name|rx_buf_size
operator|=
name|MJUMPAGESIZE
expr_stmt|;
elseif|else
if|if
condition|(
name|ha
operator|->
name|max_frame_size
operator|<=
name|MJUM9BYTES
condition|)
name|ha
operator|->
name|rx_buf_size
operator|=
name|MJUM9BYTES
expr_stmt|;
elseif|else
if|if
condition|(
name|ha
operator|->
name|max_frame_size
operator|<=
name|MJUM16BYTES
condition|)
name|ha
operator|->
name|rx_buf_size
operator|=
name|MJUM16BYTES
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ha
operator|->
name|max_frame_size
operator|<=
name|MCLBYTES
condition|)
name|ha
operator|->
name|rx_buf_size
operator|=
name|MCLBYTES
expr_stmt|;
else|else
name|ha
operator|->
name|rx_buf_size
operator|=
name|MJUMPAGESIZE
expr_stmt|;
block|}
name|rc
operator|=
name|qlnx_alloc_mem_rxq
argument_list|(
name|ha
argument_list|,
name|fp
operator|->
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|ha
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|rc
operator|=
name|qlnx_alloc_mem_txq
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|fp
operator|->
name|txq
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|err
goto|;
block|}
return|return
literal|0
return|;
name|err
label|:
name|qlnx_free_mem_fp
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_free_mem_load
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|qlnx_fastpath
modifier|*
name|fp
init|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
decl_stmt|;
name|qlnx_free_mem_fp
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_alloc_mem_load
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|,
name|rss_id
decl_stmt|;
for|for
control|(
name|rss_id
operator|=
literal|0
init|;
name|rss_id
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|rss_id
operator|++
control|)
block|{
name|struct
name|qlnx_fastpath
modifier|*
name|fp
init|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|rss_id
index|]
decl_stmt|;
name|rc
operator|=
name|qlnx_alloc_mem_fp
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
break|break;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_start_vport
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|,
name|u8
name|vport_id
parameter_list|,
name|u16
name|mtu
parameter_list|,
name|u8
name|drop_ttl0_flg
parameter_list|,
name|u8
name|inner_vlan_removal_en_flg
parameter_list|,
name|u8
name|tx_switching
parameter_list|,
name|u8
name|hw_lro_enable
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|ecore_sp_vport_start_params
name|vport_start_params
init|=
block|{
literal|0
block|}
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
expr_stmt|;
name|vport_start_params
operator|.
name|remove_inner_vlan
operator|=
name|inner_vlan_removal_en_flg
expr_stmt|;
name|vport_start_params
operator|.
name|tx_switching
operator|=
literal|0
expr_stmt|;
name|vport_start_params
operator|.
name|handle_ptp_pkts
operator|=
literal|0
expr_stmt|;
name|vport_start_params
operator|.
name|only_untagged
operator|=
literal|0
expr_stmt|;
name|vport_start_params
operator|.
name|drop_ttl0
operator|=
name|drop_ttl0_flg
expr_stmt|;
name|vport_start_params
operator|.
name|tpa_mode
operator|=
operator|(
name|hw_lro_enable
condition|?
name|ECORE_TPA_MODE_RSC
else|:
name|ECORE_TPA_MODE_NONE
operator|)
expr_stmt|;
name|vport_start_params
operator|.
name|max_buffers_per_cqe
operator|=
name|QLNX_TPA_MAX_AGG_BUFFERS
expr_stmt|;
name|vport_start_params
operator|.
name|vport_id
operator|=
name|vport_id
expr_stmt|;
name|vport_start_params
operator|.
name|mtu
operator|=
name|mtu
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"Setting mtu to %d and VPORT ID = %d\n"
argument_list|,
name|mtu
argument_list|,
name|vport_id
argument_list|)
expr_stmt|;
name|for_each_hwfn
argument_list|(
argument|cdev
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|vport_start_params
operator|.
name|concrete_fid
operator|=
name|p_hwfn
operator|->
name|hw_info
operator|.
name|concrete_fid
expr_stmt|;
name|vport_start_params
operator|.
name|opaque_fid
operator|=
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
expr_stmt|;
name|rc
operator|=
name|ecore_sp_vport_start
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|vport_start_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to start VPORT V-PORT %d"
literal|" with MTU %d\n"
argument_list|,
name|vport_id
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|ecore_hw_start_fastpath
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"Started V-PORT %d with MTU %d\n"
argument_list|,
name|vport_id
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_update_vport
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|cdev
parameter_list|,
name|struct
name|qlnx_update_vport_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ecore_sp_vport_update_params
name|sp_params
decl_stmt|;
name|int
name|rc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|fp_index
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|ecore_rss_params
modifier|*
name|rss
decl_stmt|;
name|qlnx_host_t
modifier|*
name|ha
init|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|cdev
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sp_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sp_params
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Translate protocol params into sp params */
name|sp_params
operator|.
name|vport_id
operator|=
name|params
operator|->
name|vport_id
expr_stmt|;
name|sp_params
operator|.
name|update_vport_active_rx_flg
operator|=
name|params
operator|->
name|update_vport_active_rx_flg
expr_stmt|;
name|sp_params
operator|.
name|vport_active_rx_flg
operator|=
name|params
operator|->
name|vport_active_rx_flg
expr_stmt|;
name|sp_params
operator|.
name|update_vport_active_tx_flg
operator|=
name|params
operator|->
name|update_vport_active_tx_flg
expr_stmt|;
name|sp_params
operator|.
name|vport_active_tx_flg
operator|=
name|params
operator|->
name|vport_active_tx_flg
expr_stmt|;
name|sp_params
operator|.
name|update_inner_vlan_removal_flg
operator|=
name|params
operator|->
name|update_inner_vlan_removal_flg
expr_stmt|;
name|sp_params
operator|.
name|inner_vlan_removal_flg
operator|=
name|params
operator|->
name|inner_vlan_removal_flg
expr_stmt|;
name|sp_params
operator|.
name|sge_tpa_params
operator|=
name|params
operator|->
name|sge_tpa_params
expr_stmt|;
comment|/* RSS - is a bit tricky, since upper-layer isn't familiar with hwfns.          * We need to re-fix the rss values per engine for CMT.          */
if|if
condition|(
name|params
operator|->
name|rss_params
operator|->
name|update_rss_config
condition|)
name|sp_params
operator|.
name|rss_params
operator|=
name|params
operator|->
name|rss_params
expr_stmt|;
else|else
name|sp_params
operator|.
name|rss_params
operator|=
name|NULL
expr_stmt|;
name|for_each_hwfn
argument_list|(
argument|cdev
argument_list|,
argument|i
argument_list|)
block|{
name|p_hwfn
operator|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|cdev
operator|->
name|num_hwfns
operator|>
literal|1
operator|)
operator|&&
name|params
operator|->
name|rss_params
operator|->
name|update_rss_config
operator|&&
name|params
operator|->
name|rss_params
operator|->
name|rss_enable
condition|)
block|{
name|rss
operator|=
name|params
operator|->
name|rss_params
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ECORE_RSS_IND_TABLE_SIZE
condition|;
name|j
operator|++
control|)
block|{
name|fp_index
operator|=
operator|(
operator|(
name|cdev
operator|->
name|num_hwfns
operator|*
name|j
operator|)
operator|+
name|i
operator|)
operator|%
name|ha
operator|->
name|num_rss
expr_stmt|;
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|fp_index
index|]
expr_stmt|;
name|rss
operator|->
name|rss_ind_table
index|[
name|j
index|]
operator|=
name|fp
operator|->
name|rxq
operator|->
name|handle
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ECORE_RSS_IND_TABLE_SIZE
condition|;
control|)
block|{
name|QL_DPRINT3
argument_list|(
name|ha
argument_list|,
literal|"%p %p %p %p %p %p %p %p \n"
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
index|]
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
operator|+
literal|1
index|]
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
operator|+
literal|2
index|]
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
operator|+
literal|3
index|]
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
operator|+
literal|4
index|]
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
operator|+
literal|5
index|]
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
operator|+
literal|6
index|]
argument_list|,
name|rss
operator|->
name|rss_ind_table
index|[
name|j
operator|+
literal|7
index|]
argument_list|)
expr_stmt|;
name|j
operator|+=
literal|8
expr_stmt|;
block|}
block|}
name|sp_params
operator|.
name|opaque_fid
operator|=
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Update sp vport ID=%d\n"
argument_list|,
name|params
operator|->
name|vport_id
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_sp_vport_update
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|sp_params
argument_list|,
name|ECORE_SPQ_MODE_EBLOCK
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to update VPORT\n"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"Updated V-PORT %d: tx_active_flag %d, \ 			rx_active_flag %d [tx_update %d], [rx_update %d]\n"
argument_list|,
name|params
operator|->
name|vport_id
argument_list|,
name|params
operator|->
name|vport_active_tx_flg
argument_list|,
name|params
operator|->
name|vport_active_rx_flg
argument_list|,
name|params
operator|->
name|update_vport_active_tx_flg
argument_list|,
name|params
operator|->
name|update_vport_active_rx_flg
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_reuse_rx_data
parameter_list|(
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|eth_rx_bd
modifier|*
name|rx_bd_cons
init|=
name|ecore_chain_consume
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
decl_stmt|;
name|struct
name|eth_rx_bd
modifier|*
name|rx_bd_prod
init|=
name|ecore_chain_produce
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data_cons
init|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_cons
index|]
decl_stmt|;
name|struct
name|sw_rx_data
modifier|*
name|sw_rx_data_prod
init|=
operator|&
name|rxq
operator|->
name|sw_rx_ring
index|[
name|rxq
operator|->
name|sw_rx_prod
index|]
decl_stmt|;
name|sw_rx_data_prod
operator|->
name|data
operator|=
name|sw_rx_data_cons
operator|->
name|data
expr_stmt|;
name|memcpy
argument_list|(
name|rx_bd_prod
argument_list|,
name|rx_bd_cons
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eth_rx_bd
argument_list|)
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_cons
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_cons
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|rxq
operator|->
name|sw_rx_prod
operator|=
operator|(
name|rxq
operator|->
name|sw_rx_prod
operator|+
literal|1
operator|)
operator|&
operator|(
name|RX_RING_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_update_rx_prod
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|qlnx_rx_queue
modifier|*
name|rxq
parameter_list|)
block|{
name|uint16_t
name|bd_prod
decl_stmt|;
name|uint16_t
name|cqe_prod
decl_stmt|;
union|union
block|{
name|struct
name|eth_rx_prod_data
name|rx_prod_data
decl_stmt|;
name|uint32_t
name|data32
decl_stmt|;
block|}
name|rx_prods
union|;
name|bd_prod
operator|=
name|ecore_chain_get_prod_idx
argument_list|(
operator|&
name|rxq
operator|->
name|rx_bd_ring
argument_list|)
expr_stmt|;
name|cqe_prod
operator|=
name|ecore_chain_get_prod_idx
argument_list|(
operator|&
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
expr_stmt|;
comment|/* Update producers */
name|rx_prods
operator|.
name|rx_prod_data
operator|.
name|bd_prod
operator|=
name|htole16
argument_list|(
name|bd_prod
argument_list|)
expr_stmt|;
name|rx_prods
operator|.
name|rx_prod_data
operator|.
name|cqe_prod
operator|=
name|htole16
argument_list|(
name|cqe_prod
argument_list|)
expr_stmt|;
comment|/* Make sure that the BD and SGE data is updated before updating the          * producers since FW might read the BD/SGE right after the producer          * is updated.          */
name|wmb
argument_list|()
expr_stmt|;
name|internal_ram_wr
argument_list|(
name|p_hwfn
argument_list|,
name|rxq
operator|->
name|hw_rxq_prod_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|rx_prods
argument_list|)
argument_list|,
operator|&
name|rx_prods
operator|.
name|data32
argument_list|)
expr_stmt|;
comment|/* mmiowb is needed to synchronize doorbell writes from more than one          * processor. It guarantees that the write arrives to the device before          * the napi lock is released and another qlnx_poll is called (possibly          * on another CPU). Without this barrier, the next doorbell can bypass          * this doorbell. This is applicable to IA64/Altix systems.          */
name|wmb
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint32_t
name|qlnx_hash_key
index|[]
init|=
block|{
operator|(
operator|(
literal|0x6d
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x5a
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x56
operator|<<
literal|8
operator|)
operator||
literal|0xda
operator|)
block|,
operator|(
operator|(
literal|0x25
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x5b
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x0e
operator|<<
literal|8
operator|)
operator||
literal|0xc2
operator|)
block|,
operator|(
operator|(
literal|0x41
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x67
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x25
operator|<<
literal|8
operator|)
operator||
literal|0x3d
operator|)
block|,
operator|(
operator|(
literal|0x43
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0xa3
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x8f
operator|<<
literal|8
operator|)
operator||
literal|0xb0
operator|)
block|,
operator|(
operator|(
literal|0xd0
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0xca
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x2b
operator|<<
literal|8
operator|)
operator||
literal|0xcb
operator|)
block|,
operator|(
operator|(
literal|0xae
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x7b
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x30
operator|<<
literal|8
operator|)
operator||
literal|0xb4
operator|)
block|,
operator|(
operator|(
literal|0x77
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0xcb
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x2d
operator|<<
literal|8
operator|)
operator||
literal|0xa3
operator|)
block|,
operator|(
operator|(
literal|0x80
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x30
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0xf2
operator|<<
literal|8
operator|)
operator||
literal|0x0c
operator|)
block|,
operator|(
operator|(
literal|0x6a
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x42
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0xb7
operator|<<
literal|8
operator|)
operator||
literal|0x3b
operator|)
block|,
operator|(
operator|(
literal|0xbe
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0xac
operator|<<
literal|16
operator|)
operator||
operator|(
literal|0x01
operator|<<
literal|8
operator|)
operator||
literal|0xfa
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|qlnx_start_queues
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|tc
decl_stmt|,
name|i
decl_stmt|,
name|vport_id
init|=
literal|0
decl_stmt|,
name|drop_ttl0_flg
init|=
literal|1
decl_stmt|,
name|vlan_removal_en
init|=
literal|1
decl_stmt|,
name|tx_switching
init|=
literal|0
decl_stmt|,
name|hw_lro_enable
init|=
literal|0
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
init|=
operator|&
name|ha
operator|->
name|cdev
decl_stmt|;
name|struct
name|ecore_rss_params
modifier|*
name|rss_params
init|=
operator|&
name|ha
operator|->
name|rss_params
decl_stmt|;
name|struct
name|qlnx_update_vport_params
name|vport_update_params
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|ecore_sge_tpa_params
name|tpa_params
decl_stmt|;
name|struct
name|ecore_queue_start_common_params
name|qparams
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Num RSS = %d\n"
argument_list|,
name|ha
operator|->
name|num_rss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ha
operator|->
name|num_rss
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Cannot update V-VPORT as active as there"
literal|" are no Rx queues\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
ifndef|#
directive|ifndef
name|QLNX_SOFT_LRO
name|hw_lro_enable
operator|=
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
expr_stmt|;
endif|#
directive|endif
comment|/* #ifndef QLNX_SOFT_LRO */
name|rc
operator|=
name|qlnx_start_vport
argument_list|(
name|cdev
argument_list|,
name|vport_id
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|,
name|drop_ttl0_flg
argument_list|,
name|vlan_removal_en
argument_list|,
name|tx_switching
argument_list|,
name|hw_lro_enable
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Start V-PORT failed %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"Start vport ramrod passed, "
literal|"vport_id = %d, MTU = %d, vlan_removal_en = %d\n"
argument_list|,
name|vport_id
argument_list|,
call|(
name|int
call|)
argument_list|(
name|ifp
operator|->
name|if_mtu
operator|+
literal|0xe
argument_list|)
argument_list|,
name|vlan_removal_en
argument_list|)
expr_stmt|;
name|for_each_rss
argument_list|(
argument|i
argument_list|)
block|{
name|struct
name|ecore_rxq_start_ret_params
name|rx_ret_params
decl_stmt|;
name|struct
name|ecore_txq_start_ret_params
name|tx_ret_params
decl_stmt|;
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
name|p_hwfn
operator|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
operator|(
name|fp
operator|->
name|rss_id
operator|%
name|cdev
operator|->
name|num_hwfns
operator|)
index|]
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|qparams
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_queue_start_common_params
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|rx_ret_params
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_rxq_start_ret_params
argument_list|)
argument_list|)
expr_stmt|;
name|qparams
operator|.
name|queue_id
operator|=
name|i
expr_stmt|;
name|qparams
operator|.
name|vport_id
operator|=
name|vport_id
expr_stmt|;
name|qparams
operator|.
name|stats_id
operator|=
name|vport_id
expr_stmt|;
name|qparams
operator|.
name|p_sb
operator|=
name|fp
operator|->
name|sb_info
expr_stmt|;
name|qparams
operator|.
name|sb_idx
operator|=
name|RX_PI
expr_stmt|;
name|rc
operator|=
name|ecore_eth_rx_queue_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
argument_list|,
operator|&
name|qparams
argument_list|,
name|fp
operator|->
name|rxq
operator|->
name|rx_buf_size
argument_list|,
comment|/* bd_max_bytes */
comment|/* bd_chain_phys_addr */
name|fp
operator|->
name|rxq
operator|->
name|rx_bd_ring
operator|.
name|p_phys_addr
argument_list|,
comment|/* cqe_pbl_addr */
name|ecore_chain_get_pbl_phys
argument_list|(
operator|&
name|fp
operator|->
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
argument_list|,
comment|/* cqe_pbl_size */
name|ecore_chain_get_page_cnt
argument_list|(
operator|&
name|fp
operator|->
name|rxq
operator|->
name|rx_comp_ring
argument_list|)
argument_list|,
operator|&
name|rx_ret_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Start RXQ #%d failed %d\n"
argument_list|,
name|i
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|fp
operator|->
name|rxq
operator|->
name|hw_rxq_prod_addr
operator|=
name|rx_ret_params
operator|.
name|p_prod
expr_stmt|;
name|fp
operator|->
name|rxq
operator|->
name|handle
operator|=
name|rx_ret_params
operator|.
name|p_handle
expr_stmt|;
name|fp
operator|->
name|rxq
operator|->
name|hw_cons_ptr
operator|=
operator|&
name|fp
operator|->
name|sb_info
operator|->
name|sb_virt
operator|->
name|pi_array
index|[
name|RX_PI
index|]
expr_stmt|;
name|qlnx_update_rx_prod
argument_list|(
name|p_hwfn
argument_list|,
name|fp
operator|->
name|rxq
argument_list|)
expr_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|ha
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
init|=
name|fp
operator|->
name|txq
index|[
name|tc
index|]
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|qparams
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_queue_start_common_params
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|tx_ret_params
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_txq_start_ret_params
argument_list|)
argument_list|)
expr_stmt|;
name|qparams
operator|.
name|queue_id
operator|=
name|txq
operator|->
name|index
operator|/
name|cdev
operator|->
name|num_hwfns
expr_stmt|;
name|qparams
operator|.
name|vport_id
operator|=
name|vport_id
expr_stmt|;
name|qparams
operator|.
name|stats_id
operator|=
name|vport_id
expr_stmt|;
name|qparams
operator|.
name|p_sb
operator|=
name|fp
operator|->
name|sb_info
expr_stmt|;
name|qparams
operator|.
name|sb_idx
operator|=
name|TX_PI
argument_list|(
name|tc
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_eth_tx_queue_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
argument_list|,
operator|&
name|qparams
argument_list|,
name|tc
argument_list|,
comment|/* bd_chain_phys_addr */
name|ecore_chain_get_pbl_phys
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|,
name|ecore_chain_get_page_cnt
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
argument_list|,
operator|&
name|tx_ret_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Start TXQ #%d failed %d\n"
argument_list|,
name|txq
operator|->
name|index
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|txq
operator|->
name|doorbell_addr
operator|=
name|tx_ret_params
operator|.
name|p_doorbell
expr_stmt|;
name|txq
operator|->
name|handle
operator|=
name|tx_ret_params
operator|.
name|p_handle
expr_stmt|;
name|txq
operator|->
name|hw_cons_ptr
operator|=
operator|&
name|fp
operator|->
name|sb_info
operator|->
name|sb_virt
operator|->
name|pi_array
index|[
name|TX_PI
argument_list|(
name|tc
argument_list|)
index|]
expr_stmt|;
name|SET_FIELD
argument_list|(
name|txq
operator|->
name|tx_db
operator|.
name|data
operator|.
name|params
argument_list|,
name|ETH_DB_DATA_DEST
argument_list|,
name|DB_DEST_XCM
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|txq
operator|->
name|tx_db
operator|.
name|data
operator|.
name|params
argument_list|,
name|ETH_DB_DATA_AGG_CMD
argument_list|,
name|DB_AGG_CMD_SET
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|txq
operator|->
name|tx_db
operator|.
name|data
operator|.
name|params
argument_list|,
name|ETH_DB_DATA_AGG_VAL_SEL
argument_list|,
name|DQ_XCM_ETH_TX_BD_PROD_CMD
argument_list|)
expr_stmt|;
name|txq
operator|->
name|tx_db
operator|.
name|data
operator|.
name|agg_flags
operator|=
name|DQ_XCM_ETH_DQ_CF_CMD
expr_stmt|;
block|}
block|}
comment|/* Fill struct with RSS params */
if|if
condition|(
name|ha
operator|->
name|num_rss
operator|>
literal|1
condition|)
block|{
name|rss_params
operator|->
name|update_rss_config
operator|=
literal|1
expr_stmt|;
name|rss_params
operator|->
name|rss_enable
operator|=
literal|1
expr_stmt|;
name|rss_params
operator|->
name|update_rss_capabilities
operator|=
literal|1
expr_stmt|;
name|rss_params
operator|->
name|update_rss_ind_table
operator|=
literal|1
expr_stmt|;
name|rss_params
operator|->
name|update_rss_key
operator|=
literal|1
expr_stmt|;
name|rss_params
operator|->
name|rss_caps
operator|=
name|ECORE_RSS_IPV4
operator||
name|ECORE_RSS_IPV6
operator||
name|ECORE_RSS_IPV4_TCP
operator||
name|ECORE_RSS_IPV6_TCP
expr_stmt|;
name|rss_params
operator|->
name|rss_table_size_log
operator|=
literal|7
expr_stmt|;
comment|/* 2^7 = 128 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_RSS_IND_TABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
operator|(
name|i
operator|%
name|ha
operator|->
name|num_rss
operator|)
index|]
expr_stmt|;
name|rss_params
operator|->
name|rss_ind_table
index|[
name|i
index|]
operator|=
name|fp
operator|->
name|rxq
operator|->
name|handle
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_RSS_KEY_SIZE
condition|;
name|i
operator|++
control|)
name|rss_params
operator|->
name|rss_key
index|[
name|i
index|]
operator|=
operator|(
name|__le32
operator|)
name|qlnx_hash_key
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|memset
argument_list|(
name|rss_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rss_params
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Prepare and send the vport enable */
name|memset
argument_list|(
operator|&
name|vport_update_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|vport_update_params
argument_list|)
argument_list|)
expr_stmt|;
name|vport_update_params
operator|.
name|vport_id
operator|=
name|vport_id
expr_stmt|;
name|vport_update_params
operator|.
name|update_vport_active_tx_flg
operator|=
literal|1
expr_stmt|;
name|vport_update_params
operator|.
name|vport_active_tx_flg
operator|=
literal|1
expr_stmt|;
name|vport_update_params
operator|.
name|update_vport_active_rx_flg
operator|=
literal|1
expr_stmt|;
name|vport_update_params
operator|.
name|vport_active_rx_flg
operator|=
literal|1
expr_stmt|;
name|vport_update_params
operator|.
name|rss_params
operator|=
name|rss_params
expr_stmt|;
name|vport_update_params
operator|.
name|update_inner_vlan_removal_flg
operator|=
literal|1
expr_stmt|;
name|vport_update_params
operator|.
name|inner_vlan_removal_flg
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|hw_lro_enable
condition|)
block|{
name|memset
argument_list|(
operator|&
name|tpa_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_sge_tpa_params
argument_list|)
argument_list|)
expr_stmt|;
name|tpa_params
operator|.
name|max_buffers_per_cqe
operator|=
name|QLNX_TPA_MAX_AGG_BUFFERS
expr_stmt|;
name|tpa_params
operator|.
name|update_tpa_en_flg
operator|=
literal|1
expr_stmt|;
name|tpa_params
operator|.
name|tpa_ipv4_en_flg
operator|=
literal|1
expr_stmt|;
name|tpa_params
operator|.
name|tpa_ipv6_en_flg
operator|=
literal|1
expr_stmt|;
name|tpa_params
operator|.
name|update_tpa_param_flg
operator|=
literal|1
expr_stmt|;
name|tpa_params
operator|.
name|tpa_pkt_split_flg
operator|=
literal|0
expr_stmt|;
name|tpa_params
operator|.
name|tpa_hdr_data_split_flg
operator|=
literal|0
expr_stmt|;
name|tpa_params
operator|.
name|tpa_gro_consistent_flg
operator|=
literal|0
expr_stmt|;
name|tpa_params
operator|.
name|tpa_max_aggs_num
operator|=
name|ETH_TPA_MAX_AGGS_NUM
expr_stmt|;
name|tpa_params
operator|.
name|tpa_max_size
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tpa_params
operator|.
name|tpa_min_size_to_start
operator|=
name|ifp
operator|->
name|if_mtu
operator|/
literal|2
expr_stmt|;
name|tpa_params
operator|.
name|tpa_min_size_to_cont
operator|=
name|ifp
operator|->
name|if_mtu
operator|/
literal|2
expr_stmt|;
name|vport_update_params
operator|.
name|sge_tpa_params
operator|=
operator|&
name|tpa_params
expr_stmt|;
block|}
name|rc
operator|=
name|qlnx_update_vport
argument_list|(
name|cdev
argument_list|,
operator|&
name|vport_update_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Update V-PORT failed %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_drain_txq
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|qlnx_fastpath
modifier|*
name|fp
parameter_list|,
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
parameter_list|)
block|{
name|uint16_t
name|hw_bd_cons
decl_stmt|;
name|uint16_t
name|ecore_cons_idx
decl_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
name|hw_bd_cons
operator|=
name|le16toh
argument_list|(
operator|*
name|txq
operator|->
name|hw_cons_ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|hw_bd_cons
operator|!=
operator|(
name|ecore_cons_idx
operator|=
name|ecore_chain_get_cons_idx
argument_list|(
operator|&
name|txq
operator|->
name|tx_pbl
argument_list|)
operator|)
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|qlnx_tx_int
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|txq
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|fp
operator|->
name|tx_mtx
argument_list|)
expr_stmt|;
name|qlnx_mdelay
argument_list|(
name|__func__
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|hw_bd_cons
operator|=
name|le16toh
argument_list|(
operator|*
name|txq
operator|->
name|hw_cons_ptr
argument_list|)
expr_stmt|;
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"[%d, %d]: done\n"
argument_list|,
name|fp
operator|->
name|rss_id
argument_list|,
name|txq
operator|->
name|index
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_stop_queues
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|qlnx_update_vport_params
name|vport_update_params
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|qlnx_fastpath
modifier|*
name|fp
decl_stmt|;
name|int
name|rc
decl_stmt|,
name|tc
decl_stmt|,
name|i
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
comment|/* Disable the vport */
name|memset
argument_list|(
operator|&
name|vport_update_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|vport_update_params
argument_list|)
argument_list|)
expr_stmt|;
name|vport_update_params
operator|.
name|vport_id
operator|=
literal|0
expr_stmt|;
name|vport_update_params
operator|.
name|update_vport_active_tx_flg
operator|=
literal|1
expr_stmt|;
name|vport_update_params
operator|.
name|vport_active_tx_flg
operator|=
literal|0
expr_stmt|;
name|vport_update_params
operator|.
name|update_vport_active_rx_flg
operator|=
literal|1
expr_stmt|;
name|vport_update_params
operator|.
name|vport_active_rx_flg
operator|=
literal|0
expr_stmt|;
name|vport_update_params
operator|.
name|rss_params
operator|=
operator|&
name|ha
operator|->
name|rss_params
expr_stmt|;
name|vport_update_params
operator|.
name|rss_params
operator|->
name|update_rss_config
operator|=
literal|0
expr_stmt|;
name|vport_update_params
operator|.
name|rss_params
operator|->
name|rss_enable
operator|=
literal|0
expr_stmt|;
name|vport_update_params
operator|.
name|update_inner_vlan_removal_flg
operator|=
literal|0
expr_stmt|;
name|vport_update_params
operator|.
name|inner_vlan_removal_flg
operator|=
literal|0
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Update vport ID= %d\n"
argument_list|,
name|vport_update_params
operator|.
name|vport_id
argument_list|)
expr_stmt|;
name|rc
operator|=
name|qlnx_update_vport
argument_list|(
name|cdev
argument_list|,
operator|&
name|vport_update_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to update vport\n"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
comment|/* Flush Tx queues. If needed, request drain from MCP */
name|for_each_rss
argument_list|(
argument|i
argument_list|)
block|{
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|ha
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|struct
name|qlnx_tx_queue
modifier|*
name|txq
init|=
name|fp
operator|->
name|txq
index|[
name|tc
index|]
decl_stmt|;
name|rc
operator|=
name|qlnx_drain_txq
argument_list|(
name|ha
argument_list|,
name|fp
argument_list|,
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
block|}
block|}
comment|/* Stop all Queues in reverse order*/
for|for
control|(
name|i
operator|=
name|ha
operator|->
name|num_rss
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
operator|(
name|i
operator|%
name|cdev
operator|->
name|num_hwfns
operator|)
index|]
decl_stmt|;
name|fp
operator|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
expr_stmt|;
comment|/* Stop the Tx Queue(s)*/
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|ha
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|int
name|tx_queue_id
decl_stmt|;
name|tx_queue_id
operator|=
name|tc
operator|*
name|ha
operator|->
name|num_rss
operator|+
name|i
expr_stmt|;
name|rc
operator|=
name|ecore_eth_tx_queue_stop
argument_list|(
name|p_hwfn
argument_list|,
name|fp
operator|->
name|txq
index|[
name|tc
index|]
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to stop TXQ #%d\n"
argument_list|,
name|tx_queue_id
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
block|}
comment|/* Stop the Rx Queue*/
name|rc
operator|=
name|ecore_eth_rx_queue_stop
argument_list|(
name|p_hwfn
argument_list|,
name|fp
operator|->
name|rxq
operator|->
name|handle
argument_list|,
name|false
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to stop RXQ #%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
block|}
comment|/* Stop the vport */
name|for_each_hwfn
argument_list|(
argument|cdev
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|rc
operator|=
name|ecore_sp_vport_stop
argument_list|(
name|p_hwfn
argument_list|,
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"Failed to stop VPORT\n"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_ucast_rx_mac
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|enum
name|ecore_filter_opcode
name|opcode
parameter_list|,
name|unsigned
name|char
name|mac
index|[
name|ETH_ALEN
index|]
parameter_list|)
block|{
name|struct
name|ecore_filter_ucast
name|ucast
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ucast
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_filter_ucast
argument_list|)
argument_list|)
expr_stmt|;
name|ucast
operator|.
name|opcode
operator|=
name|opcode
expr_stmt|;
name|ucast
operator|.
name|type
operator|=
name|ECORE_FILTER_MAC
expr_stmt|;
name|ucast
operator|.
name|is_rx_filter
operator|=
literal|1
expr_stmt|;
name|ucast
operator|.
name|vport_to_add_to
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ucast
operator|.
name|mac
index|[
literal|0
index|]
argument_list|,
name|mac
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_filter_ucast_cmd
argument_list|(
name|cdev
argument_list|,
operator|&
name|ucast
argument_list|,
name|ECORE_SPQ_MODE_CB
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_remove_all_ucast_mac
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ecore_filter_ucast
name|ucast
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ucast
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_filter_ucast
argument_list|)
argument_list|)
expr_stmt|;
name|ucast
operator|.
name|opcode
operator|=
name|ECORE_FILTER_REPLACE
expr_stmt|;
name|ucast
operator|.
name|type
operator|=
name|ECORE_FILTER_MAC
expr_stmt|;
name|ucast
operator|.
name|is_rx_filter
operator|=
literal|1
expr_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|rc
operator|=
name|ecore_filter_ucast_cmd
argument_list|(
name|cdev
argument_list|,
operator|&
name|ucast
argument_list|,
name|ECORE_SPQ_MODE_CB
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_remove_all_mcast_mac
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ecore_filter_mcast
modifier|*
name|mcast
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|int
name|rc
decl_stmt|,
name|i
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|mcast
operator|=
operator|&
name|ha
operator|->
name|ecore_mcast
expr_stmt|;
name|bzero
argument_list|(
name|mcast
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_filter_mcast
argument_list|)
argument_list|)
expr_stmt|;
name|mcast
operator|->
name|opcode
operator|=
name|ECORE_FILTER_REMOVE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QLNX_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|||
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|||
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|||
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|||
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|||
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|mcast
operator|->
name|mac
index|[
name|i
index|]
argument_list|,
operator|&
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mcast
operator|->
name|num_mc_addrs
operator|++
expr_stmt|;
block|}
block|}
name|mcast
operator|=
operator|&
name|ha
operator|->
name|ecore_mcast
expr_stmt|;
name|rc
operator|=
name|ecore_filter_mcast_cmd
argument_list|(
name|cdev
argument_list|,
name|mcast
argument_list|,
name|ECORE_SPQ_MODE_CB
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ha
operator|->
name|mcast
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|qlnx_mcast_t
argument_list|)
operator|*
name|QLNX_MAX_NUM_MULTICAST_ADDRS
operator|)
argument_list|)
expr_stmt|;
name|ha
operator|->
name|nmcast
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_clean_filters
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
comment|/* Remove all unicast macs */
name|rc
operator|=
name|qlnx_remove_all_ucast_mac
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
comment|/* Remove all multicast macs */
name|rc
operator|=
name|qlnx_remove_all_mcast_mac
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|qlnx_set_ucast_rx_mac
argument_list|(
name|ha
argument_list|,
name|ECORE_FILTER_FLUSH
argument_list|,
name|ha
operator|->
name|primary_mac
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_rx_accept_filter
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
name|filter
parameter_list|)
block|{
name|struct
name|ecore_filter_accept_flags
name|accept
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|accept
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_filter_accept_flags
argument_list|)
argument_list|)
expr_stmt|;
name|accept
operator|.
name|update_rx_mode_config
operator|=
literal|1
expr_stmt|;
name|accept
operator|.
name|rx_accept_filter
operator|=
name|filter
expr_stmt|;
name|accept
operator|.
name|update_tx_mode_config
operator|=
literal|1
expr_stmt|;
name|accept
operator|.
name|tx_accept_filter
operator|=
name|ECORE_ACCEPT_UCAST_MATCHED
operator||
name|ECORE_ACCEPT_MCAST_MATCHED
operator||
name|ECORE_ACCEPT_BCAST
expr_stmt|;
name|rc
operator|=
name|ecore_filter_accept_cmd
argument_list|(
name|cdev
argument_list|,
literal|0
argument_list|,
name|accept
argument_list|,
name|false
argument_list|,
name|false
argument_list|,
name|ECORE_SPQ_MODE_CB
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_rx_mode
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|filter
decl_stmt|;
name|rc
operator|=
name|qlnx_set_ucast_rx_mac
argument_list|(
name|ha
argument_list|,
name|ECORE_FILTER_REPLACE
argument_list|,
name|ha
operator|->
name|primary_mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|qlnx_remove_all_mcast_mac
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|filter
operator|=
name|ECORE_ACCEPT_UCAST_MATCHED
operator||
name|ECORE_ACCEPT_MCAST_MATCHED
operator||
name|ECORE_ACCEPT_BCAST
expr_stmt|;
name|ha
operator|->
name|filter
operator|=
name|filter
expr_stmt|;
name|rc
operator|=
name|qlnx_set_rx_accept_filter
argument_list|(
name|ha
argument_list|,
name|filter
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_set_link
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|bool
name|link_up
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|hwfn
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|ptt
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|for_each_hwfn
argument_list|(
argument|cdev
argument_list|,
argument|i
argument_list|)
block|{
name|hwfn
operator|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
name|i
index|]
expr_stmt|;
name|ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptt
condition|)
return|return
operator|-
name|EBUSY
return|;
name|rc
operator|=
name|ecore_mcp_set_link
argument_list|(
name|hwfn
argument_list|,
name|ptt
argument_list|,
name|link_up
argument_list|)
expr_stmt|;
name|ecore_ptt_release
argument_list|(
name|hwfn
argument_list|,
name|ptt
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
block|}
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
end_if

begin_function
specifier|static
name|uint64_t
name|qlnx_get_counter
parameter_list|(
name|if_t
name|ifp
parameter_list|,
name|ift_counter
name|cnt
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|uint64_t
name|count
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|if_getsoftc
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cnt
condition|)
block|{
case|case
name|IFCOUNTER_IPACKETS
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_ucast_pkts
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mcast_pkts
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_bcast_pkts
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_IERRORS
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_crc_errors
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_align_errors
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_oversize_packets
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_undersize_packets
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OPACKETS
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_ucast_pkts
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mcast_pkts
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_bcast_pkts
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OERRORS
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_err_drop_pkts
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_COLLISIONS
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|IFCOUNTER_IBYTES
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_ucast_bytes
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mcast_bytes
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_bcast_bytes
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OBYTES
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_ucast_bytes
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mcast_bytes
operator|+
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_bcast_bytes
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_IMCASTS
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|rx_mcast_bytes
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OMCASTS
case|:
name|count
operator|=
name|ha
operator|->
name|hw_stats
operator|.
name|common
operator|.
name|tx_mcast_bytes
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_IQDROPS
case|:
case|case
name|IFCOUNTER_OQDROPS
case|:
case|case
name|IFCOUNTER_NOPROTO
case|:
default|default:
return|return
operator|(
name|if_get_counter_default
argument_list|(
name|ifp
argument_list|,
name|cnt
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|count
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|qlnx_timer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|qlnx_host_t
modifier|*
name|ha
decl_stmt|;
name|ha
operator|=
operator|(
name|qlnx_host_t
operator|*
operator|)
name|arg
expr_stmt|;
name|ecore_get_vport_stats
argument_list|(
operator|&
name|ha
operator|->
name|cdev
argument_list|,
operator|&
name|ha
operator|->
name|hw_stats
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|storm_stats_enable
condition|)
name|qlnx_sample_storm_stats
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|ha
operator|->
name|qlnx_callout
argument_list|,
name|hz
argument_list|,
name|qlnx_timer
argument_list|,
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_load
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|qlnx_alloc_mem_arrays
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|qlnx_load_exit0
goto|;
name|qlnx_init_fp
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|rc
operator|=
name|qlnx_alloc_mem_load
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|qlnx_load_exit1
goto|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"Allocated %d RSS queues on %d TC/s\n"
argument_list|,
name|ha
operator|->
name|num_rss
argument_list|,
name|ha
operator|->
name|num_tc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rc
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
operator|(
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
operator|)
argument_list|,
name|NULL
argument_list|,
name|qlnx_fp_isr
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
argument_list|,
operator|&
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
argument_list|)
operator|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"could not setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_load_exit2
goto|;
block|}
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"rss_id = %d irq_rid %d \ 			 irq %p handle %p\n"
argument_list|,
name|i
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq_rid
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
argument_list|)
expr_stmt|;
name|bus_bind_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
operator|(
name|i
operator|%
name|mp_ncpus
operator|)
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|qlnx_start_queues
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|qlnx_load_exit2
goto|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"Start VPORT, RXQ and TXQ succeeded\n"
argument_list|)
expr_stmt|;
comment|/* Add primary mac and set Rx filters */
name|rc
operator|=
name|qlnx_set_rx_mode
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
goto|goto
name|qlnx_load_exit2
goto|;
comment|/* Ask for link-up using current configuration */
name|qlnx_set_link
argument_list|(
name|ha
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ha
operator|->
name|state
operator|=
name|QLNX_STATE_OPEN
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ha
operator|->
name|hw_stats
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_eth_stats
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|callout_init
condition|)
name|callout_reset
argument_list|(
operator|&
name|ha
operator|->
name|qlnx_callout
argument_list|,
name|hz
argument_list|,
name|qlnx_timer
argument_list|,
name|ha
argument_list|)
expr_stmt|;
goto|goto
name|qlnx_load_exit0
goto|;
name|qlnx_load_exit2
label|:
name|qlnx_free_mem_load
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_load_exit1
label|:
name|ha
operator|->
name|num_rss
operator|=
literal|0
expr_stmt|;
name|qlnx_load_exit0
label|:
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit [%d]\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_drain_soft_lro
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|QLNX_SOFT_LRO
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ifp
operator|=
name|ha
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|qlnx_fastpath
modifier|*
name|fp
init|=
operator|&
name|ha
operator|->
name|fp_array
index|[
name|i
index|]
decl_stmt|;
name|struct
name|lro_ctrl
modifier|*
name|lro
decl_stmt|;
name|lro
operator|=
operator|&
name|fp
operator|->
name|rxq
operator|->
name|lro
expr_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100101
operator|)
operator|||
operator|(
name|defined
name|QLNX_QSORT_LRO
operator|)
name|tcp_lro_flush_all
argument_list|(
name|lro
argument_list|)
expr_stmt|;
else|#
directive|else
name|struct
name|lro_entry
modifier|*
name|queued
decl_stmt|;
while|while
condition|(
operator|(
operator|!
name|SLIST_EMPTY
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|)
operator|)
condition|)
block|{
name|queued
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|)
expr_stmt|;
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|tcp_lro_flush
argument_list|(
name|lro
argument_list|,
name|queued
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* #if (__FreeBSD_version>= 1100101) || (defined QLNX_QSORT_LRO) */
block|}
block|}
endif|#
directive|endif
comment|/* #ifdef QLNX_SOFT_LRO */
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_unload
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"enter\n"
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|" QLNX STATE = %d\n"
argument_list|,
name|ha
operator|->
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|state
operator|==
name|QLNX_STATE_OPEN
condition|)
block|{
name|qlnx_set_link
argument_list|(
name|ha
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|qlnx_clean_filters
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_stop_queues
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ecore_hw_stop_fastpath
argument_list|(
name|cdev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
condition|)
block|{
operator|(
name|void
operator|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|irq
argument_list|,
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
argument_list|)
expr_stmt|;
name|ha
operator|->
name|irq_vec
index|[
name|i
index|]
operator|.
name|handle
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|qlnx_drain_fp_taskqueues
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_drain_soft_lro
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qlnx_free_mem_load
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|callout_init
condition|)
name|callout_drain
argument_list|(
operator|&
name|ha
operator|->
name|qlnx_callout
argument_list|)
expr_stmt|;
name|qlnx_mdelay
argument_list|(
name|__func__
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
name|ha
operator|->
name|state
operator|=
name|QLNX_STATE_CLOSED
expr_stmt|;
name|QL_DPRINT2
argument_list|(
name|ha
argument_list|,
literal|"exit\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_grc_dumpsize
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|num_dwords
parameter_list|,
name|int
name|hwfn_index
parameter_list|)
block|{
name|int
name|rval
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
decl_stmt|;
name|ecore_dbg_set_app_ver
argument_list|(
name|ecore_dbg_get_fw_func_ver
argument_list|()
argument_list|)
expr_stmt|;
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
name|hwfn_index
index|]
expr_stmt|;
name|p_ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_ptt
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"ecore_ptt_acquire failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
name|rval
operator|=
name|ecore_dbg_grc_get_dump_buf_size
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|num_dwords
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
name|DBG_STATUS_OK
condition|)
name|rval
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"ecore_dbg_grc_get_dump_buf_size failed"
literal|"[0x%x]\n"
argument_list|,
name|rval
argument_list|)
expr_stmt|;
block|}
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qlnx_idle_chk_size
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|num_dwords
parameter_list|,
name|int
name|hwfn_index
parameter_list|)
block|{
name|int
name|rval
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
decl_stmt|;
name|ecore_dbg_set_app_ver
argument_list|(
name|ecore_dbg_get_fw_func_ver
argument_list|()
argument_list|)
expr_stmt|;
name|p_hwfn
operator|=
operator|&
name|ha
operator|->
name|cdev
operator|.
name|hwfns
index|[
name|hwfn_index
index|]
expr_stmt|;
name|p_ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_ptt
condition|)
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"ecore_ptt_acquire failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
name|rval
operator|=
name|ecore_dbg_idle_chk_get_dump_buf_size
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|num_dwords
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
name|DBG_STATUS_OK
condition|)
name|rval
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|QL_DPRINT1
argument_list|(
name|ha
argument_list|,
literal|"ecore_dbg_idle_chk_get_dump_buf_size failed"
literal|" [0x%x]\n"
argument_list|,
name|rval
argument_list|)
expr_stmt|;
block|}
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qlnx_sample_storm_stats
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|index
decl_stmt|;
name|struct
name|ecore_dev
modifier|*
name|cdev
decl_stmt|;
name|qlnx_storm_stats_t
modifier|*
name|s_stats
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
decl_stmt|;
name|struct
name|ecore_hwfn
modifier|*
name|hwfn
decl_stmt|;
if|if
condition|(
name|ha
operator|->
name|storm_stats_index
operator|>=
name|QLNX_STORM_STATS_SAMPLES_PER_HWFN
condition|)
block|{
name|ha
operator|->
name|storm_stats_enable
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|cdev
operator|=
operator|&
name|ha
operator|->
name|cdev
expr_stmt|;
name|for_each_hwfn
argument_list|(
argument|cdev
argument_list|,
argument|i
argument_list|)
block|{
name|hwfn
operator|=
operator|&
name|cdev
operator|->
name|hwfns
index|[
name|i
index|]
expr_stmt|;
name|p_ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_ptt
condition|)
return|return;
name|index
operator|=
name|ha
operator|->
name|storm_stats_index
operator|+
operator|(
name|i
operator|*
name|QLNX_STORM_STATS_SAMPLES_PER_HWFN
operator|)
expr_stmt|;
name|s_stats
operator|=
operator|&
name|ha
operator|->
name|storm_stats
index|[
name|index
index|]
expr_stmt|;
comment|/* XSTORM */
name|reg
operator|=
name|XSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_ACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|xstorm_active_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|XSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_STALL_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|xstorm_stall_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|XSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_SLEEPING_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|xstorm_sleeping_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|XSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_INACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|xstorm_inactive_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* YSTORM */
name|reg
operator|=
name|YSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_ACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ystorm_active_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|YSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_STALL_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ystorm_stall_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|YSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_SLEEPING_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ystorm_sleeping_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|YSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_INACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ystorm_inactive_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* PSTORM */
name|reg
operator|=
name|PSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_ACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|pstorm_active_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|PSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_STALL_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|pstorm_stall_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|PSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_SLEEPING_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|pstorm_sleeping_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|PSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_INACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|pstorm_inactive_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* TSTORM */
name|reg
operator|=
name|TSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_ACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|tstorm_active_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|TSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_STALL_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|tstorm_stall_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|TSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_SLEEPING_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|tstorm_sleeping_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|TSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_INACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|tstorm_inactive_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* MSTORM */
name|reg
operator|=
name|MSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_ACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|mstorm_active_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|MSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_STALL_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|mstorm_stall_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|MSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_SLEEPING_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|mstorm_sleeping_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|MSEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_INACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|mstorm_inactive_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* USTORM */
name|reg
operator|=
name|USEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_ACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ustorm_active_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|USEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_STORM_STALL_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ustorm_stall_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|USEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_SLEEPING_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ustorm_sleeping_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|USEM_REG_FAST_MEMORY
operator|+
name|SEM_FAST_REG_IDLE_INACTIVE_CYCLES_BB_K2
expr_stmt|;
name|s_stats
operator|->
name|ustorm_inactive_cycles
operator|=
name|ecore_rd
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ecore_ptt_release
argument_list|(
name|hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|storm_stats_index
operator|++
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qlnx_dump_buf8  * Function: dumps a buffer as bytes  */
end_comment

begin_function
specifier|static
name|void
name|qlnx_dump_buf8
parameter_list|(
name|qlnx_host_t
modifier|*
name|ha
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|dbuf
parameter_list|,
name|uint32_t
name|len
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|i
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|buf
operator|=
name|dbuf
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: %s 0x%x dump start\n"
argument_list|,
name|__func__
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|>=
literal|16
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|,
name|buf
index|[
literal|9
index|]
argument_list|,
name|buf
index|[
literal|10
index|]
argument_list|,
name|buf
index|[
literal|11
index|]
argument_list|,
name|buf
index|[
literal|12
index|]
argument_list|,
name|buf
index|[
literal|13
index|]
argument_list|,
name|buf
index|[
literal|14
index|]
argument_list|,
name|buf
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
name|i
operator|+=
literal|16
expr_stmt|;
name|len
operator|-=
literal|16
expr_stmt|;
name|buf
operator|+=
literal|16
expr_stmt|;
block|}
switch|switch
condition|(
name|len
condition|)
block|{
case|case
literal|1
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x: %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x: %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x: %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x: %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|10
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|,
name|buf
index|[
literal|9
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|11
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|,
name|buf
index|[
literal|9
index|]
argument_list|,
name|buf
index|[
literal|10
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|12
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|,
name|buf
index|[
literal|9
index|]
argument_list|,
name|buf
index|[
literal|10
index|]
argument_list|,
name|buf
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|13
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|,
name|buf
index|[
literal|9
index|]
argument_list|,
name|buf
index|[
literal|10
index|]
argument_list|,
name|buf
index|[
literal|11
index|]
argument_list|,
name|buf
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|14
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|,
name|buf
index|[
literal|9
index|]
argument_list|,
name|buf
index|[
literal|10
index|]
argument_list|,
name|buf
index|[
literal|11
index|]
argument_list|,
name|buf
index|[
literal|12
index|]
argument_list|,
name|buf
index|[
literal|13
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"0x%08x:"
literal|" %02x %02x %02x %02x %02x %02x %02x %02x"
literal|" %02x %02x %02x %02x %02x %02x %02x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|,
name|buf
index|[
literal|4
index|]
argument_list|,
name|buf
index|[
literal|5
index|]
argument_list|,
name|buf
index|[
literal|6
index|]
argument_list|,
name|buf
index|[
literal|7
index|]
argument_list|,
name|buf
index|[
literal|8
index|]
argument_list|,
name|buf
index|[
literal|9
index|]
argument_list|,
name|buf
index|[
literal|10
index|]
argument_list|,
name|buf
index|[
literal|11
index|]
argument_list|,
name|buf
index|[
literal|12
index|]
argument_list|,
name|buf
index|[
literal|13
index|]
argument_list|,
name|buf
index|[
literal|14
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: %s dump end\n"
argument_list|,
name|__func__
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


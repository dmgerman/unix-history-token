begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2017-2018 Cavium, Inc.   * All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * File : ecore_dcbx.c  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"bcm_osal.h"
end_include

begin_include
include|#
directive|include
file|"ecore.h"
end_include

begin_include
include|#
directive|include
file|"ecore_sp_commands.h"
end_include

begin_include
include|#
directive|include
file|"ecore_dcbx.h"
end_include

begin_include
include|#
directive|include
file|"ecore_cxt.h"
end_include

begin_include
include|#
directive|include
file|"ecore_gtt_reg_addr.h"
end_include

begin_include
include|#
directive|include
file|"ecore_iro.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_ECORE_ROCE
end_ifdef

begin_include
include|#
directive|include
file|"ecore_roce.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ecore_iov_api.h"
end_include

begin_define
define|#
directive|define
name|ECORE_DCBX_MAX_MIB_READ_TRY
value|(100)
end_define

begin_define
define|#
directive|define
name|ECORE_ETH_TYPE_DEFAULT
value|(0)
end_define

begin_define
define|#
directive|define
name|ECORE_ETH_TYPE_ROCE
value|(0x8915)
end_define

begin_define
define|#
directive|define
name|ECORE_UDP_PORT_TYPE_ROCE_V2
value|(0x12B7)
end_define

begin_define
define|#
directive|define
name|ECORE_ETH_TYPE_FCOE
value|(0x8906)
end_define

begin_define
define|#
directive|define
name|ECORE_TCP_PORT_ISCSI
value|(0xCBC)
end_define

begin_define
define|#
directive|define
name|ECORE_DCBX_INVALID_PRIORITY
value|0xFF
end_define

begin_comment
comment|/* Get Traffic Class from priority traffic class table, 4 bits represent  * the traffic class corresponding to the priority.  */
end_comment

begin_define
define|#
directive|define
name|ECORE_DCBX_PRIO2TC
parameter_list|(
name|prio_tc_tbl
parameter_list|,
name|prio
parameter_list|)
define|\
value|((u32)(prio_tc_tbl>> ((7 - prio) * 4))& 0x7)
end_define

begin_function
specifier|static
name|bool
name|ecore_dcbx_app_ethtype
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|)
block|{
return|return
operator|!
operator|!
operator|(
name|ECORE_MFW_GET_FIELD
argument_list|(
name|app_info_bitmap
argument_list|,
name|DCBX_APP_SF
argument_list|)
operator|==
name|DCBX_APP_SF_ETHTYPE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_ieee_app_ethtype
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|)
block|{
name|u8
name|mfw_val
init|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|app_info_bitmap
argument_list|,
name|DCBX_APP_SF_IEEE
argument_list|)
decl_stmt|;
comment|/* Old MFW */
if|if
condition|(
name|mfw_val
operator|==
name|DCBX_APP_SF_IEEE_RESERVED
condition|)
return|return
name|ecore_dcbx_app_ethtype
argument_list|(
name|app_info_bitmap
argument_list|)
return|;
return|return
operator|!
operator|!
operator|(
name|mfw_val
operator|==
name|DCBX_APP_SF_IEEE_ETHTYPE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_app_port
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|)
block|{
return|return
operator|!
operator|!
operator|(
name|ECORE_MFW_GET_FIELD
argument_list|(
name|app_info_bitmap
argument_list|,
name|DCBX_APP_SF
argument_list|)
operator|==
name|DCBX_APP_SF_PORT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_ieee_app_port
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|,
name|u8
name|type
parameter_list|)
block|{
name|u8
name|mfw_val
init|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|app_info_bitmap
argument_list|,
name|DCBX_APP_SF_IEEE
argument_list|)
decl_stmt|;
comment|/* Old MFW */
if|if
condition|(
name|mfw_val
operator|==
name|DCBX_APP_SF_IEEE_RESERVED
condition|)
return|return
name|ecore_dcbx_app_port
argument_list|(
name|app_info_bitmap
argument_list|)
return|;
return|return
operator|!
operator|!
operator|(
name|mfw_val
operator|==
name|type
operator|||
name|mfw_val
operator|==
name|DCBX_APP_SF_IEEE_TCP_UDP_PORT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_default_tlv
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|,
name|u16
name|proto_id
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|bool
name|ethtype
decl_stmt|;
if|if
condition|(
name|ieee
condition|)
name|ethtype
operator|=
name|ecore_dcbx_ieee_app_ethtype
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
else|else
name|ethtype
operator|=
name|ecore_dcbx_app_ethtype
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
return|return
operator|!
operator|!
operator|(
name|ethtype
operator|&&
operator|(
name|proto_id
operator|==
name|ECORE_ETH_TYPE_DEFAULT
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_iscsi_tlv
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|,
name|u16
name|proto_id
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|bool
name|port
decl_stmt|;
if|if
condition|(
name|ieee
condition|)
name|port
operator|=
name|ecore_dcbx_ieee_app_port
argument_list|(
name|app_info_bitmap
argument_list|,
name|DCBX_APP_SF_IEEE_TCP_PORT
argument_list|)
expr_stmt|;
else|else
name|port
operator|=
name|ecore_dcbx_app_port
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
return|return
operator|!
operator|!
operator|(
name|port
operator|&&
operator|(
name|proto_id
operator|==
name|ECORE_TCP_PORT_ISCSI
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_fcoe_tlv
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|,
name|u16
name|proto_id
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|bool
name|ethtype
decl_stmt|;
if|if
condition|(
name|ieee
condition|)
name|ethtype
operator|=
name|ecore_dcbx_ieee_app_ethtype
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
else|else
name|ethtype
operator|=
name|ecore_dcbx_app_ethtype
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
return|return
operator|!
operator|!
operator|(
name|ethtype
operator|&&
operator|(
name|proto_id
operator|==
name|ECORE_ETH_TYPE_FCOE
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_roce_tlv
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|,
name|u16
name|proto_id
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|bool
name|ethtype
decl_stmt|;
if|if
condition|(
name|ieee
condition|)
name|ethtype
operator|=
name|ecore_dcbx_ieee_app_ethtype
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
else|else
name|ethtype
operator|=
name|ecore_dcbx_app_ethtype
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
return|return
operator|!
operator|!
operator|(
name|ethtype
operator|&&
operator|(
name|proto_id
operator|==
name|ECORE_ETH_TYPE_ROCE
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_roce_v2_tlv
parameter_list|(
name|u32
name|app_info_bitmap
parameter_list|,
name|u16
name|proto_id
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|bool
name|port
decl_stmt|;
if|if
condition|(
name|ieee
condition|)
name|port
operator|=
name|ecore_dcbx_ieee_app_port
argument_list|(
name|app_info_bitmap
argument_list|,
name|DCBX_APP_SF_IEEE_UDP_PORT
argument_list|)
expr_stmt|;
else|else
name|port
operator|=
name|ecore_dcbx_app_port
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
return|return
operator|!
operator|!
operator|(
name|port
operator|&&
operator|(
name|proto_id
operator|==
name|ECORE_UDP_PORT_TYPE_ROCE_V2
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_iwarp_tlv
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u32
name|app_info_bitmap
parameter_list|,
name|u16
name|proto_id
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|bool
name|port
decl_stmt|;
if|if
condition|(
operator|!
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|iwarp_port
condition|)
return|return
name|false
return|;
if|if
condition|(
name|ieee
condition|)
name|port
operator|=
name|ecore_dcbx_ieee_app_port
argument_list|(
name|app_info_bitmap
argument_list|,
name|DCBX_APP_SF_IEEE_TCP_PORT
argument_list|)
expr_stmt|;
else|else
name|port
operator|=
name|ecore_dcbx_app_port
argument_list|(
name|app_info_bitmap
argument_list|)
expr_stmt|;
return|return
operator|!
operator|!
operator|(
name|port
operator|&&
operator|(
name|proto_id
operator|==
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|iwarp_port
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_dp_protocol
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_dcbx_results
modifier|*
name|p_data
parameter_list|)
block|{
name|enum
name|dcbx_protocol_type
name|id
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"DCBX negotiated: %d\n"
argument_list|,
name|p_data
operator|->
name|dcbx_enabled
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OSAL_ARRAY_SIZE
argument_list|(
name|ecore_dcbx_app_update
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|id
operator|=
name|ecore_dcbx_app_update
index|[
name|i
index|]
operator|.
name|id
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"%s info: update %d, enable %d, prio %d, tc %d, num_active_tc %d dscp_enable = %d dscp_val = %d\n"
argument_list|,
name|ecore_dcbx_app_update
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|p_data
operator|->
name|arr
index|[
name|id
index|]
operator|.
name|update
argument_list|,
name|p_data
operator|->
name|arr
index|[
name|id
index|]
operator|.
name|enable
argument_list|,
name|p_data
operator|->
name|arr
index|[
name|id
index|]
operator|.
name|priority
argument_list|,
name|p_data
operator|->
name|arr
index|[
name|id
index|]
operator|.
name|tc
argument_list|,
name|p_hwfn
operator|->
name|hw_info
operator|.
name|num_active_tc
argument_list|,
name|p_data
operator|->
name|arr
index|[
name|id
index|]
operator|.
name|dscp_enable
argument_list|,
name|p_data
operator|->
name|arr
index|[
name|id
index|]
operator|.
name|dscp_val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_set_params
parameter_list|(
name|struct
name|ecore_dcbx_results
modifier|*
name|p_data
parameter_list|,
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|bool
name|enable
parameter_list|,
name|u8
name|prio
parameter_list|,
name|u8
name|tc
parameter_list|,
name|enum
name|dcbx_protocol_type
name|type
parameter_list|,
name|enum
name|ecore_pci_personality
name|personality
parameter_list|)
block|{
name|struct
name|ecore_dcbx_dscp_params
modifier|*
name|dscp
init|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|get
operator|.
name|dscp
decl_stmt|;
comment|/* PF update ramrod data */
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|enable
operator|=
name|enable
expr_stmt|;
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|priority
operator|=
name|prio
expr_stmt|;
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|tc
operator|=
name|tc
expr_stmt|;
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|dscp_enable
operator|=
name|dscp
operator|->
name|enabled
expr_stmt|;
if|if
condition|(
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|dscp_enable
condition|)
block|{
name|u8
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_DCBX_DSCP_SIZE
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|prio
operator|==
name|dscp
operator|->
name|dscp_pri_map
index|[
name|i
index|]
condition|)
block|{
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|dscp_val
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|enable
operator|&&
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|dscp_enable
condition|)
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|update
operator|=
name|UPDATE_DCB_DSCP
expr_stmt|;
elseif|else
if|if
condition|(
name|enable
condition|)
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|update
operator|=
name|UPDATE_DCB
expr_stmt|;
else|else
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|update
operator|=
name|DONT_UPDATE_DCB_DSCP
expr_stmt|;
comment|/* QM reconf data */
if|if
condition|(
name|p_hwfn
operator|->
name|hw_info
operator|.
name|personality
operator|==
name|personality
condition|)
name|p_hwfn
operator|->
name|hw_info
operator|.
name|offload_tc
operator|=
name|tc
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Update app protocol data and hw_info fields with the TLV info */
end_comment

begin_function
specifier|static
name|void
name|ecore_dcbx_update_app_info
parameter_list|(
name|struct
name|ecore_dcbx_results
modifier|*
name|p_data
parameter_list|,
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|bool
name|enable
parameter_list|,
name|u8
name|prio
parameter_list|,
name|u8
name|tc
parameter_list|,
name|enum
name|dcbx_protocol_type
name|type
parameter_list|)
block|{
name|enum
name|ecore_pci_personality
name|personality
decl_stmt|;
name|enum
name|dcbx_protocol_type
name|id
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|OSAL_ARRAY_SIZE
argument_list|(
name|ecore_dcbx_app_update
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|id
operator|=
name|ecore_dcbx_app_update
index|[
name|i
index|]
operator|.
name|id
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|id
condition|)
continue|continue;
name|personality
operator|=
name|ecore_dcbx_app_update
index|[
name|i
index|]
operator|.
name|personality
expr_stmt|;
name|name
operator|=
name|ecore_dcbx_app_update
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
name|ecore_dcbx_set_params
argument_list|(
name|p_data
argument_list|,
name|p_hwfn
argument_list|,
name|enable
argument_list|,
name|prio
argument_list|,
name|tc
argument_list|,
name|type
argument_list|,
name|personality
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_get_app_priority
parameter_list|(
name|u8
name|pri_bitmap
parameter_list|,
name|u8
modifier|*
name|priority
parameter_list|)
block|{
name|u32
name|pri_mask
decl_stmt|,
name|pri
init|=
name|ECORE_MAX_PFC_PRIORITIES
decl_stmt|;
name|u32
name|index
init|=
name|ECORE_MAX_PFC_PRIORITIES
operator|-
literal|1
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
comment|/* Bitmap 1 corresponds to priority 0, return priority 0 */
if|if
condition|(
name|pri_bitmap
operator|==
literal|1
condition|)
block|{
operator|*
name|priority
operator|=
literal|0
expr_stmt|;
return|return
name|rc
return|;
block|}
comment|/* Choose the highest priority */
while|while
condition|(
operator|(
name|ECORE_MAX_PFC_PRIORITIES
operator|==
name|pri
operator|)
operator|&&
name|index
condition|)
block|{
name|pri_mask
operator|=
literal|1
operator|<<
name|index
expr_stmt|;
if|if
condition|(
name|pri_bitmap
operator|&
name|pri_mask
condition|)
name|pri
operator|=
name|index
expr_stmt|;
name|index
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|pri
operator|<
name|ECORE_MAX_PFC_PRIORITIES
condition|)
operator|*
name|priority
operator|=
operator|(
name|u8
operator|)
name|pri
expr_stmt|;
else|else
name|rc
operator|=
name|ECORE_INVAL
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|ecore_dcbx_get_app_protocol_type
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u32
name|app_prio_bitmap
parameter_list|,
name|u16
name|id
parameter_list|,
name|enum
name|dcbx_protocol_type
modifier|*
name|type
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
if|if
condition|(
name|ecore_dcbx_fcoe_tlv
argument_list|(
name|app_prio_bitmap
argument_list|,
name|id
argument_list|,
name|ieee
argument_list|)
condition|)
block|{
operator|*
name|type
operator|=
name|DCBX_PROTOCOL_FCOE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ecore_dcbx_roce_tlv
argument_list|(
name|app_prio_bitmap
argument_list|,
name|id
argument_list|,
name|ieee
argument_list|)
condition|)
block|{
operator|*
name|type
operator|=
name|DCBX_PROTOCOL_ROCE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ecore_dcbx_iscsi_tlv
argument_list|(
name|app_prio_bitmap
argument_list|,
name|id
argument_list|,
name|ieee
argument_list|)
condition|)
block|{
operator|*
name|type
operator|=
name|DCBX_PROTOCOL_ISCSI
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ecore_dcbx_default_tlv
argument_list|(
name|app_prio_bitmap
argument_list|,
name|id
argument_list|,
name|ieee
argument_list|)
condition|)
block|{
operator|*
name|type
operator|=
name|DCBX_PROTOCOL_ETH
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ecore_dcbx_roce_v2_tlv
argument_list|(
name|app_prio_bitmap
argument_list|,
name|id
argument_list|,
name|ieee
argument_list|)
condition|)
block|{
operator|*
name|type
operator|=
name|DCBX_PROTOCOL_ROCE_V2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ecore_dcbx_iwarp_tlv
argument_list|(
name|p_hwfn
argument_list|,
name|app_prio_bitmap
argument_list|,
name|id
argument_list|,
name|ieee
argument_list|)
condition|)
block|{
operator|*
name|type
operator|=
name|DCBX_PROTOCOL_IWARP
expr_stmt|;
block|}
else|else
block|{
operator|*
name|type
operator|=
name|DCBX_MAX_PROTOCOL_TYPE
expr_stmt|;
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"No action required, App TLV id = 0x%x app_prio_bitmap = 0x%x\n"
argument_list|,
name|id
argument_list|,
name|app_prio_bitmap
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/*  Parse app TLV's to update TC information in hw_info structure for  * reconfiguring QM. Get protocol specific data for PF update ramrod command.  */
end_comment

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_process_tlv
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_dcbx_results
modifier|*
name|p_data
parameter_list|,
name|struct
name|dcbx_app_priority_entry
modifier|*
name|p_tbl
parameter_list|,
name|u32
name|pri_tc_tbl
parameter_list|,
name|int
name|count
parameter_list|,
name|u8
name|dcbx_version
parameter_list|)
block|{
name|enum
name|dcbx_protocol_type
name|type
decl_stmt|;
name|u8
name|tc
decl_stmt|,
name|priority_map
decl_stmt|;
name|bool
name|enable
decl_stmt|,
name|ieee
decl_stmt|;
name|u16
name|protocol_id
decl_stmt|;
name|u8
name|priority
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"Num APP entries = %d pri_tc_tbl = 0x%x dcbx_version = %u\n"
argument_list|,
name|count
argument_list|,
name|pri_tc_tbl
argument_list|,
name|dcbx_version
argument_list|)
expr_stmt|;
name|ieee
operator|=
operator|(
name|dcbx_version
operator|==
name|DCBX_CONFIG_VERSION_IEEE
operator|)
expr_stmt|;
comment|/* Parse APP TLV */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|protocol_id
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|DCBX_APP_PROTOCOL_ID
argument_list|)
expr_stmt|;
name|priority_map
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|DCBX_APP_PRI_MAP
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"Id = 0x%x pri_map = %u\n"
argument_list|,
name|protocol_id
argument_list|,
name|priority_map
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_get_app_priority
argument_list|(
name|priority_map
argument_list|,
operator|&
name|priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|ECORE_INVAL
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Invalid priority\n"
argument_list|)
expr_stmt|;
return|return
name|ECORE_INVAL
return|;
block|}
name|tc
operator|=
name|ECORE_DCBX_PRIO2TC
argument_list|(
name|pri_tc_tbl
argument_list|,
name|priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecore_dcbx_get_app_protocol_type
argument_list|(
name|p_hwfn
argument_list|,
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|protocol_id
argument_list|,
operator|&
name|type
argument_list|,
name|ieee
argument_list|)
condition|)
block|{
comment|/* ETH always have the enable bit reset, as it gets 			 * vlan information per packet. For other protocols, 			 * should be set according to the dcbx_enabled 			 * indication, but we only got here if there was an 			 * app tlv for the protocol, so dcbx must be enabled. 			 */
name|enable
operator|=
operator|!
operator|(
name|type
operator|==
name|DCBX_PROTOCOL_ETH
operator|)
expr_stmt|;
name|ecore_dcbx_update_app_info
argument_list|(
name|p_data
argument_list|,
name|p_hwfn
argument_list|,
name|enable
argument_list|,
name|priority
argument_list|,
name|tc
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Update ramrod protocol data and hw_info fields 	 * with default info when corresponding APP TLV's are not detected. 	 * The enabled field has a different logic for ethernet as only for 	 * ethernet dcb should disabled by default, as the information arrives 	 * from the OS (unless an explicit app tlv was present). 	 */
name|tc
operator|=
name|p_data
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ETH
index|]
operator|.
name|tc
expr_stmt|;
name|priority
operator|=
name|p_data
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ETH
index|]
operator|.
name|priority
expr_stmt|;
for|for
control|(
name|type
operator|=
literal|0
init|;
name|type
operator|<
name|DCBX_MAX_PROTOCOL_TYPE
condition|;
name|type
operator|++
control|)
block|{
if|if
condition|(
name|p_data
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|update
condition|)
continue|continue;
name|enable
operator|=
operator|(
name|type
operator|==
name|DCBX_PROTOCOL_ETH
operator|)
condition|?
name|false
else|:
operator|!
operator|!
name|dcbx_version
expr_stmt|;
name|ecore_dcbx_update_app_info
argument_list|(
name|p_data
argument_list|,
name|p_hwfn
argument_list|,
name|enable
argument_list|,
name|priority
argument_list|,
name|tc
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Parse app TLV's to update TC information in hw_info structure for  * reconfiguring QM. Get protocol specific data for PF update ramrod command.  */
end_comment

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_process_mib_info
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|)
block|{
name|struct
name|dcbx_app_priority_feature
modifier|*
name|p_app
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|struct
name|ecore_dcbx_results
name|data
init|=
block|{
literal|0
block|}
decl_stmt|;
name|struct
name|dcbx_app_priority_entry
modifier|*
name|p_tbl
decl_stmt|;
name|struct
name|dcbx_ets_feature
modifier|*
name|p_ets
decl_stmt|;
name|struct
name|ecore_hw_info
modifier|*
name|p_info
decl_stmt|;
name|u32
name|pri_tc_tbl
decl_stmt|,
name|flags
decl_stmt|;
name|u8
name|dcbx_version
decl_stmt|;
name|int
name|num_entries
decl_stmt|;
name|flags
operator|=
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|operational
operator|.
name|flags
expr_stmt|;
name|dcbx_version
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|flags
argument_list|,
name|DCBX_CONFIG_VERSION
argument_list|)
expr_stmt|;
name|p_app
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|operational
operator|.
name|features
operator|.
name|app
expr_stmt|;
name|p_tbl
operator|=
name|p_app
operator|->
name|app_pri_tbl
expr_stmt|;
name|p_ets
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|operational
operator|.
name|features
operator|.
name|ets
expr_stmt|;
name|pri_tc_tbl
operator|=
name|p_ets
operator|->
name|pri_tc_tbl
index|[
literal|0
index|]
expr_stmt|;
name|p_info
operator|=
operator|&
name|p_hwfn
operator|->
name|hw_info
expr_stmt|;
name|num_entries
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_app
operator|->
name|flags
argument_list|,
name|DCBX_APP_NUM_ENTRIES
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_process_tlv
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|data
argument_list|,
name|p_tbl
argument_list|,
name|pri_tc_tbl
argument_list|,
name|num_entries
argument_list|,
name|dcbx_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_info
operator|->
name|num_active_tc
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_ets
operator|->
name|flags
argument_list|,
name|DCBX_ETS_MAX_TCS
argument_list|)
expr_stmt|;
name|p_hwfn
operator|->
name|qm_info
operator|.
name|ooo_tc
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_ets
operator|->
name|flags
argument_list|,
name|DCBX_OOO_TC
argument_list|)
expr_stmt|;
name|data
operator|.
name|pf_id
operator|=
name|p_hwfn
operator|->
name|rel_pf_id
expr_stmt|;
name|data
operator|.
name|dcbx_enabled
operator|=
operator|!
operator|!
name|dcbx_version
expr_stmt|;
name|ecore_dcbx_dp_protocol
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|results
argument_list|,
operator|&
name|data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_dcbx_results
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_copy_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_mib_meta_data
modifier|*
name|p_data
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|u32
name|prefix_seq_num
decl_stmt|,
name|suffix_seq_num
decl_stmt|;
name|int
name|read_count
init|=
literal|0
decl_stmt|;
comment|/* The data is considered to be valid only if both sequence numbers are 	 * the same. 	 */
do|do
block|{
if|if
condition|(
name|type
operator|==
name|ECORE_DCBX_REMOTE_LLDP_MIB
condition|)
block|{
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_data
operator|->
name|lldp_remote
argument_list|,
name|p_data
operator|->
name|addr
argument_list|,
name|p_data
operator|->
name|size
argument_list|)
expr_stmt|;
name|prefix_seq_num
operator|=
name|p_data
operator|->
name|lldp_remote
operator|->
name|prefix_seq_num
expr_stmt|;
name|suffix_seq_num
operator|=
name|p_data
operator|->
name|lldp_remote
operator|->
name|suffix_seq_num
expr_stmt|;
block|}
else|else
block|{
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_data
operator|->
name|mib
argument_list|,
name|p_data
operator|->
name|addr
argument_list|,
name|p_data
operator|->
name|size
argument_list|)
expr_stmt|;
name|prefix_seq_num
operator|=
name|p_data
operator|->
name|mib
operator|->
name|prefix_seq_num
expr_stmt|;
name|suffix_seq_num
operator|=
name|p_data
operator|->
name|mib
operator|->
name|suffix_seq_num
expr_stmt|;
block|}
name|read_count
operator|++
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"mib type = %d, try count = %d prefix seq num  = %d suffix seq num = %d\n"
argument_list|,
name|type
argument_list|,
name|read_count
argument_list|,
name|prefix_seq_num
argument_list|,
name|suffix_seq_num
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|prefix_seq_num
operator|!=
name|suffix_seq_num
operator|)
operator|&&
operator|(
name|read_count
operator|<
name|ECORE_DCBX_MAX_MIB_READ_TRY
operator|)
condition|)
do|;
if|if
condition|(
name|read_count
operator|>=
name|ECORE_DCBX_MAX_MIB_READ_TRY
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"MIB read err, mib type = %d, try count = %d prefix seq num = %d suffix seq num = %d\n"
argument_list|,
name|type
argument_list|,
name|read_count
argument_list|,
name|prefix_seq_num
argument_list|,
name|suffix_seq_num
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ECORE_IO
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_priority_info
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_dcbx_app_prio
modifier|*
name|p_prio
parameter_list|,
name|struct
name|ecore_dcbx_results
modifier|*
name|p_results
parameter_list|)
block|{
name|u8
name|val
decl_stmt|;
name|p_prio
operator|->
name|roce
operator|=
name|ECORE_DCBX_INVALID_PRIORITY
expr_stmt|;
name|p_prio
operator|->
name|roce_v2
operator|=
name|ECORE_DCBX_INVALID_PRIORITY
expr_stmt|;
name|p_prio
operator|->
name|iscsi
operator|=
name|ECORE_DCBX_INVALID_PRIORITY
expr_stmt|;
name|p_prio
operator|->
name|fcoe
operator|=
name|ECORE_DCBX_INVALID_PRIORITY
expr_stmt|;
if|if
condition|(
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE
index|]
operator|.
name|update
operator|&&
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE
index|]
operator|.
name|enable
condition|)
name|p_prio
operator|->
name|roce
operator|=
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE
index|]
operator|.
name|priority
expr_stmt|;
if|if
condition|(
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE_V2
index|]
operator|.
name|update
operator|&&
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE_V2
index|]
operator|.
name|enable
condition|)
block|{
name|val
operator|=
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE_V2
index|]
operator|.
name|priority
expr_stmt|;
name|p_prio
operator|->
name|roce_v2
operator|=
name|val
expr_stmt|;
block|}
if|if
condition|(
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ISCSI
index|]
operator|.
name|update
operator|&&
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ISCSI
index|]
operator|.
name|enable
condition|)
name|p_prio
operator|->
name|iscsi
operator|=
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ISCSI
index|]
operator|.
name|priority
expr_stmt|;
if|if
condition|(
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_FCOE
index|]
operator|.
name|update
operator|&&
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_FCOE
index|]
operator|.
name|enable
condition|)
name|p_prio
operator|->
name|fcoe
operator|=
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_FCOE
index|]
operator|.
name|priority
expr_stmt|;
if|if
condition|(
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ETH
index|]
operator|.
name|update
operator|&&
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ETH
index|]
operator|.
name|enable
condition|)
name|p_prio
operator|->
name|eth
operator|=
name|p_results
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ETH
index|]
operator|.
name|priority
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"Priorities: iscsi %d, roce %d, roce v2 %d, fcoe %d, eth %d\n"
argument_list|,
name|p_prio
operator|->
name|iscsi
argument_list|,
name|p_prio
operator|->
name|roce
argument_list|,
name|p_prio
operator|->
name|roce_v2
argument_list|,
name|p_prio
operator|->
name|fcoe
argument_list|,
name|p_prio
operator|->
name|eth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_app_data
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|dcbx_app_priority_feature
modifier|*
name|p_app
parameter_list|,
name|struct
name|dcbx_app_priority_entry
modifier|*
name|p_tbl
parameter_list|,
name|struct
name|ecore_dcbx_params
modifier|*
name|p_params
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|struct
name|ecore_app_entry
modifier|*
name|entry
decl_stmt|;
name|u8
name|pri_map
decl_stmt|;
name|int
name|i
decl_stmt|;
name|p_params
operator|->
name|app_willing
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_app
operator|->
name|flags
argument_list|,
name|DCBX_APP_WILLING
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|app_valid
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_app
operator|->
name|flags
argument_list|,
name|DCBX_APP_ENABLED
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|app_error
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_app
operator|->
name|flags
argument_list|,
name|DCBX_APP_ERROR
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|num_app_entries
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_app
operator|->
name|flags
argument_list|,
name|DCBX_APP_NUM_ENTRIES
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DCBX_MAX_APP_PROTOCOL
condition|;
name|i
operator|++
control|)
block|{
name|entry
operator|=
operator|&
name|p_params
operator|->
name|app_entry
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ieee
condition|)
block|{
name|u8
name|sf_ieee
decl_stmt|;
name|u32
name|val
decl_stmt|;
name|sf_ieee
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|DCBX_APP_SF_IEEE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sf_ieee
condition|)
block|{
case|case
name|DCBX_APP_SF_IEEE_RESERVED
case|:
comment|/* Old MFW */
name|val
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|DCBX_APP_SF
argument_list|)
expr_stmt|;
name|entry
operator|->
name|sf_ieee
operator|=
name|val
condition|?
name|ECORE_DCBX_SF_IEEE_TCP_UDP_PORT
else|:
name|ECORE_DCBX_SF_IEEE_ETHTYPE
expr_stmt|;
break|break;
case|case
name|DCBX_APP_SF_IEEE_ETHTYPE
case|:
name|entry
operator|->
name|sf_ieee
operator|=
name|ECORE_DCBX_SF_IEEE_ETHTYPE
expr_stmt|;
break|break;
case|case
name|DCBX_APP_SF_IEEE_TCP_PORT
case|:
name|entry
operator|->
name|sf_ieee
operator|=
name|ECORE_DCBX_SF_IEEE_TCP_PORT
expr_stmt|;
break|break;
case|case
name|DCBX_APP_SF_IEEE_UDP_PORT
case|:
name|entry
operator|->
name|sf_ieee
operator|=
name|ECORE_DCBX_SF_IEEE_UDP_PORT
expr_stmt|;
break|break;
case|case
name|DCBX_APP_SF_IEEE_TCP_UDP_PORT
case|:
name|entry
operator|->
name|sf_ieee
operator|=
name|ECORE_DCBX_SF_IEEE_TCP_UDP_PORT
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|entry
operator|->
name|ethtype
operator|=
operator|!
operator|(
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|DCBX_APP_SF
argument_list|)
operator|)
expr_stmt|;
block|}
name|pri_map
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|DCBX_APP_PRI_MAP
argument_list|)
expr_stmt|;
name|ecore_dcbx_get_app_priority
argument_list|(
name|pri_map
argument_list|,
operator|&
name|entry
operator|->
name|prio
argument_list|)
expr_stmt|;
name|entry
operator|->
name|proto_id
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|DCBX_APP_PROTOCOL_ID
argument_list|)
expr_stmt|;
name|ecore_dcbx_get_app_protocol_type
argument_list|(
name|p_hwfn
argument_list|,
name|p_tbl
index|[
name|i
index|]
operator|.
name|entry
argument_list|,
name|entry
operator|->
name|proto_id
argument_list|,
operator|&
name|entry
operator|->
name|proto_type
argument_list|,
name|ieee
argument_list|)
expr_stmt|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"APP params: willing %d, valid %d error = %d\n"
argument_list|,
name|p_params
operator|->
name|app_willing
argument_list|,
name|p_params
operator|->
name|app_valid
argument_list|,
name|p_params
operator|->
name|app_error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_pfc_data
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u32
name|pfc
parameter_list|,
name|struct
name|ecore_dcbx_params
modifier|*
name|p_params
parameter_list|)
block|{
name|u8
name|pfc_map
decl_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|willing
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|pfc
argument_list|,
name|DCBX_PFC_WILLING
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|max_tc
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|pfc
argument_list|,
name|DCBX_PFC_CAPS
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|enabled
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|pfc
argument_list|,
name|DCBX_PFC_ENABLED
argument_list|)
expr_stmt|;
name|pfc_map
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|pfc
argument_list|,
name|DCBX_PFC_PRI_EN_BITMAP
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|0
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_0
operator|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|1
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_1
operator|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|2
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_2
operator|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|3
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_3
operator|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|4
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_4
operator|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|5
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_5
operator|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|6
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_6
operator|)
expr_stmt|;
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
literal|7
index|]
operator|=
operator|!
operator|!
operator|(
name|pfc_map
operator|&
name|DCBX_PFC_PRI_EN_BITMAP_PRI_7
operator|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"PFC params: willing %d, pfc_bitmap %u max_tc = %u enabled = %d\n"
argument_list|,
name|p_params
operator|->
name|pfc
operator|.
name|willing
argument_list|,
name|pfc_map
argument_list|,
name|p_params
operator|->
name|pfc
operator|.
name|max_tc
argument_list|,
name|p_params
operator|->
name|pfc
operator|.
name|enabled
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_ets_data
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|dcbx_ets_feature
modifier|*
name|p_ets
parameter_list|,
name|struct
name|ecore_dcbx_params
modifier|*
name|p_params
parameter_list|)
block|{
name|u32
name|bw_map
index|[
literal|2
index|]
decl_stmt|,
name|tsa_map
index|[
literal|2
index|]
decl_stmt|,
name|pri_map
decl_stmt|;
name|int
name|i
decl_stmt|;
name|p_params
operator|->
name|ets_willing
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_ets
operator|->
name|flags
argument_list|,
name|DCBX_ETS_WILLING
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|ets_enabled
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_ets
operator|->
name|flags
argument_list|,
name|DCBX_ETS_ENABLED
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|ets_cbs
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_ets
operator|->
name|flags
argument_list|,
name|DCBX_ETS_CBS
argument_list|)
expr_stmt|;
name|p_params
operator|->
name|max_ets_tc
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_ets
operator|->
name|flags
argument_list|,
name|DCBX_ETS_MAX_TCS
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"ETS params: willing %d, enabled = %d ets_cbs %d pri_tc_tbl_0 %x max_ets_tc %d\n"
argument_list|,
name|p_params
operator|->
name|ets_willing
argument_list|,
name|p_params
operator|->
name|ets_enabled
argument_list|,
name|p_params
operator|->
name|ets_cbs
argument_list|,
name|p_ets
operator|->
name|pri_tc_tbl
index|[
literal|0
index|]
argument_list|,
name|p_params
operator|->
name|max_ets_tc
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|ets_enabled
operator|&&
operator|!
name|p_params
operator|->
name|max_ets_tc
condition|)
block|{
name|p_params
operator|->
name|max_ets_tc
operator|=
name|ECORE_MAX_PFC_PRIORITIES
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"ETS params: max_ets_tc is forced to %d\n"
argument_list|,
name|p_params
operator|->
name|max_ets_tc
argument_list|)
expr_stmt|;
block|}
comment|/* 8 bit tsa and bw data corresponding to each of the 8 TC's are 	 * encoded in a type u32 array of size 2. 	 */
name|bw_map
index|[
literal|0
index|]
operator|=
name|OSAL_BE32_TO_CPU
argument_list|(
name|p_ets
operator|->
name|tc_bw_tbl
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bw_map
index|[
literal|1
index|]
operator|=
name|OSAL_BE32_TO_CPU
argument_list|(
name|p_ets
operator|->
name|tc_bw_tbl
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|tsa_map
index|[
literal|0
index|]
operator|=
name|OSAL_BE32_TO_CPU
argument_list|(
name|p_ets
operator|->
name|tc_tsa_tbl
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tsa_map
index|[
literal|1
index|]
operator|=
name|OSAL_BE32_TO_CPU
argument_list|(
name|p_ets
operator|->
name|tc_tsa_tbl
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|pri_map
operator|=
name|p_ets
operator|->
name|pri_tc_tbl
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_MAX_PFC_PRIORITIES
condition|;
name|i
operator|++
control|)
block|{
name|p_params
operator|->
name|ets_tc_bw_tbl
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|u8
operator|*
operator|)
name|bw_map
operator|)
index|[
name|i
index|]
expr_stmt|;
name|p_params
operator|->
name|ets_tc_tsa_tbl
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|u8
operator|*
operator|)
name|tsa_map
operator|)
index|[
name|i
index|]
expr_stmt|;
name|p_params
operator|->
name|ets_pri_tc_tbl
index|[
name|i
index|]
operator|=
name|ECORE_DCBX_PRIO2TC
argument_list|(
name|pri_map
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"elem %d  bw_tbl %x tsa_tbl %x\n"
argument_list|,
name|i
argument_list|,
name|p_params
operator|->
name|ets_tc_bw_tbl
index|[
name|i
index|]
argument_list|,
name|p_params
operator|->
name|ets_tc_tsa_tbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_common_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|dcbx_app_priority_feature
modifier|*
name|p_app
parameter_list|,
name|struct
name|dcbx_app_priority_entry
modifier|*
name|p_tbl
parameter_list|,
name|struct
name|dcbx_ets_feature
modifier|*
name|p_ets
parameter_list|,
name|u32
name|pfc
parameter_list|,
name|struct
name|ecore_dcbx_params
modifier|*
name|p_params
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|ecore_dcbx_get_app_data
argument_list|(
name|p_hwfn
argument_list|,
name|p_app
argument_list|,
name|p_tbl
argument_list|,
name|p_params
argument_list|,
name|ieee
argument_list|)
expr_stmt|;
name|ecore_dcbx_get_ets_data
argument_list|(
name|p_hwfn
argument_list|,
name|p_ets
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
name|ecore_dcbx_get_pfc_data
argument_list|(
name|p_hwfn
argument_list|,
name|pfc
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_local_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|dcbx_features
modifier|*
name|p_feat
decl_stmt|;
name|p_feat
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|local_admin
operator|.
name|features
expr_stmt|;
name|ecore_dcbx_get_common_params
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_feat
operator|->
name|app
argument_list|,
name|p_feat
operator|->
name|app
operator|.
name|app_pri_tbl
argument_list|,
operator|&
name|p_feat
operator|->
name|ets
argument_list|,
name|p_feat
operator|->
name|pfc
argument_list|,
operator|&
name|params
operator|->
name|local
operator|.
name|params
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|params
operator|->
name|local
operator|.
name|valid
operator|=
name|true
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_remote_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|dcbx_features
modifier|*
name|p_feat
decl_stmt|;
name|p_feat
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|remote
operator|.
name|features
expr_stmt|;
name|ecore_dcbx_get_common_params
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_feat
operator|->
name|app
argument_list|,
name|p_feat
operator|->
name|app
operator|.
name|app_pri_tbl
argument_list|,
operator|&
name|p_feat
operator|->
name|ets
argument_list|,
name|p_feat
operator|->
name|pfc
argument_list|,
operator|&
name|params
operator|->
name|remote
operator|.
name|params
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|params
operator|->
name|remote
operator|.
name|valid
operator|=
name|true
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_get_operational_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ecore_dcbx_operational_params
modifier|*
name|p_operational
decl_stmt|;
name|struct
name|ecore_dcbx_results
modifier|*
name|p_results
decl_stmt|;
name|struct
name|dcbx_features
modifier|*
name|p_feat
decl_stmt|;
name|bool
name|enabled
decl_stmt|,
name|err
decl_stmt|;
name|u32
name|flags
decl_stmt|;
name|bool
name|val
decl_stmt|;
name|flags
operator|=
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|operational
operator|.
name|flags
expr_stmt|;
comment|/* If DCBx version is non zero, then negotiation 	 * was successfuly performed 	 */
name|p_operational
operator|=
operator|&
name|params
operator|->
name|operational
expr_stmt|;
name|enabled
operator|=
operator|!
operator|!
operator|(
name|ECORE_MFW_GET_FIELD
argument_list|(
name|flags
argument_list|,
name|DCBX_CONFIG_VERSION
argument_list|)
operator|!=
name|DCBX_CONFIG_VERSION_DISABLED
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|enabled
condition|)
block|{
name|p_operational
operator|->
name|enabled
operator|=
name|enabled
expr_stmt|;
name|p_operational
operator|->
name|valid
operator|=
name|false
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"Dcbx is disabled\n"
argument_list|)
expr_stmt|;
return|return
name|ECORE_INVAL
return|;
block|}
name|p_feat
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|operational
operator|.
name|features
expr_stmt|;
name|p_results
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|results
expr_stmt|;
name|val
operator|=
operator|!
operator|!
operator|(
name|ECORE_MFW_GET_FIELD
argument_list|(
name|flags
argument_list|,
name|DCBX_CONFIG_VERSION
argument_list|)
operator|==
name|DCBX_CONFIG_VERSION_IEEE
operator|)
expr_stmt|;
name|p_operational
operator|->
name|ieee
operator|=
name|val
expr_stmt|;
name|val
operator|=
operator|!
operator|!
operator|(
name|ECORE_MFW_GET_FIELD
argument_list|(
name|flags
argument_list|,
name|DCBX_CONFIG_VERSION
argument_list|)
operator|==
name|DCBX_CONFIG_VERSION_CEE
operator|)
expr_stmt|;
name|p_operational
operator|->
name|cee
operator|=
name|val
expr_stmt|;
name|val
operator|=
operator|!
operator|!
operator|(
name|ECORE_MFW_GET_FIELD
argument_list|(
name|flags
argument_list|,
name|DCBX_CONFIG_VERSION
argument_list|)
operator|==
name|DCBX_CONFIG_VERSION_STATIC
operator|)
expr_stmt|;
name|p_operational
operator|->
name|local
operator|=
name|val
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"Version support: ieee %d, cee %d, static %d\n"
argument_list|,
name|p_operational
operator|->
name|ieee
argument_list|,
name|p_operational
operator|->
name|cee
argument_list|,
name|p_operational
operator|->
name|local
argument_list|)
expr_stmt|;
name|ecore_dcbx_get_common_params
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_feat
operator|->
name|app
argument_list|,
name|p_feat
operator|->
name|app
operator|.
name|app_pri_tbl
argument_list|,
operator|&
name|p_feat
operator|->
name|ets
argument_list|,
name|p_feat
operator|->
name|pfc
argument_list|,
operator|&
name|params
operator|->
name|operational
operator|.
name|params
argument_list|,
name|p_operational
operator|->
name|ieee
argument_list|)
expr_stmt|;
name|ecore_dcbx_get_priority_info
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_operational
operator|->
name|app_prio
argument_list|,
name|p_results
argument_list|)
expr_stmt|;
name|err
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_feat
operator|->
name|app
operator|.
name|flags
argument_list|,
name|DCBX_APP_ERROR
argument_list|)
expr_stmt|;
name|p_operational
operator|->
name|err
operator|=
name|err
expr_stmt|;
name|p_operational
operator|->
name|enabled
operator|=
name|enabled
expr_stmt|;
name|p_operational
operator|->
name|valid
operator|=
name|true
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_dscp_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ecore_dcbx_dscp_params
modifier|*
name|p_dscp
decl_stmt|;
name|struct
name|dcb_dscp_map
modifier|*
name|p_dscp_map
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|entry
decl_stmt|;
name|u32
name|pri_map
decl_stmt|;
name|p_dscp
operator|=
operator|&
name|params
operator|->
name|dscp
expr_stmt|;
name|p_dscp_map
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|dscp_map
expr_stmt|;
name|p_dscp
operator|->
name|enabled
operator|=
name|ECORE_MFW_GET_FIELD
argument_list|(
name|p_dscp_map
operator|->
name|flags
argument_list|,
name|DCB_DSCP_ENABLE
argument_list|)
expr_stmt|;
comment|/* MFW encodes 64 dscp entries into 8 element array of u32 entries, 	 * where each entry holds the 4bit priority map for 8 dscp entries. 	 */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|entry
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_DCBX_DSCP_SIZE
operator|/
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|pri_map
operator|=
name|OSAL_BE32_TO_CPU
argument_list|(
name|p_dscp_map
operator|->
name|dscp_pri_map
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"elem %d pri_map 0x%x\n"
argument_list|,
name|entry
argument_list|,
name|pri_map
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ECORE_DCBX_DSCP_SIZE
operator|/
literal|8
condition|;
name|j
operator|++
operator|,
name|entry
operator|++
control|)
name|p_dscp
operator|->
name|dscp_pri_map
index|[
name|entry
index|]
operator|=
call|(
name|u32
call|)
argument_list|(
name|pri_map
operator|>>
operator|(
name|j
operator|*
literal|4
operator|)
argument_list|)
operator|&
literal|0xf
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_local_lldp_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|lldp_config_params_s
modifier|*
name|p_local
decl_stmt|;
name|p_local
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|lldp_local
index|[
name|LLDP_NEAREST_BRIDGE
index|]
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
name|params
operator|->
name|lldp_local
operator|.
name|local_chassis_id
argument_list|,
name|p_local
operator|->
name|local_chassis_id
argument_list|,
name|OSAL_ARRAY_SIZE
argument_list|(
name|p_local
operator|->
name|local_chassis_id
argument_list|)
argument_list|)
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
name|params
operator|->
name|lldp_local
operator|.
name|local_port_id
argument_list|,
name|p_local
operator|->
name|local_port_id
argument_list|,
name|OSAL_ARRAY_SIZE
argument_list|(
name|p_local
operator|->
name|local_port_id
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_get_remote_lldp_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|lldp_status_params_s
modifier|*
name|p_remote
decl_stmt|;
name|p_remote
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|lldp_remote
index|[
name|LLDP_NEAREST_BRIDGE
index|]
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
name|params
operator|->
name|lldp_remote
operator|.
name|peer_chassis_id
argument_list|,
name|p_remote
operator|->
name|peer_chassis_id
argument_list|,
name|OSAL_ARRAY_SIZE
argument_list|(
name|p_remote
operator|->
name|peer_chassis_id
argument_list|)
argument_list|)
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
name|params
operator|->
name|lldp_remote
operator|.
name|peer_port_id
argument_list|,
name|p_remote
operator|->
name|peer_port_id
argument_list|,
name|OSAL_ARRAY_SIZE
argument_list|(
name|p_remote
operator|->
name|peer_port_id
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_get_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|p_params
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ECORE_DCBX_REMOTE_MIB
case|:
name|ecore_dcbx_get_remote_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_LOCAL_MIB
case|:
name|ecore_dcbx_get_local_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_OPERATIONAL_MIB
case|:
name|ecore_dcbx_get_operational_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_REMOTE_LLDP_MIB
case|:
name|ecore_dcbx_get_remote_lldp_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_LOCAL_LLDP_MIB
case|:
name|ecore_dcbx_get_local_lldp_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"MIB read err, unknown mib type %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|ECORE_INVAL
return|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_read_local_lldp_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|)
block|{
name|struct
name|ecore_dcbx_mib_meta_data
name|data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|OSAL_MEM_ZERO
argument_list|(
operator|&
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|lldp_config_params
argument_list|)
expr_stmt|;
name|data
operator|.
name|lldp_local
operator|=
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|lldp_local
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|lldp_config_params_s
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|data
operator|.
name|lldp_local
argument_list|,
name|data
operator|.
name|addr
argument_list|,
name|data
operator|.
name|size
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_read_remote_lldp_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|struct
name|ecore_dcbx_mib_meta_data
name|data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|OSAL_MEM_ZERO
argument_list|(
operator|&
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|lldp_status_params
argument_list|)
expr_stmt|;
name|data
operator|.
name|lldp_remote
operator|=
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|lldp_remote
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|lldp_status_params_s
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_copy_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|data
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_read_operational_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|struct
name|ecore_dcbx_mib_meta_data
name|data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|OSAL_MEM_ZERO
argument_list|(
operator|&
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|operational_dcbx_mib
argument_list|)
expr_stmt|;
name|data
operator|.
name|mib
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|operational
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|dcbx_mib
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_copy_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|data
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_read_remote_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|struct
name|ecore_dcbx_mib_meta_data
name|data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|OSAL_MEM_ZERO
argument_list|(
operator|&
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|remote_dcbx_mib
argument_list|)
expr_stmt|;
name|data
operator|.
name|mib
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|remote
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|dcbx_mib
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_copy_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|data
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_read_local_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|)
block|{
name|struct
name|ecore_dcbx_mib_meta_data
name|data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|OSAL_MEM_ZERO
argument_list|(
operator|&
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|local_admin_dcbx_mib
argument_list|)
expr_stmt|;
name|data
operator|.
name|local_admin
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|local_admin
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|dcbx_local_params
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|data
operator|.
name|local_admin
argument_list|,
name|data
operator|.
name|addr
argument_list|,
name|data
operator|.
name|size
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_read_dscp_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|)
block|{
name|struct
name|ecore_dcbx_mib_meta_data
name|data
decl_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|dcb_dscp_map
argument_list|)
expr_stmt|;
name|data
operator|.
name|dscp_map
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|dscp_map
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|dcb_dscp_map
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|data
operator|.
name|dscp_map
argument_list|,
name|data
operator|.
name|addr
argument_list|,
name|data
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_read_mib
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_INVAL
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ECORE_DCBX_OPERATIONAL_MIB
case|:
name|ecore_dcbx_read_dscp_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_read_operational_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_REMOTE_MIB
case|:
name|rc
operator|=
name|ecore_dcbx_read_remote_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_LOCAL_MIB
case|:
name|rc
operator|=
name|ecore_dcbx_read_local_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_REMOTE_LLDP_MIB
case|:
name|rc
operator|=
name|ecore_dcbx_read_remote_lldp_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_LOCAL_LLDP_MIB
case|:
name|rc
operator|=
name|ecore_dcbx_read_local_lldp_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"MIB read err, unknown mib type %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/*  * Read updated MIB.  * Reconfigure QM and invoke PF update ramrod command if operational MIB  * change is detected.  */
end_comment

begin_function
name|enum
name|_ecore_status_t
name|ecore_dcbx_mib_update_event
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|rc
operator|=
name|ecore_dcbx_read_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
if|if
condition|(
name|type
operator|==
name|ECORE_DCBX_OPERATIONAL_MIB
condition|)
block|{
name|ecore_dcbx_get_dscp_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|get
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_process_mib_info
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rc
condition|)
block|{
name|bool
name|enabled
decl_stmt|;
comment|/* reconfigure tcs of QM queues according 			 * to negotiation results 			 */
name|ecore_qm_reconf
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
comment|/* update storm FW with negotiation results */
name|ecore_sp_pf_update
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
comment|/* set eagle enigne 1 flow control workaround 			 * according to negotiation results 			 */
name|enabled
operator|=
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|results
operator|.
name|dcbx_enabled
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_ECORE_ROCE
comment|/* for roce PFs, we may want to enable/disable DPM 			 * when DCBx change occurs 			 */
if|if
condition|(
name|ECORE_IS_ROCE_PERSONALITY
argument_list|(
name|p_hwfn
argument_list|)
condition|)
name|ecore_roce_dpm_dcbx
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
name|ecore_dcbx_get_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|get
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|ECORE_DCBX_OPERATIONAL_MIB
condition|)
block|{
name|struct
name|ecore_dcbx_results
modifier|*
name|p_data
decl_stmt|;
name|u16
name|val
decl_stmt|;
comment|/* Update the DSCP to TC mapping bit if required */
if|if
condition|(
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|dscp_nig_update
condition|)
block|{
name|ecore_wr
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|NIG_REG_DSCP_TO_TC_MAP_ENABLE
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|dscp_nig_update
operator|=
name|false
expr_stmt|;
block|}
comment|/* Configure in NIG which protocols support EDPM and should 		 * honor PFC. 		 */
name|p_data
operator|=
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|results
expr_stmt|;
name|val
operator|=
operator|(
literal|0x1
operator|<<
name|p_data
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE
index|]
operator|.
name|tc
operator|)
operator||
operator|(
literal|0x1
operator|<<
name|p_data
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE_V2
index|]
operator|.
name|tc
operator|)
expr_stmt|;
name|val
operator|<<=
name|NIG_REG_TX_EDPM_CTRL_TX_EDPM_TC_EN_SHIFT
expr_stmt|;
name|val
operator||=
name|NIG_REG_TX_EDPM_CTRL_TX_EDPM_EN
expr_stmt|;
name|ecore_wr
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|NIG_REG_TX_EDPM_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|OSAL_DCBX_AEN
argument_list|(
name|p_hwfn
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_dcbx_info_alloc
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|)
block|{
name|OSAL_BUILD_BUG_ON
argument_list|(
name|ECORE_LLDP_CHASSIS_ID_STAT_LEN
operator|!=
name|LLDP_CHASSIS_ID_STAT_LEN
argument_list|)
expr_stmt|;
name|OSAL_BUILD_BUG_ON
argument_list|(
name|ECORE_LLDP_PORT_ID_STAT_LEN
operator|!=
name|LLDP_PORT_ID_STAT_LEN
argument_list|)
expr_stmt|;
name|OSAL_BUILD_BUG_ON
argument_list|(
name|ECORE_DCBX_MAX_APP_PROTOCOL
operator|!=
name|DCBX_MAX_APP_PROTOCOL
argument_list|)
expr_stmt|;
name|p_hwfn
operator|->
name|p_dcbx_info
operator|=
name|OSAL_ZALLOC
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|GFP_KERNEL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_hwfn
operator|->
name|p_dcbx_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_hwfn
operator|->
name|p_dcbx_info
condition|)
block|{
name|DP_NOTICE
argument_list|(
name|p_hwfn
argument_list|,
name|true
argument_list|,
literal|"Failed to allocate `struct ecore_dcbx_info'"
argument_list|)
expr_stmt|;
return|return
name|ECORE_NOMEM
return|;
block|}
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|iwarp_port
operator|=
name|p_hwfn
operator|->
name|pf_params
operator|.
name|rdma_pf_params
operator|.
name|iwarp_port
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
name|void
name|ecore_dcbx_info_free
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|)
block|{
name|OSAL_FREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|p_hwfn
operator|->
name|p_dcbx_info
argument_list|)
expr_stmt|;
name|p_hwfn
operator|->
name|p_dcbx_info
operator|=
name|OSAL_NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_update_protocol_data
parameter_list|(
name|struct
name|protocol_dcb_data
modifier|*
name|p_data
parameter_list|,
name|struct
name|ecore_dcbx_results
modifier|*
name|p_src
parameter_list|,
name|enum
name|dcbx_protocol_type
name|type
parameter_list|)
block|{
name|p_data
operator|->
name|dcb_enable_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|enable
expr_stmt|;
name|p_data
operator|->
name|dcb_priority
operator|=
name|p_src
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|priority
expr_stmt|;
name|p_data
operator|->
name|dcb_tc
operator|=
name|p_src
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|tc
expr_stmt|;
name|p_data
operator|->
name|dscp_enable_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|dscp_enable
expr_stmt|;
name|p_data
operator|->
name|dscp_val
operator|=
name|p_src
operator|->
name|arr
index|[
name|type
index|]
operator|.
name|dscp_val
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Set pf update ramrod command params */
end_comment

begin_function
name|void
name|ecore_dcbx_set_pf_update_params
parameter_list|(
name|struct
name|ecore_dcbx_results
modifier|*
name|p_src
parameter_list|,
name|struct
name|pf_update_ramrod_data
modifier|*
name|p_dest
parameter_list|)
block|{
name|struct
name|protocol_dcb_data
modifier|*
name|p_dcb_data
decl_stmt|;
name|u8
name|update_flag
decl_stmt|;
name|p_dest
operator|->
name|pf_id
operator|=
name|p_src
operator|->
name|pf_id
expr_stmt|;
name|update_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_FCOE
index|]
operator|.
name|update
expr_stmt|;
name|p_dest
operator|->
name|update_fcoe_dcb_data_mode
operator|=
name|update_flag
expr_stmt|;
name|update_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE
index|]
operator|.
name|update
expr_stmt|;
name|p_dest
operator|->
name|update_roce_dcb_data_mode
operator|=
name|update_flag
expr_stmt|;
name|update_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ROCE_V2
index|]
operator|.
name|update
expr_stmt|;
name|p_dest
operator|->
name|update_rroce_dcb_data_mode
operator|=
name|update_flag
expr_stmt|;
name|update_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ISCSI
index|]
operator|.
name|update
expr_stmt|;
name|p_dest
operator|->
name|update_iscsi_dcb_data_mode
operator|=
name|update_flag
expr_stmt|;
name|update_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_ETH
index|]
operator|.
name|update
expr_stmt|;
name|p_dest
operator|->
name|update_eth_dcb_data_mode
operator|=
name|update_flag
expr_stmt|;
name|update_flag
operator|=
name|p_src
operator|->
name|arr
index|[
name|DCBX_PROTOCOL_IWARP
index|]
operator|.
name|update
expr_stmt|;
name|p_dest
operator|->
name|update_iwarp_dcb_data_mode
operator|=
name|update_flag
expr_stmt|;
name|p_dcb_data
operator|=
operator|&
name|p_dest
operator|->
name|fcoe_dcb_data
expr_stmt|;
name|ecore_dcbx_update_protocol_data
argument_list|(
name|p_dcb_data
argument_list|,
name|p_src
argument_list|,
name|DCBX_PROTOCOL_FCOE
argument_list|)
expr_stmt|;
name|p_dcb_data
operator|=
operator|&
name|p_dest
operator|->
name|roce_dcb_data
expr_stmt|;
name|ecore_dcbx_update_protocol_data
argument_list|(
name|p_dcb_data
argument_list|,
name|p_src
argument_list|,
name|DCBX_PROTOCOL_ROCE
argument_list|)
expr_stmt|;
name|p_dcb_data
operator|=
operator|&
name|p_dest
operator|->
name|rroce_dcb_data
expr_stmt|;
name|ecore_dcbx_update_protocol_data
argument_list|(
name|p_dcb_data
argument_list|,
name|p_src
argument_list|,
name|DCBX_PROTOCOL_ROCE_V2
argument_list|)
expr_stmt|;
name|p_dcb_data
operator|=
operator|&
name|p_dest
operator|->
name|iscsi_dcb_data
expr_stmt|;
name|ecore_dcbx_update_protocol_data
argument_list|(
name|p_dcb_data
argument_list|,
name|p_src
argument_list|,
name|DCBX_PROTOCOL_ISCSI
argument_list|)
expr_stmt|;
name|p_dcb_data
operator|=
operator|&
name|p_dest
operator|->
name|eth_dcb_data
expr_stmt|;
name|ecore_dcbx_update_protocol_data
argument_list|(
name|p_dcb_data
argument_list|,
name|p_src
argument_list|,
name|DCBX_PROTOCOL_ETH
argument_list|)
expr_stmt|;
name|p_dcb_data
operator|=
operator|&
name|p_dest
operator|->
name|iwarp_dcb_data
expr_stmt|;
name|ecore_dcbx_update_protocol_data
argument_list|(
name|p_dcb_data
argument_list|,
name|p_src
argument_list|,
name|DCBX_PROTOCOL_IWARP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_dcbx_query_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_dcbx_get
modifier|*
name|p_get
parameter_list|,
name|enum
name|ecore_mib_read_type
name|type
parameter_list|)
block|{
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
if|if
condition|(
name|IS_VF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
return|return
name|ECORE_INVAL
return|;
name|p_ptt
operator|=
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_ptt
condition|)
block|{
name|rc
operator|=
name|ECORE_TIMEOUT
expr_stmt|;
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"rc = %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|rc
operator|=
name|ecore_dcbx_read_mib
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
goto|goto
name|out
goto|;
name|rc
operator|=
name|ecore_dcbx_get_params
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_get
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|out
label|:
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_set_pfc_data
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u32
modifier|*
name|pfc
parameter_list|,
name|struct
name|ecore_dcbx_params
modifier|*
name|p_params
parameter_list|)
block|{
name|u8
name|pfc_map
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|pfc
operator|&=
operator|~
name|DCBX_PFC_ERROR_MASK
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|pfc
operator|.
name|willing
condition|)
operator|*
name|pfc
operator||=
name|DCBX_PFC_WILLING_MASK
expr_stmt|;
else|else
operator|*
name|pfc
operator|&=
operator|~
name|DCBX_PFC_WILLING_MASK
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|pfc
operator|.
name|enabled
condition|)
operator|*
name|pfc
operator||=
name|DCBX_PFC_ENABLED_MASK
expr_stmt|;
else|else
operator|*
name|pfc
operator|&=
operator|~
name|DCBX_PFC_ENABLED_MASK
expr_stmt|;
operator|*
name|pfc
operator|&=
operator|~
name|DCBX_PFC_CAPS_MASK
expr_stmt|;
operator|*
name|pfc
operator||=
operator|(
name|u32
operator|)
name|p_params
operator|->
name|pfc
operator|.
name|max_tc
operator|<<
name|DCBX_PFC_CAPS_SHIFT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_MAX_PFC_PRIORITIES
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_params
operator|->
name|pfc
operator|.
name|prio
index|[
name|i
index|]
condition|)
name|pfc_map
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
operator|*
name|pfc
operator|&=
operator|~
name|DCBX_PFC_PRI_EN_BITMAP_MASK
expr_stmt|;
operator|*
name|pfc
operator||=
operator|(
name|pfc_map
operator|<<
name|DCBX_PFC_PRI_EN_BITMAP_SHIFT
operator|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"pfc = 0x%x\n"
argument_list|,
operator|*
name|pfc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_set_ets_data
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|dcbx_ets_feature
modifier|*
name|p_ets
parameter_list|,
name|struct
name|ecore_dcbx_params
modifier|*
name|p_params
parameter_list|)
block|{
name|u8
modifier|*
name|bw_map
decl_stmt|,
modifier|*
name|tsa_map
decl_stmt|;
name|u32
name|val
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p_params
operator|->
name|ets_willing
condition|)
name|p_ets
operator|->
name|flags
operator||=
name|DCBX_ETS_WILLING_MASK
expr_stmt|;
else|else
name|p_ets
operator|->
name|flags
operator|&=
operator|~
name|DCBX_ETS_WILLING_MASK
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|ets_cbs
condition|)
name|p_ets
operator|->
name|flags
operator||=
name|DCBX_ETS_CBS_MASK
expr_stmt|;
else|else
name|p_ets
operator|->
name|flags
operator|&=
operator|~
name|DCBX_ETS_CBS_MASK
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|ets_enabled
condition|)
name|p_ets
operator|->
name|flags
operator||=
name|DCBX_ETS_ENABLED_MASK
expr_stmt|;
else|else
name|p_ets
operator|->
name|flags
operator|&=
operator|~
name|DCBX_ETS_ENABLED_MASK
expr_stmt|;
name|p_ets
operator|->
name|flags
operator|&=
operator|~
name|DCBX_ETS_MAX_TCS_MASK
expr_stmt|;
name|p_ets
operator|->
name|flags
operator||=
operator|(
name|u32
operator|)
name|p_params
operator|->
name|max_ets_tc
operator|<<
name|DCBX_ETS_MAX_TCS_SHIFT
expr_stmt|;
name|bw_map
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|p_ets
operator|->
name|tc_bw_tbl
index|[
literal|0
index|]
expr_stmt|;
name|tsa_map
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|p_ets
operator|->
name|tc_tsa_tbl
index|[
literal|0
index|]
expr_stmt|;
name|p_ets
operator|->
name|pri_tc_tbl
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_MAX_PFC_PRIORITIES
condition|;
name|i
operator|++
control|)
block|{
name|bw_map
index|[
name|i
index|]
operator|=
name|p_params
operator|->
name|ets_tc_bw_tbl
index|[
name|i
index|]
expr_stmt|;
name|tsa_map
index|[
name|i
index|]
operator|=
name|p_params
operator|->
name|ets_tc_tsa_tbl
index|[
name|i
index|]
expr_stmt|;
comment|/* Copy the priority value to the corresponding 4 bits in the 		 * traffic class table. 		 */
name|val
operator|=
operator|(
operator|(
operator|(
name|u32
operator|)
name|p_params
operator|->
name|ets_pri_tc_tbl
index|[
name|i
index|]
operator|)
operator|<<
operator|(
operator|(
literal|7
operator|-
name|i
operator|)
operator|*
literal|4
operator|)
operator|)
expr_stmt|;
name|p_ets
operator|->
name|pri_tc_tbl
index|[
literal|0
index|]
operator||=
name|val
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|p_ets
operator|->
name|tc_bw_tbl
index|[
name|i
index|]
operator|=
name|OSAL_CPU_TO_BE32
argument_list|(
name|p_ets
operator|->
name|tc_bw_tbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|p_ets
operator|->
name|tc_tsa_tbl
index|[
name|i
index|]
operator|=
name|OSAL_CPU_TO_BE32
argument_list|(
name|p_ets
operator|->
name|tc_tsa_tbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"flags = 0x%x pri_tc = 0x%x tc_bwl[] = {0x%x, 0x%x} tc_tsa = {0x%x, 0x%x}\n"
argument_list|,
name|p_ets
operator|->
name|flags
argument_list|,
name|p_ets
operator|->
name|pri_tc_tbl
index|[
literal|0
index|]
argument_list|,
name|p_ets
operator|->
name|tc_bw_tbl
index|[
literal|0
index|]
argument_list|,
name|p_ets
operator|->
name|tc_bw_tbl
index|[
literal|1
index|]
argument_list|,
name|p_ets
operator|->
name|tc_tsa_tbl
index|[
literal|0
index|]
argument_list|,
name|p_ets
operator|->
name|tc_tsa_tbl
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_dcbx_set_app_data
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|dcbx_app_priority_feature
modifier|*
name|p_app
parameter_list|,
name|struct
name|ecore_dcbx_params
modifier|*
name|p_params
parameter_list|,
name|bool
name|ieee
parameter_list|)
block|{
name|u32
modifier|*
name|entry
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p_params
operator|->
name|app_willing
condition|)
name|p_app
operator|->
name|flags
operator||=
name|DCBX_APP_WILLING_MASK
expr_stmt|;
else|else
name|p_app
operator|->
name|flags
operator|&=
operator|~
name|DCBX_APP_WILLING_MASK
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|app_valid
condition|)
name|p_app
operator|->
name|flags
operator||=
name|DCBX_APP_ENABLED_MASK
expr_stmt|;
else|else
name|p_app
operator|->
name|flags
operator|&=
operator|~
name|DCBX_APP_ENABLED_MASK
expr_stmt|;
name|p_app
operator|->
name|flags
operator|&=
operator|~
name|DCBX_APP_NUM_ENTRIES_MASK
expr_stmt|;
name|p_app
operator|->
name|flags
operator||=
operator|(
name|u32
operator|)
name|p_params
operator|->
name|num_app_entries
operator|<<
name|DCBX_APP_NUM_ENTRIES_SHIFT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DCBX_MAX_APP_PROTOCOL
condition|;
name|i
operator|++
control|)
block|{
name|entry
operator|=
operator|&
name|p_app
operator|->
name|app_pri_tbl
index|[
name|i
index|]
operator|.
name|entry
expr_stmt|;
operator|*
name|entry
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ieee
condition|)
block|{
operator|*
name|entry
operator|&=
operator|~
operator|(
name|DCBX_APP_SF_IEEE_MASK
operator||
name|DCBX_APP_SF_MASK
operator|)
expr_stmt|;
switch|switch
condition|(
name|p_params
operator|->
name|app_entry
index|[
name|i
index|]
operator|.
name|sf_ieee
condition|)
block|{
case|case
name|ECORE_DCBX_SF_IEEE_ETHTYPE
case|:
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_IEEE_ETHTYPE
operator|<<
name|DCBX_APP_SF_IEEE_SHIFT
operator|)
expr_stmt|;
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_ETHTYPE
operator|<<
name|DCBX_APP_SF_SHIFT
operator|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_SF_IEEE_TCP_PORT
case|:
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_IEEE_TCP_PORT
operator|<<
name|DCBX_APP_SF_IEEE_SHIFT
operator|)
expr_stmt|;
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_PORT
operator|<<
name|DCBX_APP_SF_SHIFT
operator|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_SF_IEEE_UDP_PORT
case|:
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_IEEE_UDP_PORT
operator|<<
name|DCBX_APP_SF_IEEE_SHIFT
operator|)
expr_stmt|;
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_PORT
operator|<<
name|DCBX_APP_SF_SHIFT
operator|)
expr_stmt|;
break|break;
case|case
name|ECORE_DCBX_SF_IEEE_TCP_UDP_PORT
case|:
operator|*
name|entry
operator||=
operator|(
name|u32
operator|)
name|DCBX_APP_SF_IEEE_TCP_UDP_PORT
operator|<<
name|DCBX_APP_SF_IEEE_SHIFT
expr_stmt|;
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_PORT
operator|<<
name|DCBX_APP_SF_SHIFT
operator|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
operator|*
name|entry
operator|&=
operator|~
name|DCBX_APP_SF_MASK
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|app_entry
index|[
name|i
index|]
operator|.
name|ethtype
condition|)
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_ETHTYPE
operator|<<
name|DCBX_APP_SF_SHIFT
operator|)
expr_stmt|;
else|else
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|DCBX_APP_SF_PORT
operator|<<
name|DCBX_APP_SF_SHIFT
operator|)
expr_stmt|;
block|}
operator|*
name|entry
operator|&=
operator|~
name|DCBX_APP_PROTOCOL_ID_MASK
expr_stmt|;
operator|*
name|entry
operator||=
operator|(
operator|(
name|u32
operator|)
name|p_params
operator|->
name|app_entry
index|[
name|i
index|]
operator|.
name|proto_id
operator|<<
name|DCBX_APP_PROTOCOL_ID_SHIFT
operator|)
expr_stmt|;
operator|*
name|entry
operator|&=
operator|~
name|DCBX_APP_PRI_MAP_MASK
expr_stmt|;
operator|*
name|entry
operator||=
operator|(
call|(
name|u32
call|)
argument_list|(
name|p_params
operator|->
name|app_entry
index|[
name|i
index|]
operator|.
name|prio
argument_list|)
operator|<<
name|DCBX_APP_PRI_MAP_SHIFT
operator|)
expr_stmt|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"flags = 0x%x\n"
argument_list|,
name|p_app
operator|->
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_set_local_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|dcbx_local_params
modifier|*
name|local_admin
parameter_list|,
name|struct
name|ecore_dcbx_set
modifier|*
name|params
parameter_list|)
block|{
name|bool
name|ieee
init|=
name|false
decl_stmt|;
name|local_admin
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
operator|&
name|local_admin
operator|->
name|features
argument_list|,
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|operational
operator|.
name|features
argument_list|,
sizeof|sizeof
argument_list|(
name|local_admin
operator|->
name|features
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|enabled
condition|)
block|{
name|local_admin
operator|->
name|config
operator|=
name|params
operator|->
name|ver_num
expr_stmt|;
name|ieee
operator|=
operator|!
operator|!
operator|(
name|params
operator|->
name|ver_num
operator|&
name|DCBX_CONFIG_VERSION_IEEE
operator|)
expr_stmt|;
block|}
else|else
name|local_admin
operator|->
name|config
operator|=
name|DCBX_CONFIG_VERSION_DISABLED
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|override_flags
operator|&
name|ECORE_DCBX_OVERRIDE_PFC_CFG
condition|)
name|ecore_dcbx_set_pfc_data
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|local_admin
operator|->
name|features
operator|.
name|pfc
argument_list|,
operator|&
name|params
operator|->
name|config
operator|.
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|override_flags
operator|&
name|ECORE_DCBX_OVERRIDE_ETS_CFG
condition|)
name|ecore_dcbx_set_ets_data
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|local_admin
operator|->
name|features
operator|.
name|ets
argument_list|,
operator|&
name|params
operator|->
name|config
operator|.
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|override_flags
operator|&
name|ECORE_DCBX_OVERRIDE_APP_CFG
condition|)
name|ecore_dcbx_set_app_data
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|local_admin
operator|->
name|features
operator|.
name|app
argument_list|,
operator|&
name|params
operator|->
name|config
operator|.
name|params
argument_list|,
name|ieee
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_dcbx_set_dscp_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|dcb_dscp_map
modifier|*
name|p_dscp_map
parameter_list|,
name|struct
name|ecore_dcbx_set
modifier|*
name|p_params
parameter_list|)
block|{
name|int
name|entry
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u32
name|val
decl_stmt|;
name|OSAL_MEMCPY
argument_list|(
name|p_dscp_map
argument_list|,
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|dscp_map
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_dscp_map
argument_list|)
argument_list|)
expr_stmt|;
name|p_dscp_map
operator|->
name|flags
operator|&=
operator|~
name|DCB_DSCP_ENABLE_MASK
expr_stmt|;
if|if
condition|(
name|p_params
operator|->
name|dscp
operator|.
name|enabled
condition|)
name|p_dscp_map
operator|->
name|flags
operator||=
name|DCB_DSCP_ENABLE_MASK
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|entry
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
operator|,
name|entry
operator|++
control|)
name|val
operator||=
operator|(
operator|(
operator|(
name|u32
operator|)
name|p_params
operator|->
name|dscp
operator|.
name|dscp_pri_map
index|[
name|entry
index|]
operator|)
operator|<<
operator|(
name|j
operator|*
literal|4
operator|)
operator|)
expr_stmt|;
name|p_dscp_map
operator|->
name|dscp_pri_map
index|[
name|i
index|]
operator|=
name|OSAL_CPU_TO_BE32
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|dscp_nig_update
operator|=
name|true
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_DCB
argument_list|,
literal|"flags = 0x%x\n"
argument_list|,
name|p_dscp_map
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_dcbx_config_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_dcbx_set
modifier|*
name|params
parameter_list|,
name|bool
name|hw_commit
parameter_list|)
block|{
name|struct
name|dcbx_local_params
name|local_admin
decl_stmt|;
name|struct
name|ecore_dcbx_mib_meta_data
name|data
decl_stmt|;
name|struct
name|dcb_dscp_map
name|dscp_map
decl_stmt|;
name|u32
name|resp
init|=
literal|0
decl_stmt|,
name|param
init|=
literal|0
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
if|if
condition|(
operator|!
name|hw_commit
condition|)
block|{
name|OSAL_MEMCPY
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
argument_list|,
name|params
argument_list|,
sizeof|sizeof
argument_list|(
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
comment|/* clear set-parmas cache */
name|OSAL_MEMSET
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_dcbx_set
argument_list|)
argument_list|)
expr_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|local_admin
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local_admin
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_dcbx_set_local_params
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|local_admin
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|local_admin_dcbx_mib
argument_list|)
expr_stmt|;
name|data
operator|.
name|local_admin
operator|=
operator|&
name|local_admin
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|dcbx_local_params
argument_list|)
expr_stmt|;
name|ecore_memcpy_to
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|data
operator|.
name|addr
argument_list|,
name|data
operator|.
name|local_admin
argument_list|,
name|data
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|override_flags
operator|&
name|ECORE_DCBX_OVERRIDE_DSCP_CFG
condition|)
block|{
name|OSAL_MEMSET
argument_list|(
operator|&
name|dscp_map
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dscp_map
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_dcbx_set_dscp_params
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|dscp_map
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|data
operator|.
name|addr
operator|=
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|offsetof
argument_list|(
expr|struct
name|public_port
argument_list|,
name|dcb_dscp_map
argument_list|)
expr_stmt|;
name|data
operator|.
name|dscp_map
operator|=
operator|&
name|dscp_map
expr_stmt|;
name|data
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|dcb_dscp_map
argument_list|)
expr_stmt|;
name|ecore_memcpy_to
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|data
operator|.
name|addr
argument_list|,
name|data
operator|.
name|dscp_map
argument_list|,
name|data
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|ecore_mcp_cmd
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|DRV_MSG_CODE_SET_DCBX
argument_list|,
literal|1
operator|<<
name|DRV_MB_PARAM_LLDP_SEND_SHIFT
argument_list|,
operator|&
name|resp
argument_list|,
operator|&
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
name|DP_NOTICE
argument_list|(
name|p_hwfn
argument_list|,
name|false
argument_list|,
literal|"Failed to send DCBX update request\n"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_dcbx_get_config_params
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_dcbx_set
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ecore_dcbx_get
modifier|*
name|dcbx_info
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|config
operator|.
name|valid
condition|)
block|{
name|OSAL_MEMCPY
argument_list|(
name|params
argument_list|,
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_dcbx_set
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
name|dcbx_info
operator|=
name|OSAL_ALLOC
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|GFP_KERNEL
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dcbx_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dcbx_info
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Failed to allocate struct ecore_dcbx_info\n"
argument_list|)
expr_stmt|;
return|return
name|ECORE_NOMEM
return|;
block|}
name|OSAL_MEMSET
argument_list|(
name|dcbx_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dcbx_info
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_dcbx_query_params
argument_list|(
name|p_hwfn
argument_list|,
name|dcbx_info
argument_list|,
name|ECORE_DCBX_OPERATIONAL_MIB
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|OSAL_FREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|dcbx_info
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|override_flags
operator|=
literal|0
expr_stmt|;
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|ver_num
operator|=
name|DCBX_CONFIG_VERSION_DISABLED
expr_stmt|;
if|if
condition|(
name|dcbx_info
operator|->
name|operational
operator|.
name|cee
condition|)
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|ver_num
operator||=
name|DCBX_CONFIG_VERSION_CEE
expr_stmt|;
if|if
condition|(
name|dcbx_info
operator|->
name|operational
operator|.
name|ieee
condition|)
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|ver_num
operator||=
name|DCBX_CONFIG_VERSION_IEEE
expr_stmt|;
if|if
condition|(
name|dcbx_info
operator|->
name|operational
operator|.
name|local
condition|)
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|ver_num
operator||=
name|DCBX_CONFIG_VERSION_STATIC
expr_stmt|;
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|enabled
operator|=
name|dcbx_info
operator|->
name|operational
operator|.
name|enabled
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|config
operator|.
name|params
argument_list|,
operator|&
name|dcbx_info
operator|->
name|operational
operator|.
name|params
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_dcbx_admin_params
argument_list|)
argument_list|)
expr_stmt|;
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
operator|.
name|config
operator|.
name|valid
operator|=
name|true
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
name|params
argument_list|,
operator|&
name|p_hwfn
operator|->
name|p_dcbx_info
operator|->
name|set
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_dcbx_set
argument_list|)
argument_list|)
expr_stmt|;
name|OSAL_FREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|dcbx_info
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2017-2018 Cavium, Inc.   * All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * File : ecore_l2.c  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"bcm_osal.h"
end_include

begin_include
include|#
directive|include
file|"ecore.h"
end_include

begin_include
include|#
directive|include
file|"ecore_status.h"
end_include

begin_include
include|#
directive|include
file|"ecore_hsi_eth.h"
end_include

begin_include
include|#
directive|include
file|"ecore_chain.h"
end_include

begin_include
include|#
directive|include
file|"ecore_spq.h"
end_include

begin_include
include|#
directive|include
file|"ecore_init_fw_funcs.h"
end_include

begin_include
include|#
directive|include
file|"ecore_cxt.h"
end_include

begin_include
include|#
directive|include
file|"ecore_l2.h"
end_include

begin_include
include|#
directive|include
file|"ecore_sp_commands.h"
end_include

begin_include
include|#
directive|include
file|"ecore_gtt_reg_addr.h"
end_include

begin_include
include|#
directive|include
file|"ecore_iro.h"
end_include

begin_include
include|#
directive|include
file|"reg_addr.h"
end_include

begin_include
include|#
directive|include
file|"ecore_int.h"
end_include

begin_include
include|#
directive|include
file|"ecore_hw.h"
end_include

begin_include
include|#
directive|include
file|"ecore_vf.h"
end_include

begin_include
include|#
directive|include
file|"ecore_sriov.h"
end_include

begin_include
include|#
directive|include
file|"ecore_mcp.h"
end_include

begin_define
define|#
directive|define
name|ECORE_MAX_SGES_NUM
value|16
end_define

begin_define
define|#
directive|define
name|CRC32_POLY
value|0x1edc6f41
end_define

begin_struct
struct|struct
name|ecore_l2_info
block|{
name|u32
name|queues
decl_stmt|;
name|unsigned
name|long
modifier|*
modifier|*
name|pp_qid_usage
decl_stmt|;
comment|/* The lock is meant to synchronize access to the qid usage */
name|osal_mutex_t
name|lock
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|enum
name|_ecore_status_t
name|ecore_l2_alloc
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|)
block|{
name|struct
name|ecore_l2_info
modifier|*
name|p_l2_info
decl_stmt|;
name|unsigned
name|long
modifier|*
modifier|*
name|pp_qids
decl_stmt|;
name|u32
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|ECORE_IS_L2_PERSONALITY
argument_list|(
name|p_hwfn
argument_list|)
condition|)
return|return
name|ECORE_SUCCESS
return|;
name|p_l2_info
operator|=
name|OSAL_VZALLOC
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_l2_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_l2_info
condition|)
return|return
name|ECORE_NOMEM
return|;
name|p_hwfn
operator|->
name|p_l2_info
operator|=
name|p_l2_info
expr_stmt|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
name|p_l2_info
operator|->
name|queues
operator|=
name|RESC_NUM
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_L2_QUEUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u8
name|rx
init|=
literal|0
decl_stmt|,
name|tx
init|=
literal|0
decl_stmt|;
name|ecore_vf_get_num_rxqs
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|rx
argument_list|)
expr_stmt|;
name|ecore_vf_get_num_txqs
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|tx
argument_list|)
expr_stmt|;
name|p_l2_info
operator|->
name|queues
operator|=
operator|(
name|u32
operator|)
name|OSAL_MAX_T
argument_list|(
name|u8
argument_list|,
name|rx
argument_list|,
name|tx
argument_list|)
expr_stmt|;
block|}
name|pp_qids
operator|=
name|OSAL_VZALLOC
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|*
name|p_l2_info
operator|->
name|queues
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp_qids
operator|==
name|OSAL_NULL
condition|)
return|return
name|ECORE_NOMEM
return|;
name|p_l2_info
operator|->
name|pp_qid_usage
operator|=
name|pp_qids
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_l2_info
operator|->
name|queues
condition|;
name|i
operator|++
control|)
block|{
name|pp_qids
index|[
name|i
index|]
operator|=
name|OSAL_VZALLOC
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|MAX_QUEUES_PER_QZONE
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp_qids
index|[
name|i
index|]
operator|==
name|OSAL_NULL
condition|)
return|return
name|ECORE_NOMEM
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_ECORE_LOCK_ALLOC
name|OSAL_MUTEX_ALLOC
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_l2_info
operator|->
name|lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
name|void
name|ecore_l2_setup
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ECORE_IS_L2_PERSONALITY
argument_list|(
name|p_hwfn
argument_list|)
condition|)
return|return;
name|OSAL_MUTEX_INIT
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ecore_l2_free
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|ECORE_IS_L2_PERSONALITY
argument_list|(
name|p_hwfn
argument_list|)
condition|)
return|return;
if|if
condition|(
name|p_hwfn
operator|->
name|p_l2_info
operator|==
name|OSAL_NULL
condition|)
return|return;
if|if
condition|(
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|pp_qid_usage
operator|==
name|OSAL_NULL
condition|)
goto|goto
name|out_l2_info
goto|;
comment|/* Free until hit first uninitialized entry */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|queues
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|pp_qid_usage
index|[
name|i
index|]
operator|==
name|OSAL_NULL
condition|)
break|break;
name|OSAL_VFREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|pp_qid_usage
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_ECORE_LOCK_ALLOC
comment|/* Lock is last to initialize, if everything else was */
if|if
condition|(
name|i
operator|==
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|queues
condition|)
name|OSAL_MUTEX_DEALLOC
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|OSAL_VFREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|pp_qid_usage
argument_list|)
expr_stmt|;
name|out_l2_info
label|:
name|OSAL_VFREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|p_hwfn
operator|->
name|p_l2_info
argument_list|)
expr_stmt|;
name|p_hwfn
operator|->
name|p_l2_info
operator|=
name|OSAL_NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* TODO - we'll need locking around these... */
end_comment

begin_function
specifier|static
name|bool
name|ecore_eth_queue_qid_usage_add
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|)
block|{
name|struct
name|ecore_l2_info
modifier|*
name|p_l2_info
init|=
name|p_hwfn
operator|->
name|p_l2_info
decl_stmt|;
name|u16
name|queue_id
init|=
name|p_cid
operator|->
name|rel
operator|.
name|queue_id
decl_stmt|;
name|bool
name|b_rc
init|=
name|true
decl_stmt|;
name|u8
name|first
decl_stmt|;
name|OSAL_MUTEX_ACQUIRE
argument_list|(
operator|&
name|p_l2_info
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue_id
operator|>
name|p_l2_info
operator|->
name|queues
condition|)
block|{
name|DP_NOTICE
argument_list|(
name|p_hwfn
argument_list|,
name|true
argument_list|,
literal|"Requested to increase usage for qzone %04x out of %08x\n"
argument_list|,
name|queue_id
argument_list|,
name|p_l2_info
operator|->
name|queues
argument_list|)
expr_stmt|;
name|b_rc
operator|=
name|false
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|first
operator|=
operator|(
name|u8
operator|)
name|OSAL_FIND_FIRST_ZERO_BIT
argument_list|(
name|p_l2_info
operator|->
name|pp_qid_usage
index|[
name|queue_id
index|]
argument_list|,
name|MAX_QUEUES_PER_QZONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
operator|>=
name|MAX_QUEUES_PER_QZONE
condition|)
block|{
name|b_rc
operator|=
name|false
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|OSAL_SET_BIT
argument_list|(
name|first
argument_list|,
name|p_l2_info
operator|->
name|pp_qid_usage
index|[
name|queue_id
index|]
argument_list|)
expr_stmt|;
name|p_cid
operator|->
name|qid_usage_idx
operator|=
name|first
expr_stmt|;
name|out
label|:
name|OSAL_MUTEX_RELEASE
argument_list|(
operator|&
name|p_l2_info
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|b_rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_eth_queue_qid_usage_del
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|)
block|{
name|OSAL_MUTEX_ACQUIRE
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|lock
argument_list|)
expr_stmt|;
name|OSAL_CLEAR_BIT
argument_list|(
name|p_cid
operator|->
name|qid_usage_idx
argument_list|,
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|pp_qid_usage
index|[
name|p_cid
operator|->
name|rel
operator|.
name|queue_id
index|]
argument_list|)
expr_stmt|;
name|OSAL_MUTEX_RELEASE
argument_list|(
operator|&
name|p_hwfn
operator|->
name|p_l2_info
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ecore_eth_queue_cid_release
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|)
block|{
name|bool
name|b_legacy_vf
init|=
operator|!
operator|!
operator|(
name|p_cid
operator|->
name|vf_legacy
operator|&
name|ECORE_QCID_LEGACY_VF_CID
operator|)
decl_stmt|;
comment|/* VFs' CIDs are 0-based in PF-view, and uninitialized on VF. 	 * For legacy vf-queues, the CID doesn't go through here. 	 */
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
operator|&&
operator|!
name|b_legacy_vf
condition|)
name|_ecore_cxt_release_cid
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
operator|->
name|cid
argument_list|,
name|p_cid
operator|->
name|vfid
argument_list|)
expr_stmt|;
comment|/* VFs maintain the index inside queue-zone on their own */
if|if
condition|(
name|p_cid
operator|->
name|vfid
operator|==
name|ECORE_QUEUE_CID_PF
condition|)
name|ecore_eth_queue_qid_usage_del
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
name|OSAL_VFREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* The internal is only meant to be directly called by PFs initializeing CIDs  * for their VFs.  */
end_comment

begin_function
specifier|static
name|struct
name|ecore_queue_cid
modifier|*
name|_ecore_eth_queue_to_cid
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|u32
name|cid
parameter_list|,
name|struct
name|ecore_queue_start_common_params
modifier|*
name|p_params
parameter_list|,
name|struct
name|ecore_queue_cid_vf_params
modifier|*
name|p_vf_params
parameter_list|)
block|{
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
name|p_cid
operator|=
name|OSAL_VZALLOC
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_cid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_cid
operator|==
name|OSAL_NULL
condition|)
return|return
name|OSAL_NULL
return|;
name|p_cid
operator|->
name|opaque_fid
operator|=
name|opaque_fid
expr_stmt|;
name|p_cid
operator|->
name|cid
operator|=
name|cid
expr_stmt|;
name|p_cid
operator|->
name|p_owner
operator|=
name|p_hwfn
expr_stmt|;
comment|/* Fill in parameters */
name|p_cid
operator|->
name|rel
operator|.
name|vport_id
operator|=
name|p_params
operator|->
name|vport_id
expr_stmt|;
name|p_cid
operator|->
name|rel
operator|.
name|queue_id
operator|=
name|p_params
operator|->
name|queue_id
expr_stmt|;
name|p_cid
operator|->
name|rel
operator|.
name|stats_id
operator|=
name|p_params
operator|->
name|stats_id
expr_stmt|;
name|p_cid
operator|->
name|sb_igu_id
operator|=
name|p_params
operator|->
name|p_sb
operator|->
name|igu_sb_id
expr_stmt|;
name|p_cid
operator|->
name|sb_idx
operator|=
name|p_params
operator|->
name|sb_idx
expr_stmt|;
comment|/* Fill-in bits related to VFs' queues if information was provided */
if|if
condition|(
name|p_vf_params
operator|!=
name|OSAL_NULL
condition|)
block|{
name|p_cid
operator|->
name|vfid
operator|=
name|p_vf_params
operator|->
name|vfid
expr_stmt|;
name|p_cid
operator|->
name|vf_qid
operator|=
name|p_vf_params
operator|->
name|vf_qid
expr_stmt|;
name|p_cid
operator|->
name|vf_legacy
operator|=
name|p_vf_params
operator|->
name|vf_legacy
expr_stmt|;
block|}
else|else
block|{
name|p_cid
operator|->
name|vfid
operator|=
name|ECORE_QUEUE_CID_PF
expr_stmt|;
block|}
comment|/* Don't try calculating the absolute indices for VFs */
if|if
condition|(
name|IS_VF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
name|p_cid
operator|->
name|abs
operator|=
name|p_cid
operator|->
name|rel
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Calculate the engine-absolute indices of the resources. 	 * The would guarantee they're valid later on. 	 * In some cases [SBs] we already have the right values. 	 */
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
operator|->
name|rel
operator|.
name|vport_id
argument_list|,
operator|&
name|p_cid
operator|->
name|abs
operator|.
name|vport_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
goto|goto
name|fail
goto|;
name|rc
operator|=
name|ecore_fw_l2_queue
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
operator|->
name|rel
operator|.
name|queue_id
argument_list|,
operator|&
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
goto|goto
name|fail
goto|;
comment|/* In case of a PF configuring its VF's queues, the stats-id is already 	 * absolute [since there's a single index that's suitable per-VF]. 	 */
if|if
condition|(
name|p_cid
operator|->
name|vfid
operator|==
name|ECORE_QUEUE_CID_PF
condition|)
block|{
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
operator|->
name|rel
operator|.
name|stats_id
argument_list|,
operator|&
name|p_cid
operator|->
name|abs
operator|.
name|stats_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
name|p_cid
operator|->
name|abs
operator|.
name|stats_id
operator|=
name|p_cid
operator|->
name|rel
operator|.
name|stats_id
expr_stmt|;
block|}
name|out
label|:
comment|/* VF-images have provided the qid_usage_idx on their own. 	 * Otherwise, we need to allocate a unique one. 	 */
if|if
condition|(
operator|!
name|p_vf_params
condition|)
block|{
if|if
condition|(
operator|!
name|ecore_eth_queue_qid_usage_add
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
else|else
block|{
name|p_cid
operator|->
name|qid_usage_idx
operator|=
name|p_vf_params
operator|->
name|qid_usage_idx
expr_stmt|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"opaque_fid: %04x CID %08x vport %02x [%02x] qzone %04x.%02x [%04x] stats %02x [%02x] SB %04x PI %02x\n"
argument_list|,
name|p_cid
operator|->
name|opaque_fid
argument_list|,
name|p_cid
operator|->
name|cid
argument_list|,
name|p_cid
operator|->
name|rel
operator|.
name|vport_id
argument_list|,
name|p_cid
operator|->
name|abs
operator|.
name|vport_id
argument_list|,
name|p_cid
operator|->
name|rel
operator|.
name|queue_id
argument_list|,
name|p_cid
operator|->
name|qid_usage_idx
argument_list|,
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|,
name|p_cid
operator|->
name|rel
operator|.
name|stats_id
argument_list|,
name|p_cid
operator|->
name|abs
operator|.
name|stats_id
argument_list|,
name|p_cid
operator|->
name|sb_igu_id
argument_list|,
name|p_cid
operator|->
name|sb_idx
argument_list|)
expr_stmt|;
return|return
name|p_cid
return|;
name|fail
label|:
name|OSAL_VFREE
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
return|return
name|OSAL_NULL
return|;
block|}
end_function

begin_function
name|struct
name|ecore_queue_cid
modifier|*
name|ecore_eth_queue_to_cid
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|struct
name|ecore_queue_start_common_params
modifier|*
name|p_params
parameter_list|,
name|struct
name|ecore_queue_cid_vf_params
modifier|*
name|p_vf_params
parameter_list|)
block|{
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
decl_stmt|;
name|u8
name|vfid
init|=
name|ECORE_CXT_PF_CID
decl_stmt|;
name|bool
name|b_legacy_vf
init|=
name|false
decl_stmt|;
name|u32
name|cid
init|=
literal|0
decl_stmt|;
comment|/* In case of legacy VFs, The CID can be derived from the additional 	 * VF parameters - the VF assumes queue X uses CID X, so we can simply 	 * use the vf_qid for this purpose as well. 	 */
if|if
condition|(
name|p_vf_params
condition|)
block|{
name|vfid
operator|=
name|p_vf_params
operator|->
name|vfid
expr_stmt|;
if|if
condition|(
name|p_vf_params
operator|->
name|vf_legacy
operator|&
name|ECORE_QCID_LEGACY_VF_CID
condition|)
block|{
name|b_legacy_vf
operator|=
name|true
expr_stmt|;
name|cid
operator|=
name|p_vf_params
operator|->
name|vf_qid
expr_stmt|;
block|}
block|}
comment|/* Get a unique firmware CID for this queue, in case it's a PF. 	 * VF's don't need a CID as the queue configuration will be done 	 * by PF. 	 */
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
operator|&&
operator|!
name|b_legacy_vf
condition|)
block|{
if|if
condition|(
name|_ecore_cxt_acquire_cid
argument_list|(
name|p_hwfn
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|cid
argument_list|,
name|vfid
argument_list|)
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
name|DP_NOTICE
argument_list|(
name|p_hwfn
argument_list|,
name|true
argument_list|,
literal|"Failed to acquire cid\n"
argument_list|)
expr_stmt|;
return|return
name|OSAL_NULL
return|;
block|}
block|}
name|p_cid
operator|=
name|_ecore_eth_queue_to_cid
argument_list|(
name|p_hwfn
argument_list|,
name|opaque_fid
argument_list|,
name|cid
argument_list|,
name|p_params
argument_list|,
name|p_vf_params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_cid
operator|==
name|OSAL_NULL
operator|)
operator|&&
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
operator|&&
operator|!
name|b_legacy_vf
condition|)
name|_ecore_cxt_release_cid
argument_list|(
name|p_hwfn
argument_list|,
name|cid
argument_list|,
name|vfid
argument_list|)
expr_stmt|;
return|return
name|p_cid
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ecore_queue_cid
modifier|*
name|ecore_eth_queue_to_cid_pf
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|struct
name|ecore_queue_start_common_params
modifier|*
name|p_params
parameter_list|)
block|{
return|return
name|ecore_eth_queue_to_cid
argument_list|(
name|p_hwfn
argument_list|,
name|opaque_fid
argument_list|,
name|p_params
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_sp_eth_vport_start
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_sp_vport_start_params
modifier|*
name|p_params
parameter_list|)
block|{
name|struct
name|vport_start_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|u16
name|rx_mode
init|=
literal|0
decl_stmt|,
name|tx_err
init|=
literal|0
decl_stmt|;
name|u8
name|abs_vport_id
init|=
literal|0
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_NOTIMPL
decl_stmt|;
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_params
operator|->
name|vport_id
argument_list|,
operator|&
name|abs_vport_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|ecore_spq_get_cid
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_params
operator|->
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_EBLOCK
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_VPORT_START
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|vport_start
expr_stmt|;
name|p_ramrod
operator|->
name|vport_id
operator|=
name|abs_vport_id
expr_stmt|;
name|p_ramrod
operator|->
name|mtu
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_params
operator|->
name|mtu
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|inner_vlan_removal_en
operator|=
name|p_params
operator|->
name|remove_inner_vlan
expr_stmt|;
name|p_ramrod
operator|->
name|handle_ptp_pkts
operator|=
name|p_params
operator|->
name|handle_ptp_pkts
expr_stmt|;
name|p_ramrod
operator|->
name|drop_ttl0_en
operator|=
name|p_params
operator|->
name|drop_ttl0
expr_stmt|;
name|p_ramrod
operator|->
name|untagged
operator|=
name|p_params
operator|->
name|only_untagged
expr_stmt|;
name|p_ramrod
operator|->
name|zero_placement_offset
operator|=
name|p_params
operator|->
name|zero_placement_offset
expr_stmt|;
name|SET_FIELD
argument_list|(
name|rx_mode
argument_list|,
name|ETH_VPORT_RX_MODE_UCAST_DROP_ALL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|rx_mode
argument_list|,
name|ETH_VPORT_RX_MODE_MCAST_DROP_ALL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|rx_mode
operator|.
name|state
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|rx_mode
argument_list|)
expr_stmt|;
comment|/* Handle requests for strict behavior on transmission errors */
name|SET_FIELD
argument_list|(
name|tx_err
argument_list|,
name|ETH_TX_ERR_VALS_ILLEGAL_VLAN_MODE
argument_list|,
name|p_params
operator|->
name|b_err_illegal_vlan_mode
condition|?
name|ETH_TX_ERR_ASSERT_MALICIOUS
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|tx_err
argument_list|,
name|ETH_TX_ERR_VALS_PACKET_TOO_SMALL
argument_list|,
name|p_params
operator|->
name|b_err_small_pkt
condition|?
name|ETH_TX_ERR_ASSERT_MALICIOUS
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|tx_err
argument_list|,
name|ETH_TX_ERR_VALS_ANTI_SPOOFING_ERR
argument_list|,
name|p_params
operator|->
name|b_err_anti_spoof
condition|?
name|ETH_TX_ERR_ASSERT_MALICIOUS
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|tx_err
argument_list|,
name|ETH_TX_ERR_VALS_ILLEGAL_INBAND_TAGS
argument_list|,
name|p_params
operator|->
name|b_err_illegal_inband_mode
condition|?
name|ETH_TX_ERR_ASSERT_MALICIOUS
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|tx_err
argument_list|,
name|ETH_TX_ERR_VALS_VLAN_INSERTION_W_INBAND_TAG
argument_list|,
name|p_params
operator|->
name|b_err_vlan_insert_with_inband
condition|?
name|ETH_TX_ERR_ASSERT_MALICIOUS
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|tx_err
argument_list|,
name|ETH_TX_ERR_VALS_MTU_VIOLATION
argument_list|,
name|p_params
operator|->
name|b_err_big_pkt
condition|?
name|ETH_TX_ERR_ASSERT_MALICIOUS
else|:
literal|0
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|tx_err
argument_list|,
name|ETH_TX_ERR_VALS_ILLEGAL_CONTROL_FRAME
argument_list|,
name|p_params
operator|->
name|b_err_ctrl_frame
condition|?
name|ETH_TX_ERR_ASSERT_MALICIOUS
else|:
literal|0
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|tx_err_behav
operator|.
name|values
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|tx_err
argument_list|)
expr_stmt|;
comment|/* TPA related fields */
name|OSAL_MEMSET
argument_list|(
operator|&
name|p_ramrod
operator|->
name|tpa_param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eth_vport_tpa_param
argument_list|)
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|max_buff_num
operator|=
name|p_params
operator|->
name|max_buffers_per_cqe
expr_stmt|;
switch|switch
condition|(
name|p_params
operator|->
name|tpa_mode
condition|)
block|{
case|case
name|ECORE_TPA_MODE_GRO
case|:
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_max_aggs_num
operator|=
name|ETH_TPA_MAX_AGGS_NUM
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_max_size
operator|=
operator|(
name|u16
operator|)
operator|-
literal|1
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_min_size_to_cont
operator|=
name|p_params
operator|->
name|mtu
operator|/
literal|2
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_min_size_to_start
operator|=
name|p_params
operator|->
name|mtu
operator|/
literal|2
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_ipv4_en_flg
operator|=
literal|1
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_ipv6_en_flg
operator|=
literal|1
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_ipv4_tunn_en_flg
operator|=
literal|1
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_ipv6_tunn_en_flg
operator|=
literal|1
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_pkt_split_flg
operator|=
literal|1
expr_stmt|;
name|p_ramrod
operator|->
name|tpa_param
operator|.
name|tpa_gro_consistent_flg
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|p_ramrod
operator|->
name|tx_switching_en
operator|=
name|p_params
operator|->
name|tx_switching
expr_stmt|;
ifndef|#
directive|ifndef
name|ASIC_ONLY
if|if
condition|(
name|CHIP_REV_IS_SLOW
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
name|p_ramrod
operator|->
name|tx_switching_en
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|p_ramrod
operator|->
name|ctl_frame_mac_check_en
operator|=
operator|!
operator|!
name|p_params
operator|->
name|check_mac
expr_stmt|;
name|p_ramrod
operator|->
name|ctl_frame_ethtype_check_en
operator|=
operator|!
operator|!
name|p_params
operator|->
name|check_ethtype
expr_stmt|;
comment|/* Software Function ID in hwfn (PFs are 0 - 15, VFs are 16 - 135) */
name|p_ramrod
operator|->
name|sw_fid
operator|=
name|ecore_concrete_to_sw_fid
argument_list|(
name|p_params
operator|->
name|concrete_fid
argument_list|)
expr_stmt|;
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_sp_vport_start
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_sp_vport_start_params
modifier|*
name|p_params
parameter_list|)
block|{
if|if
condition|(
name|IS_VF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
return|return
name|ecore_vf_pf_vport_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_params
operator|->
name|vport_id
argument_list|,
name|p_params
operator|->
name|mtu
argument_list|,
name|p_params
operator|->
name|remove_inner_vlan
argument_list|,
name|p_params
operator|->
name|tpa_mode
argument_list|,
name|p_params
operator|->
name|max_buffers_per_cqe
argument_list|,
name|p_params
operator|->
name|only_untagged
argument_list|)
return|;
return|return
name|ecore_sp_eth_vport_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_params
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_sp_vport_update_rss
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|vport_update_ramrod_data
modifier|*
name|p_ramrod
parameter_list|,
name|struct
name|ecore_rss_params
modifier|*
name|p_rss
parameter_list|)
block|{
name|struct
name|eth_vport_rss_config
modifier|*
name|p_config
decl_stmt|;
name|int
name|i
decl_stmt|,
name|table_size
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
if|if
condition|(
operator|!
name|p_rss
condition|)
block|{
name|p_ramrod
operator|->
name|common
operator|.
name|update_rss_flg
operator|=
literal|0
expr_stmt|;
return|return
name|rc
return|;
block|}
name|p_config
operator|=
operator|&
name|p_ramrod
operator|->
name|rss_config
expr_stmt|;
name|OSAL_BUILD_BUG_ON
argument_list|(
name|ECORE_RSS_IND_TABLE_SIZE
operator|!=
name|ETH_RSS_IND_TABLE_ENTRIES_NUM
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ecore_fw_rss_eng
argument_list|(
name|p_hwfn
argument_list|,
name|p_rss
operator|->
name|rss_eng_id
argument_list|,
operator|&
name|p_config
operator|->
name|rss_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_rss_flg
operator|=
name|p_rss
operator|->
name|update_rss_config
expr_stmt|;
name|p_config
operator|->
name|update_rss_capabilities
operator|=
name|p_rss
operator|->
name|update_rss_capabilities
expr_stmt|;
name|p_config
operator|->
name|update_rss_ind_table
operator|=
name|p_rss
operator|->
name|update_rss_ind_table
expr_stmt|;
name|p_config
operator|->
name|update_rss_key
operator|=
name|p_rss
operator|->
name|update_rss_key
expr_stmt|;
name|p_config
operator|->
name|rss_mode
operator|=
name|p_rss
operator|->
name|rss_enable
condition|?
name|ETH_VPORT_RSS_MODE_REGULAR
else|:
name|ETH_VPORT_RSS_MODE_DISABLED
expr_stmt|;
name|p_config
operator|->
name|capabilities
operator|=
literal|0
expr_stmt|;
name|SET_FIELD
argument_list|(
name|p_config
operator|->
name|capabilities
argument_list|,
name|ETH_VPORT_RSS_CONFIG_IPV4_CAPABILITY
argument_list|,
operator|!
operator|!
operator|(
name|p_rss
operator|->
name|rss_caps
operator|&
name|ECORE_RSS_IPV4
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|p_config
operator|->
name|capabilities
argument_list|,
name|ETH_VPORT_RSS_CONFIG_IPV6_CAPABILITY
argument_list|,
operator|!
operator|!
operator|(
name|p_rss
operator|->
name|rss_caps
operator|&
name|ECORE_RSS_IPV6
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|p_config
operator|->
name|capabilities
argument_list|,
name|ETH_VPORT_RSS_CONFIG_IPV4_TCP_CAPABILITY
argument_list|,
operator|!
operator|!
operator|(
name|p_rss
operator|->
name|rss_caps
operator|&
name|ECORE_RSS_IPV4_TCP
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|p_config
operator|->
name|capabilities
argument_list|,
name|ETH_VPORT_RSS_CONFIG_IPV6_TCP_CAPABILITY
argument_list|,
operator|!
operator|!
operator|(
name|p_rss
operator|->
name|rss_caps
operator|&
name|ECORE_RSS_IPV6_TCP
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|p_config
operator|->
name|capabilities
argument_list|,
name|ETH_VPORT_RSS_CONFIG_IPV4_UDP_CAPABILITY
argument_list|,
operator|!
operator|!
operator|(
name|p_rss
operator|->
name|rss_caps
operator|&
name|ECORE_RSS_IPV4_UDP
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|p_config
operator|->
name|capabilities
argument_list|,
name|ETH_VPORT_RSS_CONFIG_IPV6_UDP_CAPABILITY
argument_list|,
operator|!
operator|!
operator|(
name|p_rss
operator|->
name|rss_caps
operator|&
name|ECORE_RSS_IPV6_UDP
operator|)
argument_list|)
expr_stmt|;
name|p_config
operator|->
name|tbl_size
operator|=
name|p_rss
operator|->
name|rss_table_size_log
expr_stmt|;
name|p_config
operator|->
name|capabilities
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_config
operator|->
name|capabilities
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_IFUP
argument_list|,
literal|"update rss flag %d, rss_mode = %d, update_caps = %d, capabilities = %d, update_ind = %d, update_rss_key = %d\n"
argument_list|,
name|p_ramrod
operator|->
name|common
operator|.
name|update_rss_flg
argument_list|,
name|p_config
operator|->
name|rss_mode
argument_list|,
name|p_config
operator|->
name|update_rss_capabilities
argument_list|,
name|p_config
operator|->
name|capabilities
argument_list|,
name|p_config
operator|->
name|update_rss_ind_table
argument_list|,
name|p_config
operator|->
name|update_rss_key
argument_list|)
expr_stmt|;
name|table_size
operator|=
name|OSAL_MIN_T
argument_list|(
name|int
argument_list|,
name|ECORE_RSS_IND_TABLE_SIZE
argument_list|,
literal|1
operator|<<
name|p_config
operator|->
name|tbl_size
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|table_size
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ecore_queue_cid
modifier|*
name|p_queue
init|=
name|p_rss
operator|->
name|rss_ind_table
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|p_queue
condition|)
return|return
name|ECORE_INVAL
return|;
name|p_config
operator|->
name|indirection_table
index|[
name|i
index|]
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_queue
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_IFUP
argument_list|,
literal|"Configured RSS indirection table [%d entries]:\n"
argument_list|,
name|table_size
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ECORE_RSS_IND_TABLE_SIZE
condition|;
name|i
operator|+=
literal|0x10
control|)
block|{
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_IFUP
argument_list|,
literal|"%04x %04x %04x %04x %04x %04x %04x %04x %04x %04x %04x %04x %04x %04x %04x %04x\n"
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|2
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|3
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|4
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|5
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|6
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|7
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|8
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|9
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|10
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|11
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|12
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|13
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|14
index|]
argument_list|)
argument_list|,
name|OSAL_LE16_TO_CPU
argument_list|(
name|p_config
operator|->
name|indirection_table
index|[
name|i
operator|+
literal|15
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|p_config
operator|->
name|rss_key
index|[
name|i
index|]
operator|=
name|OSAL_CPU_TO_LE32
argument_list|(
name|p_rss
operator|->
name|rss_key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_sp_update_accept_mode
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|vport_update_ramrod_data
modifier|*
name|p_ramrod
parameter_list|,
name|struct
name|ecore_filter_accept_flags
name|accept_flags
parameter_list|)
block|{
name|p_ramrod
operator|->
name|common
operator|.
name|update_rx_mode_flg
operator|=
name|accept_flags
operator|.
name|update_rx_mode_config
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_tx_mode_flg
operator|=
name|accept_flags
operator|.
name|update_tx_mode_config
expr_stmt|;
ifndef|#
directive|ifndef
name|ASIC_ONLY
comment|/* On B0 emulation we cannot enable Tx, since this would cause writes 	 * to PVFC HW block which isn't implemented in emulation. 	 */
if|if
condition|(
name|CHIP_REV_IS_SLOW
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"Non-Asic - prevent Tx mode in vport update\n"
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_tx_mode_flg
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* Set Rx mode accept flags */
if|if
condition|(
name|p_ramrod
operator|->
name|common
operator|.
name|update_rx_mode_flg
condition|)
block|{
name|u8
name|accept_filter
init|=
name|accept_flags
operator|.
name|rx_accept_filter
decl_stmt|;
name|u16
name|state
init|=
literal|0
decl_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_RX_MODE_UCAST_DROP_ALL
argument_list|,
operator|!
operator|(
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_UCAST_MATCHED
operator|)
operator|||
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_UCAST_UNMATCHED
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_RX_MODE_UCAST_ACCEPT_UNMATCHED
argument_list|,
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_UCAST_UNMATCHED
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_RX_MODE_MCAST_DROP_ALL
argument_list|,
operator|!
operator|(
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_MCAST_MATCHED
operator|)
operator|||
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_MCAST_UNMATCHED
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_RX_MODE_MCAST_ACCEPT_ALL
argument_list|,
operator|(
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_MCAST_MATCHED
operator|)
operator|&&
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_MCAST_UNMATCHED
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_RX_MODE_BCAST_ACCEPT_ALL
argument_list|,
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_BCAST
operator|)
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|rx_mode
operator|.
name|state
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"vport[%02x] p_ramrod->rx_mode.state = 0x%x\n"
argument_list|,
name|p_ramrod
operator|->
name|common
operator|.
name|vport_id
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
comment|/* Set Tx mode accept flags */
if|if
condition|(
name|p_ramrod
operator|->
name|common
operator|.
name|update_tx_mode_flg
condition|)
block|{
name|u8
name|accept_filter
init|=
name|accept_flags
operator|.
name|tx_accept_filter
decl_stmt|;
name|u16
name|state
init|=
literal|0
decl_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_TX_MODE_UCAST_DROP_ALL
argument_list|,
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_NONE
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_TX_MODE_MCAST_DROP_ALL
argument_list|,
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_NONE
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_TX_MODE_MCAST_ACCEPT_ALL
argument_list|,
operator|(
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_MCAST_MATCHED
operator|)
operator|&&
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_MCAST_UNMATCHED
operator|)
operator|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|state
argument_list|,
name|ETH_VPORT_TX_MODE_BCAST_ACCEPT_ALL
argument_list|,
operator|!
operator|!
operator|(
name|accept_filter
operator|&
name|ECORE_ACCEPT_BCAST
operator|)
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|tx_mode
operator|.
name|state
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"vport[%02x] p_ramrod->tx_mode.state = 0x%x\n"
argument_list|,
name|p_ramrod
operator|->
name|common
operator|.
name|vport_id
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_sp_vport_update_sge_tpa
parameter_list|(
name|struct
name|vport_update_ramrod_data
modifier|*
name|p_ramrod
parameter_list|,
name|struct
name|ecore_sge_tpa_params
modifier|*
name|p_params
parameter_list|)
block|{
name|struct
name|eth_vport_tpa_param
modifier|*
name|p_tpa
decl_stmt|;
if|if
condition|(
operator|!
name|p_params
condition|)
block|{
name|p_ramrod
operator|->
name|common
operator|.
name|update_tpa_param_flg
operator|=
literal|0
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_tpa_en_flg
operator|=
literal|0
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_tpa_param_flg
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|p_ramrod
operator|->
name|common
operator|.
name|update_tpa_en_flg
operator|=
name|p_params
operator|->
name|update_tpa_en_flg
expr_stmt|;
name|p_tpa
operator|=
operator|&
name|p_ramrod
operator|->
name|tpa_param
expr_stmt|;
name|p_tpa
operator|->
name|tpa_ipv4_en_flg
operator|=
name|p_params
operator|->
name|tpa_ipv4_en_flg
expr_stmt|;
name|p_tpa
operator|->
name|tpa_ipv6_en_flg
operator|=
name|p_params
operator|->
name|tpa_ipv6_en_flg
expr_stmt|;
name|p_tpa
operator|->
name|tpa_ipv4_tunn_en_flg
operator|=
name|p_params
operator|->
name|tpa_ipv4_tunn_en_flg
expr_stmt|;
name|p_tpa
operator|->
name|tpa_ipv6_tunn_en_flg
operator|=
name|p_params
operator|->
name|tpa_ipv6_tunn_en_flg
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_tpa_param_flg
operator|=
name|p_params
operator|->
name|update_tpa_param_flg
expr_stmt|;
name|p_tpa
operator|->
name|max_buff_num
operator|=
name|p_params
operator|->
name|max_buffers_per_cqe
expr_stmt|;
name|p_tpa
operator|->
name|tpa_pkt_split_flg
operator|=
name|p_params
operator|->
name|tpa_pkt_split_flg
expr_stmt|;
name|p_tpa
operator|->
name|tpa_hdr_data_split_flg
operator|=
name|p_params
operator|->
name|tpa_hdr_data_split_flg
expr_stmt|;
name|p_tpa
operator|->
name|tpa_gro_consistent_flg
operator|=
name|p_params
operator|->
name|tpa_gro_consistent_flg
expr_stmt|;
name|p_tpa
operator|->
name|tpa_max_aggs_num
operator|=
name|p_params
operator|->
name|tpa_max_aggs_num
expr_stmt|;
name|p_tpa
operator|->
name|tpa_max_size
operator|=
name|p_params
operator|->
name|tpa_max_size
expr_stmt|;
name|p_tpa
operator|->
name|tpa_min_size_to_start
operator|=
name|p_params
operator|->
name|tpa_min_size_to_start
expr_stmt|;
name|p_tpa
operator|->
name|tpa_min_size_to_cont
operator|=
name|p_params
operator|->
name|tpa_min_size_to_cont
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ecore_sp_update_mcast_bin
parameter_list|(
name|struct
name|vport_update_ramrod_data
modifier|*
name|p_ramrod
parameter_list|,
name|struct
name|ecore_sp_vport_update_params
modifier|*
name|p_params
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|p_ramrod
operator|->
name|approx_mcast
operator|.
name|bins
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p_ramrod
operator|->
name|approx_mcast
operator|.
name|bins
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_params
operator|->
name|update_approx_mcast_flg
condition|)
return|return;
name|p_ramrod
operator|->
name|common
operator|.
name|update_approx_mcast_flg
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_MULTICAST_MAC_BINS_IN_REGS
condition|;
name|i
operator|++
control|)
block|{
name|u32
modifier|*
name|p_bins
init|=
operator|(
name|u32
operator|*
operator|)
name|p_params
operator|->
name|bins
decl_stmt|;
name|p_ramrod
operator|->
name|approx_mcast
operator|.
name|bins
index|[
name|i
index|]
operator|=
name|OSAL_CPU_TO_LE32
argument_list|(
name|p_bins
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_sp_vport_update
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_sp_vport_update_params
modifier|*
name|p_params
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|struct
name|ecore_rss_params
modifier|*
name|p_rss_params
init|=
name|p_params
operator|->
name|rss_params
decl_stmt|;
name|struct
name|vport_update_ramrod_data_cmn
modifier|*
name|p_cmn
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|struct
name|vport_update_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|u8
name|abs_vport_id
init|=
literal|0
decl_stmt|,
name|val
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_NOTIMPL
decl_stmt|;
if|if
condition|(
name|IS_VF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
name|rc
operator|=
name|ecore_vf_pf_vport_update
argument_list|(
name|p_hwfn
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_params
operator|->
name|vport_id
argument_list|,
operator|&
name|abs_vport_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|ecore_spq_get_cid
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_params
operator|->
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|comp_mode
expr_stmt|;
name|init_data
operator|.
name|p_comp_data
operator|=
name|p_comp_data
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_VPORT_UPDATE
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Copy input params to ramrod according to FW struct */
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|vport_update
expr_stmt|;
name|p_cmn
operator|=
operator|&
name|p_ramrod
operator|->
name|common
expr_stmt|;
name|p_cmn
operator|->
name|vport_id
operator|=
name|abs_vport_id
expr_stmt|;
name|p_cmn
operator|->
name|rx_active_flg
operator|=
name|p_params
operator|->
name|vport_active_rx_flg
expr_stmt|;
name|p_cmn
operator|->
name|update_rx_active_flg
operator|=
name|p_params
operator|->
name|update_vport_active_rx_flg
expr_stmt|;
name|p_cmn
operator|->
name|tx_active_flg
operator|=
name|p_params
operator|->
name|vport_active_tx_flg
expr_stmt|;
name|p_cmn
operator|->
name|update_tx_active_flg
operator|=
name|p_params
operator|->
name|update_vport_active_tx_flg
expr_stmt|;
name|p_cmn
operator|->
name|accept_any_vlan
operator|=
name|p_params
operator|->
name|accept_any_vlan
expr_stmt|;
name|val
operator|=
name|p_params
operator|->
name|update_accept_any_vlan_flg
expr_stmt|;
name|p_cmn
operator|->
name|update_accept_any_vlan_flg
operator|=
name|val
expr_stmt|;
name|p_cmn
operator|->
name|inner_vlan_removal_en
operator|=
name|p_params
operator|->
name|inner_vlan_removal_flg
expr_stmt|;
name|val
operator|=
name|p_params
operator|->
name|update_inner_vlan_removal_flg
expr_stmt|;
name|p_cmn
operator|->
name|update_inner_vlan_removal_en_flg
operator|=
name|val
expr_stmt|;
name|p_cmn
operator|->
name|default_vlan_en
operator|=
name|p_params
operator|->
name|default_vlan_enable_flg
expr_stmt|;
name|val
operator|=
name|p_params
operator|->
name|update_default_vlan_enable_flg
expr_stmt|;
name|p_cmn
operator|->
name|update_default_vlan_en_flg
operator|=
name|val
expr_stmt|;
name|p_cmn
operator|->
name|default_vlan
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_params
operator|->
name|default_vlan
argument_list|)
expr_stmt|;
name|p_cmn
operator|->
name|update_default_vlan_flg
operator|=
name|p_params
operator|->
name|update_default_vlan_flg
expr_stmt|;
name|p_cmn
operator|->
name|silent_vlan_removal_en
operator|=
name|p_params
operator|->
name|silent_vlan_removal_flg
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|tx_switching_en
operator|=
name|p_params
operator|->
name|tx_switching_flg
expr_stmt|;
ifndef|#
directive|ifndef
name|ASIC_ONLY
if|if
condition|(
name|CHIP_REV_IS_FPGA
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
if|if
condition|(
name|p_ramrod
operator|->
name|common
operator|.
name|tx_switching_en
operator|||
name|p_ramrod
operator|->
name|common
operator|.
name|update_tx_switching_en_flg
condition|)
block|{
name|DP_NOTICE
argument_list|(
name|p_hwfn
argument_list|,
name|false
argument_list|,
literal|"FPGA - why are we seeing tx-switching? Overriding it\n"
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|tx_switching_en
operator|=
literal|0
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_tx_switching_en_flg
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
name|p_cmn
operator|->
name|update_tx_switching_en_flg
operator|=
name|p_params
operator|->
name|update_tx_switching_flg
expr_stmt|;
name|p_cmn
operator|->
name|anti_spoofing_en
operator|=
name|p_params
operator|->
name|anti_spoofing_en
expr_stmt|;
name|val
operator|=
name|p_params
operator|->
name|update_anti_spoofing_en_flg
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_anti_spoofing_en_flg
operator|=
name|val
expr_stmt|;
name|rc
operator|=
name|ecore_sp_vport_update_rss
argument_list|(
name|p_hwfn
argument_list|,
name|p_ramrod
argument_list|,
name|p_rss_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
comment|/* Return spq entry which is taken in ecore_sp_init_request()*/
name|ecore_spq_return_entry
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
comment|/* Update mcast bins for VFs, PF doesn't use this functionality */
name|ecore_sp_update_mcast_bin
argument_list|(
name|p_ramrod
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
name|ecore_sp_update_accept_mode
argument_list|(
name|p_hwfn
argument_list|,
name|p_ramrod
argument_list|,
name|p_params
operator|->
name|accept_flags
argument_list|)
expr_stmt|;
name|ecore_sp_vport_update_sge_tpa
argument_list|(
name|p_ramrod
argument_list|,
name|p_params
operator|->
name|sge_tpa_params
argument_list|)
expr_stmt|;
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_sp_vport_stop
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|u8
name|vport_id
parameter_list|)
block|{
name|struct
name|vport_stop_ramrod_data
modifier|*
name|p_ramrod
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
decl_stmt|;
name|u8
name|abs_vport_id
init|=
literal|0
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
if|if
condition|(
name|IS_VF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
return|return
name|ecore_vf_pf_vport_stop
argument_list|(
name|p_hwfn
argument_list|)
return|;
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|vport_id
argument_list|,
operator|&
name|abs_vport_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|ecore_spq_get_cid
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_EBLOCK
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_VPORT_STOP
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|vport_stop
expr_stmt|;
name|p_ramrod
operator|->
name|vport_id
operator|=
name|abs_vport_id
expr_stmt|;
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_vf_pf_accept_flags
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_filter_accept_flags
modifier|*
name|p_accept_flags
parameter_list|)
block|{
name|struct
name|ecore_sp_vport_update_params
name|s_params
decl_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|s_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|s_params
argument_list|)
argument_list|)
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
operator|&
name|s_params
operator|.
name|accept_flags
argument_list|,
name|p_accept_flags
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_filter_accept_flags
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ecore_vf_pf_vport_update
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|s_params
argument_list|)
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_filter_accept_cmd
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|p_dev
parameter_list|,
name|u8
name|vport
parameter_list|,
name|struct
name|ecore_filter_accept_flags
name|accept_flags
parameter_list|,
name|u8
name|update_accept_any_vlan
parameter_list|,
name|u8
name|accept_any_vlan
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|struct
name|ecore_sp_vport_update_params
name|vport_update_params
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
comment|/* Prepare and send the vport rx_mode change */
name|OSAL_MEMSET
argument_list|(
operator|&
name|vport_update_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|vport_update_params
argument_list|)
argument_list|)
expr_stmt|;
name|vport_update_params
operator|.
name|vport_id
operator|=
name|vport
expr_stmt|;
name|vport_update_params
operator|.
name|accept_flags
operator|=
name|accept_flags
expr_stmt|;
name|vport_update_params
operator|.
name|update_accept_any_vlan_flg
operator|=
name|update_accept_any_vlan
expr_stmt|;
name|vport_update_params
operator|.
name|accept_any_vlan
operator|=
name|accept_any_vlan
expr_stmt|;
name|for_each_hwfn
argument_list|(
argument|p_dev
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|p_dev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|vport_update_params
operator|.
name|opaque_fid
operator|=
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
expr_stmt|;
if|if
condition|(
name|IS_VF
argument_list|(
name|p_dev
argument_list|)
condition|)
block|{
name|rc
operator|=
name|ecore_vf_pf_accept_flags
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|accept_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
continue|continue;
block|}
name|rc
operator|=
name|ecore_sp_vport_update
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|vport_update_params
argument_list|,
name|comp_mode
argument_list|,
name|p_comp_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_dev
argument_list|,
literal|"Update rx_mode failed %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"Accept filter configured, flags = [Rx]%x [Tx]%x\n"
argument_list|,
name|accept_flags
operator|.
name|rx_accept_filter
argument_list|,
name|accept_flags
operator|.
name|tx_accept_filter
argument_list|)
expr_stmt|;
if|if
condition|(
name|update_accept_any_vlan
condition|)
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"accept_any_vlan=%d configured\n"
argument_list|,
name|accept_any_vlan
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_eth_rxq_start_ramrod
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|,
name|u16
name|bd_max_bytes
parameter_list|,
name|dma_addr_t
name|bd_chain_phys_addr
parameter_list|,
name|dma_addr_t
name|cqe_pbl_addr
parameter_list|,
name|u16
name|cqe_pbl_size
parameter_list|)
block|{
name|struct
name|rx_queue_start_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_NOTIMPL
decl_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"opaque_fid=0x%x, cid=0x%x, rx_qzone=0x%x, vport_id=0x%x, sb_id=0x%x\n"
argument_list|,
name|p_cid
operator|->
name|opaque_fid
argument_list|,
name|p_cid
operator|->
name|cid
argument_list|,
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|,
name|p_cid
operator|->
name|abs
operator|.
name|vport_id
argument_list|,
name|p_cid
operator|->
name|sb_igu_id
argument_list|)
expr_stmt|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|p_cid
operator|->
name|cid
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_cid
operator|->
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_EBLOCK
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_RX_QUEUE_START
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|rx_queue_start
expr_stmt|;
name|p_ramrod
operator|->
name|sb_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_cid
operator|->
name|sb_igu_id
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|sb_index
operator|=
name|p_cid
operator|->
name|sb_idx
expr_stmt|;
name|p_ramrod
operator|->
name|vport_id
operator|=
name|p_cid
operator|->
name|abs
operator|.
name|vport_id
expr_stmt|;
name|p_ramrod
operator|->
name|stats_counter_id
operator|=
name|p_cid
operator|->
name|abs
operator|.
name|stats_id
expr_stmt|;
name|p_ramrod
operator|->
name|rx_queue_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|complete_cqe_flg
operator|=
literal|0
expr_stmt|;
name|p_ramrod
operator|->
name|complete_event_flg
operator|=
literal|1
expr_stmt|;
name|p_ramrod
operator|->
name|bd_max_bytes
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|bd_max_bytes
argument_list|)
expr_stmt|;
name|DMA_REGPAIR_LE
argument_list|(
name|p_ramrod
operator|->
name|bd_base
argument_list|,
name|bd_chain_phys_addr
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|num_of_pbl_pages
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|cqe_pbl_size
argument_list|)
expr_stmt|;
name|DMA_REGPAIR_LE
argument_list|(
name|p_ramrod
operator|->
name|cqe_pbl_addr
argument_list|,
name|cqe_pbl_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_cid
operator|->
name|vfid
operator|!=
name|ECORE_QUEUE_CID_PF
condition|)
block|{
name|bool
name|b_legacy_vf
init|=
operator|!
operator|!
operator|(
name|p_cid
operator|->
name|vf_legacy
operator|&
name|ECORE_QCID_LEGACY_VF_RX_PROD
operator|)
decl_stmt|;
name|p_ramrod
operator|->
name|vf_rx_prod_index
operator|=
name|p_cid
operator|->
name|vf_qid
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"Queue%s is meant for VF rxq[%02x]\n"
argument_list|,
name|b_legacy_vf
condition|?
literal|" [legacy]"
else|:
literal|""
argument_list|,
name|p_cid
operator|->
name|vf_qid
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|vf_rx_prod_use_zone_a
operator|=
name|b_legacy_vf
expr_stmt|;
block|}
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_eth_pf_rx_queue_start
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|,
name|u16
name|bd_max_bytes
parameter_list|,
name|dma_addr_t
name|bd_chain_phys_addr
parameter_list|,
name|dma_addr_t
name|cqe_pbl_addr
parameter_list|,
name|u16
name|cqe_pbl_size
parameter_list|,
name|void
name|OSAL_IOMEM
modifier|*
modifier|*
name|pp_prod
parameter_list|)
block|{
name|u32
name|init_prod_val
init|=
literal|0
decl_stmt|;
operator|*
name|pp_prod
operator|=
operator|(
name|u8
name|OSAL_IOMEM
operator|*
operator|)
name|p_hwfn
operator|->
name|regview
operator|+
name|GTT_BAR0_MAP_REG_MSDM_RAM
operator|+
name|MSTORM_ETH_PF_PRODS_OFFSET
argument_list|(
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
comment|/* Init the rcq, rx bd and rx sge (if valid) producers to 0 */
name|__internal_ram_wr
argument_list|(
name|p_hwfn
argument_list|,
operator|*
name|pp_prod
argument_list|,
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|(
operator|&
name|init_prod_val
operator|)
argument_list|)
expr_stmt|;
return|return
name|ecore_eth_rxq_start_ramrod
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|bd_max_bytes
argument_list|,
name|bd_chain_phys_addr
argument_list|,
name|cqe_pbl_addr
argument_list|,
name|cqe_pbl_size
argument_list|)
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_eth_rx_queue_start
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|struct
name|ecore_queue_start_common_params
modifier|*
name|p_params
parameter_list|,
name|u16
name|bd_max_bytes
parameter_list|,
name|dma_addr_t
name|bd_chain_phys_addr
parameter_list|,
name|dma_addr_t
name|cqe_pbl_addr
parameter_list|,
name|u16
name|cqe_pbl_size
parameter_list|,
name|struct
name|ecore_rxq_start_ret_params
modifier|*
name|p_ret_params
parameter_list|)
block|{
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
comment|/* Allocate a CID for the queue */
name|p_cid
operator|=
name|ecore_eth_queue_to_cid_pf
argument_list|(
name|p_hwfn
argument_list|,
name|opaque_fid
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_cid
operator|==
name|OSAL_NULL
condition|)
return|return
name|ECORE_NOMEM
return|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
name|rc
operator|=
name|ecore_eth_pf_rx_queue_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|bd_max_bytes
argument_list|,
name|bd_chain_phys_addr
argument_list|,
name|cqe_pbl_addr
argument_list|,
name|cqe_pbl_size
argument_list|,
operator|&
name|p_ret_params
operator|->
name|p_prod
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|ecore_vf_pf_rxq_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|bd_max_bytes
argument_list|,
name|bd_chain_phys_addr
argument_list|,
name|cqe_pbl_addr
argument_list|,
name|cqe_pbl_size
argument_list|,
operator|&
name|p_ret_params
operator|->
name|p_prod
argument_list|)
expr_stmt|;
comment|/* Provide the caller with a reference to as handler */
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
name|ecore_eth_queue_cid_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
else|else
name|p_ret_params
operator|->
name|p_handle
operator|=
operator|(
name|void
operator|*
operator|)
name|p_cid
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_sp_eth_rx_queues_update
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|void
modifier|*
modifier|*
name|pp_rxq_handles
parameter_list|,
name|u8
name|num_rxqs
parameter_list|,
name|u8
name|complete_cqe_flg
parameter_list|,
name|u8
name|complete_event_flg
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|struct
name|rx_queue_update_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_NOTIMPL
decl_stmt|;
name|u8
name|i
decl_stmt|;
if|if
condition|(
name|IS_VF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
return|return
name|ecore_vf_pf_rxqs_update
argument_list|(
name|p_hwfn
argument_list|,
operator|(
expr|struct
name|ecore_queue_cid
operator|*
operator|*
operator|)
name|pp_rxq_handles
argument_list|,
name|num_rxqs
argument_list|,
name|complete_cqe_flg
argument_list|,
name|complete_event_flg
argument_list|)
return|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|comp_mode
expr_stmt|;
name|init_data
operator|.
name|p_comp_data
operator|=
name|p_comp_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_rxqs
condition|;
name|i
operator|++
control|)
block|{
name|p_cid
operator|=
operator|(
operator|(
expr|struct
name|ecore_queue_cid
operator|*
operator|*
operator|)
name|pp_rxq_handles
operator|)
index|[
name|i
index|]
expr_stmt|;
comment|/* Get SPQ entry */
name|init_data
operator|.
name|cid
operator|=
name|p_cid
operator|->
name|cid
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_cid
operator|->
name|opaque_fid
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_RX_QUEUE_UPDATE
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|rx_queue_update
expr_stmt|;
name|p_ramrod
operator|->
name|vport_id
operator|=
name|p_cid
operator|->
name|abs
operator|.
name|vport_id
expr_stmt|;
name|p_ramrod
operator|->
name|rx_queue_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|complete_cqe_flg
operator|=
name|complete_cqe_flg
expr_stmt|;
name|p_ramrod
operator|->
name|complete_event_flg
operator|=
name|complete_event_flg
expr_stmt|;
name|rc
operator|=
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_eth_pf_rx_queue_stop
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|,
name|bool
name|b_eq_completion_only
parameter_list|,
name|bool
name|b_cqe_completion
parameter_list|)
block|{
name|struct
name|rx_queue_stop_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|p_cid
operator|->
name|cid
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_cid
operator|->
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_EBLOCK
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_RX_QUEUE_STOP
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|rx_queue_stop
expr_stmt|;
name|p_ramrod
operator|->
name|vport_id
operator|=
name|p_cid
operator|->
name|abs
operator|.
name|vport_id
expr_stmt|;
name|p_ramrod
operator|->
name|rx_queue_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
comment|/* Cleaning the queue requires the completion to arrive there. 	 * In addition, VFs require the answer to come as eqe to PF. 	 */
name|p_ramrod
operator|->
name|complete_cqe_flg
operator|=
operator|(
operator|(
name|p_cid
operator|->
name|vfid
operator|==
name|ECORE_QUEUE_CID_PF
operator|)
operator|&&
operator|!
name|b_eq_completion_only
operator|)
operator|||
name|b_cqe_completion
expr_stmt|;
name|p_ramrod
operator|->
name|complete_event_flg
operator|=
operator|(
name|p_cid
operator|->
name|vfid
operator|!=
name|ECORE_QUEUE_CID_PF
operator|)
operator|||
name|b_eq_completion_only
expr_stmt|;
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_eth_rx_queue_stop
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|void
modifier|*
name|p_rxq
parameter_list|,
name|bool
name|eq_completion_only
parameter_list|,
name|bool
name|cqe_completion
parameter_list|)
block|{
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
init|=
operator|(
expr|struct
name|ecore_queue_cid
operator|*
operator|)
name|p_rxq
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_NOTIMPL
decl_stmt|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
name|rc
operator|=
name|ecore_eth_pf_rx_queue_stop
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|eq_completion_only
argument_list|,
name|cqe_completion
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|ecore_vf_pf_rxq_stop
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|cqe_completion
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|ECORE_SUCCESS
condition|)
name|ecore_eth_queue_cid_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_eth_txq_start_ramrod
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|,
name|dma_addr_t
name|pbl_addr
parameter_list|,
name|u16
name|pbl_size
parameter_list|,
name|u16
name|pq_id
parameter_list|)
block|{
name|struct
name|tx_queue_start_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_NOTIMPL
decl_stmt|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|p_cid
operator|->
name|cid
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_cid
operator|->
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_EBLOCK
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_TX_QUEUE_START
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|tx_queue_start
expr_stmt|;
name|p_ramrod
operator|->
name|vport_id
operator|=
name|p_cid
operator|->
name|abs
operator|.
name|vport_id
expr_stmt|;
name|p_ramrod
operator|->
name|sb_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_cid
operator|->
name|sb_igu_id
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|sb_index
operator|=
name|p_cid
operator|->
name|sb_idx
expr_stmt|;
name|p_ramrod
operator|->
name|stats_counter_id
operator|=
name|p_cid
operator|->
name|abs
operator|.
name|stats_id
expr_stmt|;
name|p_ramrod
operator|->
name|queue_zone_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|same_as_last_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_cid
operator|->
name|abs
operator|.
name|queue_id
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|pbl_size
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|pbl_size
argument_list|)
expr_stmt|;
name|DMA_REGPAIR_LE
argument_list|(
name|p_ramrod
operator|->
name|pbl_base_addr
argument_list|,
name|pbl_addr
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|qm_pq_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|pq_id
argument_list|)
expr_stmt|;
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_eth_pf_tx_queue_start
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|,
name|u8
name|tc
parameter_list|,
name|dma_addr_t
name|pbl_addr
parameter_list|,
name|u16
name|pbl_size
parameter_list|,
name|void
name|OSAL_IOMEM
modifier|*
modifier|*
name|pp_doorbell
parameter_list|)
block|{
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
comment|/* TODO - set tc in the pq_params for multi-cos */
name|rc
operator|=
name|ecore_eth_txq_start_ramrod
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|pbl_addr
argument_list|,
name|pbl_size
argument_list|,
name|ecore_get_cm_pq_idx_mcos
argument_list|(
name|p_hwfn
argument_list|,
name|tc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Provide the caller with the necessary return values */
operator|*
name|pp_doorbell
operator|=
operator|(
name|u8
name|OSAL_IOMEM
operator|*
operator|)
name|p_hwfn
operator|->
name|doorbells
operator|+
name|DB_ADDR
argument_list|(
name|p_cid
operator|->
name|cid
argument_list|,
name|DQ_DEMS_LEGACY
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_eth_tx_queue_start
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|struct
name|ecore_queue_start_common_params
modifier|*
name|p_params
parameter_list|,
name|u8
name|tc
parameter_list|,
name|dma_addr_t
name|pbl_addr
parameter_list|,
name|u16
name|pbl_size
parameter_list|,
name|struct
name|ecore_txq_start_ret_params
modifier|*
name|p_ret_params
parameter_list|)
block|{
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
name|p_cid
operator|=
name|ecore_eth_queue_to_cid_pf
argument_list|(
name|p_hwfn
argument_list|,
name|opaque_fid
argument_list|,
name|p_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_cid
operator|==
name|OSAL_NULL
condition|)
return|return
name|ECORE_INVAL
return|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
name|rc
operator|=
name|ecore_eth_pf_tx_queue_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|tc
argument_list|,
name|pbl_addr
argument_list|,
name|pbl_size
argument_list|,
operator|&
name|p_ret_params
operator|->
name|p_doorbell
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|ecore_vf_pf_txq_start
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|,
name|pbl_addr
argument_list|,
name|pbl_size
argument_list|,
operator|&
name|p_ret_params
operator|->
name|p_doorbell
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
name|ecore_eth_queue_cid_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
else|else
name|p_ret_params
operator|->
name|p_handle
operator|=
operator|(
name|void
operator|*
operator|)
name|p_cid
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_eth_pf_tx_queue_stop
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
parameter_list|)
block|{
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|p_cid
operator|->
name|cid
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_cid
operator|->
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_EBLOCK
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_TX_QUEUE_STOP
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_eth_tx_queue_stop
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|void
modifier|*
name|p_handle
parameter_list|)
block|{
name|struct
name|ecore_queue_cid
modifier|*
name|p_cid
init|=
operator|(
expr|struct
name|ecore_queue_cid
operator|*
operator|)
name|p_handle
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
name|rc
operator|=
name|ecore_eth_pf_tx_queue_stop
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|ecore_vf_pf_txq_stop
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|ECORE_SUCCESS
condition|)
name|ecore_eth_queue_cid_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_cid
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|eth_filter_action
name|ecore_filter_action
parameter_list|(
name|enum
name|ecore_filter_opcode
name|opcode
parameter_list|)
block|{
name|enum
name|eth_filter_action
name|action
init|=
name|MAX_ETH_FILTER_ACTION
decl_stmt|;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|ECORE_FILTER_ADD
case|:
name|action
operator|=
name|ETH_FILTER_ACTION_ADD
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_REMOVE
case|:
name|action
operator|=
name|ETH_FILTER_ACTION_REMOVE
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_FLUSH
case|:
name|action
operator|=
name|ETH_FILTER_ACTION_REMOVE_ALL
expr_stmt|;
break|break;
default|default:
name|action
operator|=
name|MAX_ETH_FILTER_ACTION
expr_stmt|;
block|}
return|return
name|action
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_filter_ucast_common
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|struct
name|ecore_filter_ucast
modifier|*
name|p_filter_cmd
parameter_list|,
name|struct
name|vport_filter_update_ramrod_data
modifier|*
modifier|*
name|pp_ramrod
parameter_list|,
name|struct
name|ecore_spq_entry
modifier|*
modifier|*
name|pp_ent
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|u8
name|vport_to_add_to
init|=
literal|0
decl_stmt|,
name|vport_to_remove_from
init|=
literal|0
decl_stmt|;
name|struct
name|vport_filter_update_ramrod_data
modifier|*
name|p_ramrod
decl_stmt|;
name|struct
name|eth_filter_cmd
modifier|*
name|p_first_filter
decl_stmt|;
name|struct
name|eth_filter_cmd
modifier|*
name|p_second_filter
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|enum
name|eth_filter_action
name|action
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_filter_cmd
operator|->
name|vport_to_remove_from
argument_list|,
operator|&
name|vport_to_remove_from
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_filter_cmd
operator|->
name|vport_to_add_to
argument_list|,
operator|&
name|vport_to_add_to
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|ecore_spq_get_cid
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|comp_mode
expr_stmt|;
name|init_data
operator|.
name|p_comp_data
operator|=
name|p_comp_data
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
name|pp_ent
argument_list|,
name|ETH_RAMROD_FILTERS_UPDATE
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
operator|*
name|pp_ramrod
operator|=
operator|&
operator|(
operator|*
name|pp_ent
operator|)
operator|->
name|ramrod
operator|.
name|vport_filter_update
expr_stmt|;
name|p_ramrod
operator|=
operator|*
name|pp_ramrod
expr_stmt|;
name|p_ramrod
operator|->
name|filter_cmd_hdr
operator|.
name|rx
operator|=
name|p_filter_cmd
operator|->
name|is_rx_filter
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|p_ramrod
operator|->
name|filter_cmd_hdr
operator|.
name|tx
operator|=
name|p_filter_cmd
operator|->
name|is_tx_filter
condition|?
literal|1
else|:
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|ASIC_ONLY
if|if
condition|(
name|CHIP_REV_IS_SLOW
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"Non-Asic - prevent Tx filters\n"
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|filter_cmd_hdr
operator|.
name|tx
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|p_filter_cmd
operator|->
name|opcode
condition|)
block|{
case|case
name|ECORE_FILTER_REPLACE
case|:
case|case
name|ECORE_FILTER_MOVE
case|:
name|p_ramrod
operator|->
name|filter_cmd_hdr
operator|.
name|cmd_cnt
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
name|p_ramrod
operator|->
name|filter_cmd_hdr
operator|.
name|cmd_cnt
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|p_first_filter
operator|=
operator|&
name|p_ramrod
operator|->
name|filter_cmds
index|[
literal|0
index|]
expr_stmt|;
name|p_second_filter
operator|=
operator|&
name|p_ramrod
operator|->
name|filter_cmds
index|[
literal|1
index|]
expr_stmt|;
switch|switch
condition|(
name|p_filter_cmd
operator|->
name|type
condition|)
block|{
case|case
name|ECORE_FILTER_MAC
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_MAC
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_VLAN
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_VLAN
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_MAC_VLAN
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_PAIR
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_INNER_MAC
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_INNER_MAC
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_INNER_VLAN
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_INNER_VLAN
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_INNER_PAIR
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_INNER_PAIR
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_INNER_MAC_VNI_PAIR
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_INNER_MAC_VNI_PAIR
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_MAC_VNI_PAIR
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_MAC_VNI_PAIR
expr_stmt|;
break|break;
case|case
name|ECORE_FILTER_VNI
case|:
name|p_first_filter
operator|->
name|type
operator|=
name|ETH_FILTER_TYPE_VNI
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_MAC
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_PAIR
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_INNER_MAC
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_INNER_PAIR
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_INNER_MAC_VNI_PAIR
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_MAC_VNI_PAIR
operator|)
condition|)
name|ecore_set_fw_mac_addr
argument_list|(
operator|&
name|p_first_filter
operator|->
name|mac_msb
argument_list|,
operator|&
name|p_first_filter
operator|->
name|mac_mid
argument_list|,
operator|&
name|p_first_filter
operator|->
name|mac_lsb
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|p_filter_cmd
operator|->
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_VLAN
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_PAIR
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_INNER_VLAN
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_INNER_PAIR
operator|)
condition|)
name|p_first_filter
operator|->
name|vlan_id
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|p_filter_cmd
operator|->
name|vlan
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_INNER_MAC_VNI_PAIR
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_MAC_VNI_PAIR
operator|)
operator|||
operator|(
name|p_first_filter
operator|->
name|type
operator|==
name|ETH_FILTER_TYPE_VNI
operator|)
condition|)
name|p_first_filter
operator|->
name|vni
operator|=
name|OSAL_CPU_TO_LE32
argument_list|(
name|p_filter_cmd
operator|->
name|vni
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_MOVE
condition|)
block|{
name|p_second_filter
operator|->
name|type
operator|=
name|p_first_filter
operator|->
name|type
expr_stmt|;
name|p_second_filter
operator|->
name|mac_msb
operator|=
name|p_first_filter
operator|->
name|mac_msb
expr_stmt|;
name|p_second_filter
operator|->
name|mac_mid
operator|=
name|p_first_filter
operator|->
name|mac_mid
expr_stmt|;
name|p_second_filter
operator|->
name|mac_lsb
operator|=
name|p_first_filter
operator|->
name|mac_lsb
expr_stmt|;
name|p_second_filter
operator|->
name|vlan_id
operator|=
name|p_first_filter
operator|->
name|vlan_id
expr_stmt|;
name|p_second_filter
operator|->
name|vni
operator|=
name|p_first_filter
operator|->
name|vni
expr_stmt|;
name|p_first_filter
operator|->
name|action
operator|=
name|ETH_FILTER_ACTION_REMOVE
expr_stmt|;
name|p_first_filter
operator|->
name|vport_id
operator|=
name|vport_to_remove_from
expr_stmt|;
name|p_second_filter
operator|->
name|action
operator|=
name|ETH_FILTER_ACTION_ADD
expr_stmt|;
name|p_second_filter
operator|->
name|vport_id
operator|=
name|vport_to_add_to
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_REPLACE
condition|)
block|{
name|p_first_filter
operator|->
name|vport_id
operator|=
name|vport_to_add_to
expr_stmt|;
name|OSAL_MEMCPY
argument_list|(
name|p_second_filter
argument_list|,
name|p_first_filter
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p_second_filter
argument_list|)
argument_list|)
expr_stmt|;
name|p_first_filter
operator|->
name|action
operator|=
name|ETH_FILTER_ACTION_REMOVE_ALL
expr_stmt|;
name|p_second_filter
operator|->
name|action
operator|=
name|ETH_FILTER_ACTION_ADD
expr_stmt|;
block|}
else|else
block|{
name|action
operator|=
name|ecore_filter_action
argument_list|(
name|p_filter_cmd
operator|->
name|opcode
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|MAX_ETH_FILTER_ACTION
condition|)
block|{
name|DP_NOTICE
argument_list|(
name|p_hwfn
argument_list|,
name|true
argument_list|,
literal|"%d is not supported yet\n"
argument_list|,
name|p_filter_cmd
operator|->
name|opcode
argument_list|)
expr_stmt|;
return|return
name|ECORE_NOTIMPL
return|;
block|}
name|p_first_filter
operator|->
name|action
operator|=
name|action
expr_stmt|;
name|p_first_filter
operator|->
name|vport_id
operator|=
operator|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_REMOVE
operator|)
condition|?
name|vport_to_remove_from
else|:
name|vport_to_add_to
expr_stmt|;
block|}
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_sp_eth_filter_ucast
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u16
name|opaque_fid
parameter_list|,
name|struct
name|ecore_filter_ucast
modifier|*
name|p_filter_cmd
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|struct
name|vport_filter_update_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|eth_filter_cmd_header
modifier|*
name|p_header
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
name|rc
operator|=
name|ecore_filter_ucast_common
argument_list|(
name|p_hwfn
argument_list|,
name|opaque_fid
argument_list|,
name|p_filter_cmd
argument_list|,
operator|&
name|p_ramrod
argument_list|,
operator|&
name|p_ent
argument_list|,
name|comp_mode
argument_list|,
name|p_comp_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Uni. filter command failed %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|p_header
operator|=
operator|&
name|p_ramrod
operator|->
name|filter_cmd_hdr
expr_stmt|;
name|p_header
operator|->
name|assert_on_error
operator|=
name|p_filter_cmd
operator|->
name|assert_on_error
expr_stmt|;
name|rc
operator|=
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Unicast filter ADD command failed %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"Unicast filter configured, opcode = %s, type = %s, cmd_cnt = %d, is_rx_filter = %d, is_tx_filter = %d\n"
argument_list|,
operator|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_ADD
operator|)
condition|?
literal|"ADD"
else|:
operator|(
operator|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_REMOVE
operator|)
condition|?
literal|"REMOVE"
else|:
operator|(
operator|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_MOVE
operator|)
condition|?
literal|"MOVE"
else|:
literal|"REPLACE"
operator|)
operator|)
argument_list|,
operator|(
name|p_filter_cmd
operator|->
name|type
operator|==
name|ECORE_FILTER_MAC
operator|)
condition|?
literal|"MAC"
else|:
operator|(
operator|(
name|p_filter_cmd
operator|->
name|type
operator|==
name|ECORE_FILTER_VLAN
operator|)
condition|?
literal|"VLAN"
else|:
literal|"MAC& VLAN"
operator|)
argument_list|,
name|p_ramrod
operator|->
name|filter_cmd_hdr
operator|.
name|cmd_cnt
argument_list|,
name|p_filter_cmd
operator|->
name|is_rx_filter
argument_list|,
name|p_filter_cmd
operator|->
name|is_tx_filter
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"vport_to_add_to = %d, vport_to_remove_from = %d, mac = %2x:%2x:%2x:%2x:%2x:%2x, vlan = %d\n"
argument_list|,
name|p_filter_cmd
operator|->
name|vport_to_add_to
argument_list|,
name|p_filter_cmd
operator|->
name|vport_to_remove_from
argument_list|,
name|p_filter_cmd
operator|->
name|mac
index|[
literal|0
index|]
argument_list|,
name|p_filter_cmd
operator|->
name|mac
index|[
literal|1
index|]
argument_list|,
name|p_filter_cmd
operator|->
name|mac
index|[
literal|2
index|]
argument_list|,
name|p_filter_cmd
operator|->
name|mac
index|[
literal|3
index|]
argument_list|,
name|p_filter_cmd
operator|->
name|mac
index|[
literal|4
index|]
argument_list|,
name|p_filter_cmd
operator|->
name|mac
index|[
literal|5
index|]
argument_list|,
name|p_filter_cmd
operator|->
name|vlan
argument_list|)
expr_stmt|;
return|return
name|ECORE_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/*******************************************************************************  * Description:  *         Calculates crc 32 on a buffer  *         Note: crc32_length MUST be aligned to 8  * Return:  ******************************************************************************/
end_comment

begin_function
specifier|static
name|u32
name|ecore_calc_crc32c
parameter_list|(
name|u8
modifier|*
name|crc32_packet
parameter_list|,
name|u32
name|crc32_length
parameter_list|,
name|u32
name|crc32_seed
parameter_list|)
block|{
name|u32
name|byte
init|=
literal|0
decl_stmt|,
name|bit
init|=
literal|0
decl_stmt|,
name|crc32_result
init|=
name|crc32_seed
decl_stmt|;
name|u8
name|msb
init|=
literal|0
decl_stmt|,
name|current_byte
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|crc32_packet
operator|==
name|OSAL_NULL
operator|)
operator|||
operator|(
name|crc32_length
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|crc32_length
operator|%
literal|8
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
return|return
name|crc32_result
return|;
block|}
for|for
control|(
name|byte
operator|=
literal|0
init|;
name|byte
operator|<
name|crc32_length
condition|;
name|byte
operator|++
control|)
block|{
name|current_byte
operator|=
name|crc32_packet
index|[
name|byte
index|]
expr_stmt|;
for|for
control|(
name|bit
operator|=
literal|0
init|;
name|bit
operator|<
literal|8
condition|;
name|bit
operator|++
control|)
block|{
name|msb
operator|=
call|(
name|u8
call|)
argument_list|(
name|crc32_result
operator|>>
literal|31
argument_list|)
expr_stmt|;
name|crc32_result
operator|=
name|crc32_result
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|msb
operator|!=
operator|(
literal|0x1
operator|&
operator|(
name|current_byte
operator|>>
name|bit
operator|)
operator|)
condition|)
block|{
name|crc32_result
operator|=
name|crc32_result
operator|^
name|CRC32_POLY
expr_stmt|;
name|crc32_result
operator||=
literal|1
expr_stmt|;
comment|/*crc32_result[0] = 1;*/
block|}
block|}
block|}
return|return
name|crc32_result
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|ecore_crc32c_le
parameter_list|(
name|u32
name|seed
parameter_list|,
name|u8
modifier|*
name|mac
parameter_list|)
block|{
name|u32
name|packet_buf
index|[
literal|2
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|OSAL_MEMCPY
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|(
operator|&
name|packet_buf
index|[
literal|0
index|]
operator|)
argument_list|,
operator|&
name|mac
index|[
literal|0
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
return|return
name|ecore_calc_crc32c
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|packet_buf
argument_list|,
literal|8
argument_list|,
name|seed
argument_list|)
return|;
block|}
end_function

begin_function
name|u8
name|ecore_mcast_bin_from_mac
parameter_list|(
name|u8
modifier|*
name|mac
parameter_list|)
block|{
name|u32
name|crc
init|=
name|ecore_crc32c_le
argument_list|(
name|ETH_MULTICAST_BIN_FROM_MAC_SEED
argument_list|,
name|mac
argument_list|)
decl_stmt|;
return|return
name|crc
operator|&
literal|0xff
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|_ecore_status_t
name|ecore_sp_eth_filter_mcast
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_filter_mcast
modifier|*
name|p_filter_cmd
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|unsigned
name|long
name|bins
index|[
name|ETH_MULTICAST_MAC_BINS_IN_REGS
index|]
decl_stmt|;
name|struct
name|vport_update_ramrod_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|u8
name|abs_vport_id
init|=
literal|0
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_ADD
condition|)
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_filter_cmd
operator|->
name|vport_to_add_to
argument_list|,
operator|&
name|abs_vport_id
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|p_filter_cmd
operator|->
name|vport_to_remove_from
argument_list|,
operator|&
name|abs_vport_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|ecore_spq_get_cid
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
expr_stmt|;
name|init_data
operator|.
name|comp_mode
operator|=
name|comp_mode
expr_stmt|;
name|init_data
operator|.
name|p_comp_data
operator|=
name|p_comp_data
expr_stmt|;
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_VPORT_UPDATE
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Multi-cast command failed %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|vport_update
expr_stmt|;
name|p_ramrod
operator|->
name|common
operator|.
name|update_approx_mcast_flg
operator|=
literal|1
expr_stmt|;
comment|/* explicitly clear out the entire vector */
name|OSAL_MEMSET
argument_list|(
operator|&
name|p_ramrod
operator|->
name|approx_mcast
operator|.
name|bins
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p_ramrod
operator|->
name|approx_mcast
operator|.
name|bins
argument_list|)
argument_list|)
expr_stmt|;
name|OSAL_MEMSET
argument_list|(
name|bins
argument_list|,
literal|0
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
operator|*
name|ETH_MULTICAST_MAC_BINS_IN_REGS
argument_list|)
expr_stmt|;
comment|/* filter ADD op is explicit set op and it removes 	*  any existing filters for the vport. 	*/
if|if
condition|(
name|p_filter_cmd
operator|->
name|opcode
operator|==
name|ECORE_FILTER_ADD
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_filter_cmd
operator|->
name|num_mc_addrs
condition|;
name|i
operator|++
control|)
block|{
name|u32
name|bit
decl_stmt|;
name|bit
operator|=
name|ecore_mcast_bin_from_mac
argument_list|(
name|p_filter_cmd
operator|->
name|mac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OSAL_SET_BIT
argument_list|(
name|bit
argument_list|,
name|bins
argument_list|)
expr_stmt|;
block|}
comment|/* Convert to correct endianity */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETH_MULTICAST_MAC_BINS_IN_REGS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|vport_update_ramrod_mcast
modifier|*
name|p_ramrod_bins
decl_stmt|;
name|u32
modifier|*
name|p_bins
init|=
operator|(
name|u32
operator|*
operator|)
name|bins
decl_stmt|;
name|p_ramrod_bins
operator|=
operator|&
name|p_ramrod
operator|->
name|approx_mcast
expr_stmt|;
name|p_ramrod_bins
operator|->
name|bins
index|[
name|i
index|]
operator|=
name|OSAL_CPU_TO_LE32
argument_list|(
name|p_bins
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|p_ramrod
operator|->
name|common
operator|.
name|vport_id
operator|=
name|abs_vport_id
expr_stmt|;
name|rc
operator|=
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Multicast filter command failed %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_filter_mcast_cmd
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|p_dev
parameter_list|,
name|struct
name|ecore_filter_mcast
modifier|*
name|p_filter_cmd
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* only ADD and REMOVE operations are supported for multi-cast */
if|if
condition|(
operator|(
name|p_filter_cmd
operator|->
name|opcode
operator|!=
name|ECORE_FILTER_ADD
operator|&&
operator|(
name|p_filter_cmd
operator|->
name|opcode
operator|!=
name|ECORE_FILTER_REMOVE
operator|)
operator|)
operator|||
operator|(
name|p_filter_cmd
operator|->
name|num_mc_addrs
operator|>
name|ECORE_MAX_MC_ADDRS
operator|)
condition|)
block|{
return|return
name|ECORE_INVAL
return|;
block|}
name|for_each_hwfn
argument_list|(
argument|p_dev
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|p_dev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|IS_VF
argument_list|(
name|p_dev
argument_list|)
condition|)
block|{
name|ecore_vf_pf_filter_mcast
argument_list|(
name|p_hwfn
argument_list|,
name|p_filter_cmd
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|rc
operator|=
name|ecore_sp_eth_filter_mcast
argument_list|(
name|p_hwfn
argument_list|,
name|p_filter_cmd
argument_list|,
name|comp_mode
argument_list|,
name|p_comp_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
break|break;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_filter_ucast_cmd
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|p_dev
parameter_list|,
name|struct
name|ecore_filter_ucast
modifier|*
name|p_filter_cmd
parameter_list|,
name|enum
name|spq_mode
name|comp_mode
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_comp_data
parameter_list|)
block|{
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_SUCCESS
decl_stmt|;
name|int
name|i
decl_stmt|;
name|for_each_hwfn
argument_list|(
argument|p_dev
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|p_dev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|u16
name|opaque_fid
decl_stmt|;
if|if
condition|(
name|IS_VF
argument_list|(
name|p_dev
argument_list|)
condition|)
block|{
name|rc
operator|=
name|ecore_vf_pf_filter_ucast
argument_list|(
name|p_hwfn
argument_list|,
name|p_filter_cmd
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|opaque_fid
operator|=
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
expr_stmt|;
name|rc
operator|=
name|ecore_sp_eth_filter_ucast
argument_list|(
name|p_hwfn
argument_list|,
name|opaque_fid
argument_list|,
name|p_filter_cmd
argument_list|,
name|comp_mode
argument_list|,
name|p_comp_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
break|break;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/* Statistics related code */
end_comment

begin_function
specifier|static
name|void
name|__ecore_get_vport_pstats_addrlen
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u32
modifier|*
name|p_addr
parameter_list|,
name|u32
modifier|*
name|p_len
parameter_list|,
name|u16
name|statistics_bin
parameter_list|)
block|{
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
operator|*
name|p_addr
operator|=
name|BAR0_MAP_REG_PSDM_RAM
operator|+
name|PSTORM_QUEUE_STAT_OFFSET
argument_list|(
name|statistics_bin
argument_list|)
expr_stmt|;
operator|*
name|p_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eth_pstorm_per_queue_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ecore_vf_iov
modifier|*
name|p_iov
init|=
name|p_hwfn
operator|->
name|vf_iov_info
decl_stmt|;
name|struct
name|pfvf_acquire_resp_tlv
modifier|*
name|p_resp
init|=
operator|&
name|p_iov
operator|->
name|acquire_resp
decl_stmt|;
operator|*
name|p_addr
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|pstats
operator|.
name|address
expr_stmt|;
operator|*
name|p_len
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|pstats
operator|.
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|__ecore_get_vport_pstats
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|p_stats
parameter_list|,
name|u16
name|statistics_bin
parameter_list|)
block|{
name|struct
name|eth_pstorm_per_queue_stat
name|pstats
decl_stmt|;
name|u32
name|pstats_addr
init|=
literal|0
decl_stmt|,
name|pstats_len
init|=
literal|0
decl_stmt|;
name|__ecore_get_vport_pstats_addrlen
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|pstats_addr
argument_list|,
operator|&
name|pstats_len
argument_list|,
name|statistics_bin
argument_list|)
expr_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|pstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pstats
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|pstats
argument_list|,
name|pstats_addr
argument_list|,
name|pstats_len
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tx_ucast_bytes
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|pstats
operator|.
name|sent_ucast_bytes
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tx_mcast_bytes
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|pstats
operator|.
name|sent_mcast_bytes
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tx_bcast_bytes
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|pstats
operator|.
name|sent_bcast_bytes
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tx_ucast_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|pstats
operator|.
name|sent_ucast_pkts
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tx_mcast_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|pstats
operator|.
name|sent_mcast_pkts
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tx_bcast_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|pstats
operator|.
name|sent_bcast_pkts
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tx_err_drop_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|pstats
operator|.
name|error_drop_pkts
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|__ecore_get_vport_tstats
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|p_stats
parameter_list|)
block|{
name|struct
name|tstorm_per_port_stat
name|tstats
decl_stmt|;
name|u32
name|tstats_addr
decl_stmt|,
name|tstats_len
decl_stmt|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
name|tstats_addr
operator|=
name|BAR0_MAP_REG_TSDM_RAM
operator|+
name|TSTORM_PORT_STAT_OFFSET
argument_list|(
name|MFW_PORT
argument_list|(
name|p_hwfn
argument_list|)
argument_list|)
expr_stmt|;
name|tstats_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tstorm_per_port_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ecore_vf_iov
modifier|*
name|p_iov
init|=
name|p_hwfn
operator|->
name|vf_iov_info
decl_stmt|;
name|struct
name|pfvf_acquire_resp_tlv
modifier|*
name|p_resp
init|=
operator|&
name|p_iov
operator|->
name|acquire_resp
decl_stmt|;
name|tstats_addr
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|tstats
operator|.
name|address
expr_stmt|;
name|tstats_len
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|tstats
operator|.
name|len
expr_stmt|;
block|}
name|OSAL_MEMSET
argument_list|(
operator|&
name|tstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tstats
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|tstats
argument_list|,
name|tstats_addr
argument_list|,
name|tstats_len
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|mftag_filter_discards
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|tstats
operator|.
name|mftag_filter_discard
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|mac_filter_discards
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|tstats
operator|.
name|eth_mac_filter_discard
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|__ecore_get_vport_ustats_addrlen
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u32
modifier|*
name|p_addr
parameter_list|,
name|u32
modifier|*
name|p_len
parameter_list|,
name|u16
name|statistics_bin
parameter_list|)
block|{
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
operator|*
name|p_addr
operator|=
name|BAR0_MAP_REG_USDM_RAM
operator|+
name|USTORM_QUEUE_STAT_OFFSET
argument_list|(
name|statistics_bin
argument_list|)
expr_stmt|;
operator|*
name|p_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eth_ustorm_per_queue_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ecore_vf_iov
modifier|*
name|p_iov
init|=
name|p_hwfn
operator|->
name|vf_iov_info
decl_stmt|;
name|struct
name|pfvf_acquire_resp_tlv
modifier|*
name|p_resp
init|=
operator|&
name|p_iov
operator|->
name|acquire_resp
decl_stmt|;
operator|*
name|p_addr
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|ustats
operator|.
name|address
expr_stmt|;
operator|*
name|p_len
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|ustats
operator|.
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|__ecore_get_vport_ustats
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|p_stats
parameter_list|,
name|u16
name|statistics_bin
parameter_list|)
block|{
name|struct
name|eth_ustorm_per_queue_stat
name|ustats
decl_stmt|;
name|u32
name|ustats_addr
init|=
literal|0
decl_stmt|,
name|ustats_len
init|=
literal|0
decl_stmt|;
name|__ecore_get_vport_ustats_addrlen
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|ustats_addr
argument_list|,
operator|&
name|ustats_len
argument_list|,
name|statistics_bin
argument_list|)
expr_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|ustats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ustats
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|ustats
argument_list|,
name|ustats_addr
argument_list|,
name|ustats_len
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|rx_ucast_bytes
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|ustats
operator|.
name|rcv_ucast_bytes
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|rx_mcast_bytes
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|ustats
operator|.
name|rcv_mcast_bytes
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|rx_bcast_bytes
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|ustats
operator|.
name|rcv_bcast_bytes
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|rx_ucast_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|ustats
operator|.
name|rcv_ucast_pkts
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|rx_mcast_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|ustats
operator|.
name|rcv_mcast_pkts
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|rx_bcast_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|ustats
operator|.
name|rcv_bcast_pkts
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|__ecore_get_vport_mstats_addrlen
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|u32
modifier|*
name|p_addr
parameter_list|,
name|u32
modifier|*
name|p_len
parameter_list|,
name|u16
name|statistics_bin
parameter_list|)
block|{
if|if
condition|(
name|IS_PF
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
operator|*
name|p_addr
operator|=
name|BAR0_MAP_REG_MSDM_RAM
operator|+
name|MSTORM_QUEUE_STAT_OFFSET
argument_list|(
name|statistics_bin
argument_list|)
expr_stmt|;
operator|*
name|p_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eth_mstorm_per_queue_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ecore_vf_iov
modifier|*
name|p_iov
init|=
name|p_hwfn
operator|->
name|vf_iov_info
decl_stmt|;
name|struct
name|pfvf_acquire_resp_tlv
modifier|*
name|p_resp
init|=
operator|&
name|p_iov
operator|->
name|acquire_resp
decl_stmt|;
operator|*
name|p_addr
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|mstats
operator|.
name|address
expr_stmt|;
operator|*
name|p_len
operator|=
name|p_resp
operator|->
name|pfdev_info
operator|.
name|stats_info
operator|.
name|mstats
operator|.
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|__ecore_get_vport_mstats
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|p_stats
parameter_list|,
name|u16
name|statistics_bin
parameter_list|)
block|{
name|struct
name|eth_mstorm_per_queue_stat
name|mstats
decl_stmt|;
name|u32
name|mstats_addr
init|=
literal|0
decl_stmt|,
name|mstats_len
init|=
literal|0
decl_stmt|;
name|__ecore_get_vport_mstats_addrlen
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|mstats_addr
argument_list|,
operator|&
name|mstats_len
argument_list|,
name|statistics_bin
argument_list|)
expr_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|mstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mstats
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|mstats
argument_list|,
name|mstats_addr
argument_list|,
name|mstats_len
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|no_buff_discards
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|mstats
operator|.
name|no_buff_discard
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|packet_too_big_discard
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|mstats
operator|.
name|packet_too_big_discard
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|ttl0_discard
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|mstats
operator|.
name|ttl0_discard
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tpa_coalesced_pkts
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|mstats
operator|.
name|tpa_coalesced_pkts
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tpa_coalesced_events
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|mstats
operator|.
name|tpa_coalesced_events
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tpa_aborts_num
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|mstats
operator|.
name|tpa_aborts_num
argument_list|)
expr_stmt|;
name|p_stats
operator|->
name|common
operator|.
name|tpa_coalesced_bytes
operator|+=
name|HILO_64_REGPAIR
argument_list|(
name|mstats
operator|.
name|tpa_coalesced_bytes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|__ecore_get_vport_port_stats
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|p_stats
parameter_list|)
block|{
name|struct
name|ecore_eth_stats_common
modifier|*
name|p_common
init|=
operator|&
name|p_stats
operator|->
name|common
decl_stmt|;
name|struct
name|port_stats
name|port_stats
decl_stmt|;
name|int
name|j
decl_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|port_stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|port_stats
argument_list|)
argument_list|)
expr_stmt|;
name|ecore_memcpy_from
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
operator|&
name|port_stats
argument_list|,
name|p_hwfn
operator|->
name|mcp_info
operator|->
name|port_addr
operator|+
name|OFFSETOF
argument_list|(
expr|struct
name|public_port
argument_list|,
name|stats
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|port_stats
argument_list|)
argument_list|)
expr_stmt|;
name|p_common
operator|->
name|rx_64_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|r64
expr_stmt|;
name|p_common
operator|->
name|rx_65_to_127_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|r127
expr_stmt|;
name|p_common
operator|->
name|rx_128_to_255_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|r255
expr_stmt|;
name|p_common
operator|->
name|rx_256_to_511_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|r511
expr_stmt|;
name|p_common
operator|->
name|rx_512_to_1023_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|r1023
expr_stmt|;
name|p_common
operator|->
name|rx_1024_to_1518_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|r1518
expr_stmt|;
name|p_common
operator|->
name|rx_crc_errors
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rfcs
expr_stmt|;
name|p_common
operator|->
name|rx_mac_crtl_frames
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rxcf
expr_stmt|;
name|p_common
operator|->
name|rx_pause_frames
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rxpf
expr_stmt|;
name|p_common
operator|->
name|rx_pfc_frames
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rxpp
expr_stmt|;
name|p_common
operator|->
name|rx_align_errors
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|raln
expr_stmt|;
name|p_common
operator|->
name|rx_carrier_errors
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rfcr
expr_stmt|;
name|p_common
operator|->
name|rx_oversize_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rovr
expr_stmt|;
name|p_common
operator|->
name|rx_jabbers
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rjbr
expr_stmt|;
name|p_common
operator|->
name|rx_undersize_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rund
expr_stmt|;
name|p_common
operator|->
name|rx_fragments
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rfrg
expr_stmt|;
name|p_common
operator|->
name|tx_64_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|t64
expr_stmt|;
name|p_common
operator|->
name|tx_65_to_127_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|t127
expr_stmt|;
name|p_common
operator|->
name|tx_128_to_255_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|t255
expr_stmt|;
name|p_common
operator|->
name|tx_256_to_511_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|t511
expr_stmt|;
name|p_common
operator|->
name|tx_512_to_1023_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|t1023
expr_stmt|;
name|p_common
operator|->
name|tx_1024_to_1518_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|t1518
expr_stmt|;
name|p_common
operator|->
name|tx_pause_frames
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|txpf
expr_stmt|;
name|p_common
operator|->
name|tx_pfc_frames
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|txpp
expr_stmt|;
name|p_common
operator|->
name|rx_mac_bytes
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rbyte
expr_stmt|;
name|p_common
operator|->
name|rx_mac_uc_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rxuca
expr_stmt|;
name|p_common
operator|->
name|rx_mac_mc_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rxmca
expr_stmt|;
name|p_common
operator|->
name|rx_mac_bc_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rxbca
expr_stmt|;
name|p_common
operator|->
name|rx_mac_frames_ok
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|rxpok
expr_stmt|;
name|p_common
operator|->
name|tx_mac_bytes
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|tbyte
expr_stmt|;
name|p_common
operator|->
name|tx_mac_uc_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|txuca
expr_stmt|;
name|p_common
operator|->
name|tx_mac_mc_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|txmca
expr_stmt|;
name|p_common
operator|->
name|tx_mac_bc_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|txbca
expr_stmt|;
name|p_common
operator|->
name|tx_mac_ctrl_frames
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|txcf
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|p_common
operator|->
name|brb_truncates
operator|+=
name|port_stats
operator|.
name|brb
operator|.
name|brb_truncate
index|[
name|j
index|]
expr_stmt|;
name|p_common
operator|->
name|brb_discards
operator|+=
name|port_stats
operator|.
name|brb
operator|.
name|brb_discard
index|[
name|j
index|]
expr_stmt|;
block|}
if|if
condition|(
name|ECORE_IS_BB
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
block|{
name|struct
name|ecore_eth_stats_bb
modifier|*
name|p_bb
init|=
operator|&
name|p_stats
operator|->
name|bb
decl_stmt|;
name|p_bb
operator|->
name|rx_1519_to_1522_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u0
operator|.
name|bb0
operator|.
name|r1522
expr_stmt|;
name|p_bb
operator|->
name|rx_1519_to_2047_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u0
operator|.
name|bb0
operator|.
name|r2047
expr_stmt|;
name|p_bb
operator|->
name|rx_2048_to_4095_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u0
operator|.
name|bb0
operator|.
name|r4095
expr_stmt|;
name|p_bb
operator|->
name|rx_4096_to_9216_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u0
operator|.
name|bb0
operator|.
name|r9216
expr_stmt|;
name|p_bb
operator|->
name|rx_9217_to_16383_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u0
operator|.
name|bb0
operator|.
name|r16383
expr_stmt|;
name|p_bb
operator|->
name|tx_1519_to_2047_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u1
operator|.
name|bb1
operator|.
name|t2047
expr_stmt|;
name|p_bb
operator|->
name|tx_2048_to_4095_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u1
operator|.
name|bb1
operator|.
name|t4095
expr_stmt|;
name|p_bb
operator|->
name|tx_4096_to_9216_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u1
operator|.
name|bb1
operator|.
name|t9216
expr_stmt|;
name|p_bb
operator|->
name|tx_9217_to_16383_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u1
operator|.
name|bb1
operator|.
name|t16383
expr_stmt|;
name|p_bb
operator|->
name|tx_lpi_entry_count
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u2
operator|.
name|bb2
operator|.
name|tlpiec
expr_stmt|;
name|p_bb
operator|->
name|tx_total_collisions
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u2
operator|.
name|bb2
operator|.
name|tncl
expr_stmt|;
block|}
else|else
block|{
name|struct
name|ecore_eth_stats_ah
modifier|*
name|p_ah
init|=
operator|&
name|p_stats
operator|->
name|ah
decl_stmt|;
name|p_ah
operator|->
name|rx_1519_to_max_byte_packets
operator|+=
name|port_stats
operator|.
name|eth
operator|.
name|u0
operator|.
name|ah0
operator|.
name|r1519_to_max
expr_stmt|;
name|p_ah
operator|->
name|tx_1519_to_max_byte_packets
operator|=
name|port_stats
operator|.
name|eth
operator|.
name|u1
operator|.
name|ah1
operator|.
name|t1519_to_max
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|__ecore_get_vport_stats
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|stats
parameter_list|,
name|u16
name|statistics_bin
parameter_list|,
name|bool
name|b_get_port_stats
parameter_list|)
block|{
name|__ecore_get_vport_mstats
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|stats
argument_list|,
name|statistics_bin
argument_list|)
expr_stmt|;
name|__ecore_get_vport_ustats
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|stats
argument_list|,
name|statistics_bin
argument_list|)
expr_stmt|;
name|__ecore_get_vport_tstats
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|stats
argument_list|)
expr_stmt|;
name|__ecore_get_vport_pstats
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|stats
argument_list|,
name|statistics_bin
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|ASIC_ONLY
comment|/* Avoid getting PORT stats for emulation.*/
if|if
condition|(
name|CHIP_REV_IS_EMUL
argument_list|(
name|p_hwfn
operator|->
name|p_dev
argument_list|)
condition|)
return|return;
endif|#
directive|endif
if|if
condition|(
name|b_get_port_stats
operator|&&
name|p_hwfn
operator|->
name|mcp_info
condition|)
name|__ecore_get_vport_port_stats
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|stats
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|_ecore_get_vport_stats
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|p_dev
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|stats
parameter_list|)
block|{
name|u8
name|fw_vport
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|OSAL_MEMSET
argument_list|(
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stats
argument_list|)
argument_list|)
expr_stmt|;
name|for_each_hwfn
argument_list|(
argument|p_dev
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|p_dev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
init|=
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
condition|?
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
else|:
name|OSAL_NULL
decl_stmt|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
condition|)
block|{
comment|/* The main vport index is relative first */
if|if
condition|(
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
literal|0
argument_list|,
operator|&
name|fw_vport
argument_list|)
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"No vport available!\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
operator|&&
operator|!
name|p_ptt
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Failed to acquire ptt\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|__ecore_get_vport_stats
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|stats
argument_list|,
name|fw_vport
argument_list|,
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
condition|?
name|true
else|:
name|false
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
operator|&&
name|p_ptt
condition|)
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ecore_get_vport_stats
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|p_dev
parameter_list|,
name|struct
name|ecore_eth_stats
modifier|*
name|stats
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|p_dev
condition|)
block|{
name|OSAL_MEMSET
argument_list|(
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|stats
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|_ecore_get_vport_stats
argument_list|(
name|p_dev
argument_list|,
name|stats
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_dev
operator|->
name|reset_stats
condition|)
return|return;
comment|/* Reduce the statistics baseline */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ecore_eth_stats
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
condition|;
name|i
operator|++
control|)
operator|(
operator|(
name|u64
operator|*
operator|)
name|stats
operator|)
index|[
name|i
index|]
operator|-=
operator|(
operator|(
name|u64
operator|*
operator|)
name|p_dev
operator|->
name|reset_stats
operator|)
index|[
name|i
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/* zeroes V-PORT specific portion of stats (Port stats remains untouched) */
end_comment

begin_function
name|void
name|ecore_reset_vport_stats
parameter_list|(
name|struct
name|ecore_dev
modifier|*
name|p_dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|for_each_hwfn
argument_list|(
argument|p_dev
argument_list|,
argument|i
argument_list|)
block|{
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
init|=
operator|&
name|p_dev
operator|->
name|hwfns
index|[
name|i
index|]
decl_stmt|;
name|struct
name|eth_mstorm_per_queue_stat
name|mstats
decl_stmt|;
name|struct
name|eth_ustorm_per_queue_stat
name|ustats
decl_stmt|;
name|struct
name|eth_pstorm_per_queue_stat
name|pstats
decl_stmt|;
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
init|=
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
condition|?
name|ecore_ptt_acquire
argument_list|(
name|p_hwfn
argument_list|)
else|:
name|OSAL_NULL
decl_stmt|;
name|u32
name|addr
init|=
literal|0
decl_stmt|,
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
operator|&&
operator|!
name|p_ptt
condition|)
block|{
name|DP_ERR
argument_list|(
name|p_hwfn
argument_list|,
literal|"Failed to acquire ptt\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|OSAL_MEMSET
argument_list|(
operator|&
name|mstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mstats
argument_list|)
argument_list|)
expr_stmt|;
name|__ecore_get_vport_mstats_addrlen
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ecore_memcpy_to
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|addr
argument_list|,
operator|&
name|mstats
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|ustats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ustats
argument_list|)
argument_list|)
expr_stmt|;
name|__ecore_get_vport_ustats_addrlen
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ecore_memcpy_to
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|addr
argument_list|,
operator|&
name|ustats
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|OSAL_MEMSET
argument_list|(
operator|&
name|pstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pstats
argument_list|)
argument_list|)
expr_stmt|;
name|__ecore_get_vport_pstats_addrlen
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ecore_memcpy_to
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|addr
argument_list|,
operator|&
name|pstats
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_PF
argument_list|(
name|p_dev
argument_list|)
condition|)
name|ecore_ptt_release
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|)
expr_stmt|;
block|}
comment|/* PORT statistics are not necessarily reset, so we need to 	 * read and create a baseline for future statistics. 	 */
if|if
condition|(
operator|!
name|p_dev
operator|->
name|reset_stats
condition|)
name|DP_INFO
argument_list|(
name|p_dev
argument_list|,
literal|"Reset stats not allocated\n"
argument_list|)
expr_stmt|;
else|else
name|_ecore_get_vport_stats
argument_list|(
name|p_dev
argument_list|,
name|p_dev
operator|->
name|reset_stats
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ecore_arfs_mode_configure
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_ptt
modifier|*
name|p_ptt
parameter_list|,
name|struct
name|ecore_arfs_config_params
modifier|*
name|p_cfg_params
parameter_list|)
block|{
if|if
condition|(
name|p_cfg_params
operator|->
name|arfs_enable
condition|)
block|{
name|ecore_set_rfs_mode_enable
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_hwfn
operator|->
name|rel_pf_id
argument_list|,
name|p_cfg_params
operator|->
name|tcp
argument_list|,
name|p_cfg_params
operator|->
name|udp
argument_list|,
name|p_cfg_params
operator|->
name|ipv4
argument_list|,
name|p_cfg_params
operator|->
name|ipv6
argument_list|)
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"tcp = %s, udp = %s, ipv4 = %s, ipv6 =%s\n"
argument_list|,
name|p_cfg_params
operator|->
name|tcp
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|,
name|p_cfg_params
operator|->
name|udp
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|,
name|p_cfg_params
operator|->
name|ipv4
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|,
name|p_cfg_params
operator|->
name|ipv6
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ecore_set_rfs_mode_disable
argument_list|(
name|p_hwfn
argument_list|,
name|p_ptt
argument_list|,
name|p_hwfn
operator|->
name|rel_pf_id
argument_list|)
expr_stmt|;
block|}
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"Configured ARFS mode : %s\n"
argument_list|,
name|p_cfg_params
operator|->
name|arfs_enable
condition|?
literal|"Enable"
else|:
literal|"Disable"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|enum
name|_ecore_status_t
name|ecore_configure_rfs_ntuple_filter
parameter_list|(
name|struct
name|ecore_hwfn
modifier|*
name|p_hwfn
parameter_list|,
name|struct
name|ecore_spq_comp_cb
modifier|*
name|p_cb
parameter_list|,
name|dma_addr_t
name|p_addr
parameter_list|,
name|u16
name|length
parameter_list|,
name|u16
name|qid
parameter_list|,
name|u8
name|vport_id
parameter_list|,
name|bool
name|b_is_add
parameter_list|)
block|{
name|struct
name|rx_update_gft_filter_data
modifier|*
name|p_ramrod
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_spq_entry
modifier|*
name|p_ent
init|=
name|OSAL_NULL
decl_stmt|;
name|struct
name|ecore_sp_init_data
name|init_data
decl_stmt|;
name|u16
name|abs_rx_q_id
init|=
literal|0
decl_stmt|;
name|u8
name|abs_vport_id
init|=
literal|0
decl_stmt|;
name|enum
name|_ecore_status_t
name|rc
init|=
name|ECORE_NOTIMPL
decl_stmt|;
name|rc
operator|=
name|ecore_fw_vport
argument_list|(
name|p_hwfn
argument_list|,
name|vport_id
argument_list|,
operator|&
name|abs_vport_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|ecore_fw_l2_queue
argument_list|(
name|p_hwfn
argument_list|,
name|qid
argument_list|,
operator|&
name|abs_rx_q_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
comment|/* Get SPQ entry */
name|OSAL_MEMSET
argument_list|(
operator|&
name|init_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_data
argument_list|)
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|cid
operator|=
name|ecore_spq_get_cid
argument_list|(
name|p_hwfn
argument_list|)
expr_stmt|;
name|init_data
operator|.
name|opaque_fid
operator|=
name|p_hwfn
operator|->
name|hw_info
operator|.
name|opaque_fid
expr_stmt|;
if|if
condition|(
name|p_cb
condition|)
block|{
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_CB
expr_stmt|;
name|init_data
operator|.
name|p_comp_data
operator|=
name|p_cb
expr_stmt|;
block|}
else|else
block|{
name|init_data
operator|.
name|comp_mode
operator|=
name|ECORE_SPQ_MODE_EBLOCK
expr_stmt|;
block|}
name|rc
operator|=
name|ecore_sp_init_request
argument_list|(
name|p_hwfn
argument_list|,
operator|&
name|p_ent
argument_list|,
name|ETH_RAMROD_GFT_UPDATE_FILTER
argument_list|,
name|PROTOCOLID_ETH
argument_list|,
operator|&
name|init_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|ECORE_SUCCESS
condition|)
return|return
name|rc
return|;
name|p_ramrod
operator|=
operator|&
name|p_ent
operator|->
name|ramrod
operator|.
name|rx_update_gft
expr_stmt|;
name|DMA_REGPAIR_LE
argument_list|(
name|p_ramrod
operator|->
name|pkt_hdr_addr
argument_list|,
name|p_addr
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|pkt_hdr_length
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|rx_qid_or_action_icid
operator|=
name|OSAL_CPU_TO_LE16
argument_list|(
name|abs_rx_q_id
argument_list|)
expr_stmt|;
name|p_ramrod
operator|->
name|vport_id
operator|=
name|abs_vport_id
expr_stmt|;
name|p_ramrod
operator|->
name|filter_type
operator|=
name|RFS_FILTER_TYPE
expr_stmt|;
name|p_ramrod
operator|->
name|filter_action
operator|=
name|b_is_add
condition|?
name|GFT_ADD_FILTER
else|:
name|GFT_DELETE_FILTER
expr_stmt|;
name|DP_VERBOSE
argument_list|(
name|p_hwfn
argument_list|,
name|ECORE_MSG_SP
argument_list|,
literal|"V[%0x], Q[%04x] - %s filter from 0x%llx [length %04xb]\n"
argument_list|,
name|abs_vport_id
argument_list|,
name|abs_rx_q_id
argument_list|,
name|b_is_add
condition|?
literal|"Adding"
else|:
literal|"Removing"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|p_addr
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
name|ecore_spq_post
argument_list|(
name|p_hwfn
argument_list|,
name|p_ent
argument_list|,
name|OSAL_NULL
argument_list|)
return|;
block|}
end_function

end_unit


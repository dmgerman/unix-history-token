begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2014, LSI Corp.  * All rights reserved.  * Author: Kashyap Desai, Sibananda Sahu  * Support: freebsdraid@lsi.com  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  * 3. Neither the name of the<ORGANIZATION> nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE  * COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  * The views and conclusions contained in the software and documentation  * are those of the authors and should not be interpreted as representing  * official policies,either expressed or implied, of the FreeBSD Project.  *  * Send feedback to:<megaraidfbsd@lsi.com>  * Mail to: LSI Corporation, 1621 Barber Lane, Milpitas, CA 95035  *    ATTN: MegaRaid FreeBSD  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
operator|<
operator|!
operator|--
name|$FreeBSD$
operator|--
operator|>
include|#
directive|include
file|<sys/param.h>
include|#
directive|include
file|<sys/systm.h>
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>
literal|900000
operator|)
include|#
directive|include
file|<sys/capability.h>
endif|#
directive|endif
include|#
directive|include
file|<sys/conf.h>
include|#
directive|include
file|<sys/kernel.h>
include|#
directive|include
file|<sys/module.h>
include|#
directive|include
file|<sys/file.h>
include|#
directive|include
file|<sys/proc.h>
include|#
directive|include
file|<machine/bus.h>
if|#
directive|if
name|defined
argument_list|(
name|__amd64__
argument_list|)
comment|/* Assume amd64 wants 32 bit Linux */
include|#
directive|include
file|<machine/../linux32/linux.h>
include|#
directive|include
file|<machine/../linux32/linux32_proto.h>
else|#
directive|else
include|#
directive|include
file|<machine/../linux/linux.h>
include|#
directive|include
file|<machine/../linux/linux_proto.h>
endif|#
directive|endif
include|#
directive|include
file|<compat/linux/linux_ioctl.h>
include|#
directive|include
file|<compat/linux/linux_util.h>
include|#
directive|include
file|<dev/mrsas/mrsas.h>
include|#
directive|include
file|<dev/mrsas/mrsas_ioctl.h>
comment|/* There are multiple ioctl number ranges that need to be handled */
define|#
directive|define
name|MRSAS_LINUX_IOCTL_MIN
value|0x4d00
define|#
directive|define
name|MRSAS_LINUX_IOCTL_MAX
value|0x4d01
specifier|static
name|linux_ioctl_function_t
name|mrsas_linux_ioctl
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|mrsas_linux_handler
init|=
block|{
name|mrsas_linux_ioctl
block|,
name|MRSAS_LINUX_IOCTL_MIN
block|,
name|MRSAS_LINUX_IOCTL_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSINIT
argument_list|(
name|mrsas_register
argument_list|,
name|SI_SUB_KLD
argument_list|,
name|SI_ORDER_MIDDLE
argument_list|,
name|linux_ioctl_register_handler
argument_list|,
operator|&
name|mrsas_linux_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSUNINIT
argument_list|(
name|mrsas_unregister
argument_list|,
name|SI_SUB_KLD
argument_list|,
name|SI_ORDER_MIDDLE
argument_list|,
name|linux_ioctl_unregister_handler
argument_list|,
operator|&
name|mrsas_linux_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_device_handler
name|mrsas_device_handler
init|=
block|{
literal|"mrsas"
block|,
literal|"megaraid_sas"
block|,
literal|"mrsas0"
block|,
literal|"megaraid_sas_ioctl_node"
block|,
operator|-
literal|1
block|,
literal|0
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSINIT
argument_list|(
name|mrsas_register2
argument_list|,
name|SI_SUB_KLD
argument_list|,
name|SI_ORDER_MIDDLE
argument_list|,
name|linux_device_register_handler
argument_list|,
operator|&
name|mrsas_device_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSUNINIT
argument_list|(
name|mrsas_unregister2
argument_list|,
name|SI_SUB_KLD
argument_list|,
name|SI_ORDER_MIDDLE
argument_list|,
name|linux_device_unregister_handler
argument_list|,
operator|&
name|mrsas_device_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|mrsas_linux_modevent
parameter_list|(
name|module_t
name|mod
name|__unused
parameter_list|,
name|int
name|cmd
name|__unused
parameter_list|,
name|void
modifier|*
name|data
name|__unused
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mrsas_linux_ioctl
parameter_list|(
name|struct
name|thread
modifier|*
name|p
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1000000
operator|)
name|cap_rights_t
name|rights
decl_stmt|;
endif|#
directive|endif
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_long
name|cmd
init|=
name|args
operator|->
name|cmd
decl_stmt|;
if|if
condition|(
name|cmd
operator|!=
name|MRSAS_LINUX_CMD32
condition|)
block|{
name|error
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|END
goto|;
block|}
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1000000
operator|)
name|error
operator|=
name|fget
argument_list|(
name|p
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|(
name|__FreeBSD_version
operator|<=
literal|900000
operator|)
name|error
operator|=
name|fget
argument_list|(
name|p
argument_list|,
name|args
operator|->
name|fd
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* For FreeBSD version greater than 9.0.0 but less than 10.0.0 */
name|error
operator|=
name|fget
argument_list|(
name|p
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|CAP_IOCTL
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|END
goto|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|cmd
argument_list|,
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|arg
argument_list|,
name|p
operator|->
name|td_ucred
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|END
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|DEV_MODULE
argument_list|(
name|mrsas_linux
argument_list|,
name|mrsas_linux_modevent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mrsas
argument_list|,
name|linux
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2011 Spectra Logic Corporation  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions, and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    substantially similar to the "NO WARRANTY" disclaimer below  *    ("Disclaimer") and any redistribution must be conditioned upon  *    including a substantially similar Disclaimer requirement for further  *    binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGES.  *  * Authors: Justin T. Gibbs     (Spectra Logic Corporation)  *          Alan Somers         (Spectra Logic Corporation)  *          John Suykerbuyk     (Spectra Logic Corporation)  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * \file netback_unit_tests.c  *  * \brief Unit tests for the Xen netback driver.  *  * Due to the driver's use of static functions, these tests cannot be compiled  * standalone; they must be #include'd from the driver's .c file.  */
end_comment

begin_comment
comment|/** Helper macro used to snprintf to a buffer and update the buffer pointer */
end_comment

begin_define
define|#
directive|define
name|SNCATF
parameter_list|(
name|buffer
parameter_list|,
name|buflen
parameter_list|,
modifier|...
parameter_list|)
value|do {				\ 	size_t new_chars = snprintf(buffer, buflen, __VA_ARGS__);	\ 	buffer += new_chars;						\
comment|/* be careful; snprintf's return value can be> buflen */
value|\ 	buflen -= MIN(buflen, new_chars);				\ } while (0)
end_define

begin_comment
comment|/* STRINGIFY and TOSTRING are used only to help turn __LINE__ into a string */
end_comment

begin_define
define|#
directive|define
name|STRINGIFY
parameter_list|(
name|x
parameter_list|)
value|#x
end_define

begin_define
define|#
directive|define
name|TOSTRING
parameter_list|(
name|x
parameter_list|)
value|STRINGIFY(x)
end_define

begin_comment
comment|/**  * Writes an error message to buffer if cond is false  * Note the implied parameters buffer and  * buflen  */
end_comment

begin_define
define|#
directive|define
name|XNB_ASSERT
parameter_list|(
name|cond
parameter_list|)
value|({						\ 	int passed = (cond);						\ 	char *_buffer = (buffer);					\ 	size_t _buflen = (buflen);					\ 	if (! passed) {							\ 		strlcat(_buffer, __func__, _buflen);			\ 		strlcat(_buffer, ":" TOSTRING(__LINE__) 		\ 		  " Assertion Error: " #cond "\n", _buflen);		\ 	}								\ 	})
end_define

begin_comment
comment|/**  * The signature used by all testcases.  If the test writes anything  * to buffer, then it will be considered a failure  * \param buffer	Return storage for error messages  * \param buflen	The space available in the buffer  */
end_comment

begin_typedef
typedef|typedef
name|void
name|testcase_t
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/**  * Signature used by setup functions  * \return nonzero on error  */
end_comment

begin_typedef
typedef|typedef
name|int
name|setup_t
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|void
name|teardown_t
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/** A simple test fixture comprising setup, teardown, and test */
end_comment

begin_struct
struct|struct
name|test_fixture
block|{
comment|/** Will be run before the test to allocate and initialize variables */
name|setup_t
modifier|*
name|setup
decl_stmt|;
comment|/** Will be run if setup succeeds */
name|testcase_t
modifier|*
name|test
decl_stmt|;
comment|/** Cleans up test data whether or not the setup suceeded*/
name|teardown_t
modifier|*
name|teardown
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|test_fixture
name|test_fixture_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|int
name|xnb_get1pkt
parameter_list|(
name|struct
name|xnb_pkt
modifier|*
name|pkt
parameter_list|,
name|size_t
name|size
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|xnb_unit_test_runner
parameter_list|(
name|test_fixture_t
specifier|const
name|tests
index|[]
parameter_list|,
name|int
name|ntests
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|__unused
name|null_setup
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__unused
name|null_teardown
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

begin_decl_stmt
specifier|static
name|setup_t
name|setup_pvt_data
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|teardown_t
name|teardown_pvt_data
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_ring2pkt_emptyring
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_ring2pkt_1req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_ring2pkt_2req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_ring2pkt_3req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_ring2pkt_extra
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_ring2pkt_partial
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_ring2pkt_wraps
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2rsp_emptypkt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2rsp_1req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2rsp_extra
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2rsp_long
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2rsp_invalid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2rsp_error
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2rsp_wraps
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_pkt2mbufc_empty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_pkt2mbufc_short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_pkt2mbufc_csum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_pkt2mbufc_1cluster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_pkt2mbufc_largecluster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_pkt2mbufc_2cluster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2gnttab_empty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2gnttab_short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2gnttab_2req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_txpkt2gnttab_2cluster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_update_mbufc_short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_update_mbufc_2req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_update_mbufc_2cluster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_mbufc2pkt_empty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_mbufc2pkt_short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_mbufc2pkt_1cluster
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_mbufc2pkt_2short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_mbufc2pkt_long
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_mbufc2pkt_extra
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_mbufc2pkt_nospace
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2gnttab_empty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2gnttab_short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2gnttab_2req
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2rsp_empty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2rsp_short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2rsp_extra
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2rsp_2short
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2rsp_2slots
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_rxpkt2rsp_copyerror
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_sscanf_llu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_sscanf_lld
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_sscanf_hhu
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_sscanf_hhd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_sscanf_hhn
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
end_if

begin_comment
comment|/* TODO: add test cases for xnb_add_mbuf_cksum for IPV6 tcp and udp */
end_comment

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_add_mbuf_cksum_arp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_add_mbuf_cksum_tcp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_add_mbuf_cksum_udp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_add_mbuf_cksum_icmp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|testcase_t
name|xnb_add_mbuf_cksum_tcp_swcksum
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|xnb_fill_eh_and_ip
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|uint16_t
name|ip_len
parameter_list|,
name|uint16_t
name|ip_id
parameter_list|,
name|uint16_t
name|ip_p
parameter_list|,
name|uint16_t
name|ip_off
parameter_list|,
name|uint16_t
name|ip_sum
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|xnb_fill_tcp
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET || INET6 */
end_comment

begin_comment
comment|/** Private data used by unit tests */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|gnttab_copy_table
name|gnttab
decl_stmt|;
name|netif_rx_back_ring_t
name|rxb
decl_stmt|;
name|netif_rx_front_ring_t
name|rxf
decl_stmt|;
name|netif_tx_back_ring_t
name|txb
decl_stmt|;
name|netif_tx_front_ring_t
name|txf
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|netif_rx_sring_t
modifier|*
name|rxs
decl_stmt|;
name|netif_tx_sring_t
modifier|*
name|txs
decl_stmt|;
block|}
name|xnb_unit_pvt
struct|;
end_struct

begin_function
specifier|static
specifier|inline
name|void
name|safe_m_freem
parameter_list|(
name|struct
name|mbuf
modifier|*
modifier|*
name|ppMbuf
parameter_list|)
block|{
if|if
condition|(
operator|*
name|ppMbuf
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|ppMbuf
argument_list|)
expr_stmt|;
operator|*
name|ppMbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * The unit test runner.  It will run every supplied test and return an  * output message as a string  * \param tests		An array of tests.  Every test will be attempted.  * \param ntests	The length of tests  * \param buffer	Return storage for the result string  * \param buflen	The length of buffer  * \return		The number of tests that failed  */
end_comment

begin_function
specifier|static
name|int
name|xnb_unit_test_runner
parameter_list|(
name|test_fixture_t
specifier|const
name|tests
index|[]
parameter_list|,
name|int
name|ntests
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|n_passes
decl_stmt|;
name|int
name|n_failures
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntests
condition|;
name|i
operator|++
control|)
block|{
name|int
name|error
init|=
name|tests
index|[
name|i
index|]
operator|.
name|setup
argument_list|()
decl_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|SNCATF
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|,
literal|"Setup failed for test idx %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|n_failures
operator|++
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|new_chars
decl_stmt|;
name|tests
index|[
name|i
index|]
operator|.
name|test
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|new_chars
operator|=
name|strnlen
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|buffer
operator|+=
name|new_chars
expr_stmt|;
name|buflen
operator|-=
name|new_chars
expr_stmt|;
if|if
condition|(
name|new_chars
operator|>
literal|0
condition|)
block|{
name|n_failures
operator|++
expr_stmt|;
block|}
block|}
name|tests
index|[
name|i
index|]
operator|.
name|teardown
argument_list|()
expr_stmt|;
block|}
name|n_passes
operator|=
name|ntests
operator|-
name|n_failures
expr_stmt|;
if|if
condition|(
name|n_passes
operator|>
literal|0
condition|)
block|{
name|SNCATF
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|,
literal|"%d Tests Passed\n"
argument_list|,
name|n_passes
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n_failures
operator|>
literal|0
condition|)
block|{
name|SNCATF
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|,
literal|"%d Tests FAILED\n"
argument_list|,
name|n_failures
argument_list|)
expr_stmt|;
block|}
return|return
name|n_failures
return|;
block|}
end_function

begin_comment
comment|/** Number of unit tests.  Must match the length of the tests array below */
end_comment

begin_define
define|#
directive|define
name|TOTAL_TESTS
value|(53)
end_define

begin_comment
comment|/**  * Max memory available for returning results.  400 chars/test should give  * enough space for a five line error message for every test  */
end_comment

begin_define
define|#
directive|define
name|TOTAL_BUFLEN
value|(400 * TOTAL_TESTS + 2)
end_define

begin_comment
comment|/**  * Called from userspace by a sysctl.  Runs all internal unit tests, and  * returns the results to userspace as a string  * \param oidp	unused  * \param arg1	pointer to an xnb_softc for a specific xnb device  * \param arg2	unused  * \param req	sysctl access structure  * \return a string via the special SYSCTL_OUT macro.  */
end_comment

begin_function
specifier|static
name|int
name|xnb_unit_test_main
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|test_fixture_t
specifier|const
name|tests
index|[
name|TOTAL_TESTS
index|]
init|=
block|{
block|{
name|setup_pvt_data
block|,
name|xnb_ring2pkt_emptyring
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_ring2pkt_1req
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_ring2pkt_2req
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_ring2pkt_3req
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_ring2pkt_extra
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_ring2pkt_partial
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_ring2pkt_wraps
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2rsp_emptypkt
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2rsp_1req
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2rsp_extra
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2rsp_long
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2rsp_invalid
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2rsp_error
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2rsp_wraps
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_pkt2mbufc_empty
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_pkt2mbufc_short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_pkt2mbufc_csum
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_pkt2mbufc_1cluster
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_pkt2mbufc_largecluster
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_pkt2mbufc_2cluster
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2gnttab_empty
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2gnttab_short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2gnttab_2req
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_txpkt2gnttab_2cluster
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_update_mbufc_short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_update_mbufc_2req
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_update_mbufc_2cluster
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_mbufc2pkt_empty
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_mbufc2pkt_short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_mbufc2pkt_1cluster
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_mbufc2pkt_2short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_mbufc2pkt_long
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_mbufc2pkt_extra
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_mbufc2pkt_nospace
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2gnttab_empty
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2gnttab_short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2gnttab_2req
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2rsp_empty
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2rsp_short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2rsp_extra
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2rsp_2short
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2rsp_2slots
block|,
name|teardown_pvt_data
block|}
block|,
block|{
name|setup_pvt_data
block|,
name|xnb_rxpkt2rsp_copyerror
block|,
name|teardown_pvt_data
block|}
block|,
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
block|{
name|null_setup
block|,
name|xnb_add_mbuf_cksum_arp
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_add_mbuf_cksum_icmp
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_add_mbuf_cksum_tcp
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_add_mbuf_cksum_tcp_swcksum
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_add_mbuf_cksum_udp
block|,
name|null_teardown
block|}
block|,
endif|#
directive|endif
block|{
name|null_setup
block|,
name|xnb_sscanf_hhd
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_sscanf_hhu
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_sscanf_lld
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_sscanf_llu
block|,
name|null_teardown
block|}
block|,
block|{
name|null_setup
block|,
name|xnb_sscanf_hhn
block|,
name|null_teardown
block|}
block|, 	}
decl_stmt|;
comment|/** 	 * results is static so that the data will persist after this function 	 * returns.  The sysctl code expects us to return a constant string. 	 * \todo: the static variable is not thread safe.  Put a mutex around 	 * it. 	 */
specifier|static
name|char
name|results
index|[
name|TOTAL_BUFLEN
index|]
decl_stmt|;
comment|/* empty the result strings */
name|results
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|xnb_unit_test_runner
argument_list|(
name|tests
argument_list|,
name|TOTAL_TESTS
argument_list|,
name|results
argument_list|,
name|TOTAL_BUFLEN
argument_list|)
expr_stmt|;
return|return
operator|(
name|SYSCTL_OUT
argument_list|(
name|req
argument_list|,
name|results
argument_list|,
name|strnlen
argument_list|(
name|results
argument_list|,
name|TOTAL_BUFLEN
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|setup_pvt_data
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
sizeof|sizeof
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|)
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|=
name|malloc
argument_list|(
name|PAGE_SIZE
argument_list|,
name|M_XENNETBACK
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|xnb_unit_pvt
operator|.
name|txs
operator|!=
name|NULL
condition|)
block|{
name|SHARED_RING_INIT
argument_list|(
name|xnb_unit_pvt
operator|.
name|txs
argument_list|)
expr_stmt|;
name|BACK_RING_INIT
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txs
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|FRONT_RING_INIT
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txs
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
literal|1
expr_stmt|;
block|}
name|xnb_unit_pvt
operator|.
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|xnb_unit_pvt
operator|.
name|ifp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
literal|1
expr_stmt|;
block|}
name|xnb_unit_pvt
operator|.
name|rxs
operator|=
name|malloc
argument_list|(
name|PAGE_SIZE
argument_list|,
name|M_XENNETBACK
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|xnb_unit_pvt
operator|.
name|rxs
operator|!=
name|NULL
condition|)
block|{
name|SHARED_RING_INIT
argument_list|(
name|xnb_unit_pvt
operator|.
name|rxs
argument_list|)
expr_stmt|;
name|BACK_RING_INIT
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|xnb_unit_pvt
operator|.
name|rxs
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|FRONT_RING_INIT
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|xnb_unit_pvt
operator|.
name|rxs
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|teardown_pvt_data
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|xnb_unit_pvt
operator|.
name|txs
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|xnb_unit_pvt
operator|.
name|txs
argument_list|,
name|M_XENNETBACK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xnb_unit_pvt
operator|.
name|rxs
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|xnb_unit_pvt
operator|.
name|rxs
argument_list|,
name|M_XENNETBACK
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xnb_unit_pvt
operator|.
name|ifp
operator|!=
name|NULL
condition|)
block|{
name|if_free
argument_list|(
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * Verify that xnb_ring2pkt will not consume any requests from an empty ring  */
end_comment

begin_function
specifier|static
name|void
name|xnb_ring2pkt_emptyring
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|num_consumed
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Verify that xnb_ring2pkt can convert a single request packet correctly  */
end_comment

begin_function
specifier|static
name|void
name|xnb_ring2pkt_1req
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|69
expr_stmt|;
comment|/* arbitrary number for test */
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|num_consumed
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
literal|69
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|==
literal|69
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|flags
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Verify that xnb_ring2pkt can convert a two request packet correctly.  * This tests handling of the MORE_DATA flag and cdr  */
end_comment

begin_function
specifier|static
name|void
name|xnb_ring2pkt_2req
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|RING_IDX
name|start_idx
init|=
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|100
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|40
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|num_consumed
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
literal|100
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|==
literal|60
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|flags
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start_idx
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|cdr
operator|==
name|start_idx
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Verify that xnb_ring2pkt can convert a three request packet correctly  */
end_comment

begin_function
specifier|static
name|void
name|xnb_ring2pkt_3req
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|RING_IDX
name|start_idx
init|=
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|200
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|40
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|50
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|num_consumed
operator|==
literal|3
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
literal|200
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|==
literal|110
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|flags
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|3
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start_idx
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|cdr
operator|==
name|start_idx
operator|+
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|pkt
operator|.
name|cdr
operator|+
literal|1
argument_list|)
operator|==
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Verify that xnb_ring2pkt can read extra inf  */
end_comment

begin_function
specifier|static
name|void
name|xnb_ring2pkt_extra
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_extra_info
modifier|*
name|ext
decl_stmt|;
name|RING_IDX
name|start_idx
init|=
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_extra_info
operator||
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|150
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|netif_extra_info
operator|*
operator|)
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|ext
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|ext
operator|->
name|type
operator|=
name|XEN_NETIF_EXTRA_TYPE_GSO
expr_stmt|;
name|ext
operator|->
name|u
operator|.
name|gso
operator|.
name|size
operator|=
literal|250
expr_stmt|;
name|ext
operator|->
name|u
operator|.
name|gso
operator|.
name|type
operator|=
name|XEN_NETIF_GSO_TYPE_TCPV4
expr_stmt|;
name|ext
operator|->
name|u
operator|.
name|gso
operator|.
name|features
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|50
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|num_consumed
operator|==
literal|3
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|extra
operator|.
name|flags
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|extra
operator|.
name|type
operator|==
name|XEN_NETIF_EXTRA_TYPE_GSO
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|extra
operator|.
name|u
operator|.
name|gso
operator|.
name|size
operator|==
literal|250
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|extra
operator|.
name|u
operator|.
name|gso
operator|.
name|type
operator|=
name|XEN_NETIF_GSO_TYPE_TCPV4
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
literal|150
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|==
literal|100
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|flags
operator|==
name|NETTXF_extra_info
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start_idx
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|cdr
operator|==
name|start_idx
operator|+
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|pkt
operator|.
name|cdr
argument_list|)
operator|==
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Verify that xnb_ring2pkt will consume no requests if the entire packet is  * not yet in the ring  */
end_comment

begin_function
specifier|static
name|void
name|xnb_ring2pkt_partial
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|150
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|num_consumed
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Verity that xnb_ring2pkt can read a packet whose requests wrap around  * the end of the ring  */
end_comment

begin_function
specifier|static
name|void
name|xnb_ring2pkt_wraps
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|unsigned
name|int
name|rsize
decl_stmt|;
comment|/* 	 * Manually tweak the ring indices to create a ring with no responses 	 * and the next request slot at position 2 from the end 	 */
name|rsize
operator|=
name|RING_SIZE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_event
operator|=
name|rsize
operator|-
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|rsp_prod
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|rsp_event
operator|=
name|rsize
operator|-
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|550
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|100
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|50
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|num_consumed
operator|==
literal|3
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|3
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|pkt
operator|.
name|cdr
operator|+
literal|1
argument_list|)
operator|==
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_txpkt2rsp should do nothing for an empty packet  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2rsp_emptypkt
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|num_consumed
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|netif_tx_back_ring_t
name|txb_backup
init|=
name|xnb_unit_pvt
operator|.
name|txb
decl_stmt|;
name|netif_tx_sring_t
name|txs_backup
init|=
operator|*
name|xnb_unit_pvt
operator|.
name|txs
decl_stmt|;
name|pkt
operator|.
name|list_len
operator|=
literal|0
expr_stmt|;
comment|/* must call xnb_ring2pkt just to intialize pkt */
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|xnb_txpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|memcmp
argument_list|(
operator|&
name|txb_backup
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
sizeof|sizeof
argument_list|(
name|txb_backup
argument_list|)
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|memcmp
argument_list|(
operator|&
name|txs_backup
argument_list|,
name|xnb_unit_pvt
operator|.
name|txs
argument_list|,
sizeof|sizeof
argument_list|(
name|txs_backup
argument_list|)
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_txpkt2rsp responding to one request  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2rsp_1req
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|uint16_t
name|num_consumed
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_tx_response
modifier|*
name|rsp
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|1000
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
operator|+=
name|num_consumed
expr_stmt|;
name|xnb_txpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|==
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|req
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/**  * xnb_txpkt2rsp responding to 1 data request and 1 extra info  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2rsp_extra
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|uint16_t
name|num_consumed
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|netif_extra_info_t
modifier|*
name|ext
decl_stmt|;
name|struct
name|netif_tx_response
modifier|*
name|rsp
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|1000
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_extra_info
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|69
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|ext
operator|=
operator|(
name|netif_extra_info_t
operator|*
operator|)
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|ext
operator|->
name|type
operator|=
name|XEN_NETIF_EXTRA_TYPE_GSO
expr_stmt|;
name|ext
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
operator|+=
name|num_consumed
expr_stmt|;
name|xnb_txpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|==
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|req
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_OKAY
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|+
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/**  * xnb_pkg2rsp responding to 3 data requests and 1 extra info  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2rsp_long
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|uint16_t
name|num_consumed
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|netif_extra_info_t
modifier|*
name|ext
decl_stmt|;
name|struct
name|netif_tx_response
modifier|*
name|rsp
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|1000
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_extra_info
operator||
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|254
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|ext
operator|=
operator|(
name|netif_extra_info_t
operator|*
operator|)
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|ext
operator|->
name|type
operator|=
name|XEN_NETIF_EXTRA_TYPE_GSO
expr_stmt|;
name|ext
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|300
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|1034
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|400
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|34
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
operator|+=
name|num_consumed
expr_stmt|;
name|xnb_txpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|==
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
literal|0
argument_list|)
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_OKAY
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|+
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_NULL
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|+
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
literal|2
argument_list|)
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_OKAY
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|+
literal|3
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
literal|3
argument_list|)
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_txpkt2rsp responding to an invalid packet.  * Note: this test will result in an error message being printed to the console  * such as:  * xnb(xnb_ring2pkt:1306): Unknown extra info type 255.  Discarding packet  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2rsp_invalid
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|uint16_t
name|num_consumed
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|netif_extra_info_t
modifier|*
name|ext
decl_stmt|;
name|struct
name|netif_tx_response
modifier|*
name|rsp
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|1000
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_extra_info
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|69
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|ext
operator|=
operator|(
name|netif_extra_info_t
operator|*
operator|)
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|ext
operator|->
name|type
operator|=
literal|0xFF
expr_stmt|;
comment|/* Invalid extra type */
name|ext
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
operator|+=
name|num_consumed
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|xnb_txpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|==
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|req
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_ERROR
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|+
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/**  * xnb_txpkt2rsp responding to one request which caused an error  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2rsp_error
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|uint16_t
name|num_consumed
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_tx_response
modifier|*
name|rsp
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|1000
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
operator|+=
name|num_consumed
expr_stmt|;
name|xnb_txpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|==
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|req
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_ERROR
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/**  * xnb_txpkt2rsp's responses wrap around the end of the ring  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2rsp_wraps
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|num_consumed
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_tx_response
modifier|*
name|rsp
decl_stmt|;
name|unsigned
name|int
name|rsize
decl_stmt|;
comment|/* 	 * Manually tweak the ring indices to create a ring with no responses 	 * and the next request slot at position 2 from the end 	 */
name|rsize
operator|=
name|RING_SIZE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_event
operator|=
name|rsize
operator|-
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|rsp_prod
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|rsp_event
operator|=
name|rsize
operator|-
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
operator|=
name|rsize
operator|-
literal|2
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|550
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|100
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|50
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|3
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|xnb_txpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|rsp_prod_pvt
operator|==
name|xnb_unit_pvt
operator|.
name|txs
operator|->
name|req_prod
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|rsp_cons
operator|+
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|req
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_OKAY
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Helper function used to setup pkt2mbufc tests  * \param size     size in bytes of the single request to push to the ring  * \param flags		optional flags to put in the netif request  * \param[out] pkt the returned packet object  * \return number of requests consumed from the ring  */
end_comment

begin_function
specifier|static
name|int
name|xnb_get1pkt
parameter_list|(
name|struct
name|xnb_pkt
modifier|*
name|pkt
parameter_list|,
name|size_t
name|size
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
block|{
name|struct
name|netif_tx_request
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|req
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
return|return
name|xnb_ring2pkt
argument_list|(
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * xnb_pkt2mbufc on an empty packet  */
end_comment

begin_function
specifier|static
name|void
name|xnb_pkt2mbufc_empty
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|num_consumed
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|pkt
operator|.
name|list_len
operator|=
literal|0
expr_stmt|;
comment|/* must call xnb_ring2pkt just to intialize pkt */
name|num_consumed
operator|=
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pkt
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_pkt2mbufc on short packet that can fit in an mbuf internal buffer  */
end_comment

begin_function
specifier|static
name|void
name|xnb_pkt2mbufc_short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|size
init|=
name|MINCLSIZE
operator|-
literal|1
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|xnb_get1pkt
argument_list|(
operator|&
name|pkt
argument_list|,
name|size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|pMbuf
argument_list|)
operator|>=
name|size
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_pkt2mbufc on short packet whose checksum was validated by the netfron  */
end_comment

begin_function
specifier|static
name|void
name|xnb_pkt2mbufc_csum
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|size
init|=
name|MINCLSIZE
operator|-
literal|1
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|xnb_get1pkt
argument_list|(
operator|&
name|pkt
argument_list|,
name|size
argument_list|,
name|NETTXF_data_validated
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|pMbuf
argument_list|)
operator|>=
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP_CHECKED
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP_VALID
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_DATA_VALID
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_PSEUDO_HDR
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_pkt2mbufc on packet that can fit in one cluster  */
end_comment

begin_function
specifier|static
name|void
name|xnb_pkt2mbufc_1cluster
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|size
init|=
name|MINCLSIZE
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|xnb_get1pkt
argument_list|(
operator|&
name|pkt
argument_list|,
name|size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|pMbuf
argument_list|)
operator|>=
name|size
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_pkt2mbufc on packet that cannot fit in one regular cluster  */
end_comment

begin_function
specifier|static
name|void
name|xnb_pkt2mbufc_largecluster
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|size
init|=
name|MCLBYTES
operator|+
literal|1
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|xnb_get1pkt
argument_list|(
operator|&
name|pkt
argument_list|,
name|size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|pMbuf
argument_list|)
operator|>=
name|size
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_pkt2mbufc on packet that cannot fit in one clusters  */
end_comment

begin_function
specifier|static
name|void
name|xnb_pkt2mbufc_2cluster
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|size
init|=
literal|2
operator|*
name|MCLBYTES
operator|+
literal|1
decl_stmt|;
name|size_t
name|space
init|=
literal|0
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|xnb_get1pkt
argument_list|(
operator|&
name|pkt
argument_list|,
name|size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
name|pMbuf
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|space
operator|+=
name|M_TRAILINGSPACE
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
name|XNB_ASSERT
argument_list|(
name|space
operator|>=
name|size
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_txpkt2gnttab on an empty packet.  Should return empty gnttab  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2gnttab_empty
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|n_entries
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|pkt
operator|.
name|list_len
operator|=
literal|0
expr_stmt|;
comment|/* must call xnb_ring2pkt just to intialize pkt */
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pkt
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|n_entries
operator|=
name|xnb_txpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|n_entries
operator|==
literal|0
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_txpkt2gnttab on a short packet, that can fit in one mbuf internal buffer  * and has one request  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2gnttab_short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|size
init|=
name|MINCLSIZE
operator|-
literal|1
decl_stmt|;
name|int
name|n_entries
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
init|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
decl_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|7
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|17
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|n_entries
operator|=
name|xnb_txpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|n_entries
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|len
operator|==
name|size
argument_list|)
expr_stmt|;
comment|/* flags should indicate gref's for source */
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|flags
operator|&
name|GNTCOPY_source_gref
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|source
operator|.
name|offset
operator|==
name|req
operator|->
name|offset
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|source
operator|.
name|domid
operator|==
name|DOMID_SELF
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|u
operator|.
name|gmfn
operator|==
name|virt_to_mfn
argument_list|(
name|mtod
argument_list|(
name|pMbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|domid
operator|==
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_txpkt2gnttab on a packet with two requests, that can fit into a single  * mbuf cluster  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2gnttab_2req
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|n_entries
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
init|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
decl_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|1900
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|7
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|500
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|8
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|n_entries
operator|=
name|xnb_txpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|n_entries
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|len
operator|==
literal|1400
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|len
operator|==
literal|500
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
argument_list|,
name|vm_offset_t
argument_list|)
operator|+
literal|1400
argument_list|)
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_txpkt2gnttab on a single request that spans two mbuf clusters  */
end_comment

begin_function
specifier|static
name|void
name|xnb_txpkt2gnttab_2cluster
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|n_entries
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
specifier|const
name|uint16_t
name|data_this_transaction
init|=
operator|(
name|MCLBYTES
operator|*
literal|2
operator|)
operator|+
literal|1
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
init|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
decl_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
name|data_this_transaction
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|8
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pMbuf
operator|==
name|NULL
condition|)
return|return;
name|n_entries
operator|=
name|xnb_txpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
if|if
condition|(
name|M_TRAILINGSPACE
argument_list|(
name|pMbuf
argument_list|)
operator|==
name|MCLBYTES
condition|)
block|{
comment|/* there should be three mbufs and three gnttab entries */
name|XNB_ASSERT
argument_list|(
name|n_entries
operator|==
literal|3
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|len
operator|==
name|MCLBYTES
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|source
operator|.
name|offset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|len
operator|==
name|MCLBYTES
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
operator|->
name|m_next
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|source
operator|.
name|offset
operator|==
name|MCLBYTES
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|2
index|]
operator|.
name|len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|2
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
operator|->
name|m_next
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|2
index|]
operator|.
name|source
operator|.
name|offset
operator|==
literal|2
operator|*
name|MCLBYTES
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|M_TRAILINGSPACE
argument_list|(
name|pMbuf
argument_list|)
operator|==
literal|2
operator|*
name|MCLBYTES
condition|)
block|{
comment|/* there should be two mbufs and two gnttab entries */
name|XNB_ASSERT
argument_list|(
name|n_entries
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|len
operator|==
literal|2
operator|*
name|MCLBYTES
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|source
operator|.
name|offset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|pMbuf
operator|->
name|m_next
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|source
operator|.
name|offset
operator|==
literal|2
operator|*
name|MCLBYTES
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* should never get here */
name|XNB_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|m_freem
argument_list|(
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_update_mbufc on a short packet that only has one gnttab entry  */
end_comment

begin_function
specifier|static
name|void
name|xnb_update_mbufc_short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|size
init|=
name|MINCLSIZE
operator|-
literal|1
decl_stmt|;
name|int
name|n_entries
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
init|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
decl_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|7
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|17
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|n_entries
operator|=
name|xnb_txpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
comment|/* Update grant table's status fields as the hypervisor call would */
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|status
operator|=
name|GNTST_okay
expr_stmt|;
name|xnb_update_mbufc
argument_list|(
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|n_entries
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_len
operator|==
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|==
name|size
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_update_mbufc on a packet with two requests, that can fit into a single  * mbuf cluster  */
end_comment

begin_function
specifier|static
name|void
name|xnb_update_mbufc_2req
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|n_entries
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
init|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
decl_stmt|;
name|req
operator|->
name|flags
operator|=
name|NETTXF_more_data
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|1900
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|7
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
literal|500
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|8
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|n_entries
operator|=
name|xnb_txpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
comment|/* Update grant table's status fields as the hypervisor call would */
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|status
operator|=
name|GNTST_okay
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|1
index|]
operator|.
name|status
operator|=
name|GNTST_okay
expr_stmt|;
name|xnb_update_mbufc
argument_list|(
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|n_entries
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|n_entries
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|==
literal|1900
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_len
operator|==
literal|1900
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_update_mbufc on a single request that spans two mbuf clusters  */
end_comment

begin_function
specifier|static
name|void
name|xnb_update_mbufc_2cluster
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|n_entries
decl_stmt|;
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|pMbuf
decl_stmt|;
specifier|const
name|uint16_t
name|data_this_transaction
init|=
operator|(
name|MCLBYTES
operator|*
literal|2
operator|)
operator|+
literal|1
decl_stmt|;
name|struct
name|netif_tx_request
modifier|*
name|req
init|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
decl_stmt|;
name|req
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|size
operator|=
name|data_this_transaction
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|8
expr_stmt|;
name|req
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
operator|++
expr_stmt|;
name|RING_PUSH_REQUESTS
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|txf
argument_list|)
expr_stmt|;
name|xnb_ring2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|xnb_unit_pvt
operator|.
name|txb
operator|.
name|req_cons
argument_list|)
expr_stmt|;
name|pMbuf
operator|=
name|xnb_pkt2mbufc
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|ifp
argument_list|)
expr_stmt|;
name|n_entries
operator|=
name|xnb_txpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|txb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
comment|/* Update grant table's status fields */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_entries
condition|;
name|i
operator|++
control|)
block|{
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|status
operator|=
name|GNTST_okay
expr_stmt|;
block|}
name|xnb_update_mbufc
argument_list|(
name|pMbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|n_entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|n_entries
operator|==
literal|3
condition|)
block|{
comment|/* there should be three mbufs and three gnttab entries */
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|==
name|data_this_transaction
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_len
operator|==
name|MCLBYTES
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_next
operator|->
name|m_len
operator|==
name|MCLBYTES
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_next
operator|->
name|m_next
operator|->
name|m_len
operator|==
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n_entries
operator|==
literal|2
condition|)
block|{
comment|/* there should be two mbufs and two gnttab entries */
name|XNB_ASSERT
argument_list|(
name|n_entries
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|==
name|data_this_transaction
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_len
operator|==
literal|2
operator|*
name|MCLBYTES
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pMbuf
operator|->
name|m_next
operator|->
name|m_len
operator|==
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* should never get here */
name|XNB_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|safe_m_freem
argument_list|(
operator|&
name|pMbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_mbufc2pkt on an empty mbufc */
end_comment

begin_function
specifier|static
name|void
name|xnb_mbufc2pkt_empty
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|free_slots
init|=
literal|64
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_get
argument_list|(
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
comment|/* 	 * note: it is illegal to set M_PKTHDR on a mbuf with no data.  Doing so 	 * will cause m_freem to segfault 	 */
name|XNB_ASSERT
argument_list|(
name|mbuf
operator|->
name|m_len
operator|==
literal|0
argument_list|)
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
literal|0
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_mbufc2pkt on a short mbufc */
end_comment

begin_function
specifier|static
name|void
name|xnb_mbufc2pkt_short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|size_t
name|size
init|=
literal|128
decl_stmt|;
name|int
name|free_slots
init|=
literal|64
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|9
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbuf
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|==
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
operator|(
name|pkt
operator|.
name|flags
operator|&
operator|(
name|NETRXF_more_data
operator||
name|NETRXF_extra_info
operator|)
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_mbufc2pkt on a single mbuf with an mbuf cluster */
end_comment

begin_function
specifier|static
name|void
name|xnb_mbufc2pkt_1cluster
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|size_t
name|size
init|=
name|MCLBYTES
decl_stmt|;
name|int
name|free_slots
init|=
literal|32
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|12
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbuf
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|==
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
operator|(
name|pkt
operator|.
name|flags
operator|&
operator|(
name|NETRXF_more_data
operator||
name|NETRXF_extra_info
operator|)
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_mbufc2pkt on a two-mbuf chain with short data regions */
end_comment

begin_function
specifier|static
name|void
name|xnb_mbufc2pkt_2short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|size_t
name|size1
init|=
name|MHLEN
operator|-
literal|5
decl_stmt|;
name|size_t
name|size2
init|=
name|MHLEN
operator|-
literal|15
decl_stmt|;
name|int
name|free_slots
init|=
literal|32
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|14
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|,
modifier|*
name|mbufc2
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size1
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbufc
operator|==
name|NULL
condition|)
return|return;
name|mbufc
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbufc2
operator|=
name|m_getm
argument_list|(
name|mbufc
argument_list|,
name|size2
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc2
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbufc2
operator|==
name|NULL
condition|)
block|{
name|safe_m_freem
argument_list|(
operator|&
name|mbufc
argument_list|)
expr_stmt|;
return|return;
block|}
name|mbufc2
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size1
operator|+
name|size2
expr_stmt|;
name|mbufc2
operator|->
name|m_len
operator|=
name|size1
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbufc2
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
name|size1
operator|+
name|size2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start
argument_list|)
expr_stmt|;
comment|/* 	 * The second m_getm may allocate a new mbuf and append 	 * it to the chain, or it may simply extend the first mbuf. 	 */
if|if
condition|(
name|mbufc2
operator|->
name|m_next
operator|!=
name|NULL
condition|)
block|{
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|==
name|size1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|list_len
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|cdr
operator|==
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|safe_m_freem
argument_list|(
operator|&
name|mbufc2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_mbufc2pkt on a mbuf chain with>1 mbuf cluster */
end_comment

begin_function
specifier|static
name|void
name|xnb_mbufc2pkt_long
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|size_t
name|size
init|=
literal|14
operator|*
name|MCLBYTES
operator|/
literal|3
decl_stmt|;
name|size_t
name|size_remaining
decl_stmt|;
name|int
name|free_slots
init|=
literal|15
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|3
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbufc
operator|==
name|NULL
condition|)
return|return;
name|mbufc
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|size_remaining
operator|=
name|size
expr_stmt|;
for|for
control|(
name|m
operator|=
name|mbufc
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|m
operator|->
name|m_len
operator|=
name|MAX
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|m
argument_list|)
argument_list|,
name|size_remaining
argument_list|)
expr_stmt|;
name|size_remaining
operator|-=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|xnb_mbufc2pkt
argument_list|(
name|mbufc
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|=
name|mbufc
operator|->
name|m_len
argument_list|)
expr_stmt|;
comment|/* 	 * There should be>1 response in the packet, and there is no 	 * extra info. 	 */
name|XNB_ASSERT
argument_list|(
operator|!
operator|(
name|pkt
operator|.
name|flags
operator|&
name|NETRXF_extra_info
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|cdr
operator|==
name|pkt
operator|.
name|car
operator|+
literal|1
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_mbufc2pkt on a mbuf chain with>1 mbuf cluster and extra info */
end_comment

begin_function
specifier|static
name|void
name|xnb_mbufc2pkt_extra
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|size_t
name|size
init|=
literal|14
operator|*
name|MCLBYTES
operator|/
literal|3
decl_stmt|;
name|size_t
name|size_remaining
decl_stmt|;
name|int
name|free_slots
init|=
literal|15
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|3
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbufc
operator|==
name|NULL
condition|)
return|return;
name|mbufc
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_TSO
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
operator|=
name|TCP_MSS
operator|-
literal|40
expr_stmt|;
name|size_remaining
operator|=
name|size
expr_stmt|;
for|for
control|(
name|m
operator|=
name|mbufc
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|m
operator|->
name|m_len
operator|=
name|MAX
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|m
argument_list|)
argument_list|,
name|size_remaining
argument_list|)
expr_stmt|;
name|size_remaining
operator|-=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|xnb_mbufc2pkt
argument_list|(
name|mbufc
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|size
operator|==
name|size
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car
operator|==
name|start
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|car_size
operator|=
name|mbufc
operator|->
name|m_len
argument_list|)
expr_stmt|;
comment|/* There should be>1 response in the packet, there is extra info */
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|flags
operator|&
name|NETRXF_extra_info
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|flags
operator|&
name|NETRXF_data_validated
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|cdr
operator|==
name|pkt
operator|.
name|car
operator|+
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|extra
operator|.
name|u
operator|.
name|gso
operator|.
name|size
operator|=
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|pkt
operator|.
name|extra
operator|.
name|type
operator|==
name|XEN_NETIF_EXTRA_TYPE_GSO
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
operator|(
name|pkt
operator|.
name|extra
operator|.
name|flags
operator|&
name|XEN_NETIF_EXTRA_FLAG_MORE
operator|)
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_mbufc2pkt with insufficient space in the ring */
end_comment

begin_function
specifier|static
name|void
name|xnb_mbufc2pkt_nospace
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|size_t
name|size
init|=
literal|14
operator|*
name|MCLBYTES
operator|/
literal|3
decl_stmt|;
name|size_t
name|size_remaining
decl_stmt|;
name|int
name|free_slots
init|=
literal|2
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|3
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|int
name|error
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbufc
operator|==
name|NULL
condition|)
return|return;
name|mbufc
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|size_remaining
operator|=
name|size
expr_stmt|;
for|for
control|(
name|m
operator|=
name|mbufc
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|m
operator|->
name|m_len
operator|=
name|MAX
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|m
argument_list|)
argument_list|,
name|size_remaining
argument_list|)
expr_stmt|;
name|size_remaining
operator|-=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|error
operator|=
name|xnb_mbufc2pkt
argument_list|(
name|mbufc
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|error
operator|==
name|EAGAIN
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
name|xnb_pkt_is_valid
argument_list|(
operator|&
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_rxpkt2gnttab on an empty packet.  Should return empty gnttab  */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2gnttab_empty
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|;
name|int
name|free_slots
init|=
literal|60
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_get
argument_list|(
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
literal|0
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_entries
operator|==
literal|0
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_rxpkt2gnttab on a short packet without extra data */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2gnttab_short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|;
name|size_t
name|size
init|=
literal|128
decl_stmt|;
name|int
name|free_slots
init|=
literal|60
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|9
decl_stmt|;
name|struct
name|netif_rx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbuf
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|7
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_entries
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|len
operator|==
name|size
argument_list|)
expr_stmt|;
comment|/* flags should indicate gref's for dest */
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|flags
operator|&
name|GNTCOPY_dest_gref
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|offset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|source
operator|.
name|domid
operator|==
name|DOMID_SELF
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|source
operator|.
name|offset
operator|==
name|virt_to_offset
argument_list|(
name|mtod
argument_list|(
name|mbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|source
operator|.
name|u
operator|.
name|gmfn
operator|==
name|virt_to_mfn
argument_list|(
name|mtod
argument_list|(
name|mbuf
argument_list|,
name|vm_offset_t
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|0
index|]
operator|.
name|dest
operator|.
name|domid
operator|==
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_rxpkt2gnttab on a packet with two different mbufs in a single chai  */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2gnttab_2req
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_mbufs
decl_stmt|;
name|size_t
name|total_granted_size
init|=
literal|0
decl_stmt|;
name|size_t
name|size
init|=
name|MJUMPAGESIZE
operator|+
literal|1
decl_stmt|;
name|int
name|free_slots
init|=
literal|60
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|11
decl_stmt|;
name|struct
name|netif_rx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|mbuf
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbuf
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|m
operator|=
name|mbuf
init|;
name|m
operator|!=
name|NULL
condition|;
name|i
operator|++
operator|,
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|xnb_unit_pvt
operator|.
name|txf
operator|.
name|req_prod_pvt
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|i
expr_stmt|;
name|req
operator|->
name|id
operator|=
literal|5
expr_stmt|;
block|}
name|num_mbufs
operator|=
name|i
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_entries
operator|>=
name|num_mbufs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr_entries
condition|;
name|i
operator|++
control|)
block|{
name|int
name|end_offset
init|=
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
name|i
index|]
operator|.
name|len
operator|+
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
name|i
index|]
operator|.
name|dest
operator|.
name|offset
decl_stmt|;
name|XNB_ASSERT
argument_list|(
name|end_offset
operator|<=
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|total_granted_size
operator|+=
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
block|}
name|XNB_ASSERT
argument_list|(
name|total_granted_size
operator|==
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_rxpkt2rsp on an empty packet.  Shouldn't make any response  */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2rsp_empty
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|;
name|int
name|nr_reqs
decl_stmt|;
name|int
name|free_slots
init|=
literal|60
decl_stmt|;
name|netif_rx_back_ring_t
name|rxb_backup
init|=
name|xnb_unit_pvt
operator|.
name|rxb
decl_stmt|;
name|netif_rx_sring_t
name|rxs_backup
init|=
operator|*
name|xnb_unit_pvt
operator|.
name|rxs
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_get
argument_list|(
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
literal|0
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|nr_reqs
operator|=
name|xnb_rxpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|nr_entries
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_reqs
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|memcmp
argument_list|(
operator|&
name|rxb_backup
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
sizeof|sizeof
argument_list|(
name|rxb_backup
argument_list|)
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|memcmp
argument_list|(
operator|&
name|rxs_backup
argument_list|,
name|xnb_unit_pvt
operator|.
name|rxs
argument_list|,
sizeof|sizeof
argument_list|(
name|rxs_backup
argument_list|)
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_rxpkt2rsp on a short packet with no extras  */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2rsp_short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|,
name|nr_reqs
decl_stmt|;
name|size_t
name|size
init|=
literal|128
decl_stmt|;
name|int
name|free_slots
init|=
literal|60
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|5
decl_stmt|;
name|struct
name|netif_rx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_rx_response
modifier|*
name|rsp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbuf
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
literal|7
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|req_cons
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|req_prod
operator|=
name|start
operator|+
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|rsp_prod
operator|=
name|start
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|nr_reqs
operator|=
name|xnb_rxpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|nr_entries
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_reqs
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|==
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|req
operator|->
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|offset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|(
name|rsp
operator|->
name|flags
operator|&
operator|(
name|NETRXF_more_data
operator||
name|NETRXF_extra_info
operator|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|size
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_rxpkt2rsp with extra data  */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2rsp_extra
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|,
name|nr_reqs
decl_stmt|;
name|size_t
name|size
init|=
literal|14
decl_stmt|;
name|int
name|free_slots
init|=
literal|15
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|3
decl_stmt|;
name|uint16_t
name|id
init|=
literal|49
decl_stmt|;
name|uint16_t
name|gref
init|=
literal|65
decl_stmt|;
name|uint16_t
name|mss
init|=
name|TCP_MSS
operator|-
literal|40
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|;
name|struct
name|netif_rx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_rx_response
modifier|*
name|rsp
decl_stmt|;
name|struct
name|netif_extra_info
modifier|*
name|ext
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbufc
operator|==
name|NULL
condition|)
return|return;
name|mbufc
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_TSO
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
operator|=
name|mss
expr_stmt|;
name|mbufc
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbufc
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|req
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|gref
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|req
operator|->
name|id
operator|=
name|id
operator|+
literal|1
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|gref
operator|+
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|req_cons
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|req_prod
operator|=
name|start
operator|+
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|rsp_prod
operator|=
name|start
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbufc
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|nr_reqs
operator|=
name|xnb_rxpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|nr_entries
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_reqs
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|==
name|start
operator|+
literal|2
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_more_data
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_extra_info
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_data_validated
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_csum_blank
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|size
argument_list|)
expr_stmt|;
name|ext
operator|=
operator|(
expr|struct
name|netif_extra_info
operator|*
operator|)
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|ext
operator|->
name|type
operator|==
name|XEN_NETIF_EXTRA_TYPE_GSO
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
operator|(
name|ext
operator|->
name|flags
operator|&
name|XEN_NETIF_EXTRA_FLAG_MORE
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|ext
operator|->
name|u
operator|.
name|gso
operator|.
name|size
operator|==
name|mss
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|ext
operator|->
name|u
operator|.
name|gso
operator|.
name|type
operator|==
name|XEN_NETIF_EXTRA_TYPE_GSO
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_rxpkt2rsp on a packet with more than a pages's worth of data.  It should  * generate two response slot  */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2rsp_2slots
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|,
name|nr_reqs
decl_stmt|;
name|size_t
name|size
init|=
name|PAGE_SIZE
operator|+
literal|100
decl_stmt|;
name|int
name|free_slots
init|=
literal|3
decl_stmt|;
name|uint16_t
name|id1
init|=
literal|17
decl_stmt|;
name|uint16_t
name|id2
init|=
literal|37
decl_stmt|;
name|uint16_t
name|gref1
init|=
literal|24
decl_stmt|;
name|uint16_t
name|gref2
init|=
literal|34
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|15
decl_stmt|;
name|struct
name|netif_rx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_rx_response
modifier|*
name|rsp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
if|if
condition|(
name|mbuf
operator|->
name|m_next
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|first_len
init|=
name|MIN
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|mbuf
argument_list|)
argument_list|,
name|size
argument_list|)
decl_stmt|;
name|mbuf
operator|->
name|m_len
operator|=
name|first_len
expr_stmt|;
name|mbuf
operator|->
name|m_next
operator|->
name|m_len
operator|=
name|size
operator|-
name|first_len
expr_stmt|;
block|}
else|else
block|{
name|mbuf
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
block|}
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|gref1
expr_stmt|;
name|req
operator|->
name|id
operator|=
name|id1
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|gref2
expr_stmt|;
name|req
operator|->
name|id
operator|=
name|id2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|req_cons
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|req_prod
operator|=
name|start
operator|+
literal|2
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|rsp_prod
operator|=
name|start
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|nr_reqs
operator|=
name|xnb_rxpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|nr_entries
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_reqs
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|==
name|start
operator|+
literal|2
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|id1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|offset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_extra_info
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_more_data
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|id2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|offset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_extra_info
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
operator|(
name|rsp
operator|->
name|flags
operator|&
name|NETRXF_more_data
operator|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|size
operator|-
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** xnb_rxpkt2rsp on a grant table with two sub-page entries */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2rsp_2short
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_reqs
decl_stmt|,
name|nr_entries
decl_stmt|;
name|size_t
name|size1
init|=
name|MHLEN
operator|-
literal|5
decl_stmt|;
name|size_t
name|size2
init|=
name|MHLEN
operator|-
literal|15
decl_stmt|;
name|int
name|free_slots
init|=
literal|32
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|14
decl_stmt|;
name|uint16_t
name|id
init|=
literal|47
decl_stmt|;
name|uint16_t
name|gref
init|=
literal|54
decl_stmt|;
name|struct
name|netif_rx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_rx_response
modifier|*
name|rsp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size1
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbufc
operator|==
name|NULL
condition|)
return|return;
name|mbufc
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|m_getm
argument_list|(
name|mbufc
argument_list|,
name|size2
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|mbufc
operator|->
name|m_next
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size1
operator|+
name|size2
expr_stmt|;
name|mbufc
operator|->
name|m_len
operator|=
name|size1
expr_stmt|;
name|mbufc
operator|->
name|m_next
operator|->
name|m_len
operator|=
name|size2
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbufc
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|gref
expr_stmt|;
name|req
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|req_cons
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|req_prod
operator|=
name|start
operator|+
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|rsp_prod
operator|=
name|start
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbufc
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
name|nr_reqs
operator|=
name|xnb_rxpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|nr_entries
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_entries
operator|==
literal|2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_reqs
operator|==
literal|1
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|size1
operator|+
name|size2
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|offset
operator|==
literal|0
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
operator|!
operator|(
name|rsp
operator|->
name|flags
operator|&
operator|(
name|NETRXF_more_data
operator||
name|NETRXF_extra_info
operator|)
operator|)
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_rxpkt2rsp on a long packet with a hypervisor gnttab_copy error  * Note: this test will result in an error message being printed to the console  * such as:  * xnb(xnb_rxpkt2rsp:1720): Got error -1 for hypervisor gnttab_copy status  */
end_comment

begin_function
specifier|static
name|void
name|xnb_rxpkt2rsp_copyerror
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|xnb_pkt
name|pkt
decl_stmt|;
name|int
name|nr_entries
decl_stmt|,
name|nr_reqs
decl_stmt|;
name|int
name|id
init|=
literal|7
decl_stmt|;
name|int
name|gref
init|=
literal|42
decl_stmt|;
name|uint16_t
name|canary
init|=
literal|6859
decl_stmt|;
name|size_t
name|size
init|=
literal|7
operator|*
name|MCLBYTES
decl_stmt|;
name|int
name|free_slots
init|=
literal|9
decl_stmt|;
name|RING_IDX
name|start
init|=
literal|2
decl_stmt|;
name|struct
name|netif_rx_request
modifier|*
name|req
decl_stmt|;
name|struct
name|netif_rx_response
modifier|*
name|rsp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbuf
decl_stmt|;
name|mbuf
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|mbuf
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|size
expr_stmt|;
name|mbuf
operator|->
name|m_len
operator|=
name|size
expr_stmt|;
name|xnb_mbufc2pkt
argument_list|(
name|mbuf
argument_list|,
operator|&
name|pkt
argument_list|,
name|start
argument_list|,
name|free_slots
argument_list|)
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|gref
expr_stmt|;
name|req
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|req_cons
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|=
name|start
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|req_prod
operator|=
name|start
operator|+
literal|1
expr_stmt|;
name|xnb_unit_pvt
operator|.
name|rxs
operator|->
name|rsp_prod
operator|=
name|start
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|req
operator|->
name|gref
operator|=
name|canary
expr_stmt|;
name|req
operator|->
name|id
operator|=
name|canary
expr_stmt|;
name|nr_entries
operator|=
name|xnb_rxpkt2gnttab
argument_list|(
operator|&
name|pkt
argument_list|,
name|mbuf
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|DOMID_FIRST_RESERVED
argument_list|)
expr_stmt|;
comment|/* Inject the error*/
name|xnb_unit_pvt
operator|.
name|gnttab
index|[
literal|2
index|]
operator|.
name|status
operator|=
name|GNTST_general_error
expr_stmt|;
name|nr_reqs
operator|=
name|xnb_rxpkt2rsp
argument_list|(
operator|&
name|pkt
argument_list|,
name|xnb_unit_pvt
operator|.
name|gnttab
argument_list|,
name|nr_entries
argument_list|,
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|nr_reqs
operator|==
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|xnb_unit_pvt
operator|.
name|rxb
operator|.
name|rsp_prod_pvt
operator|==
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|RING_GET_RESPONSE
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxb
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|id
operator|==
name|id
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|rsp
operator|->
name|status
operator|==
name|NETIF_RSP_ERROR
argument_list|)
expr_stmt|;
name|req
operator|=
name|RING_GET_REQUEST
argument_list|(
operator|&
name|xnb_unit_pvt
operator|.
name|rxf
argument_list|,
name|start
operator|+
literal|1
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|req
operator|->
name|gref
operator|==
name|canary
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|req
operator|->
name|id
operator|==
name|canary
argument_list|)
expr_stmt|;
name|safe_m_freem
argument_list|(
operator|&
name|mbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
end_if

begin_comment
comment|/**  * xnb_add_mbuf_cksum on an ARP request packet  */
end_comment

begin_function
specifier|static
name|void
name|xnb_add_mbuf_cksum_arp
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|pkt_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ether_arp
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ether_arp
modifier|*
name|ep
decl_stmt|;
name|unsigned
name|char
name|pkt_orig
index|[
name|pkt_len
index|]
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|pkt_len
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
comment|/* Fill in an example arp request */
name|eh
operator|=
name|mtod
argument_list|(
name|mbufc
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|0
index|]
operator|=
literal|0xff
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|2
index|]
operator|=
literal|0xff
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|3
index|]
operator|=
literal|0xff
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|4
index|]
operator|=
literal|0xff
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|5
index|]
operator|=
literal|0xff
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|1
index|]
operator|=
literal|0x15
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|2
index|]
operator|=
literal|0x17
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|3
index|]
operator|=
literal|0xe9
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|4
index|]
operator|=
literal|0x30
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|5
index|]
operator|=
literal|0x68
expr_stmt|;
name|eh
operator|->
name|ether_type
operator|=
name|htons
argument_list|(
name|ETHERTYPE_ARP
argument_list|)
expr_stmt|;
name|ep
operator|=
operator|(
expr|struct
name|ether_arp
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|ep
operator|->
name|ea_hdr
operator|.
name|ar_hrd
operator|=
name|htons
argument_list|(
name|ARPHRD_ETHER
argument_list|)
expr_stmt|;
name|ep
operator|->
name|ea_hdr
operator|.
name|ar_pro
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|ep
operator|->
name|ea_hdr
operator|.
name|ar_hln
operator|=
literal|6
expr_stmt|;
name|ep
operator|->
name|ea_hdr
operator|.
name|ar_pln
operator|=
literal|4
expr_stmt|;
name|ep
operator|->
name|ea_hdr
operator|.
name|ar_op
operator|=
name|htons
argument_list|(
name|ARPOP_REQUEST
argument_list|)
expr_stmt|;
name|ep
operator|->
name|arp_sha
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|ep
operator|->
name|arp_sha
index|[
literal|1
index|]
operator|=
literal|0x15
expr_stmt|;
name|ep
operator|->
name|arp_sha
index|[
literal|2
index|]
operator|=
literal|0x17
expr_stmt|;
name|ep
operator|->
name|arp_sha
index|[
literal|3
index|]
operator|=
literal|0xe9
expr_stmt|;
name|ep
operator|->
name|arp_sha
index|[
literal|4
index|]
operator|=
literal|0x30
expr_stmt|;
name|ep
operator|->
name|arp_sha
index|[
literal|5
index|]
operator|=
literal|0x68
expr_stmt|;
name|ep
operator|->
name|arp_spa
index|[
literal|0
index|]
operator|=
literal|0xc0
expr_stmt|;
name|ep
operator|->
name|arp_spa
index|[
literal|1
index|]
operator|=
literal|0xa8
expr_stmt|;
name|ep
operator|->
name|arp_spa
index|[
literal|2
index|]
operator|=
literal|0x0a
expr_stmt|;
name|ep
operator|->
name|arp_spa
index|[
literal|3
index|]
operator|=
literal|0x04
expr_stmt|;
name|bzero
argument_list|(
operator|&
operator|(
name|ep
operator|->
name|arp_tha
operator|)
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|ep
operator|->
name|arp_tpa
index|[
literal|0
index|]
operator|=
literal|0xc0
expr_stmt|;
name|ep
operator|->
name|arp_tpa
index|[
literal|1
index|]
operator|=
literal|0xa8
expr_stmt|;
name|ep
operator|->
name|arp_tpa
index|[
literal|2
index|]
operator|=
literal|0x0a
expr_stmt|;
name|ep
operator|->
name|arp_tpa
index|[
literal|3
index|]
operator|=
literal|0x06
expr_stmt|;
comment|/* fill in the length field */
name|mbufc
operator|->
name|m_len
operator|=
name|pkt_len
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|pkt_len
expr_stmt|;
comment|/* indicate that the netfront uses hw-assisted checksums */
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
operator||
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
comment|/* Make a backup copy of the packet */
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|mbufc
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
argument_list|,
name|pkt_orig
argument_list|,
name|pkt_len
argument_list|)
expr_stmt|;
comment|/* Function under test */
name|xnb_add_mbuf_cksum
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
comment|/* Verify that the packet's data did not change */
name|XNB_ASSERT
argument_list|(
name|bcmp
argument_list|(
name|mtod
argument_list|(
name|mbufc
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
argument_list|,
name|pkt_orig
argument_list|,
name|pkt_len
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Helper function that populates the ethernet header and IP header used by  * some of the xnb_add_mbuf_cksum unit tests.  m must already be allocated  * and must be large enough  */
end_comment

begin_function
specifier|static
name|void
name|xnb_fill_eh_and_ip
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|uint16_t
name|ip_len
parameter_list|,
name|uint16_t
name|ip_id
parameter_list|,
name|uint16_t
name|ip_p
parameter_list|,
name|uint16_t
name|ip_off
parameter_list|,
name|uint16_t
name|ip_sum
parameter_list|)
block|{
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|iph
decl_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|1
index|]
operator|=
literal|0x16
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|2
index|]
operator|=
literal|0x3e
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|3
index|]
operator|=
literal|0x23
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|4
index|]
operator|=
literal|0x50
expr_stmt|;
name|eh
operator|->
name|ether_dhost
index|[
literal|5
index|]
operator|=
literal|0x0b
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|1
index|]
operator|=
literal|0x16
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|2
index|]
operator|=
literal|0x30
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|3
index|]
operator|=
literal|0x00
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|4
index|]
operator|=
literal|0x00
expr_stmt|;
name|eh
operator|->
name|ether_shost
index|[
literal|5
index|]
operator|=
literal|0x00
expr_stmt|;
name|eh
operator|->
name|ether_type
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|iph
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|iph
operator|->
name|ip_hl
operator|=
literal|0x5
expr_stmt|;
comment|/* 5 dwords == 20 bytes */
name|iph
operator|->
name|ip_v
operator|=
literal|4
expr_stmt|;
comment|/* IP v4 */
name|iph
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|iph
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|ip_len
argument_list|)
expr_stmt|;
name|iph
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
name|ip_id
argument_list|)
expr_stmt|;
name|iph
operator|->
name|ip_off
operator|=
name|htons
argument_list|(
name|ip_off
argument_list|)
expr_stmt|;
name|iph
operator|->
name|ip_ttl
operator|=
literal|64
expr_stmt|;
name|iph
operator|->
name|ip_p
operator|=
name|ip_p
expr_stmt|;
name|iph
operator|->
name|ip_sum
operator|=
name|htons
argument_list|(
name|ip_sum
argument_list|)
expr_stmt|;
name|iph
operator|->
name|ip_src
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
literal|0xc0a80a04
argument_list|)
expr_stmt|;
name|iph
operator|->
name|ip_dst
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
literal|0xc0a80a05
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_add_mbuf_cksum on an ICMP packet, based on a tcpdump of an actual  * ICMP packet  */
end_comment

begin_function
specifier|static
name|void
name|xnb_add_mbuf_cksum_icmp
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|icmp_len
init|=
literal|64
decl_stmt|;
comment|/* set by ping(1) */
specifier|const
name|size_t
name|pkt_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
name|icmp_len
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|iph
decl_stmt|;
name|struct
name|icmp
modifier|*
name|icmph
decl_stmt|;
name|unsigned
name|char
name|pkt_orig
index|[
name|icmp_len
index|]
decl_stmt|;
name|uint32_t
modifier|*
name|tv_field
decl_stmt|;
name|uint8_t
modifier|*
name|data_payload
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|uint16_t
name|ICMP_CSUM
init|=
literal|0xaed7
decl_stmt|;
specifier|const
name|uint16_t
name|IP_CSUM
init|=
literal|0xe533
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|pkt_len
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
comment|/* Fill in an example ICMP ping request */
name|eh
operator|=
name|mtod
argument_list|(
name|mbufc
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|xnb_fill_eh_and_ip
argument_list|(
name|mbufc
argument_list|,
literal|84
argument_list|,
literal|28
argument_list|,
name|IPPROTO_ICMP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|iph
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|icmph
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
name|iph
operator|+
literal|1
operator|)
expr_stmt|;
name|icmph
operator|->
name|icmp_type
operator|=
name|ICMP_ECHO
expr_stmt|;
name|icmph
operator|->
name|icmp_code
operator|=
literal|0
expr_stmt|;
name|icmph
operator|->
name|icmp_cksum
operator|=
name|htons
argument_list|(
name|ICMP_CSUM
argument_list|)
expr_stmt|;
name|icmph
operator|->
name|icmp_id
operator|=
name|htons
argument_list|(
literal|31492
argument_list|)
expr_stmt|;
name|icmph
operator|->
name|icmp_seq
operator|=
name|htons
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * ping(1) uses bcopy to insert a native-endian timeval after icmp_seq. 	 * For this test, we will set the bytes individually for portability. 	 */
name|tv_field
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|&
operator|(
name|icmph
operator|->
name|icmp_hun
operator|)
operator|)
expr_stmt|;
name|tv_field
index|[
literal|0
index|]
operator|=
literal|0x4f02cfac
expr_stmt|;
name|tv_field
index|[
literal|1
index|]
operator|=
literal|0x0007c46a
expr_stmt|;
comment|/* 	 * Remainder of packet is an incrmenting 8 bit integer, starting with 8 	 */
name|data_payload
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|&
name|tv_field
index|[
literal|2
index|]
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|8
init|;
name|i
operator|<
literal|37
condition|;
name|i
operator|++
control|)
block|{
operator|*
name|data_payload
operator|++
operator|=
name|i
expr_stmt|;
block|}
comment|/* fill in the length field */
name|mbufc
operator|->
name|m_len
operator|=
name|pkt_len
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|pkt_len
expr_stmt|;
comment|/* indicate that the netfront uses hw-assisted checksums */
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
operator||
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|mbufc
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
argument_list|,
name|pkt_orig
argument_list|,
name|icmp_len
argument_list|)
expr_stmt|;
comment|/* Function under test */
name|xnb_add_mbuf_cksum
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
comment|/* Check the IP checksum */
name|XNB_ASSERT
argument_list|(
name|iph
operator|->
name|ip_sum
operator|==
name|htons
argument_list|(
name|IP_CSUM
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check that the ICMP packet did not change */
name|XNB_ASSERT
argument_list|(
name|bcmp
argument_list|(
name|icmph
argument_list|,
name|pkt_orig
argument_list|,
name|icmp_len
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_add_mbuf_cksum on a UDP packet, based on a tcpdump of an actual  * UDP packet  */
end_comment

begin_function
specifier|static
name|void
name|xnb_add_mbuf_cksum_udp
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|udp_len
init|=
literal|16
decl_stmt|;
specifier|const
name|size_t
name|pkt_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
name|udp_len
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|iph
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|udp
decl_stmt|;
name|uint8_t
modifier|*
name|data_payload
decl_stmt|;
specifier|const
name|uint16_t
name|IP_CSUM
init|=
literal|0xe56b
decl_stmt|;
specifier|const
name|uint16_t
name|UDP_CSUM
init|=
literal|0xdde2
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|pkt_len
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
comment|/* Fill in an example UDP packet made by 'uname | nc -u<host> 2222 */
name|eh
operator|=
name|mtod
argument_list|(
name|mbufc
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|xnb_fill_eh_and_ip
argument_list|(
name|mbufc
argument_list|,
literal|36
argument_list|,
literal|4
argument_list|,
name|IPPROTO_UDP
argument_list|,
literal|0
argument_list|,
literal|0xbaad
argument_list|)
expr_stmt|;
name|iph
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|udp
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
name|iph
operator|+
literal|1
operator|)
expr_stmt|;
name|udp
operator|->
name|uh_sport
operator|=
name|htons
argument_list|(
literal|0x51ae
argument_list|)
expr_stmt|;
name|udp
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
literal|0x08ae
argument_list|)
expr_stmt|;
name|udp
operator|->
name|uh_ulen
operator|=
name|htons
argument_list|(
name|udp_len
argument_list|)
expr_stmt|;
name|udp
operator|->
name|uh_sum
operator|=
name|htons
argument_list|(
literal|0xbaad
argument_list|)
expr_stmt|;
comment|/* xnb_add_mbuf_cksum will fill this in */
name|data_payload
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|udp
operator|+
literal|1
operator|)
expr_stmt|;
name|data_payload
index|[
literal|0
index|]
operator|=
literal|'F'
expr_stmt|;
name|data_payload
index|[
literal|1
index|]
operator|=
literal|'r'
expr_stmt|;
name|data_payload
index|[
literal|2
index|]
operator|=
literal|'e'
expr_stmt|;
name|data_payload
index|[
literal|3
index|]
operator|=
literal|'e'
expr_stmt|;
name|data_payload
index|[
literal|4
index|]
operator|=
literal|'B'
expr_stmt|;
name|data_payload
index|[
literal|5
index|]
operator|=
literal|'S'
expr_stmt|;
name|data_payload
index|[
literal|6
index|]
operator|=
literal|'D'
expr_stmt|;
name|data_payload
index|[
literal|7
index|]
operator|=
literal|'\n'
expr_stmt|;
comment|/* fill in the length field */
name|mbufc
operator|->
name|m_len
operator|=
name|pkt_len
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|pkt_len
expr_stmt|;
comment|/* indicate that the netfront uses hw-assisted checksums */
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
operator||
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
comment|/* Function under test */
name|xnb_add_mbuf_cksum
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
comment|/* Check the checksums */
name|XNB_ASSERT
argument_list|(
name|iph
operator|->
name|ip_sum
operator|==
name|htons
argument_list|(
name|IP_CSUM
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|udp
operator|->
name|uh_sum
operator|==
name|htons
argument_list|(
name|UDP_CSUM
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Helper function that populates a TCP packet used by all of the  * xnb_add_mbuf_cksum tcp unit tests.  m must already be allocated and must be  * large enough  */
end_comment

begin_function
specifier|static
name|void
name|xnb_fill_tcp
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|iph
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tcp
decl_stmt|;
name|uint32_t
modifier|*
name|options
decl_stmt|;
name|uint8_t
modifier|*
name|data_payload
decl_stmt|;
comment|/* Fill in an example TCP packet made by 'uname | nc<host> 2222' */
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|xnb_fill_eh_and_ip
argument_list|(
name|m
argument_list|,
literal|60
argument_list|,
literal|8
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|IP_DF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|iph
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|tcp
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|iph
operator|+
literal|1
operator|)
expr_stmt|;
name|tcp
operator|->
name|th_sport
operator|=
name|htons
argument_list|(
literal|0x9cd9
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|th_dport
operator|=
name|htons
argument_list|(
literal|2222
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|th_seq
operator|=
name|htonl
argument_list|(
literal|0x00f72b10
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|th_ack
operator|=
name|htonl
argument_list|(
literal|0x7f37ba6c
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|th_x2
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|th_off
operator|=
literal|8
expr_stmt|;
name|tcp
operator|->
name|th_flags
operator|=
literal|0x18
expr_stmt|;
name|tcp
operator|->
name|th_win
operator|=
name|htons
argument_list|(
literal|0x410
argument_list|)
expr_stmt|;
comment|/* th_sum is incorrect; will be inserted by function under test */
name|tcp
operator|->
name|th_sum
operator|=
name|htons
argument_list|(
literal|0xbaad
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|th_urp
operator|=
name|htons
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * The following 12 bytes of options encode: 	 * [nop, nop, TS val 33247 ecr 3457687679] 	 */
name|options
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|tcp
operator|+
literal|1
operator|)
expr_stmt|;
name|options
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
literal|0x0101080a
argument_list|)
expr_stmt|;
name|options
index|[
literal|1
index|]
operator|=
name|htonl
argument_list|(
literal|0x000081df
argument_list|)
expr_stmt|;
name|options
index|[
literal|2
index|]
operator|=
name|htonl
argument_list|(
literal|0xce18207f
argument_list|)
expr_stmt|;
name|data_payload
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|&
name|options
index|[
literal|3
index|]
operator|)
expr_stmt|;
name|data_payload
index|[
literal|0
index|]
operator|=
literal|'F'
expr_stmt|;
name|data_payload
index|[
literal|1
index|]
operator|=
literal|'r'
expr_stmt|;
name|data_payload
index|[
literal|2
index|]
operator|=
literal|'e'
expr_stmt|;
name|data_payload
index|[
literal|3
index|]
operator|=
literal|'e'
expr_stmt|;
name|data_payload
index|[
literal|4
index|]
operator|=
literal|'B'
expr_stmt|;
name|data_payload
index|[
literal|5
index|]
operator|=
literal|'S'
expr_stmt|;
name|data_payload
index|[
literal|6
index|]
operator|=
literal|'D'
expr_stmt|;
name|data_payload
index|[
literal|7
index|]
operator|=
literal|'\n'
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_add_mbuf_cksum on a TCP packet, based on a tcpdump of an actual TCP  * packet  */
end_comment

begin_function
specifier|static
name|void
name|xnb_add_mbuf_cksum_tcp
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|payload_len
init|=
literal|8
decl_stmt|;
specifier|const
name|size_t
name|tcp_options_len
init|=
literal|12
decl_stmt|;
specifier|const
name|size_t
name|pkt_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
operator|+
name|tcp_options_len
operator|+
name|payload_len
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|iph
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tcp
decl_stmt|;
specifier|const
name|uint16_t
name|IP_CSUM
init|=
literal|0xa55a
decl_stmt|;
specifier|const
name|uint16_t
name|TCP_CSUM
init|=
literal|0x2f64
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|pkt_len
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
comment|/* Fill in an example TCP packet made by 'uname | nc<host> 2222' */
name|xnb_fill_tcp
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mbufc
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|iph
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|tcp
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|iph
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* fill in the length field */
name|mbufc
operator|->
name|m_len
operator|=
name|pkt_len
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|pkt_len
expr_stmt|;
comment|/* indicate that the netfront uses hw-assisted checksums */
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
operator||
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
comment|/* Function under test */
name|xnb_add_mbuf_cksum
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
comment|/* Check the checksums */
name|XNB_ASSERT
argument_list|(
name|iph
operator|->
name|ip_sum
operator|==
name|htons
argument_list|(
name|IP_CSUM
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|tcp
operator|->
name|th_sum
operator|==
name|htons
argument_list|(
name|TCP_CSUM
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * xnb_add_mbuf_cksum on a TCP packet that does not use HW assisted checksums  */
end_comment

begin_function
specifier|static
name|void
name|xnb_add_mbuf_cksum_tcp_swcksum
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|size_t
name|payload_len
init|=
literal|8
decl_stmt|;
specifier|const
name|size_t
name|tcp_options_len
init|=
literal|12
decl_stmt|;
specifier|const
name|size_t
name|pkt_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
operator|+
name|tcp_options_len
operator|+
name|payload_len
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mbufc
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|iph
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tcp
decl_stmt|;
comment|/* Use deliberately bad checksums, and verify that they don't get */
comment|/* corrected by xnb_add_mbuf_cksum */
specifier|const
name|uint16_t
name|IP_CSUM
init|=
literal|0xdead
decl_stmt|;
specifier|const
name|uint16_t
name|TCP_CSUM
init|=
literal|0xbeef
decl_stmt|;
name|mbufc
operator|=
name|m_getm
argument_list|(
name|NULL
argument_list|,
name|pkt_len
argument_list|,
name|M_WAITOK
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
comment|/* Fill in an example TCP packet made by 'uname | nc<host> 2222' */
name|xnb_fill_tcp
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mbufc
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|iph
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|iph
operator|->
name|ip_sum
operator|=
name|htons
argument_list|(
name|IP_CSUM
argument_list|)
expr_stmt|;
name|tcp
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|iph
operator|+
literal|1
operator|)
expr_stmt|;
name|tcp
operator|->
name|th_sum
operator|=
name|htons
argument_list|(
name|TCP_CSUM
argument_list|)
expr_stmt|;
comment|/* fill in the length field */
name|mbufc
operator|->
name|m_len
operator|=
name|pkt_len
expr_stmt|;
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|pkt_len
expr_stmt|;
comment|/* indicate that the netfront does not use hw-assisted checksums */
name|mbufc
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
literal|0
expr_stmt|;
comment|/* Function under test */
name|xnb_add_mbuf_cksum
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
comment|/* Check that the checksums didn't change */
name|XNB_ASSERT
argument_list|(
name|iph
operator|->
name|ip_sum
operator|==
name|htons
argument_list|(
name|IP_CSUM
argument_list|)
argument_list|)
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|tcp
operator|->
name|th_sum
operator|==
name|htons
argument_list|(
name|TCP_CSUM
argument_list|)
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mbufc
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET || INET6 */
end_comment

begin_comment
comment|/**  * sscanf on unsigned chars  */
end_comment

begin_function
specifier|static
name|void
name|xnb_sscanf_hhu
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
name|mystr
index|[]
init|=
literal|"137"
decl_stmt|;
name|uint8_t
name|dest
index|[
literal|12
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
name|dest
index|[
name|i
index|]
operator|=
literal|'X'
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|sscanf
argument_list|(
name|mystr
argument_list|,
literal|"%hhu"
argument_list|,
operator|&
name|dest
index|[
literal|4
index|]
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
name|XNB_ASSERT
argument_list|(
name|dest
index|[
name|i
index|]
operator|==
operator|(
name|i
operator|==
literal|4
condition|?
literal|137
else|:
literal|'X'
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * sscanf on signed chars  */
end_comment

begin_function
specifier|static
name|void
name|xnb_sscanf_hhd
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
name|mystr
index|[]
init|=
literal|"-27"
decl_stmt|;
name|int8_t
name|dest
index|[
literal|12
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
name|dest
index|[
name|i
index|]
operator|=
literal|'X'
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|sscanf
argument_list|(
name|mystr
argument_list|,
literal|"%hhd"
argument_list|,
operator|&
name|dest
index|[
literal|4
index|]
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
name|XNB_ASSERT
argument_list|(
name|dest
index|[
name|i
index|]
operator|==
operator|(
name|i
operator|==
literal|4
condition|?
operator|-
literal|27
else|:
literal|'X'
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * sscanf on signed long longs  */
end_comment

begin_function
specifier|static
name|void
name|xnb_sscanf_lld
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
name|mystr
index|[]
init|=
literal|"-123456789012345"
decl_stmt|;
comment|/* about -2**47 */
name|long
name|long
name|dest
index|[
literal|3
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|dest
index|[
name|i
index|]
operator|=
operator|(
name|long
name|long
operator|)
literal|0xdeadbeefdeadbeef
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|sscanf
argument_list|(
name|mystr
argument_list|,
literal|"%lld"
argument_list|,
operator|&
name|dest
index|[
literal|1
index|]
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|XNB_ASSERT
argument_list|(
name|dest
index|[
name|i
index|]
operator|==
operator|(
name|i
operator|!=
literal|1
condition|?
operator|(
name|long
name|long
operator|)
literal|0xdeadbeefdeadbeef
else|:
operator|-
literal|123456789012345
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * sscanf on unsigned long longs  */
end_comment

begin_function
specifier|static
name|void
name|xnb_sscanf_llu
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
name|mystr
index|[]
init|=
literal|"12802747070103273189"
decl_stmt|;
name|unsigned
name|long
name|long
name|dest
index|[
literal|3
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|dest
index|[
name|i
index|]
operator|=
operator|(
name|long
name|long
operator|)
literal|0xdeadbeefdeadbeef
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|sscanf
argument_list|(
name|mystr
argument_list|,
literal|"%llu"
argument_list|,
operator|&
name|dest
index|[
literal|1
index|]
argument_list|)
operator|==
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|XNB_ASSERT
argument_list|(
name|dest
index|[
name|i
index|]
operator|==
operator|(
name|i
operator|!=
literal|1
condition|?
operator|(
name|long
name|long
operator|)
literal|0xdeadbeefdeadbeef
else|:
literal|12802747070103273189ull
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * sscanf on unsigned short short n's  */
end_comment

begin_function
specifier|static
name|void
name|xnb_sscanf_hhn
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
name|mystr
index|[]
init|=
literal|"000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f"
literal|"202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"
literal|"404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f"
decl_stmt|;
name|unsigned
name|char
name|dest
index|[
literal|12
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
name|dest
index|[
name|i
index|]
operator|=
operator|(
name|unsigned
name|char
operator|)
literal|'X'
expr_stmt|;
name|XNB_ASSERT
argument_list|(
name|sscanf
argument_list|(
name|mystr
argument_list|,
literal|"000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f"
literal|"202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f"
literal|"404142434445464748494a4b4c4d4e4f%hhn"
argument_list|,
operator|&
name|dest
index|[
literal|4
index|]
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
name|XNB_ASSERT
argument_list|(
name|dest
index|[
name|i
index|]
operator|==
operator|(
name|i
operator|==
literal|4
condition|?
literal|160
else|:
literal|'X'
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_rtwn.c,v 1.6 2015/08/28 00:03:53 deraadt Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2010 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2015 Stefan Sperling<stsp@openbsd.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for Realtek RTL8188CE  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/firmware.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_regdomain.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ratectl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwnreg.h>
end_include

begin_define
define|#
directive|define
name|RTWN_DEBUG
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|RTWN_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
value|do { if (sc->sc_debug> 0) printf x; } while (0)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|do { if (sc->sc_debug>= (n)) printf x; } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * PCI configuration space registers.  */
end_comment

begin_define
define|#
directive|define
name|RTWN_PCI_IOBA
value|0x10
end_define

begin_comment
comment|/* i/o mapped base */
end_comment

begin_define
define|#
directive|define
name|RTWN_PCI_MMBA
value|0x18
end_define

begin_comment
comment|/* memory mapped base */
end_comment

begin_define
define|#
directive|define
name|RTWN_INT_ENABLE
value|(R92C_IMR_ROK | R92C_IMR_VODOK | R92C_IMR_VIDOK | \ 			R92C_IMR_BEDOK | R92C_IMR_BKDOK | R92C_IMR_MGNTDOK | \ 			R92C_IMR_HIGHDOK | R92C_IMR_BDOK | R92C_IMR_RDU | \ 			R92C_IMR_RXFOVW)
end_define

begin_struct
struct|struct
name|rtwn_ident
block|{
name|uint16_t
name|vendor
decl_stmt|;
name|uint16_t
name|device
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|rtwn_ident
name|rtwn_ident_table
index|[]
init|=
block|{
block|{
literal|0x10ec
block|,
literal|0x8176
block|,
literal|"Realtek RTL8188CE"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|rtwn_dma_map_addr
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_setup_rx_desc
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|struct
name|r92c_rx_desc
modifier|*
parameter_list|,
name|bus_addr_t
parameter_list|,
name|size_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_alloc_rx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_reset_rx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_free_rx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_alloc_tx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_reset_tx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_free_tx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|rtwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
specifier|const
name|char
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
parameter_list|,
name|enum
name|ieee80211_opmode
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_write_1
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_write_2
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_write_4
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|rtwn_read_1
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|rtwn_read_2
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|rtwn_read_4
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_fw_cmd
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
specifier|const
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_rf_write
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|rtwn_rf_read
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_llt_write
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|rtwn_efuse_read_1
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_efuse_read
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_read_chipid
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_read_rom
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_ra_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_tsf_sync_enable
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_set_led
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_calib_to
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
parameter_list|,
name|enum
name|ieee80211_state
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_updateedca
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_update_avgrssi
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int8_t
name|rtwn_get_rssi
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_rx_frame
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|struct
name|r92c_rx_desc
modifier|*
parameter_list|,
name|struct
name|rtwn_rx_data
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_tx
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_tx_done
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_transmit
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_parent
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_start
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_watchdog
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_power_on
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_llt_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_fw_reset
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_fw_loadpage
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_load_firmware
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_dma_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_mac_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_bb_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_rf_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_cam_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_pa_bias_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_rxfilter_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_edca_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_write_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_get_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|uint16_t
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_set_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_set_rx_bssid_all
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_set_gain
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_update_mcast
parameter_list|(
name|struct
name|ieee80211com
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_set_chan
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_iq_calib_chain
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_iq_calib_run
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_iq_calib_compare_results
parameter_list|(
name|uint16_t
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_iq_calib_write_results
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
index|[
literal|2
index|]
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_iq_calib
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_lc_calib
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_temp_calib
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_stop_locked
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_stop
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rtwn_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Aliases. */
end_comment

begin_define
define|#
directive|define
name|rtwn_bb_write
value|rtwn_write_4
end_define

begin_define
define|#
directive|define
name|rtwn_bb_read
value|rtwn_read_4
end_define

begin_function_decl
specifier|static
name|int
name|rtwn_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_suspend
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtwn_resume
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|rtwn_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|rtwn_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|rtwn_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|rtwn_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|rtwn_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|rtwn_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|rtwn_resume
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|rtwn_driver
init|=
block|{
literal|"rtwn"
block|,
name|rtwn_methods
block|,
expr|sizeof
operator|(
expr|struct
name|rtwn_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|rtwn_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|rtwn
argument_list|,
name|pci
argument_list|,
name|rtwn_driver
argument_list|,
name|rtwn_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|rtwn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|rtwn
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|rtwn
argument_list|,
name|wlan
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|rtwn
argument_list|,
name|firmware
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|rtwn_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|const
name|struct
name|rtwn_ident
modifier|*
name|ident
decl_stmt|;
for|for
control|(
name|ident
operator|=
name|rtwn_ident_table
init|;
name|ident
operator|->
name|name
operator|!=
name|NULL
condition|;
name|ident
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
name|ident
operator|->
name|vendor
operator|&&
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|ident
operator|->
name|device
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|ident
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|lcsr
decl_stmt|;
name|uint8_t
name|bands
index|[
name|IEEE80211_MODE_BYTES
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
decl_stmt|,
name|error
decl_stmt|,
name|rid
decl_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_debug
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Get the offset of the PCI Express Capability Structure in PCI 	 * Configuration Space. 	 */
name|error
operator|=
name|pci_find_cap
argument_list|(
name|dev
argument_list|,
name|PCIY_EXPRESS
argument_list|,
operator|&
name|sc
operator|->
name|sc_cap_off
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"PCIe capability structure not found!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Enable bus-mastering. */
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't map mem space\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|sc
operator|->
name|sc_st
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
comment|/* Install interrupt handler. */
name|count
operator|=
literal|1
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pci_alloc_msi
argument_list|(
name|dev
argument_list|,
operator|&
name|count
argument_list|)
operator|==
literal|0
condition|)
name|rid
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
operator||
operator|(
name|rid
operator|!=
literal|0
condition|?
literal|0
else|:
name|RF_SHAREABLE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't map interrupt\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|RTWN_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|calib_to
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_to
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mbufq_init
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|error
operator|=
name|rtwn_read_chipid
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unsupported test chip\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Disable PCIe Active State Power Management (ASPM). */
name|lcsr
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|sc
operator|->
name|sc_cap_off
operator|+
name|PCIER_LINK_CTL
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|lcsr
operator|&=
operator|~
name|PCIEM_LINK_CTL_ASPMC
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|sc
operator|->
name|sc_cap_off
operator|+
name|PCIER_LINK_CTL
argument_list|,
name|lcsr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Allocate Tx/Rx buffers. */
name|error
operator|=
name|rtwn_alloc_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate Rx buffers\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_NTXQUEUES
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|rtwn_alloc_tx_list
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate Tx buffers\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
comment|/* Determine number of Tx/Rx chains. */
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C
condition|)
block|{
name|sc
operator|->
name|ntxchains
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C_1T2R
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|ntxchains
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|nrxchains
operator|=
literal|1
expr_stmt|;
block|}
name|rtwn_read_rom
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"MAC/BB RTL%s, RF 6052 %dT%dR\n"
argument_list|,
operator|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C
operator|)
condition|?
literal|"8192CE"
else|:
literal|"8188CE"
argument_list|,
name|sc
operator|->
name|ntxchains
argument_list|,
name|sc
operator|->
name|nrxchains
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_softc
operator|=
name|sc
expr_stmt|;
name|ic
operator|->
name|ic_name
operator|=
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|IEEE80211_M_STA
expr_stmt|;
name|ic
operator|->
name|ic_phytype
operator|=
name|IEEE80211_T_OFDM
expr_stmt|;
comment|/* not only, but not used */
comment|/* set device capabilities */
name|ic
operator|->
name|ic_caps
operator|=
name|IEEE80211_C_STA
comment|/* station mode */
operator||
name|IEEE80211_C_MONITOR
comment|/* monitor mode */
operator||
name|IEEE80211_C_SHPREAMBLE
comment|/* short preamble supported */
operator||
name|IEEE80211_C_SHSLOT
comment|/* short slot time supported */
operator||
name|IEEE80211_C_WPA
comment|/* capable of WPA1+WPA2 */
operator||
name|IEEE80211_C_BGSCAN
comment|/* capable of bg scanning */
operator||
name|IEEE80211_C_WME
comment|/* 802.11e */
expr_stmt|;
name|memset
argument_list|(
name|bands
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bands
argument_list|)
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11B
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
name|bands
argument_list|,
name|IEEE80211_MODE_11G
argument_list|)
expr_stmt|;
name|ieee80211_init_channels
argument_list|(
name|ic
argument_list|,
name|NULL
argument_list|,
name|bands
argument_list|)
expr_stmt|;
name|ieee80211_ifattach
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_wme
operator|.
name|wme_update
operator|=
name|rtwn_updateedca
expr_stmt|;
name|ic
operator|->
name|ic_update_mcast
operator|=
name|rtwn_update_mcast
expr_stmt|;
name|ic
operator|->
name|ic_scan_start
operator|=
name|rtwn_scan_start
expr_stmt|;
name|ic
operator|->
name|ic_scan_end
operator|=
name|rtwn_scan_end
expr_stmt|;
name|ic
operator|->
name|ic_set_channel
operator|=
name|rtwn_set_channel
expr_stmt|;
name|ic
operator|->
name|ic_raw_xmit
operator|=
name|rtwn_raw_xmit
expr_stmt|;
name|ic
operator|->
name|ic_transmit
operator|=
name|rtwn_transmit
expr_stmt|;
name|ic
operator|->
name|ic_parent
operator|=
name|rtwn_parent
expr_stmt|;
name|ic
operator|->
name|ic_vap_create
operator|=
name|rtwn_vap_create
expr_stmt|;
name|ic
operator|->
name|ic_vap_delete
operator|=
name|rtwn_vap_delete
expr_stmt|;
name|ieee80211_radiotap_attach
argument_list|(
name|ic
argument_list|,
operator|&
name|sc
operator|->
name|sc_txtap
operator|.
name|wt_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_txtap
argument_list|)
argument_list|,
name|RTWN_TX_RADIOTAP_PRESENT
argument_list|,
operator|&
name|sc
operator|->
name|sc_rxtap
operator|.
name|wr_ihdr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|sc_rxtap
argument_list|)
argument_list|,
name|RTWN_RX_RADIOTAP_PRESENT
argument_list|)
expr_stmt|;
comment|/* 	 * Hook our interrupt after all initialization is complete. 	 */
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|rtwn_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't establish interrupt, error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|ieee80211_announce
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|rtwn_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_softc
operator|!=
name|NULL
condition|)
block|{
name|rtwn_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|calib_to
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_to
argument_list|)
expr_stmt|;
name|ieee80211_ifdetach
argument_list|(
operator|&
name|sc
operator|->
name|sc_ic
argument_list|)
expr_stmt|;
name|mbufq_drain
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
expr_stmt|;
block|}
comment|/* Uninstall interrupt handler. */
if|if
condition|(
name|sc
operator|->
name|irq
operator|!=
name|NULL
condition|)
block|{
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|sc_ih
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|irq
argument_list|)
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* Free Tx/Rx buffers. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_NTXQUEUES
condition|;
name|i
operator|++
control|)
name|rtwn_free_tx_list
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|rtwn_free_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|mem
argument_list|)
argument_list|,
name|sc
operator|->
name|mem
argument_list|)
expr_stmt|;
name|RTWN_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_dma_map_addr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return;
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"too many DMA segments, %d should be 1"
operator|,
name|nsegs
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_setup_rx_desc
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|r92c_rx_desc
modifier|*
name|desc
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|memset
argument_list|(
name|desc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|desc
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|rxdw0
operator|=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_RXDW0_PKTLEN
argument_list|,
name|len
argument_list|)
operator||
operator|(
operator|(
name|idx
operator|==
name|RTWN_RX_LIST_COUNT
operator|-
literal|1
operator|)
condition|?
name|R92C_RXDW0_EOR
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|rxbufaddr
operator|=
name|htole32
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|bus_space_barrier
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_mapsize
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
name|desc
operator|->
name|rxdw0
operator||=
name|htole32
argument_list|(
name|R92C_RXDW0_OWN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_alloc_rx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|rtwn_rx_ring
modifier|*
name|rx_ring
init|=
operator|&
name|sc
operator|->
name|rx_ring
decl_stmt|;
name|struct
name|rtwn_rx_data
modifier|*
name|rx_data
decl_stmt|;
name|bus_size_t
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
comment|/* Allocate Rx descriptors. */
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|r92c_rx_desc
argument_list|)
operator|*
name|RTWN_RX_LIST_COUNT
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|rx_ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create rx desc DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|rx_ring
operator|->
name|desc_dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|rx_ring
operator|->
name|desc
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_COHERENT
argument_list|,
operator|&
name|rx_ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate rx desc\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|rx_ring
operator|->
name|desc_dmat
argument_list|,
name|rx_ring
operator|->
name|desc_map
argument_list|,
name|rx_ring
operator|->
name|desc
argument_list|,
name|size
argument_list|,
name|rtwn_dma_map_addr
argument_list|,
operator|&
name|rx_ring
operator|->
name|paddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load rx desc DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|rx_ring
operator|->
name|desc_dmat
argument_list|,
name|rx_ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Create RX buffer DMA tag. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|rx_ring
operator|->
name|data_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create rx buf DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Allocate Rx buffers. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_RX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|rx_data
operator|=
operator|&
name|rx_ring
operator|->
name|rx_data
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|rx_ring
operator|->
name|data_dmat
argument_list|,
literal|0
argument_list|,
operator|&
name|rx_data
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create rx buf DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rx_data
operator|->
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_data
operator|->
name|m
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not allocate rx mbuf\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|rx_ring
operator|->
name|data_dmat
argument_list|,
name|rx_data
operator|->
name|map
argument_list|,
name|mtod
argument_list|(
name|rx_data
operator|->
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|MCLBYTES
argument_list|,
name|rtwn_dma_map_addr
argument_list|,
operator|&
name|rx_data
operator|->
name|paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load rx buf DMA map"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rtwn_setup_rx_desc
argument_list|(
name|sc
argument_list|,
operator|&
name|rx_ring
operator|->
name|desc
index|[
name|i
index|]
argument_list|,
name|rx_data
operator|->
name|paddr
argument_list|,
name|MCLBYTES
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|rtwn_free_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_reset_rx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|rtwn_rx_ring
modifier|*
name|rx_ring
init|=
operator|&
name|sc
operator|->
name|rx_ring
decl_stmt|;
name|struct
name|rtwn_rx_data
modifier|*
name|rx_data
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_RX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|rx_data
operator|=
operator|&
name|rx_ring
operator|->
name|rx_data
index|[
name|i
index|]
expr_stmt|;
name|rtwn_setup_rx_desc
argument_list|(
name|sc
argument_list|,
operator|&
name|rx_ring
operator|->
name|desc
index|[
name|i
index|]
argument_list|,
name|rx_data
operator|->
name|paddr
argument_list|,
name|MCLBYTES
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_free_rx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|rtwn_rx_ring
modifier|*
name|rx_ring
init|=
operator|&
name|sc
operator|->
name|rx_ring
decl_stmt|;
name|struct
name|rtwn_rx_data
modifier|*
name|rx_data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|rx_ring
operator|->
name|desc_dmat
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|rx_ring
operator|->
name|desc
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|rx_ring
operator|->
name|desc_dmat
argument_list|,
name|rx_ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|rx_ring
operator|->
name|desc_dmat
argument_list|,
name|rx_ring
operator|->
name|desc
argument_list|,
name|rx_ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
name|rx_ring
operator|->
name|desc
operator|=
name|NULL
expr_stmt|;
block|}
name|bus_dma_tag_destroy
argument_list|(
name|rx_ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
name|rx_ring
operator|->
name|desc_dmat
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_RX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|rx_data
operator|=
operator|&
name|rx_ring
operator|->
name|rx_data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rx_data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|rx_ring
operator|->
name|data_dmat
argument_list|,
name|rx_data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rx_data
operator|->
name|m
argument_list|)
expr_stmt|;
name|rx_data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
name|bus_dmamap_destroy
argument_list|(
name|rx_ring
operator|->
name|data_dmat
argument_list|,
name|rx_data
operator|->
name|map
argument_list|)
expr_stmt|;
name|rx_data
operator|->
name|map
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rx_ring
operator|->
name|data_dmat
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|rx_ring
operator|->
name|data_dmat
argument_list|)
expr_stmt|;
name|rx_ring
operator|->
name|data_dmat
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_alloc_tx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|rtwn_tx_ring
modifier|*
name|tx_ring
init|=
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
decl_stmt|;
name|struct
name|rtwn_tx_data
modifier|*
name|tx_data
decl_stmt|;
name|bus_size_t
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|r92c_tx_desc
argument_list|)
operator|*
name|RTWN_TX_LIST_COUNT
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
name|size
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tx_ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create tx ring DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tx_ring
operator|->
name|desc
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|tx_ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't map tx ring DMA memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
name|tx_ring
operator|->
name|desc_map
argument_list|,
name|tx_ring
operator|->
name|desc
argument_list|,
name|size
argument_list|,
name|rtwn_dma_map_addr
argument_list|,
operator|&
name|tx_ring
operator|->
name|paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not load desc DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tx_ring
operator|->
name|data_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create tx buf DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_TX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|r92c_tx_desc
modifier|*
name|desc
init|=
operator|&
name|tx_ring
operator|->
name|desc
index|[
name|i
index|]
decl_stmt|;
comment|/* setup tx desc */
name|desc
operator|->
name|nextdescaddr
operator|=
name|htole32
argument_list|(
name|tx_ring
operator|->
name|paddr
operator|+
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|r92c_tx_desc
argument_list|)
operator|*
operator|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|RTWN_TX_LIST_COUNT
operator|)
argument_list|)
expr_stmt|;
name|tx_data
operator|=
operator|&
name|tx_ring
operator|->
name|tx_data
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|tx_ring
operator|->
name|data_dmat
argument_list|,
literal|0
argument_list|,
operator|&
name|tx_data
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not create tx buf DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|tx_data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|tx_data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|rtwn_free_tx_list
argument_list|(
name|sc
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_reset_tx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|rtwn_tx_ring
modifier|*
name|tx_ring
init|=
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_TX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|r92c_tx_desc
modifier|*
name|desc
init|=
operator|&
name|tx_ring
operator|->
name|desc
index|[
name|i
index|]
decl_stmt|;
name|struct
name|rtwn_tx_data
modifier|*
name|tx_data
init|=
operator|&
name|tx_ring
operator|->
name|tx_data
index|[
name|i
index|]
decl_stmt|;
name|memset
argument_list|(
name|desc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|desc
argument_list|)
operator|-
operator|(
sizeof|sizeof
argument_list|(
name|desc
operator|->
name|reserved
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|desc
operator|->
name|nextdescaddr64
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|desc
operator|->
name|nextdescaddr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|tx_ring
operator|->
name|data_dmat
argument_list|,
name|tx_data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tx_data
operator|->
name|m
argument_list|)
expr_stmt|;
name|tx_data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|tx_data
operator|->
name|ni
operator|!=
name|NULL
condition|)
block|{
name|ieee80211_free_node
argument_list|(
name|tx_data
operator|->
name|ni
argument_list|)
expr_stmt|;
name|tx_data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|bus_dmamap_sync
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
name|tx_ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|qfullmsk
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|qid
operator|)
expr_stmt|;
name|tx_ring
operator|->
name|queued
operator|=
literal|0
expr_stmt|;
name|tx_ring
operator|->
name|cur
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_free_tx_list
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|rtwn_tx_ring
modifier|*
name|tx_ring
init|=
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
decl_stmt|;
name|struct
name|rtwn_tx_data
modifier|*
name|tx_data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|tx_ring
operator|->
name|desc_dmat
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|tx_ring
operator|->
name|desc
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
name|tx_ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
name|tx_ring
operator|->
name|desc
argument_list|,
name|tx_ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
block|}
name|bus_dma_tag_destroy
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_TX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|tx_data
operator|=
operator|&
name|tx_ring
operator|->
name|tx_data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|tx_data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|tx_ring
operator|->
name|data_dmat
argument_list|,
name|tx_data
operator|->
name|map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tx_data
operator|->
name|m
argument_list|)
expr_stmt|;
name|tx_data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tx_ring
operator|->
name|data_dmat
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|tx_ring
operator|->
name|data_dmat
argument_list|)
expr_stmt|;
name|tx_ring
operator|->
name|data_dmat
operator|=
name|NULL
expr_stmt|;
block|}
name|sc
operator|->
name|qfullmsk
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|qid
operator|)
expr_stmt|;
name|tx_ring
operator|->
name|queued
operator|=
literal|0
expr_stmt|;
name|tx_ring
operator|->
name|cur
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee80211vap
modifier|*
name|rtwn_vap_create
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
specifier|const
name|char
name|name
index|[
name|IFNAMSIZ
index|]
parameter_list|,
name|int
name|unit
parameter_list|,
name|enum
name|ieee80211_opmode
name|opmode
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|uint8_t
name|bssid
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|,
specifier|const
name|uint8_t
name|mac
index|[
name|IEEE80211_ADDR_LEN
index|]
parameter_list|)
block|{
name|struct
name|rtwn_vap
modifier|*
name|rvp
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
if|if
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|rvp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rtwn_vap
argument_list|)
argument_list|,
name|M_80211_VAP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|vap
operator|=
operator|&
name|rvp
operator|->
name|vap
expr_stmt|;
if|if
condition|(
name|ieee80211_vap_setup
argument_list|(
name|ic
argument_list|,
name|vap
argument_list|,
name|name
argument_list|,
name|unit
argument_list|,
name|opmode
argument_list|,
name|flags
operator||
name|IEEE80211_CLONE_NOBEACONS
argument_list|,
name|bssid
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* out of memory */
name|free
argument_list|(
name|rvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
comment|/* Override state transition machine. */
name|rvp
operator|->
name|newstate
operator|=
name|vap
operator|->
name|iv_newstate
expr_stmt|;
name|vap
operator|->
name|iv_newstate
operator|=
name|rtwn_newstate
expr_stmt|;
comment|/* Complete setup. */
name|ieee80211_vap_attach
argument_list|(
name|vap
argument_list|,
name|ieee80211_media_change
argument_list|,
name|ieee80211_media_status
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|ic
operator|->
name|ic_opmode
operator|=
name|opmode
expr_stmt|;
return|return
operator|(
name|vap
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_vap_delete
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|rtwn_vap
modifier|*
name|rvp
init|=
name|RTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|ieee80211_vap_detach
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rvp
argument_list|,
name|M_80211_VAP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_write_1
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_write_2
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|val
operator|=
name|htole16
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_write_4
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|val
operator|=
name|htole32
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|rtwn_read_1
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
return|return
operator|(
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
name|addr
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|rtwn_read_2
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
return|return
operator|(
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
name|addr
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|rtwn_read_4
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
return|return
operator|(
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
name|addr
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_fw_cmd
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|id
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|r92c_fw_cmd
name|cmd
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Wait for current FW box to be empty. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMETFR
argument_list|)
operator|&
operator|(
literal|1
operator|<<
name|sc
operator|->
name|fwcur
operator|)
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not send firmware command %d\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
name|memset
argument_list|(
operator|&
name|cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|id
operator|=
name|id
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|3
condition|)
name|cmd
operator|.
name|id
operator||=
name|R92C_CMD_FLAG_EXT
expr_stmt|;
name|KASSERT
argument_list|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|cmd
operator|.
name|msg
argument_list|)
argument_list|,
operator|(
literal|"rtwn_fw_cmd\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cmd
operator|.
name|msg
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Write the first word last since that will trigger the FW. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_HMEBOX_EXT
argument_list|(
name|sc
operator|->
name|fwcur
argument_list|)
argument_list|,
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|cmd
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HMEBOX
argument_list|(
name|sc
operator|->
name|fwcur
argument_list|)
argument_list|,
operator|*
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|cmd
operator|+
literal|0
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fwcur
operator|=
operator|(
name|sc
operator|->
name|fwcur
operator|+
literal|1
operator|)
operator|%
name|R92C_H2C_NBOX
expr_stmt|;
comment|/* Give firmware some time for processing. */
name|DELAY
argument_list|(
literal|2000
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_rf_write
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_LSSI_PARAM_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LSSI_PARAM_DATA
argument_list|,
name|val
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|rtwn_rf_read
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint8_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|reg
index|[
name|R92C_MAX_CHAINS
index|]
decl_stmt|,
name|val
decl_stmt|;
name|reg
index|[
literal|0
index|]
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|!=
literal|0
condition|)
name|reg
index|[
name|chain
index|]
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
index|[
literal|0
index|]
operator|&
operator|~
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|,
name|RW
argument_list|(
name|reg
index|[
name|chain
index|]
argument_list|,
name|R92C_HSSI_PARAM2_READ_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
index|[
literal|0
index|]
operator||
name|R92C_HSSI_PARAM2_READ_EDGE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
name|chain
argument_list|)
argument_list|)
operator|&
name|R92C_HSSI_PARAM1_PI
condition|)
name|val
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSPI_READBACK
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|val
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_READBACK
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|MS
argument_list|(
name|val
argument_list|,
name|R92C_LSSI_READBACK_DATA
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_llt_write
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|ntries
decl_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_LLT_INIT
argument_list|,
name|SM
argument_list|(
name|R92C_LLT_INIT_OP
argument_list|,
name|R92C_LLT_INIT_OP_WRITE
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LLT_INIT_ADDR
argument_list|,
name|addr
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_LLT_INIT_DATA
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Wait for write operation to complete. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|20
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|MS
argument_list|(
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_LLT_INIT
argument_list|)
argument_list|,
name|R92C_LLT_INIT_OP
argument_list|)
operator|==
name|R92C_LLT_INIT_OP_NO_ACTIVE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|rtwn_efuse_read_1
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_EFUSE_CTRL_ADDR
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_EFUSE_CTRL_VALID
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Wait for read operation to complete. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_EFUSE_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|R92C_EFUSE_CTRL_VALID
condition|)
return|return
operator|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_EFUSE_CTRL_DATA
argument_list|)
operator|)
return|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read efuse byte at address 0x%x\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0xff
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_efuse_read
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
modifier|*
name|rom
init|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|sc
operator|->
name|rom
decl_stmt|;
name|uint16_t
name|addr
init|=
literal|0
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint8_t
name|off
decl_stmt|,
name|msk
decl_stmt|;
name|int
name|i
decl_stmt|;
name|reg
operator|=
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_ISO_CTRL_PWC_EV12V
operator|)
condition|)
block|{
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|reg
operator||
name|R92C_SYS_ISO_CTRL_PWC_EV12V
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_FUNC_EN_ELDR
operator|)
condition|)
block|{
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator||
name|R92C_SYS_FUNC_EN_ELDR
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
operator|(
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator|)
operator|)
operator|!=
operator|(
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
operator|)
condition|)
block|{
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CLKR
argument_list|,
name|reg
operator||
name|R92C_SYS_CLKR_LOADER_EN
operator||
name|R92C_SYS_CLKR_ANA8M
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|sc
operator|->
name|rom
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|rom
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|addr
operator|<
literal|512
condition|)
block|{
name|reg
operator|=
name|rtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|==
literal|0xff
condition|)
break|break;
name|addr
operator|++
expr_stmt|;
name|off
operator|=
name|reg
operator|>>
literal|4
expr_stmt|;
name|msk
operator|=
name|reg
operator|&
literal|0xf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msk
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|0
index|]
operator|=
name|rtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
name|rom
index|[
name|off
operator|*
literal|8
operator|+
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
name|rtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|addr
operator|++
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|RTWN_DEBUG
if|if
condition|(
name|sc
operator|->
name|sc_debug
operator|>=
literal|2
condition|)
block|{
comment|/* Dump ROM content. */
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|rom
argument_list|)
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x:"
argument_list|,
name|rom
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_read_chipid
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_CFG
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_TRP_VAUX_EN
condition|)
comment|/* Unsupported test chip. */
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_TYPE_92C
condition|)
block|{
name|sc
operator|->
name|chip
operator||=
name|RTWN_CHIP_92C
expr_stmt|;
comment|/* Check if it is a castrated 8192C. */
if|if
condition|(
name|MS
argument_list|(
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_HPON_FSM
argument_list|)
argument_list|,
name|R92C_HPON_FSM_CHIP_BONDING_ID
argument_list|)
operator|==
name|R92C_HPON_FSM_CHIP_BONDING_ID_92C_1T2R
condition|)
name|sc
operator|->
name|chip
operator||=
name|RTWN_CHIP_92C_1T2R
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|R92C_SYS_CFG_VENDOR_UMC
condition|)
block|{
name|sc
operator|->
name|chip
operator||=
name|RTWN_CHIP_UMC
expr_stmt|;
if|if
condition|(
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_SYS_CFG_CHIP_VER_RTL
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|chip
operator||=
name|RTWN_CHIP_UMC_A_CUT
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_read_rom
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|r92c_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
decl_stmt|;
comment|/* Read full ROM image. */
name|rtwn_efuse_read
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rom
operator|->
name|id
operator|!=
literal|0x8129
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"invalid EEPROM ID 0x%x\n"
argument_list|,
name|rom
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/* XXX Weird but this is what the vendor driver does. */
name|sc
operator|->
name|pa_setting
operator|=
name|rtwn_efuse_read_1
argument_list|(
name|sc
argument_list|,
literal|0x1fa
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"PA setting=0x%x\n"
operator|,
name|sc
operator|->
name|pa_setting
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|board_type
operator|=
name|MS
argument_list|(
name|rom
operator|->
name|rf_opt1
argument_list|,
name|R92C_ROM_RF1_BOARD_TYPE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regulatory
operator|=
name|MS
argument_list|(
name|rom
operator|->
name|rf_opt1
argument_list|,
name|R92C_ROM_RF1_REGULATORY
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"regulatory type=%d\n"
operator|,
name|sc
operator|->
name|regulatory
operator|)
argument_list|)
expr_stmt|;
name|IEEE80211_ADDR_COPY
argument_list|(
name|sc
operator|->
name|sc_ic
operator|.
name|ic_macaddr
argument_list|,
name|rom
operator|->
name|macaddr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize rate adaptation in firmware.  */
end_comment

begin_function
specifier|static
name|int
name|rtwn_ra_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|map
index|[]
init|=
block|{
literal|2
block|,
literal|4
block|,
literal|11
block|,
literal|22
block|,
literal|12
block|,
literal|18
block|,
literal|24
block|,
literal|36
block|,
literal|48
block|,
literal|72
block|,
literal|96
block|,
literal|108
block|}
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|ieee80211_ref_node
argument_list|(
name|vap
operator|->
name|iv_bss
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_rateset
modifier|*
name|rs
init|=
operator|&
name|ni
operator|->
name|ni_rates
decl_stmt|;
name|struct
name|r92c_fw_cmd_macid_cfg
name|cmd
decl_stmt|;
name|uint32_t
name|rates
decl_stmt|,
name|basicrates
decl_stmt|;
name|uint8_t
name|mode
decl_stmt|;
name|int
name|maxrate
decl_stmt|,
name|maxbasicrate
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Get normal and basic rates mask. */
name|rates
operator|=
name|basicrates
operator|=
literal|0
expr_stmt|;
name|maxrate
operator|=
name|maxbasicrate
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
comment|/* Convert 802.11 rate to HW rate index. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|nitems
argument_list|(
name|map
argument_list|)
condition|;
name|j
operator|++
control|)
if|if
condition|(
operator|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_VAL
operator|)
operator|==
name|map
index|[
name|j
index|]
condition|)
break|break;
if|if
condition|(
name|j
operator|==
name|nitems
argument_list|(
name|map
argument_list|)
condition|)
comment|/* Unknown rate, skip. */
continue|continue;
name|rates
operator||=
literal|1
operator|<<
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|>
name|maxrate
condition|)
name|maxrate
operator|=
name|j
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_BASIC
condition|)
block|{
name|basicrates
operator||=
literal|1
operator|<<
name|j
expr_stmt|;
if|if
condition|(
name|j
operator|>
name|maxbasicrate
condition|)
name|maxbasicrate
operator|=
name|j
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|mode
operator|=
name|R92C_RAID_11B
expr_stmt|;
else|else
name|mode
operator|=
name|R92C_RAID_11BG
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"mode=0x%x rates=0x%08x, basicrates=0x%08x\n"
operator|,
name|mode
operator|,
name|rates
operator|,
name|basicrates
operator|)
argument_list|)
expr_stmt|;
comment|/* Set rates mask for group addressed frames. */
name|cmd
operator|.
name|macid
operator|=
name|RTWN_MACID_BC
operator||
name|RTWN_MACID_VALID
expr_stmt|;
name|cmd
operator|.
name|mask
operator|=
name|htole32
argument_list|(
name|mode
operator|<<
literal|28
operator||
name|basicrates
argument_list|)
expr_stmt|;
name|error
operator|=
name|rtwn_fw_cmd
argument_list|(
name|sc
argument_list|,
name|R92C_CMD_MACID_CONFIG
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not add broadcast station\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Set initial MRR rate. */
name|DPRINTF
argument_list|(
operator|(
literal|"maxbasicrate=%d\n"
operator|,
name|maxbasicrate
operator|)
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIDATA_RATE_SEL
argument_list|(
name|RTWN_MACID_BC
argument_list|)
argument_list|,
name|maxbasicrate
argument_list|)
expr_stmt|;
comment|/* Set rates mask for unicast frames. */
name|cmd
operator|.
name|macid
operator|=
name|RTWN_MACID_BSS
operator||
name|RTWN_MACID_VALID
expr_stmt|;
name|cmd
operator|.
name|mask
operator|=
name|htole32
argument_list|(
name|mode
operator|<<
literal|28
operator||
name|rates
argument_list|)
expr_stmt|;
name|error
operator|=
name|rtwn_fw_cmd
argument_list|(
name|sc
argument_list|,
name|R92C_CMD_MACID_CONFIG
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not add BSS station\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Set initial MRR rate. */
name|DPRINTF
argument_list|(
operator|(
literal|"maxrate=%d\n"
operator|,
name|maxrate
operator|)
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIDATA_RATE_SEL
argument_list|(
name|RTWN_MACID_BSS
argument_list|)
argument_list|,
name|maxrate
argument_list|)
expr_stmt|;
comment|/* Configure Automatic Rate Fallback Register. */
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
block|{
if|if
condition|(
name|rates
operator|&
literal|0x0c
condition|)
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_ARFR
argument_list|(
literal|0
argument_list|)
argument_list|,
name|htole32
argument_list|(
name|rates
operator|&
literal|0x0d
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_ARFR
argument_list|(
literal|0
argument_list|)
argument_list|,
name|htole32
argument_list|(
name|rates
operator|&
literal|0x0f
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_ARFR
argument_list|(
literal|0
argument_list|)
argument_list|,
name|htole32
argument_list|(
name|rates
operator|&
literal|0x0ff5
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Indicate highest supported rate. */
name|ni
operator|->
name|ni_txrate
operator|=
name|rs
operator|->
name|rs_rates
index|[
name|rs
operator|->
name|rs_nrates
operator|-
literal|1
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_tsf_sync_enable
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|vap
operator|->
name|iv_bss
decl_stmt|;
name|uint64_t
name|tsf
decl_stmt|;
comment|/* Enable TSF synchronization. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator|&
operator|~
name|R92C_BCN_CTRL_DIS_TSF_UDT0
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator|&
operator|~
name|R92C_BCN_CTRL_EN_BCN
argument_list|)
expr_stmt|;
comment|/* Set initial TSF. */
name|memcpy
argument_list|(
operator|&
name|tsf
argument_list|,
name|ni
operator|->
name|ni_tstamp
operator|.
name|data
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|tsf
operator|=
name|le64toh
argument_list|(
name|tsf
argument_list|)
expr_stmt|;
name|tsf
operator|=
name|tsf
operator|-
operator|(
name|tsf
operator|%
operator|(
name|vap
operator|->
name|iv_bss
operator|->
name|ni_intval
operator|*
name|IEEE80211_DUR_TU
operator|)
operator|)
expr_stmt|;
name|tsf
operator|-=
name|IEEE80211_DUR_TU
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_TSFTR
operator|+
literal|0
argument_list|,
name|tsf
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_TSFTR
operator|+
literal|4
argument_list|,
name|tsf
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator||
name|R92C_BCN_CTRL_EN_BCN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_set_led
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|led
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
if|if
condition|(
name|led
operator|==
name|RTWN_LED_LINK
condition|)
block|{
name|reg
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|)
operator|&
literal|0xf0
expr_stmt|;
if|if
condition|(
operator|!
name|on
condition|)
name|reg
operator||=
name|R92C_LEDCFG2_DIS
expr_stmt|;
else|else
name|reg
operator||=
name|R92C_LEDCFG2_EN
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ledlink
operator|=
name|on
expr_stmt|;
comment|/* Save LED state. */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_calib_to
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|r92c_fw_cmd_rssi
name|cmd
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|avg_pwdb
operator|!=
operator|-
literal|1
condition|)
block|{
comment|/* Indicate Rx signal strength to FW for rate adaptation. */
name|memset
argument_list|(
operator|&
name|cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|macid
operator|=
literal|0
expr_stmt|;
comment|/* BSS. */
name|cmd
operator|.
name|pwdb
operator|=
name|sc
operator|->
name|avg_pwdb
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|3
argument_list|,
operator|(
literal|"sending RSSI command avg=%d\n"
operator|,
name|sc
operator|->
name|avg_pwdb
operator|)
argument_list|)
expr_stmt|;
name|rtwn_fw_cmd
argument_list|(
name|sc
argument_list|,
name|R92C_CMD_RSSI_SETTING
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Do temperature compensation. */
name|rtwn_temp_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|calib_to
argument_list|,
name|hz
operator|*
literal|2
argument_list|,
name|rtwn_calib_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_newstate
parameter_list|(
name|struct
name|ieee80211vap
modifier|*
name|vap
parameter_list|,
name|enum
name|ieee80211_state
name|nstate
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|struct
name|rtwn_vap
modifier|*
name|rvp
init|=
name|RTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|vap
operator|->
name|iv_ic
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
init|=
name|vap
operator|->
name|iv_bss
decl_stmt|;
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|IEEE80211_UNLOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
condition|)
block|{
comment|/* Stop calibration. */
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|calib_to
argument_list|)
expr_stmt|;
comment|/* Turn link LED off. */
name|rtwn_set_led
argument_list|(
name|sc
argument_list|,
name|RTWN_LED_LINK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set media status to 'No Link'. */
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_CR_NETTYPE
argument_list|,
name|R92C_CR_NETTYPE_NOLINK
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Stop Rx of data frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Rest TSF. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DUAL_TSF_RST
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
comment|/* Disable TSF synchronization. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
operator||
name|R92C_BCN_CTRL_DIS_TSF_UDT0
argument_list|)
expr_stmt|;
comment|/* Reset EDCA parameters. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VO_PARAM
argument_list|,
literal|0x002f3217
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VI_PARAM
argument_list|,
literal|0x005e4317
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BE_PARAM
argument_list|,
literal|0x00105320
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BK_PARAM
argument_list|,
literal|0x0000a444
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|nstate
condition|)
block|{
case|case
name|IEEE80211_S_INIT
case|:
comment|/* Turn link LED off. */
name|rtwn_set_led
argument_list|(
name|sc
argument_list|,
name|RTWN_LED_LINK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_SCAN
case|:
comment|/* Make link LED blink during scan. */
name|rtwn_set_led
argument_list|(
name|sc
argument_list|,
name|RTWN_LED_LINK
argument_list|,
operator|!
name|sc
operator|->
name|ledlink
argument_list|)
expr_stmt|;
comment|/* Pause AC Tx queues. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|)
operator||
literal|0x0f
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_AUTH
case|:
name|rtwn_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_S_RUN
case|:
if|if
condition|(
name|ic
operator|->
name|ic_opmode
operator|==
name|IEEE80211_M_MONITOR
condition|)
block|{
comment|/* Enable Rx of data frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Turn link LED on. */
name|rtwn_set_led
argument_list|(
name|sc
argument_list|,
name|RTWN_LED_LINK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Set media status to 'Associated'. */
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_CR_NETTYPE
argument_list|,
name|R92C_CR_NETTYPE_INFRA
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Set BSSID. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BSSID
operator|+
literal|0
argument_list|,
name|le32dec
argument_list|(
operator|&
name|ni
operator|->
name|ni_bssid
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BSSID
operator|+
literal|4
argument_list|,
name|le16dec
argument_list|(
operator|&
name|ni
operator|->
name|ni_bssid
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIRTS_RATE_SEL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
comment|/* 802.11b/g */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_INIRTS_RATE_SEL
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* Enable Rx of data frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Flush all AC queues. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set beacon interval. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_INTERVAL
argument_list|,
name|ni
operator|->
name|ni_intval
argument_list|)
expr_stmt|;
comment|/* Allow Rx from our BSSID only. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|)
operator||
name|R92C_RCR_CBSSID_DATA
operator||
name|R92C_RCR_CBSSID_BCN
argument_list|)
expr_stmt|;
comment|/* Enable TSF synchronization. */
name|rtwn_tsf_sync_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_CCK
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_OFDM
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPEC_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_SPEC_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_R2T_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_T2T_SIFS
operator|+
literal|1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
comment|/* Intialize rate adaptation. */
name|rtwn_ra_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Turn link LED on. */
name|rtwn_set_led
argument_list|(
name|sc
argument_list|,
name|RTWN_LED_LINK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|avg_pwdb
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Reset average RSSI. */
comment|/* Reset temperature calibration state machine. */
name|sc
operator|->
name|thcal_state
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|thcal_lctemp
operator|=
literal|0
expr_stmt|;
comment|/* Start periodic calibration. */
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|calib_to
argument_list|,
name|hz
operator|*
literal|2
argument_list|,
name|rtwn_calib_to
argument_list|,
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|IEEE80211_LOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
name|rvp
operator|->
name|newstate
argument_list|(
name|vap
argument_list|,
name|nstate
argument_list|,
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_updateedca
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
specifier|const
name|uint16_t
name|aci2reg
index|[
name|WME_NUM_AC
index|]
init|=
block|{
name|R92C_EDCA_BE_PARAM
block|,
name|R92C_EDCA_BK_PARAM
block|,
name|R92C_EDCA_VI_PARAM
block|,
name|R92C_EDCA_VO_PARAM
block|}
decl_stmt|;
name|int
name|aci
decl_stmt|,
name|aifs
decl_stmt|,
name|slottime
decl_stmt|;
name|IEEE80211_LOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
name|slottime
operator|=
operator|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_SHSLOT
operator|)
condition|?
literal|9
else|:
literal|20
expr_stmt|;
for|for
control|(
name|aci
operator|=
literal|0
init|;
name|aci
operator|<
name|WME_NUM_AC
condition|;
name|aci
operator|++
control|)
block|{
specifier|const
name|struct
name|wmeParams
modifier|*
name|ac
init|=
operator|&
name|ic
operator|->
name|ic_wme
operator|.
name|wme_chanParams
operator|.
name|cap_wmeParams
index|[
name|aci
index|]
decl_stmt|;
comment|/* AIFS[AC] = AIFSN[AC] * aSlotTime + aSIFSTime. */
name|aifs
operator|=
name|ac
operator|->
name|wmep_aifsn
operator|*
name|slottime
operator|+
literal|10
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|aci2reg
index|[
name|aci
index|]
argument_list|,
name|SM
argument_list|(
name|R92C_EDCA_PARAM_TXOP
argument_list|,
name|ac
operator|->
name|wmep_txopLimit
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_EDCA_PARAM_ECWMIN
argument_list|,
name|ac
operator|->
name|wmep_logcwmin
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_EDCA_PARAM_ECWMAX
argument_list|,
name|ac
operator|->
name|wmep_logcwmax
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_EDCA_PARAM_AIFS
argument_list|,
name|aifs
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|IEEE80211_UNLOCK
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_update_avgrssi
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|int8_t
name|rssi
parameter_list|)
block|{
name|int
name|pwdb
decl_stmt|;
comment|/* Convert antenna signal to percentage. */
if|if
condition|(
name|rssi
operator|<=
operator|-
literal|100
operator|||
name|rssi
operator|>=
literal|20
condition|)
name|pwdb
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|rssi
operator|>=
literal|0
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
else|else
name|pwdb
operator|=
literal|100
operator|+
name|rssi
expr_stmt|;
if|if
condition|(
name|rate
operator|<=
literal|3
condition|)
block|{
comment|/* CCK gain is smaller than OFDM/MCS gain. */
name|pwdb
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
name|pwdb
operator|>
literal|100
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|pwdb
operator|<=
literal|14
condition|)
name|pwdb
operator|-=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|26
condition|)
name|pwdb
operator|-=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|34
condition|)
name|pwdb
operator|-=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|42
condition|)
name|pwdb
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|avg_pwdb
operator|==
operator|-
literal|1
condition|)
comment|/* Init. */
name|sc
operator|->
name|avg_pwdb
operator|=
name|pwdb
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|avg_pwdb
operator|<
name|pwdb
condition|)
name|sc
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|sc
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
operator|+
literal|1
expr_stmt|;
else|else
name|sc
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|sc
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|4
argument_list|,
operator|(
literal|"PWDB=%d EMA=%d\n"
operator|,
name|pwdb
operator|,
name|sc
operator|->
name|avg_pwdb
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|rtwn_get_rssi
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rate
parameter_list|,
name|void
modifier|*
name|physt
parameter_list|)
block|{
specifier|static
specifier|const
name|int8_t
name|cckoff
index|[]
init|=
block|{
literal|16
block|,
operator|-
literal|12
block|,
operator|-
literal|26
block|,
operator|-
literal|46
block|}
decl_stmt|;
name|struct
name|r92c_rx_phystat
modifier|*
name|phy
decl_stmt|;
name|struct
name|r92c_rx_cck
modifier|*
name|cck
decl_stmt|;
name|uint8_t
name|rpt
decl_stmt|;
name|int8_t
name|rssi
decl_stmt|;
if|if
condition|(
name|rate
operator|<=
literal|3
condition|)
block|{
name|cck
operator|=
operator|(
expr|struct
name|r92c_rx_cck
operator|*
operator|)
name|physt
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_FLAG_CCK_HIPWR
condition|)
block|{
name|rpt
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|>>
literal|5
operator|)
operator|&
literal|0x3
expr_stmt|;
name|rssi
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|&
literal|0x1f
operator|)
operator|<<
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rpt
operator|=
operator|(
name|cck
operator|->
name|agc_rpt
operator|>>
literal|6
operator|)
operator|&
literal|0x3
expr_stmt|;
name|rssi
operator|=
name|cck
operator|->
name|agc_rpt
operator|&
literal|0x3e
expr_stmt|;
block|}
name|rssi
operator|=
name|cckoff
index|[
name|rpt
index|]
operator|-
name|rssi
expr_stmt|;
block|}
else|else
block|{
comment|/* OFDM/HT. */
name|phy
operator|=
operator|(
expr|struct
name|r92c_rx_phystat
operator|*
operator|)
name|physt
expr_stmt|;
name|rssi
operator|=
operator|(
operator|(
name|le32toh
argument_list|(
name|phy
operator|->
name|phydw1
argument_list|)
operator|>>
literal|1
operator|)
operator|&
literal|0x7f
operator|)
operator|-
literal|110
expr_stmt|;
block|}
return|return
operator|(
name|rssi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_rx_frame
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|r92c_rx_desc
modifier|*
name|rx_desc
parameter_list|,
name|struct
name|rtwn_rx_data
modifier|*
name|rx_data
parameter_list|,
name|int
name|desc_idx
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211_frame_min
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|r92c_rx_phystat
modifier|*
name|phy
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|rxdw0
decl_stmt|,
name|rxdw3
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m1
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|bus_addr_t
name|physaddr
decl_stmt|;
name|uint8_t
name|rate
decl_stmt|;
name|int8_t
name|rssi
init|=
literal|0
decl_stmt|,
name|nf
decl_stmt|;
name|int
name|infosz
decl_stmt|,
name|nsegs
decl_stmt|,
name|pktlen
decl_stmt|,
name|shift
decl_stmt|,
name|error
decl_stmt|;
name|rxdw0
operator|=
name|le32toh
argument_list|(
name|rx_desc
operator|->
name|rxdw0
argument_list|)
expr_stmt|;
name|rxdw3
operator|=
name|le32toh
argument_list|(
name|rx_desc
operator|->
name|rxdw3
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|rxdw0
operator|&
operator|(
name|R92C_RXDW0_CRCERR
operator||
name|R92C_RXDW0_ICVERR
operator|)
argument_list|)
condition|)
block|{
comment|/* 		 * This should not happen since we setup our Rx filter 		 * to not receive these frames. 		 */
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|pktlen
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_PKTLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|pktlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame_ack
argument_list|)
operator|||
name|pktlen
operator|>
name|MCLBYTES
argument_list|)
condition|)
block|{
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|rate
operator|=
name|MS
argument_list|(
name|rxdw3
argument_list|,
name|R92C_RXDW3_RATE
argument_list|)
expr_stmt|;
name|infosz
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_INFOSZ
argument_list|)
operator|*
literal|8
expr_stmt|;
if|if
condition|(
name|infosz
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|r92c_rx_phystat
argument_list|)
condition|)
name|infosz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|r92c_rx_phystat
argument_list|)
expr_stmt|;
name|shift
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|R92C_RXDW0_SHIFT
argument_list|)
expr_stmt|;
comment|/* Get RSSI from PHY status descriptor if present. */
if|if
condition|(
name|infosz
operator|!=
literal|0
operator|&&
operator|(
name|rxdw0
operator|&
name|R92C_RXDW0_PHYST
operator|)
condition|)
block|{
name|phy
operator|=
name|mtod
argument_list|(
name|rx_data
operator|->
name|m
argument_list|,
expr|struct
name|r92c_rx_phystat
operator|*
argument_list|)
expr_stmt|;
name|rssi
operator|=
name|rtwn_get_rssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
name|phy
argument_list|)
expr_stmt|;
comment|/* Update our average RSSI. */
name|rtwn_update_avgrssi
argument_list|(
name|sc
argument_list|,
name|rate
argument_list|,
name|rssi
argument_list|)
expr_stmt|;
block|}
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
operator|(
literal|"Rx frame len=%d rate=%d infosz=%d shift=%d rssi=%d\n"
operator|,
name|pktlen
operator|,
name|rate
operator|,
name|infosz
operator|,
name|shift
operator|,
name|rssi
operator|)
argument_list|)
expr_stmt|;
name|m1
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|==
name|NULL
condition|)
block|{
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|rx_ring
operator|.
name|data_dmat
argument_list|,
name|rx_data
operator|->
name|map
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|rx_ring
operator|.
name|data_dmat
argument_list|,
name|rx_data
operator|->
name|map
argument_list|,
name|mtod
argument_list|(
name|m1
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|MCLBYTES
argument_list|,
name|rtwn_dma_map_addr
argument_list|,
operator|&
name|physaddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|rx_ring
operator|.
name|data_dmat
argument_list|,
name|rx_data
operator|->
name|map
argument_list|,
name|rx_data
operator|->
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
condition|)
name|panic
argument_list|(
literal|"%s: could not load old RX mbuf"
argument_list|,
name|device_get_name
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Physical address may have changed. */
name|rtwn_setup_rx_desc
argument_list|(
name|sc
argument_list|,
name|rx_desc
argument_list|,
name|physaddr
argument_list|,
name|MCLBYTES
argument_list|,
name|desc_idx
argument_list|)
expr_stmt|;
name|counter_u64_add
argument_list|(
name|ic
operator|->
name|ic_ierrors
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Finalize mbuf. */
name|m
operator|=
name|rx_data
operator|->
name|m
expr_stmt|;
name|rx_data
operator|->
name|m
operator|=
name|m1
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|pktlen
operator|+
name|infosz
operator|+
name|shift
expr_stmt|;
comment|/* Update RX descriptor. */
name|rtwn_setup_rx_desc
argument_list|(
name|sc
argument_list|,
name|rx_desc
argument_list|,
name|physaddr
argument_list|,
name|MCLBYTES
argument_list|,
name|desc_idx
argument_list|)
expr_stmt|;
comment|/* Get ieee80211 frame header. */
if|if
condition|(
name|rxdw0
operator|&
name|R92C_RXDW0_PHYST
condition|)
name|m_adj
argument_list|(
name|m
argument_list|,
name|infosz
operator|+
name|shift
argument_list|)
expr_stmt|;
else|else
name|m_adj
argument_list|(
name|m
argument_list|,
name|shift
argument_list|)
expr_stmt|;
name|nf
operator|=
operator|-
literal|95
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active
argument_list|(
name|ic
argument_list|)
condition|)
block|{
name|struct
name|rtwn_rx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_rxtap
decl_stmt|;
name|tap
operator|->
name|wr_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rxdw3
operator|&
name|R92C_RXDW3_HT
operator|)
condition|)
block|{
switch|switch
condition|(
name|rate
condition|)
block|{
comment|/* CCK. */
case|case
literal|0
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|11
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|22
expr_stmt|;
break|break;
comment|/* OFDM. */
case|case
literal|4
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|12
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|18
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|24
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|36
expr_stmt|;
break|break;
case|case
literal|8
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|48
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|72
expr_stmt|;
break|break;
case|case
literal|10
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|96
expr_stmt|;
break|break;
case|case
literal|11
case|:
name|tap
operator|->
name|wr_rate
operator|=
literal|108
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|rate
operator|>=
literal|12
condition|)
block|{
comment|/* MCS0~15. */
comment|/* Bit 7 set means HT MCS instead of rate. */
name|tap
operator|->
name|wr_rate
operator|=
literal|0x80
operator||
operator|(
name|rate
operator|-
literal|12
operator|)
expr_stmt|;
block|}
name|tap
operator|->
name|wr_dbm_antsignal
operator|=
name|rssi
expr_stmt|;
name|tap
operator|->
name|wr_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
block|}
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame_min
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_len
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
condition|)
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
name|wh
argument_list|)
expr_stmt|;
else|else
name|ni
operator|=
name|NULL
expr_stmt|;
comment|/* Send the frame to the 802.11 layer. */
if|if
condition|(
name|ni
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|ieee80211_input
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|rssi
operator|-
name|nf
argument_list|,
name|nf
argument_list|)
expr_stmt|;
comment|/* Node is no longer needed. */
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|ieee80211_input_all
argument_list|(
name|ic
argument_list|,
name|m
argument_list|,
name|rssi
operator|-
name|nf
argument_list|,
name|nf
argument_list|)
expr_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_tx
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_key
modifier|*
name|k
init|=
name|NULL
decl_stmt|;
name|struct
name|rtwn_tx_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|rtwn_tx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|r92c_tx_desc
modifier|*
name|txd
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|uint16_t
name|qos
decl_stmt|;
name|uint8_t
name|raid
decl_stmt|,
name|type
decl_stmt|,
name|tid
decl_stmt|,
name|qid
decl_stmt|;
name|int
name|nsegs
decl_stmt|,
name|error
decl_stmt|;
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
comment|/* Encrypt the frame if need be. */
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
name|k
operator|=
name|ieee80211_crypto_encap
argument_list|(
name|ni
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* 802.11 header may have moved. */
name|wh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ieee80211_frame
operator|*
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IEEE80211_QOS_HAS_SEQ
argument_list|(
name|wh
argument_list|)
condition|)
block|{
name|qos
operator|=
operator|(
operator|(
specifier|const
expr|struct
name|ieee80211_qosframe
operator|*
operator|)
name|wh
operator|)
operator|->
name|i_qos
index|[
literal|0
index|]
expr_stmt|;
name|tid
operator|=
name|qos
operator|&
name|IEEE80211_QOS_TID
expr_stmt|;
block|}
else|else
block|{
name|qos
operator|=
literal|0
expr_stmt|;
name|tid
operator|=
literal|0
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|IEEE80211_FC0_TYPE_CTL
case|:
case|case
name|IEEE80211_FC0_TYPE_MGT
case|:
name|qid
operator|=
name|RTWN_VO_QUEUE
expr_stmt|;
break|break;
default|default:
name|qid
operator|=
name|M_WME_GETAC
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Grab a Tx buffer from the ring. */
name|tx_ring
operator|=
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
expr_stmt|;
name|data
operator|=
operator|&
name|tx_ring
operator|->
name|tx_data
index|[
name|tx_ring
operator|->
name|cur
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
comment|/* Fill Tx descriptor. */
name|txd
operator|=
operator|&
name|tx_ring
operator|->
name|desc
index|[
name|tx_ring
operator|->
name|cur
index|]
expr_stmt|;
if|if
condition|(
name|htole32
argument_list|(
name|txd
operator|->
name|txdw0
argument_list|)
operator|&
name|R92C_RXDW0_OWN
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|txd
operator|->
name|txdw0
operator|=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW0_PKTLEN
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW0_OFFSET
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|txd
argument_list|)
argument_list|)
operator||
name|R92C_TXDW0_FSG
operator||
name|R92C_TXDW0_LSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
condition|)
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|R92C_TXDW0_BMCAST
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw1
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|txdw4
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|txdw5
operator|=
literal|0
expr_stmt|;
comment|/* XXX TODO: rate control; implement low-rate for EAPOL */
if|if
condition|(
operator|!
name|IEEE80211_IS_MULTICAST
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
operator|&&
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_curmode
operator|==
name|IEEE80211_MODE_11B
condition|)
name|raid
operator|=
name|R92C_RAID_11B
expr_stmt|;
else|else
name|raid
operator|=
name|R92C_RAID_11BG
expr_stmt|;
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_MACID
argument_list|,
name|RTWN_MACID_BSS
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|R92C_TXDW1_QSEL_BE
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_RAID
argument_list|,
name|raid
argument_list|)
operator||
name|R92C_TXDW1_AGGBK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_flags
operator|&
name|IEEE80211_F_USEPROT
condition|)
block|{
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_CTSONLY
condition|)
block|{
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_CTS2SELF
operator||
name|R92C_TXDW4_HWRTSEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ic
operator|->
name|ic_protmode
operator|==
name|IEEE80211_PROT_RTSCTS
condition|)
block|{
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_RTSEN
operator||
name|R92C_TXDW4_HWRTSEN
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* XXX TODO: implement rate control */
comment|/* Send RTS at OFDM24. */
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW4_RTSRATE
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_RTSRATE_FBLIMIT
argument_list|,
literal|0xf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Send data at OFDM54. */
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE
argument_list|,
literal|11
argument_list|)
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE_FBLIMIT
argument_list|,
literal|0x1f
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|txd
operator|->
name|txdw1
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW1_MACID
argument_list|,
literal|0
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_QSEL
argument_list|,
name|R92C_TXDW1_QSEL_MGNT
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXDW1_RAID
argument_list|,
name|R92C_RAID_11B
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Force CCK1. */
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_DRVRATE
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw5
operator||=
name|htole32
argument_list|(
name|SM
argument_list|(
name|R92C_TXDW5_DATARATE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Set sequence number (already little endian). */
name|txd
operator|->
name|txdseq
operator|=
name|htole16
argument_list|(
name|M_SEQNO_GET
argument_list|(
name|m
argument_list|)
operator|%
name|IEEE80211_SEQ_RANGE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qos
condition|)
block|{
comment|/* Use HW sequence numbering for non-QoS frames. */
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_HWSEQ
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdseq
operator||=
name|htole16
argument_list|(
literal|0x8000
argument_list|)
expr_stmt|;
block|}
else|else
name|txd
operator|->
name|txdw4
operator||=
name|htole32
argument_list|(
name|R92C_TXDW4_QOS
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|tx_ring
operator|->
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|&&
name|error
operator|!=
name|EFBIG
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't map mbuf (error %d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|struct
name|mbuf
modifier|*
name|mnew
decl_stmt|;
name|mnew
operator|=
name|m_defrag
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mnew
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't defragment mbuf\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|m
operator|=
name|mnew
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|tx_ring
operator|->
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"can't map mbuf (error %d)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
name|txd
operator|->
name|txbufaddr
operator|=
name|htole32
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txbufsize
operator|=
name|htole16
argument_list|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|bus_space_barrier
argument_list|(
name|sc
operator|->
name|sc_st
argument_list|,
name|sc
operator|->
name|sc_sh
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|sc_mapsize
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
name|txd
operator|->
name|txdw0
operator||=
name|htole32
argument_list|(
name|R92C_TXDW0_OWN
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
name|tx_ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|tx_ring
operator|->
name|data_dmat
argument_list|,
name|data
operator|->
name|map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|m
expr_stmt|;
name|data
operator|->
name|ni
operator|=
name|ni
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active_vap
argument_list|(
name|vap
argument_list|)
condition|)
block|{
name|struct
name|rtwn_tx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_txtap
decl_stmt|;
name|tap
operator|->
name|wt_flags
operator|=
literal|0
expr_stmt|;
name|tap
operator|->
name|wt_chan_freq
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wt_chan_flags
operator|=
name|htole16
argument_list|(
name|ic
operator|->
name|ic_curchan
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
name|ieee80211_radiotap_tx
argument_list|(
name|vap
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|tx_ring
operator|->
name|cur
operator|=
operator|(
name|tx_ring
operator|->
name|cur
operator|+
literal|1
operator|)
operator|%
name|RTWN_TX_LIST_COUNT
expr_stmt|;
name|tx_ring
operator|->
name|queued
operator|++
expr_stmt|;
if|if
condition|(
name|tx_ring
operator|->
name|queued
operator|>=
operator|(
name|RTWN_TX_LIST_COUNT
operator|-
literal|1
operator|)
condition|)
name|sc
operator|->
name|qfullmsk
operator||=
operator|(
literal|1
operator|<<
name|qid
operator|)
expr_stmt|;
comment|/* Kick TX. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_PCIE_CTRL_REG
argument_list|,
operator|(
literal|1
operator|<<
name|qid
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_tx_done
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|qid
parameter_list|)
block|{
name|struct
name|rtwn_tx_ring
modifier|*
name|tx_ring
init|=
operator|&
name|sc
operator|->
name|tx_ring
index|[
name|qid
index|]
decl_stmt|;
name|struct
name|rtwn_tx_data
modifier|*
name|tx_data
decl_stmt|;
name|struct
name|r92c_tx_desc
modifier|*
name|tx_desc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bus_dmamap_sync
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
name|tx_ring
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_TX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|tx_data
operator|=
operator|&
name|tx_ring
operator|->
name|tx_data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|tx_data
operator|->
name|m
operator|==
name|NULL
condition|)
continue|continue;
name|tx_desc
operator|=
operator|&
name|tx_ring
operator|->
name|desc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|le32toh
argument_list|(
name|tx_desc
operator|->
name|txdw0
argument_list|)
operator|&
name|R92C_TXDW0_OWN
condition|)
continue|continue;
name|bus_dmamap_unload
argument_list|(
name|tx_ring
operator|->
name|desc_dmat
argument_list|,
name|tx_ring
operator|->
name|desc_map
argument_list|)
expr_stmt|;
comment|/* 		 * XXX TODO: figure out whether the transmit succeeded or not. 		 * .. and then notify rate control. 		 */
name|ieee80211_tx_complete
argument_list|(
name|tx_data
operator|->
name|ni
argument_list|,
name|tx_data
operator|->
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tx_data
operator|->
name|ni
operator|=
name|NULL
expr_stmt|;
name|tx_data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|0
expr_stmt|;
name|tx_ring
operator|->
name|queued
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|tx_ring
operator|->
name|queued
operator|<
operator|(
name|RTWN_TX_LIST_COUNT
operator|-
literal|1
operator|)
condition|)
name|sc
operator|->
name|qfullmsk
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|qid
operator|)
expr_stmt|;
name|rtwn_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_raw_xmit
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|struct
name|ieee80211_bpf_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
name|ni
operator|->
name|ni_ic
decl_stmt|;
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Prevent management frames from being sent if we're not ready. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_RUNNING
operator|)
condition|)
block|{
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENETDOWN
operator|)
return|;
block|}
if|if
condition|(
name|rtwn_tx
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|5
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_transmit
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|error
operator|=
name|mbufq_enqueue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|rtwn_start
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_parent
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_nrunning
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|rtwn_init
argument_list|(
name|sc
argument_list|)
operator|==
literal|0
condition|)
name|ieee80211_start_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
else|else
name|ieee80211_stop
argument_list|(
name|vap
argument_list|)
expr_stmt|;
block|}
else|else
name|rtwn_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_start
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|RTWN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
name|sc
operator|->
name|qfullmsk
operator|==
literal|0
operator|&&
operator|(
name|m
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|sc
operator|->
name|sc_snd
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ni
operator|=
operator|(
expr|struct
name|ieee80211_node
operator|*
operator|)
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
expr_stmt|;
if|if
condition|(
name|rtwn_tx
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
name|ni
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ni
operator|->
name|ni_vap
operator|->
name|iv_ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ieee80211_free_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_watchdog
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|RTWN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_RUNNING
argument_list|,
operator|(
literal|"not running"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tx_timer
operator|!=
literal|0
operator|&&
operator|--
name|sc
operator|->
name|sc_tx_timer
operator|==
literal|0
condition|)
block|{
name|ic_printf
argument_list|(
name|ic
argument_list|,
literal|"device timeout\n"
argument_list|)
expr_stmt|;
name|ieee80211_restart_all
argument_list|(
name|ic
argument_list|)
expr_stmt|;
return|return;
block|}
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_to
argument_list|,
name|hz
argument_list|,
name|rtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_power_on
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Wait for autoload done bit. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_PFM_ALDN
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for chip autoload\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Unlock ISO/CLK/Power control register. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* TODO: check if we need this for 8188CE */
if|if
condition|(
name|sc
operator|->
name|board_type
operator|!=
name|R92C_BOARD_TYPE_DONGLE
condition|)
block|{
comment|/* bt coex */
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
name|R92C_APS_FSMCO_SOP_ABG
operator||
name|R92C_APS_FSMCO_SOP_AMB
operator||
name|R92C_APS_FSMCO_XOP_BTCK
operator|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* Move SPS into PWM mode. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPS0_CTRL
argument_list|,
literal|0x2b
argument_list|)
expr_stmt|;
comment|/* Set low byte to 0x0f, leave others unchanged. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|,
operator|(
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|)
operator|&
literal|0xffffff00
operator|)
operator||
literal|0x0f
argument_list|)
expr_stmt|;
comment|/* TODO: check if we need this for 8188CE */
if|if
condition|(
name|sc
operator|->
name|board_type
operator|!=
name|R92C_BOARD_TYPE_DONGLE
condition|)
block|{
comment|/* bt coex */
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|(
operator|~
literal|0x00024800
operator|)
expr_stmt|;
comment|/* XXX magic from linux */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
operator|(
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
operator|&
literal|0xff
operator|)
operator||
name|R92C_SYS_ISO_CTRL_PWC_EV12V
operator||
name|R92C_SYS_ISO_CTRL_DIOR
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|200
argument_list|)
expr_stmt|;
comment|/* TODO: linux does additional btcoex stuff here */
comment|/* Auto enable WLAN. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator||
name|R92C_APS_FSMCO_APFM_ONMAC
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|)
operator|&
name|R92C_APS_FSMCO_APFM_ONMAC
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MAC auto ON\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Enable radio, GPIO and LED functions. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|R92C_APS_FSMCO_AFSM_PCIE
operator||
name|R92C_APS_FSMCO_PDN_EN
operator||
name|R92C_APS_FSMCO_PFM_ALDN
argument_list|)
expr_stmt|;
comment|/* Release RF digital isolation. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|,
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_ISO_CTRL
argument_list|)
operator|&
operator|~
name|R92C_SYS_ISO_CTRL_DIOR
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C
condition|)
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_PCIE_CTRL_REG
operator|+
literal|3
argument_list|,
literal|0x77
argument_list|)
expr_stmt|;
else|else
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_PCIE_CTRL_REG
operator|+
literal|3
argument_list|,
literal|0x22
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_INT_MIG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|board_type
operator|!=
name|R92C_BOARD_TYPE_DONGLE
condition|)
block|{
comment|/* bt coex */
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|2
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0xfd
expr_stmt|;
comment|/* XXX magic from linux */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|)
operator|&
operator|~
name|R92C_GPIO_MUXCFG_RFKILL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_IO_SEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_GPIO_IO_SEL_RFKILL
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"radio is disabled by hardware switch\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
comment|/* Initialize MAC. */
name|reg
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|)
operator|&
operator|~
name|R92C_APSD_CTRL_OFF
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|200
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_APSD_CTRL
argument_list|)
operator|&
name|R92C_APSD_CTRL_OFF_STATUS
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|500
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|200
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for MAC initialization\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
comment|/* Enable MAC DMA/WMAC/SCHEDULE/SEC blocks. */
name|reg
operator|=
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_CR_HCI_TXDMA_EN
operator||
name|R92C_CR_HCI_RXDMA_EN
operator||
name|R92C_CR_TXDMA_EN
operator||
name|R92C_CR_RXDMA_EN
operator||
name|R92C_CR_PROTOCOL_EN
operator||
name|R92C_CR_SCHEDULE_EN
operator||
name|R92C_CR_MACTXEN
operator||
name|R92C_CR_MACRXEN
operator||
name|R92C_CR_ENSEC
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0xfe10
argument_list|,
literal|0x19
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_llt_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
comment|/* Reserve pages [0; R92C_TX_PAGE_COUNT]. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|R92C_TX_PAGE_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|rtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* NB: 0xff indicates end-of-list. */
if|if
condition|(
operator|(
name|error
operator|=
name|rtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
literal|0xff
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Use pages [R92C_TX_PAGE_COUNT + 1; R92C_TXPKTBUF_COUNT - 1] 	 * as ring buffer. 	 */
for|for
control|(
operator|++
name|i
init|;
name|i
operator|<
name|R92C_TXPKTBUF_COUNT
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|rtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Make the last page point to the beginning of the ring buffer. */
name|error
operator|=
name|rtwn_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_TX_PAGE_COUNT
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_fw_reset
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|int
name|ntries
decl_stmt|;
comment|/* Tell 8051 to reset itself. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_HMETFR
operator|+
literal|3
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
comment|/* Wait until 8051 resets by itself. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
name|reg
operator|=
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|reg
operator|&
name|R92C_SYS_FUNC_EN_CPUEN
operator|)
condition|)
goto|goto
name|sleep
goto|;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
comment|/* Force 8051 reset. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
operator|&
operator|~
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
name|sleep
label|:
comment|/*  	 * We must sleep for one second to let the firmware settle. 	 * Accessing registers too early will hang the whole system. 	 */
if|if
condition|(
name|msleep
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|,
literal|"rtwnrst"
argument_list|,
name|hz
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for firmware "
literal|"initialization to complete\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_fw_loadpage
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|page
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|off
decl_stmt|,
name|mlen
decl_stmt|,
name|i
decl_stmt|;
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_MCUFWDL_PAGE
argument_list|,
name|page
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|off
operator|=
name|R92C_FW_START_ADDR
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|>
literal|196
condition|)
name|mlen
operator|=
literal|196
expr_stmt|;
elseif|else
if|if
condition|(
name|len
operator|>
literal|4
condition|)
name|mlen
operator|=
literal|4
expr_stmt|;
else|else
name|mlen
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mlen
condition|;
name|i
operator|++
control|)
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|off
operator|++
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|buf
operator|+=
name|mlen
expr_stmt|;
name|len
operator|-=
name|mlen
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_load_firmware
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|firmware
modifier|*
name|fw
decl_stmt|;
specifier|const
name|struct
name|r92c_fw_hdr
modifier|*
name|hdr
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|mlen
decl_stmt|,
name|ntries
decl_stmt|,
name|page
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
comment|/* Read firmware image from the filesystem. */
if|if
condition|(
operator|(
name|sc
operator|->
name|chip
operator|&
operator|(
name|RTWN_CHIP_UMC_A_CUT
operator||
name|RTWN_CHIP_92C
operator|)
operator|)
operator|==
name|RTWN_CHIP_UMC_A_CUT
condition|)
name|name
operator|=
literal|"rtwn-rtl8192cfwU"
expr_stmt|;
else|else
name|name
operator|=
literal|"rtwn-rtl8192cfwU_B"
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fw
operator|=
name|firmware_get
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not read firmware %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
name|len
operator|=
name|fw
operator|->
name|datasize
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"firmware too short\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ptr
operator|=
name|fw
operator|->
name|data
expr_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|r92c_fw_hdr
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* Check if there is a valid FW header and skip it. */
if|if
condition|(
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x88c
operator|||
operator|(
name|le16toh
argument_list|(
name|hdr
operator|->
name|signature
argument_list|)
operator|>>
literal|4
operator|)
operator|==
literal|0x92c
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"FW V%d.%d %02d-%02d %02d:%02d\n"
operator|,
name|le16toh
argument_list|(
name|hdr
operator|->
name|version
argument_list|)
operator|,
name|le16toh
argument_list|(
name|hdr
operator|->
name|subversion
argument_list|)
operator|,
name|hdr
operator|->
name|month
operator|,
name|hdr
operator|->
name|date
operator|,
name|hdr
operator|->
name|hour
operator|,
name|hdr
operator|->
name|minute
operator|)
argument_list|)
expr_stmt|;
name|ptr
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_RAM_DL_SEL
condition|)
name|rtwn_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable FW download. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator||
name|R92C_SYS_FUNC_EN_CPUEN
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator||
name|R92C_MCUFWDL_EN
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|2
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|2
argument_list|)
operator|&
operator|~
literal|0x08
argument_list|)
expr_stmt|;
comment|/* Reset the FWDL checksum. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator||
name|R92C_MCUFWDL_CHKSUM_RPT
argument_list|)
expr_stmt|;
for|for
control|(
name|page
operator|=
literal|0
init|;
name|len
operator|>
literal|0
condition|;
name|page
operator|++
control|)
block|{
name|mlen
operator|=
name|MIN
argument_list|(
name|len
argument_list|,
name|R92C_FW_PAGE_SIZE
argument_list|)
expr_stmt|;
name|rtwn_fw_loadpage
argument_list|(
name|sc
argument_list|,
name|page
argument_list|,
name|ptr
argument_list|,
name|mlen
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|mlen
expr_stmt|;
name|len
operator|-=
name|mlen
expr_stmt|;
block|}
comment|/* Disable FW download. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
operator|~
name|R92C_MCUFWDL_EN
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Wait for checksum report. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_CHKSUM_RPT
condition|)
break|break;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for checksum report\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
name|R92C_MCUFWDL_WINTINI_RDY
operator|)
operator||
name|R92C_MCUFWDL_RDY
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Wait for firmware readiness. */
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|2000
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_WINTINI_RDY
condition|)
break|break;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout waiting for firmware readiness\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|fail
label|:
name|firmware_put
argument_list|(
name|fw
argument_list|,
name|FIRMWARE_UNLOAD
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_dma_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Initialize LLT table. */
name|error
operator|=
name|rtwn_llt_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
name|error
return|;
comment|/* Set number of pages for normal priority queue. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN_NPQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RQPN
argument_list|,
comment|/* Set number of pages for public queue. */
name|SM
argument_list|(
name|R92C_RQPN_PUBQ
argument_list|,
name|R92C_PUBQ_NPAGES
argument_list|)
operator||
comment|/* Set number of pages for high priority queue. */
name|SM
argument_list|(
name|R92C_RQPN_HPQ
argument_list|,
name|R92C_HPQ_NPAGES
argument_list|)
operator||
comment|/* Set number of pages for low priority queue. */
name|SM
argument_list|(
name|R92C_RQPN_LPQ
argument_list|,
name|R92C_LPQ_NPAGES
argument_list|)
operator||
comment|/* Load values. */
name|R92C_RQPN_LD
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_BCNQ_BDNY
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_MGQ_BDNY
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPKTBUF_WMAC_LBK_BF_HD
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TDECTRL
operator|+
literal|1
argument_list|,
name|R92C_TX_PAGE_BOUNDARY
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_TRXDMA_CTRL_QMAP_M
expr_stmt|;
name|reg
operator||=
literal|0xF771
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXDMA_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_TCR
argument_list|,
name|R92C_TCR_CFENDFORM
operator||
operator|(
literal|1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|1
operator|<<
literal|13
operator|)
argument_list|)
expr_stmt|;
comment|/* Configure Tx DMA. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BKQ_DESA
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|RTWN_BK_QUEUE
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BEQ_DESA
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|RTWN_BE_QUEUE
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_VIQ_DESA
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|RTWN_VI_QUEUE
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_VOQ_DESA
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|RTWN_VO_QUEUE
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_BCNQ_DESA
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|RTWN_BEACON_QUEUE
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MGQ_DESA
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|RTWN_MGNT_QUEUE
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HQ_DESA
argument_list|,
name|sc
operator|->
name|tx_ring
index|[
name|RTWN_HIGH_QUEUE
index|]
operator|.
name|paddr
argument_list|)
expr_stmt|;
comment|/* Configure Rx DMA. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RX_DESA
argument_list|,
name|sc
operator|->
name|rx_ring
operator|.
name|paddr
argument_list|)
expr_stmt|;
comment|/* Set Tx/Rx transfer page boundary. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TRXFF_BNDY
operator|+
literal|2
argument_list|,
literal|0x27ff
argument_list|)
expr_stmt|;
comment|/* Set Tx/Rx transfer page size. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_PBP
argument_list|,
name|SM
argument_list|(
name|R92C_PBP_PSRX
argument_list|,
name|R92C_PBP_128
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_PBP_PSTX
argument_list|,
name|R92C_PBP_128
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_mac_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Write MAC initialization values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|rtl8192ce_mac
argument_list|)
condition|;
name|i
operator|++
control|)
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|rtl8192ce_mac
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|rtl8192ce_mac
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_bb_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|rtwn_bb_prog
modifier|*
name|prog
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Enable BB and RF. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
operator||
name|R92C_SYS_FUNC_EN_BBRSTB
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator||
name|R92C_SYS_FUNC_EN_DIO_RF
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_PLL_CTRL
argument_list|,
literal|0xdb83
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RF_CTRL
argument_list|,
name|R92C_RF_CTRL_EN
operator||
name|R92C_RF_CTRL_RSTB
operator||
name|R92C_RF_CTRL_SDMRSTB
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|R92C_SYS_FUNC_EN_DIO_PCIE
operator||
name|R92C_SYS_FUNC_EN_PCIEA
operator||
name|R92C_SYS_FUNC_EN_PPLL
operator||
name|R92C_SYS_FUNC_EN_BB_GLB_RST
operator||
name|R92C_SYS_FUNC_EN_BBRSTB
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
operator|+
literal|1
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG0
argument_list|,
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG0
argument_list|)
operator||
literal|0x00800000
argument_list|)
expr_stmt|;
comment|/* Select BB programming. */
name|prog
operator|=
operator|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C
operator|)
condition|?
operator|&
name|rtl8192ce_bb_prog_2t
else|:
operator|&
name|rtl8192ce_bb_prog_1t
expr_stmt|;
comment|/* Write BB initialization values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|prog
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|prog
operator|->
name|regs
index|[
name|i
index|]
argument_list|,
name|prog
operator|->
name|vals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C_1T2R
condition|)
block|{
comment|/* 8192C 1T only configuration. */
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_TXINFO
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000003
operator|)
operator||
literal|0x2
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_TXINFO
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_TXINFO
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00300033
operator|)
operator||
literal|0x00200022
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_TXINFO
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_AFESETTING
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0xff000000
operator|)
operator||
literal|0x45
operator|<<
literal|24
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_AFESETTING
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x000000ff
operator|)
operator||
literal|0x23
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCPARAM1
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000030
operator|)
operator||
literal|1
operator|<<
literal|4
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCPARAM1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe74
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe74
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe78
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe78
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe7c
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe7c
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe80
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe80
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe88
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
literal|2
operator|<<
literal|26
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe88
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* Write AGC values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|prog
operator|->
name|agccount
condition|;
name|i
operator|++
control|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCRSSITABLE
argument_list|,
name|prog
operator|->
name|agcvals
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|)
operator|&
name|R92C_HSSI_PARAM2_CCK_HIPWR
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|RTWN_FLAG_CCK_HIPWR
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_rf_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|struct
name|rtwn_rf_prog
modifier|*
name|prog
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|type
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|idx
decl_stmt|,
name|off
decl_stmt|;
comment|/* Select RF programming based on board type. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|prog
operator|=
name|rtl8188ce_rf_prog
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|prog
operator|=
name|rtl8188ru_rf_prog
expr_stmt|;
else|else
name|prog
operator|=
name|rtl8188cu_rf_prog
expr_stmt|;
block|}
else|else
name|prog
operator|=
name|rtl8192ce_rf_prog
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
comment|/* Save RF_ENV control type. */
name|idx
operator|=
name|i
operator|/
literal|2
expr_stmt|;
name|off
operator|=
operator|(
name|i
operator|%
literal|2
operator|)
operator|*
literal|16
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
operator|(
name|reg
operator|>>
name|off
operator|)
operator|&
literal|0x10
expr_stmt|;
comment|/* Set RF_ENV enable. */
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|0x100000
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Set RF_ENV output high. */
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|0x10
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Set address and data lengths of RF registers. */
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_HSSI_PARAM2_ADDR_LENGTH
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_HSSI_PARAM2_DATA_LENGTH
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* Write RF initialization values for this chain. */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|prog
index|[
name|i
index|]
operator|.
name|count
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
operator|>=
literal|0xf9
operator|&&
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
operator|<=
literal|0xfe
condition|)
block|{
comment|/* 				 * These are fake RF registers offsets that 				 * indicate a delay is required. 				 */
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|prog
index|[
name|i
index|]
operator|.
name|regs
index|[
name|j
index|]
argument_list|,
name|prog
index|[
name|i
index|]
operator|.
name|vals
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Restore RF_ENV control type. */
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
literal|0x10
operator|<<
name|off
operator|)
operator||
operator|(
name|type
operator|<<
name|off
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Cache RF register CHNLBW. */
name|sc
operator|->
name|rf_chnlbw
index|[
name|i
index|]
operator|=
name|rtwn_rf_read
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|chip
operator|&
operator|(
name|RTWN_CHIP_UMC_A_CUT
operator||
name|RTWN_CHIP_92C
operator|)
operator|)
operator|==
name|RTWN_CHIP_UMC_A_CUT
condition|)
block|{
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G1
argument_list|,
literal|0x30255
argument_list|)
expr_stmt|;
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G2
argument_list|,
literal|0x50a00
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_cam_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Invalidate all CAM entries. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CAMCMD
argument_list|,
name|R92C_CAMCMD_POLLING
operator||
name|R92C_CAMCMD_CLR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_pa_bias_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|pa_setting
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x0f406
argument_list|)
expr_stmt|;
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x4f406
argument_list|)
expr_stmt|;
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x8f406
argument_list|)
expr_stmt|;
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0xcf406
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|pa_setting
operator|&
literal|0x10
operator|)
condition|)
block|{
name|reg
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0xf0
operator|)
operator||
literal|0x90
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x16
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_rxfilter_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Initialize Rx filter. */
comment|/* TODO: use better filter for monitor mode. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|R92C_RCR_AAP
operator||
name|R92C_RCR_APM
operator||
name|R92C_RCR_AM
operator||
name|R92C_RCR_AB
operator||
name|R92C_RCR_APP_ICV
operator||
name|R92C_RCR_AMF
operator||
name|R92C_RCR_HTC_LOC_CTRL
operator||
name|R92C_RCR_APP_MIC
operator||
name|R92C_RCR_APP_PHYSTS
argument_list|)
expr_stmt|;
comment|/* Accept all multicast frames. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|0
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|4
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* Accept all management frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP0
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Reject all control frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP1
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* Accept all data frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_edca_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SPEC_SIFS
argument_list|,
literal|0x1010
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_SPEC_SIFS
argument_list|,
literal|0x1010
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_CCK
argument_list|,
literal|0x1010
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_OFDM
argument_list|,
literal|0x0e0e
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BE_PARAM
argument_list|,
literal|0x005ea42b
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BK_PARAM
argument_list|,
literal|0x0000a44f
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VI_PARAM
argument_list|,
literal|0x005e4322
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VO_PARAM
argument_list|,
literal|0x002f3222
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_write_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint16_t
name|power
index|[
name|RTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* Write per-CCK rate Tx power. */
if|if
condition|(
name|chain
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_A_CCK1_MCS32
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK1
argument_list|,
name|power
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_A_CCK1_MCS32
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK2
argument_list|,
name|power
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK55
argument_list|,
name|power
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_A_CCK11
argument_list|,
name|power
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK1_55_MCS32
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK1
argument_list|,
name|power
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK2
argument_list|,
name|power
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK55
argument_list|,
name|power
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK1_55_MCS32
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_TXAGC_B_CCK11
argument_list|,
name|power
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_B_CCK11_A_CCK2_11
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* Write per-OFDM rate Tx power. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_RATE18_06
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_RATE06
argument_list|,
name|power
index|[
literal|4
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE09
argument_list|,
name|power
index|[
literal|5
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE12
argument_list|,
name|power
index|[
literal|6
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE18
argument_list|,
name|power
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_RATE54_24
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_RATE24
argument_list|,
name|power
index|[
literal|8
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE36
argument_list|,
name|power
index|[
literal|9
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE48
argument_list|,
name|power
index|[
literal|10
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_RATE54
argument_list|,
name|power
index|[
literal|11
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write per-MCS Tx power. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS03_MCS00
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS00
argument_list|,
name|power
index|[
literal|12
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS01
argument_list|,
name|power
index|[
literal|13
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS02
argument_list|,
name|power
index|[
literal|14
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS03
argument_list|,
name|power
index|[
literal|15
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS07_MCS04
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS04
argument_list|,
name|power
index|[
literal|16
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS05
argument_list|,
name|power
index|[
literal|17
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS06
argument_list|,
name|power
index|[
literal|18
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS07
argument_list|,
name|power
index|[
literal|19
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS11_MCS08
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS08
argument_list|,
name|power
index|[
literal|20
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS09
argument_list|,
name|power
index|[
literal|21
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS10
argument_list|,
name|power
index|[
literal|22
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS11
argument_list|,
name|power
index|[
literal|23
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_TXAGC_MCS15_MCS12
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R92C_TXAGC_MCS12
argument_list|,
name|power
index|[
literal|24
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS13
argument_list|,
name|power
index|[
literal|25
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS14
argument_list|,
name|power
index|[
literal|26
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_TXAGC_MCS15
argument_list|,
name|power
index|[
literal|27
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_get_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|,
name|uint16_t
name|power
index|[
name|RTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|r92c_rom
modifier|*
name|rom
init|=
operator|&
name|sc
operator|->
name|rom
decl_stmt|;
name|uint16_t
name|cckpow
decl_stmt|,
name|ofdmpow
decl_stmt|,
name|htpow
decl_stmt|,
name|diff
decl_stmt|,
name|max
decl_stmt|;
specifier|const
name|struct
name|rtwn_txpwr
modifier|*
name|base
decl_stmt|;
name|int
name|ridx
decl_stmt|,
name|chan
decl_stmt|,
name|group
decl_stmt|;
comment|/* Determine channel group. */
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|<=
literal|3
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|9
condition|)
name|group
operator|=
literal|1
expr_stmt|;
else|else
name|group
operator|=
literal|2
expr_stmt|;
comment|/* Get original Tx power based on board type and RF chain. */
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|chip
operator|&
name|RTWN_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|base
operator|=
operator|&
name|rtl8188ru_txagc
index|[
name|chain
index|]
expr_stmt|;
else|else
name|base
operator|=
operator|&
name|rtl8192cu_txagc
index|[
name|chain
index|]
expr_stmt|;
block|}
else|else
name|base
operator|=
operator|&
name|rtl8192cu_txagc
index|[
name|chain
index|]
expr_stmt|;
name|memset
argument_list|(
name|power
argument_list|,
literal|0
argument_list|,
name|RTWN_RIDX_COUNT
operator|*
sizeof|sizeof
argument_list|(
name|power
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<=
literal|3
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
for|for
control|(
name|ridx
operator|=
literal|4
init|;
name|ridx
operator|<
name|RTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|3
condition|)
block|{
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
comment|/* Apply vendor limits. */
if|if
condition|(
name|extc
operator|!=
name|NULL
condition|)
name|max
operator|=
name|rom
operator|->
name|ht40_max_pwr
index|[
name|group
index|]
expr_stmt|;
else|else
name|max
operator|=
name|rom
operator|->
name|ht20_max_pwr
index|[
name|group
index|]
expr_stmt|;
name|max
operator|=
operator|(
name|max
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|max
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|max
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
name|group
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|regulatory
operator|!=
literal|2
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|base
operator|->
name|pwr
index|[
literal|0
index|]
index|[
name|ridx
index|]
expr_stmt|;
block|}
comment|/* Compute per-CCK rate Tx power. */
name|cckpow
operator|=
name|rom
operator|->
name|cck_tx_pwr
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<=
literal|3
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|cckpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
name|htpow
operator|=
name|rom
operator|->
name|ht40_1s_tx_pwr
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
block|{
comment|/* Apply reduction for 2 spatial streams. */
name|diff
operator|=
name|rom
operator|->
name|ht40_2s_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|htpow
operator|=
operator|(
name|htpow
operator|>
name|diff
operator|)
condition|?
name|htpow
operator|-
name|diff
else|:
literal|0
expr_stmt|;
block|}
comment|/* Compute per-OFDM rate Tx power. */
name|diff
operator|=
name|rom
operator|->
name|ofdm_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|ofdmpow
operator|=
name|htpow
operator|+
name|diff
expr_stmt|;
comment|/* HT->OFDM correction. */
for|for
control|(
name|ridx
operator|=
literal|4
init|;
name|ridx
operator|<=
literal|11
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|ofdmpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
comment|/* Compute per-MCS Tx power. */
if|if
condition|(
name|extc
operator|==
name|NULL
condition|)
block|{
name|diff
operator|=
name|rom
operator|->
name|ht20_tx_pwr_diff
index|[
name|group
index|]
expr_stmt|;
name|diff
operator|=
operator|(
name|diff
operator|>>
operator|(
name|chain
operator|*
literal|4
operator|)
operator|)
operator|&
literal|0xf
expr_stmt|;
name|htpow
operator|+=
name|diff
expr_stmt|;
comment|/* HT40->HT20 correction. */
block|}
for|for
control|(
name|ridx
operator|=
literal|12
init|;
name|ridx
operator|<=
literal|27
condition|;
name|ridx
operator|++
control|)
block|{
name|power
index|[
name|ridx
index|]
operator|+=
name|htpow
expr_stmt|;
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|RTWN_DEBUG
if|if
condition|(
name|sc
operator|->
name|sc_debug
operator|>=
literal|4
condition|)
block|{
comment|/* Dump per-rate Tx power values. */
name|printf
argument_list|(
literal|"Tx power for chain %d:\n"
argument_list|,
name|chain
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
literal|0
init|;
name|ridx
operator|<
name|RTWN_RIDX_COUNT
condition|;
name|ridx
operator|++
control|)
name|printf
argument_list|(
literal|"Rate %d = %u\n"
argument_list|,
name|ridx
argument_list|,
name|power
index|[
name|ridx
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_set_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|)
block|{
name|uint16_t
name|power
index|[
name|RTWN_RIDX_COUNT
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ntxchains
condition|;
name|i
operator|++
control|)
block|{
comment|/* Compute per-rate Tx power values. */
name|rtwn_get_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|c
argument_list|,
name|extc
argument_list|,
name|power
argument_list|)
expr_stmt|;
comment|/* Write per-rate Tx power values to hardware. */
name|rtwn_write_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|power
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_set_rx_bssid_all
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|reg
operator|&=
operator|~
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
else|else
name|reg
operator||=
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_set_gain
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|gain
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|0
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_OFDM0_AGCCORE1_GAIN
argument_list|,
name|gain
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCCORE1
argument_list|(
literal|1
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_scan_start
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Receive beacons / probe responses from any BSSID. */
name|rtwn_set_rx_bssid_all
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Set gain for scanning. */
name|rtwn_set_gain
argument_list|(
name|sc
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_scan_end
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Restore limitations. */
name|rtwn_set_rx_bssid_all
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Set gain under link. */
name|rtwn_set_gain
argument_list|(
name|sc
argument_list|,
literal|0x32
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_set_channel
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_SCAN
condition|)
block|{
comment|/* Make link LED blink during scan. */
name|rtwn_set_led
argument_list|(
name|sc
argument_list|,
name|RTWN_LED_LINK
argument_list|,
operator|!
name|sc
operator|->
name|ledlink
argument_list|)
expr_stmt|;
block|}
name|rtwn_set_chan
argument_list|(
name|sc
argument_list|,
name|ic
operator|->
name|ic_curchan
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_update_mcast
parameter_list|(
name|struct
name|ieee80211com
modifier|*
name|ic
parameter_list|)
block|{
comment|/* XXX do nothing?  */
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_set_chan
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|extc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|u_int
name|chan
decl_stmt|;
name|int
name|i
decl_stmt|;
name|chan
operator|=
name|ieee80211_chan2ieee
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
expr_stmt|;
comment|/* XXX center freq! */
if|if
condition|(
name|chan
operator|==
literal|0
operator|||
name|chan
operator|==
name|IEEE80211_CHAN_ANY
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: invalid channel %x\n"
argument_list|,
name|__func__
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Set Tx power for this new channel. */
name|rtwn_set_txpower
argument_list|(
name|sc
argument_list|,
name|c
argument_list|,
name|extc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
name|RW
argument_list|(
name|sc
operator|->
name|rf_chnlbw
index|[
name|i
index|]
argument_list|,
name|R92C_RF_CHNLBW_CHNL
argument_list|,
name|chan
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|IEEE80211_NO_HT
if|if
condition|(
name|extc
operator|!=
name|NULL
condition|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* Is secondary channel below or above primary? */
name|int
name|prichlo
init|=
name|c
operator|->
name|ic_freq
operator|<
name|extc
operator|->
name|ic_freq
decl_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|)
operator|&
operator|~
name|R92C_BWOPMODE_20MHZ
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
operator|+
literal|2
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x6f
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|1
else|:
literal|2
operator|)
operator|<<
literal|5
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
operator|+
literal|2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
operator||
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|,
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|)
operator||
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
comment|/* Set CCK side band. */
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000010
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|0
else|:
literal|1
operator|)
operator|<<
literal|4
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x00000c00
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|1
else|:
literal|2
operator|)
operator|<<
literal|10
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|,
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|)
operator|&
operator|~
name|R92C_FPGA0_ANAPARAM2_CBW20
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0x818
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|reg
operator|&
operator|~
literal|0x0c000000
operator|)
operator||
operator|(
name|prichlo
condition|?
literal|2
else|:
literal|1
operator|)
operator|<<
literal|26
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x818
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Select 40MHz bandwidth. */
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
operator|(
name|sc
operator|->
name|rf_chnlbw
index|[
literal|0
index|]
operator|&
operator|~
literal|0xfff
operator|)
operator||
name|chan
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BWOPMODE
argument_list|)
operator||
name|R92C_BWOPMODE_20MHZ
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
operator|&
operator|~
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|,
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_RFMOD
argument_list|)
operator|&
operator|~
name|R92C_RFMOD_40MHZ
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|,
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_ANAPARAM2
argument_list|)
operator||
name|R92C_FPGA0_ANAPARAM2_CBW20
argument_list|)
expr_stmt|;
comment|/* Select 20MHz bandwidth. */
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
operator|(
name|sc
operator|->
name|rf_chnlbw
index|[
literal|0
index|]
operator|&
operator|~
literal|0xfff
operator|)
operator||
name|R92C_RF_CHNLBW_BW20
operator||
name|chan
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_iq_calib_chain
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|uint16_t
name|tx
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
name|rx
index|[
literal|2
index|]
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|;
name|int
name|offset
init|=
name|chain
operator|*
literal|0x20
decl_stmt|;
if|if
condition|(
name|chain
operator|==
literal|0
condition|)
block|{
comment|/* IQ calibration for chain 0. */
comment|/* IQ calibration settings for chain 0. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe30
argument_list|,
literal|0x10008c1f
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe34
argument_list|,
literal|0x10008c1f
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe38
argument_list|,
literal|0x82140102
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe3c
argument_list|,
literal|0x28160202
argument_list|)
expr_stmt|;
comment|/* 2T */
comment|/* IQ calibration settings for chain 1. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe50
argument_list|,
literal|0x10008c22
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe54
argument_list|,
literal|0x10008c22
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe58
argument_list|,
literal|0x82140102
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe5c
argument_list|,
literal|0x28160202
argument_list|)
expr_stmt|;
block|}
else|else
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe3c
argument_list|,
literal|0x28160502
argument_list|)
expr_stmt|;
comment|/* 1T */
comment|/* LO calibration settings. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe4c
argument_list|,
literal|0x001028d1
argument_list|)
expr_stmt|;
comment|/* We're doing LO and IQ calibration in one shot. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe48
argument_list|,
literal|0xf9000000
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe48
argument_list|,
literal|0xf8000000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* IQ calibration for chain 1. */
comment|/* We're doing LO and IQ calibration in one shot. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe60
argument_list|,
literal|0x00000002
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0xe60
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
comment|/* Give LO and IQ calibrations the time to complete. */
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* Read IQ calibration status. */
name|status
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xeac
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|28
operator|+
name|chain
operator|*
literal|3
operator|)
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Tx failed. */
comment|/* Read Tx IQ calibration results. */
name|tx
index|[
literal|0
index|]
operator|=
operator|(
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe94
operator|+
name|offset
argument_list|)
operator|>>
literal|16
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|tx
index|[
literal|1
index|]
operator|=
operator|(
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xe9c
operator|+
name|offset
argument_list|)
operator|>>
literal|16
operator|)
operator|&
literal|0x3ff
expr_stmt|;
if|if
condition|(
name|tx
index|[
literal|0
index|]
operator|==
literal|0x142
operator|||
name|tx
index|[
literal|1
index|]
operator|==
literal|0x042
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Tx failed. */
if|if
condition|(
name|status
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|27
operator|+
name|chain
operator|*
literal|3
operator|)
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* Rx failed. */
comment|/* Read Rx IQ calibration results. */
name|rx
index|[
literal|0
index|]
operator|=
operator|(
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xea4
operator|+
name|offset
argument_list|)
operator|>>
literal|16
operator|)
operator|&
literal|0x3ff
expr_stmt|;
name|rx
index|[
literal|1
index|]
operator|=
operator|(
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
literal|0xeac
operator|+
name|offset
argument_list|)
operator|>>
literal|16
operator|)
operator|&
literal|0x3ff
expr_stmt|;
if|if
condition|(
name|rx
index|[
literal|0
index|]
operator|==
literal|0x132
operator|||
name|rx
index|[
literal|1
index|]
operator|==
literal|0x036
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* Rx failed. */
return|return
operator|(
literal|3
operator|)
return|;
comment|/* Both Tx and Rx succeeded. */
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_iq_calib_run
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|n
parameter_list|,
name|uint16_t
name|tx
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
name|rx
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|)
block|{
comment|/* Registers to save and restore during IQ calibration. */
struct|struct
name|iq_cal_regs
block|{
name|uint32_t
name|adda
index|[
literal|16
index|]
decl_stmt|;
name|uint8_t
name|txpause
decl_stmt|;
name|uint8_t
name|bcn_ctrl
decl_stmt|;
name|uint8_t
name|ustime_tsf
decl_stmt|;
name|uint32_t
name|gpio_muxcfg
decl_stmt|;
name|uint32_t
name|ofdm0_trxpathena
decl_stmt|;
name|uint32_t
name|ofdm0_trmuxpar
decl_stmt|;
name|uint32_t
name|fpga0_rfifacesw1
decl_stmt|;
block|}
name|iq_cal_regs
struct|;
specifier|static
specifier|const
name|uint16_t
name|reg_adda
index|[
literal|16
index|]
init|=
block|{
literal|0x85c
block|,
literal|0xe6c
block|,
literal|0xe70
block|,
literal|0xe74
block|,
literal|0xe78
block|,
literal|0xe7c
block|,
literal|0xe80
block|,
literal|0xe84
block|,
literal|0xe88
block|,
literal|0xe8c
block|,
literal|0xed0
block|,
literal|0xed4
block|,
literal|0xed8
block|,
literal|0xedc
block|,
literal|0xee0
block|,
literal|0xeec
block|}
decl_stmt|;
name|int
name|i
decl_stmt|,
name|chain
decl_stmt|;
name|uint32_t
name|hssi_param1
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|reg_adda
argument_list|)
condition|;
name|i
operator|++
control|)
name|iq_cal_regs
operator|.
name|adda
index|[
name|i
index|]
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|reg_adda
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|iq_cal_regs
operator|.
name|txpause
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|)
expr_stmt|;
name|iq_cal_regs
operator|.
name|bcn_ctrl
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|)
expr_stmt|;
name|iq_cal_regs
operator|.
name|ustime_tsf
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_USTIME_TSF
argument_list|)
expr_stmt|;
name|iq_cal_regs
operator|.
name|gpio_muxcfg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|==
literal|1
condition|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|reg_adda
index|[
literal|0
index|]
argument_list|,
literal|0x0b1b25a0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|nitems
argument_list|(
name|reg_adda
argument_list|)
condition|;
name|i
operator|++
control|)
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|reg_adda
index|[
name|i
index|]
argument_list|,
literal|0x0bdb25a0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|reg_adda
argument_list|)
condition|;
name|i
operator|++
control|)
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|reg_adda
index|[
name|i
index|]
argument_list|,
literal|0x04db25a4
argument_list|)
expr_stmt|;
block|}
name|hssi_param1
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hssi_param1
operator|&
name|R92C_HSSI_PARAM1_PI
operator|)
condition|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
literal|0
argument_list|)
argument_list|,
name|hssi_param1
operator||
name|R92C_HSSI_PARAM1_PI
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
literal|1
argument_list|)
argument_list|,
name|hssi_param1
operator||
name|R92C_HSSI_PARAM1_PI
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|iq_cal_regs
operator|.
name|ofdm0_trxpathena
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|)
expr_stmt|;
name|iq_cal_regs
operator|.
name|ofdm0_trmuxpar
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRMUXPAR
argument_list|)
expr_stmt|;
name|iq_cal_regs
operator|.
name|fpga0_rfifacesw1
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|,
literal|0x03a05600
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRMUXPAR
argument_list|,
literal|0x000800e4
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x22204000
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
block|}
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|iq_cal_regs
operator|.
name|bcn_ctrl
operator|&
operator|~
operator|(
literal|0x08
operator|)
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USTIME_TSF
argument_list|,
name|iq_cal_regs
operator|.
name|ustime_tsf
operator|&
operator|~
operator|(
literal|0x08
operator|)
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|,
name|iq_cal_regs
operator|.
name|gpio_muxcfg
operator|&
operator|~
operator|(
literal|0x20
operator|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0b68
argument_list|,
literal|0x00080000
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0b6c
argument_list|,
literal|0x00080000
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0e28
argument_list|,
literal|0x80800000
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0e40
argument_list|,
literal|0x01007c00
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0e44
argument_list|,
literal|0x01004800
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0b68
argument_list|,
literal|0x00080000
argument_list|)
expr_stmt|;
for|for
control|(
name|chain
operator|=
literal|0
init|;
name|chain
operator|<
name|sc
operator|->
name|ntxchains
condition|;
name|chain
operator|++
control|)
block|{
if|if
condition|(
name|chain
operator|>
literal|0
condition|)
block|{
comment|/* Put chain 0 on standby. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0e28
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x00010000
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0e28
argument_list|,
literal|0x80800000
argument_list|)
expr_stmt|;
comment|/* Enable chain 1. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|reg_adda
argument_list|)
condition|;
name|i
operator|++
control|)
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|reg_adda
index|[
name|i
index|]
argument_list|,
literal|0x0b1b25a4
argument_list|)
expr_stmt|;
block|}
comment|/* Run IQ calibration twice. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|rtwn_iq_calib_chain
argument_list|(
name|sc
argument_list|,
name|chain
argument_list|,
name|tx
index|[
name|chain
index|]
argument_list|,
name|rx
index|[
name|chain
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"%s: chain %d: Tx failed.\n"
operator|,
name|__func__
operator|,
name|chain
operator|)
argument_list|)
expr_stmt|;
name|tx
index|[
name|chain
index|]
index|[
literal|0
index|]
operator|=
literal|0xff
expr_stmt|;
name|tx
index|[
name|chain
index|]
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
name|rx
index|[
name|chain
index|]
index|[
literal|0
index|]
operator|=
literal|0xff
expr_stmt|;
name|rx
index|[
name|chain
index|]
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"%s: chain %d: Rx failed.\n"
operator|,
name|__func__
operator|,
name|chain
operator|)
argument_list|)
expr_stmt|;
name|rx
index|[
name|chain
index|]
index|[
literal|0
index|]
operator|=
literal|0xff
expr_stmt|;
name|rx
index|[
name|chain
index|]
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
literal|3
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"%s: chain %d: Both Tx and Rx "
literal|"succeeded.\n"
operator|,
name|__func__
operator|,
name|chain
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"%s: results for run %d chain %d: tx[0]=0x%x, "
literal|"tx[1]=0x%x rx[0]=0x%x rx[1]=0x%x\n"
operator|,
name|__func__
operator|,
name|n
operator|,
name|chain
operator|,
name|tx
index|[
name|chain
index|]
index|[
literal|0
index|]
operator|,
name|tx
index|[
name|chain
index|]
index|[
literal|1
index|]
operator|,
name|rx
index|[
name|chain
index|]
index|[
literal|0
index|]
operator|,
name|rx
index|[
name|chain
index|]
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|,
name|iq_cal_regs
operator|.
name|ofdm0_trxpathena
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
literal|1
argument_list|)
argument_list|,
name|iq_cal_regs
operator|.
name|fpga0_rfifacesw1
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRMUXPAR
argument_list|,
name|iq_cal_regs
operator|.
name|ofdm0_trmuxpar
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
literal|0x0e28
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x00032ed3
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_LSSI_PARAM
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x00032ed3
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|hssi_param1
operator|&
name|R92C_HSSI_PARAM1_PI
operator|)
condition|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
literal|0
argument_list|)
argument_list|,
name|hssi_param1
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM1
argument_list|(
literal|1
argument_list|)
argument_list|,
name|hssi_param1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|reg_adda
argument_list|)
condition|;
name|i
operator|++
control|)
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|reg_adda
index|[
name|i
index|]
argument_list|,
name|iq_cal_regs
operator|.
name|adda
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
name|iq_cal_regs
operator|.
name|txpause
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|iq_cal_regs
operator|.
name|bcn_ctrl
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_USTIME_TSF
argument_list|,
name|iq_cal_regs
operator|.
name|ustime_tsf
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|,
name|iq_cal_regs
operator|.
name|gpio_muxcfg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|RTWN_IQ_CAL_MAX_TOLERANCE
value|5
end_define

begin_function
specifier|static
name|int
name|rtwn_iq_calib_compare_results
parameter_list|(
name|uint16_t
name|tx1
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
name|rx1
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
name|tx2
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
name|rx2
index|[
literal|2
index|]
index|[
literal|2
index|]
parameter_list|,
name|int
name|ntxchains
parameter_list|)
block|{
name|int
name|chain
decl_stmt|,
name|i
decl_stmt|,
name|tx_ok
index|[
literal|2
index|]
decl_stmt|,
name|rx_ok
index|[
literal|2
index|]
decl_stmt|;
name|tx_ok
index|[
literal|0
index|]
operator|=
name|tx_ok
index|[
literal|1
index|]
operator|=
name|rx_ok
index|[
literal|0
index|]
operator|=
name|rx_ok
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|chain
operator|=
literal|0
init|;
name|chain
operator|<
name|ntxchains
condition|;
name|chain
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tx1
index|[
name|chain
index|]
index|[
name|i
index|]
operator|==
literal|0xff
operator|||
name|tx2
index|[
name|chain
index|]
index|[
name|i
index|]
operator|==
literal|0xff
operator|||
name|rx1
index|[
name|chain
index|]
index|[
name|i
index|]
operator|==
literal|0xff
operator|||
name|rx2
index|[
name|chain
index|]
index|[
name|i
index|]
operator|==
literal|0xff
condition|)
continue|continue;
name|tx_ok
index|[
name|chain
index|]
operator|=
operator|(
name|abs
argument_list|(
name|tx1
index|[
name|chain
index|]
index|[
name|i
index|]
operator|-
name|tx2
index|[
name|chain
index|]
index|[
name|i
index|]
argument_list|)
operator|<=
name|RTWN_IQ_CAL_MAX_TOLERANCE
operator|)
expr_stmt|;
name|rx_ok
index|[
name|chain
index|]
operator|=
operator|(
name|abs
argument_list|(
name|rx1
index|[
name|chain
index|]
index|[
name|i
index|]
operator|-
name|rx2
index|[
name|chain
index|]
index|[
name|i
index|]
argument_list|)
operator|<=
name|RTWN_IQ_CAL_MAX_TOLERANCE
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ntxchains
operator|>
literal|1
condition|)
return|return
operator|(
name|tx_ok
index|[
literal|0
index|]
operator|&&
name|tx_ok
index|[
literal|1
index|]
operator|&&
name|rx_ok
index|[
literal|0
index|]
operator|&&
name|rx_ok
index|[
literal|1
index|]
operator|)
return|;
else|else
return|return
operator|(
name|tx_ok
index|[
literal|0
index|]
operator|&&
name|rx_ok
index|[
literal|0
index|]
operator|)
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|RTWN_IQ_CAL_MAX_TOLERANCE
end_undef

begin_function
specifier|static
name|void
name|rtwn_iq_calib_write_results
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|tx
index|[
literal|2
index|]
parameter_list|,
name|uint16_t
name|rx
index|[
literal|2
index|]
parameter_list|,
name|int
name|chain
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|,
name|val
decl_stmt|,
name|x
decl_stmt|;
name|long
name|y
decl_stmt|,
name|tx_c
decl_stmt|;
if|if
condition|(
name|tx
index|[
literal|0
index|]
operator|==
literal|0xff
operator|||
name|tx
index|[
literal|1
index|]
operator|==
literal|0xff
condition|)
return|return;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TXIQIMBALANCE
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|reg
operator|>>
literal|22
operator|)
operator|&
literal|0x3ff
operator|)
expr_stmt|;
name|x
operator|=
name|tx
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|x
operator|&
literal|0x0200
condition|)
name|x
operator||=
literal|0xfc00
expr_stmt|;
name|reg
operator|=
operator|(
operator|(
operator|(
name|x
operator|*
name|val
operator|)
operator|>>
literal|8
operator|)
operator|&
literal|0x3ff
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TXIQIMBALANCE
argument_list|(
name|chain
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_ECCATHRESHOLD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|x
operator|*
name|val
operator|)
operator|>>
literal|7
operator|)
operator|&
literal|0x01
condition|)
name|reg
operator||=
literal|0x80000000
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
literal|0x80000000
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_ECCATHRESHOLD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|y
operator|=
name|tx
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|y
operator|&
literal|0x00000200
condition|)
name|y
operator||=
literal|0xfffffc00
expr_stmt|;
name|tx_c
operator|=
operator|(
name|y
operator|*
name|val
operator|)
operator|>>
literal|8
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TXAFE
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
operator|(
operator|(
name|tx_c
operator|&
literal|0x3c0
operator|)
operator|>>
literal|6
operator|)
operator|<<
literal|24
operator|)
operator|&
literal|0xf0000000
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TXAFE
argument_list|(
name|chain
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TXIQIMBALANCE
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
operator|(
name|tx_c
operator|&
literal|0x3f
operator|)
operator|<<
literal|16
operator|)
operator|&
literal|0x003F0000
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TXIQIMBALANCE
argument_list|(
name|chain
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_ECCATHRESHOLD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|y
operator|*
name|val
operator|)
operator|>>
literal|7
operator|)
operator|&
literal|0x01
condition|)
name|reg
operator||=
literal|0x20000000
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
literal|0x20000000
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_ECCATHRESHOLD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx
index|[
literal|0
index|]
operator|==
literal|0xff
operator|||
name|rx
index|[
literal|1
index|]
operator|==
literal|0xff
condition|)
return|return;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_RXIQIMBALANCE
argument_list|(
name|chain
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
name|rx
index|[
literal|0
index|]
operator|&
literal|0x3ff
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_RXIQIMBALANCE
argument_list|(
name|chain
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
operator|(
name|rx
index|[
literal|1
index|]
operator|&
literal|0x03f
operator|)
operator|<<
literal|8
operator|)
operator|&
literal|0xFC00
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_RXIQIMBALANCE
argument_list|(
name|chain
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_RXIQEXTANTA
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
operator|(
name|rx
index|[
literal|1
index|]
operator|&
literal|0xf
operator|)
operator|>>
literal|6
operator|)
operator|&
literal|0x000f
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_RXIQEXTANTA
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCRSSITABLE
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
operator|(
operator|(
name|rx
index|[
literal|1
index|]
operator|&
literal|0xf
operator|)
operator|>>
literal|6
operator|)
operator|<<
literal|12
operator|)
operator|&
literal|0xf000
operator|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCRSSITABLE
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|RTWN_IQ_CAL_NRUN
value|3
end_define

begin_function
specifier|static
name|void
name|rtwn_iq_calib
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|tx
index|[
name|RTWN_IQ_CAL_NRUN
index|]
index|[
literal|2
index|]
index|[
literal|2
index|]
decl_stmt|,
name|rx
index|[
name|RTWN_IQ_CAL_NRUN
index|]
index|[
literal|2
index|]
index|[
literal|2
index|]
decl_stmt|;
name|int
name|n
decl_stmt|,
name|valid
decl_stmt|;
name|valid
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|RTWN_IQ_CAL_NRUN
condition|;
name|n
operator|++
control|)
block|{
name|rtwn_iq_calib_run
argument_list|(
name|sc
argument_list|,
name|n
argument_list|,
name|tx
index|[
name|n
index|]
argument_list|,
name|rx
index|[
name|n
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
continue|continue;
comment|/* Valid results remain stable after consecutive runs. */
name|valid
operator|=
name|rtwn_iq_calib_compare_results
argument_list|(
name|tx
index|[
name|n
operator|-
literal|1
index|]
argument_list|,
name|rx
index|[
name|n
operator|-
literal|1
index|]
argument_list|,
name|tx
index|[
name|n
index|]
argument_list|,
name|rx
index|[
name|n
index|]
argument_list|,
name|sc
operator|->
name|ntxchains
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid
condition|)
break|break;
block|}
if|if
condition|(
name|valid
condition|)
block|{
name|rtwn_iq_calib_write_results
argument_list|(
name|sc
argument_list|,
name|tx
index|[
name|n
index|]
index|[
literal|0
index|]
argument_list|,
name|rx
index|[
name|n
index|]
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>
literal|1
condition|)
name|rtwn_iq_calib_write_results
argument_list|(
name|sc
argument_list|,
name|tx
index|[
name|n
index|]
index|[
literal|1
index|]
argument_list|,
name|rx
index|[
name|n
index|]
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_undef
undef|#
directive|undef
name|RTWN_IQ_CAL_NRUN
end_undef

begin_function
specifier|static
name|void
name|rtwn_lc_calib
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|rf_ac
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|txmode
decl_stmt|;
name|int
name|i
decl_stmt|;
name|txmode
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|txmode
operator|&
literal|0x70
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Disable all continuous Tx. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|,
name|txmode
operator|&
operator|~
literal|0x70
argument_list|)
expr_stmt|;
comment|/* Set RF mode to standby mode. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
name|rf_ac
index|[
name|i
index|]
operator|=
name|rtwn_rf_read
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|)
expr_stmt|;
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|,
name|RW
argument_list|(
name|rf_ac
index|[
name|i
index|]
argument_list|,
name|R92C_RF_AC_MODE
argument_list|,
name|R92C_RF_AC_MODE_STANDBY
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Block all Tx queues. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
comment|/* Start calibration. */
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
name|rtwn_rf_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_CHNLBW
argument_list|)
operator||
name|R92C_RF_CHNLBW_LCSTART
argument_list|)
expr_stmt|;
comment|/* Give calibration the time to complete. */
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Restore configuration. */
if|if
condition|(
operator|(
name|txmode
operator|&
literal|0x70
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Restore Tx mode. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM1_LSTF
operator|+
literal|3
argument_list|,
name|txmode
argument_list|)
expr_stmt|;
comment|/* Restore RF mode. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_AC
argument_list|,
name|rf_ac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Unblock all Tx queues. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_temp_calib
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|temp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|thcal_state
operator|==
literal|0
condition|)
block|{
comment|/* Start measuring temperature. */
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_T_METER
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
name|sc
operator|->
name|thcal_state
operator|=
literal|1
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|thcal_state
operator|=
literal|0
expr_stmt|;
comment|/* Read measured temperature. */
name|temp
operator|=
name|rtwn_rf_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_T_METER
argument_list|)
operator|&
literal|0x1f
expr_stmt|;
if|if
condition|(
name|temp
operator|==
literal|0
condition|)
comment|/* Read failed, skip. */
return|return;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"temperature=%d\n"
operator|,
name|temp
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Redo IQ and LC calibration if temperature changed significantly 	 * since last calibration. 	 */
if|if
condition|(
name|sc
operator|->
name|thcal_lctemp
operator|==
literal|0
condition|)
block|{
comment|/* First calibration is performed in rtwn_init(). */
name|sc
operator|->
name|thcal_lctemp
operator|=
name|temp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|abs
argument_list|(
name|temp
operator|-
name|sc
operator|->
name|thcal_lctemp
argument_list|)
operator|>
literal|1
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"IQ/LC calib triggered by temp: %d -> %d\n"
operator|,
name|sc
operator|->
name|thcal_lctemp
operator|,
name|temp
operator|)
argument_list|)
expr_stmt|;
name|rtwn_iq_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rtwn_lc_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Record temperature of last calibration. */
name|sc
operator|->
name|thcal_lctemp
operator|=
name|temp
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rtwn_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|ic
operator|->
name|ic_vaps
argument_list|)
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint8_t
name|macaddr
index|[
name|IEEE80211_ADDR_LEN
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_RUNNING
condition|)
block|{
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sc
operator|->
name|sc_flags
operator||=
name|RTWN_RUNNING
expr_stmt|;
comment|/* Init firmware commands ring. */
name|sc
operator|->
name|fwcur
operator|=
literal|0
expr_stmt|;
comment|/* Power on adapter. */
name|error
operator|=
name|rtwn_power_on
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not power on adapter\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Initialize DMA. */
name|error
operator|=
name|rtwn_dma_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"could not initialize DMA\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Set info size in Rx descriptors (in 64-bit words). */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RX_DRVINFO_SZ
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Disable interrupts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HISR
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HIMR
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* Set MAC address. */
name|IEEE80211_ADDR_COPY
argument_list|(
name|macaddr
argument_list|,
name|vap
condition|?
name|vap
operator|->
name|iv_myaddr
else|:
name|ic
operator|->
name|ic_macaddr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IEEE80211_ADDR_LEN
condition|;
name|i
operator|++
control|)
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_MACID
operator|+
name|i
argument_list|,
name|macaddr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Set initial network type. */
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_CR_NETTYPE
argument_list|,
name|R92C_CR_NETTYPE_INFRA
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|rtwn_rxfilter_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|RW
argument_list|(
name|reg
argument_list|,
name|R92C_RRSR_RATE_BITMAP
argument_list|,
name|R92C_RRSR_RATE_ALL
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Set short/long retry limits. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RL
argument_list|,
name|SM
argument_list|(
name|R92C_RL_SRL
argument_list|,
literal|0x07
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_RL_LRL
argument_list|,
literal|0x07
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize EDCA parameters. */
name|rtwn_edca_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set data and response automatic rate fallback retry counts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_DARFRC
operator|+
literal|0
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_DARFRC
operator|+
literal|4
argument_list|,
literal|0x07060504
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RARFRC
operator|+
literal|0
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RARFRC
operator|+
literal|4
argument_list|,
literal|0x07060504
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_FWHW_TXQ_CTRL
argument_list|,
literal|0x1f80
argument_list|)
expr_stmt|;
comment|/* Set ACK timeout. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_ACKTO
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
comment|/* Initialize beacon parameters. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_TBTT_PROHIBIT
argument_list|,
literal|0x6404
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_DRVERLYINT
argument_list|,
literal|0x05
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCNDMATIM
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_BCNTCFG
argument_list|,
literal|0x660f
argument_list|)
expr_stmt|;
comment|/* Setup AMPDU aggregation. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_AGGLEN_LMT
argument_list|,
literal|0x99997631
argument_list|)
expr_stmt|;
comment|/* MCS7~0 */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AGGR_BREAK_TIME
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_MAX_ERR
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_BCN_CTRL
argument_list|,
name|R92C_BCN_CTRL_DIS_TSF_UDT0
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_PIFS
argument_list|,
literal|0x1c
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MCUTST_1
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
comment|/* Load 8051 microcode. */
name|error
operator|=
name|rtwn_load_firmware
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
comment|/* Initialize MAC/BB/RF blocks. */
name|rtwn_mac_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rtwn_bb_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rtwn_rf_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Turn CCK and OFDM blocks on. */
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_RFMOD_CCK_EN
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_RFMOD_OFDM_EN
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Clear per-station keys table. */
name|rtwn_cam_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable hardware sequence numbering. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_HWSEQ_CTRL
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* Perform LO and IQ calibrations. */
name|rtwn_iq_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Perform LC calibration. */
name|rtwn_lc_calib
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rtwn_pa_bias_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Initialize GPIO setting. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|,
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_GPIO_MUXCFG
argument_list|)
operator|&
operator|~
name|R92C_GPIO_MUXCFG_ENBT
argument_list|)
expr_stmt|;
comment|/* Fix for lower temperature. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
literal|0x15
argument_list|,
literal|0xe9
argument_list|)
expr_stmt|;
comment|/* CLear pending interrupts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HISR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* Enable interrupts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HIMR
argument_list|,
name|RTWN_INT_ENABLE
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_to
argument_list|,
name|hz
argument_list|,
name|rtwn_watchdog
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|rtwn_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_stop_locked
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RTWN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_RUNNING
operator|)
condition|)
return|return;
name|sc
operator|->
name|sc_tx_timer
operator|=
literal|0
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|watchdog_to
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|calib_to
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_flags
operator|&=
operator|~
name|RTWN_RUNNING
expr_stmt|;
comment|/* Disable interrupts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HISR
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HIMR
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* Stop hardware. */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_TXPAUSE
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RF_CTRL
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|)
expr_stmt|;
name|reg
operator||=
name|R92C_SYS_FUNC_EN_BB_GLB_RST
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|R92C_SYS_FUNC_EN_BB_GLB_RST
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SYS_FUNC_EN
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|R92C_CR_HCI_TXDMA_EN
operator||
name|R92C_CR_HCI_RXDMA_EN
operator||
name|R92C_CR_TXDMA_EN
operator||
name|R92C_CR_RXDMA_EN
operator||
name|R92C_CR_PROTOCOL_EN
operator||
name|R92C_CR_SCHEDULE_EN
operator||
name|R92C_CR_MACTXEN
operator||
name|R92C_CR_MACRXEN
operator||
name|R92C_CR_ENSEC
operator|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R92C_MCUFWDL
argument_list|)
operator|&
name|R92C_MCUFWDL_RAM_DL_SEL
condition|)
name|rtwn_fw_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* TODO: linux does additional btcoex stuff here */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_PLL_CTRL
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
comment|/* linux magic number */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_SPS0_CTRL
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
comment|/* ditto */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AFE_XTAL_CTRL
argument_list|,
literal|0x0e
argument_list|)
expr_stmt|;
comment|/* different with btcoex */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_RSV_CTRL
argument_list|,
literal|0x0e
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_APS_FSMCO
argument_list|,
name|R92C_APS_FSMCO_PDN_EN
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_NTXQUEUES
condition|;
name|i
operator|++
control|)
name|rtwn_reset_tx_list
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|rtwn_reset_rx_list
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_stop
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rtwn_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|status
operator|=
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_HISR
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
operator|||
name|status
operator|==
literal|0xffffffff
condition|)
block|{
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Disable interrupts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HIMR
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* Ack interrupts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HISR
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* Vendor driver treats RX errors like ROK... */
if|if
condition|(
name|status
operator|&
operator|(
name|R92C_IMR_ROK
operator||
name|R92C_IMR_RXFOVW
operator||
name|R92C_IMR_RDU
operator|)
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|rx_ring
operator|.
name|desc_dmat
argument_list|,
name|sc
operator|->
name|rx_ring
operator|.
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_RX_LIST_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|r92c_rx_desc
modifier|*
name|rx_desc
init|=
operator|&
name|sc
operator|->
name|rx_ring
operator|.
name|desc
index|[
name|i
index|]
decl_stmt|;
name|struct
name|rtwn_rx_data
modifier|*
name|rx_data
init|=
operator|&
name|sc
operator|->
name|rx_ring
operator|.
name|rx_data
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|le32toh
argument_list|(
name|rx_desc
operator|->
name|rxdw0
argument_list|)
operator|&
name|R92C_RXDW0_OWN
condition|)
continue|continue;
name|rtwn_rx_frame
argument_list|(
name|sc
argument_list|,
name|rx_desc
argument_list|,
name|rx_data
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|status
operator|&
name|R92C_IMR_BDOK
condition|)
name|rtwn_tx_done
argument_list|(
name|sc
argument_list|,
name|RTWN_BEACON_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|R92C_IMR_HIGHDOK
condition|)
name|rtwn_tx_done
argument_list|(
name|sc
argument_list|,
name|RTWN_HIGH_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|R92C_IMR_MGNTDOK
condition|)
name|rtwn_tx_done
argument_list|(
name|sc
argument_list|,
name|RTWN_MGNT_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|R92C_IMR_BKDOK
condition|)
name|rtwn_tx_done
argument_list|(
name|sc
argument_list|,
name|RTWN_BK_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|R92C_IMR_BEDOK
condition|)
name|rtwn_tx_done
argument_list|(
name|sc
argument_list|,
name|RTWN_BE_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|R92C_IMR_VIDOK
condition|)
name|rtwn_tx_done
argument_list|(
name|sc
argument_list|,
name|RTWN_VI_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|R92C_IMR_VODOK
condition|)
name|rtwn_tx_done
argument_list|(
name|sc
argument_list|,
name|RTWN_VO_QUEUE
argument_list|)
expr_stmt|;
comment|/* Enable interrupts. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_HIMR
argument_list|,
name|RTWN_INT_ENABLE
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


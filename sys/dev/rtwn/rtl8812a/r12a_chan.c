begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Andriy Voskoboinyk<avos@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwnvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwn_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwn_ridx.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwn_rx.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8812a/r12a.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8812a/r12a_reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8812a/r12a_var.h>
end_include

begin_function
specifier|static
name|void
name|r12a_write_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|uint8_t
name|power
index|[
name|RTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* Write per-CCK rate Tx power. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_CCK11_1
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R12A_TXAGC_CCK1
argument_list|,
name|power
index|[
name|RTWN_RIDX_CCK1
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_CCK2
argument_list|,
name|power
index|[
name|RTWN_RIDX_CCK2
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_CCK55
argument_list|,
name|power
index|[
name|RTWN_RIDX_CCK55
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_CCK11
argument_list|,
name|power
index|[
name|RTWN_RIDX_CCK11
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Write per-OFDM rate Tx power. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_OFDM18_6
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R12A_TXAGC_OFDM06
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM6
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_OFDM09
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM9
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_OFDM12
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM12
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_OFDM18
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM18
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_OFDM54_24
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R12A_TXAGC_OFDM24
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM24
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_OFDM36
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM36
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_OFDM48
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM48
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_OFDM54
argument_list|,
name|power
index|[
name|RTWN_RIDX_OFDM54
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write per-MCS Tx power. */
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_MCS3_0
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R12A_TXAGC_MCS0
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|0
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS1
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|1
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS2
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|2
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS3
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|3
argument_list|)
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_MCS7_4
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R12A_TXAGC_MCS4
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|4
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS5
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|5
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS6
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|6
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS7
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|7
argument_list|)
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|>=
literal|2
condition|)
block|{
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_MCS11_8
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R12A_TXAGC_MCS8
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|8
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS9
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|9
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS10
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|10
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS11
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|11
argument_list|)
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_MCS15_12
argument_list|(
name|chain
argument_list|)
argument_list|,
name|SM
argument_list|(
name|R12A_TXAGC_MCS12
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|12
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS13
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|13
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS14
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|14
argument_list|)
index|]
argument_list|)
operator||
name|SM
argument_list|(
name|R12A_TXAGC_MCS15
argument_list|,
name|power
index|[
name|RTWN_RIDX_HT_MCS
argument_list|(
literal|15
argument_list|)
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: VHT rates */
block|}
end_function

begin_function
specifier|static
name|int
name|r12a_get_power_group
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|uint8_t
name|chan
decl_stmt|;
name|int
name|group
decl_stmt|;
name|chan
operator|=
name|rtwn_chan2centieee
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
name|chan
operator|<=
literal|2
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|5
condition|)
name|group
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|8
condition|)
name|group
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|11
condition|)
name|group
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|14
condition|)
name|group
operator|=
literal|4
expr_stmt|;
else|else
block|{
name|KASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"wrong 2GHz channel %d!\n"
operator|,
name|chan
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
name|chan
operator|<
literal|36
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|chan
operator|<=
literal|42
condition|)
name|group
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|48
condition|)
name|group
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|58
condition|)
name|group
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|64
condition|)
name|group
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|106
condition|)
name|group
operator|=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|114
condition|)
name|group
operator|=
literal|5
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|122
condition|)
name|group
operator|=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|130
condition|)
name|group
operator|=
literal|7
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|138
condition|)
name|group
operator|=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|144
condition|)
name|group
operator|=
literal|9
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|155
condition|)
name|group
operator|=
literal|10
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|161
condition|)
name|group
operator|=
literal|11
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|171
condition|)
name|group
operator|=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|<=
literal|177
condition|)
name|group
operator|=
literal|13
expr_stmt|;
else|else
block|{
name|KASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"wrong 5GHz channel %d!\n"
operator|,
name|chan
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|KASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"wrong channel band (flags %08X)\n"
operator|,
name|c
operator|->
name|ic_flags
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|group
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|r12a_get_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|chain
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|,
name|uint8_t
name|power
index|[
name|RTWN_RIDX_COUNT
index|]
parameter_list|)
block|{
name|struct
name|r12a_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ridx
decl_stmt|,
name|group
decl_stmt|,
name|max_mcs
decl_stmt|;
comment|/* Determine channel group. */
name|group
operator|=
name|r12a_get_power_group
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* shouldn't happen */
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: incorrect channel\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* TODO: VHT rates. */
name|max_mcs
operator|=
name|RTWN_RIDX_HT_MCS
argument_list|(
name|sc
operator|->
name|ntxchains
operator|*
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* XXX regulatory */
comment|/* XXX net80211 regulatory */
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
for|for
control|(
name|ridx
operator|=
name|RTWN_RIDX_CCK1
init|;
name|ridx
operator|<=
name|RTWN_RIDX_CCK11
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|rs
operator|->
name|cck_tx_pwr
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|RTWN_RIDX_OFDM6
init|;
name|ridx
operator|<=
name|max_mcs
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|rs
operator|->
name|ht40_tx_pwr_2g
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|RTWN_RIDX_OFDM6
init|;
name|ridx
operator|<=
name|RTWN_RIDX_OFDM54
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|+=
name|rs
operator|->
name|ofdm_tx_pwr_diff_2g
index|[
name|chain
index|]
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ntxchains
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
name|min_mcs
decl_stmt|;
name|uint8_t
name|pwr_diff
decl_stmt|;
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
name|IEEE80211_IS_CHAN_HT80
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* Vendor driver uses HT40 values here. */
name|pwr_diff
operator|=
name|rs
operator|->
name|bw40_tx_pwr_diff_2g
index|[
name|chain
index|]
index|[
name|i
index|]
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|c
argument_list|)
condition|)
name|pwr_diff
operator|=
name|rs
operator|->
name|bw40_tx_pwr_diff_2g
index|[
name|chain
index|]
index|[
name|i
index|]
expr_stmt|;
else|else
name|pwr_diff
operator|=
name|rs
operator|->
name|bw20_tx_pwr_diff_2g
index|[
name|chain
index|]
index|[
name|i
index|]
expr_stmt|;
name|min_mcs
operator|=
name|RTWN_RIDX_HT_MCS
argument_list|(
name|i
operator|*
literal|8
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|min_mcs
init|;
name|ridx
operator|<=
name|max_mcs
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|+=
name|pwr_diff
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 5GHz */
for|for
control|(
name|ridx
operator|=
name|RTWN_RIDX_OFDM6
init|;
name|ridx
operator|<=
name|max_mcs
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|=
name|rs
operator|->
name|ht40_tx_pwr_5g
index|[
name|chain
index|]
index|[
name|group
index|]
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|RTWN_RIDX_OFDM6
init|;
name|ridx
operator|<=
name|RTWN_RIDX_OFDM54
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|+=
name|rs
operator|->
name|ofdm_tx_pwr_diff_5g
index|[
name|chain
index|]
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ntxchains
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
name|min_mcs
decl_stmt|;
name|uint8_t
name|pwr_diff
decl_stmt|;
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
name|IEEE80211_IS_CHAN_HT80
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* TODO: calculate base value. */
name|pwr_diff
operator|=
name|rs
operator|->
name|bw80_tx_pwr_diff_5g
index|[
name|chain
index|]
index|[
name|i
index|]
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|c
argument_list|)
condition|)
name|pwr_diff
operator|=
name|rs
operator|->
name|bw40_tx_pwr_diff_5g
index|[
name|chain
index|]
index|[
name|i
index|]
expr_stmt|;
else|else
name|pwr_diff
operator|=
name|rs
operator|->
name|bw20_tx_pwr_diff_5g
index|[
name|chain
index|]
index|[
name|i
index|]
expr_stmt|;
name|min_mcs
operator|=
name|RTWN_RIDX_HT_MCS
argument_list|(
name|i
operator|*
literal|8
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|min_mcs
init|;
name|ridx
operator|<=
name|max_mcs
condition|;
name|ridx
operator|++
control|)
name|power
index|[
name|ridx
index|]
operator|+=
name|pwr_diff
expr_stmt|;
block|}
block|}
comment|/* Apply max limit. */
for|for
control|(
name|ridx
operator|=
name|RTWN_RIDX_CCK1
init|;
name|ridx
operator|<=
name|max_mcs
condition|;
name|ridx
operator|++
control|)
block|{
if|if
condition|(
name|power
index|[
name|ridx
index|]
operator|>
name|R92C_MAX_TX_PWR
condition|)
name|power
index|[
name|ridx
index|]
operator|=
name|R92C_MAX_TX_PWR
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|RTWN_DEBUG
if|if
condition|(
name|sc
operator|->
name|sc_debug
operator|&
name|RTWN_DEBUG_TXPWR
condition|)
block|{
comment|/* Dump per-rate Tx power values. */
name|printf
argument_list|(
literal|"Tx power for chain %d:\n"
argument_list|,
name|chain
argument_list|)
expr_stmt|;
for|for
control|(
name|ridx
operator|=
name|RTWN_RIDX_CCK1
init|;
name|ridx
operator|<=
name|max_mcs
condition|;
name|ridx
operator|++
control|)
name|printf
argument_list|(
literal|"Rate %d = %u\n"
argument_list|,
name|ridx
argument_list|,
name|power
index|[
name|ridx
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|r12a_set_txpower
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|uint8_t
name|power
index|[
name|RTWN_RIDX_COUNT
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|ntxchains
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
name|power
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|power
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Compute per-rate Tx power values. */
name|r12a_get_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|c
argument_list|,
name|power
argument_list|)
expr_stmt|;
comment|/* Write per-rate Tx power values to hardware. */
name|r12a_write_txpower
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|c
argument_list|,
name|power
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r12a_fix_spur
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|r12a_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|uint16_t
name|chan
init|=
name|rtwn_chan2centieee
argument_list|(
name|c
argument_list|)
decl_stmt|;
if|if
condition|(
name|rs
operator|->
name|chip
operator|&
name|R12A_CHIP_C_CUT
condition|)
block|{
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|c
argument_list|)
operator|&&
name|chan
operator|==
literal|11
condition|)
block|{
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0
argument_list|,
literal|0xc00
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_ADC_BUF_CLK
argument_list|,
literal|0
argument_list|,
literal|0x40000000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0x400
argument_list|,
literal|0x800
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|c
argument_list|)
operator|&&
comment|/* 20 MHz */
operator|(
name|chan
operator|==
literal|13
operator|||
name|chan
operator|==
literal|14
operator|)
condition|)
block|{
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0
argument_list|,
literal|0x300
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_ADC_BUF_CLK
argument_list|,
literal|0
argument_list|,
literal|0x40000000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* !80 Mhz */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0x100
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_ADC_BUF_CLK
argument_list|,
literal|0x40000000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* Set ADC clock to 160M to resolve 2480 MHz spur. */
if|if
condition|(
operator|!
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|c
argument_list|)
operator|&&
comment|/* 20 MHz */
operator|(
name|chan
operator|==
literal|13
operator|||
name|chan
operator|==
literal|14
operator|)
condition|)
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0
argument_list|,
literal|0x300
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|)
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0x100
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|r12a_set_band
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|r12a_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|uint32_t
name|basicrates
decl_stmt|;
name|uint8_t
name|swing
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Check if band was changed. */
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_flags
operator|&
operator|(
name|RTWN_STARTED
operator||
name|RTWN_RUNNING
operator|)
operator|)
operator|!=
name|RTWN_STARTED
operator|&&
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
operator|^
operator|!
operator|(
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
name|R12A_CCK_CHECK
argument_list|)
operator|&
name|R12A_CCK_CHECK_5GHZ
operator|)
condition|)
return|return;
name|rtwn_get_rates
argument_list|(
name|sc
argument_list|,
name|ieee80211_get_suprates
argument_list|(
name|ic
argument_list|,
name|c
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|basicrates
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|rtwn_r12a_set_band_2ghz
argument_list|(
name|sc
argument_list|,
name|basicrates
argument_list|)
expr_stmt|;
name|swing
operator|=
name|rs
operator|->
name|tx_bbswing_2g
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_5GHZ
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|rtwn_r12a_set_band_5ghz
argument_list|(
name|sc
argument_list|,
name|basicrates
argument_list|)
expr_stmt|;
name|swing
operator|=
name|rs
operator|->
name|tx_bbswing_5g
expr_stmt|;
block|}
else|else
block|{
name|KASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"wrong channel flags %08X\n"
operator|,
name|c
operator|->
name|ic_flags
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* XXX PATH_B is set by vendor driver. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|uint16_t
name|val
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
operator|(
name|swing
operator|>>
name|i
operator|*
literal|2
operator|)
operator|&
literal|0x3
condition|)
block|{
case|case
literal|0
case|:
name|val
operator|=
literal|0x200
expr_stmt|;
comment|/* 0 dB	*/
break|break;
case|case
literal|1
case|:
name|val
operator|=
literal|0x16a
expr_stmt|;
comment|/* -3 dB */
break|break;
case|case
literal|2
case|:
name|val
operator|=
literal|0x101
expr_stmt|;
comment|/* -6 dB */
break|break;
case|case
literal|3
case|:
name|val
operator|=
literal|0xb6
expr_stmt|;
comment|/* -9 dB */
break|break;
block|}
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_TX_SCALE
argument_list|(
name|i
argument_list|)
argument_list|,
name|R12A_TX_SCALE_SWING_M
argument_list|,
name|val
operator|<<
name|R12A_TX_SCALE_SWING_S
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|r12a_set_chan
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|uint16_t
name|chan
decl_stmt|;
name|int
name|i
decl_stmt|;
name|r12a_set_band
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|chan
operator|=
name|rtwn_chan2centieee
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
literal|36
operator|<=
name|chan
operator|&&
name|chan
operator|<=
literal|48
condition|)
name|val
operator|=
literal|0x09280000
expr_stmt|;
elseif|else
if|if
condition|(
literal|50
operator|<=
name|chan
operator|&&
name|chan
operator|<=
literal|64
condition|)
name|val
operator|=
literal|0x08a60000
expr_stmt|;
elseif|else
if|if
condition|(
literal|100
operator|<=
name|chan
operator|&&
name|chan
operator|<=
literal|116
condition|)
name|val
operator|=
literal|0x08a40000
expr_stmt|;
elseif|else
if|if
condition|(
literal|118
operator|<=
name|chan
condition|)
name|val
operator|=
literal|0x08240000
expr_stmt|;
else|else
name|val
operator|=
literal|0x12d40000
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_FC_AREA
argument_list|,
literal|0x1ffe0000
argument_list|,
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|36
operator|<=
name|chan
operator|&&
name|chan
operator|<=
literal|64
condition|)
name|val
operator|=
literal|0x10100
expr_stmt|;
elseif|else
if|if
condition|(
literal|100
operator|<=
name|chan
operator|&&
name|chan
operator|<=
literal|140
condition|)
name|val
operator|=
literal|0x30100
expr_stmt|;
elseif|else
if|if
condition|(
literal|140
operator|<
name|chan
condition|)
name|val
operator|=
literal|0x50100
expr_stmt|;
else|else
name|val
operator|=
literal|0x00000
expr_stmt|;
name|rtwn_rf_setbits
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
literal|0x70300
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* RTL8812AU-specific */
name|rtwn_r12a_fix_spur
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|chan
operator|<=
literal|0xff
argument_list|,
operator|(
literal|"%s: chan %d\n"
operator|,
name|__func__
operator|,
name|chan
operator|)
argument_list|)
expr_stmt|;
name|rtwn_rf_setbits
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
literal|0xff
argument_list|,
name|chan
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
name|IEEE80211_IS_CHAN_HT80
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* 80 MHz */
name|rtwn_setbits_2
argument_list|(
name|sc
argument_list|,
name|R92C_WMAC_TRXPTCL_CTL
argument_list|,
literal|0x80
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
comment|/* TODO */
name|val
operator|=
literal|0x0
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|c
argument_list|)
condition|)
block|{
comment|/* 40 MHz */
name|uint8_t
name|ext_chan
decl_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40U
argument_list|(
name|c
argument_list|)
condition|)
name|ext_chan
operator|=
name|R12A_DATA_SEC_PRIM_DOWN_20
expr_stmt|;
else|else
name|ext_chan
operator|=
name|R12A_DATA_SEC_PRIM_UP_20
expr_stmt|;
name|rtwn_setbits_2
argument_list|(
name|sc
argument_list|,
name|R92C_WMAC_TRXPTCL_CTL
argument_list|,
literal|0x100
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R12A_DATA_SEC
argument_list|,
name|ext_chan
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0x003003c3
argument_list|,
literal|0x00300201
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_ADC_BUF_CLK
argument_list|,
literal|0x40000000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* discard high 4 bits */
name|val
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|)
expr_stmt|;
name|val
operator|=
name|RW
argument_list|(
name|val
argument_list|,
name|R12A_RFMOD_EXT_CHAN
argument_list|,
name|ext_chan
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R12A_CCA_ON_SEC
argument_list|)
expr_stmt|;
name|val
operator|=
name|RW
argument_list|(
name|val
argument_list|,
name|R12A_CCA_ON_SEC_EXT_CHAN
argument_list|,
name|ext_chan
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_CCA_ON_SEC
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtwn_read_1
argument_list|(
name|sc
argument_list|,
literal|0x837
argument_list|)
operator|&
literal|0x04
condition|)
name|val
operator|=
literal|0x01800000
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
operator|&&
name|sc
operator|->
name|ntxchains
operator|==
literal|2
condition|)
name|val
operator|=
literal|0x01c00000
expr_stmt|;
else|else
name|val
operator|=
literal|0x02000000
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_L1_PEAK_TH
argument_list|,
literal|0x03c00000
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40U
argument_list|(
name|c
argument_list|)
condition|)
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|,
literal|0x10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_SYSTEM
argument_list|,
literal|0
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0x400
expr_stmt|;
block|}
else|else
block|{
comment|/* 20 MHz */
name|rtwn_setbits_2
argument_list|(
name|sc
argument_list|,
name|R92C_WMAC_TRXPTCL_CTL
argument_list|,
literal|0x180
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R12A_DATA_SEC
argument_list|,
name|R12A_DATA_SEC_NO_EXT
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFMOD
argument_list|,
literal|0x003003c3
argument_list|,
literal|0x00300200
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_ADC_BUF_CLK
argument_list|,
literal|0x40000000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nrxchains
operator|==
literal|2
operator|&&
name|sc
operator|->
name|ntxchains
operator|==
literal|2
condition|)
name|val
operator|=
literal|0x01c00000
expr_stmt|;
else|else
name|val
operator|=
literal|0x02000000
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_L1_PEAK_TH
argument_list|,
literal|0x03c00000
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0xc00
expr_stmt|;
block|}
comment|/* RTL8812AU-specific */
name|rtwn_r12a_fix_spur
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
name|rtwn_rf_setbits
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_CHNLBW
argument_list|,
literal|0xc00
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Set Tx power for this new channel. */
name|r12a_set_txpower
argument_list|(
name|sc
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r12a_set_band_2ghz
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|basicrates
parameter_list|)
block|{
name|struct
name|r12a_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
comment|/* Enable CCK / OFDM. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_OFDMCCK_EN
argument_list|,
literal|0
argument_list|,
name|R12A_OFDMCCK_EN_CCK
operator||
name|R12A_OFDMCCK_EN_OFDM
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_BW_INDICATION
argument_list|,
literal|0x02
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_PWED_TH
argument_list|,
literal|0x3e000
argument_list|,
literal|0x2e000
argument_list|)
expr_stmt|;
comment|/* Select AGC table. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_TABLE_SELECT
argument_list|,
literal|0x03
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rs
operator|->
name|rfe_type
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
case|case
literal|2
case|:
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x77777777
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x77777777
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x54337770
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x54337770
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_ANTSEL_SW
argument_list|,
literal|0x0303
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x77777777
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x77777777
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x00100000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x00100000
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
operator|+
literal|2
argument_list|,
literal|0x77
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x77777777
argument_list|)
expr_stmt|;
name|rtwn_setbits_1
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
operator|+
literal|3
argument_list|,
literal|0x01
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_TX_PATH
argument_list|,
literal|0xf0
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_CCK_RX_PATH
argument_list|,
literal|0x0f000000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
comment|/* Write basic rates. */
name|rtwn_set_basicrates
argument_list|(
name|sc
argument_list|,
name|basicrates
argument_list|)
expr_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R12A_CCK_CHECK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r12a_set_band_5ghz
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|basicrates
parameter_list|)
block|{
name|struct
name|r12a_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R12A_CCK_CHECK
argument_list|,
name|R12A_CCK_CHECK_5GHZ
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|100
condition|;
name|ntries
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R12A_TXPKT_EMPTY
argument_list|)
operator|&
literal|0x30
operator|)
operator|==
literal|0x30
condition|)
break|break;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|25
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntries
operator|==
literal|100
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"%s: TXPKT_EMPTY check failed (%04X)\n"
argument_list|,
name|__func__
argument_list|,
name|rtwn_read_2
argument_list|(
name|sc
argument_list|,
name|R12A_TXPKT_EMPTY
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Enable OFDM. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_OFDMCCK_EN
argument_list|,
name|R12A_OFDMCCK_EN_CCK
argument_list|,
name|R12A_OFDMCCK_EN_OFDM
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_BW_INDICATION
argument_list|,
literal|0x01
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_PWED_TH
argument_list|,
literal|0x3e000
argument_list|,
literal|0x2a000
argument_list|)
expr_stmt|;
comment|/* Select AGC table. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_TXAGC_TABLE_SELECT
argument_list|,
literal|0x03
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rs
operator|->
name|rfe_type
condition|)
block|{
case|case
literal|0
case|:
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x77337717
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x77337717
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x77337717
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x77337717
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|4
case|:
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x77337777
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x77337777
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x54337717
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x54337717
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_ANTSEL_SW
argument_list|,
literal|0x0303
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|0
argument_list|)
operator|+
literal|2
argument_list|,
literal|0x33
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_PINMUX
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x77337777
argument_list|)
expr_stmt|;
name|rtwn_setbits_1
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|0
argument_list|)
operator|+
literal|3
argument_list|,
literal|0
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_RFE_INV
argument_list|(
literal|1
argument_list|)
argument_list|,
literal|0x3ff00000
argument_list|,
literal|0x01000000
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_TX_PATH
argument_list|,
literal|0xf0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R12A_CCK_RX_PATH
argument_list|,
literal|0
argument_list|,
literal|0x0f000000
argument_list|)
expr_stmt|;
comment|/* Write basic rates. */
name|rtwn_set_basicrates
argument_list|(
name|sc
argument_list|,
name|basicrates
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_urtwn.c,v 1.16 2011/02/10 17:26:40 jakemsr Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2010 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2014 Kevin Lo<kevlo@FreeBSD.org>  * Copyright (c) 2015-2016 Andriy Voskoboinyk<avos@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwnvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwn_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8192c/r92c.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8192c/r92c_priv.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8192c/r92c_reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8192c/r92c_var.h>
end_include

begin_function
name|int
name|r92c_check_condition
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
name|cond
index|[]
parameter_list|)
block|{
name|struct
name|r92c_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|uint8_t
name|mask
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|cond
index|[
literal|0
index|]
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RESET
argument_list|,
literal|"%s: condition byte 0: %02X; chip %02X, board %02X\n"
argument_list|,
name|__func__
argument_list|,
name|cond
index|[
literal|0
index|]
argument_list|,
name|rs
operator|->
name|chip
argument_list|,
name|rs
operator|->
name|board_type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|chip
operator|&
name|R92C_CHIP_92C
operator|)
condition|)
block|{
if|if
condition|(
name|rs
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_HIGHPA
condition|)
name|mask
operator|=
name|R92C_COND_RTL8188RU
expr_stmt|;
elseif|else
if|if
condition|(
name|rs
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|mask
operator|=
name|R92C_COND_RTL8188CE
expr_stmt|;
else|else
name|mask
operator|=
name|R92C_COND_RTL8188CU
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rs
operator|->
name|board_type
operator|==
name|R92C_BOARD_TYPE_MINICARD
condition|)
name|mask
operator|=
name|R92C_COND_RTL8192CE
expr_stmt|;
else|else
name|mask
operator|=
name|R92C_COND_RTL8192CU
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTWN_MAX_CONDITIONS
operator|&&
name|cond
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|cond
index|[
name|i
index|]
operator|&
name|mask
operator|)
operator|==
name|mask
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|r92c_llt_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
comment|/* Reserve pages [0; page_count]. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|page_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|r92c_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* NB: 0xff indicates end-of-list. */
if|if
condition|(
operator|(
name|error
operator|=
name|r92c_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
literal|0xff
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Use pages [page_count + 1; pktbuf_count - 1] 	 * as ring buffer. 	 */
for|for
control|(
operator|++
name|i
init|;
name|i
operator|<
name|sc
operator|->
name|pktbuf_count
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|r92c_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Make the last page point to the beginning of the ring buffer. */
name|error
operator|=
name|r92c_llt_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|sc
operator|->
name|page_count
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|r92c_set_page_size
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
return|return
operator|(
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_PBP
argument_list|,
name|SM
argument_list|(
name|R92C_PBP_PSRX
argument_list|,
name|R92C_PBP_128
argument_list|)
operator||
name|SM
argument_list|(
name|R92C_PBP_PSTX
argument_list|,
name|R92C_PBP_128
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|r92c_init_bb_common
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|r92c_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Write BB initialization values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|bb_size
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|rtwn_bb_prog
modifier|*
name|bb_prog
init|=
operator|&
name|sc
operator|->
name|bb_prog
index|[
name|i
index|]
decl_stmt|;
while|while
condition|(
operator|!
name|rtwn_check_condition
argument_list|(
name|sc
argument_list|,
name|bb_prog
operator|->
name|cond
argument_list|)
condition|)
block|{
name|KASSERT
argument_list|(
name|bb_prog
operator|->
name|next
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s: wrong condition value (i %d)\n"
operator|,
name|__func__
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|bb_prog
operator|=
name|bb_prog
operator|->
name|next
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|bb_prog
operator|->
name|count
condition|;
name|j
operator|++
control|)
block|{
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RESET
argument_list|,
literal|"BB: reg 0x%03x, val 0x%08x\n"
argument_list|,
name|bb_prog
operator|->
name|reg
index|[
name|j
index|]
argument_list|,
name|bb_prog
operator|->
name|val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|bb_prog
operator|->
name|reg
index|[
name|j
index|]
argument_list|,
name|bb_prog
operator|->
name|val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rs
operator|->
name|chip
operator|&
name|R92C_CHIP_92C_1T2R
condition|)
block|{
comment|/* 8192C 1T only configuration. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_TXINFO
argument_list|,
literal|0x03
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA1_TXINFO
argument_list|,
literal|0x300033
argument_list|,
literal|0x200022
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_CCK0_AFESETTING
argument_list|,
literal|0xff000000
argument_list|,
literal|0x45000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_TRXPATHENA
argument_list|,
literal|0xff
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCPARAM1
argument_list|,
literal|0x30
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
literal|0xe74
argument_list|,
literal|0x0c000000
argument_list|,
literal|0x08000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
literal|0xe78
argument_list|,
literal|0x0c000000
argument_list|,
literal|0x08000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
literal|0xe7c
argument_list|,
literal|0x0c000000
argument_list|,
literal|0x08000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
literal|0xe80
argument_list|,
literal|0x0c000000
argument_list|,
literal|0x08000000
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
literal|0xe88
argument_list|,
literal|0x0c000000
argument_list|,
literal|0x08000000
argument_list|)
expr_stmt|;
block|}
comment|/* Write AGC values. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|agc_size
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|rtwn_agc_prog
modifier|*
name|agc_prog
init|=
operator|&
name|sc
operator|->
name|agc_prog
index|[
name|i
index|]
decl_stmt|;
while|while
condition|(
operator|!
name|rtwn_check_condition
argument_list|(
name|sc
argument_list|,
name|agc_prog
operator|->
name|cond
argument_list|)
condition|)
block|{
name|KASSERT
argument_list|(
name|agc_prog
operator|->
name|next
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s: wrong condition value (2) (i %d)\n"
operator|,
name|__func__
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|agc_prog
operator|=
name|agc_prog
operator|->
name|next
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|agc_prog
operator|->
name|count
condition|;
name|j
operator|++
control|)
block|{
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RESET
argument_list|,
literal|"AGC: val 0x%08x\n"
argument_list|,
name|agc_prog
operator|->
name|val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|rtwn_bb_write
argument_list|(
name|sc
argument_list|,
name|R92C_OFDM0_AGCRSSITABLE
argument_list|,
name|agc_prog
operator|->
name|val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
literal|0
argument_list|)
argument_list|)
operator|&
name|R92C_HSSI_PARAM2_CCK_HIPWR
condition|)
name|sc
operator|->
name|sc_flags
operator||=
name|RTWN_FLAG_CCK_HIPWR
expr_stmt|;
block|}
end_function

begin_function
name|int
name|r92c_init_rf_chain
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|rtwn_rf_prog
modifier|*
name|rf_prog
parameter_list|,
name|int
name|chain
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RESET
argument_list|,
literal|"%s: chain %d\n"
argument_list|,
name|__func__
argument_list|,
name|chain
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rf_prog
index|[
name|i
index|]
operator|.
name|reg
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|rtwn_rf_prog
modifier|*
name|prog
init|=
operator|&
name|rf_prog
index|[
name|i
index|]
decl_stmt|;
while|while
condition|(
operator|!
name|rtwn_check_condition
argument_list|(
name|sc
argument_list|,
name|prog
operator|->
name|cond
argument_list|)
condition|)
block|{
name|KASSERT
argument_list|(
name|prog
operator|->
name|next
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s: wrong condition value (i %d)\n"
operator|,
name|__func__
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
name|prog
operator|=
name|prog
operator|->
name|next
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|prog
operator|->
name|count
condition|;
name|j
operator|++
control|)
block|{
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RESET
argument_list|,
literal|"RF: reg 0x%02x, val 0x%05x\n"
argument_list|,
name|prog
operator|->
name|reg
index|[
name|j
index|]
argument_list|,
name|prog
operator|->
name|val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
comment|/* 			 * These are fake RF registers offsets that 			 * indicate a delay is required. 			 */
comment|/* NB: we are using 'value' to store required delay. */
if|if
condition|(
name|prog
operator|->
name|reg
index|[
name|j
index|]
operator|>
literal|0xf8
condition|)
block|{
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
name|prog
operator|->
name|val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
name|chain
argument_list|,
name|prog
operator|->
name|reg
index|[
name|j
index|]
argument_list|,
name|prog
operator|->
name|val
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|void
name|r92c_init_rf
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|r92c_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|type
decl_stmt|;
name|int
name|i
decl_stmt|,
name|chain
decl_stmt|,
name|idx
decl_stmt|,
name|off
decl_stmt|;
for|for
control|(
name|chain
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|chain
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|chain
operator|++
operator|,
name|i
operator|++
control|)
block|{
comment|/* Save RF_ENV control type. */
name|idx
operator|=
name|chain
operator|/
literal|2
expr_stmt|;
name|off
operator|=
operator|(
name|chain
operator|%
literal|2
operator|)
operator|*
literal|16
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
operator|(
name|reg
operator|>>
name|off
operator|)
operator|&
literal|0x10
expr_stmt|;
comment|/* Set RF_ENV enable. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|chain
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0x100000
argument_list|)
expr_stmt|;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Set RF_ENV output high. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
name|chain
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Set address and data lengths of RF registers. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|,
name|R92C_HSSI_PARAM2_ADDR_LENGTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_HSSI_PARAM2
argument_list|(
name|chain
argument_list|)
argument_list|,
name|R92C_HSSI_PARAM2_DATA_LENGTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtwn_delay
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Write RF initialization values for this chain. */
name|i
operator|+=
name|r92c_init_rf_chain
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rf_prog
index|[
name|i
index|]
argument_list|,
name|chain
argument_list|)
expr_stmt|;
comment|/* Restore RF_ENV control type. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACESW
argument_list|(
name|idx
argument_list|)
argument_list|,
literal|0x10
operator|<<
name|off
argument_list|,
name|type
operator|<<
name|off
argument_list|)
expr_stmt|;
comment|/* Cache RF register CHNLBW. */
name|rs
operator|->
name|rf_chnlbw
index|[
name|chain
index|]
operator|=
name|rtwn_rf_read
argument_list|(
name|sc
argument_list|,
name|chain
argument_list|,
name|R92C_RF_CHNLBW
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rs
operator|->
name|chip
operator|&
operator|(
name|R92C_CHIP_UMC_A_CUT
operator||
name|R92C_CHIP_92C
operator|)
operator|)
operator|==
name|R92C_CHIP_UMC_A_CUT
condition|)
block|{
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G1
argument_list|,
literal|0x30255
argument_list|)
expr_stmt|;
name|rtwn_rf_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|R92C_RF_RX_G2
argument_list|,
literal|0x50a00
argument_list|)
expr_stmt|;
block|}
comment|/* Turn CCK and OFDM blocks on. */
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
literal|0
argument_list|,
name|R92C_RFMOD_CCK_EN
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFMOD
argument_list|,
literal|0
argument_list|,
name|R92C_RFMOD_OFDM_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r92c_init_edca
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* SIFS */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SPEC_SIFS
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_MAC_SPEC_SIFS
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_CCK
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_SIFS_OFDM
argument_list|,
literal|0x100a
argument_list|)
expr_stmt|;
comment|/* TXOP */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BE_PARAM
argument_list|,
literal|0x005ea42b
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_BK_PARAM
argument_list|,
literal|0x0000a44f
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VI_PARAM
argument_list|,
literal|0x005ea324
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_EDCA_VO_PARAM
argument_list|,
literal|0x002fa226
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r92c_init_ampdu
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* Setup AMPDU aggregation. */
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_AGGLEN_LMT
argument_list|,
literal|0x99997631
argument_list|)
expr_stmt|;
comment|/* MCS7~0 */
name|rtwn_write_1
argument_list|(
name|sc
argument_list|,
name|R92C_AGGR_BREAK_TIME
argument_list|,
literal|0x16
argument_list|)
expr_stmt|;
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_MAX_AGGR_NUM
argument_list|,
literal|0x0708
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|r92c_init_antsel
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|ntxchains
operator|!=
literal|1
operator|||
name|sc
operator|->
name|nrxchains
operator|!=
literal|1
condition|)
return|return;
name|rtwn_setbits_1
argument_list|(
name|sc
argument_list|,
name|R92C_LEDCFG2
argument_list|,
literal|0
argument_list|,
literal|0x80
argument_list|)
expr_stmt|;
name|rtwn_bb_setbits
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFPARAM
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0x2000
argument_list|)
expr_stmt|;
name|reg
operator|=
name|rtwn_bb_read
argument_list|(
name|sc
argument_list|,
name|R92C_FPGA0_RFIFACEOE
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_ant
operator|=
name|MS
argument_list|(
name|reg
argument_list|,
name|R92C_FPGA0_RFIFACEOE0_ANT
argument_list|)
expr_stmt|;
comment|/* XXX */
block|}
end_function

begin_function
name|void
name|r92c_pa_bias_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|r92c_softc
modifier|*
name|rs
init|=
name|sc
operator|->
name|sc_priv
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nrxchains
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rs
operator|->
name|pa_setting
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
continue|continue;
name|r92c_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x0f406
argument_list|)
expr_stmt|;
name|r92c_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x4f406
argument_list|)
expr_stmt|;
name|r92c_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0x8f406
argument_list|)
expr_stmt|;
name|r92c_rf_write
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|R92C_RF_IPA
argument_list|,
literal|0xcf406
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|rs
operator|->
name|pa_setting
operator|&
literal|0x10
operator|)
condition|)
name|rtwn_setbits_1
argument_list|(
name|sc
argument_list|,
literal|0x16
argument_list|,
literal|0xf0
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


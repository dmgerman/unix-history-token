begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_urtwn.c,v 1.16 2011/02/10 17:26:40 jakemsr Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2010 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2014 Kevin Lo<kevlo@FreeBSD.org>  * Copyright (c) 2015-2016 Andriy Voskoboinyk<avos@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_wlan.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_var.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwnreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwnvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwn_debug.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwn_ridx.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/if_rtwn_rx.h>
end_include

begin_include
include|#
directive|include
file|<dev/rtwn/rtl8192c/r92c_reg.h>
end_include

begin_function
name|void
name|rtwn_get_rates
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|ieee80211_rateset
modifier|*
name|rs
parameter_list|,
specifier|const
name|struct
name|ieee80211_htrateset
modifier|*
name|rs_ht
parameter_list|,
name|uint32_t
modifier|*
name|rates_p
parameter_list|,
name|int
modifier|*
name|maxrate_p
parameter_list|,
name|int
name|basic_rates
parameter_list|)
block|{
name|uint32_t
name|rates
decl_stmt|;
name|uint8_t
name|ridx
decl_stmt|;
name|int
name|i
decl_stmt|,
name|maxrate
decl_stmt|;
comment|/* Get rates mask. */
name|rates
operator|=
literal|0
expr_stmt|;
name|maxrate
operator|=
literal|0
expr_stmt|;
comment|/* This is for 11bg */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
comment|/* Convert 802.11 rate to HW rate index. */
name|ridx
operator|=
name|rate2ridx
argument_list|(
name|IEEE80211_RV
argument_list|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ridx
operator|==
name|RTWN_RIDX_UNKNOWN
condition|)
comment|/* Unknown rate, skip. */
continue|continue;
if|if
condition|(
operator|(
operator|(
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_BASIC
operator|)
operator|!=
literal|0
operator|)
operator|||
operator|!
name|basic_rates
condition|)
block|{
name|rates
operator||=
literal|1
operator|<<
name|ridx
expr_stmt|;
if|if
condition|(
name|ridx
operator|>
name|maxrate
condition|)
name|maxrate
operator|=
name|ridx
expr_stmt|;
block|}
block|}
comment|/* If we're doing 11n, enable 11n rates */
if|if
condition|(
name|rs_ht
operator|!=
name|NULL
operator|&&
operator|!
name|basic_rates
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs_ht
operator|->
name|rs_nrates
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rs_ht
operator|->
name|rs_rates
index|[
name|i
index|]
operator|&
literal|0x7f
operator|)
operator|>
literal|0xf
condition|)
continue|continue;
comment|/* 11n rates start at index 12 */
name|ridx
operator|=
name|RTWN_RIDX_MCS
argument_list|(
operator|(
name|rs_ht
operator|->
name|rs_rates
index|[
name|i
index|]
operator|)
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|rates
operator||=
operator|(
literal|1
operator|<<
name|ridx
operator|)
expr_stmt|;
comment|/* Guard against the rate table being oddly ordered */
if|if
condition|(
name|ridx
operator|>
name|maxrate
condition|)
name|maxrate
operator|=
name|ridx
expr_stmt|;
block|}
block|}
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RA
argument_list|,
literal|"%s: rates 0x%08X, maxrate %d\n"
argument_list|,
name|__func__
argument_list|,
name|rates
argument_list|,
name|maxrate
argument_list|)
expr_stmt|;
if|if
condition|(
name|rates_p
operator|!=
name|NULL
condition|)
operator|*
name|rates_p
operator|=
name|rates
expr_stmt|;
if|if
condition|(
name|maxrate_p
operator|!=
name|NULL
condition|)
operator|*
name|maxrate_p
operator|=
name|maxrate
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rtwn_set_basicrates
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|rates
parameter_list|)
block|{
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RA
argument_list|,
literal|"%s: rates 0x%08X\n"
argument_list|,
name|__func__
argument_list|,
name|rates
argument_list|)
expr_stmt|;
name|rtwn_setbits_4
argument_list|(
name|sc
argument_list|,
name|R92C_RRSR
argument_list|,
name|R92C_RRSR_RATE_BITMAP_M
argument_list|,
name|rates
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_update_avgrssi
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|rtwn_node
modifier|*
name|un
parameter_list|,
name|int8_t
name|rssi
parameter_list|,
name|int
name|is_cck
parameter_list|)
block|{
name|int
name|pwdb
decl_stmt|;
comment|/* Convert antenna signal to percentage. */
if|if
condition|(
name|rssi
operator|<=
operator|-
literal|100
operator|||
name|rssi
operator|>=
literal|20
condition|)
name|pwdb
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|rssi
operator|>=
literal|0
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
else|else
name|pwdb
operator|=
literal|100
operator|+
name|rssi
expr_stmt|;
if|if
condition|(
name|is_cck
condition|)
block|{
comment|/* CCK gain is smaller than OFDM/MCS gain. */
name|pwdb
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
name|pwdb
operator|>
literal|100
condition|)
name|pwdb
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|pwdb
operator|<=
literal|14
condition|)
name|pwdb
operator|-=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|26
condition|)
name|pwdb
operator|-=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|34
condition|)
name|pwdb
operator|-=
literal|6
expr_stmt|;
elseif|else
if|if
condition|(
name|pwdb
operator|<=
literal|42
condition|)
name|pwdb
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|un
operator|->
name|avg_pwdb
operator|==
operator|-
literal|1
condition|)
comment|/* Init. */
name|un
operator|->
name|avg_pwdb
operator|=
name|pwdb
expr_stmt|;
elseif|else
if|if
condition|(
name|un
operator|->
name|avg_pwdb
operator|<
name|pwdb
condition|)
name|un
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|un
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
operator|+
literal|1
expr_stmt|;
else|else
name|un
operator|->
name|avg_pwdb
operator|=
operator|(
operator|(
name|un
operator|->
name|avg_pwdb
operator|*
literal|19
operator|+
name|pwdb
operator|)
operator|/
literal|20
operator|)
expr_stmt|;
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RSSI
argument_list|,
literal|"MACID %d, PWDB %d, EMA %d\n"
argument_list|,
name|un
operator|->
name|id
argument_list|,
name|pwdb
argument_list|,
name|un
operator|->
name|avg_pwdb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int8_t
name|rtwn_get_rssi
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|physt
parameter_list|,
name|int
name|is_cck
parameter_list|)
block|{
name|int8_t
name|rssi
decl_stmt|;
if|if
condition|(
name|is_cck
condition|)
name|rssi
operator|=
name|rtwn_get_rssi_cck
argument_list|(
name|sc
argument_list|,
name|physt
argument_list|)
expr_stmt|;
else|else
comment|/* OFDM/HT. */
name|rssi
operator|=
name|rtwn_get_rssi_ofdm
argument_list|(
name|sc
argument_list|,
name|physt
argument_list|)
expr_stmt|;
return|return
operator|(
name|rssi
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|rtwn_get_tsf_low
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|id
parameter_list|)
block|{
return|return
operator|(
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_TSFTR
argument_list|(
name|id
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|rtwn_get_tsf_high
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|id
parameter_list|)
block|{
return|return
operator|(
name|rtwn_read_4
argument_list|(
name|sc
argument_list|,
name|R92C_TSFTR
argument_list|(
name|id
argument_list|)
operator|+
literal|4
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_get_tsf
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
modifier|*
name|buf
parameter_list|,
name|int
name|id
parameter_list|)
block|{
comment|/* NB: we cannot read it at once. */
operator|*
name|buf
operator|=
name|rtwn_get_tsf_high
argument_list|(
name|sc
argument_list|,
name|id
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|<<=
literal|32
expr_stmt|;
operator|*
name|buf
operator|+=
name|rtwn_get_tsf_low
argument_list|(
name|sc
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|rtwn_extend_rx_tsf
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|rtwn_rx_stat_common
modifier|*
name|stat
parameter_list|)
block|{
name|uint64_t
name|tsft
decl_stmt|;
name|uint32_t
name|rxdw3
decl_stmt|,
name|tsfl
decl_stmt|,
name|tsfl_curr
decl_stmt|;
name|int
name|id
decl_stmt|;
name|rxdw3
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw3
argument_list|)
expr_stmt|;
name|tsfl
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|tsf_low
argument_list|)
expr_stmt|;
name|id
operator|=
name|MS
argument_list|(
name|rxdw3
argument_list|,
name|RTWN_RXDW3_BSSID01_FIT
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|id
condition|)
block|{
case|case
literal|1
case|:
case|case
literal|2
case|:
name|id
operator|>>=
literal|1
expr_stmt|;
name|tsfl_curr
operator|=
name|rtwn_get_tsf_low
argument_list|(
name|sc
argument_list|,
name|id
argument_list|)
expr_stmt|;
break|break;
default|default:
block|{
name|uint32_t
name|tsfl0
decl_stmt|,
name|tsfl1
decl_stmt|;
name|tsfl0
operator|=
name|rtwn_get_tsf_low
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tsfl1
operator|=
name|rtwn_get_tsf_low
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|tsfl0
operator|-
name|tsfl
argument_list|)
operator|<
name|abs
argument_list|(
name|tsfl1
operator|-
name|tsfl
argument_list|)
condition|)
block|{
name|id
operator|=
literal|0
expr_stmt|;
name|tsfl_curr
operator|=
name|tsfl0
expr_stmt|;
block|}
else|else
block|{
name|id
operator|=
literal|1
expr_stmt|;
name|tsfl_curr
operator|=
name|tsfl1
expr_stmt|;
block|}
break|break;
block|}
block|}
name|tsft
operator|=
name|rtwn_get_tsf_high
argument_list|(
name|sc
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsfl
operator|>
name|tsfl_curr
operator|&&
name|tsfl
operator|>
literal|0xffff0000
condition|)
name|tsft
operator|--
expr_stmt|;
name|tsft
operator|<<=
literal|32
expr_stmt|;
name|tsft
operator|+=
name|tsfl
expr_stmt|;
return|return
operator|(
name|tsft
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|ieee80211_node
modifier|*
name|rtwn_rx_common
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|desc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|struct
name|ieee80211_node
modifier|*
name|ni
decl_stmt|;
name|struct
name|ieee80211_frame_min
modifier|*
name|wh
decl_stmt|;
name|struct
name|ieee80211_rx_stats
name|rxs
decl_stmt|;
name|struct
name|rtwn_node
modifier|*
name|un
decl_stmt|;
name|struct
name|rtwn_rx_stat_common
modifier|*
name|stat
decl_stmt|;
name|void
modifier|*
name|physt
decl_stmt|;
name|uint32_t
name|rxdw0
decl_stmt|;
name|int8_t
name|rssi
decl_stmt|;
name|int
name|cipher
decl_stmt|,
name|infosz
decl_stmt|,
name|is_cck
decl_stmt|,
name|pktlen
decl_stmt|,
name|shift
decl_stmt|;
name|stat
operator|=
name|desc
expr_stmt|;
name|rxdw0
operator|=
name|le32toh
argument_list|(
name|stat
operator|->
name|rxdw0
argument_list|)
expr_stmt|;
name|cipher
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|RTWN_RXDW0_CIPHER
argument_list|)
expr_stmt|;
name|infosz
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|RTWN_RXDW0_INFOSZ
argument_list|)
operator|*
literal|8
expr_stmt|;
name|pktlen
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|RTWN_RXDW0_PKTLEN
argument_list|)
expr_stmt|;
name|shift
operator|=
name|MS
argument_list|(
name|rxdw0
argument_list|,
name|RTWN_RXDW0_SHIFT
argument_list|)
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame_min
operator|*
operator|)
operator|(
name|mtodo
argument_list|(
name|m
argument_list|,
name|shift
operator|+
name|infosz
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
operator|)
operator|&&
name|cipher
operator|!=
name|R92C_CAM_ALGO_NONE
condition|)
name|m
operator|->
name|m_flags
operator||=
name|M_WEP
expr_stmt|;
if|if
condition|(
name|pktlen
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
condition|)
block|{
name|ni
operator|=
name|ieee80211_find_rxnode
argument_list|(
name|ic
argument_list|,
name|wh
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni
operator|!=
name|NULL
operator|&&
operator|(
name|ni
operator|->
name|ni_flags
operator|&
name|IEEE80211_NODE_HT
operator|)
condition|)
name|m
operator|->
name|m_flags
operator||=
name|M_AMPDU
expr_stmt|;
block|}
else|else
name|ni
operator|=
name|NULL
expr_stmt|;
name|un
operator|=
name|RTWN_NODE
argument_list|(
name|ni
argument_list|)
expr_stmt|;
if|if
condition|(
name|infosz
operator|!=
literal|0
operator|&&
operator|(
name|rxdw0
operator|&
name|RTWN_RXDW0_PHYST
operator|)
condition|)
name|physt
operator|=
operator|(
name|void
operator|*
operator|)
name|mtodo
argument_list|(
name|m
argument_list|,
name|shift
argument_list|)
expr_stmt|;
else|else
name|physt
operator|=
operator|(
name|un
operator|!=
name|NULL
operator|)
condition|?
operator|&
name|un
operator|->
name|last_physt
else|:
operator|&
name|sc
operator|->
name|last_physt
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|rxs
argument_list|,
sizeof|sizeof
argument_list|(
name|rxs
argument_list|)
argument_list|)
expr_stmt|;
name|rtwn_get_rx_stats
argument_list|(
name|sc
argument_list|,
operator|&
name|rxs
argument_list|,
name|desc
argument_list|,
name|physt
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxs
operator|.
name|c_pktflags
operator|&
name|IEEE80211_RX_F_AMPDU
condition|)
block|{
comment|/* Next MPDU will come without PHY info. */
name|memcpy
argument_list|(
operator|&
name|sc
operator|->
name|last_physt
argument_list|,
name|physt
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|last_physt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|un
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
operator|&
name|un
operator|->
name|last_physt
argument_list|,
name|physt
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|last_physt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Add some common bits. */
comment|/* NB: should not happen. */
if|if
condition|(
name|rxdw0
operator|&
name|RTWN_RXDW0_CRCERR
condition|)
name|rxs
operator|.
name|c_pktflags
operator||=
name|IEEE80211_RX_F_FAIL_FCSCRC
expr_stmt|;
name|rxs
operator|.
name|r_flags
operator||=
name|IEEE80211_R_TSF_START
expr_stmt|;
comment|/* XXX undocumented */
name|rxs
operator|.
name|r_flags
operator||=
name|IEEE80211_R_TSF64
expr_stmt|;
name|rxs
operator|.
name|c_rx_tsf
operator|=
name|rtwn_extend_rx_tsf
argument_list|(
name|sc
argument_list|,
name|stat
argument_list|)
expr_stmt|;
comment|/* Get RSSI from PHY status descriptor. */
name|is_cck
operator|=
operator|(
name|rxs
operator|.
name|c_pktflags
operator|&
name|IEEE80211_RX_F_CCK
operator|)
operator|!=
literal|0
expr_stmt|;
name|rssi
operator|=
name|rtwn_get_rssi
argument_list|(
name|sc
argument_list|,
name|physt
argument_list|,
name|is_cck
argument_list|)
expr_stmt|;
comment|/* XXX TODO: we really need a rate-to-string method */
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_RSSI
argument_list|,
literal|"%s: rssi %d, rate %d\n"
argument_list|,
name|__func__
argument_list|,
name|rssi
argument_list|,
name|rxs
operator|.
name|c_rate
argument_list|)
expr_stmt|;
if|if
condition|(
name|un
operator|!=
name|NULL
operator|&&
name|infosz
operator|!=
literal|0
operator|&&
operator|(
name|rxdw0
operator|&
name|RTWN_RXDW0_PHYST
operator|)
condition|)
block|{
comment|/* Update our average RSSI. */
name|rtwn_update_avgrssi
argument_list|(
name|sc
argument_list|,
name|un
argument_list|,
name|rssi
argument_list|,
name|is_cck
argument_list|)
expr_stmt|;
block|}
name|rxs
operator|.
name|r_flags
operator||=
name|IEEE80211_R_NF
operator||
name|IEEE80211_R_RSSI
expr_stmt|;
name|rxs
operator|.
name|c_nf
operator|=
name|RTWN_NOISE_FLOOR
expr_stmt|;
name|rxs
operator|.
name|c_rssi
operator|=
name|rssi
operator|-
name|rxs
operator|.
name|c_nf
expr_stmt|;
operator|(
name|void
operator|)
name|ieee80211_add_rx_params
argument_list|(
name|m
argument_list|,
operator|&
name|rxs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ieee80211_radiotap_active
argument_list|(
name|ic
argument_list|)
condition|)
block|{
name|struct
name|rtwn_rx_radiotap_header
modifier|*
name|tap
init|=
operator|&
name|sc
operator|->
name|sc_rxtap
decl_stmt|;
name|tap
operator|->
name|wr_flags
operator|=
name|rtwn_rx_radiotap_flags
argument_list|(
name|sc
argument_list|,
name|desc
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_tsft
operator|=
name|htole64
argument_list|(
name|rxs
operator|.
name|c_rx_tsf
argument_list|)
expr_stmt|;
name|tap
operator|->
name|wr_rate
operator|=
name|rxs
operator|.
name|c_rate
expr_stmt|;
name|tap
operator|->
name|wr_dbm_antsignal
operator|=
name|rssi
expr_stmt|;
name|tap
operator|->
name|wr_dbm_antnoise
operator|=
name|rxs
operator|.
name|c_nf
expr_stmt|;
block|}
comment|/* Drop PHY descriptor. */
name|m_adj
argument_list|(
name|m
argument_list|,
name|infosz
operator|+
name|shift
argument_list|)
expr_stmt|;
return|return
operator|(
name|ni
operator|)
return|;
block|}
end_function

begin_function
name|void
name|rtwn_adhoc_recv_mgmt
parameter_list|(
name|struct
name|ieee80211_node
modifier|*
name|ni
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|subtype
parameter_list|,
specifier|const
name|struct
name|ieee80211_rx_stats
modifier|*
name|rxs
parameter_list|,
name|int
name|rssi
parameter_list|,
name|int
name|nf
parameter_list|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
init|=
name|ni
operator|->
name|ni_vap
decl_stmt|;
name|struct
name|rtwn_softc
modifier|*
name|sc
init|=
name|vap
operator|->
name|iv_ic
operator|->
name|ic_softc
decl_stmt|;
name|struct
name|rtwn_vap
modifier|*
name|uvp
init|=
name|RTWN_VAP
argument_list|(
name|vap
argument_list|)
decl_stmt|;
name|uint64_t
name|ni_tstamp
decl_stmt|,
name|curr_tstamp
decl_stmt|;
name|uvp
operator|->
name|recv_mgmt
argument_list|(
name|ni
argument_list|,
name|m
argument_list|,
name|subtype
argument_list|,
name|rxs
argument_list|,
name|rssi
argument_list|,
name|nf
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|iv_state
operator|==
name|IEEE80211_S_RUN
operator|&&
operator|(
name|subtype
operator|==
name|IEEE80211_FC0_SUBTYPE_BEACON
operator|||
name|subtype
operator|==
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
operator|)
condition|)
block|{
name|ni_tstamp
operator|=
name|le64toh
argument_list|(
name|ni
operator|->
name|ni_tstamp
operator|.
name|tsf
argument_list|)
expr_stmt|;
name|RTWN_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rtwn_get_tsf
argument_list|(
name|sc
argument_list|,
operator|&
name|curr_tstamp
argument_list|,
name|uvp
operator|->
name|id
argument_list|)
expr_stmt|;
name|RTWN_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ni_tstamp
operator|>=
name|curr_tstamp
condition|)
operator|(
name|void
operator|)
name|ieee80211_ibss_merge
argument_list|(
name|ni
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|rtwn_get_multi_pos
parameter_list|(
specifier|const
name|uint8_t
name|maddr
index|[]
parameter_list|)
block|{
name|uint64_t
name|mask
init|=
literal|0x00004d101df481b4
decl_stmt|;
name|uint8_t
name|pos
init|=
literal|0x27
decl_stmt|;
comment|/* initial value */
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IEEE80211_ADDR_LEN
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
if|if
condition|(
operator|(
name|maddr
index|[
name|i
index|]
operator|>>
name|j
operator|)
operator|&
literal|1
condition|)
name|pos
operator|^=
operator|(
name|mask
operator|>>
operator|(
name|i
operator|*
literal|8
operator|+
name|j
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|pos
operator|&=
literal|0x3f
expr_stmt|;
return|return
operator|(
name|pos
operator|)
return|;
block|}
end_function

begin_function
name|void
name|rtwn_set_multi
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|mfilt
index|[
literal|2
index|]
decl_stmt|;
name|RTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* general structure was copied from ath(4). */
if|if
condition|(
name|ic
operator|->
name|ic_allmulti
operator|==
literal|0
condition|)
block|{
name|struct
name|ieee80211vap
modifier|*
name|vap
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
comment|/* 		 * Merge multicast addresses to form the hardware filter. 		 */
name|mfilt
index|[
literal|0
index|]
operator|=
name|mfilt
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|vap
argument_list|,
argument|&ic->ic_vaps
argument_list|,
argument|iv_next
argument_list|)
block|{
name|ifp
operator|=
name|vap
operator|->
name|iv_ifp
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
name|caddr_t
name|dl
decl_stmt|;
name|uint8_t
name|pos
decl_stmt|;
name|dl
operator|=
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
expr_stmt|;
name|pos
operator|=
name|rtwn_get_multi_pos
argument_list|(
name|dl
argument_list|)
expr_stmt|;
name|mfilt
index|[
name|pos
operator|/
literal|32
index|]
operator||=
operator|(
literal|1
operator|<<
operator|(
name|pos
operator|%
literal|32
operator|)
operator|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|mfilt
index|[
literal|0
index|]
operator|=
name|mfilt
index|[
literal|1
index|]
operator|=
operator|~
literal|0
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|0
argument_list|,
name|mfilt
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_MAR
operator|+
literal|4
argument_list|,
name|mfilt
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RTWN_DPRINTF
argument_list|(
name|sc
argument_list|,
name|RTWN_DEBUG_STATE
argument_list|,
literal|"%s: MC filter %08x:%08x\n"
argument_list|,
name|__func__
argument_list|,
name|mfilt
index|[
literal|0
index|]
argument_list|,
name|mfilt
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|rtwn_rxfilter_update_mgt
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint16_t
name|filter
decl_stmt|;
name|filter
operator|=
literal|0x7f7f
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bcn_vaps
operator|==
literal|0
condition|)
block|{
comment|/* STA and/or MONITOR mode vaps */
name|filter
operator|&=
operator|~
operator|(
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_ASSOC_REQ
argument_list|)
operator||
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_REASSOC_REQ
argument_list|)
operator||
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_PROBE_REQ
argument_list|)
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|ap_vaps
operator|==
name|sc
operator|->
name|nvaps
operator|-
name|sc
operator|->
name|mon_vaps
condition|)
block|{
comment|/* AP vaps only */
name|filter
operator|&=
operator|~
operator|(
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
argument_list|)
operator||
name|R92C_RXFLTMAP_SUBTYPE
argument_list|(
name|IEEE80211_FC0_SUBTYPE_REASSOC_RESP
argument_list|)
operator|)
expr_stmt|;
block|}
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP0
argument_list|,
name|filter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rtwn_rxfilter_update
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Filter for management frames. */
name|rtwn_rxfilter_update_mgt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Update Rx filter. */
name|rtwn_set_promisc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rtwn_rxfilter_init
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|RTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Setup multicast filter. */
name|rtwn_set_multi
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Reject all control frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP1
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* Reject all data frames. */
name|rtwn_write_2
argument_list|(
name|sc
argument_list|,
name|R92C_RXFLTMAP2
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* Append generic Rx filter bits. */
name|sc
operator|->
name|rcr
operator||=
name|R92C_RCR_AM
operator||
name|R92C_RCR_AB
operator||
name|R92C_RCR_APM
operator||
name|R92C_RCR_HTC_LOC_CTRL
operator||
name|R92C_RCR_APP_PHYSTS
operator||
name|R92C_RCR_APP_ICV
operator||
name|R92C_RCR_APP_MIC
expr_stmt|;
comment|/* Update dynamic Rx filter parts. */
name|rtwn_rxfilter_update
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rtwn_rxfilter_set
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|sc_flags
operator|&
name|RTWN_RCR_LOCKED
operator|)
condition|)
name|rtwn_write_4
argument_list|(
name|sc
argument_list|,
name|R92C_RCR
argument_list|,
name|sc
operator|->
name|rcr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rtwn_set_rx_bssid_all
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
if|if
condition|(
name|enable
condition|)
name|sc
operator|->
name|rcr
operator|&=
operator|~
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
else|else
name|sc
operator|->
name|rcr
operator||=
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
name|rtwn_rxfilter_set
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|rtwn_set_promisc
parameter_list|(
name|struct
name|rtwn_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ieee80211com
modifier|*
name|ic
init|=
operator|&
name|sc
operator|->
name|sc_ic
decl_stmt|;
name|uint32_t
name|mask_all
decl_stmt|,
name|mask_min
decl_stmt|;
name|RTWN_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mask_all
operator|=
name|R92C_RCR_ACF
operator||
name|R92C_RCR_ADF
operator||
name|R92C_RCR_AMF
operator||
name|R92C_RCR_AAP
expr_stmt|;
name|mask_min
operator|=
name|R92C_RCR_APM
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bcn_vaps
operator|==
literal|0
condition|)
name|mask_min
operator||=
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ap_vaps
operator|==
literal|0
condition|)
name|mask_min
operator||=
name|R92C_RCR_CBSSID_DATA
expr_stmt|;
if|if
condition|(
name|ic
operator|->
name|ic_promisc
operator|==
literal|0
operator|&&
name|sc
operator|->
name|mon_vaps
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|bcn_vaps
operator|!=
literal|0
condition|)
name|mask_all
operator||=
name|R92C_RCR_CBSSID_BCN
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ap_vaps
operator|!=
literal|0
condition|)
comment|/* for Null data frames */
name|mask_all
operator||=
name|R92C_RCR_CBSSID_DATA
expr_stmt|;
name|sc
operator|->
name|rcr
operator|&=
operator|~
name|mask_all
expr_stmt|;
name|sc
operator|->
name|rcr
operator||=
name|mask_min
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|rcr
operator|&=
operator|~
name|mask_min
expr_stmt|;
name|sc
operator|->
name|rcr
operator||=
name|mask_all
expr_stmt|;
block|}
name|rtwn_rxfilter_set
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2004 M. Warner Losh.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Driver for ISA to PCMCIA bridges compliant with the Intel ExCA  * specification.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<isa/isavar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccardreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccardvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/exca/excareg.h>
end_include

begin_include
include|#
directive|include
file|<dev/exca/excavar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccbb/pccbbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccbb/pccbbvar.h>
end_include

begin_include
include|#
directive|include
file|"power_if.h"
end_include

begin_include
include|#
directive|include
file|"card_if.h"
end_include

begin_comment
comment|/*****************************************************************************  * Configurable parameters.  *****************************************************************************/
end_comment

begin_comment
comment|/* sysctl vars */
end_comment

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|pcic
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"PCIC parameters"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|isa_intr_mask
init|=
name|EXCA_INT_MASK_ALLOWED
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.cbb.intr_mask"
argument_list|,
operator|&
name|isa_intr_mask
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_pcic
argument_list|,
name|OID_AUTO
argument_list|,
name|intr_mask
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|isa_intr_mask
argument_list|,
literal|0
argument_list|,
literal|"Mask of allowable interrupts for this laptop.  The default is generally\n\ correct, but some laptops do not route all the IRQ pins to the bridge to\n\ save wires.  Sometimes you need a more restrictive mask because some of the\n\ hardware in your laptop may not have a driver so its IRQ might not be\n\ allocated."
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * CL-PD6722's VSENSE method  *     0: NO VSENSE (assume a 5.0V card always)  *     1: 6710's method (default)  *     2: 6729's method  */
end_comment

begin_decl_stmt
name|int
name|pcic_pd6722_vsense
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.pcic.pd6722_vsense"
argument_list|,
operator|&
name|pcic_pd6722_vsense
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_pcic
argument_list|,
name|OID_AUTO
argument_list|,
name|pd6722_vsense
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|pcic_pd6722_vsense
argument_list|,
literal|1
argument_list|,
literal|"Select CL-PD6722's VSENSE method.  VSENSE is used to determine the\n\ volatage of inserted cards.  The CL-PD6722 has two methods to determine the\n\ voltage of the card.  0 means assume a 5.0V card and do not check.  1 means\n\ use the same method that the CL-PD6710 uses (default).  2 means use the\n\ same method as the CL-PD6729.  2 is documented in the datasheet as being\n\ the correct way, but 1 seems to give better results on more laptops."
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*****************************************************************************  * End of configurable parameters.  *****************************************************************************/
end_comment

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
value|do { if (cbb_debug) printf x; } while (0)
end_define

begin_define
define|#
directive|define
name|DEVPRINTF
parameter_list|(
name|x
parameter_list|)
value|do { if (cbb_debug) device_printf x; } while (0)
end_define

begin_comment
comment|/* XXX Not sure that PNP0E03 should be claimed, except maybe on pc98 */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|isa_pnp_id
name|pcic_ids
index|[]
init|=
block|{
block|{
name|EXCA_PNP_ACTIONTEC
block|,
name|NULL
block|}
block|,
comment|/* AEI0218 */
block|{
name|EXCA_PNP_IBM3765
block|,
name|NULL
block|}
block|,
comment|/* IBM3765 */
block|{
name|EXCA_PNP_82365
block|,
name|NULL
block|}
block|,
comment|/* PNP0E00 */
block|{
name|EXCA_PNP_CL_PD6720
block|,
name|NULL
block|}
block|,
comment|/* PNP0E01 */
block|{
name|EXCA_PNP_VLSI_82C146
block|,
name|NULL
block|}
block|,
comment|/* PNP0E02 */
block|{
name|EXCA_PNP_82365_CARDBUS
block|,
name|NULL
block|}
block|,
comment|/* PNP0E03 */
block|{
name|EXCA_PNP_SCM_SWAPBOX
block|,
name|NULL
block|}
block|,
comment|/* SCM0469 */
block|{
name|EXCA_NEC_PC9801_102
block|,
name|NULL
block|}
block|,
comment|/* NEC8091 */
block|{
name|EXCA_NEC_PC9821RA_E01
block|,
name|NULL
block|}
block|,
comment|/* NEC8121 */
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/************************************************************************/
end_comment

begin_comment
comment|/* Probe/Attach								*/
end_comment

begin_comment
comment|/************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|cbb_isa_activate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|cbb_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* A little bogus, but go ahead and get the irq for CSC events */
name|rid
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * No IRQ specified, find one.  This can be due to the PnP 		 * data not specifying any IRQ, or the default kernel not 		 * assinging an IRQ. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
operator|&&
name|res
operator|==
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|isa_intr_mask
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|i
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|->
name|irq_res
operator|=
name|res
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|NULL
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot allocate I/O\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|sc
operator|->
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|base_res
operator|=
name|res
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cbb_isa_deactivate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|cbb_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|base_res
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|base_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|base_res
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cbb_isa_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|cbb_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* Check isapnp ids */
name|error
operator|=
name|ISA_PNP_PROBE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|pcic_ids
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|&&
name|error
operator|!=
name|ENOENT
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|cbb_isa_activate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Check to make sure that we have actual hardware */
name|error
operator|=
name|exca_probe_slots
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|exca
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|bst
argument_list|,
name|sc
operator|->
name|bsh
argument_list|)
expr_stmt|;
name|cbb_isa_deactivate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cbb_isa_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|cbb_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|cbb_isa_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|cbb_isa_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|cbb_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|cbb_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|cbb_resume
argument_list|)
block|,
comment|/* bus methods */
name|DEVMETHOD
argument_list|(
name|bus_read_ivar
argument_list|,
name|cbb_read_ivar
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_write_ivar
argument_list|,
name|cbb_write_ivar
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_alloc_resource
argument_list|,
name|cbb_alloc_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_release_resource
argument_list|,
name|cbb_release_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_activate_resource
argument_list|,
name|cbb_activate_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_deactivate_resource
argument_list|,
name|cbb_deactivate_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_driver_added
argument_list|,
name|cbb_driver_added
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_child_detached
argument_list|,
name|cbb_child_detached
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_setup_intr
argument_list|,
name|cbb_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_teardown_intr
argument_list|,
name|cbb_teardown_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_child_present
argument_list|,
name|cbb_child_present
argument_list|)
block|,
comment|/* 16-bit card interface */
name|DEVMETHOD
argument_list|(
name|card_set_res_flags
argument_list|,
name|cbb_pcic_set_res_flags
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|card_set_memory_offset
argument_list|,
name|cbb_pcic_set_memory_offset
argument_list|)
block|,
comment|/* power interface */
name|DEVMETHOD
argument_list|(
name|power_enable_socket
argument_list|,
name|cbb_power_enable_socket
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|power_disable_socket
argument_list|,
name|cbb_power_disable_socket
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|cbb_isa_driver
init|=
block|{
literal|"cbb"
block|,
name|cbb_methods
block|,
expr|sizeof
operator|(
expr|struct
name|cbb_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|cbb
argument_list|,
name|isa
argument_list|,
name|cbb_isa_driver
argument_list|,
name|cbb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|cbb
argument_list|,
name|exca
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


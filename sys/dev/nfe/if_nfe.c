begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: if_nfe.c,v 1.54 2006/04/07 12:38:12 jsg Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 2006 Shigeaki Tagashira<shigeaki@se.hiroshima-u.ac.jp>  * Copyright (c) 2006 Damien Bergamini<damien.bergamini@free.fr>  * Copyright (c) 2005, 2006 Jonathan Gray<jsg@openbsd.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* Driver for NVIDIA nForce MCP Fast Ethernet and Gigabit Ethernet */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Uncomment the following line to enable polling. */
end_comment

begin_comment
comment|/* #define	DEVICE_POLLING */
end_comment

begin_define
define|#
directive|define
name|NFE_JUMBO
end_define

begin_define
define|#
directive|define
name|NFE_CSUM
end_define

begin_define
define|#
directive|define
name|NVLAN
value|0
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_KERNEL_OPTION_HEADERS
end_ifdef

begin_include
include|#
directive|include
file|"opt_device_polling.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/nfe/if_nfereg.h>
end_include

begin_include
include|#
directive|include
file|<dev/nfe/if_nfevar.h>
end_include

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|nfe
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|nfe
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|nfe
argument_list|,
name|miibus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_function_decl
specifier|static
name|int
name|nfe_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_miibus_readreg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_miibus_writereg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_miibus_statchg
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_txdesc32_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_desc32
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_txdesc64_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_desc64
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_txdesc32_rsync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_txdesc64_rsync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_rxdesc32_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_desc32
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_rxdesc64_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_desc64
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_rxeof
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_txeof
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_encap
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_setmulti
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_init_locked
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_stop
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_alloc_rx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_rx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_reset_rx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_rx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_free_rx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_rx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_alloc_tx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_tx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_reset_tx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_tx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_free_tx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|struct
name|nfe_tx_ring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nfe_ifmedia_upd_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_tick
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_tick_locked
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_get_macaddr
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_set_macaddr
parameter_list|(
name|struct
name|nfe_softc
modifier|*
parameter_list|,
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nfe_dma_map_segs
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|DEVICE_POLLING
end_ifdef

begin_function_decl
specifier|static
name|void
name|nfe_poll_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|enum
name|poll_cmd
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|NFE_DEBUG
end_ifdef

begin_decl_stmt
name|int
name|nfedebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
value|do { if (nfedebug) printf x; } while (0)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|do { if (nfedebug>= (n)) printf x; } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|x
parameter_list|)
end_define

begin_define
define|#
directive|define
name|DPRINTFN
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|NFE_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_lock(&(_sc)->nfe_mtx)
end_define

begin_define
define|#
directive|define
name|NFE_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_unlock(&(_sc)->nfe_mtx)
end_define

begin_define
define|#
directive|define
name|NFE_LOCK_ASSERT
parameter_list|(
name|_sc
parameter_list|)
value|mtx_assert(&(_sc)->nfe_mtx, MA_OWNED)
end_define

begin_define
define|#
directive|define
name|letoh16
parameter_list|(
name|x
parameter_list|)
value|le16toh(x)
end_define

begin_define
define|#
directive|define
name|NV_RID
value|0x10
end_define

begin_decl_stmt
specifier|static
name|device_method_t
name|nfe_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|nfe_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|nfe_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|nfe_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|nfe_shutdown
argument_list|)
block|,
comment|/* bus interface */
name|DEVMETHOD
argument_list|(
name|bus_print_child
argument_list|,
name|bus_generic_print_child
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_driver_added
argument_list|,
name|bus_generic_driver_added
argument_list|)
block|,
comment|/* MII interface */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|nfe_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|nfe_miibus_writereg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_statchg
argument_list|,
name|nfe_miibus_statchg
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|nfe_driver
init|=
block|{
literal|"nfe"
block|,
name|nfe_methods
block|,
expr|sizeof
operator|(
expr|struct
name|nfe_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|nfe_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|nfe
argument_list|,
name|pci
argument_list|,
name|nfe_driver
argument_list|,
name|nfe_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|nfe
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|nfe_type
name|nfe_devs
index|[]
init|=
block|{
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE_LAN
block|,
literal|"NVIDIA nForce MCP Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE2_LAN
block|,
literal|"NVIDIA nForce2 MCP2 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE2_400_LAN1
block|,
literal|"NVIDIA nForce2 400 MCP4 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE2_400_LAN2
block|,
literal|"NVIDIA nForce2 400 MCP5 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE3_LAN1
block|,
literal|"NVIDIA nForce3 MCP3 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE3_250_LAN
block|,
literal|"NVIDIA nForce3 250 MCP6 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE3_LAN4
block|,
literal|"NVIDIA nForce3 MCP7 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE4_LAN1
block|,
literal|"NVIDIA nForce4 CK804 MCP8 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE4_LAN2
block|,
literal|"NVIDIA nForce4 CK804 MCP9 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP04_LAN1
block|,
literal|"NVIDIA nForce MCP04 Networking Adapter"
block|}
block|,
comment|// MCP10
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP04_LAN2
block|,
literal|"NVIDIA nForce MCP04 Networking Adapter"
block|}
block|,
comment|// MCP11
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE430_LAN1
block|,
literal|"NVIDIA nForce 430 MCP12 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_NFORCE430_LAN2
block|,
literal|"NVIDIA nForce 430 MCP13 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP55_LAN1
block|,
literal|"NVIDIA nForce MCP55 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP55_LAN2
block|,
literal|"NVIDIA nForce MCP55 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP61_LAN1
block|,
literal|"NVIDIA nForce MCP61 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP61_LAN2
block|,
literal|"NVIDIA nForce MCP61 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP61_LAN3
block|,
literal|"NVIDIA nForce MCP61 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP61_LAN2
block|,
literal|"NVIDIA nForce MCP61 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP65_LAN1
block|,
literal|"NVIDIA nForce MCP65 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP65_LAN2
block|,
literal|"NVIDIA nForce MCP65 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP65_LAN3
block|,
literal|"NVIDIA nForce MCP65 Networking Adapter"
block|}
block|,
block|{
name|PCI_VENDOR_NVIDIA
block|,
name|PCI_PRODUCT_NVIDIA_MCP65_LAN2
block|,
literal|"NVIDIA nForce MCP65 Networking Adapter"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Probe for supported hardware ID's */
end_comment

begin_function
specifier|static
name|int
name|nfe_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nfe_type
modifier|*
name|t
decl_stmt|;
name|t
operator|=
name|nfe_devs
expr_stmt|;
comment|/* Check for matching PCI DEVICE ID's */
while|while
condition|(
name|t
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
name|t
operator|->
name|vid_id
operator|)
operator|&&
operator|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|t
operator|->
name|dev_id
operator|)
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|t
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|,
name|rid
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nfe_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|nfe_unit
operator|=
name|unit
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|nfe_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
operator||
name|MTX_RECURSE
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|nfe_stat_ch
argument_list|,
operator|&
name|sc
operator|->
name|nfe_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|rid
operator|=
name|NV_RID
expr_stmt|;
name|sc
operator|->
name|nfe_res
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_res
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: couldn't map ports/memory\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|nfe_memt
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|nfe_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nfe_memh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|nfe_res
argument_list|)
expr_stmt|;
comment|/* Allocate interrupt */
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|nfe_irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_irq
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: couldn't map interrupt\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|nfe_get_macaddr
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|eaddr
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nfe_flags
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
name|PCI_PRODUCT_NVIDIA_NFORCE3_LAN2
case|:
case|case
name|PCI_PRODUCT_NVIDIA_NFORCE3_LAN3
case|:
case|case
name|PCI_PRODUCT_NVIDIA_NFORCE3_LAN4
case|:
case|case
name|PCI_PRODUCT_NVIDIA_NFORCE3_LAN5
case|:
name|sc
operator|->
name|nfe_flags
operator||=
name|NFE_JUMBO_SUP
operator||
name|NFE_HW_CSUM
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_NVIDIA_MCP51_LAN1
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP51_LAN2
case|:
name|sc
operator|->
name|nfe_flags
operator||=
name|NFE_40BIT_ADDR
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_NVIDIA_CK804_LAN1
case|:
case|case
name|PCI_PRODUCT_NVIDIA_CK804_LAN2
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP04_LAN1
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP04_LAN2
case|:
name|sc
operator|->
name|nfe_flags
operator||=
name|NFE_JUMBO_SUP
operator||
name|NFE_40BIT_ADDR
operator||
name|NFE_HW_CSUM
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_NVIDIA_MCP55_LAN1
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP55_LAN2
case|:
name|sc
operator|->
name|nfe_flags
operator||=
name|NFE_JUMBO_SUP
operator||
name|NFE_40BIT_ADDR
operator||
name|NFE_HW_CSUM
operator||
name|NFE_HW_VLAN
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_NVIDIA_MCP61_LAN1
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP61_LAN2
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP61_LAN3
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP61_LAN4
case|:
name|sc
operator|->
name|nfe_flags
operator||=
name|NFE_40BIT_ADDR
expr_stmt|;
break|break;
case|case
name|PCI_PRODUCT_NVIDIA_MCP65_LAN1
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP65_LAN2
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP65_LAN3
case|:
case|case
name|PCI_PRODUCT_NVIDIA_MCP65_LAN4
case|:
name|sc
operator|->
name|nfe_flags
operator||=
name|NFE_JUMBO_SUP
operator||
name|NFE_40BIT_ADDR
operator||
name|NFE_HW_CSUM
expr_stmt|;
break|break;
block|}
comment|/* 	 * Allocate the parent bus DMA tag appropriate for PCI. 	 */
define|#
directive|define
name|NFE_NSEG_NEW
value|32
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MAXBSIZE
argument_list|,
name|NFE_NSEG_NEW
argument_list|,
comment|/* maxsize, nsegments */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|nfe_parent_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|ifp
operator|=
name|sc
operator|->
name|nfe_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: can not if_alloc()\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOSPC
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|nfe_mtu
operator|=
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
comment|/* 	 * Allocate Tx and Rx rings. 	 */
if|if
condition|(
name|nfe_alloc_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not allocate Tx ring\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|nfe_alloc_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not allocate Rx ring\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|nfe_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|nfe_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|nfe_start
expr_stmt|;
comment|/* ifp->if_hwassist = NFE_CSUM_FEATURES; */
name|ifp
operator|->
name|if_watchdog
operator|=
name|nfe_watchdog
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|nfe_init
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|NFE_IFQ_MAXLEN
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator|=
name|IFCAP_VLAN_MTU
expr_stmt|;
ifdef|#
directive|ifdef
name|NFE_JUMBO
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_JUMBO_MTU
expr_stmt|;
else|#
directive|else
name|ifp
operator|->
name|if_capabilities
operator|&=
operator|~
name|IFCAP_JUMBO_MTU
expr_stmt|;
name|sc
operator|->
name|nfe_flags
operator|&=
operator|~
name|NFE_JUMBO_SUP
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|NVLAN
operator|>
literal|0
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_HW_VLAN
condition|)
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NFE_CSUM
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_HW_CSUM
condition|)
block|{
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator||=
name|IFCAP_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
name|NFE_CSUM_FEATURES
expr_stmt|;
block|}
else|#
directive|else
name|sc
operator|->
name|nfe_flags
operator|&=
operator|~
name|NFE_HW_CSUM
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_POLLING
expr_stmt|;
endif|#
directive|endif
comment|/* Do MII setup */
if|if
condition|(
name|mii_phy_probe
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|nfe_miibus
argument_list|,
name|nfe_ifmedia_upd
argument_list|,
name|nfe_ifmedia_sts
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: MII without any phy!\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|eaddr
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|nfe_irq
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|nfe_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|nfe_intrhand
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: couldn't set up irq\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|fail
label|:
if|if
condition|(
name|error
condition|)
name|nfe_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_char
name|eaddr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|mtx_initialized
argument_list|(
operator|&
name|sc
operator|->
name|nfe_mtx
argument_list|)
argument_list|,
operator|(
literal|"nfe mutex not initialized"
operator|)
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|nfe_ifp
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
name|ether_poll_deregister
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
block|{
name|eaddr
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|eaddr
index|[
literal|5
operator|-
name|i
index|]
expr_stmt|;
block|}
name|nfe_set_macaddr
argument_list|(
name|sc
argument_list|,
name|eaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_stop
argument_list|(
name|ifp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|nfe_stat_ch
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ifp
condition|)
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_miibus
condition|)
name|device_delete_child
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_intrhand
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|nfe_irq
argument_list|,
name|sc
operator|->
name|nfe_intrhand
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_irq
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|nfe_irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_res
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|NV_RID
argument_list|,
name|sc
operator|->
name|nfe_res
argument_list|)
expr_stmt|;
name|nfe_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
argument_list|)
expr_stmt|;
name|nfe_free_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_parent_tag
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|nfe_parent_tag
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|sc
operator|->
name|nfe_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_miibus_statchg
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|u_int32_t
name|phy
decl_stmt|,
name|seed
decl_stmt|,
name|misc
init|=
name|NFE_MISC1_MAGIC
decl_stmt|,
name|link
init|=
name|NFE_MEDIA_SET
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
name|phy
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_IFACE
argument_list|)
expr_stmt|;
name|phy
operator|&=
operator|~
operator|(
name|NFE_PHY_HDX
operator||
name|NFE_PHY_100TX
operator||
name|NFE_PHY_1000T
operator|)
expr_stmt|;
name|seed
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_RNDSEED
argument_list|)
expr_stmt|;
name|seed
operator|&=
operator|~
name|NFE_SEED_MASK
expr_stmt|;
if|if
condition|(
operator|(
name|mii
operator|->
name|mii_media_active
operator|&
name|IFM_GMASK
operator|)
operator|==
name|IFM_HDX
condition|)
block|{
name|phy
operator||=
name|NFE_PHY_HDX
expr_stmt|;
comment|/* half-duplex */
name|misc
operator||=
name|NFE_MISC1_HDX
expr_stmt|;
block|}
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
condition|)
block|{
case|case
name|IFM_1000_T
case|:
comment|/* full-duplex only */
name|link
operator||=
name|NFE_MEDIA_1000T
expr_stmt|;
name|seed
operator||=
name|NFE_SEED_1000T
expr_stmt|;
name|phy
operator||=
name|NFE_PHY_1000T
expr_stmt|;
break|break;
case|case
name|IFM_100_TX
case|:
name|link
operator||=
name|NFE_MEDIA_100TX
expr_stmt|;
name|seed
operator||=
name|NFE_SEED_100TX
expr_stmt|;
name|phy
operator||=
name|NFE_PHY_100TX
expr_stmt|;
break|break;
case|case
name|IFM_10_T
case|:
name|link
operator||=
name|NFE_MEDIA_10T
expr_stmt|;
name|seed
operator||=
name|NFE_SEED_10T
expr_stmt|;
break|break;
block|}
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RNDSEED
argument_list|,
name|seed
argument_list|)
expr_stmt|;
comment|/* XXX: gigabit NICs only? */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_IFACE
argument_list|,
name|phy
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_MISC1
argument_list|,
name|misc
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_LINKSPEED
argument_list|,
name|link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|val
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|)
operator|&
name|NFE_PHY_BUSY
condition|)
block|{
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|,
name|NFE_PHY_BUSY
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|,
operator|(
name|phy
operator|<<
name|NFE_PHYADD_SHIFT
operator|)
operator||
name|reg
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|)
operator|&
name|NFE_PHY_BUSY
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|ntries
operator|==
literal|1000
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"nfe%d: timeout waiting for PHY\n"
operator|,
name|sc
operator|->
name|nfe_unit
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|)
operator|&
name|NFE_PHY_ERROR
condition|)
block|{
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"nfe%d: could not read PHY\n"
operator|,
name|sc
operator|->
name|nfe_unit
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|val
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
literal|0xffffffff
operator|&&
name|val
operator|!=
literal|0
condition|)
name|sc
operator|->
name|mii_phyaddr
operator|=
name|phy
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|2
argument_list|,
operator|(
literal|"nfe%d: mii read phy %d reg 0x%x ret 0x%x\n"
operator|,
name|sc
operator|->
name|nfe_unit
operator|,
name|phy
operator|,
name|reg
operator|,
name|val
operator|)
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|ctl
decl_stmt|;
name|int
name|ntries
decl_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|)
operator|&
name|NFE_PHY_BUSY
condition|)
block|{
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|,
name|NFE_PHY_BUSY
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_DATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ctl
operator|=
name|NFE_PHY_WRITE
operator||
operator|(
name|phy
operator|<<
name|NFE_PHYADD_SHIFT
operator|)
operator||
name|reg
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|,
name|ctl
argument_list|)
expr_stmt|;
for|for
control|(
name|ntries
operator|=
literal|0
init|;
name|ntries
operator|<
literal|1000
condition|;
name|ntries
operator|++
control|)
block|{
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_CTL
argument_list|)
operator|&
name|NFE_PHY_BUSY
operator|)
condition|)
break|break;
block|}
ifdef|#
directive|ifdef
name|NFE_DEBUG
if|if
condition|(
name|nfedebug
operator|>=
literal|2
operator|&&
name|ntries
operator|==
literal|1000
condition|)
name|printf
argument_list|(
literal|"could not write to PHY\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_alloc_rx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|nfe_desc32
modifier|*
name|desc32
decl_stmt|;
name|struct
name|nfe_desc64
modifier|*
name|desc64
decl_stmt|;
name|struct
name|nfe_rx_data
modifier|*
name|data
decl_stmt|;
name|void
modifier|*
modifier|*
name|desc
decl_stmt|;
name|bus_addr_t
name|physaddr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|descsize
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|desc64
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc64
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|desc32
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc32
argument_list|)
expr_stmt|;
block|}
name|ring
operator|->
name|cur
operator|=
name|ring
operator|->
name|next
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|bufsz
operator|=
operator|(
name|sc
operator|->
name|nfe_mtu
operator|+
name|NFE_RX_HEADERS
operator|<=
name|MCLBYTES
operator|)
condition|?
name|MCLBYTES
else|:
name|MJUM9BYTES
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|nfe_parent_tag
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|NFE_RX_RING_COUNT
operator|*
name|descsize
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|NFE_RX_RING_COUNT
operator|*
name|descsize
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|ring
operator|->
name|rx_desc_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not create desc DMA tag\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* allocate memory to desc */
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
name|desc
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|ring
operator|->
name|rx_desc_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not create desc DMA map\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* map desc to device visible address space */
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|,
name|ring
operator|->
name|rx_desc_map
argument_list|,
operator|*
name|desc
argument_list|,
name|NFE_RX_RING_COUNT
operator|*
name|descsize
argument_list|,
name|nfe_dma_map_segs
argument_list|,
operator|&
name|ring
operator|->
name|rx_desc_segs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not load desc DMA map\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|bzero
argument_list|(
operator|*
name|desc
argument_list|,
name|NFE_RX_RING_COUNT
operator|*
name|descsize
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rx_desc_addr
operator|=
name|ring
operator|->
name|rx_desc_segs
operator|.
name|ds_addr
expr_stmt|;
name|ring
operator|->
name|physaddr
operator|=
name|ring
operator|->
name|rx_desc_addr
expr_stmt|;
comment|/* 	 * Pre-allocate Rx buffers and populate Rx ring. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFE_RX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|data
index|[
name|i
index|]
expr_stmt|;
name|MGETHDR
argument_list|(
name|data
operator|->
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not allocate rx mbuf\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|nfe_parent_tag
argument_list|,
name|ETHER_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|MCLBYTES
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|data
operator|->
name|rx_data_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not create DMA map\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|data
operator|->
name|rx_data_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not allocate mbuf cluster\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|MCLGET
argument_list|(
name|data
operator|->
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|data
operator|->
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|,
name|mtod
argument_list|(
name|data
operator|->
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|ring
operator|->
name|bufsz
argument_list|,
name|nfe_dma_map_segs
argument_list|,
operator|&
name|data
operator|->
name|rx_data_segs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not load rx buf DMA map\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|data
operator|->
name|rx_data_addr
operator|=
name|data
operator|->
name|rx_data_segs
operator|.
name|ds_addr
expr_stmt|;
name|physaddr
operator|=
name|data
operator|->
name|rx_data_addr
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc64
operator|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|desc64
index|[
name|i
index|]
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__LP64__
argument_list|)
name|desc64
operator|->
name|physaddr
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
name|physaddr
operator|>>
literal|32
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|desc64
operator|->
name|physaddr
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|physaddr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|desc64
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|bufsz
argument_list|)
expr_stmt|;
name|desc64
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|NFE_RX_READY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc32
operator|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|desc32
index|[
name|i
index|]
expr_stmt|;
name|desc32
operator|->
name|physaddr
operator|=
name|htole32
argument_list|(
name|physaddr
argument_list|)
expr_stmt|;
name|desc32
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|bufsz
argument_list|)
expr_stmt|;
name|desc32
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|NFE_RX_READY
argument_list|)
expr_stmt|;
block|}
block|}
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|,
name|ring
operator|->
name|rx_desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|nfe_free_rx_ring
argument_list|(
name|sc
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_reset_rx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFE_RX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|ring
operator|->
name|desc64
index|[
name|i
index|]
operator|.
name|length
operator|=
name|htole16
argument_list|(
name|ring
operator|->
name|bufsz
argument_list|)
expr_stmt|;
name|ring
operator|->
name|desc64
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|htole16
argument_list|(
name|NFE_RX_READY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ring
operator|->
name|desc32
index|[
name|i
index|]
operator|.
name|length
operator|=
name|htole16
argument_list|(
name|ring
operator|->
name|bufsz
argument_list|)
expr_stmt|;
name|ring
operator|->
name|desc32
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|htole16
argument_list|(
name|NFE_RX_READY
argument_list|)
expr_stmt|;
block|}
block|}
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|,
name|ring
operator|->
name|rx_desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
name|ring
operator|->
name|next
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_free_rx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_rx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|nfe_rx_data
modifier|*
name|data
decl_stmt|;
name|void
modifier|*
name|desc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|descsize
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc
operator|=
name|ring
operator|->
name|desc64
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc64
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|=
name|ring
operator|->
name|desc32
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|desc
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|,
name|ring
operator|->
name|rx_desc_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|,
name|ring
operator|->
name|rx_desc_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|,
name|desc
argument_list|,
name|ring
operator|->
name|rx_desc_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|rx_desc_tag
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFE_RX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|rx_data_map
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_alloc_tx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|void
modifier|*
modifier|*
name|desc
decl_stmt|;
name|int
name|descsize
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|desc64
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc64
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ring
operator|->
name|desc32
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc32
argument_list|)
expr_stmt|;
block|}
name|ring
operator|->
name|queued
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
name|ring
operator|->
name|next
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|nfe_parent_tag
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|NFE_TX_RING_COUNT
operator|*
name|descsize
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|NFE_TX_RING_COUNT
operator|*
name|descsize
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|ring
operator|->
name|tx_desc_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not create desc DMA tag\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|ring
operator|->
name|tx_desc_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
name|desc
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|ring
operator|->
name|tx_desc_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not create desc DMA map\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|ring
operator|->
name|tx_desc_tag
argument_list|,
name|ring
operator|->
name|tx_desc_map
argument_list|,
operator|*
name|desc
argument_list|,
name|NFE_TX_RING_COUNT
operator|*
name|descsize
argument_list|,
name|nfe_dma_map_segs
argument_list|,
operator|&
name|ring
operator|->
name|tx_desc_segs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not load desc DMA map\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|bzero
argument_list|(
operator|*
name|desc
argument_list|,
name|NFE_TX_RING_COUNT
operator|*
name|descsize
argument_list|)
expr_stmt|;
name|ring
operator|->
name|tx_desc_addr
operator|=
name|ring
operator|->
name|tx_desc_segs
operator|.
name|ds_addr
expr_stmt|;
name|ring
operator|->
name|physaddr
operator|=
name|ring
operator|->
name|tx_desc_addr
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|nfe_parent_tag
argument_list|,
name|ETHER_ALIGN
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NFE_JBYTES
argument_list|,
name|NFE_MAX_SCATTER
argument_list|,
name|NFE_JBYTES
argument_list|,
name|BUS_DMA_ALLOCNOW
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ring
operator|->
name|tx_data_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not create DMA tag\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFE_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|ring
operator|->
name|tx_data_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
operator|.
name|tx_data_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not create DMA map\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
return|return
literal|0
return|;
name|fail
label|:
name|nfe_free_tx_ring
argument_list|(
name|sc
argument_list|,
name|ring
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_reset_tx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|nfe_tx_data
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFE_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
name|ring
operator|->
name|desc64
index|[
name|i
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
else|else
name|ring
operator|->
name|desc32
index|[
name|i
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|tx_data_tag
argument_list|,
name|data
operator|->
name|active
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|tx_data_tag
argument_list|,
name|data
operator|->
name|active
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|tx_desc_tag
argument_list|,
name|ring
operator|->
name|tx_desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|ring
operator|->
name|queued
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|cur
operator|=
name|ring
operator|->
name|next
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_free_tx_ring
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_tx_ring
modifier|*
name|ring
parameter_list|)
block|{
name|struct
name|nfe_tx_data
modifier|*
name|data
decl_stmt|;
name|void
modifier|*
name|desc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|descsize
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc
operator|=
name|ring
operator|->
name|desc64
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc64
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|=
name|ring
operator|->
name|desc32
expr_stmt|;
name|descsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nfe_desc32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|desc
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|tx_desc_tag
argument_list|,
name|ring
operator|->
name|tx_desc_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|tx_desc_tag
argument_list|,
name|ring
operator|->
name|tx_desc_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ring
operator|->
name|tx_desc_tag
argument_list|,
name|desc
argument_list|,
name|ring
operator|->
name|tx_desc_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|tx_desc_tag
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFE_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ring
operator|->
name|tx_data_tag
argument_list|,
name|data
operator|->
name|active
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ring
operator|->
name|tx_data_tag
argument_list|,
name|data
operator|->
name|active
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* ..and now actually destroy the DMA mappings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NFE_TX_RING_COUNT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|ring
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|tx_data_map
operator|==
name|NULL
condition|)
continue|continue;
name|bus_dmamap_destroy
argument_list|(
name|ring
operator|->
name|tx_data_tag
argument_list|,
name|data
operator|->
name|tx_data_map
argument_list|)
expr_stmt|;
block|}
name|bus_dma_tag_destroy
argument_list|(
name|ring
operator|->
name|tx_data_tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEVICE_POLLING
end_ifdef

begin_decl_stmt
specifier|static
name|poll_handler_t
name|nfe_poll
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|nfe_poll
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|enum
name|poll_cmd
name|cmd
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|nfe_poll_locked
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_poll_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|enum
name|poll_cmd
name|cmd
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|u_int32_t
name|r
decl_stmt|;
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
return|return;
block|}
name|sc
operator|->
name|rxcycles
operator|=
name|count
expr_stmt|;
name|nfe_rxeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_txeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|nfe_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|POLL_AND_CHECK_STATUS
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_STATUS
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
return|return;
block|}
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_STATUS
argument_list|,
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|NFE_IRQ_LINK
condition|)
block|{
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"nfe%d: link state changed\n"
operator|,
name|sc
operator|->
name|nfe_unit
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DEVICE_POLLING */
end_comment

begin_function
specifier|static
name|int
name|nfe_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFMTU
case|:
if|if
condition|(
name|ifr
operator|->
name|ifr_mtu
operator|==
name|ifp
operator|->
name|if_mtu
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_JUMBO_SUP
operator|)
operator|&&
operator|(
name|ifr
operator|->
name|ifr_mtu
operator|>=
name|ETHERMIN
operator|&&
name|ifr
operator|->
name|ifr_mtu
operator|<=
name|NV_PKTLIMIT_2
operator|)
condition|)
block|{
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nfe_mtu
operator|=
name|ifp
operator|->
name|if_mtu
operator|=
name|ifr
operator|->
name|ifr_mtu
expr_stmt|;
name|nfe_stop
argument_list|(
name|ifp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nfe_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
argument_list|)
expr_stmt|;
name|nfe_free_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Reallocate Tx and Rx rings. */
if|if
condition|(
name|nfe_alloc_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not allocate Tx ring\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|nfe_alloc_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not allocate Rx ring\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
name|nfe_free_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
break|break;
block|}
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFFLAGS
case|:
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
comment|/* 			 * If only the PROMISC or ALLMULTI flag changes, then 			 * don't do a full re-init of the chip, just update 			 * the Rx filter. 			 */
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|&&
operator|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|sc
operator|->
name|nfe_if_flags
operator|)
operator|&
operator|(
name|IFF_ALLMULTI
operator||
name|IFF_PROMISC
operator|)
operator|)
operator|!=
literal|0
condition|)
name|nfe_setmulti
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|nfe_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|nfe_stop
argument_list|(
name|ifp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|nfe_if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_setmulti
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
block|{
name|int
name|init
init|=
literal|0
decl_stmt|;
name|int
name|mask
init|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
decl_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|mask
operator|&
name|IFCAP_POLLING
condition|)
block|{
if|if
condition|(
name|ifr
operator|->
name|ifr_reqcap
operator|&
name|IFCAP_POLLING
condition|)
block|{
name|error
operator|=
name|ether_poll_register
argument_list|(
name|nfe_poll
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator||=
name|IFCAP_POLLING
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|ether_poll_deregister
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* Enable interrupt even in error case */
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_MASK
argument_list|,
name|NFE_IRQ_WANTED
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_POLLING
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* DEVICE_POLLING */
ifdef|#
directive|ifdef
name|NFE_CSUM
if|if
condition|(
name|mask
operator|&
name|IFCAP_HWCSUM
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_HWCSUM
expr_stmt|;
if|if
condition|(
name|IFCAP_HWCSUM
operator|&
name|ifp
operator|->
name|if_capenable
operator|&&
name|IFCAP_HWCSUM
operator|&
name|ifp
operator|->
name|if_capabilities
condition|)
name|ifp
operator|->
name|if_hwassist
operator|=
name|NFE_CSUM_FEATURES
expr_stmt|;
else|else
name|ifp
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|nfe_flags
operator|^=
name|NFE_HW_CSUM
expr_stmt|;
name|init
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|init
operator|&&
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|nfe_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|nfe_ifp
decl_stmt|;
name|u_int32_t
name|r
decl_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
block|{
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|r
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_STATUS
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
comment|/* not for us */
block|}
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_STATUS
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|DPRINTFN
argument_list|(
literal|5
argument_list|,
operator|(
literal|"nfe_intr: interrupt register %x\n"
operator|,
name|r
operator|)
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|&
name|NFE_IRQ_LINK
condition|)
block|{
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"nfe%d: link state changed\n"
operator|,
name|sc
operator|->
name|nfe_unit
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
comment|/* check Rx ring */
name|nfe_rxeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* check Tx ring */
name|nfe_txeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_MASK
argument_list|,
name|NFE_IRQ_WANTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|&&
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|nfe_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_txdesc32_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_desc32
modifier|*
name|desc32
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_desc_tag
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|tx_desc_map
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_txdesc64_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_desc64
modifier|*
name|desc64
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_desc_tag
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|tx_desc_map
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_txdesc32_rsync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_desc_tag
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|tx_desc_map
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_txdesc64_rsync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|end
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_desc_tag
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|tx_desc_map
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_rxdesc32_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_desc32
modifier|*
name|desc32
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|rx_desc_tag
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|rx_desc_map
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_rxdesc64_sync
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|nfe_desc64
modifier|*
name|desc64
parameter_list|,
name|int
name|ops
parameter_list|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|rx_desc_tag
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|rx_desc_map
argument_list|,
name|ops
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_rxeof
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|nfe_ifp
decl_stmt|;
name|struct
name|nfe_desc32
modifier|*
name|desc32
init|=
name|NULL
decl_stmt|;
name|struct
name|nfe_desc64
modifier|*
name|desc64
init|=
name|NULL
decl_stmt|;
name|struct
name|nfe_rx_data
modifier|*
name|data
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|mnew
decl_stmt|;
name|bus_addr_t
name|physaddr
decl_stmt|;
name|u_int16_t
name|flags
decl_stmt|;
name|int
name|error
decl_stmt|,
name|len
decl_stmt|;
if|#
directive|if
name|NVLAN
operator|>
literal|1
name|u_int16_t
name|vlan_tag
init|=
literal|0
decl_stmt|;
name|int
name|have_tag
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|rxcycles
operator|<=
literal|0
condition|)
break|break;
name|sc
operator|->
name|rxcycles
operator|--
expr_stmt|;
block|}
endif|#
directive|endif
name|data
operator|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|data
index|[
name|sc
operator|->
name|rxq
operator|.
name|cur
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc64
operator|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|desc64
index|[
name|sc
operator|->
name|rxq
operator|.
name|cur
index|]
expr_stmt|;
name|nfe_rxdesc64_sync
argument_list|(
name|sc
argument_list|,
name|desc64
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|flags
operator|=
name|letoh16
argument_list|(
name|desc64
operator|->
name|flags
argument_list|)
expr_stmt|;
name|len
operator|=
name|letoh16
argument_list|(
name|desc64
operator|->
name|length
argument_list|)
operator|&
literal|0x3fff
expr_stmt|;
if|#
directive|if
name|NVLAN
operator|>
literal|1
if|if
condition|(
name|flags
operator|&
name|NFE_TX_VLAN_TAG
condition|)
block|{
name|have_tag
operator|=
literal|1
expr_stmt|;
name|vlan_tag
operator|=
name|desc64
operator|->
name|vtag
expr_stmt|;
block|}
endif|#
directive|endif
block|}
else|else
block|{
name|desc32
operator|=
operator|&
name|sc
operator|->
name|rxq
operator|.
name|desc32
index|[
name|sc
operator|->
name|rxq
operator|.
name|cur
index|]
expr_stmt|;
name|nfe_rxdesc32_sync
argument_list|(
name|sc
argument_list|,
name|desc32
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|flags
operator|=
name|letoh16
argument_list|(
name|desc32
operator|->
name|flags
argument_list|)
expr_stmt|;
name|len
operator|=
name|letoh16
argument_list|(
name|desc32
operator|->
name|length
argument_list|)
operator|&
literal|0x3fff
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|NFE_RX_READY
condition|)
break|break;
if|if
condition|(
operator|(
name|sc
operator|->
name|nfe_flags
operator|&
operator|(
name|NFE_JUMBO_SUP
operator||
name|NFE_40BIT_ADDR
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|NFE_RX_VALID_V1
operator|)
condition|)
goto|goto
name|skip
goto|;
if|if
condition|(
operator|(
name|flags
operator|&
name|NFE_RX_FIXME_V1
operator|)
operator|==
name|NFE_RX_FIXME_V1
condition|)
block|{
name|flags
operator|&=
operator|~
name|NFE_RX_ERROR
expr_stmt|;
name|len
operator|--
expr_stmt|;
comment|/* fix buffer length */
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|NFE_RX_VALID_V2
operator|)
condition|)
goto|goto
name|skip
goto|;
if|if
condition|(
operator|(
name|flags
operator|&
name|NFE_RX_FIXME_V2
operator|)
operator|==
name|NFE_RX_FIXME_V2
condition|)
block|{
name|flags
operator|&=
operator|~
name|NFE_RX_ERROR
expr_stmt|;
name|len
operator|--
expr_stmt|;
comment|/* fix buffer length */
block|}
block|}
if|if
condition|(
name|flags
operator|&
name|NFE_RX_ERROR
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
comment|/* 		 * Try to allocate a new mbuf for this ring element and load 		 * it before processing the current mbuf. If the ring element 		 * cannot be loaded, drop the received packet and reuse the 		 * old mbuf. In the unlikely case that the old mbuf can't be 		 * reloaded either, explicitly panic. 		 */
name|MGETHDR
argument_list|(
name|mnew
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|mnew
operator|==
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|MCLGET
argument_list|(
name|mnew
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|mnew
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|mnew
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|bus_dmamap_sync
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|,
name|mtod
argument_list|(
name|mnew
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|MCLBYTES
argument_list|,
name|nfe_dma_map_segs
argument_list|,
operator|&
name|data
operator|->
name|rx_data_segs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|mnew
argument_list|)
expr_stmt|;
comment|/* try to reload the old mbuf */
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|data
operator|->
name|rx_data_tag
argument_list|,
name|data
operator|->
name|rx_data_map
argument_list|,
name|mtod
argument_list|(
name|data
operator|->
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|MCLBYTES
argument_list|,
name|nfe_dma_map_segs
argument_list|,
operator|&
name|data
operator|->
name|rx_data_segs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
comment|/* very unlikely that it will fail.. */
name|panic
argument_list|(
literal|"nfe%d: could not load old rx mbuf"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
block|}
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|data
operator|->
name|rx_data_addr
operator|=
name|data
operator|->
name|rx_data_segs
operator|.
name|ds_addr
expr_stmt|;
name|physaddr
operator|=
name|data
operator|->
name|rx_data_addr
expr_stmt|;
comment|/* 		 * New mbuf successfully loaded, update Rx ring and continue 		 * processing. 		 */
name|m
operator|=
name|data
operator|->
name|m
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|mnew
expr_stmt|;
comment|/* finalize mbuf */
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_HW_CSUM
operator|)
operator|&&
operator|(
name|flags
operator|&
name|NFE_RX_CSUMOK
operator|)
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|NFE_RX_IP_CSUMOK_V2
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_VALID
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|NFE_RX_UDP_CSUMOK_V2
operator|||
name|flags
operator|&
name|NFE_RX_TCP_CSUMOK_V2
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xffff
expr_stmt|;
block|}
block|}
if|#
directive|if
name|NVLAN
operator|>
literal|1
if|if
condition|(
name|have_tag
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|vlan_tag
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
endif|#
directive|endif
name|ifp
operator|->
name|if_ipackets
operator|++
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* update mapping address in h/w descriptor */
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|__LP64__
argument_list|)
name|desc64
operator|->
name|physaddr
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
name|physaddr
operator|>>
literal|32
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|desc64
operator|->
name|physaddr
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|physaddr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc32
operator|->
name|physaddr
operator|=
name|htole32
argument_list|(
name|physaddr
argument_list|)
expr_stmt|;
block|}
name|skip
label|:
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc64
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|bufsz
argument_list|)
expr_stmt|;
name|desc64
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|NFE_RX_READY
argument_list|)
expr_stmt|;
name|nfe_rxdesc64_sync
argument_list|(
name|sc
argument_list|,
name|desc64
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc32
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|sc
operator|->
name|rxq
operator|.
name|bufsz
argument_list|)
expr_stmt|;
name|desc32
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|NFE_RX_READY
argument_list|)
expr_stmt|;
name|nfe_rxdesc32_sync
argument_list|(
name|sc
argument_list|,
name|desc32
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|rxq
operator|.
name|cur
operator|=
operator|(
name|sc
operator|->
name|rxq
operator|.
name|cur
operator|+
literal|1
operator|)
operator|%
name|NFE_RX_RING_COUNT
expr_stmt|;
block|}
comment|//end for(;;)
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_txeof
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|nfe_ifp
decl_stmt|;
name|struct
name|nfe_desc32
modifier|*
name|desc32
decl_stmt|;
name|struct
name|nfe_desc64
modifier|*
name|desc64
decl_stmt|;
name|struct
name|nfe_tx_data
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|u_int16_t
name|flags
decl_stmt|;
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|txq
operator|.
name|next
operator|!=
name|sc
operator|->
name|txq
operator|.
name|cur
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc64
operator|=
operator|&
name|sc
operator|->
name|txq
operator|.
name|desc64
index|[
name|sc
operator|->
name|txq
operator|.
name|next
index|]
expr_stmt|;
name|nfe_txdesc64_sync
argument_list|(
name|sc
argument_list|,
name|desc64
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|flags
operator|=
name|letoh16
argument_list|(
name|desc64
operator|->
name|flags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|desc32
operator|=
operator|&
name|sc
operator|->
name|txq
operator|.
name|desc32
index|[
name|sc
operator|->
name|txq
operator|.
name|next
index|]
expr_stmt|;
name|nfe_txdesc32_sync
argument_list|(
name|sc
argument_list|,
name|desc32
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|flags
operator|=
name|letoh16
argument_list|(
name|desc32
operator|->
name|flags
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|NFE_TX_VALID
condition|)
break|break;
name|data
operator|=
operator|&
name|sc
operator|->
name|txq
operator|.
name|data
index|[
name|sc
operator|->
name|txq
operator|.
name|next
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|nfe_flags
operator|&
operator|(
name|NFE_JUMBO_SUP
operator||
name|NFE_40BIT_ADDR
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|NFE_TX_LASTFRAG_V1
operator|)
operator|&&
name|data
operator|->
name|m
operator|==
name|NULL
condition|)
goto|goto
name|skip
goto|;
if|if
condition|(
operator|(
name|flags
operator|&
name|NFE_TX_ERROR_V1
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: tx v1 error 0x%4b\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|,
name|flags
argument_list|,
name|NFE_V1_TXERR
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
block|}
else|else
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|NFE_TX_LASTFRAG_V2
operator|)
operator|&&
name|data
operator|->
name|m
operator|==
name|NULL
condition|)
goto|goto
name|skip
goto|;
if|if
condition|(
operator|(
name|flags
operator|&
name|NFE_TX_ERROR_V2
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: tx v1 error 0x%4b\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|,
name|flags
argument_list|,
name|NFE_V2_TXERR
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
block|}
else|else
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|m
operator|==
name|NULL
condition|)
block|{
comment|/* should not get there */
name|printf
argument_list|(
literal|"nfe%d: last fragment bit w/o associated mbuf!\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
comment|/* last fragment of the mbuf chain transmitted */
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_data_tag
argument_list|,
name|data
operator|->
name|active
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_data_tag
argument_list|,
name|data
operator|->
name|active
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|data
operator|->
name|m
argument_list|)
expr_stmt|;
name|data
operator|->
name|m
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|skip
label|:
name|sc
operator|->
name|txq
operator|.
name|queued
operator|--
expr_stmt|;
name|sc
operator|->
name|txq
operator|.
name|next
operator|=
operator|(
name|sc
operator|->
name|txq
operator|.
name|next
operator|+
literal|1
operator|)
operator|%
name|NFE_TX_RING_COUNT
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
comment|/* at least one slot freed */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|nfe_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_encap
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m0
parameter_list|)
block|{
name|struct
name|nfe_desc32
modifier|*
name|desc32
init|=
name|NULL
decl_stmt|;
name|struct
name|nfe_desc64
modifier|*
name|desc64
init|=
name|NULL
decl_stmt|;
name|struct
name|nfe_tx_data
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|NFE_MAX_SCATTER
index|]
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|nsegs
decl_stmt|;
name|u_int16_t
name|flags
init|=
name|NFE_TX_VALID
decl_stmt|;
name|map
operator|=
name|sc
operator|->
name|txq
operator|.
name|data
index|[
name|sc
operator|->
name|txq
operator|.
name|cur
index|]
operator|.
name|tx_data_map
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_data_tag
argument_list|,
name|map
argument_list|,
name|m0
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"nfe%d: could not map mbuf (error %d)\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|txq
operator|.
name|queued
operator|+
name|nsegs
operator|>=
name|NFE_TX_RING_COUNT
operator|-
literal|1
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_data_tag
argument_list|,
name|map
argument_list|)
expr_stmt|;
return|return
name|ENOBUFS
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_HW_CSUM
condition|)
block|{
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP
condition|)
name|flags
operator||=
name|NFE_TX_IP_CSUM
expr_stmt|;
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TCP
condition|)
name|flags
operator||=
name|NFE_TX_TCP_CSUM
expr_stmt|;
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_UDP
condition|)
name|flags
operator||=
name|NFE_TX_TCP_CSUM
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
operator|&
name|sc
operator|->
name|txq
operator|.
name|data
index|[
name|sc
operator|->
name|txq
operator|.
name|cur
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|desc64
operator|=
operator|&
name|sc
operator|->
name|txq
operator|.
name|desc64
index|[
name|sc
operator|->
name|txq
operator|.
name|cur
index|]
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|__LP64__
argument_list|)
name|desc64
operator|->
name|physaddr
index|[
literal|0
index|]
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|desc64
operator|->
name|physaddr
index|[
literal|1
index|]
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|desc64
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|desc64
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|flags
argument_list|)
expr_stmt|;
if|#
directive|if
name|NVLAN
operator|>
literal|0
if|if
condition|(
name|m0
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
name|desc64
operator|->
name|vtag
operator|=
name|htole32
argument_list|(
name|NFE_TX_VTAG
operator||
name|m0
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|desc32
operator|=
operator|&
name|sc
operator|->
name|txq
operator|.
name|desc32
index|[
name|sc
operator|->
name|txq
operator|.
name|cur
index|]
expr_stmt|;
name|desc32
operator|->
name|physaddr
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|desc32
operator|->
name|length
operator|=
name|htole16
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|desc32
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
comment|/* csum flags and vtag belong to the first fragment only */
if|if
condition|(
name|nsegs
operator|>
literal|1
condition|)
block|{
name|flags
operator|&=
operator|~
operator|(
name|NFE_TX_IP_CSUM
operator||
name|NFE_TX_TCP_CSUM
operator|)
expr_stmt|;
block|}
name|sc
operator|->
name|txq
operator|.
name|queued
operator|++
expr_stmt|;
name|sc
operator|->
name|txq
operator|.
name|cur
operator|=
operator|(
name|sc
operator|->
name|txq
operator|.
name|cur
operator|+
literal|1
operator|)
operator|%
name|NFE_TX_RING_COUNT
expr_stmt|;
block|}
comment|/* the whole mbuf chain has been DMA mapped, fix last descriptor */
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
block|{
name|flags
operator||=
name|NFE_TX_LASTFRAG_V2
expr_stmt|;
name|desc64
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_JUMBO_SUP
condition|)
name|flags
operator||=
name|NFE_TX_LASTFRAG_V2
expr_stmt|;
else|else
name|flags
operator||=
name|NFE_TX_LASTFRAG_V1
expr_stmt|;
name|desc32
operator|->
name|flags
operator|=
name|htole16
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|m
operator|=
name|m0
expr_stmt|;
name|data
operator|->
name|active
operator|=
name|map
expr_stmt|;
name|data
operator|->
name|nsegs
operator|=
name|nsegs
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|txq
operator|.
name|tx_data_tag
argument_list|,
name|map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_setmulti
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|nfe_ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int32_t
name|filter
init|=
name|NFE_RXFILTER_MAGIC
decl_stmt|;
name|u_int8_t
name|addr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|,
name|mask
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|u_int8_t
name|etherbroadcastaddr
index|[
name|ETHER_ADDR_LEN
index|]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
operator|(
name|IFF_ALLMULTI
operator||
name|IFF_PROMISC
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|bzero
argument_list|(
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|mask
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bcopy
argument_list|(
name|etherbroadcastaddr
argument_list|,
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|etherbroadcastaddr
argument_list|,
name|mask
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|IF_ADDR_LOCK
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
name|u_char
modifier|*
name|addrp
decl_stmt|;
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|addrp
operator|=
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
block|{
name|u_int8_t
name|mcaddr
init|=
name|addrp
index|[
name|i
index|]
decl_stmt|;
name|addr
index|[
name|i
index|]
operator|&=
name|mcaddr
expr_stmt|;
name|mask
index|[
name|i
index|]
operator|&=
operator|~
name|mcaddr
expr_stmt|;
block|}
block|}
name|IF_ADDR_UNLOCK
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
block|{
name|mask
index|[
name|i
index|]
operator||=
name|addr
index|[
name|i
index|]
expr_stmt|;
block|}
name|done
label|:
name|addr
index|[
literal|0
index|]
operator||=
literal|0x01
expr_stmt|;
comment|/* make sure multicast bit is set */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_MULTIADDR_HI
argument_list|,
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
operator||
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|addr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_MULTIADDR_LO
argument_list|,
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
operator||
name|addr
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_MULTIMASK_HI
argument_list|,
name|mask
index|[
literal|3
index|]
operator|<<
literal|24
operator||
name|mask
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|mask
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|mask
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_MULTIMASK_LO
argument_list|,
name|mask
index|[
literal|5
index|]
operator|<<
literal|8
operator||
name|mask
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|filter
operator||=
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
condition|?
name|NFE_PROMISC
else|:
name|NFE_U2M
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RXFILTER
argument_list|,
name|filter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
name|int
name|old
init|=
name|sc
operator|->
name|txq
operator|.
name|cur
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|nfe_link
operator|||
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
condition|)
block|{
return|return;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|IFQ_POLL
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|nfe_encap
argument_list|(
name|sc
argument_list|,
name|m0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
comment|/* packet put in h/w queue, remove from s/w queue */
name|IFQ_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|txq
operator|.
name|cur
operator|==
name|old
condition|)
block|{
comment|/* nothing sent */
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
name|nfe_txdesc64_rsync
argument_list|(
name|sc
argument_list|,
name|old
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|cur
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
else|else
name|nfe_txdesc32_rsync
argument_list|(
name|sc
argument_list|,
name|old
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|cur
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* kick Tx */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RXTX_CTL
argument_list|,
name|NFE_RXTX_KICKTX
operator||
name|sc
operator|->
name|rxtxctl
argument_list|)
expr_stmt|;
comment|/* 	 * Set a timeout in case the chip goes out to lunch. 	 */
name|ifp
operator|->
name|if_timer
operator|=
literal|5
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_watchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|printf
argument_list|(
literal|"nfe%d: watchdog timeout\n"
argument_list|,
name|sc
operator|->
name|nfe_unit
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|nfe_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_init
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_init_locked
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|nfe_ifp
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|u_int32_t
name|tmp
decl_stmt|;
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
return|return;
block|}
name|nfe_stop
argument_list|(
name|ifp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_TX_UNK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rxtxctl
operator|=
name|NFE_RXTX_BIT2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_40BIT_ADDR
condition|)
name|sc
operator|->
name|rxtxctl
operator||=
name|NFE_RXTX_V3MAGIC
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_JUMBO_SUP
condition|)
name|sc
operator|->
name|rxtxctl
operator||=
name|NFE_RXTX_V2MAGIC
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_HW_CSUM
condition|)
name|sc
operator|->
name|rxtxctl
operator||=
name|NFE_RXTX_RXCSUM
expr_stmt|;
if|#
directive|if
name|NVLAN
operator|>
literal|0
comment|/* 	 * Although the adapter is capable of stripping VLAN tags from received 	 * frames (NFE_RXTX_VTAG_STRIP), we do not enable this functionality on 	 * purpose.  This will be done in software by our network stack. 	 */
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_HW_VLAN
condition|)
name|sc
operator|->
name|rxtxctl
operator||=
name|NFE_RXTX_VTAG_INSERT
expr_stmt|;
endif|#
directive|endif
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RXTX_CTL
argument_list|,
name|NFE_RXTX_RESET
operator||
name|sc
operator|->
name|rxtxctl
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RXTX_CTL
argument_list|,
name|sc
operator|->
name|rxtxctl
argument_list|)
expr_stmt|;
if|#
directive|if
name|NVLAN
if|if
condition|(
name|sc
operator|->
name|nfe_flags
operator|&
name|NFE_HW_VLAN
condition|)
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_VTAG_CTL
argument_list|,
name|NFE_VTAG_ENABLE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_SETUP_R6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set MAC address */
name|nfe_set_macaddr
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|eaddr
argument_list|)
expr_stmt|;
comment|/* tell MAC where rings are in memory */
ifdef|#
directive|ifdef
name|__LP64__
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RX_RING_ADDR_HI
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|physaddr
operator|>>
literal|32
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RX_RING_ADDR_LO
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|physaddr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__LP64__
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_TX_RING_ADDR_HI
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|physaddr
operator|>>
literal|32
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_TX_RING_ADDR_LO
argument_list|,
name|sc
operator|->
name|txq
operator|.
name|physaddr
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RING_SIZE
argument_list|,
operator|(
name|NFE_RX_RING_COUNT
operator|-
literal|1
operator|)
operator|<<
literal|16
operator||
operator|(
name|NFE_TX_RING_COUNT
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RXBUFSZ
argument_list|,
name|sc
operator|->
name|rxq
operator|.
name|bufsz
argument_list|)
expr_stmt|;
comment|/* force MAC to wakeup */
name|tmp
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PWR_STATE
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PWR_STATE
argument_list|,
name|tmp
operator||
name|NFE_PWR_WAKEUP
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_PWR_STATE
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PWR_STATE
argument_list|,
name|tmp
operator||
name|NFE_PWR_VALID
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
comment|/* configure interrupts coalescing/mitigation */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IMTIMER
argument_list|,
name|NFE_IM_DEFAULT
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* no interrupt mitigation: one interrupt per packet */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IMTIMER
argument_list|,
literal|970
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_SETUP_R1
argument_list|,
name|NFE_R1_MAGIC
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_SETUP_R2
argument_list|,
name|NFE_R2_MAGIC
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_SETUP_R6
argument_list|,
name|NFE_R6_MAGIC
argument_list|)
expr_stmt|;
comment|/* update MAC knowledge of PHY; generates a NFE_IRQ_LINK interrupt */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_STATUS
argument_list|,
name|sc
operator|->
name|mii_phyaddr
operator|<<
literal|24
operator||
name|NFE_STATUS_MAGIC
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_SETUP_R4
argument_list|,
name|NFE_R4_MAGIC
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_WOL_CTL
argument_list|,
name|NFE_WOL_MAGIC
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rxtxctl
operator|&=
operator|~
name|NFE_RXTX_BIT2
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RXTX_CTL
argument_list|,
name|sc
operator|->
name|rxtxctl
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RXTX_CTL
argument_list|,
name|NFE_RXTX_BIT1
operator||
name|sc
operator|->
name|rxtxctl
argument_list|)
expr_stmt|;
comment|/* set Rx filter */
name|nfe_setmulti
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_ifmedia_upd
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|nfe_tick_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* enable Rx */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RX_CTL
argument_list|,
name|NFE_RX_START
argument_list|)
expr_stmt|;
comment|/* enable Tx */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_TX_CTL
argument_list|,
name|NFE_TX_START
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_PHY_STATUS
argument_list|,
literal|0xf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEVICE_POLLING
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_POLLING
condition|)
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_MASK
argument_list|,
name|NFE_IRQ_WANTED
argument_list|)
expr_stmt|;
comment|/* enable interrupts */
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|sc
operator|->
name|nfe_link
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_stop
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|int
name|disable
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|nfe_stat_ch
argument_list|)
expr_stmt|;
comment|/* abort Tx */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_TX_CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disable Rx */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_RX_CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* disable interrupts */
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_IRQ_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nfe_link
operator|=
literal|0
expr_stmt|;
comment|/* reset Tx and Rx rings */
name|nfe_reset_tx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|txq
argument_list|)
expr_stmt|;
name|nfe_reset_rx_ring
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|rxq
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_ifmedia_upd_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nfe_ifmedia_upd_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
if|if
condition|(
name|mii
operator|->
name|mii_instance
condition|)
block|{
name|struct
name|mii_softc
modifier|*
name|miisc
decl_stmt|;
for|for
control|(
name|miisc
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|mii
operator|->
name|mii_phys
argument_list|)
init|;
name|miisc
operator|!=
name|NULL
condition|;
name|miisc
operator|=
name|LIST_NEXT
argument_list|(
name|miisc
argument_list|,
name|mii_list
argument_list|)
control|)
block|{
name|mii_phy_reset
argument_list|(
name|miisc
argument_list|)
expr_stmt|;
block|}
block|}
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_tick
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|nfe_tick_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nfe_tick_locked
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|NFE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|nfe_ifp
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|nfe_miibus
argument_list|)
expr_stmt|;
name|mii_tick
argument_list|(
name|mii
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|nfe_link
condition|)
block|{
if|if
condition|(
name|mii
operator|->
name|mii_media_status
operator|&
name|IFM_ACTIVE
operator|&&
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|!=
name|IFM_NONE
condition|)
block|{
name|sc
operator|->
name|nfe_link
operator|++
expr_stmt|;
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
operator|==
name|IFM_1000_T
operator|&&
name|bootverbose
condition|)
name|if_printf
argument_list|(
name|sc
operator|->
name|nfe_ifp
argument_list|,
literal|"gigabit link up\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|nfe_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|nfe_stat_ch
argument_list|,
name|hz
argument_list|,
name|nfe_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|nfe_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|NFE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|nfe_ifp
expr_stmt|;
name|nfe_stop
argument_list|(
name|ifp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* nfe_reset(sc); */
name|NFE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_get_macaddr
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|addr
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_MACADDR_LO
argument_list|)
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
operator|(
name|tmp
operator|&
literal|0xff
operator|)
expr_stmt|;
name|tmp
operator|=
name|NFE_READ
argument_list|(
name|sc
argument_list|,
name|NFE_MACADDR_HI
argument_list|)
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
operator|(
name|tmp
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
operator|(
name|tmp
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|4
index|]
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|5
index|]
operator|=
operator|(
name|tmp
operator|&
literal|0xff
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nfe_set_macaddr
parameter_list|(
name|struct
name|nfe_softc
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|addr
parameter_list|)
block|{
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_MACADDR_LO
argument_list|,
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
operator||
name|addr
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|NFE_WRITE
argument_list|(
name|sc
argument_list|,
name|NFE_MACADDR_HI
argument_list|,
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
operator||
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|addr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Map a single buffer address.  */
end_comment

begin_function
specifier|static
name|void
name|nfe_dma_map_segs
parameter_list|(
name|arg
parameter_list|,
name|segs
parameter_list|,
name|nseg
parameter_list|,
name|error
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
name|bus_dma_segment_t
modifier|*
name|segs
decl_stmt|;
name|int
name|error
decl_stmt|,
name|nseg
decl_stmt|;
block|{
if|if
condition|(
name|error
condition|)
return|return;
name|KASSERT
argument_list|(
name|nseg
operator|==
literal|1
argument_list|,
operator|(
literal|"too many DMA segments, %d should be 1"
operator|,
name|nseg
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|bus_dma_segment_t
operator|*
operator|)
name|arg
operator|=
operator|*
name|segs
expr_stmt|;
return|return;
block|}
end_function

end_unit


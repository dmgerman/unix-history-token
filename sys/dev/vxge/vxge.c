begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxge.h>
end_include

begin_decl_stmt
specifier|static
name|int
name|vxge_pci_bd_no
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u32
name|vxge_drv_copyright
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u32
name|vxge_dev_ref_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u32
name|vxge_dev_req_reboot
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|vpath_selector
index|[
name|VXGE_HAL_MAX_VIRTUAL_PATHS
index|]
init|= \
block|{
literal|0
block|,
literal|1
block|,
literal|3
block|,
literal|3
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|7
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|15
block|,
literal|31
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * vxge_probe  * Probes for x3100 devices  */
end_comment

begin_function
name|int
name|vxge_probe
parameter_list|(
name|device_t
name|ndev
parameter_list|)
block|{
name|int
name|err
init|=
name|ENXIO
decl_stmt|;
name|u16
name|pci_bd_no
init|=
literal|0
decl_stmt|;
name|u16
name|pci_vendor_id
init|=
literal|0
decl_stmt|;
name|u16
name|pci_device_id
init|=
literal|0
decl_stmt|;
name|char
name|adapter_name
index|[
literal|64
index|]
decl_stmt|;
name|pci_vendor_id
operator|=
name|pci_get_vendor
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_vendor_id
operator|!=
name|VXGE_PCI_VENDOR_ID
condition|)
goto|goto
name|_exit0
goto|;
name|pci_device_id
operator|=
name|pci_get_device
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_device_id
operator|==
name|VXGE_PCI_DEVICE_ID_TITAN_1
condition|)
block|{
name|pci_bd_no
operator|=
operator|(
name|pci_get_bus
argument_list|(
name|ndev
argument_list|)
operator||
name|pci_get_slot
argument_list|(
name|ndev
argument_list|)
operator|)
expr_stmt|;
name|snprintf
argument_list|(
name|adapter_name
argument_list|,
sizeof|sizeof
argument_list|(
name|adapter_name
argument_list|)
argument_list|,
name|VXGE_ADAPTER_NAME
argument_list|,
name|pci_get_revid
argument_list|(
name|ndev
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|ndev
argument_list|,
name|adapter_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vxge_drv_copyright
condition|)
block|{
name|device_printf
argument_list|(
name|ndev
argument_list|,
name|VXGE_COPYRIGHT
argument_list|)
expr_stmt|;
name|vxge_drv_copyright
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|vxge_dev_req_reboot
operator|==
literal|0
condition|)
block|{
name|vxge_pci_bd_no
operator|=
name|pci_bd_no
expr_stmt|;
name|err
operator|=
name|BUS_PROBE_DEFAULT
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pci_bd_no
operator|!=
name|vxge_pci_bd_no
condition|)
block|{
name|vxge_pci_bd_no
operator|=
name|pci_bd_no
expr_stmt|;
name|err
operator|=
name|BUS_PROBE_DEFAULT
expr_stmt|;
block|}
block|}
block|}
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_attach  * Connects driver to the system if probe was success @ndev handle  */
end_comment

begin_function
name|int
name|vxge_attach
parameter_list|(
name|device_t
name|ndev
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
decl_stmt|;
name|vxge_hal_device_t
modifier|*
name|hldev
init|=
name|NULL
decl_stmt|;
name|vxge_hal_device_attr_t
name|device_attr
decl_stmt|;
name|vxge_free_resources_e
name|error_level
init|=
name|VXGE_FREE_NONE
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
comment|/* Get per-ndev buffer */
name|vdev
operator|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|device_get_softc
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vdev
condition|)
goto|goto
name|_exit0
goto|;
name|bzero
argument_list|(
name|vdev
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_dev_t
argument_list|)
argument_list|)
expr_stmt|;
name|vdev
operator|->
name|ndev
operator|=
name|ndev
expr_stmt|;
name|strlcpy
argument_list|(
name|vdev
operator|->
name|ndev_name
argument_list|,
literal|"vxge"
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|ndev_name
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|vxge_driver_config
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
goto|goto
name|_exit0
goto|;
comment|/* Initialize HAL driver */
name|status
operator|=
name|vxge_driver_init
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Failed to initialize driver\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
comment|/* Enable PCI bus-master */
name|pci_enable_busmaster
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
comment|/* Allocate resources */
name|err
operator|=
name|vxge_alloc_resources
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"resource allocation failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|err
operator|=
name|vxge_device_hw_info_get
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_BAR2
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
comment|/* Get firmware default values for Device Configuration */
name|vxge_hal_device_config_default_get
argument_list|(
name|vdev
operator|->
name|device_config
argument_list|)
expr_stmt|;
comment|/* Customize Device Configuration based on User request */
name|vxge_vpath_config
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
comment|/* Allocate ISR resources */
name|err
operator|=
name|vxge_alloc_isr_resources
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_ISR_RESOURCE
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"isr resource allocation failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
comment|/* HAL attributes */
name|device_attr
operator|.
name|bar0
operator|=
operator|(
name|u8
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|bar_info
index|[
literal|0
index|]
expr_stmt|;
name|device_attr
operator|.
name|bar1
operator|=
operator|(
name|u8
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|bar_info
index|[
literal|1
index|]
expr_stmt|;
name|device_attr
operator|.
name|bar2
operator|=
operator|(
name|u8
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|bar_info
index|[
literal|2
index|]
expr_stmt|;
name|device_attr
operator|.
name|regh0
operator|=
operator|(
name|vxge_bus_res_t
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|reg_map
index|[
literal|0
index|]
expr_stmt|;
name|device_attr
operator|.
name|regh1
operator|=
operator|(
name|vxge_bus_res_t
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|reg_map
index|[
literal|1
index|]
expr_stmt|;
name|device_attr
operator|.
name|regh2
operator|=
operator|(
name|vxge_bus_res_t
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|reg_map
index|[
literal|2
index|]
expr_stmt|;
name|device_attr
operator|.
name|irqh
operator|=
operator|(
name|pci_irq_h
operator|)
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_handle
expr_stmt|;
name|device_attr
operator|.
name|cfgh
operator|=
name|vdev
operator|->
name|pdev
expr_stmt|;
name|device_attr
operator|.
name|pdev
operator|=
name|vdev
operator|->
name|pdev
expr_stmt|;
comment|/* Initialize HAL Device */
name|status
operator|=
name|vxge_hal_device_initialize
argument_list|(
operator|(
name|vxge_hal_device_h
operator|*
operator|)
operator|&
name|hldev
argument_list|,
operator|&
name|device_attr
argument_list|,
name|vdev
operator|->
name|device_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_ISR_RESOURCE
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"hal device initialization failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|devh
operator|=
name|hldev
expr_stmt|;
name|vxge_hal_device_private_set
argument_list|(
name|hldev
argument_list|,
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|err
operator|=
name|vxge_firmware_verify
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|vxge_dev_req_reboot
operator|=
literal|1
expr_stmt|;
name|error_level
operator|=
name|VXGE_FREE_TERMINATE_DEVICE
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
block|}
comment|/* Allocate memory for vpath */
name|vdev
operator|->
name|vpaths
operator|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
name|vdev
operator|->
name|no_of_vpath
operator|*
sizeof|sizeof
argument_list|(
name|vxge_vpath_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|vpaths
operator|==
name|NULL
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_TERMINATE_DEVICE
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"vpath memory allocation failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|no_of_func
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|vxge_hal_func_mode_count
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|function_mode
argument_list|,
operator|&
name|vdev
operator|->
name|no_of_func
argument_list|)
expr_stmt|;
name|vxge_bw_priority_config
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
comment|/* Initialize mutexes */
name|vxge_mutex_init
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
comment|/* Initialize Media */
name|vxge_media_init
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|err
operator|=
name|vxge_ifp_setup
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_MEDIA
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"setting up interface failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|err
operator|=
name|vxge_isr_setup
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_INTERFACE
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to associate interrupt handler with device\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vxge_device_hw_info_print
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|vdev
operator|->
name|is_active
operator|=
name|TRUE
expr_stmt|;
name|_exit0
label|:
if|if
condition|(
name|error_level
condition|)
block|{
name|vxge_free_resources
argument_list|(
name|ndev
argument_list|,
name|error_level
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENXIO
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_detach  * Detaches driver from the Kernel subsystem  */
end_comment

begin_function
name|int
name|vxge_detach
parameter_list|(
name|device_t
name|ndev
parameter_list|)
block|{
name|vxge_dev_t
modifier|*
name|vdev
decl_stmt|;
name|vdev
operator|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|device_get_softc
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_active
condition|)
block|{
name|vdev
operator|->
name|is_active
operator|=
name|FALSE
expr_stmt|;
name|vxge_stop
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|vxge_free_resources
argument_list|(
name|ndev
argument_list|,
name|VXGE_FREE_ALL
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_shutdown  * To shutdown device before system shutdown  */
end_comment

begin_function
name|int
name|vxge_shutdown
parameter_list|(
name|device_t
name|ndev
parameter_list|)
block|{
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|device_get_softc
argument_list|(
name|ndev
argument_list|)
decl_stmt|;
name|vxge_stop
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_init  * Initialize the interface  */
end_comment

begin_function
name|void
name|vxge_init
parameter_list|(
name|void
modifier|*
name|vdev_ptr
parameter_list|)
block|{
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|vdev_ptr
decl_stmt|;
name|VXGE_DRV_LOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|vxge_init_locked
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|VXGE_DRV_UNLOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_init_locked  * Initialize the interface  */
end_comment

begin_function
name|void
name|vxge_init_locked
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
init|=
name|EINVAL
decl_stmt|;
name|vxge_hal_device_t
modifier|*
name|hldev
init|=
name|vdev
operator|->
name|devh
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_hal_vpath_h
name|vpath_handle
decl_stmt|;
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
comment|/* If device is in running state, initializing is not required */
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
goto|goto
name|_exit0
goto|;
name|VXGE_DRV_LOCK_ASSERT
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
comment|/* Opening vpaths */
name|err
operator|=
name|vxge_vpath_open
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
goto|goto
name|_exit1
goto|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|rth_enable
condition|)
block|{
name|status
operator|=
name|vxge_rth_config
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
goto|goto
name|_exit1
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath_handle
operator|=
name|vxge_vpath_handle_get
argument_list|(
name|vdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vpath_handle
condition|)
continue|continue;
comment|/* check initial mtu before enabling the device */
name|status
operator|=
name|vxge_hal_device_mtu_check
argument_list|(
name|vpath_handle
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"invalid mtu size %ld specified\n"
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
goto|goto
name|_exit1
goto|;
block|}
name|status
operator|=
name|vxge_hal_vpath_mtu_set
argument_list|(
name|vpath_handle
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"setting mtu in device failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit1
goto|;
block|}
block|}
comment|/* Enable HAL device */
name|status
operator|=
name|vxge_hal_device_enable
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to enable device\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit1
goto|;
block|}
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_MSIX
condition|)
name|vxge_msix_enable
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
comment|/* Checksum capability */
name|ifp
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
condition|)
name|ifp
operator|->
name|if_hwassist
operator||=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO4
condition|)
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath_handle
operator|=
name|vxge_vpath_handle_get
argument_list|(
name|vdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vpath_handle
condition|)
continue|continue;
comment|/* Enabling mcast for all vpath */
name|vxge_hal_vpath_mcast_enable
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
comment|/* Enabling bcast for all vpath */
name|status
operator|=
name|vxge_hal_vpath_bcast_enable
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"can't enable bcast on vpath (%d)\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
comment|/* Enable interrupts */
name|vxge_hal_device_intr_enable
argument_list|(
name|vdev
operator|->
name|devh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath_handle
operator|=
name|vxge_vpath_handle_get
argument_list|(
name|vdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vpath_handle
condition|)
continue|continue;
name|bzero
argument_list|(
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|driver_stats
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_drv_stats_t
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|vxge_hal_vpath_enable
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
goto|goto
name|_exit2
goto|;
block|}
name|vxge_os_mdelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* Device is initialized */
name|vdev
operator|->
name|is_initialized
operator|=
name|TRUE
expr_stmt|;
comment|/* Now inform the stack we're ready */
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
goto|goto
name|_exit0
goto|;
name|_exit2
label|:
name|vxge_hal_device_intr_disable
argument_list|(
name|vdev
operator|->
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_device_disable
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|_exit1
label|:
name|vxge_vpath_close
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|_exit0
label|:
return|return;
block|}
end_function

begin_comment
comment|/*  * vxge_driver_init  * Initializes HAL driver  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_driver_init
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|vxge_hal_uld_cbs_t
name|uld_callbacks
decl_stmt|;
name|vxge_hal_driver_config_t
name|driver_config
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
comment|/* Initialize HAL driver */
if|if
condition|(
operator|!
name|vxge_dev_ref_count
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|uld_callbacks
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_uld_cbs_t
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|driver_config
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_driver_config_t
argument_list|)
argument_list|)
expr_stmt|;
name|uld_callbacks
operator|.
name|link_up
operator|=
name|vxge_link_up
expr_stmt|;
name|uld_callbacks
operator|.
name|link_down
operator|=
name|vxge_link_down
expr_stmt|;
name|uld_callbacks
operator|.
name|crit_err
operator|=
name|vxge_crit_error
expr_stmt|;
name|uld_callbacks
operator|.
name|sched_timer
operator|=
name|NULL
expr_stmt|;
name|uld_callbacks
operator|.
name|xpak_alarm_log
operator|=
name|NULL
expr_stmt|;
name|status
operator|=
name|vxge_hal_driver_initialize
argument_list|(
operator|&
name|driver_config
argument_list|,
operator|&
name|uld_callbacks
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to initialize driver\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
block|}
name|vxge_hal_driver_debug_set
argument_list|(
name|VXGE_TRACE
argument_list|)
expr_stmt|;
name|vxge_dev_ref_count
operator|++
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_driver_config  */
end_comment

begin_function
name|int
name|vxge_driver_config
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|char
name|temp_buffer
index|[
literal|30
index|]
decl_stmt|;
name|vxge_bw_info_t
name|bw_info
decl_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.no_of_vpath"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|no_of_vpath
argument_list|,
name|VXGE_DEFAULT_USER_HARDCODED
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|no_of_vpath
operator|==
name|VXGE_DEFAULT_USER_HARDCODED
condition|)
name|vdev
operator|->
name|config
operator|.
name|no_of_vpath
operator|=
name|mp_ncpus
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|no_of_vpath
operator|<=
literal|0
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Failed to load driver, \ 		    invalid config : \'no_of_vpath\'\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.intr_coalesce"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|intr_coalesce
argument_list|,
name|VXGE_DEFAULT_CONFIG_DISABLE
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.rth_enable"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|rth_enable
argument_list|,
name|VXGE_DEFAULT_CONFIG_ENABLE
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.rth_bkt_sz"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|rth_bkt_sz
argument_list|,
name|VXGE_DEFAULT_RTH_BUCKET_SIZE
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.lro_enable"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|lro_enable
argument_list|,
name|VXGE_DEFAULT_CONFIG_ENABLE
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.tso_enable"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|tso_enable
argument_list|,
name|VXGE_DEFAULT_CONFIG_ENABLE
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.tx_steering"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|tx_steering
argument_list|,
name|VXGE_DEFAULT_CONFIG_DISABLE
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.msix_enable"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|intr_mode
argument_list|,
name|VXGE_HAL_INTR_MODE_MSIX
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.ifqmaxlen"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|ifq_maxlen
argument_list|,
name|VXGE_DEFAULT_CONFIG_IFQ_MAXLEN
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.port_mode"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|port_mode
argument_list|,
name|VXGE_DEFAULT_CONFIG_VALUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|==
name|VXGE_DEFAULT_USER_HARDCODED
condition|)
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.l2_switch"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|l2_switch
argument_list|,
name|VXGE_DEFAULT_CONFIG_VALUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|l2_switch
operator|==
name|VXGE_DEFAULT_USER_HARDCODED
condition|)
name|vdev
operator|->
name|config
operator|.
name|l2_switch
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.fw_upgrade"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|fw_option
argument_list|,
name|VXGE_FW_UPGRADE_ALL
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.low_latency"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|low_latency
argument_list|,
name|VXGE_DEFAULT_CONFIG_DISABLE
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
literal|"hint.vxge.0.func_mode"
argument_list|,
name|vdev
operator|->
name|config
argument_list|,
name|function_mode
argument_list|,
name|VXGE_DEFAULT_CONFIG_VALUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|function_mode
operator|==
name|VXGE_DEFAULT_USER_HARDCODED
condition|)
name|vdev
operator|->
name|config
operator|.
name|function_mode
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|is_multi_func
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|function_mode
argument_list|)
operator|||
name|is_single_func
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|function_mode
argument_list|)
operator|)
condition|)
name|vdev
operator|->
name|config
operator|.
name|function_mode
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_FUNCTIONS
condition|;
name|i
operator|++
control|)
block|{
name|bw_info
operator|.
name|func_id
operator|=
name|i
expr_stmt|;
name|sprintf
argument_list|(
name|temp_buffer
argument_list|,
literal|"hint.vxge.0.bandwidth_%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
name|temp_buffer
argument_list|,
name|bw_info
argument_list|,
name|bandwidth
argument_list|,
name|VXGE_DEFAULT_USER_HARDCODED
argument_list|)
expr_stmt|;
if|if
condition|(
name|bw_info
operator|.
name|bandwidth
operator|==
name|VXGE_DEFAULT_USER_HARDCODED
condition|)
name|bw_info
operator|.
name|bandwidth
operator|=
name|VXGE_HAL_VPATH_BW_LIMIT_DEFAULT
expr_stmt|;
name|sprintf
argument_list|(
name|temp_buffer
argument_list|,
literal|"hint.vxge.0.priority_%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|VXGE_GET_PARAM
argument_list|(
name|temp_buffer
argument_list|,
name|bw_info
argument_list|,
name|priority
argument_list|,
name|VXGE_DEFAULT_USER_HARDCODED
argument_list|)
expr_stmt|;
if|if
condition|(
name|bw_info
operator|.
name|priority
operator|==
name|VXGE_DEFAULT_USER_HARDCODED
condition|)
name|bw_info
operator|.
name|priority
operator|=
name|VXGE_HAL_VPATH_PRIORITY_DEFAULT
expr_stmt|;
name|vxge_os_memcpy
argument_list|(
operator|&
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|i
index|]
argument_list|,
operator|&
name|bw_info
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_bw_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_stop  */
end_comment

begin_function
name|void
name|vxge_stop
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|VXGE_DRV_LOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|vxge_stop_locked
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|VXGE_DRV_UNLOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_stop_locked  * Common code for both stop and part of reset.  * disables device, interrupts and closes vpaths handle  */
end_comment

begin_function
name|void
name|vxge_stop_locked
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|u64
name|adapter_status
init|=
literal|0
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|vxge_hal_device_t
modifier|*
name|hldev
init|=
name|vdev
operator|->
name|devh
decl_stmt|;
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
name|VXGE_DRV_LOCK_ASSERT
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
comment|/* If device is not in "Running" state, return */
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
comment|/* Set appropriate flags */
name|vdev
operator|->
name|is_initialized
operator|=
name|FALSE
expr_stmt|;
name|hldev
operator|->
name|link_state
operator|=
name|VXGE_HAL_LINK_NONE
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
comment|/* Disable interrupts */
name|vxge_hal_device_intr_disable
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
comment|/* Disable HAL device */
name|status
operator|=
name|vxge_hal_device_disable
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_device_status
argument_list|(
name|hldev
argument_list|,
operator|&
name|adapter_status
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"adapter status: 0x%llx\n"
argument_list|,
name|adapter_status
argument_list|)
expr_stmt|;
block|}
comment|/* reset vpaths */
name|vxge_vpath_reset
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|vxge_os_mdelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* Close Vpaths */
name|vxge_vpath_close
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vxge_send
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|)
block|{
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
literal|0
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
name|VXGE_TX_TRYLOCK
argument_list|(
name|vpath
argument_list|)
condition|)
block|{
name|vxge_send_locked
argument_list|(
name|ifp
argument_list|,
name|vpath
argument_list|)
expr_stmt|;
name|VXGE_TX_UNLOCK
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|vxge_send_locked
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|,
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|)
block|{
name|mbuf_t
name|m_head
init|=
name|NULL
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|VXGE_TX_LOCK_ASSERT
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|vdev
operator|->
name|is_initialized
operator|)
operator|||
operator|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
operator|)
condition|)
return|return;
while|while
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
block|{
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|vxge_xmit
argument_list|(
name|ifp
argument_list|,
name|vpath
argument_list|,
operator|&
name|m_head
argument_list|)
condition|)
block|{
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
break|break;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_again
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Send a copy of the frame to the BPF listener */
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
end_if

begin_function
name|int
name|vxge_mq_send
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|,
name|mbuf_t
name|m_head
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|tx_steering
condition|)
block|{
name|i
operator|=
name|vxge_vpath_get
argument_list|(
name|vdev
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|M_HASHTYPE_GET
argument_list|(
name|m_head
argument_list|)
operator|!=
name|M_HASHTYPE_NONE
condition|)
block|{
name|i
operator|=
name|m_head
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|%
name|vdev
operator|->
name|no_of_vpath
expr_stmt|;
block|}
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|VXGE_TX_TRYLOCK
argument_list|(
name|vpath
argument_list|)
condition|)
block|{
name|err
operator|=
name|vxge_mq_send_locked
argument_list|(
name|ifp
argument_list|,
name|vpath
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
name|VXGE_TX_UNLOCK
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
block|}
else|else
name|err
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|vxge_mq_send_locked
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|,
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|,
name|mbuf_t
name|m_head
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|mbuf_t
name|next
init|=
name|NULL
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|VXGE_TX_LOCK_ASSERT
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|vdev
operator|->
name|is_initialized
operator|)
operator|||
operator|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|err
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
block|{
name|next
operator|=
name|drbr_dequeue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|drbr_needs_enqueue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|err
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|,
name|m_head
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|_exit0
goto|;
name|next
operator|=
name|drbr_dequeue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|)
expr_stmt|;
block|}
else|else
name|next
operator|=
name|m_head
expr_stmt|;
comment|/* Process the queue */
while|while
condition|(
name|next
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|err
operator|=
name|vxge_xmit
argument_list|(
name|ifp
argument_list|,
name|vpath
argument_list|,
operator|&
name|next
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|next
operator|==
name|NULL
condition|)
break|break;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|err
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_again
argument_list|)
expr_stmt|;
break|break;
block|}
name|ifp
operator|->
name|if_obytes
operator|+=
name|next
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|next
operator|->
name|m_flags
operator|&
name|M_MCAST
condition|)
name|ifp
operator|->
name|if_omcasts
operator|++
expr_stmt|;
comment|/* Send a copy of the frame to the BPF listener */
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|next
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
break|break;
name|next
operator|=
name|drbr_dequeue
argument_list|(
name|ifp
argument_list|,
name|vpath
operator|->
name|br
argument_list|)
expr_stmt|;
block|}
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|vxge_mq_qflush
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|mbuf_t
name|m_head
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|vpath
operator|->
name|handle
condition|)
continue|continue;
name|VXGE_TX_LOCK
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m_head
operator|=
name|buf_ring_dequeue_sc
argument_list|(
name|vpath
operator|->
name|br
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|vxge_free_packet
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
name|VXGE_TX_UNLOCK
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
block|}
name|if_qflush
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
specifier|inline
name|int
name|vxge_xmit
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|,
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|,
name|mbuf_t
modifier|*
name|m_headp
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|num_segs
init|=
literal|0
decl_stmt|;
name|u32
name|txdl_avail
decl_stmt|,
name|dma_index
decl_stmt|,
name|tagged
init|=
literal|0
decl_stmt|;
name|dma_addr_t
name|dma_addr
decl_stmt|;
name|bus_size_t
name|dma_sizes
decl_stmt|;
name|void
modifier|*
name|dtr_priv
decl_stmt|;
name|vxge_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_hal_txdl_h
name|txdlh
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_xmit
argument_list|)
expr_stmt|;
name|txdl_avail
operator|=
name|vxge_hal_fifo_free_txdl_count_get
argument_list|(
name|vpath
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_avail
operator|<
name|VXGE_TX_LOW_THRESHOLD
condition|)
block|{
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_low_dtr_cnt
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
comment|/* Reserve descriptors */
name|status
operator|=
name|vxge_hal_fifo_txdl_reserve
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
operator|&
name|txdlh
argument_list|,
operator|&
name|dtr_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_reserve_failed
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
comment|/* Update Tx private structure for this descriptor */
name|txdl_priv
operator|=
operator|(
name|vxge_txdl_priv_t
operator|*
operator|)
name|dtr_priv
expr_stmt|;
comment|/* 	 * Map the packet for DMA. 	 * Returns number of segments through num_segs. 	 */
name|err
operator|=
name|vxge_dma_mbuf_coalesce
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|,
name|txdl_priv
operator|->
name|dma_map
argument_list|,
name|m_headp
argument_list|,
name|txdl_priv
operator|->
name|dma_buffers
argument_list|,
operator|&
name|num_segs
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|driver_stats
operator|.
name|tx_max_frags
operator|<
name|num_segs
condition|)
name|vpath
operator|->
name|driver_stats
operator|.
name|tx_max_frags
operator|=
name|num_segs
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ENOMEM
condition|)
block|{
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_no_dma_setup
argument_list|)
expr_stmt|;
name|vxge_hal_fifo_txdl_free
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
elseif|else
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|vxge_free_packet
argument_list|(
operator|*
name|m_headp
argument_list|)
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_no_dma_setup
argument_list|)
expr_stmt|;
name|vxge_hal_fifo_txdl_free
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|txdl_priv
operator|->
name|mbuf_pkt
operator|=
operator|*
name|m_headp
expr_stmt|;
comment|/* Set VLAN tag in descriptor only if this packet has it */
if|if
condition|(
operator|(
operator|*
name|m_headp
operator|)
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
name|vxge_hal_fifo_txdl_vlan_set
argument_list|(
name|txdlh
argument_list|,
operator|(
operator|*
name|m_headp
operator|)
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
argument_list|)
expr_stmt|;
comment|/* Set descriptor buffer for header and each fragment/segment */
for|for
control|(
name|dma_index
operator|=
literal|0
init|;
name|dma_index
operator|<
name|num_segs
condition|;
name|dma_index
operator|++
control|)
block|{
name|dma_sizes
operator|=
name|txdl_priv
operator|->
name|dma_buffers
index|[
name|dma_index
index|]
operator|.
name|ds_len
expr_stmt|;
name|dma_addr
operator|=
name|htole64
argument_list|(
name|txdl_priv
operator|->
name|dma_buffers
index|[
name|dma_index
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|vxge_hal_fifo_txdl_buffer_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|txdlh
argument_list|,
name|dma_index
argument_list|,
name|dma_addr
argument_list|,
name|dma_sizes
argument_list|)
expr_stmt|;
block|}
comment|/* Pre-write Sync of mapping */
name|bus_dmamap_sync
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|,
name|txdl_priv
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|m_headp
operator|)
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|m_headp
operator|)
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
condition|)
block|{
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_tso
argument_list|)
expr_stmt|;
name|vxge_hal_fifo_txdl_lso_set
argument_list|(
name|txdlh
argument_list|,
name|VXGE_HAL_FIFO_LSO_FRM_ENCAP_AUTO
argument_list|,
operator|(
operator|*
name|m_headp
operator|)
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Checksum */
if|if
condition|(
name|ifp
operator|->
name|if_hwassist
operator|>
literal|0
condition|)
block|{
name|vxge_hal_fifo_txdl_cksum_set_bits
argument_list|(
name|txdlh
argument_list|,
name|VXGE_HAL_FIFO_TXD_TX_CKO_IPV4_EN
operator||
name|VXGE_HAL_FIFO_TXD_TX_CKO_TCP_EN
operator||
name|VXGE_HAL_FIFO_TXD_TX_CKO_UDP_EN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|vxge_hal_device_check_id
argument_list|(
name|vdev
operator|->
name|devh
argument_list|)
operator|==
name|VXGE_HAL_CARD_TITAN_1A
operator|)
operator|&&
operator|(
name|vdev
operator|->
name|hw_fw_version
operator|>=
name|VXGE_FW_VERSION
argument_list|(
literal|1
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
name|tagged
operator|=
literal|1
expr_stmt|;
name|vxge_hal_fifo_txdl_post
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|txdlh
argument_list|,
name|tagged
argument_list|)
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_posted
argument_list|)
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_tx_replenish  * Allocate buffers and set them into descriptors for later use  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_tx_replenish
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|,
name|u32
name|dtr_index
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|,
name|vxge_hal_reopen_e
name|reopen
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_txdl_priv_t
modifier|*
name|txdl_priv
init|=
operator|(
name|vxge_txdl_priv_t
operator|*
operator|)
name|dtr_priv
decl_stmt|;
name|err
operator|=
name|bus_dmamap_create
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|txdl_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|err
operator|==
literal|0
operator|)
condition|?
name|VXGE_HAL_OK
else|:
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_tx_compl  * If the interrupt is due to Tx completion, free the sent buffer  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_tx_compl
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|,
name|vxge_hal_fifo_tcode_e
name|t_code
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
name|VXGE_TX_LOCK
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
comment|/* 	 * For each completed descriptor 	 * Get private structure, free buffer, do unmapping, and free descriptor 	 */
do|do
block|{
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_compl
argument_list|)
expr_stmt|;
if|if
condition|(
name|t_code
operator|!=
name|VXGE_HAL_FIFO_T_CODE_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"tx transfer code %d\n"
argument_list|,
name|t_code
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|tx_tcode
argument_list|)
expr_stmt|;
name|vxge_hal_fifo_handle_tcode
argument_list|(
name|vpath_handle
argument_list|,
name|txdlh
argument_list|,
name|t_code
argument_list|)
expr_stmt|;
block|}
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
name|txdl_priv
operator|=
operator|(
name|vxge_txdl_priv_t
operator|*
operator|)
name|dtr_priv
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|,
name|txdl_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|vxge_free_packet
argument_list|(
name|txdl_priv
operator|->
name|mbuf_pkt
argument_list|)
expr_stmt|;
name|vxge_hal_fifo_txdl_free
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|vxge_hal_fifo_txdl_next_completed
argument_list|(
name|vpath_handle
argument_list|,
operator|&
name|txdlh
argument_list|,
operator|&
name|dtr_priv
argument_list|,
operator|&
name|t_code
argument_list|)
operator|==
name|VXGE_HAL_OK
condition|)
do|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|VXGE_TX_UNLOCK
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|void
name|vxge_tx_term
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|,
name|vxge_hal_txdl_state_e
name|state
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|,
name|vxge_hal_reopen_e
name|reopen
parameter_list|)
block|{
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_txdl_priv_t
modifier|*
name|txdl_priv
init|=
operator|(
name|vxge_txdl_priv_t
operator|*
operator|)
name|dtr_priv
decl_stmt|;
if|if
condition|(
name|state
operator|!=
name|VXGE_HAL_TXDL_STATE_POSTED
condition|)
return|return;
if|if
condition|(
name|txdl_priv
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|,
name|txdl_priv
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|,
name|txdl_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|,
name|txdl_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|vxge_free_packet
argument_list|(
name|txdl_priv
operator|->
name|mbuf_pkt
argument_list|)
expr_stmt|;
block|}
comment|/* Free the descriptor */
name|vxge_hal_fifo_txdl_free
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_rx_replenish  * Allocate buffers and set them into descriptors for later use  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_rx_replenish
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|,
name|u32
name|dtr_index
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|,
name|vxge_hal_reopen_e
name|reopen
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_rxd_priv_t
modifier|*
name|rxd_priv
init|=
operator|(
name|vxge_rxd_priv_t
operator|*
operator|)
name|dtr_priv
decl_stmt|;
comment|/* Create DMA map for these descriptors */
name|err
operator|=
name|bus_dmamap_create
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|rxd_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|vxge_rx_rxd_1b_set
argument_list|(
name|vpath
argument_list|,
name|rxdh
argument_list|,
name|dtr_priv
argument_list|)
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_FAIL
expr_stmt|;
block|}
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_rx_compl  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_rx_compl
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|,
name|u8
name|t_code
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|mbuf_t
name|mbuf_up
decl_stmt|;
name|vxge_rxd_priv_t
modifier|*
name|rxd_priv
decl_stmt|;
name|vxge_hal_ring_rxd_info_t
name|ext_info
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|struct
name|lro_entry
modifier|*
name|queued
init|=
name|NULL
decl_stmt|;
name|struct
name|lro_ctrl
modifier|*
name|lro
init|=
operator|&
name|vpath
operator|->
name|lro
decl_stmt|;
comment|/* get the interface pointer */
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
do|do
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|vxge_hal_ring_rxd_post
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_FAIL
expr_stmt|;
break|break;
block|}
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|rx_compl
argument_list|)
expr_stmt|;
name|rxd_priv
operator|=
operator|(
name|vxge_rxd_priv_t
operator|*
operator|)
name|dtr_priv
expr_stmt|;
comment|/* Gets details of mbuf i.e., packet length */
name|vxge_rx_rxd_1b_get
argument_list|(
name|vpath
argument_list|,
name|rxdh
argument_list|,
name|dtr_priv
argument_list|)
expr_stmt|;
comment|/* 		 * Prepare one buffer to send it to upper layer Since upper 		 * layer frees the buffer do not use rxd_priv->mbuf_pkt. 		 * Meanwhile prepare a new buffer, do mapping, use with the 		 * current descriptor and post descriptor back to ring vpath 		 */
name|mbuf_up
operator|=
name|rxd_priv
operator|->
name|mbuf_pkt
expr_stmt|;
if|if
condition|(
name|t_code
operator|!=
name|VXGE_HAL_RING_RXD_T_CODE_OK
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|rx_tcode
argument_list|)
expr_stmt|;
name|status
operator|=
name|vxge_hal_ring_handle_tcode
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|,
name|t_code
argument_list|)
expr_stmt|;
comment|/* 			 * If transfer code is not for unknown protocols and 			 * vxge_hal_device_handle_tcode is NOT returned 			 * VXGE_HAL_OK 			 * drop this packet and increment rx_tcode stats 			 */
if|if
condition|(
operator|(
name|status
operator|!=
name|VXGE_HAL_OK
operator|)
operator|&&
operator|(
name|t_code
operator|!=
name|VXGE_HAL_RING_T_CODE_L3_PKT_ERR
operator|)
condition|)
block|{
name|vxge_free_packet
argument_list|(
name|mbuf_up
argument_list|)
expr_stmt|;
name|vxge_hal_ring_rxd_post
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|vxge_rx_rxd_1b_set
argument_list|(
name|vpath
argument_list|,
name|rxdh
argument_list|,
name|dtr_priv
argument_list|)
condition|)
block|{
comment|/* 			 * If unable to allocate buffer, post descriptor back 			 * to vpath for future processing of same packet. 			 */
name|vxge_hal_ring_rxd_post
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* Get the extended information */
name|vxge_hal_ring_rxd_1b_info_get
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|,
operator|&
name|ext_info
argument_list|)
expr_stmt|;
comment|/* post descriptor with newly allocated mbuf back to vpath */
name|vxge_hal_ring_rxd_post
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
name|vpath
operator|->
name|rxd_posted
operator|++
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|rxd_posted
operator|%
name|VXGE_RXD_REPLENISH_COUNT
operator|==
literal|0
condition|)
name|vxge_hal_ring_rxd_post_post_db
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
comment|/* 		 * Set successfully computed checksums in the mbuf. 		 * Leave the rest to the stack to be reverified. 		 */
name|vxge_rx_checksum
argument_list|(
name|ext_info
argument_list|,
name|mbuf_up
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
name|M_HASHTYPE_SET
argument_list|(
name|mbuf_up
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
name|mbuf_up
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|vpath
operator|->
name|vp_index
expr_stmt|;
endif|#
directive|endif
comment|/* Post-Read sync for buffers */
name|bus_dmamap_sync
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|vxge_rx_input
argument_list|(
name|ifp
argument_list|,
name|mbuf_up
argument_list|,
name|vpath
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|vxge_hal_ring_rxd_next_completed
argument_list|(
name|vpath_handle
argument_list|,
operator|&
name|rxdh
argument_list|,
operator|&
name|dtr_priv
argument_list|,
operator|&
name|t_code
argument_list|)
operator|==
name|VXGE_HAL_OK
condition|)
do|;
comment|/* Flush any outstanding LRO work */
if|if
condition|(
name|vpath
operator|->
name|lro_enable
operator|&&
name|vpath
operator|->
name|lro
operator|.
name|lro_cnt
condition|)
block|{
while|while
condition|(
operator|(
name|queued
operator|=
name|SLIST_FIRST
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|SLIST_REMOVE_HEAD
argument_list|(
operator|&
name|lro
operator|->
name|lro_active
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|tcp_lro_flush
argument_list|(
name|lro
argument_list|,
name|queued
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|vxge_rx_input
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|,
name|mbuf_t
name|mbuf_up
parameter_list|,
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|)
block|{
if|if
condition|(
name|vpath
operator|->
name|lro_enable
operator|&&
name|vpath
operator|->
name|lro
operator|.
name|lro_cnt
condition|)
block|{
if|if
condition|(
name|tcp_lro_rx
argument_list|(
operator|&
name|vpath
operator|->
name|lro
argument_list|,
name|mbuf_up
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
return|return;
block|}
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|mbuf_up
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|vxge_rx_checksum
parameter_list|(
name|vxge_hal_ring_rxd_info_t
name|ext_info
parameter_list|,
name|mbuf_t
name|mbuf_up
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|ext_info
operator|.
name|proto
operator|&
name|VXGE_HAL_FRAME_PROTO_IP_FRAG
operator|)
operator|&&
operator|(
name|ext_info
operator|.
name|proto
operator|&
name|VXGE_HAL_FRAME_PROTO_TCP_OR_UDP
operator|)
operator|&&
name|ext_info
operator|.
name|l3_cksum_valid
operator|&&
name|ext_info
operator|.
name|l4_cksum_valid
condition|)
block|{
name|mbuf_up
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
name|htons
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
name|mbuf_up
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_IP_CHECKED
expr_stmt|;
name|mbuf_up
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_VALID
expr_stmt|;
name|mbuf_up
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
operator|(
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
operator|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ext_info
operator|.
name|vlan
condition|)
block|{
name|mbuf_up
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|ext_info
operator|.
name|vlan
expr_stmt|;
name|mbuf_up
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_rx_term During unload terminate and free all descriptors  * @vpath_handle Rx vpath Handle @rxdh Rx Descriptor Handle @state Descriptor  * State @userdata Per-adapter Data @reopen vpath open/reopen option  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|void
name|vxge_rx_term
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|,
name|vxge_hal_rxd_state_e
name|state
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|,
name|vxge_hal_reopen_e
name|reopen
parameter_list|)
block|{
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_rxd_priv_t
modifier|*
name|rxd_priv
init|=
operator|(
name|vxge_rxd_priv_t
operator|*
operator|)
name|dtr_priv
decl_stmt|;
if|if
condition|(
name|state
operator|!=
name|VXGE_HAL_RXD_STATE_POSTED
condition|)
return|return;
if|if
condition|(
name|rxd_priv
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dmamap_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|vxge_free_packet
argument_list|(
name|rxd_priv
operator|->
name|mbuf_pkt
argument_list|)
expr_stmt|;
block|}
comment|/* Free the descriptor */
name|vxge_hal_ring_rxd_free
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_rx_rxd_1b_get  * Get descriptors of packet to send up  */
end_comment

begin_function
name|void
name|vxge_rx_rxd_1b_get
parameter_list|(
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|)
block|{
name|vxge_rxd_priv_t
modifier|*
name|rxd_priv
init|=
operator|(
name|vxge_rxd_priv_t
operator|*
operator|)
name|dtr_priv
decl_stmt|;
name|mbuf_t
name|mbuf_up
init|=
name|rxd_priv
operator|->
name|mbuf_pkt
decl_stmt|;
comment|/* Retrieve data from completed descriptor */
name|vxge_hal_ring_rxd_1b_get
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|rxdh
argument_list|,
operator|&
name|rxd_priv
operator|->
name|dma_addr
index|[
literal|0
index|]
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|&
name|rxd_priv
operator|->
name|dma_sizes
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* Update newly created buffer to be sent up with packet length */
name|mbuf_up
operator|->
name|m_len
operator|=
name|rxd_priv
operator|->
name|dma_sizes
index|[
literal|0
index|]
expr_stmt|;
name|mbuf_up
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|rxd_priv
operator|->
name|dma_sizes
index|[
literal|0
index|]
expr_stmt|;
name|mbuf_up
operator|->
name|m_next
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_rx_rxd_1b_set  * Allocates new mbufs to be placed into descriptors  */
end_comment

begin_function
name|int
name|vxge_rx_rxd_1b_set
parameter_list|(
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|,
name|void
modifier|*
name|dtr_priv
parameter_list|)
block|{
name|int
name|num_segs
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|mbuf_t
name|mbuf_pkt
decl_stmt|;
name|bus_dmamap_t
name|dma_map
decl_stmt|;
name|bus_dma_segment_t
name|dma_buffers
index|[
literal|1
index|]
decl_stmt|;
name|vxge_rxd_priv_t
modifier|*
name|rxd_priv
init|=
operator|(
name|vxge_rxd_priv_t
operator|*
operator|)
name|dtr_priv
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|mbuf_pkt
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|vdev
operator|->
name|rx_mbuf_sz
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mbuf_pkt
condition|)
block|{
name|err
operator|=
name|ENOBUFS
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|rx_no_buf
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"out of memory to allocate mbuf\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
comment|/* Update mbuf's length, packet length and receive interface */
name|mbuf_pkt
operator|->
name|m_len
operator|=
name|vdev
operator|->
name|rx_mbuf_sz
expr_stmt|;
name|mbuf_pkt
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|vdev
operator|->
name|rx_mbuf_sz
expr_stmt|;
name|mbuf_pkt
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|vdev
operator|->
name|ifp
expr_stmt|;
comment|/* Load DMA map */
name|err
operator|=
name|vxge_dma_mbuf_coalesce
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|vpath
operator|->
name|extra_dma_map
argument_list|,
operator|&
name|mbuf_pkt
argument_list|,
name|dma_buffers
argument_list|,
operator|&
name|num_segs
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|rx_map_fail
argument_list|)
expr_stmt|;
name|vxge_free_packet
argument_list|(
name|mbuf_pkt
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
comment|/* Unload DMA map of mbuf in current descriptor */
name|bus_dmamap_sync
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|)
expr_stmt|;
comment|/* Update descriptor private data */
name|dma_map
operator|=
name|rxd_priv
operator|->
name|dma_map
expr_stmt|;
name|rxd_priv
operator|->
name|mbuf_pkt
operator|=
name|mbuf_pkt
expr_stmt|;
name|rxd_priv
operator|->
name|dma_addr
index|[
literal|0
index|]
operator|=
name|htole64
argument_list|(
name|dma_buffers
operator|->
name|ds_addr
argument_list|)
expr_stmt|;
name|rxd_priv
operator|->
name|dma_map
operator|=
name|vpath
operator|->
name|extra_dma_map
expr_stmt|;
name|vpath
operator|->
name|extra_dma_map
operator|=
name|dma_map
expr_stmt|;
comment|/* Pre-Read/Write sync */
name|bus_dmamap_sync
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|rxd_priv
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Set descriptor buffer */
name|vxge_hal_ring_rxd_1b_set
argument_list|(
name|rxdh
argument_list|,
name|rxd_priv
operator|->
name|dma_addr
index|[
literal|0
index|]
argument_list|,
name|vdev
operator|->
name|rx_mbuf_sz
argument_list|)
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_link_up  * Callback for Link-up indication from HAL  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|void
name|vxge_link_up
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_hal_device_hw_info_t
modifier|*
name|hw_info
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|hw_info
operator|=
operator|&
name|vdev
operator|->
name|config
operator|.
name|hw_info
expr_stmt|;
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_MSIX
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
name|vxge_hal_vpath_tti_ci_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|)
expr_stmt|;
name|vxge_hal_vpath_rti_ci_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
operator|&&
operator|(
name|hw_info
operator|->
name|ports
operator|>
literal|1
operator|)
condition|)
block|{
name|vxge_active_port_update
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Active Port : %lld\n"
argument_list|,
name|vdev
operator|->
name|active_port
argument_list|)
expr_stmt|;
block|}
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_link_down  * Callback for Link-down indication from HAL  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|void
name|vxge_link_down
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_MSIX
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
name|vxge_hal_vpath_tti_ci_reset
argument_list|(
name|vpath
operator|->
name|handle
argument_list|)
expr_stmt|;
name|vxge_hal_vpath_rti_ci_reset
argument_list|(
name|vpath
operator|->
name|handle
argument_list|)
expr_stmt|;
block|}
block|}
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_reset  */
end_comment

begin_function
name|void
name|vxge_reset
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|vdev
operator|->
name|is_initialized
condition|)
return|return;
name|VXGE_DRV_LOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|vxge_stop_locked
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|vxge_init_locked
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|VXGE_DRV_UNLOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_crit_error  * Callback for Critical error indication from HAL  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|void
name|vxge_crit_error
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|,
name|vxge_hal_event_e
name|type
parameter_list|,
name|u64
name|serr_data
parameter_list|)
block|{
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|VXGE_HAL_EVENT_SERR
case|:
case|case
name|VXGE_HAL_EVENT_KDFCCTL
case|:
case|case
name|VXGE_HAL_EVENT_CRITICAL
case|:
name|vxge_hal_device_intr_disable
argument_list|(
name|vdev
operator|->
name|devh
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_ifp_setup  */
end_comment

begin_function
name|int
name|vxge_ifp_setup
parameter_list|(
name|device_t
name|ndev
parameter_list|)
block|{
name|ifnet_t
name|ifp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|device_get_softc
argument_list|(
name|ndev
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|bVAL1
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|vpath_mask
argument_list|,
name|i
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|j
operator|>=
name|vdev
operator|->
name|no_of_vpath
condition|)
break|break;
name|vdev
operator|->
name|vpaths
index|[
name|j
index|]
operator|.
name|vp_id
operator|=
name|i
expr_stmt|;
name|vdev
operator|->
name|vpaths
index|[
name|j
index|]
operator|.
name|vp_index
operator|=
name|j
expr_stmt|;
name|vdev
operator|->
name|vpaths
index|[
name|j
index|]
operator|.
name|vdev
operator|=
name|vdev
expr_stmt|;
name|vdev
operator|->
name|vpaths
index|[
name|j
index|]
operator|.
name|is_configured
operator|=
name|TRUE
expr_stmt|;
name|vxge_os_memcpy
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|vdev
operator|->
name|vpaths
index|[
name|j
index|]
operator|.
name|mac_addr
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|mac_addrs
index|[
name|i
index|]
operator|)
argument_list|,
operator|(
name|size_t
operator|)
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
comment|/* Get interface ifnet structure for this Ether device */
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"memory allocation for ifnet failed\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|ifp
operator|=
name|ifp
expr_stmt|;
comment|/* Initialize interface ifnet structure */
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|ndev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|ndev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
name|VXGE_BAUDRATE
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|vxge_init
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|vdev
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|vxge_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|vxge_send
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
name|ifp
operator|->
name|if_transmit
operator|=
name|vxge_mq_send
expr_stmt|;
name|ifp
operator|->
name|if_qflush
operator|=
name|vxge_mq_qflush
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|max
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|ifq_maxlen
argument_list|,
name|ifqmaxlen
argument_list|)
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
argument_list|)
expr_stmt|;
comment|/* IFQ_SET_READY(&ifp->if_snd); */
name|ifp
operator|->
name|if_data
operator|.
name|ifi_hdrlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
operator||
name|IFCAP_VLAN_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTAGGING
operator||
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_JUMBO_MTU
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|tso_enable
condition|)
name|vxge_tso_config
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|lro_enable
condition|)
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_LRO
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|strlcpy
argument_list|(
name|vdev
operator|->
name|ndev_name
argument_list|,
name|device_get_nameunit
argument_list|(
name|ndev
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|ndev_name
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Attach the interface */
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|vdev
operator|->
name|vpaths
index|[
literal|0
index|]
operator|.
name|mac_addr
argument_list|)
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_isr_setup  * Register isr functions  */
end_comment

begin_function
name|int
name|vxge_isr_setup
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|irq_rid
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|void
modifier|*
name|isr_func_arg
decl_stmt|;
name|void
function_decl|(
modifier|*
name|isr_func_ptr
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
switch|switch
condition|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
condition|)
block|{
case|case
name|VXGE_HAL_INTR_MODE_IRQLINE
case|:
name|err
operator|=
name|bus_setup_intr
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_res
argument_list|,
operator|(
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
operator|)
argument_list|,
name|vxge_isr_filter
argument_list|,
name|vxge_isr_line
argument_list|,
name|vdev
argument_list|,
operator|&
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_handle
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_INTR_MODE_MSIX
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|intr_count
condition|;
name|i
operator|++
control|)
block|{
name|irq_rid
operator|=
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_rid
expr_stmt|;
name|vpath
operator|=
operator|&
name|vdev
operator|->
name|vpaths
index|[
name|irq_rid
operator|/
literal|4
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|irq_rid
operator|%
literal|4
operator|)
operator|==
literal|2
condition|)
block|{
name|isr_func_ptr
operator|=
name|vxge_isr_msix
expr_stmt|;
name|isr_func_arg
operator|=
operator|(
name|void
operator|*
operator|)
name|vpath
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|irq_rid
operator|%
literal|4
operator|)
operator|==
literal|3
condition|)
block|{
name|isr_func_ptr
operator|=
name|vxge_isr_msix_alarm
expr_stmt|;
name|isr_func_arg
operator|=
operator|(
name|void
operator|*
operator|)
name|vpath
expr_stmt|;
block|}
else|else
break|break;
name|err
operator|=
name|bus_setup_intr
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_res
argument_list|,
operator|(
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
operator|)
argument_list|,
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|isr_func_ptr
argument_list|,
operator|(
name|void
operator|*
operator|)
name|isr_func_arg
argument_list|,
operator|&
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
comment|/* Teardown interrupt handler */
while|while
condition|(
operator|--
name|i
operator|>
literal|0
condition|)
name|bus_teardown_intr
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_res
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_handle
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_isr_filter  * ISR filter function - filter interrupts from other shared devices  */
end_comment

begin_function
name|int
name|vxge_isr_filter
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|)
block|{
name|u64
name|val64
init|=
literal|0
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vdev
operator|->
name|devh
decl_stmt|;
name|vxge_hal_common_reg_t
modifier|*
name|common_reg
init|=
operator|(
name|vxge_hal_common_reg_t
operator|*
operator|)
operator|(
name|hldev
operator|->
name|common_reg
operator|)
decl_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|vdev
operator|->
name|pdev
argument_list|,
operator|(
name|vdev
operator|->
name|devh
operator|)
operator|->
name|regh0
argument_list|,
operator|&
name|common_reg
operator|->
name|titan_general_int_status
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|val64
operator|)
condition|?
name|FILTER_SCHEDULE_THREAD
else|:
name|FILTER_STRAY
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_isr_line  * Interrupt service routine for Line interrupts  */
end_comment

begin_function
name|void
name|vxge_isr_line
parameter_list|(
name|void
modifier|*
name|vdev_ptr
parameter_list|)
block|{
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|vdev_ptr
decl_stmt|;
name|vxge_hal_device_handle_irq
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vxge_isr_msix
parameter_list|(
name|void
modifier|*
name|vpath_ptr
parameter_list|)
block|{
name|u32
name|got_rx
init|=
literal|0
decl_stmt|;
name|u32
name|got_tx
init|=
literal|0
decl_stmt|;
name|__hal_virtualpath_t
modifier|*
name|hal_vpath
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|vpath_ptr
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|hal_vpath
operator|=
operator|(
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath
operator|->
name|handle
operator|)
operator|->
name|vpath
expr_stmt|;
name|VXGE_DRV_STATS
argument_list|(
name|vpath
argument_list|,
name|isr_msix
argument_list|)
expr_stmt|;
name|VXGE_HAL_DEVICE_STATS_SW_INFO_TRAFFIC_INTR
argument_list|(
name|vdev
operator|->
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_vpath_mf_msix_mask
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|msix_vec
argument_list|)
expr_stmt|;
comment|/* processing rx */
name|vxge_hal_vpath_poll_rx
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
operator|&
name|got_rx
argument_list|)
expr_stmt|;
comment|/* processing tx */
if|if
condition|(
name|hal_vpath
operator|->
name|vp_config
operator|->
name|fifo
operator|.
name|enable
condition|)
block|{
name|vxge_intr_coalesce_tx
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
name|vxge_hal_vpath_poll_tx
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
operator|&
name|got_tx
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_vpath_mf_msix_unmask
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|msix_vec
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vxge_isr_msix_alarm
parameter_list|(
name|void
modifier|*
name|vpath_ptr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
init|=
operator|(
name|vxge_vpath_t
operator|*
operator|)
name|vpath_ptr
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|VXGE_HAL_DEVICE_STATS_SW_INFO_NOT_TRAFFIC_INTR
argument_list|(
name|vdev
operator|->
name|devh
argument_list|)
expr_stmt|;
comment|/* Process alarms in each vpath */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
name|vxge_hal_vpath_mf_msix_mask
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|msix_vec_alarm
argument_list|)
expr_stmt|;
name|status
operator|=
name|vxge_hal_vpath_alarm_process
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|==
name|VXGE_HAL_ERR_EVENT_SLOT_FREEZE
operator|)
operator|||
operator|(
name|status
operator|==
name|VXGE_HAL_ERR_EVENT_SERR
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"processing alarms urecoverable error %x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* Stop the driver */
name|vdev
operator|->
name|is_initialized
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
name|vxge_hal_vpath_mf_msix_unmask
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|msix_vec_alarm
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_msix_enable  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_msix_enable
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|first_vp_id
decl_stmt|,
name|msix_id
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
comment|/* 	 * Unmasking and Setting MSIX vectors before enabling interrupts 	 * tim[] : 0 - Tx ## 1 - Rx ## 2 - UMQ-DMQ ## 0 - BITMAP 	 */
name|int
name|tim
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
name|vdev
operator|->
name|vpaths
operator|+
name|i
expr_stmt|;
name|first_vp_id
operator|=
name|vdev
operator|->
name|vpaths
index|[
literal|0
index|]
operator|.
name|vp_id
expr_stmt|;
name|msix_id
operator|=
name|vpath
operator|->
name|vp_id
operator|*
name|VXGE_HAL_VPATH_MSIX_ACTIVE
expr_stmt|;
name|tim
index|[
literal|1
index|]
operator|=
name|vpath
operator|->
name|msix_vec
operator|=
name|msix_id
operator|+
literal|1
expr_stmt|;
name|vpath
operator|->
name|msix_vec_alarm
operator|=
name|first_vp_id
operator|*
name|VXGE_HAL_VPATH_MSIX_ACTIVE
operator|+
name|VXGE_HAL_VPATH_MSIX_ALARM_ID
expr_stmt|;
name|status
operator|=
name|vxge_hal_vpath_mf_msix_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|tim
argument_list|,
name|VXGE_HAL_VPATH_MSIX_ALARM_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to set msix vectors to vpath\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|vxge_hal_vpath_mf_msix_unmask
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|msix_vec
argument_list|)
expr_stmt|;
name|vxge_hal_vpath_mf_msix_unmask
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|msix_vec_alarm
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_media_init  * Initializes, adds and sets media  */
end_comment

begin_function
name|void
name|vxge_media_init
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|ifmedia_init
argument_list|(
operator|&
name|vdev
operator|->
name|media
argument_list|,
name|IFM_IMASK
argument_list|,
name|vxge_media_change
argument_list|,
name|vxge_media_status
argument_list|)
expr_stmt|;
comment|/* Add supported media */
name|ifmedia_add
argument_list|(
operator|&
name|vdev
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|vdev
operator|->
name|ifm_optics
operator||
name|IFM_FDX
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Set media */
name|ifmedia_add
argument_list|(
operator|&
name|vdev
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|vdev
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_media_status  * Callback  for interface media settings  */
end_comment

begin_function
name|void
name|vxge_media_status
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|vxge_hal_device_t
modifier|*
name|hldev
init|=
name|vdev
operator|->
name|devh
decl_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
expr_stmt|;
comment|/* set link state */
if|if
condition|(
name|vxge_hal_device_link_state_get
argument_list|(
name|hldev
argument_list|)
operator|==
name|VXGE_HAL_LINK_UP
condition|)
block|{
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator||=
name|vdev
operator|->
name|ifm_optics
operator||
name|IFM_FDX
expr_stmt|;
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_media_change  * Media change driver callback  */
end_comment

begin_function
name|int
name|vxge_media_change
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|)
block|{
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifmediap
init|=
operator|&
name|vdev
operator|->
name|media
decl_stmt|;
return|return
operator|(
name|IFM_TYPE
argument_list|(
name|ifmediap
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|?
name|EINVAL
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allocate PCI resources  */
end_comment

begin_function
name|int
name|vxge_alloc_resources
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|vxge_pci_info_t
modifier|*
name|pci_info
init|=
name|NULL
decl_stmt|;
name|vxge_free_resources_e
name|error_level
init|=
name|VXGE_FREE_NONE
decl_stmt|;
name|device_t
name|ndev
init|=
name|vdev
operator|->
name|ndev
decl_stmt|;
comment|/* Allocate Buffer for HAL Device Configuration */
name|vdev
operator|->
name|device_config
operator|=
operator|(
name|vxge_hal_device_config_t
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|vxge_hal_device_config_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vdev
operator|->
name|device_config
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
name|error_level
operator|=
name|VXGE_DISABLE_PCI_BUSMASTER
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to allocate memory for device config\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|pci_info
operator|=
operator|(
name|vxge_pci_info_t
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|vxge_pci_info_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pci_info
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_DEVICE_CONFIG
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to allocate memory for pci info\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|pci_info
operator|->
name|ndev
operator|=
name|ndev
expr_stmt|;
name|vdev
operator|->
name|pdev
operator|=
name|pci_info
expr_stmt|;
name|err
operator|=
name|vxge_alloc_bar_resources
argument_list|(
name|vdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_BAR0
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|err
operator|=
name|vxge_alloc_bar_resources
argument_list|(
name|vdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|error_level
operator|=
name|VXGE_FREE_BAR1
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|err
operator|=
name|vxge_alloc_bar_resources
argument_list|(
name|vdev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|error_level
operator|=
name|VXGE_FREE_BAR2
expr_stmt|;
name|_exit0
label|:
if|if
condition|(
name|error_level
condition|)
name|vxge_free_resources
argument_list|(
name|ndev
argument_list|,
name|error_level
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_alloc_bar_resources  * Allocates BAR resources  */
end_comment

begin_function
name|int
name|vxge_alloc_bar_resources
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|res_id
init|=
literal|0
decl_stmt|;
name|vxge_pci_info_t
modifier|*
name|pci_info
init|=
name|vdev
operator|->
name|pdev
decl_stmt|;
name|res_id
operator|=
name|PCIR_BAR
argument_list|(
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|0
else|:
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
operator|=
name|bus_alloc_resource_any
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|res_id
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to allocate memory for bus resources\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|pci_info
operator|->
name|reg_map
index|[
name|i
index|]
operator|=
operator|(
name|vxge_bus_res_t
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|vxge_bus_res_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_info
operator|->
name|reg_map
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to allocate memory bar resources\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
operator|(
operator|(
name|vxge_bus_res_t
operator|*
operator|)
operator|(
name|pci_info
operator|->
name|reg_map
index|[
name|i
index|]
operator|)
operator|)
operator|->
name|bus_space_tag
operator|=
name|rman_get_bustag
argument_list|(
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
operator|(
operator|(
name|vxge_bus_res_t
operator|*
operator|)
operator|(
name|pci_info
operator|->
name|reg_map
index|[
name|i
index|]
operator|)
operator|)
operator|->
name|bus_space_handle
operator|=
name|rman_get_bushandle
argument_list|(
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
operator|(
operator|(
name|vxge_bus_res_t
operator|*
operator|)
operator|(
name|pci_info
operator|->
name|reg_map
index|[
name|i
index|]
operator|)
operator|)
operator|->
name|bar_start_addr
operator|=
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
expr_stmt|;
operator|(
operator|(
name|vxge_bus_res_t
operator|*
operator|)
operator|(
name|pci_info
operator|->
name|reg_map
index|[
name|i
index|]
operator|)
operator|)
operator|->
name|bus_res_len
operator|=
name|rman_get_size
argument_list|(
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_alloc_isr_resources  */
end_comment

begin_function
name|int
name|vxge_alloc_isr_resources
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|,
name|irq_rid
decl_stmt|;
name|int
name|msix_vec_reqd
decl_stmt|,
name|intr_count
decl_stmt|,
name|msix_count
decl_stmt|;
name|int
name|intr_mode
init|=
name|VXGE_HAL_INTR_MODE_IRQLINE
decl_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_MSIX
condition|)
block|{
comment|/* MSI-X messages supported by device */
name|intr_count
operator|=
name|pci_msix_count
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
name|intr_count
condition|)
block|{
name|msix_vec_reqd
operator|=
literal|4
operator|*
name|vdev
operator|->
name|no_of_vpath
expr_stmt|;
if|if
condition|(
name|intr_count
operator|>=
name|msix_vec_reqd
condition|)
block|{
name|intr_count
operator|=
name|msix_vec_reqd
expr_stmt|;
name|err
operator|=
name|pci_alloc_msix
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
operator|&
name|intr_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
name|intr_mode
operator|=
name|VXGE_HAL_INTR_MODE_MSIX
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|err
operator|!=
literal|0
operator|)
operator|||
operator|(
name|intr_count
operator|<
name|msix_vec_reqd
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Unable to allocate "
literal|"msi/x vectors switching to INTA mode\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|err
operator|=
literal|0
expr_stmt|;
name|vdev
operator|->
name|intr_count
operator|=
literal|0
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|intr_mode
operator|=
name|intr_mode
expr_stmt|;
switch|switch
condition|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
condition|)
block|{
case|case
name|VXGE_HAL_INTR_MODE_IRQLINE
case|:
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_rid
operator|=
literal|0
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_rid
argument_list|,
operator|(
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to allocate line interrupt resource\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|intr_count
operator|++
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_INTR_MODE_MSIX
case|:
name|msix_count
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|irq_rid
operator|=
name|i
operator|*
literal|4
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_rid
operator|=
name|irq_rid
operator|+
literal|2
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_rid
argument_list|,
operator|(
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"allocating bus resource (rid %d) failed\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_rid
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|intr_count
operator|++
expr_stmt|;
name|err
operator|=
name|bus_bind_intr
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_res
argument_list|,
operator|(
name|i
operator|%
name|mp_ncpus
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
break|break;
name|msix_count
operator|++
expr_stmt|;
block|}
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_rid
operator|=
literal|3
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_rid
argument_list|,
operator|(
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"allocating bus resource (rid %d) failed\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_rid
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|intr_count
operator|++
expr_stmt|;
name|err
operator|=
name|bus_bind_intr
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|msix_count
index|]
operator|.
name|irq_res
argument_list|,
operator|(
name|i
operator|%
name|mp_ncpus
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|vdev
operator|->
name|device_config
operator|->
name|intr_mode
operator|=
name|vdev
operator|->
name|config
operator|.
name|intr_mode
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_free_resources  * Undo what-all we did during load/attach  */
end_comment

begin_function
name|void
name|vxge_free_resources
parameter_list|(
name|device_t
name|ndev
parameter_list|,
name|vxge_free_resources_e
name|vxge_free_resource
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
decl_stmt|;
name|vdev
operator|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|device_get_softc
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|vxge_free_resource
condition|)
block|{
case|case
name|VXGE_FREE_ALL
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|intr_count
condition|;
name|i
operator|++
control|)
block|{
name|bus_teardown_intr
argument_list|(
name|ndev
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_res
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_handle
argument_list|)
expr_stmt|;
block|}
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_INTERFACE
case|:
name|ether_ifdetach
argument_list|(
name|vdev
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|bus_generic_detach
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|vdev
operator|->
name|ifp
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_MEDIA
case|:
name|ifmedia_removeall
argument_list|(
operator|&
name|vdev
operator|->
name|media
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_MUTEX
case|:
name|vxge_mutex_destroy
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_VPATH
case|:
name|vxge_mem_free
argument_list|(
name|vdev
operator|->
name|vpaths
argument_list|,
name|vdev
operator|->
name|no_of_vpath
operator|*
sizeof|sizeof
argument_list|(
name|vxge_vpath_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_TERMINATE_DEVICE
case|:
if|if
condition|(
name|vdev
operator|->
name|devh
operator|!=
name|NULL
condition|)
block|{
name|vxge_hal_device_private_set
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vxge_hal_device_terminate
argument_list|(
name|vdev
operator|->
name|devh
argument_list|)
expr_stmt|;
block|}
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_ISR_RESOURCE
case|:
name|vxge_free_isr_resources
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_BAR2
case|:
name|vxge_free_bar_resources
argument_list|(
name|vdev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_BAR1
case|:
name|vxge_free_bar_resources
argument_list|(
name|vdev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_BAR0
case|:
name|vxge_free_bar_resources
argument_list|(
name|vdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_PCI_INFO
case|:
name|vxge_mem_free
argument_list|(
name|vdev
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_pci_info_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_DEVICE_CONFIG
case|:
name|vxge_mem_free
argument_list|(
name|vdev
operator|->
name|device_config
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_config_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_DISABLE_PCI_BUSMASTER
case|:
name|pci_disable_busmaster
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_FREE_TERMINATE_DRIVER
case|:
if|if
condition|(
name|vxge_dev_ref_count
condition|)
block|{
operator|--
name|vxge_dev_ref_count
expr_stmt|;
if|if
condition|(
literal|0
operator|==
name|vxge_dev_ref_count
condition|)
name|vxge_hal_driver_terminate
argument_list|()
expr_stmt|;
block|}
comment|/* FALLTHROUGH */
default|default:
case|case
name|VXGE_FREE_NONE
case|:
break|break;
comment|/* NOTREACHED */
block|}
block|}
end_function

begin_function
name|void
name|vxge_free_isr_resources
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
condition|)
block|{
case|case
name|VXGE_HAL_INTR_MODE_IRQLINE
case|:
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_res
condition|)
block|{
name|bus_release_resource
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_rid
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_res
argument_list|)
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
literal|0
index|]
operator|.
name|irq_res
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_HAL_INTR_MODE_MSIX
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|intr_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_res
condition|)
block|{
name|bus_release_resource
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_rid
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_res
argument_list|)
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|isr_info
index|[
name|i
index|]
operator|.
name|irq_res
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vdev
operator|->
name|intr_count
condition|)
name|pci_release_msi
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|vxge_free_bar_resources
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|int
name|res_id
init|=
literal|0
decl_stmt|;
name|vxge_pci_info_t
modifier|*
name|pci_info
init|=
name|vdev
operator|->
name|pdev
decl_stmt|;
name|res_id
operator|=
name|PCIR_BAR
argument_list|(
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|0
else|:
operator|(
name|i
operator|*
literal|2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
condition|)
name|bus_release_resource
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|res_id
argument_list|,
name|pci_info
operator|->
name|bar_info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vxge_mem_free
argument_list|(
name|pci_info
operator|->
name|reg_map
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_bus_res_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_init_mutex  * Initializes mutexes used in driver  */
end_comment

begin_function
name|void
name|vxge_mutex_init
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|mtx_drv_name
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|mtx_drv_name
argument_list|)
argument_list|,
literal|"%s_drv"
argument_list|,
name|vdev
operator|->
name|ndev_name
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|vdev
operator|->
name|mtx_drv
argument_list|,
name|vdev
operator|->
name|mtx_drv_name
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|mtx_tx_name
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|mtx_tx_name
argument_list|)
argument_list|,
literal|"%s_tx_%d"
argument_list|,
name|vdev
operator|->
name|ndev_name
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|mtx_tx
argument_list|,
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|mtx_tx_name
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_mutex_destroy  * Destroys mutexes used in driver  */
end_comment

begin_function
name|void
name|vxge_mutex_destroy
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
name|VXGE_TX_LOCK_DESTROY
argument_list|(
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|VXGE_DRV_LOCK_DESTROY
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_rth_config  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_rth_config
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_hal_vpath_h
name|vpath_handle
decl_stmt|;
name|vxge_hal_rth_hash_types_t
name|hash_types
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|u8
name|mtable
index|[
literal|256
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
comment|/* Filling matable with bucket-to-vpath mapping */
name|vdev
operator|->
name|config
operator|.
name|rth_bkt_sz
operator|=
name|VXGE_DEFAULT_RTH_BUCKET_SIZE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
literal|1
operator|<<
name|vdev
operator|->
name|config
operator|.
name|rth_bkt_sz
operator|)
condition|;
name|i
operator|++
control|)
name|mtable
index|[
name|i
index|]
operator|=
name|i
operator|%
name|vdev
operator|->
name|no_of_vpath
expr_stmt|;
comment|/* Fill RTH hash types */
name|hash_types
operator|.
name|hash_type_tcpipv4_en
operator|=
name|VXGE_HAL_RING_HASH_TYPE_TCP_IPV4
expr_stmt|;
name|hash_types
operator|.
name|hash_type_tcpipv6_en
operator|=
name|VXGE_HAL_RING_HASH_TYPE_TCP_IPV6
expr_stmt|;
name|hash_types
operator|.
name|hash_type_tcpipv6ex_en
operator|=
name|VXGE_HAL_RING_HASH_TYPE_TCP_IPV6_EX
expr_stmt|;
name|hash_types
operator|.
name|hash_type_ipv4_en
operator|=
name|VXGE_HAL_RING_HASH_TYPE_IPV4
expr_stmt|;
name|hash_types
operator|.
name|hash_type_ipv6_en
operator|=
name|VXGE_HAL_RING_HASH_TYPE_IPV6
expr_stmt|;
name|hash_types
operator|.
name|hash_type_ipv6ex_en
operator|=
name|VXGE_HAL_RING_HASH_TYPE_IPV6_EX
expr_stmt|;
comment|/* set indirection table, bucket-to-vpath mapping */
name|status
operator|=
name|vxge_hal_vpath_rts_rth_itable_set
argument_list|(
name|vdev
operator|->
name|vpath_handles
argument_list|,
name|vdev
operator|->
name|no_of_vpath
argument_list|,
name|mtable
argument_list|,
operator|(
call|(
name|u32
call|)
argument_list|(
literal|1
operator|<<
name|vdev
operator|->
name|config
operator|.
name|rth_bkt_sz
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"rth configuration failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath_handle
operator|=
name|vxge_vpath_handle_get
argument_list|(
name|vdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vpath_handle
condition|)
continue|continue;
name|status
operator|=
name|vxge_hal_vpath_rts_rth_set
argument_list|(
name|vpath_handle
argument_list|,
name|RTH_ALG_JENKINS
argument_list|,
operator|&
name|hash_types
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|rth_bkt_sz
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"rth configuration failed for vpath (%d)\n"
argument_list|,
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|vp_id
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|_exit0
label|:
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_vpath_config  * Sets HAL parameter values from kenv  */
end_comment

begin_function
name|void
name|vxge_vpath_config
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u32
name|no_of_vpath
init|=
literal|0
decl_stmt|;
name|vxge_hal_vp_config_t
modifier|*
name|vp_config
decl_stmt|;
name|vxge_hal_device_config_t
modifier|*
name|device_config
init|=
name|vdev
operator|->
name|device_config
decl_stmt|;
name|device_config
operator|->
name|debug_level
operator|=
name|VXGE_TRACE
expr_stmt|;
name|device_config
operator|->
name|debug_mask
operator|=
name|VXGE_COMPONENT_ALL
expr_stmt|;
name|device_config
operator|->
name|device_poll_millis
operator|=
name|VXGE_DEFAULT_DEVICE_POLL_MILLIS
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|no_of_vpath
operator|=
name|min
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|no_of_vpath
argument_list|,
name|vdev
operator|->
name|max_supported_vpath
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
name|vp_config
operator|=
operator|&
operator|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|)
expr_stmt|;
name|vp_config
operator|->
name|fifo
operator|.
name|enable
operator|=
name|VXGE_HAL_FIFO_DISABLE
expr_stmt|;
name|vp_config
operator|->
name|ring
operator|.
name|enable
operator|=
name|VXGE_HAL_RING_DISABLE
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|no_of_vpath
operator|>=
name|vdev
operator|->
name|config
operator|.
name|no_of_vpath
condition|)
break|break;
if|if
condition|(
operator|!
name|bVAL1
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|vpath_mask
argument_list|,
name|i
argument_list|)
condition|)
continue|continue;
name|no_of_vpath
operator|++
expr_stmt|;
name|vp_config
operator|=
operator|&
operator|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|)
expr_stmt|;
name|vp_config
operator|->
name|mtu
operator|=
name|VXGE_HAL_DEFAULT_MTU
expr_stmt|;
name|vp_config
operator|->
name|ring
operator|.
name|enable
operator|=
name|VXGE_HAL_RING_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|ring
operator|.
name|post_mode
operator|=
name|VXGE_HAL_RING_POST_MODE_DOORBELL
expr_stmt|;
name|vp_config
operator|->
name|ring
operator|.
name|buffer_mode
operator|=
name|VXGE_HAL_RING_RXD_BUFFER_MODE_1
expr_stmt|;
name|vp_config
operator|->
name|ring
operator|.
name|ring_length
operator|=
name|vxge_ring_length_get
argument_list|(
name|VXGE_HAL_RING_RXD_BUFFER_MODE_1
argument_list|)
expr_stmt|;
name|vp_config
operator|->
name|ring
operator|.
name|scatter_mode
operator|=
name|VXGE_HAL_RING_SCATTER_MODE_A
expr_stmt|;
name|vp_config
operator|->
name|rpa_all_vid_en
operator|=
name|VXGE_DEFAULT_ALL_VID_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|rpa_strip_vlan_tag
operator|=
name|VXGE_DEFAULT_STRIP_VLAN_TAG
expr_stmt|;
name|vp_config
operator|->
name|rpa_ucast_all_addr_en
operator|=
name|VXGE_HAL_VPATH_RPA_UCAST_ALL_ADDR_DISABLE
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|intr_enable
operator|=
name|VXGE_HAL_TIM_INTR_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|txfrm_cnt_en
operator|=
name|VXGE_HAL_TXFRM_CNT_EN_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|util_sel
operator|=
name|VXGE_HAL_TIM_UTIL_SEL_LEGACY_RX_NET_UTIL
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|uec_a
operator|=
name|VXGE_DEFAULT_RTI_RX_UFC_A
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|uec_b
operator|=
name|VXGE_DEFAULT_RTI_RX_UFC_B
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|uec_c
operator|=
name|VXGE_DEFAULT_RTI_RX_UFC_C
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|uec_d
operator|=
name|VXGE_DEFAULT_RTI_RX_UFC_D
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|urange_a
operator|=
name|VXGE_DEFAULT_RTI_RX_URANGE_A
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|urange_b
operator|=
name|VXGE_DEFAULT_RTI_RX_URANGE_B
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|urange_c
operator|=
name|VXGE_DEFAULT_RTI_RX_URANGE_C
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|timer_ac_en
operator|=
name|VXGE_HAL_TIM_TIMER_AC_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|timer_ci_en
operator|=
name|VXGE_HAL_TIM_TIMER_CI_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|btimer_val
operator|=
operator|(
name|VXGE_DEFAULT_RTI_BTIMER_VAL
operator|*
literal|1000
operator|)
operator|/
literal|272
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|rtimer_val
operator|=
operator|(
name|VXGE_DEFAULT_RTI_RTIMER_VAL
operator|*
literal|1000
operator|)
operator|/
literal|272
expr_stmt|;
name|vp_config
operator|->
name|rti
operator|.
name|ltimer_val
operator|=
operator|(
name|VXGE_DEFAULT_RTI_LTIMER_VAL
operator|*
literal|1000
operator|)
operator|/
literal|272
expr_stmt|;
if|if
condition|(
operator|(
name|no_of_vpath
operator|>
literal|1
operator|)
operator|&&
operator|(
name|VXGE_DEFAULT_CONFIG_MQ_ENABLE
operator|==
literal|0
operator|)
condition|)
continue|continue;
name|vp_config
operator|->
name|fifo
operator|.
name|enable
operator|=
name|VXGE_HAL_FIFO_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|fifo
operator|.
name|max_aligned_frags
operator|=
name|VXGE_DEFAULT_FIFO_ALIGNED_FRAGS
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|intr_enable
operator|=
name|VXGE_HAL_TIM_INTR_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|txfrm_cnt_en
operator|=
name|VXGE_HAL_TXFRM_CNT_EN_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|util_sel
operator|=
name|VXGE_HAL_TIM_UTIL_SEL_LEGACY_TX_NET_UTIL
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|uec_a
operator|=
name|VXGE_DEFAULT_TTI_TX_UFC_A
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|uec_b
operator|=
name|VXGE_DEFAULT_TTI_TX_UFC_B
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|uec_c
operator|=
name|VXGE_DEFAULT_TTI_TX_UFC_C
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|uec_d
operator|=
name|VXGE_DEFAULT_TTI_TX_UFC_D
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|urange_a
operator|=
name|VXGE_DEFAULT_TTI_TX_URANGE_A
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|urange_b
operator|=
name|VXGE_DEFAULT_TTI_TX_URANGE_B
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|urange_c
operator|=
name|VXGE_DEFAULT_TTI_TX_URANGE_C
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|timer_ac_en
operator|=
name|VXGE_HAL_TIM_TIMER_AC_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|timer_ci_en
operator|=
name|VXGE_HAL_TIM_TIMER_CI_ENABLE
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|btimer_val
operator|=
operator|(
name|VXGE_DEFAULT_TTI_BTIMER_VAL
operator|*
literal|1000
operator|)
operator|/
literal|272
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|rtimer_val
operator|=
operator|(
name|VXGE_DEFAULT_TTI_RTIMER_VAL
operator|*
literal|1000
operator|)
operator|/
literal|272
expr_stmt|;
name|vp_config
operator|->
name|tti
operator|.
name|ltimer_val
operator|=
operator|(
name|VXGE_DEFAULT_TTI_LTIMER_VAL
operator|*
literal|1000
operator|)
operator|/
literal|272
expr_stmt|;
block|}
name|vdev
operator|->
name|no_of_vpath
operator|=
name|no_of_vpath
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|no_of_vpath
operator|==
literal|1
condition|)
name|vdev
operator|->
name|config
operator|.
name|tx_steering
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|rth_enable
operator|&&
operator|(
name|vdev
operator|->
name|no_of_vpath
operator|>
literal|1
operator|)
condition|)
block|{
name|device_config
operator|->
name|rth_en
operator|=
name|VXGE_HAL_RTH_ENABLE
expr_stmt|;
name|device_config
operator|->
name|rth_it_type
operator|=
name|VXGE_HAL_RTH_IT_TYPE_MULTI_IT
expr_stmt|;
block|}
name|vdev
operator|->
name|config
operator|.
name|rth_enable
operator|=
name|device_config
operator|->
name|rth_en
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_vpath_cb_fn  * Virtual path Callback function  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|vxge_vpath_cb_fn
parameter_list|(
name|vxge_hal_client_h
name|client_handle
parameter_list|,
name|vxge_hal_up_msg_h
name|msgh
parameter_list|,
name|vxge_hal_message_type_e
name|msg_type
parameter_list|,
name|vxge_hal_obj_id_t
name|obj_id
parameter_list|,
name|vxge_hal_result_e
name|result
parameter_list|,
name|vxge_hal_opaque_handle_t
modifier|*
name|opaque_handle
parameter_list|)
block|{
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_vpath_open  */
end_comment

begin_function
name|int
name|vxge_vpath_open
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
init|=
name|EINVAL
decl_stmt|;
name|u64
name|func_id
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_hal_vpath_attr_t
name|vpath_attr
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|struct
name|lro_ctrl
modifier|*
name|lro
init|=
name|NULL
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|vpath_attr
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_attr_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
name|lro
operator|=
operator|&
name|vpath
operator|->
name|lro
expr_stmt|;
comment|/* Vpath vpath_attr: FIFO */
name|vpath_attr
operator|.
name|vp_id
operator|=
name|vpath
operator|->
name|vp_id
expr_stmt|;
name|vpath_attr
operator|.
name|fifo_attr
operator|.
name|callback
operator|=
name|vxge_tx_compl
expr_stmt|;
name|vpath_attr
operator|.
name|fifo_attr
operator|.
name|txdl_init
operator|=
name|vxge_tx_replenish
expr_stmt|;
name|vpath_attr
operator|.
name|fifo_attr
operator|.
name|txdl_term
operator|=
name|vxge_tx_term
expr_stmt|;
name|vpath_attr
operator|.
name|fifo_attr
operator|.
name|userdata
operator|=
name|vpath
expr_stmt|;
name|vpath_attr
operator|.
name|fifo_attr
operator|.
name|per_txdl_space
operator|=
sizeof|sizeof
argument_list|(
name|vxge_txdl_priv_t
argument_list|)
expr_stmt|;
comment|/* Vpath vpath_attr: Ring */
name|vpath_attr
operator|.
name|ring_attr
operator|.
name|callback
operator|=
name|vxge_rx_compl
expr_stmt|;
name|vpath_attr
operator|.
name|ring_attr
operator|.
name|rxd_init
operator|=
name|vxge_rx_replenish
expr_stmt|;
name|vpath_attr
operator|.
name|ring_attr
operator|.
name|rxd_term
operator|=
name|vxge_rx_term
expr_stmt|;
name|vpath_attr
operator|.
name|ring_attr
operator|.
name|userdata
operator|=
name|vpath
expr_stmt|;
name|vpath_attr
operator|.
name|ring_attr
operator|.
name|per_rxd_space
operator|=
sizeof|sizeof
argument_list|(
name|vxge_rxd_priv_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|vxge_dma_tags_create
argument_list|(
name|vpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to create dma tags\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
name|vpath
operator|->
name|br
operator|=
name|buf_ring_alloc
argument_list|(
name|VXGE_DEFAULT_BR_SIZE
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|,
operator|&
name|vpath
operator|->
name|mtx_tx
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|br
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
name|status
operator|=
name|vxge_hal_vpath_open
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
operator|&
name|vpath_attr
argument_list|,
operator|(
name|vxge_hal_vpath_callback_f
operator|)
name|vxge_vpath_cb_fn
argument_list|,
name|NULL
argument_list|,
operator|&
name|vpath
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to open vpath (%d)\n"
argument_list|,
name|vpath
operator|->
name|vp_id
argument_list|)
expr_stmt|;
name|err
operator|=
name|EPERM
expr_stmt|;
break|break;
block|}
name|vpath
operator|->
name|is_open
operator|=
name|TRUE
expr_stmt|;
name|vdev
operator|->
name|vpath_handles
index|[
name|i
index|]
operator|=
name|vpath
operator|->
name|handle
expr_stmt|;
name|vpath
operator|->
name|tx_ticks
operator|=
name|ticks
expr_stmt|;
name|vpath
operator|->
name|rx_ticks
operator|=
name|ticks
expr_stmt|;
name|vpath
operator|->
name|tti_rtimer_val
operator|=
name|VXGE_DEFAULT_TTI_RTIMER_VAL
expr_stmt|;
name|vpath
operator|->
name|tti_rtimer_val
operator|=
name|VXGE_DEFAULT_TTI_RTIMER_VAL
expr_stmt|;
name|vpath
operator|->
name|tx_intr_coalesce
operator|=
name|vdev
operator|->
name|config
operator|.
name|intr_coalesce
expr_stmt|;
name|vpath
operator|->
name|rx_intr_coalesce
operator|=
name|vdev
operator|->
name|config
operator|.
name|intr_coalesce
expr_stmt|;
name|func_id
operator|=
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|func_id
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|low_latency
operator|&&
operator|(
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|priority
operator|==
name|VXGE_DEFAULT_VPATH_PRIORITY_HIGH
operator|)
condition|)
block|{
name|vpath
operator|->
name|tx_intr_coalesce
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|vdev
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
condition|)
block|{
name|err
operator|=
name|tcp_lro_init
argument_list|(
name|lro
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"LRO Initialization failed!\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|vpath
operator|->
name|lro_enable
operator|=
name|TRUE
expr_stmt|;
name|lro
operator|->
name|ifp
operator|=
name|vdev
operator|->
name|ifp
expr_stmt|;
block|}
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|vxge_tso_config
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|u32
name|func_id
decl_stmt|,
name|priority
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vdev
operator|->
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO4
expr_stmt|;
name|status
operator|=
name|vxge_bw_priority_get
argument_list|(
name|vdev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|func_id
operator|=
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|func_id
expr_stmt|;
name|priority
operator|=
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|priority
expr_stmt|;
if|if
condition|(
name|priority
operator|!=
name|VXGE_DEFAULT_VPATH_PRIORITY_HIGH
condition|)
name|vdev
operator|->
name|ifp
operator|->
name|if_capabilities
operator|&=
operator|~
name|IFCAP_TSO4
expr_stmt|;
block|}
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
if|if
condition|(
name|vdev
operator|->
name|ifp
operator|->
name|if_capabilities
operator|&
name|IFCAP_TSO4
condition|)
name|vdev
operator|->
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTSO
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_bw_priority_get
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|vxge_bw_info_t
modifier|*
name|bw_info
parameter_list|)
block|{
name|u32
name|priority
decl_stmt|,
name|bandwidth
decl_stmt|;
name|u32
name|vpath_count
decl_stmt|;
name|u64
name|func_id
decl_stmt|,
name|func_mode
decl_stmt|,
name|vpath_list
index|[
name|VXGE_HAL_MAX_VIRTUAL_PATHS
index|]
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|func_id
operator|=
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|func_id
expr_stmt|;
if|if
condition|(
name|bw_info
condition|)
block|{
name|func_id
operator|=
name|bw_info
operator|->
name|func_id
expr_stmt|;
name|func_mode
operator|=
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|function_mode
expr_stmt|;
if|if
condition|(
operator|(
name|is_single_func
argument_list|(
name|func_mode
argument_list|)
operator|)
operator|&&
operator|(
name|func_id
operator|>
literal|0
operator|)
condition|)
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
if|if
condition|(
name|vdev
operator|->
name|hw_fw_version
operator|>=
name|VXGE_FW_VERSION
argument_list|(
literal|1
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|status
operator|=
name|vxge_hal_vf_rx_bw_get
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|func_id
argument_list|,
operator|&
name|bandwidth
argument_list|,
operator|&
name|priority
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|vxge_hal_get_vpath_list
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|func_id
argument_list|,
name|vpath_list
argument_list|,
operator|&
name|vpath_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|status
operator|=
name|vxge_hal_bw_priority_get
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vpath_list
index|[
literal|0
index|]
argument_list|,
operator|&
name|bandwidth
argument_list|,
operator|&
name|priority
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
if|if
condition|(
name|bw_info
condition|)
block|{
name|bw_info
operator|->
name|priority
operator|=
name|priority
expr_stmt|;
name|bw_info
operator|->
name|bandwidth
operator|=
name|bandwidth
expr_stmt|;
block|}
else|else
block|{
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|priority
operator|=
name|priority
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|bandwidth
operator|=
name|bandwidth
expr_stmt|;
block|}
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * close vpaths  */
end_comment

begin_function
name|void
name|vxge_vpath_close
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|handle
condition|)
name|vxge_hal_vpath_close
argument_list|(
name|vpath
operator|->
name|handle
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
if|if
condition|(
name|vpath
operator|->
name|br
operator|!=
name|NULL
condition|)
name|buf_ring_free
argument_list|(
name|vpath
operator|->
name|br
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Free LRO memory */
if|if
condition|(
name|vpath
operator|->
name|lro_enable
condition|)
name|tcp_lro_free
argument_list|(
operator|&
name|vpath
operator|->
name|lro
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|dma_tag_rx
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|vpath
operator|->
name|extra_dma_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vpath
operator|->
name|dma_tag_tx
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|)
expr_stmt|;
name|vpath
operator|->
name|handle
operator|=
name|NULL
expr_stmt|;
name|vpath
operator|->
name|is_open
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * reset vpaths  */
end_comment

begin_function
name|void
name|vxge_vpath_reset
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_hal_vpath_h
name|vpath_handle
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath_handle
operator|=
name|vxge_vpath_handle_get
argument_list|(
name|vdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vpath_handle
condition|)
continue|continue;
name|status
operator|=
name|vxge_hal_vpath_reset
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed to reset vpath :%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|vxge_vpath_get
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|mbuf_t
name|mhead
parameter_list|)
block|{
name|struct
name|tcphdr
modifier|*
name|th
init|=
name|NULL
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
init|=
name|NULL
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
init|=
name|NULL
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|NULL
decl_stmt|;
name|struct
name|ether_vlan_header
modifier|*
name|eth
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|ulp
init|=
name|NULL
decl_stmt|;
name|int
name|ehdrlen
decl_stmt|,
name|iphlen
init|=
literal|0
decl_stmt|;
name|u8
name|ipproto
init|=
literal|0
decl_stmt|;
name|u16
name|etype
decl_stmt|,
name|src_port
decl_stmt|,
name|dst_port
decl_stmt|;
name|u16
name|queue_len
decl_stmt|,
name|counter
init|=
literal|0
decl_stmt|;
name|src_port
operator|=
name|dst_port
operator|=
literal|0
expr_stmt|;
name|queue_len
operator|=
name|vdev
operator|->
name|no_of_vpath
expr_stmt|;
name|eth
operator|=
name|mtod
argument_list|(
name|mhead
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eth
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|etype
operator|=
name|ntohs
argument_list|(
name|eth
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
block|}
else|else
block|{
name|etype
operator|=
name|ntohs
argument_list|(
name|eth
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mhead
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|iphlen
operator|=
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
name|ipproto
operator|=
name|ip
operator|->
name|ip_p
expr_stmt|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
name|iphlen
operator|)
expr_stmt|;
name|uh
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|ip
operator|+
name|iphlen
operator|)
expr_stmt|;
break|break;
case|case
name|ETHERTYPE_IPV6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|mhead
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|iphlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
name|ipproto
operator|=
name|ip6
operator|->
name|ip6_nxt
expr_stmt|;
name|ulp
operator|=
name|mtod
argument_list|(
name|mhead
argument_list|,
name|char
operator|*
argument_list|)
operator|+
name|iphlen
expr_stmt|;
name|th
operator|=
operator|(
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|ulp
operator|)
operator|)
expr_stmt|;
name|uh
operator|=
operator|(
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
name|ulp
operator|)
operator|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
switch|switch
condition|(
name|ipproto
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|src_port
operator|=
name|th
operator|->
name|th_sport
expr_stmt|;
name|dst_port
operator|=
name|th
operator|->
name|th_dport
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|src_port
operator|=
name|uh
operator|->
name|uh_sport
expr_stmt|;
name|dst_port
operator|=
name|uh
operator|->
name|uh_dport
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|counter
operator|=
operator|(
name|ntohs
argument_list|(
name|src_port
argument_list|)
operator|+
name|ntohs
argument_list|(
name|dst_port
argument_list|)
operator|)
operator|&
name|vpath_selector
index|[
name|queue_len
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|counter
operator|>=
name|queue_len
condition|)
name|counter
operator|=
name|queue_len
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|counter
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|vxge_hal_vpath_h
name|vxge_vpath_handle_get
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|int
name|i
parameter_list|)
block|{
return|return
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|is_open
condition|?
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|.
name|handle
else|:
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|vxge_firmware_verify
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u64
name|active_config
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
if|if
condition|(
name|vdev
operator|->
name|fw_upgrade
condition|)
block|{
name|status
operator|=
name|vxge_firmware_upgrade
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|vdev
operator|->
name|config
operator|.
name|function_mode
operator|!=
name|VXGE_DEFAULT_CONFIG_VALUE
operator|)
operator|&&
operator|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|function_mode
operator|!=
operator|(
name|u64
operator|)
name|vdev
operator|->
name|config
operator|.
name|function_mode
operator|)
condition|)
block|{
name|status
operator|=
name|vxge_func_mode_set
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|err
operator|=
name|ENXIO
expr_stmt|;
block|}
comment|/* l2_switch configuration */
name|active_config
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|status
operator|=
name|vxge_hal_get_active_config
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_HAL_XMAC_NWIF_ActConfig_L2SwitchEnabled
argument_list|,
operator|&
name|active_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|vdev
operator|->
name|l2_switch
operator|=
name|active_config
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|l2_switch
operator|!=
name|VXGE_DEFAULT_CONFIG_VALUE
condition|)
block|{
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|l2_switch
operator|!=
name|active_config
condition|)
block|{
name|status
operator|=
name|vxge_l2switch_mode_set
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|err
operator|=
name|ENXIO
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|ports
operator|==
name|VXGE_DUAL_PORT_MODE
condition|)
block|{
if|if
condition|(
name|vxge_port_mode_update
argument_list|(
name|vdev
argument_list|)
operator|==
name|ENXIO
condition|)
name|err
operator|=
name|ENXIO
expr_stmt|;
block|}
name|_exit0
label|:
if|if
condition|(
name|err
operator|==
name|ENXIO
condition|)
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"PLEASE POWER CYCLE THE SYSTEM\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_firmware_upgrade
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|u8
modifier|*
name|fw_buffer
decl_stmt|;
name|u32
name|fw_size
decl_stmt|;
name|vxge_hal_device_hw_info_t
modifier|*
name|hw_info
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|hw_info
operator|=
operator|&
name|vdev
operator|->
name|config
operator|.
name|hw_info
expr_stmt|;
name|fw_size
operator|=
sizeof|sizeof
argument_list|(
name|VXGE_FW_ARRAY_NAME
argument_list|)
expr_stmt|;
name|fw_buffer
operator|=
operator|(
name|u8
operator|*
operator|)
name|VXGE_FW_ARRAY_NAME
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Current firmware version : %s (%s)\n"
argument_list|,
name|hw_info
operator|->
name|fw_version
operator|.
name|version
argument_list|,
name|hw_info
operator|->
name|fw_date
operator|.
name|date
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Upgrading firmware to %d.%d.%d\n"
argument_list|,
name|VXGE_MIN_FW_MAJOR_VERSION
argument_list|,
name|VXGE_MIN_FW_MINOR_VERSION
argument_list|,
name|VXGE_MIN_FW_BUILD_NUMBER
argument_list|)
expr_stmt|;
comment|/* Call HAL API to upgrade firmware */
name|status
operator|=
name|vxge_hal_mrpcim_fw_upgrade
argument_list|(
name|vdev
operator|->
name|pdev
argument_list|,
operator|(
name|pci_reg_h
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|reg_map
index|[
literal|0
index|]
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|bar_info
index|[
literal|0
index|]
argument_list|,
name|fw_buffer
argument_list|,
name|fw_size
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"firmware upgrade %s\n"
argument_list|,
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
literal|"successful"
else|:
literal|"failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_func_mode_set
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|u64
name|active_config
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|status
operator|=
name|vxge_hal_mrpcim_pcie_func_mode_set
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|function_mode
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"function mode change %s\n"
argument_list|,
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
literal|"successful"
else|:
literal|"failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_set_fw_api
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
literal|0ULL
argument_list|,
name|VXGE_HAL_API_FUNC_MODE_COMMIT
argument_list|,
literal|0
argument_list|,
literal|0ULL
argument_list|,
literal|0ULL
argument_list|)
expr_stmt|;
name|vxge_hal_get_active_config
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_HAL_XMAC_NWIF_ActConfig_NWPortMode
argument_list|,
operator|&
name|active_config
argument_list|)
expr_stmt|;
comment|/* 		 * If in MF + DP mode 		 * if user changes to SF, change port_mode to single port mode 		 */
if|if
condition|(
operator|(
operator|(
name|is_multi_func
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|function_mode
argument_list|)
operator|)
operator|&&
name|is_single_func
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|function_mode
argument_list|)
operator|)
operator|&&
operator|(
name|active_config
operator|==
name|VXGE_HAL_DP_NP_MODE_DUAL_PORT
operator|)
condition|)
block|{
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|=
name|VXGE_HAL_DP_NP_MODE_SINGLE_PORT
expr_stmt|;
name|status
operator|=
name|vxge_port_mode_set
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_port_mode_set
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|status
operator|=
name|vxge_hal_set_port_mode
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|port_mode
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"port mode change %s\n"
argument_list|,
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
literal|"successful"
else|:
literal|"failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_set_fw_api
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
literal|0ULL
argument_list|,
name|VXGE_HAL_API_FUNC_MODE_COMMIT
argument_list|,
literal|0
argument_list|,
literal|0ULL
argument_list|,
literal|0ULL
argument_list|)
expr_stmt|;
comment|/* Configure vpath_mapping for active-active mode only */
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|==
name|VXGE_HAL_DP_NP_MODE_DUAL_PORT
condition|)
block|{
name|status
operator|=
name|vxge_hal_config_vpath_map
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_DUAL_PORT_MAP
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"dual port map change %s\n"
argument_list|,
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
literal|"successful"
else|:
literal|"failed"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|int
name|vxge_port_mode_update
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u64
name|active_config
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
if|if
condition|(
operator|(
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|==
name|VXGE_HAL_DP_NP_MODE_DUAL_PORT
operator|)
operator|&&
name|is_single_func
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|function_mode
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Adapter in SF mode, dual port mode is not allowed\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|EPERM
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|active_config
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|status
operator|=
name|vxge_hal_get_active_config
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_HAL_XMAC_NWIF_ActConfig_NWPortMode
argument_list|,
operator|&
name|active_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|port_mode
operator|=
name|active_config
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|!=
name|VXGE_DEFAULT_CONFIG_VALUE
condition|)
block|{
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|!=
name|vdev
operator|->
name|port_mode
condition|)
block|{
name|status
operator|=
name|vxge_port_mode_set
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|err
operator|=
name|ENXIO
expr_stmt|;
name|vdev
operator|->
name|port_mode
operator|=
name|vdev
operator|->
name|config
operator|.
name|port_mode
expr_stmt|;
block|}
block|}
name|active_config
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|status
operator|=
name|vxge_hal_get_active_config
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_HAL_XMAC_NWIF_ActConfig_BehaviourOnFail
argument_list|,
operator|&
name|active_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|port_failure
operator|=
name|active_config
expr_stmt|;
comment|/* 	 * active/active mode : set to NoMove 	 * active/passive mode: set to Failover-Failback 	 */
if|if
condition|(
name|vdev
operator|->
name|port_mode
operator|==
name|VXGE_HAL_DP_NP_MODE_DUAL_PORT
condition|)
name|vdev
operator|->
name|config
operator|.
name|port_failure
operator|=
name|VXGE_HAL_XMAC_NWIF_OnFailure_NoMove
expr_stmt|;
elseif|else
if|if
condition|(
name|vdev
operator|->
name|port_mode
operator|==
name|VXGE_HAL_DP_NP_MODE_ACTIVE_PASSIVE
condition|)
name|vdev
operator|->
name|config
operator|.
name|port_failure
operator|=
name|VXGE_HAL_XMAC_NWIF_OnFailure_OtherPortBackOnRestore
expr_stmt|;
if|if
condition|(
operator|(
name|vdev
operator|->
name|port_mode
operator|!=
name|VXGE_HAL_DP_NP_MODE_SINGLE_PORT
operator|)
operator|&&
operator|(
name|vdev
operator|->
name|config
operator|.
name|port_failure
operator|!=
name|vdev
operator|->
name|port_failure
operator|)
condition|)
block|{
name|status
operator|=
name|vxge_port_behavior_on_failure_set
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|err
operator|=
name|ENXIO
expr_stmt|;
block|}
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_port_mode_get
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|vxge_port_info_t
modifier|*
name|port_info
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u64
name|active_config
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|active_config
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|status
operator|=
name|vxge_hal_get_active_config
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_HAL_XMAC_NWIF_ActConfig_NWPortMode
argument_list|,
operator|&
name|active_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|port_info
operator|->
name|port_mode
operator|=
name|active_config
expr_stmt|;
name|active_config
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|status
operator|=
name|vxge_hal_get_active_config
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_HAL_XMAC_NWIF_ActConfig_BehaviourOnFail
argument_list|,
operator|&
name|active_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|port_info
operator|->
name|port_failure
operator|=
name|active_config
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_port_behavior_on_failure_set
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|status
operator|=
name|vxge_hal_set_behavior_on_failure
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|port_failure
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"port behaviour on failure change %s\n"
argument_list|,
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
literal|"successful"
else|:
literal|"failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|vxge_hal_set_fw_api
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
literal|0ULL
argument_list|,
name|VXGE_HAL_API_FUNC_MODE_COMMIT
argument_list|,
literal|0
argument_list|,
literal|0ULL
argument_list|,
literal|0ULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|void
name|vxge_active_port_update
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|u64
name|active_config
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|active_config
operator|=
name|VXGE_DEFAULT_CONFIG_VALUE
expr_stmt|;
name|status
operator|=
name|vxge_hal_get_active_config
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|VXGE_HAL_XMAC_NWIF_ActConfig_ActivePort
argument_list|,
operator|&
name|active_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|vdev
operator|->
name|active_port
operator|=
name|active_config
expr_stmt|;
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_l2switch_mode_set
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|status
operator|=
name|vxge_hal_set_l2switch_mode
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|l2_switch
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"L2 switch %s\n"
argument_list|,
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
operator|(
name|vdev
operator|->
name|config
operator|.
name|l2_switch
operator|)
condition|?
literal|"enable"
else|:
literal|"disable"
else|:
literal|"change failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|vxge_hal_set_fw_api
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
literal|0ULL
argument_list|,
name|VXGE_HAL_API_FUNC_MODE_COMMIT
argument_list|,
literal|0
argument_list|,
literal|0ULL
argument_list|,
literal|0ULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_promisc_set  * Enable Promiscuous Mode  */
end_comment

begin_function
name|void
name|vxge_promisc_set
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|ifnet_t
name|ifp
decl_stmt|;
name|vxge_hal_vpath_h
name|vpath_handle
decl_stmt|;
if|if
condition|(
operator|!
name|vdev
operator|->
name|is_initialized
condition|)
return|return;
name|ifp
operator|=
name|vdev
operator|->
name|ifp
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath_handle
operator|=
name|vxge_vpath_handle_get
argument_list|(
name|vdev
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vpath_handle
condition|)
continue|continue;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
name|vxge_hal_vpath_promisc_enable
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
else|else
name|vxge_hal_vpath_promisc_disable
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_change_mtu  * Change interface MTU to a requested valid size  */
end_comment

begin_function
name|int
name|vxge_change_mtu
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|unsigned
name|long
name|new_mtu
parameter_list|)
block|{
name|int
name|err
init|=
name|EINVAL
decl_stmt|;
if|if
condition|(
operator|(
name|new_mtu
operator|<
name|VXGE_HAL_MIN_MTU
operator|)
operator|||
operator|(
name|new_mtu
operator|>
name|VXGE_HAL_MAX_MTU
operator|)
condition|)
goto|goto
name|_exit0
goto|;
operator|(
name|vdev
operator|->
name|ifp
operator|)
operator|->
name|if_mtu
operator|=
name|new_mtu
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"MTU changed to %ld\n"
argument_list|,
operator|(
name|vdev
operator|->
name|ifp
operator|)
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_initialized
condition|)
block|{
name|if_down
argument_list|(
name|vdev
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|vxge_reset
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|if_up
argument_list|(
name|vdev
operator|->
name|ifp
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
literal|0
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Creates DMA tags for both Tx and Rx  */
end_comment

begin_function
name|int
name|vxge_dma_tags_create
parameter_list|(
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|bus_size_t
name|max_size
decl_stmt|,
name|boundary
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
name|vpath
operator|->
name|vdev
decl_stmt|;
name|ifnet_t
name|ifp
init|=
name|vdev
operator|->
name|ifp
decl_stmt|;
name|max_size
operator|=
name|ifp
operator|->
name|if_mtu
operator|+
name|VXGE_HAL_MAC_HEADER_MAX_SIZE
operator|+
name|VXGE_HAL_HEADER_ETHERNET_II_802_3_ALIGN
expr_stmt|;
name|VXGE_BUFFER_ALIGN
argument_list|(
argument|max_size
argument_list|,
literal|128
argument_list|)
if|if
condition|(
name|max_size
operator|<=
name|MCLBYTES
condition|)
name|vdev
operator|->
name|rx_mbuf_sz
operator|=
name|MCLBYTES
expr_stmt|;
else|else
name|vdev
operator|->
name|rx_mbuf_sz
operator|=
operator|(
name|max_size
operator|>
name|MJUMPAGESIZE
operator|)
condition|?
name|MJUM9BYTES
else|:
name|MJUMPAGESIZE
expr_stmt|;
name|boundary
operator|=
operator|(
name|max_size
operator|>
name|PAGE_SIZE
operator|)
condition|?
literal|0
else|:
name|PAGE_SIZE
expr_stmt|;
comment|/* DMA tag for Tx */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|)
argument_list|,
literal|1
argument_list|,
name|PAGE_SIZE
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|VXGE_TSO_SIZE
argument_list|,
name|VXGE_MAX_SEGS
argument_list|,
name|PAGE_SIZE
argument_list|,
name|BUS_DMA_ALLOCNOW
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
operator|(
name|vpath
operator|->
name|dma_tag_tx
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
goto|goto
name|_exit0
goto|;
comment|/* DMA tag for Rx */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|)
argument_list|,
literal|1
argument_list|,
name|boundary
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|vdev
operator|->
name|rx_mbuf_sz
argument_list|,
literal|1
argument_list|,
name|vdev
operator|->
name|rx_mbuf_sz
argument_list|,
name|BUS_DMA_ALLOCNOW
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
operator|(
name|vpath
operator|->
name|dma_tag_rx
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
goto|goto
name|_exit1
goto|;
comment|/* Create DMA map for this descriptor */
name|err
operator|=
name|bus_dmamap_create
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|vpath
operator|->
name|extra_dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
goto|goto
name|_exit0
goto|;
name|bus_dma_tag_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_rx
argument_list|)
expr_stmt|;
name|_exit1
label|:
name|bus_dma_tag_destroy
argument_list|(
name|vpath
operator|->
name|dma_tag_tx
argument_list|)
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|vxge_dma_mbuf_coalesce
parameter_list|(
name|bus_dma_tag_t
name|dma_tag_tx
parameter_list|,
name|bus_dmamap_t
name|dma_map
parameter_list|,
name|mbuf_t
modifier|*
name|m_headp
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|dma_buffers
parameter_list|,
name|int
modifier|*
name|num_segs
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|mbuf_t
name|mbuf_pkt
init|=
name|NULL
decl_stmt|;
name|retry
label|:
name|err
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|dma_tag_tx
argument_list|,
name|dma_map
argument_list|,
operator|*
name|m_headp
argument_list|,
name|dma_buffers
argument_list|,
name|num_segs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|EFBIG
condition|)
block|{
comment|/* try to defrag, too many segments */
name|mbuf_pkt
operator|=
name|m_defrag
argument_list|(
operator|*
name|m_headp
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbuf_pkt
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
operator|*
name|m_headp
operator|=
name|mbuf_pkt
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|vxge_device_hw_info_get
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
init|=
name|ENXIO
decl_stmt|;
name|u64
name|vpath_mask
init|=
literal|0
decl_stmt|;
name|u32
name|max_supported_vpath
init|=
literal|0
decl_stmt|;
name|u32
name|fw_ver_maj_min
decl_stmt|;
name|vxge_firmware_upgrade_e
name|fw_option
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_hal_device_hw_info_t
modifier|*
name|hw_info
decl_stmt|;
name|status
operator|=
name|vxge_hal_device_hw_info_get
argument_list|(
name|vdev
operator|->
name|pdev
argument_list|,
operator|(
name|pci_reg_h
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|reg_map
index|[
literal|0
index|]
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|vdev
operator|->
name|pdev
operator|->
name|bar_info
index|[
literal|0
index|]
argument_list|,
operator|&
name|vdev
operator|->
name|config
operator|.
name|hw_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
goto|goto
name|_exit0
goto|;
name|hw_info
operator|=
operator|&
name|vdev
operator|->
name|config
operator|.
name|hw_info
expr_stmt|;
name|vpath_mask
operator|=
name|hw_info
operator|->
name|vpath_mask
expr_stmt|;
if|if
condition|(
name|vpath_mask
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"No vpaths available in device\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|fw_option
operator|=
name|vdev
operator|->
name|config
operator|.
name|fw_option
expr_stmt|;
comment|/* Check how many vpaths are available */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|vpath_mask
operator|)
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|max_supported_vpath
operator|++
expr_stmt|;
block|}
name|vdev
operator|->
name|max_supported_vpath
operator|=
name|max_supported_vpath
expr_stmt|;
name|status
operator|=
name|vxge_hal_device_is_privileged
argument_list|(
name|hw_info
operator|->
name|host_type
argument_list|,
name|hw_info
operator|->
name|func_id
argument_list|)
expr_stmt|;
name|vdev
operator|->
name|is_privilaged
operator|=
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
name|vdev
operator|->
name|hw_fw_version
operator|=
name|VXGE_FW_VERSION
argument_list|(
name|hw_info
operator|->
name|fw_version
operator|.
name|major
argument_list|,
name|hw_info
operator|->
name|fw_version
operator|.
name|minor
argument_list|,
name|hw_info
operator|->
name|fw_version
operator|.
name|build
argument_list|)
expr_stmt|;
name|fw_ver_maj_min
operator|=
name|VXGE_FW_MAJ_MIN_VERSION
argument_list|(
name|hw_info
operator|->
name|fw_version
operator|.
name|major
argument_list|,
name|hw_info
operator|->
name|fw_version
operator|.
name|minor
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fw_option
operator|>=
name|VXGE_FW_UPGRADE_FORCE
operator|)
operator|||
operator|(
name|vdev
operator|->
name|hw_fw_version
operator|!=
name|VXGE_DRV_FW_VERSION
operator|)
condition|)
block|{
comment|/* For fw_ver 1.8.1 and above ignore build number. */
if|if
condition|(
operator|(
name|fw_option
operator|==
name|VXGE_FW_UPGRADE_ALL
operator|)
operator|&&
operator|(
operator|(
name|vdev
operator|->
name|hw_fw_version
operator|>=
name|VXGE_FW_VERSION
argument_list|(
literal|1
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|)
operator|)
operator|&&
operator|(
name|fw_ver_maj_min
operator|==
name|VXGE_DRV_FW_MAJ_MIN_VERSION
operator|)
operator|)
condition|)
block|{
goto|goto
name|_exit1
goto|;
block|}
if|if
condition|(
name|vdev
operator|->
name|hw_fw_version
operator|<
name|VXGE_BASE_FW_VERSION
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Upgrade driver through vxge_update, "
literal|"Unable to load the driver.\n"
argument_list|)
expr_stmt|;
goto|goto
name|_exit0
goto|;
block|}
name|vdev
operator|->
name|fw_upgrade
operator|=
name|TRUE
expr_stmt|;
block|}
name|_exit1
label|:
name|err
operator|=
literal|0
expr_stmt|;
name|_exit0
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_device_hw_info_print  * Print device and driver information  */
end_comment

begin_function
name|void
name|vxge_device_hw_info_print
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|device_t
name|ndev
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|children
decl_stmt|;
name|char
name|pmd_type
index|[
literal|2
index|]
index|[
name|VXGE_PMD_INFO_LEN
index|]
decl_stmt|;
name|vxge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_device_hw_info_t
modifier|*
name|hw_info
decl_stmt|;
name|vxge_hal_device_pmd_info_t
modifier|*
name|pmd_port
decl_stmt|;
name|hldev
operator|=
name|vdev
operator|->
name|devh
expr_stmt|;
name|ndev
operator|=
name|vdev
operator|->
name|ndev
expr_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
name|children
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|ndev
argument_list|)
argument_list|)
expr_stmt|;
name|hw_info
operator|=
operator|&
operator|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_DRV_VERSION
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_DRV_VERSION
index|]
argument_list|)
argument_list|,
literal|"%d.%d.%d.%d"
argument_list|,
name|XGELL_VERSION_MAJOR
argument_list|,
name|XGELL_VERSION_MINOR
argument_list|,
name|XGELL_VERSION_FIX
argument_list|,
name|XGELL_VERSION_BUILD
argument_list|)
expr_stmt|;
comment|/* Print PCI-e bus type/speed/width info */
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PCIE_INFO
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PCIE_INFO
index|]
argument_list|)
argument_list|,
literal|"x%d"
argument_list|,
name|hldev
operator|->
name|link_width
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|link_width
operator|<=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X4
condition|)
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"For optimal performance a x8 "
literal|"PCI-Express slot is required.\n"
argument_list|)
expr_stmt|;
name|vxge_null_terminate
argument_list|(
operator|(
name|char
operator|*
operator|)
name|hw_info
operator|->
name|serial_number
argument_list|,
sizeof|sizeof
argument_list|(
name|hw_info
operator|->
name|serial_number
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_null_terminate
argument_list|(
operator|(
name|char
operator|*
operator|)
name|hw_info
operator|->
name|part_number
argument_list|,
sizeof|sizeof
argument_list|(
name|hw_info
operator|->
name|part_number
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_SERIAL_NO
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_SERIAL_NO
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|hw_info
operator|->
name|serial_number
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PART_NO
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PART_NO
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|hw_info
operator|->
name|part_number
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_VERSION
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_VERSION
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|hw_info
operator|->
name|fw_version
operator|.
name|version
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_DATE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_DATE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|hw_info
operator|->
name|fw_date
operator|.
name|date
argument_list|)
expr_stmt|;
name|pmd_port
operator|=
operator|&
operator|(
name|hw_info
operator|->
name|pmd_port0
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hw_info
operator|->
name|ports
condition|;
name|i
operator|++
control|)
block|{
name|vxge_pmd_port_type_get
argument_list|(
name|vdev
argument_list|,
name|pmd_port
operator|->
name|type
argument_list|,
name|pmd_type
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|pmd_type
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_0
operator|+
name|i
index|]
argument_list|,
literal|"vendor=??, sn=??, pn=??, type=??"
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_0
operator|+
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_null_terminate
argument_list|(
name|pmd_port
operator|->
name|vendor
argument_list|,
sizeof|sizeof
argument_list|(
name|pmd_port
operator|->
name|vendor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pmd_port
operator|->
name|vendor
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pmd_port
operator|=
operator|&
operator|(
name|hw_info
operator|->
name|pmd_port1
operator|)
expr_stmt|;
continue|continue;
block|}
name|vxge_null_terminate
argument_list|(
name|pmd_port
operator|->
name|ser_num
argument_list|,
sizeof|sizeof
argument_list|(
name|pmd_port
operator|->
name|ser_num
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_null_terminate
argument_list|(
name|pmd_port
operator|->
name|part_num
argument_list|,
sizeof|sizeof
argument_list|(
name|pmd_port
operator|->
name|part_num
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_0
operator|+
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_0
operator|+
name|i
index|]
argument_list|)
argument_list|,
literal|"vendor=%s, sn=%s, pn=%s, type=%s"
argument_list|,
name|pmd_port
operator|->
name|vendor
argument_list|,
name|pmd_port
operator|->
name|ser_num
argument_list|,
name|pmd_port
operator|->
name|part_num
argument_list|,
name|pmd_type
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|pmd_port
operator|=
operator|&
operator|(
name|hw_info
operator|->
name|pmd_port1
operator|)
expr_stmt|;
block|}
switch|switch
condition|(
name|hw_info
operator|->
name|function_mode
condition|)
block|{
case|case
name|VXGE_HAL_PCIE_FUNC_MODE_SF1_VP17
case|:
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|)
argument_list|,
literal|"%s %d %s"
argument_list|,
literal|"Single Function - 1 function(s)"
argument_list|,
name|vdev
operator|->
name|max_supported_vpath
argument_list|,
literal|"VPath(s)/function"
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCIE_FUNC_MODE_MF2_VP8
case|:
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|)
argument_list|,
literal|"%s %d %s"
argument_list|,
literal|"Multi Function - 2 function(s)"
argument_list|,
name|vdev
operator|->
name|max_supported_vpath
argument_list|,
literal|"VPath(s)/function"
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCIE_FUNC_MODE_MF4_VP4
case|:
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|)
argument_list|,
literal|"%s %d %s"
argument_list|,
literal|"Multi Function - 4 function(s)"
argument_list|,
name|vdev
operator|->
name|max_supported_vpath
argument_list|,
literal|"VPath(s)/function"
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCIE_FUNC_MODE_MF8_VP2
case|:
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|)
argument_list|,
literal|"%s %d %s"
argument_list|,
literal|"Multi Function - 8 function(s)"
argument_list|,
name|vdev
operator|->
name|max_supported_vpath
argument_list|,
literal|"VPath(s)/function"
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCIE_FUNC_MODE_MF8P_VP2
case|:
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|)
argument_list|,
literal|"%s %d %s"
argument_list|,
literal|"Multi Function (DirectIO) - 8 function(s)"
argument_list|,
name|vdev
operator|->
name|max_supported_vpath
argument_list|,
literal|"VPath(s)/function"
argument_list|)
expr_stmt|;
break|break;
block|}
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_INTR_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_INTR_MODE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
operator|(
operator|(
name|vdev
operator|->
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_MSIX
operator|)
condition|?
literal|"MSI-X"
else|:
literal|"INTA"
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_VPATH_COUNT
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_VPATH_COUNT
index|]
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|vdev
operator|->
name|no_of_vpath
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_MTU_SIZE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_MTU_SIZE
index|]
argument_list|)
argument_list|,
literal|"%lu"
argument_list|,
name|vdev
operator|->
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_LRO_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_LRO_MODE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
operator|(
operator|(
name|vdev
operator|->
name|config
operator|.
name|lro_enable
operator|)
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_RTH_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_RTH_MODE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
operator|(
operator|(
name|vdev
operator|->
name|config
operator|.
name|rth_enable
operator|)
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_TSO_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_TSO_MODE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
operator|(
operator|(
name|vdev
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO4
operator|)
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
operator|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_ADAPTER_TYPE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_ADAPTER_TYPE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
operator|(
operator|(
name|hw_info
operator|->
name|ports
operator|==
literal|1
operator|)
condition|?
literal|"Single Port"
else|:
literal|"Dual Port"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
if|if
condition|(
name|hw_info
operator|->
name|ports
operator|>
literal|1
condition|)
block|{
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_MODE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|vxge_port_mode
index|[
name|vdev
operator|->
name|port_mode
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|port_mode
operator|!=
name|VXGE_HAL_DP_NP_MODE_SINGLE_PORT
condition|)
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_FAILURE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_FAILURE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|vxge_port_failure
index|[
name|vdev
operator|->
name|port_failure
index|]
argument_list|)
expr_stmt|;
name|vxge_active_port_update
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_ACTIVE_PORT
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_ACTIVE_PORT
index|]
argument_list|)
argument_list|,
literal|"%lld"
argument_list|,
name|vdev
operator|->
name|active_port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|is_single_func
argument_list|(
name|hw_info
operator|->
name|function_mode
argument_list|)
condition|)
block|{
name|snprintf
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_L2SWITCH_MODE
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_L2SWITCH_MODE
index|]
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
operator|(
operator|(
name|vdev
operator|->
name|l2_switch
operator|)
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Driver version\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_DRV_VERSION
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Serial number\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_SERIAL_NO
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Part number\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PART_NO
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Firmware version\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_VERSION
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Firmware date\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_DATE
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Link width\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PCIE_INFO
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Function mode\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Interrupt type\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_INTR_MODE
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"VPath(s) opened\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_VPATH_COUNT
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Adapter Type\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_ADAPTER_TYPE
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"PMD Port 0\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw_info
operator|->
name|ports
operator|>
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"PMD Port 1\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Port Mode\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_MODE
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|port_mode
operator|!=
name|VXGE_HAL_DP_NP_MODE_SINGLE_PORT
condition|)
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"Port Failure\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_FAILURE
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"Active Port\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_ACTIVE_PORT
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
operator|&&
operator|!
name|is_single_func
argument_list|(
name|hw_info
operator|->
name|function_mode
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"L2 Switch\t: %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_L2SWITCH_MODE
index|]
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"MTU is %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_MTU_SIZE
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"LRO %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_LRO_MODE
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"RTH %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_RTH_MODE
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|ndev
argument_list|,
literal|"TSO %s\n"
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_TSO_MODE
index|]
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Driver version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_DRV_VERSION
index|]
argument_list|,
literal|0
argument_list|,
literal|"Driver version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Serial number"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_SERIAL_NO
index|]
argument_list|,
literal|0
argument_list|,
literal|"Serial number"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Part number"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PART_NO
index|]
argument_list|,
literal|0
argument_list|,
literal|"Part number"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Firmware version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_VERSION
index|]
argument_list|,
literal|0
argument_list|,
literal|"Firmware version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Firmware date"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FW_DATE
index|]
argument_list|,
literal|0
argument_list|,
literal|"Firmware date"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Link width"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PCIE_INFO
index|]
argument_list|,
literal|0
argument_list|,
literal|"Link width"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Function mode"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_FUNC_MODE
index|]
argument_list|,
literal|0
argument_list|,
literal|"Function mode"
argument_list|)
expr_stmt|;
block|}
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Interrupt type"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_INTR_MODE
index|]
argument_list|,
literal|0
argument_list|,
literal|"Interrupt type"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"VPath(s) opened"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_VPATH_COUNT
index|]
argument_list|,
literal|0
argument_list|,
literal|"VPath(s) opened"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Adapter Type"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_ADAPTER_TYPE
index|]
argument_list|,
literal|0
argument_list|,
literal|"Adapter Type"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pmd port 0"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_0
index|]
argument_list|,
literal|0
argument_list|,
literal|"pmd port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hw_info
operator|->
name|ports
operator|>
literal|1
condition|)
block|{
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pmd port 1"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PMD_PORTS_1
index|]
argument_list|,
literal|0
argument_list|,
literal|"pmd port"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Port Mode"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_MODE
index|]
argument_list|,
literal|0
argument_list|,
literal|"Port Mode"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdev
operator|->
name|port_mode
operator|!=
name|VXGE_HAL_DP_NP_MODE_SINGLE_PORT
condition|)
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"Port Failure"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_PORT_FAILURE
index|]
argument_list|,
literal|0
argument_list|,
literal|"Port Failure"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"L2 Switch"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_L2SWITCH_MODE
index|]
argument_list|,
literal|0
argument_list|,
literal|"L2 Switch"
argument_list|)
expr_stmt|;
block|}
block|}
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"LRO mode"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_LRO_MODE
index|]
argument_list|,
literal|0
argument_list|,
literal|"LRO mode"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"RTH mode"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_RTH_MODE
index|]
argument_list|,
literal|0
argument_list|,
literal|"RTH mode"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|children
argument_list|,
name|OID_AUTO
argument_list|,
literal|"TSO mode"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|vdev
operator|->
name|config
operator|.
name|nic_attr
index|[
name|VXGE_PRINT_TSO_MODE
index|]
argument_list|,
literal|0
argument_list|,
literal|"TSO mode"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vxge_pmd_port_type_get
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|u32
name|port_type
parameter_list|,
name|char
modifier|*
name|ifm_name
parameter_list|,
name|u8
name|ifm_len
parameter_list|)
block|{
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_UNKNOWN
expr_stmt|;
switch|switch
condition|(
name|port_type
condition|)
block|{
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_10G_SR
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_10G_SR
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"10GbE SR"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_10G_LR
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_10G_LR
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"10GbE LR"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_10G_LRM
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_10G_LRM
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"10GbE LRM"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_10G_DIRECT
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_10G_TWINAX
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"10GbE DA (Direct Attached)"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_10G_CX4
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_10G_CX4
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"10GbE CX4"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_10G_BASE_T
case|:
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_10G_T
expr_stmt|;
endif|#
directive|endif
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"10GbE baseT"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_10G_OTHER
case|:
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"10GbE Other"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_1G_SX
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_1000_SX
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"1GbE SX"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_1G_LX
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_1000_LX
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"1GbE LX"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_1G_CX
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_1000_CX
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"1GbE CX"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_1G_BASE_T
case|:
name|vdev
operator|->
name|ifm_optics
operator|=
name|IFM_1000_T
expr_stmt|;
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"1GbE baseT"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_1G_DIRECT
case|:
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"1GbE DA (Direct Attached)"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_1G_CX4
case|:
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"1GbE CX4"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_1G_OTHER
case|:
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"1GbE Other"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
default|default:
case|case
name|VXGE_HAL_DEVICE_PMD_TYPE_UNKNOWN
case|:
name|strlcpy
argument_list|(
name|ifm_name
argument_list|,
literal|"UNSUP"
argument_list|,
name|ifm_len
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|u32
name|vxge_ring_length_get
parameter_list|(
name|u32
name|buffer_mode
parameter_list|)
block|{
return|return
operator|(
name|VXGE_DEFAULT_RING_BLOCK
operator|*
name|vxge_hal_ring_rxds_per_block_get
argument_list|(
name|buffer_mode
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Removes trailing spaces padded  * and NULL terminates strings  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|vxge_null_terminate
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|len
operator|--
expr_stmt|;
while|while
condition|(
operator|*
name|str
operator|&&
operator|(
operator|*
name|str
operator|!=
literal|' '
operator|)
operator|&&
operator|(
name|len
operator|!=
literal|0
operator|)
condition|)
operator|++
name|str
expr_stmt|;
operator|--
name|len
expr_stmt|;
if|if
condition|(
operator|*
name|str
condition|)
operator|*
name|str
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_ioctl  * Callback to control the device  */
end_comment

begin_function
name|int
name|vxge_ioctl
parameter_list|(
name|ifnet_t
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|int
name|mask
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|vxge_dev_t
modifier|*
name|vdev
init|=
operator|(
name|vxge_dev_t
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
if|if
condition|(
operator|!
name|vdev
operator|->
name|is_active
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
switch|switch
condition|(
name|command
condition|)
block|{
comment|/* Set/Get ifnet address */
case|case
name|SIOCSIFADDR
case|:
case|case
name|SIOCGIFADDR
case|:
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
comment|/* Set Interface MTU */
case|case
name|SIOCSIFMTU
case|:
name|err
operator|=
name|vxge_change_mtu
argument_list|(
name|vdev
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ifr
operator|->
name|ifr_mtu
argument_list|)
expr_stmt|;
break|break;
comment|/* Set Interface Flags */
case|case
name|SIOCSIFFLAGS
case|:
name|VXGE_DRV_LOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|vdev
operator|->
name|if_flags
operator|)
operator|&
operator|(
name|IFF_PROMISC
operator||
name|IFF_ALLMULTI
operator|)
condition|)
name|vxge_promisc_set
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vxge_init_locked
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|vxge_stop_locked
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
block|}
name|vdev
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|VXGE_DRV_UNLOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
break|break;
comment|/* Add/delete multicast address */
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
break|break;
comment|/* Get/Set Interface Media */
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|err
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|vdev
operator|->
name|media
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
comment|/* Set Capabilities */
case|case
name|SIOCSIFCAP
case|:
name|VXGE_DRV_LOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|mask
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TXCSUM
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|^=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO
operator|)
operator|&&
operator|!
operator|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
operator|)
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"TSO Disabled\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_RXCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO4
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
condition|)
block|{
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"TSO Enabled\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Enable tx checksum offload \ 					     first.\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|EAGAIN
expr_stmt|;
block|}
block|}
else|else
block|{
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"TSO Disabled\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_LRO
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_LRO
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_MTU
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_MTU
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWCSUM
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|800000
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTSO
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTSO
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VLAN_CAPABILITIES
argument_list|)
name|VLAN_CAPABILITIES
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|VXGE_DRV_UNLOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGPRIVATE_0
case|:
name|VXGE_DRV_LOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|err
operator|=
name|vxge_ioctl_stats
argument_list|(
name|vdev
argument_list|,
name|ifr
argument_list|)
expr_stmt|;
name|VXGE_DRV_UNLOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGPRIVATE_1
case|:
name|VXGE_DRV_LOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
name|err
operator|=
name|vxge_ioctl_regs
argument_list|(
name|vdev
argument_list|,
name|ifr
argument_list|)
expr_stmt|;
name|VXGE_DRV_UNLOCK
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
break|break;
default|default:
name|err
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_ioctl_regs  * IOCTL to get registers  */
end_comment

begin_function
name|int
name|vxge_ioctl_regs
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|struct
name|ifreq
modifier|*
name|ifr
parameter_list|)
block|{
name|u64
name|value
init|=
literal|0x0
decl_stmt|;
name|u32
name|vp_id
init|=
literal|0
decl_stmt|;
name|u32
name|offset
decl_stmt|,
name|reqd_size
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
init|=
name|EINVAL
decl_stmt|;
name|char
modifier|*
name|command
init|=
operator|(
name|char
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
decl_stmt|;
name|void
modifier|*
name|reg_info
init|=
operator|(
name|void
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_hal_mgmt_reg_type_e
name|regs_type
decl_stmt|;
switch|switch
condition|(
operator|*
name|command
condition|)
block|{
case|case
name|vxge_hal_mgmt_reg_type_pcicfgmgmt
case|:
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_pcicfgmgmt_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_pcicfgmgmt
expr_stmt|;
block|}
break|break;
case|case
name|vxge_hal_mgmt_reg_type_mrpcim
case|:
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_mrpcim_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_mrpcim
expr_stmt|;
block|}
break|break;
case|case
name|vxge_hal_mgmt_reg_type_srpcim
case|:
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_srpcim_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_srpcim
expr_stmt|;
block|}
break|break;
case|case
name|vxge_hal_mgmt_reg_type_memrepair
case|:
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
comment|/* reqd_size = sizeof(vxge_hal_memrepair_reg_t); */
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_memrepair
expr_stmt|;
block|}
break|break;
case|case
name|vxge_hal_mgmt_reg_type_legacy
case|:
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_legacy_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_legacy
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_toc
case|:
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_toc_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_toc
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_common
case|:
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_common_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_common
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpmgmt
case|:
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_vpmgmt_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_vpmgmt
expr_stmt|;
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
operator|*
operator|(
operator|(
name|u32
operator|*
operator|)
name|reg_info
operator|+
literal|1
operator|)
index|]
operator|)
expr_stmt|;
name|vp_id
operator|=
name|vpath
operator|->
name|vp_id
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpath
case|:
name|reqd_size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
expr_stmt|;
name|regs_type
operator|=
name|vxge_hal_mgmt_reg_type_vpath
expr_stmt|;
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
operator|*
operator|(
operator|(
name|u32
operator|*
operator|)
name|reg_info
operator|+
literal|1
operator|)
index|]
operator|)
expr_stmt|;
name|vp_id
operator|=
name|vpath
operator|->
name|vp_id
expr_stmt|;
break|break;
case|case
name|VXGE_GET_VPATH_COUNT
case|:
operator|*
operator|(
operator|(
name|u32
operator|*
operator|)
name|reg_info
operator|)
operator|=
name|vdev
operator|->
name|no_of_vpath
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|reqd_size
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|reqd_size
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|reqd_size
condition|;
name|i
operator|++
operator|,
name|offset
operator|+=
literal|0x0008
control|)
block|{
name|value
operator|=
literal|0x0
expr_stmt|;
name|status
operator|=
name|vxge_hal_mgmt_reg_read
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|regs_type
argument_list|,
name|vp_id
argument_list|,
name|offset
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
name|err
operator|=
operator|(
name|status
operator|!=
name|VXGE_HAL_OK
operator|)
condition|?
name|EINVAL
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|EINVAL
condition|)
break|break;
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
operator|(
name|u64
operator|*
operator|)
name|reg_info
operator|+
name|i
operator|)
operator|)
operator|=
name|value
expr_stmt|;
block|}
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_ioctl_stats  * IOCTL to get statistics  */
end_comment

begin_function
name|int
name|vxge_ioctl_stats
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|struct
name|ifreq
modifier|*
name|ifr
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|retsize
decl_stmt|,
name|err
init|=
name|EINVAL
decl_stmt|;
name|u32
name|bufsize
decl_stmt|;
name|vxge_vpath_t
modifier|*
name|vpath
decl_stmt|;
name|vxge_bw_info_t
modifier|*
name|bw_info
decl_stmt|;
name|vxge_port_info_t
modifier|*
name|port_info
decl_stmt|;
name|vxge_drv_stats_t
modifier|*
name|drv_stat
decl_stmt|;
name|char
modifier|*
name|buffer
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|command
init|=
operator|(
name|char
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
switch|switch
condition|(
operator|*
name|command
condition|)
block|{
case|case
name|VXGE_GET_PCI_CONF
case|:
name|bufsize
operator|=
name|VXGE_STATS_BUFFER_SIZE
expr_stmt|;
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
operator|!=
name|NULL
condition|)
block|{
name|status
operator|=
name|vxge_hal_aux_pci_config_read
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|bufsize
argument_list|,
name|buffer
argument_list|,
operator|&
name|retsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|err
operator|=
name|copyout
argument_list|(
name|buffer
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
name|retsize
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed pciconfig statistics query\n"
argument_list|)
expr_stmt|;
name|vxge_mem_free
argument_list|(
name|buffer
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_GET_MRPCIM_STATS
case|:
if|if
condition|(
operator|!
name|vdev
operator|->
name|is_privilaged
condition|)
break|break;
name|bufsize
operator|=
name|VXGE_STATS_BUFFER_SIZE
expr_stmt|;
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
operator|!=
name|NULL
condition|)
block|{
name|status
operator|=
name|vxge_hal_aux_stats_mrpcim_read
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|bufsize
argument_list|,
name|buffer
argument_list|,
operator|&
name|retsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|err
operator|=
name|copyout
argument_list|(
name|buffer
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
name|retsize
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed mrpcim statistics query\n"
argument_list|)
expr_stmt|;
name|vxge_mem_free
argument_list|(
name|buffer
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_GET_DEVICE_STATS
case|:
name|bufsize
operator|=
name|VXGE_STATS_BUFFER_SIZE
expr_stmt|;
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
operator|!=
name|NULL
condition|)
block|{
name|status
operator|=
name|vxge_hal_aux_stats_device_read
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|bufsize
argument_list|,
name|buffer
argument_list|,
operator|&
name|retsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|err
operator|=
name|copyout
argument_list|(
name|buffer
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
name|retsize
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed device statistics query\n"
argument_list|)
expr_stmt|;
name|vxge_mem_free
argument_list|(
name|buffer
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_GET_DEVICE_HWINFO
case|:
name|bufsize
operator|=
sizeof|sizeof
argument_list|(
name|vxge_device_hw_info_t
argument_list|)
expr_stmt|;
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
operator|!=
name|NULL
condition|)
block|{
name|vxge_os_memcpy
argument_list|(
operator|&
operator|(
operator|(
operator|(
name|vxge_device_hw_info_t
operator|*
operator|)
name|buffer
operator|)
operator|->
name|hw_info
operator|)
argument_list|,
operator|&
name|vdev
operator|->
name|config
operator|.
name|hw_info
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|(
name|vxge_device_hw_info_t
operator|*
operator|)
name|buffer
operator|)
operator|->
name|port_mode
operator|=
name|vdev
operator|->
name|port_mode
expr_stmt|;
operator|(
operator|(
name|vxge_device_hw_info_t
operator|*
operator|)
name|buffer
operator|)
operator|->
name|port_failure
operator|=
name|vdev
operator|->
name|port_failure
expr_stmt|;
name|err
operator|=
name|copyout
argument_list|(
name|buffer
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed device hardware info query\n"
argument_list|)
expr_stmt|;
name|vxge_mem_free
argument_list|(
name|buffer
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_GET_DRIVER_STATS
case|:
name|bufsize
operator|=
sizeof|sizeof
argument_list|(
name|vxge_drv_stats_t
argument_list|)
operator|*
name|vdev
operator|->
name|no_of_vpath
expr_stmt|;
name|drv_stat
operator|=
operator|(
name|vxge_drv_stats_t
operator|*
operator|)
name|vxge_mem_alloc
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv_stat
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_vpath
condition|;
name|i
operator|++
control|)
block|{
name|vpath
operator|=
operator|&
operator|(
name|vdev
operator|->
name|vpaths
index|[
name|i
index|]
operator|)
expr_stmt|;
name|vpath
operator|->
name|driver_stats
operator|.
name|rx_lro_queued
operator|+=
name|vpath
operator|->
name|lro
operator|.
name|lro_queued
expr_stmt|;
name|vpath
operator|->
name|driver_stats
operator|.
name|rx_lro_flushed
operator|+=
name|vpath
operator|->
name|lro
operator|.
name|lro_flushed
expr_stmt|;
name|vxge_os_memcpy
argument_list|(
operator|&
name|drv_stat
index|[
name|i
index|]
argument_list|,
operator|&
operator|(
name|vpath
operator|->
name|driver_stats
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_drv_stats_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|copyout
argument_list|(
name|drv_stat
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"failed driver statistics query\n"
argument_list|)
expr_stmt|;
name|vxge_mem_free
argument_list|(
name|drv_stat
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_GET_BANDWIDTH
case|:
name|bw_info
operator|=
operator|(
name|vxge_bw_info_t
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
if|if
condition|(
operator|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|func_id
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|vdev
operator|->
name|hw_fw_version
operator|<
name|VXGE_FW_VERSION
argument_list|(
literal|1
argument_list|,
literal|8
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
break|break;
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|func_id
operator|!=
literal|0
condition|)
name|bw_info
operator|->
name|func_id
operator|=
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|func_id
expr_stmt|;
name|status
operator|=
name|vxge_bw_priority_get
argument_list|(
name|vdev
argument_list|,
name|bw_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
break|break;
name|err
operator|=
name|copyout
argument_list|(
name|bw_info
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_bw_info_t
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_SET_BANDWIDTH
case|:
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
name|err
operator|=
name|vxge_bw_priority_set
argument_list|(
name|vdev
argument_list|,
name|ifr
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_SET_PORT_MODE
case|:
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|ports
operator|==
name|VXGE_DUAL_PORT_MODE
condition|)
block|{
name|port_info
operator|=
operator|(
name|vxge_port_info_t
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|port_mode
operator|=
name|port_info
operator|->
name|port_mode
expr_stmt|;
name|err
operator|=
name|vxge_port_mode_update
argument_list|(
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|ENXIO
condition|)
name|err
operator|=
name|VXGE_HAL_FAIL
expr_stmt|;
else|else
block|{
name|err
operator|=
name|VXGE_HAL_OK
expr_stmt|;
name|device_printf
argument_list|(
name|vdev
operator|->
name|ndev
argument_list|,
literal|"PLEASE POWER CYCLE THE SYSTEM\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
case|case
name|VXGE_GET_PORT_MODE
case|:
if|if
condition|(
name|vdev
operator|->
name|is_privilaged
condition|)
block|{
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|hw_info
operator|.
name|ports
operator|==
name|VXGE_DUAL_PORT_MODE
condition|)
block|{
name|port_info
operator|=
operator|(
name|vxge_port_info_t
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
name|err
operator|=
name|vxge_port_mode_get
argument_list|(
name|vdev
argument_list|,
name|port_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|err
operator|=
name|copyout
argument_list|(
name|port_info
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_port_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|vxge_bw_priority_config
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|int
name|err
init|=
name|EINVAL
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|no_of_func
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|vxge_bw_priority_update
argument_list|(
name|vdev
argument_list|,
name|i
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
break|break;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|vxge_bw_priority_set
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|struct
name|ifreq
modifier|*
name|ifr
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|u32
name|func_id
decl_stmt|;
name|vxge_bw_info_t
modifier|*
name|bw_info
decl_stmt|;
name|bw_info
operator|=
operator|(
name|vxge_bw_info_t
operator|*
operator|)
name|ifr
operator|->
name|ifr_data
expr_stmt|;
name|func_id
operator|=
name|bw_info
operator|->
name|func_id
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|priority
operator|=
name|bw_info
operator|->
name|priority
expr_stmt|;
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|bandwidth
operator|=
name|bw_info
operator|->
name|bandwidth
expr_stmt|;
name|err
operator|=
name|vxge_bw_priority_update
argument_list|(
name|vdev
argument_list|,
name|func_id
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|vxge_bw_priority_update
parameter_list|(
name|vxge_dev_t
modifier|*
name|vdev
parameter_list|,
name|u32
name|func_id
parameter_list|,
name|bool
name|binit
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|set
init|=
literal|0
decl_stmt|;
name|u32
name|bandwidth
decl_stmt|,
name|priority
decl_stmt|,
name|vpath_count
decl_stmt|;
name|u64
name|vpath_list
index|[
name|VXGE_HAL_MAX_VIRTUAL_PATHS
index|]
decl_stmt|;
name|vxge_hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_vp_config_t
modifier|*
name|vp_config
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|hldev
operator|=
name|vdev
operator|->
name|devh
expr_stmt|;
name|status
operator|=
name|vxge_hal_get_vpath_list
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|func_id
argument_list|,
name|vpath_list
argument_list|,
operator|&
name|vpath_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
return|return
operator|(
name|status
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vpath_count
condition|;
name|i
operator|++
control|)
block|{
name|vp_config
operator|=
operator|&
operator|(
name|hldev
operator|->
name|config
operator|.
name|vp_config
index|[
name|vpath_list
index|[
name|i
index|]
index|]
operator|)
expr_stmt|;
comment|/* Configure Bandwidth */
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|bandwidth
operator|!=
name|VXGE_HAL_VPATH_BW_LIMIT_DEFAULT
condition|)
block|{
name|set
operator|=
literal|1
expr_stmt|;
name|bandwidth
operator|=
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|bandwidth
expr_stmt|;
if|if
condition|(
name|bandwidth
operator|<
name|VXGE_HAL_VPATH_BW_LIMIT_MIN
operator|||
name|bandwidth
operator|>
name|VXGE_HAL_VPATH_BW_LIMIT_MAX
condition|)
block|{
name|bandwidth
operator|=
name|VXGE_HAL_VPATH_BW_LIMIT_DEFAULT
expr_stmt|;
block|}
name|vp_config
operator|->
name|bandwidth
operator|=
name|bandwidth
expr_stmt|;
block|}
comment|/* 		 * If b/w limiting is enabled on any of the 		 * VFs, then for remaining VFs set the priority to 3 		 * and b/w limiting to max i.e 10 Gb) 		 */
if|if
condition|(
name|vp_config
operator|->
name|bandwidth
operator|==
name|VXGE_HAL_VPATH_BW_LIMIT_DEFAULT
condition|)
name|vp_config
operator|->
name|bandwidth
operator|=
name|VXGE_HAL_VPATH_BW_LIMIT_MAX
expr_stmt|;
if|if
condition|(
name|binit
operator|&&
name|vdev
operator|->
name|config
operator|.
name|low_latency
condition|)
block|{
if|if
condition|(
name|func_id
operator|==
literal|0
condition|)
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|priority
operator|=
name|VXGE_DEFAULT_VPATH_PRIORITY_HIGH
expr_stmt|;
block|}
comment|/* Configure Priority */
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|priority
operator|!=
name|VXGE_HAL_VPATH_PRIORITY_DEFAULT
condition|)
block|{
name|set
operator|=
literal|1
expr_stmt|;
name|priority
operator|=
name|vdev
operator|->
name|config
operator|.
name|bw_info
index|[
name|func_id
index|]
operator|.
name|priority
expr_stmt|;
if|if
condition|(
name|priority
operator|<
name|VXGE_HAL_VPATH_PRIORITY_MIN
operator|||
name|priority
operator|>
name|VXGE_HAL_VPATH_PRIORITY_MAX
condition|)
block|{
name|priority
operator|=
name|VXGE_HAL_VPATH_PRIORITY_DEFAULT
expr_stmt|;
block|}
name|vp_config
operator|->
name|priority
operator|=
name|priority
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vdev
operator|->
name|config
operator|.
name|low_latency
condition|)
block|{
name|set
operator|=
literal|1
expr_stmt|;
name|vp_config
operator|->
name|priority
operator|=
name|VXGE_DEFAULT_VPATH_PRIORITY_LOW
expr_stmt|;
block|}
if|if
condition|(
name|set
operator|==
literal|1
condition|)
block|{
name|status
operator|=
name|vxge_hal_rx_bw_priority_set
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vpath_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
break|break;
if|if
condition|(
name|vpath_list
index|[
name|i
index|]
operator|<
name|VXGE_HAL_TX_BW_VPATH_LIMIT
condition|)
block|{
name|status
operator|=
name|vxge_hal_tx_bw_priority_set
argument_list|(
name|vdev
operator|->
name|devh
argument_list|,
name|vpath_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
break|break;
block|}
block|}
block|}
return|return
operator|(
operator|(
name|status
operator|==
name|VXGE_HAL_OK
operator|)
condition|?
literal|0
else|:
name|EINVAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_intr_coalesce_tx  * Changes interrupt coalescing if the interrupts are not within a range  * Return Value: Nothing  */
end_comment

begin_function
name|void
name|vxge_intr_coalesce_tx
parameter_list|(
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|)
block|{
name|u32
name|timer
decl_stmt|;
if|if
condition|(
operator|!
name|vpath
operator|->
name|tx_intr_coalesce
condition|)
return|return;
name|vpath
operator|->
name|tx_interrupts
operator|++
expr_stmt|;
if|if
condition|(
name|ticks
operator|>
name|vpath
operator|->
name|tx_ticks
operator|+
name|hz
operator|/
literal|100
condition|)
block|{
name|vpath
operator|->
name|tx_ticks
operator|=
name|ticks
expr_stmt|;
name|timer
operator|=
name|vpath
operator|->
name|tti_rtimer_val
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|tx_interrupts
operator|>
name|VXGE_MAX_TX_INTERRUPT_COUNT
condition|)
block|{
if|if
condition|(
name|timer
operator|!=
name|VXGE_TTI_RTIMER_ADAPT_VAL
condition|)
block|{
name|vpath
operator|->
name|tti_rtimer_val
operator|=
name|VXGE_TTI_RTIMER_ADAPT_VAL
expr_stmt|;
name|vxge_hal_vpath_dynamic_tti_rtimer_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|tti_rtimer_val
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|timer
operator|!=
literal|0
condition|)
block|{
name|vpath
operator|->
name|tti_rtimer_val
operator|=
literal|0
expr_stmt|;
name|vxge_hal_vpath_dynamic_tti_rtimer_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|tti_rtimer_val
argument_list|)
expr_stmt|;
block|}
block|}
name|vpath
operator|->
name|tx_interrupts
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_intr_coalesce_rx  * Changes interrupt coalescing if the interrupts are not within a range  * Return Value: Nothing  */
end_comment

begin_function
name|void
name|vxge_intr_coalesce_rx
parameter_list|(
name|vxge_vpath_t
modifier|*
name|vpath
parameter_list|)
block|{
name|u32
name|timer
decl_stmt|;
if|if
condition|(
operator|!
name|vpath
operator|->
name|rx_intr_coalesce
condition|)
return|return;
name|vpath
operator|->
name|rx_interrupts
operator|++
expr_stmt|;
if|if
condition|(
name|ticks
operator|>
name|vpath
operator|->
name|rx_ticks
operator|+
name|hz
operator|/
literal|100
condition|)
block|{
name|vpath
operator|->
name|rx_ticks
operator|=
name|ticks
expr_stmt|;
name|timer
operator|=
name|vpath
operator|->
name|rti_rtimer_val
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|rx_interrupts
operator|>
name|VXGE_MAX_RX_INTERRUPT_COUNT
condition|)
block|{
if|if
condition|(
name|timer
operator|!=
name|VXGE_RTI_RTIMER_ADAPT_VAL
condition|)
block|{
name|vpath
operator|->
name|rti_rtimer_val
operator|=
name|VXGE_RTI_RTIMER_ADAPT_VAL
expr_stmt|;
name|vxge_hal_vpath_dynamic_rti_rtimer_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|rti_rtimer_val
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|timer
operator|!=
literal|0
condition|)
block|{
name|vpath
operator|->
name|rti_rtimer_val
operator|=
literal|0
expr_stmt|;
name|vxge_hal_vpath_dynamic_rti_rtimer_set
argument_list|(
name|vpath
operator|->
name|handle
argument_list|,
name|vpath
operator|->
name|rti_rtimer_val
argument_list|)
expr_stmt|;
block|}
block|}
name|vpath
operator|->
name|rx_interrupts
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_methods FreeBSD device interface entry points  */
end_comment

begin_decl_stmt
specifier|static
name|device_method_t
name|vxge_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|vxge_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|vxge_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|vxge_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|vxge_shutdown
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|vxge_driver
init|=
block|{
literal|"vxge"
block|,
name|vxge_methods
block|,
sizeof|sizeof
argument_list|(
name|vxge_dev_t
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|vxge_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|vxge
argument_list|,
name|pci
argument_list|,
name|vxge_driver
argument_list|,
name|vxge_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


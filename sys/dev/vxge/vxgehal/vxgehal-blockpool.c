begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * SPDX-License-Identifier: BSD-3-Clause  *  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxgehal/vxgehal.h>
end_include

begin_comment
comment|/*  * __hal_blockpool_create - Create block pool  * @devh: Pointer to HAL Device object.  * @blockpool: Block pool to be created.  * @pool_size: Number of blocks in the pool.  * @pool_incr: Number of blocks to be request from OS at a time  * @pool_min: Number of blocks below which new blocks to be requested.  * @pool_max: Number of blocks above which block to be freed.  *  * This function creates block pool  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_blockpool_create
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|__hal_blockpool_t
modifier|*
name|blockpool
parameter_list|,
name|u32
name|pool_size
parameter_list|,
name|u32
name|pool_incr
parameter_list|,
name|u32
name|pool_min
parameter_list|,
name|u32
name|pool_max
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|__hal_blockpool_entry_t
modifier|*
name|entry
decl_stmt|;
name|void
modifier|*
name|memblock
decl_stmt|;
name|dma_addr_t
name|dma_addr
decl_stmt|;
name|pci_dma_h
name|dma_handle
decl_stmt|;
name|pci_dma_acc_h
name|acc_handle
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_os_memzero
argument_list|(
operator|&
name|dma_handle
argument_list|,
sizeof|sizeof
argument_list|(
name|pci_dma_h
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_os_memzero
argument_list|(
operator|&
name|acc_handle
argument_list|,
sizeof|sizeof
argument_list|(
name|pci_dma_acc_h
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"blockpool = 0x"
name|VXGE_OS_STXFMT
literal|", pool_size = %d, pool_incr = %d, "
literal|"pool_min = %d, pool_max = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|blockpool
argument_list|,
name|pool_size
argument_list|,
name|pool_incr
argument_list|,
name|pool_min
argument_list|,
name|pool_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|blockpool
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_err_log_pool
argument_list|(
literal|"%s:%d null pointer passed. blockpool is null"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|blockpool
operator|->
name|hldev
operator|=
name|devh
expr_stmt|;
name|blockpool
operator|->
name|block_size
operator|=
name|VXGE_OS_HOST_PAGE_SIZE
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|=
literal|0
expr_stmt|;
name|blockpool
operator|->
name|pool_incr
operator|=
name|pool_incr
expr_stmt|;
name|blockpool
operator|->
name|pool_min
operator|=
name|pool_min
expr_stmt|;
name|blockpool
operator|->
name|pool_max
operator|=
name|pool_max
expr_stmt|;
name|blockpool
operator|->
name|req_out
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_DMA_CONSISTENT
argument_list|)
name|blockpool
operator|->
name|dma_flags
operator|=
name|VXGE_OS_DMA_CONSISTENT
expr_stmt|;
else|#
directive|else
name|blockpool
operator|->
name|dma_flags
operator|=
name|VXGE_OS_DMA_STREAMING
expr_stmt|;
endif|#
directive|endif
name|vxge_list_init
argument_list|(
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
name|vxge_list_init
argument_list|(
operator|&
name|blockpool
operator|->
name|free_entry_list
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock_init
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_init_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|irqh
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pool_size
operator|+
name|pool_max
condition|;
name|i
operator|++
control|)
block|{
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_blockpool_entry_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|__hal_blockpool_destroy
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|vxge_list_insert
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|,
operator|&
name|blockpool
operator|->
name|free_entry_list
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pool_size
condition|;
name|i
operator|++
control|)
block|{
name|memblock
operator|=
name|vxge_os_dma_malloc
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|VXGE_OS_HOST_PAGE_SIZE
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|,
operator|&
name|dma_handle
argument_list|,
operator|&
name|acc_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|memblock
operator|==
name|NULL
condition|)
block|{
name|__hal_blockpool_destroy
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|dma_addr
operator|=
name|vxge_os_dma_map
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|dma_handle
argument_list|,
name|memblock
argument_list|,
name|VXGE_OS_HOST_PAGE_SIZE
argument_list|,
name|VXGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma_addr
operator|==
name|VXGE_OS_INVALID_DMA_ADDR
condition|)
block|{
name|vxge_os_dma_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|memblock
argument_list|,
name|VXGE_OS_HOST_PAGE_SIZE
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|,
operator|&
name|dma_handle
argument_list|,
operator|&
name|acc_handle
argument_list|)
expr_stmt|;
name|__hal_blockpool_destroy
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_list_first_get
argument_list|(
operator|&
name|blockpool
operator|->
name|free_entry_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_blockpool_entry_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|vxge_list_remove
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|)
expr_stmt|;
name|entry
operator|->
name|length
operator|=
name|VXGE_OS_HOST_PAGE_SIZE
expr_stmt|;
name|entry
operator|->
name|memblock
operator|=
name|memblock
expr_stmt|;
name|entry
operator|->
name|dma_addr
operator|=
name|dma_addr
expr_stmt|;
name|entry
operator|->
name|acc_handle
operator|=
name|acc_handle
expr_stmt|;
name|entry
operator|->
name|dma_handle
operator|=
name|dma_handle
expr_stmt|;
name|vxge_list_insert
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|,
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|++
expr_stmt|;
block|}
else|else
block|{
name|__hal_blockpool_destroy
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
block|}
name|vxge_hal_info_log_pool
argument_list|(
literal|"Blockpool  block size:%d block pool size: %d"
argument_list|,
name|blockpool
operator|->
name|block_size
argument_list|,
name|blockpool
operator|->
name|pool_size
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_destroy - Deallocates the block pool  * @blockpool: blockpool to be deallocated  *  * This function freeup the memory pool and removes the  * block pool.  */
end_comment

begin_function
name|void
name|__hal_blockpool_destroy
parameter_list|(
name|__hal_blockpool_t
modifier|*
name|blockpool
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_list_t
modifier|*
name|p
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|vxge_assert
argument_list|(
name|blockpool
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|blockpool
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"blockpool = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|blockpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|blockpool
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_err_log_pool
argument_list|(
literal|"%s:%d null pointer passed blockpool = null"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 1"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return;
block|}
name|vxge_list_for_each_safe
argument_list|(
argument|p
argument_list|,
argument|n
argument_list|,
argument|&blockpool->free_block_list
argument_list|)
block|{
name|vxge_os_dma_unmap
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|dma_handle
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|dma_addr
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|length
argument_list|,
name|VXGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|vxge_os_dma_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|memblock
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|length
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|,
operator|&
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|dma_handle
argument_list|,
operator|&
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|acc_handle
argument_list|)
expr_stmt|;
name|vxge_list_remove
argument_list|(
operator|&
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|item
argument_list|)
expr_stmt|;
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_blockpool_entry_t
argument_list|)
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|--
expr_stmt|;
block|}
name|vxge_list_for_each_safe
argument_list|(
argument|p
argument_list|,
argument|n
argument_list|,
argument|&blockpool->free_entry_list
argument_list|)
block|{
name|vxge_list_remove
argument_list|(
operator|&
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|item
argument_list|)
expr_stmt|;
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_blockpool_entry_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock_destroy
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_blocks_add - Request additional blocks  * @blockpool: Block pool.  *  * Requests additional blocks to block pool  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|__hal_blockpool_blocks_add
parameter_list|(
name|__hal_blockpool_t
modifier|*
name|blockpool
parameter_list|)
block|{
name|u32
name|nreq
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
name|blockpool
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|blockpool
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"blockpool = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|blockpool
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|blockpool
operator|->
name|pool_size
operator|+
name|blockpool
operator|->
name|req_out
operator|)
operator|<
name|blockpool
operator|->
name|pool_min
condition|)
block|{
name|nreq
operator|=
name|blockpool
operator|->
name|pool_incr
expr_stmt|;
name|blockpool
operator|->
name|req_out
operator|+=
name|nreq
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nreq
condition|;
name|i
operator|++
control|)
block|{
name|vxge_os_dma_malloc_async
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|blockpool
operator|->
name|hldev
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|blockpool
operator|->
name|hldev
argument_list|,
name|VXGE_OS_HOST_PAGE_SIZE
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_blocks_remove - Free additional blocks  * @blockpool: Block pool.  *  * Frees additional blocks over maximum from the block pool  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|__hal_blockpool_blocks_remove
parameter_list|(
name|__hal_blockpool_t
modifier|*
name|blockpool
parameter_list|)
block|{
name|vxge_list_t
modifier|*
name|p
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
name|blockpool
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|blockpool
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"blockpool = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|blockpool
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_list_for_each_safe
argument_list|(
argument|p
argument_list|,
argument|n
argument_list|,
argument|&blockpool->free_block_list
argument_list|)
block|{
if|if
condition|(
name|blockpool
operator|->
name|pool_size
operator|<
name|blockpool
operator|->
name|pool_max
condition|)
break|break;
name|vxge_os_dma_unmap
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|blockpool
operator|->
name|hldev
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|dma_handle
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|dma_addr
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|length
argument_list|,
name|VXGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|vxge_os_dma_free
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|blockpool
operator|->
name|hldev
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|memblock
argument_list|,
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|length
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|,
operator|&
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|dma_handle
argument_list|,
operator|&
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|acc_handle
argument_list|)
expr_stmt|;
name|vxge_list_remove
argument_list|(
operator|&
operator|(
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|p
operator|)
operator|->
name|item
argument_list|)
expr_stmt|;
name|vxge_list_insert
argument_list|(
name|p
argument_list|,
operator|&
name|blockpool
operator|->
name|free_entry_list
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|--
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_blockpool_block_add - callback for vxge_os_dma_malloc_async  * @devh: HAL device handle.  * @block_addr: Virtual address of the block  * @length: Length of the block.  * @p_dma_h: Physical address of the block  * @acc_handle: DMA acc handle  *  * Adds a block to block pool  */
end_comment

begin_function
name|void
name|vxge_hal_blockpool_block_add
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|void
modifier|*
name|block_addr
parameter_list|,
name|u32
name|length
parameter_list|,
name|pci_dma_h
modifier|*
name|dma_h
parameter_list|,
name|pci_dma_acc_h
modifier|*
name|acc_handle
parameter_list|)
block|{
name|__hal_blockpool_t
modifier|*
name|blockpool
decl_stmt|;
name|__hal_blockpool_entry_t
modifier|*
name|entry
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|dma_addr_t
name|dma_addr
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|u32
name|req_out
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", length = %d, "
literal|"block_addr = 0x"
name|VXGE_OS_STXFMT
literal|",  dma_h = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"acc_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|length
argument_list|,
operator|(
name|ptr_t
operator|)
name|block_addr
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_h
argument_list|,
operator|(
name|ptr_t
operator|)
name|acc_handle
argument_list|)
expr_stmt|;
name|blockpool
operator|=
operator|&
name|hldev
operator|->
name|block_pool
expr_stmt|;
if|if
condition|(
name|block_addr
operator|==
name|NULL
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|blockpool
operator|->
name|req_out
operator|--
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 1"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return;
block|}
name|dma_addr
operator|=
name|vxge_os_dma_map
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|*
name|dma_h
argument_list|,
name|block_addr
argument_list|,
name|length
argument_list|,
name|VXGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma_addr
operator|==
name|VXGE_OS_INVALID_DMA_ADDR
condition|)
block|{
name|vxge_os_dma_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|block_addr
argument_list|,
name|length
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|,
name|dma_h
argument_list|,
name|acc_handle
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|blockpool
operator|->
name|req_out
operator|--
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 1"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_list_first_get
argument_list|(
operator|&
name|blockpool
operator|->
name|free_entry_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_blockpool_entry_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vxge_list_remove
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|entry
operator|->
name|length
operator|=
name|length
expr_stmt|;
name|entry
operator|->
name|memblock
operator|=
name|block_addr
expr_stmt|;
name|entry
operator|->
name|dma_addr
operator|=
name|dma_addr
expr_stmt|;
name|entry
operator|->
name|acc_handle
operator|=
operator|*
name|acc_handle
expr_stmt|;
name|entry
operator|->
name|dma_handle
operator|=
operator|*
name|dma_h
expr_stmt|;
name|vxge_list_insert
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|,
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|++
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_MEMORY
expr_stmt|;
block|}
name|blockpool
operator|->
name|req_out
operator|--
expr_stmt|;
name|req_out
operator|=
name|blockpool
operator|->
name|req_out
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|req_out
operator|==
literal|0
condition|)
name|__hal_channel_process_pending_list
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_malloc - Allocate a memory block from pool  * @devh: HAL device handle.  * @size: Length of the block.  * @dma_addr: Buffer to return DMA Address of the block.  * @dma_handle: Buffer to return DMA handle of the block.  * @acc_handle: Buffer to return DMA acc handle  *  *  * Allocates a block of memory of given size, either from block pool  * or by calling vxge_os_dma_malloc()  */
end_comment

begin_function
name|void
modifier|*
name|__hal_blockpool_malloc
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|size
parameter_list|,
name|dma_addr_t
modifier|*
name|dma_addr
parameter_list|,
name|pci_dma_h
modifier|*
name|dma_handle
parameter_list|,
name|pci_dma_acc_h
modifier|*
name|acc_handle
parameter_list|)
block|{
name|__hal_blockpool_entry_t
modifier|*
name|entry
decl_stmt|;
name|__hal_blockpool_t
modifier|*
name|blockpool
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|void
modifier|*
name|memblock
init|=
name|NULL
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", size = %d, "
literal|"dma_addr = 0x"
name|VXGE_OS_STXFMT
literal|", dma_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"acc_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|size
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_addr
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|acc_handle
argument_list|)
expr_stmt|;
name|blockpool
operator|=
operator|&
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|block_pool
expr_stmt|;
if|if
condition|(
name|size
operator|!=
name|blockpool
operator|->
name|block_size
condition|)
block|{
name|memblock
operator|=
name|vxge_os_dma_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|size
argument_list|,
name|blockpool
operator|->
name|dma_flags
operator||
name|VXGE_OS_DMA_CACHELINE_ALIGNED
argument_list|,
name|dma_handle
argument_list|,
name|acc_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|memblock
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
operator|*
name|dma_addr
operator|=
name|vxge_os_dma_map
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|*
name|dma_handle
argument_list|,
name|memblock
argument_list|,
name|size
argument_list|,
name|VXGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|,
name|blockpool
operator|->
name|dma_flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|dma_addr
operator|==
name|VXGE_OS_INVALID_DMA_ADDR
condition|)
block|{
name|vxge_os_dma_free
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|memblock
argument_list|,
name|size
argument_list|,
name|blockpool
operator|->
name|dma_flags
operator||
name|VXGE_OS_DMA_CACHELINE_ALIGNED
argument_list|,
name|dma_handle
argument_list|,
name|acc_handle
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
else|else
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_list_first_get
argument_list|(
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|vxge_list_remove
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|)
expr_stmt|;
operator|*
name|dma_addr
operator|=
name|entry
operator|->
name|dma_addr
expr_stmt|;
operator|*
name|dma_handle
operator|=
name|entry
operator|->
name|dma_handle
expr_stmt|;
operator|*
name|acc_handle
operator|=
name|entry
operator|->
name|acc_handle
expr_stmt|;
name|memblock
operator|=
name|entry
operator|->
name|memblock
expr_stmt|;
name|vxge_list_insert
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|,
operator|&
name|blockpool
operator|->
name|free_entry_list
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|--
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|memblock
operator|!=
name|NULL
condition|)
name|__hal_blockpool_blocks_add
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|!
name|memblock
argument_list|)
expr_stmt|;
return|return
operator|(
name|memblock
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_free - Frees the memory allcoated with __hal_blockpool_malloc  * @devh: HAL device handle.  * @memblock: Virtual address block  * @size: Length of the block.  * @dma_addr: DMA Address of the block.  * @dma_handle: DMA handle of the block.  * @acc_handle: DMA acc handle  *  *  * Frees the memory allocated with __hal_blockpool_malloc to blockpool or system  */
end_comment

begin_function
name|void
name|__hal_blockpool_free
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|u32
name|size
parameter_list|,
name|dma_addr_t
modifier|*
name|dma_addr
parameter_list|,
name|pci_dma_h
modifier|*
name|dma_handle
parameter_list|,
name|pci_dma_acc_h
modifier|*
name|acc_handle
parameter_list|)
block|{
name|__hal_blockpool_entry_t
modifier|*
name|entry
decl_stmt|;
name|__hal_blockpool_t
modifier|*
name|blockpool
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", size = %d, "
literal|"dma_addr = 0x"
name|VXGE_OS_STXFMT
literal|", dma_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"acc_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|size
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_addr
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|acc_handle
argument_list|)
expr_stmt|;
name|blockpool
operator|=
operator|&
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|block_pool
expr_stmt|;
if|if
condition|(
name|size
operator|!=
name|blockpool
operator|->
name|block_size
condition|)
block|{
name|vxge_os_dma_unmap
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
operator|*
name|dma_handle
argument_list|,
operator|*
name|dma_addr
argument_list|,
name|size
argument_list|,
name|VXGE_OS_DMA_DIR_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|vxge_os_dma_free
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|memblock
argument_list|,
name|size
argument_list|,
name|blockpool
operator|->
name|dma_flags
operator||
name|VXGE_OS_DMA_CACHELINE_ALIGNED
argument_list|,
name|dma_handle
argument_list|,
name|acc_handle
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_list_first_get
argument_list|(
operator|&
name|blockpool
operator|->
name|free_entry_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_blockpool_entry_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vxge_list_remove
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|entry
operator|->
name|length
operator|=
name|size
expr_stmt|;
name|entry
operator|->
name|memblock
operator|=
name|memblock
expr_stmt|;
name|entry
operator|->
name|dma_addr
operator|=
operator|*
name|dma_addr
expr_stmt|;
name|entry
operator|->
name|acc_handle
operator|=
operator|*
name|acc_handle
expr_stmt|;
name|entry
operator|->
name|dma_handle
operator|=
operator|*
name|dma_handle
expr_stmt|;
name|vxge_list_insert
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|,
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|++
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_MEMORY
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
name|__hal_blockpool_blocks_remove
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_block_allocate - Allocates a block from block pool  * @hldev: Hal device  * @size: Size of the block to be allocated  *  * This function allocates a block from block pool or from the system  */
end_comment

begin_function
name|__hal_blockpool_entry_t
modifier|*
name|__hal_blockpool_block_allocate
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|size
parameter_list|)
block|{
name|__hal_blockpool_entry_t
modifier|*
name|entry
init|=
name|NULL
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_blockpool_t
modifier|*
name|blockpool
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", size = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|blockpool
operator|=
operator|&
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|block_pool
expr_stmt|;
if|if
condition|(
name|size
operator|==
name|blockpool
operator|->
name|block_size
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_list_first_get
argument_list|(
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|!=
name|NULL
condition|)
block|{
name|vxge_list_remove
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|--
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|entry
operator|!=
name|NULL
condition|)
name|__hal_blockpool_blocks_add
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|!
name|entry
argument_list|)
expr_stmt|;
return|return
operator|(
name|entry
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_block_free - Frees a block from block pool  * @devh: Hal device  * @entry: Entry of block to be freed  *  * This function frees a block from block pool  */
end_comment

begin_function
name|void
name|__hal_blockpool_block_free
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|__hal_blockpool_entry_t
modifier|*
name|entry
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_blockpool_t
modifier|*
name|blockpool
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", entry = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|entry
argument_list|)
expr_stmt|;
name|blockpool
operator|=
operator|&
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|block_pool
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|length
operator|==
name|blockpool
operator|->
name|block_size
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_list_insert
argument_list|(
operator|&
name|entry
operator|->
name|item
argument_list|,
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|++
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|__hal_blockpool_blocks_remove
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_list_allocate - Allocate blocks from block pool  * @devh: Hal device  * @blocklist: List into which the allocated blocks to be inserted  * @count: Number of blocks to be allocated  *  * This function allocates a register from the register pool  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_blockpool_list_allocate
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_list_t
modifier|*
name|blocklist
parameter_list|,
name|u32
name|count
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_blockpool_t
modifier|*
name|blockpool
decl_stmt|;
name|__hal_blockpool_entry_t
modifier|*
name|block_entry
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", blocklist = "
literal|"0x"
name|VXGE_OS_STXFMT
literal|", count = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|blocklist
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|blockpool
operator|=
operator|&
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|block_pool
expr_stmt|;
if|if
condition|(
name|blocklist
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_err_log_pool
argument_list|(
literal|"null pointer passed blockpool = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"blocklist = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|blockpool
argument_list|,
operator|(
name|ptr_t
operator|)
name|blocklist
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 1"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_list_init
argument_list|(
name|blocklist
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|block_entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_list_first_get
argument_list|(
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|block_entry
operator|==
name|NULL
condition|)
break|break;
name|vxge_list_remove
argument_list|(
operator|&
name|block_entry
operator|->
name|item
argument_list|)
expr_stmt|;
name|vxge_os_memzero
argument_list|(
name|block_entry
operator|->
name|memblock
argument_list|,
name|blockpool
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|vxge_list_insert
argument_list|(
operator|&
name|block_entry
operator|->
name|item
argument_list|,
name|blocklist
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|++
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|i
operator|<
name|count
condition|)
block|{
name|vxge_hal_err_log_pool
argument_list|(
literal|"%s:%d Blockpool out of blocks"
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
name|__hal_blockpool_list_free
argument_list|(
name|blockpool
argument_list|,
name|blocklist
argument_list|)
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_MEMORY
expr_stmt|;
block|}
name|__hal_blockpool_blocks_add
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_blockpool_list_free - Free a list of blocks from block pool  * @devh: Hal device  * @blocklist: List of blocks to be freed  *  * This function frees a list of blocks to the block pool  */
end_comment

begin_function
name|void
name|__hal_blockpool_list_free
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_list_t
modifier|*
name|blocklist
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_blockpool_t
modifier|*
name|blockpool
decl_stmt|;
name|__hal_blockpool_entry_t
modifier|*
name|block_entry
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", blocklist = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|blocklist
argument_list|)
expr_stmt|;
name|blockpool
operator|=
operator|&
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|block_pool
expr_stmt|;
if|if
condition|(
name|blocklist
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_err_log_pool
argument_list|(
literal|"null pointer passed blockpool = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"blocklist = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|blockpool
argument_list|,
operator|(
name|ptr_t
operator|)
name|blocklist
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 1"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
operator|(
name|block_entry
operator|=
operator|(
name|__hal_blockpool_entry_t
operator|*
operator|)
name|vxge_list_first_get
argument_list|(
name|blocklist
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|vxge_list_remove
argument_list|(
operator|&
name|block_entry
operator|->
name|item
argument_list|)
expr_stmt|;
name|vxge_list_insert
argument_list|(
operator|&
name|block_entry
operator|->
name|item
argument_list|,
operator|&
name|blockpool
operator|->
name|free_block_list
argument_list|)
expr_stmt|;
name|blockpool
operator|->
name|pool_size
operator|++
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_BP_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_BP_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|blockpool
operator|->
name|pool_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_blockpool_blocks_remove
argument_list|(
name|blockpool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * SPDX-License-Identifier: BSD-3-Clause  *  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxgehal/vxgehal.h>
end_include

begin_comment
comment|/*  * vxge_hal_pio_mem_write32_upper  *  * Endiann-aware implementation of vxge_os_pio_mem_write32().  * Since X3100 has 64bit registers, we differintiate uppper and lower  * parts.  */
end_comment

begin_function
name|void
name|vxge_hal_pio_mem_write32_upper
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|pci_reg_h
name|regh
parameter_list|,
name|u32
name|val
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_HOST_BIG_ENDIAN
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|VXGE_OS_PIO_LITTLE_ENDIAN
argument_list|)
name|vxge_os_pio_mem_write32
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|val
argument_list|,
name|addr
argument_list|)
expr_stmt|;
else|#
directive|else
name|vxge_os_pio_mem_write32
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|val
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|addr
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * vxge_hal_pio_mem_write32_lower  *  * Endiann-aware implementation of vxge_os_pio_mem_write32().  * Since X3100 has 64bit registers, we differintiate uppper and lower  * parts.  */
end_comment

begin_function
name|void
name|vxge_hal_pio_mem_write32_lower
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|pci_reg_h
name|regh
parameter_list|,
name|u32
name|val
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_HOST_BIG_ENDIAN
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|VXGE_OS_PIO_LITTLE_ENDIAN
argument_list|)
name|vxge_os_pio_mem_write32
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|val
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|addr
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|vxge_os_pio_mem_write32
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|val
argument_list|,
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_pciconfig_get - Read the content of given address  *			 in pci config space.  * @devh: Device handle.  * @offset: Configuration address(offset)to read from  * @length: Length of the data (1, 2 or 4 bytes)  * @val: Pointer to a buffer to return the content of the address  *  * Read from the pci config space.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_pciconfig_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|offset
parameter_list|,
name|u32
name|length
parameter_list|,
name|void
modifier|*
name|val
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|devh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|val
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|status
operator|=
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|i
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_pci_caps_list_process  * @hldev: HAL device handle.  *  * Process PCI capabilities and initialize the offsets  */
end_comment

begin_function
name|void
name|__hal_device_pci_caps_list_process
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|u8
name|cap_id
decl_stmt|;
name|u16
name|ext_cap_id
decl_stmt|;
name|u16
name|next_ptr
decl_stmt|;
name|u32
modifier|*
name|ptr_32
decl_stmt|;
name|vxge_hal_pci_config_t
modifier|*
name|pci_config
init|=
operator|&
name|hldev
operator|->
name|pci_config_space_bios
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
name|next_ptr
operator|=
name|pci_config
operator|->
name|capabilities_pointer
expr_stmt|;
while|while
condition|(
name|next_ptr
operator|!=
literal|0
condition|)
block|{
name|cap_id
operator|=
name|VXGE_HAL_PCI_CAP_ID
argument_list|(
operator|(
operator|(
operator|(
name|u8
operator|*
operator|)
name|pci_config
operator|)
operator|+
name|next_ptr
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cap_id
condition|)
block|{
case|case
name|VXGE_HAL_PCI_CAP_ID_PM
case|:
name|hldev
operator|->
name|pci_caps
operator|.
name|pm_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_VPD
case|:
name|hldev
operator|->
name|pci_caps
operator|.
name|vpd_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_SLOTID
case|:
name|hldev
operator|->
name|pci_caps
operator|.
name|sid_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_MSI
case|:
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_VS
case|:
name|hldev
operator|->
name|pci_caps
operator|.
name|vs_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_SHPC
case|:
name|hldev
operator|->
name|pci_caps
operator|.
name|shpc_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_PCIE
case|:
name|hldev
operator|->
name|pci_e_caps
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_MSIX
case|:
name|hldev
operator|->
name|pci_caps
operator|.
name|msix_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_CAP_ID_AGP
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_CHSWP
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_PCIX
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_HT
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_DBGPORT
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_CPCICSR
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_PCIBSVID
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_AGP8X
case|:
case|case
name|VXGE_HAL_PCI_CAP_ID_SECDEV
case|:
name|vxge_hal_info_log_device
argument_list|(
literal|"Unexpected Capability = %d"
argument_list|,
name|cap_id
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vxge_hal_info_log_device
argument_list|(
literal|"Unknown capability = %d"
argument_list|,
name|cap_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|next_ptr
operator|=
name|VXGE_HAL_PCI_CAP_NEXT
argument_list|(
operator|(
operator|(
operator|(
name|u8
operator|*
operator|)
name|pci_config
operator|)
operator|+
name|next_ptr
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* CONSTCOND */
if|if
condition|(
name|VXGE_HAL_PCI_CONFIG_SPACE_SIZE
operator|<=
literal|0x100
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return;
block|}
name|next_ptr
operator|=
literal|0x100
expr_stmt|;
while|while
condition|(
name|next_ptr
operator|!=
literal|0
condition|)
block|{
name|ptr_32
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|u8
operator|*
operator|)
name|pci_config
operator|)
operator|+
name|next_ptr
operator|)
operator|)
expr_stmt|;
name|ext_cap_id
operator|=
call|(
name|u16
call|)
argument_list|(
name|VXGE_HAL_PCI_EXT_CAP_ID
argument_list|(
operator|*
name|ptr_32
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ext_cap_id
condition|)
block|{
case|case
name|VXGE_HAL_PCI_EXT_CAP_ID_ERR
case|:
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXT_CAP_ID_VC
case|:
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|vc_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXT_CAP_ID_DSN
case|:
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|dsn_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXT_CAP_ID_PWR
case|:
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|pwr_budget_cap_offset
operator|=
name|next_ptr
expr_stmt|;
break|break;
default|default:
name|vxge_hal_info_log_device
argument_list|(
literal|"Unknown capability = %d"
argument_list|,
name|ext_cap_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|next_ptr
operator|=
operator|(
name|u16
operator|)
name|VXGE_HAL_PCI_EXT_CAP_NEXT
argument_list|(
operator|*
name|ptr_32
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_pci_e_init  * @hldev: HAL device handle.  *  * Initialize certain PCI/PCI-X configuration registers  * with recommended values. Save config space for future hw resets.  */
end_comment

begin_function
name|void
name|__hal_device_pci_e_init
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u16
name|cmd
decl_stmt|;
name|u32
modifier|*
name|ptr_32
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
comment|/* save original PCI config space to restore it on device_terminate() */
name|ptr_32
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|hldev
operator|->
name|pci_config_space_bios
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_PCI_CONFIG_SPACE_SIZE
operator|/
literal|4
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|i
operator|*
literal|4
argument_list|,
literal|4
argument_list|,
name|ptr_32
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|__hal_device_pci_caps_list_process
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
comment|/* Set the PErr Repconse bit and SERR in PCI command register. */
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|vxge_offsetof
argument_list|(
name|vxge_hal_pci_config_le_t
argument_list|,
name|command
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|cmd
argument_list|)
expr_stmt|;
name|cmd
operator||=
literal|0x140
expr_stmt|;
name|vxge_os_pci_write16
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|vxge_offsetof
argument_list|(
name|vxge_hal_pci_config_le_t
argument_list|,
name|command
argument_list|)
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
comment|/* save PCI config space for future resets */
name|ptr_32
operator|=
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|hldev
operator|->
name|pci_config_space
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_PCI_CONFIG_SPACE_SIZE
operator|/
literal|4
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|i
operator|*
literal|4
argument_list|,
literal|4
argument_list|,
name|ptr_32
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_bus_master_enable  * @hldev: HAL device handle.  *  * Enable bus mastership.  */
end_comment

begin_function
specifier|static
name|void
name|__hal_device_bus_master_enable
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|u16
name|cmd
decl_stmt|;
name|u16
name|bus_master
init|=
literal|4
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|vxge_offsetof
argument_list|(
name|vxge_hal_pci_config_le_t
argument_list|,
name|command
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|cmd
argument_list|)
expr_stmt|;
comment|/* already enabled? do nothing */
if|if
condition|(
name|cmd
operator|&
name|bus_master
condition|)
return|return;
name|cmd
operator||=
name|bus_master
expr_stmt|;
name|vxge_os_pci_write16
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|vxge_offsetof
argument_list|(
name|vxge_hal_pci_config_le_t
argument_list|,
name|command
argument_list|)
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_register_poll  * @pdev: PCI device object.  * @regh: BAR mapped memory handle (Solaris), or simply PCI device @pdev  *	(Linux and the rest.)  * @reg: register to poll for  * @op: 0 - bit reset, 1 - bit set  * @mask: mask for logical "and" condition based on %op  * @max_millis: maximum time to try to poll in milliseconds  *  * Will poll certain register for specified amount of time.  * Will poll until masked bit is not cleared.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_register_poll
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|pci_reg_h
name|regh
parameter_list|,
name|u64
modifier|*
name|reg
parameter_list|,
name|u32
name|op
parameter_list|,
name|u64
name|mask
parameter_list|,
name|u32
name|max_millis
parameter_list|)
block|{
name|u64
name|val64
decl_stmt|;
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|vxge_hal_status_e
name|ret
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|vxge_os_udelay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
do|do
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
literal|0
operator|&&
operator|!
operator|(
name|val64
operator|&
name|mask
operator|)
condition|)
block|{
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|op
operator|==
literal|1
operator|&&
operator|(
name|val64
operator|&
name|mask
operator|)
operator|==
name|mask
condition|)
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
name|vxge_os_udelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<=
literal|9
condition|)
do|;
do|do
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
literal|0
operator|&&
operator|!
operator|(
name|val64
operator|&
name|mask
operator|)
condition|)
block|{
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|op
operator|==
literal|1
operator|&&
operator|(
name|val64
operator|&
name|mask
operator|)
operator|==
name|mask
condition|)
block|{
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
name|vxge_os_udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<
name|max_millis
condition|)
do|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_register_stall  * @pdev: PCI device object.  * @regh: BAR mapped memory handle (Solaris), or simply PCI device @pdev  *	(Linux and the rest.)  * @reg: register to poll for  * @op: 0 - bit reset, 1 - bit set  * @mask: mask for logical "and" condition based on %op  * @max_millis: maximum time to try to poll in milliseconds  *  * Will poll certain register for specified amount of time.  * Will poll until masked bit is not cleared.  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_device_register_stall
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|pci_reg_h
name|regh
parameter_list|,
name|u64
modifier|*
name|reg
parameter_list|,
name|u32
name|op
parameter_list|,
name|u64
name|mask
parameter_list|,
name|u32
name|max_millis
parameter_list|)
block|{
name|u64
name|val64
decl_stmt|;
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|vxge_hal_status_e
name|ret
init|=
name|VXGE_HAL_FAIL
decl_stmt|;
name|vxge_os_stall
argument_list|(
literal|10
argument_list|)
expr_stmt|;
do|do
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
literal|0
operator|&&
operator|!
operator|(
name|val64
operator|&
name|mask
operator|)
condition|)
block|{
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|op
operator|==
literal|1
operator|&&
operator|(
name|val64
operator|&
name|mask
operator|)
operator|==
name|mask
condition|)
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
name|vxge_os_stall
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<=
literal|9
condition|)
do|;
do|do
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
literal|0
operator|&&
operator|!
operator|(
name|val64
operator|&
name|mask
operator|)
condition|)
block|{
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|op
operator|==
literal|1
operator|&&
operator|(
name|val64
operator|&
name|mask
operator|)
operator|==
name|mask
condition|)
block|{
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
name|vxge_os_stall
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<
name|max_millis
condition|)
do|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|vxge_hal_device_get_legacy_reg
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|pci_reg_h
name|regh
parameter_list|,
name|u8
modifier|*
name|bar0
parameter_list|)
block|{
name|vxge_hal_legacy_reg_t
modifier|*
name|legacy_reg
init|=
name|NULL
decl_stmt|;
comment|/* 	 * If length of Bar0 is 16MB, then assume we are configured 	 * in MF8P_VP2 mode and add 8MB to get legacy_reg offsets 	 */
if|if
condition|(
name|vxge_os_pci_res_len
argument_list|(
name|pdev
argument_list|,
name|regh
argument_list|)
operator|==
literal|0x1000000
condition|)
name|legacy_reg
operator|=
operator|(
name|vxge_hal_legacy_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|bar0
operator|+
literal|0x800000
operator|)
operator|)
expr_stmt|;
else|else
name|legacy_reg
operator|=
operator|(
name|vxge_hal_legacy_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
name|bar0
operator|)
expr_stmt|;
return|return
operator|(
name|legacy_reg
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_reg_addr_get  * @hldev: HAL Device object.  *  * This routine sets the swapper and reads the toc pointer and initializes the  * register location pointers in the device object. It waits until the ric is  * completed initializing registers.  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_device_reg_addr_get
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|u64
name|val64
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|legacy_reg
operator|=
operator|(
name|vxge_hal_legacy_reg_t
operator|*
operator|)
name|vxge_hal_device_get_legacy_reg
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|bar0
argument_list|)
expr_stmt|;
name|status
operator|=
name|__hal_legacy_swapper_set
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|legacy_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|legacy_reg
operator|->
name|toc_first_pointer
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|toc_reg
operator|=
operator|(
name|vxge_hal_toc_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_common_pointer
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|common_reg
operator|=
operator|(
name|vxge_hal_common_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_hal_info_log_device
argument_list|(
literal|"COMMON = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|common_reg
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_memrepair_pointer
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|memrepair_reg
operator|=
operator|(
name|vxge_hal_memrepair_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_hal_info_log_device
argument_list|(
literal|"MEM REPAIR = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|memrepair_reg
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_TITAN_PCICFGMGMT_REG_SPACES
condition|;
name|i
operator|++
control|)
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_pcicfgmgmt_pointer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|pcicfgmgmt_reg
index|[
name|i
index|]
operator|=
operator|(
name|vxge_hal_pcicfgmgmt_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_hal_info_log_device
argument_list|(
literal|"PCICFG_MGMT[%d] = "
literal|"0x"
name|VXGE_OS_STXFMT
argument_list|,
name|i
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|pcicfgmgmt_reg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_mrpcim_pointer
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|mrpcim_reg
operator|=
operator|(
name|vxge_hal_mrpcim_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_hal_info_log_device
argument_list|(
literal|"MEM REPAIR = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|mrpcim_reg
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_TITAN_SRPCIM_REG_SPACES
condition|;
name|i
operator|++
control|)
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_srpcim_pointer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|srpcim_reg
index|[
name|i
index|]
operator|=
operator|(
name|vxge_hal_srpcim_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_hal_info_log_device
argument_list|(
literal|"SRPCIM[%d] =0x"
name|VXGE_OS_STXFMT
argument_list|,
name|i
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|srpcim_reg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_TITAN_VPMGMT_REG_SPACES
condition|;
name|i
operator|++
control|)
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_vpmgmt_pointer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|i
index|]
operator|=
operator|(
name|vxge_hal_vpmgmt_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_hal_info_log_device
argument_list|(
literal|"VPMGMT[%d] = 0x"
name|VXGE_OS_STXFMT
argument_list|,
name|i
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_TITAN_VPATH_REG_SPACES
condition|;
name|i
operator|++
control|)
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_vpath_pointer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|vpath_reg
index|[
name|i
index|]
operator|=
operator|(
name|vxge_hal_vpath_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_hal_info_log_device
argument_list|(
literal|"VPATH[%d] = 0x"
name|VXGE_OS_STXFMT
argument_list|,
name|i
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpath_reg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_kdfc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|VXGE_HAL_TOC_GET_KDFC_INITIAL_BIR
argument_list|(
name|val64
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|hldev
operator|->
name|kdfc
operator|=
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|VXGE_HAL_TOC_GET_KDFC_INITIAL_OFFSET
argument_list|(
name|val64
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|hldev
operator|->
name|kdfc
operator|=
name|hldev
operator|->
name|header
operator|.
name|bar1
operator|+
name|VXGE_HAL_TOC_GET_KDFC_INITIAL_OFFSET
argument_list|(
name|val64
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|hldev
operator|->
name|kdfc
operator|=
name|hldev
operator|->
name|header
operator|.
name|bar2
operator|+
name|VXGE_HAL_TOC_GET_KDFC_INITIAL_OFFSET
argument_list|(
name|val64
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vxge_hal_info_log_device
argument_list|(
literal|"Invalid BIR = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|VXGE_HAL_TOC_GET_KDFC_INITIAL_BIR
argument_list|(
name|val64
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|vxge_hal_info_log_device
argument_list|(
literal|"KDFC = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|kdfc
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|toc_reg
operator|->
name|toc_usdc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|VXGE_HAL_TOC_GET_USDC_INITIAL_BIR
argument_list|(
name|val64
argument_list|)
condition|)
block|{
case|case
literal|0
case|:
name|hldev
operator|->
name|usdc
operator|=
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|VXGE_HAL_TOC_GET_USDC_INITIAL_OFFSET
argument_list|(
name|val64
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|hldev
operator|->
name|usdc
operator|=
name|hldev
operator|->
name|header
operator|.
name|bar1
operator|+
name|VXGE_HAL_TOC_GET_USDC_INITIAL_OFFSET
argument_list|(
name|val64
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|hldev
operator|->
name|usdc
operator|=
name|hldev
operator|->
name|header
operator|.
name|bar2
operator|+
name|VXGE_HAL_TOC_GET_USDC_INITIAL_OFFSET
argument_list|(
name|val64
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vxge_hal_info_log_device
argument_list|(
literal|"Invalid BIR = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|VXGE_HAL_TOC_GET_USDC_INITIAL_BIR
argument_list|(
name|val64
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|vxge_hal_info_log_device
argument_list|(
literal|"USDC = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|usdc
argument_list|)
expr_stmt|;
name|status
operator|=
name|vxge_hal_device_register_poll
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|vpath_rst_in_prog
argument_list|,
literal|0
argument_list|,
name|VXGE_HAL_VPATH_RST_IN_PROG_VPATH_RST_IN_PROG
argument_list|(
literal|0x1ffff
argument_list|)
argument_list|,
name|VXGE_HAL_DEF_DEVICE_POLL_MILLIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_err_log_device
argument_list|(
literal|"%s:vpath_rst_in_prog is not cleared"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_id_get  * @hldev: HAL Device object.  *  * This routine returns sets the device id and revision numbers into the device  * structure  */
end_comment

begin_function
name|void
name|__hal_device_id_get
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|vxge_offsetof
argument_list|(
name|vxge_hal_pci_config_le_t
argument_list|,
name|device_id
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|hldev
operator|->
name|header
operator|.
name|device_id
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|vxge_offsetof
argument_list|(
name|vxge_hal_pci_config_le_t
argument_list|,
name|revision
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|hldev
operator|->
name|header
operator|.
name|revision
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_access_rights_get: Get Access Rights of the driver  * @host_type: Host type.  * @func_id: Function Id  *  * This routine returns the Access Rights of the driver  */
end_comment

begin_function
name|u32
name|__hal_device_access_rights_get
parameter_list|(
name|u32
name|host_type
parameter_list|,
name|u32
name|func_id
parameter_list|)
block|{
name|u32
name|access_rights
init|=
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_VPATH
decl_stmt|;
switch|switch
condition|(
name|host_type
condition|)
block|{
case|case
name|VXGE_HAL_NO_MR_NO_SR_NORMAL_FUNCTION
case|:
if|if
condition|(
name|func_id
operator|==
literal|0
condition|)
block|{
name|access_rights
operator||=
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator||
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_SRPCIM
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_HAL_MR_NO_SR_VH0_BASE_FUNCTION
case|:
name|access_rights
operator||=
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator||
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_SRPCIM
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_NO_MR_SR_VH0_FUNCTION0
case|:
name|access_rights
operator||=
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator||
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_SRPCIM
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_NO_MR_SR_VH0_VIRTUAL_FUNCTION
case|:
case|case
name|VXGE_HAL_SR_VH_VIRTUAL_FUNCTION
case|:
break|break;
case|case
name|VXGE_HAL_MR_SR_VH0_INVALID_CONFIG
case|:
break|break;
case|case
name|VXGE_HAL_SR_VH_FUNCTION0
case|:
case|case
name|VXGE_HAL_VH_NORMAL_FUNCTION
case|:
name|access_rights
operator||=
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_SRPCIM
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|access_rights
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_host_info_get  * @hldev: HAL Device object.  *  * This routine returns the host type assignments  */
end_comment

begin_function
name|void
name|__hal_device_host_info_get
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|u64
name|val64
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|host_type_assignments
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|host_type
operator|=
operator|(
name|u32
operator|)
name|VXGE_HAL_HOST_TYPE_ASSIGNMENTS_GET_HOST_TYPE_ASSIGNMENTS
argument_list|(
name|val64
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|vplane_assignments
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|srpcim_id
operator|=
operator|(
name|u32
operator|)
name|VXGE_HAL_VPLANE_ASSIGNMENTS_GET_VPLANE_ASSIGNMENTS
argument_list|(
name|val64
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|vpath_assignments
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|vpath_assignments
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|debug_assignments
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|vh_id
operator|=
operator|(
name|u32
operator|)
name|VXGE_HAL_DEBUG_ASSIGNMENTS_GET_VHLABEL
argument_list|(
name|val64
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|i
index|]
operator|->
name|vpath_to_func_map_cfg1
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|func_id
operator|=
operator|(
name|u32
operator|)
name|VXGE_HAL_VPATH_TO_FUNC_MAP_CFG1_GET_CFG1
argument_list|(
name|val64
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|access_rights
operator|=
name|__hal_device_access_rights_get
argument_list|(
name|hldev
operator|->
name|host_type
argument_list|,
name|hldev
operator|->
name|func_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
condition|)
block|{
name|hldev
operator|->
name|manager_up
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|i
index|]
operator|->
name|srpcim_to_vpath_wmsg
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|manager_up
operator|=
name|__hal_ifmsg_is_manager_up
argument_list|(
name|val64
argument_list|)
expr_stmt|;
block|}
name|hldev
operator|->
name|first_vp_id
operator|=
name|i
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_pci_e_info_get - Get PCI_E bus informations such as link_width  *				  and signalling rate  * @hldev: HAL device.  * @signalling_rate:	pointer to a variable of enumerated type  *			vxge_hal_pci_e_signalling_rate_e {}.  * @link_width:		pointer to a variable of enumerated type  *			vxge_hal_pci_e_link_width_e {}.  *  * Get pci-e signalling rate and link width.  *  * Returns: one of the vxge_hal_status_e {} enumerated types.  * VXGE_HAL_OK			- for success.  * VXGE_HAL_ERR_INVALID_PCI_INFO - for invalid PCI information from the card.  * VXGE_HAL_ERR_BAD_DEVICE_ID	- for invalid card.  *  */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|__hal_device_pci_e_info_get
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|,
name|vxge_hal_pci_e_signalling_rate_e
modifier|*
name|signalling_rate
parameter_list|,
name|vxge_hal_pci_e_link_width_e
modifier|*
name|link_width
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_hal_pci_e_capability_t
modifier|*
name|pci_e_caps
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|signalling_rate
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|link_width
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", signalling_rate = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"link_width = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|signalling_rate
argument_list|,
operator|(
name|ptr_t
operator|)
name|link_width
argument_list|)
expr_stmt|;
name|pci_e_caps
operator|=
operator|(
name|vxge_hal_pci_e_capability_t
operator|*
operator|)
operator|(
operator|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|hldev
operator|->
name|pci_config_space_bios
operator|)
operator|+
name|hldev
operator|->
name|pci_e_caps
operator|)
expr_stmt|;
switch|switch
condition|(
name|pci_e_caps
operator|->
name|pci_e_lnkcap
operator|&
name|VXGE_HAL_PCI_EXP_LNKCAP_LNK_SPEED
condition|)
block|{
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LS_2_5
case|:
operator|*
name|signalling_rate
operator|=
name|VXGE_HAL_PCI_E_SIGNALLING_RATE_2_5GB
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LS_5
case|:
operator|*
name|signalling_rate
operator|=
name|VXGE_HAL_PCI_E_SIGNALLING_RATE_5GB
expr_stmt|;
break|break;
default|default:
operator|*
name|signalling_rate
operator|=
name|VXGE_HAL_PCI_E_SIGNALLING_RATE_UNKNOWN
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|(
name|pci_e_caps
operator|->
name|pci_e_lnksta
operator|&
name|VXGE_HAL_PCI_EXP_LNKCAP_LNK_WIDTH
operator|)
operator|>>
literal|4
condition|)
block|{
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_X1
case|:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X1
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_X2
case|:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X2
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_X4
case|:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X4
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_X8
case|:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X8
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_X12
case|:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X12
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_X16
case|:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X16
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_X32
case|:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_X32
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_PCI_EXP_LNKCAP_LW_RES
case|:
default|default:
operator|*
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_UNKNOWN
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_hw_initialize  * @hldev: HAL device handle.  *  * Initialize X3100-V hardware.  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_device_hw_initialize
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
name|__hal_device_pci_e_init
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
comment|/* update the pci mode, frequency, and width */
if|if
condition|(
name|__hal_device_pci_e_info_get
argument_list|(
name|hldev
argument_list|,
operator|&
name|hldev
operator|->
name|header
operator|.
name|signalling_rate
argument_list|,
operator|&
name|hldev
operator|->
name|header
operator|.
name|link_width
argument_list|)
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|hldev
operator|->
name|header
operator|.
name|signalling_rate
operator|=
name|VXGE_HAL_PCI_E_SIGNALLING_RATE_UNKNOWN
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|link_width
operator|=
name|VXGE_HAL_PCI_E_LINK_WIDTH_UNKNOWN
expr_stmt|;
comment|/* 		 * FIXME: this cannot happen. 		 * But if it happens we cannot continue just like that 		 */
name|vxge_hal_err_log_device
argument_list|(
literal|"unable to get pci info ==> %s : %d"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_SRPCIM
condition|)
block|{
name|status
operator|=
name|__hal_srpcim_initialize
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
condition|)
block|{
name|status
operator|=
name|__hal_mrpcim_initialize
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|hldev
operator|->
name|hw_is_initialized
operator|=
literal|1
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|terminating
operator|=
literal|0
expr_stmt|;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_reset - Reset device.  * @devh: HAL device handle.  *  * Soft-reset the device, reset the device stats except reset_cnt.  *  *  * Returns:  VXGE_HAL_OK - success.  * VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED - Device is not initialized.  * VXGE_HAL_ERR_RESET_FAILED - Reset failed.  *  * See also: vxge_hal_status_e {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_reset
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|header
operator|.
name|is_initialized
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|status
operator|=
name|vxge_hal_vpath_reset
argument_list|(
name|VXGE_HAL_VIRTUAL_PATH_HANDLE
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_err_log_device
argument_list|(
literal|"vpath %d Reset Failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_reset_poll - Poll the device for reset complete.  * @devh: HAL device handle.  *  * Poll the device for reset complete  *  * Returns:  VXGE_HAL_OK - success.  * VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED - Device is not initialized.  * VXGE_HAL_ERR_RESET_FAILED - Reset failed.  *  * See also: vxge_hal_status_e {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_reset_poll
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|header
operator|.
name|is_initialized
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|status
operator|=
name|vxge_hal_vpath_reset_poll
argument_list|(
name|VXGE_HAL_VIRTUAL_PATH_HANDLE
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_err_log_device
argument_list|(
literal|"vpath %d Reset Poll Failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_mrpcim_reset_poll - Poll the device for mrpcim reset complete  * @devh: HAL device handle.  *  * Poll the device for mrpcim reset complete  *  * Returns:  VXGE_HAL_OK - success.  * VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED - Device is not initialized.  * VXGE_HAL_ERR_RESET_FAILED - Reset failed.  * VXGE_HAL_ERR_MANAGER_NOT_FOUND - MRPCIM/SRPCIM manager not found  * VXGE_HAL_ERR_TIME_OUT - Device Reset timed out  *  * See also: vxge_hal_status_e {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_mrpcim_reset_poll
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|header
operator|.
name|is_initialized
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_DEVICE_NOT_INITIALIZED
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|hldev
operator|->
name|manager_up
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_MANAGER_NOT_FOUND
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_MANAGER_NOT_FOUND
operator|)
return|;
block|}
name|status
operator|=
name|__hal_ifmsg_device_reset_end_poll
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_TIME_OUT
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_TIME_OUT
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|status
operator|=
name|vxge_hal_vpath_reset_poll
argument_list|(
name|VXGE_HAL_VIRTUAL_PATH_HANDLE
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_err_log_device
argument_list|(
literal|"vpath %d Reset Poll Failed"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_status - Check whether X3100 hardware is ready for  * operation.  * @devh: HAL device handle.  * @hw_status: X3100 status register. Returned by HAL.  *  * Check whether X3100 hardware is ready for operation.  * The checking includes TDMA, RDMA, PFC, PIC, MC_DRAM, and the rest  * hardware functional blocks.  *  * Returns: VXGE_HAL_OK if the device is ready for operation. Otherwise  * returns VXGE_HAL_FAIL. Also, fills in  adapter status (in @hw_status).  *  * See also: vxge_hal_status_e {}.  * Usage: See ex_open {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_status
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u64
modifier|*
name|hw_status
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|hw_status
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
operator|*
name|hw_status
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|adapter_status
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"Adapter_Status = 0x"
name|VXGE_OS_LLXFMT
argument_list|,
operator|*
name|hw_status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_RTDMA_RTDMA_READY
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_RTDMA_RTDMA_READY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_RTDMA_RTDMA_READY
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_WRDMA_WRDMA_READY
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_WRDMA_WRDMA_READY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_WRDMA_WRDMA_READY
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_KDFC_KDFC_READY
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_KDFC_KDFC_READY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_KDFC_KDFC_READY
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_TPA_TMAC_BUF_EMPTY
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_TPA_TMAC_BUF_EMPTY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_TPA_TMAC_BUF_EMPTY
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_RDCTL_PIC_QUIESCENT
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_RDCTL_PIC_QUIESCENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_RDCTL_PIC_QUIESCENT
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_XGMAC_NETWORK_FAULT
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_XGMAC_NETWORK_FAULT
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_XGMAC_NETWORK_FAULT
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_ROCRC_OFFLOAD_QUIESCENT
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_ROCRC_OFFLOAD_QUIESCENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_ROCRC_OFFLOAD_QUIESCENT
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_G3IF_FB_G3IF_FB_GDDR3_READY
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_G3IF_FB_G3IF_FB_GDDR3_READY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_G3IF_FB_G3IF_FB_GDDR3_READY
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_G3IF_CM_G3IF_CM_GDDR3_READY
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_G3IF_CM_G3IF_CM_GDDR3_READY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_G3IF_CM_G3IF_CM_GDDR3_READY
operator|)
return|;
block|}
ifndef|#
directive|ifndef
name|VXGE_HAL_TITAN_EMULATION
if|if
condition|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_RIC_RIC_RUNNING
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_RIC_RIC_RUNNING
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_RIC_RIC_RUNNING
operator|)
return|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_CMG_C_PLL_IN_LOCK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_CMG_C_PLL_IN_LOCK
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_CMG_C_PLL_IN_LOCK
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_XGMAC_X_PLL_IN_LOCK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_XGMAC_X_PLL_IN_LOCK
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_XGMAC_X_PLL_IN_LOCK
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_FBIF_M_PLL_IN_LOCK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_FBIF_M_PLL_IN_LOCK
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_FBIF_M_PLL_IN_LOCK
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_PCC_PCC_IDLE
argument_list|(
literal|0xFF
argument_list|)
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_PCC_PCC_IDLE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_PCC_PCC_IDLE
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|hw_status
operator|&
name|VXGE_HAL_ADAPTER_STATUS_ROCRC_RC_PRC_QUIESCENT
argument_list|(
literal|0xFF
argument_list|)
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_ROCRC_RC_PRC_QUIESCENT
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_ROCRC_RC_PRC_QUIESCENT
operator|)
return|;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0x"
name|VXGE_OS_STXFMT
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|ptr_t
operator|)
operator|*
name|hw_status
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_is_slot_freeze  * @devh: the device  *  * Returns non-zero if the slot is freezed.  * The determination is made based on the adapter_status  * register which will never give all FFs, unless PCI read  * cannot go through.  */
end_comment

begin_function
name|int
name|vxge_hal_device_is_slot_freeze
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|u16
name|device_id
decl_stmt|;
name|u64
name|adapter_status
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|adapter_status
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|adapter_status
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|vxge_offsetof
argument_list|(
name|vxge_hal_pci_config_le_t
argument_list|,
name|device_id
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|device_id
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|adapter_status
operator|==
name|VXGE_HAL_ALL_FOXES
operator|)
operator|||
operator|(
name|device_id
operator|==
literal|0xffff
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|adapter_status
operator|==
name|VXGE_HAL_ALL_FOXES
operator|)
operator|||
operator|(
name|device_id
operator|==
literal|0xffff
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_intr_enable - Enable interrupts.  * @devh: HAL device handle.  * @op: One of the vxge_hal_device_intr_e enumerated values specifying  *	  the type(s) of interrupts to enable.  *  * Enable X3100 interrupts. The function is to be executed the last in  * X3100 initialization sequence.  *  * See also: vxge_hal_device_intr_disable()  */
end_comment

begin_function
name|void
name|vxge_hal_device_intr_enable
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|u32
name|val32
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_device_mask_all
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
operator|(
name|void
operator|)
name|__hal_vpath_intr_enable
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_IRQLINE
operator|)
operator|||
operator|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_EMULATED_INTA
operator|)
condition|)
block|{
name|val64
operator|=
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_BMAP
index|]
expr_stmt|;
if|if
condition|(
name|val64
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status0
argument_list|)
expr_stmt|;
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
name|val64
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
name|val32
operator|=
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_BMAP
index|]
expr_stmt|;
if|if
condition|(
name|val32
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|val32
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status1
argument_list|)
expr_stmt|;
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
name|val32
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|titan_general_int_status
argument_list|)
expr_stmt|;
name|vxge_hal_device_unmask_all
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_intr_disable - Disable X3100 interrupts.  * @devh: HAL device handle.  * @op: One of the vxge_hal_device_intr_e enumerated values specifying  *	  the type(s) of interrupts to disable.  *  * Disable X3100 interrupts.  *  * See also: vxge_hal_device_intr_enable()  */
end_comment

begin_function
name|void
name|vxge_hal_device_intr_disable
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|u32
name|val32
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_device_mask_all
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_IRQLINE
operator|)
operator|||
operator|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_EMULATED_INTA
operator|)
condition|)
block|{
name|val64
operator|=
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_BMAP
index|]
expr_stmt|;
if|if
condition|(
name|val64
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
name|val32
operator|=
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_BMAP
index|]
expr_stmt|;
if|if
condition|(
name|val32
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|val32
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
operator|(
name|void
operator|)
name|__hal_vpath_intr_disable
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_device_unmask_all
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_mask_all - Mask all device interrupts.  * @devh: HAL device handle.  *  * Mask	all	device interrupts.  *  * See also: vxge_hal_device_unmask_all()  */
end_comment

begin_function
name|void
name|vxge_hal_device_mask_all
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u64
name|val64
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|val64
operator|=
name|VXGE_HAL_TITAN_MASK_ALL_INT_ALARM
operator||
name|VXGE_HAL_TITAN_MASK_ALL_INT_TRAFFIC
expr_stmt|;
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|u32
operator|)
name|bVAL32
argument_list|(
name|val64
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|titan_mask_all_int
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_unmask_all - Unmask all device interrupts.  * @devh: HAL device handle.  *  * Unmask all device interrupts.  *  * See also: vxge_hal_device_mask_all()  */
end_comment

begin_function
name|void
name|vxge_hal_device_unmask_all
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u64
name|val64
init|=
literal|0
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|intr_mode
operator|==
name|VXGE_HAL_INTR_MODE_IRQLINE
condition|)
name|val64
operator|=
name|VXGE_HAL_TITAN_MASK_ALL_INT_TRAFFIC
expr_stmt|;
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|u32
operator|)
name|bVAL32
argument_list|(
name|val64
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|titan_mask_all_int
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_begin_irq - Begin IRQ processing.  * @devh: HAL device handle.  * @skip_alarms: Do not clear the alarms  * @reason: "Reason" for the interrupt,	the value of X3100's  *			general_int_status register.  *  * The function	performs two actions, It first checks whether (shared IRQ) the  * interrupt was raised	by the device. Next, it	masks the device interrupts.  *  * Note:  * vxge_hal_device_begin_irq() does not flush MMIO writes through the  * bridge. Therefore, two back-to-back interrupts are potentially possible.  * It is the responsibility	of the ULD to make sure	that only one  * vxge_hal_device_continue_irq() runs at a time.  *  * Returns: 0, if the interrupt	is not "ours" (note that in this case the  * device remain enabled).  * Otherwise, vxge_hal_device_begin_irq() returns 64bit general adapter  * status.  * See also: vxge_hal_device_handle_irq()  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_begin_irq
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|skip_alarms
parameter_list|,
name|u64
modifier|*
name|reason
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|u64
name|adapter_status
decl_stmt|;
name|u64
name|vpath_mask
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_hal_status_e
name|ret
init|=
name|VXGE_HAL_ERR_WRONG_IRQ
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|reason
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", skip_alarms = %d, "
literal|"reason = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|skip_alarms
argument_list|,
operator|(
name|ptr_t
operator|)
name|reason
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|titan_general_int_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxge_os_unlikely
argument_list|(
operator|!
name|val64
argument_list|)
condition|)
block|{
comment|/* not Titan interrupt	 */
operator|*
name|reason
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|VXGE_HAL_ERR_WRONG_IRQ
expr_stmt|;
name|vxge_hal_info_log_device_irq
argument_list|(
literal|"wrong_isr general_int_status = \ 		    0x%llx"
argument_list|,
name|val64
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
if|if
condition|(
name|vxge_os_unlikely
argument_list|(
name|val64
operator|==
name|VXGE_HAL_ALL_FOXES
argument_list|)
condition|)
block|{
name|adapter_status
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|adapter_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter_status
operator|==
name|VXGE_HAL_ALL_FOXES
condition|)
block|{
name|vxge_hal_info_log_device_irq
argument_list|(
literal|"%s:Slot is frozen"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|__hal_device_handle_error
argument_list|(
name|hldev
argument_list|,
name|NULL_VPID
argument_list|,
name|VXGE_HAL_EVENT_SLOT_FREEZE
argument_list|)
expr_stmt|;
operator|*
name|reason
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|VXGE_HAL_ERR_SLOT_FREEZE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
operator|*
name|reason
operator|=
name|val64
expr_stmt|;
name|vpath_mask
operator|=
name|hldev
operator|->
name|vpaths_deployed
operator|>>
operator|(
literal|64
operator|-
name|VXGE_HAL_MAX_VIRTUAL_PATHS
operator|)
expr_stmt|;
if|if
condition|(
name|val64
operator|&
name|VXGE_HAL_TITAN_GENERAL_INT_STATUS_VPATH_TRAFFIC_INT
argument_list|(
name|vpath_mask
argument_list|)
condition|)
block|{
name|hldev
operator|->
name|header
operator|.
name|traffic_intr_cnt
operator|++
expr_stmt|;
name|ret
operator|=
name|VXGE_HAL_TRAFFIC_INTERRUPT
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
name|hldev
operator|->
name|header
operator|.
name|not_traffic_intr_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|vxge_os_unlikely
argument_list|(
name|val64
operator|&
name|VXGE_HAL_TITAN_GENERAL_INT_STATUS_VPATH_ALARM_INT
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|status
operator|=
name|__hal_vpath_alarm_process
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|,
name|skip_alarms
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_ERR_WRONG_IRQ
condition|)
name|ret
operator|=
name|status
expr_stmt|;
block|}
block|}
name|exit
label|:
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<==Error in  %s:%s:%d result = 0x%x general_int_status= 0x%llx"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|ret
argument_list|,
name|val64
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_continue_irq - Continue handling IRQ:	process	all  *				completed descriptors.  * @devh: HAL device handle.  *  * Process completed descriptors and unmask the	device interrupts.  *  * The vxge_hal_device_continue_irq() walks all open virtual paths  * and calls upper-layer driver	(ULD) via supplied completion  * callback.  *  * Note	that the vxge_hal_device_continue_irq is	part of	the _fast_ path.  * To optimize the processing, the function does _not_ check for  * errors and alarms.  *  * Returns: VXGE_HAL_OK.  *  * See also: vxge_hal_device_handle_irq()  * vxge_hal_ring_rxd_next_completed(),  * vxge_hal_fifo_txdl_next_completed(), vxge_hal_ring_callback_f {},  * vxge_hal_fifo_callback_f {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_continue_irq
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
operator|(
name|void
operator|)
name|vxge_hal_vpath_continue_irq
argument_list|(
name|VXGE_HAL_VIRTUAL_PATH_HANDLE
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_handle_irq - Handle device IRQ.  * @devh: HAL device handle.  * @skip_alarms: Do not clear the alarms  *  * Perform the complete	handling of the	line interrupt.	The function  * performs two	calls.  * First it uses vxge_hal_device_begin_irq() to check the reason for  * the interrupt and mask the device interrupts.  * Second, it calls	vxge_hal_device_continue_irq() to process all  * completed descriptors and re-enable the interrupts.  *  * Returns: VXGE_HAL_OK - success;  * VXGE_HAL_ERR_WRONG_IRQ - (shared) IRQ produced by other device.  *  * See also: vxge_hal_device_begin_irq(), vxge_hal_device_continue_irq().  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_handle_irq
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|skip_alarms
parameter_list|)
block|{
name|u64
name|reason
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", \ 	    skip_alarms = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|skip_alarms
argument_list|)
expr_stmt|;
name|vxge_hal_device_mask_all
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|status
operator|=
name|vxge_hal_device_begin_irq
argument_list|(
name|hldev
argument_list|,
name|skip_alarms
argument_list|,
operator|&
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxge_os_unlikely
argument_list|(
name|status
operator|==
name|VXGE_HAL_ERR_WRONG_IRQ
argument_list|)
condition|)
block|{
name|vxge_hal_device_unmask_all
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_TRAFFIC_INTERRUPT
condition|)
block|{
name|vxge_hal_device_clear_rx
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|status
operator|=
name|vxge_hal_device_continue_irq
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_device_clear_tx
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vxge_os_unlikely
argument_list|(
operator|(
name|status
operator|==
name|VXGE_HAL_ERR_CRITICAL
operator|)
operator|&&
name|skip_alarms
argument_list|)
condition|)
comment|/* ULD needs to unmask explicitely */
goto|goto
name|exit
goto|;
name|vxge_hal_device_unmask_all
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|exit
label|:
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_handle_link_up_ind  * @hldev: HAL device handle.  *  * Link up indication handler. The function is invoked by HAL when  * X3100 indicates that the link is up for programmable amount of time.  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_device_handle_link_up_ind
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
comment|/* 	 * If the previous link state is not down, return. 	 */
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|link_state
operator|==
name|VXGE_HAL_LINK_UP
condition|)
block|{
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
name|hldev
operator|->
name|header
operator|.
name|link_state
operator|=
name|VXGE_HAL_LINK_UP
expr_stmt|;
comment|/* notify ULD */
if|if
condition|(
name|g_vxge_hal_driver
operator|->
name|uld_callbacks
operator|.
name|link_up
condition|)
block|{
name|g_vxge_hal_driver
operator|->
name|uld_callbacks
operator|.
name|link_up
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|upper_layer_data
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_handle_link_down_ind  * @hldev: HAL device handle.  *  * Link down indication handler. The function is invoked by HAL when  * X3100 indicates that the link is down.  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_device_handle_link_down_ind
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|)
block|{
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
comment|/* 	 * If the previous link state is not down, return. 	 */
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|link_state
operator|==
name|VXGE_HAL_LINK_DOWN
condition|)
block|{
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
name|hldev
operator|->
name|header
operator|.
name|link_state
operator|=
name|VXGE_HAL_LINK_DOWN
expr_stmt|;
comment|/* notify ULD */
if|if
condition|(
name|g_vxge_hal_driver
operator|->
name|uld_callbacks
operator|.
name|link_down
condition|)
block|{
name|g_vxge_hal_driver
operator|->
name|uld_callbacks
operator|.
name|link_down
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|upper_layer_data
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_link_state_test - Test the link state.  * @devh: HAL device handle.  *  * Test link state.  * Returns: link state.  */
end_comment

begin_function
name|vxge_hal_device_link_state_e
name|vxge_hal_device_link_state_test
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_device_link_state_e
name|status
init|=
name|VXGE_HAL_LINK_NONE
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|status
operator|=
name|__hal_vpath_link_state_test
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_link_state_poll - Poll for the link state.  * @devh: HAL device handle.  *  * Get link state.  * Returns: link state.  */
end_comment

begin_function
name|vxge_hal_device_link_state_e
name|vxge_hal_device_link_state_poll
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_device_link_state_e
name|link_state
init|=
name|VXGE_HAL_LINK_NONE
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|hldev
operator|->
name|header
operator|.
name|link_state
operator|=
name|VXGE_HAL_LINK_NONE
expr_stmt|;
name|link_state
operator|=
name|__hal_vpath_link_state_poll
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|link_state
argument_list|)
expr_stmt|;
return|return
operator|(
name|link_state
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_data_rate_poll - Poll for the data rate.  * @devh: HAL device handle.  *  * Get data rate.  * Returns: data rate.  */
end_comment

begin_function
name|vxge_hal_device_data_rate_e
name|vxge_hal_device_data_rate_poll
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_device_data_rate_e
name|data_rate
init|=
name|VXGE_HAL_DATA_RATE_UNKNOWN
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|data_rate
operator|=
name|__hal_vpath_data_rate_poll
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|data_rate
argument_list|)
expr_stmt|;
return|return
operator|(
name|data_rate
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_lag_mode_get - Get Current LAG Mode  * @devh: HAL device handle.  *  * Get Current LAG Mode  */
end_comment

begin_function
name|vxge_hal_device_lag_mode_e
name|vxge_hal_device_lag_mode_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_device_lag_mode_e
name|lag_mode
init|=
name|VXGE_HAL_DEVICE_LAG_MODE_UNKNOWN
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|lag_mode
operator|=
name|__hal_vpath_lag_mode_get
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|lag_mode
argument_list|)
expr_stmt|;
return|return
operator|(
name|lag_mode
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_device_handle_error - Handle error  * @hldev: HAL device  * @vp_id: Vpath Id  * @type: Error type. Please see vxge_hal_event_e {}  *  * Handle error.  */
end_comment

begin_function
name|void
name|__hal_device_handle_error
parameter_list|(
name|__hal_device_t
modifier|*
name|hldev
parameter_list|,
name|u32
name|vp_id
parameter_list|,
name|vxge_hal_event_e
name|type
parameter_list|)
block|{
name|vxge_assert
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", vp_id = %d, type = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
name|vp_id
argument_list|,
name|type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
default|default:
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_TYPE
argument_list|)
expr_stmt|;
return|return;
case|case
name|VXGE_HAL_EVENT_UNKNOWN
case|:
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|dump_on_unknown
condition|)
block|{
operator|(
name|void
operator|)
name|vxge_hal_aux_device_dump
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_HAL_EVENT_SERR
case|:
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|dump_on_serr
condition|)
block|{
operator|(
name|void
operator|)
name|vxge_hal_aux_device_dump
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_HAL_EVENT_CRITICAL
case|:
case|case
name|VXGE_HAL_EVENT_SRPCIM_CRITICAL
case|:
case|case
name|VXGE_HAL_EVENT_MRPCIM_CRITICAL
case|:
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|dump_on_critical
condition|)
block|{
operator|(
name|void
operator|)
name|vxge_hal_aux_device_dump
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_HAL_EVENT_ECCERR
case|:
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|dump_on_eccerr
condition|)
block|{
operator|(
name|void
operator|)
name|vxge_hal_aux_device_dump
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VXGE_HAL_EVENT_KDFCCTL
case|:
break|break;
case|case
name|VXGE_HAL_EVENT_DEVICE_RESET_START
case|:
break|break;
case|case
name|VXGE_HAL_EVENT_DEVICE_RESET_COMPLETE
case|:
break|break;
case|case
name|VXGE_HAL_EVENT_VPATH_RESET_START
case|:
break|break;
case|case
name|VXGE_HAL_EVENT_VPATH_RESET_COMPLETE
case|:
break|break;
case|case
name|VXGE_HAL_EVENT_SLOT_FREEZE
case|:
break|break;
block|}
comment|/* notify ULD */
if|if
condition|(
name|g_vxge_hal_driver
operator|->
name|uld_callbacks
operator|.
name|crit_err
condition|)
block|{
name|g_vxge_hal_driver
operator|->
name|uld_callbacks
operator|.
name|crit_err
argument_list|(
operator|(
name|vxge_hal_device_h
operator|)
name|hldev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|upper_layer_data
argument_list|,
name|type
argument_list|,
name|vp_id
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_mask_tx - Mask Tx interrupts.  * @devh: HAL device.  *  * Mask	Tx device interrupts.  *  * See also: vxge_hal_device_unmask_tx(), vxge_hal_device_mask_rx(),  * vxge_hal_device_clear_tx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_mask_tx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_clear_tx - Acknowledge (that is, clear) the  * condition that has caused the TX	interrupt.  * @devh: HAL device.  *  * Acknowledge (that is, clear)	the	condition that has caused  * the Tx interrupt.  * See also: vxge_hal_device_begin_irq(), vxge_hal_device_continue_irq(),  * vxge_hal_device_clear_rx(), vxge_hal_device_mask_tx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_clear_tx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_unmask_tx - Unmask Tx	interrupts.  * @devh: HAL device.  *  * Unmask Tx device interrupts.  *  * See also: vxge_hal_device_mask_tx(), vxge_hal_device_clear_tx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_unmask_tx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_mask_rx - Mask Rx	interrupts.  * @devh: HAL device.  *  * Mask	Rx device interrupts.  *  * See also: vxge_hal_device_unmask_rx(), vxge_hal_device_mask_tx(),  * vxge_hal_device_clear_rx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_mask_rx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_clear_rx - Acknowledge (that is, clear) the  * condition that has caused the RX	interrupt.  * @devh: HAL device.  *  * Acknowledge (that is, clear)	the	condition that has caused  * the Rx interrupt.  * See also: vxge_hal_device_begin_irq(), vxge_hal_device_continue_irq(),  * vxge_hal_device_clear_tx(), vxge_hal_device_mask_rx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_clear_rx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_unmask_rx - Unmask Rx	interrupts.  * @devh: HAL device.  *  * Unmask Rx device interrupts.  *  * See also: vxge_hal_device_mask_rx(), vxge_hal_device_clear_rx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_unmask_rx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_mask_tx_rx - Mask Tx and Rx interrupts.  * @devh: HAL device.  *  * Mask Tx and Rx device interrupts.  *  * See also: vxge_hal_device_unmask_tx_rx(), vxge_hal_device_clear_tx_rx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_mask_tx_rx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_clear_tx_rx - Acknowledge (that is, clear) the  * condition that has caused the Tx and RX interrupt.  * @devh: HAL device.  *  * Acknowledge (that is, clear)	the	condition that has caused  * the Tx and Rx interrupt.  * See also: vxge_hal_device_begin_irq(), vxge_hal_device_continue_irq(),  * vxge_hal_device_mask_tx_rx(), vxge_hal_device_unmask_tx_rx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_clear_tx_rx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_status1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_unmask_tx_rx - Unmask Tx and Rx interrupts.  * @devh: HAL device.  *  * Unmask Rx device interrupts.  *  * See also: vxge_hal_device_mask_tx_rx(), vxge_hal_device_clear_tx_rx().  */
end_comment

begin_function
name|void
name|vxge_hal_device_unmask_tx_rx
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
operator|(
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask0
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|~
operator|(
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_TX
index|]
operator||
name|hldev
operator|->
name|tim_int_mask1
index|[
name|VXGE_HAL_VPATH_INTR_RX
index|]
operator|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|tim_int_mask1
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_device_irq
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_hw_info_get - Get the hw information  * @pdev: PCI device object.  * @regh0: BAR0 mapped memory handle (Solaris), or simply PCI device @pdev  *	(Linux and the rest.)  * @bar0: Address of BAR0 in PCI config  * @hw_info: Buffer to return vxge_hal_device_hw_info_t {} structure  *  * Returns the vpath mask that has the bits set for each vpath allocated  * for the driver, FW version information and the first mac addresse for  * each vpath  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_hw_info_get
parameter_list|(
name|pci_dev_h
name|pdev
parameter_list|,
name|pci_reg_h
name|regh0
parameter_list|,
name|u8
modifier|*
name|bar0
parameter_list|,
name|vxge_hal_device_hw_info_t
modifier|*
name|hw_info
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|vxge_hal_legacy_reg_t
modifier|*
name|legacy_reg
decl_stmt|;
name|vxge_hal_toc_reg_t
modifier|*
name|toc_reg
decl_stmt|;
name|vxge_hal_mrpcim_reg_t
modifier|*
name|mrpcim_reg
decl_stmt|;
name|vxge_hal_common_reg_t
modifier|*
name|common_reg
decl_stmt|;
name|vxge_hal_vpath_reg_t
modifier|*
name|vpath_reg
decl_stmt|;
name|vxge_hal_vpmgmt_reg_t
modifier|*
name|vpmgmt_reg
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"pdev = 0x"
name|VXGE_OS_STXFMT
literal|", regh0 = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"bar0 = 0x"
name|VXGE_OS_STXFMT
literal|", hw_info = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|pdev
argument_list|,
operator|(
name|ptr_t
operator|)
name|regh0
argument_list|,
operator|(
name|ptr_t
operator|)
name|bar0
argument_list|,
operator|(
name|ptr_t
operator|)
name|hw_info
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|bar0
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|hw_info
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_os_memzero
argument_list|(
name|hw_info
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|legacy_reg
operator|=
operator|(
name|vxge_hal_legacy_reg_t
operator|*
operator|)
name|vxge_hal_device_get_legacy_reg
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
name|bar0
argument_list|)
expr_stmt|;
name|status
operator|=
name|__hal_legacy_swapper_set
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
name|legacy_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|legacy_reg
operator|->
name|toc_first_pointer
argument_list|)
expr_stmt|;
name|toc_reg
operator|=
operator|(
name|vxge_hal_toc_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|toc_reg
operator|->
name|toc_common_pointer
argument_list|)
expr_stmt|;
name|common_reg
operator|=
operator|(
name|vxge_hal_common_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|status
operator|=
name|vxge_hal_device_register_poll
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|common_reg
operator|->
name|vpath_rst_in_prog
argument_list|,
literal|0
argument_list|,
name|VXGE_HAL_VPATH_RST_IN_PROG_VPATH_RST_IN_PROG
argument_list|(
literal|0x1ffff
argument_list|)
argument_list|,
name|VXGE_HAL_DEF_DEVICE_POLL_MILLIS
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|hw_info
operator|->
name|vpath_mask
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|common_reg
operator|->
name|vpath_assignments
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|common_reg
operator|->
name|host_type_assignments
argument_list|)
expr_stmt|;
name|hw_info
operator|->
name|host_type
operator|=
operator|(
name|u32
operator|)
name|VXGE_HAL_HOST_TYPE_ASSIGNMENTS_GET_HOST_TYPE_ASSIGNMENTS
argument_list|(
name|val64
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|hw_info
operator|->
name|vpath_mask
operator|)
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|toc_reg
operator|->
name|toc_vpmgmt_pointer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vpmgmt_reg
operator|=
operator|(
name|vxge_hal_vpmgmt_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|vpmgmt_reg
operator|->
name|vpath_to_func_map_cfg1
argument_list|)
expr_stmt|;
name|hw_info
operator|->
name|func_id
operator|=
operator|(
name|u32
operator|)
name|VXGE_HAL_VPATH_TO_FUNC_MAP_CFG1_GET_CFG1
argument_list|(
name|val64
argument_list|)
expr_stmt|;
if|if
condition|(
name|__hal_device_access_rights_get
argument_list|(
name|hw_info
operator|->
name|host_type
argument_list|,
name|hw_info
operator|->
name|func_id
argument_list|)
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
condition|)
block|{
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|toc_reg
operator|->
name|toc_mrpcim_pointer
argument_list|)
expr_stmt|;
name|mrpcim_reg
operator|=
operator|(
name|vxge_hal_mrpcim_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|vxge_os_pio_mem_write64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
literal|0
argument_list|,
operator|&
name|mrpcim_reg
operator|->
name|xgmac_gen_fw_memo_mask
argument_list|)
expr_stmt|;
name|vxge_os_wmb
argument_list|()
expr_stmt|;
block|}
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|toc_reg
operator|->
name|toc_vpath_pointer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vpath_reg
operator|=
operator|(
name|vxge_hal_vpath_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_fw_flash_ver_get
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
name|i
argument_list|,
name|vpath_reg
argument_list|,
operator|&
name|hw_info
operator|->
name|fw_version
argument_list|,
operator|&
name|hw_info
operator|->
name|fw_date
argument_list|,
operator|&
name|hw_info
operator|->
name|flash_version
argument_list|,
operator|&
name|hw_info
operator|->
name|flash_date
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_card_info_get
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
name|i
argument_list|,
name|vpath_reg
argument_list|,
name|hw_info
operator|->
name|serial_number
argument_list|,
name|hw_info
operator|->
name|part_number
argument_list|,
name|hw_info
operator|->
name|product_description
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pmd_info_get
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
name|i
argument_list|,
name|vpath_reg
argument_list|,
operator|&
name|hw_info
operator|->
name|ports
argument_list|,
operator|&
name|hw_info
operator|->
name|pmd_port0
argument_list|,
operator|&
name|hw_info
operator|->
name|pmd_port1
argument_list|)
expr_stmt|;
name|hw_info
operator|->
name|function_mode
operator|=
name|__hal_vpath_pci_func_mode_get
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
name|i
argument_list|,
name|vpath_reg
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|hw_info
operator|->
name|vpath_mask
operator|)
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
operator|&
name|toc_reg
operator|->
name|toc_vpath_pointer
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vpath_reg
operator|=
operator|(
name|vxge_hal_vpath_reg_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
name|bar0
operator|+
name|val64
operator|)
operator|)
expr_stmt|;
name|status
operator|=
name|__hal_vpath_hw_addr_get
argument_list|(
name|pdev
argument_list|,
name|regh0
argument_list|,
name|i
argument_list|,
name|vpath_reg
argument_list|,
name|hw_info
operator|->
name|mac_addrs
index|[
name|i
index|]
argument_list|,
name|hw_info
operator|->
name|mac_addr_masks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_initialize - Initialize X3100 device.  * @hldev: HAL device handle.  * @attr: pointer to vxge_hal_device_attr_t structure  * @device_config: Configuration to be _applied_ to the device,  *		For the X3100 configuration "knobs" please  *		refer to vxge_hal_device_config_t and X3100  *		User Guide.  *  * Initialize X3100 device. Note that all the arguments of this public API  * are 'IN', including @hldev. Upper-layer driver (ULD) cooperates with  * OS to find new X3100 device, locate its PCI and memory spaces.  *  * When done, the ULD allocates sizeof(__hal_device_t) bytes for HAL  * to enable the latter to perform X3100 hardware initialization.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_DRIVER_NOT_INITIALIZED - Driver is not initialized.  * VXGE_HAL_ERR_BAD_DEVICE_CONFIG - Device configuration params are not  * valid.  * VXGE_HAL_ERR_OUT_OF_MEMORY - Memory allocation failed.  * VXGE_HAL_ERR_BAD_SUBSYSTEM_ID - Device subsystem id is invalid.  * VXGE_HAL_ERR_INVALID_MAC_ADDRESS - Device mac address in not valid.  * VXGE_HAL_INF_MEM_STROBE_CMD_EXECUTING - Failed to retrieve the mac  * address within the time(timeout) or TTI/RTI initialization failed.  * VXGE_HAL_ERR_SWAPPER_CTRL - Failed to configure swapper control.  *  * See also: __hal_device_terminate(), vxge_hal_status_e {}  * vxge_hal_device_attr_t {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_initialize
parameter_list|(
name|vxge_hal_device_h
modifier|*
name|devh
parameter_list|,
name|vxge_hal_device_attr_t
modifier|*
name|attr
parameter_list|,
name|vxge_hal_device_config_t
modifier|*
name|device_config
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u32
name|nblocks
init|=
literal|0
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|devh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|attr
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|device_config
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", attr = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"device_config = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|attr
argument_list|,
operator|(
name|ptr_t
operator|)
name|device_config
argument_list|)
expr_stmt|;
comment|/* sanity check */
if|if
condition|(
name|g_vxge_hal_driver
operator|==
name|NULL
operator|||
operator|!
name|g_vxge_hal_driver
operator|->
name|is_initialized
condition|)
block|{
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_DRIVER_NOT_INITIALIZED
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_DRIVER_NOT_INITIALIZED
operator|)
return|;
block|}
name|status
operator|=
name|__hal_device_config_check
argument_list|(
name|device_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
name|attr
operator|->
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_device_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|hldev
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_device_t
argument_list|)
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|magic
operator|=
name|VXGE_HAL_DEVICE_MAGIC
expr_stmt|;
name|__hal_channel_init_pending_list
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_device_debug_set
argument_list|(
name|hldev
argument_list|,
name|device_config
operator|->
name|debug_level
argument_list|,
name|device_config
operator|->
name|debug_mask
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_TRACE_INTO_CIRCULAR_ARR
argument_list|)
name|hldev
operator|->
name|trace_buf
operator|.
name|size
operator|=
name|device_config
operator|->
name|tracebuf_size
expr_stmt|;
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|=
operator|(
name|u8
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
name|attr
operator|->
name|pdev
argument_list|,
name|hldev
operator|->
name|trace_buf
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|vxge_os_printf
argument_list|(
literal|"cannot allocate trace buffer!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|hldev
operator|->
name|trace_buf
operator|.
name|wrapped_count
operator|=
literal|0
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_info_log_device
argument_list|(
literal|"device 0x"
name|VXGE_OS_STXFMT
literal|" is initializing"
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|)
expr_stmt|;
comment|/* apply config */
name|vxge_os_memcpy
argument_list|(
operator|&
name|hldev
operator|->
name|header
operator|.
name|config
argument_list|,
name|device_config
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_config_t
argument_list|)
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|regh0
operator|=
name|attr
operator|->
name|regh0
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|regh1
operator|=
name|attr
operator|->
name|regh1
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|regh2
operator|=
name|attr
operator|->
name|regh2
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|=
name|attr
operator|->
name|bar0
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|bar1
operator|=
name|attr
operator|->
name|bar1
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|bar2
operator|=
name|attr
operator|->
name|bar2
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|pdev
operator|=
name|attr
operator|->
name|pdev
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|irqh
operator|=
name|attr
operator|->
name|irqh
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|cfgh
operator|=
name|attr
operator|->
name|cfgh
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|__hal_device_reg_addr_get
argument_list|(
name|hldev
argument_list|)
operator|)
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|vxge_hal_device_terminate
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|__hal_device_id_get
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|__hal_device_host_info_get
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|nblocks
operator|+=
literal|1
expr_stmt|;
comment|/* For MRPCIM stats */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
if|if
condition|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|enable
operator|==
name|VXGE_HAL_RING_ENABLE
condition|)
block|{
name|nblocks
operator|+=
operator|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|ring_length
operator|+
name|vxge_hal_ring_rxds_per_block_get
argument_list|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|buffer_mode
argument_list|)
operator|-
literal|1
operator|)
operator|/
name|vxge_hal_ring_rxds_per_block_get
argument_list|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|ring
operator|.
name|buffer_mode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|fifo
operator|.
name|enable
operator|==
name|VXGE_HAL_FIFO_ENABLE
operator|)
operator|&&
operator|(
operator|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|fifo
operator|.
name|max_frags
operator|*
sizeof|sizeof
argument_list|(
name|vxge_hal_fifo_txd_t
argument_list|)
operator|)
operator|<=
name|VXGE_OS_HOST_PAGE_SIZE
operator|)
condition|)
block|{
name|nblocks
operator|+=
operator|(
operator|(
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|fifo
operator|.
name|fifo_length
operator|*
sizeof|sizeof
argument_list|(
name|vxge_hal_fifo_txd_t
argument_list|)
operator|*
name|device_config
operator|->
name|vp_config
index|[
name|i
index|]
operator|.
name|fifo
operator|.
name|max_frags
operator|)
operator|+
name|VXGE_OS_HOST_PAGE_SIZE
operator|-
literal|1
operator|)
operator|/
name|VXGE_OS_HOST_PAGE_SIZE
expr_stmt|;
block|}
name|nblocks
operator|+=
literal|1
expr_stmt|;
comment|/* For vpath stats */
block|}
if|if
condition|(
name|__hal_blockpool_create
argument_list|(
name|hldev
argument_list|,
operator|&
name|hldev
operator|->
name|block_pool
argument_list|,
name|device_config
operator|->
name|dma_blockpool_initial
operator|+
name|nblocks
argument_list|,
name|device_config
operator|->
name|dma_blockpool_incr
argument_list|,
name|device_config
operator|->
name|dma_blockpool_min
argument_list|,
name|device_config
operator|->
name|dma_blockpool_max
operator|+
name|nblocks
argument_list|)
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_info_log_device
argument_list|(
literal|"%s:__hal_blockpool_create failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
name|vxge_hal_device_terminate
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|status
operator|=
name|__hal_device_hw_initialize
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|vxge_hal_device_terminate
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|hldev
operator|->
name|dump_buf
operator|=
operator|(
name|char
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|VXGE_HAL_DUMP_BUF_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|dump_buf
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_info_log_device
argument_list|(
literal|"%s:vxge_os_malloc failed "
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
name|vxge_hal_device_terminate
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|hldev
operator|->
name|header
operator|.
name|is_initialized
operator|=
literal|1
expr_stmt|;
operator|*
name|devh
operator|=
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_terminate - Terminate X3100 device.  * @devh: HAL device handle.  *  * Terminate HAL device.  *  * See also: vxge_hal_device_initialize().  */
end_comment

begin_function
name|void
name|vxge_hal_device_terminate
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|g_vxge_hal_driver
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|hldev
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|==
name|VXGE_HAL_DEVICE_MAGIC
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|terminating
operator|=
literal|1
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|is_initialized
operator|=
literal|0
expr_stmt|;
name|hldev
operator|->
name|in_poll
operator|=
literal|0
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|magic
operator|=
name|VXGE_HAL_DEVICE_DEAD
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|dump_buf
condition|)
block|{
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|dump_buf
argument_list|,
name|VXGE_HAL_DUMP_BUF_SIZE
argument_list|)
expr_stmt|;
name|hldev
operator|->
name|dump_buf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|hldev
operator|->
name|srpcim
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|__hal_srpcim_terminate
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|mrpcim
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|__hal_mrpcim_terminate
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|__hal_channel_destroy_pending_list
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|__hal_blockpool_destroy
argument_list|(
operator|&
name|hldev
operator|->
name|block_pool
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_TRACE_INTO_CIRCULAR_ARR
argument_list|)
if|if
condition|(
name|hldev
operator|->
name|trace_buf
operator|.
name|size
condition|)
block|{
name|vxge_os_free
argument_list|(
name|NULL
argument_list|,
name|hldev
operator|->
name|trace_buf
operator|.
name|data
argument_list|,
name|hldev
operator|->
name|trace_buf
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_device_t
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_enable - Enable device.  * @devh: HAL device handle.  *  * Enable the specified device: bring up the link/interface.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_enable
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hldev
operator|->
name|hw_is_initialized
condition|)
block|{
name|status
operator|=
name|__hal_device_hw_initialize
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
name|__hal_device_bus_master_enable
argument_list|(
name|hldev
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_disable - Disable X3100 adapter.  * @devh: HAL device handle.  *  * Disable this device. To gracefully reset the adapter, the host should:  *  *	- call vxge_hal_device_disable();  *  *	- call vxge_hal_device_intr_disable();  *  *	- do some work (error recovery, change mtu, reset, etc);  *  *	- call vxge_hal_device_enable();  *  *	- call vxge_hal_device_intr_enable().  *  * Note: Disabling the device does _not_ include disabling of interrupts.  * After disabling the device stops receiving new frames but those frames  * that were already in the pipe will keep coming for some few milliseconds.  *  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_disable
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|VXGE_COMPONENT_HAL_DEVICE
operator|&
name|VXGE_DEBUG_MODULE_MASK
operator|)
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_hw_stats_enable - Enable device h/w statistics.  * @devh: HAL Device.  *  * Enable the DMA vpath statistics for the device. The function is to be called  * to re-enable the adapter to update stats into the host memory  *  * See also: vxge_hal_device_hw_stats_disable()  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_hw_stats_enable
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|stats_cfg0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|vxge_os_memcpy
argument_list|(
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
operator|.
name|hw_stats_sav
argument_list|,
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
operator|.
name|hw_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|stats_read_method
operator|==
name|VXGE_HAL_STATS_READ_METHOD_DMA
condition|)
block|{
name|val64
operator||=
name|VXGE_HAL_STATS_CFG0_STATS_ENABLE
argument_list|(
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|i
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|__hal_vpath_hw_stats_get
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|,
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
operator|.
name|hw_stats
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|u32
operator|)
name|bVAL32
argument_list|(
name|val64
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|stats_cfg0
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_hw_stats_disable - Disable device h/w statistics.  * @devh: HAL Device.  *  * Enable the DMA vpath statistics for the device. The function is to be called  * to disable the adapter to update stats into the host memory. This function  * is not needed to be called, normally.  *  * See also: vxge_hal_device_hw_stats_enable()  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_hw_stats_disable
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|)
expr_stmt|;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|stats_cfg0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|val64
operator|&=
operator|~
name|VXGE_HAL_STATS_CFG0_STATS_ENABLE
argument_list|(
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|i
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_pio_mem_write32_upper
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|u32
operator|)
name|bVAL32
argument_list|(
name|val64
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|stats_cfg0
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_hw_stats_get - Get the device hw statistics.  * @devh: HAL Device.  * @hw_stats: Hardware stats  *  * Returns the vpath h/w stats for the device.  *  * See also: vxge_hal_device_hw_stats_enable(),  * vxge_hal_device_hw_stats_disable()  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_hw_stats_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_device_stats_hw_info_t
modifier|*
name|hw_stats
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
init|=
literal|0
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|devh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|hw_stats
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", hw_stats = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|hw_stats
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|stats_read_method
operator|==
name|VXGE_HAL_STATS_READ_METHOD_DMA
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|val64
operator||=
name|VXGE_HAL_STATS_CFG0_STATS_ENABLE
argument_list|(
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|i
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|vxge_hal_device_register_poll
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|common_reg
operator|->
name|stats_cfg0
argument_list|,
literal|0
argument_list|,
name|val64
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|device_poll_millis
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_os_memcpy
argument_list|(
name|hw_stats
argument_list|,
operator|&
name|hldev
operator|->
name|stats
operator|.
name|hw_dev_info_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_stats_hw_info_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_sw_stats_get - Get the device sw statistics.  * @devh: HAL Device.  * @sw_stats: Software stats  *  * Returns the vpath s/w stats for the device.  *  * See also: vxge_hal_device_hw_stats_get()  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_sw_stats_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_device_stats_sw_info_t
modifier|*
name|sw_stats
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sw_stats
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", sw_stats = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|sw_stats
argument_list|)
expr_stmt|;
name|vxge_os_memcpy
argument_list|(
name|sw_stats
argument_list|,
operator|&
name|hldev
operator|->
name|stats
operator|.
name|sw_dev_info_stats
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_stats_sw_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_stats_get - Get the device statistics.  * @devh: HAL Device.  * @stats: Device stats  *  * Returns the device stats for the device.  *  * See also: vxge_hal_device_hw_stats_get(), vxge_hal_device_sw_stats_get()  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_stats_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_device_stats_t
modifier|*
name|stats
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|stats
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", stats = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|stats
argument_list|)
expr_stmt|;
name|vxge_os_memcpy
argument_list|(
name|stats
argument_list|,
operator|&
name|hldev
operator|->
name|stats
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_stats_t
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_xmac_stats_get - Get the Device XMAC Statistics  * @devh: HAL device handle.  * @xmac_stats: Buffer to return XMAC Statistics.  *  * Get the XMAC Statistics  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_xmac_stats_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_device_xmac_stats_t
modifier|*
name|xmac_stats
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|xmac_stats
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_stats
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", xmac_stats = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|xmac_stats
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpaths_deployed
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|status
operator|=
name|__hal_vpath_xmac_tx_stats_get
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|,
operator|&
name|xmac_stats
operator|->
name|vpath_tx_stats
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|status
operator|=
name|__hal_vpath_xmac_rx_stats_get
argument_list|(
operator|&
name|hldev
operator|->
name|virtual_paths
index|[
name|i
index|]
argument_list|,
operator|&
name|xmac_stats
operator|->
name|vpath_rx_stats
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
name|vxge_hal_trace_log_stats
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|VXGE_TRACE_INTO_CIRCULAR_ARR
argument_list|)
end_if

begin_comment
comment|/*  * vxge_hal_device_trace_write - Write the trace from the given buffer into  *				 circular trace buffer  * @devh: HAL device handle.  * @trace_buf: Buffer containing the trace.  * @trace_len: Length of the trace in the buffer  *  * Writes the trace from the given buffer into the circular trace buffer  *  */
end_comment

begin_function
name|void
name|vxge_hal_device_trace_write
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u8
modifier|*
name|trace_buf
parameter_list|,
name|u32
name|trace_len
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|u32
name|offset
decl_stmt|;
if|if
condition|(
name|hldev
operator|==
name|NULL
condition|)
return|return;
name|offset
operator|=
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|trace_len
operator|>
literal|1
condition|)
block|{
name|u32
name|leftsize
init|=
name|hldev
operator|->
name|trace_buf
operator|.
name|size
operator|-
name|offset
decl_stmt|;
if|if
condition|(
name|trace_len
operator|>
name|leftsize
condition|)
block|{
name|vxge_os_memzero
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|offset
argument_list|,
name|leftsize
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
name|hldev
operator|->
name|trace_buf
operator|.
name|wrapped_count
operator|++
expr_stmt|;
block|}
name|vxge_os_memcpy
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|offset
argument_list|,
name|trace_buf
argument_list|,
name|trace_len
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|trace_len
expr_stmt|;
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
operator|=
name|offset
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_trace_dump - Dump the trace buffer.  * @devh: HAL device handle.  *  * Dump the trace buffer contents.  */
end_comment

begin_function
name|void
name|vxge_hal_device_trace_dump
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|u32
name|offset
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|hldev
operator|==
name|NULL
condition|)
return|return;
name|offset
operator|=
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
expr_stmt|;
name|vxge_os_printf
argument_list|(
literal|"################ Trace dump Begin ###############\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|trace_buf
operator|.
name|wrapped_count
condition|)
block|{
for|for
control|(
name|i
operator|=
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
init|;
name|i
operator|<
name|hldev
operator|->
name|trace_buf
operator|.
name|size
condition|;
name|i
operator|+=
name|offset
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
operator|)
condition|)
name|vxge_os_printf
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
expr_stmt|;
name|offset
operator|=
name|vxge_os_strlen
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
condition|;
name|i
operator|+=
name|offset
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
operator|)
condition|)
name|vxge_os_printf
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
expr_stmt|;
name|offset
operator|=
name|vxge_os_strlen
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
name|vxge_os_printf
argument_list|(
literal|"################ Trace dump End ###############\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_trace_read - Read trace buffer contents.  * @devh: HAL device handle.  * @buffer: Buffer to store the trace buffer contents.  * @buf_size: Size of the buffer.  * @read_length: Size of the valid data in the buffer.  *  * Read  HAL trace buffer contents starting from the offset  * up to the size of the buffer or till EOF is reached.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_EOF_TRACE_BUF - No more data in the trace buffer.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_trace_read
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|unsigned
name|buf_size
parameter_list|,
name|unsigned
modifier|*
name|read_length
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|u32
name|offset
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|buf_off
init|=
literal|0
decl_stmt|;
operator|*
name|read_length
operator|=
literal|0
expr_stmt|;
operator|*
name|buffer
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hldev
operator|==
name|NULL
condition|)
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
name|offset
operator|=
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|trace_buf
operator|.
name|wrapped_count
condition|)
block|{
for|for
control|(
name|i
operator|=
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
init|;
name|i
operator|<
name|hldev
operator|->
name|trace_buf
operator|.
name|size
condition|;
name|i
operator|+=
name|offset
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
operator|)
condition|)
block|{
name|vxge_os_sprintf
argument_list|(
name|buffer
operator|+
name|buf_off
argument_list|,
literal|"%s\n"
argument_list|,
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
expr_stmt|;
name|buf_off
operator|+=
name|vxge_os_strlen
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|buf_off
operator|>
name|buf_size
condition|)
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|offset
operator|=
name|vxge_os_strlen
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hldev
operator|->
name|trace_buf
operator|.
name|offset
condition|;
name|i
operator|+=
name|offset
control|)
block|{
if|if
condition|(
operator|*
operator|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
operator|)
condition|)
block|{
name|vxge_os_sprintf
argument_list|(
name|buffer
operator|+
name|buf_off
argument_list|,
literal|"%s\n"
argument_list|,
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
expr_stmt|;
name|buf_off
operator|+=
name|vxge_os_strlen
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|buf_off
operator|>
name|buf_size
condition|)
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|offset
operator|=
name|vxge_os_strlen
argument_list|(
name|hldev
operator|->
name|trace_buf
operator|.
name|data
operator|+
name|i
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
operator|*
name|read_length
operator|=
name|buf_off
expr_stmt|;
operator|*
operator|(
name|buffer
operator|+
name|buf_off
operator|+
literal|1
operator|)
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * vxge_hal_device_debug_set - Set the debug module, level and timestamp  * @devh: Hal device object  * @level: Debug level as defined in enum vxge_debug_level_e  * @module masks: An or value of component masks as defined in vxge_debug.h  *  * This routine is used to dynamically change the debug output  */
end_comment

begin_function
name|void
name|vxge_hal_device_debug_set
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_debug_level_e
name|level
parameter_list|,
name|u32
name|mask
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|hldev
operator|->
name|header
operator|.
name|debug_module_mask
operator|=
name|mask
expr_stmt|;
name|hldev
operator|->
name|header
operator|.
name|debug_level
operator|=
name|level
expr_stmt|;
name|hldev
operator|->
name|d_trace_mask
operator|=
literal|0
expr_stmt|;
name|hldev
operator|->
name|d_info_mask
operator|=
literal|0
expr_stmt|;
name|hldev
operator|->
name|d_err_mask
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|level
condition|)
block|{
case|case
name|VXGE_TRACE
case|:
name|hldev
operator|->
name|d_trace_mask
operator|=
name|mask
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_INFO
case|:
name|hldev
operator|->
name|d_info_mask
operator|=
name|mask
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VXGE_ERR
case|:
name|hldev
operator|->
name|d_err_mask
operator|=
name|mask
expr_stmt|;
comment|/* FALLTHROUGH */
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_flick_link_led - Flick (blink) link LED.  * @devh: HAL device handle.  * @port : Port number 0, or 1  * @on_off: TRUE if flickering to be on, FALSE to be off  *  * Flicker the link LED.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_flick_link_led
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|port
parameter_list|,
name|u32
name|on_off
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", port = %d, on_off = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|port
argument_list|,
name|on_off
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
name|status
operator|=
name|__hal_vpath_flick_link_led
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|port
argument_list|,
name|on_off
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_device_getpause_data -Pause frame frame generation and reception.  * @devh: HAL device handle.  * @port : Port number 0, 1, or 2  * @tx : A field to return the pause generation capability of the NIC.  * @rx : A field to return the pause reception capability of the NIC.  *  * Returns the Pause frame generation and reception capability of the NIC.  * Return value:  * status  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_getpause_data
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|port
parameter_list|,
name|u32
modifier|*
name|tx
parameter_list|,
name|u32
modifier|*
name|rx
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u64
name|val64
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_ERR_VPATH_NOT_AVAILABLE
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"port = %d, tx = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"rx = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|port
argument_list|,
operator|(
name|ptr_t
operator|)
name|tx
argument_list|,
operator|(
name|ptr_t
operator|)
name|rx
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
name|port
operator|>=
name|VXGE_HAL_MAC_MAX_PORTS
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_PORT
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_PORT
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_MAX_VIRTUAL_PATHS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|i
argument_list|)
operator|)
condition|)
continue|continue;
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|i
index|]
operator|->
name|rxmac_pause_cfg_port_vpmgmt_clone
index|[
name|port
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|val64
operator|&
name|VXGE_HAL_RXMAC_PAUSE_CFG_PORT_VPMGMT_CLONE_GEN_EN
condition|)
operator|*
name|tx
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|val64
operator|&
name|VXGE_HAL_RXMAC_PAUSE_CFG_PORT_VPMGMT_CLONE_RCV_EN
condition|)
operator|*
name|rx
operator|=
literal|1
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|vxge_hal_status_e
name|vxge_hal_device_is_privileged
parameter_list|(
name|u32
name|host_type
parameter_list|,
name|u32
name|func_id
parameter_list|)
block|{
name|u32
name|access_rights
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
decl_stmt|;
name|access_rights
operator|=
name|__hal_device_access_rights_get
argument_list|(
name|host_type
argument_list|,
name|func_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
condition|)
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

end_unit


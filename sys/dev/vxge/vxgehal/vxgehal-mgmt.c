begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * SPDX-License-Identifier: BSD-3-Clause  *  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxgehal/vxgehal.h>
end_include

begin_comment
comment|/*  * vxge_hal_mgmt_about - Retrieve about info.  * @devh: HAL device handle.  * @about_info: Filled in by HAL. See vxge_hal_mgmt_about_info_t {}.  * @size: Pointer to buffer containing the Size of the @buffer_info.  * HAL will return an error if the size is smaller than  * sizeof(vxge_hal_mgmt_about_info_t) and returns required size in this field  *  * Retrieve information such as PCI device and vendor IDs, board  * revision number, HAL version number, etc.  *  * Returns: VXGE_HAL_OK - success;  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_VERSION_CONFLICT - Version it not matching.  * VXGE_HAL_ERR_OUT_OF_SPACE - If the buffer is not sufficient  * VXGE_HAL_FAIL - Failed to retrieve the information.  *  * See also: vxge_hal_mgmt_about_info_t {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_about
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_about_info_t
modifier|*
name|about_info
parameter_list|,
name|u32
modifier|*
name|size
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|about_info
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|size
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", about_info = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"size = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|about_info
argument_list|,
operator|(
name|ptr_t
operator|)
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_mgmt_about_info_t
argument_list|)
condition|)
block|{
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_mgmt_about_info_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_SPACE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_SPACE
operator|)
return|;
block|}
name|about_info
operator|->
name|vendor
operator|=
name|hldev
operator|->
name|pci_config_space_bios
operator|.
name|vendor_id
expr_stmt|;
name|about_info
operator|->
name|device
operator|=
name|hldev
operator|->
name|pci_config_space_bios
operator|.
name|device_id
expr_stmt|;
name|about_info
operator|->
name|subsys_vendor
operator|=
name|hldev
operator|->
name|pci_config_space_bios
operator|.
name|subsystem_vendor_id
expr_stmt|;
name|about_info
operator|->
name|subsys_device
operator|=
name|hldev
operator|->
name|pci_config_space_bios
operator|.
name|subsystem_id
expr_stmt|;
name|about_info
operator|->
name|board_rev
operator|=
name|hldev
operator|->
name|pci_config_space_bios
operator|.
name|revision
expr_stmt|;
name|vxge_os_strlcpy
argument_list|(
name|about_info
operator|->
name|vendor_name
argument_list|,
name|VXGE_DRIVER_VENDOR
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|vendor_name
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_os_strlcpy
argument_list|(
name|about_info
operator|->
name|chip_name
argument_list|,
name|VXGE_CHIP_FAMILY
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|chip_name
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_os_strlcpy
argument_list|(
name|about_info
operator|->
name|media
argument_list|,
name|VXGE_SUPPORTED_MEDIA_0
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|media
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|hal_major
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|hal_major
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|VXGE_HAL_VERSION_MAJOR
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|hal_minor
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|hal_minor
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|VXGE_HAL_VERSION_MINOR
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|hal_fix
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|hal_fix
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|VXGE_HAL_VERSION_FIX
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|hal_build
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|hal_build
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|VXGE_HAL_VERSION_BUILD
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|ll_major
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|ll_major
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|XGELL_VERSION_MAJOR
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|ll_minor
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|ll_minor
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|XGELL_VERSION_MINOR
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|ll_fix
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|ll_fix
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|XGELL_VERSION_FIX
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vxge_os_snprintf
argument_list|(
name|about_info
operator|->
name|ll_build
argument_list|,
sizeof|sizeof
argument_list|(
name|about_info
operator|->
name|ll_build
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|XGELL_VERSION_BUILD
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_mgmt_about_info_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_pci_config - Retrieve PCI configuration.  * @devh: HAL device handle.  * @buffer: Buffer to return pci config.  * @size: Pointer to buffer containing the Size of the @buffer.  * HAL will return an error if the size is smaller than  * sizeof(vxge_hal_pci_config_t) and returns required size in this field  *  * Get PCI configuration. Permits to retrieve at run-time configuration  * values that were used to configure the device at load-time.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_VERSION_CONFLICT - Version it not matching.  * VXGE_HAL_ERR_OUT_OF_SPACE - If the buffer is not sufficient  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_pci_config
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u8
modifier|*
name|buffer
parameter_list|,
name|u32
modifier|*
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_hal_pci_config_t
modifier|*
name|pci_config
init|=
operator|(
name|vxge_hal_pci_config_t
operator|*
operator|)
name|buffer
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|buffer
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|size
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"buffer = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"size = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|buffer
argument_list|,
operator|(
name|ptr_t
operator|)
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_pci_config_t
argument_list|)
condition|)
block|{
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_pci_config_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_SPACE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_SPACE
operator|)
return|;
block|}
comment|/* refresh PCI config space */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXGE_HAL_PCI_CONFIG_SPACE_SIZE
operator|/
literal|4
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|i
operator|*
literal|4
argument_list|,
literal|4
argument_list|,
operator|(
name|u32
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|&
name|hldev
operator|->
name|pci_config_space
operator|)
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
name|vxge_os_memcpy
argument_list|(
name|pci_config
argument_list|,
operator|&
name|hldev
operator|->
name|pci_config_space
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_pci_config_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_pci_config_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_msi_capabilities_get - Returns the msi capabilities  * @devh: HAL device handle.  * @msi_cap: MSI Capabilities  *  * Return the msi capabilities  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_msi_capabilities_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_msi_cap_t
modifier|*
name|msi_cap
parameter_list|)
block|{
name|u16
name|msi_control_reg
decl_stmt|;
name|u32
name|addr32
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|msi_cap
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", msi_cap = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|msi_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|==
literal|0
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|msi_cap
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mgmt_msi_cap_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|msi_control
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|msi_control_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_ENABLE
condition|)
name|msi_cap
operator|->
name|enable
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_PVMASK
condition|)
name|msi_cap
operator|->
name|is_pvm_capable
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_64BIT
condition|)
name|msi_cap
operator|->
name|is_64bit_addr_capable
operator|=
literal|1
expr_stmt|;
name|msi_cap
operator|->
name|vectors_allocated
operator|=
operator|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_QSIZE
operator|)
operator|>>
literal|4
expr_stmt|;
name|msi_cap
operator|->
name|max_vectors_capable
operator|=
operator|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_QMASK
operator|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|msi_cap
operator|->
name|is_64bit_addr_capable
condition|)
block|{
if|if
condition|(
name|msi_cap
operator|->
name|is_pvm_capable
condition|)
block|{
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_addr_hi
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|addr32
argument_list|)
expr_stmt|;
name|msi_cap
operator|->
name|address
operator|=
operator|(
operator|(
name|u64
operator|)
name|addr32
operator|)
operator|<<
literal|32
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_addr_lo
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|addr32
argument_list|)
expr_stmt|;
name|msi_cap
operator|->
name|address
operator||=
operator|(
name|u64
operator|)
name|addr32
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_mask
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|msi_cap
operator|->
name|mask_bits
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_pending
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|msi_cap
operator|->
name|pending_bits
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_no_pvm
operator|.
name|msi_addr_hi
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|addr32
argument_list|)
expr_stmt|;
name|msi_cap
operator|->
name|address
operator|=
operator|(
operator|(
name|u64
operator|)
name|addr32
operator|)
operator|<<
literal|32
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_no_pvm
operator|.
name|msi_addr_lo
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|addr32
argument_list|)
expr_stmt|;
name|msi_cap
operator|->
name|address
operator||=
operator|(
name|u64
operator|)
name|addr32
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_no_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|msi_cap
operator|->
name|is_pvm_capable
condition|)
block|{
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_addr
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|addr32
argument_list|)
expr_stmt|;
name|msi_cap
operator|->
name|address
operator|=
operator|(
name|u64
operator|)
name|addr32
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_mask
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|msi_cap
operator|->
name|mask_bits
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_pending
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|msi_cap
operator|->
name|pending_bits
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_no_pvm
operator|.
name|msi_addr
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|addr32
argument_list|)
expr_stmt|;
name|msi_cap
operator|->
name|address
operator|=
operator|(
name|u64
operator|)
name|addr32
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_no_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_msi_capabilities_set - Sets the msi capabilities  * @devh: HAL device handle.  * @msi_cap: MSI Capabilities  *  * Sets the msi capabilities  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_msi_capabilities_set
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_msi_cap_t
modifier|*
name|msi_cap
parameter_list|)
block|{
name|u16
name|msi_control_reg
decl_stmt|;
name|u32
name|addr32
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|msi_cap
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|","
literal|"msi_cap = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|msi_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|==
literal|0
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|msi_control
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|msi_control_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|msi_cap
operator|->
name|enable
condition|)
name|msi_control_reg
operator||=
name|VXGE_HAL_PCI_MSI_FLAGS_ENABLE
expr_stmt|;
else|else
name|msi_control_reg
operator|&=
operator|~
name|VXGE_HAL_PCI_MSI_FLAGS_ENABLE
expr_stmt|;
if|if
condition|(
name|msi_cap
operator|->
name|vectors_allocated
operator|>
call|(
name|u32
call|)
argument_list|(
operator|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_QMASK
operator|)
operator|>>
literal|1
argument_list|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|msi_control_reg
operator|&=
operator|~
name|VXGE_HAL_PCI_MSI_FLAGS_QSIZE
expr_stmt|;
name|msi_control_reg
operator||=
operator|(
name|msi_cap
operator|->
name|vectors_allocated
operator|&
literal|0x7
operator|)
operator|<<
literal|4
expr_stmt|;
if|if
condition|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_64BIT
condition|)
block|{
if|if
condition|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_PVMASK
condition|)
block|{
name|addr32
operator|=
call|(
name|u32
call|)
argument_list|(
name|msi_cap
operator|->
name|address
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_addr_hi
argument_list|)
argument_list|,
name|addr32
argument_list|)
expr_stmt|;
name|addr32
operator|=
operator|(
name|u32
operator|)
name|msi_cap
operator|->
name|address
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_addr_lo
argument_list|)
argument_list|,
name|addr32
argument_list|)
expr_stmt|;
name|vxge_os_pci_write16
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_mask
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|mask_bits
argument_list|)
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_pvm
operator|.
name|msi_pending
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|pending_bits
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|addr32
operator|=
call|(
name|u32
call|)
argument_list|(
name|msi_cap
operator|->
name|address
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_no_pvm
operator|.
name|msi_addr_hi
argument_list|)
argument_list|,
name|addr32
argument_list|)
expr_stmt|;
name|addr32
operator|=
operator|(
name|u32
operator|)
name|msi_cap
operator|->
name|address
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_no_pvm
operator|.
name|msi_addr_lo
argument_list|)
argument_list|,
name|addr32
argument_list|)
expr_stmt|;
name|vxge_os_pci_write16
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma64_no_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|msi_control_reg
operator|&
name|VXGE_HAL_PCI_MSI_FLAGS_PVMASK
condition|)
block|{
name|addr32
operator|=
operator|(
name|u32
operator|)
name|msi_cap
operator|->
name|address
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_addr
argument_list|)
argument_list|,
name|addr32
argument_list|)
expr_stmt|;
name|vxge_os_pci_write16
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_mask
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|mask_bits
argument_list|)
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_pvm
operator|.
name|msi_pending
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|pending_bits
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|addr32
operator|=
operator|(
name|u32
operator|)
name|msi_cap
operator|->
name|address
expr_stmt|;
name|vxge_os_pci_write32
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_no_pvm
operator|.
name|msi_addr
argument_list|)
argument_list|,
name|addr32
argument_list|)
expr_stmt|;
name|vxge_os_pci_write16
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|au
operator|.
name|ma32_no_pvm
operator|.
name|msi_data
argument_list|)
argument_list|,
name|msi_cap
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_os_pci_write16
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|cfgh
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msi_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msi_capability_le_t
argument_list|,
name|msi_control
argument_list|)
argument_list|,
name|msi_control_reg
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_msix_capabilities_get - Returns the msix capabilities  * @devh: HAL device handle.  * @msix_cap: MSIX Capabilities  *  * Return the msix capabilities  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_msix_capabilities_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_msix_cap_t
modifier|*
name|msix_cap
parameter_list|)
block|{
name|u16
name|msix_control_reg
decl_stmt|;
name|u32
name|msix_offset
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|msix_cap
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", msix_cap = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|msix_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|pci_caps
operator|.
name|msix_cap_offset
operator|==
literal|0
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|msix_cap
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mgmt_msix_cap_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msix_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msix_capability_le_t
argument_list|,
name|msix_control
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|msix_control_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|msix_control_reg
operator|&
name|VXGE_HAL_PCI_MSIX_FLAGS_ENABLE
condition|)
name|msix_cap
operator|->
name|enable
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|msix_control_reg
operator|&
name|VXGE_HAL_PCI_MSIX_FLAGS_MASK
condition|)
name|msix_cap
operator|->
name|mask_all_vect
operator|=
literal|1
expr_stmt|;
name|msix_cap
operator|->
name|table_size
operator|=
operator|(
name|msix_control_reg
operator|&
name|VXGE_HAL_PCI_MSIX_FLAGS_TSIZE
operator|)
operator|+
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msix_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msix_capability_le_t
argument_list|,
name|table_offset
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|msix_offset
argument_list|)
expr_stmt|;
name|msix_cap
operator|->
name|table_offset
operator|=
operator|(
name|msix_offset
operator|&
name|VXGE_HAL_PCI_MSIX_TABLE_OFFSET
operator|)
operator|>>
literal|3
expr_stmt|;
name|msix_cap
operator|->
name|table_bir
operator|=
name|msix_offset
operator|&
name|VXGE_HAL_PCI_MSIX_TABLE_BIR
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|msix_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_msix_capability_le_t
argument_list|,
name|pba_offset
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|msix_offset
argument_list|)
expr_stmt|;
name|msix_cap
operator|->
name|pba_offset
operator|=
operator|(
name|msix_offset
operator|&
name|VXGE_HAL_PCI_MSIX_PBA_OFFSET
operator|)
operator|>>
literal|3
expr_stmt|;
name|msix_cap
operator|->
name|pba_bir
operator|=
name|msix_offset
operator|&
name|VXGE_HAL_PCI_MSIX_PBA_BIR
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_pm_capabilities_get - Returns the pm capabilities  * @devh: HAL device handle.  * @pm_cap: pm Capabilities  *  * Return the pm capabilities  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_pm_capabilities_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_pm_cap_t
modifier|*
name|pm_cap
parameter_list|)
block|{
name|u16
name|pm_cap_reg
decl_stmt|;
name|u16
name|pm_control_reg
decl_stmt|;
name|u8
name|pm_ppb_ext
decl_stmt|;
name|u8
name|pm_data_reg
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|pm_cap
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"pm_cap = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|pm_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|pci_caps
operator|.
name|pm_cap_offset
operator|==
literal|0
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|pm_cap
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mgmt_pm_cap_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|pm_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_pm_capability_le_t
argument_list|,
name|capabilities_reg
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|pm_cap_reg
argument_list|)
expr_stmt|;
name|pm_cap
operator|->
name|pm_cap_ver
operator|=
call|(
name|u32
call|)
argument_list|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_VER_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_PME_CLOCK
condition|)
name|pm_cap
operator|->
name|pm_cap_pme_clock
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_AUX_POWER
condition|)
name|pm_cap
operator|->
name|pm_cap_aux_power
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_DSI
condition|)
name|pm_cap
operator|->
name|pm_cap_dsi
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_AUX_CURRENT
condition|)
name|pm_cap
operator|->
name|pm_cap_aux_current
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_D1
condition|)
name|pm_cap
operator|->
name|pm_cap_cap_d0
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_D2
condition|)
name|pm_cap
operator|->
name|pm_cap_cap_d1
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_PME_D0
condition|)
name|pm_cap
operator|->
name|pm_cap_pme_d0
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_PME_D1
condition|)
name|pm_cap
operator|->
name|pm_cap_pme_d1
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_PME_D2
condition|)
name|pm_cap
operator|->
name|pm_cap_pme_d2
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_PME_D3_HOT
condition|)
name|pm_cap
operator|->
name|pm_cap_pme_d3_hot
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CAP_PME_D3_COLD
condition|)
name|pm_cap
operator|->
name|pm_cap_pme_d3_cold
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|pm_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_pm_capability_le_t
argument_list|,
name|pm_ctrl
argument_list|)
argument_list|,
literal|2
argument_list|,
operator|&
name|pm_control_reg
argument_list|)
expr_stmt|;
name|pm_cap
operator|->
name|pm_ctrl_state
operator|=
name|pm_control_reg
operator|&
name|VXGE_HAL_PCI_PM_CTRL_STATE_MASK
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CTRL_NO_SOFT_RESET
condition|)
name|pm_cap
operator|->
name|pm_ctrl_no_soft_reset
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CTRL_PME_ENABLE
condition|)
name|pm_cap
operator|->
name|pm_ctrl_pme_enable
operator|=
literal|1
expr_stmt|;
name|pm_cap
operator|->
name|pm_ctrl_pme_data_sel
operator|=
call|(
name|u32
call|)
argument_list|(
name|pm_control_reg
operator|&
name|VXGE_HAL_PCI_PM_CTRL_DATA_SEL_MASK
argument_list|)
operator|>>
literal|10
expr_stmt|;
name|pm_cap
operator|->
name|pm_ctrl_pme_data_scale
operator|=
call|(
name|u32
call|)
argument_list|(
name|pm_control_reg
operator|&
name|VXGE_HAL_PCI_PM_CTRL_DATA_SCALE_MASK
argument_list|)
operator|>>
literal|13
expr_stmt|;
if|if
condition|(
name|pm_cap_reg
operator|&
name|VXGE_HAL_PCI_PM_CTRL_PME_STATUS
condition|)
name|pm_cap
operator|->
name|pm_ctrl_pme_status
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|pm_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_pm_capability_le_t
argument_list|,
name|pm_ctrl
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|pm_ppb_ext
argument_list|)
expr_stmt|;
if|if
condition|(
name|pm_ppb_ext
operator|&
name|VXGE_HAL_PCI_PM_PPB_B2_B3
condition|)
name|pm_cap
operator|->
name|pm_ppb_ext_b2_b3
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pm_ppb_ext
operator|&
name|VXGE_HAL_PCI_PM_BPCC_ENABLE
condition|)
name|pm_cap
operator|->
name|pm_ppb_ext_ecc_en
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|pm_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_pm_capability_le_t
argument_list|,
name|pm_data_reg
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|pm_data_reg
argument_list|)
expr_stmt|;
name|pm_cap
operator|->
name|pm_data_reg
operator|=
operator|(
name|u32
operator|)
name|pm_data_reg
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_sid_capabilities_get - Returns the sid capabilities  * @devh: HAL device handle.  * @sid_cap: Slot Id Capabilities  *  * Return the Slot Id capabilities  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_sid_capabilities_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_sid_cap_t
modifier|*
name|sid_cap
parameter_list|)
block|{
name|u8
name|chasis_num_reg
decl_stmt|;
name|u8
name|slot_num_reg
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sid_cap
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|", sid_cap = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|sid_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|pci_caps
operator|.
name|sid_cap_offset
operator|==
literal|0
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|sid_cap
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mgmt_sid_cap_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|sid_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_sid_capability_le_t
argument_list|,
name|sid_esr
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|slot_num_reg
argument_list|)
expr_stmt|;
name|sid_cap
operator|->
name|sid_number_of_slots
operator|=
call|(
name|u32
call|)
argument_list|(
name|slot_num_reg
operator|&
name|VXGE_HAL_PCI_SID_ESR_NSLOTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot_num_reg
operator|&
name|VXGE_HAL_PCI_SID_ESR_FIC
condition|)
name|sid_cap
operator|->
name|sid_number_of_slots
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_caps
operator|.
name|sid_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_sid_capability_le_t
argument_list|,
name|sid_chasis_nr
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|chasis_num_reg
argument_list|)
expr_stmt|;
name|sid_cap
operator|->
name|sid_chasis_number
operator|=
operator|(
name|u32
operator|)
name|chasis_num_reg
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_pci_err_capabilities_get - Returns the pci error capabilities  * @devh: HAL device handle.  * @err_cap: PCI-E Extended Error Capabilities  *  * Return the PCI-E Extended Error capabilities  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_pci_err_capabilities_get
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_pci_err_cap_t
modifier|*
name|err_cap
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|hldev
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|err_cap
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"hldev = 0x"
name|VXGE_OS_STXFMT
literal|",sid_cap = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|hldev
argument_list|,
operator|(
name|ptr_t
operator|)
name|err_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|==
literal|0
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|err_cap
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_pci_err_cap_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_header
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_header
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_uncor_status
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_uncor_status
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_uncor_mask
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_uncor_mask
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_uncor_server
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_uncor_server
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_cor_status
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_cor_status
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_cap
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_cap
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|err_header_log
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|err_header_log
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_root_command
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_root_command
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_root_status
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_root_status
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_root_cor_src
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_root_cor_src
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|hldev
operator|->
name|pci_e_ext_caps
operator|.
name|err_cap_offset
operator|+
name|vxge_offsetof
argument_list|(
name|vxge_hal_err_capability_t
argument_list|,
name|pci_err_root_src
argument_list|)
argument_list|,
literal|4
argument_list|,
operator|&
name|err_cap
operator|->
name|pci_err_root_src
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_driver_config - Retrieve driver configuration.  * @drv_config: Device configuration, see vxge_hal_driver_config_t {}.  * @size: Pointer to buffer containing the Size of the @drv_config.  * HAL will return an error if the size is smaller than  * sizeof(vxge_hal_driver_config_t) and returns required size in this field  *  * Get driver configuration. Permits to retrieve at run-time configuration  * values that were used to configure the device at load-time.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_DRIVER_NOT_INITIALIZED - HAL is not initialized.  * VXGE_HAL_ERR_VERSION_CONFLICT - Version is not matching.  * VXGE_HAL_ERR_OUT_OF_SPACE - If the buffer is not sufficient  *  * See also: vxge_hal_driver_config_t {}, vxge_hal_mgmt_device_config().  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_driver_config
parameter_list|(
name|vxge_hal_driver_config_t
modifier|*
name|drv_config
parameter_list|,
name|u32
modifier|*
name|size
parameter_list|)
block|{
name|vxge_assert
argument_list|(
operator|(
name|drv_config
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|size
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"drv_config = 0x"
name|VXGE_OS_STXFMT
literal|", size = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|drv_config
argument_list|,
operator|(
name|ptr_t
operator|)
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|g_vxge_hal_driver
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_DRIVER_NOT_INITIALIZED
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_DRIVER_NOT_INITIALIZED
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_driver_config_t
argument_list|)
condition|)
block|{
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_driver_config_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_SPACE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_SPACE
operator|)
return|;
block|}
name|vxge_os_memcpy
argument_list|(
name|drv_config
argument_list|,
operator|&
name|g_vxge_hal_driver
operator|->
name|config
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_driver_config_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_driver_config_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_driver
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_device_config - Retrieve device configuration.  * @devh: HAL device handle.  * @dev_config: Device configuration, see vxge_hal_device_config_t {}.  * @size: Pointer to buffer containing the Size of the @dev_config.  * HAL will return an error if the size is smaller than  * sizeof(vxge_hal_device_config_t) and returns required size in this field  *  * Get device configuration. Permits to retrieve at run-time configuration  * values that were used to initialize and configure the device.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_VERSION_CONFLICT - Version it not matching.  * VXGE_HAL_ERR_OUT_OF_SPACE - If the buffer is not sufficient  *  * See also: vxge_hal_device_config_t {}, vxge_hal_mgmt_driver_config().  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_device_config
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_device_config_t
modifier|*
name|dev_config
parameter_list|,
name|u32
modifier|*
name|size
parameter_list|)
block|{
name|vxge_hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|vxge_hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|devh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|dev_config
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|size
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", dev_config = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"size = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
operator|(
name|ptr_t
operator|)
name|dev_config
argument_list|,
operator|(
name|ptr_t
operator|)
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_device_config_t
argument_list|)
condition|)
block|{
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_device_config_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_SPACE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_SPACE
operator|)
return|;
block|}
name|vxge_os_memcpy
argument_list|(
name|dev_config
argument_list|,
operator|&
name|hldev
operator|->
name|config
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_device_config_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_device_config_t
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_pcireg_read - Read PCI configuration at a specified  * offset.  * @devh: HAL device handle.  * @offset: Offset in the 256 byte PCI configuration space.  * @value_bits: 8, 16, or 32 (bits) to read.  * @value: Value returned by HAL.  *  * Read PCI configuration, given device and offset in the PCI space.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_INVALID_OFFSET - Register offset in the BAR space is not  * valid.  * VXGE_HAL_ERR_INVALID_VALUE_BIT_SIZE - Invalid bits size. Valid  * values(8/16/32).  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_pcireg_read
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|unsigned
name|int
name|offset
parameter_list|,
name|int
name|value_bits
parameter_list|,
name|u32
modifier|*
name|value
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|devh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|value
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", offset = %d, value_bits = %d, "
literal|"value = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|offset
argument_list|,
name|value_bits
argument_list|,
operator|(
name|ptr_t
operator|)
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_pci_config_t
argument_list|)
operator|-
name|value_bits
operator|/
literal|8
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_OFFSET
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|__hal_vpath_pci_read
argument_list|(
name|hldev
argument_list|,
name|hldev
operator|->
name|first_vp_id
argument_list|,
name|offset
argument_list|,
name|value_bits
operator|/
literal|8
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_reg_read - Read X3100 register.  * @devh: HAL device handle.  * @type: Register types as defined in enum vxge_hal_mgmt_reg_type_e {}  * @Index: For pcicfgmgmt, srpcim, vpmgmt, vpath this gives the Index  *		ignored for others  * @offset: Register offset in the register space qualified by the type and  *		index.  * @value: Register value. Returned by HAL.  * Read X3100 register.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_INVALID_TYPE - Type is not valid.  * VXGE_HAL_ERR_INVALID_INDEX - Index is not valid.  * VXGE_HAL_ERR_INVALID_OFFSET - Register offset in the space is not valid.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_reg_read
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_reg_type_e
name|type
parameter_list|,
name|u32
name|vp_id
parameter_list|,
name|u32
name|offset
parameter_list|,
name|u64
modifier|*
name|value
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|devh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|value
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", type = %d, "
literal|"vp_id = %d, offset = %d, value = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|type
argument_list|,
name|vp_id
argument_list|,
name|offset
argument_list|,
operator|(
name|ptr_t
operator|)
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|vxge_hal_mgmt_reg_type_legacy
case|:
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_legacy_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|legacy_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_toc
case|:
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_toc_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|toc_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_common
case|:
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_common_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|common_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_memrepair
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_memrepair_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|memrepair_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_pcicfgmgmt
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_PCICFGMGMT_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_pcicfgmgmt_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|pcicfgmgmt_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_mrpcim
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_mrpcim_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|mrpcim_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_srpcim
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_SRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_SRPCIM_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_srpcim_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|srpcim_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpmgmt
case|:
if|if
condition|(
operator|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPMGMT_REG_SPACES
operator|-
literal|1
operator|)
operator|||
operator|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|vp_id
argument_list|)
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_vpmgmt_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpath
case|:
if|if
condition|(
operator|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPATH_REG_SPACES
operator|-
literal|1
operator|)
operator|||
operator|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|vp_id
argument_list|)
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPATH_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpath_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_TYPE
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_reg_Write - Write X3100 register.  * @devh: HAL device handle.  * @type: Register types as defined in enum vxge_hal_mgmt_reg_type_e {}  * @index: For pcicfgmgmt, srpcim, vpmgmt, vpath this gives the Index  *		ignored for others  * @offset: Register offset in the register space qualified by the type and  *		index.  * @value: Register value to be written.  * Write X3100 register.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_INVALID_TYPE - Type is not valid.  * VXGE_HAL_ERR_INVALID_INDEX - Index is not valid.  * VXGE_HAL_ERR_INVALID_OFFSET - Register offset in the space is not valid.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_reg_write
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_reg_type_e
name|type
parameter_list|,
name|u32
name|vp_id
parameter_list|,
name|u32
name|offset
parameter_list|,
name|u64
name|value
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", type = %d, "
literal|"index = %d, offset = %d, value = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|type
argument_list|,
name|vp_id
argument_list|,
name|offset
argument_list|,
operator|(
name|ptr_t
operator|)
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|vxge_hal_mgmt_reg_type_legacy
case|:
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_legacy_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|legacy_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_toc
case|:
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_toc_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|toc_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_common
case|:
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_common_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|common_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_memrepair
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_memrepair_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|memrepair_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_pcicfgmgmt
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_PCICFGMGMT_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_pcicfgmgmt_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|pcicfgmgmt_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_mrpcim
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_mrpcim_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|mrpcim_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_srpcim
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_SRPCIM_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_srpcim_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|srpcim_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpmgmt
case|:
if|if
condition|(
operator|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPMGMT_REG_SPACES
operator|-
literal|1
operator|)
operator|||
operator|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|vp_id
argument_list|)
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_vpmgmt_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpath
case|:
if|if
condition|(
operator|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPATH_REG_SPACES
operator|-
literal|1
operator|)
operator|||
operator|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|vp_id
argument_list|)
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|offset
operator|>
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
operator|-
literal|8
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_OFFSET
expr_stmt|;
break|break;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpath_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_TYPE
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_bar0_read - Read X3100 register located at the offset  *                           from bar0.  * @devh: HAL device handle.  * @offset: Register offset from bar0  * @value: Register value. Returned by HAL.  * Read X3100 register.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_INVALID_OFFSET - Register offset in the space is not valid.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_bar0_read
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|offset
parameter_list|,
name|u64
modifier|*
name|value
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", offset = %d, value = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|offset
argument_list|,
operator|(
name|ptr_t
operator|)
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|offset
operator|)
operator|>
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpath_reg
index|[
name|VXGE_HAL_MAX_VIRTUAL_PATHS
operator|-
literal|1
index|]
operator|+
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
operator|-
literal|8
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_OFFSET
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_OFFSET
operator|)
return|;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_bar1_read - Read X3100 register located at the offset  *                           from bar1.  * @devh: HAL device handle.  * @offset: Register offset from bar1  * @value: Register value. Returned by HAL.  * Read X3100 register.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_bar1_read
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|offset
parameter_list|,
name|u64
modifier|*
name|value
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", offset = %d, value = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|offset
argument_list|,
operator|(
name|ptr_t
operator|)
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
operator|*
name|value
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|header
operator|.
name|bar1
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_bar0_Write - Write X3100 register located at the offset  *			    from bar0.  * @devh: HAL device handle.  * @offset: Register offset from bar0  * @value: Register value to be written.  * Write X3100 register.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_INVALID_OFFSET - Register offset in the space is not valid.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_bar0_write
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|offset
parameter_list|,
name|u64
name|value
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", offset = %d, value = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|offset
argument_list|,
operator|(
name|ptr_t
operator|)
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|+
name|offset
operator|)
operator|>
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpath_reg
index|[
name|VXGE_HAL_MAX_VIRTUAL_PATHS
operator|-
literal|1
index|]
operator|+
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
operator|-
literal|8
operator|)
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_OFFSET
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_OFFSET
operator|)
return|;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|value
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|header
operator|.
name|bar0
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_register_config - Retrieve register configuration.  * @devh: HAL device handle.  * @type: Register types as defined in enum vxge_hal_mgmt_reg_type_e {}  * @Index: For pcicfgmgmt, srpcim, vpmgmt, vpath this gives the Index  *		ignored for others  * @config: Device configuration, see vxge_hal_device_config_t {}.  * @size: Pointer to buffer containing the Size of the @reg_config.  * HAL will return an error if the size is smaller than  * requested register space and returns required size in this field  *  * Get register configuration. Permits to retrieve register values.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_ERR_INVALID_DEVICE - Device is not valid.  * VXGE_HAL_ERR_INVALID_TYPE - Type is not valid.  * VXGE_HAL_ERR_INVALID_INDEX - Index is not valid.  * VXGE_HAL_ERR_OUT_OF_SPACE - If the buffer is not sufficient  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_register_config
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|vxge_hal_mgmt_reg_type_e
name|type
parameter_list|,
name|u32
name|vp_id
parameter_list|,
name|u8
modifier|*
name|config
parameter_list|,
name|u32
modifier|*
name|size
parameter_list|)
block|{
name|u32
name|offset
decl_stmt|;
name|u64
modifier|*
name|reg_config
init|=
operator|(
name|u64
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
name|config
operator|)
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|devh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|reg_config
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|size
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_device
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", type = %d, index = %d, "
literal|"reg_config = 0x"
name|VXGE_OS_STXFMT
literal|", size = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|type
argument_list|,
name|vp_id
argument_list|,
operator|(
name|ptr_t
operator|)
name|reg_config
argument_list|,
operator|(
name|ptr_t
operator|)
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|vxge_hal_mgmt_reg_type_legacy
case|:
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_legacy_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_legacy_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_legacy_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|legacy_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_legacy_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_toc
case|:
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_toc_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_toc_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_toc_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|toc_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_toc_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_common
case|:
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_common_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_common_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_common_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|common_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_common_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_memrepair
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_memrepair_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_memrepair_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_memrepair_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|memrepair_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_memrepair_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_pcicfgmgmt
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_PCICFGMGMT_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_pcicfgmgmt_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_pcicfgmgmt_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_pcicfgmgmt_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|pcicfgmgmt_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_pcicfgmgmt_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_mrpcim
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_mrpcim_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_mrpcim_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_mrpcim_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|mrpcim_reg
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_mrpcim_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_srpcim
case|:
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_SRPCIM
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_SRPCIM_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_srpcim_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_srpcim_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_srpcim_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|srpcim_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_srpcim_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpmgmt
case|:
if|if
condition|(
operator|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPMGMT_REG_SPACES
operator|-
literal|1
operator|)
operator|||
operator|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|vp_id
argument_list|)
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_vpmgmt_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_vpmgmt_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_vpmgmt_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpmgmt_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_vpmgmt_reg_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|vxge_hal_mgmt_reg_type_vpath
case|:
if|if
condition|(
operator|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPATH_REG_SPACES
operator|-
literal|1
operator|)
operator|||
operator|(
operator|!
operator|(
name|hldev
operator|->
name|vpath_assignments
operator|&
name|mBIT
argument_list|(
name|vp_id
argument_list|)
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vp_id
operator|>
name|VXGE_HAL_TITAN_VPATH_REG_SPACES
operator|-
literal|1
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_INDEX
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|size
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_ERR_OUT_OF_SPACE
expr_stmt|;
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
condition|;
name|offset
operator|+=
literal|8
control|)
block|{
operator|*
name|reg_config
operator|++
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|ptr_t
operator|)
name|hldev
operator|->
name|vpath_reg
index|[
name|vp_id
index|]
operator|)
operator|+
name|offset
operator|)
argument_list|)
expr_stmt|;
block|}
operator|*
name|size
operator|=
sizeof|sizeof
argument_list|(
name|vxge_hal_vpath_reg_t
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|VXGE_HAL_ERR_INVALID_TYPE
expr_stmt|;
break|break;
block|}
name|vxge_hal_trace_log_device
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_read_xfp_current_temp - Read current temparature of given port  * @hldev: HAL device handle.  * @port: Port number  *  * This routine only gets the temperature for XFP modules. Also, updating of the  * NVRAM can sometimes fail and so the reading we might get may not be uptodate.  */
end_comment

begin_function
name|u32
name|vxge_hal_mgmt_read_xfp_current_temp
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|port
parameter_list|)
block|{
name|u16
name|val1
decl_stmt|,
name|val2
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|u32
name|actual
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", port = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
operator|)
return|;
block|}
name|val1
operator|=
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_CONTROL_256_BYTES
expr_stmt|;
name|status
operator|=
name|__hal_mrpcim_mdio_access
argument_list|(
name|devh
argument_list|,
name|port
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_OP_TYPE_ADDR_WRITE
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_DEVAD_PMA_PMD
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_CONTROL
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* Now wait for the transfer to complete */
do|do
block|{
name|vxge_os_mdelay
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* wait 50 milliseonds */
name|status
operator|=
name|__hal_mrpcim_mdio_access
argument_list|(
name|devh
argument_list|,
name|port
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_OP_TYPE_ADDR_READ
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_DEVAD_PMA_PMD
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_CONTROL
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
name|count
operator|++
operator|>
literal|10
condition|)
block|{
comment|/* waited 500 ms which should be plenty of time */
break|break;
block|}
block|}
do|while
condition|(
operator|(
name|val1
operator|&
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_CONTROL_STAT_MASK
operator|)
operator|==
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_CONTROL_PROGRESS
condition|)
do|;
if|if
condition|(
operator|(
name|val1
operator|&
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_CONTROL_STAT_MASK
operator|)
operator|==
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_CONTROL_FAILED
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|status
operator|=
name|__hal_mrpcim_mdio_access
argument_list|(
name|devh
argument_list|,
name|port
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_OP_TYPE_ADDR_READ
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_DEVAD_PMA_PMD
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_DATA_XFP_TEMP_1
argument_list|,
operator|&
name|val1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|status
operator|=
name|__hal_mrpcim_mdio_access
argument_list|(
name|devh
argument_list|,
name|port
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_OP_TYPE_ADDR_READ
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_DEVAD_PMA_PMD
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_EEPROM_NVR_DATA_XFP_TEMP_2
argument_list|,
operator|&
name|val2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|actual
operator|=
operator|(
operator|(
name|val1
operator|<<
literal|8
operator|)
operator||
name|val2
operator|)
expr_stmt|;
if|if
condition|(
name|actual
operator|>=
literal|32768
condition|)
name|actual
operator|=
name|actual
operator|-
literal|65536
expr_stmt|;
name|actual
operator|=
name|actual
operator|/
literal|256
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|actual
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_pma_loopback - Enable or disable PMA loopback  * @devh: HAL device handle.  * @port: Port number  * @enable:Boolean set to 1 to enable and 0 to disable.  *  * Enable or disable PMA loopback.  * Return value:  * 0 on success.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_pma_loopback
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|port
parameter_list|,
name|u32
name|enable
parameter_list|)
block|{
name|u16
name|val
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", port = %d, enable = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|port
argument_list|,
name|enable
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
operator|)
return|;
block|}
name|status
operator|=
name|__hal_mrpcim_mdio_access
argument_list|(
name|devh
argument_list|,
name|port
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_OP_TYPE_ADDR_READ
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_DEVAD_PMA_PMD
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_PMA_CONTROL_1
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
if|if
condition|(
name|enable
condition|)
name|val
operator||=
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_PMA_CONTROL_1_LOOPBACK
expr_stmt|;
else|else
name|val
operator|&=
operator|~
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_PMA_CONTROL_1_LOOPBACK
expr_stmt|;
name|status
operator|=
name|__hal_mrpcim_mdio_access
argument_list|(
name|devh
argument_list|,
name|port
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_OP_TYPE_ADDR_WRITE
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_DEVAD_PMA_PMD
argument_list|,
name|VXGE_HAL_MDIO_MGR_ACCESS_PORT_ADDR_PMA_CONTROL_1
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mgmt_xgmii_loopback - Enable or disable xgmii loopback  * @devh: HAL device handle.  * @port: Port number  * @enable:Boolean set to 1 to enable and 0 to disable.  *  * Enable or disable xgmii loopback.  * Return value:  * 0 on success.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_mgmt_xgmii_loopback
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|port
parameter_list|,
name|u32
name|enable
parameter_list|)
block|{
name|u64
name|val64
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", port = %d, enable = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|port
argument_list|,
name|enable
argument_list|)
expr_stmt|;
if|if
condition|(
name|hldev
operator|->
name|header
operator|.
name|magic
operator|!=
name|VXGE_HAL_DEVICE_MAGIC
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_DEVICE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_DEVICE
operator|)
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|hldev
operator|->
name|access_rights
operator|&
name|VXGE_HAL_DEVICE_ACCESS_RIGHT_MRPCIM
operator|)
condition|)
block|{
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_PRIVILAGED_OPEARATION
operator|)
return|;
block|}
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|hldev
operator|->
name|mrpcim_reg
operator|->
name|xmac_cfg_port
index|[
name|port
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|val64
operator||=
name|VXGE_HAL_XMAC_CFG_PORT_XGMII_LOOPBACK
expr_stmt|;
else|else
name|val64
operator|&=
operator|~
name|VXGE_HAL_XMAC_CFG_PORT_XGMII_LOOPBACK
expr_stmt|;
name|vxge_os_pio_mem_write64
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|hldev
operator|->
name|mrpcim_reg
operator|->
name|xmac_cfg_port
index|[
name|port
index|]
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mrpcim
argument_list|(
literal|"<== %s:%s:%d Result = 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxgehal/vxgehal.h>
end_include

begin_comment
comment|/*  * __hal_fifo_mempool_item_alloc - Allocate List blocks for TxD list callback  * @mempoolh: Handle to memory pool  * @memblock: Address of this memory block  * @memblock_index: Index of this memory block  * @dma_object: dma object for this block  * @item: Pointer to this item  * @index: Index of this item in memory block  * @is_last: If this is last item in the block  * @userdata: Specific data of user  *  * This function is callback passed to __hal_mempool_create to create memory  * pool for TxD list  */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|__hal_fifo_mempool_item_alloc
parameter_list|(
name|vxge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|u32
name|memblock_index
parameter_list|,
name|vxge_hal_mempool_dma_t
modifier|*
name|dma_object
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|u32
name|item_index
parameter_list|,
name|u32
name|is_last
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|void
modifier|*
name|block_priv
decl_stmt|;
name|u32
name|memblock_item_idx
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|item
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|VXGE_COMPONENT_HAL_POOL
operator|&
name|VXGE_DEBUG_MODULE_MASK
operator|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
decl_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"mempoolh = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"memblock = 0x"
name|VXGE_OS_STXFMT
literal|", memblock_index = %d, "
literal|"dma_object = 0x"
name|VXGE_OS_STXFMT
literal|", \ 		    item = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"item_index = %d, is_last = %d, userdata = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempoolh
argument_list|,
operator|(
name|ptr_t
operator|)
name|memblock
argument_list|,
name|memblock_index
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_object
argument_list|,
operator|(
name|ptr_t
operator|)
name|item
argument_list|,
name|item_index
argument_list|,
name|is_last
argument_list|,
operator|(
name|ptr_t
operator|)
name|userdata
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|block_priv
operator|=
name|__hal_mempool_item_priv
argument_list|(
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_index
argument_list|,
name|item
argument_list|,
operator|&
name|memblock_item_idx
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|block_priv
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fifo
operator|->
name|txdl_per_memblock
condition|;
name|i
operator|++
control|)
block|{
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|int
name|dtr_index
init|=
name|item_index
operator|*
name|fifo
operator|->
name|txdl_per_memblock
operator|+
name|i
decl_stmt|;
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|item
operator|+
name|i
operator|*
name|fifo
operator|->
name|txdl_size
operator|)
operator|)
expr_stmt|;
name|txdp
operator|->
name|host_control
operator|=
name|dtr_index
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|dtr
operator|=
name|txdp
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|uld_priv
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|block_priv
operator|+
name|fifo
operator|->
name|txdl_priv_size
operator|*
name|i
operator|)
expr_stmt|;
name|fifo
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|hal_priv
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|uld_priv
operator|)
operator|+
name|fifo
operator|->
name|per_txdl_space
operator|)
expr_stmt|;
name|txdl_priv
operator|=
operator|(
name|__hal_fifo_txdl_priv_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|hal_priv
expr_stmt|;
name|vxge_assert
argument_list|(
name|txdl_priv
argument_list|)
expr_stmt|;
comment|/* pre-format HAL's TxDL's private */
comment|/* LINTED */
name|txdl_priv
operator|->
name|dma_offset
operator|=
operator|(
name|char
operator|*
operator|)
name|txdp
operator|-
operator|(
name|char
operator|*
operator|)
name|memblock
expr_stmt|;
name|txdl_priv
operator|->
name|dma_addr
operator|=
name|dma_object
operator|->
name|addr
operator|+
name|txdl_priv
operator|->
name|dma_offset
expr_stmt|;
name|txdl_priv
operator|->
name|dma_handle
operator|=
name|dma_object
operator|->
name|handle
expr_stmt|;
name|txdl_priv
operator|->
name|memblock
operator|=
name|memblock
expr_stmt|;
name|txdl_priv
operator|->
name|first_txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdp
expr_stmt|;
name|txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|dang_txdl
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|dang_frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|alloc_frags
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
name|txdl_priv
operator|->
name|dma_object
operator|=
name|dma_object
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_ALIGN_XMIT
argument_list|)
name|txdl_priv
operator|->
name|align_vaddr
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_addr
operator|=
operator|(
name|dma_addr_t
operator|)
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|VXGE_HAL_ALIGN_XMIT_ALLOC_RT
comment|/* CONSTCOND */
if|if
condition|(
name|TRUE
condition|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
if|if
condition|(
name|fifo
operator|->
name|config
operator|->
name|alignment_size
condition|)
block|{
name|status
operator|=
name|__hal_fifo_txdl_align_alloc_map
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
if|#
directive|if
operator|(
name|VXGE_COMPONENT_HAL_POOL
operator|&
name|VXGE_DEBUG_MODULE_MASK
operator|)
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_err_log_pool
argument_list|(
literal|"align buffer[%d] %d bytes, \ 					    status %d"
argument_list|,
operator|(
name|item_index
operator|*
name|fifo
operator|->
name|txdl_per_memblock
operator|+
name|i
operator|)
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
block|}
endif|#
directive|endif
endif|#
directive|endif
if|if
condition|(
name|fifo
operator|->
name|txdl_init
condition|)
block|{
name|fifo
operator|->
name|txdl_init
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|vph
argument_list|,
operator|(
name|vxge_hal_txdl_h
operator|)
name|txdp
argument_list|,
name|VXGE_HAL_FIFO_ULD_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
argument_list|,
name|VXGE_HAL_FIFO_TXDL_INDEX
argument_list|(
name|txdp
argument_list|)
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|userdata
argument_list|,
name|VXGE_HAL_OPEN_NORMAL
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
operator|(
name|VXGE_COMPONENT_HAL_POOL
operator|&
name|VXGE_DEBUG_MODULE_MASK
operator|)
block|{
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
decl_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_fifo_mempool_item_free - Free List blocks for TxD list callback  * @mempoolh: Handle to memory pool  * @memblock: Address of this memory block  * @memblock_index: Index of this memory block  * @dma_object: dma object for this block  * @item: Pointer to this item  * @index: Index of this item in memory block  * @is_last: If this is last item in the block  * @userdata: Specific data of user  *  * This function is callback passed to __hal_mempool_free to destroy memory  * pool for TxD list  */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|__hal_fifo_mempool_item_free
parameter_list|(
name|vxge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|u32
name|memblock_index
parameter_list|,
name|vxge_hal_mempool_dma_t
modifier|*
name|dma_object
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|u32
name|item_index
parameter_list|,
name|u32
name|is_last
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|vxge_assert
argument_list|(
name|item
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|VXGE_COMPONENT_HAL_POOL
operator|&
name|VXGE_DEBUG_MODULE_MASK
operator|)
block|{
name|__hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
decl_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"mempoolh = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"memblock = 0x"
name|VXGE_OS_STXFMT
literal|", memblock_index = %d, "
literal|"dma_object = 0x"
name|VXGE_OS_STXFMT
literal|", \ 		    item = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"item_index = %d, is_last = %d, userdata = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempoolh
argument_list|,
operator|(
name|ptr_t
operator|)
name|memblock
argument_list|,
name|memblock_index
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_object
argument_list|,
operator|(
name|ptr_t
operator|)
name|item
argument_list|,
name|item_index
argument_list|,
name|is_last
argument_list|,
operator|(
name|ptr_t
operator|)
name|userdata
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_ALIGN_XMIT
argument_list|)
block|{
name|__hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|config
operator|->
name|alignment_size
condition|)
block|{
name|int
name|i
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fifo
operator|->
name|txdl_per_memblock
condition|;
name|i
operator|++
control|)
block|{
name|txdp
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|item
operator|+
name|i
operator|*
name|fifo
operator|->
name|txdl_size
operator|)
expr_stmt|;
name|__hal_fifo_txdl_align_free_unmap
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
if|#
directive|if
operator|(
name|VXGE_COMPONENT_HAL_POOL
operator|&
name|VXGE_DEBUG_MODULE_MASK
operator|)
block|{
name|__hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|__hal_device_t
modifier|*
name|hldev
init|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
decl_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_fifo_create - Create a FIFO  * @vpath_handle: Handle returned by virtual path open  * @attr: FIFO configuration parameters structure  *  * This function creates FIFO and initializes it.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_fifo_create
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_fifo_attr_t
modifier|*
name|attr
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|vxge_hal_fifo_config_t
modifier|*
name|config
decl_stmt|;
name|u32
name|txdl_size
decl_stmt|,
name|memblock_size
decl_stmt|,
name|txdl_per_memblock
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|attr
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", attr = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vpath_handle
operator|==
name|NULL
operator|)
operator|||
operator|(
name|attr
operator|==
name|NULL
operator|)
condition|)
block|{
name|vxge_hal_err_log_fifo
argument_list|(
literal|"null pointer passed ==> %s : %d"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_HANDLE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_HANDLE
operator|)
return|;
block|}
name|config
operator|=
operator|&
name|vp
operator|->
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|vp_config
index|[
name|vp
operator|->
name|vpath
operator|->
name|vp_id
index|]
operator|.
name|fifo
expr_stmt|;
name|txdl_size
operator|=
name|config
operator|->
name|max_frags
operator|*
sizeof|sizeof
argument_list|(
name|vxge_hal_fifo_txd_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_size
operator|<=
name|VXGE_OS_HOST_PAGE_SIZE
condition|)
name|memblock_size
operator|=
name|VXGE_OS_HOST_PAGE_SIZE
expr_stmt|;
else|else
name|memblock_size
operator|=
name|txdl_size
expr_stmt|;
name|txdl_per_memblock
operator|=
name|memblock_size
operator|/
name|txdl_size
expr_stmt|;
name|config
operator|->
name|fifo_length
operator|=
operator|(
operator|(
name|config
operator|->
name|fifo_length
operator|+
name|txdl_per_memblock
operator|-
literal|1
operator|)
operator|/
name|txdl_per_memblock
operator|)
operator|*
name|txdl_per_memblock
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vxge_hal_channel_allocate
argument_list|(
operator|(
name|vxge_hal_device_h
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
argument_list|,
name|vpath_handle
argument_list|,
name|VXGE_HAL_CHANNEL_TYPE_FIFO
argument_list|,
name|config
operator|->
name|fifo_length
argument_list|,
name|attr
operator|->
name|per_txdl_space
argument_list|,
name|attr
operator|->
name|userdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_err_log_fifo
argument_list|(
literal|"Memory allocation failed ==> %s : %d"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|vp
operator|->
name|vpath
operator|->
name|fifoh
operator|=
name|fifo
expr_stmt|;
name|fifo
operator|->
name|stats
operator|=
operator|&
name|vp
operator|->
name|vpath
operator|->
name|sw_stats
operator|->
name|fifo_stats
expr_stmt|;
name|fifo
operator|->
name|config
operator|=
name|config
expr_stmt|;
name|fifo
operator|->
name|memblock_size
operator|=
name|memblock_size
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock_init
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|vp
operator|->
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_init_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|vp
operator|->
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|irqh
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fifo
operator|->
name|align_size
operator|=
name|fifo
operator|->
name|config
operator|->
name|alignment_size
operator|*
name|fifo
operator|->
name|config
operator|->
name|max_aligned_frags
expr_stmt|;
comment|/* apply "interrupts per txdl" attribute */
name|fifo
operator|->
name|interrupt_type
operator|=
name|VXGE_HAL_FIFO_TXD_INT_TYPE_UTILZ
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|config
operator|->
name|intr
condition|)
block|{
name|fifo
operator|->
name|interrupt_type
operator|=
name|VXGE_HAL_FIFO_TXD_INT_TYPE_PER_LIST
expr_stmt|;
block|}
name|fifo
operator|->
name|no_snoop_bits
operator|=
name|config
operator|->
name|no_snoop_bits
expr_stmt|;
comment|/* 	 * FIFO memory management strategy: 	 * 	 * TxDL splitted into three independent parts: 	 *	- set of TxD's 	 *	- TxD HAL private part 	 *	- upper layer private part 	 * 	 * Adaptative memory allocation used. i.e. Memory allocated on 	 * demand with the size which will fit into one memory block. 	 * One memory block may contain more than one TxDL. In simple case 	 * memory block size can be equal to CPU page size. On more 	 * sophisticated OS's memory block can be contiguous across 	 * several pages. 	 * 	 * During "reserve" operations more memory can be allocated on demand 	 * for example due to FIFO full condition. 	 * 	 * Pool of memory memblocks never shrinks except __hal_fifo_close 	 * routine which will essentially stop channel and free the resources. 	 */
comment|/* TxDL common private size == TxDL private + ULD private */
name|fifo
operator|->
name|txdl_priv_size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_fifo_txdl_priv_t
argument_list|)
operator|+
name|attr
operator|->
name|per_txdl_space
expr_stmt|;
name|fifo
operator|->
name|txdl_priv_size
operator|=
operator|(
operator|(
name|fifo
operator|->
name|txdl_priv_size
operator|+
name|__vxge_os_cacheline_size
operator|-
literal|1
operator|)
operator|/
name|__vxge_os_cacheline_size
operator|)
operator|*
name|__vxge_os_cacheline_size
expr_stmt|;
name|fifo
operator|->
name|per_txdl_space
operator|=
name|attr
operator|->
name|per_txdl_space
expr_stmt|;
comment|/* recompute txdl size to be cacheline aligned */
name|fifo
operator|->
name|txdl_size
operator|=
name|txdl_size
expr_stmt|;
name|fifo
operator|->
name|txdl_per_memblock
operator|=
name|txdl_per_memblock
expr_stmt|;
comment|/* 	 * since txdl_init() callback will be called from item_alloc(), 	 * the same way channels userdata might be used prior to 	 * channel_initialize() 	 */
name|fifo
operator|->
name|txdl_init
operator|=
name|attr
operator|->
name|txdl_init
expr_stmt|;
name|fifo
operator|->
name|txdl_term
operator|=
name|attr
operator|->
name|txdl_term
expr_stmt|;
name|fifo
operator|->
name|callback
operator|=
name|attr
operator|->
name|callback
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|txdl_per_memblock
operator|==
literal|0
condition|)
block|{
name|__hal_fifo_delete
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_BLOCK_SIZE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_BLOCK_SIZE
operator|)
return|;
block|}
comment|/* calculate actual TxDL block private size */
name|fifo
operator|->
name|txdlblock_priv_size
operator|=
name|fifo
operator|->
name|txdl_priv_size
operator|*
name|fifo
operator|->
name|txdl_per_memblock
expr_stmt|;
name|fifo
operator|->
name|mempool
operator|=
name|vxge_hal_mempool_create
argument_list|(
operator|(
name|vxge_hal_device_h
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
argument_list|,
name|fifo
operator|->
name|memblock_size
argument_list|,
name|fifo
operator|->
name|memblock_size
argument_list|,
name|fifo
operator|->
name|txdlblock_priv_size
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|fifo_length
operator|/
name|fifo
operator|->
name|txdl_per_memblock
argument_list|,
name|fifo
operator|->
name|config
operator|->
name|fifo_length
operator|/
name|fifo
operator|->
name|txdl_per_memblock
argument_list|,
name|__hal_fifo_mempool_item_alloc
argument_list|,
name|__hal_fifo_mempool_item_free
argument_list|,
name|fifo
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|mempool
operator|==
name|NULL
condition|)
block|{
name|__hal_fifo_delete
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|status
operator|=
name|vxge_hal_channel_initialize
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|__hal_fifo_delete
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_fifo_abort - Returns the TxD  * @fifoh: Fifo to be reset  * @reopen: See  vxge_hal_reopen_e {}.  *  * This function terminates the TxDs of fifo  */
end_comment

begin_function
name|void
name|__hal_fifo_abort
parameter_list|(
name|vxge_hal_fifo_h
name|fifoh
parameter_list|,
name|vxge_hal_reopen_e
name|reopen
parameter_list|)
block|{
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|fifoh
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_txdl_h
name|txdlh
decl_stmt|;
name|vxge_assert
argument_list|(
name|fifoh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"fifo = 0x"
name|VXGE_OS_STXFMT
literal|", reopen = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|fifoh
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|txdl_term
condition|)
block|{
name|__hal_channel_for_each_dtr
argument_list|(
argument|&fifo->channel
argument_list|,
argument|txdlh
argument_list|,
argument|i
argument_list|)
block|{
if|if
condition|(
operator|!
name|__hal_channel_is_posted_dtr
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|fifo
operator|->
name|txdl_term
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|vph
argument_list|,
name|txdlh
argument_list|,
name|VXGE_HAL_FIFO_ULD_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
argument_list|,
name|VXGE_HAL_TXDL_STATE_FREED
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|__hal_channel_dtr_try_complete
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
operator|&
name|txdlh
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdlh
operator|==
name|NULL
condition|)
break|break;
name|__hal_channel_dtr_complete
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|txdl_term
condition|)
block|{
name|fifo
operator|->
name|txdl_term
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|vph
argument_list|,
name|txdlh
argument_list|,
name|VXGE_HAL_FIFO_ULD_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
argument_list|,
name|VXGE_HAL_TXDL_STATE_POSTED
argument_list|,
name|fifo
operator|->
name|channel
operator|.
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
block|}
name|__hal_channel_dtr_free
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
name|VXGE_HAL_FIFO_TXDL_INDEX
argument_list|(
name|txdlh
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_fifo_reset - Resets the fifo  * @fifoh: Fifo to be reset  *  * This function resets the fifo during vpath reset operation  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_fifo_reset
parameter_list|(
name|vxge_hal_fifo_h
name|fifoh
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
init|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|fifoh
decl_stmt|;
name|vxge_assert
argument_list|(
name|fifoh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"fifo = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|fifoh
argument_list|)
expr_stmt|;
name|__hal_fifo_abort
argument_list|(
name|fifoh
argument_list|,
name|VXGE_HAL_RESET_ONLY
argument_list|)
expr_stmt|;
name|status
operator|=
name|__hal_channel_reset
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_doorbell_reset - Resets the doorbell fifo  * @vapth_handle: Vpath Handle  *  * This function resets the doorbell fifo during if fifo error occurs  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_fifo_doorbell_reset
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|vxge_hal_txdl_h
name|txdlh
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_virtualpath_t
modifier|*
name|vpath
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_OK
decl_stmt|;
name|vxge_assert
argument_list|(
name|vpath_handle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vpath
operator|=
operator|(
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|vph
operator|)
operator|->
name|vpath
expr_stmt|;
name|status
operator|=
name|__hal_non_offload_db_reset
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|vph
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|__hal_channel_for_each_posted_dtr
argument_list|(
argument|&fifo->channel
argument_list|,
argument|txdlh
argument_list|,
argument|i
argument_list|)
block|{
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|__hal_non_offload_db_post
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|vph
argument_list|,
operator|(
operator|(
name|VXGE_HAL_FIFO_TXD_NO_BW_LIMIT_GET
argument_list|(
operator|(
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
operator|)
operator|->
name|control_1
argument_list|)
operator|)
condition|?
operator|(
operator|(
operator|(
name|u64
operator|)
name|txdl_priv
operator|->
name|dma_addr
operator|)
operator||
literal|0x1
operator|)
else|:
operator|(
name|u64
operator|)
name|txdl_priv
operator|->
name|dma_addr
operator|)
argument_list|,
name|txdl_priv
operator|->
name|frags
operator|-
literal|1
argument_list|,
name|vpath
operator|->
name|vp_config
operator|->
name|fifo
operator|.
name|no_snoop_bits
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_fifo_delete - Removes the FIFO  * @vpath_handle: Virtual path handle to which this queue belongs  *  * This function freeup the memory pool and removes the FIFO  */
end_comment

begin_function
name|void
name|__hal_fifo_delete
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
name|vpath_handle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|mempool
condition|)
block|{
name|__hal_fifo_abort
argument_list|(
name|vp
operator|->
name|vpath
operator|->
name|fifoh
argument_list|,
name|VXGE_HAL_OPEN_NORMAL
argument_list|)
expr_stmt|;
name|vxge_hal_mempool_destroy
argument_list|(
name|fifo
operator|->
name|mempool
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_channel_terminate
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock_destroy
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|vp
operator|->
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|vp
operator|->
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_channel_free
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_ALIGN_XMIT
argument_list|)
end_if

begin_comment
comment|/*  * __hal_fifo_txdl_align_free_unmap - Unmap the alignement buffers  * @fifo: Fifo  * @txdp: txdl  *  * This function unmaps dma memory for the alignment buffers  */
end_comment

begin_function
name|void
name|__hal_fifo_txdl_align_free_unmap
parameter_list|(
name|__hal_fifo_t
modifier|*
name|fifo
parameter_list|,
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|fifo
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdp
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"fifo = 0x"
name|VXGE_OS_STXFMT
literal|",  txdp = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|fifo
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdp
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|align_vaddr
operator|!=
name|NULL
condition|)
block|{
name|__hal_blockpool_free
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|devh
argument_list|,
name|txdl_priv
operator|->
name|align_vaddr
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_addr
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_acch
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|align_vaddr
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_addr
operator|=
literal|0
expr_stmt|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_fifo_txdl_align_alloc_map - Maps the alignement buffers  * @fifo: Fifo  * @txdp: txdl  *  * This function maps dma memory for the alignment buffers  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_fifo_txdl_align_alloc_map
parameter_list|(
name|__hal_fifo_t
modifier|*
name|fifo
parameter_list|,
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|fifo
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdp
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"fifo = 0x"
name|VXGE_OS_STXFMT
literal|",  txdp = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|fifo
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdp
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
comment|/* allocate alignment DMA-buffer */
name|txdl_priv
operator|->
name|align_vaddr
operator|=
operator|(
name|u8
operator|*
operator|)
name|__hal_blockpool_malloc
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|devh
argument_list|,
name|fifo
operator|->
name|align_size
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_addr
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
operator|&
name|txdl_priv
operator|->
name|align_dma_acch
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|align_vaddr
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * vxge_hal_fifo_free_txdl_count_get - returns the number of txdls  *                               available in the fifo  * @vpath_handle: Virtual path handle.  */
end_comment

begin_function
name|u32
name|vxge_hal_fifo_free_txdl_count_get
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|)
block|{
return|return
name|__hal_channel_free_dtr_count
argument_list|(
operator|&
operator|(
operator|(
name|__hal_fifo_t
operator|*
operator|)
operator|(
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
operator|)
operator|->
name|vpath
operator|->
name|fifoh
operator|)
operator|->
name|channel
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_private_get - Retrieve per-descriptor private data.  * @vpath_handle: Virtual path handle.  * @txdlh: Descriptor handle.  *  * Retrieve per-descriptor private data.  * Note that ULD requests per-descriptor space via  * vxge_hal_fifo_attr_t passed to  * vxge_hal_vpath_open().  *  * Returns: private ULD data associated with the descriptor.  */
end_comment

begin_function
name|void
modifier|*
name|vxge_hal_fifo_txdl_private_get
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|)
block|{
return|return
operator|(
name|VXGE_HAL_FIFO_ULD_PRIV
argument_list|(
operator|(
operator|(
name|__hal_fifo_t
operator|*
operator|)
operator|(
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
operator|)
operator|->
name|vpath
operator|->
name|fifoh
operator|)
argument_list|,
name|txdlh
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_reserve - Reserve fifo descriptor.  * @vapth_handle: virtual path handle.  * @txdlh: Reserved descriptor. On success HAL fills this "out" parameter  *	with a valid handle.  * @txdl_priv: Buffer to return the pointer to per txdl space  *  * Reserve a single TxDL (that is, fifo descriptor)  * for the subsequent filling-in by upper layerdriver (ULD))  * and posting on the corresponding channel (@channelh)  * via vxge_hal_fifo_txdl_post().  *  * Note: it is the responsibility of ULD to reserve multiple descriptors  * for lengthy (e.g., LSO) transmit operation. A single fifo descriptor  * carries up to configured number (fifo.max_frags) of contiguous buffers.  *  * Returns: VXGE_HAL_OK - success;  * VXGE_HAL_INF_OUT_OF_DESCRIPTORS - Currently no descriptors available  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_fifo_txdl_reserve
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
modifier|*
name|txdlh
parameter_list|,
name|void
modifier|*
modifier|*
name|txdl_priv
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|",  txdlh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|__hal_channel_dtr_reserve
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
init|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|txdlh
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
comment|/* reset the TxDL's private */
name|priv
operator|->
name|align_dma_offset
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|align_vaddr_start
operator|=
name|priv
operator|->
name|align_vaddr
expr_stmt|;
name|priv
operator|->
name|align_used_frags
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|frags
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|alloc_frags
operator|=
name|fifo
operator|->
name|config
operator|->
name|max_frags
expr_stmt|;
name|priv
operator|->
name|dang_txdl
operator|=
name|NULL
expr_stmt|;
name|priv
operator|->
name|dang_frags
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
name|priv
operator|->
name|bytes_sent
operator|=
literal|0
expr_stmt|;
operator|*
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_ULD_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|fifo
operator|->
name|config
operator|->
name|max_frags
condition|;
name|i
operator|++
control|)
block|{
name|txdp
operator|=
operator|(
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|txdlh
operator|)
operator|+
name|i
expr_stmt|;
name|txdp
operator|->
name|control_0
operator|=
name|txdp
operator|->
name|control_1
operator|=
literal|0
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_MEMORY_CHECK
argument_list|)
name|priv
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_buffer_set - Set transmit buffer pointer in the  * descriptor.  * @vpath_handle: virtual path handle.  * @txdlh: Descriptor handle.  * @frag_idx: Index of the data buffer in the caller's scatter-gather list  *	   (of buffers).  * @dma_pointer: DMA address of the data buffer referenced by @frag_idx.  * @size: Size of the data buffer (in bytes).  *  * This API is part of the preparation of the transmit descriptor for posting  * (via vxge_hal_fifo_txdl_post()). The related "preparation" APIs include  * vxge_hal_fifo_txdl_mss_set() and vxge_hal_fifo_txdl_cksum_set_bits().  * All three APIs fill in the fields of the fifo descriptor,  * in accordance with the X3100 specification.  *  */
end_comment

begin_function
name|void
name|vxge_hal_fifo_txdl_buffer_set
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|u32
name|frag_idx
parameter_list|,
name|dma_addr_t
name|dma_pointer
parameter_list|,
name|unsigned
name|long
name|size
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|dma_pointer
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|size
operator|!=
literal|0
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", frag_idx = %d, "
literal|"dma_pointer = 0x"
name|VXGE_OS_LLXFMT
literal|", size = %lu"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
name|frag_idx
argument_list|,
operator|(
name|u64
operator|)
name|dma_pointer
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
operator|+
name|txdl_priv
operator|->
name|frags
expr_stmt|;
comment|/* 	 * Note: 	 * it is the responsibility of upper layers and not HAL 	 * detect it and skip zero-size fragment 	 */
name|vxge_assert
argument_list|(
name|size
operator|>
literal|0
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|frag_idx
operator|<
name|txdl_priv
operator|->
name|alloc_frags
argument_list|)
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|dma_pointer
expr_stmt|;
name|txdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_BUFFER_SIZE
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
name|size
expr_stmt|;
name|fifo
operator|->
name|stats
operator|->
name|total_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_buffer_set_aligned - Align transmit buffer and fill  * in fifo descriptor.  * @vpath_handle: Virtual path handle.  * @txdlh: Descriptor handle.  * @frag_idx: Index of the data buffer in the caller's scatter-gather list  *	   (of buffers).  * @vaddr: Virtual address of the data buffer.  * @dma_pointer: DMA address of the data buffer referenced by @frag_idx.  * @size: Size of the data buffer (in bytes).  * @misaligned_size: Size (in bytes) of the misaligned portion of the  * data buffer. Calculated by the caller, based on the platform/OS/other  * specific criteria, which is outside of HAL's domain. See notes below.  *  * This API is part of the transmit descriptor preparation for posting  * (via vxge_hal_fifo_txdl_post()). The related "preparation" APIs include  * vxge_hal_fifo_txdl_mss_set() and vxge_hal_fifo_txdl_cksum_set_bits().  * All three APIs fill in the fields of the fifo descriptor,  * in accordance with the X3100 specification.  * On the PCI-X based systems aligning transmit data typically provides better  * transmit performance. The typical alignment granularity: L2 cacheline size.  * However, HAL does not make assumptions in terms of the alignment granularity;  * this is specified via additional @misaligned_size parameter described above.  * Prior to calling vxge_hal_fifo_txdl_buffer_set_aligned(),  * ULD is supposed to check alignment of a given fragment/buffer. For this HAL  * provides a separate vxge_hal_check_alignment() API sufficient to cover  * most (but not all) possible alignment criteria.  * If the buffer appears to be aligned, the ULD calls  * vxge_hal_fifo_txdl_buffer_set().  * Otherwise, ULD calls vxge_hal_fifo_txdl_buffer_set_aligned().  *  * Note; This API is a "superset" of vxge_hal_fifo_txdl_buffer_set(). In  * addition to filling in the specified descriptor it aligns transmit data on  * the specified boundary.  * Note: Decision on whether to align or not to align a given contiguous  * transmit buffer is outside of HAL's domain. To this end ULD can use any  * programmable criteria, which can help to 1) boost transmit performance,  * and/or 2) provide a workaround for PCI bridge bugs, if any.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_fifo_txdl_buffer_set_aligned
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|u32
name|frag_idx
parameter_list|,
name|void
modifier|*
name|vaddr
parameter_list|,
name|dma_addr_t
name|dma_pointer
parameter_list|,
name|u32
name|size
parameter_list|,
name|u32
name|misaligned_size
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|int
name|remaining_size
decl_stmt|;
name|ptrdiff_t
name|prev_boff
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|vaddr
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|dma_pointer
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|size
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|misaligned_size
operator|!=
literal|0
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"frag_idx = %d, vaddr = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"dma_pointer = 0x"
name|VXGE_OS_LLXFMT
literal|", size = %d, "
literal|"misaligned_size = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
name|frag_idx
argument_list|,
operator|(
name|ptr_t
operator|)
name|vaddr
argument_list|,
operator|(
name|u64
operator|)
name|dma_pointer
argument_list|,
name|size
argument_list|,
name|misaligned_size
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
operator|+
name|txdl_priv
operator|->
name|frags
expr_stmt|;
comment|/* 	 * On some systems buffer size could be zero. 	 * It is the responsibility of ULD and *not HAL* to 	 * detect it and skip it. 	 */
name|vxge_assert
argument_list|(
name|size
operator|>
literal|0
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|frag_idx
operator|<
name|txdl_priv
operator|->
name|alloc_frags
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|misaligned_size
operator|!=
literal|0
operator|&&
name|misaligned_size
operator|<=
name|fifo
operator|->
name|config
operator|->
name|alignment_size
argument_list|)
expr_stmt|;
name|remaining_size
operator|=
name|size
operator|-
name|misaligned_size
expr_stmt|;
name|vxge_assert
argument_list|(
name|remaining_size
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|vxge_os_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|txdl_priv
operator|->
name|align_vaddr_start
argument_list|,
name|vaddr
argument_list|,
name|misaligned_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|align_used_frags
operator|>=
name|fifo
operator|->
name|config
operator|->
name|max_aligned_frags
condition|)
block|{
return|return
operator|(
name|VXGE_HAL_ERR_OUT_ALIGNED_FRAGS
operator|)
return|;
block|}
comment|/* setup new buffer */
comment|/* LINTED */
name|prev_boff
operator|=
name|txdl_priv
operator|->
name|align_vaddr_start
operator|-
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|txdl_priv
operator|->
name|align_dma_addr
operator|+
name|prev_boff
expr_stmt|;
name|txdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_BUFFER_SIZE
argument_list|(
name|misaligned_size
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
name|misaligned_size
expr_stmt|;
name|fifo
operator|->
name|stats
operator|->
name|total_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_used_frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_vaddr_start
operator|+=
name|fifo
operator|->
name|config
operator|->
name|alignment_size
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_offset
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
comment|/* sync new buffer */
name|vxge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
name|txdp
operator|->
name|buffer_pointer
argument_list|,
literal|0
argument_list|,
name|misaligned_size
argument_list|,
name|VXGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|remaining_size
condition|)
block|{
name|vxge_assert
argument_list|(
name|frag_idx
operator|<
name|txdl_priv
operator|->
name|alloc_frags
argument_list|)
expr_stmt|;
name|txdp
operator|++
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|dma_pointer
operator|+
name|misaligned_size
expr_stmt|;
name|txdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_BUFFER_SIZE
argument_list|(
name|remaining_size
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
name|remaining_size
expr_stmt|;
name|fifo
operator|->
name|stats
operator|->
name|total_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_buffer_append - Append the contents of virtually  *		contiguous data buffer to a single physically contiguous buffer.  * @vpath_handle: Virtual path handle.  * @txdlh: Descriptor handle.  * @vaddr: Virtual address of the data buffer.  * @size: Size of the data buffer (in bytes).  *  * This API is part of the transmit descriptor preparation for posting  * (via vxge_hal_fifo_txdl_post()).  * The main difference of this API wrt to the APIs  * vxge_hal_fifo_txdl_buffer_set_aligned() is that this API appends the  * contents of virtually contiguous data buffers received from  * upper layer into a single physically contiguous data buffer and the  * device will do a DMA from this buffer.  *  * See Also: vxge_hal_fifo_txdl_buffer_finalize(),  * vxge_hal_fifo_txdl_buffer_set(),  * vxge_hal_fifo_txdl_buffer_set_aligned().  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_fifo_txdl_buffer_append
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|void
modifier|*
name|vaddr
parameter_list|,
name|u32
name|size
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|ptrdiff_t
name|used
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|vaddr
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|size
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", vaddr = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"size = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
operator|(
name|ptr_t
operator|)
name|vaddr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
comment|/* LINTED */
name|used
operator|=
name|txdl_priv
operator|->
name|align_vaddr_start
operator|-
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|used
operator|+=
name|txdl_priv
operator|->
name|align_dma_offset
expr_stmt|;
if|if
condition|(
name|used
operator|+
operator|(
name|unsigned
name|int
operator|)
name|size
operator|>
operator|(
name|unsigned
name|int
operator|)
name|fifo
operator|->
name|align_size
condition|)
return|return
operator|(
name|VXGE_HAL_ERR_OUT_ALIGNED_FRAGS
operator|)
return|;
name|vxge_os_memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|txdl_priv
operator|->
name|align_vaddr_start
operator|+
name|txdl_priv
operator|->
name|align_dma_offset
argument_list|,
name|vaddr
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|fifo
operator|->
name|stats
operator|->
name|copied_frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_offset
operator|+=
name|size
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_buffer_finalize - Prepares a descriptor that contains the  * single physically contiguous buffer.  *  * @vpath_handle: Virtual path handle.  * @txdlh: Descriptor handle.  * @frag_idx: Index of the data buffer in the Txdl list.  *  * This API in conjunction with vxge_hal_fifo_txdl_buffer_append() prepares  * a descriptor that consists of a single physically contiguous buffer  * which inturn contains the contents of one or more virtually contiguous  * buffers received from the upper layer.  *  * See Also: vxge_hal_fifo_txdl_buffer_append().  */
end_comment

begin_function
name|void
name|vxge_hal_fifo_txdl_buffer_finalize
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|u32
name|frag_idx
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|ptrdiff_t
name|prev_boff
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|frag_idx
operator|!=
literal|0
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", frag_idx = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
name|frag_idx
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
operator|+
name|txdl_priv
operator|->
name|frags
expr_stmt|;
comment|/* LINTED */
name|prev_boff
operator|=
name|txdl_priv
operator|->
name|align_vaddr_start
operator|-
name|txdl_priv
operator|->
name|align_vaddr
expr_stmt|;
name|txdp
operator|->
name|buffer_pointer
operator|=
operator|(
name|u64
operator|)
name|txdl_priv
operator|->
name|align_dma_addr
operator|+
name|prev_boff
expr_stmt|;
name|txdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_BUFFER_SIZE
argument_list|(
name|txdl_priv
operator|->
name|align_dma_offset
argument_list|)
expr_stmt|;
name|txdl_priv
operator|->
name|bytes_sent
operator|+=
operator|(
name|unsigned
name|int
operator|)
name|txdl_priv
operator|->
name|align_dma_offset
expr_stmt|;
name|fifo
operator|->
name|stats
operator|->
name|total_buffers
operator|++
expr_stmt|;
name|fifo
operator|->
name|stats
operator|->
name|copied_buffers
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|frags
operator|++
expr_stmt|;
name|txdl_priv
operator|->
name|align_used_frags
operator|++
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
comment|/* sync pre-mapped buffer */
name|vxge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|align_dma_handle
argument_list|,
name|txdp
operator|->
name|buffer_pointer
argument_list|,
literal|0
argument_list|,
name|txdl_priv
operator|->
name|align_dma_offset
argument_list|,
name|VXGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* increment vaddr_start for the next buffer_append() iteration */
name|txdl_priv
operator|->
name|align_vaddr_start
operator|+=
name|txdl_priv
operator|->
name|align_dma_offset
expr_stmt|;
name|txdl_priv
operator|->
name|align_dma_offset
operator|=
literal|0
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_new_frame_set - Start the new packet by setting TXDL flags  * @vpath_handle: virtual path handle.  * @txdlh: Descriptor handle.  * @tagged: Is the frame tagged  *  * This API is part of the preparation of the transmit descriptor for posting  * (via vxge_hal_fifo_txdl_post()). This api is used to mark the end of previous  * frame and start of a new frame.  *  */
end_comment

begin_function
name|void
name|vxge_hal_fifo_txdl_new_frame_set
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|u32
name|tagged
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", tagged = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
name|tagged
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
operator|+
name|txdl_priv
operator|->
name|frags
expr_stmt|;
name|txdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_HOST_STEER
argument_list|(
name|vp
operator|->
name|vpath
operator|->
name|vp_config
operator|->
name|wire_port
argument_list|)
expr_stmt|;
name|txdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_GATHER_CODE
argument_list|(
name|VXGE_HAL_FIFO_TXD_GATHER_CODE_FIRST
argument_list|)
expr_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|fifo
operator|->
name|interrupt_type
expr_stmt|;
name|txdp
operator|->
name|control_1
operator||=
name|VXGE_HAL_FIFO_TXD_INT_NUMBER
argument_list|(
name|vp
operator|->
name|vpath
operator|->
name|tx_intr_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|tagged
condition|)
name|txdp
operator|->
name|control_1
operator||=
name|VXGE_HAL_FIFO_TXD_NO_BW_LIMIT
expr_stmt|;
if|if
condition|(
name|txdl_priv
operator|->
name|frags
condition|)
block|{
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
operator|+
operator|(
name|txdl_priv
operator|->
name|frags
operator|-
literal|1
operator|)
expr_stmt|;
name|txdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_GATHER_CODE
argument_list|(
name|VXGE_HAL_FIFO_TXD_GATHER_CODE_LAST
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_post - Post descriptor on the fifo channel.  * @vpath_handle: Virtual path handle.  * @txdlh: Descriptor obtained via vxge_hal_fifo_txdl_reserve()  * @tagged: Is the frame tagged  *  * Post descriptor on the 'fifo' type channel for transmission.  * Prior to posting the descriptor should be filled in accordance with  * Host/X3100 interface specification for a given service (LL, etc.).  *  */
end_comment

begin_function
name|void
name|vxge_hal_fifo_txdl_post
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|u32
name|tagged
parameter_list|)
block|{
name|u64
name|list_ptr
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp_last
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp_first
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", tagged = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
name|tagged
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|txdp_first
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
expr_stmt|;
name|txdp_first
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_HOST_STEER
argument_list|(
name|vp
operator|->
name|vpath
operator|->
name|vp_config
operator|->
name|wire_port
argument_list|)
expr_stmt|;
name|txdp_first
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_GATHER_CODE
argument_list|(
name|VXGE_HAL_FIFO_TXD_GATHER_CODE_FIRST
argument_list|)
expr_stmt|;
name|txdp_first
operator|->
name|control_1
operator||=
name|VXGE_HAL_FIFO_TXD_INT_NUMBER
argument_list|(
name|vp
operator|->
name|vpath
operator|->
name|tx_intr_num
argument_list|)
expr_stmt|;
name|txdp_first
operator|->
name|control_1
operator||=
name|fifo
operator|->
name|interrupt_type
expr_stmt|;
name|list_ptr
operator|=
operator|(
name|u64
operator|)
name|txdl_priv
operator|->
name|dma_addr
expr_stmt|;
if|if
condition|(
name|tagged
condition|)
block|{
name|txdp_first
operator|->
name|control_1
operator||=
name|VXGE_HAL_FIFO_TXD_NO_BW_LIMIT
expr_stmt|;
name|list_ptr
operator||=
literal|0x1
expr_stmt|;
block|}
name|txdp_last
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
operator|+
operator|(
name|txdl_priv
operator|->
name|frags
operator|-
literal|1
operator|)
expr_stmt|;
name|txdp_last
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_GATHER_CODE
argument_list|(
name|VXGE_HAL_FIFO_TXD_GATHER_CODE_LAST
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|txdp_first
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_LIST_OWN_ADAPTER
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
comment|/* make sure device overwrites the t_code value on completion */
name|txdp_first
operator|->
name|control_0
operator||=
name|VXGE_HAL_FIFO_TXD_T_CODE
argument_list|(
name|VXGE_HAL_FIFO_TXD_T_CODE_UNUSED
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_TXDL_STREAMING
argument_list|)
comment|/* sync the TxDL to device */
name|vxge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|txdl_priv
operator|->
name|dma_handle
argument_list|,
name|txdl_priv
operator|->
name|dma_addr
argument_list|,
name|txdl_priv
operator|->
name|dma_offset
argument_list|,
name|txdl_priv
operator|->
name|frags
operator|<<
literal|5
argument_list|,
comment|/* sizeof(vxge_hal_fifo_txd_t) */
name|VXGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * we want touch dtr_arr in order with ownership bit set to HW 	 */
name|__hal_channel_dtr_post
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
name|VXGE_HAL_FIFO_TXDL_INDEX
argument_list|(
name|txdlh
argument_list|)
argument_list|)
expr_stmt|;
name|__hal_non_offload_db_post
argument_list|(
name|vpath_handle
argument_list|,
name|list_ptr
argument_list|,
name|txdl_priv
operator|->
name|frags
operator|-
literal|1
argument_list|,
name|vp
operator|->
name|vpath
operator|->
name|vp_config
operator|->
name|fifo
operator|.
name|no_snoop_bits
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_FIFO_DUMP_TXD
argument_list|)
name|vxge_hal_info_log_fifo
argument_list|(
literal|""
name|VXGE_OS_LLXFMT
literal|":"
name|VXGE_OS_LLXFMT
literal|":"
name|VXGE_OS_LLXFMT
literal|":"
name|VXGE_OS_LLXFMT
literal|" dma "
name|VXGE_OS_LLXFMT
argument_list|,
name|txdp_first
operator|->
name|control_0
argument_list|,
name|txdp_first
operator|->
name|control_1
argument_list|,
name|txdp_first
operator|->
name|buffer_pointer
argument_list|,
name|VXGE_HAL_FIFO_TXDL_INDEX
argument_list|(
name|txdp_first
argument_list|)
argument_list|,
name|txdl_priv
operator|->
name|dma_addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fifo
operator|->
name|stats
operator|->
name|total_posts
operator|++
expr_stmt|;
name|fifo
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_max
operator|<
name|fifo
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
condition|)
name|fifo
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_max
operator|=
name|fifo
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_is_next_txdl_completed - Checks if the next txdl is completed  * @vpath_handle: Virtual path handle.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_fifo_is_next_txdl_completed
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
name|vxge_hal_txdl_h
name|txdlh
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|vxge_assert
argument_list|(
name|vpath_handle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_try_complete
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
operator|&
name|txdlh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
expr_stmt|;
if|if
condition|(
operator|(
name|txdp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|!
operator|(
name|txdp
operator|->
name|control_0
operator|&
name|VXGE_HAL_FIFO_TXD_LIST_OWN_ADAPTER
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* no more completions */
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_next_completed - Retrieve next completed descriptor.  * @vpath_handle: Virtual path handle.  * @txdlh: Descriptor handle. Returned by HAL.  * @txdl_priv: Buffer to return the pointer to per txdl space  * @t_code: Transfer code, as per X3100 User Guide,  *	 Transmit Descriptor Format.  *	 Returned by HAL.  *  * Retrieve the _next_ completed descriptor.  * HAL uses channel callback (*vxge_hal_channel_callback_f) to notifiy  * upper-layer driver (ULD) of new completed descriptors. After that  * the ULD can use vxge_hal_fifo_txdl_next_completed to retrieve the rest  * completions (the very first completion is passed by HAL via  * vxge_hal_channel_callback_f).  *  * Implementation-wise, the upper-layer driver is free to call  * vxge_hal_fifo_txdl_next_completed either immediately from inside the  * channel callback, or in a deferred fashion and separate (from HAL)  * context.  *  * Non-zero @t_code means failure to process the descriptor.  * The failure could happen, for instance, when the link is  * down, in which case X3100 completes the descriptor because it  * is not able to send the data out.  *  * For details please refer to X3100 User Guide.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS - No completed descriptors  * are currently available for processing.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_fifo_txdl_next_completed
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
modifier|*
name|txdlh
parameter_list|,
name|void
modifier|*
modifier|*
name|txdl_priv
parameter_list|,
name|vxge_hal_fifo_tcode_e
modifier|*
name|t_code
parameter_list|)
block|{
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_TXDL_STREAMING
argument_list|)
name|__hal_fifo_txdl_priv_t
modifier|*
name|priv
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|t_code
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", t_code = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
operator|(
name|ptr_t
operator|)
name|t_code
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|txdlh
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_try_complete
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|txdp
operator|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
operator|*
name|txdlh
expr_stmt|;
if|if
condition|(
name|txdp
operator|!=
name|NULL
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_TXDL_STREAMING
argument_list|)
name|priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
comment|/* 		 * sync TxDL to read the ownership 		 * 		 * Note: 16bytes means Control_1& Control_2 		 */
name|vxge_os_dma_sync
argument_list|(
name|fifo
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|priv
operator|->
name|dma_handle
argument_list|,
name|priv
operator|->
name|dma_addr
argument_list|,
name|priv
operator|->
name|dma_offset
argument_list|,
literal|16
argument_list|,
name|VXGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* check whether host owns it */
if|if
condition|(
operator|!
operator|(
name|txdp
operator|->
name|control_0
operator|&
name|VXGE_HAL_FIFO_TXD_LIST_OWN_ADAPTER
operator|)
condition|)
block|{
name|__hal_channel_dtr_complete
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|)
expr_stmt|;
operator|*
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_ULD_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
operator|*
name|t_code
operator|=
operator|(
name|vxge_hal_fifo_tcode_e
operator|)
name|VXGE_HAL_FIFO_TXD_T_CODE_GET
argument_list|(
name|txdp
operator|->
name|control_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fifo
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|>
literal|0
condition|)
name|fifo
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|--
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
block|}
block|}
comment|/* no more completions */
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_handle_tcode - Handle transfer code.  * @vpath_handle: Virtual Path handle.  * @txdlh: Descriptor handle.  * @t_code: One of the enumerated (and documented in the X3100 user guide)  *	 "transfer codes".  *  * Handle descriptor's transfer code. The latter comes with each completed  * descriptor.  *  * Returns: one of the vxge_hal_status_e {} enumerated types.  * VXGE_HAL_OK			- for success.  * VXGE_HAL_ERR_CRITICAL	- when encounters critical error.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_fifo_handle_tcode
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|,
name|vxge_hal_fifo_tcode_e
name|t_code
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
literal|", t_code = 0x%d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
name|t_code
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|t_code
operator|&
literal|0x7
operator|)
condition|)
block|{
case|case
literal|0
case|:
comment|/* 000: Transfer operation completed successfully. */
break|break;
case|case
literal|1
case|:
comment|/* 		 * 001: a PCI read transaction (either TxD or frame data) 		 *	returned with corrupt data. 		 */
break|break;
case|case
literal|2
case|:
comment|/* 010: a PCI read transaction was returned with no data. */
break|break;
case|case
literal|3
case|:
comment|/* 		 * 011: The host attempted to send either a frame or LSO 		 *	MSS that was too long (>9800B). 		 */
break|break;
case|case
literal|4
case|:
comment|/* 		 * 100: Error detected during TCP/UDP Large Send 		 *	Offload operation, due to improper header template, 		 *	unsupported protocol, etc. 		 */
break|break;
default|default:
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_TCODE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_TCODE
operator|)
return|;
block|}
name|vp
operator|->
name|vpath
operator|->
name|sw_stats
operator|->
name|fifo_stats
operator|.
name|txd_t_code_err_cnt
index|[
name|t_code
index|]
operator|++
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_OK
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_fifo_txdl_free_many - Free the fragments  * @fifo: FIFO  * @txdp: Poniter to a TxD  * @list_size: List size  * @frags: Number of fragments  *  * This routinf frees the fragments in a txdl  */
end_comment

begin_function
name|void
name|__hal_fifo_txdl_free_many
parameter_list|(
name|__hal_fifo_t
modifier|*
name|fifo
parameter_list|,
name|vxge_hal_fifo_txd_t
modifier|*
name|txdp
parameter_list|,
name|u32
name|list_size
parameter_list|,
name|u32
name|frags
parameter_list|)
block|{
name|__hal_fifo_txdl_priv_t
modifier|*
name|current_txdl_priv
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|next_txdl_priv
decl_stmt|;
name|u32
name|invalid_frags
init|=
name|frags
operator|%
name|list_size
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|fifo
operator|->
name|channel
operator|.
name|vph
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|fifo
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdp
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"fifo = 0x"
name|VXGE_OS_STXFMT
literal|", txdp = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"list_size = %d, frags = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|fifo
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdp
argument_list|,
name|list_size
argument_list|,
name|frags
argument_list|)
expr_stmt|;
if|if
condition|(
name|invalid_frags
condition|)
block|{
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"freeing corrupt txdlh 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"fragments %d list size %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdp
argument_list|,
name|frags
argument_list|,
name|list_size
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|invalid_frags
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|txdp
condition|)
block|{
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"freeing linked txdlh 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"fragments %d list size %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdp
argument_list|,
name|frags
argument_list|,
name|list_size
argument_list|)
expr_stmt|;
name|current_txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdp
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_OS_MEMORY_CHECK
argument_list|)
name|current_txdl_priv
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_free
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
name|VXGE_HAL_FIFO_TXDL_INDEX
argument_list|(
name|txdp
argument_list|)
argument_list|)
expr_stmt|;
name|next_txdl_priv
operator|=
name|current_txdl_priv
operator|->
name|next_txdl_priv
expr_stmt|;
name|vxge_assert
argument_list|(
name|frags
argument_list|)
expr_stmt|;
name|frags
operator|-=
name|list_size
expr_stmt|;
if|if
condition|(
name|next_txdl_priv
condition|)
block|{
name|current_txdl_priv
operator|->
name|next_txdl_priv
operator|=
name|NULL
expr_stmt|;
name|txdp
operator|=
name|next_txdl_priv
operator|->
name|first_txdp
expr_stmt|;
block|}
else|else
block|{
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"freed linked txdlh fragments %d list size %d"
argument_list|,
name|frags
argument_list|,
name|list_size
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|vxge_assert
argument_list|(
name|frags
operator|==
literal|0
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_fifo_txdl_free - Free descriptor.  * @vpath_handle: Virtual path handle.  * @txdlh: Descriptor handle.  *  * Free the reserved descriptor. This operation is "symmetrical" to  * vxge_hal_fifo_txdl_reserve. The "free-ing" completes the descriptor's  * lifecycle.  *  * After free-ing (see vxge_hal_fifo_txdl_free()) the descriptor again can  * be:  *  * - reserved (vxge_hal_fifo_txdl_reserve);  *  * - posted (vxge_hal_fifo_txdl_post);  *  * - completed (vxge_hal_fifo_txdl_next_completed);  *  * - and recycled again (vxge_hal_fifo_txdl_free).  *  * For alternative state transitions and more details please refer to  * the design doc.  *  */
end_comment

begin_function
name|void
name|vxge_hal_fifo_txdl_free
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_txdl_h
name|txdlh
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_fifo_t
modifier|*
name|fifo
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_fifo_txdl_priv_t
modifier|*
name|txdl_priv
decl_stmt|;
name|u32
name|max_frags
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|u32
name|flags
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|txdlh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"txdlh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|)
expr_stmt|;
name|fifo
operator|=
operator|(
name|__hal_fifo_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|fifoh
expr_stmt|;
name|vxge_assert
argument_list|(
name|fifo
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|txdl_priv
operator|=
name|VXGE_HAL_FIFO_HAL_PRIV
argument_list|(
name|fifo
argument_list|,
name|txdlh
argument_list|)
expr_stmt|;
name|max_frags
operator|=
name|fifo
operator|->
name|config
operator|->
name|max_frags
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|txdl_priv
operator|->
name|alloc_frags
operator|>
name|max_frags
condition|)
block|{
name|vxge_hal_fifo_txd_t
modifier|*
name|dang_txdp
init|=
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdl_priv
operator|->
name|dang_txdl
decl_stmt|;
name|u32
name|dang_frags
init|=
name|txdl_priv
operator|->
name|dang_frags
decl_stmt|;
name|u32
name|alloc_frags
init|=
name|txdl_priv
operator|->
name|alloc_frags
decl_stmt|;
name|txdl_priv
operator|->
name|dang_txdl
operator|=
name|NULL
expr_stmt|;
name|txdl_priv
operator|->
name|dang_frags
operator|=
literal|0
expr_stmt|;
name|txdl_priv
operator|->
name|alloc_frags
operator|=
literal|0
expr_stmt|;
comment|/* txdlh must have a linked list of txdlh */
name|vxge_assert
argument_list|(
name|txdl_priv
operator|->
name|next_txdl_priv
argument_list|)
expr_stmt|;
comment|/* free any dangling txdlh first */
if|if
condition|(
name|dang_txdp
condition|)
block|{
name|vxge_hal_info_log_fifo
argument_list|(
literal|"freeing dangled txdlh 0x"
name|VXGE_OS_STXFMT
literal|" for %d "
literal|"fragments"
argument_list|,
operator|(
name|ptr_t
operator|)
name|dang_txdp
argument_list|,
name|dang_frags
argument_list|)
expr_stmt|;
name|__hal_fifo_txdl_free_many
argument_list|(
name|fifo
argument_list|,
name|dang_txdp
argument_list|,
name|max_frags
argument_list|,
name|dang_frags
argument_list|)
expr_stmt|;
block|}
comment|/* now free the reserved txdlh list */
name|vxge_hal_info_log_fifo
argument_list|(
literal|"freeing txdlh 0x"
name|VXGE_OS_STXFMT
literal|" list of %d fragments"
argument_list|,
operator|(
name|ptr_t
operator|)
name|txdlh
argument_list|,
name|alloc_frags
argument_list|)
expr_stmt|;
name|__hal_fifo_txdl_free_many
argument_list|(
name|fifo
argument_list|,
operator|(
name|vxge_hal_fifo_txd_t
operator|*
operator|)
name|txdlh
argument_list|,
name|max_frags
argument_list|,
name|alloc_frags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|__hal_channel_dtr_free
argument_list|(
operator|&
name|fifo
operator|->
name|channel
argument_list|,
name|VXGE_HAL_FIFO_TXDL_INDEX
argument_list|(
name|txdlh
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fifo
operator|->
name|channel
operator|.
name|poll_bytes
operator|+=
name|txdl_priv
operator|->
name|bytes_sent
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_OS_MEMORY_CHECK
argument_list|)
name|txdl_priv
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_TX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|fifo
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_fifo
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


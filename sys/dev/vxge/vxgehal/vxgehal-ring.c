begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxgehal/vxgehal.h>
end_include

begin_comment
comment|/*  * __hal_ring_block_memblock_idx - Return the memblock index  * @block: Virtual address of memory block  *  * This function returns the index of memory block  */
end_comment

begin_function
specifier|static
specifier|inline
name|u32
name|__hal_ring_block_memblock_idx
parameter_list|(
name|vxge_hal_ring_block_t
name|block
parameter_list|)
block|{
return|return
operator|(
name|u32
operator|)
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|block
operator|+
name|VXGE_HAL_RING_MEMBLOCK_IDX_OFFSET
operator|)
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_block_memblock_idx_set - Sets the memblock index  * @block: Virtual address of memory block  * @memblock_idx: Index of memory block  *  * This function sets index to a memory block  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|__hal_ring_block_memblock_idx_set
parameter_list|(
name|vxge_hal_ring_block_t
name|block
parameter_list|,
name|u32
name|memblock_idx
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|block
operator|+
name|VXGE_HAL_RING_MEMBLOCK_IDX_OFFSET
operator|)
operator|)
operator|)
operator|=
name|memblock_idx
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/*  * __hal_ring_block_next_pointer - Returns the dma address of next block  * @block: RxD block  *  * Returns the dma address of next block stored in the RxD block  */
end_comment

begin_comment
unit|static inline dma_addr_t
comment|/* LINTED */
end_comment

begin_endif
unit|__hal_ring_block_next_pointer(     vxge_hal_ring_block_t *block) { 	return (dma_addr_t)*((u64 *) ((void *)((u8 *) block + 	    VXGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET))); }
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * __hal_ring_block_next_pointer_set - Sets the next block pointer in RxD block  * @block: RxD block  * @dma_next: dma address of next block  *  * Sets the next block pointer in RxD block  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|__hal_ring_block_next_pointer_set
parameter_list|(
name|vxge_hal_ring_block_t
modifier|*
name|block
parameter_list|,
name|dma_addr_t
name|dma_next
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|u64
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|u8
operator|*
operator|)
name|block
operator|+
name|VXGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET
operator|)
operator|)
operator|)
operator|=
name|dma_next
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_first_block_address_get - Returns the dma address of the  *		first block  * @ringh: Handle to the ring  *  * Returns the dma address of the first RxD block  */
end_comment

begin_function
name|u64
name|__hal_ring_first_block_address_get
parameter_list|(
name|vxge_hal_ring_h
name|ringh
parameter_list|)
block|{
name|__hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|ringh
decl_stmt|;
name|vxge_hal_mempool_dma_t
modifier|*
name|dma_object
decl_stmt|;
name|dma_object
operator|=
name|__hal_mempool_memblock_dma
argument_list|(
name|ring
operator|->
name|mempool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|dma_object
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|dma_object
operator|->
name|addr
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_RXD_STREAMING
argument_list|)
end_if

begin_comment
comment|/*  * __hal_ring_item_dma_offset - Return the dma offset of an item  * @mempoolh: Handle to the memory pool of the ring  * @item: Item for which to get the dma offset  *  * This function returns the dma offset of a given item  */
end_comment

begin_function
specifier|static
name|ptrdiff_t
name|__hal_ring_item_dma_offset
parameter_list|(
name|vxge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|item
parameter_list|)
block|{
name|u32
name|memblock_idx
decl_stmt|;
name|void
modifier|*
name|memblock
decl_stmt|;
name|vxge_hal_mempool_t
modifier|*
name|mempool
init|=
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|mempoolh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|item
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|dma_handle
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"mempoolh = 0x"
name|VXGE_OS_STXFMT
literal|", item = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempoolh
argument_list|,
operator|(
name|ptr_t
operator|)
name|item
argument_list|)
expr_stmt|;
comment|/* get owner memblock index */
name|memblock_idx
operator|=
name|__hal_ring_block_memblock_idx
argument_list|(
name|item
argument_list|)
expr_stmt|;
comment|/* get owner memblock by memblock index */
name|memblock
operator|=
name|__hal_mempool_memblock
argument_list|(
name|mempoolh
argument_list|,
name|memblock_idx
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|u8
operator|*
operator|)
name|item
operator|-
operator|(
name|u8
operator|*
operator|)
name|memblock
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * __hal_ring_item_dma_addr - Return the dma address of an item  * @mempoolh: Handle to the memory pool of the ring  * @item: Item for which to get the dma offset  * @dma_handle: dma handle  *  * This function returns the dma address of a given item  */
end_comment

begin_function
specifier|static
name|dma_addr_t
name|__hal_ring_item_dma_addr
parameter_list|(
name|vxge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|pci_dma_h
modifier|*
name|dma_handle
parameter_list|)
block|{
name|u32
name|memblock_idx
decl_stmt|;
name|void
modifier|*
name|memblock
decl_stmt|;
name|vxge_hal_mempool_dma_t
modifier|*
name|memblock_dma_object
decl_stmt|;
name|vxge_hal_mempool_t
modifier|*
name|mempool
init|=
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|ptrdiff_t
name|dma_item_offset
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|mempoolh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|item
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|dma_handle
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"mempoolh = 0x"
name|VXGE_OS_STXFMT
literal|", item = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"dma_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempoolh
argument_list|,
operator|(
name|ptr_t
operator|)
name|item
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_handle
argument_list|)
expr_stmt|;
comment|/* get owner memblock index */
name|memblock_idx
operator|=
name|__hal_ring_block_memblock_idx
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|item
argument_list|)
expr_stmt|;
comment|/* get owner memblock by memblock index */
name|memblock
operator|=
name|__hal_mempool_memblock
argument_list|(
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_idx
argument_list|)
expr_stmt|;
comment|/* get memblock DMA object by memblock index */
name|memblock_dma_object
operator|=
name|__hal_mempool_memblock_dma
argument_list|(
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_idx
argument_list|)
expr_stmt|;
comment|/* calculate offset in the memblock of this item */
comment|/* LINTED */
name|dma_item_offset
operator|=
operator|(
name|u8
operator|*
operator|)
name|item
operator|-
operator|(
name|u8
operator|*
operator|)
name|memblock
expr_stmt|;
operator|*
name|dma_handle
operator|=
name|memblock_dma_object
operator|->
name|handle
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|memblock_dma_object
operator|->
name|addr
operator|+
name|dma_item_offset
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_rxdblock_link - Link the RxD blocks  * @mempoolh: Handle to the memory pool of the ring  * @ring: ring  * @from: RxD block from which to link  * @to: RxD block to which to link to  *  * This function returns the dma address of a given item  */
end_comment

begin_function
specifier|static
name|void
name|__hal_ring_rxdblock_link
parameter_list|(
name|vxge_hal_mempool_h
name|mempoolh
parameter_list|,
name|__hal_ring_t
modifier|*
name|ring
parameter_list|,
name|u32
name|from
parameter_list|,
name|u32
name|to
parameter_list|)
block|{
name|vxge_hal_ring_block_t
modifier|*
name|to_item
decl_stmt|,
modifier|*
name|from_item
decl_stmt|;
name|dma_addr_t
name|to_dma
decl_stmt|,
name|from_dma
decl_stmt|;
name|pci_dma_h
name|to_dma_handle
decl_stmt|,
name|from_dma_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|mempoolh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|ring
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"mempoolh = 0x"
name|VXGE_OS_STXFMT
literal|", ring = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"from = %d, to = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempoolh
argument_list|,
operator|(
name|ptr_t
operator|)
name|ring
argument_list|,
name|from
argument_list|,
name|to
argument_list|)
expr_stmt|;
comment|/* get "from" RxD block */
name|from_item
operator|=
operator|(
name|vxge_hal_ring_block_t
operator|*
operator|)
name|__hal_mempool_item
argument_list|(
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|from
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|from_item
argument_list|)
expr_stmt|;
comment|/* get "to" RxD block */
name|to_item
operator|=
operator|(
name|vxge_hal_ring_block_t
operator|*
operator|)
name|__hal_mempool_item
argument_list|(
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|to
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|to_item
argument_list|)
expr_stmt|;
comment|/* return address of the beginning of previous RxD block */
name|to_dma
operator|=
name|__hal_ring_item_dma_addr
argument_list|(
name|mempoolh
argument_list|,
name|to_item
argument_list|,
operator|&
name|to_dma_handle
argument_list|)
expr_stmt|;
comment|/* 	 * set next pointer for this RxD block to point on 	 * previous item's DMA start address 	 */
name|__hal_ring_block_next_pointer_set
argument_list|(
name|from_item
argument_list|,
name|to_dma
argument_list|)
expr_stmt|;
comment|/* return "from" RxD block's DMA start address */
name|from_dma
operator|=
name|__hal_ring_item_dma_addr
argument_list|(
name|mempoolh
argument_list|,
name|from_item
argument_list|,
operator|&
name|from_dma_handle
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_RXD_STREAMING
argument_list|)
comment|/* we must sync "from" RxD block, so hardware will see it */
name|vxge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|from_dma_handle
argument_list|,
name|from_dma
operator|+
name|VXGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET
argument_list|,
name|__hal_ring_item_dma_offset
argument_list|(
name|mempoolh
argument_list|,
name|from_item
argument_list|)
operator|+
name|VXGE_HAL_RING_NEXT_BLOCK_POINTER_OFFSET
argument_list|,
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|VXGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_info_log_ring
argument_list|(
literal|"block%d:0x"
name|VXGE_OS_STXFMT
literal|" => block%d:0x"
name|VXGE_OS_STXFMT
argument_list|,
name|from
argument_list|,
operator|(
name|ptr_t
operator|)
name|from_dma
argument_list|,
name|to
argument_list|,
operator|(
name|ptr_t
operator|)
name|to_dma
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_mempool_item_alloc - Allocate List blocks for RxD block callback  * @mempoolh: Handle to memory pool  * @memblock: Address of this memory block  * @memblock_index: Index of this memory block  * @dma_object: dma object for this block  * @item: Pointer to this item  * @index: Index of this item in memory block  * @is_last: If this is last item in the block  * @userdata: Specific data of user  *  * This function is callback passed to __hal_mempool_create to create memory  * pool for RxD block  */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|__hal_ring_mempool_item_alloc
parameter_list|(
name|vxge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|u32
name|memblock_index
parameter_list|,
name|vxge_hal_mempool_dma_t
modifier|*
name|dma_object
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|u32
name|item_index
parameter_list|,
name|u32
name|is_last
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|item
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|ring
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"mempoolh = 0x"
name|VXGE_OS_STXFMT
literal|", memblock = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"memblock_index = %d, dma_object = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"item = 0x"
name|VXGE_OS_STXFMT
literal|", item_index = %d, is_last = %d, "
literal|"userdata = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempoolh
argument_list|,
operator|(
name|ptr_t
operator|)
name|memblock
argument_list|,
name|memblock_index
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_object
argument_list|,
operator|(
name|ptr_t
operator|)
name|item
argument_list|,
name|item_index
argument_list|,
name|is_last
argument_list|,
operator|(
name|ptr_t
operator|)
name|userdata
argument_list|)
expr_stmt|;
comment|/* format rxds array */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ring
operator|->
name|rxds_per_block
condition|;
name|i
operator|++
control|)
block|{
name|void
modifier|*
name|uld_priv
decl_stmt|;
name|void
modifier|*
name|rxdblock_priv
decl_stmt|;
name|__hal_ring_rxd_priv_t
modifier|*
name|rxd_priv
decl_stmt|;
name|vxge_hal_ring_rxd_1_t
modifier|*
name|rxdp
decl_stmt|;
name|u32
name|memblock_item_idx
decl_stmt|;
name|u32
name|dtr_index
init|=
name|item_index
operator|*
name|ring
operator|->
name|rxds_per_block
operator|+
name|i
decl_stmt|;
name|ring
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|dtr
operator|=
operator|(
operator|(
name|u8
operator|*
operator|)
name|item
operator|)
operator|+
name|i
operator|*
name|ring
operator|->
name|rxd_size
expr_stmt|;
comment|/* 		 * Note: memblock_item_idx is index of the item within 		 * the memblock. For instance, in case of three RxD-blocks 		 * per memblock this value can be 0, 1 or 2. 		 */
name|rxdblock_priv
operator|=
name|__hal_mempool_item_priv
argument_list|(
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
argument_list|,
name|memblock_index
argument_list|,
name|item
argument_list|,
operator|&
name|memblock_item_idx
argument_list|)
expr_stmt|;
name|rxdp
operator|=
operator|(
name|vxge_hal_ring_rxd_1_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|dtr
expr_stmt|;
name|uld_priv
operator|=
operator|(
operator|(
name|u8
operator|*
operator|)
name|rxdblock_priv
operator|+
name|ring
operator|->
name|rxd_priv_size
operator|*
name|i
operator|)
expr_stmt|;
name|rxd_priv
operator|=
operator|(
name|__hal_ring_rxd_priv_t
operator|*
operator|)
operator|(
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|uld_priv
operator|)
operator|+
name|ring
operator|->
name|per_rxd_space
operator|)
operator|)
expr_stmt|;
operator|(
operator|(
name|vxge_hal_ring_rxd_5_t
operator|*
operator|)
name|rxdp
operator|)
operator|->
name|host_control
operator|=
name|dtr_index
expr_stmt|;
name|ring
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|uld_priv
operator|=
operator|(
name|void
operator|*
operator|)
name|uld_priv
expr_stmt|;
name|ring
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|dtr_index
index|]
operator|.
name|hal_priv
operator|=
operator|(
name|void
operator|*
operator|)
name|rxd_priv
expr_stmt|;
comment|/* pre-format per-RxD Ring's private */
comment|/* LINTED */
name|rxd_priv
operator|->
name|dma_offset
operator|=
operator|(
name|u8
operator|*
operator|)
name|rxdp
operator|-
operator|(
name|u8
operator|*
operator|)
name|memblock
expr_stmt|;
name|rxd_priv
operator|->
name|dma_addr
operator|=
name|dma_object
operator|->
name|addr
operator|+
name|rxd_priv
operator|->
name|dma_offset
expr_stmt|;
name|rxd_priv
operator|->
name|dma_handle
operator|=
name|dma_object
operator|->
name|handle
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
name|rxd_priv
operator|->
name|dma_object
operator|=
name|dma_object
expr_stmt|;
endif|#
directive|endif
name|rxd_priv
operator|->
name|db_bytes
operator|=
name|ring
operator|->
name|rxd_size
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|ring
operator|->
name|rxds_per_block
operator|-
literal|1
operator|)
condition|)
block|{
name|rxd_priv
operator|->
name|db_bytes
operator|+=
operator|(
operator|(
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|mempoolh
operator|)
operator|->
name|memblock_size
operator|-
operator|(
name|ring
operator|->
name|rxds_per_block
operator|*
name|ring
operator|->
name|rxd_size
operator|)
operator|)
expr_stmt|;
block|}
block|}
name|__hal_ring_block_memblock_idx_set
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|item
argument_list|,
name|memblock_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_last
condition|)
block|{
comment|/* link last one with first one */
name|__hal_ring_rxdblock_link
argument_list|(
name|mempoolh
argument_list|,
name|ring
argument_list|,
name|item_index
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|item_index
operator|>
literal|0
condition|)
block|{
comment|/* link this RxD block with previous one */
name|__hal_ring_rxdblock_link
argument_list|(
name|mempoolh
argument_list|,
name|ring
argument_list|,
name|item_index
operator|-
literal|1
argument_list|,
name|item_index
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_mempool_item_free - Free RxD blockt callback  * @mempoolh: Handle to memory pool  * @memblock: Address of this memory block  * @memblock_index: Index of this memory block  * @dma_object: dma object for this block  * @item: Pointer to this item  * @index: Index of this item in memory block  * @is_last: If this is last item in the block  * @userdata: Specific data of user  *  * This function is callback passed to __hal_mempool_free to destroy memory  * pool for RxD block  */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|__hal_ring_mempool_item_free
parameter_list|(
name|vxge_hal_mempool_h
name|mempoolh
parameter_list|,
name|void
modifier|*
name|memblock
parameter_list|,
name|u32
name|memblock_index
parameter_list|,
name|vxge_hal_mempool_dma_t
modifier|*
name|dma_object
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|u32
name|item_index
parameter_list|,
name|u32
name|is_last
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|__hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|userdata
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|item
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|ring
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"mempoolh = 0x"
name|VXGE_OS_STXFMT
literal|", memblock = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"memblock_index = %d, dma_object = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"item = 0x"
name|VXGE_OS_STXFMT
literal|", item_index = %d, is_last = %d, "
literal|"userdata = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempoolh
argument_list|,
operator|(
name|ptr_t
operator|)
name|memblock
argument_list|,
name|memblock_index
argument_list|,
operator|(
name|ptr_t
operator|)
name|dma_object
argument_list|,
operator|(
name|ptr_t
operator|)
name|item
argument_list|,
name|item_index
argument_list|,
name|is_last
argument_list|,
operator|(
name|ptr_t
operator|)
name|userdata
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_pool
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_initial_replenish - Initial replenish of RxDs  * @ring: ring  * @reopen: Flag to denote if it is open or repopen  *  * This function replenishes the RxDs from reserve array to work array  */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|__hal_ring_initial_replenish
parameter_list|(
name|__hal_ring_t
modifier|*
name|ring
parameter_list|,
name|vxge_hal_reopen_e
name|reopen
parameter_list|)
block|{
name|vxge_hal_rxd_h
name|rxd
decl_stmt|;
name|void
modifier|*
name|uld_priv
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"ring = 0x"
name|VXGE_OS_STXFMT
literal|", reopen = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|ring
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
while|while
condition|(
name|vxge_hal_ring_rxd_reserve
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|vph
argument_list|,
operator|&
name|rxd
argument_list|,
operator|&
name|uld_priv
argument_list|)
operator|==
name|VXGE_HAL_OK
condition|)
block|{
if|if
condition|(
name|ring
operator|->
name|rxd_init
condition|)
block|{
name|status
operator|=
name|ring
operator|->
name|rxd_init
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|vph
argument_list|,
name|rxd
argument_list|,
name|uld_priv
argument_list|,
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxd
argument_list|)
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_ring_rxd_free
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|vph
argument_list|,
name|rxd
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d \ 				    Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
name|vxge_hal_ring_rxd_post
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|vph
argument_list|,
name|rxd
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_create - Create a Ring  * @vpath_handle: Handle returned by virtual path open  * @attr: Ring configuration parameters structure  *  * This function creates Ring and initializes it.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_ring_create
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_ring_attr_t
modifier|*
name|attr
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|vxge_hal_ring_config_t
modifier|*
name|config
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|attr
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", attr = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vpath_handle
operator|==
name|NULL
operator|)
operator|||
operator|(
name|attr
operator|==
name|NULL
operator|)
condition|)
block|{
name|vxge_hal_err_log_ring
argument_list|(
literal|"null pointer passed ==> %s : %d"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result:1"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_FAIL
operator|)
return|;
block|}
name|config
operator|=
operator|&
name|vp
operator|->
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|config
operator|.
name|vp_config
index|[
name|vp
operator|->
name|vpath
operator|->
name|vp_id
index|]
operator|.
name|ring
expr_stmt|;
name|config
operator|->
name|ring_length
operator|=
operator|(
operator|(
name|config
operator|->
name|ring_length
operator|+
name|vxge_hal_ring_rxds_per_block_get
argument_list|(
name|config
operator|->
name|buffer_mode
argument_list|)
operator|-
literal|1
operator|)
operator|/
name|vxge_hal_ring_rxds_per_block_get
argument_list|(
name|config
operator|->
name|buffer_mode
argument_list|)
operator|)
operator|*
name|vxge_hal_ring_rxds_per_block_get
argument_list|(
name|config
operator|->
name|buffer_mode
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vxge_hal_channel_allocate
argument_list|(
operator|(
name|vxge_hal_device_h
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
argument_list|,
name|vpath_handle
argument_list|,
name|VXGE_HAL_CHANNEL_TYPE_RING
argument_list|,
name|config
operator|->
name|ring_length
argument_list|,
name|attr
operator|->
name|per_rxd_space
argument_list|,
name|attr
operator|->
name|userdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_err_log_ring
argument_list|(
literal|"Memory allocation failed ==> %s : %d"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|vp
operator|->
name|vpath
operator|->
name|ringh
operator|=
operator|(
name|vxge_hal_ring_h
operator|)
name|ring
expr_stmt|;
name|ring
operator|->
name|stats
operator|=
operator|&
name|vp
operator|->
name|vpath
operator|->
name|sw_stats
operator|->
name|ring_stats
expr_stmt|;
name|ring
operator|->
name|config
operator|=
name|config
expr_stmt|;
name|ring
operator|->
name|callback
operator|=
name|attr
operator|->
name|callback
expr_stmt|;
name|ring
operator|->
name|rxd_init
operator|=
name|attr
operator|->
name|rxd_init
expr_stmt|;
name|ring
operator|->
name|rxd_term
operator|=
name|attr
operator|->
name|rxd_term
expr_stmt|;
name|ring
operator|->
name|indicate_max_pkts
operator|=
name|config
operator|->
name|indicate_max_pkts
expr_stmt|;
name|ring
operator|->
name|buffer_mode
operator|=
name|config
operator|->
name|buffer_mode
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock_init
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_init_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|irqh
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ring
operator|->
name|rxd_size
operator|=
name|vxge_hal_ring_rxd_size_get
argument_list|(
name|config
operator|->
name|buffer_mode
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rxd_priv_size
operator|=
sizeof|sizeof
argument_list|(
name|__hal_ring_rxd_priv_t
argument_list|)
operator|+
name|attr
operator|->
name|per_rxd_space
expr_stmt|;
name|ring
operator|->
name|per_rxd_space
operator|=
name|attr
operator|->
name|per_rxd_space
expr_stmt|;
name|ring
operator|->
name|rxd_priv_size
operator|=
operator|(
operator|(
name|ring
operator|->
name|rxd_priv_size
operator|+
name|__vxge_os_cacheline_size
operator|-
literal|1
operator|)
operator|/
name|__vxge_os_cacheline_size
operator|)
operator|*
name|__vxge_os_cacheline_size
expr_stmt|;
comment|/* 	 * how many RxDs can fit into one block. Depends on configured 	 * buffer_mode. 	 */
name|ring
operator|->
name|rxds_per_block
operator|=
name|vxge_hal_ring_rxds_per_block_get
argument_list|(
name|config
operator|->
name|buffer_mode
argument_list|)
expr_stmt|;
comment|/* calculate actual RxD block private size */
name|ring
operator|->
name|rxdblock_priv_size
operator|=
name|ring
operator|->
name|rxd_priv_size
operator|*
name|ring
operator|->
name|rxds_per_block
expr_stmt|;
name|ring
operator|->
name|rxd_mem_avail
operator|=
operator|(
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|vph
operator|)
operator|->
name|vpath
operator|->
name|rxd_mem_size
expr_stmt|;
name|ring
operator|->
name|db_byte_count
operator|=
literal|0
expr_stmt|;
name|ring
operator|->
name|mempool
operator|=
name|vxge_hal_mempool_create
argument_list|(
operator|(
name|vxge_hal_device_h
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
argument_list|,
name|VXGE_OS_HOST_PAGE_SIZE
argument_list|,
name|VXGE_OS_HOST_PAGE_SIZE
argument_list|,
name|ring
operator|->
name|rxdblock_priv_size
argument_list|,
name|ring
operator|->
name|config
operator|->
name|ring_length
operator|/
name|ring
operator|->
name|rxds_per_block
argument_list|,
name|ring
operator|->
name|config
operator|->
name|ring_length
operator|/
name|ring
operator|->
name|rxds_per_block
argument_list|,
name|__hal_ring_mempool_item_alloc
argument_list|,
name|__hal_ring_mempool_item_free
argument_list|,
name|ring
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|mempool
operator|==
name|NULL
condition|)
block|{
name|__hal_ring_delete
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|status
operator|=
name|vxge_hal_channel_initialize
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|__hal_ring_delete
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
comment|/* 	 * Note: 	 * Specifying rxd_init callback means two things: 	 * 1) rxds need to be initialized by ULD at channel-open time; 	 * 2) rxds need to be posted at channel-open time 	 *	(that's what the initial_replenish() below does) 	 * Currently we don't have a case when the 1) is done without the 2). 	 */
if|if
condition|(
name|ring
operator|->
name|rxd_init
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|__hal_ring_initial_replenish
argument_list|(
name|ring
argument_list|,
name|VXGE_HAL_OPEN_NORMAL
argument_list|)
operator|)
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|__hal_ring_delete
argument_list|(
name|vpath_handle
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
comment|/* 	 * initial replenish will increment the counter in its post() routine, 	 * we have to reset it 	 */
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|=
literal|0
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_abort - Returns the RxD  * @ringh: Ring to be reset  * @reopen: See  vxge_hal_reopen_e {}.  *  * This function terminates the RxDs of ring  */
end_comment

begin_function
name|void
name|__hal_ring_abort
parameter_list|(
name|vxge_hal_ring_h
name|ringh
parameter_list|,
name|vxge_hal_reopen_e
name|reopen
parameter_list|)
block|{
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|vxge_hal_rxd_h
name|rxdh
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|ringh
decl_stmt|;
name|vxge_assert
argument_list|(
name|ringh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"ring = 0x"
name|VXGE_OS_STXFMT
literal|", reopen = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|ringh
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|rxd_term
condition|)
block|{
name|__hal_channel_for_each_dtr
argument_list|(
argument|&ring->channel
argument_list|,
argument|rxdh
argument_list|,
argument|i
argument_list|)
block|{
if|if
condition|(
operator|!
name|__hal_channel_is_posted_dtr
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|ring
operator|->
name|rxd_term
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|vph
argument_list|,
name|rxdh
argument_list|,
name|VXGE_HAL_RING_ULD_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdh
argument_list|)
argument_list|,
name|VXGE_HAL_RXD_STATE_FREED
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|__hal_channel_dtr_try_complete
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
operator|&
name|rxdh
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxdh
operator|==
name|NULL
condition|)
break|break;
name|__hal_channel_dtr_complete
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|rxd_term
condition|)
block|{
name|ring
operator|->
name|rxd_term
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|vph
argument_list|,
name|rxdh
argument_list|,
name|VXGE_HAL_RING_ULD_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdh
argument_list|)
argument_list|,
name|VXGE_HAL_RXD_STATE_POSTED
argument_list|,
name|ring
operator|->
name|channel
operator|.
name|userdata
argument_list|,
name|reopen
argument_list|)
expr_stmt|;
block|}
name|__hal_channel_dtr_free
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdh
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_reset - Resets the ring  * @ringh: Ring to be reset  *  * This function resets the ring during vpath reset operation  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_ring_reset
parameter_list|(
name|vxge_hal_ring_h
name|ringh
parameter_list|)
block|{
name|__hal_ring_t
modifier|*
name|ring
init|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|ringh
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_status_e
name|status
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vph
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|vph
decl_stmt|;
name|vxge_assert
argument_list|(
name|ringh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|ring
operator|->
name|channel
operator|.
name|devh
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"ring = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|ringh
argument_list|)
expr_stmt|;
name|__hal_ring_abort
argument_list|(
name|ringh
argument_list|,
name|VXGE_HAL_RESET_ONLY
argument_list|)
expr_stmt|;
name|status
operator|=
name|__hal_channel_reset
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
name|ring
operator|->
name|rxd_mem_avail
operator|=
name|vph
operator|->
name|vpath
operator|->
name|rxd_mem_size
expr_stmt|;
name|ring
operator|->
name|db_byte_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|rxd_init
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|__hal_ring_initial_replenish
argument_list|(
name|ring
argument_list|,
name|VXGE_HAL_RESET_ONLY
argument_list|)
operator|)
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_delete - Removes the ring  * @vpath_handle: Virtual path handle to which this queue belongs  *  * This function freeup the memory pool and removes the ring  */
end_comment

begin_function
name|void
name|__hal_ring_delete
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_assert
argument_list|(
name|vpath_handle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|)
expr_stmt|;
name|__hal_ring_abort
argument_list|(
name|vp
operator|->
name|vpath
operator|->
name|ringh
argument_list|,
name|VXGE_HAL_OPEN_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|mempool
condition|)
block|{
name|vxge_hal_mempool_destroy
argument_list|(
name|ring
operator|->
name|mempool
argument_list|)
expr_stmt|;
block|}
name|vxge_hal_channel_terminate
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock_destroy
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_destroy_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|hldev
operator|->
name|pdev
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_channel_free
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * __hal_ring_frame_length_set	- Set the maximum frame length of recv frames.  * @vpath: virtual Path  * @new_frmlen: New frame length  *  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_INF_OUT_OF_DESCRIPTORS - Currently no descriptors available.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|__hal_ring_frame_length_set
parameter_list|(
name|__hal_virtualpath_t
modifier|*
name|vpath
parameter_list|,
name|u32
name|new_frmlen
parameter_list|)
block|{
name|u64
name|val64
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
name|vpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath = 0x"
name|VXGE_OS_STXFMT
literal|", new_frmlen = %d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath
argument_list|,
name|new_frmlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|vp_open
operator|==
name|VXGE_HAL_VP_NOT_OPEN
condition|)
block|{
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_VPATH_NOT_OPEN
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_VPATH_NOT_OPEN
operator|)
return|;
block|}
name|val64
operator|=
name|vxge_os_pio_mem_read64
argument_list|(
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
operator|&
name|vpath
operator|->
name|vp_reg
operator|->
name|rxmac_vcfg0
argument_list|)
expr_stmt|;
name|val64
operator|&=
operator|~
name|VXGE_HAL_RXMAC_VCFG0_RTS_MAX_FRM_LEN
argument_list|(
literal|0x3fff
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpath
operator|->
name|vp_config
operator|->
name|ring
operator|.
name|max_frm_len
operator|!=
name|VXGE_HAL_MAX_RING_FRM_LEN_USE_MTU
condition|)
block|{
name|val64
operator||=
name|VXGE_HAL_RXMAC_VCFG0_RTS_MAX_FRM_LEN
argument_list|(
name|vpath
operator|->
name|vp_config
operator|->
name|ring
operator|.
name|max_frm_len
operator|+
name|VXGE_HAL_MAC_HEADER_MAX_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val64
operator||=
name|VXGE_HAL_RXMAC_VCFG0_RTS_MAX_FRM_LEN
argument_list|(
name|new_frmlen
operator|+
name|VXGE_HAL_MAC_HEADER_MAX_SIZE
argument_list|)
expr_stmt|;
block|}
name|vxge_os_pio_mem_write64
argument_list|(
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|vpath
operator|->
name|hldev
operator|->
name|header
operator|.
name|regh0
argument_list|,
name|val64
argument_list|,
operator|&
name|vpath
operator|->
name|vp_reg
operator|->
name|rxmac_vcfg0
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_reserve - Reserve ring descriptor.  * @vpath_handle: virtual Path handle.  * @rxdh: Reserved descriptor. On success HAL fills this "out" parameter  *		with a valid handle.  * @rxd_priv: Buffer to return pointer to per rxd private space  *  * Reserve Rx descriptor for the subsequent filling-in (by upper layer  * driver (ULD)) and posting on the corresponding channel (@channelh)  * via vxge_hal_ring_rxd_post().  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_INF_OUT_OF_DESCRIPTORS - Currently no descriptors available.  *  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_ring_rxd_reserve
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
modifier|*
name|rxdh
parameter_list|,
name|void
modifier|*
modifier|*
name|rxd_priv
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
decl_stmt|;
endif|#
directive|endif
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxd_priv
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", rxdh = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"rxd_priv = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxd_priv
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|status
operator|=
name|__hal_channel_dtr_reserve
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|status
operator|==
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|vxge_hal_ring_rxd_1_t
operator|*
operator|)
operator|*
name|rxdh
decl_stmt|;
comment|/* instead of memset: reset	this RxD */
name|rxdp
operator|->
name|control_0
operator|=
name|rxdp
operator|->
name|control_1
operator|=
literal|0
expr_stmt|;
operator|*
name|rxd_priv
operator|=
name|VXGE_HAL_RING_ULD_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_MEMORY_CHECK
argument_list|)
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_pre_post - Prepare rxd and post  * @vpath_handle: virtual Path handle.  * @rxdh: Descriptor handle.  *  * This routine prepares a rxd and posts  */
end_comment

begin_function
name|void
name|vxge_hal_ring_rxd_pre_post
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
name|vxge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|vxge_hal_ring_rxd_1_t
operator|*
operator|)
name|rxdh
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
decl_stmt|;
endif|#
directive|endif
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", rxdh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
comment|/* make	sure device overwrites the (illegal) t_code on completion */
name|rxdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_RING_RXD_T_CODE
argument_list|(
name|VXGE_HAL_RING_RXD_T_CODE_UNUSED
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_RING_ENFORCE_ORDER
argument_list|)
if|if
condition|(
name|TRUE
condition|)
block|{
if|if
condition|(
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_rxd_h
name|prev_rxdh
decl_stmt|;
name|__hal_ring_rxd_priv_t
modifier|*
name|rxdp_priv
decl_stmt|;
name|u32
name|index
decl_stmt|;
name|rxdp_priv
operator|=
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
if|if
condition|(
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdp
argument_list|)
operator|==
literal|0
condition|)
name|index
operator|=
name|ring
operator|->
name|channel
operator|.
name|length
expr_stmt|;
else|else
name|index
operator|=
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdp
argument_list|)
operator|-
literal|1
expr_stmt|;
name|prev_rxdh
operator|=
name|ring
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|index
index|]
operator|.
name|dtr
expr_stmt|;
if|if
condition|(
name|prev_rxdh
operator|!=
name|NULL
operator|&&
operator|(
name|rxdp_priv
operator|->
name|dma_offset
operator|&
operator|(
operator|~
literal|0xFFF
operator|)
operator|)
operator|!=
name|rxdp_priv
operator|->
name|dma_offset
condition|)
block|{
name|vxge_assert
argument_list|(
operator|(
name|char
operator|*
operator|)
name|prev_rxdh
operator|+
name|ring
operator|->
name|rxd_size
operator|==
name|rxdh
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
name|__hal_channel_dtr_post
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdh
argument_list|)
argument_list|)
expr_stmt|;
name|ring
operator|->
name|db_byte_count
operator|+=
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdh
argument_list|)
operator|->
name|db_bytes
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_post_post - Process rxd after post.  * @vpath_handle: virtual Path handle.  * @rxdh: Descriptor handle.  *  * Processes rxd after post  */
end_comment

begin_function
name|void
name|vxge_hal_ring_rxd_post_post
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|)
block|{
name|vxge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|vxge_hal_ring_rxd_1_t
operator|*
operator|)
name|rxdh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_RXD_STREAMING
argument_list|)
name|__hal_ring_rxd_priv_t
modifier|*
name|priv
decl_stmt|;
endif|#
directive|endif
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", rxdh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* do POST */
name|rxdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_RING_RXD_LIST_OWN_ADAPTER
expr_stmt|;
name|rxdp
operator|->
name|control_1
operator||=
name|VXGE_HAL_RING_RXD_LIST_TAIL_OWN_ADAPTER
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_RXD_STREAMING
argument_list|)
name|priv
operator|=
name|__hal_ring_rxd_priv
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|vxge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|priv
operator|->
name|dma_handle
argument_list|,
name|priv
operator|->
name|dma_addr
argument_list|,
name|priv
operator|->
name|dma_offset
argument_list|,
name|ring
operator|->
name|rxd_size
argument_list|,
name|VXGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|>
literal|0
condition|)
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|--
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_post - Post descriptor on the ring.  * @vpath_handle: virtual Path handle.  * @rxdh: Descriptor obtained via vxge_hal_ring_rxd_reserve().  *  * Post	descriptor on the ring.  * Prior to posting the	descriptor should be filled in accordance with  * Host/X3100 interface specification for a given service (LL, etc.).  *  */
end_comment

begin_function
name|void
name|vxge_hal_ring_rxd_post
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|)
block|{
name|vxge_hal_ring_rxd_1_t
modifier|*
name|rxdp
init|=
operator|(
name|vxge_hal_ring_rxd_1_t
operator|*
operator|)
name|rxdh
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
decl_stmt|;
endif|#
directive|endif
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", rxdh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* Based on Titan HW bugzilla # 3039, we need to reset the tcode */
name|rxdp
operator|->
name|control_0
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
comment|/* make	sure device overwrites the (illegal) t_code on completion */
name|rxdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_RING_RXD_T_CODE
argument_list|(
name|VXGE_HAL_RING_RXD_T_CODE_UNUSED
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rxdp
operator|->
name|control_1
operator||=
name|VXGE_HAL_RING_RXD_LIST_TAIL_OWN_ADAPTER
expr_stmt|;
name|rxdp
operator|->
name|control_0
operator||=
name|VXGE_HAL_RING_RXD_LIST_OWN_ADAPTER
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_RXD_STREAMING
argument_list|)
block|{
name|__hal_ring_rxd_priv_t
modifier|*
name|rxdp_temp1
decl_stmt|;
name|rxdp_temp1
operator|=
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|vxge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|rxdp_temp1
operator|->
name|dma_handle
argument_list|,
name|rxdp_temp1
operator|->
name|dma_addr
argument_list|,
name|rxdp_temp1
operator|->
name|dma_offset
argument_list|,
name|ring
operator|->
name|rxd_size
argument_list|,
name|VXGE_OS_DMA_DIR_TODEVICE
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_DEBUG_ASSERT
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_RING_ENFORCE_ORDER
argument_list|)
if|if
condition|(
name|TRUE
condition|)
block|{
if|if
condition|(
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|vxge_hal_rxd_h
name|prev_rxdh
decl_stmt|;
name|__hal_ring_rxd_priv_t
modifier|*
name|rxdp_temp2
decl_stmt|;
name|rxdp_temp2
operator|=
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|prev_rxdh
operator|=
name|ring
operator|->
name|channel
operator|.
name|dtr_arr
index|[
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdp
argument_list|)
operator|-
literal|1
index|]
operator|.
name|dtr
expr_stmt|;
if|if
condition|(
name|prev_rxdh
operator|!=
name|NULL
operator|&&
operator|(
name|rxdp_temp2
operator|->
name|dma_offset
operator|&
operator|(
operator|~
literal|0xFFF
operator|)
operator|)
operator|!=
name|rxdp_temp2
operator|->
name|dma_offset
condition|)
name|vxge_assert
argument_list|(
operator|(
name|char
operator|*
operator|)
name|prev_rxdh
operator|+
name|ring
operator|->
name|rxd_size
operator|==
name|rxdh
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|__hal_channel_dtr_post
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdh
argument_list|)
argument_list|)
expr_stmt|;
name|ring
operator|->
name|db_byte_count
operator|+=
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
operator|->
name|db_bytes
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|>
literal|0
condition|)
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|--
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_post_post_wmb - Process rxd after post with memory barrier  * @vpath_handle: virtual Path handle.  * @rxdh: Descriptor handle.  *  * Processes rxd after post with memory barrier.  */
end_comment

begin_function
name|void
name|vxge_hal_ring_rxd_post_post_wmb
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", rxdh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|)
expr_stmt|;
comment|/* Do memory barrier before changing the ownership */
name|vxge_os_wmb
argument_list|()
expr_stmt|;
name|vxge_hal_ring_rxd_post_post
argument_list|(
name|vpath_handle
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_post_post_db - Post Doorbell after posting the rxd(s).  * @vpath_handle: virtual Path handle.  *  * Post Doorbell after posting the rxd(s).  */
end_comment

begin_function
name|void
name|vxge_hal_ring_rxd_post_post_db
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_assert
argument_list|(
name|vpath_handle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ring
operator|->
name|db_byte_count
operator|<=
name|ring
operator|->
name|rxd_mem_avail
condition|)
block|{
name|__hal_rxd_db_post
argument_list|(
name|vpath_handle
argument_list|,
name|ring
operator|->
name|db_byte_count
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rxd_mem_avail
operator|-=
name|ring
operator|->
name|db_byte_count
expr_stmt|;
name|ring
operator|->
name|db_byte_count
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|__hal_rxd_db_post
argument_list|(
name|vpath_handle
argument_list|,
name|ring
operator|->
name|rxd_mem_avail
argument_list|)
expr_stmt|;
name|ring
operator|->
name|db_byte_count
operator|-=
name|ring
operator|->
name|rxd_mem_avail
expr_stmt|;
name|ring
operator|->
name|rxd_mem_avail
operator|=
literal|0
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_is_next_rxd_completed - Check if the next rxd is completed  * @vpath_handle: Virtual Path handle.  *  * Checks if the _next_	completed descriptor is	in host	memory  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS - No completed	descriptors  * are currently available for processing.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_ring_is_next_rxd_completed
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|)
block|{
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_hal_rxd_h
name|rxdh
decl_stmt|;
name|vxge_hal_ring_rxd_1_t
modifier|*
name|rxdp
decl_stmt|;
comment|/* doesn't matter 1, 3 or 5... */
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|vxge_assert
argument_list|(
name|vpath_handle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_try_complete
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
operator|&
name|rxdh
argument_list|)
expr_stmt|;
name|rxdp
operator|=
operator|(
name|vxge_hal_ring_rxd_1_t
operator|*
operator|)
name|rxdh
expr_stmt|;
if|if
condition|(
name|rxdp
operator|!=
name|NULL
condition|)
block|{
comment|/* check whether it is not the end */
if|if
condition|(
operator|(
operator|!
operator|(
name|rxdp
operator|->
name|control_0
operator|&
name|VXGE_HAL_RING_RXD_LIST_OWN_ADAPTER
operator|)
operator|)
operator|&&
operator|(
operator|!
operator|(
name|rxdp
operator|->
name|control_1
operator|&
name|VXGE_HAL_RING_RXD_LIST_TAIL_OWN_ADAPTER
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_next_completed - Get the _next_ completed descriptor.  * @channelh: Channel handle.  * @rxdh: Descriptor handle. Returned by HAL.  * @rxd_priv: Buffer to return a pointer to the per rxd space allocated  * @t_code:	Transfer code, as per X3100 User Guide,  *			Receive	Descriptor Format. Returned	by HAL.  *  * Retrieve the	_next_ completed descriptor.  * HAL uses ring callback (*vxge_hal_ring_callback_f) to notifiy  * upper-layer driver (ULD) of new completed descriptors. After that  * the ULD can use vxge_hal_ring_rxd_next_completed to retrieve the rest  * completions (the very first completion is passed by HAL via  * vxge_hal_ring_callback_f).  *  * Implementation-wise,	the upper-layer	driver is free to call  * vxge_hal_ring_rxd_next_completed either immediately from inside the  * ring callback, or in a deferred fashion and separate (from HAL)  * context.  *  * Non-zero @t_code means failure to fill-in receive buffer(s)  * of the descriptor.  * For instance, parity	error detected during the data transfer.  * In this case	X3100 will	complete the descriptor	and	indicate  * for the host	that the received data is not to be	used.  * For details please refer	to X3100 User Guide.  *  * Returns: VXGE_HAL_OK - success.  * VXGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS - No completed	descriptors  * are currently available for processing.  *  * See also: vxge_hal_ring_callback_f {},  * vxge_hal_fifo_rxd_next_completed(), vxge_hal_status_e {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_ring_rxd_next_completed
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
modifier|*
name|rxdh
parameter_list|,
name|void
modifier|*
modifier|*
name|rxd_priv
parameter_list|,
name|u8
modifier|*
name|t_code
parameter_list|)
block|{
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|vxge_hal_ring_rxd_5_t
modifier|*
name|rxdp
decl_stmt|;
comment|/* doesn't matter 1, 3 or 5... */
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_RXD_STREAMING
argument_list|)
name|__hal_ring_rxd_priv_t
modifier|*
name|priv
decl_stmt|;
endif|#
directive|endif
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_hal_status_e
name|status
init|=
name|VXGE_HAL_INF_NO_MORE_COMPLETED_DESCRIPTORS
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|u64
name|own
decl_stmt|,
name|control_0
decl_stmt|,
name|control_1
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxd_priv
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|t_code
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", rxdh = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"rxd_priv = 0x"
name|VXGE_OS_STXFMT
literal|", t_code = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxd_priv
argument_list|,
operator|(
name|ptr_t
operator|)
name|t_code
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|rxdh
operator|=
literal|0
expr_stmt|;
operator|*
name|rxd_priv
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_try_complete
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
name|rxdh
argument_list|)
expr_stmt|;
name|rxdp
operator|=
operator|(
name|vxge_hal_ring_rxd_5_t
operator|*
operator|)
operator|*
name|rxdh
expr_stmt|;
if|if
condition|(
name|rxdp
operator|!=
name|NULL
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_DMA_REQUIRES_SYNC
argument_list|)
operator|&&
name|defined
argument_list|(
name|VXGE_HAL_DMA_RXD_STREAMING
argument_list|)
comment|/* 		 * Note: 24 bytes at most means: 		 *	- Control_3 in case of 5-buffer	mode 		 *	- Control_1 and	Control_2 		 * 		 * This is the only length needs to be invalidated 		 * type of channels. 		 */
name|priv
operator|=
name|__hal_ring_rxd_priv
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|vxge_os_dma_sync
argument_list|(
name|ring
operator|->
name|channel
operator|.
name|pdev
argument_list|,
name|priv
operator|->
name|dma_handle
argument_list|,
name|priv
operator|->
name|dma_addr
argument_list|,
name|priv
operator|->
name|dma_offset
argument_list|,
literal|24
argument_list|,
name|VXGE_OS_DMA_DIR_FROMDEVICE
argument_list|)
expr_stmt|;
endif|#
directive|endif
operator|*
name|t_code
operator|=
operator|(
name|u8
operator|)
name|VXGE_HAL_RING_RXD_T_CODE_GET
argument_list|(
name|rxdp
operator|->
name|control_0
argument_list|)
expr_stmt|;
name|control_0
operator|=
name|rxdp
operator|->
name|control_0
expr_stmt|;
name|control_1
operator|=
name|rxdp
operator|->
name|control_1
expr_stmt|;
name|own
operator|=
name|control_0
operator|&
name|VXGE_HAL_RING_RXD_LIST_OWN_ADAPTER
expr_stmt|;
comment|/* check whether it is not the end */
if|if
condition|(
operator|(
operator|!
name|own
operator|&&
operator|!
operator|(
name|control_1
operator|&
name|VXGE_HAL_RING_RXD_LIST_TAIL_OWN_ADAPTER
operator|)
operator|)
operator|||
operator|(
operator|*
name|t_code
operator|==
name|VXGE_HAL_RING_RXD_T_CODE_FRM_DROP
operator|)
condition|)
block|{
ifndef|#
directive|ifndef
name|VXGE_HAL_IRQ_POLLING
if|if
condition|(
operator|++
name|ring
operator|->
name|cmpl_cnt
operator|>
name|ring
operator|->
name|indicate_max_pkts
condition|)
block|{
comment|/* 				 * reset it. since we don't want to return 				 * garbage to the ULD 				 */
operator|*
name|rxdh
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|VXGE_HAL_COMPLETIONS_REMAIN
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
name|__hal_channel_dtr_complete
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|)
expr_stmt|;
operator|*
name|rxd_priv
operator|=
name|VXGE_HAL_RING_ULD_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
expr_stmt|;
name|ring
operator|->
name|rxd_mem_avail
operator|+=
operator|(
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdp
argument_list|)
operator|)
operator|->
name|db_bytes
expr_stmt|;
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_max
operator|<
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
condition|)
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_max
operator|=
name|ring
operator|->
name|stats
operator|->
name|common_stats
operator|.
name|usage_cnt
expr_stmt|;
switch|switch
condition|(
name|ring
operator|->
name|buffer_mode
condition|)
block|{
case|case
name|VXGE_HAL_RING_RXD_BUFFER_MODE_1
case|:
name|ring
operator|->
name|channel
operator|.
name|poll_bytes
operator|+=
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_1_BUFFER0_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_RING_RXD_BUFFER_MODE_3
case|:
name|ring
operator|->
name|channel
operator|.
name|poll_bytes
operator|+=
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_3_BUFFER0_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
operator|+
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_3_BUFFER1_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
operator|+
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_3_BUFFER2_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VXGE_HAL_RING_RXD_BUFFER_MODE_5
case|:
name|ring
operator|->
name|channel
operator|.
name|poll_bytes
operator|+=
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_5_BUFFER0_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
operator|+
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_5_BUFFER1_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
operator|+
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_5_BUFFER2_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_1
argument_list|)
operator|+
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_5_BUFFER3_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
operator|+
operator|(
name|u32
operator|)
name|VXGE_HAL_RING_RXD_5_BUFFER4_SIZE_GET
argument_list|(
name|rxdp
operator|->
name|control_2
argument_list|)
expr_stmt|;
break|break;
block|}
name|status
operator|=
name|VXGE_HAL_OK
expr_stmt|;
ifndef|#
directive|ifndef
name|VXGE_HAL_IRQ_POLLING
block|}
endif|#
directive|endif
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_handle_tcode - Handle transfer code.  * @vpath_handle: Virtual Path handle.  * @rxdh: Descriptor handle.  * @t_code: One of the enumerated (and documented in the X3100 user guide)  *	 "transfer codes".  *  * Handle descriptor's transfer code. The latter comes with each completed  * descriptor.  *  * Returns: one of the vxge_hal_status_e {} enumerated types.  * VXGE_HAL_OK			- for success.  * VXGE_HAL_ERR_CRITICAL	- when encounters critical error.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_ring_handle_tcode
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|,
name|u8
name|t_code
parameter_list|)
block|{
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"rxdh = 0x"
name|VXGE_OS_STXFMT
literal|", t_code = 0x%d"
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|,
name|t_code
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|t_code
condition|)
block|{
case|case
literal|0x0
case|:
comment|/* 0x0: Transfer ok. */
break|break;
case|case
literal|0x1
case|:
comment|/* 		 * 0x1: Layer 3 checksum presentation 		 *	configuration mismatch. 		 */
break|break;
case|case
literal|0x2
case|:
comment|/* 		 * 0x2: Layer 4 checksum presentation 		 *	configuration mismatch. 		 */
break|break;
case|case
literal|0x3
case|:
comment|/* 		 * 0x3: Layer 3 and Layer 4 checksum 		 *	presentation configuration mismatch. 		 */
break|break;
case|case
literal|0x4
case|:
comment|/* 0x4: Reserved. */
break|break;
case|case
literal|0x5
case|:
comment|/* 		 * 0x5: Layer 3 error unparseable packet, 		 *	such as unknown IPv6 header. 		 */
break|break;
case|case
literal|0x6
case|:
comment|/* 		 * 0x6: Layer 2 error frame integrity 		 *	error, such as FCS or ECC). 		 */
break|break;
case|case
literal|0x7
case|:
comment|/* 		 * 0x7: Buffer size error the RxD buffer(s) 		 *	were not appropriately sized and 		 *	data loss occurred. 		 */
break|break;
case|case
literal|0x8
case|:
comment|/* 0x8: Internal ECC error RxD corrupted. */
name|__hal_device_handle_error
argument_list|(
name|vp
operator|->
name|vpath
operator|->
name|hldev
argument_list|,
name|vp
operator|->
name|vpath
operator|->
name|vp_id
argument_list|,
name|VXGE_HAL_EVENT_ECCERR
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9
case|:
comment|/* 		 * 0x9: Benign overflow the contents of 		 *	Segment1 exceeded the capacity of 		 *	Buffer1 and the remainder was placed 		 *	in Buffer2. Segment2 now starts in 		 *	Buffer3. No data loss or errors occurred. 		 */
break|break;
case|case
literal|0xA
case|:
comment|/* 		 * 0xA: Buffer size 0 one of the RxDs 		 *	assigned buffers has a size of 0 bytes. 		 */
break|break;
case|case
literal|0xB
case|:
comment|/* 0xB: Reserved. */
break|break;
case|case
literal|0xC
case|:
comment|/* 		 * 0xC: Frame dropped either due to 		 *	VPath Reset or because of a VPIN mismatch. 		 */
break|break;
case|case
literal|0xD
case|:
comment|/* 0xD: Reserved. */
break|break;
case|case
literal|0xE
case|:
comment|/* 0xE: Reserved. */
break|break;
case|case
literal|0xF
case|:
comment|/* 		 * 0xF: Multiple errors more than one 		 *	transfer code condition occurred. 		 */
break|break;
default|default:
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_INVALID_TCODE
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_INVALID_TCODE
operator|)
return|;
block|}
name|vp
operator|->
name|vpath
operator|->
name|sw_stats
operator|->
name|ring_stats
operator|.
name|rxd_t_code_err_cnt
index|[
name|t_code
index|]
operator|++
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_OK
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_private_get - Get ULD private per-descriptor data.  * @vpath_handle: Virtual Path handle.  * @rxdh: Descriptor handle.  *  * Returns: private ULD	info associated	with the descriptor.  * ULD requests	per-descriptor space via vxge_hal_ring_attr.  *  */
end_comment

begin_function
name|void
modifier|*
name|vxge_hal_ring_rxd_private_get
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|)
block|{
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
return|return
operator|(
name|VXGE_HAL_RING_ULD_PRIV
argument_list|(
operator|(
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
operator|)
argument_list|,
name|rxdh
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_ring_rxd_free - Free descriptor.  * @vpath_handle: Virtual Path handle.  * @rxdh: Descriptor handle.  *  * Free	the reserved descriptor. This operation is "symmetrical" to  * vxge_hal_ring_rxd_reserve. The "free-ing" completes the descriptor's  * lifecycle.  *  * After free-ing (see vxge_hal_ring_rxd_free()) the descriptor again can  * be:  *  * - reserved (vxge_hal_ring_rxd_reserve);  *  * - posted	(vxge_hal_ring_rxd_post);  *  * - completed (vxge_hal_ring_rxd_next_completed);  *  * - and recycled again	(vxge_hal_ring_rxd_free).  *  * For alternative state transitions and more details please refer to  * the design doc.  *  */
end_comment

begin_function
name|void
name|vxge_hal_ring_rxd_free
parameter_list|(
name|vxge_hal_vpath_h
name|vpath_handle
parameter_list|,
name|vxge_hal_rxd_h
name|rxdh
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|unsigned
name|long
name|flags
decl_stmt|;
endif|#
directive|endif
name|__hal_ring_t
modifier|*
name|ring
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|__hal_vpath_handle_t
modifier|*
name|vp
init|=
operator|(
name|__hal_vpath_handle_t
operator|*
operator|)
name|vpath_handle
decl_stmt|;
name|vxge_assert
argument_list|(
operator|(
name|vpath_handle
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|rxdh
operator|!=
name|NULL
operator|)
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|hldev
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_ring
argument_list|(
literal|"vpath_handle = 0x"
name|VXGE_OS_STXFMT
literal|", rxdh = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|vpath_handle
argument_list|,
operator|(
name|ptr_t
operator|)
name|rxdh
argument_list|)
expr_stmt|;
name|ring
operator|=
operator|(
name|__hal_ring_t
operator|*
operator|)
name|vp
operator|->
name|vpath
operator|->
name|ringh
expr_stmt|;
name|vxge_assert
argument_list|(
name|ring
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_lock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_lock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|__hal_channel_dtr_free
argument_list|(
operator|&
name|ring
operator|->
name|channel
argument_list|,
name|VXGE_HAL_RING_RXD_INDEX
argument_list|(
name|rxdh
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_MEMORY_CHECK
argument_list|)
name|VXGE_HAL_RING_HAL_PRIV
argument_list|(
name|ring
argument_list|,
name|rxdh
argument_list|)
operator|->
name|allocated
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST
argument_list|)
name|vxge_os_spin_unlock
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|VXGE_HAL_RX_MULTI_POST_IRQ
argument_list|)
name|vxge_os_spin_unlock_irq
argument_list|(
operator|&
name|ring
operator|->
name|channel
operator|.
name|post_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vxge_hal_trace_log_ring
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxgehal/vxgehal.h>
end_include

begin_comment
comment|/*  * __hal_mempool_grow  *  * Will resize mempool up to %num_allocate value.  */
end_comment

begin_function
specifier|static
name|vxge_hal_status_e
name|__hal_mempool_grow
parameter_list|(
name|vxge_hal_mempool_t
modifier|*
name|mempool
parameter_list|,
name|u32
name|num_allocate
parameter_list|,
name|u32
modifier|*
name|num_allocated
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|item_index
decl_stmt|,
name|is_last
decl_stmt|;
name|u32
name|first_time
init|=
name|mempool
operator|->
name|memblocks_allocated
operator|==
literal|0
condition|?
literal|1
else|:
literal|0
decl_stmt|;
name|u32
name|n_items
init|=
name|mempool
operator|->
name|items_per_memblock
decl_stmt|;
name|u32
name|start_block_idx
init|=
name|mempool
operator|->
name|memblocks_allocated
decl_stmt|;
name|u32
name|end_block_idx
init|=
name|mempool
operator|->
name|memblocks_allocated
operator|+
name|num_allocate
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
name|mempool
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"mempool = 0x"
name|VXGE_OS_STXFMT
literal|", num_allocate = %d, "
literal|"num_allocated = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempool
argument_list|,
name|num_allocate
argument_list|,
operator|(
name|ptr_t
operator|)
name|num_allocated
argument_list|)
expr_stmt|;
operator|*
name|num_allocated
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|end_block_idx
operator|>
name|mempool
operator|->
name|memblocks_max
condition|)
block|{
name|vxge_hal_err_log_mm
argument_list|(
literal|"%s"
argument_list|,
literal|"__hal_mempool_grow: can grow anymore"
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
name|start_block_idx
init|;
name|i
operator|<
name|end_block_idx
condition|;
name|i
operator|++
control|)
block|{
name|void
modifier|*
name|the_memblock
decl_stmt|;
name|vxge_hal_mempool_dma_t
modifier|*
name|dma_object
decl_stmt|;
name|is_last
operator|=
operator|(
operator|(
name|end_block_idx
operator|-
literal|1
operator|)
operator|==
name|i
operator|)
expr_stmt|;
name|dma_object
operator|=
name|mempool
operator|->
name|memblocks_dma_arr
operator|+
name|i
expr_stmt|;
comment|/* 		 * allocate memblock's private part. Each DMA memblock 		 * has a space allocated for item's private usage upon 		 * mempool's user request. Each time mempool grows, it will 		 * allocate new memblock and its private part at once. 		 * This helps to minimize memory usage a lot. 		 */
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
operator|=
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_err_log_mm
argument_list|(
literal|"memblock_priv[%d]: \ 			    out of virtual memory, "
literal|"requested %d(%d:%d) bytes"
argument_list|,
name|i
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|,
name|mempool
operator|->
name|items_priv_size
argument_list|,
name|n_items
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
comment|/* allocate DMA-capable memblock */
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
operator|=
name|__hal_blockpool_malloc
argument_list|(
name|mempool
operator|->
name|devh
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
operator|&
name|dma_object
operator|->
name|addr
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|vxge_os_free
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
name|vxge_hal_err_log_mm
argument_list|(
literal|"memblock[%d]: \ 			    out of DMA memory"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_ERR_OUT_OF_MEMORY
operator|)
return|;
block|}
operator|(
operator|*
name|num_allocated
operator|)
operator|++
expr_stmt|;
name|mempool
operator|->
name|memblocks_allocated
operator|++
expr_stmt|;
name|vxge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|)
expr_stmt|;
name|the_memblock
operator|=
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
expr_stmt|;
comment|/* fill the items hash array */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n_items
condition|;
name|j
operator|++
control|)
block|{
name|item_index
operator|=
name|i
operator|*
name|n_items
operator|+
name|j
expr_stmt|;
if|if
condition|(
name|first_time
operator|&&
operator|(
name|item_index
operator|>=
name|mempool
operator|->
name|items_initial
operator|)
condition|)
break|break;
name|mempool
operator|->
name|items_arr
index|[
name|item_index
index|]
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
name|the_memblock
operator|+
name|j
operator|*
name|mempool
operator|->
name|item_size
operator|)
expr_stmt|;
comment|/* let caller to do more job on each item */
if|if
condition|(
name|mempool
operator|->
name|item_func_alloc
operator|!=
name|NULL
condition|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|mempool
operator|->
name|item_func_alloc
argument_list|(
name|mempool
argument_list|,
name|the_memblock
argument_list|,
name|i
argument_list|,
name|dma_object
argument_list|,
name|mempool
operator|->
name|items_arr
index|[
name|item_index
index|]
argument_list|,
name|item_index
argument_list|,
name|is_last
argument_list|,
name|mempool
operator|->
name|userdata
argument_list|)
operator|)
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
if|if
condition|(
name|mempool
operator|->
name|item_func_free
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|j
condition|;
name|k
operator|++
control|)
block|{
name|item_index
operator|=
name|i
operator|*
name|n_items
operator|+
name|k
expr_stmt|;
operator|(
name|void
operator|)
name|mempool
operator|->
name|item_func_free
argument_list|(
name|mempool
argument_list|,
name|the_memblock
argument_list|,
name|i
argument_list|,
name|dma_object
argument_list|,
name|mempool
operator|->
name|items_arr
index|[
name|item_index
index|]
argument_list|,
name|item_index
argument_list|,
name|is_last
argument_list|,
name|mempool
operator|->
name|userdata
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_os_free
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|n_items
argument_list|)
expr_stmt|;
name|__hal_blockpool_free
argument_list|(
name|mempool
operator|->
name|devh
argument_list|,
name|the_memblock
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
operator|&
name|dma_object
operator|->
name|addr
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|)
expr_stmt|;
operator|(
operator|*
name|num_allocated
operator|)
operator|--
expr_stmt|;
name|mempool
operator|->
name|memblocks_allocated
operator|--
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
block|}
name|mempool
operator|->
name|items_current
operator|=
name|item_index
operator|+
literal|1
expr_stmt|;
block|}
name|vxge_hal_info_log_mm
argument_list|(
literal|"memblock%d: allocated %dk, vaddr 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"dma_addr 0x"
name|VXGE_OS_STXFMT
argument_list|,
name|i
argument_list|,
name|mempool
operator|->
name|memblock_size
operator|/
literal|1024
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
name|dma_object
operator|->
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|first_time
operator|&&
name|mempool
operator|->
name|items_current
operator|==
name|mempool
operator|->
name|items_initial
condition|)
block|{
break|break;
block|}
block|}
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mempool_create  * @memblock_size:  * @items_initial:  * @items_max:  * @item_size:  * @item_func:  *  * This function will create memory pool object. Pool may grow but will  * never shrink. Pool consists of number of dynamically allocated blocks  * with size enough to hold %items_initial number of items. Memory is  * DMA-able but client must map/unmap before interoperating with the device.  * See also: vxge_os_dma_map(), vxge_hal_dma_unmap(), vxge_hal_status_e {}.  */
end_comment

begin_function
name|vxge_hal_mempool_t
modifier|*
name|vxge_hal_mempool_create
parameter_list|(
name|vxge_hal_device_h
name|devh
parameter_list|,
name|u32
name|memblock_size
parameter_list|,
name|u32
name|item_size
parameter_list|,
name|u32
name|items_priv_size
parameter_list|,
name|u32
name|items_initial
parameter_list|,
name|u32
name|items_max
parameter_list|,
name|vxge_hal_mempool_item_f
name|item_func_alloc
parameter_list|,
name|vxge_hal_mempool_item_f
name|item_func_free
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
name|u32
name|memblocks_to_allocate
decl_stmt|;
name|vxge_hal_mempool_t
modifier|*
name|mempool
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|u32
name|allocated
decl_stmt|;
name|vxge_assert
argument_list|(
name|devh
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"devh = 0x"
name|VXGE_OS_STXFMT
literal|", memblock_size = %d, item_size = %d, "
literal|"items_priv_size = %d, items_initial = %d, items_max = %d, "
literal|"item_func_alloc = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"item_func_free = 0x"
name|VXGE_OS_STXFMT
literal|", "
literal|"userdata = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|devh
argument_list|,
name|memblock_size
argument_list|,
name|item_size
argument_list|,
name|items_priv_size
argument_list|,
name|items_initial
argument_list|,
name|items_max
argument_list|,
operator|(
name|ptr_t
operator|)
name|item_func_alloc
argument_list|,
operator|(
name|ptr_t
operator|)
name|item_func_free
argument_list|,
operator|(
name|ptr_t
operator|)
name|userdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|memblock_size
operator|<
name|item_size
condition|)
block|{
name|vxge_hal_err_log_mm
argument_list|(
literal|"memblock_size %d< item_size %d: misconfiguration"
argument_list|,
name|memblock_size
argument_list|,
name|item_size
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_FAIL
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|mempool
operator|=
operator|(
name|vxge_hal_mempool_t
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mempool_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|mempool
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mempool_t
argument_list|)
argument_list|)
expr_stmt|;
name|mempool
operator|->
name|devh
operator|=
name|devh
expr_stmt|;
name|mempool
operator|->
name|memblock_size
operator|=
name|memblock_size
expr_stmt|;
name|mempool
operator|->
name|items_max
operator|=
name|items_max
expr_stmt|;
name|mempool
operator|->
name|items_initial
operator|=
name|items_initial
expr_stmt|;
name|mempool
operator|->
name|item_size
operator|=
name|item_size
expr_stmt|;
name|mempool
operator|->
name|items_priv_size
operator|=
name|items_priv_size
expr_stmt|;
name|mempool
operator|->
name|item_func_alloc
operator|=
name|item_func_alloc
expr_stmt|;
name|mempool
operator|->
name|item_func_free
operator|=
name|item_func_free
expr_stmt|;
name|mempool
operator|->
name|userdata
operator|=
name|userdata
expr_stmt|;
name|mempool
operator|->
name|memblocks_allocated
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|memblock_size
operator|!=
name|VXGE_OS_HOST_PAGE_SIZE
condition|)
name|mempool
operator|->
name|dma_flags
operator|=
name|VXGE_OS_DMA_CACHELINE_ALIGNED
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_HAL_DMA_CONSISTENT
argument_list|)
name|mempool
operator|->
name|dma_flags
operator||=
name|VXGE_OS_DMA_CONSISTENT
expr_stmt|;
else|#
directive|else
name|mempool
operator|->
name|dma_flags
operator||=
name|VXGE_OS_DMA_STREAMING
expr_stmt|;
endif|#
directive|endif
name|mempool
operator|->
name|items_per_memblock
operator|=
name|memblock_size
operator|/
name|item_size
expr_stmt|;
name|mempool
operator|->
name|memblocks_max
operator|=
operator|(
name|items_max
operator|+
name|mempool
operator|->
name|items_per_memblock
operator|-
literal|1
operator|)
operator|/
name|mempool
operator|->
name|items_per_memblock
expr_stmt|;
comment|/* allocate array of memblocks */
name|mempool
operator|->
name|memblocks_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_arr
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
comment|/* allocate array of private parts of items per memblocks */
name|mempool
operator|->
name|memblocks_priv_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_priv_arr
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_priv_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
comment|/* allocate array of memblocks DMA objects */
name|mempool
operator|->
name|memblocks_dma_arr
operator|=
operator|(
name|vxge_hal_mempool_dma_t
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mempool_dma_t
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|memblocks_dma_arr
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|mempool
operator|->
name|memblocks_dma_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mempool_dma_t
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
comment|/* allocate hash array of items */
name|mempool
operator|->
name|items_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|items_arr
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|mempool
operator|->
name|items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
name|mempool
operator|->
name|shadow_items_arr
operator|=
operator|(
name|void
operator|*
operator|*
operator|)
name|vxge_os_malloc
argument_list|(
operator|(
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
operator|)
operator|->
name|header
operator|.
name|pdev
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|mempool
operator|->
name|shadow_items_arr
operator|==
name|NULL
condition|)
block|{
name|vxge_hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|vxge_os_memzero
argument_list|(
name|mempool
operator|->
name|shadow_items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
comment|/* calculate initial number of memblocks */
name|memblocks_to_allocate
operator|=
operator|(
name|mempool
operator|->
name|items_initial
operator|+
name|mempool
operator|->
name|items_per_memblock
operator|-
literal|1
operator|)
operator|/
name|mempool
operator|->
name|items_per_memblock
expr_stmt|;
name|vxge_hal_info_log_mm
argument_list|(
literal|"allocating %d memblocks, "
literal|"%d items per memblock"
argument_list|,
name|memblocks_to_allocate
argument_list|,
name|mempool
operator|->
name|items_per_memblock
argument_list|)
expr_stmt|;
comment|/* pre-allocate the mempool */
name|status
operator|=
name|__hal_mempool_grow
argument_list|(
name|mempool
argument_list|,
name|memblocks_to_allocate
argument_list|,
operator|&
name|allocated
argument_list|)
expr_stmt|;
name|vxge_os_memcpy
argument_list|(
name|mempool
operator|->
name|shadow_items_arr
argument_list|,
name|mempool
operator|->
name|items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VXGE_HAL_OK
condition|)
block|{
name|vxge_hal_mempool_destroy
argument_list|(
name|mempool
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: %d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|VXGE_HAL_ERR_OUT_OF_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|vxge_hal_info_log_mm
argument_list|(
literal|"total: allocated %dk of DMA-capable memory"
argument_list|,
name|mempool
operator|->
name|memblock_size
operator|*
name|allocated
operator|/
literal|1024
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
return|return
operator|(
name|mempool
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_mempool_destroy  */
end_comment

begin_function
name|void
name|vxge_hal_mempool_destroy
parameter_list|(
name|vxge_hal_mempool_t
modifier|*
name|mempool
parameter_list|)
block|{
name|u32
name|i
decl_stmt|,
name|j
decl_stmt|,
name|item_index
decl_stmt|;
name|__hal_device_t
modifier|*
name|hldev
decl_stmt|;
name|vxge_assert
argument_list|(
name|mempool
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|hldev
operator|=
operator|(
name|__hal_device_t
operator|*
operator|)
name|mempool
operator|->
name|devh
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"==> %s:%s:%d"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"mempool = 0x"
name|VXGE_OS_STXFMT
argument_list|,
operator|(
name|ptr_t
operator|)
name|mempool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mempool
operator|->
name|memblocks_allocated
condition|;
name|i
operator|++
control|)
block|{
name|vxge_hal_mempool_dma_t
modifier|*
name|dma_object
decl_stmt|;
name|vxge_assert
argument_list|(
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vxge_assert
argument_list|(
name|mempool
operator|->
name|memblocks_dma_arr
operator|+
name|i
argument_list|)
expr_stmt|;
name|dma_object
operator|=
name|mempool
operator|->
name|memblocks_dma_arr
operator|+
name|i
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|mempool
operator|->
name|items_per_memblock
condition|;
name|j
operator|++
control|)
block|{
name|item_index
operator|=
name|i
operator|*
name|mempool
operator|->
name|items_per_memblock
operator|+
name|j
expr_stmt|;
comment|/* to skip last partially filled(if any) memblock */
if|if
condition|(
name|item_index
operator|>=
name|mempool
operator|->
name|items_current
condition|)
break|break;
comment|/* let caller to do more job on each item */
if|if
condition|(
name|mempool
operator|->
name|item_func_free
operator|!=
name|NULL
condition|)
block|{
name|mempool
operator|->
name|item_func_free
argument_list|(
name|mempool
argument_list|,
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
name|dma_object
argument_list|,
name|mempool
operator|->
name|shadow_items_arr
index|[
name|item_index
index|]
argument_list|,
name|item_index
argument_list|,
comment|/* unused */
operator|-
literal|1
argument_list|,
name|mempool
operator|->
name|userdata
argument_list|)
expr_stmt|;
block|}
block|}
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|items_priv_size
operator|*
name|mempool
operator|->
name|items_per_memblock
argument_list|)
expr_stmt|;
name|__hal_blockpool_free
argument_list|(
name|hldev
argument_list|,
name|mempool
operator|->
name|memblocks_arr
index|[
name|i
index|]
argument_list|,
name|mempool
operator|->
name|memblock_size
argument_list|,
operator|&
name|dma_object
operator|->
name|addr
argument_list|,
operator|&
name|dma_object
operator|->
name|handle
argument_list|,
operator|&
name|dma_object
operator|->
name|acc_handle
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|items_arr
condition|)
block|{
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|shadow_items_arr
condition|)
block|{
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|shadow_items_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|items_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|memblocks_dma_arr
condition|)
block|{
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_dma_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mempool_dma_t
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|memblocks_priv_arr
condition|)
block|{
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_priv_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mempool
operator|->
name|memblocks_arr
condition|)
block|{
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
operator|->
name|memblocks_arr
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|mempool
operator|->
name|memblocks_max
argument_list|)
expr_stmt|;
block|}
name|vxge_os_free
argument_list|(
name|hldev
operator|->
name|header
operator|.
name|pdev
argument_list|,
name|mempool
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_mempool_t
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_hal_trace_log_mm
argument_list|(
literal|"<== %s:%s:%d  Result: 0"
argument_list|,
name|__FILE__
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_check_alignment - Check buffer alignment	and	calculate the  * "misaligned"	portion.  * @dma_pointer: DMA address of	the	buffer.  * @size: Buffer size, in bytes.  * @alignment: Alignment "granularity" (see	below),	in bytes.  * @copy_size: Maximum number of bytes to "extract"	from the buffer  * (in order to	spost it as	a separate scatter-gather entry). See below.  *  * Check buffer	alignment and calculate	"misaligned" portion, if exists.  * The buffer is considered	aligned	if its address is multiple of  * the specified @alignment. If	this is	the	case,  * vxge_hal_check_alignment() returns zero.  * Otherwise, vxge_hal_check_alignment()	uses the last argument,  * @copy_size,  * to calculate	the	size to	"extract" from the buffer. The @copy_size  * may or may not be equal @alignment. The difference between these	two  * arguments is	that the @alignment is used to make the decision: aligned  * or not aligned. While the @copy_size	is used	to calculate the portion  * of the buffer to "extract", i.e.	to post	as a separate entry in the  * transmit descriptor.	For example, the combination  * @alignment = 8 and @copy_size = 64 will work	okay on	AMD Opteron boxes.  *  * Note: @copy_size should be a	multiple of @alignment.	In many	practical  * cases @copy_size and	@alignment will	probably be equal.  *  * See also: vxge_hal_fifo_txdl_buffer_set_aligned().  */
end_comment

begin_function
name|u32
name|vxge_hal_check_alignment
parameter_list|(
name|dma_addr_t
name|dma_pointer
parameter_list|,
name|u32
name|size
parameter_list|,
name|u32
name|alignment
parameter_list|,
name|u32
name|copy_size
parameter_list|)
block|{
name|u32
name|misaligned_size
decl_stmt|;
name|misaligned_size
operator|=
call|(
name|int
call|)
argument_list|(
name|dma_pointer
operator|&
operator|(
name|alignment
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|misaligned_size
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|size
operator|>
name|copy_size
condition|)
block|{
name|misaligned_size
operator|=
call|(
name|int
call|)
argument_list|(
name|dma_pointer
operator|&
operator|(
name|copy_size
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|misaligned_size
operator|=
name|copy_size
operator|-
name|misaligned_size
expr_stmt|;
block|}
else|else
block|{
name|misaligned_size
operator|=
name|size
expr_stmt|;
block|}
return|return
operator|(
name|misaligned_size
operator|)
return|;
block|}
end_function

end_unit


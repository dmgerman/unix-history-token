begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * SPDX-License-Identifier: BSD-3-Clause  *  * Copyright(c) 2002-2011 Exar Corp.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification are permitted provided the following conditions are met:  *  *    1. Redistributions of source code must retain the above copyright notice,  *       this list of conditions and the following disclaimer.  *  *    2. Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *  *    3. Neither the name of the Exar Corporation nor the names of its  *       contributors may be used to endorse or promote products derived from  *       this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*$FreeBSD$*/
end_comment

begin_include
include|#
directive|include
file|<dev/vxge/vxgehal/vxgehal.h>
end_include

begin_decl_stmt
specifier|static
name|__hal_driver_t
name|g_driver
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__hal_driver_t
modifier|*
name|g_vxge_hal_driver
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_MEMORY_CHECK
argument_list|)
end_if

begin_decl_stmt
name|vxge_os_malloc_t
name|g_malloc_arr
index|[
name|VXGE_OS_MALLOC_CNT_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u32
name|g_malloc_cnt
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Runtime tracing support  */
end_comment

begin_decl_stmt
name|u32
name|g_debug_level
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * vxge_hal_driver_initialize - Initialize HAL.  * @config: HAL configuration, see vxge_hal_driver_config_t {}.  * @uld_callbacks: Upper-layer driver callbacks, e.g. link-up.  *  * HAL initialization entry point. Not to confuse with device initialization  * (note that HAL "contains" zero or more X3100 devices).  *  * Returns: VXGE_HAL_OK - success;  * VXGE_HAL_ERR_BAD_DRIVER_CONFIG - Driver configuration params invalid.  *  * See also: vxge_hal_device_initialize(), vxge_hal_status_e {},  * vxge_hal_uld_cbs_t {}.  */
end_comment

begin_function
name|vxge_hal_status_e
name|vxge_hal_driver_initialize
parameter_list|(
name|vxge_hal_driver_config_t
modifier|*
name|config
parameter_list|,
name|vxge_hal_uld_cbs_t
modifier|*
name|uld_callbacks
parameter_list|)
block|{
name|vxge_hal_status_e
name|status
decl_stmt|;
name|g_vxge_hal_driver
operator|=
operator|&
name|g_driver
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|vxge_hal_driver_config_check
argument_list|(
name|config
argument_list|)
operator|)
operator|!=
name|VXGE_HAL_OK
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|vxge_os_memzero
argument_list|(
name|g_vxge_hal_driver
argument_list|,
sizeof|sizeof
argument_list|(
name|__hal_driver_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* apply config */
name|vxge_os_memcpy
argument_list|(
operator|&
name|g_vxge_hal_driver
operator|->
name|config
argument_list|,
name|config
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_driver_config_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* apply ULD callbacks */
name|vxge_os_memcpy
argument_list|(
operator|&
name|g_vxge_hal_driver
operator|->
name|uld_callbacks
argument_list|,
name|uld_callbacks
argument_list|,
sizeof|sizeof
argument_list|(
name|vxge_hal_uld_cbs_t
argument_list|)
argument_list|)
expr_stmt|;
name|vxge_hal_driver_debug_set
argument_list|(
name|config
operator|->
name|level
argument_list|)
expr_stmt|;
name|g_vxge_hal_driver
operator|->
name|is_initialized
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|VXGE_HAL_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * vxge_hal_driver_terminate - Terminate HAL.  *  * HAL termination entry point.  *  * See also: vxge_hal_device_terminate().  */
end_comment

begin_function
name|void
name|vxge_hal_driver_terminate
parameter_list|(
name|void
parameter_list|)
block|{
name|g_vxge_hal_driver
operator|->
name|is_initialized
operator|=
literal|0
expr_stmt|;
name|g_vxge_hal_driver
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|VXGE_OS_MEMORY_CHECK
argument_list|)
if|if
condition|(
name|TRUE
condition|)
block|{
name|u32
name|i
decl_stmt|,
name|leaks
init|=
literal|0
decl_stmt|;
name|vxge_os_printf
argument_list|(
literal|"OSPAL: max g_malloc_cnt %d\n"
argument_list|,
name|g_malloc_cnt
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|g_malloc_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|ptr
operator|!=
name|NULL
condition|)
block|{
name|vxge_os_printf
argument_list|(
literal|"OSPAL: memory leak detected at "
literal|"%s:%lu:"
name|VXGE_OS_LLXFMT
literal|":%lu\n"
argument_list|,
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|file
argument_list|,
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|line
argument_list|,
operator|(
name|u64
operator|)
operator|(
name|ptr_t
operator|)
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|ptr
argument_list|,
name|g_malloc_arr
index|[
name|i
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
name|leaks
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|leaks
condition|)
block|{
name|vxge_os_printf
argument_list|(
literal|"OSPAL: %d memory leaks detected\n"
argument_list|,
name|leaks
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vxge_os_println
argument_list|(
literal|"OSPAL: no memory leaks detected\n"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * vxge_hal_driver_debug_set - Set the debug module, level and timestamp  * @level: Debug level as defined in enum vxge_debug_level_e  *  * This routine is used to dynamically change the debug output  */
end_comment

begin_function
name|void
name|vxge_hal_driver_debug_set
parameter_list|(
name|vxge_debug_level_e
name|level
parameter_list|)
block|{
name|g_vxge_hal_driver
operator|->
name|debug_level
operator|=
name|level
expr_stmt|;
name|g_debug_level
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|level
condition|)
block|{
comment|/* FALLTHRU */
case|case
name|VXGE_TRACE
case|:
name|g_debug_level
operator||=
name|VXGE_TRACE
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VXGE_INFO
case|:
name|g_debug_level
operator||=
name|VXGE_INFO
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VXGE_ERR
case|:
name|g_debug_level
operator||=
name|VXGE_ERR
expr_stmt|;
comment|/* FALLTHRU */
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * vxge_hal_driver_debug_get - Get the debug level  *  * This routine returns the current debug level set  */
end_comment

begin_function
name|u32
name|vxge_hal_driver_debug_get
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|g_vxge_hal_driver
operator|->
name|debug_level
operator|)
return|;
block|}
end_function

end_unit


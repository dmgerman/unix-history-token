begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2005-2010 Daniel Braniss<danny@cs.huji.ac.il>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/*  | $Id: iscsi.c 752 2009-08-20 11:23:28Z danny $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_iscsi_initiator.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/capability.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/protosw.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<dev/iscsi/initiator/iscsi.h>
end_include

begin_include
include|#
directive|include
file|<dev/iscsi/initiator/iscsivar.h>
end_include

begin_decl_stmt
specifier|static
name|char
modifier|*
name|iscsi_driver_version
init|=
literal|"2.2.4.2"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|isc_softc
modifier|*
name|isc
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_ISCSI
argument_list|,
literal|"iSCSI"
argument_list|,
literal|"iSCSI driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_ISCSIBUF
argument_list|,
literal|"iSCbuf"
argument_list|,
literal|"iSCSI buffers"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_TMP
argument_list|,
literal|"iSCtmp"
argument_list|,
literal|"iSCSI tmp"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|ISCSI_INITIATOR_DEBUG
end_ifdef

begin_decl_stmt
name|int
name|iscsi_debug
init|=
name|ISCSI_INITIATOR_DEBUG
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_debug
argument_list|,
name|OID_AUTO
argument_list|,
name|iscsi_initiator
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|iscsi_debug
argument_list|,
literal|0
argument_list|,
literal|"iSCSI driver debug flag"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|mtx
name|iscsi_dbg_mtx
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|max_sessions
init|=
name|MAX_SESSIONS
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_net
argument_list|,
name|OID_AUTO
argument_list|,
name|iscsi_initiator_max_sessions
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|max_sessions
argument_list|,
name|MAX_SESSIONS
argument_list|,
literal|"Max sessions allowed"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|max_pdus
init|=
name|MAX_PDUS
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_net
argument_list|,
name|OID_AUTO
argument_list|,
name|iscsi_initiator_max_pdus
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|max_pdus
argument_list|,
name|MAX_PDUS
argument_list|,
literal|"Max pdu pool"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|isid
index|[
literal|6
operator|+
literal|1
index|]
init|=
block|{
literal|0x80
block|,
literal|'D'
block|,
literal|'I'
block|,
literal|'B'
block|,
literal|'0'
block|,
literal|'0'
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|i_create_session
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
modifier|*
name|ndev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_ping
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_send
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_recv
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_setsoc
parameter_list|(
name|isc_session_t
modifier|*
name|sp
parameter_list|,
name|int
name|fd
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_fullfeature
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flag
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|d_open_t
name|iscsi_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|iscsi_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|iscsi_ioctl
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|ISCSI_INITIATOR_DEBUG
end_ifdef

begin_decl_stmt
specifier|static
name|d_read_t
name|iscsi_read
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|iscsi_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_open
operator|=
name|iscsi_open
block|,
operator|.
name|d_close
operator|=
name|iscsi_close
block|,
operator|.
name|d_ioctl
operator|=
name|iscsi_ioctl
block|,
ifdef|#
directive|ifdef
name|ISCSI_INITIATOR_DEBUG
operator|.
name|d_read
operator|=
name|iscsi_read
block|,
endif|#
directive|endif
operator|.
name|d_name
operator|=
literal|"iSCSI"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|iscsi_open
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|otype
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|7
argument_list|,
literal|"dev=%d"
argument_list|,
name|dev2unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev2unit
argument_list|(
name|dev
argument_list|)
operator|>
name|max_sessions
condition|)
block|{
comment|// should not happen
return|return
name|ENODEV
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iscsi_close
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|otyp
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|isc_session_t
modifier|*
name|sp
decl_stmt|;
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|3
argument_list|,
literal|"session=%d flag=%x"
argument_list|,
name|dev2unit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev2unit
argument_list|(
name|dev
argument_list|)
operator|==
name|max_sessions
condition|)
block|{
return|return
literal|0
return|;
block|}
name|sp
operator|=
name|dev
operator|->
name|si_drv2
expr_stmt|;
if|if
condition|(
name|sp
operator|!=
name|NULL
condition|)
block|{
name|sdebug
argument_list|(
literal|3
argument_list|,
literal|"sp->flags=%x"
argument_list|,
name|sp
operator|->
name|flags
argument_list|)
expr_stmt|;
comment|/* 	   | if still in full phase, this probably means 	   | that something went realy bad. 	   | it could be a result from 'shutdown', in which case 	   | we will ignore it (so buffers can be flushed). 	   | the problem is that there is no way of differentiating 	   | between a shutdown procedure and 'iscontrol' dying. 	   */
if|if
condition|(
name|sp
operator|->
name|flags
operator|&
name|ISC_FFPHASE
condition|)
comment|// delay in case this is a shutdown.
name|tsleep
argument_list|(
name|sp
argument_list|,
name|PRIBIO
argument_list|,
literal|"isc-cls"
argument_list|,
literal|60
operator|*
name|hz
argument_list|)
expr_stmt|;
name|ism_stop
argument_list|(
name|sp
argument_list|)
expr_stmt|;
block|}
name|debug
argument_list|(
literal|2
argument_list|,
literal|"done"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iscsi_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|isc_softc
modifier|*
name|sc
decl_stmt|;
name|isc_session_t
modifier|*
name|sp
decl_stmt|;
name|isc_opt_t
modifier|*
name|opt
decl_stmt|;
name|int
name|error
decl_stmt|;
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dev2unit
argument_list|(
name|dev
argument_list|)
operator|==
name|max_sessions
condition|)
block|{
comment|/* 	   | non Session commands 	   */
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|ISCSISETSES
case|:
name|error
operator|=
name|i_create_session
argument_list|(
name|dev
argument_list|,
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
break|break;
default|default:
name|error
operator|=
name|ENXIO
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
comment|/*       | session commands       */
name|sp
operator|=
name|dev
operator|->
name|si_drv2
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|ENXIO
return|;
name|sdebug
argument_list|(
literal|6
argument_list|,
literal|"dev=%d cmd=%d"
argument_list|,
name|dev2unit
argument_list|(
name|dev
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|cmd
operator|&
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|ISCSISETSOC
case|:
name|error
operator|=
name|i_setsoc
argument_list|(
name|sp
argument_list|,
operator|*
operator|(
name|u_int
operator|*
operator|)
name|arg
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISCSISETOPT
case|:
name|opt
operator|=
operator|(
name|isc_opt_t
operator|*
operator|)
name|arg
expr_stmt|;
name|error
operator|=
name|i_setopt
argument_list|(
name|sp
argument_list|,
name|opt
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISCSISEND
case|:
name|error
operator|=
name|i_send
argument_list|(
name|dev
argument_list|,
name|arg
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISCSIRECV
case|:
name|error
operator|=
name|i_recv
argument_list|(
name|dev
argument_list|,
name|arg
argument_list|,
name|td
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISCSIPING
case|:
name|error
operator|=
name|i_ping
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISCSISTART
case|:
name|error
operator|=
name|sp
operator|->
name|soc
operator|==
name|NULL
condition|?
name|ENOTCONN
else|:
name|i_fullfeature
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|sp
operator|->
name|proc
operator|=
name|td
operator|->
name|td_proc
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sp
operator|->
name|clist
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sp
operator|->
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pid"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sp
operator|->
name|proc
operator|->
name|p_pid
argument_list|,
sizeof|sizeof
argument_list|(
name|pid_t
argument_list|)
argument_list|,
literal|"control process id"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ISCSIRESTART
case|:
name|error
operator|=
name|sp
operator|->
name|soc
operator|==
name|NULL
condition|?
name|ENOTCONN
else|:
name|i_fullfeature
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISCSISTOP
case|:
name|error
operator|=
name|i_fullfeature
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ISCSISIGNAL
case|:
block|{
name|int
name|sig
init|=
operator|*
operator|(
name|int
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|sig
operator|<
literal|0
operator|||
name|sig
operator|>
name|_SIG_MAXSIG
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
else|else
name|sp
operator|->
name|signal
operator|=
name|sig
expr_stmt|;
break|break;
block|}
case|case
name|ISCSIGETCAM
case|:
block|{
name|iscsi_cam_t
modifier|*
name|cp
init|=
operator|(
name|iscsi_cam_t
operator|*
operator|)
name|arg
decl_stmt|;
name|error
operator|=
name|ic_getCamVals
argument_list|(
name|sp
argument_list|,
name|cp
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iscsi_read
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|ioflag
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ISCSI_INITIATOR_DEBUG
name|struct
name|isc_softc
modifier|*
name|sc
decl_stmt|;
name|isc_session_t
modifier|*
name|sp
decl_stmt|;
name|pduq_t
modifier|*
name|pq
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
name|sp
operator|=
name|dev
operator|->
name|si_drv2
expr_stmt|;
if|if
condition|(
name|dev2unit
argument_list|(
name|dev
argument_list|)
operator|==
name|max_sessions
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/----- Session ------/\n"
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|sp
argument_list|,
argument|&sc->isc_sess
argument_list|,
argument|sp_link
argument_list|)
block|{
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%03d] '%s' '%s'\n"
argument_list|,
name|i
operator|++
argument_list|,
name|sp
operator|->
name|opt
operator|.
name|targetAddress
argument_list|,
name|sp
operator|->
name|opt
operator|.
name|targetName
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d/%d /---- free -----/\n"
argument_list|,
name|sc
operator|->
name|npdu_alloc
argument_list|,
name|sc
operator|->
name|npdu_max
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
init|=
name|sp
operator|->
name|soc
decl_stmt|;
define|#
directive|define
name|pukeit
parameter_list|(
name|i
parameter_list|,
name|pq
parameter_list|)
value|do {\ 	       sprintf(buf, "%03d] %06x %02x %06x %06x %jd\n",\ 		       i, ntohl(pq->pdu.ipdu.bhs.CmdSN),\ 		       pq->pdu.ipdu.bhs.opcode, ntohl(pq->pdu.ipdu.bhs.itt),\ 		       ntohl(pq->pdu.ipdu.bhs.ExpStSN),\ 		       (intmax_t)pq->ts.sec);\ 	       } while(0)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d/%d /---- hld -----/\n"
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|nhld
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|max_hld
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->hld
argument_list|,
argument|pq_link
argument_list|)
block|{
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pukeit
argument_list|(
name|i
argument_list|,
name|pq
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d/%d /---- rsp -----/\n"
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|nrsp
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|max_rsp
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->rsp
argument_list|,
argument|pq_link
argument_list|)
block|{
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pukeit
argument_list|(
name|i
argument_list|,
name|pq
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d/%d /---- csnd -----/\n"
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|ncsnd
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|max_csnd
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->csnd
argument_list|,
argument|pq_link
argument_list|)
block|{
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pukeit
argument_list|(
name|i
argument_list|,
name|pq
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d/%d /---- wsnd -----/\n"
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|nwsnd
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|max_wsnd
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->wsnd
argument_list|,
argument|pq_link
argument_list|)
block|{
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pukeit
argument_list|(
name|i
argument_list|,
name|pq
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d/%d /---- isnd -----/\n"
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|nisnd
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|max_isnd
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->isnd
argument_list|,
argument|pq_link
argument_list|)
block|{
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|pukeit
argument_list|(
name|i
argument_list|,
name|pq
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/---- Stats ---/\n"
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"recv=%d sent=%d\n"
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|nrecv
argument_list|,
name|sp
operator|->
name|stats
operator|.
name|nsent
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"flags=%x pdus: alloc=%d max=%d\n"
argument_list|,
name|sp
operator|->
name|flags
argument_list|,
name|sc
operator|->
name|npdu_alloc
argument_list|,
name|sc
operator|->
name|npdu_max
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"cws=%d last cmd=%x exp=%x max=%x stat=%x itt=%x\n"
argument_list|,
name|sp
operator|->
name|cws
argument_list|,
name|sp
operator|->
name|sn
operator|.
name|cmd
argument_list|,
name|sp
operator|->
name|sn
operator|.
name|expCmd
argument_list|,
name|sp
operator|->
name|sn
operator|.
name|maxCmd
argument_list|,
name|sp
operator|->
name|sn
operator|.
name|stat
argument_list|,
name|sp
operator|->
name|sn
operator|.
name|itt
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/---- socket -----/\nso_count=%d so_state=%x\n"
argument_list|,
name|so
operator|->
name|so_count
argument_list|,
name|so
operator|->
name|so_state
argument_list|)
expr_stmt|;
name|uiomove
argument_list|(
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|uio
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_ping
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  | low level I/O  */
end_comment

begin_function
specifier|static
name|int
name|i_setsoc
parameter_list|(
name|isc_session_t
modifier|*
name|sp
parameter_list|,
name|int
name|fd
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sp
operator|->
name|soc
operator|!=
name|NULL
condition|)
name|isc_stop_receiver
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
name|CAP_SOCK_ALL
argument_list|,
operator|&
name|sp
operator|->
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|fgetsock
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
name|CAP_SOCK_ALL
argument_list|,
operator|&
name|sp
operator|->
name|soc
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|sp
operator|->
name|td
operator|=
name|td
expr_stmt|;
name|isc_start_receiver
argument_list|(
name|sp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fdrop
argument_list|(
name|sp
operator|->
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|sp
operator|->
name|fp
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_send
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|isc_session_t
modifier|*
name|sp
init|=
name|dev
operator|->
name|si_drv2
decl_stmt|;
name|caddr_t
name|bp
decl_stmt|;
name|pduq_t
modifier|*
name|pq
decl_stmt|;
name|pdu_t
modifier|*
name|pp
decl_stmt|;
name|int
name|n
decl_stmt|,
name|error
decl_stmt|;
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|soc
operator|==
name|NULL
condition|)
return|return
name|ENOTCONN
return|;
if|if
condition|(
operator|(
name|pq
operator|=
name|pdu_alloc
argument_list|(
name|sp
operator|->
name|isc
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|EAGAIN
return|;
name|pp
operator|=
operator|&
name|pq
operator|->
name|pdu
expr_stmt|;
name|pq
operator|->
name|pdu
operator|=
operator|*
operator|(
name|pdu_t
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|i_prepPDU
argument_list|(
name|sp
argument_list|,
name|pq
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|bp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|pq
operator|->
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|union
name|ipdu_u
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|pq
operator|->
name|buf
operator|=
name|bp
operator|=
name|malloc
argument_list|(
name|pq
operator|->
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|union
name|ipdu_u
argument_list|)
argument_list|,
name|M_ISCSIBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|pq
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
name|pq
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
comment|// just in case?
name|sdebug
argument_list|(
literal|2
argument_list|,
literal|"len=%d ahs_len=%d ds_len=%d buf=%zu@%p"
argument_list|,
name|pq
operator|->
name|len
argument_list|,
name|pp
operator|->
name|ahs_len
argument_list|,
name|pp
operator|->
name|ds_len
argument_list|,
name|pq
operator|->
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|union
name|ipdu_u
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|ahs_len
condition|)
block|{
comment|// XXX: never tested, looks suspicious
name|n
operator|=
name|pp
operator|->
name|ahs_len
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|pp
operator|->
name|ahs_addr
argument_list|,
name|bp
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|sdebug
argument_list|(
literal|3
argument_list|,
literal|"copyin ahs: error=%d"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pp
operator|->
name|ahs_addr
operator|=
operator|(
name|ahs_t
operator|*
operator|)
name|bp
expr_stmt|;
name|bp
operator|+=
name|n
expr_stmt|;
block|}
if|if
condition|(
name|pp
operator|->
name|ds_len
condition|)
block|{
name|n
operator|=
name|pp
operator|->
name|ds_len
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|pp
operator|->
name|ds_addr
argument_list|,
name|bp
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|sdebug
argument_list|(
literal|3
argument_list|,
literal|"copyin ds: error=%d"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pp
operator|->
name|ds_addr
operator|=
name|bp
expr_stmt|;
name|bp
operator|+=
name|n
expr_stmt|;
while|while
condition|(
name|n
operator|&
literal|03
condition|)
block|{
name|n
operator|++
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|error
operator|=
name|isc_qout
argument_list|(
name|sp
argument_list|,
name|pq
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|wakeup
argument_list|(
operator|&
name|sp
operator|->
name|flags
argument_list|)
expr_stmt|;
comment|// XXX: to 'push' proc_out ...
name|out
label|:
if|if
condition|(
name|error
condition|)
name|pdu_free
argument_list|(
name|sp
operator|->
name|isc
argument_list|,
name|pq
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_recv
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|isc_session_t
modifier|*
name|sp
init|=
name|dev
operator|->
name|si_drv2
decl_stmt|;
name|pduq_t
modifier|*
name|pq
decl_stmt|;
name|pdu_t
modifier|*
name|pp
decl_stmt|,
modifier|*
name|up
decl_stmt|;
name|caddr_t
name|bp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|mustfree
decl_stmt|,
name|cnt
decl_stmt|;
name|size_t
name|need
decl_stmt|,
name|have
decl_stmt|,
name|n
decl_stmt|;
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|EIO
return|;
if|if
condition|(
name|sp
operator|->
name|soc
operator|==
name|NULL
condition|)
return|return
name|ENOTCONN
return|;
name|cnt
operator|=
literal|6
expr_stmt|;
comment|// XXX: maybe the user can request a time out?
name|mtx_lock
argument_list|(
operator|&
name|sp
operator|->
name|rsp_mtx
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|pq
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|sp
operator|->
name|rsp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|msleep
argument_list|(
operator|&
name|sp
operator|->
name|rsp
argument_list|,
operator|&
name|sp
operator|->
name|rsp_mtx
argument_list|,
name|PRIBIO
argument_list|,
literal|"isc_rsp"
argument_list|,
name|hz
operator|*
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|--
operator|==
literal|0
condition|)
break|break;
comment|// XXX: for now, needs work
block|}
if|if
condition|(
name|pq
operator|!=
name|NULL
condition|)
block|{
name|sp
operator|->
name|stats
operator|.
name|nrsp
operator|--
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|sp
operator|->
name|rsp
argument_list|,
name|pq
argument_list|,
name|pq_link
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sp
operator|->
name|rsp_mtx
argument_list|)
expr_stmt|;
name|sdebug
argument_list|(
literal|6
argument_list|,
literal|"cnt=%d"
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|pq
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOTCONN
expr_stmt|;
name|sdebug
argument_list|(
literal|3
argument_list|,
literal|"error=%d sp->flags=%x "
argument_list|,
name|error
argument_list|,
name|sp
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|up
operator|=
operator|(
name|pdu_t
operator|*
operator|)
name|arg
expr_stmt|;
name|pp
operator|=
operator|&
name|pq
operator|->
name|pdu
expr_stmt|;
name|up
operator|->
name|ipdu
operator|=
name|pp
operator|->
name|ipdu
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|ds_len
operator|=
literal|0
expr_stmt|;
name|up
operator|->
name|ahs_len
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pq
operator|->
name|mp
condition|)
block|{
name|u_int
name|len
decl_stmt|;
comment|// Grr...
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|ahs_len
condition|)
block|{
name|len
operator|+=
name|pp
operator|->
name|ahs_len
expr_stmt|;
block|}
if|if
condition|(
name|pp
operator|->
name|ds_len
condition|)
block|{
name|len
operator|+=
name|pp
operator|->
name|ds_len
expr_stmt|;
block|}
name|mustfree
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|pq
operator|->
name|mp
operator|->
name|m_len
condition|)
block|{
name|mustfree
operator|++
expr_stmt|;
name|bp
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_TMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|sdebug
argument_list|(
literal|4
argument_list|,
literal|"need mbufcopy: %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|i_mbufcopy
argument_list|(
name|pq
operator|->
name|mp
argument_list|,
name|bp
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|bp
operator|=
name|mtod
argument_list|(
name|pq
operator|->
name|mp
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|ahs_len
condition|)
block|{
name|need
operator|=
name|pp
operator|->
name|ahs_len
expr_stmt|;
name|n
operator|=
name|MIN
argument_list|(
name|up
operator|->
name|ahs_size
argument_list|,
name|need
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|bp
argument_list|,
operator|(
name|caddr_t
operator|)
name|up
operator|->
name|ahs_addr
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|up
operator|->
name|ahs_len
operator|=
name|n
expr_stmt|;
name|bp
operator|+=
name|need
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|error
operator|&&
name|pp
operator|->
name|ds_len
condition|)
block|{
name|need
operator|=
name|pp
operator|->
name|ds_len
expr_stmt|;
if|if
condition|(
operator|(
name|have
operator|=
name|up
operator|->
name|ds_size
operator|)
operator|==
literal|0
condition|)
block|{
name|have
operator|=
name|up
operator|->
name|ahs_size
operator|-
name|n
expr_stmt|;
name|up
operator|->
name|ds_addr
operator|=
operator|(
name|caddr_t
operator|)
name|up
operator|->
name|ahs_addr
operator|+
name|n
expr_stmt|;
block|}
name|n
operator|=
name|MIN
argument_list|(
name|have
argument_list|,
name|need
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|bp
argument_list|,
operator|(
name|caddr_t
operator|)
name|up
operator|->
name|ds_addr
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|up
operator|->
name|ds_len
operator|=
name|n
expr_stmt|;
block|}
if|if
condition|(
name|mustfree
condition|)
name|free
argument_list|(
name|bp
argument_list|,
name|M_TMP
argument_list|)
expr_stmt|;
block|}
name|sdebug
argument_list|(
literal|6
argument_list|,
literal|"len=%d ahs_len=%d ds_len=%d"
argument_list|,
name|pq
operator|->
name|len
argument_list|,
name|pp
operator|->
name|ahs_len
argument_list|,
name|pp
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|pdu_free
argument_list|(
name|sp
operator|->
name|isc
argument_list|,
name|pq
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_fullfeature
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|isc_session_t
modifier|*
name|sp
init|=
name|dev
operator|->
name|si_drv2
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sdebug
argument_list|(
literal|2
argument_list|,
literal|"flag=%d"
argument_list|,
name|flag
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|flag
condition|)
block|{
case|case
literal|0
case|:
comment|// stop
name|sp
operator|->
name|flags
operator|&=
operator|~
name|ISC_FFPHASE
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|// start
name|sp
operator|->
name|flags
operator||=
name|ISC_FFPHASE
expr_stmt|;
name|error
operator|=
name|ic_init
argument_list|(
name|sp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|// restart
name|sp
operator|->
name|flags
operator||=
name|ISC_FFPHASE
expr_stmt|;
name|ism_restart
argument_list|(
name|sp
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_create_session
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
modifier|*
name|ndev
parameter_list|)
block|{
name|struct
name|isc_softc
modifier|*
name|sc
init|=
name|dev
operator|->
name|si_drv1
decl_stmt|;
name|isc_session_t
modifier|*
name|sp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|n
decl_stmt|;
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|sp
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|isc_session_t
argument_list|)
argument_list|,
name|M_ISCSI
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|sx_xlock
argument_list|(
operator|&
name|sc
operator|->
name|unit_sx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|alloc_unr
argument_list|(
name|sc
operator|->
name|unit
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|sx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|unit_sx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sp
argument_list|,
name|M_ISCSI
argument_list|)
expr_stmt|;
name|xdebug
argument_list|(
literal|"too many sessions!"
argument_list|)
expr_stmt|;
return|return
name|EPERM
return|;
block|}
name|sx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|unit_sx
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|isc_mtx
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|isc_sess
argument_list|,
name|sp
argument_list|,
name|sp_link
argument_list|)
expr_stmt|;
name|isc
operator|->
name|nsess
operator|++
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|isc_mtx
argument_list|)
expr_stmt|;
name|sp
operator|->
name|dev
operator|=
name|make_dev
argument_list|(
operator|&
name|iscsi_cdevsw
argument_list|,
name|n
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0600
argument_list|,
literal|"iscsi%d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|ndev
operator|=
name|sp
operator|->
name|sid
operator|=
name|n
expr_stmt|;
name|sp
operator|->
name|isc
operator|=
name|sc
expr_stmt|;
name|sp
operator|->
name|dev
operator|->
name|si_drv1
operator|=
name|sc
expr_stmt|;
name|sp
operator|->
name|dev
operator|->
name|si_drv2
operator|=
name|sp
expr_stmt|;
name|sp
operator|->
name|opt
operator|.
name|maxRecvDataSegmentLength
operator|=
literal|8192
expr_stmt|;
name|sp
operator|->
name|opt
operator|.
name|maxXmitDataSegmentLength
operator|=
literal|8192
expr_stmt|;
name|sp
operator|->
name|opt
operator|.
name|maxBurstLength
operator|=
literal|65536
expr_stmt|;
comment|// 64k
name|sp
operator|->
name|opt
operator|.
name|maxluns
operator|=
name|ISCSI_MAX_LUNS
expr_stmt|;
name|error
operator|=
name|ism_start
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|notused
end_ifdef

begin_function
specifier|static
name|void
name|iscsi_counters
parameter_list|(
name|isc_session_t
modifier|*
name|sp
parameter_list|)
block|{
name|int
name|h
decl_stmt|,
name|r
decl_stmt|,
name|s
decl_stmt|;
name|pduq_t
modifier|*
name|pq
decl_stmt|;
define|#
directive|define
name|_puke
parameter_list|(
name|i
parameter_list|,
name|pq
parameter_list|)
value|do {\ 	       debug(2, "%03d] %06x %02x %x %ld %jd %x\n",\ 		       i, ntohl( pq->pdu.ipdu.bhs.CmdSN), \ 		       pq->pdu.ipdu.bhs.opcode, ntohl(pq->pdu.ipdu.bhs.itt),\ 		       (long)pq->ts.sec, pq->ts.frac, pq->flags);\ 	       } while(0)
name|h
operator|=
name|r
operator|=
name|s
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->hld
argument_list|,
argument|pq_link
argument_list|)
block|{
name|_puke
argument_list|(
name|h
argument_list|,
name|pq
argument_list|)
expr_stmt|;
name|h
operator|++
expr_stmt|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->rsp
argument_list|,
argument|pq_link
argument_list|)
name|r
operator|++
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->csnd
argument_list|,
argument|pq_link
argument_list|)
name|s
operator|++
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->wsnd
argument_list|,
argument|pq_link
argument_list|)
name|s
operator|++
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|pq
argument_list|,
argument|&sp->isnd
argument_list|,
argument|pq_link
argument_list|)
name|s
operator|++
expr_stmt|;
name|debug
argument_list|(
literal|2
argument_list|,
literal|"hld=%d rsp=%d snd=%d"
argument_list|,
name|h
argument_list|,
name|r
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|iscsi_shutdown
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|struct
name|isc_softc
modifier|*
name|sc
init|=
name|v
decl_stmt|;
name|isc_session_t
modifier|*
name|sp
decl_stmt|;
name|int
name|n
decl_stmt|;
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
block|{
name|xdebug
argument_list|(
literal|"sc is NULL!"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|DO_EVENTHANDLER
if|if
condition|(
name|sc
operator|->
name|eh
operator|==
name|NULL
condition|)
name|debug
argument_list|(
literal|2
argument_list|,
literal|"sc->eh is NULL"
argument_list|)
expr_stmt|;
else|else
block|{
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|shutdown_pre_sync
argument_list|,
name|sc
operator|->
name|eh
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|2
argument_list|,
literal|"done n=%d"
argument_list|,
name|sc
operator|->
name|nsess
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|n
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|sp
argument_list|,
argument|&sc->isc_sess
argument_list|,
argument|sp_link
argument_list|)
block|{
name|debug
argument_list|(
literal|2
argument_list|,
literal|"%2d] sp->flags=0x%08x"
argument_list|,
name|n
argument_list|,
name|sp
operator|->
name|flags
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|debug
argument_list|(
literal|2
argument_list|,
literal|"done"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_pdus
parameter_list|(
name|struct
name|isc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pdu_zone
operator|!=
name|NULL
condition|)
block|{
name|uma_zdestroy
argument_list|(
name|sc
operator|->
name|pdu_zone
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pdu_zone
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|iscsi_start
parameter_list|(
name|void
parameter_list|)
block|{
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|TUNABLE_INT_FETCH
argument_list|(
literal|"net.iscsi_initiator.max_sessions"
argument_list|,
operator|&
name|max_sessions
argument_list|)
expr_stmt|;
name|TUNABLE_INT_FETCH
argument_list|(
literal|"net.iscsi_initiator.max_pdus"
argument_list|,
operator|&
name|max_pdus
argument_list|)
expr_stmt|;
name|isc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|isc_softc
argument_list|)
argument_list|,
name|M_ISCSI
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|isc
operator|->
name|dev
operator|=
name|make_dev
argument_list|(
operator|&
name|iscsi_cdevsw
argument_list|,
name|max_sessions
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0600
argument_list|,
literal|"iscsi"
argument_list|)
expr_stmt|;
name|isc
operator|->
name|dev
operator|->
name|si_drv1
operator|=
name|isc
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|isc
operator|->
name|isc_mtx
argument_list|,
literal|"iscsi"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|isc
operator|->
name|isc_sess
argument_list|)
expr_stmt|;
comment|/*       | now init the free pdu list       */
name|isc
operator|->
name|pdu_zone
operator|=
name|uma_zcreate
argument_list|(
literal|"pdu"
argument_list|,
sizeof|sizeof
argument_list|(
name|pduq_t
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc
operator|->
name|pdu_zone
operator|==
name|NULL
condition|)
block|{
name|xdebug
argument_list|(
literal|"iscsi_initiator: uma_zcreate failed"
argument_list|)
expr_stmt|;
comment|// XXX: should fail...
block|}
name|uma_zone_set_max
argument_list|(
name|isc
operator|->
name|pdu_zone
argument_list|,
name|max_pdus
argument_list|)
expr_stmt|;
name|isc
operator|->
name|unit
operator|=
name|new_unrhdr
argument_list|(
literal|0
argument_list|,
name|max_sessions
operator|-
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sx_init
argument_list|(
operator|&
name|isc
operator|->
name|unit_sx
argument_list|,
literal|"iscsi sx"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DO_EVENTHANDLER
if|if
condition|(
operator|(
name|isc
operator|->
name|eh
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|shutdown_pre_sync
argument_list|,
name|iscsi_shutdown
argument_list|,
name|sc
argument_list|,
name|SHUTDOWN_PRI_DEFAULT
operator|-
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|xdebug
argument_list|(
literal|"shutdown event registration failed\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*       | sysctl stuff       */
name|sysctl_ctx_init
argument_list|(
operator|&
name|isc
operator|->
name|clist
argument_list|)
expr_stmt|;
name|isc
operator|->
name|oid
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|isc
operator|->
name|clist
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_net
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"iscsi_initiator"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"iSCSI Subsystem"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
operator|&
name|isc
operator|->
name|clist
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|isc
operator|->
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"driver_version"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|iscsi_driver_version
argument_list|,
literal|0
argument_list|,
literal|"iscsi driver version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
operator|&
name|isc
operator|->
name|clist
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|isc
operator|->
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"isid"
argument_list|,
name|CTLFLAG_RW
argument_list|,
name|isid
argument_list|,
literal|6
operator|+
literal|1
argument_list|,
literal|"initiator part of the Session Identifier"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|isc
operator|->
name|clist
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|isc
operator|->
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sessions"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|isc
operator|->
name|nsess
argument_list|,
sizeof|sizeof
argument_list|(
name|isc
operator|->
name|nsess
argument_list|)
argument_list|,
literal|"number of active session"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"iscsi: version %s\n"
argument_list|,
name|iscsi_driver_version
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  | Notes:  |	unload SHOULD fail if there is activity  |	activity: there is/are active session/s  */
end_comment

begin_function
specifier|static
name|void
name|iscsi_stop
parameter_list|(
name|void
parameter_list|)
block|{
name|isc_session_t
modifier|*
name|sp
decl_stmt|,
modifier|*
name|sp_tmp
decl_stmt|;
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
comment|/*       | go through all the sessions       | Note: close should have done this ...       */
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|sp
argument_list|,
argument|&isc->isc_sess
argument_list|,
argument|sp_link
argument_list|,
argument|sp_tmp
argument_list|)
block|{
comment|//XXX: check for activity ...
name|ism_stop
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|cam_sim
operator|!=
name|NULL
condition|)
name|ic_destroy
argument_list|(
name|sp
argument_list|)
expr_stmt|;
block|}
name|mtx_destroy
argument_list|(
operator|&
name|isc
operator|->
name|isc_mtx
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|isc
operator|->
name|unit_sx
argument_list|)
expr_stmt|;
name|free_pdus
argument_list|(
name|isc
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc
operator|->
name|dev
condition|)
name|destroy_dev
argument_list|(
name|isc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctl_ctx_free
argument_list|(
operator|&
name|isc
operator|->
name|clist
argument_list|)
condition|)
name|xdebug
argument_list|(
literal|"sysctl_ctx_free failed"
argument_list|)
expr_stmt|;
name|iscsi_shutdown
argument_list|(
name|isc
argument_list|)
expr_stmt|;
comment|// XXX: check EVENTHANDLER_ ...
name|free
argument_list|(
name|isc
argument_list|,
name|M_ISCSI
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|iscsi_modevent
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|what
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|debug_called
argument_list|(
literal|8
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|what
condition|)
block|{
case|case
name|MOD_LOAD
case|:
name|iscsi_start
argument_list|()
expr_stmt|;
break|break;
case|case
name|MOD_QUIESCE
case|:
if|if
condition|(
name|isc
operator|->
name|nsess
condition|)
block|{
name|xdebug
argument_list|(
literal|"iscsi module busy(nsess=%d), cannot unload"
argument_list|,
name|isc
operator|->
name|nsess
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"iscsi module busy, cannot unload"
argument_list|)
expr_stmt|;
block|}
return|return
name|isc
operator|->
name|nsess
return|;
case|case
name|MOD_SHUTDOWN
case|:
break|break;
case|case
name|MOD_UNLOAD
case|:
name|iscsi_stop
argument_list|()
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|moduledata_t
name|iscsi_mod
init|=
block|{
literal|"iscsi"
block|,
operator|(
name|modeventhand_t
operator|)
name|iscsi_modevent
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|ISCSI_ROOT
end_ifdef

begin_function
specifier|static
name|void
name|iscsi_rootconf
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
literal|0
block|nfs_setup_diskless(); 	if (nfs_diskless_valid) 		rootdevnames[0] = "nfs:";
endif|#
directive|endif
name|printf
argument_list|(
literal|"** iscsi_rootconf **\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|SYSINIT
argument_list|(
argument|cpu_rootconf1
argument_list|,
argument|SI_SUB_ROOT_CONF
argument_list|,
argument|SI_ORDER_FIRST
argument_list|,
argument|iscsi_rootconf
argument_list|,
argument|NULL
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|DECLARE_MODULE
argument_list|(
name|iscsi
argument_list|,
name|iscsi_mod
argument_list|,
name|SI_SUB_DRIVERS
argument_list|,
name|SI_ORDER_MIDDLE
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|iscsi
argument_list|,
name|cam
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


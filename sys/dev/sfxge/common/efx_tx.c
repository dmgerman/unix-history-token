begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007-2015 Solarflare Communications Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *  * 1. Redistributions of source code must retain the above copyright notice,  *    this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright notice,  *    this list of conditions and the following disclaimer in the documentation  *    and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * The views and conclusions contained in the software and documentation are  * those of the authors and should not be interpreted as representing official  * policies, either expressed or implied, of the FreeBSD Project.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"efsys.h"
end_include

begin_include
include|#
directive|include
file|"efx.h"
end_include

begin_include
include|#
directive|include
file|"efx_types.h"
end_include

begin_include
include|#
directive|include
file|"efx_regs.h"
end_include

begin_include
include|#
directive|include
file|"efx_impl.h"
end_include

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_define
define|#
directive|define
name|EFX_TX_QSTAT_INCR
parameter_list|(
name|_etp
parameter_list|,
name|_stat
parameter_list|)
define|\
value|do {								\ 		(_etp)->et_stat[_stat]++;				\ 	_NOTE(CONSTANTCONDITION)					\ 	} while (B_FALSE)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|EFX_TX_QSTAT_INCR
parameter_list|(
name|_etp
parameter_list|,
name|_stat
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_FALCON
operator|||
name|EFSYS_OPT_SIENA
end_if

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_init
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|falconsiena_tx_fini
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qcreate
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|index
parameter_list|,
name|__in
name|unsigned
name|int
name|label
parameter_list|,
name|__in
name|efsys_mem_t
modifier|*
name|esmp
parameter_list|,
name|__in
name|size_t
name|n
parameter_list|,
name|__in
name|uint32_t
name|id
parameter_list|,
name|__in
name|uint16_t
name|flags
parameter_list|,
name|__in
name|efx_evq_t
modifier|*
name|eep
parameter_list|,
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__out
name|unsigned
name|int
modifier|*
name|addedp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|falconsiena_tx_qdestroy
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qpost
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efx_buffer_t
operator|*
name|eb
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__inout
name|unsigned
name|int
operator|*
name|addedp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|falconsiena_tx_qpush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|unsigned
name|int
name|added
parameter_list|,
name|__in
name|unsigned
name|int
name|pushed
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qpace
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|unsigned
name|int
name|ns
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qflush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|falconsiena_tx_qenable
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qdesc_post
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efx_desc_t
operator|*
name|ed
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__inout
name|unsigned
name|int
operator|*
name|addedp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|falconsiena_tx_qdesc_dma_create
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|efsys_dma_addr_t
name|addr
parameter_list|,
name|__in
name|size_t
name|size
parameter_list|,
name|__in
name|boolean_t
name|eop
parameter_list|,
name|__out
name|efx_desc_t
modifier|*
name|edp
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_decl_stmt
specifier|static
name|void
name|falconsiena_tx_qstats_update
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__inout_ecount
argument_list|(
argument|TX_NQSTATS
argument_list|)
name|efsys_stat_t
operator|*
name|stat
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_FALCON || EFSYS_OPT_SIENA */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_FALCON
end_if

begin_decl_stmt
specifier|static
name|efx_tx_ops_t
name|__efx_tx_falcon_ops
init|=
block|{
name|falconsiena_tx_init
block|,
comment|/* etxo_init */
name|falconsiena_tx_fini
block|,
comment|/* etxo_fini */
name|falconsiena_tx_qcreate
block|,
comment|/* etxo_qcreate */
name|falconsiena_tx_qdestroy
block|,
comment|/* etxo_qdestroy */
name|falconsiena_tx_qpost
block|,
comment|/* etxo_qpost */
name|falconsiena_tx_qpush
block|,
comment|/* etxo_qpush */
name|falconsiena_tx_qpace
block|,
comment|/* etxo_qpace */
name|falconsiena_tx_qflush
block|,
comment|/* etxo_qflush */
name|falconsiena_tx_qenable
block|,
comment|/* etxo_qenable */
name|NULL
block|,
comment|/* etxo_qpio_enable */
name|NULL
block|,
comment|/* etxo_qpio_disable */
name|NULL
block|,
comment|/* etxo_qpio_write */
name|NULL
block|,
comment|/* etxo_qpio_post */
name|falconsiena_tx_qdesc_post
block|,
comment|/* etxo_qdesc_post */
name|falconsiena_tx_qdesc_dma_create
block|,
comment|/* etxo_qdesc_dma_create */
name|NULL
block|,
comment|/* etxo_qdesc_tso_create */
name|NULL
block|,
comment|/* etxo_qdesc_vlantci_create */
if|#
directive|if
name|EFSYS_OPT_QSTATS
name|falconsiena_tx_qstats_update
block|,
comment|/* etxo_qstats_update */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_FALCON */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_SIENA
end_if

begin_decl_stmt
specifier|static
name|efx_tx_ops_t
name|__efx_tx_siena_ops
init|=
block|{
name|falconsiena_tx_init
block|,
comment|/* etxo_init */
name|falconsiena_tx_fini
block|,
comment|/* etxo_fini */
name|falconsiena_tx_qcreate
block|,
comment|/* etxo_qcreate */
name|falconsiena_tx_qdestroy
block|,
comment|/* etxo_qdestroy */
name|falconsiena_tx_qpost
block|,
comment|/* etxo_qpost */
name|falconsiena_tx_qpush
block|,
comment|/* etxo_qpush */
name|falconsiena_tx_qpace
block|,
comment|/* etxo_qpace */
name|falconsiena_tx_qflush
block|,
comment|/* etxo_qflush */
name|falconsiena_tx_qenable
block|,
comment|/* etxo_qenable */
name|NULL
block|,
comment|/* etxo_qpio_enable */
name|NULL
block|,
comment|/* etxo_qpio_disable */
name|NULL
block|,
comment|/* etxo_qpio_write */
name|NULL
block|,
comment|/* etxo_qpio_post */
name|falconsiena_tx_qdesc_post
block|,
comment|/* etxo_qdesc_post */
name|falconsiena_tx_qdesc_dma_create
block|,
comment|/* etxo_qdesc_dma_create */
name|NULL
block|,
comment|/* etxo_qdesc_tso_create */
name|NULL
block|,
comment|/* etxo_qdesc_vlantci_create */
if|#
directive|if
name|EFSYS_OPT_QSTATS
name|falconsiena_tx_qstats_update
block|,
comment|/* etxo_qstats_update */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_SIENA */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_HUNTINGTON
end_if

begin_decl_stmt
specifier|static
name|efx_tx_ops_t
name|__efx_tx_hunt_ops
init|=
block|{
name|ef10_tx_init
block|,
comment|/* etxo_init */
name|ef10_tx_fini
block|,
comment|/* etxo_fini */
name|ef10_tx_qcreate
block|,
comment|/* etxo_qcreate */
name|ef10_tx_qdestroy
block|,
comment|/* etxo_qdestroy */
name|ef10_tx_qpost
block|,
comment|/* etxo_qpost */
name|ef10_tx_qpush
block|,
comment|/* etxo_qpush */
name|ef10_tx_qpace
block|,
comment|/* etxo_qpace */
name|ef10_tx_qflush
block|,
comment|/* etxo_qflush */
name|ef10_tx_qenable
block|,
comment|/* etxo_qenable */
name|ef10_tx_qpio_enable
block|,
comment|/* etxo_qpio_enable */
name|ef10_tx_qpio_disable
block|,
comment|/* etxo_qpio_disable */
name|ef10_tx_qpio_write
block|,
comment|/* etxo_qpio_write */
name|ef10_tx_qpio_post
block|,
comment|/* etxo_qpio_post */
name|ef10_tx_qdesc_post
block|,
comment|/* etxo_qdesc_post */
name|ef10_tx_qdesc_dma_create
block|,
comment|/* etxo_qdesc_dma_create */
name|hunt_tx_qdesc_tso_create
block|,
comment|/* etxo_qdesc_tso_create */
name|ef10_tx_qdesc_vlantci_create
block|,
comment|/* etxo_qdesc_vlantci_create */
if|#
directive|if
name|EFSYS_OPT_QSTATS
name|ef10_tx_qstats_update
block|,
comment|/* etxo_qstats_update */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_HUNTINGTON */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_MEDFORD
end_if

begin_decl_stmt
specifier|static
name|efx_tx_ops_t
name|__efx_tx_medford_ops
init|=
block|{
name|ef10_tx_init
block|,
comment|/* etxo_init */
name|ef10_tx_fini
block|,
comment|/* etxo_fini */
name|ef10_tx_qcreate
block|,
comment|/* etxo_qcreate */
name|ef10_tx_qdestroy
block|,
comment|/* etxo_qdestroy */
name|ef10_tx_qpost
block|,
comment|/* etxo_qpost */
name|ef10_tx_qpush
block|,
comment|/* etxo_qpush */
name|ef10_tx_qpace
block|,
comment|/* etxo_qpace */
name|ef10_tx_qflush
block|,
comment|/* etxo_qflush */
name|ef10_tx_qenable
block|,
comment|/* etxo_qenable */
name|ef10_tx_qpio_enable
block|,
comment|/* etxo_qpio_enable */
name|ef10_tx_qpio_disable
block|,
comment|/* etxo_qpio_disable */
name|ef10_tx_qpio_write
block|,
comment|/* etxo_qpio_write */
name|ef10_tx_qpio_post
block|,
comment|/* etxo_qpio_post */
name|ef10_tx_qdesc_post
block|,
comment|/* etxo_qdesc_post */
name|ef10_tx_qdesc_dma_create
block|,
comment|/* etxo_qdesc_dma_create */
name|NULL
block|,
comment|/* etxo_qdesc_tso_create */
name|ef10_tx_qdesc_vlantci_create
block|,
comment|/* etxo_qdesc_vlantci_create */
if|#
directive|if
name|EFSYS_OPT_QSTATS
name|ef10_tx_qstats_update
block|,
comment|/* etxo_qstats_update */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_MEDFORD */
end_comment

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_tx_init
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_tx_ops_t
modifier|*
name|etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_NIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|enp
operator|->
name|en_mod_flags
operator|&
name|EFX_MOD_EV
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|enp
operator|->
name|en_mod_flags
operator|&
name|EFX_MOD_TX
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
switch|switch
condition|(
name|enp
operator|->
name|en_family
condition|)
block|{
if|#
directive|if
name|EFSYS_OPT_FALCON
case|case
name|EFX_FAMILY_FALCON
case|:
name|etxop
operator|=
operator|(
name|efx_tx_ops_t
operator|*
operator|)
operator|&
name|__efx_tx_falcon_ops
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_FALCON */
if|#
directive|if
name|EFSYS_OPT_SIENA
case|case
name|EFX_FAMILY_SIENA
case|:
name|etxop
operator|=
operator|(
name|efx_tx_ops_t
operator|*
operator|)
operator|&
name|__efx_tx_siena_ops
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_SIENA */
if|#
directive|if
name|EFSYS_OPT_HUNTINGTON
case|case
name|EFX_FAMILY_HUNTINGTON
case|:
name|etxop
operator|=
operator|(
name|efx_tx_ops_t
operator|*
operator|)
operator|&
name|__efx_tx_hunt_ops
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_HUNTINGTON */
if|#
directive|if
name|EFSYS_OPT_MEDFORD
case|case
name|EFX_FAMILY_MEDFORD
case|:
name|etxop
operator|=
operator|(
name|efx_tx_ops_t
operator|*
operator|)
operator|&
name|__efx_tx_medford_ops
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_MEDFORD */
default|default:
name|EFSYS_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_tx_qcount
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_init
argument_list|(
name|enp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail4
goto|;
name|enp
operator|->
name|en_etxop
operator|=
name|etxop
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator||=
name|EFX_MOD_TX
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail4
label|:
name|EFSYS_PROBE
argument_list|(
name|fail4
argument_list|)
expr_stmt|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_etxop
operator|=
name|NULL
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator|&=
operator|~
name|EFX_MOD_TX
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|efx_tx_fini
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_NIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_TX
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_tx_qcount
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|etxop
operator|->
name|etxo_fini
argument_list|(
name|enp
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_etxop
operator|=
name|NULL
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator|&=
operator|~
name|EFX_MOD_TX
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_tx_qcreate
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|index
parameter_list|,
name|__in
name|unsigned
name|int
name|label
parameter_list|,
name|__in
name|efsys_mem_t
modifier|*
name|esmp
parameter_list|,
name|__in
name|size_t
name|n
parameter_list|,
name|__in
name|uint32_t
name|id
parameter_list|,
name|__in
name|uint16_t
name|flags
parameter_list|,
name|__in
name|efx_evq_t
modifier|*
name|eep
parameter_list|,
name|__deref_out
name|efx_txq_t
modifier|*
modifier|*
name|etpp
parameter_list|,
name|__out
name|unsigned
name|int
modifier|*
name|addedp
parameter_list|)
block|{
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|efx_txq_t
modifier|*
name|etp
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_TX
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_tx_qcount
operator|+
literal|1
argument_list|,
operator|<
argument_list|,
name|encp
operator|->
name|enc_txq_limit
argument_list|)
expr_stmt|;
comment|/* Allocate an TXQ object */
name|EFSYS_KMEM_ALLOC
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_txq_t
argument_list|)
argument_list|,
name|etp
argument_list|)
expr_stmt|;
if|if
condition|(
name|etp
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|etp
operator|->
name|et_magic
operator|=
name|EFX_TXQ_MAGIC
expr_stmt|;
name|etp
operator|->
name|et_enp
operator|=
name|enp
expr_stmt|;
name|etp
operator|->
name|et_index
operator|=
name|index
expr_stmt|;
name|etp
operator|->
name|et_mask
operator|=
name|n
operator|-
literal|1
expr_stmt|;
name|etp
operator|->
name|et_esmp
operator|=
name|esmp
expr_stmt|;
comment|/* Initial descriptor index may be modified by etxo_qcreate */
operator|*
name|addedp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qcreate
argument_list|(
name|enp
argument_list|,
name|index
argument_list|,
name|label
argument_list|,
name|esmp
argument_list|,
name|n
argument_list|,
name|id
argument_list|,
name|flags
argument_list|,
name|eep
argument_list|,
name|etp
argument_list|,
name|addedp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail2
goto|;
name|enp
operator|->
name|en_tx_qcount
operator|++
expr_stmt|;
operator|*
name|etpp
operator|=
name|etp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|EFSYS_KMEM_FREE
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_txq_t
argument_list|)
argument_list|,
name|etp
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|efx_tx_qdestroy
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_tx_qcount
operator|!=
literal|0
argument_list|)
expr_stmt|;
operator|--
name|enp
operator|->
name|en_tx_qcount
expr_stmt|;
name|etxop
operator|->
name|etxo_qdestroy
argument_list|(
name|etp
argument_list|)
expr_stmt|;
comment|/* Free the TXQ object */
name|EFSYS_KMEM_FREE
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_txq_t
argument_list|)
argument_list|,
name|etp
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_tx_qpost
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efx_buffer_t
operator|*
name|eb
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__inout
name|unsigned
name|int
operator|*
name|addedp
argument_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qpost
argument_list|(
name|etp
argument_list|,
name|eb
argument_list|,
name|n
argument_list|,
name|completed
argument_list|,
name|addedp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_function
name|void
name|efx_tx_qpush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|unsigned
name|int
name|added
parameter_list|,
name|__in
name|unsigned
name|int
name|pushed
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|etxop
operator|->
name|etxo_qpush
argument_list|(
name|etp
argument_list|,
name|added
argument_list|,
name|pushed
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_tx_qpace
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|unsigned
name|int
name|ns
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qpace
argument_list|(
name|etp
argument_list|,
name|ns
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_tx_qflush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qflush
argument_list|(
name|etp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|efx_tx_qenable
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|etxop
operator|->
name|etxo_qenable
argument_list|(
name|etp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_tx_qpio_enable
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|~
name|enp
operator|->
name|en_features
operator|&
name|EFX_FEATURE_PIO_BUFFERS
condition|)
block|{
name|rc
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|etxop
operator|->
name|etxo_qpio_enable
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qpio_enable
argument_list|(
name|etp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail3
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|efx_tx_qpio_disable
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|etxop
operator|->
name|etxo_qpio_disable
operator|!=
name|NULL
condition|)
name|etxop
operator|->
name|etxo_qpio_disable
argument_list|(
name|etp
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_tx_qpio_write
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|buf_length
argument_list|)
name|uint8_t
operator|*
name|buffer
argument_list|,
name|__in
name|size_t
name|buf_length
argument_list|,
name|__in
name|size_t
name|pio_buf_offset
argument_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|etxop
operator|->
name|etxo_qpio_write
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qpio_write
argument_list|(
name|etp
argument_list|,
name|buffer
argument_list|,
name|buf_length
argument_list|,
name|pio_buf_offset
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|ENOTSUP
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_tx_qpio_post
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|size_t
name|pkt_length
parameter_list|,
name|__in
name|unsigned
name|int
name|completed
parameter_list|,
name|__inout
name|unsigned
name|int
modifier|*
name|addedp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|etxop
operator|->
name|etxo_qpio_post
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qpio_post
argument_list|(
name|etp
argument_list|,
name|pkt_length
argument_list|,
name|completed
argument_list|,
name|addedp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|ENOTSUP
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_tx_qdesc_post
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efx_desc_t
operator|*
name|ed
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__inout
name|unsigned
name|int
operator|*
name|addedp
argument_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|etxop
operator|->
name|etxo_qdesc_post
argument_list|(
name|etp
argument_list|,
name|ed
argument_list|,
name|n
argument_list|,
name|completed
argument_list|,
name|addedp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_function
name|void
name|efx_tx_qdesc_dma_create
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|efsys_dma_addr_t
name|addr
parameter_list|,
name|__in
name|size_t
name|size
parameter_list|,
name|__in
name|boolean_t
name|eop
parameter_list|,
name|__out
name|efx_desc_t
modifier|*
name|edp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|etxop
operator|->
name|etxo_qdesc_dma_create
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|etxop
operator|->
name|etxo_qdesc_dma_create
argument_list|(
name|etp
argument_list|,
name|addr
argument_list|,
name|size
argument_list|,
name|eop
argument_list|,
name|edp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_tx_qdesc_tso_create
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|uint16_t
name|ipv4_id
parameter_list|,
name|__in
name|uint32_t
name|tcp_seq
parameter_list|,
name|__in
name|uint8_t
name|tcp_flags
parameter_list|,
name|__out
name|efx_desc_t
modifier|*
name|edp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|etxop
operator|->
name|etxo_qdesc_tso_create
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|etxop
operator|->
name|etxo_qdesc_tso_create
argument_list|(
name|etp
argument_list|,
name|ipv4_id
argument_list|,
name|tcp_seq
argument_list|,
name|tcp_flags
argument_list|,
name|edp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_tx_qdesc_vlantci_create
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|uint16_t
name|tci
parameter_list|,
name|__out
name|efx_desc_t
modifier|*
name|edp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|etxop
operator|->
name|etxo_qdesc_vlantci_create
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|etxop
operator|->
name|etxo_qdesc_vlantci_create
argument_list|(
name|etp
argument_list|,
name|tci
argument_list|,
name|edp
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_decl_stmt
name|void
name|efx_tx_qstats_update
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__inout_ecount
argument_list|(
argument|TX_NQSTATS
argument_list|)
name|efsys_stat_t
operator|*
name|stat
argument_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_tx_ops_t
modifier|*
name|etxop
init|=
name|enp
operator|->
name|en_etxop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|etxop
operator|->
name|etxo_qstats_update
argument_list|(
name|etp
argument_list|,
name|stat
argument_list|)
expr_stmt|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_FALCON
operator|||
name|EFSYS_OPT_SIENA
end_if

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_init
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_oword_t
name|oword
decl_stmt|;
comment|/* 	 * Disable the timer-based TX DMA backoff and allow TX DMA to be 	 * controlled by the RX FIFO fill level (although always allow a 	 * minimal trickle). 	 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_RESERVED_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_RX_SPACER
argument_list|,
literal|0xfe
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_RX_SPACER_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_ONE_PKT_PER_Q
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_PUSH_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DIS_NON_IP_EV
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_PREF_THRESHOLD
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_PREF_WD_TMR
argument_list|,
literal|0x3fffff
argument_list|)
expr_stmt|;
comment|/* 	 * Filter all packets less than 14 bytes to avoid parsing 	 * errors. 	 */
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_FLUSH_MIN_LEN_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_RESERVED_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* 	 * Do not set TX_NO_EOP_DISC_EN, since it limits packets to 16 	 * descriptors (which is bad). 	 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_NO_EOP_DISC_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|EFX_TX_DESC
parameter_list|(
name|_etp
parameter_list|,
name|_addr
parameter_list|,
name|_size
parameter_list|,
name|_eop
parameter_list|,
name|_added
parameter_list|)
define|\
value|do {								\ 		unsigned int id;					\ 		size_t offset;						\ 		efx_qword_t qword;					\ 									\ 		id = (_added)++& (_etp)->et_mask;			\ 		offset = id * sizeof (efx_qword_t);			\ 									\ 		EFSYS_PROBE5(tx_post, unsigned int, (_etp)->et_index,	\ 		    unsigned int, id, efsys_dma_addr_t, (_addr),	\ 		    size_t, (_size), boolean_t, (_eop));		\ 									\ 		EFX_POPULATE_QWORD_4(qword,				\ 		    FSF_AZ_TX_KER_CONT, (_eop) ? 0 : 1,			\ 		    FSF_AZ_TX_KER_BYTE_COUNT, (uint32_t)(_size),	\ 		    FSF_AZ_TX_KER_BUF_ADDR_DW0,				\ 		    (uint32_t)((_addr)& 0xffffffff),			\ 		    FSF_AZ_TX_KER_BUF_ADDR_DW1,				\ 		    (uint32_t)((_addr)>> 32));				\ 		EFSYS_MEM_WRITEQ((_etp)->et_esmp, offset,&qword);	\ 									\ 		_NOTE(CONSTANTCONDITION)				\ 	} while (B_FALSE)
end_define

begin_decl_stmt
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qpost
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efx_buffer_t
operator|*
name|eb
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__inout
name|unsigned
name|int
operator|*
name|addedp
argument_list|)
block|{
name|unsigned
name|int
name|added
init|=
operator|*
name|addedp
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|int
name|rc
init|=
name|ENOSPC
decl_stmt|;
if|if
condition|(
name|added
operator|-
name|completed
operator|+
name|n
operator|>
name|EFX_TXQ_LIMIT
argument_list|(
name|etp
operator|->
name|et_mask
operator|+
literal|1
argument_list|)
condition|)
goto|goto
name|fail1
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|efx_buffer_t
modifier|*
name|ebp
init|=
operator|&
name|eb
index|[
name|i
index|]
decl_stmt|;
name|efsys_dma_addr_t
name|start
init|=
name|ebp
operator|->
name|eb_addr
decl_stmt|;
name|size_t
name|size
init|=
name|ebp
operator|->
name|eb_size
decl_stmt|;
name|efsys_dma_addr_t
name|end
init|=
name|start
operator|+
name|size
decl_stmt|;
comment|/* Fragments must not span 4k boundaries. */
name|EFSYS_ASSERT
argument_list|(
name|P2ROUNDUP
argument_list|(
name|start
operator|+
literal|1
argument_list|,
literal|4096
argument_list|)
operator|>=
name|end
argument_list|)
expr_stmt|;
name|EFX_TX_DESC
argument_list|(
name|etp
argument_list|,
name|start
argument_list|,
name|size
argument_list|,
name|ebp
operator|->
name|eb_eop
argument_list|,
name|added
argument_list|)
expr_stmt|;
block|}
name|EFX_TX_QSTAT_INCR
argument_list|(
name|etp
argument_list|,
name|TX_POST
argument_list|)
expr_stmt|;
operator|*
name|addedp
operator|=
name|added
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|void
name|falconsiena_tx_qpush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|unsigned
name|int
name|added
parameter_list|,
name|__in
name|unsigned
name|int
name|pushed
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|uint32_t
name|wptr
decl_stmt|;
name|efx_dword_t
name|dword
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
comment|/* Push the populated descriptors out */
name|wptr
operator|=
name|added
operator|&
name|etp
operator|->
name|et_mask
expr_stmt|;
name|EFX_POPULATE_OWORD_1
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESC_WPTR
argument_list|,
name|wptr
argument_list|)
expr_stmt|;
comment|/* Only write the third DWORD */
name|EFX_POPULATE_DWORD_1
argument_list|(
name|dword
argument_list|,
name|EFX_DWORD_0
argument_list|,
name|EFX_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|EFX_DWORD_3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Guarantee ordering of memory (descriptors) and PIO (doorbell) */
name|EFX_DMA_SYNC_QUEUE_FOR_DEVICE
argument_list|(
name|etp
operator|->
name|et_esmp
argument_list|,
name|etp
operator|->
name|et_mask
operator|+
literal|1
argument_list|,
name|wptr
argument_list|,
name|pushed
operator|&
name|etp
operator|->
name|et_mask
argument_list|)
expr_stmt|;
name|EFSYS_PIO_WRITE_BARRIER
argument_list|()
expr_stmt|;
name|EFX_BAR_TBL_WRITED3
argument_list|(
name|enp
argument_list|,
name|FR_BZ_TX_DESC_UPD_REGP0
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|dword
argument_list|,
name|B_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|EFX_MAX_PACE_VALUE
value|20
end_define

begin_define
define|#
directive|define
name|EFX_TX_PACE_CLOCK_BASE
value|104
end_define

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qpace
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|unsigned
name|int
name|ns
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|unsigned
name|int
name|pace_val
decl_stmt|;
name|unsigned
name|int
name|timer_period
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|ns
operator|==
literal|0
condition|)
block|{
name|pace_val
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * The pace_val to write into the table is s.t 		 * ns<= timer_period * (2 ^ pace_val) 		 */
name|timer_period
operator|=
name|EFX_TX_PACE_CLOCK_BASE
operator|/
name|encp
operator|->
name|enc_clk_mult
expr_stmt|;
for|for
control|(
name|pace_val
operator|=
literal|1
init|;
name|pace_val
operator|<=
name|EFX_MAX_PACE_VALUE
condition|;
name|pace_val
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|timer_period
operator|<<
name|pace_val
operator|)
operator|>=
name|ns
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|pace_val
operator|>
name|EFX_MAX_PACE_VALUE
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
comment|/* Update the pacing table */
name|EFX_POPULATE_OWORD_1
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_PACE
argument_list|,
name|pace_val
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_PACE_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qflush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|uint32_t
name|label
decl_stmt|;
name|efx_tx_qpace
argument_list|(
name|etp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|label
operator|=
name|etp
operator|->
name|et_index
expr_stmt|;
comment|/* Flush the queue */
name|EFX_POPULATE_OWORD_2
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_FLUSH_DESCQ_CMD
argument_list|,
literal|1
argument_list|,
name|FRF_AZ_TX_FLUSH_DESCQ
argument_list|,
name|label
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_FLUSH_DESCQ_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|falconsiena_tx_qenable
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|EFX_BAR_TBL_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
name|EFSYS_PROBE5
argument_list|(
argument|tx_descq_ptr
argument_list|,
argument|unsigned int
argument_list|,
argument|etp->et_index
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_3)
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_2)
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_1)
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_0)
argument_list|)
empty_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DC_HW_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESCQ_HW_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESCQ_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qcreate
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|index
parameter_list|,
name|__in
name|unsigned
name|int
name|label
parameter_list|,
name|__in
name|efsys_mem_t
modifier|*
name|esmp
parameter_list|,
name|__in
name|size_t
name|n
parameter_list|,
name|__in
name|uint32_t
name|id
parameter_list|,
name|__in
name|uint16_t
name|flags
parameter_list|,
name|__in
name|efx_evq_t
modifier|*
name|eep
parameter_list|,
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__out
name|unsigned
name|int
modifier|*
name|addedp
parameter_list|)
block|{
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|EFX_EV_TX_NLABELS
operator|==
operator|(
literal|1
operator|<<
name|FRF_AZ_TX_DESCQ_LABEL_WIDTH
operator|)
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|label
argument_list|,
operator|<
argument_list|,
name|EFX_EV_TX_NLABELS
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|ISP2
argument_list|(
name|EFX_TXQ_MAXNDESCS
argument_list|(
name|encp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|ISP2
argument_list|(
name|EFX_TXQ_MINNDESCS
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ISP2
argument_list|(
name|n
argument_list|)
operator|||
operator|(
name|n
operator|<
name|EFX_TXQ_MINNDESCS
operator|)
operator|||
operator|(
name|n
operator|>
name|EFX_EVQ_MAXNEVS
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|index
operator|>=
name|encp
operator|->
name|enc_txq_limit
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
for|for
control|(
name|size
operator|=
literal|0
init|;
operator|(
literal|1
operator|<<
name|size
operator|)
operator|<=
operator|(
name|EFX_TXQ_MAXNDESCS
argument_list|(
name|encp
argument_list|)
operator|/
name|EFX_TXQ_MINNDESCS
operator|)
condition|;
name|size
operator|++
control|)
if|if
condition|(
operator|(
literal|1
operator|<<
name|size
operator|)
operator|==
call|(
name|int
call|)
argument_list|(
name|n
operator|/
name|EFX_TXQ_MINNDESCS
argument_list|)
condition|)
break|break;
if|if
condition|(
name|id
operator|+
operator|(
literal|1
operator|<<
name|size
operator|)
operator|>=
name|encp
operator|->
name|enc_buftbl_limit
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
comment|/* Set up the new descriptor queue */
operator|*
name|addedp
operator|=
literal|0
expr_stmt|;
name|EFX_POPULATE_OWORD_6
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESCQ_BUF_BASE_ID
argument_list|,
name|id
argument_list|,
name|FRF_AZ_TX_DESCQ_EVQ_ID
argument_list|,
name|eep
operator|->
name|ee_index
argument_list|,
name|FRF_AZ_TX_DESCQ_OWNER_ID
argument_list|,
literal|0
argument_list|,
name|FRF_AZ_TX_DESCQ_LABEL
argument_list|,
name|label
argument_list|,
name|FRF_AZ_TX_DESCQ_SIZE
argument_list|,
name|size
argument_list|,
name|FRF_AZ_TX_DESCQ_TYPE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_NON_IP_DROP_DIS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_IP_CHKSM_DIS
argument_list|,
operator|(
name|flags
operator|&
name|EFX_TXQ_CKSUM_IPV4
operator|)
condition|?
literal|0
else|:
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_TCP_CHKSM_DIS
argument_list|,
operator|(
name|flags
operator|&
name|EFX_TXQ_CKSUM_TCPUDP
operator|)
condition|?
literal|0
else|:
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|falconsiena_tx_qdesc_post
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efx_desc_t
operator|*
name|ed
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__inout
name|unsigned
name|int
operator|*
name|addedp
argument_list|)
block|{
name|unsigned
name|int
name|added
init|=
operator|*
name|addedp
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|added
operator|-
name|completed
operator|+
name|n
operator|>
name|EFX_TXQ_LIMIT
argument_list|(
name|etp
operator|->
name|et_mask
operator|+
literal|1
argument_list|)
condition|)
block|{
name|rc
operator|=
name|ENOSPC
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|efx_desc_t
modifier|*
name|edp
init|=
operator|&
name|ed
index|[
name|i
index|]
decl_stmt|;
name|unsigned
name|int
name|id
decl_stmt|;
name|size_t
name|offset
decl_stmt|;
name|id
operator|=
name|added
operator|++
operator|&
name|etp
operator|->
name|et_mask
expr_stmt|;
name|offset
operator|=
name|id
operator|*
sizeof|sizeof
argument_list|(
name|efx_desc_t
argument_list|)
expr_stmt|;
name|EFSYS_MEM_WRITEQ
argument_list|(
name|etp
operator|->
name|et_esmp
argument_list|,
name|offset
argument_list|,
operator|&
name|edp
operator|->
name|ed_eq
argument_list|)
expr_stmt|;
block|}
name|EFSYS_PROBE3
argument_list|(
argument|tx_desc_post
argument_list|,
argument|unsigned int
argument_list|,
argument|etp->et_index
argument_list|,
argument|unsigned int
argument_list|,
argument|added
argument_list|,
argument|unsigned int
argument_list|,
argument|n
argument_list|)
empty_stmt|;
name|EFX_TX_QSTAT_INCR
argument_list|(
name|etp
argument_list|,
name|TX_POST
argument_list|)
expr_stmt|;
operator|*
name|addedp
operator|=
name|added
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_function
name|void
name|falconsiena_tx_qdesc_dma_create
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|efsys_dma_addr_t
name|addr
parameter_list|,
name|__in
name|size_t
name|size
parameter_list|,
name|__in
name|boolean_t
name|eop
parameter_list|,
name|__out
name|efx_desc_t
modifier|*
name|edp
parameter_list|)
block|{
comment|/* Fragments must not span 4k boundaries. */
name|EFSYS_ASSERT
argument_list|(
name|P2ROUNDUP
argument_list|(
name|addr
operator|+
literal|1
argument_list|,
literal|4096
argument_list|)
operator|>=
name|addr
operator|+
name|size
argument_list|)
expr_stmt|;
name|EFSYS_PROBE4
argument_list|(
argument|tx_desc_dma_create
argument_list|,
argument|unsigned int
argument_list|,
argument|etp->et_index
argument_list|,
argument|efsys_dma_addr_t
argument_list|,
argument|addr
argument_list|,
argument|size_t
argument_list|,
argument|size
argument_list|,
argument|boolean_t
argument_list|,
argument|eop
argument_list|)
empty_stmt|;
name|EFX_POPULATE_QWORD_4
argument_list|(
name|edp
operator|->
name|ed_eq
argument_list|,
name|FSF_AZ_TX_KER_CONT
argument_list|,
name|eop
condition|?
literal|0
else|:
literal|1
argument_list|,
name|FSF_AZ_TX_KER_BYTE_COUNT
argument_list|,
operator|(
name|uint32_t
operator|)
name|size
argument_list|,
name|FSF_AZ_TX_KER_BUF_ADDR_DW0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|&
literal|0xffffffff
argument_list|)
argument_list|,
name|FSF_AZ_TX_KER_BUF_ADDR_DW1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_FALCON || EFSYS_OPT_SIENA */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_if
if|#
directive|if
name|EFSYS_OPT_NAMES
end_if

begin_comment
comment|/* START MKCONFIG GENERATED EfxTransmitQueueStatNamesBlock 9d8d26a0a5e2c453 */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|__efx_tx_qstat_name
index|[]
init|=
block|{
literal|"post"
block|,
literal|"post_pio"
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* END MKCONFIG GENERATED EfxTransmitQueueStatNamesBlock */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|efx_tx_qstat_name
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|id
argument_list|,
operator|<
argument_list|,
name|TX_NQSTATS
argument_list|)
expr_stmt|;
return|return
operator|(
name|__efx_tx_qstat_name
index|[
name|id
index|]
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_NAMES */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_QSTATS */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_FALCON
operator|||
name|EFSYS_OPT_SIENA
end_if

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_decl_stmt
specifier|static
name|void
name|falconsiena_tx_qstats_update
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__inout_ecount
argument_list|(
argument|TX_NQSTATS
argument_list|)
name|efsys_stat_t
operator|*
name|stat
argument_list|)
block|{
name|unsigned
name|int
name|id
decl_stmt|;
for|for
control|(
name|id
operator|=
literal|0
init|;
name|id
operator|<
name|TX_NQSTATS
condition|;
name|id
operator|++
control|)
block|{
name|efsys_stat_t
modifier|*
name|essp
init|=
operator|&
name|stat
index|[
name|id
index|]
decl_stmt|;
name|EFSYS_STAT_INCR
argument_list|(
name|essp
argument_list|,
name|etp
operator|->
name|et_stat
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|etp
operator|->
name|et_stat
index|[
name|id
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_QSTATS */
end_comment

begin_function
specifier|static
name|void
name|falconsiena_tx_qdestroy
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
comment|/* Purge descriptor queue */
name|EFX_ZERO_OWORD
argument_list|(
name|oword
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|falconsiena_tx_fini
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_FALCON || EFSYS_OPT_SIENA */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2007-2009 Solarflare Communications Inc.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"efsys.h"
end_include

begin_include
include|#
directive|include
file|"efx.h"
end_include

begin_include
include|#
directive|include
file|"efx_types.h"
end_include

begin_include
include|#
directive|include
file|"efx_regs.h"
end_include

begin_include
include|#
directive|include
file|"efx_impl.h"
end_include

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_define
define|#
directive|define
name|EFX_TX_QSTAT_INCR
parameter_list|(
name|_etp
parameter_list|,
name|_stat
parameter_list|)
define|\
value|do {								\ 		(_etp)->et_stat[_stat]++;				\ 	_NOTE(CONSTANTCONDITION)					\ 	} while (B_FALSE)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|EFX_TX_QSTAT_INCR
parameter_list|(
name|_etp
parameter_list|,
name|_stat
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|__checkReturn
name|int
name|efx_tx_init
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_oword_t
name|oword
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_NIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|enp
operator|->
name|en_mod_flags
operator|&
name|EFX_MOD_EV
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|enp
operator|->
name|en_mod_flags
operator|&
name|EFX_MOD_TX
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_tx_qcount
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Disable the timer-based TX DMA backoff and allow TX DMA to be 	 * controlled by the RX FIFO fill level (although always allow a 	 * minimal trickle). 	 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_RESERVED_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_RX_SPACER
argument_list|,
literal|0xfe
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_RX_SPACER_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_ONE_PKT_PER_Q
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_PUSH_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DIS_NON_IP_EV
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_PREF_THRESHOLD
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_PREF_WD_TMR
argument_list|,
literal|0x3fffff
argument_list|)
expr_stmt|;
comment|/* 	 * Filter all packets less than 14 bytes to avoid parsing 	 * errors. 	 */
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_FLUSH_MIN_LEN_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_RESERVED_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* 	 * Do not set TX_NO_EOP_DISC_EN, since it limits packets to 16 	 * descriptors (which is bad). 	 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_NO_EOP_DISC_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator||=
name|EFX_MOD_TX
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_FILTER
end_if

begin_function
specifier|extern
name|__checkReturn
name|int
name|efx_tx_filter_insert
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__inout
name|efx_filter_spec_t
modifier|*
name|spec
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3P
argument_list|(
name|spec
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|spec
operator|->
name|efs_dmaq_id
operator|=
operator|(
name|uint16_t
operator|)
name|etp
operator|->
name|et_index
expr_stmt|;
return|return
operator|(
name|efx_filter_insert_filter
argument_list|(
name|etp
operator|->
name|et_enp
argument_list|,
name|spec
argument_list|,
name|B_FALSE
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_FILTER
end_if

begin_function
specifier|extern
name|__checkReturn
name|int
name|efx_tx_filter_remove
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__inout
name|efx_filter_spec_t
modifier|*
name|spec
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3P
argument_list|(
name|spec
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|spec
operator|->
name|efs_dmaq_id
operator|=
operator|(
name|uint16_t
operator|)
name|etp
operator|->
name|et_index
expr_stmt|;
return|return
operator|(
name|efx_filter_remove_filter
argument_list|(
name|etp
operator|->
name|et_enp
argument_list|,
name|spec
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|EFX_TX_DESC
parameter_list|(
name|_etp
parameter_list|,
name|_addr
parameter_list|,
name|_size
parameter_list|,
name|_eop
parameter_list|,
name|_added
parameter_list|)
define|\
value|do {								\ 		unsigned int id;					\ 		size_t offset;						\ 		efx_qword_t qword;					\ 									\ 		id = (_added)++& (_etp)->et_mask;			\ 		offset = id * sizeof (efx_qword_t);			\ 									\ 		EFSYS_PROBE5(tx_post, unsigned int, (_etp)->et_index,	\ 		    unsigned int, id, efsys_dma_addr_t, (_addr),	\ 		    size_t, (_size), boolean_t, (_eop));		\ 									\ 		EFX_POPULATE_QWORD_4(qword,				\ 		    FSF_AZ_TX_KER_CONT, (_eop) ? 0 : 1,			\ 		    FSF_AZ_TX_KER_BYTE_COUNT, (uint32_t)(_size),	\ 		    FSF_AZ_TX_KER_BUF_ADDR_DW0,				\ 		    (uint32_t)((_addr)& 0xffffffff),			\ 		    FSF_AZ_TX_KER_BUF_ADDR_DW1,				\ 		    (uint32_t)((_addr)>> 32));				\ 		EFSYS_MEM_WRITEQ((_etp)->et_esmp, offset,&qword);	\ 									\ 		_NOTE(CONSTANTCONDITION)				\ 	} while (B_FALSE)
end_define

begin_decl_stmt
name|__checkReturn
name|int
name|efx_tx_qpost
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efx_buffer_t
operator|*
name|eb
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__inout
name|unsigned
name|int
operator|*
name|addedp
argument_list|)
block|{
name|unsigned
name|int
name|added
init|=
operator|*
name|addedp
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|int
name|rc
init|=
name|ENOSPC
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|added
operator|-
name|completed
operator|+
name|n
operator|>
name|EFX_TXQ_LIMIT
argument_list|(
name|etp
operator|->
name|et_mask
operator|+
literal|1
argument_list|)
condition|)
goto|goto
name|fail1
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|efx_buffer_t
modifier|*
name|ebp
init|=
operator|&
name|eb
index|[
name|i
index|]
decl_stmt|;
name|efsys_dma_addr_t
name|start
init|=
name|ebp
operator|->
name|eb_addr
decl_stmt|;
name|size_t
name|size
init|=
name|ebp
operator|->
name|eb_size
decl_stmt|;
name|efsys_dma_addr_t
name|end
init|=
name|start
operator|+
name|size
decl_stmt|;
comment|/* Fragments must not span 4k boundaries. */
name|EFSYS_ASSERT
argument_list|(
name|P2ROUNDUP
argument_list|(
name|start
operator|+
literal|1
argument_list|,
literal|4096
argument_list|)
operator|>=
name|end
argument_list|)
expr_stmt|;
name|EFX_TX_DESC
argument_list|(
name|etp
argument_list|,
name|start
argument_list|,
name|size
argument_list|,
name|ebp
operator|->
name|eb_eop
argument_list|,
name|added
argument_list|)
expr_stmt|;
block|}
name|EFX_TX_QSTAT_INCR
argument_list|(
name|etp
argument_list|,
name|TX_POST
argument_list|)
expr_stmt|;
operator|*
name|addedp
operator|=
name|added
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_function
name|void
name|efx_tx_qpush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|,
name|__in
name|unsigned
name|int
name|added
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|uint32_t
name|wptr
decl_stmt|;
name|efx_dword_t
name|dword
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
comment|/* Guarantee ordering of memory (descriptors) and PIO (doorbell) */
name|EFSYS_PIO_WRITE_BARRIER
argument_list|()
expr_stmt|;
comment|/* Push the populated descriptors out */
name|wptr
operator|=
name|added
operator|&
name|etp
operator|->
name|et_mask
expr_stmt|;
name|EFX_POPULATE_OWORD_1
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESC_WPTR
argument_list|,
name|wptr
argument_list|)
expr_stmt|;
comment|/* Only write the third DWORD */
name|EFX_POPULATE_DWORD_1
argument_list|(
name|dword
argument_list|,
name|EFX_DWORD_0
argument_list|,
name|EFX_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|EFX_DWORD_3
argument_list|)
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITED3
argument_list|(
name|enp
argument_list|,
name|FR_BZ_TX_DESC_UPD_REGP0
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|dword
argument_list|,
name|B_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_tx_qflush
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|uint32_t
name|label
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|label
operator|=
name|etp
operator|->
name|et_index
expr_stmt|;
comment|/* Flush the queue */
name|EFX_POPULATE_OWORD_2
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_FLUSH_DESCQ_CMD
argument_list|,
literal|1
argument_list|,
name|FRF_AZ_TX_FLUSH_DESCQ
argument_list|,
name|label
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_FLUSH_DESCQ_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_tx_qenable
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFSYS_PROBE5
argument_list|(
argument|tx_descq_ptr
argument_list|,
argument|unsigned int
argument_list|,
argument|etp->et_index
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_3)
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_2)
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_1)
argument_list|,
argument|uint32_t
argument_list|,
argument|EFX_OWORD_FIELD(oword, EFX_DWORD_0)
argument_list|)
empty_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DC_HW_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESCQ_HW_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESCQ_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|int
name|efx_tx_qcreate
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|index
parameter_list|,
name|__in
name|unsigned
name|int
name|label
parameter_list|,
name|__in
name|efsys_mem_t
modifier|*
name|esmp
parameter_list|,
name|__in
name|size_t
name|n
parameter_list|,
name|__in
name|uint32_t
name|id
parameter_list|,
name|__in
name|uint16_t
name|flags
parameter_list|,
name|__in
name|efx_evq_t
modifier|*
name|eep
parameter_list|,
name|__deref_out
name|efx_txq_t
modifier|*
modifier|*
name|etpp
parameter_list|)
block|{
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|efx_txq_t
modifier|*
name|etp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_TX
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|EFX_EV_TX_NLABELS
operator|==
operator|(
literal|1
operator|<<
name|FRF_AZ_TX_DESCQ_LABEL_WIDTH
operator|)
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|label
argument_list|,
operator|<
argument_list|,
name|EFX_EV_TX_NLABELS
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_tx_qcount
operator|+
literal|1
argument_list|,
operator|<
argument_list|,
name|encp
operator|->
name|enc_txq_limit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ISP2
argument_list|(
name|n
argument_list|)
operator|||
operator|!
operator|(
name|n
operator|&
name|EFX_TXQ_NDESCS_MASK
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|index
operator|>=
name|encp
operator|->
name|enc_txq_limit
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
for|for
control|(
name|size
operator|=
literal|0
init|;
operator|(
literal|1
operator|<<
name|size
operator|)
operator|<=
operator|(
name|EFX_TXQ_MAXNDESCS
operator|/
name|EFX_TXQ_MINNDESCS
operator|)
condition|;
name|size
operator|++
control|)
if|if
condition|(
operator|(
literal|1
operator|<<
name|size
operator|)
operator|==
call|(
name|int
call|)
argument_list|(
name|n
operator|/
name|EFX_TXQ_MINNDESCS
argument_list|)
condition|)
break|break;
if|if
condition|(
name|id
operator|+
operator|(
literal|1
operator|<<
name|size
operator|)
operator|>=
name|encp
operator|->
name|enc_buftbl_limit
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
comment|/* Allocate an TXQ object */
name|EFSYS_KMEM_ALLOC
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_txq_t
argument_list|)
argument_list|,
name|etp
argument_list|)
expr_stmt|;
if|if
condition|(
name|etp
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail4
goto|;
block|}
name|etp
operator|->
name|et_magic
operator|=
name|EFX_TXQ_MAGIC
expr_stmt|;
name|etp
operator|->
name|et_enp
operator|=
name|enp
expr_stmt|;
name|etp
operator|->
name|et_index
operator|=
name|index
expr_stmt|;
name|etp
operator|->
name|et_mask
operator|=
name|n
operator|-
literal|1
expr_stmt|;
name|etp
operator|->
name|et_esmp
operator|=
name|esmp
expr_stmt|;
comment|/* Set up the new descriptor queue */
name|EFX_POPULATE_OWORD_6
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_TX_DESCQ_BUF_BASE_ID
argument_list|,
name|id
argument_list|,
name|FRF_AZ_TX_DESCQ_EVQ_ID
argument_list|,
name|eep
operator|->
name|ee_index
argument_list|,
name|FRF_AZ_TX_DESCQ_OWNER_ID
argument_list|,
literal|0
argument_list|,
name|FRF_AZ_TX_DESCQ_LABEL
argument_list|,
name|label
argument_list|,
name|FRF_AZ_TX_DESCQ_SIZE
argument_list|,
name|size
argument_list|,
name|FRF_AZ_TX_DESCQ_TYPE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_NON_IP_DROP_DIS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_IP_CHKSM_DIS
argument_list|,
operator|(
name|flags
operator|&
name|EFX_CKSUM_IPV4
operator|)
condition|?
literal|0
else|:
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_TX_TCP_CHKSM_DIS
argument_list|,
operator|(
name|flags
operator|&
name|EFX_CKSUM_TCPUDP
operator|)
condition|?
literal|0
else|:
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_tx_qcount
operator|++
expr_stmt|;
operator|*
name|etpp
operator|=
name|etp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail4
label|:
name|EFSYS_PROBE
argument_list|(
name|fail4
argument_list|)
expr_stmt|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_if
if|#
directive|if
name|EFSYS_OPT_NAMES
end_if

begin_comment
comment|/* START MKCONFIG GENERATED EfxTransmitQueueStatNamesBlock 78ca9ab00287fffb */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|__cs
modifier|*
name|__cs
name|__efx_tx_qstat_name
index|[]
init|=
block|{
literal|"post"
block|,
literal|"unaligned_split"
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* END MKCONFIG GENERATED EfxTransmitQueueStatNamesBlock */
end_comment

begin_function
specifier|const
name|char
name|__cs
modifier|*
name|efx_tx_qstat_name
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|id
argument_list|,
operator|<
argument_list|,
name|TX_NQSTATS
argument_list|)
expr_stmt|;
return|return
operator|(
name|__efx_tx_qstat_name
index|[
name|id
index|]
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_NAMES */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_QSTATS */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_QSTATS
end_if

begin_decl_stmt
name|void
name|efx_tx_qstats_update
argument_list|(
name|__in
name|efx_txq_t
operator|*
name|etp
argument_list|,
name|__inout_ecount
argument_list|(
argument|TX_NQSTATS
argument_list|)
name|efsys_stat_t
operator|*
name|stat
argument_list|)
block|{
name|unsigned
name|int
name|id
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
for|for
control|(
name|id
operator|=
literal|0
init|;
name|id
operator|<
name|TX_NQSTATS
condition|;
name|id
operator|++
control|)
block|{
name|efsys_stat_t
modifier|*
name|essp
init|=
operator|&
name|stat
index|[
name|id
index|]
decl_stmt|;
name|EFSYS_STAT_INCR
argument_list|(
name|essp
argument_list|,
name|etp
operator|->
name|et_stat
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|etp
operator|->
name|et_stat
index|[
name|id
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_QSTATS */
end_comment

begin_function
name|void
name|efx_tx_qdestroy
parameter_list|(
name|__in
name|efx_txq_t
modifier|*
name|etp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|etp
operator|->
name|et_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|etp
operator|->
name|et_magic
argument_list|,
operator|==
argument_list|,
name|EFX_TXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_tx_qcount
operator|!=
literal|0
argument_list|)
expr_stmt|;
operator|--
name|enp
operator|->
name|en_tx_qcount
expr_stmt|;
comment|/* Purge descriptor queue */
name|EFX_ZERO_OWORD
argument_list|(
name|oword
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_TX_DESC_PTR_TBL
argument_list|,
name|etp
operator|->
name|et_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* Free the TXQ object */
name|EFSYS_KMEM_FREE
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_txq_t
argument_list|)
argument_list|,
name|etp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_tx_fini
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_NIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_TX
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_tx_qcount
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator|&=
operator|~
name|EFX_MOD_TX
expr_stmt|;
block|}
end_function

end_unit


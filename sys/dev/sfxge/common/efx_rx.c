begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2007-2009 Solarflare Communications Inc.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"efsys.h"
end_include

begin_include
include|#
directive|include
file|"efx.h"
end_include

begin_include
include|#
directive|include
file|"efx_types.h"
end_include

begin_include
include|#
directive|include
file|"efx_regs.h"
end_include

begin_include
include|#
directive|include
file|"efx_impl.h"
end_include

begin_function
name|__checkReturn
name|int
name|efx_rx_init
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_oword_t
name|oword
decl_stmt|;
name|unsigned
name|int
name|index
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_NIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|enp
operator|->
name|en_mod_flags
operator|&
name|EFX_MOD_EV
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|enp
operator|->
name|en_mod_flags
operator|&
name|EFX_MOD_RX
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_RX_DESC_PUSH_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_RX_HASH_ALG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_RX_IP_HASH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_RX_TCP_SUP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_RX_HASH_INSRT_HDR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_RX_USR_BUF_SIZE
argument_list|,
literal|0x3000
operator|/
literal|32
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* Zero the RSS table */
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|FR_BZ_RX_INDIRECTION_TBL_ROWS
condition|;
name|index
operator|++
control|)
block|{
name|EFX_ZERO_OWORD
argument_list|(
name|oword
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_BZ_RX_INDIRECTION_TBL
argument_list|,
name|index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
block|}
name|enp
operator|->
name|en_mod_flags
operator||=
name|EFX_MOD_RX
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_HDR_SPLIT
end_if

begin_function
name|__checkReturn
name|int
name|efx_rx_hdr_split_enable
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|hdr_buf_size
parameter_list|,
name|__in
name|unsigned
name|int
name|pld_buf_size
parameter_list|)
block|{
name|unsigned
name|int
name|nhdr32
decl_stmt|;
name|unsigned
name|int
name|npld32
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_family
argument_list|,
operator|>=
argument_list|,
name|EFX_FAMILY_SIENA
argument_list|)
expr_stmt|;
name|nhdr32
operator|=
name|hdr_buf_size
operator|/
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|nhdr32
operator|==
literal|0
operator|)
operator|||
operator|(
name|nhdr32
operator|>=
operator|(
literal|1
operator|<<
name|FRF_CZ_RX_HDR_SPLIT_HDR_BUF_SIZE_WIDTH
operator|)
operator|)
operator|||
operator|(
operator|(
name|hdr_buf_size
operator|%
literal|32
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|npld32
operator|=
name|pld_buf_size
operator|/
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|npld32
operator|==
literal|0
operator|)
operator|||
operator|(
name|npld32
operator|>=
operator|(
literal|1
operator|<<
name|FRF_CZ_RX_HDR_SPLIT_PLD_BUF_SIZE_WIDTH
operator|)
operator|)
operator|||
operator|(
operator|(
name|pld_buf_size
operator|%
literal|32
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
name|enp
operator|->
name|en_rx_qcount
operator|>
literal|0
condition|)
block|{
name|rc
operator|=
name|EBUSY
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_CZ_RX_HDR_SPLIT_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_CZ_RX_HDR_SPLIT_HDR_BUF_SIZE
argument_list|,
name|nhdr32
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_CZ_RX_HDR_SPLIT_PLD_BUF_SIZE
argument_list|,
name|npld32
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_HDR_SPLIT */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCATTER
end_if

begin_function
name|__checkReturn
name|int
name|efx_rx_scatter_enable
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|buf_size
parameter_list|)
block|{
name|unsigned
name|int
name|nbuf32
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_family
argument_list|,
operator|>=
argument_list|,
name|EFX_FAMILY_FALCON
argument_list|)
expr_stmt|;
name|nbuf32
operator|=
name|buf_size
operator|/
literal|32
expr_stmt|;
if|if
condition|(
operator|(
name|nbuf32
operator|==
literal|0
operator|)
operator|||
operator|(
name|nbuf32
operator|>=
operator|(
literal|1
operator|<<
name|FRF_BZ_RX_USR_BUF_SIZE_WIDTH
operator|)
operator|)
operator|||
operator|(
operator|(
name|buf_size
operator|%
literal|32
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|enp
operator|->
name|en_rx_qcount
operator|>
literal|0
condition|)
block|{
name|rc
operator|=
name|EBUSY
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
comment|/* Set scatter buffer size */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_RX_USR_BUF_SIZE
argument_list|,
name|nbuf32
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_CFG_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* Enable scatter for packets not matching a filter */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_FILTER_CTL_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_SCATTER_ENBL_NO_MATCH_Q
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_FILTER_CTL_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCATTER */
end_comment

begin_define
define|#
directive|define
name|EFX_RX_LFSR_HASH
parameter_list|(
name|_enp
parameter_list|,
name|_insert
parameter_list|)
define|\
value|do {                                    			\ 		efx_oword_t oword;					\ 									\ 		EFX_BAR_READO((_enp), FR_AZ_RX_CFG_REG,&oword);	\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_HASH_ALG, 0);	\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_IP_HASH, 0);	\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_TCP_SUP, 0);	\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_HASH_INSRT_HDR,	\ 		    (_insert) ? 1 : 0);					\ 		EFX_BAR_WRITEO((_enp), FR_AZ_RX_CFG_REG,&oword);	\ 									\ 		if ((_enp)->en_family == EFX_FAMILY_SIENA) {		\ 			EFX_BAR_READO((_enp), FR_CZ_RX_RSS_IPV6_REG3,	\&oword);					\ 			EFX_SET_OWORD_FIELD(oword,			\ 			    FRF_CZ_RX_RSS_IPV6_THASH_ENABLE, 0);	\ 			EFX_BAR_WRITEO((_enp), FR_CZ_RX_RSS_IPV6_REG3,	\&oword);					\ 		}							\ 									\ 		_NOTE(CONSTANTCONDITION)				\ 	} while (B_FALSE)
end_define

begin_define
define|#
directive|define
name|EFX_RX_TOEPLITZ_IPV4_HASH
parameter_list|(
name|_enp
parameter_list|,
name|_insert
parameter_list|,
name|_ip
parameter_list|,
name|_tcp
parameter_list|)
define|\
value|do {                                    			\ 		efx_oword_t oword;					\ 									\ 		EFX_BAR_READO((_enp), FR_AZ_RX_CFG_REG,&oword);	\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_HASH_ALG, 1);	\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_IP_HASH,		\ 		    (_ip) ? 1 : 0);					\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_TCP_SUP,		\ 		    (_tcp) ? 0 : 1);					\ 		EFX_SET_OWORD_FIELD(oword, FRF_BZ_RX_HASH_INSRT_HDR,	\ 		    (_insert) ? 1 : 0);					\ 		EFX_BAR_WRITEO((_enp), FR_AZ_RX_CFG_REG,&oword);	\ 									\ 		_NOTE(CONSTANTCONDITION)				\ 	} while (B_FALSE)
end_define

begin_define
define|#
directive|define
name|EFX_RX_TOEPLITZ_IPV6_HASH
parameter_list|(
name|_enp
parameter_list|,
name|_ip
parameter_list|,
name|_tcp
parameter_list|,
name|_rc
parameter_list|)
define|\
value|do {                                    			\ 		efx_oword_t oword;					\ 									\ 		if ((_enp)->en_family == EFX_FAMILY_FALCON) {		\ 			(_rc) = ((_ip) || (_tcp)) ? ENOTSUP : 0;	\ 			break;						\ 		}							\ 									\ 		EFX_BAR_READO((_enp), FR_CZ_RX_RSS_IPV6_REG3,&oword);	\ 		EFX_SET_OWORD_FIELD(oword,				\ 		    FRF_CZ_RX_RSS_IPV6_THASH_ENABLE, 1);		\ 		EFX_SET_OWORD_FIELD(oword,				\ 		    FRF_CZ_RX_RSS_IPV6_IP_THASH_ENABLE, (_ip) ? 1 : 0);	\ 		EFX_SET_OWORD_FIELD(oword,				\ 		    FRF_CZ_RX_RSS_IPV6_TCP_SUPPRESS, (_tcp) ? 0 : 1);	\ 		EFX_BAR_WRITEO((_enp), FR_CZ_RX_RSS_IPV6_REG3,&oword);	\ 									\ 		(_rc) = 0;						\ 									\ 		_NOTE(CONSTANTCONDITION)				\ 	} while (B_FALSE)
end_define

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_function
name|__checkReturn
name|int
name|efx_rx_scale_mode_set
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|efx_rx_hash_alg_t
name|alg
parameter_list|,
name|__in
name|efx_rx_hash_type_t
name|type
parameter_list|,
name|__in
name|boolean_t
name|insert
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_family
argument_list|,
operator|>=
argument_list|,
name|EFX_FAMILY_FALCON
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|EFX_RX_HASHALG_LFSR
case|:
name|EFX_RX_LFSR_HASH
argument_list|(
name|enp
argument_list|,
name|insert
argument_list|)
expr_stmt|;
break|break;
case|case
name|EFX_RX_HASHALG_TOEPLITZ
case|:
name|EFX_RX_TOEPLITZ_IPV4_HASH
argument_list|(
name|enp
argument_list|,
name|insert
argument_list|,
name|type
operator|&
operator|(
literal|1
operator|<<
name|EFX_RX_HASH_IPV4
operator|)
argument_list|,
name|type
operator|&
operator|(
literal|1
operator|<<
name|EFX_RX_HASH_TCPIPV4
operator|)
argument_list|)
expr_stmt|;
name|EFX_RX_TOEPLITZ_IPV6_HASH
argument_list|(
name|enp
argument_list|,
name|type
operator|&
operator|(
literal|1
operator|<<
name|EFX_RX_HASH_IPV6
operator|)
argument_list|,
name|type
operator|&
operator|(
literal|1
operator|<<
name|EFX_RX_HASH_TCPIPV6
operator|)
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
break|break;
default|default:
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|EFX_RX_LFSR_HASH
argument_list|(
name|enp
argument_list|,
name|B_FALSE
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_decl_stmt
name|__checkReturn
name|int
name|efx_rx_scale_toeplitz_ipv4_key_set
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|uint8_t
operator|*
name|key
argument_list|,
name|__in
name|size_t
name|n
argument_list|)
block|{
name|efx_oword_t
name|oword
decl_stmt|;
name|unsigned
name|int
name|byte
decl_stmt|;
name|unsigned
name|int
name|offset
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
comment|/* Write toeplitz hash key */
name|EFX_ZERO_OWORD
argument_list|(
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_BZ_RX_RSS_TKEY_LBN
operator|+
name|FRF_BZ_RX_RSS_TKEY_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|=
name|key
index|[
name|byte
operator|++
index|]
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_BZ_RX_RSS_TKEY_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
comment|/* Verify toeplitz hash key */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_BZ_RX_RSS_TKEY_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_BZ_RX_RSS_TKEY_LBN
operator|+
name|FRF_BZ_RX_RSS_TKEY_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
block|{
if|if
condition|(
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|!=
name|key
index|[
name|byte
operator|++
index|]
condition|)
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_decl_stmt
name|__checkReturn
name|int
name|efx_rx_scale_toeplitz_ipv6_key_set
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|uint8_t
operator|*
name|key
argument_list|,
name|__in
name|size_t
name|n
argument_list|)
block|{
name|efx_oword_t
name|oword
decl_stmt|;
name|unsigned
name|int
name|byte
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
comment|/* Write toeplitz hash key 3 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_CZ_RX_RSS_IPV6_REG3
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_CZ_RX_RSS_IPV6_TKEY_HI_LBN
operator|+
name|FRF_CZ_RX_RSS_IPV6_TKEY_HI_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|=
name|key
index|[
name|byte
operator|++
index|]
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_CZ_RX_RSS_IPV6_REG3
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* Write toeplitz hash key 2 */
name|EFX_ZERO_OWORD
argument_list|(
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_CZ_RX_RSS_IPV6_TKEY_MID_LBN
operator|+
name|FRF_CZ_RX_RSS_IPV6_TKEY_MID_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|=
name|key
index|[
name|byte
operator|++
index|]
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_CZ_RX_RSS_IPV6_REG2
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* Write toeplitz hash key 1 */
name|EFX_ZERO_OWORD
argument_list|(
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_CZ_RX_RSS_IPV6_TKEY_LO_LBN
operator|+
name|FRF_CZ_RX_RSS_IPV6_TKEY_LO_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|=
name|key
index|[
name|byte
operator|++
index|]
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_CZ_RX_RSS_IPV6_REG1
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
comment|/* Verify toeplitz hash key 3 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_CZ_RX_RSS_IPV6_REG3
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_CZ_RX_RSS_IPV6_TKEY_HI_LBN
operator|+
name|FRF_CZ_RX_RSS_IPV6_TKEY_HI_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
block|{
if|if
condition|(
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|!=
name|key
index|[
name|byte
operator|++
index|]
condition|)
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
block|}
comment|/* Verify toeplitz hash key 2 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_CZ_RX_RSS_IPV6_REG2
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_CZ_RX_RSS_IPV6_TKEY_MID_LBN
operator|+
name|FRF_CZ_RX_RSS_IPV6_TKEY_MID_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
block|{
if|if
condition|(
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|!=
name|key
index|[
name|byte
operator|++
index|]
condition|)
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
block|}
comment|/* Verify toeplitz hash key 1 */
name|EFX_BAR_READO
argument_list|(
name|enp
argument_list|,
name|FR_CZ_RX_RSS_IPV6_REG1
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
for|for
control|(
name|offset
operator|=
operator|(
name|FRF_CZ_RX_RSS_IPV6_TKEY_LO_LBN
operator|+
name|FRF_CZ_RX_RSS_IPV6_TKEY_LO_WIDTH
operator|)
operator|/
literal|8
init|;
name|offset
operator|>
literal|0
operator|&&
name|byte
operator|<
name|n
condition|;
operator|--
name|offset
control|)
block|{
if|if
condition|(
name|oword
operator|.
name|eo_u8
index|[
name|offset
operator|-
literal|1
index|]
operator|!=
name|key
index|[
name|byte
operator|++
index|]
condition|)
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_decl_stmt
name|__checkReturn
name|int
name|efx_rx_scale_tbl_set
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|unsigned
name|int
operator|*
name|table
argument_list|,
name|__in
name|size_t
name|n
argument_list|)
block|{
name|efx_oword_t
name|oword
decl_stmt|;
name|int
name|index
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|EFX_RSS_TBL_SIZE
operator|==
name|FR_BZ_RX_INDIRECTION_TBL_ROWS
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|EFX_MAXRSS
operator|==
operator|(
literal|1
operator|<<
name|FRF_BZ_IT_QUEUE_WIDTH
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|FR_BZ_RX_INDIRECTION_TBL_ROWS
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|FR_BZ_RX_INDIRECTION_TBL_ROWS
condition|;
name|index
operator|++
control|)
block|{
name|uint32_t
name|byte
decl_stmt|;
comment|/* Calculate the entry to place in the table */
name|byte
operator|=
operator|(
name|uint32_t
operator|)
name|table
index|[
name|index
operator|%
name|n
index|]
expr_stmt|;
name|EFSYS_PROBE2
argument_list|(
name|table
argument_list|,
name|int
argument_list|,
name|index
argument_list|,
name|uint32_t
argument_list|,
name|byte
argument_list|)
expr_stmt|;
name|EFX_POPULATE_OWORD_1
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_IT_QUEUE
argument_list|,
name|byte
argument_list|)
expr_stmt|;
comment|/* Write the table */
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_BZ_RX_INDIRECTION_TBL
argument_list|,
name|index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|index
operator|=
name|FR_BZ_RX_INDIRECTION_TBL_ROWS
operator|-
literal|1
init|;
name|index
operator|>=
literal|0
condition|;
operator|--
name|index
control|)
block|{
name|uint32_t
name|byte
decl_stmt|;
comment|/* Determine if we're starting a new batch */
name|byte
operator|=
operator|(
name|uint32_t
operator|)
name|table
index|[
name|index
operator|%
name|n
index|]
expr_stmt|;
comment|/* Read the table */
name|EFX_BAR_TBL_READO
argument_list|(
name|enp
argument_list|,
name|FR_BZ_RX_INDIRECTION_TBL
argument_list|,
name|index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* Verify the entry */
if|if
condition|(
name|EFX_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_BZ_IT_QUEUE
argument_list|)
operator|!=
name|byte
condition|)
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_FILTER
end_if

begin_function
specifier|extern
name|__checkReturn
name|int
name|efx_rx_filter_insert
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|,
name|__inout
name|efx_filter_spec_t
modifier|*
name|spec
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|erp
operator|->
name|er_magic
argument_list|,
operator|==
argument_list|,
name|EFX_RXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3P
argument_list|(
name|spec
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|spec
operator|->
name|efs_dmaq_id
operator|=
operator|(
name|uint16_t
operator|)
name|erp
operator|->
name|er_index
expr_stmt|;
return|return
operator|(
name|efx_filter_insert_filter
argument_list|(
name|erp
operator|->
name|er_enp
argument_list|,
name|spec
argument_list|,
name|B_FALSE
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|EFSYS_OPT_FILTER
end_if

begin_function
specifier|extern
name|__checkReturn
name|int
name|efx_rx_filter_remove
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|,
name|__inout
name|efx_filter_spec_t
modifier|*
name|spec
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|erp
operator|->
name|er_magic
argument_list|,
operator|==
argument_list|,
name|EFX_RXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3P
argument_list|(
name|spec
argument_list|,
operator|!=
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|spec
operator|->
name|efs_dmaq_id
operator|=
operator|(
name|uint16_t
operator|)
name|erp
operator|->
name|er_index
expr_stmt|;
return|return
operator|(
name|efx_filter_remove_filter
argument_list|(
name|erp
operator|->
name|er_enp
argument_list|,
name|spec
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|void
name|efx_rx_qpost
argument_list|(
name|__in
name|efx_rxq_t
operator|*
name|erp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efsys_dma_addr_t
operator|*
name|addrp
argument_list|,
name|__in
name|size_t
name|size
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__in
name|unsigned
name|int
name|added
argument_list|)
block|{
name|efx_qword_t
name|qword
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|unsigned
name|int
name|offset
decl_stmt|;
name|unsigned
name|int
name|id
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|erp
operator|->
name|er_magic
argument_list|,
operator|==
argument_list|,
name|EFX_RXQ_MAGIC
argument_list|)
expr_stmt|;
comment|/* The client driver must not overfill the queue */
name|EFSYS_ASSERT3U
argument_list|(
name|added
operator|-
name|completed
operator|+
name|n
argument_list|,
operator|<=
argument_list|,
name|EFX_RXQ_LIMIT
argument_list|(
name|erp
operator|->
name|er_mask
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|id
operator|=
name|added
operator|&
operator|(
name|erp
operator|->
name|er_mask
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|EFSYS_PROBE4
argument_list|(
argument|rx_post
argument_list|,
argument|unsigned int
argument_list|,
argument|erp->er_index
argument_list|,
argument|unsigned int
argument_list|,
argument|id
argument_list|,
argument|efsys_dma_addr_t
argument_list|,
argument|addrp[i]
argument_list|,
argument|size_t
argument_list|,
argument|size
argument_list|)
empty_stmt|;
name|EFX_POPULATE_QWORD_3
argument_list|(
name|qword
argument_list|,
name|FSF_AZ_RX_KER_BUF_SIZE
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|size
argument_list|)
argument_list|,
name|FSF_AZ_RX_KER_BUF_ADDR_DW0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addrp
index|[
name|i
index|]
operator|&
literal|0xffffffff
argument_list|)
argument_list|,
name|FSF_AZ_RX_KER_BUF_ADDR_DW1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addrp
index|[
name|i
index|]
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|offset
operator|=
name|id
operator|*
sizeof|sizeof
argument_list|(
name|efx_qword_t
argument_list|)
expr_stmt|;
name|EFSYS_MEM_WRITEQ
argument_list|(
name|erp
operator|->
name|er_esmp
argument_list|,
name|offset
argument_list|,
operator|&
name|qword
argument_list|)
expr_stmt|;
name|id
operator|=
operator|(
name|id
operator|+
literal|1
operator|)
operator|&
operator|(
name|erp
operator|->
name|er_mask
operator|)
expr_stmt|;
block|}
block|}
end_decl_stmt

begin_function
name|void
name|efx_rx_qpush
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|,
name|__in
name|unsigned
name|int
name|added
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|erp
operator|->
name|er_enp
decl_stmt|;
name|uint32_t
name|wptr
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|efx_dword_t
name|dword
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|erp
operator|->
name|er_magic
argument_list|,
operator|==
argument_list|,
name|EFX_RXQ_MAGIC
argument_list|)
expr_stmt|;
comment|/* Guarantee ordering of memory (descriptors) and PIO (doorbell) */
name|EFSYS_PIO_WRITE_BARRIER
argument_list|()
expr_stmt|;
comment|/* Push the populated descriptors out */
name|wptr
operator|=
name|added
operator|&
name|erp
operator|->
name|er_mask
expr_stmt|;
name|EFX_POPULATE_OWORD_1
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_RX_DESC_WPTR
argument_list|,
name|wptr
argument_list|)
expr_stmt|;
comment|/* Only write the third DWORD */
name|EFX_POPULATE_DWORD_1
argument_list|(
name|dword
argument_list|,
name|EFX_DWORD_0
argument_list|,
name|EFX_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|EFX_DWORD_3
argument_list|)
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITED3
argument_list|(
name|enp
argument_list|,
name|FR_BZ_RX_DESC_UPD_REGP0
argument_list|,
name|erp
operator|->
name|er_index
argument_list|,
operator|&
name|dword
argument_list|,
name|B_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_rx_qflush
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|erp
operator|->
name|er_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|uint32_t
name|label
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|erp
operator|->
name|er_magic
argument_list|,
operator|==
argument_list|,
name|EFX_RXQ_MAGIC
argument_list|)
expr_stmt|;
name|label
operator|=
name|erp
operator|->
name|er_index
expr_stmt|;
comment|/* Flush the queue */
name|EFX_POPULATE_OWORD_2
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_RX_FLUSH_DESCQ_CMD
argument_list|,
literal|1
argument_list|,
name|FRF_AZ_RX_FLUSH_DESCQ
argument_list|,
name|label
argument_list|)
expr_stmt|;
name|EFX_BAR_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_FLUSH_DESCQ_REG
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_rx_qenable
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|erp
operator|->
name|er_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|erp
operator|->
name|er_magic
argument_list|,
operator|==
argument_list|,
name|EFX_RXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_READO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_DESC_PTR_TBL
argument_list|,
name|erp
operator|->
name|er_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_RX_DC_HW_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_RX_DESCQ_HW_RPTR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EFX_SET_OWORD_FIELD
argument_list|(
name|oword
argument_list|,
name|FRF_AZ_RX_DESCQ_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_DESC_PTR_TBL
argument_list|,
name|erp
operator|->
name|er_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|int
name|efx_rx_qcreate
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|index
parameter_list|,
name|__in
name|unsigned
name|int
name|label
parameter_list|,
name|__in
name|efx_rxq_type_t
name|type
parameter_list|,
name|__in
name|efsys_mem_t
modifier|*
name|esmp
parameter_list|,
name|__in
name|size_t
name|n
parameter_list|,
name|__in
name|uint32_t
name|id
parameter_list|,
name|__in
name|efx_evq_t
modifier|*
name|eep
parameter_list|,
name|__deref_out
name|efx_rxq_t
modifier|*
modifier|*
name|erpp
parameter_list|)
block|{
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|efx_rxq_t
modifier|*
name|erp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|boolean_t
name|split
decl_stmt|;
name|boolean_t
name|jumbo
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|EFX_EV_RX_NLABELS
operator|==
operator|(
literal|1
operator|<<
name|FRF_AZ_RX_DESCQ_LABEL_WIDTH
operator|)
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|label
argument_list|,
operator|<
argument_list|,
name|EFX_EV_RX_NLABELS
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_rx_qcount
operator|+
literal|1
argument_list|,
operator|<
argument_list|,
name|encp
operator|->
name|enc_rxq_limit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ISP2
argument_list|(
name|n
argument_list|)
operator|||
operator|!
operator|(
name|n
operator|&
name|EFX_RXQ_NDESCS_MASK
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|index
operator|>=
name|encp
operator|->
name|enc_rxq_limit
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
for|for
control|(
name|size
operator|=
literal|0
init|;
operator|(
literal|1
operator|<<
name|size
operator|)
operator|<=
operator|(
name|EFX_RXQ_MAXNDESCS
operator|/
name|EFX_RXQ_MINNDESCS
operator|)
condition|;
name|size
operator|++
control|)
if|if
condition|(
operator|(
literal|1
operator|<<
name|size
operator|)
operator|==
call|(
name|int
call|)
argument_list|(
name|n
operator|/
name|EFX_RXQ_MINNDESCS
argument_list|)
condition|)
break|break;
if|if
condition|(
name|id
operator|+
operator|(
literal|1
operator|<<
name|size
operator|)
operator|>=
name|encp
operator|->
name|enc_buftbl_limit
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|EFX_RXQ_TYPE_DEFAULT
case|:
name|split
operator|=
name|B_FALSE
expr_stmt|;
name|jumbo
operator|=
name|B_FALSE
expr_stmt|;
break|break;
if|#
directive|if
name|EFSYS_OPT_RX_HDR_SPLIT
case|case
name|EFX_RXQ_TYPE_SPLIT_HEADER
case|:
if|if
condition|(
operator|(
name|enp
operator|->
name|en_family
operator|<
name|EFX_FAMILY_SIENA
operator|)
operator|||
operator|(
operator|(
name|index
operator|&
literal|1
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail4
goto|;
block|}
name|split
operator|=
name|B_TRUE
expr_stmt|;
name|jumbo
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
name|EFX_RXQ_TYPE_SPLIT_PAYLOAD
case|:
if|if
condition|(
operator|(
name|enp
operator|->
name|en_family
operator|<
name|EFX_FAMILY_SIENA
operator|)
operator|||
operator|(
operator|(
name|index
operator|&
literal|1
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail4
goto|;
block|}
name|split
operator|=
name|B_FALSE
expr_stmt|;
name|jumbo
operator|=
name|B_TRUE
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_RX_HDR_SPLIT */
if|#
directive|if
name|EFSYS_OPT_RX_SCATTER
case|case
name|EFX_RXQ_TYPE_SCATTER
case|:
if|if
condition|(
name|enp
operator|->
name|en_family
operator|<
name|EFX_FAMILY_SIENA
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail4
goto|;
block|}
name|split
operator|=
name|B_FALSE
expr_stmt|;
name|jumbo
operator|=
name|B_TRUE
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_RX_SCATTER */
default|default:
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail4
goto|;
block|}
comment|/* Allocate an RXQ object */
name|EFSYS_KMEM_ALLOC
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_rxq_t
argument_list|)
argument_list|,
name|erp
argument_list|)
expr_stmt|;
if|if
condition|(
name|erp
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|fail5
goto|;
block|}
name|erp
operator|->
name|er_magic
operator|=
name|EFX_RXQ_MAGIC
expr_stmt|;
name|erp
operator|->
name|er_enp
operator|=
name|enp
expr_stmt|;
name|erp
operator|->
name|er_index
operator|=
name|index
expr_stmt|;
name|erp
operator|->
name|er_mask
operator|=
name|n
operator|-
literal|1
expr_stmt|;
name|erp
operator|->
name|er_esmp
operator|=
name|esmp
expr_stmt|;
comment|/* Set up the new descriptor queue */
name|EFX_POPULATE_OWORD_10
argument_list|(
name|oword
argument_list|,
name|FRF_CZ_RX_HDR_SPLIT
argument_list|,
name|split
argument_list|,
name|FRF_AZ_RX_ISCSI_DDIG_EN
argument_list|,
literal|0
argument_list|,
name|FRF_AZ_RX_ISCSI_HDIG_EN
argument_list|,
literal|0
argument_list|,
name|FRF_AZ_RX_DESCQ_BUF_BASE_ID
argument_list|,
name|id
argument_list|,
name|FRF_AZ_RX_DESCQ_EVQ_ID
argument_list|,
name|eep
operator|->
name|ee_index
argument_list|,
name|FRF_AZ_RX_DESCQ_OWNER_ID
argument_list|,
literal|0
argument_list|,
name|FRF_AZ_RX_DESCQ_LABEL
argument_list|,
name|label
argument_list|,
name|FRF_AZ_RX_DESCQ_SIZE
argument_list|,
name|size
argument_list|,
name|FRF_AZ_RX_DESCQ_TYPE
argument_list|,
literal|0
argument_list|,
name|FRF_AZ_RX_DESCQ_JUMBO
argument_list|,
name|jumbo
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_DESC_PTR_TBL
argument_list|,
name|erp
operator|->
name|er_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_rx_qcount
operator|++
expr_stmt|;
operator|*
name|erpp
operator|=
name|erp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail5
label|:
name|EFSYS_PROBE
argument_list|(
name|fail5
argument_list|)
expr_stmt|;
name|fail4
label|:
name|EFSYS_PROBE
argument_list|(
name|fail4
argument_list|)
expr_stmt|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|efx_rx_qdestroy
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|erp
operator|->
name|er_enp
decl_stmt|;
name|efx_oword_t
name|oword
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|erp
operator|->
name|er_magic
argument_list|,
operator|==
argument_list|,
name|EFX_RXQ_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_rx_qcount
operator|!=
literal|0
argument_list|)
expr_stmt|;
operator|--
name|enp
operator|->
name|en_rx_qcount
expr_stmt|;
comment|/* Purge descriptor queue */
name|EFX_ZERO_OWORD
argument_list|(
name|oword
argument_list|)
expr_stmt|;
name|EFX_BAR_TBL_WRITEO
argument_list|(
name|enp
argument_list|,
name|FR_AZ_RX_DESC_PTR_TBL
argument_list|,
name|erp
operator|->
name|er_index
argument_list|,
operator|&
name|oword
argument_list|)
expr_stmt|;
comment|/* Free the RXQ object */
name|EFSYS_KMEM_FREE
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_rxq_t
argument_list|)
argument_list|,
name|erp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|efx_rx_fini
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_NIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_RX
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_rx_qcount
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator|&=
operator|~
name|EFX_MOD_RX
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2009 Solarflare Communications Inc.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"efsys.h"
end_include

begin_include
include|#
directive|include
file|"efx.h"
end_include

begin_include
include|#
directive|include
file|"efx_impl.h"
end_include

begin_if
if|#
directive|if
name|EFSYS_OPT_SIENA
end_if

begin_function
specifier|static
name|void
name|siena_phy_decode_cap
parameter_list|(
name|__in
name|uint32_t
name|mcdi_cap
parameter_list|,
name|__out
name|uint32_t
modifier|*
name|maskp
parameter_list|)
block|{
name|uint32_t
name|mask
decl_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_10HDX_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_10HDX
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_10FDX_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_10FDX
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_100HDX_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_100HDX
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_100FDX_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_100FDX
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_1000HDX_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_1000HDX
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_1000FDX_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_1000FDX
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_10000FDX_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_10000FDX
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_PAUSE_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_PAUSE
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_ASYM_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_ASYM
operator|)
expr_stmt|;
if|if
condition|(
name|mcdi_cap
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHY_CAP_AN_LBN
operator|)
condition|)
name|mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_AN
operator|)
expr_stmt|;
operator|*
name|maskp
operator|=
name|mask
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siena_phy_decode_link_mode
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint32_t
name|link_flags
parameter_list|,
name|__in
name|unsigned
name|int
name|speed
parameter_list|,
name|__in
name|unsigned
name|int
name|fcntl
parameter_list|,
name|__out
name|efx_link_mode_t
modifier|*
name|link_modep
parameter_list|,
name|__out
name|unsigned
name|int
modifier|*
name|fcntlp
parameter_list|)
block|{
name|boolean_t
name|fd
init|=
operator|!
operator|!
operator|(
name|link_flags
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_GET_LINK_OUT_FULL_DUPLEX_LBN
operator|)
operator|)
decl_stmt|;
name|boolean_t
name|up
init|=
operator|!
operator|!
operator|(
name|link_flags
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_GET_LINK_OUT_LINK_UP_LBN
operator|)
operator|)
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
if|if
condition|(
operator|!
name|up
condition|)
operator|*
name|link_modep
operator|=
name|EFX_LINK_DOWN
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
literal|10000
operator|&&
name|fd
condition|)
operator|*
name|link_modep
operator|=
name|EFX_LINK_10000FDX
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
literal|1000
condition|)
operator|*
name|link_modep
operator|=
name|fd
condition|?
name|EFX_LINK_1000FDX
else|:
name|EFX_LINK_1000HDX
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
literal|100
condition|)
operator|*
name|link_modep
operator|=
name|fd
condition|?
name|EFX_LINK_100FDX
else|:
name|EFX_LINK_100HDX
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
literal|10
condition|)
operator|*
name|link_modep
operator|=
name|fd
condition|?
name|EFX_LINK_10FDX
else|:
name|EFX_LINK_10HDX
expr_stmt|;
else|else
operator|*
name|link_modep
operator|=
name|EFX_LINK_UNKNOWN
expr_stmt|;
if|if
condition|(
name|fcntl
operator|==
name|MC_CMD_FCNTL_OFF
condition|)
operator|*
name|fcntlp
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|fcntl
operator|==
name|MC_CMD_FCNTL_RESPOND
condition|)
operator|*
name|fcntlp
operator|=
name|EFX_FCNTL_RESPOND
expr_stmt|;
elseif|else
if|if
condition|(
name|fcntl
operator|==
name|MC_CMD_FCNTL_BIDIR
condition|)
operator|*
name|fcntlp
operator|=
name|EFX_FCNTL_RESPOND
operator||
name|EFX_FCNTL_GENERATE
expr_stmt|;
else|else
block|{
name|EFSYS_PROBE1
argument_list|(
name|mc_pcol_error
argument_list|,
name|int
argument_list|,
name|fcntl
argument_list|)
expr_stmt|;
operator|*
name|fcntlp
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|siena_phy_link_ev
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|efx_qword_t
modifier|*
name|eqp
parameter_list|,
name|__out
name|efx_link_mode_t
modifier|*
name|link_modep
parameter_list|)
block|{
name|efx_port_t
modifier|*
name|epp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_port
operator|)
decl_stmt|;
name|unsigned
name|int
name|link_flags
decl_stmt|;
name|unsigned
name|int
name|speed
decl_stmt|;
name|unsigned
name|int
name|fcntl
decl_stmt|;
name|efx_link_mode_t
name|link_mode
decl_stmt|;
name|uint32_t
name|lp_cap_mask
decl_stmt|;
comment|/* 	 * Convert the LINKCHANGE speed enumeration into mbit/s, in the 	 * same way as GET_LINK encodes the speed 	 */
switch|switch
condition|(
name|MCDI_EV_FIELD
argument_list|(
name|eqp
argument_list|,
name|LINKCHANGE_SPEED
argument_list|)
condition|)
block|{
case|case
name|MCDI_EVENT_LINKCHANGE_SPEED_100M
case|:
name|speed
operator|=
literal|100
expr_stmt|;
break|break;
case|case
name|MCDI_EVENT_LINKCHANGE_SPEED_1G
case|:
name|speed
operator|=
literal|1000
expr_stmt|;
break|break;
case|case
name|MCDI_EVENT_LINKCHANGE_SPEED_10G
case|:
name|speed
operator|=
literal|10000
expr_stmt|;
break|break;
default|default:
name|speed
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|link_flags
operator|=
name|MCDI_EV_FIELD
argument_list|(
name|eqp
argument_list|,
name|LINKCHANGE_LINK_FLAGS
argument_list|)
expr_stmt|;
name|siena_phy_decode_link_mode
argument_list|(
name|enp
argument_list|,
name|link_flags
argument_list|,
name|speed
argument_list|,
name|MCDI_EV_FIELD
argument_list|(
name|eqp
argument_list|,
name|LINKCHANGE_FCNTL
argument_list|)
argument_list|,
operator|&
name|link_mode
argument_list|,
operator|&
name|fcntl
argument_list|)
expr_stmt|;
name|siena_phy_decode_cap
argument_list|(
name|MCDI_EV_FIELD
argument_list|(
name|eqp
argument_list|,
name|LINKCHANGE_LP_CAP
argument_list|)
argument_list|,
operator|&
name|lp_cap_mask
argument_list|)
expr_stmt|;
comment|/* 	 * It's safe to update ep_lp_cap_mask without the driver's port lock 	 * because presumably any concurrently running efx_port_poll() is 	 * only going to arrive at the same value. 	 * 	 * ep_fcntl has two meanings. It's either the link common fcntl 	 * (if the PHY supports AN), or it's the forced link state. If 	 * the former, it's safe to update the value for the same reason as 	 * for ep_lp_cap_mask. If the latter, then just ignore the value, 	 * because we can race with efx_mac_fcntl_set(). 	 */
name|epp
operator|->
name|ep_lp_cap_mask
operator|=
name|lp_cap_mask
expr_stmt|;
if|if
condition|(
name|epp
operator|->
name|ep_phy_cap_mask
operator|&
operator|(
literal|1
operator|<<
name|EFX_PHY_CAP_AN
operator|)
condition|)
name|epp
operator|->
name|ep_fcntl
operator|=
name|fcntl
expr_stmt|;
operator|*
name|link_modep
operator|=
name|link_mode
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|int
name|siena_phy_power
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|boolean_t
name|power
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
if|if
condition|(
operator|!
name|power
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Check if the PHY is a zombie */
if|if
condition|(
operator|(
name|rc
operator|=
name|siena_phy_verify
argument_list|(
name|enp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
name|enp
operator|->
name|en_reset_flags
operator||=
name|EFX_RESET_PHY
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|int
name|siena_phy_get_link
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|siena_link_state_t
modifier|*
name|slsp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|outbuf
index|[
name|MC_CMD_GET_LINK_OUT_LEN
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_GET_LINK
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_GET_LINK_IN_LEN
operator|==
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|outbuf
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
sizeof|sizeof
argument_list|(
name|outbuf
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_GET_LINK_OUT_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|siena_phy_decode_cap
argument_list|(
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LINK_OUT_CAP
argument_list|)
argument_list|,
operator|&
name|slsp
operator|->
name|sls_adv_cap_mask
argument_list|)
expr_stmt|;
name|siena_phy_decode_cap
argument_list|(
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LINK_OUT_LP_CAP
argument_list|)
argument_list|,
operator|&
name|slsp
operator|->
name|sls_lp_cap_mask
argument_list|)
expr_stmt|;
name|siena_phy_decode_link_mode
argument_list|(
name|enp
argument_list|,
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LINK_OUT_FLAGS
argument_list|)
argument_list|,
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LINK_OUT_LINK_SPEED
argument_list|)
argument_list|,
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LINK_OUT_FCNTL
argument_list|)
argument_list|,
operator|&
name|slsp
operator|->
name|sls_link_mode
argument_list|,
operator|&
name|slsp
operator|->
name|sls_fcntl
argument_list|)
expr_stmt|;
if|#
directive|if
name|EFSYS_OPT_LOOPBACK
comment|/* Assert the MC_CMD_LOOPBACK and EFX_LOOPBACK namespace agree */
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_NONE
operator|==
name|EFX_LOOPBACK_OFF
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_DATA
operator|==
name|EFX_LOOPBACK_DATA
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_GMAC
operator|==
name|EFX_LOOPBACK_GMAC
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_XGMII
operator|==
name|EFX_LOOPBACK_XGMII
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_XGXS
operator|==
name|EFX_LOOPBACK_XGXS
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_XAUI
operator|==
name|EFX_LOOPBACK_XAUI
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_GMII
operator|==
name|EFX_LOOPBACK_GMII
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_SGMII
operator|==
name|EFX_LOOPBACK_SGMII
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_XGBR
operator|==
name|EFX_LOOPBACK_XGBR
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_XFI
operator|==
name|EFX_LOOPBACK_XFI
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_XAUI_FAR
operator|==
name|EFX_LOOPBACK_XAUI_FAR
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_GMII_FAR
operator|==
name|EFX_LOOPBACK_GMII_FAR
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_SGMII_FAR
operator|==
name|EFX_LOOPBACK_SGMII_FAR
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_XFI_FAR
operator|==
name|EFX_LOOPBACK_XFI_FAR
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_GPHY
operator|==
name|EFX_LOOPBACK_GPHY
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_PHYXS
operator|==
name|EFX_LOOPBACK_PHY_XS
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_PCS
operator|==
name|EFX_LOOPBACK_PCS
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_LOOPBACK_PMAPMD
operator|==
name|EFX_LOOPBACK_PMA_PMD
argument_list|)
expr_stmt|;
name|slsp
operator|->
name|sls_loopback
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LINK_OUT_LOOPBACK_MODE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* EFSYS_OPT_LOOPBACK */
name|slsp
operator|->
name|sls_mac_up
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LINK_OUT_MAC_FAULT
argument_list|)
operator|==
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|int
name|siena_phy_reconfigure
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_port_t
modifier|*
name|epp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_port
operator|)
decl_stmt|;
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_SET_ID_LED_IN_LEN
argument_list|,
name|MC_CMD_SET_LINK_IN_LEN
argument_list|)
index|]
decl_stmt|;
name|uint32_t
name|cap_mask
decl_stmt|;
name|unsigned
name|int
name|led_mode
decl_stmt|;
name|unsigned
name|int
name|speed
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_SET_LINK
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_SET_LINK_IN_LEN
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_SET_LINK_OUT_LEN
operator|==
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
literal|0
expr_stmt|;
name|cap_mask
operator|=
name|epp
operator|->
name|ep_adv_cap_mask
expr_stmt|;
name|MCDI_IN_POPULATE_DWORD_10
argument_list|(
name|req
argument_list|,
name|SET_LINK_IN_CAP
argument_list|,
name|PHY_CAP_10HDX
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_10HDX
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_10FDX
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_10FDX
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_100HDX
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_100HDX
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_100FDX
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_100FDX
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_1000HDX
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_1000HDX
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_1000FDX
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_1000FDX
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_10000FDX
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_10000FDX
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_PAUSE
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_PAUSE
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_ASYM
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_ASYM
operator|)
operator|&
literal|0x1
argument_list|,
name|PHY_CAP_AN
argument_list|,
operator|(
name|cap_mask
operator|>>
name|EFX_PHY_CAP_AN
operator|)
operator|&
literal|0x1
argument_list|)
expr_stmt|;
if|#
directive|if
name|EFSYS_OPT_LOOPBACK
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|SET_LINK_IN_LOOPBACK_MODE
argument_list|,
name|epp
operator|->
name|ep_loopback_type
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|epp
operator|->
name|ep_loopback_link_mode
condition|)
block|{
case|case
name|EFX_LINK_100FDX
case|:
name|speed
operator|=
literal|100
expr_stmt|;
break|break;
case|case
name|EFX_LINK_1000FDX
case|:
name|speed
operator|=
literal|1000
expr_stmt|;
break|break;
case|case
name|EFX_LINK_10000FDX
case|:
name|speed
operator|=
literal|10000
expr_stmt|;
break|break;
default|default:
name|speed
operator|=
literal|0
expr_stmt|;
block|}
else|#
directive|else
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|SET_LINK_IN_LOOPBACK_MODE
argument_list|,
name|MC_CMD_LOOPBACK_NONE
argument_list|)
expr_stmt|;
name|speed
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* EFSYS_OPT_LOOPBACK */
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|SET_LINK_IN_LOOPBACK_SPEED
argument_list|,
name|speed
argument_list|)
expr_stmt|;
if|#
directive|if
name|EFSYS_OPT_PHY_FLAGS
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|SET_LINK_IN_FLAGS
argument_list|,
name|epp
operator|->
name|ep_phy_flags
argument_list|)
expr_stmt|;
else|#
directive|else
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|SET_LINK_IN_FLAGS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* EFSYS_OPT_PHY_FLAGS */
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
comment|/* And set the blink mode */
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_SET_ID_LED
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_SET_ID_LED_IN_LEN
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_SET_ID_LED_OUT_LEN
operator|==
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|EFSYS_OPT_PHY_LED_CONTROL
switch|switch
condition|(
name|epp
operator|->
name|ep_phy_led_mode
condition|)
block|{
case|case
name|EFX_PHY_LED_DEFAULT
case|:
name|led_mode
operator|=
name|MC_CMD_LED_DEFAULT
expr_stmt|;
break|break;
case|case
name|EFX_PHY_LED_OFF
case|:
name|led_mode
operator|=
name|MC_CMD_LED_OFF
expr_stmt|;
break|break;
case|case
name|EFX_PHY_LED_ON
case|:
name|led_mode
operator|=
name|MC_CMD_LED_ON
expr_stmt|;
break|break;
default|default:
name|EFSYS_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|led_mode
operator|=
name|MC_CMD_LED_DEFAULT
expr_stmt|;
block|}
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|SET_ID_LED_IN_STATE
argument_list|,
name|led_mode
argument_list|)
expr_stmt|;
else|#
directive|else
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|SET_ID_LED_IN_STATE
argument_list|,
name|MC_CMD_LED_DEFAULT
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* EFSYS_OPT_PHY_LED_CONTROL */
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|int
name|siena_phy_verify
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|outbuf
index|[
name|MC_CMD_GET_PHY_STATE_OUT_LEN
index|]
decl_stmt|;
name|uint32_t
name|state
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_GET_PHY_STATE
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_GET_PHY_STATE_IN_LEN
operator|==
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|outbuf
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
sizeof|sizeof
argument_list|(
name|outbuf
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_GET_PHY_STATE_OUT_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|state
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_PHY_STATE_OUT_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|!=
name|MC_CMD_PHY_STATE_OK
condition|)
block|{
if|if
condition|(
name|state
operator|!=
name|MC_CMD_PHY_STATE_ZOMBIE
condition|)
name|EFSYS_PROBE1
argument_list|(
name|mc_pcol_error
argument_list|,
name|int
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOTACTIVE
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|int
name|siena_phy_oui_get
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|uint32_t
modifier|*
name|ouip
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp, ouip)
argument_list|)
return|return
operator|(
name|ENOTSUP
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_PHY_STATS
end_if

begin_define
define|#
directive|define
name|SIENA_SIMPLE_STAT_SET
parameter_list|(
name|_vmask
parameter_list|,
name|_esmp
parameter_list|,
name|_smask
parameter_list|,
name|_stat
parameter_list|,		\
name|_mc_record
parameter_list|,
name|_efx_record
parameter_list|)
define|\
value|if ((_vmask)& (1ULL<< (_mc_record))) {			\ 		(_smask) |= (1ULL<< (_efx_record));			\ 		if ((_stat) != NULL&& !EFSYS_MEM_IS_NULL(_esmp)) {	\ 			efx_dword_t dword;				\ 			EFSYS_MEM_READD(_esmp, (_mc_record) * 4,&dword);\ 			(_stat)[_efx_record] =				\ 				EFX_DWORD_FIELD(dword, EFX_DWORD_0);	\ 		}							\ 	}
end_define

begin_define
define|#
directive|define
name|SIENA_SIMPLE_STAT_SET2
parameter_list|(
name|_vmask
parameter_list|,
name|_esmp
parameter_list|,
name|_smask
parameter_list|,
name|_stat
parameter_list|,
name|_record
parameter_list|)
define|\
value|SIENA_SIMPLE_STAT_SET(_vmask, _esmp, _smask, _stat, 		\ 			    MC_CMD_ ## _record,				\ 			    EFX_PHY_STAT_ ## _record)
end_define

begin_decl_stmt
name|void
name|siena_phy_decode_stats
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in
name|uint32_t
name|vmask
argument_list|,
name|__in_opt
name|efsys_mem_t
operator|*
name|esmp
argument_list|,
name|__out_opt
name|uint64_t
operator|*
name|smaskp
argument_list|,
name|__out_ecount_opt
argument_list|(
argument|EFX_PHY_NSTATS
argument_list|)
name|uint32_t
operator|*
name|stat
argument_list|)
block|{
name|uint64_t
name|smask
init|=
literal|0
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|OUI
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PMA_PMD_LINK_UP
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PMA_PMD_RX_FAULT
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PMA_PMD_TX_FAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|vmask
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PMA_PMD_SIGNAL
operator|)
condition|)
block|{
name|smask
operator||=
operator|(
operator|(
literal|1ULL
operator|<<
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_A
operator|)
operator||
operator|(
literal|1ULL
operator|<<
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_B
operator|)
operator||
operator|(
literal|1ULL
operator|<<
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_C
operator|)
operator||
operator|(
literal|1ULL
operator|<<
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_D
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|stat
operator|!=
name|NULL
operator|&&
name|esmp
operator|!=
name|NULL
operator|&&
operator|!
name|EFSYS_MEM_IS_NULL
argument_list|(
name|esmp
argument_list|)
condition|)
block|{
name|efx_dword_t
name|dword
decl_stmt|;
name|uint32_t
name|sig
decl_stmt|;
name|EFSYS_MEM_READD
argument_list|(
name|esmp
argument_list|,
literal|4
operator|*
name|MC_CMD_PMA_PMD_SIGNAL
argument_list|,
operator|&
name|dword
argument_list|)
expr_stmt|;
name|sig
operator|=
name|EFX_DWORD_FIELD
argument_list|(
name|dword
argument_list|,
name|EFX_DWORD_0
argument_list|)
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_A
index|]
operator|=
operator|(
name|sig
operator|>>
literal|1
operator|)
operator|&
literal|1
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_B
index|]
operator|=
operator|(
name|sig
operator|>>
literal|2
operator|)
operator|&
literal|1
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_C
index|]
operator|=
operator|(
name|sig
operator|>>
literal|3
operator|)
operator|&
literal|1
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PMA_PMD_SIGNAL_D
index|]
operator|=
operator|(
name|sig
operator|>>
literal|4
operator|)
operator|&
literal|1
expr_stmt|;
block|}
block|}
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PMA_PMD_SNR_A
argument_list|,
name|EFX_PHY_STAT_SNR_A
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PMA_PMD_SNR_B
argument_list|,
name|EFX_PHY_STAT_SNR_B
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PMA_PMD_SNR_C
argument_list|,
name|EFX_PHY_STAT_SNR_C
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PMA_PMD_SNR_D
argument_list|,
name|EFX_PHY_STAT_SNR_D
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PCS_LINK_UP
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PCS_RX_FAULT
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PCS_TX_FAULT
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PCS_BER
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|PCS_BLOCK_ERRORS
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PHYXS_LINK_UP
argument_list|,
name|EFX_PHY_STAT_PHY_XS_LINK_UP
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PHYXS_RX_FAULT
argument_list|,
name|EFX_PHY_STAT_PHY_XS_RX_FAULT
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PHYXS_TX_FAULT
argument_list|,
name|EFX_PHY_STAT_PHY_XS_TX_FAULT
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_PHYXS_ALIGN
argument_list|,
name|EFX_PHY_STAT_PHY_XS_ALIGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|vmask
operator|&
operator|(
literal|1
operator|<<
name|MC_CMD_PHYXS_SYNC
operator|)
condition|)
block|{
name|smask
operator||=
operator|(
operator|(
literal|1
operator|<<
name|EFX_PHY_STAT_PHY_XS_SYNC_A
operator|)
operator||
operator|(
literal|1
operator|<<
name|EFX_PHY_STAT_PHY_XS_SYNC_B
operator|)
operator||
operator|(
literal|1
operator|<<
name|EFX_PHY_STAT_PHY_XS_SYNC_C
operator|)
operator||
operator|(
literal|1
operator|<<
name|EFX_PHY_STAT_PHY_XS_SYNC_D
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|stat
operator|!=
name|NULL
operator|&&
operator|!
name|EFSYS_MEM_IS_NULL
argument_list|(
name|esmp
argument_list|)
condition|)
block|{
name|efx_dword_t
name|dword
decl_stmt|;
name|uint32_t
name|sync
decl_stmt|;
name|EFSYS_MEM_READD
argument_list|(
name|esmp
argument_list|,
literal|4
operator|*
name|MC_CMD_PHYXS_SYNC
argument_list|,
operator|&
name|dword
argument_list|)
expr_stmt|;
name|sync
operator|=
name|EFX_DWORD_FIELD
argument_list|(
name|dword
argument_list|,
name|EFX_DWORD_0
argument_list|)
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PHY_XS_SYNC_A
index|]
operator|=
operator|(
name|sync
operator|>>
literal|0
operator|)
operator|&
literal|1
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PHY_XS_SYNC_B
index|]
operator|=
operator|(
name|sync
operator|>>
literal|1
operator|)
operator|&
literal|1
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PHY_XS_SYNC_C
index|]
operator|=
operator|(
name|sync
operator|>>
literal|2
operator|)
operator|&
literal|1
expr_stmt|;
name|stat
index|[
name|EFX_PHY_STAT_PHY_XS_SYNC_D
index|]
operator|=
operator|(
name|sync
operator|>>
literal|3
operator|)
operator|&
literal|1
expr_stmt|;
block|}
block|}
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|AN_LINK_UP
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET2
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|AN_COMPLETE
argument_list|)
expr_stmt|;
name|SIENA_SIMPLE_STAT_SET
argument_list|(
name|vmask
argument_list|,
name|esmp
argument_list|,
name|smask
argument_list|,
name|stat
argument_list|,
name|MC_CMD_CL22_LINK_UP
argument_list|,
name|EFX_PHY_STAT_CL22EXT_LINK_UP
argument_list|)
expr_stmt|;
if|if
condition|(
name|smaskp
operator|!=
name|NULL
condition|)
operator|*
name|smaskp
operator|=
name|smask
expr_stmt|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|int
name|siena_phy_stats_update
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in
name|efsys_mem_t
operator|*
name|esmp
argument_list|,
name|__out_ecount
argument_list|(
argument|EFX_PHY_NSTATS
argument_list|)
name|uint32_t
operator|*
name|stat
argument_list|)
block|{
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|uint32_t
name|vmask
init|=
name|encp
operator|->
name|enc_siena_phy_stat_mask
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MC_CMD_PHY_STATS_IN_LEN
index|]
decl_stmt|;
name|uint64_t
name|smask
decl_stmt|;
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_PHY_STATS
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_PHY_STATS_OUT_DMA_LEN
operator|==
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
literal|0
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|PHY_STATS_IN_DMA_ADDR_LO
argument_list|,
name|EFSYS_MEM_ADDR
argument_list|(
name|esmp
argument_list|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|PHY_STATS_IN_DMA_ADDR_HI
argument_list|,
name|EFSYS_MEM_ADDR
argument_list|(
name|esmp
argument_list|)
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|EFSYS_ASSERT3U
argument_list|(
name|req
operator|.
name|emr_out_length
argument_list|,
operator|==
argument_list|,
name|MC_CMD_PHY_STATS_OUT_DMA_LEN
argument_list|)
expr_stmt|;
name|siena_phy_decode_stats
argument_list|(
name|enp
argument_list|,
name|vmask
argument_list|,
name|esmp
argument_list|,
operator|&
name|smask
argument_list|,
name|stat
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|smask
operator|==
name|encp
operator|->
name|enc_phy_stat_mask
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_PHY_STATS */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_PHY_PROPS
end_if

begin_if
if|#
directive|if
name|EFSYS_OPT_NAMES
end_if

begin_function
specifier|extern
specifier|const
name|char
name|__cs
modifier|*
name|siena_phy_prop_name
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp, id)
argument_list|)
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_NAMES */
end_comment

begin_function
specifier|extern
name|__checkReturn
name|int
name|siena_phy_prop_get
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|id
parameter_list|,
name|__in
name|uint32_t
name|flags
parameter_list|,
name|__out
name|uint32_t
modifier|*
name|valp
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp, id, flags, valp)
argument_list|)
return|return
operator|(
name|ENOTSUP
operator|)
return|;
block|}
end_function

begin_function
specifier|extern
name|__checkReturn
name|int
name|siena_phy_prop_set
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|id
parameter_list|,
name|__in
name|uint32_t
name|val
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp, id, val)
argument_list|)
return|return
operator|(
name|ENOTSUP
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_PHY_PROPS */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_PHY_BIST
end_if

begin_function
name|__checkReturn
name|int
name|siena_phy_bist_start
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|efx_phy_bist_type_t
name|type
parameter_list|)
block|{
name|uint8_t
name|payload
index|[
name|MC_CMD_START_BIST_IN_LEN
index|]
decl_stmt|;
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_START_BIST
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|MC_CMD_START_BIST_OUT_LEN
operator|==
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|EFX_PHY_BIST_TYPE_NORMAL
case|:
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|START_BIST_IN_TYPE
argument_list|,
name|MC_CMD_PHY_BIST
argument_list|)
expr_stmt|;
break|break;
case|case
name|EFX_PHY_BIST_TYPE_CABLE_SHORT
case|:
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|START_BIST_IN_TYPE
argument_list|,
name|MC_CMD_PHY_BIST_CABLE_SHORT
argument_list|)
expr_stmt|;
break|break;
case|case
name|EFX_PHY_BIST_TYPE_CABLE_LONG
case|:
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|START_BIST_IN_TYPE
argument_list|,
name|MC_CMD_PHY_BIST_CABLE_LONG
argument_list|)
expr_stmt|;
break|break;
default|default:
name|EFSYS_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|unsigned
name|long
name|siena_phy_sft9001_bist_status
parameter_list|(
name|__in
name|uint16_t
name|code
parameter_list|)
block|{
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|MC_CMD_POLL_BIST_SFT9001_PAIR_BUSY
case|:
return|return
operator|(
name|EFX_PHY_CABLE_STATUS_BUSY
operator|)
return|;
case|case
name|MC_CMD_POLL_BIST_SFT9001_INTER_PAIR_SHORT
case|:
return|return
operator|(
name|EFX_PHY_CABLE_STATUS_INTERPAIRSHORT
operator|)
return|;
case|case
name|MC_CMD_POLL_BIST_SFT9001_INTRA_PAIR_SHORT
case|:
return|return
operator|(
name|EFX_PHY_CABLE_STATUS_INTRAPAIRSHORT
operator|)
return|;
case|case
name|MC_CMD_POLL_BIST_SFT9001_PAIR_OPEN
case|:
return|return
operator|(
name|EFX_PHY_CABLE_STATUS_OPEN
operator|)
return|;
case|case
name|MC_CMD_POLL_BIST_SFT9001_PAIR_OK
case|:
return|return
operator|(
name|EFX_PHY_CABLE_STATUS_OK
operator|)
return|;
default|default:
return|return
operator|(
name|EFX_PHY_CABLE_STATUS_INVALID
operator|)
return|;
block|}
block|}
end_function

begin_decl_stmt
name|__checkReturn
name|int
name|siena_phy_bist_poll
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in
name|efx_phy_bist_type_t
name|type
argument_list|,
name|__out
name|efx_phy_bist_result_t
operator|*
name|resultp
argument_list|,
name|__out_opt
name|__drv_when
argument_list|(
argument|count>
literal|0
argument_list|,
argument|__notnull
argument_list|)
name|uint32_t
operator|*
name|value_maskp
argument_list|,
name|__out_ecount_opt
argument_list|(
argument|count
argument_list|)
name|__drv_when
argument_list|(
argument|count>
literal|0
argument_list|,
argument|__notnull
argument_list|)
name|unsigned
name|long
operator|*
name|valuesp
argument_list|,
name|__in
name|size_t
name|count
argument_list|)
block|{
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MCDI_CTL_SDU_LEN_MAX
index|]
decl_stmt|;
name|uint32_t
name|value_mask
init|=
literal|0
decl_stmt|;
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint32_t
name|result
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_POLL_BIST
expr_stmt|;
name|_NOTE
argument_list|(
argument|CONSTANTCONDITION
argument_list|)
name|EFSYS_ASSERT
argument_list|(
name|MC_CMD_POLL_BIST_IN_LEN
operator|==
literal|0
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_POLL_BIST_OUT_RESULT_OFST
operator|+
literal|4
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
name|count
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|memset
argument_list|(
name|valuesp
argument_list|,
literal|'\0'
argument_list|,
name|count
operator|*
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_RESULT
argument_list|)
expr_stmt|;
comment|/* Extract PHY specific results */
if|if
condition|(
name|result
operator|==
name|MC_CMD_POLL_BIST_PASSED
operator|&&
name|encp
operator|->
name|enc_phy_type
operator|==
name|EFX_PHY_SFT9001B
operator|&&
name|req
operator|.
name|emr_out_length_used
operator|>=
name|MC_CMD_POLL_BIST_OUT_SFT9001_LEN
operator|&&
operator|(
name|type
operator|==
name|EFX_PHY_BIST_TYPE_CABLE_SHORT
operator|||
name|type
operator|==
name|EFX_PHY_BIST_TYPE_CABLE_LONG
operator|)
condition|)
block|{
name|uint16_t
name|word
decl_stmt|;
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_LENGTH_A
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_LENGTH_A
index|]
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_LENGTH_A
argument_list|)
expr_stmt|;
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_LENGTH_A
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_LENGTH_B
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_LENGTH_B
index|]
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_LENGTH_B
argument_list|)
expr_stmt|;
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_LENGTH_B
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_LENGTH_C
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_LENGTH_C
index|]
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_LENGTH_C
argument_list|)
expr_stmt|;
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_LENGTH_C
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_LENGTH_D
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_LENGTH_D
index|]
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_LENGTH_D
argument_list|)
expr_stmt|;
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_LENGTH_D
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_STATUS_A
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
block|{
name|word
operator|=
name|MCDI_OUT_WORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_STATUS_A
argument_list|)
expr_stmt|;
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_STATUS_A
index|]
operator|=
name|siena_phy_sft9001_bist_status
argument_list|(
name|word
argument_list|)
expr_stmt|;
block|}
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_STATUS_A
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_STATUS_B
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
block|{
name|word
operator|=
name|MCDI_OUT_WORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_STATUS_B
argument_list|)
expr_stmt|;
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_STATUS_B
index|]
operator|=
name|siena_phy_sft9001_bist_status
argument_list|(
name|word
argument_list|)
expr_stmt|;
block|}
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_STATUS_B
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_STATUS_C
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
block|{
name|word
operator|=
name|MCDI_OUT_WORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_STATUS_C
argument_list|)
expr_stmt|;
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_STATUS_C
index|]
operator|=
name|siena_phy_sft9001_bist_status
argument_list|(
name|word
argument_list|)
expr_stmt|;
block|}
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_STATUS_C
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
name|EFX_PHY_BIST_CABLE_STATUS_D
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
block|{
name|word
operator|=
name|MCDI_OUT_WORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_SFT9001_CABLE_STATUS_D
argument_list|)
expr_stmt|;
name|valuesp
index|[
name|EFX_PHY_BIST_CABLE_STATUS_D
index|]
operator|=
name|siena_phy_sft9001_bist_status
argument_list|(
name|word
argument_list|)
expr_stmt|;
block|}
name|value_mask
operator||=
operator|(
literal|1
operator|<<
name|EFX_PHY_BIST_CABLE_STATUS_D
operator|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|result
operator|==
name|MC_CMD_POLL_BIST_FAILED
operator|&&
name|encp
operator|->
name|enc_phy_type
operator|==
name|EFX_PHY_QLX111V
operator|&&
name|req
operator|.
name|emr_out_length
operator|>=
name|MC_CMD_POLL_BIST_OUT_MRSFP_LEN
operator|&&
name|count
operator|>
name|EFX_PHY_BIST_FAULT_CODE
condition|)
block|{
if|if
condition|(
name|valuesp
operator|!=
name|NULL
condition|)
name|valuesp
index|[
name|EFX_PHY_BIST_FAULT_CODE
index|]
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|POLL_BIST_OUT_MRSFP_TEST
argument_list|)
expr_stmt|;
name|value_mask
operator||=
literal|1
operator|<<
name|EFX_PHY_BIST_FAULT_CODE
expr_stmt|;
block|}
if|if
condition|(
name|value_maskp
operator|!=
name|NULL
condition|)
operator|*
name|value_maskp
operator|=
name|value_mask
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|resultp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|MC_CMD_POLL_BIST_RUNNING
condition|)
operator|*
name|resultp
operator|=
name|EFX_PHY_BIST_RESULT_RUNNING
expr_stmt|;
elseif|else
if|if
condition|(
name|result
operator|==
name|MC_CMD_POLL_BIST_PASSED
condition|)
operator|*
name|resultp
operator|=
name|EFX_PHY_BIST_RESULT_PASSED
expr_stmt|;
else|else
operator|*
name|resultp
operator|=
name|EFX_PHY_BIST_RESULT_FAILED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|int
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_function
name|void
name|siena_phy_bist_stop
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|efx_phy_bist_type_t
name|type
parameter_list|)
block|{
comment|/* There is no way to stop BIST on Siena */
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp, type)
argument_list|)
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_PHY_BIST */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_SIENA */
end_comment

end_unit


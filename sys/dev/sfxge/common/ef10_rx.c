begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2012-2016 Solarflare Communications Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *  * 1. Redistributions of source code must retain the above copyright notice,  *    this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright notice,  *    this list of conditions and the following disclaimer in the documentation  *    and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * The views and conclusions contained in the software and documentation are  * those of the authors and should not be interpreted as representing official  * policies, either expressed or implied, of the FreeBSD Project.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"efx.h"
end_include

begin_include
include|#
directive|include
file|"efx_impl.h"
end_include

begin_if
if|#
directive|if
name|EFSYS_OPT_HUNTINGTON
operator|||
name|EFSYS_OPT_MEDFORD
end_if

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_init_rxq
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint32_t
name|size
parameter_list|,
name|__in
name|uint32_t
name|target_evq
parameter_list|,
name|__in
name|uint32_t
name|label
parameter_list|,
name|__in
name|uint32_t
name|instance
parameter_list|,
name|__in
name|efsys_mem_t
modifier|*
name|esmp
parameter_list|,
name|__in
name|boolean_t
name|disable_scatter
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_INIT_RXQ_IN_LEN
argument_list|(
name|EFX_RXQ_NBUFS
argument_list|(
name|EFX_RXQ_MAXNDESCS
argument_list|)
argument_list|)
argument_list|,
name|MC_CMD_INIT_RXQ_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|int
name|npages
init|=
name|EFX_RXQ_NBUFS
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|efx_qword_t
modifier|*
name|dma_addr
decl_stmt|;
name|uint64_t
name|addr
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|size
argument_list|,
operator|<=
argument_list|,
name|EFX_RXQ_MAXNDESCS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_INIT_RXQ
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_INIT_RXQ_IN_LEN
argument_list|(
name|npages
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_INIT_RXQ_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|INIT_RXQ_IN_SIZE
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|INIT_RXQ_IN_TARGET_EVQ
argument_list|,
name|target_evq
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|INIT_RXQ_IN_LABEL
argument_list|,
name|label
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|INIT_RXQ_IN_INSTANCE
argument_list|,
name|instance
argument_list|)
expr_stmt|;
name|MCDI_IN_POPULATE_DWORD_6
argument_list|(
name|req
argument_list|,
name|INIT_RXQ_IN_FLAGS
argument_list|,
name|INIT_RXQ_IN_FLAG_BUFF_MODE
argument_list|,
literal|0
argument_list|,
name|INIT_RXQ_IN_FLAG_HDR_SPLIT
argument_list|,
literal|0
argument_list|,
name|INIT_RXQ_IN_FLAG_TIMESTAMP
argument_list|,
literal|0
argument_list|,
name|INIT_RXQ_IN_CRC_MODE
argument_list|,
literal|0
argument_list|,
name|INIT_RXQ_IN_FLAG_PREFIX
argument_list|,
literal|1
argument_list|,
name|INIT_RXQ_IN_FLAG_DISABLE_SCATTER
argument_list|,
name|disable_scatter
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|INIT_RXQ_IN_OWNER_ID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|INIT_RXQ_IN_PORT_ID
argument_list|,
name|EVB_PORT_ID_ASSIGNED
argument_list|)
expr_stmt|;
name|dma_addr
operator|=
name|MCDI_IN2
argument_list|(
name|req
argument_list|,
name|efx_qword_t
argument_list|,
name|INIT_RXQ_IN_DMA_ADDR
argument_list|)
expr_stmt|;
name|addr
operator|=
name|EFSYS_MEM_ADDR
argument_list|(
name|esmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npages
condition|;
name|i
operator|++
control|)
block|{
name|EFX_POPULATE_QWORD_2
argument_list|(
operator|*
name|dma_addr
argument_list|,
name|EFX_DWORD_1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|32
argument_list|)
argument_list|,
name|EFX_DWORD_0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|&
literal|0xffffffff
argument_list|)
argument_list|)
expr_stmt|;
name|dma_addr
operator|++
expr_stmt|;
name|addr
operator|+=
name|EFX_BUF_SIZE
expr_stmt|;
block|}
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_fini_rxq
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint32_t
name|instance
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_FINI_RXQ_IN_LEN
argument_list|,
name|MC_CMD_FINI_RXQ_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_FINI_RXQ
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_FINI_RXQ_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_FINI_RXQ_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|FINI_RXQ_IN_INSTANCE
argument_list|,
name|instance
argument_list|)
expr_stmt|;
name|efx_mcdi_execute_quiet
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|req
operator|.
name|emr_rc
operator|!=
name|MC_CMD_ERR_EALREADY
operator|)
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_rss_context_alloc
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|efx_rx_scale_support_t
name|scale_support
parameter_list|,
name|__in
name|uint32_t
name|num_queues
parameter_list|,
name|__out
name|uint32_t
modifier|*
name|rss_contextp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_RSS_CONTEXT_ALLOC_IN_LEN
argument_list|,
name|MC_CMD_RSS_CONTEXT_ALLOC_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|uint32_t
name|rss_context
decl_stmt|;
name|uint32_t
name|context_type
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|num_queues
operator|>
name|EFX_MAXRSS
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
switch|switch
condition|(
name|scale_support
condition|)
block|{
case|case
name|EFX_RX_SCALE_EXCLUSIVE
case|:
name|context_type
operator|=
name|MC_CMD_RSS_CONTEXT_ALLOC_IN_TYPE_EXCLUSIVE
expr_stmt|;
break|break;
case|case
name|EFX_RX_SCALE_SHARED
case|:
name|context_type
operator|=
name|MC_CMD_RSS_CONTEXT_ALLOC_IN_TYPE_SHARED
expr_stmt|;
break|break;
default|default:
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_RSS_CONTEXT_ALLOC
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_RSS_CONTEXT_ALLOC_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_RSS_CONTEXT_ALLOC_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_ALLOC_IN_UPSTREAM_PORT_ID
argument_list|,
name|EVB_PORT_ID_ASSIGNED
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_ALLOC_IN_TYPE
argument_list|,
name|context_type
argument_list|)
expr_stmt|;
comment|/* NUM_QUEUES is only used to validate indirection table offsets */
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_ALLOC_IN_NUM_QUEUES
argument_list|,
name|num_queues
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_RSS_CONTEXT_ALLOC_OUT_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail4
goto|;
block|}
name|rss_context
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_ALLOC_OUT_RSS_CONTEXT_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|rss_context
operator|==
name|EF10_RSS_CONTEXT_INVALID
condition|)
block|{
name|rc
operator|=
name|ENOENT
expr_stmt|;
goto|goto
name|fail5
goto|;
block|}
operator|*
name|rss_contextp
operator|=
name|rss_context
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail5
label|:
name|EFSYS_PROBE
argument_list|(
name|fail5
argument_list|)
expr_stmt|;
name|fail4
label|:
name|EFSYS_PROBE
argument_list|(
name|fail4
argument_list|)
expr_stmt|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_function
specifier|static
name|efx_rc_t
name|efx_mcdi_rss_context_free
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint32_t
name|rss_context
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_RSS_CONTEXT_FREE_IN_LEN
argument_list|,
name|MC_CMD_RSS_CONTEXT_FREE_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|rss_context
operator|==
name|EF10_RSS_CONTEXT_INVALID
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_RSS_CONTEXT_FREE
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_RSS_CONTEXT_FREE_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_RSS_CONTEXT_FREE_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_FREE_IN_RSS_CONTEXT_ID
argument_list|,
name|rss_context
argument_list|)
expr_stmt|;
name|efx_mcdi_execute_quiet
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_function
specifier|static
name|efx_rc_t
name|efx_mcdi_rss_context_set_flags
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint32_t
name|rss_context
parameter_list|,
name|__in
name|efx_rx_hash_type_t
name|type
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_RSS_CONTEXT_SET_FLAGS_IN_LEN
argument_list|,
name|MC_CMD_RSS_CONTEXT_SET_FLAGS_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|rss_context
operator|==
name|EF10_RSS_CONTEXT_INVALID
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_RSS_CONTEXT_SET_FLAGS
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_RSS_CONTEXT_SET_FLAGS_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_RSS_CONTEXT_SET_FLAGS_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_SET_FLAGS_IN_RSS_CONTEXT_ID
argument_list|,
name|rss_context
argument_list|)
expr_stmt|;
name|MCDI_IN_POPULATE_DWORD_4
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_SET_FLAGS_IN_FLAGS
argument_list|,
name|RSS_CONTEXT_SET_FLAGS_IN_TOEPLITZ_IPV4_EN
argument_list|,
operator|(
name|type
operator|&
operator|(
literal|1U
operator|<<
name|EFX_RX_HASH_IPV4
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
name|RSS_CONTEXT_SET_FLAGS_IN_TOEPLITZ_TCPV4_EN
argument_list|,
operator|(
name|type
operator|&
operator|(
literal|1U
operator|<<
name|EFX_RX_HASH_TCPIPV4
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
name|RSS_CONTEXT_SET_FLAGS_IN_TOEPLITZ_IPV6_EN
argument_list|,
operator|(
name|type
operator|&
operator|(
literal|1U
operator|<<
name|EFX_RX_HASH_IPV6
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
name|RSS_CONTEXT_SET_FLAGS_IN_TOEPLITZ_TCPV6_EN
argument_list|,
operator|(
name|type
operator|&
operator|(
literal|1U
operator|<<
name|EFX_RX_HASH_TCPIPV6
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_decl_stmt
specifier|static
name|efx_rc_t
name|efx_mcdi_rss_context_set_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in
name|uint32_t
name|rss_context
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|uint8_t
operator|*
name|key
argument_list|,
name|__in
name|size_t
name|n
argument_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_RSS_CONTEXT_SET_KEY_IN_LEN
argument_list|,
name|MC_CMD_RSS_CONTEXT_SET_KEY_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|rss_context
operator|==
name|EF10_RSS_CONTEXT_INVALID
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_RSS_CONTEXT_SET_KEY
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_RSS_CONTEXT_SET_KEY_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_RSS_CONTEXT_SET_KEY_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_SET_KEY_IN_RSS_CONTEXT_ID
argument_list|,
name|rss_context
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|n
argument_list|,
operator|==
argument_list|,
name|MC_CMD_RSS_CONTEXT_SET_KEY_IN_TOEPLITZ_KEY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|MC_CMD_RSS_CONTEXT_SET_KEY_IN_TOEPLITZ_KEY_LEN
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|memcpy
argument_list|(
name|MCDI_IN2
argument_list|(
name|req
argument_list|,
name|uint8_t
argument_list|,
name|RSS_CONTEXT_SET_KEY_IN_TOEPLITZ_KEY
argument_list|)
argument_list|,
name|key
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_decl_stmt
specifier|static
name|efx_rc_t
name|efx_mcdi_rss_context_set_table
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in
name|uint32_t
name|rss_context
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|unsigned
name|int
operator|*
name|table
argument_list|,
name|__in
name|size_t
name|n
argument_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_RSS_CONTEXT_SET_TABLE_IN_LEN
argument_list|,
name|MC_CMD_RSS_CONTEXT_SET_TABLE_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|req_table
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
if|if
condition|(
name|rss_context
operator|==
name|EF10_RSS_CONTEXT_INVALID
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_RSS_CONTEXT_SET_TABLE
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_RSS_CONTEXT_SET_TABLE_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_RSS_CONTEXT_SET_TABLE_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|RSS_CONTEXT_SET_TABLE_IN_RSS_CONTEXT_ID
argument_list|,
name|rss_context
argument_list|)
expr_stmt|;
name|req_table
operator|=
name|MCDI_IN2
argument_list|(
name|req
argument_list|,
name|uint8_t
argument_list|,
name|RSS_CONTEXT_SET_TABLE_IN_INDIRECTION_TABLE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MC_CMD_RSS_CONTEXT_SET_TABLE_IN_INDIRECTION_TABLE_LEN
condition|;
name|i
operator|++
control|)
block|{
name|req_table
index|[
name|i
index|]
operator|=
operator|(
name|n
operator|>
literal|0
operator|)
condition|?
operator|(
name|uint8_t
operator|)
name|table
index|[
name|i
operator|%
name|n
index|]
else|:
literal|0
expr_stmt|;
block|}
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_function
name|__checkReturn
name|efx_rc_t
name|ef10_rx_init
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
if|if
condition|(
name|efx_mcdi_rss_context_alloc
argument_list|(
name|enp
argument_list|,
name|EFX_RX_SCALE_EXCLUSIVE
argument_list|,
name|EFX_MAXRSS
argument_list|,
operator|&
name|enp
operator|->
name|en_rss_context
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Allocated an exclusive RSS context, which allows both the 		 * indirection table and key to be modified. 		 */
name|enp
operator|->
name|en_rss_support
operator|=
name|EFX_RX_SCALE_EXCLUSIVE
expr_stmt|;
name|enp
operator|->
name|en_hash_support
operator|=
name|EFX_RX_HASH_AVAILABLE
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Failed to allocate an exclusive RSS context. Continue 		 * operation without support for RSS. The pseudo-header in 		 * received packets will not contain a Toeplitz hash value. 		 */
name|enp
operator|->
name|en_rss_support
operator|=
name|EFX_RX_SCALE_UNAVAILABLE
expr_stmt|;
name|enp
operator|->
name|en_hash_support
operator|=
name|EFX_RX_HASH_UNAVAILABLE
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* EFSYS_OPT_RX_SCALE */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCATTER
end_if

begin_function
name|__checkReturn
name|efx_rc_t
name|ef10_rx_scatter_enable
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|buf_size
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp, buf_size)
argument_list|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCATTER */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_function
name|__checkReturn
name|efx_rc_t
name|ef10_rx_scale_mode_set
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|efx_rx_hash_alg_t
name|alg
parameter_list|,
name|__in
name|efx_rx_hash_type_t
name|type
parameter_list|,
name|__in
name|boolean_t
name|insert
parameter_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|alg
argument_list|,
operator|==
argument_list|,
name|EFX_RX_HASHALG_TOEPLITZ
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|insert
argument_list|,
operator|==
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|alg
operator|!=
name|EFX_RX_HASHALG_TOEPLITZ
operator|)
operator|||
operator|(
name|insert
operator|==
name|B_FALSE
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|enp
operator|->
name|en_rss_support
operator|==
name|EFX_RX_SCALE_UNAVAILABLE
condition|)
block|{
name|rc
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_mcdi_rss_context_set_flags
argument_list|(
name|enp
argument_list|,
name|enp
operator|->
name|en_rss_context
argument_list|,
name|type
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail3
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|ef10_rx_scale_key_set
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|uint8_t
operator|*
name|key
argument_list|,
name|__in
name|size_t
name|n
argument_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|enp
operator|->
name|en_rss_support
operator|==
name|EFX_RX_SCALE_UNAVAILABLE
condition|)
block|{
name|rc
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_mcdi_rss_context_set_key
argument_list|(
name|enp
argument_list|,
name|enp
operator|->
name|en_rss_context
argument_list|,
name|key
argument_list|,
name|n
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail2
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|ef10_rx_scale_tbl_set
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|unsigned
name|int
operator|*
name|table
argument_list|,
name|__in
name|size_t
name|n
argument_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
name|enp
operator|->
name|en_rss_support
operator|==
name|EFX_RX_SCALE_UNAVAILABLE
condition|)
block|{
name|rc
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_mcdi_rss_context_set_table
argument_list|(
name|enp
argument_list|,
name|enp
operator|->
name|en_rss_context
argument_list|,
name|table
argument_list|,
name|n
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail2
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_comment
comment|/*  * EF10 RX pseudo-header  * ---------------------  *  * Receive packets are prefixed by an (optional) 14 byte pseudo-header:  *  *  +00: Toeplitz hash value.  *       (32bit little-endian)  *  +04: Outer VLAN tag. Zero if the packet did not have an outer VLAN tag.  *       (16bit big-endian)  *  +06: Inner VLAN tag. Zero if the packet did not have an inner VLAN tag.  *       (16bit big-endian)  *  +08: Packet Length. Zero if the RX datapath was in cut-through mode.  *       (16bit little-endian)  *  +10: MAC timestamp. Zero if timestamping is not enabled.  *       (32bit little-endian)  *  * See "The RX Pseudo-header" in SF-109306-TC.  */
end_comment

begin_function
name|__checkReturn
name|efx_rc_t
name|ef10_rx_prefix_pktlen
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint8_t
modifier|*
name|buffer
parameter_list|,
name|__out
name|uint16_t
modifier|*
name|lengthp
parameter_list|)
block|{
name|_NOTE
argument_list|(
name|ARGUNUSED
argument_list|(
name|enp
argument_list|)
argument_list|)
comment|/* 	 * The RX pseudo-header contains the packet length, excluding the 	 * pseudo-header. If the hardware receive datapath was operating in 	 * cut-through mode then the length in the RX pseudo-header will be 	 * zero, and the packet length must be obtained from the DMA length 	 * reported in the RX event. 	 */
operator|*
name|lengthp
operator|=
name|buffer
index|[
literal|8
index|]
operator||
operator|(
name|buffer
index|[
literal|9
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
end_if

begin_function
name|__checkReturn
name|uint32_t
name|ef10_rx_prefix_hash
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|efx_rx_hash_alg_t
name|func
parameter_list|,
name|__in
name|uint8_t
modifier|*
name|buffer
parameter_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
switch|switch
condition|(
name|func
condition|)
block|{
case|case
name|EFX_RX_HASHALG_TOEPLITZ
case|:
return|return
operator|(
name|buffer
index|[
literal|0
index|]
operator||
operator|(
name|buffer
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|buffer
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|buffer
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator|)
return|;
default|default:
name|EFSYS_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_RX_SCALE */
end_comment

begin_decl_stmt
name|void
name|ef10_rx_qpost
argument_list|(
name|__in
name|efx_rxq_t
operator|*
name|erp
argument_list|,
name|__in_ecount
argument_list|(
argument|n
argument_list|)
name|efsys_dma_addr_t
operator|*
name|addrp
argument_list|,
name|__in
name|size_t
name|size
argument_list|,
name|__in
name|unsigned
name|int
name|n
argument_list|,
name|__in
name|unsigned
name|int
name|completed
argument_list|,
name|__in
name|unsigned
name|int
name|added
argument_list|)
block|{
name|efx_qword_t
name|qword
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|unsigned
name|int
name|offset
decl_stmt|;
name|unsigned
name|int
name|id
decl_stmt|;
comment|/* The client driver must not overfill the queue */
name|EFSYS_ASSERT3U
argument_list|(
name|added
operator|-
name|completed
operator|+
name|n
argument_list|,
operator|<=
argument_list|,
name|EFX_RXQ_LIMIT
argument_list|(
name|erp
operator|->
name|er_mask
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|id
operator|=
name|added
operator|&
operator|(
name|erp
operator|->
name|er_mask
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|EFSYS_PROBE4
argument_list|(
argument|rx_post
argument_list|,
argument|unsigned int
argument_list|,
argument|erp->er_index
argument_list|,
argument|unsigned int
argument_list|,
argument|id
argument_list|,
argument|efsys_dma_addr_t
argument_list|,
argument|addrp[i]
argument_list|,
argument|size_t
argument_list|,
argument|size
argument_list|)
empty_stmt|;
name|EFX_POPULATE_QWORD_3
argument_list|(
name|qword
argument_list|,
name|ESF_DZ_RX_KER_BYTE_CNT
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|size
argument_list|)
argument_list|,
name|ESF_DZ_RX_KER_BUF_ADDR_DW0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addrp
index|[
name|i
index|]
operator|&
literal|0xffffffff
argument_list|)
argument_list|,
name|ESF_DZ_RX_KER_BUF_ADDR_DW1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|addrp
index|[
name|i
index|]
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|offset
operator|=
name|id
operator|*
sizeof|sizeof
argument_list|(
name|efx_qword_t
argument_list|)
expr_stmt|;
name|EFSYS_MEM_WRITEQ
argument_list|(
name|erp
operator|->
name|er_esmp
argument_list|,
name|offset
argument_list|,
operator|&
name|qword
argument_list|)
expr_stmt|;
name|id
operator|=
operator|(
name|id
operator|+
literal|1
operator|)
operator|&
operator|(
name|erp
operator|->
name|er_mask
operator|)
expr_stmt|;
block|}
block|}
end_decl_stmt

begin_function
name|void
name|ef10_rx_qpush
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|,
name|__in
name|unsigned
name|int
name|added
parameter_list|,
name|__inout
name|unsigned
name|int
modifier|*
name|pushedp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|erp
operator|->
name|er_enp
decl_stmt|;
name|unsigned
name|int
name|pushed
init|=
operator|*
name|pushedp
decl_stmt|;
name|uint32_t
name|wptr
decl_stmt|;
name|efx_dword_t
name|dword
decl_stmt|;
comment|/* Hardware has alignment restriction for WPTR */
name|wptr
operator|=
name|P2ALIGN
argument_list|(
name|added
argument_list|,
name|EF10_RX_WPTR_ALIGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|pushed
operator|==
name|wptr
condition|)
return|return;
operator|*
name|pushedp
operator|=
name|wptr
expr_stmt|;
comment|/* Push the populated descriptors out */
name|wptr
operator|&=
name|erp
operator|->
name|er_mask
expr_stmt|;
name|EFX_POPULATE_DWORD_1
argument_list|(
name|dword
argument_list|,
name|ERF_DZ_RX_DESC_WPTR
argument_list|,
name|wptr
argument_list|)
expr_stmt|;
comment|/* Guarantee ordering of memory (descriptors) and PIO (doorbell) */
name|EFX_DMA_SYNC_QUEUE_FOR_DEVICE
argument_list|(
name|erp
operator|->
name|er_esmp
argument_list|,
name|erp
operator|->
name|er_mask
operator|+
literal|1
argument_list|,
name|wptr
argument_list|,
name|pushed
operator|&
name|erp
operator|->
name|er_mask
argument_list|)
expr_stmt|;
name|EFSYS_PIO_WRITE_BARRIER
argument_list|()
expr_stmt|;
name|EFX_BAR_TBL_WRITED
argument_list|(
name|enp
argument_list|,
name|ER_DZ_RX_DESC_UPD_REG
argument_list|,
name|erp
operator|->
name|er_index
argument_list|,
operator|&
name|dword
argument_list|,
name|B_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|ef10_rx_qflush
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|erp
operator|->
name|er_enp
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_mcdi_fini_rxq
argument_list|(
name|enp
argument_list|,
name|erp
operator|->
name|er_index
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ef10_rx_qenable
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|)
block|{
comment|/* FIXME */
name|_NOTE
argument_list|(
argument|ARGUNUSED(erp)
argument_list|)
comment|/* FIXME */
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|ef10_rx_qcreate
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|unsigned
name|int
name|index
parameter_list|,
name|__in
name|unsigned
name|int
name|label
parameter_list|,
name|__in
name|efx_rxq_type_t
name|type
parameter_list|,
name|__in
name|efsys_mem_t
modifier|*
name|esmp
parameter_list|,
name|__in
name|size_t
name|n
parameter_list|,
name|__in
name|uint32_t
name|id
parameter_list|,
name|__in
name|efx_evq_t
modifier|*
name|eep
parameter_list|,
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|)
block|{
name|efx_nic_cfg_t
modifier|*
name|encp
init|=
operator|&
operator|(
name|enp
operator|->
name|en_nic_cfg
operator|)
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|boolean_t
name|disable_scatter
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(id, erp)
argument_list|)
name|EFX_STATIC_ASSERT
argument_list|(
name|EFX_EV_RX_NLABELS
operator|==
operator|(
literal|1
operator|<<
name|ESF_DZ_RX_QLABEL_WIDTH
operator|)
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|label
argument_list|,
operator|<
argument_list|,
name|EFX_EV_RX_NLABELS
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_rx_qcount
operator|+
literal|1
argument_list|,
operator|<
argument_list|,
name|encp
operator|->
name|enc_rxq_limit
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|ISP2
argument_list|(
name|EFX_RXQ_MAXNDESCS
argument_list|)
argument_list|)
expr_stmt|;
name|EFX_STATIC_ASSERT
argument_list|(
name|ISP2
argument_list|(
name|EFX_RXQ_MINNDESCS
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ISP2
argument_list|(
name|n
argument_list|)
operator|||
operator|(
name|n
operator|<
name|EFX_RXQ_MINNDESCS
operator|)
operator|||
operator|(
name|n
operator|>
name|EFX_RXQ_MAXNDESCS
operator|)
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|index
operator|>=
name|encp
operator|->
name|enc_rxq_limit
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
comment|/* Scatter can only be disabled if the firmware supports doing so */
if|if
condition|(
operator|(
name|type
operator|!=
name|EFX_RXQ_TYPE_SCATTER
operator|)
operator|&&
name|enp
operator|->
name|en_nic_cfg
operator|.
name|enc_rx_disable_scatter_supported
condition|)
block|{
name|disable_scatter
operator|=
name|B_TRUE
expr_stmt|;
block|}
else|else
block|{
name|disable_scatter
operator|=
name|B_FALSE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_mcdi_init_rxq
argument_list|(
name|enp
argument_list|,
name|n
argument_list|,
name|eep
operator|->
name|ee_index
argument_list|,
name|label
argument_list|,
name|index
argument_list|,
name|esmp
argument_list|,
name|disable_scatter
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail3
goto|;
name|erp
operator|->
name|er_eep
operator|=
name|eep
expr_stmt|;
name|erp
operator|->
name|er_label
operator|=
name|label
expr_stmt|;
name|ef10_ev_rxlabel_init
argument_list|(
name|eep
argument_list|,
name|erp
argument_list|,
name|label
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ef10_rx_qdestroy
parameter_list|(
name|__in
name|efx_rxq_t
modifier|*
name|erp
parameter_list|)
block|{
name|efx_nic_t
modifier|*
name|enp
init|=
name|erp
operator|->
name|er_enp
decl_stmt|;
name|efx_evq_t
modifier|*
name|eep
init|=
name|erp
operator|->
name|er_eep
decl_stmt|;
name|unsigned
name|int
name|label
init|=
name|erp
operator|->
name|er_label
decl_stmt|;
name|ef10_ev_rxlabel_fini
argument_list|(
name|eep
argument_list|,
name|label
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_rx_qcount
operator|!=
literal|0
argument_list|)
expr_stmt|;
operator|--
name|enp
operator|->
name|en_rx_qcount
expr_stmt|;
name|EFSYS_KMEM_FREE
argument_list|(
name|enp
operator|->
name|en_esip
argument_list|,
sizeof|sizeof
argument_list|(
name|efx_rxq_t
argument_list|)
argument_list|,
name|erp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ef10_rx_fini
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
if|#
directive|if
name|EFSYS_OPT_RX_SCALE
if|if
condition|(
name|enp
operator|->
name|en_rss_support
operator|!=
name|EFX_RX_SCALE_UNAVAILABLE
condition|)
block|{
operator|(
name|void
operator|)
name|efx_mcdi_rss_context_free
argument_list|(
name|enp
argument_list|,
name|enp
operator|->
name|en_rss_context
argument_list|)
expr_stmt|;
block|}
name|enp
operator|->
name|en_rss_context
operator|=
literal|0
expr_stmt|;
name|enp
operator|->
name|en_rss_support
operator|=
name|EFX_RX_SCALE_UNAVAILABLE
expr_stmt|;
else|#
directive|else
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
endif|#
directive|endif
comment|/* EFSYS_OPT_RX_SCALE */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_HUNTINGTON || EFSYS_OPT_MEDFORD */
end_comment

end_unit


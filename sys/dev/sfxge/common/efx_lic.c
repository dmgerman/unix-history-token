begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009-2016 Solarflare Communications Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *  * 1. Redistributions of source code must retain the above copyright notice,  *    this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright notice,  *    this list of conditions and the following disclaimer in the documentation  *    and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * The views and conclusions contained in the software and documentation are  * those of the authors and should not be interpreted as representing official  * policies, either expressed or implied, of the FreeBSD Project.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"efx.h"
end_include

begin_include
include|#
directive|include
file|"efx_impl.h"
end_include

begin_if
if|#
directive|if
name|EFSYS_OPT_LICENSING
end_if

begin_include
include|#
directive|include
file|"ef10_tlv_layout.h"
end_include

begin_if
if|#
directive|if
name|EFSYS_OPT_SIENA
operator||
name|EFSYS_OPT_HUNTINGTON
end_if

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_find_start
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_find_end
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|endp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v1v2_find_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v1v2_validate_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_read_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out_bcount_part
argument_list|(
argument|key_max_size
argument_list|,
argument|*lengthp
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|size_t
name|key_max_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_write_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_delete_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__in
name|uint32_t
name|end
argument_list|,
name|__out
name|uint32_t
operator|*
name|deltap
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_create_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_finish_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_HUNTINGTON | EFSYS_OPT_SIENA */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_SIENA
end_if

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_fc_license_update_license
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_fc_license_get_key_stats
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|efx_key_stats_t
modifier|*
name|eksp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|efx_lic_ops_t
name|__efx_lic_v1_ops
init|=
block|{
name|efx_mcdi_fc_license_update_license
block|,
comment|/* elo_update_licenses */
name|efx_mcdi_fc_license_get_key_stats
block|,
comment|/* elo_get_key_stats */
name|NULL
block|,
comment|/* elo_app_state */
name|NULL
block|,
comment|/* elo_get_id */
name|efx_lic_v1v2_find_start
block|,
comment|/* elo_find_start */
name|efx_lic_v1v2_find_end
block|,
comment|/* elo_find_end */
name|efx_lic_v1v2_find_key
block|,
comment|/* elo_find_key */
name|efx_lic_v1v2_validate_key
block|,
comment|/* elo_validate_key */
name|efx_lic_v1v2_read_key
block|,
comment|/* elo_read_key */
name|efx_lic_v1v2_write_key
block|,
comment|/* elo_write_key */
name|efx_lic_v1v2_delete_key
block|,
comment|/* elo_delete_key */
name|efx_lic_v1v2_create_partition
block|,
comment|/* elo_create_partition */
name|efx_lic_v1v2_finish_partition
block|,
comment|/* elo_finish_partition */
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_SIENA */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_HUNTINGTON
end_if

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_update_licenses
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_get_key_stats
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|efx_key_stats_t
modifier|*
name|eksp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensed_app_state
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint64_t
name|app_id
parameter_list|,
name|__out
name|boolean_t
modifier|*
name|licensedp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|efx_lic_ops_t
name|__efx_lic_v2_ops
init|=
block|{
name|efx_mcdi_licensing_update_licenses
block|,
comment|/* elo_update_licenses */
name|efx_mcdi_licensing_get_key_stats
block|,
comment|/* elo_get_key_stats */
name|efx_mcdi_licensed_app_state
block|,
comment|/* elo_app_state */
name|NULL
block|,
comment|/* elo_get_id */
name|efx_lic_v1v2_find_start
block|,
comment|/* elo_find_start */
name|efx_lic_v1v2_find_end
block|,
comment|/* elo_find_end */
name|efx_lic_v1v2_find_key
block|,
comment|/* elo_find_key */
name|efx_lic_v1v2_validate_key
block|,
comment|/* elo_validate_key */
name|efx_lic_v1v2_read_key
block|,
comment|/* elo_read_key */
name|efx_lic_v1v2_write_key
block|,
comment|/* elo_write_key */
name|efx_lic_v1v2_delete_key
block|,
comment|/* elo_delete_key */
name|efx_lic_v1v2_create_partition
block|,
comment|/* elo_create_partition */
name|efx_lic_v1v2_finish_partition
block|,
comment|/* elo_finish_partition */
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_HUNTINGTON */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_MEDFORD
end_if

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_update_licenses
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_report_license
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|efx_key_stats_t
modifier|*
name|eksp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_app_state
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint64_t
name|app_id
parameter_list|,
name|__out
name|boolean_t
modifier|*
name|licensedp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_get_id
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|typep
argument_list|,
name|__out
name|size_t
operator|*
name|lengthp
argument_list|,
name|__out_bcount_part_opt
argument_list|(
argument|buffer_size
argument_list|,
argument|*lengthp
argument_list|)
name|uint8_t
operator|*
name|bufferp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_find_start
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_find_end
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|endp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v3_find_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v3_validate_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_read_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out_bcount_part
argument_list|(
argument|key_max_size
argument_list|,
argument|*lengthp
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|size_t
name|key_max_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_write_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_delete_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__in
name|uint32_t
name|end
argument_list|,
name|__out
name|uint32_t
operator|*
name|deltap
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_create_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_finish_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|efx_lic_ops_t
name|__efx_lic_v3_ops
init|=
block|{
name|efx_mcdi_licensing_v3_update_licenses
block|,
comment|/* elo_update_licenses */
name|efx_mcdi_licensing_v3_report_license
block|,
comment|/* elo_get_key_stats */
name|efx_mcdi_licensing_v3_app_state
block|,
comment|/* elo_app_state */
name|efx_mcdi_licensing_v3_get_id
block|,
comment|/* elo_get_id */
name|efx_lic_v3_find_start
block|,
comment|/* elo_find_start*/
name|efx_lic_v3_find_end
block|,
comment|/* elo_find_end */
name|efx_lic_v3_find_key
block|,
comment|/* elo_find_key */
name|efx_lic_v3_validate_key
block|,
comment|/* elo_validate_key */
name|efx_lic_v3_read_key
block|,
comment|/* elo_read_key */
name|efx_lic_v3_write_key
block|,
comment|/* elo_write_key */
name|efx_lic_v3_delete_key
block|,
comment|/* elo_delete_key */
name|efx_lic_v3_create_partition
block|,
comment|/* elo_create_partition */
name|efx_lic_v3_finish_partition
block|,
comment|/* elo_finish_partition */
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_MEDFORD */
end_comment

begin_comment
comment|/* V1 Licensing - used in Siena Modena only */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_SIENA
end_if

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_fc_license_update_license
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MC_CMD_FC_IN_LICENSE_LEN
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_SIENA
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_FC
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_FC_IN_LICENSE_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
literal|0
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|FC_IN_CMD
argument_list|,
name|MC_CMD_FC_OP_LICENSE
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|FC_IN_LICENSE_OP
argument_list|,
name|MC_CMD_FC_IN_LICENSE_UPDATE_LICENSE
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|EIO
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_fc_license_get_key_stats
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|efx_key_stats_t
modifier|*
name|eksp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_FC_IN_LICENSE_LEN
argument_list|,
name|MC_CMD_FC_OUT_LICENSE_LEN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_SIENA
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_FC
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_FC_IN_LICENSE_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_FC_OUT_LICENSE_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|FC_IN_CMD
argument_list|,
name|MC_CMD_FC_OP_LICENSE
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|FC_IN_LICENSE_OP
argument_list|,
name|MC_CMD_FC_IN_LICENSE_GET_KEY_STATS
argument_list|)
expr_stmt|;
name|efx_mcdi_execute_quiet
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_FC_OUT_LICENSE_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|eksp
operator|->
name|eks_valid
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|FC_OUT_LICENSE_VALID_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_invalid
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|FC_OUT_LICENSE_INVALID_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_blacklisted
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|FC_OUT_LICENSE_BLACKLISTED_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_unverifiable
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_wrong_node
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_apps_lo
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_apps_hi
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_features_lo
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_features_hi
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_SIENA */
end_comment

begin_comment
comment|/* V1 and V2 Partition format - based on a 16-bit TLV format */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_SIENA
operator||
name|EFSYS_OPT_HUNTINGTON
end_if

begin_comment
comment|/*  * V1/V2 format - defined in SF-108542-TC section 4.2:  *  Type (T):   16bit - revision/HMAC algorithm  *  Length (L): 16bit - value length in bytes  *  Value (V):  L bytes - payload  */
end_comment

begin_define
define|#
directive|define
name|EFX_LICENSE_V1V2_PAYLOAD_LENGTH_MAX
value|(256)
end_define

begin_define
define|#
directive|define
name|EFX_LICENSE_V1V2_HEADER_LENGTH
value|(2 * sizeof(uint16_t))
end_define

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_find_start
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|)
block|{
name|_NOTE
argument_list|(
name|ARGUNUSED
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|)
argument_list|)
operator|*
name|startp
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_find_end
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|endp
argument_list|)
block|{
name|_NOTE
argument_list|(
name|ARGUNUSED
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|)
argument_list|)
operator|*
name|endp
operator|=
name|offset
operator|+
name|EFX_LICENSE_V1V2_HEADER_LENGTH
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v1v2_find_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
name|boolean_t
name|found
decl_stmt|;
name|uint16_t
name|tlv_type
decl_stmt|;
name|uint16_t
name|tlv_length
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
if|if
condition|(
operator|(
name|size_t
operator|)
name|buffer_size
operator|-
name|offset
operator|<
name|EFX_LICENSE_V1V2_HEADER_LENGTH
condition|)
goto|goto
name|fail1
goto|;
name|tlv_type
operator|=
name|__LE_TO_CPU_16
argument_list|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|bufferp
index|[
name|offset
index|]
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tlv_length
operator|=
name|__LE_TO_CPU_16
argument_list|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|bufferp
index|[
name|offset
index|]
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tlv_length
operator|>
name|EFX_LICENSE_V1V2_PAYLOAD_LENGTH_MAX
operator|)
operator|||
operator|(
name|tlv_type
operator|==
literal|0
operator|&&
name|tlv_length
operator|==
literal|0
operator|)
condition|)
block|{
name|found
operator|=
name|B_FALSE
expr_stmt|;
block|}
else|else
block|{
operator|*
name|startp
operator|=
name|offset
expr_stmt|;
operator|*
name|lengthp
operator|=
name|tlv_length
operator|+
name|EFX_LICENSE_V1V2_HEADER_LENGTH
expr_stmt|;
name|found
operator|=
name|B_TRUE
expr_stmt|;
block|}
return|return
operator|(
name|found
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE
argument_list|(
name|fail1
argument_list|)
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v1v2_validate_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|)
block|{
name|uint16_t
name|tlv_type
decl_stmt|;
name|uint16_t
name|tlv_length
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
if|if
condition|(
name|length
operator|<
name|EFX_LICENSE_V1V2_HEADER_LENGTH
condition|)
block|{
goto|goto
name|fail1
goto|;
block|}
name|tlv_type
operator|=
name|__LE_TO_CPU_16
argument_list|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|keyp
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tlv_length
operator|=
name|__LE_TO_CPU_16
argument_list|(
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|keyp
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlv_length
operator|>
name|EFX_LICENSE_V1V2_PAYLOAD_LENGTH_MAX
condition|)
block|{
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
name|tlv_type
operator|==
literal|0
condition|)
block|{
goto|goto
name|fail3
goto|;
block|}
if|if
condition|(
operator|(
name|tlv_length
operator|+
name|EFX_LICENSE_V1V2_HEADER_LENGTH
operator|)
operator|!=
name|length
condition|)
block|{
goto|goto
name|fail4
goto|;
block|}
return|return
operator|(
name|B_TRUE
operator|)
return|;
name|fail4
label|:
name|EFSYS_PROBE
argument_list|(
name|fail4
argument_list|)
expr_stmt|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE
argument_list|(
name|fail1
argument_list|)
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_read_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out_bcount_part
argument_list|(
argument|key_max_size
argument_list|,
argument|*lengthp
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|size_t
name|key_max_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|EFSYS_ASSERT
argument_list|(
name|length
operator|<=
operator|(
name|EFX_LICENSE_V1V2_PAYLOAD_LENGTH_MAX
operator|+
name|EFX_LICENSE_V1V2_HEADER_LENGTH
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_max_size
operator|<
name|length
condition|)
block|{
name|rc
operator|=
name|ENOSPC
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|memcpy
argument_list|(
name|keyp
argument_list|,
operator|&
name|bufferp
index|[
name|offset
index|]
argument_list|,
name|length
argument_list|)
expr_stmt|;
operator|*
name|lengthp
operator|=
name|length
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_write_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|EFSYS_ASSERT
argument_list|(
name|length
operator|<=
operator|(
name|EFX_LICENSE_V1V2_PAYLOAD_LENGTH_MAX
operator|+
name|EFX_LICENSE_V1V2_HEADER_LENGTH
operator|)
argument_list|)
expr_stmt|;
comment|/* Ensure space for terminator remains */
if|if
condition|(
operator|(
name|offset
operator|+
name|length
operator|)
operator|>
operator|(
name|buffer_size
operator|-
name|EFX_LICENSE_V1V2_HEADER_LENGTH
operator|)
condition|)
block|{
name|rc
operator|=
name|ENOSPC
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|memcpy
argument_list|(
name|bufferp
operator|+
name|offset
argument_list|,
name|keyp
argument_list|,
name|length
argument_list|)
expr_stmt|;
operator|*
name|lengthp
operator|=
name|length
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_delete_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__in
name|uint32_t
name|end
argument_list|,
name|__out
name|uint32_t
operator|*
name|deltap
argument_list|)
block|{
name|uint32_t
name|move_start
init|=
name|offset
operator|+
name|length
decl_stmt|;
name|uint32_t
name|move_length
init|=
name|end
operator|-
name|move_start
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|EFSYS_ASSERT
argument_list|(
name|end
operator|<=
name|buffer_size
argument_list|)
expr_stmt|;
comment|/* Shift everything after the key down */
name|memmove
argument_list|(
name|bufferp
operator|+
name|offset
argument_list|,
name|bufferp
operator|+
name|move_start
argument_list|,
name|move_length
argument_list|)
expr_stmt|;
operator|*
name|deltap
operator|=
name|length
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_create_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|EFSYS_ASSERT
argument_list|(
name|EFX_LICENSE_V1V2_HEADER_LENGTH
operator|<=
name|buffer_size
argument_list|)
expr_stmt|;
comment|/* Write terminator */
name|memset
argument_list|(
name|bufferp
argument_list|,
literal|'\0'
argument_list|,
name|EFX_LICENSE_V1V2_HEADER_LENGTH
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v1v2_finish_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp, bufferp, buffer_size)
argument_list|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_HUNTINGTON | EFSYS_OPT_SIENA */
end_comment

begin_comment
comment|/* V2 Licensing - used by Huntington family only. See SF-113611-TC */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_HUNTINGTON
end_if

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensed_app_state
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint64_t
name|app_id
parameter_list|,
name|__out
name|boolean_t
modifier|*
name|licensedp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_GET_LICENSED_APP_STATE_IN_LEN
argument_list|,
name|MC_CMD_GET_LICENSED_APP_STATE_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|uint32_t
name|app_state
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_HUNTINGTON
argument_list|)
expr_stmt|;
comment|/* V2 licensing supports 32bit app id only */
if|if
condition|(
operator|(
name|app_id
operator|>>
literal|32
operator|)
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_GET_LICENSED_APP_STATE
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_GET_LICENSED_APP_STATE_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_GET_LICENSED_APP_STATE_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LICENSED_APP_STATE_IN_APP_ID
argument_list|,
name|app_id
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_GET_LICENSED_APP_STATE_OUT_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail3
goto|;
block|}
name|app_state
operator|=
operator|(
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LICENSED_APP_STATE_OUT_STATE
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|app_state
operator|!=
name|MC_CMD_GET_LICENSED_APP_STATE_OUT_NOT_LICENSED
condition|)
block|{
operator|*
name|licensedp
operator|=
name|B_TRUE
expr_stmt|;
block|}
else|else
block|{
operator|*
name|licensedp
operator|=
name|B_FALSE
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_update_licenses
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MC_CMD_LICENSING_IN_LEN
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_HUNTINGTON
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_LICENSING
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_LICENSING_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
literal|0
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_IN_OP
argument_list|,
name|MC_CMD_LICENSING_IN_OP_UPDATE_LICENSE
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|EIO
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_get_key_stats
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|efx_key_stats_t
modifier|*
name|eksp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_LICENSING_IN_LEN
argument_list|,
name|MC_CMD_LICENSING_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_HUNTINGTON
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_LICENSING
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_LICENSING_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_LICENSING_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_IN_OP
argument_list|,
name|MC_CMD_LICENSING_IN_OP_GET_KEY_STATS
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_LICENSING_OUT_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|eksp
operator|->
name|eks_valid
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_OUT_VALID_APP_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_invalid
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_OUT_INVALID_APP_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_blacklisted
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_OUT_BLACKLISTED_APP_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_unverifiable
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_OUT_UNVERIFIABLE_APP_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_wrong_node
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_OUT_WRONG_NODE_APP_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_apps_lo
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_apps_hi
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_features_lo
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_features_hi
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_HUNTINGTON */
end_comment

begin_comment
comment|/* V3 Licensing - used starting from Medford family. See SF-114884-SW */
end_comment

begin_if
if|#
directive|if
name|EFSYS_OPT_MEDFORD
end_if

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_update_licenses
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MC_CMD_LICENSING_V3_IN_LEN
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_MEDFORD
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_LICENSING_V3
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_LICENSING_V3_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
literal|0
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_IN_OP
argument_list|,
name|MC_CMD_LICENSING_V3_IN_OP_UPDATE_LICENSE
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_report_license
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|efx_key_stats_t
modifier|*
name|eksp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_LICENSING_V3_IN_LEN
argument_list|,
name|MC_CMD_LICENSING_V3_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_MEDFORD
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_LICENSING_V3
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_LICENSING_V3_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_LICENSING_V3_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_IN_OP
argument_list|,
name|MC_CMD_LICENSING_V3_IN_OP_REPORT_LICENSE
argument_list|)
expr_stmt|;
name|efx_mcdi_execute_quiet
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_LICENSING_V3_OUT_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|eksp
operator|->
name|eks_valid
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_VALID_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_invalid
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_INVALID_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_blacklisted
operator|=
literal|0
expr_stmt|;
name|eksp
operator|->
name|eks_unverifiable
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_UNVERIFIABLE_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_wrong_node
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_WRONG_NODE_KEYS
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_apps_lo
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_LICENSED_APPS_LO
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_apps_hi
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_LICENSED_APPS_HI
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_features_lo
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_LICENSED_FEATURES_LO
argument_list|)
expr_stmt|;
name|eksp
operator|->
name|eks_licensed_features_hi
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_V3_OUT_LICENSED_FEATURES_HI
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_app_state
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint64_t
name|app_id
parameter_list|,
name|__out
name|boolean_t
modifier|*
name|licensedp
parameter_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_GET_LICENSED_V3_APP_STATE_IN_LEN
argument_list|,
name|MC_CMD_GET_LICENSED_V3_APP_STATE_OUT_LEN
argument_list|)
index|]
decl_stmt|;
name|uint32_t
name|app_state
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|enp
operator|->
name|en_family
operator|==
name|EFX_FAMILY_MEDFORD
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_GET_LICENSED_V3_APP_STATE
expr_stmt|;
name|req
operator|.
name|emr_in_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_GET_LICENSED_V3_APP_STATE_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|payload
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_GET_LICENSED_V3_APP_STATE_OUT_LEN
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LICENSED_V3_APP_STATE_IN_APP_ID_LO
argument_list|,
name|app_id
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|MCDI_IN_SET_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LICENSED_V3_APP_STATE_IN_APP_ID_HI
argument_list|,
name|app_id
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|efx_mcdi_execute
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_GET_LICENSED_V3_APP_STATE_OUT_LEN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
name|app_state
operator|=
operator|(
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|GET_LICENSED_V3_APP_STATE_OUT_STATE
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|app_state
operator|!=
name|MC_CMD_GET_LICENSED_V3_APP_STATE_OUT_NOT_LICENSED
condition|)
block|{
operator|*
name|licensedp
operator|=
name|B_TRUE
expr_stmt|;
block|}
else|else
block|{
operator|*
name|licensedp
operator|=
name|B_FALSE
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|__checkReturn
name|efx_rc_t
name|efx_mcdi_licensing_v3_get_id
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|typep
argument_list|,
name|__out
name|size_t
operator|*
name|lengthp
argument_list|,
name|__out_bcount_part_opt
argument_list|(
argument|buffer_size
argument_list|,
argument|*lengthp
argument_list|)
name|uint8_t
operator|*
name|bufferp
argument_list|)
block|{
name|efx_mcdi_req_t
name|req
decl_stmt|;
name|uint8_t
name|payload
index|[
name|MAX
argument_list|(
name|MC_CMD_LICENSING_GET_ID_V3_IN_LEN
argument_list|,
name|MC_CMD_LICENSING_GET_ID_V3_OUT_LENMIN
argument_list|)
index|]
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|req
operator|.
name|emr_cmd
operator|=
name|MC_CMD_LICENSING_GET_ID_V3
expr_stmt|;
if|if
condition|(
name|bufferp
operator|==
name|NULL
condition|)
block|{
comment|/* Request id type and length only */
name|req
operator|.
name|emr_in_buf
operator|=
name|bufferp
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_LICENSING_GET_ID_V3_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|bufferp
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MC_CMD_LICENSING_GET_ID_V3_OUT_LENMIN
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|payload
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Request full buffer */
name|req
operator|.
name|emr_in_buf
operator|=
name|bufferp
expr_stmt|;
name|req
operator|.
name|emr_in_length
operator|=
name|MC_CMD_LICENSING_GET_ID_V3_IN_LEN
expr_stmt|;
name|req
operator|.
name|emr_out_buf
operator|=
name|bufferp
expr_stmt|;
name|req
operator|.
name|emr_out_length
operator|=
name|MIN
argument_list|(
name|buffer_size
argument_list|,
name|MC_CMD_LICENSING_GET_ID_V3_OUT_LENMAX
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|bufferp
argument_list|,
literal|0
argument_list|,
name|req
operator|.
name|emr_out_length
argument_list|)
expr_stmt|;
block|}
name|efx_mcdi_execute_quiet
argument_list|(
name|enp
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|emr_rc
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|req
operator|.
name|emr_rc
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|req
operator|.
name|emr_out_length_used
operator|<
name|MC_CMD_LICENSING_GET_ID_V3_OUT_LENMIN
condition|)
block|{
name|rc
operator|=
name|EMSGSIZE
expr_stmt|;
goto|goto
name|fail2
goto|;
block|}
operator|*
name|typep
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_GET_ID_V3_OUT_LICENSE_TYPE
argument_list|)
expr_stmt|;
operator|*
name|lengthp
operator|=
name|MCDI_OUT_DWORD
argument_list|(
name|req
argument_list|,
name|LICENSING_GET_ID_V3_OUT_LICENSE_ID_LENGTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|bufferp
operator|==
name|NULL
condition|)
block|{
comment|/* modify length requirements to indicate to caller the extra buffering 		** needed to read the complete output. 		*/
operator|*
name|lengthp
operator|+=
name|MC_CMD_LICENSING_GET_ID_V3_OUT_LENMIN
expr_stmt|;
block|}
else|else
block|{
comment|/* Shift ID down to start of buffer */
name|memmove
argument_list|(
name|bufferp
argument_list|,
name|bufferp
operator|+
name|MC_CMD_LICENSING_GET_ID_V3_OUT_LICENSE_ID_OFST
argument_list|,
operator|*
name|lengthp
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|bufferp
operator|+
operator|(
operator|*
name|lengthp
operator|)
argument_list|,
literal|0
argument_list|,
name|MC_CMD_LICENSING_GET_ID_V3_OUT_LICENSE_ID_OFST
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/* V3 format uses Huntington TLV format partition. See SF-108797-SW */
end_comment

begin_define
define|#
directive|define
name|EFX_LICENSE_V3_KEY_LENGTH_MIN
value|(64)
end_define

begin_define
define|#
directive|define
name|EFX_LICENSE_V3_KEY_LENGTH_MAX
value|(160)
end_define

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_find_start
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
return|return
name|ef10_nvram_buffer_find_item_start
argument_list|(
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|startp
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_find_end
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|endp
argument_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
return|return
name|ef10_nvram_buffer_find_end
argument_list|(
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|endp
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v3_find_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
return|return
name|ef10_nvram_buffer_find_item
argument_list|(
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|startp
argument_list|,
name|lengthp
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_v3_validate_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|)
block|{
comment|/* Check key is a valid V3 key */
name|uint8_t
name|key_type
decl_stmt|;
name|uint8_t
name|key_length
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
if|if
condition|(
name|length
operator|<
name|EFX_LICENSE_V3_KEY_LENGTH_MIN
condition|)
block|{
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|length
operator|>
name|EFX_LICENSE_V3_KEY_LENGTH_MAX
condition|)
block|{
goto|goto
name|fail2
goto|;
block|}
name|key_type
operator|=
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|keyp
operator|)
index|[
literal|0
index|]
expr_stmt|;
name|key_length
operator|=
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|keyp
operator|)
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|key_type
operator|<
literal|3
condition|)
block|{
goto|goto
name|fail3
goto|;
block|}
if|if
condition|(
name|key_length
operator|>
name|length
condition|)
block|{
goto|goto
name|fail4
goto|;
block|}
return|return
operator|(
name|B_TRUE
operator|)
return|;
name|fail4
label|:
name|EFSYS_PROBE
argument_list|(
name|fail4
argument_list|)
expr_stmt|;
name|fail3
label|:
name|EFSYS_PROBE
argument_list|(
name|fail3
argument_list|)
expr_stmt|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE
argument_list|(
name|fail1
argument_list|)
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_read_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out_bcount_part
argument_list|(
argument|key_max_size
argument_list|,
argument|*lengthp
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|size_t
name|key_max_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
return|return
name|ef10_nvram_buffer_get_item
argument_list|(
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|keyp
argument_list|,
name|key_max_size
argument_list|,
name|lengthp
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_write_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
name|EFSYS_ASSERT
argument_list|(
name|length
operator|<=
name|EFX_LICENSE_V3_KEY_LENGTH_MAX
argument_list|)
expr_stmt|;
return|return
name|ef10_nvram_buffer_insert_item
argument_list|(
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|keyp
argument_list|,
name|length
argument_list|,
name|lengthp
argument_list|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_delete_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__in
name|uint32_t
name|end
argument_list|,
name|__out
name|uint32_t
operator|*
name|deltap
argument_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
name|_NOTE
argument_list|(
argument|ARGUNUSED(enp)
argument_list|)
if|if
condition|(
operator|(
name|rc
operator|=
name|ef10_nvram_buffer_delete_item
argument_list|(
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|end
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|fail1
goto|;
block|}
operator|*
name|deltap
operator|=
name|length
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_create_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
comment|/* Construct empty partition */
if|if
condition|(
operator|(
name|rc
operator|=
name|ef10_nvram_buffer_create
argument_list|(
name|enp
argument_list|,
name|NVRAM_PARTITION_TYPE_LICENSE
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|rc
operator|=
name|EFAULT
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_v3_finish_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
block|{
name|efx_rc_t
name|rc
decl_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|ef10_nvram_buffer_finish
argument_list|(
name|bufferp
argument_list|,
name|buffer_size
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|fail1
goto|;
block|}
comment|/* Validate completed partition */
if|if
condition|(
operator|(
name|rc
operator|=
name|ef10_nvram_buffer_validate
argument_list|(
name|enp
argument_list|,
name|NVRAM_PARTITION_TYPE_LICENSE
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|fail2
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail2
label|:
name|EFSYS_PROBE
argument_list|(
name|fail2
argument_list|)
expr_stmt|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_MEDFORD */
end_comment

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_lic_init
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
decl_stmt|;
name|efx_key_stats_t
name|eks
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_PROBE
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
operator|!
operator|(
name|enp
operator|->
name|en_mod_flags
operator|&
name|EFX_MOD_LIC
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|enp
operator|->
name|en_family
condition|)
block|{
if|#
directive|if
name|EFSYS_OPT_SIENA
case|case
name|EFX_FAMILY_SIENA
case|:
name|elop
operator|=
operator|&
name|__efx_lic_v1_ops
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_SIENA */
if|#
directive|if
name|EFSYS_OPT_HUNTINGTON
case|case
name|EFX_FAMILY_HUNTINGTON
case|:
name|elop
operator|=
operator|&
name|__efx_lic_v2_ops
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_HUNTINGTON */
if|#
directive|if
name|EFSYS_OPT_MEDFORD
case|case
name|EFX_FAMILY_MEDFORD
case|:
name|elop
operator|=
operator|&
name|__efx_lic_v3_ops
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* EFSYS_OPT_MEDFORD */
default|default:
name|EFSYS_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ENOTSUP
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|enp
operator|->
name|en_elop
operator|=
name|elop
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator||=
name|EFX_MOD_LIC
expr_stmt|;
comment|/* Probe for support */
if|if
condition|(
name|efx_lic_get_key_stats
argument_list|(
name|enp
argument_list|,
operator|&
name|eks
argument_list|)
operator|==
literal|0
condition|)
block|{
name|enp
operator|->
name|en_licensing_supported
operator|=
name|B_TRUE
expr_stmt|;
block|}
else|else
block|{
name|enp
operator|->
name|en_licensing_supported
operator|=
name|B_FALSE
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|extern
name|__checkReturn
name|boolean_t
name|efx_lic_check_support
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_PROBE
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
return|return
name|enp
operator|->
name|en_licensing_supported
return|;
block|}
end_function

begin_function
name|void
name|efx_lic_fini
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_PROBE
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
name|enp
operator|->
name|en_elop
operator|=
name|NULL
expr_stmt|;
name|enp
operator|->
name|en_mod_flags
operator|&=
operator|~
name|EFX_MOD_LIC
expr_stmt|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_lic_update_licenses
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_update_licenses
argument_list|(
name|enp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_lic_get_key_stats
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__out
name|efx_key_stats_t
modifier|*
name|eksp
parameter_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_get_key_stats
argument_list|(
name|enp
argument_list|,
name|eksp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_lic_app_state
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|uint64_t
name|app_id
parameter_list|,
name|__out
name|boolean_t
modifier|*
name|licensedp
parameter_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|elop
operator|->
name|elo_app_state
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOTSUP
operator|)
return|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_app_state
argument_list|(
name|enp
argument_list|,
name|app_id
argument_list|,
name|licensedp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|__checkReturn
name|efx_rc_t
name|efx_lic_get_id
parameter_list|(
name|__in
name|efx_nic_t
modifier|*
name|enp
parameter_list|,
name|__in
name|size_t
name|buffer_size
parameter_list|,
name|__out
name|uint32_t
modifier|*
name|typep
parameter_list|,
name|__out
name|size_t
modifier|*
name|lengthp
parameter_list|,
name|__out_opt
name|uint8_t
modifier|*
name|bufferp
parameter_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|elop
operator|->
name|elo_get_id
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOTSUP
operator|)
return|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_get_id
argument_list|(
name|enp
argument_list|,
name|buffer_size
argument_list|,
name|typep
argument_list|,
name|lengthp
argument_list|,
name|bufferp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Buffer management API - abstracts varying TLV format used for License partition */
end_comment

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_find_start
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_find_start
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|startp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_find_end
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|endp
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_find_end
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|endp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_find_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__out
name|uint32_t
operator|*
name|startp
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|bufferp
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|startp
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT
argument_list|(
name|lengthp
argument_list|)
expr_stmt|;
return|return
operator|(
name|elop
operator|->
name|elo_find_key
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|startp
argument_list|,
name|lengthp
argument_list|)
operator|)
return|;
block|}
end_decl_stmt

begin_comment
comment|/* Validate that the buffer contains a single key in a recognised format. ** An empty or terminator buffer is not accepted as a valid key. */
end_comment

begin_decl_stmt
name|__checkReturn
name|__success
argument_list|(return
operator|!=
name|B_FALSE
argument_list|)
name|boolean_t
name|efx_lic_validate_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|boolean_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_validate_key
argument_list|(
name|enp
argument_list|,
name|keyp
argument_list|,
name|length
argument_list|)
operator|)
operator|==
name|B_FALSE
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
name|B_TRUE
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_read_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out_bcount_part
argument_list|(
argument|key_max_size
argument_list|,
argument|*lengthp
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|size_t
name|key_max_size
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_read_key
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|keyp
argument_list|,
name|key_max_size
argument_list|,
name|lengthp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_write_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in_bcount
argument_list|(
argument|length
argument_list|)
name|caddr_t
name|keyp
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__out
name|uint32_t
operator|*
name|lengthp
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_write_key
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|keyp
argument_list|,
name|length
argument_list|,
name|lengthp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_delete_key
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|,
name|__in
name|uint32_t
name|offset
argument_list|,
name|__in
name|uint32_t
name|length
argument_list|,
name|__in
name|uint32_t
name|end
argument_list|,
name|__out
name|uint32_t
operator|*
name|deltap
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_delete_key
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|,
name|offset
argument_list|,
name|length
argument_list|,
name|end
argument_list|,
name|deltap
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_create_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_create_partition
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|__checkReturn
name|efx_rc_t
name|efx_lic_finish_partition
argument_list|(
name|__in
name|efx_nic_t
operator|*
name|enp
argument_list|,
name|__in_bcount
argument_list|(
argument|buffer_size
argument_list|)
name|caddr_t
name|bufferp
argument_list|,
name|__in
name|size_t
name|buffer_size
argument_list|)
block|{
specifier|const
name|efx_lic_ops_t
modifier|*
name|elop
init|=
name|enp
operator|->
name|en_elop
decl_stmt|;
name|efx_rc_t
name|rc
decl_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_magic
argument_list|,
operator|==
argument_list|,
name|EFX_NIC_MAGIC
argument_list|)
expr_stmt|;
name|EFSYS_ASSERT3U
argument_list|(
name|enp
operator|->
name|en_mod_flags
argument_list|,
operator|&
argument_list|,
name|EFX_MOD_LIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|elop
operator|->
name|elo_finish_partition
argument_list|(
name|enp
argument_list|,
name|bufferp
argument_list|,
name|buffer_size
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail1
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail1
label|:
name|EFSYS_PROBE1
argument_list|(
name|fail1
argument_list|,
name|efx_rc_t
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EFSYS_OPT_LICENSING */
end_comment

end_unit


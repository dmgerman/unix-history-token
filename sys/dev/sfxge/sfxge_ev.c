begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010-2011 Solarflare Communications, Inc.  * All rights reserved.  *  * This software was developed in part by Philip Paeps under contract for  * Solarflare Communications, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|"common/efx.h"
end_include

begin_include
include|#
directive|include
file|"sfxge.h"
end_include

begin_function
specifier|static
name|void
name|sfxge_ev_qcomplete
parameter_list|(
name|struct
name|sfxge_evq
modifier|*
name|evq
parameter_list|,
name|boolean_t
name|eop
parameter_list|)
block|{
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|unsigned
name|int
name|index
decl_stmt|;
name|struct
name|sfxge_rxq
modifier|*
name|rxq
decl_stmt|;
name|struct
name|sfxge_txq
modifier|*
name|txq
decl_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
name|index
operator|=
name|evq
operator|->
name|index
expr_stmt|;
name|rxq
operator|=
name|sc
operator|->
name|rxq
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|txq
operator|=
name|evq
operator|->
name|txq
operator|)
operator|!=
name|NULL
condition|)
block|{
name|evq
operator|->
name|txq
operator|=
name|NULL
expr_stmt|;
name|evq
operator|->
name|txqs
operator|=
operator|&
operator|(
name|evq
operator|->
name|txq
operator|)
expr_stmt|;
do|do
block|{
name|struct
name|sfxge_txq
modifier|*
name|next
decl_stmt|;
name|next
operator|=
name|txq
operator|->
name|next
expr_stmt|;
name|txq
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|KASSERT
argument_list|(
name|txq
operator|->
name|evq_index
operator|==
name|index
argument_list|,
operator|(
literal|"txq->evq_index != index"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|txq
operator|->
name|pending
operator|!=
name|txq
operator|->
name|completed
condition|)
name|sfxge_tx_qcomplete
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|txq
operator|=
name|next
expr_stmt|;
block|}
do|while
condition|(
name|txq
operator|!=
name|NULL
condition|)
do|;
block|}
if|if
condition|(
name|rxq
operator|->
name|pending
operator|!=
name|rxq
operator|->
name|completed
condition|)
name|sfxge_rx_qcomplete
argument_list|(
name|rxq
argument_list|,
name|eop
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_rx
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|label
parameter_list|,
name|uint32_t
name|id
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sfxge_rxq
modifier|*
name|rxq
decl_stmt|;
name|unsigned
name|int
name|expected
decl_stmt|;
name|struct
name|sfxge_rx_sw_desc
modifier|*
name|rx_desc
decl_stmt|;
name|evq
operator|=
name|arg
expr_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|evq
operator|->
name|exception
condition|)
goto|goto
name|done
goto|;
name|rxq
operator|=
name|sc
operator|->
name|rxq
index|[
name|label
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|rxq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"rxq == NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|index
operator|==
name|rxq
operator|->
name|index
argument_list|,
operator|(
literal|"evq->index != rxq->index"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxq
operator|->
name|init_state
operator|!=
name|SFXGE_RXQ_STARTED
condition|)
goto|goto
name|done
goto|;
name|expected
operator|=
name|rxq
operator|->
name|pending
operator|++
operator|&
name|rxq
operator|->
name|ptr_mask
expr_stmt|;
if|if
condition|(
name|id
operator|!=
name|expected
condition|)
block|{
name|evq
operator|->
name|exception
operator|=
name|B_TRUE
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"RX completion out of order"
literal|" (id=%#x expected=%#x flags=%#x); resetting\n"
argument_list|,
name|id
argument_list|,
name|expected
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|sfxge_schedule_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|rx_desc
operator|=
operator|&
name|rxq
operator|->
name|queue
index|[
name|id
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|rx_desc
operator|->
name|flags
operator|==
name|EFX_DISCARD
argument_list|,
operator|(
literal|"rx_desc->flags != EFX_DISCARD"
operator|)
argument_list|)
expr_stmt|;
name|rx_desc
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|KASSERT
argument_list|(
name|size
operator|<
operator|(
literal|1
operator|<<
literal|16
operator|)
argument_list|,
operator|(
literal|"size> (1<< 16)"
operator|)
argument_list|)
expr_stmt|;
name|rx_desc
operator|->
name|size
operator|=
operator|(
name|uint16_t
operator|)
name|size
expr_stmt|;
name|prefetch_read_many
argument_list|(
name|rx_desc
operator|->
name|mbuf
argument_list|)
expr_stmt|;
name|evq
operator|->
name|rx_done
operator|++
expr_stmt|;
if|if
condition|(
name|rxq
operator|->
name|pending
operator|-
name|rxq
operator|->
name|completed
operator|>=
name|SFXGE_RX_BATCH
condition|)
name|sfxge_ev_qcomplete
argument_list|(
name|evq
argument_list|,
name|B_FALSE
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|evq
operator|->
name|rx_done
operator|>=
name|SFXGE_EV_BATCH
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_exception
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|code
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
name|evq
operator|->
name|exception
operator|=
name|B_TRUE
expr_stmt|;
if|if
condition|(
name|code
operator|!=
name|EFX_EXCEPTION_UNKNOWN_SENSOREVT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"hardware exception (code=%u); resetting\n"
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|sfxge_schedule_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_rxq_flush_done
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|rxq_index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sfxge_rxq
modifier|*
name|rxq
decl_stmt|;
name|unsigned
name|int
name|index
decl_stmt|;
name|unsigned
name|int
name|label
decl_stmt|;
name|uint16_t
name|magic
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
name|rxq
operator|=
name|sc
operator|->
name|rxq
index|[
name|rxq_index
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|rxq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"rxq == NULL"
operator|)
argument_list|)
expr_stmt|;
comment|/* Resend a software event on the correct queue */
name|index
operator|=
name|rxq
operator|->
name|index
expr_stmt|;
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|index
index|]
expr_stmt|;
name|label
operator|=
name|rxq_index
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|label
operator|&
name|SFXGE_MAGIC_DMAQ_LABEL_MASK
operator|)
operator|==
name|label
argument_list|,
operator|(
literal|"(label& SFXGE_MAGIC_DMAQ_LABEL_MASK) != level"
operator|)
argument_list|)
expr_stmt|;
name|magic
operator|=
name|SFXGE_MAGIC_RX_QFLUSH_DONE
operator||
name|label
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_STARTED
argument_list|,
operator|(
literal|"evq not started"
operator|)
argument_list|)
expr_stmt|;
name|efx_ev_qpost
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|magic
argument_list|)
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_rxq_flush_failed
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|rxq_index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sfxge_rxq
modifier|*
name|rxq
decl_stmt|;
name|unsigned
name|int
name|index
decl_stmt|;
name|unsigned
name|int
name|label
decl_stmt|;
name|uint16_t
name|magic
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
name|rxq
operator|=
name|sc
operator|->
name|rxq
index|[
name|rxq_index
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|rxq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"rxq == NULL"
operator|)
argument_list|)
expr_stmt|;
comment|/* Resend a software event on the correct queue */
name|index
operator|=
name|rxq
operator|->
name|index
expr_stmt|;
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|index
index|]
expr_stmt|;
name|label
operator|=
name|rxq_index
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|label
operator|&
name|SFXGE_MAGIC_DMAQ_LABEL_MASK
operator|)
operator|==
name|label
argument_list|,
operator|(
literal|"(label& SFXGE_MAGIC_DMAQ_LABEL_MASK) != label"
operator|)
argument_list|)
expr_stmt|;
name|magic
operator|=
name|SFXGE_MAGIC_RX_QFLUSH_FAILED
operator||
name|label
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_STARTED
argument_list|,
operator|(
literal|"evq not started"
operator|)
argument_list|)
expr_stmt|;
name|efx_ev_qpost
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|magic
argument_list|)
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|sfxge_txq
modifier|*
name|sfxge_get_txq_by_label
parameter_list|(
name|struct
name|sfxge_evq
modifier|*
name|evq
parameter_list|,
name|enum
name|sfxge_txq_type
name|label
parameter_list|)
block|{
name|unsigned
name|int
name|index
decl_stmt|;
name|KASSERT
argument_list|(
operator|(
name|evq
operator|->
name|index
operator|==
literal|0
operator|&&
name|label
operator|<
name|SFXGE_TXQ_NTYPES
operator|)
operator|||
operator|(
name|label
operator|==
name|SFXGE_TXQ_IP_TCP_UDP_CKSUM
operator|)
argument_list|,
operator|(
literal|"unexpected txq label"
operator|)
argument_list|)
expr_stmt|;
name|index
operator|=
operator|(
name|evq
operator|->
name|index
operator|==
literal|0
operator|)
condition|?
name|label
else|:
operator|(
name|evq
operator|->
name|index
operator|-
literal|1
operator|+
name|SFXGE_TXQ_NTYPES
operator|)
expr_stmt|;
return|return
operator|(
name|evq
operator|->
name|sc
operator|->
name|txq
index|[
name|index
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_tx
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|label
parameter_list|,
name|uint32_t
name|id
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_txq
modifier|*
name|txq
decl_stmt|;
name|unsigned
name|int
name|stop
decl_stmt|;
name|unsigned
name|int
name|delta
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|txq
operator|=
name|sfxge_get_txq_by_label
argument_list|(
name|evq
argument_list|,
name|label
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|txq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"txq == NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|index
operator|==
name|txq
operator|->
name|evq_index
argument_list|,
operator|(
literal|"evq->index != txq->evq_index"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|txq
operator|->
name|init_state
operator|!=
name|SFXGE_TXQ_STARTED
condition|)
goto|goto
name|done
goto|;
name|stop
operator|=
operator|(
name|id
operator|+
literal|1
operator|)
operator|&
name|txq
operator|->
name|ptr_mask
expr_stmt|;
name|id
operator|=
name|txq
operator|->
name|pending
operator|&
name|txq
operator|->
name|ptr_mask
expr_stmt|;
name|delta
operator|=
operator|(
name|stop
operator|>=
name|id
operator|)
condition|?
operator|(
name|stop
operator|-
name|id
operator|)
else|:
operator|(
name|txq
operator|->
name|entries
operator|-
name|id
operator|+
name|stop
operator|)
expr_stmt|;
name|txq
operator|->
name|pending
operator|+=
name|delta
expr_stmt|;
name|evq
operator|->
name|tx_done
operator|++
expr_stmt|;
if|if
condition|(
name|txq
operator|->
name|next
operator|==
name|NULL
operator|&&
name|evq
operator|->
name|txqs
operator|!=
operator|&
operator|(
name|txq
operator|->
name|next
operator|)
condition|)
block|{
operator|*
operator|(
name|evq
operator|->
name|txqs
operator|)
operator|=
name|txq
expr_stmt|;
name|evq
operator|->
name|txqs
operator|=
operator|&
operator|(
name|txq
operator|->
name|next
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|txq
operator|->
name|pending
operator|-
name|txq
operator|->
name|completed
operator|>=
name|SFXGE_TX_BATCH
condition|)
name|sfxge_tx_qcomplete
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|evq
operator|->
name|tx_done
operator|>=
name|SFXGE_EV_BATCH
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_txq_flush_done
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|txq_index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sfxge_txq
modifier|*
name|txq
decl_stmt|;
name|unsigned
name|int
name|label
decl_stmt|;
name|uint16_t
name|magic
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
name|txq
operator|=
name|sc
operator|->
name|txq
index|[
name|txq_index
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|txq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"txq == NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|txq
operator|->
name|init_state
operator|==
name|SFXGE_TXQ_INITIALIZED
argument_list|,
operator|(
literal|"txq not initialized"
operator|)
argument_list|)
expr_stmt|;
comment|/* Resend a software event on the correct queue */
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|txq
operator|->
name|evq_index
index|]
expr_stmt|;
name|label
operator|=
name|txq
operator|->
name|type
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|label
operator|&
name|SFXGE_MAGIC_DMAQ_LABEL_MASK
operator|)
operator|==
name|label
argument_list|,
operator|(
literal|"(label& SFXGE_MAGIC_DMAQ_LABEL_MASK) != label"
operator|)
argument_list|)
expr_stmt|;
name|magic
operator|=
name|SFXGE_MAGIC_TX_QFLUSH_DONE
operator||
name|label
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_STARTED
argument_list|,
operator|(
literal|"evq not started"
operator|)
argument_list|)
expr_stmt|;
name|efx_ev_qpost
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|magic
argument_list|)
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_software
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint16_t
name|magic
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|unsigned
name|int
name|label
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
name|label
operator|=
name|magic
operator|&
name|SFXGE_MAGIC_DMAQ_LABEL_MASK
expr_stmt|;
name|magic
operator|&=
operator|~
name|SFXGE_MAGIC_DMAQ_LABEL_MASK
expr_stmt|;
switch|switch
condition|(
name|magic
condition|)
block|{
case|case
name|SFXGE_MAGIC_RX_QFLUSH_DONE
case|:
block|{
name|struct
name|sfxge_rxq
modifier|*
name|rxq
init|=
name|sc
operator|->
name|rxq
index|[
name|label
index|]
decl_stmt|;
name|KASSERT
argument_list|(
name|rxq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"rxq == NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|index
operator|==
name|rxq
operator|->
name|index
argument_list|,
operator|(
literal|"evq->index != rxq->index"
operator|)
argument_list|)
expr_stmt|;
name|sfxge_rx_qflush_done
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SFXGE_MAGIC_RX_QFLUSH_FAILED
case|:
block|{
name|struct
name|sfxge_rxq
modifier|*
name|rxq
init|=
name|sc
operator|->
name|rxq
index|[
name|label
index|]
decl_stmt|;
name|KASSERT
argument_list|(
name|rxq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"rxq == NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|index
operator|==
name|rxq
operator|->
name|index
argument_list|,
operator|(
literal|"evq->index != rxq->index"
operator|)
argument_list|)
expr_stmt|;
name|sfxge_rx_qflush_failed
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SFXGE_MAGIC_RX_QREFILL
case|:
block|{
name|struct
name|sfxge_rxq
modifier|*
name|rxq
init|=
name|sc
operator|->
name|rxq
index|[
name|label
index|]
decl_stmt|;
name|KASSERT
argument_list|(
name|rxq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"rxq == NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|index
operator|==
name|rxq
operator|->
name|index
argument_list|,
operator|(
literal|"evq->index != rxq->index"
operator|)
argument_list|)
expr_stmt|;
name|sfxge_rx_qrefill
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|SFXGE_MAGIC_TX_QFLUSH_DONE
case|:
block|{
name|struct
name|sfxge_txq
modifier|*
name|txq
init|=
name|sfxge_get_txq_by_label
argument_list|(
name|evq
argument_list|,
name|label
argument_list|)
decl_stmt|;
name|KASSERT
argument_list|(
name|txq
operator|!=
name|NULL
argument_list|,
operator|(
literal|"txq == NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|index
operator|==
name|txq
operator|->
name|evq_index
argument_list|,
operator|(
literal|"evq->index != txq->evq_index"
operator|)
argument_list|)
expr_stmt|;
name|sfxge_tx_qflush_done
argument_list|(
name|txq
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
break|break;
block|}
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_sram
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|code
parameter_list|)
block|{
operator|(
name|void
operator|)
name|arg
expr_stmt|;
operator|(
name|void
operator|)
name|code
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|EFX_SRAM_UPDATE
case|:
name|EFSYS_PROBE
argument_list|(
name|sram_update
argument_list|)
expr_stmt|;
break|break;
case|case
name|EFX_SRAM_CLEAR
case|:
name|EFSYS_PROBE
argument_list|(
name|sram_clear
argument_list|)
expr_stmt|;
break|break;
case|case
name|EFX_SRAM_ILLEGAL_CLEAR
case|:
name|EFSYS_PROBE
argument_list|(
name|sram_illegal_clear
argument_list|)
expr_stmt|;
break|break;
default|default:
name|KASSERT
argument_list|(
name|B_FALSE
argument_list|,
operator|(
literal|"Impossible SRAM event"
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_timer
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|index
parameter_list|)
block|{
operator|(
name|void
operator|)
name|arg
expr_stmt|;
operator|(
name|void
operator|)
name|index
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_wake_up
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|index
parameter_list|)
block|{
operator|(
name|void
operator|)
name|arg
expr_stmt|;
operator|(
name|void
operator|)
name|index
expr_stmt|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sfxge_ev_stat_update
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|unsigned
name|int
name|index
decl_stmt|;
name|clock_t
name|now
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sc
operator|->
name|softc_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|evq
index|[
literal|0
index|]
operator|->
name|init_state
operator|!=
name|SFXGE_EVQ_STARTED
condition|)
goto|goto
name|out
goto|;
name|now
operator|=
name|ticks
expr_stmt|;
if|if
condition|(
name|now
operator|-
name|sc
operator|->
name|ev_stats_update_time
operator|<
name|hz
condition|)
goto|goto
name|out
goto|;
name|sc
operator|->
name|ev_stats_update_time
operator|=
name|now
expr_stmt|;
comment|/* Add event counts from each event queue in turn */
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|sc
operator|->
name|intr
operator|.
name|n_alloc
condition|;
name|index
operator|++
control|)
block|{
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|index
index|]
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
name|efx_ev_qstats_update
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|sc
operator|->
name|ev_stats
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|sx_xunlock
argument_list|(
operator|&
name|sc
operator|->
name|softc_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sfxge_ev_stat_handler
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|sfxge_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|unsigned
name|int
name|id
init|=
name|arg2
decl_stmt|;
name|sfxge_ev_stat_update
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|SYSCTL_OUT
argument_list|(
name|req
argument_list|,
operator|&
name|sc
operator|->
name|ev_stats
index|[
name|id
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|ev_stats
index|[
name|id
index|]
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sfxge_ev_stat_init
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
init|=
name|device_get_sysctl_ctx
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|stat_list
decl_stmt|;
name|unsigned
name|int
name|id
decl_stmt|;
name|char
name|name
index|[
literal|40
index|]
decl_stmt|;
name|stat_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|stats_node
argument_list|)
expr_stmt|;
for|for
control|(
name|id
operator|=
literal|0
init|;
name|id
operator|<
name|EV_NQSTATS
condition|;
name|id
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"ev_%s"
argument_list|,
name|efx_ev_qstat_name
argument_list|(
name|sc
operator|->
name|enp
argument_list|,
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|stat_list
argument_list|,
name|OID_AUTO
argument_list|,
name|name
argument_list|,
name|CTLTYPE_U64
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
name|id
argument_list|,
name|sfxge_ev_stat_handler
argument_list|,
literal|"Q"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sfxge_ev_qmoderate
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|idx
parameter_list|,
name|unsigned
name|int
name|us
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|efx_evq_t
modifier|*
name|eep
decl_stmt|;
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|idx
index|]
expr_stmt|;
name|eep
operator|=
name|evq
operator|->
name|common
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_STARTED
argument_list|,
operator|(
literal|"evq->init_state != SFXGE_EVQ_STARTED"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|efx_ev_qmoderate
argument_list|(
name|eep
argument_list|,
name|us
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sfxge_int_mod_handler
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|sfxge_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|struct
name|sfxge_intr
modifier|*
name|intr
init|=
operator|&
name|sc
operator|->
name|intr
decl_stmt|;
name|unsigned
name|int
name|moderation
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|index
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sc
operator|->
name|softc_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|newptr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|SYSCTL_IN
argument_list|(
name|req
argument_list|,
operator|&
name|moderation
argument_list|,
sizeof|sizeof
argument_list|(
name|moderation
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/* We may not be calling efx_ev_qmoderate() now, 		 * so we have to range-check the value ourselves. 		 */
if|if
condition|(
name|moderation
operator|>
name|efx_nic_cfg_get
argument_list|(
name|sc
operator|->
name|enp
argument_list|)
operator|->
name|enc_evq_moderation_max
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sc
operator|->
name|ev_moderation
operator|=
name|moderation
expr_stmt|;
if|if
condition|(
name|intr
operator|->
name|state
operator|==
name|SFXGE_INTR_STARTED
condition|)
block|{
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|intr
operator|->
name|n_alloc
condition|;
name|index
operator|++
control|)
name|sfxge_ev_qmoderate
argument_list|(
name|sc
argument_list|,
name|index
argument_list|,
name|moderation
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|error
operator|=
name|SYSCTL_OUT
argument_list|(
name|req
argument_list|,
operator|&
name|sc
operator|->
name|ev_moderation
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|ev_moderation
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|sx_xunlock
argument_list|(
operator|&
name|sc
operator|->
name|softc_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_initialized
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_STARTING
argument_list|,
operator|(
literal|"evq not starting"
operator|)
argument_list|)
expr_stmt|;
name|evq
operator|->
name|init_state
operator|=
name|SFXGE_EVQ_STARTED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|sfxge_ev_link_change
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|efx_link_mode_t
name|link_mode
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|struct
name|sfxge_softc
modifier|*
name|sc
decl_stmt|;
name|evq
operator|=
operator|(
expr|struct
name|sfxge_evq
operator|*
operator|)
name|arg
expr_stmt|;
name|sc
operator|=
name|evq
operator|->
name|sc
expr_stmt|;
name|sfxge_mac_link_update
argument_list|(
name|sc
argument_list|,
name|link_mode
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|efx_ev_callbacks_t
name|sfxge_ev_callbacks
init|=
block|{
operator|.
name|eec_initialized
operator|=
name|sfxge_ev_initialized
block|,
operator|.
name|eec_rx
operator|=
name|sfxge_ev_rx
block|,
operator|.
name|eec_tx
operator|=
name|sfxge_ev_tx
block|,
operator|.
name|eec_exception
operator|=
name|sfxge_ev_exception
block|,
operator|.
name|eec_rxq_flush_done
operator|=
name|sfxge_ev_rxq_flush_done
block|,
operator|.
name|eec_rxq_flush_failed
operator|=
name|sfxge_ev_rxq_flush_failed
block|,
operator|.
name|eec_txq_flush_done
operator|=
name|sfxge_ev_txq_flush_done
block|,
operator|.
name|eec_software
operator|=
name|sfxge_ev_software
block|,
operator|.
name|eec_sram
operator|=
name|sfxge_ev_sram
block|,
operator|.
name|eec_wake_up
operator|=
name|sfxge_ev_wake_up
block|,
operator|.
name|eec_timer
operator|=
name|sfxge_ev_timer
block|,
operator|.
name|eec_link_change
operator|=
name|sfxge_ev_link_change
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|sfxge_ev_qpoll
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|index
index|]
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|evq
operator|->
name|init_state
operator|!=
name|SFXGE_EVQ_STARTING
operator|&&
name|evq
operator|->
name|init_state
operator|!=
name|SFXGE_EVQ_STARTED
condition|)
block|{
name|rc
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Synchronize the DMA memory for reading */
name|bus_dmamap_sync
argument_list|(
name|evq
operator|->
name|mem
operator|.
name|esm_tag
argument_list|,
name|evq
operator|->
name|mem
operator|.
name|esm_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|rx_done
operator|==
literal|0
argument_list|,
operator|(
literal|"evq->rx_done != 0"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|tx_done
operator|==
literal|0
argument_list|,
operator|(
literal|"evq->tx_done != 0"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|txq
operator|==
name|NULL
argument_list|,
operator|(
literal|"evq->txq != NULL"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|txqs
operator|==
operator|&
name|evq
operator|->
name|txq
argument_list|,
operator|(
literal|"evq->txqs !=&evq->txq"
operator|)
argument_list|)
expr_stmt|;
comment|/* Poll the queue */
name|efx_ev_qpoll
argument_list|(
name|evq
operator|->
name|common
argument_list|,
operator|&
name|evq
operator|->
name|read_ptr
argument_list|,
operator|&
name|sfxge_ev_callbacks
argument_list|,
name|evq
argument_list|)
expr_stmt|;
name|evq
operator|->
name|rx_done
operator|=
literal|0
expr_stmt|;
name|evq
operator|->
name|tx_done
operator|=
literal|0
expr_stmt|;
comment|/* Perform any pending completion processing */
name|sfxge_ev_qcomplete
argument_list|(
name|evq
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
comment|/* Re-prime the event queue for interrupts */
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_ev_qprime
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|evq
operator|->
name|read_ptr
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|mtx_unlock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|mtx_unlock
argument_list|(
operator|&
operator|(
name|evq
operator|->
name|lock
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sfxge_ev_qstop
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|index
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_STARTED
argument_list|,
operator|(
literal|"evq->init_state != SFXGE_EVQ_STARTED"
operator|)
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
name|evq
operator|->
name|init_state
operator|=
name|SFXGE_EVQ_INITIALIZED
expr_stmt|;
name|evq
operator|->
name|read_ptr
operator|=
literal|0
expr_stmt|;
name|evq
operator|->
name|exception
operator|=
name|B_FALSE
expr_stmt|;
comment|/* Add event counts before discarding the common evq state */
name|efx_ev_qstats_update
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|sc
operator|->
name|ev_stats
argument_list|)
expr_stmt|;
name|efx_ev_qdestroy
argument_list|(
name|evq
operator|->
name|common
argument_list|)
expr_stmt|;
name|efx_sram_buf_tbl_clear
argument_list|(
name|sc
operator|->
name|enp
argument_list|,
name|evq
operator|->
name|buf_base_id
argument_list|,
name|EFX_EVQ_NBUFS
argument_list|(
name|evq
operator|->
name|entries
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sfxge_ev_qstart
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|efsys_mem_t
modifier|*
name|esmp
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|index
index|]
expr_stmt|;
name|esmp
operator|=
operator|&
name|evq
operator|->
name|mem
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_INITIALIZED
argument_list|,
operator|(
literal|"evq->init_state != SFXGE_EVQ_INITIALIZED"
operator|)
argument_list|)
expr_stmt|;
comment|/* Clear all events. */
operator|(
name|void
operator|)
name|memset
argument_list|(
name|esmp
operator|->
name|esm_base
argument_list|,
literal|0xff
argument_list|,
name|EFX_EVQ_SIZE
argument_list|(
name|evq
operator|->
name|entries
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Program the buffer table. */
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_sram_buf_tbl_set
argument_list|(
name|sc
operator|->
name|enp
argument_list|,
name|evq
operator|->
name|buf_base_id
argument_list|,
name|esmp
argument_list|,
name|EFX_EVQ_NBUFS
argument_list|(
name|evq
operator|->
name|entries
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* Create the common code event queue. */
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_ev_qcreate
argument_list|(
name|sc
operator|->
name|enp
argument_list|,
name|index
argument_list|,
name|esmp
argument_list|,
name|evq
operator|->
name|entries
argument_list|,
name|evq
operator|->
name|buf_base_id
argument_list|,
operator|&
name|evq
operator|->
name|common
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
name|mtx_lock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* Set the default moderation */
operator|(
name|void
operator|)
name|efx_ev_qmoderate
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|sc
operator|->
name|ev_moderation
argument_list|)
expr_stmt|;
comment|/* Prime the event queue for interrupts */
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_ev_qprime
argument_list|(
name|evq
operator|->
name|common
argument_list|,
name|evq
operator|->
name|read_ptr
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail2
goto|;
name|evq
operator|->
name|init_state
operator|=
name|SFXGE_EVQ_STARTING
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* Wait for the initialization event */
name|count
operator|=
literal|0
expr_stmt|;
do|do
block|{
comment|/* Pause for 100 ms */
name|pause
argument_list|(
literal|"sfxge evq init"
argument_list|,
name|hz
operator|/
literal|10
argument_list|)
expr_stmt|;
comment|/* Check to see if the test event has been processed */
if|if
condition|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_STARTED
condition|)
goto|goto
name|done
goto|;
block|}
do|while
condition|(
operator|++
name|count
operator|<
literal|20
condition|)
do|;
name|rc
operator|=
name|ETIMEDOUT
expr_stmt|;
goto|goto
name|fail3
goto|;
name|done
label|:
return|return
operator|(
literal|0
operator|)
return|;
name|fail3
label|:
name|mtx_lock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
name|evq
operator|->
name|init_state
operator|=
name|SFXGE_EVQ_INITIALIZED
expr_stmt|;
name|fail2
label|:
name|mtx_unlock
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
name|efx_ev_qdestroy
argument_list|(
name|evq
operator|->
name|common
argument_list|)
expr_stmt|;
name|fail
label|:
name|efx_sram_buf_tbl_clear
argument_list|(
name|sc
operator|->
name|enp
argument_list|,
name|evq
operator|->
name|buf_base_id
argument_list|,
name|EFX_EVQ_NBUFS
argument_list|(
name|evq
operator|->
name|entries
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|void
name|sfxge_ev_stop
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sfxge_intr
modifier|*
name|intr
decl_stmt|;
name|efx_nic_t
modifier|*
name|enp
decl_stmt|;
name|int
name|index
decl_stmt|;
name|intr
operator|=
operator|&
name|sc
operator|->
name|intr
expr_stmt|;
name|enp
operator|=
name|sc
operator|->
name|enp
expr_stmt|;
name|KASSERT
argument_list|(
name|intr
operator|->
name|state
operator|==
name|SFXGE_INTR_STARTED
argument_list|,
operator|(
literal|"Interrupts not started"
operator|)
argument_list|)
expr_stmt|;
comment|/* Stop the event queue(s) */
name|index
operator|=
name|intr
operator|->
name|n_alloc
expr_stmt|;
while|while
condition|(
operator|--
name|index
operator|>=
literal|0
condition|)
name|sfxge_ev_qstop
argument_list|(
name|sc
argument_list|,
name|index
argument_list|)
expr_stmt|;
comment|/* Tear down the event module */
name|efx_ev_fini
argument_list|(
name|enp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sfxge_ev_start
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sfxge_intr
modifier|*
name|intr
decl_stmt|;
name|int
name|index
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|intr
operator|=
operator|&
name|sc
operator|->
name|intr
expr_stmt|;
name|KASSERT
argument_list|(
name|intr
operator|->
name|state
operator|==
name|SFXGE_INTR_STARTED
argument_list|,
operator|(
literal|"intr->state != SFXGE_INTR_STARTED"
operator|)
argument_list|)
expr_stmt|;
comment|/* Initialize the event module */
if|if
condition|(
operator|(
name|rc
operator|=
name|efx_ev_init
argument_list|(
name|sc
operator|->
name|enp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* Start the event queues */
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|intr
operator|->
name|n_alloc
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rc
operator|=
name|sfxge_ev_qstart
argument_list|(
name|sc
argument_list|,
name|index
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
comment|/* Stop the event queue(s) */
while|while
condition|(
operator|--
name|index
operator|>=
literal|0
condition|)
name|sfxge_ev_qstop
argument_list|(
name|sc
argument_list|,
name|index
argument_list|)
expr_stmt|;
comment|/* Tear down the event module */
name|efx_ev_fini
argument_list|(
name|sc
operator|->
name|enp
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sfxge_ev_qfini
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|evq
operator|=
name|sc
operator|->
name|evq
index|[
name|index
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|init_state
operator|==
name|SFXGE_EVQ_INITIALIZED
argument_list|,
operator|(
literal|"evq->init_state != SFXGE_EVQ_INITIALIZED"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|evq
operator|->
name|txqs
operator|==
operator|&
name|evq
operator|->
name|txq
argument_list|,
operator|(
literal|"evq->txqs !=&evq->txq"
operator|)
argument_list|)
expr_stmt|;
name|sfxge_dma_free
argument_list|(
operator|&
name|evq
operator|->
name|mem
argument_list|)
expr_stmt|;
name|sc
operator|->
name|evq
index|[
name|index
index|]
operator|=
name|NULL
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|evq
argument_list|,
name|M_SFXGE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sfxge_ev_qinit
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|)
block|{
name|struct
name|sfxge_evq
modifier|*
name|evq
decl_stmt|;
name|efsys_mem_t
modifier|*
name|esmp
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|KASSERT
argument_list|(
name|index
operator|<
name|SFXGE_RX_SCALE_MAX
argument_list|,
operator|(
literal|"index>= SFXGE_RX_SCALE_MAX"
operator|)
argument_list|)
expr_stmt|;
name|evq
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|sfxge_evq
argument_list|)
argument_list|,
name|M_SFXGE
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|evq
operator|->
name|sc
operator|=
name|sc
expr_stmt|;
name|evq
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|sc
operator|->
name|evq
index|[
name|index
index|]
operator|=
name|evq
expr_stmt|;
name|esmp
operator|=
operator|&
name|evq
operator|->
name|mem
expr_stmt|;
comment|/* Build an event queue with room for one event per tx and rx buffer, 	 * plus some extra for link state events and MCDI completions. 	 * There are three tx queues in the first event queue and one in 	 * other. 	 */
if|if
condition|(
name|index
operator|==
literal|0
condition|)
name|evq
operator|->
name|entries
operator|=
name|ROUNDUP_POW_OF_TWO
argument_list|(
name|sc
operator|->
name|rxq_entries
operator|+
literal|3
operator|*
name|sc
operator|->
name|txq_entries
operator|+
literal|128
argument_list|)
expr_stmt|;
else|else
name|evq
operator|->
name|entries
operator|=
name|ROUNDUP_POW_OF_TWO
argument_list|(
name|sc
operator|->
name|rxq_entries
operator|+
name|sc
operator|->
name|txq_entries
operator|+
literal|128
argument_list|)
expr_stmt|;
comment|/* Initialise TX completion list */
name|evq
operator|->
name|txqs
operator|=
operator|&
name|evq
operator|->
name|txq
expr_stmt|;
comment|/* Allocate DMA space. */
if|if
condition|(
operator|(
name|rc
operator|=
name|sfxge_dma_alloc
argument_list|(
name|sc
argument_list|,
name|EFX_EVQ_SIZE
argument_list|(
name|evq
operator|->
name|entries
argument_list|)
argument_list|,
name|esmp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|rc
operator|)
return|;
comment|/* Allocate buffer table entries. */
name|sfxge_sram_buf_tbl_alloc
argument_list|(
name|sc
argument_list|,
name|EFX_EVQ_NBUFS
argument_list|(
name|evq
operator|->
name|entries
argument_list|)
argument_list|,
operator|&
name|evq
operator|->
name|buf_base_id
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|evq
operator|->
name|lock
argument_list|,
literal|"evq"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|evq
operator|->
name|init_state
operator|=
name|SFXGE_EVQ_INITIALIZED
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|sfxge_ev_fini
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sfxge_intr
modifier|*
name|intr
decl_stmt|;
name|int
name|index
decl_stmt|;
name|intr
operator|=
operator|&
name|sc
operator|->
name|intr
expr_stmt|;
name|KASSERT
argument_list|(
name|intr
operator|->
name|state
operator|==
name|SFXGE_INTR_INITIALIZED
argument_list|,
operator|(
literal|"intr->state != SFXGE_INTR_INITIALIZED"
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ev_moderation
operator|=
literal|0
expr_stmt|;
comment|/* Tear down the event queue(s). */
name|index
operator|=
name|intr
operator|->
name|n_alloc
expr_stmt|;
while|while
condition|(
operator|--
name|index
operator|>=
literal|0
condition|)
name|sfxge_ev_qfini
argument_list|(
name|sc
argument_list|,
name|index
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sfxge_ev_init
parameter_list|(
name|struct
name|sfxge_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|sysctl_ctx
init|=
name|device_get_sysctl_ctx
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|sysctl_tree
init|=
name|device_get_sysctl_tree
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|sfxge_intr
modifier|*
name|intr
decl_stmt|;
name|int
name|index
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|intr
operator|=
operator|&
name|sc
operator|->
name|intr
expr_stmt|;
name|KASSERT
argument_list|(
name|intr
operator|->
name|state
operator|==
name|SFXGE_INTR_INITIALIZED
argument_list|,
operator|(
literal|"intr->state != SFXGE_INTR_INITIALIZED"
operator|)
argument_list|)
expr_stmt|;
comment|/* Set default interrupt moderation; add a sysctl to 	 * read and change it. 	 */
name|sc
operator|->
name|ev_moderation
operator|=
literal|30
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"int_mod"
argument_list|,
name|CTLTYPE_UINT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sfxge_int_mod_handler
argument_list|,
literal|"IU"
argument_list|,
literal|"sfxge interrupt moderation (us)"
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize the event queue(s) - one per interrupt. 	 */
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|intr
operator|->
name|n_alloc
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|rc
operator|=
name|sfxge_ev_qinit
argument_list|(
name|sc
argument_list|,
name|index
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|fail
goto|;
block|}
name|sfxge_ev_stat_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
while|while
condition|(
operator|--
name|index
operator|>=
literal|0
condition|)
name|sfxge_ev_qfini
argument_list|(
name|sc
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

end_unit


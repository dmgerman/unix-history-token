begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013-2014 Qlogic Corporation  * All rights reserved.  *  *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"  *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE  *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  *  POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * File: qls_hw.c  * Author : David C Somayajulu, Qlogic Corporation, Aliso Viejo, CA 92656.  * Content: Contains Hardware dependant functions  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"qls_os.h"
end_include

begin_include
include|#
directive|include
file|"qls_hw.h"
end_include

begin_include
include|#
directive|include
file|"qls_def.h"
end_include

begin_include
include|#
directive|include
file|"qls_inline.h"
end_include

begin_include
include|#
directive|include
file|"qls_ver.h"
end_include

begin_include
include|#
directive|include
file|"qls_glbl.h"
end_include

begin_include
include|#
directive|include
file|"qls_dbg.h"
end_include

begin_comment
comment|/*  * Static Functions  */
end_comment

begin_function_decl
specifier|static
name|int
name|qls_wait_for_mac_proto_idx_ready
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_config_unicast_mac_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_config_mcast_mac_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|,
name|uint32_t
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_init_rss
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_init_comp_queue
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|cid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_init_work_queue
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|wid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_init_fw_routing_table
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_hw_add_all_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_hw_add_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_hw_del_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_wait_for_flash_ready
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_sem_lock
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mask
parameter_list|,
name|uint32_t
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qls_sem_unlock
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qls_free_tx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_alloc_tx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qls_free_rx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_alloc_rx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qls_free_mpi_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_alloc_mpi_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qls_free_rss_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_alloc_rss_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_flash_validate
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
specifier|const
name|char
modifier|*
name|signature
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_wait_for_proc_addr_ready
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_proc_addr_rd_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|addr_module
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_proc_addr_wr_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|addr_module
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_hw_reset
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * MPI Related Functions  */
end_comment

begin_function_decl
specifier|static
name|int
name|qls_mbx_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|in_mbx
parameter_list|,
name|uint32_t
name|i_count
parameter_list|,
name|uint32_t
modifier|*
name|out_mbx
parameter_list|,
name|uint32_t
name|o_count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_mbx_set_mgmt_ctrl
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|t_ctrl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|qls_mbx_get_mgmt_ctrl
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|t_status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qls_mbx_get_link_status
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|qls_mbx_about_fw
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|qls_get_msix_count
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
return|return
operator|(
name|ha
operator|->
name|num_rx_rings
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_syctl_mpi_dump
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ret
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
block|{
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
name|qls_mpi_core_dump
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_syctl_link_status
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
name|qla_host_t
modifier|*
name|ha
decl_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ret
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
block|{
name|ha
operator|=
operator|(
name|qla_host_t
operator|*
operator|)
name|arg1
expr_stmt|;
name|qls_mbx_get_link_status
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_mbx_about_fw
argument_list|(
name|ha
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qls_hw_add_sysctls
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|ha
operator|->
name|num_rx_rings
operator|=
name|MAX_RX_RINGS
expr_stmt|;
name|ha
operator|->
name|num_tx_rings
operator|=
name|MAX_TX_RINGS
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"num_rx_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|num_rx_rings
argument_list|,
name|ha
operator|->
name|num_rx_rings
argument_list|,
literal|"Number of Completion Queues"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"num_tx_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|ha
operator|->
name|num_tx_rings
argument_list|,
name|ha
operator|->
name|num_tx_rings
argument_list|,
literal|"Number of Transmit Rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mpi_dump"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qls_syctl_mpi_dump
argument_list|,
literal|"I"
argument_list|,
literal|"MPI Dump"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"link_status"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ha
argument_list|,
literal|0
argument_list|,
name|qls_syctl_link_status
argument_list|,
literal|"I"
argument_list|,
literal|"Link Status"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_free_dma  * Function: Frees the DMA'able memory allocated in qls_alloc_dma()  */
end_comment

begin_function
name|void
name|qls_free_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qls_free_rss_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_free_mpi_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_free_tx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_free_rx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qls_alloc_dma  * Function: Allocates DMA'able memory for Tx/Rx Rings, Tx/Rx Contexts.  */
end_comment

begin_function
name|int
name|qls_alloc_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
if|if
condition|(
name|qls_alloc_rx_dma
argument_list|(
name|ha
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|qls_alloc_tx_dma
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|qls_free_rx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|qls_alloc_mpi_dma
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|qls_free_tx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_free_rx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|qls_alloc_rss_dma
argument_list|(
name|ha
argument_list|)
condition|)
block|{
name|qls_free_mpi_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_free_tx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_free_rx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_wait_for_mac_proto_idx_ready
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|op
parameter_list|)
block|{
name|uint32_t
name|data32
decl_stmt|;
name|uint32_t
name|count
init|=
literal|3
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data32
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|data32
operator|&
name|op
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|QLA_USEC_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_config_unicast_mac_addr  * Function: binds/unbinds a unicast MAC address to the interface.  */
end_comment

begin_function
specifier|static
name|int
name|qls_config_unicast_mac_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mac_upper
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mac_lower
init|=
literal|0
decl_stmt|;
name|uint32_t
name|value
init|=
literal|0
decl_stmt|,
name|index
decl_stmt|;
if|if
condition|(
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_MAC_SERDES
argument_list|,
name|Q81_CTL_SEM_SET_MAC_SERDES
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|add_mac
condition|)
block|{
name|mac_upper
operator|=
operator|(
name|ha
operator|->
name|mac_addr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|ha
operator|->
name|mac_addr
index|[
literal|1
index|]
expr_stmt|;
name|mac_lower
operator|=
operator|(
name|ha
operator|->
name|mac_addr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|ha
operator|->
name|mac_addr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|ha
operator|->
name|mac_addr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|ha
operator|->
name|mac_addr
index|[
literal|5
index|]
expr_stmt|;
block|}
name|ret
operator|=
name|qls_wait_for_mac_proto_idx_ready
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_AI_MW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_config_unicast_mac_addr_exit
goto|;
name|index
operator|=
literal|128
operator|*
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
expr_stmt|;
comment|/* index */
name|value
operator|=
operator|(
name|index
operator|<<
name|Q81_CTL_MAC_PROTO_AI_IDX_SHIFT
operator|)
operator||
name|Q81_CTL_MAC_PROTO_AI_TYPE_CAM_MAC
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_INDEX
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_DATA
argument_list|,
name|mac_lower
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_mac_proto_idx_ready
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_AI_MW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_config_unicast_mac_addr_exit
goto|;
name|value
operator|=
operator|(
name|index
operator|<<
name|Q81_CTL_MAC_PROTO_AI_IDX_SHIFT
operator|)
operator||
name|Q81_CTL_MAC_PROTO_AI_TYPE_CAM_MAC
operator||
literal|0x1
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_INDEX
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_DATA
argument_list|,
name|mac_upper
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_mac_proto_idx_ready
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_AI_MW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_config_unicast_mac_addr_exit
goto|;
name|value
operator|=
operator|(
name|index
operator|<<
name|Q81_CTL_MAC_PROTO_AI_IDX_SHIFT
operator|)
operator||
name|Q81_CTL_MAC_PROTO_AI_TYPE_CAM_MAC
operator||
literal|0x2
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_INDEX
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
name|Q81_CAM_MAC_OFF2_ROUTE_NIC
operator||
operator|(
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
operator|<<
name|Q81_CAM_MAC_OFF2_FUNC_SHIFT
operator|)
operator||
operator|(
literal|0
operator|<<
name|Q81_CAM_MAC_OFF2_CQID_SHIFT
operator|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_DATA
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|qls_config_unicast_mac_addr_exit
label|:
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_MAC_SERDES
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_config_mcast_mac_addr  * Function: binds/unbinds a multicast MAC address to the interface.  */
end_comment

begin_function
specifier|static
name|int
name|qls_config_mcast_mac_addr
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mac_addr
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|,
name|uint32_t
name|index
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mac_upper
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mac_lower
init|=
literal|0
decl_stmt|;
name|uint32_t
name|value
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_MAC_SERDES
argument_list|,
name|Q81_CTL_SEM_SET_MAC_SERDES
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|add_mac
condition|)
block|{
name|mac_upper
operator|=
operator|(
name|mac_addr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|mac_addr
index|[
literal|1
index|]
expr_stmt|;
name|mac_lower
operator|=
operator|(
name|mac_addr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|mac_addr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|mac_addr
index|[
literal|5
index|]
expr_stmt|;
block|}
name|ret
operator|=
name|qls_wait_for_mac_proto_idx_ready
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_AI_MW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_config_mcast_mac_addr_exit
goto|;
name|value
operator|=
name|Q81_CTL_MAC_PROTO_AI_E
operator||
operator|(
name|index
operator|<<
name|Q81_CTL_MAC_PROTO_AI_IDX_SHIFT
operator|)
operator||
name|Q81_CTL_MAC_PROTO_AI_TYPE_MCAST
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_INDEX
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_DATA
argument_list|,
name|mac_lower
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_mac_proto_idx_ready
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_AI_MW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_config_mcast_mac_addr_exit
goto|;
name|value
operator|=
name|Q81_CTL_MAC_PROTO_AI_E
operator||
operator|(
name|index
operator|<<
name|Q81_CTL_MAC_PROTO_AI_IDX_SHIFT
operator|)
operator||
name|Q81_CTL_MAC_PROTO_AI_TYPE_MCAST
operator||
literal|0x1
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_INDEX
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_MAC_PROTO_ADDR_DATA
argument_list|,
name|mac_upper
argument_list|)
expr_stmt|;
name|qls_config_mcast_mac_addr_exit
label|:
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_MAC_SERDES
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_set_mac_rcv_mode  * Function: Enable/Disable AllMulticast and Promiscous Modes.  */
end_comment

begin_function
specifier|static
name|int
name|qls_wait_for_route_idx_ready
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|op
parameter_list|)
block|{
name|uint32_t
name|data32
decl_stmt|;
name|uint32_t
name|count
init|=
literal|3
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data32
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ROUTING_INDEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|data32
operator|&
name|op
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|QLA_USEC_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_load_route_idx_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|index
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|qls_wait_for_route_idx_ready
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_RI_MW
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: [0x%08x, 0x%08x] failed\n"
argument_list|,
name|__func__
argument_list|,
name|index
argument_list|,
name|data
argument_list|)
expr_stmt|;
goto|goto
name|qls_load_route_idx_reg_exit
goto|;
block|}
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ROUTING_INDEX
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ROUTING_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|qls_load_route_idx_reg_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_load_route_idx_reg_locked
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|index
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_RIDX_DATAREG
argument_list|,
name|Q81_CTL_SEM_SET_RIDX_DATAREG
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ret
operator|=
name|qls_load_route_idx_reg
argument_list|(
name|ha
argument_list|,
name|index
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_RIDX_DATAREG
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_clear_routing_table
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_RIDX_DATAREG
argument_list|,
name|Q81_CTL_SEM_SET_RIDX_DATAREG
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_load_route_idx_reg
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
operator|(
name|i
operator|<<
literal|8
operator|)
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_RIDX_DATAREG
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|qls_set_promisc
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|qls_load_route_idx_reg_locked
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_E
operator||
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_PROMISCUOUS
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator|)
argument_list|,
name|Q81_CTL_RD_VALID_PKT
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qls_reset_promisc
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|qls_load_route_idx_reg_locked
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_PROMISCUOUS
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|qls_set_allmulti
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|qls_load_route_idx_reg_locked
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_E
operator||
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_ALLMULTI
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator|)
argument_list|,
name|Q81_CTL_RD_MCAST
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|qls_reset_allmulti
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|qls_load_route_idx_reg_locked
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_ALLMULTI
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_init_fw_routing_table
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|qls_clear_routing_table
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_RIDX_DATAREG
argument_list|,
name|Q81_CTL_SEM_SET_RIDX_DATAREG
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ret
operator|=
name|qls_load_route_idx_reg
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_E
operator||
name|Q81_CTL_RI_DST_DROP
operator||
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_ALL_ERROR
operator|)
argument_list|,
name|Q81_CTL_RD_ERROR_PKT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_fw_routing_table_exit
goto|;
name|ret
operator|=
name|qls_load_route_idx_reg
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_E
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator||
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_BCAST
operator|)
argument_list|,
name|Q81_CTL_RD_BCAST
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_fw_routing_table_exit
goto|;
if|if
condition|(
name|ha
operator|->
name|num_rx_rings
operator|>
literal|1
condition|)
block|{
name|ret
operator|=
name|qls_load_route_idx_reg
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_E
operator||
name|Q81_CTL_RI_DST_RSS
operator||
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_RSS_MATCH
operator|)
argument_list|,
name|Q81_CTL_RD_RSS_MATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_fw_routing_table_exit
goto|;
block|}
name|ret
operator|=
name|qls_load_route_idx_reg
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_E
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator||
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_MCAST_MATCH
operator|)
argument_list|,
name|Q81_CTL_RD_MCAST_REG_MATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_fw_routing_table_exit
goto|;
name|ret
operator|=
name|qls_load_route_idx_reg
argument_list|(
name|ha
argument_list|,
operator|(
name|Q81_CTL_RI_E
operator||
name|Q81_CTL_RI_DST_DFLTQ
operator||
name|Q81_CTL_RI_TYPE_NICQMASK
operator||
name|Q81_CTL_RI_IDX_CAM_HIT
operator|)
argument_list|,
name|Q81_CTL_RD_CAM_HIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_fw_routing_table_exit
goto|;
name|qls_init_fw_routing_table_exit
label|:
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_RIDX_DATAREG
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_tx_tso_chksum
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|q81_tx_tso_t
modifier|*
name|tx_mac
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
decl_stmt|;
name|uint32_t
name|ehdrlen
decl_stmt|,
name|ip_hlen
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint16_t
name|etype
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|uint8_t
name|buf
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
index|]
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mp
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ehdrlen
operator|=
name|ETHER_HDR_LEN
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|ehdrlen
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|buf
expr_stmt|;
block|}
name|tx_mac
operator|->
name|opcode
operator|=
name|Q81_IOCB_TX_TSO
expr_stmt|;
name|tx_mac
operator|->
name|flags
operator||=
name|Q81_TX_TSO_FLAGS_IPV4
expr_stmt|;
name|tx_mac
operator|->
name|phdr_offsets
operator|=
name|ehdrlen
expr_stmt|;
name|tx_mac
operator|->
name|phdr_offsets
operator||=
operator|(
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
operator|<<
name|Q81_TX_TSO_PHDR_SHIFT
operator|)
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
name|tx_mac
operator|->
name|flags
operator||=
name|Q81_TX_TSO_FLAGS_LSO
expr_stmt|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
name|th
operator|->
name|th_sum
operator|=
name|in_pseudo
argument_list|(
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|,
name|htons
argument_list|(
name|IPPROTO_TCP
argument_list|)
argument_list|)
expr_stmt|;
name|tx_mac
operator|->
name|mss
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
name|tx_mac
operator|->
name|phdr_length
operator|=
name|ip_hlen
operator|+
name|ehdrlen
operator|+
operator|(
name|th
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
break|break;
block|}
name|tx_mac
operator|->
name|vlan_off
operator||=
name|Q81_TX_TSO_VLAN_OFF_IC
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|tx_mac
operator|->
name|flags
operator||=
name|Q81_TX_TSO_FLAGS_TC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
block|{
name|tx_mac
operator|->
name|flags
operator||=
name|Q81_TX_TSO_FLAGS_UC
expr_stmt|;
block|}
break|break;
case|case
name|ETHERTYPE_IPV6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|mp
operator|->
name|m_data
operator|+
name|ehdrlen
operator|)
expr_stmt|;
name|ip_hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_len
operator|<
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
condition|)
block|{
name|m_copydata
argument_list|(
name|mp
argument_list|,
name|ehdrlen
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
name|buf
expr_stmt|;
block|}
name|tx_mac
operator|->
name|opcode
operator|=
name|Q81_IOCB_TX_TSO
expr_stmt|;
name|tx_mac
operator|->
name|flags
operator||=
name|Q81_TX_TSO_FLAGS_IPV6
expr_stmt|;
name|tx_mac
operator|->
name|vlan_off
operator||=
name|Q81_TX_TSO_VLAN_OFF_IC
expr_stmt|;
name|tx_mac
operator|->
name|phdr_offsets
operator|=
name|ehdrlen
expr_stmt|;
name|tx_mac
operator|->
name|phdr_offsets
operator||=
operator|(
operator|(
name|ehdrlen
operator|+
name|ip_hlen
operator|)
operator|<<
name|Q81_TX_TSO_PHDR_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|tx_mac
operator|->
name|flags
operator||=
name|Q81_TX_TSO_FLAGS_TC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ip6
operator|->
name|ip6_nxt
operator|==
name|IPPROTO_UDP
condition|)
block|{
name|tx_mac
operator|->
name|flags
operator||=
name|Q81_TX_TSO_FLAGS_UC
expr_stmt|;
block|}
break|break;
default|default:
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|QLA_TX_MIN_FREE
value|2
end_define

begin_function
name|int
name|qls_hw_tx_done
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|txr_idx
parameter_list|)
block|{
name|uint32_t
name|txr_done
decl_stmt|,
name|txr_next
decl_stmt|;
name|txr_done
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_done
expr_stmt|;
name|txr_next
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_next
expr_stmt|;
if|if
condition|(
name|txr_done
operator|==
name|txr_next
condition|)
block|{
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|=
name|NUM_TX_DESCRIPTORS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|txr_done
operator|>
name|txr_next
condition|)
block|{
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|=
name|txr_done
operator|-
name|txr_next
expr_stmt|;
block|}
else|else
block|{
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|=
name|NUM_TX_DESCRIPTORS
operator|+
name|txr_done
operator|-
name|txr_next
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|<=
name|QLA_TX_MIN_FREE
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_hw_send  * Function: Transmits a packet. It first checks if the packet is a  *	candidate for Large TCP Segment Offload and then for UDP/TCP checksum  *	offload. If either of these creteria are not met, it is transmitted  *	as a regular ethernet frame.  */
end_comment

begin_function
name|int
name|qls_hw_send
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|uint32_t
name|txr_next
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mp
parameter_list|,
name|uint32_t
name|txr_idx
parameter_list|)
block|{
name|q81_tx_mac_t
modifier|*
name|tx_mac
decl_stmt|;
name|q81_txb_desc_t
modifier|*
name|tx_desc
decl_stmt|;
name|uint32_t
name|total_length
init|=
literal|0
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|total_length
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|total_length
operator|>
name|QLA_MAX_TSO_FRAME_SIZE
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: total length exceeds maxlen(%d)\n"
argument_list|,
name|__func__
argument_list|,
name|total_length
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|<=
operator|(
name|NUM_TX_DESCRIPTORS
operator|>>
literal|2
operator|)
condition|)
block|{
if|if
condition|(
name|qls_hw_tx_done
argument_list|(
name|ha
argument_list|,
name|txr_idx
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: tx_free[%d] = %d\n"
argument_list|,
name|__func__
argument_list|,
name|txr_idx
argument_list|,
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_free
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|tx_mac
operator|=
operator|(
name|q81_tx_mac_t
operator|*
operator|)
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|wq_vaddr
index|[
name|txr_next
index|]
expr_stmt|;
name|bzero
argument_list|(
name|tx_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|q81_tx_mac_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator||
name|CSUM_TSO
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|qls_tx_tso_chksum
argument_list|(
name|ha
argument_list|,
name|mp
argument_list|,
operator|(
name|q81_tx_tso_t
operator|*
operator|)
name|tx_mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|mp
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|tx_tso_frames
operator|++
expr_stmt|;
else|else
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|tx_frames
operator|++
expr_stmt|;
block|}
else|else
block|{
name|tx_mac
operator|->
name|opcode
operator|=
name|Q81_IOCB_TX_MAC
expr_stmt|;
block|}
if|if
condition|(
name|mp
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
name|tx_mac
operator|->
name|vlan_tci
operator|=
name|mp
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
expr_stmt|;
name|tx_mac
operator|->
name|vlan_off
operator||=
name|Q81_TX_MAC_VLAN_OFF_V
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|tx_vlan_frames
operator|++
expr_stmt|;
block|}
name|tx_mac
operator|->
name|frame_length
operator|=
name|total_length
expr_stmt|;
name|tx_mac
operator|->
name|tid_lo
operator|=
name|txr_next
expr_stmt|;
if|if
condition|(
name|nsegs
operator|<=
name|MAX_TX_MAC_DESC
condition|)
block|{
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: 1 [%d, %d]\n"
operator|,
name|__func__
operator|,
name|total_length
operator|,
name|tx_mac
operator|->
name|tid_lo
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|tx_mac
operator|->
name|txd
index|[
name|i
index|]
operator|.
name|baddr
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
name|tx_mac
operator|->
name|txd
index|[
name|i
index|]
operator|.
name|length
operator|=
name|segs
operator|->
name|ds_len
expr_stmt|;
name|segs
operator|++
expr_stmt|;
block|}
name|tx_mac
operator|->
name|txd
index|[
operator|(
name|nsegs
operator|-
literal|1
operator|)
index|]
operator|.
name|flags
operator|=
name|Q81_RXB_DESC_FLAGS_E
expr_stmt|;
block|}
else|else
block|{
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: 2 [%d, %d]\n"
operator|,
name|__func__
operator|,
name|total_length
operator|,
name|tx_mac
operator|->
name|tid_lo
operator|)
argument_list|)
expr_stmt|;
name|tx_mac
operator|->
name|txd
index|[
literal|0
index|]
operator|.
name|baddr
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|tx_buf
index|[
name|txr_next
index|]
operator|.
name|oal_paddr
expr_stmt|;
name|tx_mac
operator|->
name|txd
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|nsegs
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|q81_txb_desc_t
argument_list|)
operator|)
expr_stmt|;
name|tx_mac
operator|->
name|txd
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|Q81_RXB_DESC_FLAGS_C
expr_stmt|;
name|tx_desc
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|tx_buf
index|[
name|txr_next
index|]
operator|.
name|oal_vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|tx_desc
operator|->
name|baddr
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
name|tx_desc
operator|->
name|length
operator|=
name|segs
operator|->
name|ds_len
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|nsegs
operator|-
literal|1
operator|)
condition|)
name|tx_desc
operator|->
name|flags
operator|=
name|Q81_RXB_DESC_FLAGS_E
expr_stmt|;
else|else
name|tx_desc
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|segs
operator|++
expr_stmt|;
name|tx_desc
operator|++
expr_stmt|;
block|}
block|}
name|txr_next
operator|=
operator|(
name|txr_next
operator|+
literal|1
operator|)
operator|&
operator|(
name|NUM_TX_DESCRIPTORS
operator|-
literal|1
operator|)
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_next
operator|=
name|txr_next
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|txr_idx
index|]
operator|.
name|txr_free
operator|--
expr_stmt|;
name|Q81_WR_WQ_PROD_IDX
argument_list|(
name|txr_idx
argument_list|,
name|txr_next
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_del_hw_if  * Function: Destroys the hardware specific entities corresponding to an  *	Ethernet Interface  */
end_comment

begin_function
name|void
name|qls_del_hw_if
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|//int  count;
if|if
condition|(
name|ha
operator|->
name|hw_init
operator|==
literal|0
condition|)
block|{
name|qls_hw_reset
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
name|Q81_SET_WQ_INVALID
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|Q81_SET_CQ_INVALID
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|Q81_DISABLE_INTR
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* MSI-x i */
block|}
name|value
operator|=
operator|(
name|Q81_CTL_INTRE_IHD
operator|<<
name|Q81_CTL_INTRE_MASK_SHIFT
operator|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_INTR_ENABLE
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
name|Q81_CTL_INTRE_EI
operator|<<
name|Q81_CTL_INTRE_MASK_SHIFT
operator|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_INTR_ENABLE
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|intr_enable
operator|=
literal|0
expr_stmt|;
name|qls_hw_reset
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Name: qls_init_hw_if  * Function: Creates the hardware specific entities corresponding to an  *	Ethernet Interface - Transmit and Receive Contexts. Sets the MAC Address  *	corresponding to the interface. Enables LRO if allowed.  */
end_comment

begin_function
name|int
name|qls_init_hw_if
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s:enter\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|ha
operator|->
name|pci_dev
expr_stmt|;
name|ret
operator|=
name|qls_hw_reset
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
name|ha
operator|->
name|vm_pgsize
operator|=
literal|4096
expr_stmt|;
comment|/* Enable FAE and EFE bits in System Register */
name|value
operator|=
name|Q81_CTL_SYSTEM_ENABLE_FAE
operator||
name|Q81_CTL_SYSTEM_ENABLE_EFE
expr_stmt|;
name|value
operator|=
operator|(
name|value
operator|<<
name|Q81_CTL_SYSTEM_MASK_SHIFT
operator|)
operator||
name|value
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SYSTEM
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* Set Default Completion Queue_ID in NIC Rcv Configuration Register */
name|value
operator|=
operator|(
name|Q81_CTL_NIC_RCVC_DCQ_MASK
operator|<<
name|Q81_CTL_NIC_RCVC_MASK_SHIFT
operator|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_NIC_RCV_CONFIG
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* Function Specific Control Register - Set Page Size and Enable NIC */
name|value
operator|=
name|Q81_CTL_FUNC_SPECIFIC_FE
operator||
name|Q81_CTL_FUNC_SPECIFIC_VM_PGSIZE_MASK
operator||
name|Q81_CTL_FUNC_SPECIFIC_EPC_O
operator||
name|Q81_CTL_FUNC_SPECIFIC_EPC_I
operator||
name|Q81_CTL_FUNC_SPECIFIC_EC
expr_stmt|;
name|value
operator|=
operator|(
name|value
operator|<<
name|Q81_CTL_FUNC_SPECIFIC_MASK_SHIFT
operator|)
operator||
name|Q81_CTL_FUNC_SPECIFIC_FE
operator||
name|Q81_CTL_FUNC_SPECIFIC_VM_PGSIZE_4K
operator||
name|Q81_CTL_FUNC_SPECIFIC_EPC_O
operator||
name|Q81_CTL_FUNC_SPECIFIC_EPC_I
operator||
name|Q81_CTL_FUNC_SPECIFIC_EC
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_FUNC_SPECIFIC
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* Interrupt Mask Register */
name|value
operator|=
name|Q81_CTL_INTRM_PI
expr_stmt|;
name|value
operator|=
operator|(
name|value
operator|<<
name|Q81_CTL_INTRM_MASK_SHIFT
operator|)
operator||
name|value
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_INTR_MASK
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* Initialiatize Completion Queue */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_init_comp_queue
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
block|}
if|if
condition|(
name|ha
operator|->
name|num_rx_rings
operator|>
literal|1
condition|)
block|{
name|ret
operator|=
name|qls_init_rss
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
block|}
comment|/* Initialize Work Queue */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_init_work_queue
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
comment|/* Set up CAM RAM with MAC Address */
name|ret
operator|=
name|qls_config_unicast_mac_addr
argument_list|(
name|ha
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
name|ret
operator|=
name|qls_hw_add_all_mcast
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
comment|/* Initialize Firmware Routing Table */
name|ret
operator|=
name|qls_init_fw_routing_table
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_hw_if_exit
goto|;
comment|/* Get Chip Revision ID */
name|ha
operator|->
name|rev_id
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_REV_ID
argument_list|)
expr_stmt|;
comment|/* Enable Global Interrupt */
name|value
operator|=
name|Q81_CTL_INTRE_EI
expr_stmt|;
name|value
operator|=
operator|(
name|value
operator|<<
name|Q81_CTL_INTRE_MASK_SHIFT
operator|)
operator||
name|value
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_INTR_ENABLE
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* Enable Interrupt Handshake Disable */
name|value
operator|=
name|Q81_CTL_INTRE_IHD
expr_stmt|;
name|value
operator|=
operator|(
name|value
operator|<<
name|Q81_CTL_INTRE_MASK_SHIFT
operator|)
operator||
name|value
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_INTR_ENABLE
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* Enable Completion Interrupt */
name|ha
operator|->
name|flags
operator|.
name|intr_enable
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|Q81_ENABLE_INTR
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* MSI-x i */
block|}
name|ha
operator|->
name|hw_init
operator|=
literal|1
expr_stmt|;
name|qls_mbx_get_link_status
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s:rxr [0x%08x]\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|.
name|cq_db_offset
operator|)
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s:txr [0x%08x]\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|.
name|wq_db_offset
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|Q81_WR_CQ_CONS_IDX
argument_list|(
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|Q81_WR_LBQ_PROD_IDX
argument_list|(
name|i
argument_list|,
name|ha
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|lbq_in
argument_list|)
expr_stmt|;
name|Q81_WR_SBQ_PROD_IDX
argument_list|(
name|i
argument_list|,
name|ha
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|sbq_in
argument_list|)
expr_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|dev
operator|,
literal|"%s: [wq_idx, cq_idx, lbq_idx, sbq_idx]"
literal|"[0x%08x, 0x%08x, 0x%08x, 0x%08x]\n"
operator|,
name|__func__
operator|,
name|Q81_RD_WQ_IDX
argument_list|(
name|i
argument_list|)
operator|,
name|Q81_RD_CQ_IDX
argument_list|(
name|i
argument_list|)
operator|,
name|Q81_RD_LBQ_IDX
argument_list|(
name|i
argument_list|)
operator|,
name|Q81_RD_SBQ_IDX
argument_list|(
name|i
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|Q81_SET_CQ_VALID
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
name|qls_init_hw_if_exit
label|:
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s:exit\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_wait_for_config_reg_bits
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|bits
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|uint32_t
name|data32
decl_stmt|;
name|uint32_t
name|count
init|=
literal|3
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data32
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data32
operator|&
name|bits
operator|)
operator|==
name|value
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|QLA_USEC_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint8_t
name|q81_hash_key
index|[]
init|=
block|{
literal|0xda
block|,
literal|0x56
block|,
literal|0x5a
block|,
literal|0x6d
block|,
literal|0xc2
block|,
literal|0x0e
block|,
literal|0x5b
block|,
literal|0x25
block|,
literal|0x3d
block|,
literal|0x25
block|,
literal|0x67
block|,
literal|0x41
block|,
literal|0xb0
block|,
literal|0x8f
block|,
literal|0xa3
block|,
literal|0x43
block|,
literal|0xcb
block|,
literal|0x2b
block|,
literal|0xca
block|,
literal|0xd0
block|,
literal|0xb4
block|,
literal|0x30
block|,
literal|0x7b
block|,
literal|0xae
block|,
literal|0xa3
block|,
literal|0x2d
block|,
literal|0xcb
block|,
literal|0x77
block|,
literal|0x0c
block|,
literal|0xf2
block|,
literal|0x30
block|,
literal|0x80
block|,
literal|0x3b
block|,
literal|0xb7
block|,
literal|0x42
block|,
literal|0x6a
block|,
literal|0xfa
block|,
literal|0x01
block|,
literal|0xac
block|,
literal|0xbe
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|qls_init_rss
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|q81_rss_icb_t
modifier|*
name|rss_icb
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|rss_icb
operator|=
name|ha
operator|->
name|rss_dma
operator|.
name|dma_b
expr_stmt|;
name|bzero
argument_list|(
name|rss_icb
argument_list|,
sizeof|sizeof
argument_list|(
name|q81_rss_icb_t
argument_list|)
argument_list|)
expr_stmt|;
name|rss_icb
operator|->
name|flags_base_cq_num
operator|=
name|Q81_RSS_ICB_FLAGS_L4K
operator||
name|Q81_RSS_ICB_FLAGS_L6K
operator||
name|Q81_RSS_ICB_FLAGS_LI
operator||
name|Q81_RSS_ICB_FLAGS_LB
operator||
name|Q81_RSS_ICB_FLAGS_LM
operator||
name|Q81_RSS_ICB_FLAGS_RT4
operator||
name|Q81_RSS_ICB_FLAGS_RT6
expr_stmt|;
name|rss_icb
operator|->
name|mask
operator|=
literal|0x3FF
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Q81_RSS_ICB_NUM_INDTBL_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|rss_icb
operator|->
name|cq_id
index|[
name|i
index|]
operator|=
operator|(
name|i
operator|&
operator|(
name|ha
operator|->
name|num_rx_rings
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|rss_icb
operator|->
name|ipv6_rss_hash_key
argument_list|,
name|q81_hash_key
argument_list|,
literal|40
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rss_icb
operator|->
name|ipv4_rss_hash_key
argument_list|,
name|q81_hash_key
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_config_reg_bits
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG_LR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_rss_exit
goto|;
name|ret
operator|=
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_ICB
argument_list|,
name|Q81_CTL_SEM_SET_ICB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|qls_init_rss_exit
goto|;
block|}
name|value
operator|=
operator|(
name|uint32_t
operator|)
name|ha
operator|->
name|rss_dma
operator|.
name|dma_addr
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ICB_ACCESS_ADDR_LO
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|ha
operator|->
name|rss_dma
operator|.
name|dma_addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ICB_ACCESS_ADDR_HI
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_ICB
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
name|Q81_CTL_CONFIG_LR
operator|<<
name|Q81_CTL_CONFIG_MASK_SHIFT
operator|)
operator||
name|Q81_CTL_CONFIG_LR
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_config_reg_bits
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG_LR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|qls_init_rss_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_init_comp_queue
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|cid
parameter_list|)
block|{
name|q81_cq_icb_t
modifier|*
name|cq_icb
decl_stmt|;
name|qla_rx_ring_t
modifier|*
name|rxr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|rxr
operator|=
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|cid
index|]
expr_stmt|;
name|rxr
operator|->
name|cq_db_offset
operator|=
name|ha
operator|->
name|vm_pgsize
operator|*
operator|(
literal|128
operator|+
name|cid
operator|)
expr_stmt|;
name|cq_icb
operator|=
name|rxr
operator|->
name|cq_icb_vaddr
expr_stmt|;
name|bzero
argument_list|(
name|cq_icb
argument_list|,
sizeof|sizeof
argument_list|(
name|q81_cq_icb_t
argument_list|)
argument_list|)
expr_stmt|;
name|cq_icb
operator|->
name|msix_vector
operator|=
name|cid
expr_stmt|;
name|cq_icb
operator|->
name|flags
operator|=
name|Q81_CQ_ICB_FLAGS_LC
operator||
name|Q81_CQ_ICB_FLAGS_LI
operator||
name|Q81_CQ_ICB_FLAGS_LL
operator||
name|Q81_CQ_ICB_FLAGS_LS
operator||
name|Q81_CQ_ICB_FLAGS_LV
expr_stmt|;
name|cq_icb
operator|->
name|length_v
operator|=
name|NUM_CQ_ENTRIES
expr_stmt|;
name|cq_icb
operator|->
name|cq_baddr_lo
operator|=
operator|(
name|rxr
operator|->
name|cq_base_paddr
operator|&
literal|0xFFFFFFFF
operator|)
expr_stmt|;
name|cq_icb
operator|->
name|cq_baddr_hi
operator|=
operator|(
name|rxr
operator|->
name|cq_base_paddr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|cq_icb
operator|->
name|cqi_addr_lo
operator|=
operator|(
name|rxr
operator|->
name|cqi_paddr
operator|&
literal|0xFFFFFFFF
operator|)
expr_stmt|;
name|cq_icb
operator|->
name|cqi_addr_hi
operator|=
operator|(
name|rxr
operator|->
name|cqi_paddr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|cq_icb
operator|->
name|pkt_idelay
operator|=
literal|10
expr_stmt|;
name|cq_icb
operator|->
name|idelay
operator|=
literal|100
expr_stmt|;
name|cq_icb
operator|->
name|lbq_baddr_lo
operator|=
operator|(
name|rxr
operator|->
name|lbq_addr_tbl_paddr
operator|&
literal|0xFFFFFFFF
operator|)
expr_stmt|;
name|cq_icb
operator|->
name|lbq_baddr_hi
operator|=
operator|(
name|rxr
operator|->
name|lbq_addr_tbl_paddr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|cq_icb
operator|->
name|lbq_bsize
operator|=
name|QLA_LGB_SIZE
expr_stmt|;
name|cq_icb
operator|->
name|lbq_length
operator|=
name|QLA_NUM_LGB_ENTRIES
expr_stmt|;
name|cq_icb
operator|->
name|sbq_baddr_lo
operator|=
operator|(
name|rxr
operator|->
name|sbq_addr_tbl_paddr
operator|&
literal|0xFFFFFFFF
operator|)
expr_stmt|;
name|cq_icb
operator|->
name|sbq_baddr_hi
operator|=
operator|(
name|rxr
operator|->
name|sbq_addr_tbl_paddr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|cq_icb
operator|->
name|sbq_bsize
operator|=
operator|(
name|uint16_t
operator|)
name|ha
operator|->
name|msize
expr_stmt|;
name|cq_icb
operator|->
name|sbq_length
operator|=
name|QLA_NUM_SMB_ENTRIES
expr_stmt|;
name|QL_DUMP_CQ
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_config_reg_bits
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG_LCQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_comp_queue_exit
goto|;
name|ret
operator|=
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_ICB
argument_list|,
name|Q81_CTL_SEM_SET_ICB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|qls_init_comp_queue_exit
goto|;
block|}
name|value
operator|=
operator|(
name|uint32_t
operator|)
name|rxr
operator|->
name|cq_icb_paddr
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ICB_ACCESS_ADDR_LO
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|rxr
operator|->
name|cq_icb_paddr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ICB_ACCESS_ADDR_HI
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_ICB
argument_list|)
expr_stmt|;
name|value
operator|=
name|Q81_CTL_CONFIG_LCQ
operator||
name|Q81_CTL_CONFIG_Q_NUM_MASK
expr_stmt|;
name|value
operator|=
operator|(
name|value
operator|<<
name|Q81_CTL_CONFIG_MASK_SHIFT
operator|)
operator||
name|Q81_CTL_CONFIG_LCQ
expr_stmt|;
name|value
operator||=
operator|(
name|cid
operator|<<
name|Q81_CTL_CONFIG_Q_NUM_SHIFT
operator|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_config_reg_bits
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG_LCQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rxr
operator|->
name|cq_next
operator|=
literal|0
expr_stmt|;
name|rxr
operator|->
name|lbq_next
operator|=
name|rxr
operator|->
name|lbq_free
operator|=
literal|0
expr_stmt|;
name|rxr
operator|->
name|sbq_next
operator|=
name|rxr
operator|->
name|sbq_free
operator|=
literal|0
expr_stmt|;
name|rxr
operator|->
name|rx_free
operator|=
name|rxr
operator|->
name|rx_next
operator|=
literal|0
expr_stmt|;
name|rxr
operator|->
name|lbq_in
operator|=
operator|(
name|QLA_NUM_LGB_ENTRIES
operator|-
literal|1
operator|)
operator|&
operator|~
literal|0xF
expr_stmt|;
name|rxr
operator|->
name|sbq_in
operator|=
operator|(
name|QLA_NUM_SMB_ENTRIES
operator|-
literal|1
operator|)
operator|&
operator|~
literal|0xF
expr_stmt|;
name|qls_init_comp_queue_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_init_work_queue
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|wid
parameter_list|)
block|{
name|q81_wq_icb_t
modifier|*
name|wq_icb
decl_stmt|;
name|qla_tx_ring_t
modifier|*
name|txr
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|txr
operator|=
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|wid
index|]
expr_stmt|;
name|txr
operator|->
name|wq_db_addr
operator|=
operator|(
expr|struct
name|resource
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|ha
operator|->
name|pci_reg1
operator|+
operator|(
name|ha
operator|->
name|vm_pgsize
operator|*
name|wid
operator|)
operator|)
expr_stmt|;
name|txr
operator|->
name|wq_db_offset
operator|=
operator|(
name|ha
operator|->
name|vm_pgsize
operator|*
name|wid
operator|)
expr_stmt|;
name|wq_icb
operator|=
name|txr
operator|->
name|wq_icb_vaddr
expr_stmt|;
name|bzero
argument_list|(
name|wq_icb
argument_list|,
sizeof|sizeof
argument_list|(
name|q81_wq_icb_t
argument_list|)
argument_list|)
expr_stmt|;
name|wq_icb
operator|->
name|length_v
operator|=
name|NUM_TX_DESCRIPTORS
operator||
name|Q81_WQ_ICB_VALID
expr_stmt|;
name|wq_icb
operator|->
name|flags
operator|=
name|Q81_WQ_ICB_FLAGS_LO
operator||
name|Q81_WQ_ICB_FLAGS_LI
operator||
name|Q81_WQ_ICB_FLAGS_LB
operator||
name|Q81_WQ_ICB_FLAGS_LC
expr_stmt|;
name|wq_icb
operator|->
name|wqcqid_rss
operator|=
name|wid
expr_stmt|;
name|wq_icb
operator|->
name|baddr_lo
operator|=
name|txr
operator|->
name|wq_paddr
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|wq_icb
operator|->
name|baddr_hi
operator|=
operator|(
name|txr
operator|->
name|wq_paddr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|wq_icb
operator|->
name|ci_addr_lo
operator|=
name|txr
operator|->
name|txr_cons_paddr
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|wq_icb
operator|->
name|ci_addr_hi
operator|=
operator|(
name|txr
operator|->
name|txr_cons_paddr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_config_reg_bits
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG_LRQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_init_wq_exit
goto|;
name|ret
operator|=
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_ICB
argument_list|,
name|Q81_CTL_SEM_SET_ICB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|qls_init_wq_exit
goto|;
block|}
name|value
operator|=
operator|(
name|uint32_t
operator|)
name|txr
operator|->
name|wq_icb_paddr
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ICB_ACCESS_ADDR_LO
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|txr
operator|->
name|wq_icb_paddr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_ICB_ACCESS_ADDR_HI
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_ICB
argument_list|)
expr_stmt|;
name|value
operator|=
name|Q81_CTL_CONFIG_LRQ
operator||
name|Q81_CTL_CONFIG_Q_NUM_MASK
expr_stmt|;
name|value
operator|=
operator|(
name|value
operator|<<
name|Q81_CTL_CONFIG_MASK_SHIFT
operator|)
operator||
name|Q81_CTL_CONFIG_LRQ
expr_stmt|;
name|value
operator||=
operator|(
name|wid
operator|<<
name|Q81_CTL_CONFIG_Q_NUM_SHIFT
operator|)
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_config_reg_bits
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_CONFIG_LRQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|txr
operator|->
name|txr_free
operator|=
name|NUM_TX_DESCRIPTORS
expr_stmt|;
name|txr
operator|->
name|txr_next
operator|=
literal|0
expr_stmt|;
name|txr
operator|->
name|txr_done
operator|=
literal|0
expr_stmt|;
name|qls_init_wq_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_hw_add_all_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|nmcast
decl_stmt|;
name|nmcast
operator|=
name|ha
operator|->
name|nmcast
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
operator|)
operator|&&
name|nmcast
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|!=
literal|0
operator|)
operator|||
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|qls_config_mcast_mac_addr
argument_list|(
name|ha
argument_list|,
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
literal|1
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|nmcast
operator|--
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_hw_add_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|QL_MAC_CMP
argument_list|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|mta
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* its been already added */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|==
literal|0
operator|)
operator|&&
operator|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|qls_config_mcast_mac_addr
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
literal|1
argument_list|,
name|i
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|bcopy
argument_list|(
name|mta
argument_list|,
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|Q8_MAC_ADDR_LEN
argument_list|)
expr_stmt|;
name|ha
operator|->
name|nmcast
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_hw_del_mcast
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Q8_MAX_NUM_MULTICAST_ADDRS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|QL_MAC_CMP
argument_list|(
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|mta
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|qls_config_mcast_mac_addr
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|,
literal|0
argument_list|,
name|i
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|mcast
index|[
name|i
index|]
operator|.
name|addr
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|ha
operator|->
name|nmcast
operator|--
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_hw_set_multi  * Function: Sets the Multicast Addresses provided the host O.S into the  *	hardware (for the given interface)  */
end_comment

begin_function
name|void
name|qls_hw_set_multi
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint8_t
modifier|*
name|mta
parameter_list|,
name|uint32_t
name|mcnt
parameter_list|,
name|uint32_t
name|add_mac
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mcnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|add_mac
condition|)
block|{
if|if
condition|(
name|qls_hw_add_mcast
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|)
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
name|qls_hw_del_mcast
argument_list|(
name|ha
argument_list|,
name|mta
argument_list|)
condition|)
break|break;
block|}
name|mta
operator|+=
name|Q8_MAC_ADDR_LEN
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|qls_update_link_state
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|link_state
decl_stmt|;
name|uint32_t
name|prev_link_state
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ha
operator|->
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|ha
operator|->
name|link_up
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|link_state
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_STATUS
argument_list|)
expr_stmt|;
name|prev_link_state
operator|=
name|ha
operator|->
name|link_up
expr_stmt|;
if|if
condition|(
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
operator|==
literal|0
condition|)
name|ha
operator|->
name|link_up
operator|=
operator|(
operator|(
name|link_state
operator|&
name|Q81_CTL_STATUS_PL0
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
else|else
name|ha
operator|->
name|link_up
operator|=
operator|(
operator|(
name|link_state
operator|&
name|Q81_CTL_STATUS_PL1
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|prev_link_state
operator|!=
name|ha
operator|->
name|link_up
condition|)
block|{
if|if
condition|(
name|ha
operator|->
name|link_up
condition|)
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|if_link_state_change
argument_list|(
name|ha
operator|->
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_free_tx_ring_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|r_idx
parameter_list|)
block|{
if|if
condition|(
name|ha
operator|->
name|tx_ring
index|[
name|r_idx
index|]
operator|.
name|flags
operator|.
name|wq_dma
condition|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|r_idx
index|]
operator|.
name|wq_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|r_idx
index|]
operator|.
name|flags
operator|.
name|wq_dma
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|tx_ring
index|[
name|r_idx
index|]
operator|.
name|flags
operator|.
name|privb_dma
condition|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|r_idx
index|]
operator|.
name|privb_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|r_idx
index|]
operator|.
name|flags
operator|.
name|privb_dma
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_free_tx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|qla_tx_buf_t
modifier|*
name|txb
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
name|qls_free_tx_ring_dma
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_TX_DESCRIPTORS
condition|;
name|j
operator|++
control|)
block|{
name|txb
operator|=
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|tx_buf
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|txb
operator|->
name|map
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|txb
operator|->
name|map
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ha
operator|->
name|tx_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|tx_tag
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_alloc_tx_ring_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|ridx
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|uint8_t
modifier|*
name|v_addr
decl_stmt|;
name|bus_addr_t
name|p_addr
decl_stmt|;
name|qla_tx_buf_t
modifier|*
name|txb
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_dma
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_dma
operator|.
name|size
operator|=
name|NUM_TX_DESCRIPTORS
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|q81_tx_cmd_t
argument_list|)
operator|)
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: [%d] txr failed\n"
argument_list|,
name|__func__
argument_list|,
name|ridx
argument_list|)
expr_stmt|;
goto|goto
name|qls_alloc_tx_ring_dma_exit
goto|;
block|}
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|wq_dma
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|privb_dma
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|privb_dma
operator|.
name|size
operator|=
name|QLA_TX_PRIVATE_BSIZE
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|privb_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: [%d] oalb failed\n"
argument_list|,
name|__func__
argument_list|,
name|ridx
argument_list|)
expr_stmt|;
goto|goto
name|qls_alloc_tx_ring_dma_exit
goto|;
block|}
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|privb_dma
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_vaddr
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_dma
operator|.
name|dma_b
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_paddr
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_dma
operator|.
name|dma_addr
expr_stmt|;
name|v_addr
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|privb_dma
operator|.
name|dma_b
expr_stmt|;
name|p_addr
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|privb_dma
operator|.
name|dma_addr
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_icb_vaddr
operator|=
name|v_addr
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|wq_icb_paddr
operator|=
name|p_addr
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|txr_cons_vaddr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|v_addr
operator|+
operator|(
name|PAGE_SIZE
operator|>>
literal|1
operator|)
operator|)
expr_stmt|;
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|txr_cons_paddr
operator|=
name|p_addr
operator|+
operator|(
name|PAGE_SIZE
operator|>>
literal|1
operator|)
expr_stmt|;
name|v_addr
operator|=
name|v_addr
operator|+
operator|(
name|PAGE_SIZE
operator|>>
literal|1
operator|)
expr_stmt|;
name|p_addr
operator|=
name|p_addr
operator|+
operator|(
name|PAGE_SIZE
operator|>>
literal|1
operator|)
expr_stmt|;
name|txb
operator|=
name|ha
operator|->
name|tx_ring
index|[
name|ridx
index|]
operator|.
name|tx_buf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_TX_DESCRIPTORS
condition|;
name|i
operator|++
control|)
block|{
name|txb
index|[
name|i
index|]
operator|.
name|oal_vaddr
operator|=
name|v_addr
expr_stmt|;
name|txb
index|[
name|i
index|]
operator|.
name|oal_paddr
operator|=
name|p_addr
expr_stmt|;
name|v_addr
operator|=
name|v_addr
operator|+
name|QLA_OAL_BLK_SIZE
expr_stmt|;
name|p_addr
operator|=
name|p_addr
operator|+
name|QLA_OAL_BLK_SIZE
expr_stmt|;
block|}
name|qls_alloc_tx_ring_dma_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_alloc_tx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|qla_tx_buf_t
modifier|*
name|txb
decl_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|QLA_MAX_TSO_FRAME_SIZE
argument_list|,
comment|/* maxsize */
name|QLA_MAX_SEGMENTS
argument_list|,
comment|/* nsegments */
name|PAGE_SIZE
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|ha
operator|->
name|tx_tag
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: tx_tag alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_tx_rings
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_alloc_tx_ring_dma
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|qls_free_tx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NUM_TX_DESCRIPTORS
condition|;
name|j
operator|++
control|)
block|{
name|txb
operator|=
operator|&
name|ha
operator|->
name|tx_ring
index|[
name|i
index|]
operator|.
name|tx_buf
index|[
name|j
index|]
expr_stmt|;
name|ret
operator|=
name|bus_dmamap_create
argument_list|(
name|ha
operator|->
name|tx_tag
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|txb
operator|->
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ha
operator|->
name|err_tx_dmamap_create
operator|++
expr_stmt|;
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: bus_dmamap_create failed[%d, %d, %d]\n"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|,
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|qls_free_tx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_free_rss_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rss_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|rss_dma
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_alloc_rss_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ha
operator|->
name|rss_dma
operator|.
name|alignment
operator|=
literal|4
expr_stmt|;
name|ha
operator|->
name|rss_dma
operator|.
name|size
operator|=
name|PAGE_SIZE
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rss_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
else|else
name|ha
operator|->
name|flags
operator|.
name|rss_dma
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_free_mpi_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|mpi_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|flags
operator|.
name|mpi_dma
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_alloc_mpi_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ha
operator|->
name|mpi_dma
operator|.
name|alignment
operator|=
literal|4
expr_stmt|;
name|ha
operator|->
name|mpi_dma
operator|.
name|size
operator|=
operator|(
literal|0x4000
operator|*
literal|4
operator|)
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|mpi_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
else|else
name|ha
operator|->
name|flags
operator|.
name|mpi_dma
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_free_rx_ring_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|ridx
parameter_list|)
block|{
if|if
condition|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|cq_dma
condition|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|cq_dma
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|lbq_dma
condition|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|lbq_dma
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|sbq_dma
condition|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|sbq_dma
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|lb_dma
condition|)
block|{
name|qls_free_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|lb_dma
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_free_rx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|qls_free_rx_ring_dma
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ha
operator|->
name|rx_tag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ha
operator|->
name|rx_tag
argument_list|)
expr_stmt|;
name|ha
operator|->
name|rx_tag
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_alloc_rx_ring_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|int
name|ridx
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|v_addr
decl_stmt|;
name|bus_addr_t
name|p_addr
decl_stmt|;
specifier|volatile
name|q81_bq_addr_e_t
modifier|*
name|bq_e
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|alignment
operator|=
literal|128
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|size
operator|=
operator|(
name|NUM_CQ_ENTRIES
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|q81_cq_e_t
argument_list|)
operator|)
operator|)
operator|+
name|PAGE_SIZE
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: [%d] cq failed\n"
argument_list|,
name|__func__
argument_list|,
name|ridx
argument_list|)
expr_stmt|;
goto|goto
name|qls_alloc_rx_ring_dma_exit
goto|;
block|}
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|cq_dma
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
operator|.
name|size
operator|=
name|QLA_LGBQ_AND_TABLE_SIZE
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: [%d] lbq failed\n"
argument_list|,
name|__func__
argument_list|,
name|ridx
argument_list|)
expr_stmt|;
goto|goto
name|qls_alloc_rx_ring_dma_exit
goto|;
block|}
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|lbq_dma
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
operator|.
name|size
operator|=
name|QLA_SMBQ_AND_TABLE_SIZE
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: [%d] sbq failed\n"
argument_list|,
name|__func__
argument_list|,
name|ridx
argument_list|)
expr_stmt|;
goto|goto
name|qls_alloc_rx_ring_dma_exit
goto|;
block|}
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|sbq_dma
operator|=
literal|1
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
operator|.
name|alignment
operator|=
literal|8
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
operator|.
name|size
operator|=
operator|(
name|QLA_LGB_SIZE
operator|*
name|QLA_NUM_LGB_ENTRIES
operator|)
expr_stmt|;
name|ret
operator|=
name|qls_alloc_dmabuf
argument_list|(
name|ha
argument_list|,
operator|&
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: [%d] lb failed\n"
argument_list|,
name|__func__
argument_list|,
name|ridx
argument_list|)
expr_stmt|;
goto|goto
name|qls_alloc_rx_ring_dma_exit
goto|;
block|}
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|flags
operator|.
name|lb_dma
operator|=
literal|1
expr_stmt|;
name|bzero
argument_list|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|dma_b
argument_list|,
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|size
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
operator|.
name|dma_b
argument_list|,
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
operator|.
name|size
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
operator|.
name|dma_b
argument_list|,
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
operator|.
name|size
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
operator|.
name|dma_b
argument_list|,
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
operator|.
name|size
argument_list|)
expr_stmt|;
comment|/* completion queue */
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_base_vaddr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|dma_b
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_base_paddr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|dma_addr
expr_stmt|;
name|v_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|dma_b
expr_stmt|;
name|p_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_dma
operator|.
name|dma_addr
expr_stmt|;
name|v_addr
operator|=
name|v_addr
operator|+
operator|(
name|NUM_CQ_ENTRIES
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|q81_cq_e_t
argument_list|)
operator|)
operator|)
expr_stmt|;
name|p_addr
operator|=
name|p_addr
operator|+
operator|(
name|NUM_CQ_ENTRIES
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|q81_cq_e_t
argument_list|)
operator|)
operator|)
expr_stmt|;
comment|/* completion queue icb */
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_icb_vaddr
operator|=
name|v_addr
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cq_icb_paddr
operator|=
name|p_addr
expr_stmt|;
name|v_addr
operator|=
name|v_addr
operator|+
operator|(
name|PAGE_SIZE
operator|>>
literal|2
operator|)
expr_stmt|;
name|p_addr
operator|=
name|p_addr
operator|+
operator|(
name|PAGE_SIZE
operator|>>
literal|2
operator|)
expr_stmt|;
comment|/* completion queue index register */
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cqi_vaddr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|v_addr
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|cqi_paddr
operator|=
name|p_addr
expr_stmt|;
name|v_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
operator|.
name|dma_b
expr_stmt|;
name|p_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_dma
operator|.
name|dma_addr
expr_stmt|;
comment|/* large buffer queue address table */
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_addr_tbl_vaddr
operator|=
name|v_addr
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_addr_tbl_paddr
operator|=
name|p_addr
expr_stmt|;
comment|/* large buffer queue */
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_vaddr
operator|=
name|v_addr
operator|+
name|PAGE_SIZE
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_paddr
operator|=
name|p_addr
operator|+
name|PAGE_SIZE
expr_stmt|;
name|v_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
operator|.
name|dma_b
expr_stmt|;
name|p_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_dma
operator|.
name|dma_addr
expr_stmt|;
comment|/* small buffer queue address table */
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_addr_tbl_vaddr
operator|=
name|v_addr
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_addr_tbl_paddr
operator|=
name|p_addr
expr_stmt|;
comment|/* small buffer queue */
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_vaddr
operator|=
name|v_addr
operator|+
name|PAGE_SIZE
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_paddr
operator|=
name|p_addr
operator|+
name|PAGE_SIZE
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_vaddr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
operator|.
name|dma_b
expr_stmt|;
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_paddr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_dma
operator|.
name|dma_addr
expr_stmt|;
comment|/* Initialize Large Buffer Queue Table */
name|p_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_paddr
expr_stmt|;
name|bq_e
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_addr_tbl_vaddr
expr_stmt|;
name|bq_e
operator|->
name|addr_lo
operator|=
name|p_addr
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|bq_e
operator|->
name|addr_hi
operator|=
operator|(
name|p_addr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|p_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lb_paddr
expr_stmt|;
name|bq_e
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|lbq_vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QLA_NUM_LGB_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|bq_e
operator|->
name|addr_lo
operator|=
name|p_addr
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|bq_e
operator|->
name|addr_hi
operator|=
operator|(
name|p_addr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|p_addr
operator|=
name|p_addr
operator|+
name|QLA_LGB_SIZE
expr_stmt|;
name|bq_e
operator|++
expr_stmt|;
block|}
comment|/* Initialize Small Buffer Queue Table */
name|p_addr
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_paddr
expr_stmt|;
name|bq_e
operator|=
name|ha
operator|->
name|rx_ring
index|[
name|ridx
index|]
operator|.
name|sbq_addr_tbl_vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|QLA_SBQ_SIZE
operator|/
name|QLA_PAGE_SIZE
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|bq_e
operator|->
name|addr_lo
operator|=
name|p_addr
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|bq_e
operator|->
name|addr_hi
operator|=
operator|(
name|p_addr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|p_addr
operator|=
name|p_addr
operator|+
name|QLA_PAGE_SIZE
expr_stmt|;
name|bq_e
operator|++
expr_stmt|;
block|}
name|qls_alloc_rx_ring_dma_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_alloc_rx_dma
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MJUM9BYTES
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|MJUM9BYTES
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|ha
operator|->
name|rx_tag
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: rx_tag alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ha
operator|->
name|num_rx_rings
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_alloc_rx_ring_dma
argument_list|(
name|ha
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|qls_free_rx_dma
argument_list|(
name|ha
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_wait_for_flash_ready
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|data32
decl_stmt|;
name|uint32_t
name|count
init|=
literal|3
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data32
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_FLASH_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|data32
operator|&
name|Q81_CTL_FLASH_ADDR_ERR
condition|)
goto|goto
name|qls_wait_for_flash_ready_exit
goto|;
if|if
condition|(
name|data32
operator|&
name|Q81_CTL_FLASH_ADDR_RDY
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|QLA_USEC_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|qls_wait_for_flash_ready_exit
label|:
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Name: qls_rd_flash32  * Function: Read Flash Memory  */
end_comment

begin_function
name|int
name|qls_rd_flash32
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|qls_wait_for_flash_ready
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|(
name|ret
operator|)
return|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_FLASH_ADDR
argument_list|,
operator|(
name|addr
operator||
name|Q81_CTL_FLASH_ADDR_R
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_flash_ready
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|(
name|ret
operator|)
return|;
operator|*
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_FLASH_DATA
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_flash_validate
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
specifier|const
name|char
modifier|*
name|signature
parameter_list|)
block|{
name|uint16_t
name|csum16
init|=
literal|0
decl_stmt|;
name|uint16_t
modifier|*
name|data16
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
name|ha
operator|->
name|flash
operator|.
name|id
argument_list|,
name|signature
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: invalid signature "
literal|"%x:%x:%x:%x %s\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|flash
operator|.
name|id
index|[
literal|0
index|]
operator|,
name|ha
operator|->
name|flash
operator|.
name|id
index|[
literal|1
index|]
operator|,
name|ha
operator|->
name|flash
operator|.
name|id
index|[
literal|2
index|]
operator|,
name|ha
operator|->
name|flash
operator|.
name|id
index|[
literal|3
index|]
operator|,
name|signature
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|data16
operator|=
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|ha
operator|->
name|flash
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|q81_flash_t
argument_list|)
operator|>>
literal|1
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|csum16
operator|+=
operator|*
name|data16
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|csum16
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: invalid checksum\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|qls_rd_nic_params
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|faddr
decl_stmt|;
name|uint32_t
modifier|*
name|qflash
decl_stmt|;
if|if
condition|(
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_FLASH
argument_list|,
name|Q81_CTL_SEM_SET_FLASH
argument_list|)
condition|)
block|{
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: semlock failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
operator|==
literal|0
condition|)
name|faddr
operator|=
name|Q81_F0_FLASH_OFFSET
operator|>>
literal|2
expr_stmt|;
else|else
name|faddr
operator|=
name|Q81_F1_FLASH_OFFSET
operator|>>
literal|2
expr_stmt|;
name|qflash
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|ha
operator|->
name|flash
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|q81_flash_t
argument_list|)
operator|>>
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_rd_flash32
argument_list|(
name|ha
argument_list|,
name|faddr
argument_list|,
name|qflash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_rd_flash_data_exit
goto|;
name|faddr
operator|++
expr_stmt|;
name|qflash
operator|++
expr_stmt|;
block|}
name|QL_DUMP_BUFFER8
argument_list|(
name|ha
argument_list|,
name|__func__
argument_list|,
operator|(
operator|&
name|ha
operator|->
name|flash
operator|)
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|q81_flash_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_flash_validate
argument_list|(
name|ha
argument_list|,
name|Q81_FLASH_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_rd_flash_data_exit
goto|;
name|bcopy
argument_list|(
name|ha
operator|->
name|flash
operator|.
name|mac_addr0
argument_list|,
name|ha
operator|->
name|mac_addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: mac %02x:%02x:%02x:%02x:%02x:%02x\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|mac_addr
index|[
literal|0
index|]
operator|,
name|ha
operator|->
name|mac_addr
index|[
literal|1
index|]
operator|,
name|ha
operator|->
name|mac_addr
index|[
literal|2
index|]
operator|,
name|ha
operator|->
name|mac_addr
index|[
literal|3
index|]
operator|,
name|ha
operator|->
name|mac_addr
index|[
literal|4
index|]
operator|,
name|ha
operator|->
name|mac_addr
index|[
literal|5
index|]
operator|)
argument_list|)
expr_stmt|;
name|qls_rd_flash_data_exit
label|:
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_FLASH
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_sem_lock
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mask
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|uint32_t
name|count
init|=
literal|30
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEMAPHORE
argument_list|,
operator|(
name|mask
operator||
name|value
operator|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEMAPHORE
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|value
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
name|QLA_USEC_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
block|}
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_sem_unlock
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEMAPHORE
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_wait_for_proc_addr_ready
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
name|data32
decl_stmt|;
name|uint32_t
name|count
init|=
literal|3
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data32
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_PROC_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|data32
operator|&
name|Q81_CTL_PROC_ADDR_ERR
condition|)
goto|goto
name|qls_wait_for_proc_addr_ready_exit
goto|;
if|if
condition|(
name|data32
operator|&
name|Q81_CTL_PROC_ADDR_RDY
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|QLA_USEC_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|qls_wait_for_proc_addr_ready_exit
label|:
name|QL_DPRINT1
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: failed\n"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_proc_addr_rd_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|addr_module
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|ret
operator|=
name|qls_wait_for_proc_addr_ready
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_proc_addr_rd_reg_exit
goto|;
name|value
operator|=
name|addr_module
operator||
name|reg
operator||
name|Q81_CTL_PROC_ADDR_READ
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_PROC_ADDR
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_proc_addr_ready
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_proc_addr_rd_reg_exit
goto|;
operator|*
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_PROC_DATA
argument_list|)
expr_stmt|;
name|qls_proc_addr_rd_reg_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_proc_addr_wr_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|addr_module
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|ret
operator|=
name|qls_wait_for_proc_addr_ready
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_proc_addr_wr_reg_exit
goto|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_PROC_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|value
operator|=
name|addr_module
operator||
name|reg
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_PROC_ADDR
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qls_wait_for_proc_addr_ready
argument_list|(
name|ha
argument_list|)
expr_stmt|;
name|qls_proc_addr_wr_reg_exit
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_hw_nic_reset
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|ha
operator|->
name|hw_init
operator|=
literal|0
expr_stmt|;
name|data
operator|=
operator|(
name|Q81_CTL_RESET_FUNC
operator|<<
name|Q81_CTL_RESET_MASK_SHIFT
operator|)
operator||
name|Q81_CTL_RESET_FUNC
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_RESET
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|count
operator|=
literal|10
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_RESET
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
name|Q81_CTL_RESET_FUNC
operator|)
operator|==
literal|0
condition|)
break|break;
name|QLA_USEC_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: Bit 15 not cleared after Reset\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_hw_reset
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|count
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s:enter[%d]\n"
operator|,
name|__func__
operator|,
name|ha
operator|->
name|hw_init
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ha
operator|->
name|hw_init
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|qls_hw_nic_reset
argument_list|(
name|ha
argument_list|)
expr_stmt|;
goto|goto
name|qls_hw_reset_exit
goto|;
block|}
name|ret
operator|=
name|qls_clear_routing_table
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_hw_reset_exit
goto|;
name|ret
operator|=
name|qls_mbx_set_mgmt_ctrl
argument_list|(
name|ha
argument_list|,
name|Q81_MBX_SET_MGMT_CTL_STOP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_hw_reset_exit
goto|;
comment|/* 	 * Wait for FIFO to empty 	 */
name|count
operator|=
literal|5
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|Q81_CTL_STATUS_NFE
condition|)
break|break;
name|qls_mdelay
argument_list|(
name|__func__
argument_list|,
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: NFE bit not set\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qls_hw_reset_exit
goto|;
block|}
name|count
operator|=
literal|5
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
operator|(
name|void
operator|)
name|qls_mbx_get_mgmt_ctrl
argument_list|(
name|ha
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
name|Q81_MBX_GET_MGMT_CTL_FIFO_EMPTY
operator|)
operator|&&
operator|(
name|data
operator|&
name|Q81_MBX_GET_MGMT_CTL_SET_MGMT
operator|)
condition|)
break|break;
name|qls_mdelay
argument_list|(
name|__func__
argument_list|,
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
goto|goto
name|qls_hw_reset_exit
goto|;
comment|/* 	 * Reset the NIC function 	 */
name|ret
operator|=
name|qls_hw_nic_reset
argument_list|(
name|ha
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|qls_hw_reset_exit
goto|;
name|ret
operator|=
name|qls_mbx_set_mgmt_ctrl
argument_list|(
name|ha
argument_list|,
name|Q81_MBX_SET_MGMT_CTL_RESUME
argument_list|)
expr_stmt|;
name|qls_hw_reset_exit
label|:
if|if
condition|(
name|ret
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * MPI Related Functions  */
end_comment

begin_function
name|int
name|qls_mpi_risc_rd_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|qls_proc_addr_rd_reg
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_PROC_ADDR_MPI_RISC
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|qls_mpi_risc_wr_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|qls_proc_addr_wr_reg
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_PROC_ADDR_MPI_RISC
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|qls_mbx_rd_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
operator|==
literal|0
condition|)
name|reg
operator|+=
name|Q81_FUNC0_MBX_OUT_REG0
expr_stmt|;
else|else
name|reg
operator|+=
name|Q81_FUNC1_MBX_OUT_REG0
expr_stmt|;
name|ret
operator|=
name|qls_mpi_risc_rd_reg
argument_list|(
name|ha
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|qls_mbx_wr_reg
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|ha
operator|->
name|pci_func
operator|&
literal|0x1
operator|)
operator|==
literal|0
condition|)
name|reg
operator|+=
name|Q81_FUNC0_MBX_IN_REG0
expr_stmt|;
else|else
name|reg
operator|+=
name|Q81_FUNC1_MBX_IN_REG0
expr_stmt|;
name|ret
operator|=
name|qls_mpi_risc_wr_reg
argument_list|(
name|ha
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_mbx_cmd
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|in_mbx
parameter_list|,
name|uint32_t
name|i_count
parameter_list|,
name|uint32_t
modifier|*
name|out_mbx
parameter_list|,
name|uint32_t
name|o_count
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|uint32_t
name|data32
decl_stmt|,
name|mbx_cmd
init|=
literal|0
decl_stmt|;
name|uint32_t
name|count
init|=
literal|50
decl_stmt|;
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: enter[0x%08x 0x%08x 0x%08x]\n"
operator|,
name|__func__
operator|,
operator|*
name|in_mbx
operator|,
operator|*
operator|(
name|in_mbx
operator|+
literal|1
operator|)
operator|,
operator|*
operator|(
name|in_mbx
operator|+
literal|2
operator|)
operator|)
argument_list|)
expr_stmt|;
name|data32
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_HOST_CMD_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|data32
operator|&
name|Q81_CTL_HCS_HTR_INTR
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: cmd_status[0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|data32
argument_list|)
expr_stmt|;
goto|goto
name|qls_mbx_cmd_exit
goto|;
block|}
if|if
condition|(
name|qls_sem_lock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_PROC_ADDR_NIC_RCV
argument_list|,
name|Q81_CTL_SEM_SET_PROC_ADDR_NIC_RCV
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: semlock failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|qls_mbx_cmd_exit
goto|;
block|}
name|ha
operator|->
name|mbx_done
operator|=
literal|0
expr_stmt|;
name|mbx_cmd
operator|=
operator|*
name|in_mbx
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|i_count
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_mbx_wr_reg
argument_list|(
name|ha
argument_list|,
name|i
argument_list|,
operator|*
name|in_mbx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: mbx_wr[%d, 0x%08x] failed\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|,
operator|*
name|in_mbx
argument_list|)
expr_stmt|;
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_PROC_ADDR_NIC_RCV
argument_list|)
expr_stmt|;
goto|goto
name|qls_mbx_cmd_exit
goto|;
block|}
name|in_mbx
operator|++
expr_stmt|;
block|}
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_HOST_CMD_STATUS
argument_list|,
name|Q81_CTL_HCS_CMD_SET_HTR_INTR
argument_list|)
expr_stmt|;
name|qls_sem_unlock
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_SEM_MASK_PROC_ADDR_NIC_RCV
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|ha
operator|->
name|mbx_done
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|intr_enable
operator|==
literal|0
condition|)
block|{
name|data32
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|data32
operator|&
name|Q81_CTL_STATUS_PI
operator|)
condition|)
block|{
name|qls_mdelay
argument_list|(
name|__func__
argument_list|,
literal|100
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|qls_mbx_rd_reg
argument_list|(
name|ha
argument_list|,
literal|0
argument_list|,
operator|&
name|data32
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|data32
operator|&
literal|0xF000
operator|)
operator|==
literal|0x4000
condition|)
block|{
name|out_mbx
index|[
literal|0
index|]
operator|=
name|data32
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|o_count
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|qls_mbx_rd_reg
argument_list|(
name|ha
argument_list|,
name|i
argument_list|,
operator|&
name|data32
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: mbx_rd[%d]"
literal|" failed\n"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
name|out_mbx
index|[
name|i
index|]
operator|=
name|data32
expr_stmt|;
block|}
break|break;
block|}
elseif|else
if|if
condition|(
operator|(
name|data32
operator|&
literal|0xF000
operator|)
operator|==
literal|0x8000
condition|)
block|{
name|count
operator|=
literal|50
expr_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,\
name|Q81_CTL_HOST_CMD_STATUS
argument_list|,\
name|Q81_CTL_HCS_CMD_CLR_RTH_INTR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|ha
operator|->
name|mbx_done
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|o_count
condition|;
name|i
operator|++
control|)
block|{
name|out_mbx
index|[
name|i
index|]
operator|=
name|ha
operator|->
name|mbox
index|[
name|i
index|]
expr_stmt|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|qls_mdelay
argument_list|(
name|__func__
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
block|}
name|qls_mbx_cmd_exit
label|:
if|if
condition|(
name|ha
operator|->
name|flags
operator|.
name|intr_enable
operator|==
literal|0
condition|)
block|{
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_HOST_CMD_STATUS
argument_list|,\
name|Q81_CTL_HCS_CMD_CLR_RTH_INTR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|ha
operator|->
name|qla_initiate_recovery
operator|=
literal|1
expr_stmt|;
block|}
name|QL_DPRINT2
argument_list|(
operator|(
name|ha
operator|->
name|pci_dev
operator|,
literal|"%s: exit[%d]\n"
operator|,
name|__func__
operator|,
name|ret
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_mbx_set_mgmt_ctrl
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
name|t_ctrl
parameter_list|)
block|{
name|uint32_t
modifier|*
name|mbox
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|mbox
operator|=
name|ha
operator|->
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
name|Q81_NUM_MBX_REGISTERS
operator|)
argument_list|)
expr_stmt|;
name|mbox
index|[
literal|0
index|]
operator|=
name|Q81_MBX_SET_MGMT_CTL
expr_stmt|;
name|mbox
index|[
literal|1
index|]
operator|=
name|t_ctrl
expr_stmt|;
if|if
condition|(
name|qls_mbx_cmd
argument_list|(
name|ha
argument_list|,
name|mbox
argument_list|,
literal|2
argument_list|,
name|mbox
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|mbox
index|[
literal|0
index|]
operator|==
name|Q81_MBX_CMD_COMPLETE
operator|)
operator|||
operator|(
operator|(
name|t_ctrl
operator|==
name|Q81_MBX_SET_MGMT_CTL_STOP
operator|)
operator|&&
operator|(
name|mbox
index|[
literal|0
index|]
operator|==
name|Q81_MBX_CMD_ERROR
operator|)
operator|)
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed [0x%08x]\n"
argument_list|,
name|__func__
argument_list|,
name|mbox
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qls_mbx_get_mgmt_ctrl
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|uint32_t
modifier|*
name|t_status
parameter_list|)
block|{
name|uint32_t
modifier|*
name|mbox
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
operator|*
name|t_status
operator|=
literal|0
expr_stmt|;
name|mbox
operator|=
name|ha
operator|->
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
name|Q81_NUM_MBX_REGISTERS
operator|)
argument_list|)
expr_stmt|;
name|mbox
index|[
literal|0
index|]
operator|=
name|Q81_MBX_GET_MGMT_CTL
expr_stmt|;
if|if
condition|(
name|qls_mbx_cmd
argument_list|(
name|ha
argument_list|,
name|mbox
argument_list|,
literal|1
argument_list|,
name|mbox
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|*
name|t_status
operator|=
name|mbox
index|[
literal|1
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_mbx_get_link_status
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
modifier|*
name|mbox
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|mbox
operator|=
name|ha
operator|->
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
name|Q81_NUM_MBX_REGISTERS
operator|)
argument_list|)
expr_stmt|;
name|mbox
index|[
literal|0
index|]
operator|=
name|Q81_MBX_GET_LNK_STATUS
expr_stmt|;
if|if
condition|(
name|qls_mbx_cmd
argument_list|(
name|ha
argument_list|,
name|mbox
argument_list|,
literal|1
argument_list|,
name|mbox
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|ha
operator|->
name|link_status
operator|=
name|mbox
index|[
literal|1
index|]
expr_stmt|;
name|ha
operator|->
name|link_down_info
operator|=
name|mbox
index|[
literal|2
index|]
expr_stmt|;
name|ha
operator|->
name|link_hw_info
operator|=
name|mbox
index|[
literal|3
index|]
expr_stmt|;
name|ha
operator|->
name|link_dcbx_counters
operator|=
name|mbox
index|[
literal|4
index|]
expr_stmt|;
name|ha
operator|->
name|link_change_counters
operator|=
name|mbox
index|[
literal|5
index|]
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|mbox
index|[
literal|0
index|]
argument_list|,
name|mbox
index|[
literal|1
index|]
argument_list|,
name|mbox
index|[
literal|2
index|]
argument_list|,
name|mbox
index|[
literal|3
index|]
argument_list|,
name|mbox
index|[
literal|4
index|]
argument_list|,
name|mbox
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|qls_mbx_about_fw
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|uint32_t
modifier|*
name|mbox
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|mbox
operator|=
name|ha
operator|->
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
name|Q81_NUM_MBX_REGISTERS
operator|)
argument_list|)
expr_stmt|;
name|mbox
index|[
literal|0
index|]
operator|=
name|Q81_MBX_ABOUT_FW
expr_stmt|;
if|if
condition|(
name|qls_mbx_cmd
argument_list|(
name|ha
argument_list|,
name|mbox
argument_list|,
literal|1
argument_list|,
name|mbox
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|mbox
index|[
literal|0
index|]
argument_list|,
name|mbox
index|[
literal|1
index|]
argument_list|,
name|mbox
index|[
literal|2
index|]
argument_list|,
name|mbox
index|[
literal|3
index|]
argument_list|,
name|mbox
index|[
literal|4
index|]
argument_list|,
name|mbox
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|qls_mbx_dump_risc_ram
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|r_addr
parameter_list|,
name|uint32_t
name|r_size
parameter_list|)
block|{
name|bus_addr_t
name|b_paddr
decl_stmt|;
name|uint32_t
modifier|*
name|mbox
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|mbox
operator|=
name|ha
operator|->
name|mbox
expr_stmt|;
name|bzero
argument_list|(
name|mbox
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|*
name|Q81_NUM_MBX_REGISTERS
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ha
operator|->
name|mpi_dma
operator|.
name|dma_b
argument_list|,
operator|(
name|r_size
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|b_paddr
operator|=
name|ha
operator|->
name|mpi_dma
operator|.
name|dma_addr
expr_stmt|;
name|mbox
index|[
literal|0
index|]
operator|=
name|Q81_MBX_DUMP_RISC_RAM
expr_stmt|;
name|mbox
index|[
literal|1
index|]
operator|=
name|r_addr
operator|&
literal|0xFFFF
expr_stmt|;
name|mbox
index|[
literal|2
index|]
operator|=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|b_paddr
operator|>>
literal|16
argument_list|)
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|mbox
index|[
literal|3
index|]
operator|=
operator|(
operator|(
name|uint32_t
operator|)
name|b_paddr
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|mbox
index|[
literal|4
index|]
operator|=
operator|(
name|r_size
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|mbox
index|[
literal|5
index|]
operator|=
name|r_size
operator|&
literal|0xFFFF
expr_stmt|;
name|mbox
index|[
literal|6
index|]
operator|=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|b_paddr
operator|>>
literal|48
argument_list|)
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|mbox
index|[
literal|7
index|]
operator|=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|b_paddr
operator|>>
literal|32
argument_list|)
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|mbox
index|[
literal|8
index|]
operator|=
operator|(
name|r_addr
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|mpi_dma
operator|.
name|dma_tag
argument_list|,
name|ha
operator|->
name|mpi_dma
operator|.
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|qls_mbx_cmd
argument_list|(
name|ha
argument_list|,
name|mbox
argument_list|,
literal|9
argument_list|,
name|mbox
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|mbox
index|[
literal|0
index|]
operator|!=
literal|0x4000
condition|)
block|{
name|device_printf
argument_list|(
name|ha
operator|->
name|pci_dev
argument_list|,
literal|"%s: failed!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
block|{
name|bus_dmamap_sync
argument_list|(
name|ha
operator|->
name|mpi_dma
operator|.
name|dma_tag
argument_list|,
name|ha
operator|->
name|mpi_dma
operator|.
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|ha
operator|->
name|mpi_dma
operator|.
name|dma_b
argument_list|,
name|buf
argument_list|,
operator|(
name|r_size
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|qls_mpi_reset
parameter_list|(
name|qla_host_t
modifier|*
name|ha
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|device_t
name|dev
init|=
name|ha
operator|->
name|pci_dev
decl_stmt|;
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_HOST_CMD_STATUS
argument_list|,\
name|Q81_CTL_HCS_CMD_SET_RISC_RESET
argument_list|)
expr_stmt|;
name|count
operator|=
literal|10
expr_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|data
operator|=
name|READ_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_HOST_CMD_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|Q81_CTL_HCS_RISC_RESET
condition|)
block|{
name|WRITE_REG32
argument_list|(
name|ha
argument_list|,
name|Q81_CTL_HOST_CMD_STATUS
argument_list|,\
name|Q81_CTL_HCS_CMD_CLR_RISC_RESET
argument_list|)
expr_stmt|;
break|break;
block|}
name|qls_mdelay
argument_list|(
name|__func__
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


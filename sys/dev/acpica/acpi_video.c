begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2003 Taku YAMAMOTO<taku@cent.saitama-u.ac.jp>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$Id: acpi_vid.c,v 1.4 2003/10/13 10:07:36 taku Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/power.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/acpi.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_comment
comment|/* ACPI video extension driver. */
end_comment

begin_struct
struct|struct
name|acpi_video_output
block|{
name|ACPI_HANDLE
name|handle
decl_stmt|;
name|UINT32
name|adr
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|acpi_video_output
argument_list|)
name|vo_next
expr_stmt|;
struct|struct
block|{
name|int
name|num
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|acpi_video_output
argument_list|)
name|next
expr_stmt|;
block|}
name|vo_unit
struct|;
name|int
name|vo_brightness
decl_stmt|;
name|int
name|vo_fullpower
decl_stmt|;
name|int
name|vo_economy
decl_stmt|;
name|int
name|vo_numlevels
decl_stmt|;
name|int
modifier|*
name|vo_levels
decl_stmt|;
name|struct
name|sysctl_ctx_list
name|vo_sysctl_ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|vo_sysctl_tree
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|STAILQ_HEAD
argument_list|(
name|acpi_video_output_queue
argument_list|,
name|acpi_video_output
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|acpi_video_softc
block|{
name|device_t
name|device
decl_stmt|;
name|ACPI_HANDLE
name|handle
decl_stmt|;
name|struct
name|acpi_video_output_queue
name|vid_outputs
decl_stmt|;
name|eventhandler_tag
name|vid_pwr_evh
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* interfaces */
end_comment

begin_function_decl
specifier|static
name|int
name|acpi_video_modevent
parameter_list|(
name|struct
name|module
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_video_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_resume
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_video_notify_handler
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|UINT32
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_video_power_profile
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_video_bind_outputs
parameter_list|(
name|struct
name|acpi_video_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|acpi_video_output
modifier|*
name|acpi_video_vo_init
parameter_list|(
name|UINT32
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_video_vo_bind
parameter_list|(
name|struct
name|acpi_video_output
modifier|*
parameter_list|,
name|ACPI_HANDLE
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_video_vo_destroy
parameter_list|(
name|struct
name|acpi_video_output
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_vo_check_level
parameter_list|(
name|struct
name|acpi_video_output
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_video_vo_notify_handler
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|UINT32
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_vo_active_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_vo_bright_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_vo_presets_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_video_vo_levels_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* operations */
end_comment

begin_function_decl
specifier|static
name|void
name|vid_set_switch_policy
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|UINT32
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vid_enum_outputs
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|void
function_decl|(
modifier|*
function_decl|)
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|UINT32
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vo_get_brightness_levels
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|int
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vo_get_brightness
parameter_list|(
name|ACPI_HANDLE
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vo_set_brightness
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|UINT32
name|vo_get_device_status
parameter_list|(
name|ACPI_HANDLE
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|UINT32
name|vo_get_graphics_state
parameter_list|(
name|ACPI_HANDLE
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vo_set_device_state
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|UINT32
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* events */
end_comment

begin_define
define|#
directive|define
name|VID_NOTIFY_SWITCHED
value|0x80
end_define

begin_define
define|#
directive|define
name|VID_NOTIFY_REPROBE
value|0x81
end_define

begin_define
define|#
directive|define
name|VID_NOTIFY_CYCLE_BRN
value|0x85
end_define

begin_define
define|#
directive|define
name|VID_NOTIFY_INC_BRN
value|0x86
end_define

begin_define
define|#
directive|define
name|VID_NOTIFY_DEC_BRN
value|0x87
end_define

begin_define
define|#
directive|define
name|VID_NOTIFY_ZERO_BRN
value|0x88
end_define

begin_comment
comment|/* _DOS (Enable/Disable Output Switching) argument bits */
end_comment

begin_define
define|#
directive|define
name|DOS_SWITCH_MASK
value|3
end_define

begin_define
define|#
directive|define
name|DOS_SWITCH_BY_OSPM
value|0
end_define

begin_define
define|#
directive|define
name|DOS_SWITCH_BY_BIOS
value|1
end_define

begin_define
define|#
directive|define
name|DOS_SWITCH_LOCKED
value|2
end_define

begin_define
define|#
directive|define
name|DOS_BRIGHTNESS_BY_OSPM
value|(1<< 2)
end_define

begin_comment
comment|/* _DOD and subdev's _ADR */
end_comment

begin_define
define|#
directive|define
name|DOD_DEVID_MASK
value|0x0f00
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_MASK_FULL
value|0xffff
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_MASK_DISPIDX
value|0x000f
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_MASK_DISPPORT
value|0x00f0
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_MONITOR
value|0x0100
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_LCD
value|0x0110
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_TV
value|0x0200
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_EXT
value|0x0300
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_INTDFP
value|0x0400
end_define

begin_define
define|#
directive|define
name|DOD_BIOS
value|(1<< 16)
end_define

begin_define
define|#
directive|define
name|DOD_NONVGA
value|(1<< 17)
end_define

begin_define
define|#
directive|define
name|DOD_HEAD_ID_SHIFT
value|18
end_define

begin_define
define|#
directive|define
name|DOD_HEAD_ID_BITS
value|3
end_define

begin_define
define|#
directive|define
name|DOD_HEAD_ID_MASK
define|\
value|(((1<< DOD_HEAD_ID_BITS) - 1)<< DOD_HEAD_ID_SHIFT)
end_define

begin_define
define|#
directive|define
name|DOD_DEVID_SCHEME_STD
value|(1<< 31)
end_define

begin_comment
comment|/* _BCL related constants */
end_comment

begin_define
define|#
directive|define
name|BCL_FULLPOWER
value|0
end_define

begin_define
define|#
directive|define
name|BCL_ECONOMY
value|1
end_define

begin_comment
comment|/* _DCS (Device Currrent Status) value bits and masks. */
end_comment

begin_define
define|#
directive|define
name|DCS_EXISTS
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|DCS_ACTIVE
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|DCS_READY
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|DCS_FUNCTIONAL
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|DCS_ATTACHED
value|(1<< 4)
end_define

begin_comment
comment|/* _DSS (Device Set Status) argument bits and masks. */
end_comment

begin_define
define|#
directive|define
name|DSS_INACTIVE
value|0
end_define

begin_define
define|#
directive|define
name|DSS_ACTIVE
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|DSS_SETNEXT
value|(1<< 30)
end_define

begin_define
define|#
directive|define
name|DSS_COMMIT
value|(1<< 31)
end_define

begin_decl_stmt
specifier|static
name|device_method_t
name|acpi_video_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|acpi_video_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|acpi_video_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|acpi_video_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|acpi_video_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|acpi_video_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|acpi_video_shutdown
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|acpi_video_driver
init|=
block|{
literal|"acpi_video"
block|,
name|acpi_video_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|acpi_video_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|acpi_video_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|acpi_video
argument_list|,
name|vgapci
argument_list|,
name|acpi_video_driver
argument_list|,
name|acpi_video_devclass
argument_list|,
name|acpi_video_modevent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|acpi_video
argument_list|,
name|acpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|sysctl_ctx_list
name|acpi_video_sysctl_ctx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sysctl_oid
modifier|*
name|acpi_video_sysctl_tree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|acpi_video_output_queue
name|crt_units
decl_stmt|,
name|tv_units
decl_stmt|,
name|ext_units
decl_stmt|,
name|lcd_units
decl_stmt|,
name|other_units
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The 'video' lock protects the hierarchy of video output devices  * (the video "bus").  The 'video_output' lock protects per-output  * data is equivalent to a softc lock for each video output.  */
end_comment

begin_expr_stmt
name|ACPI_SERIAL_DECL
argument_list|(
name|video
argument_list|,
literal|"ACPI video"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ACPI_SERIAL_DECL
argument_list|(
name|video_output
argument_list|,
literal|"ACPI video output"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_ACPIVIDEO
argument_list|,
literal|"acpivideo"
argument_list|,
literal|"ACPI video extension"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|acpi_video_modevent
parameter_list|(
name|struct
name|module
modifier|*
name|mod
name|__unused
parameter_list|,
name|int
name|evt
parameter_list|,
name|void
modifier|*
name|cookie
name|__unused
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|evt
condition|)
block|{
case|case
name|MOD_LOAD
case|:
name|sysctl_ctx_init
argument_list|(
operator|&
name|acpi_video_sysctl_ctx
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|crt_units
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|tv_units
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|ext_units
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|lcd_units
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|other_units
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_UNLOAD
case|:
name|sysctl_ctx_free
argument_list|(
operator|&
name|acpi_video_sysctl_ctx
argument_list|)
expr_stmt|;
name|acpi_video_sysctl_tree
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
name|err
operator|=
name|EINVAL
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
if|if
condition|(
name|device_find_child
argument_list|(
name|parent
argument_list|,
literal|"acpi_video"
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|NULL
condition|)
name|device_add_child
argument_list|(
name|parent
argument_list|,
literal|"acpi_video"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_video_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|ACPI_HANDLE
name|devh
decl_stmt|,
name|h
decl_stmt|;
name|ACPI_OBJECT_TYPE
name|t_dos
decl_stmt|;
name|devh
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_disabled
argument_list|(
literal|"video"
argument_list|)
operator|||
name|ACPI_FAILURE
argument_list|(
name|AcpiGetHandle
argument_list|(
name|devh
argument_list|,
literal|"_DOD"
argument_list|,
operator|&
name|h
argument_list|)
argument_list|)
operator|||
name|ACPI_FAILURE
argument_list|(
name|AcpiGetHandle
argument_list|(
name|devh
argument_list|,
literal|"_DOS"
argument_list|,
operator|&
name|h
argument_list|)
argument_list|)
operator|||
name|ACPI_FAILURE
argument_list|(
name|AcpiGetType
argument_list|(
name|h
argument_list|,
operator|&
name|t_dos
argument_list|)
argument_list|)
operator|||
name|t_dos
operator|!=
name|ACPI_TYPE_METHOD
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"ACPI video extension"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_video_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_softc
modifier|*
name|acpi_sc
decl_stmt|;
name|struct
name|acpi_video_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|acpi_sc
operator|=
name|devclass_get_softc
argument_list|(
name|devclass_find
argument_list|(
literal|"acpi"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_video_sysctl_tree
operator|==
name|NULL
condition|)
block|{
name|acpi_video_sysctl_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|acpi_video_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|acpi_sc
operator|->
name|acpi_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"video"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"video extension control"
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|sc
operator|->
name|device
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|handle
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|sc
operator|->
name|vid_outputs
argument_list|)
expr_stmt|;
name|AcpiInstallNotifyHandler
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_video_notify_handler
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vid_pwr_evh
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|power_profile_change
argument_list|,
name|acpi_video_power_profile
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|acpi_video_bind_outputs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_END
argument_list|(
name|video
argument_list|)
expr_stmt|;
comment|/* 	 * Notify the BIOS that we want to switch both active outputs and 	 * brightness levels. 	 */
name|vid_set_switch_policy
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|DOS_SWITCH_BY_OSPM
operator||
name|DOS_BRIGHTNESS_BY_OSPM
argument_list|)
expr_stmt|;
name|acpi_video_power_profile
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_video_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_video_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|,
modifier|*
name|vn
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|vid_set_switch_policy
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|DOS_SWITCH_BY_BIOS
argument_list|)
expr_stmt|;
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|power_profile_change
argument_list|,
name|sc
operator|->
name|vid_pwr_evh
argument_list|)
expr_stmt|;
name|AcpiRemoveNotifyHandler
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_video_notify_handler
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|vo
argument_list|,
argument|&sc->vid_outputs
argument_list|,
argument|vo_next
argument_list|,
argument|vn
argument_list|)
block|{
name|acpi_video_vo_destroy
argument_list|(
name|vo
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|video
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_video_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_video_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|,
modifier|*
name|vn
decl_stmt|;
name|int
name|level
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Restore brightness level */
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|vo
argument_list|,
argument|&sc->vid_outputs
argument_list|,
argument|vo_next
argument_list|,
argument|vn
argument_list|)
block|{
if|if
condition|(
operator|(
name|vo
operator|->
name|adr
operator|&
name|DOD_DEVID_MASK_FULL
operator|)
operator|!=
name|DOD_DEVID_LCD
operator|&&
operator|(
name|vo
operator|->
name|adr
operator|&
name|DOD_DEVID_MASK
operator|)
operator|!=
name|DOD_DEVID_INTDFP
condition|)
continue|continue;
if|if
condition|(
operator|(
name|vo_get_device_status
argument_list|(
name|vo
operator|->
name|handle
argument_list|)
operator|&
name|DCS_ACTIVE
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|level
operator|=
name|vo_get_brightness
argument_list|(
name|vo
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|!=
operator|-
literal|1
condition|)
name|vo_set_brightness
argument_list|(
name|vo
operator|->
name|handle
argument_list|,
name|level
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_END
argument_list|(
name|video
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_video_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_video_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|vid_set_switch_policy
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|DOS_SWITCH_BY_BIOS
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_notify_handler
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_video_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|,
modifier|*
name|vo_tmp
decl_stmt|;
name|ACPI_HANDLE
name|lasthand
decl_stmt|;
name|UINT32
name|dcs
decl_stmt|,
name|dss
decl_stmt|,
name|dss_p
decl_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|acpi_video_softc
operator|*
operator|)
name|context
expr_stmt|;
switch|switch
condition|(
name|notify
condition|)
block|{
case|case
name|VID_NOTIFY_SWITCHED
case|:
name|dss_p
operator|=
literal|0
expr_stmt|;
name|lasthand
operator|=
name|NULL
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|vo
argument_list|,
argument|&sc->vid_outputs
argument_list|,
argument|vo_next
argument_list|)
block|{
name|dss
operator|=
name|vo_get_graphics_state
argument_list|(
name|vo
operator|->
name|handle
argument_list|)
expr_stmt|;
name|dcs
operator|=
name|vo_get_device_status
argument_list|(
name|vo
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|dcs
operator|&
name|DCS_READY
operator|)
condition|)
name|dss
operator|=
name|DSS_INACTIVE
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dcs
operator|&
name|DCS_ACTIVE
operator|)
operator|&&
name|dss
operator|==
name|DSS_INACTIVE
operator|)
operator|||
operator|(
operator|!
operator|(
name|dcs
operator|&
name|DCS_ACTIVE
operator|)
operator|&&
name|dss
operator|==
name|DSS_ACTIVE
operator|)
condition|)
block|{
if|if
condition|(
name|lasthand
operator|!=
name|NULL
condition|)
name|vo_set_device_state
argument_list|(
name|lasthand
argument_list|,
name|dss_p
argument_list|)
expr_stmt|;
name|dss_p
operator|=
name|dss
expr_stmt|;
name|lasthand
operator|=
name|vo
operator|->
name|handle
expr_stmt|;
block|}
block|}
if|if
condition|(
name|lasthand
operator|!=
name|NULL
condition|)
name|vo_set_device_state
argument_list|(
name|lasthand
argument_list|,
name|dss_p
operator||
name|DSS_COMMIT
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_END
argument_list|(
name|video
argument_list|)
expr_stmt|;
break|break;
case|case
name|VID_NOTIFY_REPROBE
case|:
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|vo
argument_list|,
argument|&sc->vid_outputs
argument_list|,
argument|vo_next
argument_list|)
name|vo
operator|->
name|handle
operator|=
name|NULL
expr_stmt|;
name|acpi_video_bind_outputs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|vo
argument_list|,
argument|&sc->vid_outputs
argument_list|,
argument|vo_next
argument_list|,
argument|vo_tmp
argument_list|)
block|{
if|if
condition|(
name|vo
operator|->
name|handle
operator|==
name|NULL
condition|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|sc
operator|->
name|vid_outputs
argument_list|,
name|vo
argument_list|,
name|acpi_video_output
argument_list|,
name|vo_next
argument_list|)
expr_stmt|;
name|acpi_video_vo_destroy
argument_list|(
name|vo
argument_list|)
expr_stmt|;
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|video
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|device
argument_list|,
literal|"unknown notify event 0x%x\n"
argument_list|,
name|notify
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_power_profile
parameter_list|(
name|void
modifier|*
name|context
parameter_list|)
block|{
name|int
name|state
decl_stmt|;
name|struct
name|acpi_video_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|;
name|sc
operator|=
name|context
expr_stmt|;
name|state
operator|=
name|power_profile_get_state
argument_list|()
expr_stmt|;
if|if
condition|(
name|state
operator|!=
name|POWER_PROFILE_PERFORMANCE
operator|&&
name|state
operator|!=
name|POWER_PROFILE_ECONOMY
condition|)
return|return;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|vo
argument_list|,
argument|&sc->vid_outputs
argument_list|,
argument|vo_next
argument_list|)
block|{
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|!=
name|NULL
operator|&&
name|vo
operator|->
name|vo_brightness
operator|==
operator|-
literal|1
condition|)
name|vo_set_brightness
argument_list|(
name|vo
operator|->
name|handle
argument_list|,
name|state
operator|==
name|POWER_PROFILE_ECONOMY
condition|?
name|vo
operator|->
name|vo_economy
else|:
name|vo
operator|->
name|vo_fullpower
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_END
argument_list|(
name|video
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_bind_outputs_subr
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|UINT32
name|adr
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_video_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|sc
operator|=
name|context
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|vo
argument_list|,
argument|&sc->vid_outputs
argument_list|,
argument|vo_next
argument_list|)
block|{
if|if
condition|(
name|vo
operator|->
name|adr
operator|==
name|adr
condition|)
block|{
name|acpi_video_vo_bind
argument_list|(
name|vo
argument_list|,
name|handle
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|vo
operator|=
name|acpi_video_vo_init
argument_list|(
name|adr
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|!=
name|NULL
condition|)
block|{
name|acpi_video_vo_bind
argument_list|(
name|vo
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|sc
operator|->
name|vid_outputs
argument_list|,
name|vo
argument_list|,
name|vo_next
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_bind_outputs
parameter_list|(
name|struct
name|acpi_video_softc
modifier|*
name|sc
parameter_list|)
block|{
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|vid_enum_outputs
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|acpi_video_bind_outputs_subr
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|acpi_video_output
modifier|*
name|acpi_video_vo_init
parameter_list|(
name|UINT32
name|adr
parameter_list|)
block|{
name|struct
name|acpi_video_output
modifier|*
name|vn
decl_stmt|,
modifier|*
name|vo
decl_stmt|,
modifier|*
name|vp
decl_stmt|;
name|int
name|n
decl_stmt|,
name|x
decl_stmt|;
name|char
name|name
index|[
literal|8
index|]
decl_stmt|,
name|env
index|[
literal|32
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|desc
decl_stmt|;
name|struct
name|acpi_video_output_queue
modifier|*
name|voqh
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|adr
operator|&
name|DOD_DEVID_MASK
condition|)
block|{
case|case
name|DOD_DEVID_MONITOR
case|:
if|if
condition|(
operator|(
name|adr
operator|&
name|DOD_DEVID_MASK_FULL
operator|)
operator|==
name|DOD_DEVID_LCD
condition|)
block|{
comment|/* DOD_DEVID_LCD is a common, backward compatible ID */
name|desc
operator|=
literal|"Internal/Integrated Digital Flat Panel"
expr_stmt|;
name|type
operator|=
literal|"lcd"
expr_stmt|;
name|voqh
operator|=
operator|&
name|lcd_units
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|=
literal|"VGA CRT or VESA Compatible Analog Monitor"
expr_stmt|;
name|type
operator|=
literal|"crt"
expr_stmt|;
name|voqh
operator|=
operator|&
name|crt_units
expr_stmt|;
block|}
break|break;
case|case
name|DOD_DEVID_TV
case|:
name|desc
operator|=
literal|"TV/HDTV or Analog-Video Monitor"
expr_stmt|;
name|type
operator|=
literal|"tv"
expr_stmt|;
name|voqh
operator|=
operator|&
name|tv_units
expr_stmt|;
break|break;
case|case
name|DOD_DEVID_EXT
case|:
name|desc
operator|=
literal|"External Digital Monitor"
expr_stmt|;
name|type
operator|=
literal|"ext"
expr_stmt|;
name|voqh
operator|=
operator|&
name|ext_units
expr_stmt|;
break|break;
case|case
name|DOD_DEVID_INTDFP
case|:
name|desc
operator|=
literal|"Internal/Integrated Digital Flat Panel"
expr_stmt|;
name|type
operator|=
literal|"lcd"
expr_stmt|;
name|voqh
operator|=
operator|&
name|lcd_units
expr_stmt|;
break|break;
default|default:
name|desc
operator|=
literal|"unknown output"
expr_stmt|;
name|type
operator|=
literal|"out"
expr_stmt|;
name|voqh
operator|=
operator|&
name|other_units
expr_stmt|;
block|}
name|n
operator|=
literal|0
expr_stmt|;
name|vp
operator|=
name|NULL
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|vn
argument_list|,
argument|voqh
argument_list|,
argument|vo_unit.next
argument_list|)
block|{
if|if
condition|(
name|vn
operator|->
name|vo_unit
operator|.
name|num
operator|!=
name|n
condition|)
break|break;
name|vp
operator|=
name|vn
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s%d"
argument_list|,
name|type
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|vo
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|vo
argument_list|)
argument_list|,
name|M_ACPIVIDEO
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|!=
name|NULL
condition|)
block|{
name|vo
operator|->
name|handle
operator|=
name|NULL
expr_stmt|;
name|vo
operator|->
name|adr
operator|=
name|adr
expr_stmt|;
name|vo
operator|->
name|vo_unit
operator|.
name|num
operator|=
name|n
expr_stmt|;
name|vo
operator|->
name|vo_brightness
operator|=
operator|-
literal|1
expr_stmt|;
name|vo
operator|->
name|vo_fullpower
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* TODO: override with tunables */
name|vo
operator|->
name|vo_economy
operator|=
operator|-
literal|1
expr_stmt|;
name|vo
operator|->
name|vo_numlevels
operator|=
literal|0
expr_stmt|;
name|vo
operator|->
name|vo_levels
operator|=
name|NULL
expr_stmt|;
name|snprintf
argument_list|(
name|env
argument_list|,
sizeof|sizeof
argument_list|(
name|env
argument_list|)
argument_list|,
literal|"hw.acpi.video.%s.fullpower"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|getenv_int
argument_list|(
name|env
argument_list|,
operator|&
name|x
argument_list|)
condition|)
name|vo
operator|->
name|vo_fullpower
operator|=
name|x
expr_stmt|;
name|snprintf
argument_list|(
name|env
argument_list|,
sizeof|sizeof
argument_list|(
name|env
argument_list|)
argument_list|,
literal|"hw.acpi.video.%s.economy"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|getenv_int
argument_list|(
name|env
argument_list|,
operator|&
name|x
argument_list|)
condition|)
name|vo
operator|->
name|vo_economy
operator|=
name|x
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|vp
operator|!=
name|NULL
condition|)
name|STAILQ_INSERT_AFTER
argument_list|(
name|voqh
argument_list|,
name|vp
argument_list|,
name|vo
argument_list|,
name|vo_unit
operator|.
name|next
argument_list|)
expr_stmt|;
else|else
name|STAILQ_INSERT_TAIL
argument_list|(
name|voqh
argument_list|,
name|vo
argument_list|,
name|vo_unit
operator|.
name|next
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_video_sysctl_tree
operator|!=
name|NULL
condition|)
name|vo
operator|->
name|vo_sysctl_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|acpi_video_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|name
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|vo_sysctl_tree
operator|!=
name|NULL
condition|)
block|{
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|vo
operator|->
name|vo_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"active"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|vo
argument_list|,
literal|0
argument_list|,
name|acpi_video_vo_active_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"current activity of this device"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|vo
operator|->
name|vo_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"brightness"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|vo
argument_list|,
literal|0
argument_list|,
name|acpi_video_vo_bright_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"current brightness level"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|vo
operator|->
name|vo_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fullpower"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|vo
argument_list|,
name|POWER_PROFILE_PERFORMANCE
argument_list|,
name|acpi_video_vo_presets_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"preset level for full power mode"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|vo
operator|->
name|vo_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"economy"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|vo
argument_list|,
name|POWER_PROFILE_ECONOMY
argument_list|,
name|acpi_video_vo_presets_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"preset level for economy mode"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|vo
operator|->
name|vo_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"levels"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|vo
argument_list|,
literal|0
argument_list|,
name|acpi_video_vo_levels_sysctl
argument_list|,
literal|"I"
argument_list|,
literal|"supported brightness levels"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"%s: sysctl node creation failed\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"%s: softc allocation failed\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"found %s(%x)"
argument_list|,
name|desc
argument_list|,
name|adr
operator|&
name|DOD_DEVID_MASK_FULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", idx#%x"
argument_list|,
name|adr
operator|&
name|DOD_DEVID_MASK_DISPIDX
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", port#%x"
argument_list|,
operator|(
name|adr
operator|&
name|DOD_DEVID_MASK_DISPPORT
operator|)
operator|>>
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|adr
operator|&
name|DOD_BIOS
condition|)
name|printf
argument_list|(
literal|", detectable by BIOS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|adr
operator|&
name|DOD_NONVGA
condition|)
name|printf
argument_list|(
literal|" (Non-VGA output device whose power "
literal|"is related to the VGA device)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|", head #%d\n"
argument_list|,
operator|(
name|adr
operator|&
name|DOD_HEAD_ID_MASK
operator|)
operator|>>
name|DOD_HEAD_ID_SHIFT
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|vo
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_vo_bind
parameter_list|(
name|struct
name|acpi_video_output
modifier|*
name|vo
parameter_list|,
name|ACPI_HANDLE
name|handle
parameter_list|)
block|{
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|!=
name|NULL
condition|)
name|AcpiOsFree
argument_list|(
name|vo
operator|->
name|vo_levels
argument_list|)
expr_stmt|;
name|vo
operator|->
name|handle
operator|=
name|handle
expr_stmt|;
name|vo
operator|->
name|vo_numlevels
operator|=
name|vo_get_brightness_levels
argument_list|(
name|handle
argument_list|,
operator|&
name|vo
operator|->
name|vo_levels
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|vo_numlevels
operator|>=
literal|2
condition|)
block|{
if|if
condition|(
name|vo
operator|->
name|vo_fullpower
operator|==
operator|-
literal|1
operator|||
name|acpi_video_vo_check_level
argument_list|(
name|vo
argument_list|,
name|vo
operator|->
name|vo_fullpower
argument_list|)
operator|!=
literal|0
condition|)
comment|/* XXX - can't deal with rebinding... */
name|vo
operator|->
name|vo_fullpower
operator|=
name|vo
operator|->
name|vo_levels
index|[
name|BCL_FULLPOWER
index|]
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|vo_economy
operator|==
operator|-
literal|1
operator|||
name|acpi_video_vo_check_level
argument_list|(
name|vo
argument_list|,
name|vo
operator|->
name|vo_economy
argument_list|)
operator|!=
literal|0
condition|)
comment|/* XXX - see above. */
name|vo
operator|->
name|vo_economy
operator|=
name|vo
operator|->
name|vo_levels
index|[
name|BCL_ECONOMY
index|]
expr_stmt|;
block|}
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|!=
name|NULL
condition|)
name|AcpiInstallNotifyHandler
argument_list|(
name|handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_video_vo_notify_handler
argument_list|,
name|vo
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_vo_destroy
parameter_list|(
name|struct
name|acpi_video_output
modifier|*
name|vo
parameter_list|)
block|{
name|struct
name|acpi_video_output_queue
modifier|*
name|voqh
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|vo_sysctl_tree
operator|!=
name|NULL
condition|)
block|{
name|vo
operator|->
name|vo_sysctl_tree
operator|=
name|NULL
expr_stmt|;
name|sysctl_ctx_free
argument_list|(
operator|&
name|vo
operator|->
name|vo_sysctl_ctx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|!=
name|NULL
condition|)
block|{
name|AcpiRemoveNotifyHandler
argument_list|(
name|vo
operator|->
name|handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_video_vo_notify_handler
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|vo
operator|->
name|vo_levels
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|vo
operator|->
name|adr
operator|&
name|DOD_DEVID_MASK
condition|)
block|{
case|case
name|DOD_DEVID_MONITOR
case|:
name|voqh
operator|=
operator|&
name|crt_units
expr_stmt|;
break|break;
case|case
name|DOD_DEVID_TV
case|:
name|voqh
operator|=
operator|&
name|tv_units
expr_stmt|;
break|break;
case|case
name|DOD_DEVID_EXT
case|:
name|voqh
operator|=
operator|&
name|ext_units
expr_stmt|;
break|break;
case|case
name|DOD_DEVID_INTDFP
case|:
name|voqh
operator|=
operator|&
name|lcd_units
expr_stmt|;
break|break;
default|default:
name|voqh
operator|=
operator|&
name|other_units
expr_stmt|;
block|}
name|STAILQ_REMOVE
argument_list|(
name|voqh
argument_list|,
name|vo
argument_list|,
name|acpi_video_output
argument_list|,
name|vo_unit
operator|.
name|next
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vo
argument_list|,
name|M_ACPIVIDEO
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_video_vo_check_level
parameter_list|(
name|struct
name|acpi_video_output
modifier|*
name|vo
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vo
operator|->
name|vo_numlevels
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|vo
operator|->
name|vo_levels
index|[
name|i
index|]
operator|==
name|level
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_video_vo_notify_handler
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|level
decl_stmt|,
name|new_level
decl_stmt|;
name|vo
operator|=
name|context
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|handle
operator|!=
name|handle
condition|)
goto|goto
name|out
goto|;
switch|switch
condition|(
name|notify
condition|)
block|{
case|case
name|VID_NOTIFY_CYCLE_BRN
case|:
if|if
condition|(
name|vo
operator|->
name|vo_numlevels
operator|<=
literal|3
condition|)
goto|goto
name|out
goto|;
comment|/* FALLTHROUGH */
case|case
name|VID_NOTIFY_INC_BRN
case|:
case|case
name|VID_NOTIFY_DEC_BRN
case|:
case|case
name|VID_NOTIFY_ZERO_BRN
case|:
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|level
operator|=
name|vo_get_brightness
argument_list|(
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown notify event 0x%x from %s\n"
argument_list|,
name|notify
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|new_level
operator|=
name|level
expr_stmt|;
switch|switch
condition|(
name|notify
condition|)
block|{
case|case
name|VID_NOTIFY_CYCLE_BRN
case|:
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|vo
operator|->
name|vo_numlevels
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|vo
operator|->
name|vo_levels
index|[
name|i
index|]
operator|==
name|level
condition|)
block|{
name|new_level
operator|=
name|vo
operator|->
name|vo_numlevels
operator|>
name|i
operator|+
literal|1
condition|?
name|vo
operator|->
name|vo_levels
index|[
name|i
operator|+
literal|1
index|]
else|:
name|vo
operator|->
name|vo_levels
index|[
literal|2
index|]
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|VID_NOTIFY_INC_BRN
case|:
case|case
name|VID_NOTIFY_DEC_BRN
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vo
operator|->
name|vo_numlevels
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|vo
operator|->
name|vo_levels
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|notify
operator|==
name|VID_NOTIFY_INC_BRN
condition|)
block|{
if|if
condition|(
name|j
operator|>
name|level
operator|&&
operator|(
name|j
operator|<
name|new_level
operator|||
name|level
operator|==
name|new_level
operator|)
condition|)
name|new_level
operator|=
name|j
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|j
operator|<
name|level
operator|&&
operator|(
name|j
operator|>
name|new_level
operator|||
name|level
operator|==
name|new_level
operator|)
condition|)
name|new_level
operator|=
name|j
expr_stmt|;
block|}
block|}
break|break;
case|case
name|VID_NOTIFY_ZERO_BRN
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vo
operator|->
name|vo_numlevels
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|vo
operator|->
name|vo_levels
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|new_level
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
block|}
if|if
condition|(
name|new_level
operator|!=
name|level
condition|)
block|{
name|vo_set_brightness
argument_list|(
name|handle
argument_list|,
name|new_level
argument_list|)
expr_stmt|;
name|vo
operator|->
name|vo_brightness
operator|=
name|new_level
expr_stmt|;
block|}
name|out
label|:
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|acpi_video_vo_active_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|;
name|int
name|state
decl_stmt|,
name|err
decl_stmt|;
name|vo
operator|=
operator|(
expr|struct
name|acpi_video_output
operator|*
operator|)
name|arg1
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|handle
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|state
operator|=
operator|(
name|vo_get_device_status
argument_list|(
name|vo
operator|->
name|handle
argument_list|)
operator|&
name|DCS_ACTIVE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|state
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|vo_set_device_state
argument_list|(
name|vo
operator|->
name|handle
argument_list|,
name|DSS_COMMIT
operator||
operator|(
name|state
condition|?
name|DSS_ACTIVE
else|:
name|DSS_INACTIVE
operator|)
argument_list|)
expr_stmt|;
name|out
label|:
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|acpi_video_vo_bright_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|;
name|int
name|level
decl_stmt|,
name|preset
decl_stmt|,
name|err
decl_stmt|;
name|vo
operator|=
operator|(
expr|struct
name|acpi_video_output
operator|*
operator|)
name|arg1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|handle
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENODEV
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|preset
operator|=
operator|(
name|power_profile_get_state
argument_list|()
operator|==
name|POWER_PROFILE_ECONOMY
operator|)
condition|?
name|vo
operator|->
name|vo_economy
else|:
name|vo
operator|->
name|vo_fullpower
expr_stmt|;
name|level
operator|=
name|vo
operator|->
name|vo_brightness
expr_stmt|;
if|if
condition|(
name|level
operator|==
operator|-
literal|1
condition|)
name|level
operator|=
name|preset
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|level
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|level
operator|<
operator|-
literal|1
operator|||
name|level
operator|>
literal|100
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|level
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|err
operator|=
name|acpi_video_vo_check_level
argument_list|(
name|vo
argument_list|,
name|level
argument_list|)
operator|)
condition|)
goto|goto
name|out
goto|;
name|vo
operator|->
name|vo_brightness
operator|=
name|level
expr_stmt|;
name|vo_set_brightness
argument_list|(
name|vo
operator|->
name|handle
argument_list|,
operator|(
name|level
operator|==
operator|-
literal|1
operator|)
condition|?
name|preset
else|:
name|level
argument_list|)
expr_stmt|;
name|out
label|:
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_video_vo_presets_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|;
name|int
name|i
decl_stmt|,
name|level
decl_stmt|,
modifier|*
name|preset
decl_stmt|,
name|err
decl_stmt|;
name|vo
operator|=
operator|(
expr|struct
name|acpi_video_output
operator|*
operator|)
name|arg1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|handle
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENODEV
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|preset
operator|=
operator|(
name|arg2
operator|==
name|POWER_PROFILE_ECONOMY
operator|)
condition|?
operator|&
name|vo
operator|->
name|vo_economy
else|:
operator|&
name|vo
operator|->
name|vo_fullpower
expr_stmt|;
name|level
operator|=
operator|*
name|preset
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|level
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|level
operator|<
operator|-
literal|1
operator|||
name|level
operator|>
literal|100
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|level
operator|==
operator|-
literal|1
condition|)
block|{
name|i
operator|=
operator|(
name|arg2
operator|==
name|POWER_PROFILE_ECONOMY
operator|)
condition|?
name|BCL_ECONOMY
else|:
name|BCL_FULLPOWER
expr_stmt|;
name|level
operator|=
name|vo
operator|->
name|vo_levels
index|[
name|i
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|err
operator|=
name|acpi_video_vo_check_level
argument_list|(
name|vo
argument_list|,
name|level
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|vo
operator|->
name|vo_brightness
operator|==
operator|-
literal|1
operator|&&
operator|(
name|power_profile_get_state
argument_list|()
operator|==
name|arg2
operator|)
condition|)
name|vo_set_brightness
argument_list|(
name|vo
operator|->
name|handle
argument_list|,
name|level
argument_list|)
expr_stmt|;
operator|*
name|preset
operator|=
name|level
expr_stmt|;
name|out
label|:
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|acpi_video_vo_levels_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_video_output
modifier|*
name|vo
decl_stmt|;
name|int
name|err
decl_stmt|;
name|vo
operator|=
operator|(
expr|struct
name|acpi_video_output
operator|*
operator|)
name|arg1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
if|if
condition|(
name|vo
operator|->
name|vo_levels
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENODEV
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|req
operator|->
name|newptr
operator|!=
name|NULL
condition|)
block|{
name|err
operator|=
name|EPERM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|err
operator|=
name|sysctl_handle_opaque
argument_list|(
name|oidp
argument_list|,
name|vo
operator|->
name|vo_levels
argument_list|,
name|vo
operator|->
name|vo_numlevels
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|vo
operator|->
name|vo_levels
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|out
label|:
name|ACPI_SERIAL_END
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vid_set_switch_policy
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|UINT32
name|policy
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|status
operator|=
name|acpi_SetInteger
argument_list|(
name|handle
argument_list|,
literal|"_DOS"
argument_list|,
name|policy
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
name|printf
argument_list|(
literal|"can't evaluate %s._DOS - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|enum_callback_arg
block|{
name|void
function_decl|(
modifier|*
name|callback
function_decl|)
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|UINT32
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
modifier|*
name|context
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|dod_pkg
decl_stmt|;
name|int
name|count
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ACPI_STATUS
name|vid_enum_outputs_subr
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|UINT32
name|level
name|__unused
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|void
modifier|*
modifier|*
name|retp
name|__unused
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|UINT32
name|adr
decl_stmt|,
name|val
decl_stmt|;
name|struct
name|enum_callback_arg
modifier|*
name|argset
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|argset
operator|=
name|context
expr_stmt|;
name|status
operator|=
name|acpi_GetInteger
argument_list|(
name|handle
argument_list|,
literal|"_ADR"
argument_list|,
operator|&
name|adr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
return|return
operator|(
name|AE_OK
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argset
operator|->
name|dod_pkg
operator|->
name|Package
operator|.
name|Count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|acpi_PkgInt32
argument_list|(
name|argset
operator|->
name|dod_pkg
argument_list|,
name|i
argument_list|,
operator|&
name|val
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|val
operator|&
name|DOD_DEVID_MASK_FULL
operator|)
operator|==
operator|(
name|adr
operator|&
name|DOD_DEVID_MASK_FULL
operator|)
condition|)
block|{
name|argset
operator|->
name|callback
argument_list|(
name|handle
argument_list|,
name|val
argument_list|,
name|argset
operator|->
name|context
argument_list|)
expr_stmt|;
name|argset
operator|->
name|count
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|AE_OK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vid_enum_outputs
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|void
function_decl|(
modifier|*
name|callback
function_decl|)
parameter_list|(
name|ACPI_HANDLE
parameter_list|,
name|UINT32
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_BUFFER
name|dod_buf
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|res
decl_stmt|;
name|struct
name|enum_callback_arg
name|argset
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video
argument_list|)
expr_stmt|;
name|dod_buf
operator|.
name|Length
operator|=
name|ACPI_ALLOCATE_BUFFER
expr_stmt|;
name|dod_buf
operator|.
name|Pointer
operator|=
name|NULL
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|handle
argument_list|,
literal|"_DOD"
argument_list|,
name|NULL
argument_list|,
operator|&
name|dod_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|AE_NOT_FOUND
condition|)
name|printf
argument_list|(
literal|"can't evaluate %s._DOD - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|argset
operator|.
name|count
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|res
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|dod_buf
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
operator|!
name|ACPI_PKG_VALID
argument_list|(
name|res
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"evaluation of %s._DOD makes no sense\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|)
expr_stmt|;
name|argset
operator|.
name|count
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|callback
operator|==
name|NULL
condition|)
block|{
name|argset
operator|.
name|count
operator|=
name|res
operator|->
name|Package
operator|.
name|Count
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|argset
operator|.
name|callback
operator|=
name|callback
expr_stmt|;
name|argset
operator|.
name|context
operator|=
name|context
expr_stmt|;
name|argset
operator|.
name|dod_pkg
operator|=
name|res
expr_stmt|;
name|argset
operator|.
name|count
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|AcpiWalkNamespace
argument_list|(
name|ACPI_TYPE_DEVICE
argument_list|,
name|handle
argument_list|,
literal|1
argument_list|,
name|vid_enum_outputs_subr
argument_list|,
name|NULL
argument_list|,
operator|&
name|argset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
name|printf
argument_list|(
literal|"failed walking down %s - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|dod_buf
operator|.
name|Pointer
operator|!=
name|NULL
condition|)
name|AcpiOsFree
argument_list|(
name|dod_buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
name|argset
operator|.
name|count
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vo_get_brightness_levels
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|int
modifier|*
modifier|*
name|levelp
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_BUFFER
name|bcl_buf
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|res
decl_stmt|;
name|int
name|num
decl_stmt|,
name|i
decl_stmt|,
name|n
decl_stmt|,
modifier|*
name|levels
decl_stmt|;
name|bcl_buf
operator|.
name|Length
operator|=
name|ACPI_ALLOCATE_BUFFER
expr_stmt|;
name|bcl_buf
operator|.
name|Pointer
operator|=
name|NULL
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|handle
argument_list|,
literal|"_BCL"
argument_list|,
name|NULL
argument_list|,
operator|&
name|bcl_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|AE_NOT_FOUND
condition|)
name|printf
argument_list|(
literal|"can't evaluate %s._BCL - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|res
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|bcl_buf
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
operator|!
name|ACPI_PKG_VALID
argument_list|(
name|res
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"evaluation of %s._BCL makes no sense\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|num
operator|=
name|res
operator|->
name|Package
operator|.
name|Count
expr_stmt|;
if|if
condition|(
name|num
operator|<
literal|2
operator|||
name|levelp
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|levels
operator|=
name|AcpiOsAllocate
argument_list|(
name|num
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|levels
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|levels
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|n
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|acpi_PkgInt32
argument_list|(
name|res
argument_list|,
name|i
argument_list|,
operator|&
name|levels
index|[
name|n
index|]
argument_list|)
operator|==
literal|0
condition|)
name|n
operator|++
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|2
condition|)
block|{
name|AcpiOsFree
argument_list|(
name|levels
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|levelp
operator|=
name|levels
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
name|out
label|:
if|if
condition|(
name|bcl_buf
operator|.
name|Pointer
operator|!=
name|NULL
condition|)
name|AcpiOsFree
argument_list|(
name|bcl_buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vo_get_brightness
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|)
block|{
name|UINT32
name|level
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|status
operator|=
name|acpi_GetInteger
argument_list|(
name|handle
argument_list|,
literal|"_BQC"
argument_list|,
operator|&
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"can't evaluate %s._BQC - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|level
operator|>
literal|100
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
name|level
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vo_set_brightness
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|int
name|level
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|status
operator|=
name|acpi_SetInteger
argument_list|(
name|handle
argument_list|,
literal|"_BCM"
argument_list|,
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
name|printf
argument_list|(
literal|"can't evaluate %s._BCM - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|UINT32
name|vo_get_device_status
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|)
block|{
name|UINT32
name|dcs
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|dcs
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|acpi_GetInteger
argument_list|(
name|handle
argument_list|,
literal|"_DCS"
argument_list|,
operator|&
name|dcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
name|printf
argument_list|(
literal|"can't evaluate %s._DCS - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dcs
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|UINT32
name|vo_get_graphics_state
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|)
block|{
name|UINT32
name|dgs
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|dgs
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|acpi_GetInteger
argument_list|(
name|handle
argument_list|,
literal|"_DGS"
argument_list|,
operator|&
name|dgs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
name|printf
argument_list|(
literal|"can't evaluate %s._DGS - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dgs
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vo_set_device_state
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|UINT32
name|state
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|video_output
argument_list|)
expr_stmt|;
name|status
operator|=
name|acpi_SetInteger
argument_list|(
name|handle
argument_list|,
literal|"_DSS"
argument_list|,
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
name|printf
argument_list|(
literal|"can't evaluate %s._DSS - %s\n"
argument_list|,
name|acpi_name
argument_list|(
name|handle
argument_list|)
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000, 2001 Michael Smith  * Copyright (c) 2000 BSDi  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_acpi.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/reboot.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|"acpi.h"
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_comment
comment|/*  * Hooks for the ACPI CA debugging infrastructure  */
end_comment

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_THERMAL
end_define

begin_macro
name|MODULE_NAME
argument_list|(
literal|"THERMAL"
argument_list|)
end_macro

begin_define
define|#
directive|define
name|TZ_ZEROC
value|2732
end_define

begin_define
define|#
directive|define
name|TZ_KELVTOC
parameter_list|(
name|x
parameter_list|)
value|(((x) - TZ_ZEROC) / 10), (((x) - TZ_ZEROC) % 10)
end_define

begin_define
define|#
directive|define
name|TZ_NOTIFY_TEMPERATURE
value|0x80
end_define

begin_define
define|#
directive|define
name|TZ_NOTIFY_DEVICES
value|0x81
end_define

begin_define
define|#
directive|define
name|TZ_NOTIFY_LEVELS
value|0x82
end_define

begin_define
define|#
directive|define
name|TZ_POLLRATE
value|(hz * 10)
end_define

begin_comment
comment|/* every ten seconds */
end_comment

begin_define
define|#
directive|define
name|TZ_NUMLEVELS
value|10
end_define

begin_comment
comment|/* defined by ACPI spec */
end_comment

begin_struct
struct|struct
name|acpi_tz_state
block|{
name|int
name|ac
index|[
name|TZ_NUMLEVELS
index|]
decl_stmt|;
name|ACPI_BUFFER
name|al
index|[
name|TZ_NUMLEVELS
index|]
decl_stmt|;
name|int
name|crt
decl_stmt|;
name|int
name|hot
decl_stmt|;
name|ACPI_BUFFER
name|psl
decl_stmt|;
name|int
name|psv
decl_stmt|;
name|int
name|tc1
decl_stmt|;
name|int
name|tc2
decl_stmt|;
name|int
name|tsp
decl_stmt|;
name|int
name|tzp
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|acpi_tz_softc
block|{
name|device_t
name|tz_dev
decl_stmt|;
name|ACPI_HANDLE
name|tz_handle
decl_stmt|;
name|struct
name|callout_handle
name|tz_timeout
decl_stmt|;
name|int
name|tz_temperature
decl_stmt|;
name|int
name|tz_active
decl_stmt|;
define|#
directive|define
name|TZ_ACTIVE_NONE
value|-1
name|int
name|tz_flags
decl_stmt|;
define|#
directive|define
name|TZ_FLAG_NONE
value|0
define|#
directive|define
name|TZ_FLAG_PSV
value|(1<<0)
define|#
directive|define
name|TZ_FLAG_HOT
value|(1<<2)
define|#
directive|define
name|TZ_FLAG_CRT
value|(1<<3)
name|struct
name|sysctl_ctx_list
name|tz_sysctl_ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tz_sysctl_tree
decl_stmt|;
name|struct
name|acpi_tz_state
name|tz_state
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|acpi_tz_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_tz_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_tz_establish
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_monitor
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_all_off
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_switch_cooler_off
parameter_list|(
name|ACPI_OBJECT
modifier|*
name|obj
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_switch_cooler_on
parameter_list|(
name|ACPI_OBJECT
modifier|*
name|obj
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_getparam
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|node
parameter_list|,
name|int
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_sanity
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|,
name|int
modifier|*
name|val
parameter_list|,
name|char
modifier|*
name|what
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_notify_handler
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_tz_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|acpi_tz_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|acpi_tz_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|acpi_tz_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|acpi_tz_driver
init|=
block|{
literal|"acpi_tz"
block|,
name|acpi_tz_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|acpi_tz_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|devclass_t
name|acpi_tz_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|acpi_tz
argument_list|,
name|acpi
argument_list|,
name|acpi_tz_driver
argument_list|,
name|acpi_tz_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|sysctl_ctx_list
name|acpi_tz_sysctl_ctx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sysctl_oid
modifier|*
name|acpi_tz_sysctl_tree
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Match an ACPI thermal zone.  */
end_comment

begin_function
specifier|static
name|int
name|acpi_tz_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|ACPI_LOCK
expr_stmt|;
comment|/* no FUNCTION_TRACE - too noisy */
if|if
condition|(
operator|(
name|acpi_get_type
argument_list|(
name|dev
argument_list|)
operator|==
name|ACPI_TYPE_THERMAL
operator|)
operator|&&
operator|!
name|acpi_disabled
argument_list|(
literal|"thermal"
argument_list|)
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"thermal zone"
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|10
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|ENXIO
expr_stmt|;
block|}
name|ACPI_UNLOCK
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attach to an ACPI thermal zone.  */
end_comment

begin_function
specifier|static
name|int
name|acpi_tz_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_tz_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_softc
modifier|*
name|acpi_sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|char
name|oidname
index|[
literal|8
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_LOCK
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tz_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|tz_handle
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/*      * Parse the current state of the thermal zone and build control      * structures.      */
if|if
condition|(
operator|(
name|error
operator|=
name|acpi_tz_establish
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/*      * Register for any Notify events sent to this zone.      */
name|AcpiInstallNotifyHandler
argument_list|(
name|sc
operator|->
name|tz_handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_tz_notify_handler
argument_list|,
name|sc
argument_list|)
expr_stmt|;
comment|/*      * Create our sysctl nodes.      *      * XXX we need a mechanism for adding nodes under ACPI.      */
if|if
condition|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|==
literal|0
condition|)
block|{
name|acpi_sc
operator|=
name|acpi_device_get_parent_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
operator|&
name|acpi_tz_sysctl_ctx
argument_list|)
expr_stmt|;
name|acpi_tz_sysctl_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|acpi_tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|acpi_sc
operator|->
name|acpi_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"thermal"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
name|sysctl_ctx_init
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|oidname
argument_list|,
literal|"tz%d"
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tz_sysctl_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|acpi_tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|oidname
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"temperature"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tz_temperature
argument_list|,
literal|0
argument_list|,
literal|"current thermal zone temperature"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"active"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tz_active
argument_list|,
literal|0
argument_list|,
literal|"active cooling mode"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"flags"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tz_flags
argument_list|,
literal|0
argument_list|,
literal|"thermal zone flags"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"_PSV"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|psv
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"_HOT"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|hot
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"_CRT"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|crt
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TZ_NUMLEVELS
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|oidname
argument_list|,
literal|"_AC%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|tz_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|tz_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|oidname
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|ac
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
comment|/*      * Don't bother evaluating/printing the temperature at this point;      * on many systems it'll be bogus until the EC is running.      */
name|out
label|:
name|ACPI_UNLOCK
expr_stmt|;
name|return_VALUE
argument_list|(
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Parse the current state of this thermal zone and set up to use it.  *  * Note that we may have previous state, which will have to be discarded.  */
end_comment

begin_function
specifier|static
name|int
name|acpi_tz_establish
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|)
block|{
name|ACPI_OBJECT
modifier|*
name|obj
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|nbuf
index|[
literal|8
index|]
decl_stmt|;
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_ASSERTLOCK
expr_stmt|;
comment|/*      * Power everything off and erase any existing state.      */
name|acpi_tz_all_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TZ_NUMLEVELS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|i
index|]
operator|.
name|Pointer
operator|!=
name|NULL
condition|)
name|AcpiOsFree
argument_list|(
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|i
index|]
operator|.
name|Pointer
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tz_state
operator|.
name|psl
operator|.
name|Pointer
operator|!=
name|NULL
condition|)
name|AcpiOsFree
argument_list|(
name|sc
operator|->
name|tz_state
operator|.
name|psl
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sc
operator|->
name|tz_state
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|tz_state
argument_list|)
argument_list|)
expr_stmt|;
comment|/* kill the timeout (harmless if not running */
name|untimeout
argument_list|(
name|acpi_tz_timeout
argument_list|,
name|sc
argument_list|,
name|sc
operator|->
name|tz_timeout
argument_list|)
expr_stmt|;
comment|/*      * Evaluate thermal zone parameters.      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TZ_NUMLEVELS
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|nbuf
argument_list|,
literal|"_AC%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
name|nbuf
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|ac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|nbuf
argument_list|,
literal|"_AL%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|acpi_EvaluateIntoBuffer
argument_list|(
name|sc
operator|->
name|tz_handle
argument_list|,
name|nbuf
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|obj
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|i
index|]
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|obj
operator|!=
name|NULL
condition|)
block|{
comment|/* should be a package containing a list of power objects */
if|if
condition|(
name|obj
operator|->
name|Type
operator|!=
name|ACPI_TYPE_PACKAGE
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|tz_dev
argument_list|,
literal|"%s has unknown object type %d, rejecting\n"
argument_list|,
name|nbuf
argument_list|,
name|obj
operator|->
name|Type
argument_list|)
expr_stmt|;
name|return_VALUE
argument_list|(
name|ENXIO
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
literal|"_CRT"
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|crt
argument_list|)
expr_stmt|;
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
literal|"_HOT"
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|hot
argument_list|)
expr_stmt|;
name|acpi_EvaluateIntoBuffer
argument_list|(
name|sc
operator|->
name|tz_handle
argument_list|,
literal|"_PSL"
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|psl
argument_list|)
expr_stmt|;
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
literal|"_PSV"
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|psv
argument_list|)
expr_stmt|;
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
literal|"_TC1"
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|tc1
argument_list|)
expr_stmt|;
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
literal|"_TC2"
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|tc2
argument_list|)
expr_stmt|;
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
literal|"_TSP"
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|tsp
argument_list|)
expr_stmt|;
name|acpi_tz_getparam
argument_list|(
name|sc
argument_list|,
literal|"_TZP"
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|tzp
argument_list|)
expr_stmt|;
comment|/*      * Sanity-check the values we've been given.      *      * XXX what do we do about systems that give us the same value for      *     more than one of these setpoints?      */
name|acpi_tz_sanity
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|crt
argument_list|,
literal|"_CRT"
argument_list|)
expr_stmt|;
name|acpi_tz_sanity
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|hot
argument_list|,
literal|"_HOT"
argument_list|)
expr_stmt|;
name|acpi_tz_sanity
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|psv
argument_list|,
literal|"_PSV"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TZ_NUMLEVELS
condition|;
name|i
operator|++
control|)
name|acpi_tz_sanity
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|tz_state
operator|.
name|ac
index|[
name|i
index|]
argument_list|,
literal|"_ACx"
argument_list|)
expr_stmt|;
comment|/*      * Power off everything that we've just been given.      */
name|acpi_tz_all_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/*      * The timeout routine always needs to run, since it may be involved      * in passive cooling.      */
name|sc
operator|->
name|tz_timeout
operator|=
name|timeout
argument_list|(
name|acpi_tz_timeout
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|return_VALUE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Evaluate the condition of a thermal zone, take appropriate actions.  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_monitor
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|temp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|newactive
decl_stmt|,
name|newflags
decl_stmt|;
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_ASSERTLOCK
expr_stmt|;
comment|/*      * Get the current temperature.      */
if|if
condition|(
operator|(
name|acpi_EvaluateInteger
argument_list|(
name|sc
operator|->
name|tz_handle
argument_list|,
literal|"_TMP"
argument_list|,
operator|&
name|temp
argument_list|)
operator|)
operator|!=
name|AE_OK
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|tz_dev
argument_list|,
literal|"error fetching current temperature\n"
argument_list|)
expr_stmt|;
comment|/* XXX disable zone? go to max cooling? */
name|return_VOID
expr_stmt|;
block|}
name|DEBUG_PRINT
argument_list|(
name|TRACE_VALUES
argument_list|,
operator|(
literal|"got %d.%dC\n"
operator|,
name|TZ_KELVTOC
argument_list|(
name|temp
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tz_temperature
operator|=
name|temp
expr_stmt|;
comment|/*      * Work out what we ought to be doing right now.      *      * Note that the _ACx levels sort from hot to cold.      */
name|newactive
operator|=
name|TZ_ACTIVE_NONE
expr_stmt|;
for|for
control|(
name|i
operator|=
name|TZ_NUMLEVELS
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
operator|(
name|sc
operator|->
name|tz_state
operator|.
name|ac
index|[
name|i
index|]
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|temp
operator|>
name|sc
operator|->
name|tz_state
operator|.
name|ac
index|[
name|i
index|]
operator|)
condition|)
name|newactive
operator|=
name|i
expr_stmt|;
name|newflags
operator|=
name|TZ_FLAG_NONE
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|tz_state
operator|.
name|psv
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|temp
operator|>
name|sc
operator|->
name|tz_state
operator|.
name|psv
operator|)
condition|)
name|newflags
operator||=
name|TZ_FLAG_PSV
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|tz_state
operator|.
name|hot
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|temp
operator|>
name|sc
operator|->
name|tz_state
operator|.
name|hot
operator|)
condition|)
name|newflags
operator||=
name|TZ_FLAG_HOT
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|tz_state
operator|.
name|crt
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|temp
operator|>
name|sc
operator|->
name|tz_state
operator|.
name|crt
operator|)
condition|)
name|newflags
operator||=
name|TZ_FLAG_CRT
expr_stmt|;
comment|/*      * If the active cooling state has changed, we have to switch things.      */
if|if
condition|(
name|newactive
operator|!=
name|sc
operator|->
name|tz_active
condition|)
block|{
comment|/* turn off the cooling devices that are on, if any are */
if|if
condition|(
name|sc
operator|->
name|tz_active
operator|!=
name|TZ_ACTIVE_NONE
condition|)
name|acpi_ForeachPackageObject
argument_list|(
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|sc
operator|->
name|tz_active
index|]
operator|.
name|Pointer
argument_list|,
name|acpi_tz_switch_cooler_off
argument_list|,
name|sc
argument_list|)
expr_stmt|;
comment|/* turn on cooling devices that are required, if any are */
if|if
condition|(
name|newactive
operator|!=
name|TZ_ACTIVE_NONE
condition|)
name|acpi_ForeachPackageObject
argument_list|(
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|newactive
index|]
operator|.
name|Pointer
argument_list|,
name|acpi_tz_switch_cooler_on
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tz_active
operator|=
name|newactive
expr_stmt|;
block|}
comment|/*      * XXX (de)activate any passive cooling that may be required.      */
comment|/*      * If we have just become _HOT or _CRT, warn the user.      *      * We should actually shut down at this point, but it's not clear      * that some systems don't actually map _CRT to the same value as _AC0.      */
if|if
condition|(
operator|(
name|newflags
operator|&
operator|(
name|TZ_FLAG_HOT
operator||
name|TZ_FLAG_CRT
operator|)
operator|)
operator|&&
operator|!
operator|(
name|sc
operator|->
name|tz_flags
operator|&
operator|(
name|TZ_FLAG_HOT
operator||
name|TZ_FLAG_CRT
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|tz_dev
argument_list|,
literal|"WARNING - current temperature (%d.%dC) exceeds system limits\n"
argument_list|,
name|TZ_KELVTOC
argument_list|(
name|sc
operator|->
name|tz_temperature
argument_list|)
argument_list|,
name|sc
operator|->
name|tz_temperature
argument_list|)
expr_stmt|;
comment|/* shutdown_nice(RB_POWEROFF);*/
block|}
name|sc
operator|->
name|tz_flags
operator|=
name|newflags
expr_stmt|;
name|return_VOID
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Turn off all the cooling devices.  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_all_off
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_ASSERTLOCK
expr_stmt|;
comment|/*      * Scan all the _AL objects, and turn them all off.      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TZ_NUMLEVELS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|i
index|]
operator|.
name|Pointer
operator|==
name|NULL
condition|)
continue|continue;
name|acpi_ForeachPackageObject
argument_list|(
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|sc
operator|->
name|tz_state
operator|.
name|al
index|[
name|i
index|]
operator|.
name|Pointer
argument_list|,
name|acpi_tz_switch_cooler_off
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/*      * XXX revert any passive-cooling options.      */
name|sc
operator|->
name|tz_active
operator|=
name|TZ_ACTIVE_NONE
expr_stmt|;
name|sc
operator|->
name|tz_flags
operator|=
name|TZ_FLAG_NONE
expr_stmt|;
name|return_VOID
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Given an object, verify that it's a reference to a device of some sort,   * and try to switch it off.  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_switch_cooler_off
parameter_list|(
name|ACPI_OBJECT
modifier|*
name|obj
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|acpi_tz_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|acpi_tz_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|ACPI_HANDLE
name|cooler
decl_stmt|;
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_ASSERTLOCK
expr_stmt|;
switch|switch
condition|(
name|obj
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_TYPE_STRING
case|:
name|DEBUG_PRINT
argument_list|(
name|TRACE_OBJECTS
argument_list|,
operator|(
literal|"called to turn %s off\n"
operator|,
name|obj
operator|->
name|String
operator|.
name|Pointer
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Find the handle for the device and turn it off. 	 * The String object here seems to contain a fully-qualified path, so we 	 * don't have to search for it in our parents. 	 * 	 * XXX This may not always be the case. 	 */
if|if
condition|(
name|AcpiGetHandle
argument_list|(
name|obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
name|NULL
argument_list|,
operator|&
name|cooler
argument_list|)
operator|==
name|AE_OK
condition|)
name|acpi_pwr_switch_consumer
argument_list|(
name|cooler
argument_list|,
name|ACPI_STATE_D3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DEBUG_PRINT
argument_list|(
name|TRACE_OBJECTS
argument_list|,
operator|(
literal|"called to handle unsupported object type %d\n"
operator|,
name|obj
operator|->
name|Type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|return_VOID
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Given an object, verify that it's a reference to a device of some sort,   * and try to switch it on.  *  * XXX replication of off/on function code is bad, mmmkay?  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_switch_cooler_on
parameter_list|(
name|ACPI_OBJECT
modifier|*
name|obj
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|acpi_tz_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|acpi_tz_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|ACPI_HANDLE
name|cooler
decl_stmt|;
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_ASSERTLOCK
expr_stmt|;
switch|switch
condition|(
name|obj
operator|->
name|Type
condition|)
block|{
case|case
name|ACPI_TYPE_STRING
case|:
name|DEBUG_PRINT
argument_list|(
name|TRACE_OBJECTS
argument_list|,
operator|(
literal|"called to turn %s off\n"
operator|,
name|obj
operator|->
name|String
operator|.
name|Pointer
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Find the handle for the device and turn it off. 	 * The String object here seems to contain a fully-qualified path, so we 	 * don't have to search for it in our parents. 	 * 	 * XXX This may not always be the case. 	 */
if|if
condition|(
name|AcpiGetHandle
argument_list|(
name|obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
name|NULL
argument_list|,
operator|&
name|cooler
argument_list|)
operator|==
name|AE_OK
condition|)
name|acpi_pwr_switch_consumer
argument_list|(
name|cooler
argument_list|,
name|ACPI_STATE_D0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DEBUG_PRINT
argument_list|(
name|TRACE_OBJECTS
argument_list|,
operator|(
literal|"called to handle unsupported object type %d\n"
operator|,
name|obj
operator|->
name|Type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|return_VOID
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Read/debug-print a parameter, default it to -1.  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_getparam
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|node
parameter_list|,
name|int
modifier|*
name|data
parameter_list|)
block|{
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_ASSERTLOCK
expr_stmt|;
if|if
condition|(
name|acpi_EvaluateInteger
argument_list|(
name|sc
operator|->
name|tz_handle
argument_list|,
name|node
argument_list|,
name|data
argument_list|)
operator|!=
name|AE_OK
condition|)
block|{
operator|*
name|data
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|DEBUG_PRINT
argument_list|(
name|TRACE_VALUES
argument_list|,
operator|(
literal|"%s.%s = %d\n"
operator|,
name|acpi_name
argument_list|(
name|sc
operator|->
name|tz_handle
argument_list|)
operator|,
name|node
operator|,
operator|*
name|data
operator|)
argument_list|)
expr_stmt|;
block|}
name|return_VOID
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Sanity-check a temperature value.  Assume that setpoints  * should be between 0C and 150C.  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_sanity
parameter_list|(
name|struct
name|acpi_tz_softc
modifier|*
name|sc
parameter_list|,
name|int
modifier|*
name|val
parameter_list|,
name|char
modifier|*
name|what
parameter_list|)
block|{
if|if
condition|(
operator|(
operator|*
name|val
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
operator|(
operator|*
name|val
operator|<
name|TZ_ZEROC
operator|)
operator|||
operator|(
operator|*
name|val
operator|>
operator|(
name|TZ_ZEROC
operator|+
literal|1500
operator|)
operator|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|tz_dev
argument_list|,
literal|"%s value is absurd, ignored (%d.%dC)\n"
argument_list|,
name|what
argument_list|,
name|TZ_KELVTOC
argument_list|(
operator|*
name|val
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|val
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Respond to a Notify event sent to the zone.  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_notify_handler
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_tz_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|acpi_tz_softc
operator|*
operator|)
name|context
decl_stmt|;
name|FUNCTION_TRACE
argument_list|(
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_ASSERTLOCK
expr_stmt|;
switch|switch
condition|(
name|notify
condition|)
block|{
case|case
name|TZ_NOTIFY_TEMPERATURE
case|:
comment|/* temperature change occurred */
name|AcpiOsQueueForExecution
argument_list|(
name|OSD_PRIORITY_HIGH
argument_list|,
operator|(
name|OSD_EXECUTION_CALLBACK
operator|)
name|acpi_tz_monitor
argument_list|,
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|TZ_NOTIFY_DEVICES
case|:
case|case
name|TZ_NOTIFY_LEVELS
case|:
comment|/* zone devices/setpoints changed */
name|AcpiOsQueueForExecution
argument_list|(
name|OSD_PRIORITY_HIGH
argument_list|,
operator|(
name|OSD_EXECUTION_CALLBACK
operator|)
name|acpi_tz_establish
argument_list|,
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|tz_dev
argument_list|,
literal|"unknown Notify event 0x%x\n"
argument_list|,
name|notify
argument_list|)
expr_stmt|;
break|break;
block|}
name|return_VOID
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Poll the thermal zone.  */
end_comment

begin_function
specifier|static
name|void
name|acpi_tz_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|acpi_tz_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|acpi_tz_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|ACPI_LOCK
expr_stmt|;
comment|/* check temperature, take action */
name|AcpiOsQueueForExecution
argument_list|(
name|OSD_PRIORITY_HIGH
argument_list|,
operator|(
name|OSD_EXECUTION_CALLBACK
operator|)
name|acpi_tz_monitor
argument_list|,
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX passive cooling actions? */
comment|/* re-register ourself */
name|sc
operator|->
name|tz_timeout
operator|=
name|timeout
argument_list|(
name|acpi_tz_timeout
argument_list|,
name|sc
argument_list|,
name|TZ_POLLRATE
argument_list|)
expr_stmt|;
name|ACPI_UNLOCK
expr_stmt|;
block|}
end_function

end_unit


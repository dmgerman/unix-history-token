begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1997 Semen Ustimenko (semen@iclub.nsu.ru)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * version: stable-165  *  */
end_comment

begin_comment
comment|/*  * EtherPower II 10/100  Fast Ethernet (tx0)  * (aka SMC9432TX based on SMC83c170 EPIC chip)  *  * Written by Semen Ustimenko.  *  * TODO:  *	Add IFF_MULTICAST support  *	Fix serious collision counter behaviour  *	Fix RX_TO_MBUF option  *	  * stable-140:  *	first stable version  *  * stable-160:  *	added BPF support  *	fixed several bugs  *  * stable-161:  *	fixed BPF support  *	fixed several bugs  *  * stable-162:  *	fixed IFF_PROMISC mode support  *	added speed info displayed at startup (MII info)  *  * stable-163:  *	added media control code  *  * stable-164:  *	fixed some bugs  *  * stable-165:  *	fixed media control code  */
end_comment

begin_include
include|#
directive|include
file|"pci.h"
end_include

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_mib.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/smc83c170.h>
end_include

begin_include
include|#
directive|include
file|"bpfilter.h"
end_include

begin_if
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Global variables  */
end_comment

begin_decl_stmt
specifier|static
name|u_long
name|epic_pci_count
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|epic_softc_t
modifier|*
name|epics
index|[
name|EPIC_MAX_DEVICES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pci_device
name|txdevice
init|=
block|{
literal|"tx"
block|,
name|epic_pci_probe
block|,
name|epic_pci_attach
block|,
operator|&
name|epic_pci_count
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Append this driver to pci drivers list  */
end_comment

begin_expr_stmt
name|DATA_SET
argument_list|(
name|pcidevice_set
argument_list|,
name|txdevice
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|epic_ifioctl
parameter_list|(
specifier|register
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|int
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|epic_softc_t
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|x
decl_stmt|,
name|error
init|=
literal|0
decl_stmt|;
name|x
operator|=
name|splimp
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFADDR
case|:
case|case
name|SIOCGIFADDR
case|:
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
comment|/* 		 * If the interface is marked up and stopped, then start it. 		 * If it is marked down and running, then stop it. 		 */
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
operator|==
literal|0
condition|)
name|epic_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
block|{
name|epic_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_RUNNING
expr_stmt|;
block|}
block|}
comment|/* Update RXCON register */
name|epic_set_rx_mode
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Update SPEED */
name|epic_set_media_speed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
comment|/* Update out multicast list */
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD__
operator|>=
literal|3
name|epic_set_mc_table
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|error
operator|=
operator|(
name|command
operator|==
name|SIOCADDMULTI
operator|)
condition|?
name|ether_addmulti
argument_list|(
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|epic_ac
argument_list|)
else|:
name|ether_delmulti
argument_list|(
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|epic_ac
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENETRESET
condition|)
block|{
name|epic_set_mc_table
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
case|case
name|SIOCSIFMTU
case|:
comment|/* 		 * Set the interface MTU. 		 */
if|if
condition|(
name|ifr
operator|->
name|ifr_mtu
operator|>
name|ETHERMTU
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|ifp
operator|->
name|if_mtu
operator|=
name|ifr
operator|->
name|ifr_mtu
expr_stmt|;
block|}
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*  * Ifstart function  */
end_comment

begin_function
specifier|static
name|void
name|epic_ifstart
parameter_list|(
name|struct
name|ifnet
modifier|*
specifier|const
name|ifp
parameter_list|)
block|{
name|epic_softc_t
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
while|while
condition|(
name|sc
operator|->
name|pending_txs
operator|<
name|TX_RING_SIZE
condition|)
block|{
name|int
name|entry
init|=
name|sc
operator|->
name|cur_tx
operator|%
name|TX_RING_SIZE
decl_stmt|;
name|struct
name|epic_tx_buffer
modifier|*
name|buf
init|=
name|sc
operator|->
name|tx_buffer
operator|+
name|entry
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|buf
operator|->
name|desc
operator|.
name|status
condition|)
break|break;
name|IF_DEQUEUE
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|epic_if
operator|.
name|if_snd
operator|)
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|m
condition|)
return|return;
name|m0
operator|=
name|m
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|m
operator|!=
literal|0
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|buf
operator|->
name|data
operator|+
name|len
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|len
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|buf
operator|->
name|desc
operator|.
name|txlength
operator|=
name|max
argument_list|(
name|len
argument_list|,
name|ETHER_MIN_LEN
operator|-
name|ETHER_CRC_LEN
argument_list|)
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|control
operator|=
literal|0x14
expr_stmt|;
comment|/* Interrupt when done */
name|buf
operator|->
name|desc
operator|.
name|status
operator|=
literal|0x8000
expr_stmt|;
comment|/* Pass ownership to the chip */
comment|/* Set watchdog timer */
name|ifp
operator|->
name|if_timer
operator|=
literal|3
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
if|if
condition|(
name|ifp
operator|->
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
comment|/* Trigger an immediate transmit demand. */
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|COMMAND
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cur_tx
operator|=
operator|(
name|sc
operator|->
name|cur_tx
operator|+
literal|1
operator|)
operator|%
name|TX_RING_SIZE
expr_stmt|;
name|sc
operator|->
name|pending_txs
operator|++
expr_stmt|;
block|}
name|sc
operator|->
name|epic_if
operator|.
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  *  IFWATCHDOG function  */
end_comment

begin_function
specifier|static
name|void
name|epic_ifwatchdog
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|epic_softc_t
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|x
decl_stmt|;
name|int
name|i
decl_stmt|;
name|x
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"tx%d: device timeout %d packets\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|pending_txs
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|+=
name|sc
operator|->
name|pending_txs
expr_stmt|;
name|epic_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|epic_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|epic_ifstart
argument_list|(
operator|&
name|sc
operator|->
name|epic_if
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Interrupt function  */
end_comment

begin_function
specifier|static
name|void
name|epic_intr_normal
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|epic_softc_t
modifier|*
name|sc
init|=
operator|(
name|epic_softc_t
operator|*
operator|)
name|arg
decl_stmt|;
name|int
name|iobase
init|=
name|sc
operator|->
name|iobase
decl_stmt|;
name|int
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
name|status
operator|=
name|inl
argument_list|(
name|iobase
operator|+
name|INTSTAT
argument_list|)
expr_stmt|;
comment|/* Acknowledge all of the current interrupt sources ASAP. */
name|outl
argument_list|(
name|iobase
operator|+
name|INTSTAT
argument_list|,
name|status
operator|&
literal|0x0000ffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
operator|(
name|INTSTAT_RQE
operator||
name|INTSTAT_HCC
operator||
name|INTSTAT_RCC
operator||
name|INTSTAT_OVW
operator|)
condition|)
name|epic_rx_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
operator|(
name|INTSTAT_TXC
operator||
name|INTSTAT_TQE
operator||
name|INTSTAT_TCC
operator||
name|INTSTAT_TXU
operator|)
condition|)
name|epic_tx_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	if( status& INTSTAT_GP2 ){ 		printf("tx%d: GP2 int occured\n",sc->unit); 		epic_read_phy_register(sc->iobase,DP83840_BMSR); 		epic_read_phy_register(sc->iobase,DP83840_BMCR); 	} */
if|if
condition|(
name|status
operator|&
operator|(
name|INTSTAT_FATAL
operator||
name|INTSTAT_PMA
operator||
name|INTSTAT_PTA
operator||
name|INTSTAT_APE
operator||
name|INTSTAT_DPE
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"tx%d: PCI fatal error occured (%s%s%s%s)"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
operator|(
name|status
operator|&
name|INTSTAT_PMA
operator|)
condition|?
literal|"PMA"
else|:
literal|""
argument_list|,
operator|(
name|status
operator|&
name|INTSTAT_PTA
operator|)
condition|?
literal|" PTA"
else|:
literal|""
argument_list|,
operator|(
name|status
operator|&
name|INTSTAT_APE
operator|)
condition|?
literal|" APE"
else|:
literal|""
argument_list|,
operator|(
name|status
operator|&
name|INTSTAT_DPE
operator|)
condition|?
literal|" DPE"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
comment|/* UPDATE statistics */
if|if
condition|(
name|status
operator|&
operator|(
name|INTSTAT_CNT
operator||
name|INTSTAT_TXU
operator||
name|INTSTAT_OVW
operator||
name|INTSTAT_RXE
operator|)
condition|)
block|{
comment|/* 		 * update dot3 Rx statistics 		 */
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsMissedFrames
operator|+=
name|inb
argument_list|(
name|iobase
operator|+
name|MPCNT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsFrameTooLongs
operator|+=
name|inb
argument_list|(
name|iobase
operator|+
name|ALICNT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsFCSErrors
operator|+=
name|inb
argument_list|(
name|iobase
operator|+
name|CRCCNT
argument_list|)
expr_stmt|;
comment|/* Update if Rx statistics */
if|if
condition|(
name|status
operator|&
operator|(
name|INTSTAT_OVW
operator||
name|INTSTAT_RXE
operator|)
condition|)
name|sc
operator|->
name|epic_if
operator|.
name|if_ierrors
operator|++
expr_stmt|;
comment|/* Tx FIFO underflow. */
if|if
condition|(
name|status
operator|&
name|INTSTAT_TXU
condition|)
block|{
comment|/* Inc. counters */
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsInternalMacTransmitErrors
operator|++
expr_stmt|;
name|sc
operator|->
name|epic_if
operator|.
name|if_oerrors
operator|++
expr_stmt|;
comment|/* Restart the transmit process. */
name|outl
argument_list|(
name|iobase
operator|+
name|COMMAND
argument_list|,
name|COMMAND_TXUGO
argument_list|)
expr_stmt|;
block|}
comment|/* Clear all error sources. */
name|outl
argument_list|(
name|iobase
operator|+
name|INTSTAT
argument_list|,
name|status
operator|&
literal|0x7f18
argument_list|)
expr_stmt|;
block|}
comment|/* If no packets are pending, thus no timeouts */
if|if
condition|(
name|sc
operator|->
name|pending_txs
operator|==
literal|0
condition|)
name|sc
operator|->
name|epic_if
operator|.
name|if_timer
operator|=
literal|0
expr_stmt|;
comment|/* We should clear all interrupt sources. */
name|outl
argument_list|(
name|iobase
operator|+
name|INTSTAT
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|epic_rx_done
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|u_int16_t
name|len
decl_stmt|;
name|struct
name|epic_rx_buffer
modifier|*
name|buf
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
while|while
condition|(
operator|!
operator|(
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|cur_rx
index|]
operator|.
name|desc
operator|.
name|status
operator|&
literal|0x8000
operator|)
operator|&&
expr|\
name|i
operator|++
operator|<
name|RX_RING_SIZE
condition|)
block|{
name|int
name|stt
decl_stmt|;
name|buf
operator|=
name|sc
operator|->
name|rx_buffer
operator|+
name|sc
operator|->
name|cur_rx
expr_stmt|;
name|stt
operator|=
name|buf
operator|->
name|desc
operator|.
name|status
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|EPIC_DEBUG
argument_list|)
name|printf
argument_list|(
literal|"tx%d: "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|"rsucc"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|2
condition|)
name|printf
argument_list|(
literal|" faer"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|4
condition|)
name|printf
argument_list|(
literal|" crer"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|8
condition|)
name|printf
argument_list|(
literal|" mpac"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|16
condition|)
name|printf
argument_list|(
literal|" mcas"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|32
condition|)
name|printf
argument_list|(
literal|" bcas\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     \n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
operator|(
name|buf
operator|->
name|desc
operator|.
name|status
operator|&
literal|1
operator|)
condition|)
block|{
name|sc
operator|->
name|epic_if
operator|.
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|rxerror
goto|;
block|}
name|len
operator|=
name|buf
operator|->
name|desc
operator|.
name|rxlength
operator|-
name|ETHER_CRC_LEN
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|RX_TO_MBUF
argument_list|)
comment|/* 		 * Copy data to new allocated mbuf 		 */
name|MGETHDR
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|m
condition|)
goto|goto
name|rxerror
goto|;
if|if
condition|(
operator|(
name|len
operator|+
literal|2
operator|)
operator|>
name|MHLEN
condition|)
block|{
name|MCLGET
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|rxerror
goto|;
block|}
block|}
name|m
operator|->
name|m_data
operator|+=
literal|2
expr_stmt|;
name|memcpy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|buf
operator|->
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|#
directive|else
name|m
operator|=
name|buf
operator|->
name|mbuf
expr_stmt|;
name|buf
operator|->
name|mbuf
operator|=
name|NULL
expr_stmt|;
name|MGETHDR
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|buf
operator|->
name|mbuf
condition|)
comment|/* XXXXX: to panic */
name|panic
argument_list|(
literal|"tx: low mbufs"
argument_list|)
expr_stmt|;
comment|/* or not to panic?*/
name|MCLGET
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|buf
operator|->
name|mbuf
condition|)
name|panic
argument_list|(
literal|"tx: low mbufs"
argument_list|)
expr_stmt|;
name|buf
operator|->
name|data
operator|=
name|mtod
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|bufaddr
operator|=
name|vtophys
argument_list|(
name|buf
operator|->
name|data
argument_list|)
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|status
operator|=
literal|0x8000
expr_stmt|;
endif|#
directive|endif
comment|/* 		 * First mbuf in packet holds the 		 * ethernet and packet headers 		 */
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
operator|&
operator|(
name|sc
operator|->
name|epic_if
operator|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
if|if
condition|(
name|sc
operator|->
name|epic_if
operator|.
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
operator|&
name|sc
operator|->
name|epic_if
argument_list|,
name|m
argument_list|)
expr_stmt|;
comment|/* Accept only our packets, broadcasts and multicasts */
if|if
condition|(
operator|(
name|eh
operator|->
name|ether_dhost
index|[
literal|0
index|]
operator|&
literal|1
operator|)
operator|==
literal|0
operator|&&
name|bcmp
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|sc
operator|->
name|epic_ac
operator|.
name|ac_enaddr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|rxerror
goto|;
block|}
endif|#
directive|endif
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_data
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
name|ether_input
argument_list|(
operator|&
name|sc
operator|->
name|epic_if
argument_list|,
name|eh
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|sc
operator|->
name|epic_if
operator|.
name|if_ipackets
operator|++
expr_stmt|;
name|rxerror
label|:
comment|/* 		 * Mark descriptor as free 		 */
name|buf
operator|->
name|desc
operator|.
name|rxlength
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|status
operator|=
literal|0x8000
expr_stmt|;
name|sc
operator|->
name|cur_rx
operator|=
operator|(
name|sc
operator|->
name|cur_rx
operator|+
literal|1
operator|)
operator|%
name|RX_RING_SIZE
expr_stmt|;
block|}
name|epic_ifstart
argument_list|(
operator|&
name|sc
operator|->
name|epic_if
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|INTSTAT
argument_list|,
name|INTSTAT_RCC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|epic_tx_done
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|if_flags
init|=
operator|~
literal|0
decl_stmt|;
name|int
name|coll
decl_stmt|;
name|u_int16_t
name|stt
decl_stmt|;
while|while
condition|(
name|i
operator|++
operator|<
name|TX_RING_SIZE
condition|)
block|{
name|struct
name|epic_tx_buffer
modifier|*
name|buf
init|=
name|sc
operator|->
name|tx_buffer
operator|+
name|sc
operator|->
name|dirty_tx
decl_stmt|;
name|u_int16_t
name|len
init|=
name|buf
operator|->
name|desc
operator|.
name|txlength
decl_stmt|;
name|stt
operator|=
name|buf
operator|->
name|desc
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|0x8000
condition|)
break|break;
comment|/* following packets are not Txed yet */
if|if
condition|(
name|stt
operator|==
literal|0
condition|)
block|{
name|if_flags
operator|=
operator|~
name|IFF_OACTIVE
expr_stmt|;
break|break;
block|}
if|#
directive|if
name|defined
argument_list|(
name|EPIC_DEBUG
argument_list|)
name|printf
argument_list|(
literal|"tx%d: "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|1
condition|)
name|printf
argument_list|(
literal|" succ"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|2
condition|)
name|printf
argument_list|(
literal|" ndef"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|4
condition|)
name|printf
argument_list|(
literal|" coll"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|8
condition|)
name|printf
argument_list|(
literal|" urun"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|16
condition|)
name|printf
argument_list|(
literal|" cdhb"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|32
condition|)
name|printf
argument_list|(
literal|" oowc"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|64
condition|)
name|printf
argument_list|(
literal|" deff"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"     "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %d\n"
argument_list|,
operator|(
name|stt
operator|>>
literal|8
operator|)
operator|&
literal|0xF
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|pending_txs
operator|--
expr_stmt|;
comment|/* packet is finished */
name|sc
operator|->
name|dirty_tx
operator|=
operator|(
name|sc
operator|->
name|dirty_tx
operator|+
literal|1
operator|)
operator|%
name|TX_RING_SIZE
expr_stmt|;
name|coll
operator|=
operator|(
name|stt
operator|>>
literal|8
operator|)
operator|&
literal|0xF
expr_stmt|;
comment|/* number of collisions*/
if|if
condition|(
name|stt
operator|&
literal|0x0001
condition|)
block|{
name|sc
operator|->
name|epic_if
operator|.
name|if_opackets
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|stt
operator|&
literal|0x0008
condition|)
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsCarrierSenseErrors
operator|++
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|0x1050
condition|)
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsInternalMacTransmitErrors
operator|++
expr_stmt|;
if|if
condition|(
name|stt
operator|&
literal|0x1000
condition|)
name|coll
operator|=
literal|16
expr_stmt|;
name|sc
operator|->
name|epic_if
operator|.
name|if_oerrors
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|stt
operator|&
literal|0x0002
condition|)
comment|/* What does it mean? */
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsDeferredTransmissions
operator|++
expr_stmt|;
name|sc
operator|->
name|epic_if
operator|.
name|if_collisions
operator|+=
name|coll
expr_stmt|;
switch|switch
condition|(
name|coll
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
literal|16
case|:
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsExcessiveCollisions
operator|++
expr_stmt|;
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsCollFrequencies
index|[
literal|15
index|]
operator|++
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsSingleCollisionFrames
operator|++
expr_stmt|;
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsCollFrequencies
index|[
literal|0
index|]
operator|++
expr_stmt|;
break|break;
default|default:
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsMultipleCollisionFrames
operator|++
expr_stmt|;
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsCollFrequencies
index|[
name|coll
operator|-
literal|1
index|]
operator|++
expr_stmt|;
break|break;
block|}
name|buf
operator|->
name|desc
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|if_flags
operator|=
operator|~
name|IFF_OACTIVE
expr_stmt|;
block|}
name|sc
operator|->
name|epic_if
operator|.
name|if_flags
operator|&=
name|if_flags
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|INTSTAT
argument_list|,
name|INTSTAT_TCC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|epic_if
operator|.
name|if_flags
operator|&
name|IFF_OACTIVE
operator|)
condition|)
name|epic_ifstart
argument_list|(
operator|&
name|sc
operator|->
name|epic_if
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Probe function  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|epic_pci_probe
parameter_list|(
name|pcici_t
name|config_id
parameter_list|,
name|pcidi_t
name|device_id
parameter_list|)
block|{
if|if
condition|(
name|PCI_VENDORID
argument_list|(
name|device_id
argument_list|)
operator|!=
name|SMC_VENDORID
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|PCI_CHIPID
argument_list|(
name|device_id
argument_list|)
operator|==
name|CHIPID_83C170
condition|)
return|return
literal|"SMC 83c170"
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * PCI_Attach function  */
end_comment

begin_function
specifier|static
name|void
name|epic_pci_attach
parameter_list|(
name|pcici_t
name|config_id
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|epic_softc_t
modifier|*
name|sc
decl_stmt|;
name|u_int32_t
name|iobase
decl_stmt|;
name|u_int32_t
name|irq
decl_stmt|;
name|u_int32_t
name|phyid
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|s
decl_stmt|;
name|int
name|phy
decl_stmt|,
name|phy_idx
decl_stmt|;
comment|/* 	 * Get iobase and irq level 	 */
name|irq
operator|=
name|PCI_CONF_READ
argument_list|(
name|PCI_CFIT
argument_list|)
operator|&
operator|(
literal|0xFF
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|pci_map_port
argument_list|(
name|config_id
argument_list|,
name|PCI_CBIO
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|iobase
argument_list|)
condition|)
return|return;
comment|/* 	 * Allocate and preinitialize softc structure 	 */
name|sc
operator|=
operator|(
name|epic_softc_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|epic_softc_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|epics
index|[
name|unit
index|]
operator|=
name|sc
expr_stmt|;
comment|/* 	 * Zero softc structure 	 */
name|bzero
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
name|epic_softc_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Initialize softc 	 */
name|sc
operator|->
name|unit
operator|=
name|unit
expr_stmt|;
name|sc
operator|->
name|iobase
operator|=
name|iobase
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
comment|/* Bring the chip out of low-power mode. */
name|outl
argument_list|(
name|iobase
operator|+
name|GENCTL
argument_list|,
literal|0x0000
argument_list|)
expr_stmt|;
comment|/* Magic?!  If we don't set this bit the MII interface won't work. */
name|outl
argument_list|(
name|iobase
operator|+
name|TEST1
argument_list|,
literal|0x0008
argument_list|)
expr_stmt|;
comment|/* Read mac address (may be better is read from EEPROM?) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
operator|/
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
condition|;
name|i
operator|++
control|)
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
name|sc
operator|->
name|epic_macaddr
operator|)
index|[
name|i
index|]
operator|=
name|inw
argument_list|(
name|iobase
operator|+
name|LAN0
operator|+
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
comment|/* Display some info */
name|printf
argument_list|(
literal|"tx%d: address %02x:%02x:%02x:%02x:%02x:%02x,"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|epic_macaddr
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|epic_macaddr
index|[
literal|1
index|]
argument_list|,
name|sc
operator|->
name|epic_macaddr
index|[
literal|2
index|]
argument_list|,
name|sc
operator|->
name|epic_macaddr
index|[
literal|3
index|]
argument_list|,
name|sc
operator|->
name|epic_macaddr
index|[
literal|4
index|]
argument_list|,
name|sc
operator|->
name|epic_macaddr
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
comment|/* Map interrupt */
if|if
condition|(
operator|!
name|pci_map_int
argument_list|(
name|config_id
argument_list|,
name|epic_intr_normal
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
argument_list|,
operator|&
name|net_imask
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"tx%d: couldn't map interrupt\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|epics
index|[
name|unit
index|]
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Fill ifnet structure */
name|ifp
operator|=
operator|&
name|sc
operator|->
name|epic_if
expr_stmt|;
name|ifp
operator|->
name|if_unit
operator|=
name|unit
expr_stmt|;
name|ifp
operator|->
name|if_name
operator|=
literal|"tx"
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
operator||
name|IFF_ALLMULTI
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|epic_ifioctl
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|epic_ifstart
expr_stmt|;
name|ifp
operator|->
name|if_watchdog
operator|=
name|epic_ifwatchdog
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
operator|(
name|if_init_f_t
operator|*
operator|)
name|epic_init
expr_stmt|;
name|ifp
operator|->
name|if_timer
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_output
operator|=
name|ether_output
expr_stmt|;
name|ifp
operator|->
name|if_linkmib
operator|=
operator|&
name|sc
operator|->
name|dot3stats
expr_stmt|;
name|ifp
operator|->
name|if_linkmiblen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ifmib_iso_8802_3
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dot3stats
operator|.
name|dot3StatsEtherChipSet
operator|=
name|DOT3CHIPSET
argument_list|(
name|dot3VendorSMC
argument_list|,
name|dot3ChipSetSMC83c170
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dot3stats
operator|.
name|dot3Compliance
operator|=
name|DOT3COMPLIANCE_COLLS
expr_stmt|;
name|printf
argument_list|(
literal|" type SMC9432TX"
argument_list|)
expr_stmt|;
name|i
operator|=
name|epic_read_phy_register
argument_list|(
name|iobase
argument_list|,
name|DP83840_BMCR
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|BMCR_AUTONEGOTIATION
condition|)
block|{
name|printf
argument_list|(
literal|" [Auto-Neg."
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|BMCR_100MBPS
condition|)
name|printf
argument_list|(
literal|" 100Mbps"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" 10Mbps"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|BMCR_FULL_DUPLEX
condition|)
name|printf
argument_list|(
literal|" FD"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"]\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|BMCR_FULL_DUPLEX
condition|)
name|printf
argument_list|(
literal|"tx%d: WARNING! FD autonegotiated, not supported\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_LINK0
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|BMCR_100MBPS
condition|)
block|{
name|printf
argument_list|(
literal|" [100Mbps"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_LINK2
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|" [10Mbps"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|BMCR_FULL_DUPLEX
condition|)
block|{
name|printf
argument_list|(
literal|" FD"
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_LINK1
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"]\n"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|EPIC_DEBUG
argument_list|)
name|printf
argument_list|(
literal|"tx%d: PHY id: ("
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
name|i
operator|=
name|epic_read_phy_register
argument_list|(
name|iobase
argument_list|,
name|DP83840_PHYIDR1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%04x:"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|phyid
operator|=
name|i
operator|<<
literal|6
expr_stmt|;
name|i
operator|=
name|epic_read_phy_register
argument_list|(
name|iobase
argument_list|,
name|DP83840_PHYIDR2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%04x)"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|phyid
operator||=
operator|(
operator|(
name|i
operator|>>
literal|10
operator|)
operator|&
literal|0x3F
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|" %08x, rev %x, mod %x\n"
argument_list|,
name|phyid
argument_list|,
operator|(
name|i
operator|)
operator|&
literal|0xF
argument_list|,
operator|(
name|i
operator|>>
literal|4
operator|)
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|epic_read_phy_register
argument_list|(
name|iobase
argument_list|,
name|DP83840_BMSR
argument_list|)
expr_stmt|;
name|epic_read_phy_register
argument_list|(
name|iobase
argument_list|,
name|DP83840_BMSR
argument_list|)
expr_stmt|;
name|epic_read_phy_register
argument_list|(
name|iobase
argument_list|,
name|DP83840_BMSR
argument_list|)
expr_stmt|;
name|i
operator|=
name|epic_read_phy_register
argument_list|(
name|iobase
argument_list|,
name|DP83840_BMSR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|i
operator|&
name|BMSR_LINK_STATUS
operator|)
condition|)
name|printf
argument_list|(
literal|"tx%d: WARNING! no link estabilished/n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
comment|/* 	 *  Attach to if manager 	 */
name|if_attach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
name|bpfattach
argument_list|(
name|ifp
argument_list|,
name|DLT_EN10MB
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * IFINIT function  */
end_comment

begin_function
specifier|static
name|void
name|epic_init
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|epic_if
decl_stmt|;
name|int
name|iobase
init|=
name|sc
operator|->
name|iobase
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Soft reset the chip. */
name|outl
argument_list|(
name|iobase
operator|+
name|GENCTL
argument_list|,
name|GENCTL_SOFT_RESET
argument_list|)
expr_stmt|;
comment|/* Reset takes 15 ticks */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x100
condition|;
name|i
operator|++
control|)
empty_stmt|;
comment|/* Wake up */
name|outl
argument_list|(
name|iobase
operator|+
name|GENCTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ?????? */
name|outl
argument_list|(
name|iobase
operator|+
name|TEST1
argument_list|,
literal|0x0008
argument_list|)
expr_stmt|;
comment|/* Initialize rings or reinitialize */
name|epic_init_rings
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Put node address to EPIC */
name|outl
argument_list|(
name|iobase
operator|+
name|LAN0
operator|+
literal|0x0
argument_list|,
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
name|sc
operator|->
name|epic_macaddr
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|LAN0
operator|+
literal|0x4
argument_list|,
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
name|sc
operator|->
name|epic_macaddr
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|LAN0
operator|+
literal|0x8
argument_list|,
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
name|sc
operator|->
name|epic_macaddr
operator|)
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* Enable interrupts,  set for PCI read multiple and etc */
name|outl
argument_list|(
name|iobase
operator|+
name|GENCTL
argument_list|,
name|GENCTL_ENABLE_INTERRUPT
operator||
name|GENCTL_MEMORY_READ_MULTIPLE
operator||
name|GENCTL_ONECOPY
operator||
name|GENCTL_RECEIVE_FIFO_THRESHOLD128
argument_list|)
expr_stmt|;
comment|/* Set transmit threshold */
name|outl
argument_list|(
name|iobase
operator|+
name|ETXTHR
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
comment|/* Compute and set RXCON. */
name|epic_set_rx_mode
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set MII speed mode */
name|epic_set_media_speed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set multicast table */
name|epic_set_mc_table
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable interrupts by setting the interrupt mask. */
name|outl
argument_list|(
name|iobase
operator|+
name|INTMASK
argument_list|,
name|INTSTAT_RCC
operator||
name|INTSTAT_RQE
operator||
name|INTSTAT_OVW
operator||
name|INTSTAT_RXE
operator||
name|INTSTAT_TXC
operator||
name|INTSTAT_TCC
operator||
name|INTSTAT_TQE
operator||
name|INTSTAT_TXU
operator||
name|INTSTAT_CNT
operator||
comment|/*INTSTAT_GP2 |*/
name|INTSTAT_FATAL
operator||
name|INTSTAT_PTA
operator||
name|INTSTAT_PMA
operator||
name|INTSTAT_APE
operator||
name|INTSTAT_DPE
argument_list|)
expr_stmt|;
comment|/* Start rx process */
name|outl
argument_list|(
name|iobase
operator|+
name|COMMAND
argument_list|,
name|COMMAND_RXQUEUED
operator||
name|COMMAND_START_RX
argument_list|)
expr_stmt|;
comment|/* Mark interface running ... */
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_RUNNING
expr_stmt|;
else|else
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_RUNNING
expr_stmt|;
comment|/* ... and free */
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * This function should set EPIC's registers according IFF_* flags  */
end_comment

begin_function
specifier|static
name|void
name|epic_set_rx_mode
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|epic_if
decl_stmt|;
name|u_int16_t
name|rxcon
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
if|if
condition|(
name|sc
operator|->
name|epic_if
operator|.
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
name|rxcon
operator||=
name|RXCON_PROMISCUOUS_MODE
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sc
operator|->
name|epic_if
operator|.
name|if_flags
operator|&
name|IFF_BROADCAST
condition|)
name|rxcon
operator||=
name|RXCON_RECEIVE_BROADCAST_FRAMES
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|epic_if
operator|.
name|if_flags
operator|&
name|IFF_MULTICAST
condition|)
name|rxcon
operator||=
name|RXCON_RECEIVE_MULTICAST_FRAMES
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|RXCON
argument_list|,
name|rxcon
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * This function should set MII to mode specified by IFF_LINK* flags  */
end_comment

begin_function
specifier|static
name|void
name|epic_set_media_speed
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|epic_if
decl_stmt|;
name|u_int16_t
name|media
decl_stmt|;
name|u_int32_t
name|i
decl_stmt|;
comment|/* Set media speed */
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK0
condition|)
block|{
comment|/* Allow only manual fullduplex modes */
name|media
operator|=
name|epic_read_phy_register
argument_list|(
name|sc
operator|->
name|iobase
argument_list|,
name|DP83840_ANAR
argument_list|)
expr_stmt|;
name|media
operator||=
name|ANAR_100
operator||
name|ANAR_10
operator||
name|ANAR_100_FD
operator||
name|ANAR_10_FD
expr_stmt|;
name|epic_write_phy_register
argument_list|(
name|sc
operator|->
name|iobase
argument_list|,
name|DP83840_ANAR
argument_list|,
name|media
argument_list|)
expr_stmt|;
comment|/* Set mode */
name|media
operator|=
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK2
operator|)
condition|?
name|BMCR_100MBPS
else|:
literal|0
expr_stmt|;
name|media
operator||=
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK1
operator|)
condition|?
name|BMCR_FULL_DUPLEX
else|:
literal|0
expr_stmt|;
name|epic_write_phy_register
argument_list|(
name|sc
operator|->
name|iobase
argument_list|,
name|DP83840_BMCR
argument_list|,
name|media
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK2
operator|)
condition|?
literal|100000000
else|:
literal|10000000
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|TXCON
argument_list|,
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK1
operator|)
condition|?
name|TXCON_LOOPBACK_MODE_FULL_DUPLEX
operator||
name|TXCON_DEFAULT
else|:
name|TXCON_DEFAULT
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|EPIC_DEBUG
argument_list|)
name|printf
argument_list|(
literal|"tx%d: %dMbps %s\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK2
operator|)
condition|?
literal|100
else|:
literal|10
argument_list|,
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_LINK1
operator|)
condition|?
literal|"full-duplex"
else|:
literal|"half-duplex"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
comment|/* If autoneg is set, IFF_LINK flags are meaningless */
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
operator|(
name|IFF_LINK0
operator||
name|IFF_LINK1
operator||
name|IFF_LINK2
operator|)
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
literal|100000000
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|TXCON
argument_list|,
name|TXCON_DEFAULT
argument_list|)
expr_stmt|;
comment|/* Does not allow to autoneg fullduplex modes */
name|media
operator|=
name|epic_read_phy_register
argument_list|(
name|sc
operator|->
name|iobase
argument_list|,
name|DP83840_ANAR
argument_list|)
expr_stmt|;
name|media
operator|&=
operator|~
operator|(
name|ANAR_100
operator||
name|ANAR_100_FD
operator||
name|ANAR_10_FD
operator||
name|ANAR_10
operator|)
expr_stmt|;
name|media
operator||=
name|ANAR_100
operator||
name|ANAR_10
expr_stmt|;
name|epic_write_phy_register
argument_list|(
name|sc
operator|->
name|iobase
argument_list|,
name|DP83840_ANAR
argument_list|,
name|media
argument_list|)
expr_stmt|;
comment|/* Set and restart autoneg */
name|epic_write_phy_register
argument_list|(
name|sc
operator|->
name|iobase
argument_list|,
name|DP83840_BMCR
argument_list|,
name|BMCR_AUTONEGOTIATION
operator||
name|BMCR_RESTART_AUTONEG
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|EPIC_DEBUG
argument_list|)
name|printf
argument_list|(
literal|"tx%d: Autonegotiation\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  * This function sets EPIC multicast table  */
end_comment

begin_function
specifier|static
name|void
name|epic_set_mc_table
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|epic_if
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_MULTICAST
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|EPIC_DEBUG
argument_list|)
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
operator|)
condition|)
name|printf
argument_list|(
literal|"tx%d: WARNING! only receive all multicasts mode supported\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|MC0
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|MC1
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|MC2
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|MC3
argument_list|,
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*  *  This function should completely stop rx and tx processes  */
end_comment

begin_function
specifier|static
name|void
name|epic_stop
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|iobase
init|=
name|sc
operator|->
name|iobase
decl_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|INTMASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|GENCTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|COMMAND
argument_list|,
name|COMMAND_STOP_RX
operator||
name|COMMAND_STOP_TDMA
operator||
name|COMMAND_STOP_TDMA
argument_list|)
expr_stmt|;
name|sc
operator|->
name|epic_if
operator|.
name|if_timer
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize Rx ad Tx rings and give them to EPIC  *  * If RX_TO_MBUF option is enabled, mbuf cluster is allocated instead of  * static buffer.  */
end_comment

begin_function
specifier|static
name|void
name|epic_init_rings
parameter_list|(
name|epic_softc_t
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|sc
operator|->
name|cur_rx
operator|=
name|sc
operator|->
name|cur_tx
operator|=
name|sc
operator|->
name|dirty_tx
operator|=
name|sc
operator|->
name|pending_txs
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RX_RING_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|epic_rx_buffer
modifier|*
name|buf
init|=
name|sc
operator|->
name|rx_buffer
operator|+
name|i
decl_stmt|;
name|buf
operator|->
name|desc
operator|.
name|status
operator|=
literal|0x0000
expr_stmt|;
comment|/* Owned by Epic chip */
name|buf
operator|->
name|desc
operator|.
name|buflength
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|bufaddr
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|next
operator|=
name|vtophys
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|rx_buffer
index|[
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|RX_RING_SIZE
index|]
operator|.
name|desc
operator|)
argument_list|)
expr_stmt|;
name|buf
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|RX_TO_MBUF
argument_list|)
if|if
condition|(
name|buf
operator|->
name|pool
condition|)
block|{
name|free
argument_list|(
name|buf
operator|->
name|pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|buf
operator|->
name|pool
operator|=
name|buf
operator|->
name|data
operator|=
literal|0
expr_stmt|;
block|}
name|buf
operator|->
name|pool
operator|=
name|malloc
argument_list|(
name|ETHER_MAX_FRAME_LEN
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pool
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"tx%d: malloc failed\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|buf
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|buf
operator|->
name|pool
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|buf
operator|->
name|mbuf
condition|)
block|{
name|m_freem
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|)
expr_stmt|;
name|buf
operator|->
name|mbuf
operator|=
name|NULL
expr_stmt|;
block|}
name|MGETHDR
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|buf
operator|->
name|mbuf
condition|)
continue|continue;
name|MCLGET
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
operator|(
name|buf
operator|->
name|mbuf
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|buf
operator|->
name|data
operator|=
name|mtod
argument_list|(
name|buf
operator|->
name|mbuf
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|buf
operator|->
name|desc
operator|.
name|bufaddr
operator|=
name|vtophys
argument_list|(
name|buf
operator|->
name|data
argument_list|)
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|buflength
operator|=
name|ETHER_MAX_FRAME_LEN
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|status
operator|=
literal|0x8000
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TX_RING_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|epic_tx_buffer
modifier|*
name|buf
init|=
name|sc
operator|->
name|tx_buffer
operator|+
name|i
decl_stmt|;
name|buf
operator|->
name|desc
operator|.
name|status
operator|=
literal|0x0000
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|buflength
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|bufaddr
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|control
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|next
operator|=
name|vtophys
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|tx_buffer
index|[
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
name|TX_RING_SIZE
index|]
operator|.
name|desc
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pool
condition|)
block|{
name|free
argument_list|(
name|buf
operator|->
name|pool
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|buf
operator|->
name|pool
operator|=
name|buf
operator|->
name|data
operator|=
literal|0
expr_stmt|;
block|}
name|buf
operator|->
name|pool
operator|=
name|malloc
argument_list|(
name|ETHER_MAX_FRAME_LEN
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pool
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"tx%d: malloc failed\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|buf
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|buf
operator|->
name|pool
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|bufaddr
operator|=
name|vtophys
argument_list|(
name|buf
operator|->
name|data
argument_list|)
expr_stmt|;
name|buf
operator|->
name|desc
operator|.
name|buflength
operator|=
name|ETHER_MAX_FRAME_LEN
expr_stmt|;
block|}
comment|/* Give rings to EPIC */
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|PRCDAR
argument_list|,
name|vtophys
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|rx_buffer
index|[
literal|0
index|]
operator|.
name|desc
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|sc
operator|->
name|iobase
operator|+
name|PTCDAR
argument_list|,
name|vtophys
argument_list|(
operator|&
operator|(
name|sc
operator|->
name|tx_buffer
index|[
literal|0
index|]
operator|.
name|desc
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * EEPROM operation functions  */
end_comment

begin_function
specifier|static
name|void
name|epic_write_eepromreg
parameter_list|(
name|u_int16_t
name|regaddr
parameter_list|,
name|u_int8_t
name|val
parameter_list|)
block|{
name|u_int16_t
name|i
decl_stmt|;
name|outb
argument_list|(
name|regaddr
argument_list|,
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0xFF
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|inb
argument_list|(
name|regaddr
argument_list|)
operator|&
literal|0x20
operator|)
condition|)
break|break;
return|return;
block|}
end_function

begin_function
specifier|static
name|u_int8_t
name|epic_read_eepromreg
parameter_list|(
name|u_int16_t
name|regaddr
parameter_list|)
block|{
return|return
name|inb
argument_list|(
name|regaddr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int8_t
name|epic_eeprom_clock
parameter_list|(
name|u_int16_t
name|ioaddr
parameter_list|,
name|u_int8_t
name|val
parameter_list|)
block|{
name|epic_write_eepromreg
argument_list|(
name|ioaddr
operator|+
name|EECTL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|epic_write_eepromreg
argument_list|(
name|ioaddr
operator|+
name|EECTL
argument_list|,
operator|(
name|val
operator||
literal|0x4
operator|)
argument_list|)
expr_stmt|;
name|epic_write_eepromreg
argument_list|(
name|ioaddr
operator|+
name|EECTL
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|epic_read_eepromreg
argument_list|(
name|ioaddr
operator|+
name|EECTL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|epic_output_eepromw
parameter_list|(
name|u_int16_t
name|ioaddr
parameter_list|,
name|u_int16_t
name|val
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0xF
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
condition|)
name|epic_eeprom_clock
argument_list|(
name|ioaddr
argument_list|,
literal|0x0B
argument_list|)
expr_stmt|;
else|else
name|epic_eeprom_clock
argument_list|(
name|ioaddr
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u_int16_t
name|epic_input_eepromw
parameter_list|(
name|u_int16_t
name|ioaddr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|tmp
decl_stmt|;
name|u_int16_t
name|retval
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0xF
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|tmp
operator|=
name|epic_eeprom_clock
argument_list|(
name|ioaddr
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
literal|0x10
condition|)
block|{
name|retval
operator||=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
block|}
block|}
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|epic_read_eeprom
parameter_list|(
name|u_int16_t
name|ioaddr
parameter_list|,
name|u_int16_t
name|loc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int16_t
name|dataval
decl_stmt|;
name|u_int16_t
name|read_cmd
decl_stmt|;
name|epic_write_eepromreg
argument_list|(
name|ioaddr
operator|+
name|EECTL
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|epic_read_eepromreg
argument_list|(
name|ioaddr
operator|+
name|EECTL
argument_list|)
operator|&
literal|0x40
condition|)
name|read_cmd
operator|=
operator|(
name|loc
operator|&
literal|0x3F
operator|)
operator||
literal|0x180
expr_stmt|;
else|else
name|read_cmd
operator|=
operator|(
name|loc
operator|&
literal|0xFF
operator|)
operator||
literal|0x600
expr_stmt|;
name|epic_output_eepromw
argument_list|(
name|ioaddr
argument_list|,
name|read_cmd
argument_list|)
expr_stmt|;
name|dataval
operator|=
name|epic_input_eepromw
argument_list|(
name|ioaddr
argument_list|)
expr_stmt|;
name|epic_write_eepromreg
argument_list|(
name|ioaddr
operator|+
name|EECTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|dataval
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|epic_read_phy_register
parameter_list|(
name|u_int16_t
name|iobase
parameter_list|,
name|u_int16_t
name|loc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|MIICTL
argument_list|,
operator|(
operator|(
name|loc
operator|<<
literal|4
operator|)
operator||
literal|0x0601
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x1000
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|inl
argument_list|(
name|iobase
operator|+
name|MIICTL
argument_list|)
operator|&
literal|1
operator|)
condition|)
break|break;
return|return
name|inl
argument_list|(
name|iobase
operator|+
name|MIIDATA
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|epic_write_phy_register
parameter_list|(
name|u_int16_t
name|iobase
parameter_list|,
name|u_int16_t
name|loc
parameter_list|,
name|u_int16_t
name|val
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|MIIDATA
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|outl
argument_list|(
name|iobase
operator|+
name|MIICTL
argument_list|,
operator|(
operator|(
name|loc
operator|<<
literal|4
operator|)
operator||
literal|0x0602
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|0x1000
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|inl
argument_list|(
name|iobase
operator|+
name|MIICTL
argument_list|)
operator|&
literal|2
operator|)
condition|)
break|break;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI> 0 */
end_comment

end_unit


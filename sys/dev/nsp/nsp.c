begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NecBSD: nsp.c,v 1.21.12.6 2001/06/29 06:27:52 honda Exp $	*/
end_comment

begin_comment
comment|/*	$NetBSD$	*/
end_comment

begin_define
define|#
directive|define
name|NSP_DEBUG
end_define

begin_define
define|#
directive|define
name|NSP_STATICS
end_define

begin_define
define|#
directive|define
name|NSP_IO_CONTROL_FLAGS
define|\
value|(NSP_READ_SUSPEND_IO | NSP_WRITE_SUSPEND_IO | \ 	 NSP_READ_FIFO_INTERRUPTS | NSP_WRITE_FIFO_INTERRUPTS | \ 	 NSP_USE_MEMIO | NSP_WAIT_FOR_SELECT)
end_define

begin_comment
comment|/*-  *  Copyright (c) 1998, 1999, 2000, 2001  *	NetBSD/pc98 porting staff. All rights reserved.  *  *  Copyright (c) 1998, 1999, 2000, 2001  *	Naofumi HONDA. All rights reserved.  *   *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  3. The name of the author may not be used to endorse or promote products  *     derived from this software without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_low.h>
end_include

begin_include
include|#
directive|include
file|<dev/nsp/nspreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/nsp/nspvar.h>
end_include

begin_comment
comment|/***************************************************  * USER SETTINGS  ***************************************************/
end_comment

begin_comment
comment|/* DEVICE CONFIGURATION FLAGS (MINOR)  *  * 0x01   DISCONNECT OFF  * 0x02   PARITY LINE OFF  * 0x04   IDENTIFY MSG OFF ( = single lun)  * 0x08   SYNC TRANSFER OFF  */
end_comment

begin_comment
comment|/***************************************************  * PARAMS  ***************************************************/
end_comment

begin_define
define|#
directive|define
name|NSP_NTARGETS
value|8
end_define

begin_define
define|#
directive|define
name|NSP_NLUNS
value|8
end_define

begin_define
define|#
directive|define
name|NSP_MAX_DATA_SIZE
value|(64 * 1024)
end_define

begin_define
define|#
directive|define
name|NSP_SELTIMEOUT
value|(200)
end_define

begin_define
define|#
directive|define
name|NSP_DELAY_MAX
value|(2 * 1000 * 1000)
end_define

begin_define
define|#
directive|define
name|NSP_DELAY_INTERVAL
value|(1)
end_define

begin_define
define|#
directive|define
name|NSP_TIMER_1MS
value|(1000 / 51)
end_define

begin_comment
comment|/***************************************************  * DEBUG  ***************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|NSP_DEBUG
end_ifdef

begin_decl_stmt
name|int
name|nsp_debug
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NSP_DEBUG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|NSP_STATICS
end_ifdef

begin_struct
struct|struct
name|nsp_statics
block|{
name|int
name|arbit_conflict_1
decl_stmt|;
name|int
name|arbit_conflict_2
decl_stmt|;
name|int
name|device_data_write
decl_stmt|;
name|int
name|device_busy
decl_stmt|;
name|int
name|disconnect
decl_stmt|;
name|int
name|reselect
decl_stmt|;
name|int
name|data_phase_bypass
decl_stmt|;
block|}
name|nsp_statics
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NSP_STATICS */
end_comment

begin_comment
comment|/***************************************************  * IO control  ***************************************************/
end_comment

begin_define
define|#
directive|define
name|NSP_READ_SUSPEND_IO
value|0x0001
end_define

begin_define
define|#
directive|define
name|NSP_WRITE_SUSPEND_IO
value|0x0002
end_define

begin_define
define|#
directive|define
name|NSP_USE_MEMIO
value|0x0004
end_define

begin_define
define|#
directive|define
name|NSP_READ_FIFO_INTERRUPTS
value|0x0010
end_define

begin_define
define|#
directive|define
name|NSP_WRITE_FIFO_INTERRUPTS
value|0x0020
end_define

begin_define
define|#
directive|define
name|NSP_WAIT_FOR_SELECT
value|0x0100
end_define

begin_decl_stmt
name|u_int
name|nsp_io_control
init|=
name|NSP_IO_CONTROL_FLAGS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nsp_read_suspend_bytes
init|=
name|DEV_BSIZE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nsp_write_suspend_bytes
init|=
name|DEV_BSIZE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nsp_read_interrupt_bytes
init|=
literal|4096
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nsp_write_interrupt_bytes
init|=
literal|4096
decl_stmt|;
end_decl_stmt

begin_comment
comment|/***************************************************  * DEVICE STRUCTURE  ***************************************************/
end_comment

begin_decl_stmt
specifier|extern
name|struct
name|cfdriver
name|nsp_cd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**************************************************************  * DECLARE  **************************************************************/
end_comment

begin_define
define|#
directive|define
name|NSP_FIFO_ON
value|1
end_define

begin_define
define|#
directive|define
name|NSP_FIFO_OFF
value|0
end_define

begin_function_decl
specifier|static
name|void
name|nsp_pio_read
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsp_pio_write
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_xfer
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|u_int8_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_msg
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_reselected
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_disconnected
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsp_pdma_end
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsphw_init
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_target_nexus_establish
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_lun_nexus_establish
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_ccb_nexus_establish
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_world_start
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsphw_start_selection
parameter_list|(
name|struct
name|nsp_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsphw_bus_reset
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsphw_attention
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|nsp_fifo_count
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|nsp_request_count
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_negate_signal
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_expect_signal
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsp_start_timer
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsp_setup_fifo
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_targ_init
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsphw_selection_done_and_expect_msgout
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|nsp_data_padding
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_timeout
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_read_fifo
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_write_fifo
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_phase_match
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|nsp_wait_interrupt
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|scsi_low_funcs
name|nspfuncs
init|=
block|{
name|SC_LOW_INIT_T
name|nsp_world_start
block|,
name|SC_LOW_BUSRST_T
name|nsphw_bus_reset
block|,
name|SC_LOW_TARG_INIT_T
name|nsp_targ_init
block|,
name|SC_LOW_LUN_INIT_T
name|NULL
block|,
name|SC_LOW_SELECT_T
name|nsphw_start_selection
block|,
name|SC_LOW_NEXUS_T
name|nsp_lun_nexus_establish
block|,
name|SC_LOW_NEXUS_T
name|nsp_ccb_nexus_establish
block|,
name|SC_LOW_ATTEN_T
name|nsphw_attention
block|,
name|SC_LOW_MSG_T
name|nsp_msg
block|,
name|SC_LOW_TIMEOUT_T
name|nsp_timeout
block|,
name|SC_LOW_POLL_T
name|nspintr
block|,
name|NULL
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/****************************************************  * hwfuncs  ****************************************************/
end_comment

begin_function
specifier|static
name|__inline
name|uint8_t
name|nsp_cr_read_1
parameter_list|(
name|struct
name|resource
modifier|*
name|res
parameter_list|,
name|bus_addr_t
name|ofs
parameter_list|)
block|{
name|bus_write_1
argument_list|(
name|res
argument_list|,
name|nsp_idxr
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
return|return
name|bus_read_1
argument_list|(
name|res
argument_list|,
name|nsp_datar
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|nsp_cr_write_1
parameter_list|(
name|struct
name|resource
modifier|*
name|res
parameter_list|,
name|bus_addr_t
name|ofs
parameter_list|,
name|uint8_t
name|va
parameter_list|)
block|{
name|bus_write_1
argument_list|(
name|res
argument_list|,
name|nsp_idxr
argument_list|,
name|ofs
argument_list|)
expr_stmt|;
name|bus_write_1
argument_list|(
name|res
argument_list|,
name|nsp_datar
argument_list|,
name|va
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_expect_signal
parameter_list|(
name|struct
name|nsp_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
name|curphase
parameter_list|,
name|u_int8_t
name|mask
parameter_list|)
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|int
name|wc
decl_stmt|;
name|u_int8_t
name|ph
decl_stmt|,
name|isrc
decl_stmt|;
for|for
control|(
name|wc
operator|=
literal|0
init|;
name|wc
operator|<
name|NSP_DELAY_MAX
operator|/
name|NSP_DELAY_INTERVAL
condition|;
name|wc
operator|++
control|)
block|{
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph
operator|==
operator|(
name|u_int8_t
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|isrc
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqsr
argument_list|)
expr_stmt|;
if|if
condition|(
name|isrc
operator|&
name|IRQSR_SCSI
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|ph
operator|&
name|mask
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|ph
operator|&
name|SCBUSMON_PHMASK
operator|)
operator|==
name|curphase
condition|)
return|return
literal|1
return|;
name|DELAY
argument_list|(
name|NSP_DELAY_INTERVAL
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"nsp_expect_signal timeout\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsphw_init
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
comment|/* block all interrupts */
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_ALLMASK
argument_list|)
expr_stmt|;
comment|/* setup SCSI interface */
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_ifselr
argument_list|,
name|IFSELR_IFSEL
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCIENR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_XFERMR
argument_list|,
name|XFERMR_IO8
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_CLKDIVR
argument_list|,
name|sc
operator|->
name|sc_iclkdiv
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCIENR
argument_list|,
name|sc
operator|->
name|sc_icr
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PARITYR
argument_list|,
name|sc
operator|->
name|sc_parr
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PTCLRR
argument_list|,
name|PTCLRR_ACK
operator||
name|PTCLRR_REQ
operator||
name|PTCLRR_HOST
operator||
name|PTCLRR_RSS
argument_list|)
expr_stmt|;
comment|/* setup fifo asic */
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_ifselr
argument_list|,
name|IFSELR_REGSEL
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_TERMPWRC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_OCR
argument_list|)
operator|&
name|OCR_TERMPWRS
operator|)
operator|==
literal|0
condition|)
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_TERMPWRC
argument_list|,
name|TERMPWRC_POWON
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_XFERMR
argument_list|,
name|XFERMR_IO8
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_CLKDIVR
argument_list|,
name|sc
operator|->
name|sc_clkdiv
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_TIMERCNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_TIMERCNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SYNCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_ACKWIDTH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* enable interrupts and ack them */
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCIENR
argument_list|,
name|sc
operator|->
name|sc_icr
argument_list|)
expr_stmt|;
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQSR_MASK
argument_list|)
expr_stmt|;
name|nsp_setup_fifo
argument_list|(
name|sc
argument_list|,
name|NSP_FIFO_OFF
argument_list|,
name|SCSI_LOW_READ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************************  * scsi low interface  ****************************************************/
end_comment

begin_function
specifier|static
name|void
name|nsphw_attention
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int8_t
name|cr
decl_stmt|;
name|cr
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|)
comment|/*& ~SCBUSCR_ACK */
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|cr
operator||
name|SCBUSCR_ATN
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsphw_bus_reset
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_ALLMASK
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|SCBUSCR_RST
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* 100ms */
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_IRQPHS
argument_list|)
expr_stmt|;
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQSR_MASK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsphw_selection_done_and_expect_msgout
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
comment|/* clear ack counter */
name|sc
operator|->
name|sc_cnt
operator|=
literal|0
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PTCLRR
argument_list|,
name|PTCLRR_PT
operator||
name|PTCLRR_ACK
operator||
name|PTCLRR_REQ
operator||
name|PTCLRR_HOST
argument_list|)
expr_stmt|;
comment|/* deassert sel and assert atten */
name|sc
operator|->
name|sc_seltout
operator|=
literal|0
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|sc
operator|->
name|sc_busc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|sc
operator|->
name|sc_busc
operator||
name|SCBUSCR_ADIR
operator||
name|SCBUSCR_ACKEN
argument_list|)
expr_stmt|;
name|SCSI_LOW_ASSERT_ATN
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsphw_start_selection
parameter_list|(
name|sc
parameter_list|,
name|cb
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|cb
operator|->
name|ti
decl_stmt|;
specifier|register
name|u_int8_t
name|arbs
decl_stmt|,
name|ph
decl_stmt|;
name|int
name|wc
decl_stmt|;
name|wc
operator|=
name|sc
operator|->
name|sc_tmaxcnt
operator|=
name|cb
operator|->
name|ccb_tcmax
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
name|sc
operator|->
name|sc_dataout_timeout
operator|=
literal|0
expr_stmt|;
comment|/* check bus free */
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph
operator|!=
name|SCBUSMON_FREE
condition|)
block|{
ifdef|#
directive|ifdef
name|NSP_STATICS
name|nsp_statics
operator|.
name|arbit_conflict_1
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* NSP_STATICS */
return|return
name|SCSI_LOW_START_FAIL
return|;
block|}
comment|/* start arbitration */
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_ARBITS
argument_list|,
name|ARBITS_EXEC
argument_list|)
expr_stmt|;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_ARBSTART
argument_list|)
expr_stmt|;
do|do
block|{
comment|/* XXX: what a stupid chip! */
name|arbs
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_ARBITS
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|arbs
operator|&
operator|(
name|ARBITS_WIN
operator||
name|ARBITS_FAIL
operator|)
operator|)
operator|==
literal|0
operator|&&
name|wc
operator|--
operator|>
literal|0
condition|)
do|;
if|if
condition|(
operator|(
name|arbs
operator|&
name|ARBITS_WIN
operator|)
operator|==
literal|0
condition|)
block|{
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_ARBITS
argument_list|,
name|ARBITS_CLR
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NSP_STATICS
name|nsp_statics
operator|.
name|arbit_conflict_2
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* NSP_STATICS */
return|return
name|SCSI_LOW_START_FAIL
return|;
block|}
comment|/* assert select line */
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_SELSTART
argument_list|)
expr_stmt|;
name|scsi_low_arbit_win
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_DATA
argument_list|,
name|sc
operator|->
name|sc_idbit
operator||
operator|(
literal|1
operator|<<
name|ti
operator|->
name|ti_id
operator|)
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|SCBUSCR_SEL
operator||
name|SCBUSCR_BSY
operator||
name|sc
operator|->
name|sc_busc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|SCBUSCR_SEL
operator||
name|SCBUSCR_BSY
operator||
name|SCBUSCR_DOUT
operator||
name|sc
operator|->
name|sc_busc
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_ARBITS
argument_list|,
name|ARBITS_CLR
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|SCBUSCR_SEL
operator||
name|SCBUSCR_DOUT
operator||
name|sc
operator|->
name|sc_busc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nsp_io_control
operator|&
name|NSP_WAIT_FOR_SELECT
operator|)
operator|!=
literal|0
condition|)
block|{
define|#
directive|define
name|NSP_FIRST_SEL_WAIT
value|300
define|#
directive|define
name|NSP_SEL_CHECK_INTERVAL
value|10
comment|/* wait for a selection response */
for|for
control|(
name|wc
operator|=
literal|0
init|;
name|wc
operator|<
name|NSP_FIRST_SEL_WAIT
operator|/
name|NSP_SEL_CHECK_INTERVAL
condition|;
name|wc
operator|++
control|)
block|{
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ph
operator|&
name|SCBUSMON_BSY
operator|)
operator|==
literal|0
condition|)
block|{
name|DELAY
argument_list|(
name|NSP_SEL_CHECK_INTERVAL
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ph
operator|&
name|SCBUSMON_BSY
operator|)
operator|!=
literal|0
condition|)
block|{
name|nsphw_selection_done_and_expect_msgout
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_SELECTED
argument_list|)
expr_stmt|;
return|return
name|SCSI_LOW_START_OK
return|;
block|}
block|}
block|}
comment|/* check a selection timeout */
name|nsp_start_timer
argument_list|(
name|sc
argument_list|,
name|NSP_TIMER_1MS
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_seltout
operator|=
literal|1
expr_stmt|;
return|return
name|SCSI_LOW_START_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_world_start
parameter_list|(
name|sc
parameter_list|,
name|fdone
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|fdone
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|sc
operator|->
name|sc_cnt
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_seltout
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_NOATTEN
operator|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_busc
operator|=
name|SCBUSCR_ATN
expr_stmt|;
else|else
name|sc
operator|->
name|sc_busc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_NOPARITY
operator|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_parr
operator|=
name|PARITYR_ENABLE
operator||
name|PARITYR_CLEAR
expr_stmt|;
else|else
name|sc
operator|->
name|sc_parr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_icr
operator|=
operator|(
name|SCIENR_SCCHG
operator||
name|SCIENR_RESEL
operator||
name|SCIENR_RST
operator|)
expr_stmt|;
name|nsphw_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|scsi_low_bus_reset
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|ncp_synch_data
block|{
name|u_int
name|min_period
decl_stmt|;
name|u_int
name|max_period
decl_stmt|;
name|u_int
name|chip_period
decl_stmt|;
name|u_int
name|ack_width
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|ncp_synch_data
name|ncp_sync_data_40M
index|[]
init|=
block|{
block|{
literal|0x0c
block|,
literal|0x0c
block|,
literal|0x1
block|,
literal|0
block|}
block|,
comment|/* 20MB  50ns*/
block|{
literal|0x19
block|,
literal|0x19
block|,
literal|0x3
block|,
literal|1
block|}
block|,
comment|/* 10MB  100ns*/
block|{
literal|0x1a
block|,
literal|0x25
block|,
literal|0x5
block|,
literal|2
block|}
block|,
comment|/* 7.5MB 150ns*/
block|{
literal|0x26
block|,
literal|0x32
block|,
literal|0x7
block|,
literal|3
block|}
block|,
comment|/* 5MB   200ns*/
block|{
literal|0x0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ncp_synch_data
name|ncp_sync_data_20M
index|[]
init|=
block|{
block|{
literal|0x19
block|,
literal|0x19
block|,
literal|0x1
block|,
literal|0
block|}
block|,
comment|/* 10MB  100ns*/
block|{
literal|0x1a
block|,
literal|0x25
block|,
literal|0x2
block|,
literal|0
block|}
block|,
comment|/* 7.5MB 150ns*/
block|{
literal|0x26
block|,
literal|0x32
block|,
literal|0x3
block|,
literal|1
block|}
block|,
comment|/* 5MB   200ns*/
block|{
literal|0x0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|nsp_msg
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|,
name|msg
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|msg
decl_stmt|;
block|{
name|struct
name|ncp_synch_data
modifier|*
name|sdp
decl_stmt|;
name|struct
name|nsp_targ_info
modifier|*
name|nti
init|=
operator|(
name|void
operator|*
operator|)
name|ti
decl_stmt|;
name|u_int
name|period
decl_stmt|,
name|offset
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|&
name|SCSI_LOW_MSG_WIDE
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ti
operator|->
name|ti_width
operator|!=
name|SCSI_LOW_BUS_WIDTH_8
condition|)
block|{
name|ti
operator|->
name|ti_width
operator|=
name|SCSI_LOW_BUS_WIDTH_8
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|msg
operator|&
name|SCSI_LOW_MSG_SYNCH
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|period
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
expr_stmt|;
name|offset
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_iclkdiv
operator|==
name|CLKDIVR_20M
condition|)
name|sdp
operator|=
operator|&
name|ncp_sync_data_20M
index|[
literal|0
index|]
expr_stmt|;
else|else
name|sdp
operator|=
operator|&
name|ncp_sync_data_40M
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|sdp
operator|->
name|max_period
operator|!=
literal|0
condition|;
name|i
operator|++
operator|,
name|sdp
operator|++
control|)
block|{
if|if
condition|(
name|period
operator|>=
name|sdp
operator|->
name|min_period
operator|&&
name|period
operator|<=
name|sdp
operator|->
name|max_period
condition|)
break|break;
block|}
if|if
condition|(
name|period
operator|!=
literal|0
operator|&&
name|sdp
operator|->
name|max_period
operator|==
literal|0
condition|)
block|{
comment|/* 		 * NO proper period/offset found, 		 * Retry neg with the target. 		 */
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|nti
operator|->
name|nti_reg_syncr
operator|=
literal|0
expr_stmt|;
name|nti
operator|->
name|nti_reg_ackwidth
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
block|{
name|nti
operator|->
name|nti_reg_syncr
operator|=
operator|(
name|sdp
operator|->
name|chip_period
operator|<<
name|SYNCR_PERS
operator|)
operator||
operator|(
name|offset
operator|&
name|SYNCR_OFFM
operator|)
expr_stmt|;
name|nti
operator|->
name|nti_reg_ackwidth
operator|=
name|sdp
operator|->
name|ack_width
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SYNCR
argument_list|,
name|nti
operator|->
name|nti_reg_syncr
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_ACKWIDTH
argument_list|,
name|nti
operator|->
name|nti_reg_ackwidth
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_targ_init
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|,
name|action
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|int
name|action
decl_stmt|;
block|{
name|struct
name|nsp_targ_info
modifier|*
name|nti
init|=
operator|(
name|void
operator|*
operator|)
name|ti
decl_stmt|;
if|if
condition|(
name|action
operator|==
name|SCSI_LOW_INFO_ALLOC
operator|||
name|action
operator|==
name|SCSI_LOW_INFO_REVOKE
condition|)
block|{
name|ti
operator|->
name|ti_width
operator|=
name|SCSI_LOW_BUS_WIDTH_8
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|=
literal|100
operator|/
literal|4
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|=
literal|15
expr_stmt|;
name|nti
operator|->
name|nti_reg_syncr
operator|=
literal|0
expr_stmt|;
name|nti
operator|->
name|nti_reg_ackwidth
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsp_start_timer
parameter_list|(
name|sc
parameter_list|,
name|time
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|time
decl_stmt|;
block|{
name|sc
operator|->
name|sc_timer
operator|=
name|time
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_TIMERCNT
argument_list|,
name|time
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************  * General probe attach  **************************************************************/
end_comment

begin_function
name|int
name|nspprobesubr
parameter_list|(
name|struct
name|resource
modifier|*
name|res
parameter_list|,
name|u_int
name|dvcfg
parameter_list|)
block|{
name|u_int8_t
name|regv
decl_stmt|;
name|regv
operator|=
name|bus_read_1
argument_list|(
name|res
argument_list|,
name|nsp_fifosr
argument_list|)
expr_stmt|;
if|if
condition|(
name|regv
operator|<
literal|0x11
operator|||
name|regv
operator|>=
literal|0x20
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|nspattachsubr
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|sc
operator|->
name|sc_idbit
operator|=
operator|(
literal|1
operator|<<
name|slp
operator|->
name|sl_hostid
operator|)
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_READ_PADDING
expr_stmt|;
name|slp
operator|->
name|sl_funcs
operator|=
operator|&
name|nspfuncs
expr_stmt|;
name|sc
operator|->
name|sc_tmaxcnt
operator|=
name|SCSI_LOW_MIN_TOUT
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
comment|/* default */
operator|(
name|void
operator|)
name|scsi_low_attach
argument_list|(
name|slp
argument_list|,
literal|0
argument_list|,
name|NSP_NTARGETS
argument_list|,
name|NSP_NLUNS
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nsp_targ_info
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************  * PDMA functions  **************************************************************/
end_comment

begin_function
specifier|static
name|u_int
name|nsp_fifo_count
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int
name|count
decl_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PTCLRR
argument_list|,
name|PTCLRR_RSS_ACK
operator||
name|PTCLRR_PT
argument_list|)
expr_stmt|;
name|count
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_datar
argument_list|)
expr_stmt|;
name|count
operator|+=
operator|(
operator|(
operator|(
name|u_int
operator|)
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_datar
argument_list|)
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|count
operator|+=
operator|(
operator|(
operator|(
name|u_int
operator|)
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_datar
argument_list|)
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|nsp_request_count
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|u_int
name|count
decl_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PTCLRR
argument_list|,
name|PTCLRR_RSS_REQ
operator||
name|PTCLRR_PT
argument_list|)
expr_stmt|;
name|count
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_datar
argument_list|)
expr_stmt|;
name|count
operator|+=
operator|(
operator|(
operator|(
name|u_int
operator|)
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_datar
argument_list|)
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
name|count
operator|+=
operator|(
operator|(
operator|(
name|u_int
operator|)
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_datar
argument_list|)
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsp_setup_fifo
parameter_list|(
name|sc
parameter_list|,
name|on
parameter_list|,
name|direction
parameter_list|,
name|datalen
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|on
decl_stmt|;
name|int
name|direction
decl_stmt|;
name|int
name|datalen
decl_stmt|;
block|{
name|u_int8_t
name|xfermode
decl_stmt|;
name|sc
operator|->
name|sc_suspendio
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|NSP_FIFO_OFF
condition|)
block|{
name|xfermode
operator|=
name|XFERMR_IO8
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* check if suspend io OK ? */
if|if
condition|(
name|datalen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|SCSI_LOW_READ
condition|)
block|{
if|if
condition|(
operator|(
name|nsp_io_control
operator|&
name|NSP_READ_SUSPEND_IO
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|datalen
operator|%
name|nsp_read_suspend_bytes
operator|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_suspendio
operator|=
name|nsp_read_suspend_bytes
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|nsp_io_control
operator|&
name|NSP_WRITE_SUSPEND_IO
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|datalen
operator|%
name|nsp_write_suspend_bytes
operator|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_suspendio
operator|=
name|nsp_write_suspend_bytes
expr_stmt|;
block|}
block|}
comment|/* determine a transfer type */
if|if
condition|(
name|datalen
operator|<
name|DEV_BSIZE
operator|||
operator|(
name|datalen
operator|&
literal|3
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|!=
name|NULL
operator|&&
operator|(
name|nsp_io_control
operator|&
name|NSP_USE_MEMIO
operator|)
operator|!=
literal|0
condition|)
name|xfermode
operator|=
name|XFERMR_XEN
operator||
name|XFERMR_MEM8
expr_stmt|;
else|else
name|xfermode
operator|=
name|XFERMR_XEN
operator||
name|XFERMR_IO8
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|!=
name|NULL
operator|&&
operator|(
name|nsp_io_control
operator|&
name|NSP_USE_MEMIO
operator|)
operator|!=
literal|0
condition|)
name|xfermode
operator|=
name|XFERMR_XEN
operator||
name|XFERMR_MEM32
expr_stmt|;
else|else
name|xfermode
operator|=
name|XFERMR_XEN
operator||
name|XFERMR_IO32
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_suspendio
operator|>
literal|0
condition|)
name|xfermode
operator||=
name|XFERMR_FIFOEN
expr_stmt|;
block|}
name|out
label|:
name|sc
operator|->
name|sc_xfermr
operator|=
name|xfermode
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_XFERMR
argument_list|,
name|sc
operator|->
name|sc_xfermr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsp_pdma_end
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|u_int
name|len
init|=
literal|0
decl_stmt|,
name|cnt
decl_stmt|;
name|sc
operator|->
name|sc_dataout_timeout
operator|=
literal|0
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
name|HW_PDMASTART
expr_stmt|;
name|nsp_setup_fifo
argument_list|(
name|sc
argument_list|,
name|NSP_FIFO_OFF
argument_list|,
name|SCSI_LOW_READ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_icr
operator|&=
operator|~
name|SCIENR_FIFO
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCIENR
argument_list|,
name|sc
operator|->
name|sc_icr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ti
operator|->
name|ti_phase
operator|==
name|PH_DATA
condition|)
block|{
name|cnt
operator|=
name|nsp_fifo_count
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|==
name|SCSI_LOW_WRITE
condition|)
block|{
name|len
operator|=
name|sc
operator|->
name|sc_cnt
operator|-
name|cnt
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_cnt
operator|>=
name|cnt
operator|&&
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|+
name|len
operator|<=
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
condition|)
block|{
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
operator|-=
name|len
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"len %x>= datalen %x\n"
argument_list|,
name|len
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|==
name|SCSI_LOW_READ
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_cnt
operator|!=
name|cnt
operator|||
name|sc
operator|->
name|sc_cnt
operator|>
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"data read count error %x != %x (%x)\n"
argument_list|,
name|sc
operator|->
name|sc_cnt
argument_list|,
name|cnt
argument_list|,
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
argument_list|)
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|sc_cnt
operator|=
name|cnt
expr_stmt|;
name|scsi_low_data_finish
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"data phase miss\n"
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|RFIFO_CRIT
value|64
end_define

begin_define
define|#
directive|define
name|WFIFO_CRIT
value|32
end_define

begin_function
specifier|static
name|void
name|nsp_data_padding
parameter_list|(
name|sc
parameter_list|,
name|direction
parameter_list|,
name|count
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|direction
decl_stmt|;
name|u_int
name|count
decl_stmt|;
block|{
if|if
condition|(
name|count
operator|>
name|NSP_MAX_DATA_SIZE
condition|)
name|count
operator|=
name|NSP_MAX_DATA_SIZE
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_XFERMR
argument_list|,
name|XFERMR_XEN
operator||
name|XFERMR_IO8
argument_list|)
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|SCSI_LOW_READ
condition|)
block|{
while|while
condition|(
name|count
operator|--
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifodr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|count
operator|--
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifodr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_XFERMR
argument_list|,
name|sc
operator|->
name|sc_xfermr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_read_fifo
parameter_list|(
name|sc
parameter_list|,
name|suspendio
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|suspendio
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|u_int
name|res
decl_stmt|;
name|res
operator|=
name|nsp_fifo_count
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|sc
operator|->
name|sc_cnt
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|NSP_DEBUG
if|if
condition|(
name|res
operator|<
name|sc
operator|->
name|sc_cnt
operator|||
name|res
operator|==
operator|(
name|u_int
operator|)
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"strange fifo ack count 0x%x< 0x%x\n"
argument_list|,
name|res
argument_list|,
name|sc
operator|->
name|sc_cnt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* NSP_DEBUG */
name|res
operator|=
name|res
operator|-
name|sc
operator|->
name|sc_cnt
expr_stmt|;
if|if
condition|(
name|res
operator|>
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
condition|)
block|{
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_error
operator|&
name|PDMAERR
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"data overrun 0x%x> 0x%x\n"
argument_list|,
name|res
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
argument_list|)
expr_stmt|;
block|}
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_READ_PADDING
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"read padding required\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|nsp_data_padding
argument_list|(
name|sc
argument_list|,
name|SCSI_LOW_READ
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_cnt
operator|+=
name|res
expr_stmt|;
return|return
literal|1
return|;
comment|/* padding start */
block|}
if|if
condition|(
name|suspendio
operator|>
literal|0
operator|&&
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|>=
name|suspendio
condition|)
name|res
operator|=
name|suspendio
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_xfermr
operator|&
operator|(
name|XFERMR_MEM32
operator||
name|XFERMR_MEM8
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_xfermr
operator|&
name|XFERMR_MEM32
operator|)
operator|!=
literal|0
condition|)
block|{
name|res
operator|&=
operator|~
literal|3
expr_stmt|;
name|bus_read_region_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
literal|0
argument_list|,
operator|(
name|u_int32_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bus_read_region_1
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
literal|0
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_xfermr
operator|&
name|XFERMR_IO32
operator|)
operator|!=
literal|0
condition|)
block|{
name|res
operator|&=
operator|~
literal|3
expr_stmt|;
name|bus_read_multi_4
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifodr
argument_list|,
operator|(
name|u_int32_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bus_read_multi_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifodr
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PARITYR
argument_list|)
operator|&
name|PARITYR_PE
condition|)
block|{
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PARITYR
argument_list|,
name|PARITYR_ENABLE
operator||
name|PARITYR_CLEAR
argument_list|)
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|,
name|SCSI_LOW_MSG_ERROR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
operator|+=
name|res
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|-=
name|res
expr_stmt|;
name|sc
operator|->
name|sc_cnt
operator|+=
name|res
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_write_fifo
parameter_list|(
name|sc
parameter_list|,
name|suspendio
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|suspendio
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|u_int
name|res
decl_stmt|;
specifier|register
name|u_int8_t
name|stat
decl_stmt|;
if|if
condition|(
name|suspendio
operator|>
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|NSP_DEBUG
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|%
name|WFIFO_CRIT
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"strange write length 0x%x\n"
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* NSP_DEBUG */
name|res
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|%
name|suspendio
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
name|res
operator|=
name|suspendio
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
name|WFIFO_CRIT
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|>
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
condition|)
name|res
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
expr_stmt|;
comment|/* XXX: reconfirm! */
name|stat
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
operator|&
name|SCBUSMON_PHMASK
expr_stmt|;
if|if
condition|(
name|stat
operator|!=
name|PHASE_DATAOUT
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_xfermr
operator|&
operator|(
name|XFERMR_MEM32
operator||
name|XFERMR_MEM8
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_xfermr
operator|&
name|XFERMR_MEM32
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_write_region_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
literal|0
argument_list|,
operator|(
name|u_int32_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bus_write_region_1
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
literal|0
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_xfermr
operator|&
name|XFERMR_IO32
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_write_multi_4
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifodr
argument_list|,
operator|(
name|u_int32_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bus_write_multi_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifodr
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
block|}
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|-=
name|res
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
operator|+=
name|res
expr_stmt|;
name|sc
operator|->
name|sc_cnt
operator|+=
name|res
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_wait_interrupt
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|int
name|tout
decl_stmt|;
specifier|register
name|u_int8_t
name|isrc
decl_stmt|;
for|for
control|(
name|tout
operator|=
literal|0
init|;
name|tout
operator|<
name|DEV_BSIZE
operator|/
literal|10
condition|;
name|tout
operator|++
control|)
block|{
name|isrc
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqsr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isrc
operator|&
operator|(
name|IRQSR_SCSI
operator||
name|IRQSR_FIFO
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_FIFO
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_FIFOCL
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nsp_pio_read
parameter_list|(
name|sc
parameter_list|,
name|suspendio
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|suspendio
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|int
name|tout
decl_stmt|,
name|padding
decl_stmt|,
name|datalen
decl_stmt|;
specifier|register
name|u_int8_t
name|stat
decl_stmt|,
name|fstat
decl_stmt|;
name|padding
operator|=
literal|0
expr_stmt|;
name|tout
operator|=
name|sc
operator|->
name|sc_tmaxcnt
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_PDMASTART
expr_stmt|;
name|datalen
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
expr_stmt|;
name|ReadLoop
label|:
while|while
condition|(
literal|1
condition|)
block|{
name|stat
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|==
operator|(
name|u_int8_t
operator|)
operator|-
literal|1
condition|)
return|return;
comment|/* out of data phase */
if|if
condition|(
operator|(
name|stat
operator|&
name|SCBUSMON_PHMASK
operator|)
operator|!=
name|PHASE_DATAIN
condition|)
block|{
name|nsp_read_fifo
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* data phase */
name|fstat
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifosr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fstat
operator|&
name|FIFOSR_FULLEMP
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_FIFOCL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|suspendio
operator|>
literal|0
condition|)
block|{
name|padding
operator||=
name|nsp_read_fifo
argument_list|(
name|sc
argument_list|,
name|suspendio
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|padding
operator||=
name|nsp_read_fifo
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
name|padding
operator|==
literal|0
operator|&&
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|<=
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|--
name|tout
operator|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"nsp_pio_read: timeout\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|>
literal|0
operator|&&
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|>
name|datalen
operator|-
name|nsp_read_interrupt_bytes
condition|)
block|{
if|if
condition|(
name|nsp_wait_interrupt
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|ReadLoop
goto|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nsp_pio_write
parameter_list|(
name|sc
parameter_list|,
name|suspendio
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|suspendio
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|u_int
name|rcount
decl_stmt|,
name|acount
decl_stmt|;
name|int
name|tout
decl_stmt|,
name|datalen
decl_stmt|;
specifier|register
name|u_int8_t
name|stat
decl_stmt|,
name|fstat
decl_stmt|;
name|tout
operator|=
name|sc
operator|->
name|sc_tmaxcnt
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_PDMASTART
expr_stmt|;
name|datalen
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
expr_stmt|;
name|WriteLoop
label|:
while|while
condition|(
literal|1
condition|)
block|{
name|stat
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
operator|&
name|SCBUSMON_PHMASK
expr_stmt|;
if|if
condition|(
name|stat
operator|!=
name|PHASE_DATAOUT
condition|)
return|return;
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_dataout_timeout
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_dataout_timeout
operator|=
name|SCSI_LOW_TIMEOUT_HZ
expr_stmt|;
return|return;
block|}
name|fstat
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifosr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fstat
operator|&
name|FIFOSR_FULLEMP
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_FIFOCL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|suspendio
operator|>
literal|0
condition|)
block|{
comment|/* XXX:IMPORTANT: 				 * To avoid timeout of pcmcia bus 				 * (not scsi bus!), we should check 				 * the scsi device sends us request 				 * signals, which means the scsi device 				 * is ready to recieve data without 				 * heavy delays.  				 */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|%
name|suspendio
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Step I: 					 * fill the nsp fifo, and waiting for 					 * the fifo empty. 					 */
name|nsp_write_fifo
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Step II: 					 * check the request singals. 					 */
name|acount
operator|=
name|nsp_fifo_count
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rcount
operator|=
name|nsp_request_count
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcount
operator|<=
name|acount
condition|)
block|{
name|nsp_write_fifo
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NSP_STATICS
name|nsp_statics
operator|.
name|device_busy
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* NSP_STATICS */
block|}
else|else
block|{
name|nsp_write_fifo
argument_list|(
name|sc
argument_list|,
name|suspendio
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NSP_STATICS
name|nsp_statics
operator|.
name|device_data_write
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* NSP_STATICS */
block|}
block|}
block|}
else|else
block|{
name|nsp_write_fifo
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|--
name|tout
operator|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"nsp_pio_write: timeout\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|>
literal|0
operator|&&
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|>
name|datalen
operator|-
name|nsp_write_interrupt_bytes
condition|)
block|{
if|if
condition|(
name|nsp_wait_interrupt
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|WriteLoop
goto|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_negate_signal
parameter_list|(
name|struct
name|nsp_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
name|mask
parameter_list|,
name|u_char
modifier|*
name|s
parameter_list|)
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|int
name|wc
decl_stmt|;
name|u_int8_t
name|regv
decl_stmt|;
for|for
control|(
name|wc
operator|=
literal|0
init|;
name|wc
operator|<
name|NSP_DELAY_MAX
operator|/
name|NSP_DELAY_INTERVAL
condition|;
name|wc
operator|++
control|)
block|{
name|regv
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
name|regv
operator|==
operator|(
name|u_int8_t
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|regv
operator|&
name|mask
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|DELAY
argument_list|(
name|NSP_DELAY_INTERVAL
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"%s nsp_negate_signal timeout\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_xfer
parameter_list|(
name|sc
parameter_list|,
name|buf
parameter_list|,
name|len
parameter_list|,
name|phase
parameter_list|,
name|clear_atn
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|u_int8_t
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|phase
decl_stmt|;
name|int
name|clear_atn
decl_stmt|;
block|{
name|int
name|ptr
decl_stmt|,
name|rv
decl_stmt|;
for|for
control|(
name|ptr
operator|=
literal|0
init|;
name|len
operator|>
literal|0
condition|;
name|len
operator|--
operator|,
name|ptr
operator|++
control|)
block|{
name|rv
operator|=
name|nsp_expect_signal
argument_list|(
name|sc
argument_list|,
name|phase
argument_list|,
name|SCBUSMON_REQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|len
operator|==
literal|1
operator|&&
name|clear_atn
operator|!=
literal|0
condition|)
block|{
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|SCBUSCR_ADIR
operator||
name|SCBUSCR_ACKEN
argument_list|)
expr_stmt|;
name|SCSI_LOW_DEASSERT_ATN
argument_list|(
operator|&
name|sc
operator|->
name|sc_sclow
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phase
operator|&
name|SCBUSMON_IO
condition|)
block|{
name|buf
index|[
name|ptr
index|]
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_DATAACK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_DATAACK
argument_list|,
name|buf
index|[
name|ptr
index|]
argument_list|)
expr_stmt|;
block|}
name|nsp_negate_signal
argument_list|(
name|sc
argument_list|,
name|SCBUSMON_ACK
argument_list|,
literal|"xfer<ACK>"
argument_list|)
expr_stmt|;
block|}
name|out
label|:
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * disconnect& reselect (HW low)  **************************************************************/
end_comment

begin_function
specifier|static
name|int
name|nsp_reselected
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|sid
decl_stmt|;
name|u_int8_t
name|cr
decl_stmt|;
name|sid
operator|=
operator|(
name|u_int
operator|)
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_RESELR
argument_list|)
expr_stmt|;
name|sid
operator|&=
operator|~
name|sc
operator|->
name|sc_idbit
expr_stmt|;
name|sid
operator|=
name|ffs
argument_list|(
name|sid
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|ti
operator|=
name|scsi_low_reselected
argument_list|(
name|slp
argument_list|,
name|sid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|EJUSTRETURN
return|;
name|nsp_negate_signal
argument_list|(
name|sc
argument_list|,
name|SCBUSMON_SEL
argument_list|,
literal|"reselect<SEL>"
argument_list|)
expr_stmt|;
name|cr
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|)
expr_stmt|;
name|cr
operator|&=
operator|~
operator|(
name|SCBUSCR_BSY
operator||
name|SCBUSCR_ATN
operator|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|cr
argument_list|)
expr_stmt|;
name|cr
operator||=
name|SCBUSCR_ADIR
operator||
name|SCBUSCR_ACKEN
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|cr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NSP_STATICS
name|nsp_statics
operator|.
name|reselect
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* NSP_STATCIS */
return|return
name|EJUSTRETURN
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_disconnected
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PTCLRR
argument_list|,
name|PTCLRR_PT
operator||
name|PTCLRR_ACK
operator||
name|PTCLRR_REQ
operator||
name|PTCLRR_HOST
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icr
operator|&
name|SCIENR_FIFO
operator|)
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_icr
operator|&=
operator|~
name|SCIENR_FIFO
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCIENR
argument_list|,
name|sc
operator|->
name|sc_icr
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|sc_cnt
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_dataout_timeout
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|NSP_STATICS
name|nsp_statics
operator|.
name|disconnect
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* NSP_STATICS */
name|scsi_low_disconnected
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * SEQUENCER  **************************************************************/
end_comment

begin_function_decl
specifier|static
name|void
name|nsp_error
parameter_list|(
name|struct
name|nsp_softc
modifier|*
parameter_list|,
name|u_char
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|nsp_error
parameter_list|(
name|struct
name|nsp_softc
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|s
parameter_list|,
name|u_int8_t
name|isrc
parameter_list|,
name|u_int8_t
name|ph
parameter_list|,
name|u_int8_t
name|irqphs
parameter_list|)
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"%s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"isrc 0x%x scmon 0x%x irqphs 0x%x\n"
argument_list|,
operator|(
name|u_int
operator|)
name|isrc
argument_list|,
operator|(
name|u_int
operator|)
name|ph
argument_list|,
operator|(
name|u_int
operator|)
name|irqphs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_target_nexus_establish
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|struct
name|nsp_targ_info
modifier|*
name|nti
init|=
operator|(
name|void
operator|*
operator|)
name|ti
decl_stmt|;
comment|/* setup synch transfer registers */
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SYNCR
argument_list|,
name|nti
operator|->
name|nti_reg_syncr
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_ACKWIDTH
argument_list|,
name|nti
operator|->
name|nti_reg_ackwidth
argument_list|)
expr_stmt|;
comment|/* setup pdma fifo (minimum) */
name|nsp_setup_fifo
argument_list|(
name|sc
argument_list|,
name|NSP_FIFO_ON
argument_list|,
name|SCSI_LOW_READ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_lun_nexus_establish
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_ccb_nexus_establish
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|sc
operator|->
name|sc_tmaxcnt
operator|=
name|cb
operator|->
name|ccb_tcmax
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
comment|/* setup pdma fifo */
name|nsp_setup_fifo
argument_list|(
name|sc
argument_list|,
name|NSP_FIFO_ON
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|==
name|SCSI_LOW_READ
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_suspendio
operator|>
literal|0
operator|&&
operator|(
name|nsp_io_control
operator|&
name|NSP_READ_FIFO_INTERRUPTS
operator|)
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_icr
operator||=
name|SCIENR_FIFO
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCIENR
argument_list|,
name|sc
operator|->
name|sc_icr
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|sc_suspendio
operator|>
literal|0
operator|&&
operator|(
name|nsp_io_control
operator|&
name|NSP_WRITE_FIFO_INTERRUPTS
operator|)
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_icr
operator||=
name|SCIENR_FIFO
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCIENR
argument_list|,
name|sc
operator|->
name|sc_icr
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_phase_match
parameter_list|(
name|struct
name|nsp_softc
modifier|*
name|sc
parameter_list|,
name|u_int8_t
name|phase
parameter_list|,
name|u_int8_t
name|stat
parameter_list|)
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
if|if
condition|(
operator|(
name|stat
operator|&
name|SCBUSMON_PHMASK
operator|)
operator|!=
name|phase
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"phase mismatch 0x%x != 0x%x\n"
argument_list|,
operator|(
name|u_int
operator|)
name|phase
argument_list|,
operator|(
name|u_int
operator|)
name|stat
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|stat
operator|&
name|SCBUSMON_REQ
operator|)
operator|==
literal|0
condition|)
return|return
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|nspintr
parameter_list|(
name|arg
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|struct
name|nsp_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|u_int
name|derror
decl_stmt|,
name|flags
decl_stmt|;
name|int
name|len
decl_stmt|,
name|rv
decl_stmt|;
name|u_int8_t
name|isrc
decl_stmt|,
name|ph
decl_stmt|,
name|irqphs
decl_stmt|,
name|cr
decl_stmt|,
name|regv
decl_stmt|;
comment|/******************************************* 	 * interrupt check 	 *******************************************/
if|if
condition|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_INACTIVE
condition|)
return|return
literal|0
return|;
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_IRQDIS
argument_list|)
expr_stmt|;
name|isrc
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqsr
argument_list|)
expr_stmt|;
if|if
condition|(
name|isrc
operator|==
operator|(
name|u_int8_t
operator|)
operator|-
literal|1
operator|||
operator|(
name|isrc
operator|&
name|IRQSR_MASK
operator|)
operator|==
literal|0
condition|)
block|{
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* XXX: IMPORTANT  	 * Do not read an irqphs register if no scsi phase interrupt. 	 * Unless, you should lose a scsi phase interrupt. 	 */
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_SCSI
operator|)
operator|!=
literal|0
condition|)
block|{
name|irqphs
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_IRQPHS
argument_list|)
expr_stmt|;
block|}
else|else
name|irqphs
operator|=
literal|0
expr_stmt|;
comment|/*  	 * timer interrupt handler (scsi vs timer interrupts) 	 */
if|if
condition|(
name|sc
operator|->
name|sc_timer
operator|!=
literal|0
condition|)
block|{
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_TIMERCNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_TIMERCNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_timer
operator|=
literal|0
expr_stmt|;
block|}
comment|/* check a timer interrupt */
name|regv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_TIMER
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_MASK
operator|)
operator|==
name|IRQSR_TIMER
operator|&&
name|sc
operator|->
name|sc_seltout
operator|==
literal|0
condition|)
block|{
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_TIMERCL
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|regv
operator||=
name|IRQCR_TIMERCL
expr_stmt|;
block|}
comment|/* check a fifo interrupt */
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_FIFO
operator|)
operator|!=
literal|0
condition|)
block|{
name|regv
operator||=
name|IRQCR_FIFOCL
expr_stmt|;
block|}
comment|/* OK. enable all interrupts */
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|regv
argument_list|)
expr_stmt|;
comment|/******************************************* 	 * debug section 	 *******************************************/
ifdef|#
directive|ifdef
name|NSP_DEBUG
if|if
condition|(
name|nsp_debug
condition|)
block|{
name|nsp_error
argument_list|(
name|sc
argument_list|,
literal|"current status"
argument_list|,
name|isrc
argument_list|,
name|ph
argument_list|,
name|irqphs
argument_list|)
expr_stmt|;
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|KDB
if|if
condition|(
name|nsp_debug
operator|>
literal|1
condition|)
name|kdb_enter
argument_list|(
name|KDB_WHY_CAM
argument_list|,
literal|"nsp"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KDB */
block|}
endif|#
directive|endif
comment|/* NSP_DEBUG */
comment|/******************************************* 	 * Parse hardware SCSI irq reasons register 	 *******************************************/
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_SCSI
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|irqphs
operator|&
name|IRQPHS_RST
operator|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_restart
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_SOFT
argument_list|,
literal|"bus reset (power off?)"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|irqphs
operator|&
name|IRQPHS_RSEL
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_RESCL
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsp_reselected
argument_list|(
name|sc
argument_list|)
operator|==
name|EJUSTRETURN
condition|)
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|irqphs
operator|&
operator|(
name|IRQPHS_PCHG
operator||
name|IRQPHS_LBF
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
comment|/******************************************* 	 * nexus check 	 *******************************************/
if|if
condition|(
operator|(
name|ti
operator|=
name|slp
operator|->
name|sl_Tnexus
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* unknown scsi phase changes */
name|nsp_error
argument_list|(
name|sc
argument_list|,
literal|"unknown scsi phase changes"
argument_list|,
name|isrc
argument_list|,
name|ph
argument_list|,
name|irqphs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/******************************************* 	 * aribitration& selection 	 *******************************************/
switch|switch
condition|(
name|ti
operator|->
name|ti_phase
condition|)
block|{
case|case
name|PH_SELSTART
case|:
if|if
condition|(
operator|(
name|ph
operator|&
name|SCBUSMON_BSY
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_seltout
operator|>=
name|NSP_SELTIMEOUT
condition|)
block|{
name|sc
operator|->
name|sc_seltout
operator|=
literal|0
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|nsp_disconnected
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
return|;
block|}
name|sc
operator|->
name|sc_seltout
operator|++
expr_stmt|;
name|nsp_start_timer
argument_list|(
name|sc
argument_list|,
name|NSP_TIMER_1MS
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_SELECTED
argument_list|)
expr_stmt|;
name|nsphw_selection_done_and_expect_msgout
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
case|case
name|PH_SELECTED
case|:
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_SCSI
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|nsp_target_nexus_establish
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|PH_RESEL
case|:
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_SCSI
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|nsp_target_nexus_establish
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ph
operator|&
name|SCBUSMON_PHMASK
operator|)
operator|!=
name|PHASE_MSGIN
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"unexpected phase after reselect\n"
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
break|break;
case|case
name|PH_DATA
case|:
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_SCSI
operator|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_FIFO
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|NSP_IS_PHASE_DATA
argument_list|(
name|ph
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|irqphs
operator|=
operator|(
name|ph
operator|&
name|IRQPHS_PHMASK
operator|)
expr_stmt|;
break|break;
block|}
return|return
literal|1
return|;
default|default:
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_SCSI
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
break|break;
block|}
comment|/******************************************* 	 * data phase control  	 *******************************************/
if|if
condition|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_PDMASTART
condition|)
block|{
if|if
condition|(
operator|(
name|isrc
operator|&
name|IRQSR_SCSI
operator|)
operator|!=
literal|0
operator|&&
name|NSP_IS_IRQPHS_DATA
argument_list|(
name|irqphs
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|==
name|SCSI_LOW_READ
condition|)
name|nsp_pio_read
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nsp_pdma_end
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
expr_stmt|;
block|}
block|}
comment|/******************************************* 	 * scsi seq 	 *******************************************/
if|if
condition|(
name|slp
operator|->
name|sl_msgphase
operator|!=
literal|0
operator|&&
operator|(
name|irqphs
operator|&
name|IRQPHS_LBF
operator|)
operator|!=
literal|0
condition|)
return|return
name|nsp_disconnected
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
return|;
comment|/* check unexpected bus free state */
if|if
condition|(
name|ph
operator|==
literal|0
condition|)
block|{
name|nsp_error
argument_list|(
name|sc
argument_list|,
literal|"unexpected bus free"
argument_list|,
name|isrc
argument_list|,
name|ph
argument_list|,
name|irqphs
argument_list|)
expr_stmt|;
return|return
name|nsp_disconnected
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
return|;
block|}
comment|/* check normal scsi phase */
switch|switch
condition|(
name|irqphs
operator|&
name|IRQPHS_PHMASK
condition|)
block|{
case|case
name|IRQPHS_CMD
case|:
if|if
condition|(
name|nsp_phase_match
argument_list|(
name|sc
argument_list|,
name|PHASE_CMD
argument_list|,
name|ph
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_CMD
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_cmd
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_CMDCR
argument_list|,
name|CMDCR_PTCLR
argument_list|)
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmdlen
condition|;
name|len
operator|++
control|)
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_CMDDR
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmd
index|[
name|len
index|]
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_CMDCR
argument_list|,
name|CMDCR_PTCLR
operator||
name|CMDCR_EXEC
argument_list|)
expr_stmt|;
break|break;
case|case
name|IRQPHS_DATAOUT
case|:
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_data
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
operator|&
name|bp
argument_list|,
name|SCSI_LOW_WRITE
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
name|nsp_pio_write
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_suspendio
argument_list|)
expr_stmt|;
break|break;
case|case
name|IRQPHS_DATAIN
case|:
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_data
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
operator|&
name|bp
argument_list|,
name|SCSI_LOW_READ
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
name|nsp_pio_read
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_suspendio
argument_list|)
expr_stmt|;
break|break;
case|case
name|IRQPHS_STATUS
case|:
if|if
condition|(
name|nsp_phase_match
argument_list|(
name|sc
argument_list|,
name|PHASE_STATUS
argument_list|,
name|ph
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_STAT
argument_list|)
expr_stmt|;
name|regv
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PARITYR
argument_list|)
operator|&
name|PARITYR_PE
condition|)
block|{
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PARITYR
argument_list|,
name|PARITYR_ENABLE
operator||
name|PARITYR_CLEAR
argument_list|)
expr_stmt|;
name|derror
operator|=
name|SCSI_LOW_DATA_PE
expr_stmt|;
block|}
else|else
name|derror
operator|=
literal|0
expr_stmt|;
comment|/* assert ACK */
name|cr
operator|=
name|SCBUSCR_ACK
operator||
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|cr
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_statusin
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|derror
operator||
name|regv
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
comment|/* check REQ nagated */
name|nsp_negate_signal
argument_list|(
name|sc
argument_list|,
name|SCBUSMON_REQ
argument_list|,
literal|"statin<REQ>"
argument_list|)
expr_stmt|;
comment|/* deassert ACK */
name|cr
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|)
operator|&
operator|(
operator|~
name|SCBUSCR_ACK
operator|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|cr
argument_list|)
expr_stmt|;
break|break;
case|case
name|IRQPHS_MSGOUT
case|:
if|if
condition|(
name|nsp_phase_match
argument_list|(
name|sc
argument_list|,
name|PHASE_MSGOUT
argument_list|,
name|ph
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
ifdef|#
directive|ifdef
name|NSP_MSGOUT_SERIALIZE
comment|/* 		 * XXX: NSP QUIRK 		 * NSP invoke interrupts only in the case of scsi phase changes, 		 * therefore we should poll the scsi phase here to catch  		 * the next "msg out" if exists (no scsi phase changes). 		 */
name|rv
operator|=
name|len
operator|=
literal|16
expr_stmt|;
do|do
block|{
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_MSGOUT
argument_list|)
expr_stmt|;
name|flags
operator|=
operator|(
name|ti
operator|->
name|ti_ophase
operator|!=
name|ti
operator|->
name|ti_phase
operator|)
condition|?
name|SCSI_LOW_MSGOUT_INIT
else|:
literal|0
expr_stmt|;
name|len
operator|=
name|scsi_low_msgout
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|slp
operator|->
name|sl_atten
operator|==
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsp_xfer
argument_list|(
name|sc
argument_list|,
name|ti
operator|->
name|ti_msgoutstr
argument_list|,
name|len
argument_list|,
name|PHASE_MSGOUT
argument_list|,
name|slp
operator|->
name|sl_clear_atten
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|nsp_error
argument_list|(
name|sc
argument_list|,
literal|"MSGOUT: xfer short"
argument_list|,
name|isrc
argument_list|,
name|ph
argument_list|,
name|irqphs
argument_list|)
expr_stmt|;
block|}
comment|/* catch a next signal */
name|rv
operator|=
name|nsp_expect_signal
argument_list|(
name|sc
argument_list|,
name|PHASE_MSGOUT
argument_list|,
name|SCBUSMON_REQ
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|rv
operator|>
literal|0
operator|&&
name|len
operator|--
operator|>
literal|0
condition|)
do|;
else|#
directive|else
comment|/* !NSP_MSGOUT_SERIALIZE */
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_MSGOUT
argument_list|)
expr_stmt|;
name|flags
operator|=
name|SCSI_LOW_MSGOUT_UNIFY
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_ophase
operator|!=
name|ti
operator|->
name|ti_phase
condition|)
name|flags
operator||=
name|SCSI_LOW_MSGOUT_INIT
expr_stmt|;
name|len
operator|=
name|scsi_low_msgout
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|slp
operator|->
name|sl_atten
operator|==
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsp_xfer
argument_list|(
name|sc
argument_list|,
name|ti
operator|->
name|ti_msgoutstr
argument_list|,
name|len
argument_list|,
name|PHASE_MSGOUT
argument_list|,
name|slp
operator|->
name|sl_clear_atten
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|nsp_error
argument_list|(
name|sc
argument_list|,
literal|"MSGOUT: xfer short"
argument_list|,
name|isrc
argument_list|,
name|ph
argument_list|,
name|irqphs
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* !NSP_MSGOUT_SERIALIZE */
break|break;
case|case
name|IRQPHS_MSGIN
case|:
if|if
condition|(
name|nsp_phase_match
argument_list|(
name|sc
argument_list|,
name|PHASE_MSGIN
argument_list|,
name|ph
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
comment|/* 		 * XXX: NSP QUIRK 		 * NSP invoke interrupts only in the case of scsi phase changes, 		 * therefore we should poll the scsi phase here to catch  		 * the next "msg in" if exists (no scsi phase changes). 		 */
name|rv
operator|=
name|len
operator|=
literal|16
expr_stmt|;
do|do
block|{
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_MSGIN
argument_list|)
expr_stmt|;
comment|/* read a data */
name|regv
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PARITYR
argument_list|)
operator|&
name|PARITYR_PE
condition|)
block|{
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_PARITYR
argument_list|,
name|PARITYR_ENABLE
operator||
name|PARITYR_CLEAR
argument_list|)
expr_stmt|;
name|derror
operator|=
name|SCSI_LOW_DATA_PE
expr_stmt|;
block|}
else|else
block|{
name|derror
operator|=
literal|0
expr_stmt|;
block|}
comment|/* assert ack */
name|cr
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|)
operator||
name|SCBUSCR_ACK
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|cr
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_msgin
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|regv
operator||
name|derror
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|scsi_low_is_msgout_continue
argument_list|(
name|ti
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* check REQ nagated */
name|nsp_negate_signal
argument_list|(
name|sc
argument_list|,
name|SCBUSMON_REQ
argument_list|,
literal|"msgin<REQ>"
argument_list|)
expr_stmt|;
comment|/* deassert ack */
name|cr
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|)
operator|&
operator|(
operator|~
name|SCBUSCR_ACK
operator|)
expr_stmt|;
name|nsp_cr_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSCR
argument_list|,
name|cr
argument_list|)
expr_stmt|;
comment|/* catch a next signal */
name|rv
operator|=
name|nsp_expect_signal
argument_list|(
name|sc
argument_list|,
name|PHASE_MSGIN
argument_list|,
name|SCBUSMON_REQ
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|rv
operator|>
literal|0
operator|&&
name|len
operator|--
operator|>
literal|0
condition|)
do|;
break|break;
default|default:
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|nsp_error
argument_list|(
name|sc
argument_list|,
literal|"unknown scsi phase"
argument_list|,
name|isrc
argument_list|,
name|ph
argument_list|,
name|irqphs
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|1
return|;
if|#
directive|if
literal|0
block|timerout: 	nsp_start_timer(sc, NSP_TIMER_1MS); 	return 0;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|nsp_timeout
parameter_list|(
name|sc
parameter_list|)
name|struct
name|nsp_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|int
name|tout
decl_stmt|;
name|u_int8_t
name|ph
decl_stmt|,
name|regv
decl_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ph
operator|&
name|SCBUSMON_PHMASK
condition|)
block|{
case|case
name|PHASE_DATAOUT
case|:
if|if
condition|(
name|sc
operator|->
name|sc_dataout_timeout
operator|==
literal|0
condition|)
break|break;
comment|/* check a fifo empty */
name|regv
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifosr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regv
operator|&
name|FIFOSR_FULLEMP
operator|)
operator|==
literal|0
condition|)
break|break;
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_FIFOCL
argument_list|)
expr_stmt|;
comment|/* check still requested */
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ph
operator|&
name|SCBUSMON_REQ
operator|)
operator|==
literal|0
condition|)
break|break;
comment|/* check timeout */
if|if
condition|(
operator|(
operator|--
name|sc
operator|->
name|sc_dataout_timeout
operator|)
operator|>
literal|0
condition|)
break|break;
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_WRITE_PADDING
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|,
literal|"write padding required\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|tout
operator|=
name|NSP_DELAY_MAX
expr_stmt|;
while|while
condition|(
name|tout
operator|--
operator|>
literal|0
condition|)
block|{
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ph
operator|&
name|SCBUSMON_PHMASK
operator|)
operator|!=
name|PHASE_DATAOUT
condition|)
break|break;
name|regv
operator|=
name|bus_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_fifosr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regv
operator|&
name|FIFOSR_FULLEMP
operator|)
operator|==
literal|0
condition|)
block|{
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|bus_write_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|nsp_irqcr
argument_list|,
name|IRQCR_FIFOCL
argument_list|)
expr_stmt|;
name|nsp_data_padding
argument_list|(
name|sc
argument_list|,
name|SCSI_LOW_WRITE
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
name|ph
operator|=
name|nsp_cr_read_1
argument_list|(
name|sc
operator|->
name|port_res
argument_list|,
name|NSPR_SCBUSMON
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ph
operator|&
name|SCBUSMON_PHMASK
operator|)
operator|==
name|PHASE_DATAOUT
condition|)
name|sc
operator|->
name|sc_dataout_timeout
operator|=
name|SCSI_LOW_TIMEOUT_HZ
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


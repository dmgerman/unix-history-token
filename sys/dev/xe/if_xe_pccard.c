begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002 Takeshi Shibagaki  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *  * xe pccard interface driver  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_mib.h>
end_include

begin_include
include|#
directive|include
file|<dev/xe/if_xereg.h>
end_include

begin_include
include|#
directive|include
file|<dev/xe/if_xevar.h>
end_include

begin_include
include|#
directive|include
file|"card_if.h"
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccardvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pccard/pccarddevs.h>
end_include

begin_define
define|#
directive|define
name|XE_VENDOR_ID_XIRCOM
value|0x0105
end_define

begin_define
define|#
directive|define
name|XE_VENDOR_ID_COMPAQ_1
value|0x0138
end_define

begin_define
define|#
directive|define
name|XE_VENDOR_ID_COMPAQ_2
value|0x0183
end_define

begin_define
define|#
directive|define
name|XE_VENDOR_ID_INTEL
value|0x0089
end_define

begin_define
define|#
directive|define
name|XE_VENDOR_ID_UNKNOWN
value|0
end_define

begin_struct
struct|struct
name|xe_vendor_table
block|{
name|u_int32_t
name|vendor_id
decl_stmt|;
name|char
modifier|*
name|vendor_desc
decl_stmt|;
block|}
name|xe_vendor_devs
index|[]
init|=
block|{
block|{
name|XE_VENDOR_ID_XIRCOM
block|,
literal|"Xircom"
block|}
block|,
block|{
name|XE_VENDOR_ID_COMPAQ_1
block|,
literal|"Compaq"
block|}
block|,
block|{
name|XE_VENDOR_ID_COMPAQ_2
block|,
literal|"Compaq"
block|}
block|,
block|{
name|XE_VENDOR_ID_INTEL
block|,
literal|"Intel"
block|}
block|,
block|{
name|XE_VENDOR_ID_UNKNOWN
block|,
literal|"Unknown"
block|}
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|XE_CARD_TYPE_FLAGS_NO
value|0x0
end_define

begin_define
define|#
directive|define
name|XE_CARD_TYPE_FLAGS_CE2
value|0x1
end_define

begin_define
define|#
directive|define
name|XE_CARD_TYPE_FLAGS_MOHAWK
value|0x2
end_define

begin_define
define|#
directive|define
name|XE_CARD_TYPE_FLAGS_DINGO
value|0x4
end_define

begin_define
define|#
directive|define
name|XE_PROD_UMASK
value|0x100f
end_define

begin_define
define|#
directive|define
name|XE_PROD_MODEM_UMASK
value|0x1000
end_define

begin_define
define|#
directive|define
name|XE_PROD_SINGLE_ID1
value|0x1
end_define

begin_define
define|#
directive|define
name|XE_PROD_SINGLE_ID2
value|0x2
end_define

begin_define
define|#
directive|define
name|XE_PROD_SINGLE_ID3
value|0x3
end_define

begin_define
define|#
directive|define
name|XE_PROD_MULTI_ID1
value|0x1001
end_define

begin_define
define|#
directive|define
name|XE_PROD_MULTI_ID2
value|0x1002
end_define

begin_define
define|#
directive|define
name|XE_PROD_MULTI_ID3
value|0x1003
end_define

begin_define
define|#
directive|define
name|XE_PROD_MULTI_ID4
value|0x1004
end_define

begin_define
define|#
directive|define
name|XE_PROD_MULTI_ID5
value|0x1005
end_define

begin_define
define|#
directive|define
name|XE_PROD_MULTI_ID6
value|0x1006
end_define

begin_define
define|#
directive|define
name|XE_PROD_MULTI_ID7
value|0x1007
end_define

begin_struct
struct|struct
name|xe_card_type_table
block|{
name|u_int32_t
name|prod_type
decl_stmt|;
name|char
modifier|*
name|card_type_desc
decl_stmt|;
name|u_int32_t
name|flags
decl_stmt|;
block|}
name|xe_card_type_devs
index|[]
init|=
block|{
block|{
name|XE_PROD_MULTI_ID1
block|,
literal|"CEM"
block|,
name|XE_CARD_TYPE_FLAGS_NO
block|}
block|,
block|{
name|XE_PROD_MULTI_ID2
block|,
literal|"CEM2"
block|,
name|XE_CARD_TYPE_FLAGS_CE2
block|}
block|,
block|{
name|XE_PROD_MULTI_ID3
block|,
literal|"CEM3"
block|,
name|XE_CARD_TYPE_FLAGS_CE2
block|}
block|,
block|{
name|XE_PROD_MULTI_ID4
block|,
literal|"CEM33"
block|,
name|XE_CARD_TYPE_FLAGS_CE2
block|}
block|,
block|{
name|XE_PROD_MULTI_ID5
block|,
literal|"CEM56M"
block|,
name|XE_CARD_TYPE_FLAGS_MOHAWK
block|}
block|,
block|{
name|XE_PROD_MULTI_ID6
block|,
literal|"CEM56"
block|,
name|XE_CARD_TYPE_FLAGS_MOHAWK
operator||
name|XE_CARD_TYPE_FLAGS_DINGO
block|}
block|,
block|{
name|XE_PROD_MULTI_ID7
block|,
literal|"CEM56"
block|,
name|XE_CARD_TYPE_FLAGS_MOHAWK
operator||
name|XE_CARD_TYPE_FLAGS_DINGO
block|}
block|,
block|{
name|XE_PROD_SINGLE_ID1
block|,
literal|"CE"
block|,
name|XE_CARD_TYPE_FLAGS_NO
block|}
block|,
block|{
name|XE_PROD_SINGLE_ID2
block|,
literal|"CE2"
block|,
name|XE_CARD_TYPE_FLAGS_CE2
block|}
block|,
block|{
name|XE_PROD_SINGLE_ID3
block|,
literal|"CE3"
block|,
name|XE_CARD_TYPE_FLAGS_MOHAWK
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
operator|-
literal|1
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * Prototypes  */
end_comment

begin_function_decl
specifier|static
name|int
name|xe_cem56fix
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|xe_vendor_table
modifier|*
name|xe_vendor_lookup
parameter_list|(
name|u_int32_t
name|devid
parameter_list|,
name|struct
name|xe_vendor_table
modifier|*
name|tbl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|xe_card_type_table
modifier|*
name|xe_card_type_lookup
parameter_list|(
name|u_int32_t
name|devid
parameter_list|,
name|struct
name|xe_card_type_table
modifier|*
name|tbl
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Fixing for RealPort cards - they need a little furtling to get the  * ethernet working. But this codes don't work well in NEWCARD.  */
end_comment

begin_function
specifier|static
name|int
name|xe_cem56fix
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xe_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|xe_softc
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|bus_space_tag_t
name|bst
decl_stmt|;
name|bus_space_handle_t
name|bsh
decl_stmt|;
name|struct
name|resource
modifier|*
name|r
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|int
name|ioport
decl_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Realport port 0x%0lx, size 0x%0lx\n"
argument_list|,
name|bus_get_resource_start
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|port_rid
argument_list|)
argument_list|,
name|bus_get_resource_count
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|port_rid
argument_list|)
argument_list|)
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|r
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|4
operator|<<
literal|10
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Can't map in attribute memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|CARD_SET_RES_FLAGS
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|PCCARD_A_MEM_ATTR
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_ECOR
argument_list|,
name|DINGO_ECOR_IRQ_LEVEL
operator||
name|DINGO_ECOR_INT_ENABLE
operator||
name|DINGO_ECOR_IOB_ENABLE
operator||
name|DINGO_ECOR_ETH_ENABLE
argument_list|)
expr_stmt|;
name|ioport
operator|=
name|bus_get_resource_start
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|port_rid
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_EBAR0
argument_list|,
name|ioport
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_EBAR1
argument_list|,
operator|(
name|ioport
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_DCOR0
argument_list|,
name|DINGO_DCOR0_SF_INT
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_DCOR1
argument_list|,
name|DINGO_DCOR1_INT_LEVEL
operator||
name|DINGO_DCOR1_EEDIO
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_DCOR2
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_DCOR3
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|DINGO_DCOR4
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|r
argument_list|)
expr_stmt|;
comment|/* success! */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|xe_vendor_table
modifier|*
name|xe_vendor_lookup
parameter_list|(
name|u_int32_t
name|devid
parameter_list|,
name|struct
name|xe_vendor_table
modifier|*
name|tbl
parameter_list|)
block|{
while|while
condition|(
name|tbl
operator|->
name|vendor_id
condition|)
block|{
if|if
condition|(
name|tbl
operator|->
name|vendor_id
operator|==
name|devid
condition|)
return|return
operator|(
name|tbl
operator|)
return|;
name|tbl
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|tbl
operator|)
return|;
comment|/* return Unknown */
block|}
end_function

begin_function
specifier|static
name|struct
name|xe_card_type_table
modifier|*
name|xe_card_type_lookup
parameter_list|(
name|u_int32_t
name|devid
parameter_list|,
name|struct
name|xe_card_type_table
modifier|*
name|tbl
parameter_list|)
block|{
while|while
condition|(
name|tbl
operator|->
name|prod_type
condition|)
block|{
if|if
condition|(
name|tbl
operator|->
name|prod_type
operator|==
operator|(
name|devid
operator|&
name|XE_PROD_UMASK
operator|)
condition|)
return|return
operator|(
name|tbl
operator|)
return|;
name|tbl
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * PCMCIA probe routine.  * Identify the device.  Called from the bus driver when the card is  * inserted or otherwise powers up.  */
end_comment

begin_function
specifier|static
name|int
name|xe_pccard_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xe_softc
modifier|*
name|scp
init|=
operator|(
expr|struct
name|xe_softc
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int32_t
name|vendor
decl_stmt|,
name|prodid
decl_stmt|,
name|prod
decl_stmt|;
name|u_int16_t
name|prodext
decl_stmt|;
name|char
modifier|*
name|cis3_str
init|=
name|NULL
decl_stmt|;
name|struct
name|xe_vendor_table
modifier|*
name|vendor_itm
decl_stmt|;
name|struct
name|xe_card_type_table
modifier|*
name|card_itm
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* 	 * PCCARD_CISTPL_MANFID = 0x20 	 */
name|pccard_get_vendor
argument_list|(
name|dev
argument_list|,
operator|&
name|vendor
argument_list|)
expr_stmt|;
name|vendor_itm
operator|=
name|xe_vendor_lookup
argument_list|(
name|vendor
argument_list|,
operator|&
name|xe_vendor_devs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|scp
operator|->
name|vendor
operator|=
name|vendor_itm
operator|->
name|vendor_desc
expr_stmt|;
name|pccard_get_product
argument_list|(
name|dev
argument_list|,
operator|&
name|prodid
argument_list|)
expr_stmt|;
name|pccard_get_prodext
argument_list|(
name|dev
argument_list|,
operator|&
name|prodext
argument_list|)
expr_stmt|;
comment|/* 	 * prod(new) =  rev, media, prod(old) 	 * prod(new) =  (don't care), (care 0x10 bit), (care 0x0f bit) 	 */
name|prod
operator|=
operator|(
name|prodid
operator|<<
literal|8
operator|)
operator||
name|prodext
expr_stmt|;
name|card_itm
operator|=
name|xe_card_type_lookup
argument_list|(
name|prod
argument_list|,
operator|&
name|xe_card_type_devs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|card_itm
condition|)
return|return
operator|(
name|ENODEV
operator|)
return|;
else|else
block|{
name|scp
operator|->
name|card_type
operator|=
name|card_itm
operator|->
name|card_type_desc
expr_stmt|;
if|if
condition|(
name|card_itm
operator|->
name|prod_type
operator|&
name|XE_PROD_MODEM_UMASK
condition|)
name|scp
operator|->
name|modem
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|!=
name|XE_CARD_TYPE_FLAGS_DINGO
condition|;
name|i
operator|=
name|i
operator|<<
literal|1
control|)
block|{
switch|switch
condition|(
name|i
operator|&
name|card_itm
operator|->
name|flags
condition|)
block|{
case|case
name|XE_CARD_TYPE_FLAGS_CE2
case|:
name|scp
operator|->
name|ce2
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|XE_CARD_TYPE_FLAGS_MOHAWK
case|:
name|scp
operator|->
name|mohawk
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|XE_CARD_TYPE_FLAGS_DINGO
case|:
name|scp
operator|->
name|dingo
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* 	 * PCCARD_CISTPL_VERS_1 = 0x15 	 */
name|pccard_get_cis3_str
argument_list|(
name|dev
argument_list|,
operator|&
name|cis3_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|scp
operator|->
name|card_type
argument_list|,
literal|"CE"
argument_list|)
operator|==
literal|0
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|cis3_str
argument_list|,
literal|"CE2"
argument_list|)
operator|==
literal|0
condition|)
name|scp
operator|->
name|card_type
operator|=
literal|"CE2"
expr_stmt|;
comment|/* Look for "CE2" string */
comment|/* 	 * PCCARD_CISTPL_FUNCE = 0x22 	 */
name|pccard_get_ether
argument_list|(
name|dev
argument_list|,
name|scp
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|)
expr_stmt|;
comment|/* Reject unsupported cards */
if|if
condition|(
name|strcmp
argument_list|(
name|scp
operator|->
name|card_type
argument_list|,
literal|"CE"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|scp
operator|->
name|card_type
argument_list|,
literal|"CEM"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Sorry, your %s card is not supported :(\n"
argument_list|,
name|scp
operator|->
name|card_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
comment|/* Success */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attach a device.  */
end_comment

begin_function
specifier|static
name|int
name|xe_pccard_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xe_softc
modifier|*
name|scp
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|xe_activate
argument_list|(
name|dev
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* Hack RealPorts into submission */
if|if
condition|(
name|scp
operator|->
name|dingo
operator|&&
name|xe_cem56fix
argument_list|(
name|dev
argument_list|)
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to fix your RealPort\n"
argument_list|)
expr_stmt|;
name|xe_deactivate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENODEV
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|err
operator|=
name|xe_attach
argument_list|(
name|dev
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"xe_attach() failed! (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * The device entry is being removed, probably because someone ejected the  * card.  The interface should have been brought down manually before calling  * this function; if not you may well lose packets.  In any case, I shut down  * the card and the interface, and hope for the best.  */
end_comment

begin_function
specifier|static
name|int
name|xe_pccard_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|xe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
operator|.
name|if_flags
operator|&=
operator|~
name|IFF_RUNNING
expr_stmt|;
name|ether_ifdetach
argument_list|(
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
argument_list|,
name|ETHER_BPF_SUPPORTED
argument_list|)
expr_stmt|;
name|xe_deactivate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pccard_product
name|xe_pccard_products
index|[]
init|=
block|{
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CE
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CE2
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CE3
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CEM
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CEM28
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CEM33
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CEM56
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|REM56
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CNW_801
argument_list|,
literal|0
argument_list|)
block|,
name|PCMCIA_CARD
argument_list|(
name|XIRCOM
argument_list|,
name|CNW_802
argument_list|,
literal|0
argument_list|)
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|xe_pccard_match
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|const
name|struct
name|pccard_product
modifier|*
name|pp
decl_stmt|;
if|if
condition|(
operator|(
name|pp
operator|=
name|pccard_product_lookup
argument_list|(
name|dev
argument_list|,
name|xe_pccard_products
argument_list|,
sizeof|sizeof
argument_list|(
name|xe_pccard_products
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|pp
operator|->
name|pp_name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|EIO
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|xe_pccard_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|pccard_compat_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|pccard_compat_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|xe_pccard_detach
argument_list|)
block|,
comment|/* Card interface */
name|DEVMETHOD
argument_list|(
name|card_compat_match
argument_list|,
name|xe_pccard_match
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|card_compat_probe
argument_list|,
name|xe_pccard_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|card_compat_attach
argument_list|,
name|xe_pccard_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|xe_pccard_driver
init|=
block|{
literal|"xe"
block|,
name|xe_pccard_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|xe_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|devclass_t
name|xe_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|xe
argument_list|,
name|pccard
argument_list|,
name|xe_pccard_driver
argument_list|,
name|xe_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


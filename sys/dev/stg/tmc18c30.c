begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*	$NecBSD: tmc18c30.c,v 1.28.12.3 2001/06/19 04:35:48 honda Exp $	*/
end_comment

begin_comment
comment|/*	$NetBSD$	*/
end_comment

begin_define
define|#
directive|define
name|STG_DEBUG
end_define

begin_define
define|#
directive|define
name|STG_STATICS
end_define

begin_define
define|#
directive|define
name|STG_IO_CONTROL_FLAGS
value|(STG_FIFO_INTERRUPTS | STG_WAIT_FOR_SELECT)
end_define

begin_comment
comment|/*  * [NetBSD for NEC PC-98 series]  *  Copyright (c) 1996, 1997, 1998, 1999, 2000, 2001  *	NetBSD/pc98 porting staff. All rights reserved.  *  Copyright (c) 1996, 1997, 1998, 1999, 2000, 2001  *	Naofumi HONDA. All rights reserved.  *  Copyright (c) 1996, 1997, 1998, 1999  *	Kouichi Matsuda. All rights reserved.  *   *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  3. The name of the author may not be used to endorse or promote products  *     derived from this software without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ddb.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
name|__FreeBSD_version
operator|>=
literal|500001
end_if

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __FreeBSD__ */
end_comment

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsipi_all.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsiconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsi_disk.h>
end_include

begin_include
include|#
directive|include
file|<machine/dvcfg.h>
end_include

begin_include
include|#
directive|include
file|<machine/physio_proc.h>
end_include

begin_include
include|#
directive|include
file|<i386/Cbus/dev/scsi_low.h>
end_include

begin_include
include|#
directive|include
file|<i386/Cbus/dev/tmc18c30reg.h>
end_include

begin_include
include|#
directive|include
file|<i386/Cbus/dev/tmc18c30var.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __NetBSD__ */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus_pio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/dvcfg.h>
end_include

begin_include
include|#
directive|include
file|<machine/physio_proc.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_low.h>
end_include

begin_include
include|#
directive|include
file|<dev/stg/tmc18c30reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/stg/tmc18c30var.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|400001
end_if

begin_include
include|#
directive|include
file|"stg.h"
end_include

begin_decl_stmt
name|struct
name|stg_softc
modifier|*
name|stgdata
index|[
name|NSTG
index|]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __FreeBSD__ */
end_comment

begin_comment
comment|/***************************************************  * USER SETTINGS  ***************************************************/
end_comment

begin_comment
comment|/* DEVICE CONFIGURATION FLAGS (MINOR)  *  * 0x01   DISCONECT OFF  * 0x02   PARITY LINE OFF  * 0x04   IDENTIFY MSG OFF ( = single lun)  * 0x08   SYNC TRANSFER OFF  */
end_comment

begin_comment
comment|/* #define	STG_SYNC_SUPPORT */
end_comment

begin_comment
comment|/* NOT YET but easy */
end_comment

begin_comment
comment|/* For the 512 fifo type: change below */
end_comment

begin_define
define|#
directive|define
name|TMC18C30_FIFOSZ
value|0x800
end_define

begin_define
define|#
directive|define
name|TMC18C30_FCBSZ
value|0x200
end_define

begin_define
define|#
directive|define
name|TMC18C50_FIFOSZ
value|0x2000
end_define

begin_define
define|#
directive|define
name|TMC18C50_FCBSZ
value|0x400
end_define

begin_define
define|#
directive|define
name|STG_MAX_DATA_SIZE
value|(64 * 1024)
end_define

begin_define
define|#
directive|define
name|STG_DELAY_MAX
value|(2 * 1000 * 1000)
end_define

begin_define
define|#
directive|define
name|STG_DELAY_INTERVAL
value|(1)
end_define

begin_define
define|#
directive|define
name|STG_DELAY_SELECT_POLLING_MAX
value|(5 * 1000 * 1000)
end_define

begin_comment
comment|/***************************************************  * PARAMS  ***************************************************/
end_comment

begin_define
define|#
directive|define
name|STG_NTARGETS
value|8
end_define

begin_define
define|#
directive|define
name|STG_NLUNS
value|8
end_define

begin_comment
comment|/***************************************************  * DEBUG  ***************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|STG_DEBUG
end_ifdef

begin_decl_stmt
name|int
name|stg_debug
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* STG_DEBUG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|STG_STATICS
end_ifdef

begin_struct
struct|struct
name|stg_statics
block|{
name|int
name|arbit_fail_0
decl_stmt|;
name|int
name|arbit_fail_1
decl_stmt|;
name|int
name|disconnect
decl_stmt|;
name|int
name|reselect
decl_stmt|;
block|}
name|stg_statics
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* STG_STATICS */
end_comment

begin_comment
comment|/***************************************************  * IO control flags  ***************************************************/
end_comment

begin_define
define|#
directive|define
name|STG_FIFO_INTERRUPTS
value|0x0001
end_define

begin_define
define|#
directive|define
name|STG_WAIT_FOR_SELECT
value|0x0100
end_define

begin_decl_stmt
name|int
name|stg_io_control
init|=
name|STG_IO_CONTROL_FLAGS
decl_stmt|;
end_decl_stmt

begin_comment
comment|/***************************************************  * DEVICE STRUCTURE  ***************************************************/
end_comment

begin_decl_stmt
specifier|extern
name|struct
name|cfdriver
name|stg_cd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**************************************************************  * DECLARE  **************************************************************/
end_comment

begin_comment
comment|/* static */
end_comment

begin_decl_stmt
specifier|static
name|void
name|stg_pio_read
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
expr|struct
name|targ_info
operator|*
operator|,
name|u_int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|stg_pio_write
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
expr|struct
name|targ_info
operator|*
operator|,
name|u_int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_xfer
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
name|u_int8_t
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_msg
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
expr|struct
name|targ_info
operator|*
operator|,
name|u_int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_reselected
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_disconnected
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
expr|struct
name|targ_info
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|__inline
name|void
name|stg_pdma_end
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
expr|struct
name|targ_info
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stghw_select_targ_wait
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stghw_check
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|stghw_init
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_negate_signal
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
name|u_int8_t
operator|,
name|u_char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_expect_signal
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
name|u_int8_t
operator|,
name|u_int8_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_world_start
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stghw_start_selection
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
name|sc
operator|,
expr|struct
name|slccb
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|stghw_bus_reset
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|stghw_attention
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_target_nexus_establish
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_lun_nexus_establish
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_ccb_nexus_establish
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_targ_init
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
expr|struct
name|targ_info
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|__inline
name|void
name|stghw_bcr_write_1
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|,
name|u_int8_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stg_timeout
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|stg_selection_done_and_expect_msgout
name|__P
argument_list|(
operator|(
expr|struct
name|stg_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scsi_low_funcs
name|stgfuncs
init|=
block|{
name|SC_LOW_INIT_T
name|stg_world_start
block|,
name|SC_LOW_BUSRST_T
name|stghw_bus_reset
block|,
name|SC_LOW_TARG_INIT_T
name|stg_targ_init
block|,
name|SC_LOW_LUN_INIT_T
name|NULL
block|,
name|SC_LOW_SELECT_T
name|stghw_start_selection
block|,
name|SC_LOW_NEXUS_T
name|stg_lun_nexus_establish
block|,
name|SC_LOW_NEXUS_T
name|stg_ccb_nexus_establish
block|,
name|SC_LOW_ATTEN_T
name|stghw_attention
block|,
name|SC_LOW_MSG_T
name|stg_msg
block|,
name|SC_LOW_TIMEOUT_T
name|stg_timeout
block|,
name|SC_LOW_POLL_T
name|stgintr
block|,
name|NULL
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/****************************************************  * hwfuncs  ****************************************************/
end_comment

begin_function
specifier|static
name|__inline
name|void
name|stghw_bcr_write_1
parameter_list|(
name|sc
parameter_list|,
name|bcv
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|u_int8_t
name|bcv
decl_stmt|;
block|{
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|tmc_bctl
argument_list|,
name|bcv
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_busimg
operator|=
name|bcv
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|stghw_check
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|u_int
name|fcbsize
decl_stmt|,
name|fcb
decl_stmt|;
name|u_int16_t
name|lsb
decl_stmt|,
name|msb
decl_stmt|;
name|lsb
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_idlsb
argument_list|)
expr_stmt|;
name|msb
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_idmsb
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msb
operator|<<
literal|8
operator||
name|lsb
condition|)
block|{
case|case
literal|0x6127
case|:
comment|/* TMCCHIP_1800 not supported. (it's my policy) */
name|sc
operator|->
name|sc_chip
operator|=
name|TMCCHIP_1800
expr_stmt|;
return|return
name|EINVAL
return|;
case|case
literal|0x60e9
case|:
if|if
condition|(
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_cfg2
argument_list|)
operator|&
literal|0x02
condition|)
block|{
name|sc
operator|->
name|sc_chip
operator|=
name|TMCCHIP_18C30
expr_stmt|;
name|sc
operator|->
name|sc_fsz
operator|=
name|TMC18C30_FIFOSZ
expr_stmt|;
name|fcbsize
operator|=
name|TMC18C30_FCBSZ
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|sc_chip
operator|=
name|TMCCHIP_18C50
expr_stmt|;
name|sc
operator|->
name|sc_fsz
operator|=
name|TMC18C50_FIFOSZ
expr_stmt|;
name|fcbsize
operator|=
name|TMC18C50_FCBSZ
expr_stmt|;
block|}
break|break;
default|default:
name|sc
operator|->
name|sc_chip
operator|=
name|TMCCHIP_UNK
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|sc
operator|->
name|sc_fcRinit
operator|=
name|FCTL_INTEN
expr_stmt|;
name|sc
operator|->
name|sc_fcWinit
operator|=
name|FCTL_PARENB
operator||
name|FCTL_INTEN
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_NOATTEN
condition|)
name|sc
operator|->
name|sc_imsg
operator|=
literal|0
expr_stmt|;
else|else
name|sc
operator|->
name|sc_imsg
operator|=
name|BCTL_ATN
expr_stmt|;
name|sc
operator|->
name|sc_busc
operator|=
name|BCTL_BUSEN
expr_stmt|;
name|sc
operator|->
name|sc_wthold
operator|=
name|fcbsize
operator|+
literal|256
expr_stmt|;
name|sc
operator|->
name|sc_rthold
operator|=
name|fcbsize
operator|-
literal|256
expr_stmt|;
name|sc
operator|->
name|sc_maxwsize
operator|=
name|sc
operator|->
name|sc_fsz
expr_stmt|;
name|fcb
operator|=
name|fcbsize
operator|/
operator|(
name|sc
operator|->
name|sc_fsz
operator|/
literal|16
operator|)
expr_stmt|;
name|sc
operator|->
name|sc_icinit
operator|=
name|ICTL_CD
operator||
name|ICTL_SEL
operator||
name|ICTL_ARBIT
operator||
name|fcb
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|stghw_init
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|BCTL_BUSFREE
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
operator||
name|FCTL_CLRFIFO
operator||
name|FCTL_CLRINT
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
name|sc
operator|->
name|sc_icinit
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ssctl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_targ_init
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|,
name|action
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|int
name|action
decl_stmt|;
block|{
name|struct
name|stg_targ_info
modifier|*
name|sti
init|=
operator|(
name|void
operator|*
operator|)
name|ti
decl_stmt|;
if|if
condition|(
name|action
operator|==
name|SCSI_LOW_INFO_ALLOC
operator|||
name|action
operator|==
name|SCSI_LOW_INFO_REVOKE
condition|)
block|{
name|ti
operator|->
name|ti_width
operator|=
name|SCSI_LOW_BUS_WIDTH_8
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|sti
operator|->
name|sti_reg_synch
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/****************************************************  * scsi low interface  ****************************************************/
end_comment

begin_function
specifier|static
name|void
name|stghw_attention
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|sc
operator|->
name|sc_busc
operator||=
name|BCTL_ATN
expr_stmt|;
name|sc
operator|->
name|sc_busimg
operator||=
name|BCTL_ATN
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_ioh
argument_list|,
name|tmc_bctl
argument_list|,
name|sc
operator|->
name|sc_busimg
argument_list|)
expr_stmt|;
name|SCSI_LOW_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stghw_bus_reset
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|BCTL_RST
argument_list|)
expr_stmt|;
name|SCSI_LOW_DELAY
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|BCTL_BUSFREE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|stghw_start_selection
parameter_list|(
name|sc
parameter_list|,
name|cb
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|cb
operator|->
name|ti
decl_stmt|;
specifier|register
name|u_int8_t
name|stat
decl_stmt|;
name|int
name|s
decl_stmt|;
name|sc
operator|->
name|sc_tmaxcnt
operator|=
name|cb
operator|->
name|ccb_tcmax
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
name|sc
operator|->
name|sc_dataout_timeout
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_ubf_timeout
operator|=
literal|0
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|BCTL_BUSFREE
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
name|sc
operator|->
name|sc_icinit
argument_list|)
expr_stmt|;
name|s
operator|=
name|splhigh
argument_list|()
expr_stmt|;
name|stat
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_astat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|stat
operator|&
name|ASTAT_INT
operator|)
operator|!=
literal|0
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|SCSI_LOW_START_FAIL
return|;
block|}
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_scsiid
argument_list|,
name|sc
operator|->
name|sc_idbit
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
operator||
name|FCTL_ARBIT
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_ARBSTART
argument_list|)
expr_stmt|;
return|return
name|SCSI_LOW_START_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_world_start
parameter_list|(
name|sc
parameter_list|,
name|fdone
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|fdone
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_NOPARITY
operator|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_fcRinit
operator||=
name|FCTL_PARENB
expr_stmt|;
else|else
name|sc
operator|->
name|sc_fcRinit
operator|&=
operator|~
name|FCTL_PARENB
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|stghw_check
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|stghw_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|scsi_low_bus_reset
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|stghw_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|SOFT_INTR_REQUIRED
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_msg
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|,
name|msg
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|msg
decl_stmt|;
block|{
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|struct
name|stg_targ_info
modifier|*
name|sti
init|=
operator|(
name|void
operator|*
operator|)
name|ti
decl_stmt|;
name|u_int
name|period
decl_stmt|,
name|offset
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|&
name|SCSI_LOW_MSG_WIDE
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|ti
operator|->
name|ti_width
operator|!=
name|SCSI_LOW_BUS_WIDTH_8
condition|)
block|{
name|ti
operator|->
name|ti_width
operator|=
name|SCSI_LOW_BUS_WIDTH_8
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|msg
operator|&
name|SCSI_LOW_MSG_SYNCH
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|period
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
expr_stmt|;
name|offset
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
expr_stmt|;
name|period
operator|=
name|period
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
name|period
operator|>=
literal|200
condition|)
block|{
name|sti
operator|->
name|sti_reg_synch
operator|=
operator|(
name|period
operator|-
literal|200
operator|)
operator|/
literal|50
expr_stmt|;
if|if
condition|(
name|period
operator|%
literal|50
condition|)
name|sti
operator|->
name|sti_reg_synch
operator|++
expr_stmt|;
name|sti
operator|->
name|sti_reg_synch
operator||=
name|SSCTL_SYNCHEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|period
operator|>=
literal|100
condition|)
block|{
name|sti
operator|->
name|sti_reg_synch
operator|=
operator|(
name|period
operator|-
literal|100
operator|)
operator|/
literal|50
expr_stmt|;
if|if
condition|(
name|period
operator|%
literal|50
condition|)
name|sti
operator|->
name|sti_reg_synch
operator|++
expr_stmt|;
name|sti
operator|->
name|sti_reg_synch
operator||=
name|SSCTL_SYNCHEN
operator||
name|SSCTL_FSYNCHEN
expr_stmt|;
block|}
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ssctl
argument_list|,
name|sti
operator|->
name|sti_reg_synch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * General probe attach  **************************************************************/
end_comment

begin_function
name|int
name|stgprobesubr
parameter_list|(
name|iot
parameter_list|,
name|ioh
parameter_list|,
name|dvcfg
parameter_list|)
name|bus_space_tag_t
name|iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
decl_stmt|;
name|u_int
name|dvcfg
decl_stmt|;
block|{
name|u_int16_t
name|lsb
decl_stmt|,
name|msb
decl_stmt|;
name|lsb
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_idlsb
argument_list|)
expr_stmt|;
name|msb
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_idmsb
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|msb
operator|<<
literal|8
operator||
name|lsb
condition|)
block|{
default|default:
return|return
literal|0
return|;
case|case
literal|0x6127
case|:
comment|/* not support! */
return|return
literal|0
return|;
case|case
literal|0x60e9
case|:
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|stgprint
parameter_list|(
name|aux
parameter_list|,
name|name
parameter_list|)
name|void
modifier|*
name|aux
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|{
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s: scsibus "
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|UNCONF
return|;
block|}
end_function

begin_function
name|void
name|stgattachsubr
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_idbit
operator|=
operator|(
literal|1
operator|<<
name|slp
operator|->
name|sl_hostid
operator|)
expr_stmt|;
name|slp
operator|->
name|sl_funcs
operator|=
operator|&
name|stgfuncs
expr_stmt|;
name|sc
operator|->
name|sc_tmaxcnt
operator|=
name|SCSI_LOW_MIN_TOUT
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
comment|/* default */
name|slp
operator|->
name|sl_flags
operator||=
name|HW_READ_PADDING
expr_stmt|;
name|slp
operator|->
name|sl_cfgflags
operator||=
name|CFG_ASYNC
expr_stmt|;
comment|/* XXX */
operator|(
name|void
operator|)
name|scsi_low_attach
argument_list|(
name|slp
argument_list|,
literal|0
argument_list|,
name|STG_NTARGETS
argument_list|,
name|STG_NLUNS
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|stg_targ_info
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************************  * PDMA functions  **************************************************************/
end_comment

begin_function
specifier|static
name|__inline
name|void
name|stg_pdma_end
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|u_int
name|len
decl_stmt|,
name|tres
decl_stmt|;
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
name|HW_PDMASTART
expr_stmt|;
name|sc
operator|->
name|sc_icinit
operator|&=
operator|~
name|ICTL_FIFO
expr_stmt|;
name|sc
operator|->
name|sc_dataout_timeout
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ti
operator|->
name|ti_phase
operator|==
name|PH_DATA
condition|)
block|{
name|len
operator|=
name|bus_space_read_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fdcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|==
name|SCSI_LOW_WRITE
condition|)
block|{
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
name|tres
operator|=
name|len
operator|+
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
expr_stmt|;
if|if
condition|(
name|tres
operator|<=
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
condition|)
block|{
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
operator|-=
name|len
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|=
name|tres
expr_stmt|;
block|}
else|else
block|{
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
name|printf
argument_list|(
literal|"%s len %x>= datalen %x\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|len
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|==
name|SCSI_LOW_READ
condition|)
block|{
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
name|printf
argument_list|(
literal|"%s: len %x left in fifo\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
name|scsi_low_data_finish
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s data phase miss\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
block|}
name|out
label|:
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stg_pio_read
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|,
name|thold
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|thold
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|struct
name|sc_p
modifier|*
name|sp
init|=
operator|&
name|slp
operator|->
name|sl_scp
decl_stmt|;
name|int
name|s
decl_stmt|,
name|tout
decl_stmt|;
name|u_int
name|res
decl_stmt|;
name|u_int8_t
name|stat
decl_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_PDMASTART
operator|)
operator|==
literal|0
condition|)
block|{
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
operator||
name|FCTL_FIFOEN
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_PDMASTART
expr_stmt|;
block|}
name|tout
operator|=
name|sc
operator|->
name|sc_tmaxcnt
expr_stmt|;
while|while
condition|(
name|tout
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|thold
operator|>
literal|0
condition|)
block|{
name|s
operator|=
name|splhigh
argument_list|()
expr_stmt|;
name|res
operator|=
name|bus_space_read_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fdcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
name|thold
condition|)
block|{
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
name|sc
operator|->
name|sc_icinit
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|stat
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
name|res
operator|=
name|bus_space_read_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fdcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|stat
operator|&
name|PHASE_MASK
operator|)
operator|!=
name|DATA_IN_PHASE
condition|)
break|break;
if|if
condition|(
name|sp
operator|->
name|scp_datalen
operator|<=
literal|0
condition|)
break|break;
name|SCSI_LOW_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
comment|/* The assumtion res != 0 is valid here */
if|if
condition|(
name|res
operator|>
name|sp
operator|->
name|scp_datalen
condition|)
block|{
if|if
condition|(
name|res
operator|==
operator|(
name|u_int
operator|)
operator|-
literal|1
condition|)
break|break;
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_READ_PADDING
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: read padding required\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
break|break;
block|}
name|sp
operator|->
name|scp_datalen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|res
operator|>
name|STG_MAX_DATA_SIZE
condition|)
name|res
operator|=
name|STG_MAX_DATA_SIZE
expr_stmt|;
while|while
condition|(
name|res
operator|--
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_rfifo
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
name|sp
operator|->
name|scp_datalen
operator|-=
name|res
expr_stmt|;
if|if
condition|(
name|res
operator|&
literal|1
condition|)
block|{
operator|*
name|sp
operator|->
name|scp_data
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_rfifo
argument_list|)
expr_stmt|;
name|sp
operator|->
name|scp_data
operator|++
expr_stmt|;
name|res
operator|--
expr_stmt|;
block|}
name|bus_space_read_multi_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_rfifo
argument_list|,
operator|(
name|u_int16_t
operator|*
operator|)
name|sp
operator|->
name|scp_data
argument_list|,
name|res
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|sp
operator|->
name|scp_data
operator|+=
name|res
expr_stmt|;
block|}
if|if
condition|(
name|tout
operator|<=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: pio read timeout\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|stg_pio_write
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|,
name|thold
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|thold
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|struct
name|sc_p
modifier|*
name|sp
init|=
operator|&
name|slp
operator|->
name|sl_scp
decl_stmt|;
name|u_int
name|res
decl_stmt|;
name|int
name|s
decl_stmt|,
name|tout
decl_stmt|;
specifier|register
name|u_int8_t
name|stat
decl_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_PDMASTART
operator|)
operator|==
literal|0
condition|)
block|{
name|stat
operator|=
name|sc
operator|->
name|sc_fcWinit
operator||
name|FCTL_FIFOEN
operator||
name|FCTL_FIFOW
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|stat
operator||
name|FCTL_CLRFIFO
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|stat
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_PDMASTART
expr_stmt|;
block|}
name|tout
operator|=
name|sc
operator|->
name|sc_tmaxcnt
expr_stmt|;
while|while
condition|(
name|tout
operator|--
operator|>
literal|0
condition|)
block|{
name|stat
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|stat
operator|&
name|PHASE_MASK
operator|)
operator|!=
name|DATA_OUT_PHASE
condition|)
break|break;
if|if
condition|(
name|sp
operator|->
name|scp_datalen
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_dataout_timeout
operator|==
literal|0
condition|)
name|sc
operator|->
name|sc_dataout_timeout
operator|=
name|SCSI_LOW_TIMEOUT_HZ
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|thold
operator|>
literal|0
condition|)
block|{
name|s
operator|=
name|splhigh
argument_list|()
expr_stmt|;
name|res
operator|=
name|bus_space_read_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fdcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
name|thold
condition|)
block|{
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
name|sc
operator|->
name|sc_icinit
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|bus_space_read_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fdcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
name|sc
operator|->
name|sc_maxwsize
operator|/
literal|2
condition|)
block|{
name|SCSI_LOW_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|res
operator|==
operator|(
name|u_int
operator|)
operator|-
literal|1
condition|)
break|break;
name|res
operator|=
name|sc
operator|->
name|sc_maxwsize
operator|-
name|res
expr_stmt|;
if|if
condition|(
name|res
operator|>
name|sp
operator|->
name|scp_datalen
condition|)
name|res
operator|=
name|sp
operator|->
name|scp_datalen
expr_stmt|;
name|sp
operator|->
name|scp_datalen
operator|-=
name|res
expr_stmt|;
if|if
condition|(
operator|(
name|res
operator|&
literal|0x1
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_wfifo
argument_list|,
operator|*
name|sp
operator|->
name|scp_data
argument_list|)
expr_stmt|;
name|sp
operator|->
name|scp_data
operator|++
expr_stmt|;
name|res
operator|--
expr_stmt|;
block|}
name|bus_space_write_multi_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_wfifo
argument_list|,
operator|(
name|u_int16_t
operator|*
operator|)
name|sp
operator|->
name|scp_data
argument_list|,
name|res
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|sp
operator|->
name|scp_data
operator|+=
name|res
expr_stmt|;
block|}
if|if
condition|(
name|tout
operator|<=
literal|0
condition|)
name|printf
argument_list|(
literal|"%s: pio write timeout\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_negate_signal
parameter_list|(
name|sc
parameter_list|,
name|mask
parameter_list|,
name|s
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|u_int8_t
name|mask
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|bst
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|bsh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|int
name|wc
decl_stmt|;
name|u_int8_t
name|regv
decl_stmt|;
for|for
control|(
name|wc
operator|=
literal|0
init|;
name|wc
operator|<
name|STG_DELAY_MAX
operator|/
name|STG_DELAY_INTERVAL
condition|;
name|wc
operator|++
control|)
block|{
name|regv
operator|=
name|bus_space_read_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
name|regv
operator|==
operator|(
name|u_int8_t
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|regv
operator|&
name|mask
operator|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|SCSI_LOW_DELAY
argument_list|(
name|STG_DELAY_INTERVAL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: %s stg_negate_signal timeout\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_expect_signal
parameter_list|(
name|sc
parameter_list|,
name|phase
parameter_list|,
name|mask
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|u_int8_t
name|phase
decl_stmt|,
name|mask
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|bst
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|bsh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|int
name|wc
decl_stmt|;
name|u_int8_t
name|ph
decl_stmt|;
name|phase
operator|&=
name|PHASE_MASK
expr_stmt|;
for|for
control|(
name|wc
operator|=
literal|0
init|;
name|wc
operator|<
name|STG_DELAY_MAX
operator|/
name|STG_DELAY_INTERVAL
condition|;
name|wc
operator|++
control|)
block|{
name|ph
operator|=
name|bus_space_read_1
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph
operator|==
operator|(
name|u_int8_t
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|ph
operator|&
name|PHASE_MASK
operator|)
operator|!=
name|phase
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|ph
operator|&
name|mask
operator|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
name|SCSI_LOW_DELAY
argument_list|(
name|STG_DELAY_INTERVAL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: stg_expect_signal timeout\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_xfer
parameter_list|(
name|sc
parameter_list|,
name|buf
parameter_list|,
name|len
parameter_list|,
name|phase
parameter_list|,
name|clear_atn
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|u_int8_t
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|phase
decl_stmt|;
name|int
name|clear_atn
decl_stmt|;
block|{
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|int
name|rv
decl_stmt|,
name|ptr
decl_stmt|;
if|if
condition|(
name|phase
operator|&
name|BSTAT_IO
condition|)
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
else|else
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcWinit
argument_list|)
expr_stmt|;
for|for
control|(
name|ptr
operator|=
literal|0
init|;
name|len
operator|>
literal|0
condition|;
name|len
operator|--
control|)
block|{
name|rv
operator|=
name|stg_expect_signal
argument_list|(
name|sc
argument_list|,
name|phase
argument_list|,
name|BSTAT_REQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|len
operator|==
literal|1
operator|&&
name|clear_atn
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_busc
operator|&=
operator|~
name|BCTL_ATN
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_busc
argument_list|)
expr_stmt|;
name|SCSI_LOW_DEASSERT_ATN
argument_list|(
operator|&
name|sc
operator|->
name|sc_sclow
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|phase
operator|&
name|BSTAT_IO
condition|)
block|{
name|buf
index|[
name|ptr
operator|++
index|]
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_rdata
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_wdata
argument_list|,
name|buf
index|[
name|ptr
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
name|stg_negate_signal
argument_list|(
name|sc
argument_list|,
name|BSTAT_ACK
argument_list|,
literal|"xfer<ACK>"
argument_list|)
expr_stmt|;
block|}
name|bad
label|:
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * disconnect& reselect (HW low)  **************************************************************/
end_comment

begin_function
specifier|static
name|int
name|stg_reselected
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|int
name|tout
decl_stmt|;
name|u_int
name|sid
decl_stmt|;
name|u_int8_t
name|regv
decl_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_selid
operator|!=
name|NULL
condition|)
block|{
comment|/* XXX: 		 * Selection vs Reselection conflicts. 		 */
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|BCTL_BUSFREE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unexpected termination\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|stg_disconnected
argument_list|(
name|sc
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|)
expr_stmt|;
block|}
comment|/* XXX: 	 * We should ack the reselection as soon as possible, 	 * becuase the target would abort the current reselection seq    	 * due to reselection timeout. 	 */
name|tout
operator|=
name|STG_DELAY_SELECT_POLLING_MAX
expr_stmt|;
while|while
condition|(
name|tout
operator|--
operator|>
literal|0
condition|)
block|{
name|regv
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regv
operator|&
operator|(
name|BSTAT_IO
operator||
name|BSTAT_SEL
operator||
name|BSTAT_BSY
operator|)
operator|)
operator|==
operator|(
name|BSTAT_IO
operator||
name|BSTAT_SEL
operator|)
condition|)
block|{
name|SCSI_LOW_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|regv
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regv
operator|&
operator|(
name|BSTAT_IO
operator||
name|BSTAT_SEL
operator||
name|BSTAT_BSY
operator|)
operator|)
operator|==
operator|(
name|BSTAT_IO
operator||
name|BSTAT_SEL
operator|)
condition|)
goto|goto
name|reselect_start
goto|;
block|}
name|SCSI_LOW_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: reselction timeout I\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|EJUSTRETURN
return|;
name|reselect_start
label|:
name|sid
operator|=
operator|(
name|u_int
operator|)
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_scsiid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sid
operator|&
name|sc
operator|->
name|sc_idbit
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* not us */
return|return
name|EJUSTRETURN
return|;
block|}
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
operator||
name|FCTL_CLRFIFO
operator||
name|FCTL_CLRINT
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_busc
operator||
name|BCTL_BSY
argument_list|)
expr_stmt|;
while|while
condition|(
name|tout
operator|--
operator|>
literal|0
condition|)
block|{
name|regv
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regv
operator|&
operator|(
name|BSTAT_SEL
operator||
name|BSTAT_BSY
operator|)
operator|)
operator|==
name|BSTAT_BSY
condition|)
goto|goto
name|reselected
goto|;
name|SCSI_LOW_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: reselction timeout II\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|EJUSTRETURN
return|;
name|reselected
label|:
name|sid
operator|&=
operator|~
name|sc
operator|->
name|sc_idbit
expr_stmt|;
name|sid
operator|=
name|ffs
argument_list|(
name|sid
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|scsi_low_reselected
argument_list|(
name|slp
argument_list|,
name|sid
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|EJUSTRETURN
return|;
ifdef|#
directive|ifdef
name|STG_STATICS
name|stg_statics
operator|.
name|reselect
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* STG_STATICS */
return|return
name|EJUSTRETURN
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_disconnected
parameter_list|(
name|sc
parameter_list|,
name|ti
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
comment|/* clear bus status& fifo */
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
operator||
name|FCTL_CLRFIFO
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|BCTL_BUSFREE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_icinit
operator|&=
operator|~
name|ICTL_FIFO
expr_stmt|;
name|sc
operator|->
name|sc_busc
operator|&=
operator|~
name|BCTL_ATN
expr_stmt|;
name|sc
operator|->
name|sc_dataout_timeout
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_ubf_timeout
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|STG_STATICS
name|stg_statics
operator|.
name|disconnect
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* STG_STATICS */
name|scsi_low_disconnected
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * SEQUENCER  **************************************************************/
end_comment

begin_function
specifier|static
name|int
name|stg_target_nexus_establish
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|struct
name|stg_targ_info
modifier|*
name|sti
init|=
operator|(
name|void
operator|*
operator|)
name|ti
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ssctl
argument_list|,
name|sti
operator|->
name|sti_reg_synch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|stg_io_control
operator|&
name|STG_FIFO_INTERRUPTS
operator|)
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_icinit
operator||=
name|ICTL_FIFO
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_lun_nexus_establish
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_ccb_nexus_establish
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|sc
operator|->
name|sc_tmaxcnt
operator|=
name|cb
operator|->
name|ccb_tcmax
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|STGHW_SELECT_INTERVAL
value|10
end_define

begin_function
specifier|static
name|int
name|stghw_select_targ_wait
parameter_list|(
name|sc
parameter_list|,
name|mu
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|mu
decl_stmt|;
block|{
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|mu
operator|=
name|mu
operator|/
name|STGHW_SELECT_INTERVAL
expr_stmt|;
while|while
condition|(
name|mu
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
operator|&
name|BSTAT_BSY
operator|)
operator|==
literal|0
condition|)
block|{
name|SCSI_LOW_DELAY
argument_list|(
name|STGHW_SELECT_INTERVAL
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|SCSI_LOW_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
operator|&
name|BSTAT_BSY
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|stg_selection_done_and_expect_msgout
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
operator||
name|FCTL_CLRFIFO
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_imsg
operator||
name|sc
operator|->
name|sc_busc
argument_list|)
expr_stmt|;
name|SCSI_LOW_ASSERT_ATN
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|stgintr
parameter_list|(
name|arg
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|struct
name|stg_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|physio_proc
modifier|*
name|pp
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|u_int
name|derror
decl_stmt|,
name|flags
decl_stmt|;
name|int
name|len
decl_stmt|,
name|s
decl_stmt|;
name|u_int8_t
name|status
decl_stmt|,
name|astatus
decl_stmt|,
name|regv
decl_stmt|;
comment|/******************************************* 	 * interrupt check 	 *******************************************/
if|if
condition|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_INACTIVE
condition|)
return|return
literal|0
return|;
name|astatus
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_astat
argument_list|)
expr_stmt|;
name|status
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|astatus
operator|&
name|ASTAT_STATMASK
operator|)
operator|==
literal|0
operator|||
name|astatus
operator|==
operator|(
name|u_int8_t
operator|)
operator|-
literal|1
condition|)
return|return
literal|0
return|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|astatus
operator|&
name|ASTAT_SCSIRST
condition|)
block|{
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
operator||
name|FCTL_CLRFIFO
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|scsi_low_restart
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_SOFT
argument_list|,
literal|"bus reset (power off?)"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
comment|/******************************************* 	 * debug section 	 *******************************************/
ifdef|#
directive|ifdef
name|STG_DEBUG
if|if
condition|(
name|stg_debug
condition|)
block|{
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: st %x ist %x\n\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|status
argument_list|,
name|astatus
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DDB
if|if
condition|(
name|stg_debug
operator|>
literal|1
condition|)
name|SCSI_LOW_DEBUGGER
argument_list|(
literal|"stg"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DDB */
block|}
endif|#
directive|endif
comment|/* STG_DEBUG */
comment|/******************************************* 	 * reselection& nexus 	 *******************************************/
if|if
condition|(
operator|(
name|status
operator|&
name|RESEL_PHASE_MASK
operator|)
operator|==
name|PHASE_RESELECTED
condition|)
block|{
if|if
condition|(
name|stg_reselected
argument_list|(
name|sc
argument_list|)
operator|==
name|EJUSTRETURN
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|ti
operator|=
name|slp
operator|->
name|sl_Tnexus
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|derror
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|astatus
operator|&
name|ASTAT_PARERR
operator|)
operator|!=
literal|0
operator|&&
name|ti
operator|->
name|ti_phase
operator|!=
name|PH_ARBSTART
operator|&&
operator|(
name|sc
operator|->
name|sc_fcRinit
operator|&
name|FCTL_PARENB
operator|)
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|PARITYERR
expr_stmt|;
name|derror
operator|=
name|SCSI_LOW_DATA_PE
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|PHASE_MASK
operator|)
operator|==
name|MESSAGE_IN_PHASE
condition|)
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_PARITY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ERROR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/******************************************* 	 * aribitration& selection 	 *******************************************/
switch|switch
condition|(
name|ti
operator|->
name|ti_phase
condition|)
block|{
case|case
name|PH_ARBSTART
case|:
if|if
condition|(
operator|(
name|astatus
operator|&
name|ASTAT_ARBIT
operator|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|STG_STATICS
name|stg_statics
operator|.
name|arbit_fail_0
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* STG_STATICS */
goto|goto
name|arb_fail
goto|;
block|}
name|status
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|BSTAT_IO
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* XXX: 			 * Selection vs Reselection conflicts. 			 */
ifdef|#
directive|ifdef
name|STG_STATICS
name|stg_statics
operator|.
name|arbit_fail_1
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* STG_STATICS */
name|arb_fail
label|:
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|BCTL_BUSFREE
argument_list|)
expr_stmt|;
name|scsi_low_arbit_fail
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Qnexus
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 		 * selection assert start. 		 */
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_SELSTART
argument_list|)
expr_stmt|;
name|scsi_low_arbit_win
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|s
operator|=
name|splhigh
argument_list|()
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_scsiid
argument_list|,
name|sc
operator|->
name|sc_idbit
operator||
operator|(
literal|1
operator|<<
name|ti
operator|->
name|ti_id
operator|)
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_imsg
operator||
name|sc
operator|->
name|sc_busc
operator||
name|BCTL_SEL
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcWinit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|stg_io_control
operator|&
name|STG_WAIT_FOR_SELECT
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* selection abort delay 200 + 100 micro sec */
if|if
condition|(
name|stghw_select_targ_wait
argument_list|(
name|sc
argument_list|,
literal|300
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_SELECTED
argument_list|)
expr_stmt|;
name|stg_selection_done_and_expect_msgout
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|PH_SELSTART
case|:
if|if
condition|(
operator|(
name|status
operator|&
name|BSTAT_BSY
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* selection timeout delay 250 ms */
if|if
condition|(
name|stghw_select_targ_wait
argument_list|(
name|sc
argument_list|,
literal|250
operator|*
literal|1000
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|stg_disconnected
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_SELECTED
argument_list|)
expr_stmt|;
name|stg_selection_done_and_expect_msgout
argument_list|(
name|sc
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|PH_SELECTED
case|:
if|if
condition|(
operator|(
name|status
operator|&
name|BSTAT_REQ
operator|)
operator|==
literal|0
condition|)
goto|goto
name|out
goto|;
name|stg_target_nexus_establish
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|PH_RESEL
case|:
if|if
condition|(
operator|(
name|status
operator|&
name|BSTAT_REQ
operator|)
operator|==
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/* clear a busy line */
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fctl
argument_list|,
name|sc
operator|->
name|sc_fcRinit
argument_list|)
expr_stmt|;
name|stghw_bcr_write_1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_busc
argument_list|)
expr_stmt|;
name|stg_target_nexus_establish
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|PHASE_MASK
operator|)
operator|!=
name|MESSAGE_IN_PHASE
condition|)
block|{
name|printf
argument_list|(
literal|"%s: unexpected phase after reselect\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
break|break;
block|}
comment|/******************************************* 	 * data phase 	 *******************************************/
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_PDMASTART
operator|)
operator|&&
name|STG_IS_PHASE_DATA
argument_list|(
name|status
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|==
name|SCSI_LOW_READ
condition|)
name|stg_pio_read
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stg_pdma_end
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
expr_stmt|;
block|}
comment|/******************************************* 	 * scsi seq 	 *******************************************/
switch|switch
condition|(
name|status
operator|&
name|PHASE_MASK
condition|)
block|{
case|case
name|COMMAND_PHASE
case|:
if|if
condition|(
name|stg_expect_signal
argument_list|(
name|sc
argument_list|,
name|COMMAND_PHASE
argument_list|,
name|BSTAT_REQ
argument_list|)
operator|<=
literal|0
condition|)
break|break;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_CMD
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_cmd
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stg_xfer
argument_list|(
name|sc
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmd
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmdlen
argument_list|,
name|COMMAND_PHASE
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: CMDOUT short\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|DATA_OUT_PHASE
case|:
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_data
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
operator|&
name|bp
argument_list|,
name|SCSI_LOW_WRITE
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
name|pp
operator|=
name|physio_proc_enter
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icinit
operator|&
name|ICTL_FIFO
operator|)
operator|!=
literal|0
condition|)
name|stg_pio_write
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|,
name|sc
operator|->
name|sc_wthold
argument_list|)
expr_stmt|;
else|else
name|stg_pio_write
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|physio_proc_leave
argument_list|(
name|pp
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATA_IN_PHASE
case|:
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_data
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
operator|&
name|bp
argument_list|,
name|SCSI_LOW_READ
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
name|pp
operator|=
name|physio_proc_enter
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|sc_icinit
operator|&
name|ICTL_FIFO
operator|)
operator|!=
literal|0
condition|)
name|stg_pio_read
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|,
name|sc
operator|->
name|sc_rthold
argument_list|)
expr_stmt|;
else|else
name|stg_pio_read
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|physio_proc_leave
argument_list|(
name|pp
argument_list|)
expr_stmt|;
break|break;
case|case
name|STATUS_PHASE
case|:
name|regv
operator|=
name|stg_expect_signal
argument_list|(
name|sc
argument_list|,
name|STATUS_PHASE
argument_list|,
name|BSTAT_REQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|regv
operator|<=
literal|0
condition|)
break|break;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_STAT
argument_list|)
expr_stmt|;
name|regv
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_sdna
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_statusin
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|regv
operator||
name|derror
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|regv
operator|!=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_rdata
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: STATIN: data mismatch\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
name|stg_negate_signal
argument_list|(
name|sc
argument_list|,
name|BSTAT_ACK
argument_list|,
literal|"statin<ACK>"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MESSAGE_OUT_PHASE
case|:
if|if
condition|(
name|stg_expect_signal
argument_list|(
name|sc
argument_list|,
name|MESSAGE_OUT_PHASE
argument_list|,
name|BSTAT_REQ
argument_list|)
operator|<=
literal|0
condition|)
break|break;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_MSGOUT
argument_list|)
expr_stmt|;
name|flags
operator|=
operator|(
name|ti
operator|->
name|ti_ophase
operator|!=
name|ti
operator|->
name|ti_phase
operator|)
condition|?
name|SCSI_LOW_MSGOUT_INIT
else|:
literal|0
expr_stmt|;
name|len
operator|=
name|scsi_low_msgout
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1
operator|&&
name|slp
operator|->
name|sl_atten
operator|==
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stg_xfer
argument_list|(
name|sc
argument_list|,
name|ti
operator|->
name|ti_msgoutstr
argument_list|,
name|len
argument_list|,
name|MESSAGE_OUT_PHASE
argument_list|,
name|slp
operator|->
name|sl_clear_atten
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: MSGOUT short\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|slp
operator|->
name|sl_msgphase
operator|>=
name|MSGPH_ABORT
condition|)
block|{
name|stg_disconnected
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|MESSAGE_IN_PHASE
case|:
comment|/* confirm phase and req signal */
if|if
condition|(
name|stg_expect_signal
argument_list|(
name|sc
argument_list|,
name|MESSAGE_IN_PHASE
argument_list|,
name|BSTAT_REQ
argument_list|)
operator|<=
literal|0
condition|)
break|break;
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_MSGIN
argument_list|)
expr_stmt|;
comment|/* read data with NOACK */
name|regv
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_sdna
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_msgin
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|derror
operator||
name|regv
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|scsi_low_is_msgout_continue
argument_list|(
name|ti
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_attention
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* read data with ACK */
if|if
condition|(
name|regv
operator|!=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_rdata
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s: MSGIN: data mismatch\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
comment|/* wait for the ack negated */
name|stg_negate_signal
argument_list|(
name|sc
argument_list|,
name|BSTAT_ACK
argument_list|,
literal|"msgin<ACK>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_msgphase
operator|!=
literal|0
operator|&&
name|slp
operator|->
name|sl_msgphase
operator|<
name|MSGPH_ABORT
condition|)
block|{
name|stg_disconnected
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|BUSFREE_PHASE
case|:
name|printf
argument_list|(
literal|"%s: unexpected disconnect\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|stg_disconnected
argument_list|(
name|sc
argument_list|,
name|ti
argument_list|)
expr_stmt|;
break|break;
default|default:
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|printf
argument_list|(
literal|"%s: unknown phase bus %x intr %x\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|status
argument_list|,
name|astatus
argument_list|)
expr_stmt|;
break|break;
block|}
name|out
label|:
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
name|sc
operator|->
name|sc_icinit
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stg_timeout
parameter_list|(
name|sc
parameter_list|)
name|struct
name|stg_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
operator|&
name|sc
operator|->
name|sc_sclow
decl_stmt|;
name|bus_space_tag_t
name|iot
init|=
name|sc
operator|->
name|sc_iot
decl_stmt|;
name|bus_space_handle_t
name|ioh
init|=
name|sc
operator|->
name|sc_ioh
decl_stmt|;
name|int
name|tout
decl_stmt|,
name|count
decl_stmt|;
name|u_int8_t
name|status
decl_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|status
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|PHASE_MASK
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|sc_ubf_timeout
operator|++
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|"%s: unexpected bus free detected\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|)
expr_stmt|;
name|stg_disconnected
argument_list|(
name|sc
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|status
operator|&
name|PHASE_MASK
condition|)
block|{
case|case
name|DATA_OUT_PHASE
case|:
if|if
condition|(
name|sc
operator|->
name|sc_dataout_timeout
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|status
operator|&
name|BSTAT_REQ
operator|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|bus_space_read_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fdcnt
argument_list|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
operator|--
name|sc
operator|->
name|sc_dataout_timeout
operator|)
operator|>
literal|0
condition|)
break|break;
name|slp
operator|->
name|sl_error
operator||=
name|PDMAERR
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_WRITE_PADDING
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: write padding required\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
break|break;
block|}
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tout
operator|=
name|STG_DELAY_MAX
expr_stmt|;
while|while
condition|(
name|tout
operator|--
condition|)
block|{
name|status
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|PHASE_MASK
operator|)
operator|!=
name|DATA_OUT_PHASE
condition|)
break|break;
if|if
condition|(
name|bus_space_read_2
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_fdcnt
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|SCSI_LOW_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|count
operator|=
name|sc
operator|->
name|sc_maxwsize
init|;
name|count
operator|>
literal|0
condition|;
name|count
operator|--
control|)
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_wfifo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|bus_space_read_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_bstat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|PHASE_MASK
operator|)
operator|==
name|DATA_OUT_PHASE
condition|)
name|sc
operator|->
name|sc_dataout_timeout
operator|=
name|SCSI_LOW_TIMEOUT_HZ
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|iot
argument_list|,
name|ioh
argument_list|,
name|tmc_ictl
argument_list|,
name|sc
operator|->
name|sc_icinit
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


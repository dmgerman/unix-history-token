begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.  * Copyright (c) 2005, 2006, 2007, 2008 Mellanox Technologies.  * All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/kernel.h>
end_include

begin_include
include|#
directive|include
file|"fw_qos.h"
end_include

begin_include
include|#
directive|include
file|"fw.h"
end_include

begin_enum
enum|enum
block|{
comment|/* allocate vpp opcode modifiers */
name|MLX4_ALLOCATE_VPP_ALLOCATE
init|=
literal|0x0
block|,
name|MLX4_ALLOCATE_VPP_QUERY
init|=
literal|0x1
block|}
enum|;
end_enum

begin_enum
enum|enum
block|{
comment|/* set vport qos opcode modifiers */
name|MLX4_SET_VPORT_QOS_SET
init|=
literal|0x0
block|,
name|MLX4_SET_VPORT_QOS_QUERY
init|=
literal|0x1
block|}
enum|;
end_enum

begin_struct
struct|struct
name|mlx4_set_port_prio2tc_context
block|{
name|u8
name|prio2tc
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mlx4_port_scheduler_tc_cfg_be
block|{
name|__be16
name|pg
decl_stmt|;
name|__be16
name|bw_precentage
decl_stmt|;
name|__be16
name|max_bw_units
decl_stmt|;
comment|/* 3-100Mbps, 4-1Gbps, other values - reserved */
name|__be16
name|max_bw_value
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mlx4_set_port_scheduler_context
block|{
name|struct
name|mlx4_port_scheduler_tc_cfg_be
name|tc
index|[
name|MLX4_NUM_TC
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Granular Qos (per VF) section */
end_comment

begin_struct
struct|struct
name|mlx4_alloc_vpp_param
block|{
name|__be32
name|availible_vpp
decl_stmt|;
name|__be32
name|vpp_p_up
index|[
name|MLX4_NUM_UP
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mlx4_prio_qos_param
block|{
name|__be32
name|bw_share
decl_stmt|;
name|__be32
name|max_avg_bw
decl_stmt|;
name|__be32
name|reserved
decl_stmt|;
name|__be32
name|enable
decl_stmt|;
name|__be32
name|reserved1
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|mlx4_set_vport_context
block|{
name|__be32
name|reserved
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|mlx4_prio_qos_param
name|qos_p_up
index|[
name|MLX4_NUM_UP
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|int
name|mlx4_SET_PORT_PRIO2TC
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u8
modifier|*
name|prio2tc
parameter_list|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_set_port_prio2tc_context
modifier|*
name|context
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|in_mod
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|context
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_NUM_UP
condition|;
name|i
operator|+=
literal|2
control|)
name|context
operator|->
name|prio2tc
index|[
name|i
operator|>>
literal|1
index|]
operator|=
name|prio2tc
index|[
name|i
index|]
operator|<<
literal|4
operator||
name|prio2tc
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|in_mod
operator|=
name|MLX4_SET_PORT_PRIO2TC
operator|<<
literal|8
operator||
name|port
expr_stmt|;
name|err
operator|=
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|in_mod
argument_list|,
literal|1
argument_list|,
name|MLX4_CMD_SET_PORT
argument_list|,
name|MLX4_CMD_TIME_CLASS_B
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx4_SET_PORT_PRIO2TC
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_SET_PORT_SCHEDULER
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u8
modifier|*
name|tc_tx_bw
parameter_list|,
name|u8
modifier|*
name|pg
parameter_list|,
name|u16
modifier|*
name|ratelimit
parameter_list|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_set_port_scheduler_context
modifier|*
name|context
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|in_mod
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|context
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_NUM_TC
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mlx4_port_scheduler_tc_cfg_be
modifier|*
name|tc
init|=
operator|&
name|context
operator|->
name|tc
index|[
name|i
index|]
decl_stmt|;
name|u16
name|r
decl_stmt|;
if|if
condition|(
name|ratelimit
operator|&&
name|ratelimit
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|ratelimit
index|[
name|i
index|]
operator|<=
name|MLX4_MAX_100M_UNITS_VAL
condition|)
block|{
name|r
operator|=
name|ratelimit
index|[
name|i
index|]
expr_stmt|;
name|tc
operator|->
name|max_bw_units
operator|=
name|htons
argument_list|(
name|MLX4_RATELIMIT_100M_UNITS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|ratelimit
index|[
name|i
index|]
operator|/
literal|10
expr_stmt|;
name|tc
operator|->
name|max_bw_units
operator|=
name|htons
argument_list|(
name|MLX4_RATELIMIT_1G_UNITS
argument_list|)
expr_stmt|;
block|}
name|tc
operator|->
name|max_bw_value
operator|=
name|htons
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tc
operator|->
name|max_bw_value
operator|=
name|htons
argument_list|(
name|MLX4_RATELIMIT_DEFAULT
argument_list|)
expr_stmt|;
name|tc
operator|->
name|max_bw_units
operator|=
name|htons
argument_list|(
name|MLX4_RATELIMIT_1G_UNITS
argument_list|)
expr_stmt|;
block|}
name|tc
operator|->
name|pg
operator|=
name|htons
argument_list|(
name|pg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|tc
operator|->
name|bw_precentage
operator|=
name|htons
argument_list|(
name|tc_tx_bw
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|in_mod
operator|=
name|MLX4_SET_PORT_SCHEDULER
operator|<<
literal|8
operator||
name|port
expr_stmt|;
name|err
operator|=
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|in_mod
argument_list|,
literal|1
argument_list|,
name|MLX4_CMD_SET_PORT
argument_list|,
name|MLX4_CMD_TIME_CLASS_B
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx4_SET_PORT_SCHEDULER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_ALLOCATE_VPP_get
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u16
modifier|*
name|availible_vpp
parameter_list|,
name|u8
modifier|*
name|vpp_p_up
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_alloc_vpp_param
modifier|*
name|out_param
decl_stmt|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|out_param
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|err
operator|=
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|port
argument_list|,
name|MLX4_ALLOCATE_VPP_QUERY
argument_list|,
name|MLX4_CMD_ALLOCATE_VPP
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
comment|/* Total number of supported VPPs */
operator|*
name|availible_vpp
operator|=
operator|(
name|u16
operator|)
name|be32_to_cpu
argument_list|(
name|out_param
operator|->
name|availible_vpp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_NUM_UP
condition|;
name|i
operator|++
control|)
name|vpp_p_up
index|[
name|i
index|]
operator|=
operator|(
name|u8
operator|)
name|be32_to_cpu
argument_list|(
name|out_param
operator|->
name|vpp_p_up
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|out
label|:
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx4_ALLOCATE_VPP_get
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_ALLOCATE_VPP_set
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u8
modifier|*
name|vpp_p_up
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_alloc_vpp_param
modifier|*
name|in_param
decl_stmt|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|in_param
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_NUM_UP
condition|;
name|i
operator|++
control|)
name|in_param
operator|->
name|vpp_p_up
index|[
name|i
index|]
operator|=
name|cpu_to_be32
argument_list|(
name|vpp_p_up
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|port
argument_list|,
name|MLX4_ALLOCATE_VPP_ALLOCATE
argument_list|,
name|MLX4_CMD_ALLOCATE_VPP
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx4_ALLOCATE_VPP_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_SET_VPORT_QOS_get
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u8
name|vport
parameter_list|,
name|struct
name|mlx4_vport_qos_param
modifier|*
name|out_param
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_set_vport_context
modifier|*
name|ctx
decl_stmt|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|ctx
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|err
operator|=
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
operator|(
name|vport
operator|<<
literal|8
operator|)
operator||
name|port
argument_list|,
name|MLX4_SET_VPORT_QOS_QUERY
argument_list|,
name|MLX4_CMD_SET_VPORT_QOS
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_NUM_UP
condition|;
name|i
operator|++
control|)
block|{
name|out_param
index|[
name|i
index|]
operator|.
name|bw_share
operator|=
name|be32_to_cpu
argument_list|(
name|ctx
operator|->
name|qos_p_up
index|[
name|i
index|]
operator|.
name|bw_share
argument_list|)
expr_stmt|;
name|out_param
index|[
name|i
index|]
operator|.
name|max_avg_bw
operator|=
name|be32_to_cpu
argument_list|(
name|ctx
operator|->
name|qos_p_up
index|[
name|i
index|]
operator|.
name|max_avg_bw
argument_list|)
expr_stmt|;
name|out_param
index|[
name|i
index|]
operator|.
name|enable
operator|=
operator|!
operator|!
operator|(
name|be32_to_cpu
argument_list|(
name|ctx
operator|->
name|qos_p_up
index|[
name|i
index|]
operator|.
name|enable
argument_list|)
operator|&
literal|31
operator|)
expr_stmt|;
block|}
name|out
label|:
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx4_SET_VPORT_QOS_get
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_SET_VPORT_QOS_set
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u8
name|vport
parameter_list|,
name|struct
name|mlx4_vport_qos_param
modifier|*
name|in_param
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_set_vport_context
modifier|*
name|ctx
decl_stmt|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|ctx
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_NUM_UP
condition|;
name|i
operator|++
control|)
block|{
name|ctx
operator|->
name|qos_p_up
index|[
name|i
index|]
operator|.
name|bw_share
operator|=
name|cpu_to_be32
argument_list|(
name|in_param
index|[
name|i
index|]
operator|.
name|bw_share
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|qos_p_up
index|[
name|i
index|]
operator|.
name|max_avg_bw
operator|=
name|cpu_to_be32
argument_list|(
name|in_param
index|[
name|i
index|]
operator|.
name|max_avg_bw
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|qos_p_up
index|[
name|i
index|]
operator|.
name|enable
operator|=
name|cpu_to_be32
argument_list|(
name|in_param
index|[
name|i
index|]
operator|.
name|enable
operator|<<
literal|31
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
operator|(
name|vport
operator|<<
literal|8
operator|)
operator||
name|port
argument_list|,
name|MLX4_SET_VPORT_QOS_SET
argument_list|,
name|MLX4_CMD_SET_VPORT_QOS
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx4_SET_VPORT_QOS_set
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


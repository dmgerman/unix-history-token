begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004 Topspin Communications.  All rights reserved.  * Copyright (c) 2005, 2006, 2007, 2008, 2014 Mellanox Technologies. All rights reserved.  * Copyright (c) 2006, 2007 Cisco Systems, Inc.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/err.h>
end_include

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/kernel.h>
end_include

begin_include
include|#
directive|include
file|<linux/vmalloc.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx4/cmd.h>
end_include

begin_include
include|#
directive|include
file|<linux/math64.h>
end_include

begin_include
include|#
directive|include
file|"mlx4.h"
end_include

begin_include
include|#
directive|include
file|"icm.h"
end_include

begin_function
specifier|static
name|u32
name|mlx4_buddy_alloc
parameter_list|(
name|struct
name|mlx4_buddy
modifier|*
name|buddy
parameter_list|,
name|int
name|order
parameter_list|)
block|{
name|int
name|o
decl_stmt|;
name|int
name|m
decl_stmt|;
name|u32
name|seg
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|buddy
operator|->
name|lock
argument_list|)
expr_stmt|;
for|for
control|(
name|o
operator|=
name|order
init|;
name|o
operator|<=
name|buddy
operator|->
name|max_order
condition|;
operator|++
name|o
control|)
if|if
condition|(
name|buddy
operator|->
name|num_free
index|[
name|o
index|]
condition|)
block|{
name|m
operator|=
literal|1
operator|<<
operator|(
name|buddy
operator|->
name|max_order
operator|-
name|o
operator|)
expr_stmt|;
name|seg
operator|=
name|find_first_bit
argument_list|(
name|buddy
operator|->
name|bits
index|[
name|o
index|]
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|seg
operator|<
name|m
condition|)
goto|goto
name|found
goto|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|buddy
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
name|found
label|:
name|clear_bit
argument_list|(
name|seg
argument_list|,
name|buddy
operator|->
name|bits
index|[
name|o
index|]
argument_list|)
expr_stmt|;
operator|--
name|buddy
operator|->
name|num_free
index|[
name|o
index|]
expr_stmt|;
while|while
condition|(
name|o
operator|>
name|order
condition|)
block|{
operator|--
name|o
expr_stmt|;
name|seg
operator|<<=
literal|1
expr_stmt|;
name|set_bit
argument_list|(
name|seg
operator|^
literal|1
argument_list|,
name|buddy
operator|->
name|bits
index|[
name|o
index|]
argument_list|)
expr_stmt|;
operator|++
name|buddy
operator|->
name|num_free
index|[
name|o
index|]
expr_stmt|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|buddy
operator|->
name|lock
argument_list|)
expr_stmt|;
name|seg
operator|<<=
name|order
expr_stmt|;
return|return
name|seg
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_buddy_free
parameter_list|(
name|struct
name|mlx4_buddy
modifier|*
name|buddy
parameter_list|,
name|u32
name|seg
parameter_list|,
name|int
name|order
parameter_list|)
block|{
name|seg
operator|>>=
name|order
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|buddy
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|test_bit
argument_list|(
name|seg
operator|^
literal|1
argument_list|,
name|buddy
operator|->
name|bits
index|[
name|order
index|]
argument_list|)
condition|)
block|{
name|clear_bit
argument_list|(
name|seg
operator|^
literal|1
argument_list|,
name|buddy
operator|->
name|bits
index|[
name|order
index|]
argument_list|)
expr_stmt|;
operator|--
name|buddy
operator|->
name|num_free
index|[
name|order
index|]
expr_stmt|;
name|seg
operator|>>=
literal|1
expr_stmt|;
operator|++
name|order
expr_stmt|;
block|}
name|set_bit
argument_list|(
name|seg
argument_list|,
name|buddy
operator|->
name|bits
index|[
name|order
index|]
argument_list|)
expr_stmt|;
operator|++
name|buddy
operator|->
name|num_free
index|[
name|order
index|]
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|buddy
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_buddy_init
parameter_list|(
name|struct
name|mlx4_buddy
modifier|*
name|buddy
parameter_list|,
name|int
name|max_order
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|s
decl_stmt|;
name|buddy
operator|->
name|max_order
operator|=
name|max_order
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|buddy
operator|->
name|lock
argument_list|)
expr_stmt|;
name|buddy
operator|->
name|bits
operator|=
name|kcalloc
argument_list|(
name|buddy
operator|->
name|max_order
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|long
operator|*
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|buddy
operator|->
name|num_free
operator|=
name|kcalloc
argument_list|(
operator|(
name|buddy
operator|->
name|max_order
operator|+
literal|1
operator|)
argument_list|,
sizeof|sizeof
expr|*
name|buddy
operator|->
name|num_free
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buddy
operator|->
name|bits
operator|||
operator|!
name|buddy
operator|->
name|num_free
condition|)
goto|goto
name|err_out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|buddy
operator|->
name|max_order
condition|;
operator|++
name|i
control|)
block|{
name|s
operator|=
name|BITS_TO_LONGS
argument_list|(
literal|1
operator|<<
operator|(
name|buddy
operator|->
name|max_order
operator|-
name|i
operator|)
argument_list|)
expr_stmt|;
name|buddy
operator|->
name|bits
index|[
name|i
index|]
operator|=
name|kcalloc
argument_list|(
name|s
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|,
name|GFP_KERNEL
operator||
name|__GFP_NOWARN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buddy
operator|->
name|bits
index|[
name|i
index|]
condition|)
block|{
name|buddy
operator|->
name|bits
index|[
name|i
index|]
operator|=
name|vzalloc
argument_list|(
name|s
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buddy
operator|->
name|bits
index|[
name|i
index|]
condition|)
goto|goto
name|err_out_free
goto|;
block|}
block|}
name|set_bit
argument_list|(
literal|0
argument_list|,
name|buddy
operator|->
name|bits
index|[
name|buddy
operator|->
name|max_order
index|]
argument_list|)
expr_stmt|;
name|buddy
operator|->
name|num_free
index|[
name|buddy
operator|->
name|max_order
index|]
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
name|err_out_free
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|buddy
operator|->
name|max_order
condition|;
operator|++
name|i
control|)
name|kvfree
argument_list|(
name|buddy
operator|->
name|bits
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|err_out
label|:
name|kfree
argument_list|(
name|buddy
operator|->
name|bits
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|buddy
operator|->
name|num_free
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_buddy_cleanup
parameter_list|(
name|struct
name|mlx4_buddy
modifier|*
name|buddy
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|buddy
operator|->
name|max_order
condition|;
operator|++
name|i
control|)
name|kvfree
argument_list|(
name|buddy
operator|->
name|bits
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|buddy
operator|->
name|bits
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|buddy
operator|->
name|num_free
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u32
name|__mlx4_alloc_mtt_range
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|order
parameter_list|)
block|{
name|struct
name|mlx4_mr_table
modifier|*
name|mr_table
init|=
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|mr_table
decl_stmt|;
name|u32
name|seg
decl_stmt|;
name|int
name|seg_order
decl_stmt|;
name|u32
name|offset
decl_stmt|;
name|seg_order
operator|=
name|max_t
argument_list|(
name|int
argument_list|,
name|order
operator|-
name|log_mtts_per_seg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|seg
operator|=
name|mlx4_buddy_alloc
argument_list|(
operator|&
name|mr_table
operator|->
name|mtt_buddy
argument_list|,
name|seg_order
argument_list|)
expr_stmt|;
if|if
condition|(
name|seg
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|offset
operator|=
name|seg
operator|*
operator|(
literal|1
operator|<<
name|log_mtts_per_seg
operator|)
expr_stmt|;
if|if
condition|(
name|mlx4_table_get_range
argument_list|(
name|dev
argument_list|,
operator|&
name|mr_table
operator|->
name|mtt_table
argument_list|,
name|offset
argument_list|,
name|offset
operator|+
operator|(
literal|1
operator|<<
name|order
operator|)
operator|-
literal|1
argument_list|)
condition|)
block|{
name|mlx4_buddy_free
argument_list|(
operator|&
name|mr_table
operator|->
name|mtt_buddy
argument_list|,
name|seg
argument_list|,
name|seg_order
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|offset
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|mlx4_alloc_mtt_range
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|order
parameter_list|)
block|{
name|u64
name|in_param
init|=
literal|0
decl_stmt|;
name|u64
name|out_param
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|set_param_l
argument_list|(
operator|&
name|in_param
argument_list|,
name|order
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_cmd_imm
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
operator|&
name|out_param
argument_list|,
name|RES_MTT
argument_list|,
name|RES_OP_RESERVE_AND_MAP
argument_list|,
name|MLX4_CMD_ALLOC_RES
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|get_param_l
argument_list|(
operator|&
name|out_param
argument_list|)
return|;
block|}
return|return
name|__mlx4_alloc_mtt_range
argument_list|(
name|dev
argument_list|,
name|order
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mlx4_mtt_init
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|int
name|npages
parameter_list|,
name|int
name|page_shift
parameter_list|,
name|struct
name|mlx4_mtt
modifier|*
name|mtt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|npages
condition|)
block|{
name|mtt
operator|->
name|order
operator|=
operator|-
literal|1
expr_stmt|;
name|mtt
operator|->
name|page_shift
operator|=
name|MLX4_ICM_PAGE_SHIFT
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
name|mtt
operator|->
name|page_shift
operator|=
name|page_shift
expr_stmt|;
for|for
control|(
name|mtt
operator|->
name|order
operator|=
literal|0
operator|,
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|npages
condition|;
name|i
operator|<<=
literal|1
control|)
operator|++
name|mtt
operator|->
name|order
expr_stmt|;
name|mtt
operator|->
name|offset
operator|=
name|mlx4_alloc_mtt_range
argument_list|(
name|dev
argument_list|,
name|mtt
operator|->
name|order
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtt
operator|->
name|offset
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
name|ENOMEM
return|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mtt_init
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|__mlx4_free_mtt_range
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|offset
parameter_list|,
name|int
name|order
parameter_list|)
block|{
name|u32
name|first_seg
decl_stmt|;
name|int
name|seg_order
decl_stmt|;
name|struct
name|mlx4_mr_table
modifier|*
name|mr_table
init|=
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|mr_table
decl_stmt|;
name|seg_order
operator|=
name|max_t
argument_list|(
name|int
argument_list|,
name|order
operator|-
name|log_mtts_per_seg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|first_seg
operator|=
name|offset
operator|/
operator|(
literal|1
operator|<<
name|log_mtts_per_seg
operator|)
expr_stmt|;
name|mlx4_buddy_free
argument_list|(
operator|&
name|mr_table
operator|->
name|mtt_buddy
argument_list|,
name|first_seg
argument_list|,
name|seg_order
argument_list|)
expr_stmt|;
name|mlx4_table_put_range
argument_list|(
name|dev
argument_list|,
operator|&
name|mr_table
operator|->
name|mtt_table
argument_list|,
name|offset
argument_list|,
name|offset
operator|+
operator|(
literal|1
operator|<<
name|order
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_free_mtt_range
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|offset
parameter_list|,
name|int
name|order
parameter_list|)
block|{
name|u64
name|in_param
init|=
literal|0
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|set_param_l
argument_list|(
operator|&
name|in_param
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|set_param_h
argument_list|(
operator|&
name|in_param
argument_list|,
name|order
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|RES_MTT
argument_list|,
name|RES_OP_RESERVE_AND_MAP
argument_list|,
name|MLX4_CMD_FREE_RES
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Failed to free mtt range at:%d order:%d\n"
argument_list|,
name|offset
argument_list|,
name|order
argument_list|)
expr_stmt|;
return|return;
block|}
name|__mlx4_free_mtt_range
argument_list|(
name|dev
argument_list|,
name|offset
argument_list|,
name|order
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx4_mtt_cleanup
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mtt
modifier|*
name|mtt
parameter_list|)
block|{
if|if
condition|(
name|mtt
operator|->
name|order
operator|<
literal|0
condition|)
return|return;
name|mlx4_free_mtt_range
argument_list|(
name|dev
argument_list|,
name|mtt
operator|->
name|offset
argument_list|,
name|mtt
operator|->
name|order
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mtt_cleanup
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|u64
name|mlx4_mtt_addr
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mtt
modifier|*
name|mtt
parameter_list|)
block|{
return|return
operator|(
name|u64
operator|)
name|mtt
operator|->
name|offset
operator|*
name|dev
operator|->
name|caps
operator|.
name|mtt_entry_sz
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mtt_addr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|u32
name|hw_index_to_key
parameter_list|(
name|u32
name|ind
parameter_list|)
block|{
return|return
operator|(
name|ind
operator|>>
literal|24
operator|)
operator||
operator|(
name|ind
operator|<<
literal|8
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|key_to_hw_index
parameter_list|(
name|u32
name|key
parameter_list|)
block|{
return|return
operator|(
name|key
operator|<<
literal|24
operator|)
operator||
operator|(
name|key
operator|>>
literal|8
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_SW2HW_MPT
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|mpt_index
parameter_list|)
block|{
return|return
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|mpt_index
argument_list|,
literal|0
argument_list|,
name|MLX4_CMD_SW2HW_MPT
argument_list|,
name|MLX4_CMD_TIME_CLASS_B
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_HW2SW_MPT
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|mpt_index
parameter_list|)
block|{
return|return
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
condition|?
name|mailbox
operator|->
name|dma
else|:
literal|0
argument_list|,
name|mpt_index
argument_list|,
operator|!
name|mailbox
argument_list|,
name|MLX4_CMD_HW2SW_MPT
argument_list|,
name|MLX4_CMD_TIME_CLASS_B
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Must protect against concurrent access */
end_comment

begin_function
name|int
name|mlx4_mr_hw_get_mpt
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mmr
parameter_list|,
name|struct
name|mlx4_mpt_entry
modifier|*
modifier|*
modifier|*
name|mpt_entry
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|key
init|=
name|key_to_hw_index
argument_list|(
name|mmr
operator|->
name|key
argument_list|)
operator|&
operator|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
operator|-
literal|1
operator|)
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|mmr
operator|->
name|enabled
operator|!=
name|MLX4_MPT_EN_HW
condition|)
return|return
operator|-
name|EINVAL
return|;
name|err
operator|=
name|mlx4_HW2SW_MPT
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"HW2SW_MPT failed (%d)."
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Most likely the MR has MWs bound to it.\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|mmr
operator|->
name|enabled
operator|=
name|MLX4_MPT_EN_SW
expr_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
operator|*
operator|*
name|mpt_entry
operator|=
name|mlx4_table_find
argument_list|(
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|mr_table
operator|.
name|dmpt_table
argument_list|,
name|key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|err
operator|=
name|mlx4_cmd_box
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
name|MLX4_CMD_QUERY_MPT
argument_list|,
name|MLX4_CMD_TIME_CLASS_B
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|free_mailbox
goto|;
operator|*
name|mpt_entry
operator|=
operator|(
expr|struct
name|mlx4_mpt_entry
operator|*
operator|*
operator|)
operator|&
name|mailbox
operator|->
name|buf
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
operator|*
name|mpt_entry
operator|)
operator|||
operator|!
operator|(
operator|*
operator|*
name|mpt_entry
operator|)
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|free_mailbox
goto|;
block|}
return|return
literal|0
return|;
name|free_mailbox
label|:
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_hw_get_mpt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_mr_hw_write_mpt
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mmr
parameter_list|,
name|struct
name|mlx4_mpt_entry
modifier|*
modifier|*
name|mpt_entry
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
comment|/* Make sure any changes to this entry are flushed */
name|wmb
argument_list|()
expr_stmt|;
operator|*
operator|(
name|u8
operator|*
operator|)
operator|(
operator|*
name|mpt_entry
operator|)
operator|=
name|MLX4_MPT_STATUS_HW
expr_stmt|;
comment|/* Make sure the new status is written */
name|wmb
argument_list|()
expr_stmt|;
name|err
operator|=
name|mlx4_SYNC_TPT
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|key
init|=
name|key_to_hw_index
argument_list|(
name|mmr
operator|->
name|key
argument_list|)
operator|&
operator|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
operator|-
literal|1
operator|)
decl_stmt|;
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
init|=
name|container_of
argument_list|(
operator|(
name|void
operator|*
operator|)
name|mpt_entry
argument_list|,
expr|struct
name|mlx4_cmd_mailbox
argument_list|,
name|buf
argument_list|)
decl_stmt|;
name|err
operator|=
name|mlx4_SW2HW_MPT
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|err
condition|)
block|{
name|mmr
operator|->
name|pd
operator|=
name|be32_to_cpu
argument_list|(
operator|(
operator|*
name|mpt_entry
operator|)
operator|->
name|pd_flags
argument_list|)
operator|&
name|MLX4_MPT_PD_MASK
expr_stmt|;
name|mmr
operator|->
name|enabled
operator|=
name|MLX4_MPT_EN_HW
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_hw_write_mpt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx4_mr_hw_put_mpt
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mpt_entry
modifier|*
modifier|*
name|mpt_entry
parameter_list|)
block|{
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
init|=
name|container_of
argument_list|(
operator|(
name|void
operator|*
operator|)
name|mpt_entry
argument_list|,
expr|struct
name|mlx4_cmd_mailbox
argument_list|,
name|buf
argument_list|)
decl_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_hw_put_mpt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_mr_hw_change_pd
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mpt_entry
modifier|*
name|mpt_entry
parameter_list|,
name|u32
name|pdn
parameter_list|)
block|{
name|u32
name|pd_flags
init|=
name|be32_to_cpu
argument_list|(
name|mpt_entry
operator|->
name|pd_flags
argument_list|)
operator|&
operator|~
name|MLX4_MPT_PD_MASK
decl_stmt|;
comment|/* The wrapper function will put the slave's id here */
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
name|pd_flags
operator|&=
operator|~
name|MLX4_MPT_PD_VF_MASK
expr_stmt|;
name|mpt_entry
operator|->
name|pd_flags
operator|=
name|cpu_to_be32
argument_list|(
name|pd_flags
operator||
operator|(
name|pdn
operator|&
name|MLX4_MPT_PD_MASK
operator|)
operator||
name|MLX4_MPT_PD_FLAG_EN_INV
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_hw_change_pd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_mr_hw_change_access
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mpt_entry
modifier|*
name|mpt_entry
parameter_list|,
name|u32
name|access
parameter_list|)
block|{
name|u32
name|flags
init|=
operator|(
name|be32_to_cpu
argument_list|(
name|mpt_entry
operator|->
name|flags
argument_list|)
operator|&
operator|~
name|MLX4_PERM_MASK
operator|)
operator||
operator|(
name|access
operator|&
name|MLX4_PERM_MASK
operator|)
decl_stmt|;
name|mpt_entry
operator|->
name|flags
operator|=
name|cpu_to_be32
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_hw_change_access
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|mlx4_mr_alloc_reserved
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|mridx
parameter_list|,
name|u32
name|pd
parameter_list|,
name|u64
name|iova
parameter_list|,
name|u64
name|size
parameter_list|,
name|u32
name|access
parameter_list|,
name|int
name|npages
parameter_list|,
name|int
name|page_shift
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mr
parameter_list|)
block|{
name|mr
operator|->
name|iova
operator|=
name|iova
expr_stmt|;
name|mr
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|mr
operator|->
name|pd
operator|=
name|pd
expr_stmt|;
name|mr
operator|->
name|access
operator|=
name|access
expr_stmt|;
name|mr
operator|->
name|enabled
operator|=
name|MLX4_MPT_DISABLED
expr_stmt|;
name|mr
operator|->
name|key
operator|=
name|hw_index_to_key
argument_list|(
name|mridx
argument_list|)
expr_stmt|;
return|return
name|mlx4_mtt_init
argument_list|(
name|dev
argument_list|,
name|npages
argument_list|,
name|page_shift
argument_list|,
operator|&
name|mr
operator|->
name|mtt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_WRITE_MTT
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
parameter_list|,
name|int
name|num_entries
parameter_list|)
block|{
return|return
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|,
name|num_entries
argument_list|,
literal|0
argument_list|,
name|MLX4_CMD_WRITE_MTT
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|__mlx4_mpt_reserve
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
return|return
name|mlx4_bitmap_alloc
argument_list|(
operator|&
name|priv
operator|->
name|mr_table
operator|.
name|mpt_bitmap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_mpt_reserve
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|u64
name|out_param
decl_stmt|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
name|mlx4_cmd_imm
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
operator|&
name|out_param
argument_list|,
name|RES_MPT
argument_list|,
name|RES_OP_RESERVE
argument_list|,
name|MLX4_CMD_ALLOC_RES
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|get_param_l
argument_list|(
operator|&
name|out_param
argument_list|)
return|;
block|}
return|return
name|__mlx4_mpt_reserve
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|__mlx4_mpt_release
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|index
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mlx4_bitmap_free
argument_list|(
operator|&
name|priv
operator|->
name|mr_table
operator|.
name|mpt_bitmap
argument_list|,
name|index
argument_list|,
name|MLX4_NO_RR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_mpt_release
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|index
parameter_list|)
block|{
name|u64
name|in_param
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|set_param_l
argument_list|(
operator|&
name|in_param
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|RES_MPT
argument_list|,
name|RES_OP_RESERVE
argument_list|,
name|MLX4_CMD_FREE_RES
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Failed to release mr index:%d\n"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return;
block|}
name|__mlx4_mpt_release
argument_list|(
name|dev
argument_list|,
name|index
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|__mlx4_mpt_alloc_icm
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|index
parameter_list|,
name|gfp_t
name|gfp
parameter_list|)
block|{
name|struct
name|mlx4_mr_table
modifier|*
name|mr_table
init|=
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|mr_table
decl_stmt|;
return|return
name|mlx4_table_get
argument_list|(
name|dev
argument_list|,
operator|&
name|mr_table
operator|->
name|dmpt_table
argument_list|,
name|index
argument_list|,
name|gfp
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_mpt_alloc_icm
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|index
parameter_list|,
name|gfp_t
name|gfp
parameter_list|)
block|{
name|u64
name|param
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|set_param_l
argument_list|(
operator|&
name|param
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|mlx4_cmd_imm
argument_list|(
name|dev
argument_list|,
name|param
argument_list|,
operator|&
name|param
argument_list|,
name|RES_MPT
argument_list|,
name|RES_OP_MAP_ICM
argument_list|,
name|MLX4_CMD_ALLOC_RES
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
return|;
block|}
return|return
name|__mlx4_mpt_alloc_icm
argument_list|(
name|dev
argument_list|,
name|index
argument_list|,
name|gfp
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|__mlx4_mpt_free_icm
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|index
parameter_list|)
block|{
name|struct
name|mlx4_mr_table
modifier|*
name|mr_table
init|=
operator|&
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
operator|->
name|mr_table
decl_stmt|;
name|mlx4_table_put
argument_list|(
name|dev
argument_list|,
operator|&
name|mr_table
operator|->
name|dmpt_table
argument_list|,
name|index
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_mpt_free_icm
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|index
parameter_list|)
block|{
name|u64
name|in_param
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|set_param_l
argument_list|(
operator|&
name|in_param
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
name|in_param
argument_list|,
name|RES_MPT
argument_list|,
name|RES_OP_MAP_ICM
argument_list|,
name|MLX4_CMD_FREE_RES
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_WRAPPED
argument_list|)
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"Failed to free icm of mr index:%d\n"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return;
block|}
return|return
name|__mlx4_mpt_free_icm
argument_list|(
name|dev
argument_list|,
name|index
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mlx4_mr_alloc
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|pd
parameter_list|,
name|u64
name|iova
parameter_list|,
name|u64
name|size
parameter_list|,
name|u32
name|access
parameter_list|,
name|int
name|npages
parameter_list|,
name|int
name|page_shift
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mr
parameter_list|)
block|{
name|u32
name|index
decl_stmt|;
name|int
name|err
decl_stmt|;
name|index
operator|=
name|mlx4_mpt_reserve
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|err
operator|=
name|mlx4_mr_alloc_reserved
argument_list|(
name|dev
argument_list|,
name|index
argument_list|,
name|pd
argument_list|,
name|iova
argument_list|,
name|size
argument_list|,
name|access
argument_list|,
name|npages
argument_list|,
name|page_shift
argument_list|,
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx4_mpt_release
argument_list|(
name|dev
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_alloc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|mlx4_mr_free_reserved
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mr
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
name|mr
operator|->
name|enabled
operator|==
name|MLX4_MPT_EN_HW
condition|)
block|{
name|err
operator|=
name|mlx4_HW2SW_MPT
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|,
name|key_to_hw_index
argument_list|(
name|mr
operator|->
name|key
argument_list|)
operator|&
operator|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"HW2SW_MPT failed (%d), MR has MWs bound to it\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|mr
operator|->
name|enabled
operator|=
name|MLX4_MPT_EN_SW
expr_stmt|;
block|}
name|mlx4_mtt_cleanup
argument_list|(
name|dev
argument_list|,
operator|&
name|mr
operator|->
name|mtt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|mlx4_mr_free
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mr
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|mlx4_mr_free_reserved
argument_list|(
name|dev
argument_list|,
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|mr
operator|->
name|enabled
condition|)
name|mlx4_mpt_free_icm
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mr
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|mlx4_mpt_release
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mr
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_free
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx4_mr_rereg_mem_cleanup
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mr
parameter_list|)
block|{
name|mlx4_mtt_cleanup
argument_list|(
name|dev
argument_list|,
operator|&
name|mr
operator|->
name|mtt
argument_list|)
expr_stmt|;
name|mr
operator|->
name|mtt
operator|.
name|order
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_rereg_mem_cleanup
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_mr_rereg_mem_write
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mr
parameter_list|,
name|u64
name|iova
parameter_list|,
name|u64
name|size
parameter_list|,
name|int
name|npages
parameter_list|,
name|int
name|page_shift
parameter_list|,
name|struct
name|mlx4_mpt_entry
modifier|*
name|mpt_entry
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx4_mtt_init
argument_list|(
name|dev
argument_list|,
name|npages
argument_list|,
name|page_shift
argument_list|,
operator|&
name|mr
operator|->
name|mtt
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|mpt_entry
operator|->
name|start
operator|=
name|cpu_to_be64
argument_list|(
name|iova
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|length
operator|=
name|cpu_to_be64
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|entity_size
operator|=
name|cpu_to_be32
argument_list|(
name|page_shift
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|flags
operator|&=
operator|~
operator|(
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_FREE
operator||
name|MLX4_MPT_FLAG_SW_OWNS
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|mr
operator|->
name|mtt
operator|.
name|order
operator|<
literal|0
condition|)
block|{
name|mpt_entry
operator|->
name|flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_PHYSICAL
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|mtt_addr
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|mpt_entry
operator|->
name|mtt_addr
operator|=
name|cpu_to_be64
argument_list|(
name|mlx4_mtt_addr
argument_list|(
name|dev
argument_list|,
operator|&
name|mr
operator|->
name|mtt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mr
operator|->
name|mtt
operator|.
name|page_shift
operator|==
literal|0
condition|)
name|mpt_entry
operator|->
name|mtt_sz
operator|=
name|cpu_to_be32
argument_list|(
literal|1
operator|<<
name|mr
operator|->
name|mtt
operator|.
name|order
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mr
operator|->
name|mtt
operator|.
name|order
operator|>=
literal|0
operator|&&
name|mr
operator|->
name|mtt
operator|.
name|page_shift
operator|==
literal|0
condition|)
block|{
comment|/* fast register MR in free state */
name|mpt_entry
operator|->
name|flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_FREE
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|pd_flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_PD_FLAG_FAST_REG
operator||
name|MLX4_MPT_PD_FLAG_RAE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mpt_entry
operator|->
name|flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_SW_OWNS
argument_list|)
expr_stmt|;
block|}
name|mr
operator|->
name|enabled
operator|=
name|MLX4_MPT_EN_SW
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_rereg_mem_write
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_mr_enable
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mr
modifier|*
name|mr
parameter_list|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_mpt_entry
modifier|*
name|mpt_entry
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx4_mpt_alloc_icm
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mr
operator|->
name|key
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
goto|goto
name|err_table
goto|;
block|}
name|mpt_entry
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
name|mpt_entry
operator|->
name|flags
operator|=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_MIO
operator||
name|MLX4_MPT_FLAG_REGION
operator||
name|mr
operator|->
name|access
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|key
operator|=
name|cpu_to_be32
argument_list|(
name|key_to_hw_index
argument_list|(
name|mr
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|pd_flags
operator|=
name|cpu_to_be32
argument_list|(
name|mr
operator|->
name|pd
operator||
name|MLX4_MPT_PD_FLAG_EN_INV
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|start
operator|=
name|cpu_to_be64
argument_list|(
name|mr
operator|->
name|iova
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|length
operator|=
name|cpu_to_be64
argument_list|(
name|mr
operator|->
name|size
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|entity_size
operator|=
name|cpu_to_be32
argument_list|(
name|mr
operator|->
name|mtt
operator|.
name|page_shift
argument_list|)
expr_stmt|;
if|if
condition|(
name|mr
operator|->
name|mtt
operator|.
name|order
operator|<
literal|0
condition|)
block|{
name|mpt_entry
operator|->
name|flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_PHYSICAL
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|mtt_addr
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|mpt_entry
operator|->
name|mtt_addr
operator|=
name|cpu_to_be64
argument_list|(
name|mlx4_mtt_addr
argument_list|(
name|dev
argument_list|,
operator|&
name|mr
operator|->
name|mtt
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mr
operator|->
name|mtt
operator|.
name|order
operator|>=
literal|0
operator|&&
name|mr
operator|->
name|mtt
operator|.
name|page_shift
operator|==
literal|0
condition|)
block|{
comment|/* fast register MR in free state */
name|mpt_entry
operator|->
name|flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_FREE
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|pd_flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_PD_FLAG_FAST_REG
operator||
name|MLX4_MPT_PD_FLAG_RAE
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|mtt_sz
operator|=
name|cpu_to_be32
argument_list|(
literal|1
operator|<<
name|mr
operator|->
name|mtt
operator|.
name|order
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mpt_entry
operator|->
name|flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_SW_OWNS
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_SW2HW_MPT
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|,
name|key_to_hw_index
argument_list|(
name|mr
operator|->
name|key
argument_list|)
operator|&
operator|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"SW2HW_MPT failed (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_cmd
goto|;
block|}
name|mr
operator|->
name|enabled
operator|=
name|MLX4_MPT_EN_HW
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_cmd
label|:
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
name|err_table
label|:
name|mlx4_mpt_free_icm
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mr
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mr_enable
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|mlx4_write_mtt_chunk
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mtt
modifier|*
name|mtt
parameter_list|,
name|int
name|start_index
parameter_list|,
name|int
name|npages
parameter_list|,
name|u64
modifier|*
name|page_list
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|__be64
modifier|*
name|mtts
decl_stmt|;
name|dma_addr_t
name|dma_handle
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mtts
operator|=
name|mlx4_table_find
argument_list|(
operator|&
name|priv
operator|->
name|mr_table
operator|.
name|mtt_table
argument_list|,
name|mtt
operator|->
name|offset
operator|+
name|start_index
argument_list|,
operator|&
name|dma_handle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mtts
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|dma_sync_single_for_cpu
argument_list|(
operator|&
name|dev
operator|->
name|persist
operator|->
name|pdev
operator|->
name|dev
argument_list|,
name|dma_handle
argument_list|,
name|npages
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npages
condition|;
operator|++
name|i
control|)
name|mtts
index|[
name|i
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|page_list
index|[
name|i
index|]
operator||
name|MLX4_MTT_FLAG_PRESENT
argument_list|)
expr_stmt|;
name|dma_sync_single_for_device
argument_list|(
operator|&
name|dev
operator|->
name|persist
operator|->
name|pdev
operator|->
name|dev
argument_list|,
name|dma_handle
argument_list|,
name|npages
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|__mlx4_write_mtt
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mtt
modifier|*
name|mtt
parameter_list|,
name|int
name|start_index
parameter_list|,
name|int
name|npages
parameter_list|,
name|u64
modifier|*
name|page_list
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|chunk
decl_stmt|;
name|int
name|mtts_per_page
decl_stmt|;
name|int
name|max_mtts_first_page
decl_stmt|;
comment|/* compute how may mtts fit in the first page */
name|mtts_per_page
operator|=
name|PAGE_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
expr_stmt|;
name|max_mtts_first_page
operator|=
name|mtts_per_page
operator|-
operator|(
name|mtt
operator|->
name|offset
operator|+
name|start_index
operator|)
operator|%
name|mtts_per_page
expr_stmt|;
name|chunk
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|max_mtts_first_page
argument_list|,
name|npages
argument_list|)
expr_stmt|;
while|while
condition|(
name|npages
operator|>
literal|0
condition|)
block|{
name|err
operator|=
name|mlx4_write_mtt_chunk
argument_list|(
name|dev
argument_list|,
name|mtt
argument_list|,
name|start_index
argument_list|,
name|chunk
argument_list|,
name|page_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|npages
operator|-=
name|chunk
expr_stmt|;
name|start_index
operator|+=
name|chunk
expr_stmt|;
name|page_list
operator|+=
name|chunk
expr_stmt|;
name|chunk
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|mtts_per_page
argument_list|,
name|npages
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mlx4_write_mtt
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mtt
modifier|*
name|mtt
parameter_list|,
name|int
name|start_index
parameter_list|,
name|int
name|npages
parameter_list|,
name|u64
modifier|*
name|page_list
parameter_list|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
init|=
name|NULL
decl_stmt|;
name|__be64
modifier|*
name|inbox
init|=
name|NULL
decl_stmt|;
name|int
name|chunk
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|mtt
operator|->
name|order
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|mlx4_is_mfunc
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
return|;
name|inbox
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
while|while
condition|(
name|npages
operator|>
literal|0
condition|)
block|{
name|chunk
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|MLX4_MAILBOX_SIZE
operator|/
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|-
literal|2
argument_list|,
name|npages
argument_list|)
expr_stmt|;
name|inbox
index|[
literal|0
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|mtt
operator|->
name|offset
operator|+
name|start_index
argument_list|)
expr_stmt|;
name|inbox
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chunk
condition|;
operator|++
name|i
control|)
name|inbox
index|[
name|i
operator|+
literal|2
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|page_list
index|[
name|i
index|]
operator||
name|MLX4_MTT_FLAG_PRESENT
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_WRITE_MTT
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|,
name|chunk
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|npages
operator|-=
name|chunk
expr_stmt|;
name|start_index
operator|+=
name|chunk
expr_stmt|;
name|page_list
operator|+=
name|chunk
expr_stmt|;
block|}
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
return|return
name|__mlx4_write_mtt
argument_list|(
name|dev
argument_list|,
name|mtt
argument_list|,
name|start_index
argument_list|,
name|npages
argument_list|,
name|page_list
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_write_mtt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_buf_write_mtt
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mtt
modifier|*
name|mtt
parameter_list|,
name|struct
name|mlx4_buf
modifier|*
name|buf
parameter_list|,
name|gfp_t
name|gfp
parameter_list|)
block|{
name|u64
modifier|*
name|page_list
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|page_list
operator|=
name|kmalloc
argument_list|(
name|buf
operator|->
name|npages
operator|*
sizeof|sizeof
expr|*
name|page_list
argument_list|,
name|gfp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|page_list
condition|)
return|return
operator|-
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|buf
operator|->
name|npages
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|buf
operator|->
name|nbufs
operator|==
literal|1
condition|)
name|page_list
index|[
name|i
index|]
operator|=
name|buf
operator|->
name|direct
operator|.
name|map
operator|+
operator|(
name|i
operator|<<
name|buf
operator|->
name|page_shift
operator|)
expr_stmt|;
else|else
name|page_list
index|[
name|i
index|]
operator|=
name|buf
operator|->
name|page_list
index|[
name|i
index|]
operator|.
name|map
expr_stmt|;
name|err
operator|=
name|mlx4_write_mtt
argument_list|(
name|dev
argument_list|,
name|mtt
argument_list|,
literal|0
argument_list|,
name|buf
operator|->
name|npages
argument_list|,
name|page_list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|page_list
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_buf_write_mtt
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_mw_alloc
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|pd
parameter_list|,
name|enum
name|mlx4_mw_type
name|type
parameter_list|,
name|struct
name|mlx4_mw
modifier|*
name|mw
parameter_list|)
block|{
name|u32
name|index
decl_stmt|;
if|if
condition|(
operator|(
name|type
operator|==
name|MLX4_MW_TYPE_1
operator|&&
operator|!
operator|(
name|dev
operator|->
name|caps
operator|.
name|flags
operator|&
name|MLX4_DEV_CAP_FLAG_MEM_WINDOW
operator|)
operator|)
operator|||
operator|(
name|type
operator|==
name|MLX4_MW_TYPE_2
operator|&&
operator|!
operator|(
name|dev
operator|->
name|caps
operator|.
name|bmme_flags
operator|&
name|MLX4_BMME_FLAG_TYPE_2_WIN
operator|)
operator|)
condition|)
return|return
operator|-
name|ENOTSUPP
return|;
name|index
operator|=
name|mlx4_mpt_reserve
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|mw
operator|->
name|key
operator|=
name|hw_index_to_key
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|mw
operator|->
name|pd
operator|=
name|pd
expr_stmt|;
name|mw
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|mw
operator|->
name|enabled
operator|=
name|MLX4_MPT_DISABLED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mw_alloc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_mw_enable
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mw
modifier|*
name|mw
parameter_list|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|struct
name|mlx4_mpt_entry
modifier|*
name|mpt_entry
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx4_mpt_alloc_icm
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mw
operator|->
name|key
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
goto|goto
name|err_table
goto|;
block|}
name|mpt_entry
operator|=
name|mailbox
operator|->
name|buf
expr_stmt|;
comment|/* Note that the MLX4_MPT_FLAG_REGION bit in mpt_entry->flags is turned 	 * off, thus creating a memory window and not a memory region. 	 */
name|mpt_entry
operator|->
name|key
operator|=
name|cpu_to_be32
argument_list|(
name|key_to_hw_index
argument_list|(
name|mw
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|pd_flags
operator|=
name|cpu_to_be32
argument_list|(
name|mw
operator|->
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|mw
operator|->
name|type
operator|==
name|MLX4_MW_TYPE_2
condition|)
block|{
name|mpt_entry
operator|->
name|flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_FLAG_FREE
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|qpn
operator|=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_QP_FLAG_BOUND_QP
argument_list|)
expr_stmt|;
name|mpt_entry
operator|->
name|pd_flags
operator||=
name|cpu_to_be32
argument_list|(
name|MLX4_MPT_PD_FLAG_EN_INV
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_SW2HW_MPT
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|,
name|key_to_hw_index
argument_list|(
name|mw
operator|->
name|key
argument_list|)
operator|&
operator|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"SW2HW_MPT failed (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_cmd
goto|;
block|}
name|mw
operator|->
name|enabled
operator|=
name|MLX4_MPT_EN_HW
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_cmd
label|:
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
name|err_table
label|:
name|mlx4_mpt_free_icm
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mw
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mw_enable
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx4_mw_free
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_mw
modifier|*
name|mw
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
name|mw
operator|->
name|enabled
operator|==
name|MLX4_MPT_EN_HW
condition|)
block|{
name|err
operator|=
name|mlx4_HW2SW_MPT
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|,
name|key_to_hw_index
argument_list|(
name|mw
operator|->
name|key
argument_list|)
operator|&
operator|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"xxx HW2SW_MPT failed (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|mw
operator|->
name|enabled
operator|=
name|MLX4_MPT_EN_SW
expr_stmt|;
block|}
if|if
condition|(
name|mw
operator|->
name|enabled
condition|)
name|mlx4_mpt_free_icm
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mw
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|mlx4_mpt_release
argument_list|(
name|dev
argument_list|,
name|key_to_hw_index
argument_list|(
name|mw
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_mw_free
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_init_mr_table
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_mr_table
modifier|*
name|mr_table
init|=
operator|&
name|priv
operator|->
name|mr_table
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* Nothing to do for slaves - all MR handling is forwarded 	* to the master */
if|if
condition|(
name|mlx4_is_slave
argument_list|(
name|dev
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|is_power_of_2
argument_list|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|err
operator|=
name|mlx4_bitmap_init
argument_list|(
operator|&
name|mr_table
operator|->
name|mpt_bitmap
argument_list|,
name|dev
operator|->
name|caps
operator|.
name|num_mpts
argument_list|,
operator|~
literal|0
argument_list|,
name|dev
operator|->
name|caps
operator|.
name|reserved_mrws
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx4_buddy_init
argument_list|(
operator|&
name|mr_table
operator|->
name|mtt_buddy
argument_list|,
name|ilog2
argument_list|(
operator|(
name|u32
operator|)
name|dev
operator|->
name|caps
operator|.
name|num_mtts
operator|/
operator|(
literal|1
operator|<<
name|log_mtts_per_seg
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_buddy
goto|;
if|if
condition|(
name|dev
operator|->
name|caps
operator|.
name|reserved_mtts
condition|)
block|{
name|priv
operator|->
name|reserved_mtts
operator|=
name|mlx4_alloc_mtt_range
argument_list|(
name|dev
argument_list|,
name|fls
argument_list|(
name|dev
operator|->
name|caps
operator|.
name|reserved_mtts
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|reserved_mtts
operator|<
literal|0
condition|)
block|{
name|mlx4_warn
argument_list|(
name|dev
argument_list|,
literal|"MTT table of order %u is too small\n"
argument_list|,
name|mr_table
operator|->
name|mtt_buddy
operator|.
name|max_order
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_reserve_mtts
goto|;
block|}
block|}
return|return
literal|0
return|;
name|err_reserve_mtts
label|:
name|mlx4_buddy_cleanup
argument_list|(
operator|&
name|mr_table
operator|->
name|mtt_buddy
argument_list|)
expr_stmt|;
name|err_buddy
label|:
name|mlx4_bitmap_cleanup
argument_list|(
operator|&
name|mr_table
operator|->
name|mpt_bitmap
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|void
name|mlx4_cleanup_mr_table
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_mr_table
modifier|*
name|mr_table
init|=
operator|&
name|priv
operator|->
name|mr_table
decl_stmt|;
if|if
condition|(
name|mlx4_is_slave
argument_list|(
name|dev
argument_list|)
condition|)
return|return;
if|if
condition|(
name|priv
operator|->
name|reserved_mtts
operator|>=
literal|0
condition|)
name|mlx4_free_mtt_range
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|reserved_mtts
argument_list|,
name|fls
argument_list|(
name|dev
operator|->
name|caps
operator|.
name|reserved_mtts
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|mlx4_buddy_cleanup
argument_list|(
operator|&
name|mr_table
operator|->
name|mtt_buddy
argument_list|)
expr_stmt|;
name|mlx4_bitmap_cleanup
argument_list|(
operator|&
name|mr_table
operator|->
name|mpt_bitmap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|mlx4_check_fmr
parameter_list|(
name|struct
name|mlx4_fmr
modifier|*
name|fmr
parameter_list|,
name|u64
modifier|*
name|page_list
parameter_list|,
name|int
name|npages
parameter_list|,
name|u64
name|iova
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|page_mask
decl_stmt|;
if|if
condition|(
name|npages
operator|>
name|fmr
operator|->
name|max_pages
condition|)
return|return
operator|-
name|EINVAL
return|;
name|page_mask
operator|=
operator|(
literal|1
operator|<<
name|fmr
operator|->
name|page_shift
operator|)
operator|-
literal|1
expr_stmt|;
comment|/* We are getting page lists, so va must be page aligned. */
if|if
condition|(
name|iova
operator|&
name|page_mask
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* Trust the user not to pass misaligned data in page_list */
if|if
condition|(
literal|0
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npages
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|page_list
index|[
name|i
index|]
operator|&
operator|~
name|page_mask
condition|)
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|fmr
operator|->
name|maps
operator|>=
name|fmr
operator|->
name|max_maps
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|mlx4_map_phys_fmr
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_fmr
modifier|*
name|fmr
parameter_list|,
name|u64
modifier|*
name|page_list
parameter_list|,
name|int
name|npages
parameter_list|,
name|u64
name|iova
parameter_list|,
name|u32
modifier|*
name|lkey
parameter_list|,
name|u32
modifier|*
name|rkey
parameter_list|)
block|{
name|u32
name|key
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|err
operator|=
name|mlx4_check_fmr
argument_list|(
name|fmr
argument_list|,
name|page_list
argument_list|,
name|npages
argument_list|,
name|iova
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
operator|++
name|fmr
operator|->
name|maps
expr_stmt|;
name|key
operator|=
name|key_to_hw_index
argument_list|(
name|fmr
operator|->
name|mr
operator|.
name|key
argument_list|)
expr_stmt|;
name|key
operator|+=
name|dev
operator|->
name|caps
operator|.
name|num_mpts
expr_stmt|;
operator|*
name|lkey
operator|=
operator|*
name|rkey
operator|=
name|fmr
operator|->
name|mr
operator|.
name|key
operator|=
name|hw_index_to_key
argument_list|(
name|key
argument_list|)
expr_stmt|;
operator|*
operator|(
name|u8
operator|*
operator|)
name|fmr
operator|->
name|mpt
operator|=
name|MLX4_MPT_STATUS_SW
expr_stmt|;
comment|/* Make sure MPT status is visible before writing MTT entries */
name|wmb
argument_list|()
expr_stmt|;
name|dma_sync_single_for_cpu
argument_list|(
operator|&
name|dev
operator|->
name|persist
operator|->
name|pdev
operator|->
name|dev
argument_list|,
name|fmr
operator|->
name|dma_handle
argument_list|,
name|npages
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|npages
condition|;
operator|++
name|i
control|)
name|fmr
operator|->
name|mtts
index|[
name|i
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|page_list
index|[
name|i
index|]
operator||
name|MLX4_MTT_FLAG_PRESENT
argument_list|)
expr_stmt|;
name|dma_sync_single_for_device
argument_list|(
operator|&
name|dev
operator|->
name|persist
operator|->
name|pdev
operator|->
name|dev
argument_list|,
name|fmr
operator|->
name|dma_handle
argument_list|,
name|npages
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
name|fmr
operator|->
name|mpt
operator|->
name|key
operator|=
name|cpu_to_be32
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|fmr
operator|->
name|mpt
operator|->
name|lkey
operator|=
name|cpu_to_be32
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|fmr
operator|->
name|mpt
operator|->
name|length
operator|=
name|cpu_to_be64
argument_list|(
name|npages
operator|*
operator|(
literal|1ull
operator|<<
name|fmr
operator|->
name|page_shift
operator|)
argument_list|)
expr_stmt|;
name|fmr
operator|->
name|mpt
operator|->
name|start
operator|=
name|cpu_to_be64
argument_list|(
name|iova
argument_list|)
expr_stmt|;
comment|/* Make MTT entries are visible before setting MPT status */
name|wmb
argument_list|()
expr_stmt|;
operator|*
operator|(
name|u8
operator|*
operator|)
name|fmr
operator|->
name|mpt
operator|=
name|MLX4_MPT_STATUS_HW
expr_stmt|;
comment|/* Make sure MPT status is visible before consumer can use FMR */
name|wmb
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_map_phys_fmr
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_fmr_alloc
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|pd
parameter_list|,
name|u32
name|access
parameter_list|,
name|int
name|max_pages
parameter_list|,
name|int
name|max_maps
parameter_list|,
name|u8
name|page_shift
parameter_list|,
name|struct
name|mlx4_fmr
modifier|*
name|fmr
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOMEM
decl_stmt|;
if|if
condition|(
name|max_maps
operator|>
name|dev
operator|->
name|caps
operator|.
name|max_fmr_maps
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|page_shift
operator|<
operator|(
name|ffs
argument_list|(
name|dev
operator|->
name|caps
operator|.
name|page_size_cap
argument_list|)
operator|-
literal|1
operator|)
operator|||
name|page_shift
operator|>=
literal|32
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* All MTTs must fit in the same page */
if|if
condition|(
name|max_pages
operator|*
sizeof|sizeof
expr|*
name|fmr
operator|->
name|mtts
operator|>
name|PAGE_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|fmr
operator|->
name|page_shift
operator|=
name|page_shift
expr_stmt|;
name|fmr
operator|->
name|max_pages
operator|=
name|max_pages
expr_stmt|;
name|fmr
operator|->
name|max_maps
operator|=
name|max_maps
expr_stmt|;
name|fmr
operator|->
name|maps
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|mlx4_mr_alloc
argument_list|(
name|dev
argument_list|,
name|pd
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|access
argument_list|,
name|max_pages
argument_list|,
name|page_shift
argument_list|,
operator|&
name|fmr
operator|->
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|fmr
operator|->
name|mtts
operator|=
name|mlx4_table_find
argument_list|(
operator|&
name|priv
operator|->
name|mr_table
operator|.
name|mtt_table
argument_list|,
name|fmr
operator|->
name|mr
operator|.
name|mtt
operator|.
name|offset
argument_list|,
operator|&
name|fmr
operator|->
name|dma_handle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fmr
operator|->
name|mtts
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free
goto|;
block|}
return|return
literal|0
return|;
name|err_free
label|:
operator|(
name|void
operator|)
name|mlx4_mr_free
argument_list|(
name|dev
argument_list|,
operator|&
name|fmr
operator|->
name|mr
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_fmr_alloc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_fmr_enable
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_fmr
modifier|*
name|fmr
parameter_list|)
block|{
name|struct
name|mlx4_priv
modifier|*
name|priv
init|=
name|mlx4_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx4_mr_enable
argument_list|(
name|dev
argument_list|,
operator|&
name|fmr
operator|->
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|fmr
operator|->
name|mpt
operator|=
name|mlx4_table_find
argument_list|(
operator|&
name|priv
operator|->
name|mr_table
operator|.
name|dmpt_table
argument_list|,
name|key_to_hw_index
argument_list|(
name|fmr
operator|->
name|mr
operator|.
name|key
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fmr
operator|->
name|mpt
condition|)
return|return
operator|-
name|ENOMEM
return|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_fmr_enable
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx4_fmr_unmap
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_fmr
modifier|*
name|fmr
parameter_list|,
name|u32
modifier|*
name|lkey
parameter_list|,
name|u32
modifier|*
name|rkey
parameter_list|)
block|{
name|struct
name|mlx4_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|!
name|fmr
operator|->
name|maps
condition|)
return|return;
name|fmr
operator|->
name|maps
operator|=
literal|0
expr_stmt|;
name|mailbox
operator|=
name|mlx4_alloc_cmd_mailbox
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mailbox
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
name|pr_warn
argument_list|(
literal|"mlx4_ib: mlx4_alloc_cmd_mailbox failed (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return;
block|}
name|err
operator|=
name|mlx4_HW2SW_MPT
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|,
name|key_to_hw_index
argument_list|(
name|fmr
operator|->
name|mr
operator|.
name|key
argument_list|)
operator|&
operator|(
name|dev
operator|->
name|caps
operator|.
name|num_mpts
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|mlx4_free_cmd_mailbox
argument_list|(
name|dev
argument_list|,
name|mailbox
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|pr_warn
argument_list|(
literal|"mlx4_ib: mlx4_HW2SW_MPT failed (%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return;
block|}
name|fmr
operator|->
name|mr
operator|.
name|enabled
operator|=
name|MLX4_MPT_EN_SW
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_fmr_unmap
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_fmr_free
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_fmr
modifier|*
name|fmr
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|fmr
operator|->
name|maps
condition|)
return|return
operator|-
name|EBUSY
return|;
name|ret
operator|=
name|mlx4_mr_free
argument_list|(
name|dev
argument_list|,
operator|&
name|fmr
operator|->
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|fmr
operator|->
name|mr
operator|.
name|enabled
operator|=
name|MLX4_MPT_DISABLED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_fmr_free
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx4_SYNC_TPT
parameter_list|(
name|struct
name|mlx4_dev
modifier|*
name|dev
parameter_list|)
block|{
return|return
name|mlx4_cmd
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_CMD_SYNC_TPT
argument_list|,
name|MLX4_CMD_TIME_CLASS_A
argument_list|,
name|MLX4_CMD_NATIVE
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL_GPL
argument_list|(
name|mlx4_SYNC_TPT
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2007, 2014 Mellanox Technologies. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<linux/etherdevice.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NET_RX_BUSY_POLL
end_ifdef

begin_include
include|#
directive|include
file|<net/busy_poll.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<linux/list.h>
end_include

begin_include
include|#
directive|include
file|<linux/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx4/driver.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx4/device.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx4/cmd.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx4/cq.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|"en.h"
end_include

begin_include
include|#
directive|include
file|"en_port.h"
end_include

begin_function_decl
specifier|static
name|void
name|mlx4_en_sysctl_stat
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mlx4_en_sysctl_conf
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|mlx4_en_unit
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NET_RX_BUSY_POLL
end_ifdef

begin_comment
comment|/* must be called with local_bh_disable()d */
end_comment

begin_function
specifier|static
name|int
name|mlx4_en_low_latency_recv
parameter_list|(
name|struct
name|napi_struct
modifier|*
name|napi
parameter_list|)
block|{
name|struct
name|mlx4_en_cq
modifier|*
name|cq
init|=
name|container_of
argument_list|(
name|napi
argument_list|,
expr|struct
name|mlx4_en_cq
argument_list|,
name|napi
argument_list|)
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
init|=
name|cq
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_rx_ring
modifier|*
name|rx_ring
init|=
name|priv
operator|->
name|rx_ring
index|[
name|cq
operator|->
name|ring
index|]
decl_stmt|;
name|int
name|done
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return
name|LL_FLUSH_FAILED
return|;
if|if
condition|(
operator|!
name|mlx4_en_cq_lock_poll
argument_list|(
name|cq
argument_list|)
condition|)
return|return
name|LL_FLUSH_BUSY
return|;
name|done
operator|=
name|mlx4_en_process_rx_cq
argument_list|(
name|dev
argument_list|,
name|cq
argument_list|,
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|LL_EXTENDED_STATS
if|if
condition|(
name|done
condition|)
name|rx_ring
operator|->
name|cleaned
operator|+=
name|done
expr_stmt|;
else|else
name|rx_ring
operator|->
name|misses
operator|++
expr_stmt|;
endif|#
directive|endif
name|mlx4_en_cq_unlock_poll
argument_list|(
name|cq
argument_list|)
expr_stmt|;
return|return
name|done
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NET_RX_BUSY_POLL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_RFS_ACCEL
end_ifdef

begin_struct
struct|struct
name|mlx4_en_filter
block|{
name|struct
name|list_head
name|next
decl_stmt|;
name|struct
name|work_struct
name|work
decl_stmt|;
name|u8
name|ip_proto
decl_stmt|;
name|__be32
name|src_ip
decl_stmt|;
name|__be32
name|dst_ip
decl_stmt|;
name|__be16
name|src_port
decl_stmt|;
name|__be16
name|dst_port
decl_stmt|;
name|int
name|rxq_index
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|u32
name|flow_id
decl_stmt|;
comment|/* RFS infrastructure id */
name|int
name|id
decl_stmt|;
comment|/* mlx4_en driver id */
name|u64
name|reg_id
decl_stmt|;
comment|/* Flow steering API id */
name|u8
name|activated
decl_stmt|;
comment|/* Used to prevent expiry before filter 					 * is attached 					 */
name|struct
name|hlist_node
name|filter_chain
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|mlx4_en_filter_rfs_expire
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|enum
name|mlx4_net_trans_rule_id
name|mlx4_ip_proto_to_trans_rule_id
parameter_list|(
name|u8
name|ip_proto
parameter_list|)
block|{
switch|switch
condition|(
name|ip_proto
condition|)
block|{
case|case
name|IPPROTO_UDP
case|:
return|return
name|MLX4_NET_TRANS_RULE_ID_UDP
return|;
case|case
name|IPPROTO_TCP
case|:
return|return
name|MLX4_NET_TRANS_RULE_ID_TCP
return|;
default|default:
return|return
operator|-
name|EPROTONOSUPPORT
return|;
block|}
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|mlx4_en_filter_work
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_filter
modifier|*
name|filter
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_filter
argument_list|,
name|work
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|filter
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx4_spec_list
name|spec_tcp_udp
init|=
block|{
operator|.
name|id
operator|=
name|mlx4_ip_proto_to_trans_rule_id
argument_list|(
name|filter
operator|->
name|ip_proto
argument_list|)
block|,
block|{
operator|.
name|tcp_udp
operator|=
block|{
operator|.
name|dst_port
operator|=
name|filter
operator|->
name|dst_port
block|,
operator|.
name|dst_port_msk
operator|=
operator|(
name|__force
name|__be16
operator|)
operator|-
literal|1
block|,
operator|.
name|src_port
operator|=
name|filter
operator|->
name|src_port
block|,
operator|.
name|src_port_msk
operator|=
operator|(
name|__force
name|__be16
operator|)
operator|-
literal|1
block|, 			}
block|, 		}
block|, 	}
decl_stmt|;
name|struct
name|mlx4_spec_list
name|spec_ip
init|=
block|{
operator|.
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_IPV4
block|,
block|{
operator|.
name|ipv4
operator|=
block|{
operator|.
name|dst_ip
operator|=
name|filter
operator|->
name|dst_ip
block|,
operator|.
name|dst_ip_msk
operator|=
operator|(
name|__force
name|__be32
operator|)
operator|-
literal|1
block|,
operator|.
name|src_ip
operator|=
name|filter
operator|->
name|src_ip
block|,
operator|.
name|src_ip_msk
operator|=
operator|(
name|__force
name|__be32
operator|)
operator|-
literal|1
block|, 			}
block|, 		}
block|, 	}
decl_stmt|;
name|struct
name|mlx4_spec_list
name|spec_eth
init|=
block|{
operator|.
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_ETH
block|, 	}
decl_stmt|;
name|struct
name|mlx4_net_trans_rule
name|rule
init|=
block|{
operator|.
name|list
operator|=
name|LIST_HEAD_INIT
argument_list|(
name|rule
operator|.
name|list
argument_list|)
block|,
operator|.
name|queue_mode
operator|=
name|MLX4_NET_TRANS_Q_LIFO
block|,
operator|.
name|exclusive
operator|=
literal|1
block|,
operator|.
name|allow_loopback
operator|=
literal|1
block|,
operator|.
name|promisc_mode
operator|=
name|MLX4_FS_REGULAR
block|,
operator|.
name|port
operator|=
name|priv
operator|->
name|port
block|,
operator|.
name|priority
operator|=
name|MLX4_DOMAIN_RFS
block|, 	}
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|__be64
name|mac_mask
init|=
name|cpu_to_be64
argument_list|(
name|MLX4_MAC_MASK
operator|<<
literal|16
argument_list|)
decl_stmt|;
if|if
condition|(
name|spec_tcp_udp
operator|.
name|id
operator|<
literal|0
condition|)
block|{
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"RFS: ignoring unsupported ip protocol (%d)\n"
argument_list|,
name|filter
operator|->
name|ip_proto
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
name|list_add_tail
argument_list|(
operator|&
name|spec_eth
operator|.
name|list
argument_list|,
operator|&
name|rule
operator|.
name|list
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|spec_ip
operator|.
name|list
argument_list|,
operator|&
name|rule
operator|.
name|list
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|spec_tcp_udp
operator|.
name|list
argument_list|,
operator|&
name|rule
operator|.
name|list
argument_list|)
expr_stmt|;
name|rule
operator|.
name|qpn
operator|=
name|priv
operator|->
name|rss_map
operator|.
name|qps
index|[
name|filter
operator|->
name|rxq_index
index|]
operator|.
name|qpn
expr_stmt|;
name|memcpy
argument_list|(
name|spec_eth
operator|.
name|eth
operator|.
name|dst_mac
argument_list|,
name|priv
operator|->
name|dev
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|spec_eth
operator|.
name|eth
operator|.
name|dst_mac_msk
argument_list|,
operator|&
name|mac_mask
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|filter
operator|->
name|activated
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|filter
operator|->
name|reg_id
condition|)
block|{
name|rc
operator|=
name|mlx4_flow_detach
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|filter
operator|->
name|reg_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|&&
name|rc
operator|!=
operator|-
name|ENOENT
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Error detaching flow. rc = %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|mlx4_flow_attach
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|rule
argument_list|,
operator|&
name|filter
operator|->
name|reg_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Error attaching flow. err = %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|ignore
label|:
name|mlx4_en_filter_rfs_expire
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|filter
operator|->
name|activated
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|hlist_head
modifier|*
name|filter_hash_bucket
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|__be32
name|src_ip
parameter_list|,
name|__be32
name|dst_ip
parameter_list|,
name|__be16
name|src_port
parameter_list|,
name|__be16
name|dst_port
parameter_list|)
block|{
name|unsigned
name|long
name|l
decl_stmt|;
name|int
name|bucket_idx
decl_stmt|;
name|l
operator|=
operator|(
name|__force
name|unsigned
name|long
operator|)
name|src_port
operator||
operator|(
operator|(
name|__force
name|unsigned
name|long
operator|)
name|dst_port
operator|<<
literal|2
operator|)
expr_stmt|;
name|l
operator|^=
call|(
name|__force
name|unsigned
name|long
call|)
argument_list|(
name|src_ip
operator|^
name|dst_ip
argument_list|)
expr_stmt|;
name|bucket_idx
operator|=
name|hash_long
argument_list|(
name|l
argument_list|,
name|MLX4_EN_FILTER_HASH_SHIFT
argument_list|)
expr_stmt|;
return|return
operator|&
name|priv
operator|->
name|filter_hash
index|[
name|bucket_idx
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx4_en_filter
modifier|*
name|mlx4_en_filter_alloc
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|int
name|rxq_index
parameter_list|,
name|__be32
name|src_ip
parameter_list|,
name|__be32
name|dst_ip
parameter_list|,
name|u8
name|ip_proto
parameter_list|,
name|__be16
name|src_port
parameter_list|,
name|__be16
name|dst_port
parameter_list|,
name|u32
name|flow_id
parameter_list|)
block|{
name|struct
name|mlx4_en_filter
modifier|*
name|filter
init|=
name|NULL
decl_stmt|;
name|filter
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_en_filter
argument_list|)
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|filter
condition|)
return|return
name|NULL
return|;
name|filter
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|filter
operator|->
name|rxq_index
operator|=
name|rxq_index
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|filter
operator|->
name|work
argument_list|,
name|mlx4_en_filter_work
argument_list|)
expr_stmt|;
name|filter
operator|->
name|src_ip
operator|=
name|src_ip
expr_stmt|;
name|filter
operator|->
name|dst_ip
operator|=
name|dst_ip
expr_stmt|;
name|filter
operator|->
name|ip_proto
operator|=
name|ip_proto
expr_stmt|;
name|filter
operator|->
name|src_port
operator|=
name|src_port
expr_stmt|;
name|filter
operator|->
name|dst_port
operator|=
name|dst_port
expr_stmt|;
name|filter
operator|->
name|flow_id
operator|=
name|flow_id
expr_stmt|;
name|filter
operator|->
name|id
operator|=
name|priv
operator|->
name|last_filter_id
operator|++
operator|%
name|RPS_NO_FILTER
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|filter
operator|->
name|next
argument_list|,
operator|&
name|priv
operator|->
name|filters
argument_list|)
expr_stmt|;
name|hlist_add_head
argument_list|(
operator|&
name|filter
operator|->
name|filter_chain
argument_list|,
name|filter_hash_bucket
argument_list|(
name|priv
argument_list|,
name|src_ip
argument_list|,
name|dst_ip
argument_list|,
name|src_port
argument_list|,
name|dst_port
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|filter
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_filter_free
parameter_list|(
name|struct
name|mlx4_en_filter
modifier|*
name|filter
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|filter
operator|->
name|priv
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|list_del
argument_list|(
operator|&
name|filter
operator|->
name|next
argument_list|)
expr_stmt|;
name|rc
operator|=
name|mlx4_flow_detach
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|filter
operator|->
name|reg_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|&&
name|rc
operator|!=
operator|-
name|ENOENT
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Error detaching flow. rc = %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|filter
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|mlx4_en_filter
modifier|*
name|mlx4_en_filter_find
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|__be32
name|src_ip
parameter_list|,
name|__be32
name|dst_ip
parameter_list|,
name|u8
name|ip_proto
parameter_list|,
name|__be16
name|src_port
parameter_list|,
name|__be16
name|dst_port
parameter_list|)
block|{
name|struct
name|mlx4_en_filter
modifier|*
name|filter
decl_stmt|;
name|struct
name|mlx4_en_filter
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|hlist_for_each_entry
argument_list|(
argument|filter
argument_list|,
argument|filter_hash_bucket(priv, src_ip, dst_ip, 						src_port, dst_port)
argument_list|,
argument|filter_chain
argument_list|)
block|{
if|if
condition|(
name|filter
operator|->
name|src_ip
operator|==
name|src_ip
operator|&&
name|filter
operator|->
name|dst_ip
operator|==
name|dst_ip
operator|&&
name|filter
operator|->
name|ip_proto
operator|==
name|ip_proto
operator|&&
name|filter
operator|->
name|src_port
operator|==
name|src_port
operator|&&
name|filter
operator|->
name|dst_port
operator|==
name|dst_port
condition|)
block|{
name|ret
operator|=
name|filter
expr_stmt|;
break|break;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_filter_rfs
parameter_list|(
name|struct
name|net_device
modifier|*
name|net_dev
parameter_list|,
specifier|const
name|struct
name|sk_buff
modifier|*
name|skb
parameter_list|,
name|u16
name|rxq_index
parameter_list|,
name|u32
name|flow_id
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|net_dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_filter
modifier|*
name|filter
decl_stmt|;
specifier|const
name|struct
name|iphdr
modifier|*
name|ip
decl_stmt|;
specifier|const
name|__be16
modifier|*
name|ports
decl_stmt|;
name|u8
name|ip_proto
decl_stmt|;
name|__be32
name|src_ip
decl_stmt|;
name|__be32
name|dst_ip
decl_stmt|;
name|__be16
name|src_port
decl_stmt|;
name|__be16
name|dst_port
decl_stmt|;
name|int
name|nhoff
init|=
name|skb_network_offset
argument_list|(
name|skb
argument_list|)
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|skb
operator|->
name|protocol
operator|!=
name|htons
argument_list|(
name|ETH_P_IP
argument_list|)
condition|)
return|return
operator|-
name|EPROTONOSUPPORT
return|;
name|ip
operator|=
operator|(
specifier|const
expr|struct
name|iphdr
operator|*
operator|)
operator|(
name|skb
operator|->
name|data
operator|+
name|nhoff
operator|)
expr_stmt|;
if|if
condition|(
name|ip_is_fragment
argument_list|(
name|ip
argument_list|)
condition|)
return|return
operator|-
name|EPROTONOSUPPORT
return|;
if|if
condition|(
operator|(
name|ip
operator|->
name|protocol
operator|!=
name|IPPROTO_TCP
operator|)
operator|&&
operator|(
name|ip
operator|->
name|protocol
operator|!=
name|IPPROTO_UDP
operator|)
condition|)
return|return
operator|-
name|EPROTONOSUPPORT
return|;
name|ports
operator|=
operator|(
specifier|const
name|__be16
operator|*
operator|)
operator|(
name|skb
operator|->
name|data
operator|+
name|nhoff
operator|+
literal|4
operator|*
name|ip
operator|->
name|ihl
operator|)
expr_stmt|;
name|ip_proto
operator|=
name|ip
operator|->
name|protocol
expr_stmt|;
name|src_ip
operator|=
name|ip
operator|->
name|saddr
expr_stmt|;
name|dst_ip
operator|=
name|ip
operator|->
name|daddr
expr_stmt|;
name|src_port
operator|=
name|ports
index|[
literal|0
index|]
expr_stmt|;
name|dst_port
operator|=
name|ports
index|[
literal|1
index|]
expr_stmt|;
name|spin_lock_bh
argument_list|(
operator|&
name|priv
operator|->
name|filters_lock
argument_list|)
expr_stmt|;
name|filter
operator|=
name|mlx4_en_filter_find
argument_list|(
name|priv
argument_list|,
name|src_ip
argument_list|,
name|dst_ip
argument_list|,
name|ip_proto
argument_list|,
name|src_port
argument_list|,
name|dst_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|filter
condition|)
block|{
if|if
condition|(
name|filter
operator|->
name|rxq_index
operator|==
name|rxq_index
condition|)
goto|goto
name|out
goto|;
name|filter
operator|->
name|rxq_index
operator|=
name|rxq_index
expr_stmt|;
block|}
else|else
block|{
name|filter
operator|=
name|mlx4_en_filter_alloc
argument_list|(
name|priv
argument_list|,
name|rxq_index
argument_list|,
name|src_ip
argument_list|,
name|dst_ip
argument_list|,
name|ip_proto
argument_list|,
name|src_port
argument_list|,
name|dst_port
argument_list|,
name|flow_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|filter
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|queue_work
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|filter
operator|->
name|work
argument_list|)
expr_stmt|;
name|out
label|:
name|ret
operator|=
name|filter
operator|->
name|id
expr_stmt|;
name|err
label|:
name|spin_unlock_bh
argument_list|(
operator|&
name|priv
operator|->
name|filters_lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|mlx4_en_cleanup_filters
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx4_en_rx_ring
modifier|*
name|rx_ring
parameter_list|)
block|{
name|struct
name|mlx4_en_filter
modifier|*
name|filter
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|LIST_HEAD
argument_list|(
name|del_list
argument_list|)
expr_stmt|;
name|spin_lock_bh
argument_list|(
operator|&
name|priv
operator|->
name|filters_lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|filter
argument_list|,
argument|tmp
argument_list|,
argument|&priv->filters
argument_list|,
argument|next
argument_list|)
block|{
name|list_move
argument_list|(
operator|&
name|filter
operator|->
name|next
argument_list|,
operator|&
name|del_list
argument_list|)
expr_stmt|;
name|hlist_del
argument_list|(
operator|&
name|filter
operator|->
name|filter_chain
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_bh
argument_list|(
operator|&
name|priv
operator|->
name|filters_lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|filter
argument_list|,
argument|tmp
argument_list|,
argument|&del_list
argument_list|,
argument|next
argument_list|)
block|{
name|cancel_work_sync
argument_list|(
operator|&
name|filter
operator|->
name|work
argument_list|)
expr_stmt|;
name|mlx4_en_filter_free
argument_list|(
name|filter
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_filter_rfs_expire
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_filter
modifier|*
name|filter
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|last_filter
init|=
name|NULL
decl_stmt|;
name|LIST_HEAD
argument_list|(
name|del_list
argument_list|)
expr_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|spin_lock_bh
argument_list|(
operator|&
name|priv
operator|->
name|filters_lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|filter
argument_list|,
argument|tmp
argument_list|,
argument|&priv->filters
argument_list|,
argument|next
argument_list|)
block|{
if|if
condition|(
name|i
operator|>
name|MLX4_EN_FILTER_EXPIRY_QUOTA
condition|)
break|break;
if|if
condition|(
name|filter
operator|->
name|activated
operator|&&
operator|!
name|work_pending
argument_list|(
operator|&
name|filter
operator|->
name|work
argument_list|)
operator|&&
name|rps_may_expire_flow
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|filter
operator|->
name|rxq_index
argument_list|,
name|filter
operator|->
name|flow_id
argument_list|,
name|filter
operator|->
name|id
argument_list|)
condition|)
block|{
name|list_move
argument_list|(
operator|&
name|filter
operator|->
name|next
argument_list|,
operator|&
name|del_list
argument_list|)
expr_stmt|;
name|hlist_del
argument_list|(
operator|&
name|filter
operator|->
name|filter_chain
argument_list|)
expr_stmt|;
block|}
else|else
name|last_filter
operator|=
name|filter
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|last_filter
operator|&&
operator|(
operator|&
name|last_filter
operator|->
name|next
operator|!=
name|priv
operator|->
name|filters
operator|.
name|next
operator|)
condition|)
name|list_move
argument_list|(
operator|&
name|priv
operator|->
name|filters
argument_list|,
operator|&
name|last_filter
operator|->
name|next
argument_list|)
expr_stmt|;
name|spin_unlock_bh
argument_list|(
operator|&
name|priv
operator|->
name|filters_lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|filter
argument_list|,
argument|tmp
argument_list|,
argument|&del_list
argument_list|,
argument|next
argument_list|)
name|mlx4_en_filter_free
argument_list|(
name|filter
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|mlx4_en_vlan_rx_add_vid
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|idx
decl_stmt|;
if|if
condition|(
name|arg
operator|!=
name|priv
condition|)
return|return;
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"adding VLAN:%d\n"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|vid
argument_list|,
name|priv
operator|->
name|active_vlans
argument_list|)
expr_stmt|;
comment|/* Add VID to port VLAN filter */
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|device_up
operator|&&
name|priv
operator|->
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_SET_VLAN_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed configuring VLAN filter\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mlx4_register_vlan
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|vid
argument_list|,
operator|&
name|idx
argument_list|)
condition|)
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"failed adding vlan %d\n"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_vlan_rx_kill_vid
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|arg
operator|!=
name|priv
condition|)
return|return;
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Killing VID:%d\n"
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|clear_bit
argument_list|(
name|vid
argument_list|,
name|priv
operator|->
name|active_vlans
argument_list|)
expr_stmt|;
comment|/* Remove VID from port VLAN filter */
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_unregister_vlan
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|vid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|device_up
operator|&&
name|priv
operator|->
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_SET_VLAN_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed configuring VLAN filter\n"
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_uc_steer_add
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|unsigned
name|char
modifier|*
name|mac
parameter_list|,
name|int
modifier|*
name|qpn
parameter_list|,
name|u64
modifier|*
name|reg_id
parameter_list|)
block|{
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_dev
modifier|*
name|dev
init|=
name|mdev
operator|->
name|dev
decl_stmt|;
name|int
name|err
decl_stmt|;
switch|switch
condition|(
name|dev
operator|->
name|caps
operator|.
name|steering_mode
condition|)
block|{
case|case
name|MLX4_STEERING_MODE_B0
case|:
block|{
name|struct
name|mlx4_qp
name|qp
decl_stmt|;
name|u8
name|gid
index|[
literal|16
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|qp
operator|.
name|qpn
operator|=
operator|*
name|qpn
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|gid
index|[
literal|10
index|]
argument_list|,
name|mac
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|gid
index|[
literal|5
index|]
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|err
operator|=
name|mlx4_unicast_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|qp
argument_list|,
name|gid
argument_list|,
literal|0
argument_list|,
name|MLX4_PROT_ETH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|MLX4_STEERING_MODE_DEVICE_MANAGED
case|:
block|{
name|struct
name|mlx4_spec_list
name|spec_eth
init|=
block|{
block|{
name|NULL
block|}
block|}
decl_stmt|;
name|__be64
name|mac_mask
init|=
name|cpu_to_be64
argument_list|(
name|MLX4_MAC_MASK
operator|<<
literal|16
argument_list|)
decl_stmt|;
name|struct
name|mlx4_net_trans_rule
name|rule
init|=
block|{
operator|.
name|queue_mode
operator|=
name|MLX4_NET_TRANS_Q_FIFO
block|,
operator|.
name|exclusive
operator|=
literal|0
block|,
operator|.
name|allow_loopback
operator|=
literal|1
block|,
operator|.
name|promisc_mode
operator|=
name|MLX4_FS_REGULAR
block|,
operator|.
name|priority
operator|=
name|MLX4_DOMAIN_NIC
block|, 		}
decl_stmt|;
name|rule
operator|.
name|port
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|rule
operator|.
name|qpn
operator|=
operator|*
name|qpn
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|rule
operator|.
name|list
argument_list|)
expr_stmt|;
name|spec_eth
operator|.
name|id
operator|=
name|MLX4_NET_TRANS_RULE_ID_ETH
expr_stmt|;
name|memcpy
argument_list|(
name|spec_eth
operator|.
name|eth
operator|.
name|dst_mac
argument_list|,
name|mac
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|spec_eth
operator|.
name|eth
operator|.
name|dst_mac_msk
argument_list|,
operator|&
name|mac_mask
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|spec_eth
operator|.
name|list
argument_list|,
operator|&
name|rule
operator|.
name|list
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_flow_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|rule
argument_list|,
name|reg_id
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|err
condition|)
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Failed Attaching Unicast\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_uc_steer_release
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|unsigned
name|char
modifier|*
name|mac
parameter_list|,
name|int
name|qpn
parameter_list|,
name|u64
name|reg_id
parameter_list|)
block|{
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_dev
modifier|*
name|dev
init|=
name|mdev
operator|->
name|dev
decl_stmt|;
switch|switch
condition|(
name|dev
operator|->
name|caps
operator|.
name|steering_mode
condition|)
block|{
case|case
name|MLX4_STEERING_MODE_B0
case|:
block|{
name|struct
name|mlx4_qp
name|qp
decl_stmt|;
name|u8
name|gid
index|[
literal|16
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|qp
operator|.
name|qpn
operator|=
name|qpn
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|gid
index|[
literal|10
index|]
argument_list|,
name|mac
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|gid
index|[
literal|5
index|]
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|mlx4_unicast_detach
argument_list|(
name|dev
argument_list|,
operator|&
name|qp
argument_list|,
name|gid
argument_list|,
name|MLX4_PROT_ETH
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|MLX4_STEERING_MODE_DEVICE_MANAGED
case|:
block|{
name|mlx4_flow_detach
argument_list|(
name|dev
argument_list|,
name|reg_id
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Invalid steering mode.\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_qp
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_dev
modifier|*
name|dev
init|=
name|mdev
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx4_mac_entry
modifier|*
name|entry
decl_stmt|;
name|int
name|index
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u64
name|reg_id
decl_stmt|;
name|int
modifier|*
name|qpn
init|=
operator|&
name|priv
operator|->
name|base_qpn
decl_stmt|;
name|u64
name|mac
init|=
name|mlx4_mac_to_u64
argument_list|(
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Registering MAC: %pM for adding\n"
argument_list|,
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|index
operator|=
name|mlx4_register_mac
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|<
literal|0
condition|)
block|{
name|err
operator|=
name|index
expr_stmt|;
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed adding MAC: %pM\n"
argument_list|,
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
if|if
condition|(
name|dev
operator|->
name|caps
operator|.
name|steering_mode
operator|==
name|MLX4_STEERING_MODE_A0
condition|)
block|{
name|int
name|base_qpn
init|=
name|mlx4_get_base_qpn
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
decl_stmt|;
operator|*
name|qpn
operator|=
name|base_qpn
operator|+
name|index
expr_stmt|;
return|return
literal|0
return|;
block|}
name|err
operator|=
name|mlx4_qp_reserve_range
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|qpn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Reserved qp %d\n"
argument_list|,
operator|*
name|qpn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to reserve qp for mac registration\n"
argument_list|)
expr_stmt|;
goto|goto
name|qp_err
goto|;
block|}
name|err
operator|=
name|mlx4_en_uc_steer_add
argument_list|(
name|priv
argument_list|,
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|,
name|qpn
argument_list|,
operator|&
name|reg_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|steer_err
goto|;
name|entry
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|entry
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|alloc_err
goto|;
block|}
name|memcpy
argument_list|(
name|entry
operator|->
name|mac
argument_list|,
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
operator|->
name|mac
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|->
name|reg_id
operator|=
name|reg_id
expr_stmt|;
name|hlist_add_head
argument_list|(
operator|&
name|entry
operator|->
name|hlist
argument_list|,
operator|&
name|priv
operator|->
name|mac_hash
index|[
name|entry
operator|->
name|mac
index|[
name|MLX4_EN_MAC_HASH_IDX
index|]
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|alloc_err
label|:
name|mlx4_en_uc_steer_release
argument_list|(
name|priv
argument_list|,
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|,
operator|*
name|qpn
argument_list|,
name|reg_id
argument_list|)
expr_stmt|;
name|steer_err
label|:
name|mlx4_qp_release_range
argument_list|(
name|dev
argument_list|,
operator|*
name|qpn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|qp_err
label|:
name|mlx4_unregister_mac
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|mac
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_put_qp
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_dev
modifier|*
name|dev
init|=
name|mdev
operator|->
name|dev
decl_stmt|;
name|int
name|qpn
init|=
name|priv
operator|->
name|base_qpn
decl_stmt|;
name|u64
name|mac
decl_stmt|;
if|if
condition|(
name|dev
operator|->
name|caps
operator|.
name|steering_mode
operator|==
name|MLX4_STEERING_MODE_A0
condition|)
block|{
name|mac
operator|=
name|mlx4_mac_to_u64
argument_list|(
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Registering MAC: %pM for deleting\n"
argument_list|,
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|mlx4_unregister_mac
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|mac
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|mlx4_mac_entry
modifier|*
name|entry
decl_stmt|;
name|struct
name|hlist_node
modifier|*
name|tmp
decl_stmt|;
name|struct
name|hlist_head
modifier|*
name|bucket
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_EN_MAC_HASH_SIZE
condition|;
operator|++
name|i
control|)
block|{
name|bucket
operator|=
operator|&
name|priv
operator|->
name|mac_hash
index|[
name|i
index|]
expr_stmt|;
name|hlist_for_each_entry_safe
argument_list|(
argument|entry
argument_list|,
argument|tmp
argument_list|,
argument|bucket
argument_list|,
argument|hlist
argument_list|)
block|{
name|mac
operator|=
name|mlx4_mac_to_u64
argument_list|(
name|entry
operator|->
name|mac
argument_list|)
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Registering MAC: %pM for deleting\n"
argument_list|,
name|entry
operator|->
name|mac
argument_list|)
expr_stmt|;
name|mlx4_en_uc_steer_release
argument_list|(
name|priv
argument_list|,
name|entry
operator|->
name|mac
argument_list|,
name|qpn
argument_list|,
name|entry
operator|->
name|reg_id
argument_list|)
expr_stmt|;
name|mlx4_unregister_mac
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|hlist_del
argument_list|(
operator|&
name|entry
operator|->
name|hlist
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Releasing qp: port %d, qpn %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|qpn
argument_list|)
expr_stmt|;
name|mlx4_qp_release_range
argument_list|(
name|dev
argument_list|,
name|qpn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_FORCE_PROMISC
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_clear_list
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_mc_list
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|mc_to_del
decl_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|mc_to_del
argument_list|,
argument|tmp
argument_list|,
argument|&priv->mc_list
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|mc_to_del
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mc_to_del
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_cache_mclist
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|struct
name|mlx4_en_mc_list
modifier|*
name|tmp
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|if_maddr_rlock
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&dev->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
operator|)
operator|->
name|sdl_alen
operator|!=
name|ETHER_ADDR_LEN
condition|)
continue|continue;
comment|/* Make sure the list didn't grow. */
name|tmp
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_en_mc_list
argument_list|)
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to allocate multicast list\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
name|tmp
operator|->
name|addr
argument_list|,
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|tmp
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|mc_list
argument_list|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_mclist_flags
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|list_head
modifier|*
name|dst
parameter_list|,
name|struct
name|list_head
modifier|*
name|src
parameter_list|)
block|{
name|struct
name|mlx4_en_mc_list
modifier|*
name|dst_tmp
decl_stmt|,
modifier|*
name|src_tmp
decl_stmt|,
modifier|*
name|new_mc
decl_stmt|;
name|bool
name|found
decl_stmt|;
comment|/* Find all the entries that should be removed from dst, 	 * These are the entries that are not found in src 	 */
name|list_for_each_entry
argument_list|(
argument|dst_tmp
argument_list|,
argument|dst
argument_list|,
argument|list
argument_list|)
block|{
name|found
operator|=
name|false
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|src_tmp
argument_list|,
argument|src
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|dst_tmp
operator|->
name|addr
argument_list|,
name|src_tmp
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
block|{
name|found
operator|=
name|true
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
name|dst_tmp
operator|->
name|action
operator|=
name|MCLIST_REM
expr_stmt|;
block|}
comment|/* Add entries that exist in src but not in dst 	 * mark them as need to add 	 */
name|list_for_each_entry
argument_list|(
argument|src_tmp
argument_list|,
argument|src
argument_list|,
argument|list
argument_list|)
block|{
name|found
operator|=
name|false
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|dst_tmp
argument_list|,
argument|dst
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|dst_tmp
operator|->
name|addr
argument_list|,
name|src_tmp
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
block|{
name|dst_tmp
operator|->
name|action
operator|=
name|MCLIST_NONE
expr_stmt|;
name|found
operator|=
name|true
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|new_mc
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_en_mc_list
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_mc
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to allocate current multicast list\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
name|new_mc
argument_list|,
name|src_tmp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_en_mc_list
argument_list|)
argument_list|)
expr_stmt|;
name|new_mc
operator|->
name|action
operator|=
name|MCLIST_ADD
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|new_mc
operator|->
name|list
argument_list|,
name|dst
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_set_rx_mode
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
return|return;
name|queue_work
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|rx_mode_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_set_promisc_mode
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_PROMISC
operator|)
condition|)
block|{
name|priv
operator|->
name|flags
operator||=
name|MLX4_EN_FLAG_PROMISC
expr_stmt|;
comment|/* Enable promiscouos mode */
switch|switch
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|steering_mode
condition|)
block|{
case|case
name|MLX4_STEERING_MODE_DEVICE_MANAGED
case|:
name|err
operator|=
name|mlx4_flow_steer_promisc_add
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|MLX4_FS_ALL_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling promiscuous mode\n"
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator||=
name|MLX4_EN_FLAG_MC_PROMISC
expr_stmt|;
break|break;
case|case
name|MLX4_STEERING_MODE_B0
case|:
name|err
operator|=
name|mlx4_unicast_promisc_add
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling unicast promiscuous mode\n"
argument_list|)
expr_stmt|;
comment|/* Add the default qp number as multicast 			 * promisc 			 */
if|if
condition|(
operator|!
operator|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_MC_PROMISC
operator|)
condition|)
block|{
name|err
operator|=
name|mlx4_multicast_promisc_add
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling multicast promiscuous mode\n"
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator||=
name|MLX4_EN_FLAG_MC_PROMISC
expr_stmt|;
block|}
break|break;
case|case
name|MLX4_STEERING_MODE_A0
case|:
name|err
operator|=
name|mlx4_SET_PORT_qpn_calc
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling promiscuous mode\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Disable port multicast filter (unconditionally) */
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling multicast filter\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_clear_promisc_mode
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_PROMISC
expr_stmt|;
comment|/* Disable promiscouos mode */
switch|switch
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|steering_mode
condition|)
block|{
case|case
name|MLX4_STEERING_MODE_DEVICE_MANAGED
case|:
name|err
operator|=
name|mlx4_flow_steer_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|MLX4_FS_ALL_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling promiscuous mode\n"
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_MC_PROMISC
expr_stmt|;
break|break;
case|case
name|MLX4_STEERING_MODE_B0
case|:
name|err
operator|=
name|mlx4_unicast_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling unicast promiscuous mode\n"
argument_list|)
expr_stmt|;
comment|/* Disable Multicast promisc */
if|if
condition|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_MC_PROMISC
condition|)
block|{
name|err
operator|=
name|mlx4_multicast_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling multicast promiscuous mode\n"
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_MC_PROMISC
expr_stmt|;
block|}
break|break;
case|case
name|MLX4_STEERING_MODE_A0
case|:
name|err
operator|=
name|mlx4_SET_PORT_qpn_calc
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling promiscuous mode\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_do_multicast
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
parameter_list|)
block|{
name|struct
name|mlx4_en_mc_list
modifier|*
name|mclist
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|u8
name|mc_list
index|[
literal|16
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|u64
name|mcast_addr
init|=
literal|0
decl_stmt|;
comment|/* Enable/disable the multicast filter according to IFF_ALLMULTI */
if|if
condition|(
name|dev
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
condition|)
block|{
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling multicast filter\n"
argument_list|)
expr_stmt|;
comment|/* Add the default qp number as multicast promisc */
if|if
condition|(
operator|!
operator|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_MC_PROMISC
operator|)
condition|)
block|{
switch|switch
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|steering_mode
condition|)
block|{
case|case
name|MLX4_STEERING_MODE_DEVICE_MANAGED
case|:
name|err
operator|=
name|mlx4_flow_steer_promisc_add
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|MLX4_FS_MC_DEFAULT
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX4_STEERING_MODE_B0
case|:
name|err
operator|=
name|mlx4_multicast_promisc_add
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX4_STEERING_MODE_A0
case|:
break|break;
block|}
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed entering multicast promisc mode\n"
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator||=
name|MLX4_EN_FLAG_MC_PROMISC
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Disable Multicast promisc */
if|if
condition|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_MC_PROMISC
condition|)
block|{
switch|switch
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|steering_mode
condition|)
block|{
case|case
name|MLX4_STEERING_MODE_DEVICE_MANAGED
case|:
name|err
operator|=
name|mlx4_flow_steer_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|MLX4_FS_MC_DEFAULT
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX4_STEERING_MODE_B0
case|:
name|err
operator|=
name|mlx4_multicast_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX4_STEERING_MODE_A0
case|:
break|break;
block|}
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling multicast promiscuous mode\n"
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_MC_PROMISC
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed disabling multicast filter\n"
argument_list|)
expr_stmt|;
comment|/* Flush mcast filter and init it with broadcast address */
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|ETH_BCAST
argument_list|,
literal|1
argument_list|,
name|MLX4_MCAST_CONFIG
argument_list|)
expr_stmt|;
comment|/* Update multicast list - we cache all addresses so they won't 		 * change while HW is updated holding the command semaphor */
name|mlx4_en_cache_mclist
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|mclist
argument_list|,
argument|&priv->mc_list
argument_list|,
argument|list
argument_list|)
block|{
name|mcast_addr
operator|=
name|mlx4_mac_to_u64
argument_list|(
name|mclist
operator|->
name|addr
argument_list|)
expr_stmt|;
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|mcast_addr
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_CONFIG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|MLX4_MCAST_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed enabling multicast filter\n"
argument_list|)
expr_stmt|;
name|update_mclist_flags
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|curr_list
argument_list|,
operator|&
name|priv
operator|->
name|mc_list
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|mclist
argument_list|,
argument|tmp
argument_list|,
argument|&priv->curr_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|mclist
operator|->
name|action
operator|==
name|MCLIST_REM
condition|)
block|{
comment|/* detach this address and delete from list */
name|memcpy
argument_list|(
operator|&
name|mc_list
index|[
literal|10
index|]
argument_list|,
name|mclist
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mc_list
index|[
literal|5
index|]
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|err
operator|=
name|mlx4_multicast_detach
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|rss_map
operator|.
name|indir_qp
argument_list|,
name|mc_list
argument_list|,
name|MLX4_PROT_ETH
argument_list|,
name|mclist
operator|->
name|reg_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Fail to detach multicast address\n"
argument_list|)
expr_stmt|;
comment|/* remove from list */
name|list_del
argument_list|(
operator|&
name|mclist
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mclist
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mclist
operator|->
name|action
operator|==
name|MCLIST_ADD
condition|)
block|{
comment|/* attach the address */
name|memcpy
argument_list|(
operator|&
name|mc_list
index|[
literal|10
index|]
argument_list|,
name|mclist
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* needed for B0 steering support */
name|mc_list
index|[
literal|5
index|]
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|err
operator|=
name|mlx4_multicast_attach
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|rss_map
operator|.
name|indir_qp
argument_list|,
name|mc_list
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
name|MLX4_PROT_ETH
argument_list|,
operator|&
name|mclist
operator|->
name|reg_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Fail to attach multicast address\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_do_set_rx_mode
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|rx_mode_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mdev
operator|->
name|device_up
condition|)
block|{
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Card is not up, ignoring rx mode change.\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
block|{
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Port is down, ignoring rx mode change.\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|mlx4_en_QUERY_PORT
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|port_state
operator|.
name|link_state
condition|)
block|{
name|priv
operator|->
name|last_link_state
operator|=
name|MLX4_DEV_EVENT_PORT_UP
expr_stmt|;
comment|/* update netif baudrate */
name|priv
operator|->
name|dev
operator|->
name|if_baudrate
operator|=
name|IF_Mbps
argument_list|(
name|priv
operator|->
name|port_state
operator|.
name|link_speed
argument_list|)
expr_stmt|;
comment|/* Important note: the following call for if_link_state_change 			 * is needed for interface up scenario (start port, link state 			 * change) */
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Link Up\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Promsicuous mode: disable all filters */
if|if
condition|(
operator|(
name|dev
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
operator|||
operator|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_FORCE_PROMISC
operator|)
condition|)
block|{
name|mlx4_en_set_promisc_mode
argument_list|(
name|priv
argument_list|,
name|mdev
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Not in promiscuous mode */
if|if
condition|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_PROMISC
condition|)
name|mlx4_en_clear_promisc_mode
argument_list|(
name|priv
argument_list|,
name|mdev
argument_list|)
expr_stmt|;
name|mlx4_en_do_multicast
argument_list|(
name|priv
argument_list|,
name|dev
argument_list|,
name|mdev
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NET_POLL_CONTROLLER
end_ifdef

begin_function
specifier|static
name|void
name|mlx4_en_netpoll
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cq
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|napi_synchronize
argument_list|(
operator|&
name|cq
operator|->
name|napi
argument_list|)
expr_stmt|;
name|mlx4_en_process_rx_cq
argument_list|(
name|dev
argument_list|,
name|cq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cq
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|mlx4_en_watchdog_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|arg
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Scheduling watchdog\n"
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|watchdog_task
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
name|callout_reset
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|,
name|MLX4_EN_WATCHDOG_TIMEOUT
argument_list|,
name|mlx4_en_watchdog_timeout
argument_list|,
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_set_default_moderation
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* If we haven't received a specific coalescing setting 	 * (module param), we set the moderation parameters as follows: 	 * - moder_cnt is set to the number of mtu sized packets to 	 *   satisfy our coelsing target. 	 * - moder_time is set to a fixed value. 	 */
name|priv
operator|->
name|rx_frames
operator|=
name|MLX4_EN_RX_COAL_TARGET
operator|/
name|priv
operator|->
name|dev
operator|->
name|if_mtu
operator|+
literal|1
expr_stmt|;
name|priv
operator|->
name|rx_usecs
operator|=
name|MLX4_EN_RX_COAL_TIME
expr_stmt|;
name|priv
operator|->
name|tx_frames
operator|=
name|MLX4_EN_TX_COAL_PKTS
expr_stmt|;
name|priv
operator|->
name|tx_usecs
operator|=
name|MLX4_EN_TX_COAL_TIME
expr_stmt|;
name|en_dbg
argument_list|(
name|INTR
argument_list|,
name|priv
argument_list|,
literal|"Default coalesing params for mtu: %u - "
literal|"rx_frames:%d rx_usecs:%d\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|priv
operator|->
name|dev
operator|->
name|if_mtu
argument_list|,
name|priv
operator|->
name|rx_frames
argument_list|,
name|priv
operator|->
name|rx_usecs
argument_list|)
expr_stmt|;
comment|/* Setup cq moderation params */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
expr_stmt|;
name|cq
operator|->
name|moder_cnt
operator|=
name|priv
operator|->
name|rx_frames
expr_stmt|;
name|cq
operator|->
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs
expr_stmt|;
name|priv
operator|->
name|last_moder_time
index|[
name|i
index|]
operator|=
name|MLX4_EN_AUTO_CONF
expr_stmt|;
name|priv
operator|->
name|last_moder_packets
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|last_moder_bytes
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
expr_stmt|;
name|cq
operator|->
name|moder_cnt
operator|=
name|priv
operator|->
name|tx_frames
expr_stmt|;
name|cq
operator|->
name|moder_time
operator|=
name|priv
operator|->
name|tx_usecs
expr_stmt|;
block|}
comment|/* Reset auto-moderation params */
name|priv
operator|->
name|pkt_rate_low
operator|=
name|MLX4_EN_RX_RATE_LOW
expr_stmt|;
name|priv
operator|->
name|rx_usecs_low
operator|=
name|MLX4_EN_RX_COAL_TIME_LOW
expr_stmt|;
name|priv
operator|->
name|pkt_rate_high
operator|=
name|MLX4_EN_RX_RATE_HIGH
expr_stmt|;
name|priv
operator|->
name|rx_usecs_high
operator|=
name|MLX4_EN_RX_COAL_TIME_HIGH
expr_stmt|;
name|priv
operator|->
name|sample_interval
operator|=
name|MLX4_EN_SAMPLE_INTERVAL
expr_stmt|;
name|priv
operator|->
name|adaptive_rx_coal
operator|=
literal|1
expr_stmt|;
name|priv
operator|->
name|last_moder_jiffies
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|last_moder_tx_packets
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_auto_moderation
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|unsigned
name|long
name|period
init|=
call|(
name|unsigned
name|long
call|)
argument_list|(
name|jiffies
operator|-
name|priv
operator|->
name|last_moder_jiffies
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|unsigned
name|long
name|packets
decl_stmt|;
name|unsigned
name|long
name|rate
decl_stmt|;
name|unsigned
name|long
name|avg_pkt_size
decl_stmt|;
name|unsigned
name|long
name|rx_packets
decl_stmt|;
name|unsigned
name|long
name|rx_bytes
decl_stmt|;
name|unsigned
name|long
name|rx_pkt_diff
decl_stmt|;
name|int
name|moder_time
decl_stmt|;
name|int
name|ring
decl_stmt|,
name|err
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|adaptive_rx_coal
operator|||
name|period
operator|<
name|priv
operator|->
name|sample_interval
operator|*
name|HZ
condition|)
return|return;
for|for
control|(
name|ring
operator|=
literal|0
init|;
name|ring
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|ring
operator|++
control|)
block|{
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
name|rx_packets
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|ring
index|]
operator|->
name|packets
expr_stmt|;
name|rx_bytes
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|ring
index|]
operator|->
name|bytes
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
name|rx_pkt_diff
operator|=
operator|(
call|(
name|unsigned
name|long
call|)
argument_list|(
name|rx_packets
operator|-
name|priv
operator|->
name|last_moder_packets
index|[
name|ring
index|]
argument_list|)
operator|)
expr_stmt|;
name|packets
operator|=
name|rx_pkt_diff
expr_stmt|;
name|rate
operator|=
name|packets
operator|*
name|HZ
operator|/
name|period
expr_stmt|;
name|avg_pkt_size
operator|=
name|packets
condition|?
operator|(
call|(
name|unsigned
name|long
call|)
argument_list|(
name|rx_bytes
operator|-
name|priv
operator|->
name|last_moder_bytes
index|[
name|ring
index|]
argument_list|)
operator|)
operator|/
name|packets
else|:
literal|0
expr_stmt|;
comment|/* Apply auto-moderation only when packet rate 		 * exceeds a rate that it matters */
if|if
condition|(
name|rate
operator|>
operator|(
name|MLX4_EN_RX_RATE_THRESH
operator|/
name|priv
operator|->
name|rx_ring_num
operator|)
operator|&&
name|avg_pkt_size
operator|>
name|MLX4_EN_AVG_PKT_SMALL
condition|)
block|{
if|if
condition|(
name|rate
operator|<
name|priv
operator|->
name|pkt_rate_low
condition|)
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
elseif|else
if|if
condition|(
name|rate
operator|>
name|priv
operator|->
name|pkt_rate_high
condition|)
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs_high
expr_stmt|;
else|else
name|moder_time
operator|=
operator|(
name|rate
operator|-
name|priv
operator|->
name|pkt_rate_low
operator|)
operator|*
operator|(
name|priv
operator|->
name|rx_usecs_high
operator|-
name|priv
operator|->
name|rx_usecs_low
operator|)
operator|/
operator|(
name|priv
operator|->
name|pkt_rate_high
operator|-
name|priv
operator|->
name|pkt_rate_low
operator|)
operator|+
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
block|}
else|else
block|{
name|moder_time
operator|=
name|priv
operator|->
name|rx_usecs_low
expr_stmt|;
block|}
if|if
condition|(
name|moder_time
operator|!=
name|priv
operator|->
name|last_moder_time
index|[
name|ring
index|]
condition|)
block|{
name|priv
operator|->
name|last_moder_time
index|[
name|ring
index|]
operator|=
name|moder_time
expr_stmt|;
name|cq
operator|=
name|priv
operator|->
name|rx_cq
index|[
name|ring
index|]
expr_stmt|;
name|cq
operator|->
name|moder_time
operator|=
name|moder_time
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed modifying moderation for cq:%d\n"
argument_list|,
name|ring
argument_list|)
expr_stmt|;
block|}
name|priv
operator|->
name|last_moder_packets
index|[
name|ring
index|]
operator|=
name|rx_packets
expr_stmt|;
name|priv
operator|->
name|last_moder_bytes
index|[
name|ring
index|]
operator|=
name|rx_bytes
expr_stmt|;
block|}
name|priv
operator|->
name|last_moder_jiffies
operator|=
name|jiffies
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_do_get_stats
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|delayed_work
modifier|*
name|delay
init|=
name|to_delayed_work
argument_list|(
name|work
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|delay
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|stats_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|device_up
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_en_DUMP_ETH_STATS
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Could not update stats\n"
argument_list|)
expr_stmt|;
name|mlx4_en_auto_moderation
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
name|queue_delayed_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|stats_task
argument_list|,
name|STATS_DELAY
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* mlx4_en_service_task - Run service task for tasks that needed to be done  * periodically  */
end_comment

begin_function
specifier|static
name|void
name|mlx4_en_service_task
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|delayed_work
modifier|*
name|delay
init|=
name|to_delayed_work
argument_list|(
name|work
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|delay
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|service_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|device_up
condition|)
block|{
name|queue_delayed_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|service_task
argument_list|,
name|SERVICE_TASK_DELAY
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_linkstate
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|linkstate_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|linkstate
init|=
name|priv
operator|->
name|link_state
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
comment|/* If observable port state changed set carrier state and 	 * report to system log */
if|if
condition|(
name|priv
operator|->
name|last_link_state
operator|!=
name|linkstate
condition|)
block|{
if|if
condition|(
name|linkstate
operator|==
name|MLX4_DEV_EVENT_PORT_DOWN
condition|)
block|{
name|en_info
argument_list|(
name|priv
argument_list|,
literal|"Link Down\n"
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
comment|/* update netif baudrate */
name|priv
operator|->
name|dev
operator|->
name|if_baudrate
operator|=
literal|0
expr_stmt|;
comment|/* make sure the port is up before notifying the OS. 		 * This is tricky since we get here on INIT_PORT and 		 * in such case we can't tell the OS the port is up. 		 * To solve this there is a call to if_link_state_change 		 * in set_rx_mode. 		 * */
block|}
elseif|else
if|if
condition|(
name|priv
operator|->
name|port_up
operator|&&
operator|(
name|linkstate
operator|==
name|MLX4_DEV_EVENT_PORT_UP
operator|)
condition|)
block|{
if|if
condition|(
name|mlx4_en_QUERY_PORT
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
condition|)
name|en_info
argument_list|(
name|priv
argument_list|,
literal|"Query port failed\n"
argument_list|)
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|if_baudrate
operator|=
name|IF_Mbps
argument_list|(
name|priv
operator|->
name|port_state
operator|.
name|link_speed
argument_list|)
expr_stmt|;
name|en_info
argument_list|(
name|priv
argument_list|,
literal|"Link Up\n"
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
block|}
name|priv
operator|->
name|last_link_state
operator|=
name|linkstate
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx4_en_start_port
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_en_cq
modifier|*
name|cq
decl_stmt|;
name|struct
name|mlx4_en_tx_ring
modifier|*
name|tx_ring
decl_stmt|;
name|int
name|rx_index
init|=
literal|0
decl_stmt|;
name|int
name|tx_index
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
name|u8
name|mc_list
index|[
literal|16
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"start port called while port already up\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|mc_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|curr_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|ethtool_list
argument_list|)
expr_stmt|;
comment|/* Calculate Rx buf size */
name|dev
operator|->
name|if_mtu
operator|=
name|min
argument_list|(
name|dev
operator|->
name|if_mtu
argument_list|,
name|priv
operator|->
name|max_mtu
argument_list|)
expr_stmt|;
name|mlx4_en_calc_rx_buf
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Rx buf size:%d\n"
argument_list|,
name|priv
operator|->
name|rx_mb_size
argument_list|)
expr_stmt|;
comment|/* Configure rx cq's and rings */
name|err
operator|=
name|mlx4_en_activate_rx_rings
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to activate RX rings\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|cq
operator|=
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
expr_stmt|;
name|mlx4_en_cq_init_lock
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_activate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed activating Rx CQ\n"
argument_list|)
expr_stmt|;
goto|goto
name|cq_err
goto|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cq
operator|->
name|size
condition|;
name|j
operator|++
control|)
name|cq
operator|->
name|buf
index|[
name|j
index|]
operator|.
name|owner_sr_opcode
operator|=
name|MLX4_CQE_OWNER_MASK
expr_stmt|;
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting cq moderation parameters"
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|cq_err
goto|;
block|}
name|mlx4_en_arm_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|cqn
operator|=
name|cq
operator|->
name|mcq
operator|.
name|cqn
expr_stmt|;
operator|++
name|rx_index
expr_stmt|;
block|}
comment|/* Set qp number */
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Getting qp number for port %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_get_qp
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed getting eth qp\n"
argument_list|)
expr_stmt|;
goto|goto
name|cq_err
goto|;
block|}
name|mdev
operator|->
name|mac_removed
index|[
name|priv
operator|->
name|port
index|]
operator|=
literal|0
expr_stmt|;
comment|/* gets default allocated counter index from func cap */
comment|/* or sink counter index if no resources */
name|priv
operator|->
name|counter_index
operator|=
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|def_counter_index
index|[
name|priv
operator|->
name|port
operator|-
literal|1
index|]
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"%s: default counter index %d for port %d\n"
argument_list|,
name|__func__
argument_list|,
name|priv
operator|->
name|counter_index
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_config_rss_steer
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed configuring rss steering\n"
argument_list|)
expr_stmt|;
goto|goto
name|mac_err
goto|;
block|}
name|err
operator|=
name|mlx4_en_create_drop_qp
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|rss_err
goto|;
comment|/* Configure tx cq's and rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
comment|/* Configure cq */
name|cq
operator|=
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
expr_stmt|;
name|err
operator|=
name|mlx4_en_activate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed activating Tx CQ\n"
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
name|err
operator|=
name|mlx4_en_set_cq_moder
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting cq moderation parameters"
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Resetting index of collapsed CQ:%d to -1\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|cq
operator|->
name|buf
operator|->
name|wqe_index
operator|=
name|cpu_to_be16
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Configure ring */
name|tx_ring
operator|=
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
expr_stmt|;
name|err
operator|=
name|mlx4_en_activate_tx_ring
argument_list|(
name|priv
argument_list|,
name|tx_ring
argument_list|,
name|cq
operator|->
name|mcq
operator|.
name|cqn
argument_list|,
name|i
operator|/
name|priv
operator|->
name|num_tx_rings_p_up
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed activating Tx ring %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
comment|/* Arm CQ for TX completions */
name|mlx4_en_arm_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
comment|/* Set initial ownership of all Tx TXBBs to SW (1) */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|tx_ring
operator|->
name|buf_size
condition|;
name|j
operator|+=
name|STAMP_STRIDE
control|)
operator|*
operator|(
operator|(
name|u32
operator|*
operator|)
operator|(
name|tx_ring
operator|->
name|buf
operator|+
name|j
operator|)
operator|)
operator|=
literal|0xffffffff
expr_stmt|;
operator|++
name|tx_index
expr_stmt|;
block|}
comment|/* Configure port */
name|err
operator|=
name|mlx4_SET_PORT_general
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting port general configurations for port %d, with error %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
comment|/* Set default qp number */
name|err
operator|=
name|mlx4_SET_PORT_qpn_calc
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting default qp numbers\n"
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
comment|/* Init port */
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Initializing port\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_INIT_PORT
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed Initializing port\n"
argument_list|)
expr_stmt|;
goto|goto
name|tx_err
goto|;
block|}
comment|/* Attach rx QP to bradcast address */
name|memset
argument_list|(
operator|&
name|mc_list
index|[
literal|10
index|]
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mc_list
index|[
literal|5
index|]
operator|=
name|priv
operator|->
name|port
expr_stmt|;
comment|/* needed for B0 steering support */
if|if
condition|(
name|mlx4_multicast_attach
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|rss_map
operator|.
name|indir_qp
argument_list|,
name|mc_list
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
name|MLX4_PROT_ETH
argument_list|,
operator|&
name|priv
operator|->
name|broadcast_id
argument_list|)
condition|)
name|mlx4_warn
argument_list|(
name|mdev
argument_list|,
literal|"Failed Attaching Broadcast\n"
argument_list|)
expr_stmt|;
comment|/* Must redo promiscuous mode setup. */
name|priv
operator|->
name|flags
operator|&=
operator|~
operator|(
name|MLX4_EN_FLAG_PROMISC
operator||
name|MLX4_EN_FLAG_MC_PROMISC
operator|)
expr_stmt|;
comment|/* Schedule multicast task to populate multicast list */
name|queue_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|rx_mode_task
argument_list|)
expr_stmt|;
name|mlx4_set_stats_bitmap
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|stats_bitmap
argument_list|)
expr_stmt|;
name|priv
operator|->
name|port_up
operator|=
name|true
expr_stmt|;
comment|/* Enable the queues. */
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_DEBUG_FS
name|mlx4_en_create_debug_files
argument_list|(
name|priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|callout_reset
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|,
name|MLX4_EN_WATCHDOG_TIMEOUT
argument_list|,
name|mlx4_en_watchdog_timeout
argument_list|,
name|priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|tx_err
label|:
while|while
condition|(
name|tx_index
operator|--
condition|)
block|{
name|mlx4_en_deactivate_tx_ring
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|tx_ring
index|[
name|tx_index
index|]
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|tx_cq
index|[
name|tx_index
index|]
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_destroy_drop_qp
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|rss_err
label|:
name|mlx4_en_release_rss_steer
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mac_err
label|:
name|mlx4_en_put_qp
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|cq_err
label|:
while|while
condition|(
name|rx_index
operator|--
condition|)
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|rx_cq
index|[
name|rx_index
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
name|mlx4_en_deactivate_rx_ring
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|err
return|;
comment|/* need to close devices */
block|}
end_function

begin_function
name|void
name|mlx4_en_stop_port
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx4_en_mc_list
modifier|*
name|mclist
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u8
name|mc_list
index|[
literal|16
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|port_up
condition|)
block|{
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"stop port called while port already down\n"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_DEBUG_FS
name|mlx4_en_delete_debug_files
argument_list|(
name|priv
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* close port*/
name|mlx4_CLOSE_PORT
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* Set port as not active */
name|priv
operator|->
name|port_up
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|counter_index
operator|!=
literal|0xff
condition|)
block|{
name|mlx4_counter_free
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|counter_index
argument_list|)
expr_stmt|;
name|priv
operator|->
name|counter_index
operator|=
literal|0xff
expr_stmt|;
block|}
comment|/* Promsicuous mode */
if|if
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|steering_mode
operator|==
name|MLX4_STEERING_MODE_DEVICE_MANAGED
condition|)
block|{
name|priv
operator|->
name|flags
operator|&=
operator|~
operator|(
name|MLX4_EN_FLAG_PROMISC
operator||
name|MLX4_EN_FLAG_MC_PROMISC
operator|)
expr_stmt|;
name|mlx4_flow_steer_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|MLX4_FS_ALL_DEFAULT
argument_list|)
expr_stmt|;
name|mlx4_flow_steer_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|MLX4_FS_MC_DEFAULT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_PROMISC
condition|)
block|{
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_PROMISC
expr_stmt|;
comment|/* Disable promiscouos mode */
name|mlx4_unicast_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
comment|/* Disable Multicast promisc */
if|if
condition|(
name|priv
operator|->
name|flags
operator|&
name|MLX4_EN_FLAG_MC_PROMISC
condition|)
block|{
name|mlx4_multicast_promisc_remove
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|base_qpn
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|priv
operator|->
name|flags
operator|&=
operator|~
name|MLX4_EN_FLAG_MC_PROMISC
expr_stmt|;
block|}
block|}
comment|/* Detach All multicasts */
name|memset
argument_list|(
operator|&
name|mc_list
index|[
literal|10
index|]
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mc_list
index|[
literal|5
index|]
operator|=
name|priv
operator|->
name|port
expr_stmt|;
comment|/* needed for B0 steering support */
name|mlx4_multicast_detach
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|rss_map
operator|.
name|indir_qp
argument_list|,
name|mc_list
argument_list|,
name|MLX4_PROT_ETH
argument_list|,
name|priv
operator|->
name|broadcast_id
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|mclist
argument_list|,
argument|&priv->curr_list
argument_list|,
argument|list
argument_list|)
block|{
name|memcpy
argument_list|(
operator|&
name|mc_list
index|[
literal|10
index|]
argument_list|,
name|mclist
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mc_list
index|[
literal|5
index|]
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|mlx4_multicast_detach
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|rss_map
operator|.
name|indir_qp
argument_list|,
name|mc_list
argument_list|,
name|MLX4_PROT_ETH
argument_list|,
name|mclist
operator|->
name|reg_id
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_clear_list
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|mclist
argument_list|,
argument|tmp
argument_list|,
argument|&priv->curr_list
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|mclist
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mclist
argument_list|)
expr_stmt|;
block|}
comment|/* Flush multicast filter */
name|mlx4_SET_MCAST_FLTR
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|MLX4_MCAST_CONFIG
argument_list|)
expr_stmt|;
name|mlx4_en_destroy_drop_qp
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* Free TX Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|mlx4_en_deactivate_tx_ring
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|msleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
name|mlx4_en_free_tx_buf
argument_list|(
name|dev
argument_list|,
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Free RSS qps */
name|mlx4_en_release_rss_steer
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* Unregister Mac address for the port */
name|mlx4_en_put_qp
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mdev
operator|->
name|mac_removed
index|[
name|priv
operator|->
name|port
index|]
operator|=
literal|1
expr_stmt|;
comment|/* Free RX Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mlx4_en_cq
modifier|*
name|cq
init|=
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
decl_stmt|;
name|mlx4_en_deactivate_rx_ring
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mlx4_en_deactivate_cq
argument_list|(
name|priv
argument_list|,
name|cq
argument_list|)
expr_stmt|;
block|}
name|callout_stop
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_restart
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx4_en_priv
argument_list|,
name|watchdog_task
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx4_en_tx_ring
modifier|*
name|ring
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|blocked
operator|==
literal|0
operator|||
name|priv
operator|->
name|port_up
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|ring
operator|=
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ring
operator|->
name|blocked
operator|&&
name|ring
operator|->
name|watchdog_time
operator|+
name|MLX4_EN_WATCHDOG_TIMEOUT
operator|<
name|ticks
condition|)
goto|goto
name|reset
goto|;
block|}
return|return;
name|reset
label|:
name|priv
operator|->
name|port_stats
operator|.
name|tx_timeout
operator|++
expr_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Watchdog task called for port %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|//for (i = 0; i< priv->tx_ring_num; i++)
comment|//        netdev_tx_reset_queue(priv->tx_ring[i]->tx_queue);
if|if
condition|(
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed restarting port %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_clear_stats
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_slave
argument_list|(
name|mdev
operator|->
name|dev
argument_list|)
condition|)
if|if
condition|(
name|mlx4_en_DUMP_ETH_STATS
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|1
argument_list|)
condition|)
name|en_dbg
argument_list|(
name|HW
argument_list|,
name|priv
argument_list|,
literal|"Failed dumping statistics\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv
operator|->
name|pstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
operator|->
name|pstats
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv
operator|->
name|pkstats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
operator|->
name|pkstats
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv
operator|->
name|port_stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
operator|->
name|port_stats
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv
operator|->
name|vport_stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
operator|->
name|vport_stats
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|bytes
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|packets
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|tx_csum
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
operator|->
name|oversized_packets
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|bytes
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|packets
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|csum_ok
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|->
name|csum_none
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_open
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|priv
operator|=
name|arg
expr_stmt|;
name|mdev
operator|=
name|priv
operator|->
name|mdev
expr_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mdev
operator|->
name|device_up
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Cannot open - device down/disabled\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Reset HW statistics and SW counters */
name|mlx4_en_clear_stats
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port:%d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|mlx4_en_free_resources
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_RFS_ACCEL
if|if
condition|(
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
condition|)
block|{
name|free_irq_cpu_rmap
argument_list|(
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
argument_list|)
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|priv
operator|->
name|tx_ring
operator|&&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_tx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|tx_cq
operator|&&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_rx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
argument_list|,
name|priv
operator|->
name|stride
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|priv
operator|->
name|stat_sysctl
operator|!=
name|NULL
condition|)
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|stat_ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx4_en_alloc_resources
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx4_en_port_profile
modifier|*
name|prof
init|=
name|priv
operator|->
name|prof
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|node
init|=
literal|0
decl_stmt|;
comment|/* Create rx Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx4_en_create_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|rx_ring_size
argument_list|,
name|i
argument_list|,
name|RX
argument_list|,
name|node
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|mlx4_en_create_rx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|rx_ring_size
argument_list|,
name|node
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
comment|/* Create tx Rings */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx4_en_create_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|tx_ring_size
argument_list|,
name|i
argument_list|,
name|TX
argument_list|,
name|node
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|mlx4_en_create_tx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|tx_ring_size
argument_list|,
name|TXBB_SIZE
argument_list|,
name|node
argument_list|,
name|i
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_RFS_ACCEL
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
operator|=
name|alloc_irq_cpu_rmap
argument_list|(
name|priv
operator|->
name|rx_ring_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|dev
operator|->
name|rx_cpu_rmap
condition|)
goto|goto
name|err
goto|;
endif|#
directive|endif
comment|/* Re-create stat sysctls in case the number of rings changed. */
name|mlx4_en_sysctl_stat
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to allocate NIC resources\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_rx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|,
name|prof
operator|->
name|rx_ring_size
argument_list|,
name|priv
operator|->
name|stride
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_tx_ring
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
condition|)
name|mlx4_en_destroy_cq
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|tx_cq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|priv
operator|->
name|port_up
operator|=
name|false
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_struct
struct|struct
name|en_port_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|en_port
modifier|*
parameter_list|,
name|struct
name|en_port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|en_port
modifier|*
parameter_list|,
name|struct
name|en_port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PORT_ATTR_RO
parameter_list|(
name|_name
parameter_list|)
define|\
value|struct en_port_attribute en_port_attr_##_name = __ATTR_RO(_name)
end_define

begin_define
define|#
directive|define
name|EN_PORT_ATTR
parameter_list|(
name|_name
parameter_list|,
name|_mode
parameter_list|,
name|_show
parameter_list|,
name|_store
parameter_list|)
define|\
value|struct en_port_attribute en_port_attr_##_name = __ATTR(_name, _mode, _show, _store)
end_define

begin_function
name|void
name|mlx4_en_destroy_netdev
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Destroying netdev on port:%d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_attach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|priv
operator|->
name|vlan_attach
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_detach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|priv
operator|->
name|vlan_detach
argument_list|)
expr_stmt|;
comment|/* Unregister device - this will close the port if it was up */
if|if
condition|(
name|priv
operator|->
name|registered
condition|)
block|{
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|allocated
condition|)
name|mlx4_free_hwq_res
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|res
argument_list|,
name|MLX4_EN_PAGE_SIZE
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|priv
operator|->
name|stats_task
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|priv
operator|->
name|service_task
argument_list|)
expr_stmt|;
comment|/* flush any pending task for this netdev */
name|flush_workqueue
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|)
expr_stmt|;
comment|/* Detach the netdev so tasks would not attempt to access it */
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mdev
operator|->
name|pndev
index|[
name|priv
operator|->
name|port
index|]
operator|=
name|NULL
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* freeing the sysctl conf cannot be called from within mlx4_en_free_resources */
if|if
condition|(
name|priv
operator|->
name|conf_sysctl
operator|!=
name|NULL
condition|)
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|conf_ctx
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|tx_cq
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_change_mtu
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|int
name|new_mtu
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Change MTU called - current:%u new:%u\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|dev
operator|->
name|if_mtu
argument_list|,
operator|(
name|unsigned
operator|)
name|new_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_mtu
operator|<
name|MLX4_EN_MIN_MTU
operator|)
operator|||
operator|(
name|new_mtu
operator|>
name|priv
operator|->
name|max_mtu
operator|)
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Bad MTU size:%d.\n"
argument_list|,
name|new_mtu
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_mtu
operator|=
name|new_mtu
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
if|if
condition|(
operator|!
name|mdev
operator|->
name|device_up
condition|)
block|{
comment|/* NIC is probably restarting - let watchdog task reset 			 *                          * the port */
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"Change MTU called with card down!?\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed restarting port:%d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|watchdog_task
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_calc_media
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|trans_type
decl_stmt|;
name|int
name|active
decl_stmt|;
name|active
operator|=
name|IFM_ETHER
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|last_link_state
operator|==
name|MLX4_DEV_EVENT_PORT_DOWN
condition|)
return|return
operator|(
name|active
operator|)
return|;
name|active
operator||=
name|IFM_FDX
expr_stmt|;
name|trans_type
operator|=
name|priv
operator|->
name|port_state
operator|.
name|transciver
expr_stmt|;
comment|/* XXX I don't know all of the transceiver values. */
switch|switch
condition|(
name|priv
operator|->
name|port_state
operator|.
name|link_speed
condition|)
block|{
case|case
literal|1000
case|:
name|active
operator||=
name|IFM_1000_T
expr_stmt|;
break|break;
case|case
literal|10000
case|:
if|if
condition|(
name|trans_type
operator|>
literal|0
operator|&&
name|trans_type
operator|<=
literal|0xC
condition|)
name|active
operator||=
name|IFM_10G_SR
expr_stmt|;
elseif|else
if|if
condition|(
name|trans_type
operator|==
literal|0x80
operator|||
name|trans_type
operator|==
literal|0
condition|)
name|active
operator||=
name|IFM_10G_CX4
expr_stmt|;
break|break;
case|case
literal|40000
case|:
name|active
operator||=
name|IFM_40G_CR4
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|priv
operator|->
name|prof
operator|->
name|tx_pause
condition|)
name|active
operator||=
name|IFM_ETH_TXPAUSE
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|prof
operator|->
name|rx_pause
condition|)
name|active
operator||=
name|IFM_ETH_RXPAUSE
expr_stmt|;
return|return
operator|(
name|active
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|dev
operator|->
name|if_softc
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|last_link_state
operator|!=
name|MLX4_DEV_EVENT_PORT_DOWN
condition|)
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mlx4_en_calc_media
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
decl_stmt|;
name|int
name|rxpause
decl_stmt|;
name|int
name|txpause
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|dev
operator|->
name|if_softc
expr_stmt|;
name|ifm
operator|=
operator|&
name|priv
operator|->
name|media
expr_stmt|;
name|rxpause
operator|=
name|txpause
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
condition|)
block|{
case|case
name|IFM_AUTO
case|:
break|break;
case|case
name|IFM_10G_SR
case|:
case|case
name|IFM_10G_CX4
case|:
case|case
name|IFM_1000_T
case|:
case|case
name|IFM_40G_CR4
case|:
if|if
condition|(
operator|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|==
name|IFM_SUBTYPE
argument_list|(
name|mlx4_en_calc_media
argument_list|(
name|priv
argument_list|)
argument_list|)
operator|)
operator|&&
operator|(
name|ifm
operator|->
name|ifm_media
operator|&
name|IFM_FDX
operator|)
condition|)
break|break;
comment|/* Fallthrough */
default|default:
name|printf
argument_list|(
literal|"%s: Only auto media type\n"
argument_list|,
name|if_name
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* Allow user to set/clear pause */
if|if
condition|(
name|IFM_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_ETH_RXPAUSE
condition|)
name|rxpause
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|IFM_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_ETH_TXPAUSE
condition|)
name|txpause
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|prof
operator|->
name|tx_pause
operator|!=
name|txpause
operator|||
name|priv
operator|->
name|prof
operator|->
name|rx_pause
operator|!=
name|rxpause
condition|)
block|{
name|priv
operator|->
name|prof
operator|->
name|tx_pause
operator|=
name|txpause
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_pause
operator|=
name|rxpause
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_SET_PORT_general
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETHER_CRC_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|mask
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
name|priv
operator|=
name|dev
operator|->
name|if_softc
expr_stmt|;
name|mdev
operator|=
name|priv
operator|->
name|mdev
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFMTU
case|:
name|error
operator|=
operator|-
name|mlx4_en_change_mtu
argument_list|(
name|dev
argument_list|,
name|ifr
operator|->
name|ifr_mtu
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|dev
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mlx4_en_set_rx_mode
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|mlx4_en_set_rx_mode
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|dev
argument_list|,
name|ifr
argument_list|,
operator|&
name|priv
operator|->
name|media
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|mask
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|dev
operator|->
name|if_capenable
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TXCSUM
condition|)
block|{
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM
expr_stmt|;
name|dev
operator|->
name|if_hwassist
operator|^=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator|)
expr_stmt|;
if|if
condition|(
name|IFCAP_TSO4
operator|&
name|dev
operator|->
name|if_capenable
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM
operator|&
name|dev
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|dev
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO4
expr_stmt|;
name|dev
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_IP_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|dev
argument_list|,
literal|"tso4 disabled due to -txcsum.\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_TXCSUM_IPV6
condition|)
block|{
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM_IPV6
expr_stmt|;
name|dev
operator|->
name|if_hwassist
operator|^=
operator|(
name|CSUM_UDP_IPV6
operator||
name|CSUM_TCP_IPV6
operator|)
expr_stmt|;
if|if
condition|(
name|IFCAP_TSO6
operator|&
name|dev
operator|->
name|if_capenable
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM_IPV6
operator|&
name|dev
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|dev
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO6
expr_stmt|;
name|dev
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_IP6_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|dev
argument_list|,
literal|"tso6 disabled due to -txcsum6.\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_RXCSUM
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_RXCSUM_IPV6
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM_IPV6
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO4
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|IFCAP_TSO4
operator|&
name|dev
operator|->
name|if_capenable
operator|)
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM
operator|&
name|dev
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|if_printf
argument_list|(
name|dev
argument_list|,
literal|"enable txcsum first.\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
name|dev
operator|->
name|if_hwassist
operator|^=
name|CSUM_IP_TSO
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO6
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|IFCAP_TSO6
operator|&
name|dev
operator|->
name|if_capenable
operator|)
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM_IPV6
operator|&
name|dev
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|if_printf
argument_list|(
name|dev
argument_list|,
literal|"enable txcsum6 first.\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO6
expr_stmt|;
name|dev
operator|->
name|if_hwassist
operator|^=
name|CSUM_IP6_TSO
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_LRO
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_LRO
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_WOL_MAGIC
condition|)
name|dev
operator|->
name|if_capenable
operator|^=
name|IFCAP_WOL_MAGIC
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
name|VLAN_CAPABILITIES
argument_list|(
name|dev
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100036
case|case
name|SIOCGI2C
case|:
block|{
name|struct
name|ifi2creq
name|i2c
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|i2c
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
if|if
condition|(
name|i2c
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|i2c
operator|.
name|data
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
comment|/* 		 * Note that we ignore i2c.addr here. The driver hardcodes 		 * the address to 0x50, while standard expects it to be 0xA0. 		 */
name|error
operator|=
name|mlx4_get_module_info
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|i2c
operator|.
name|offset
argument_list|,
name|i2c
operator|.
name|len
argument_list|,
name|i2c
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|<
literal|0
condition|)
block|{
name|error
operator|=
operator|-
name|error
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|i2c
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|dev
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mlx4_en_init_netdev
parameter_list|(
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
parameter_list|,
name|int
name|port
parameter_list|,
name|struct
name|mlx4_en_port_profile
modifier|*
name|prof
parameter_list|)
block|{
name|struct
name|net_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|uint8_t
name|dev_addr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|priv
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Net device allocation failed\n"
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|dev
operator|->
name|if_softc
operator|=
name|priv
expr_stmt|;
name|if_initname
argument_list|(
name|dev
argument_list|,
literal|"mlxen"
argument_list|,
name|atomic_fetchadd_int
argument_list|(
operator|&
name|mlx4_en_unit
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|dev
operator|->
name|if_init
operator|=
name|mlx4_en_open
expr_stmt|;
name|dev
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|dev
operator|->
name|if_ioctl
operator|=
name|mlx4_en_ioctl
expr_stmt|;
name|dev
operator|->
name|if_transmit
operator|=
name|mlx4_en_transmit
expr_stmt|;
name|dev
operator|->
name|if_qflush
operator|=
name|mlx4_en_qflush
expr_stmt|;
name|dev
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|prof
operator|->
name|tx_ring_size
expr_stmt|;
comment|/* 	 * Initialize driver private data 	 */
name|priv
operator|->
name|counter_index
operator|=
literal|0xff
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|stats_lock
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|rx_mode_task
argument_list|,
name|mlx4_en_do_set_rx_mode
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_task
argument_list|,
name|mlx4_en_restart
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|linkstate_task
argument_list|,
name|mlx4_en_linkstate
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|priv
operator|->
name|stats_task
argument_list|,
name|mlx4_en_do_get_stats
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|priv
operator|->
name|service_task
argument_list|,
name|mlx4_en_service_task
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|priv
operator|->
name|watchdog_timer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_RFS_ACCEL
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|filters
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|filters_lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|priv
operator|->
name|msg_enable
operator|=
name|MLX4_EN_MSG_LEVEL
expr_stmt|;
name|priv
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|priv
operator|->
name|mdev
operator|=
name|mdev
expr_stmt|;
name|priv
operator|->
name|ddev
operator|=
operator|&
name|mdev
operator|->
name|pdev
operator|->
name|dev
expr_stmt|;
name|priv
operator|->
name|prof
operator|=
name|prof
expr_stmt|;
name|priv
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|priv
operator|->
name|port_up
operator|=
name|false
expr_stmt|;
name|priv
operator|->
name|flags
operator|=
name|prof
operator|->
name|flags
expr_stmt|;
name|priv
operator|->
name|num_tx_rings_p_up
operator|=
name|mdev
operator|->
name|profile
operator|.
name|num_tx_rings_p_up
expr_stmt|;
name|priv
operator|->
name|tx_ring_num
operator|=
name|prof
operator|->
name|tx_ring_num
expr_stmt|;
name|priv
operator|->
name|tx_ring
operator|=
name|kcalloc
argument_list|(
name|MAX_TX_RINGS
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_en_tx_ring
operator|*
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|tx_ring
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|priv
operator|->
name|tx_cq
operator|=
name|kcalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_en_cq
operator|*
argument_list|)
argument_list|,
name|MAX_TX_RINGS
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|tx_cq
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|priv
operator|->
name|rx_ring_num
operator|=
name|prof
operator|->
name|rx_ring_num
expr_stmt|;
name|priv
operator|->
name|cqe_factor
operator|=
operator|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|cqe_size
operator|==
literal|64
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|priv
operator|->
name|mac_index
operator|=
operator|-
literal|1
expr_stmt|;
name|priv
operator|->
name|last_ifq_jiffies
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|if_counters_rx_errors
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|if_counters_rx_no_buffer
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_MLX4_EN_DCB
if|if
condition|(
operator|!
name|mlx4_is_slave
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|)
condition|)
block|{
name|priv
operator|->
name|dcbx_cap
operator|=
name|DCB_CAP_DCBX_HOST
expr_stmt|;
name|priv
operator|->
name|flags
operator||=
name|MLX4_EN_FLAG_DCB_ENABLED
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_ETS_CFG
condition|)
block|{
name|dev
operator|->
name|dcbnl_ops
operator|=
operator|&
name|mlx4_en_dcbnl_ops
expr_stmt|;
block|}
else|else
block|{
name|en_info
argument_list|(
name|priv
argument_list|,
literal|"QoS disabled - no HW support\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dcbnl_ops
operator|=
operator|&
name|mlx4_en_dcbnl_pfc_ops
expr_stmt|;
block|}
block|}
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX4_EN_MAC_HASH_SIZE
condition|;
operator|++
name|i
control|)
name|INIT_HLIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|mac_hash
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Query for default mac and max mtu */
name|priv
operator|->
name|max_mtu
operator|=
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|eth_mtu_cap
index|[
name|priv
operator|->
name|port
index|]
expr_stmt|;
name|priv
operator|->
name|mac
operator|=
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|def_mac
index|[
name|priv
operator|->
name|port
index|]
expr_stmt|;
if|if
condition|(
name|ILLEGAL_MAC
argument_list|(
name|priv
operator|->
name|mac
argument_list|)
condition|)
block|{
if|#
directive|if
name|BITS_PER_LONG
operator|==
literal|64
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Port: %d, invalid mac burned: 0x%lx, quiting\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|mac
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|BITS_PER_LONG
operator|==
literal|32
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Port: %d, invalid mac burned: 0x%llx, quiting\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|mac
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|priv
operator|->
name|stride
operator|=
name|roundup_pow_of_two
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_en_rx_desc
argument_list|)
operator|+
name|DS_SIZE
argument_list|)
expr_stmt|;
name|mlx4_en_sysctl_conf
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
comment|/* Allocate page for receive rings */
name|err
operator|=
name|mlx4_alloc_hwq_res
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|res
argument_list|,
name|MLX4_EN_PAGE_SIZE
argument_list|,
name|MLX4_EN_PAGE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to allocate page for rx qps\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|priv
operator|->
name|allocated
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Set driver features 	 */
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
operator||
name|IFCAP_HWCSUM_IPV6
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_MTU
operator||
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWCSUM
operator||
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_LINKSTATE
operator||
name|IFCAP_JUMBO_MTU
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_LRO
expr_stmt|;
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWSTATS
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|LSO_support
condition|)
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO4
operator||
name|IFCAP_TSO6
operator||
name|IFCAP_VLAN_HWTSO
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|1100000
comment|/* set TSO limits so that we don't have to drop TX packets */
name|dev
operator|->
name|if_hw_tsomax
operator|=
name|MLX4_EN_TX_MAX_PAYLOAD_SIZE
operator|-
operator|(
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
operator|)
comment|/* hdr */
expr_stmt|;
name|dev
operator|->
name|if_hw_tsomaxsegcount
operator|=
name|MLX4_EN_TX_MAX_MBUF_FRAGS
operator|-
literal|1
comment|/* hdr */
expr_stmt|;
name|dev
operator|->
name|if_hw_tsomaxsegsize
operator|=
name|MLX4_EN_TX_MAX_MBUF_SIZE
expr_stmt|;
endif|#
directive|endif
name|dev
operator|->
name|if_capenable
operator|=
name|dev
operator|->
name|if_capabilities
expr_stmt|;
name|dev
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_capenable
operator|&
operator|(
name|IFCAP_TSO4
operator||
name|IFCAP_TSO6
operator|)
condition|)
name|dev
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
condition|)
name|dev
operator|->
name|if_hwassist
operator||=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM_IPV6
condition|)
name|dev
operator|->
name|if_hwassist
operator||=
operator|(
name|CSUM_UDP_IPV6
operator||
name|CSUM_TCP_IPV6
operator|)
expr_stmt|;
comment|/* Register for VLAN events */
name|priv
operator|->
name|vlan_attach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_config
argument_list|,
name|mlx4_en_vlan_rx_add_vid
argument_list|,
name|priv
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|priv
operator|->
name|vlan_detach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|mlx4_en_vlan_rx_kill_vid
argument_list|,
name|priv
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|mdev
operator|->
name|pndev
index|[
name|priv
operator|->
name|port
index|]
operator|=
name|dev
expr_stmt|;
name|priv
operator|->
name|last_link_state
operator|=
name|MLX4_DEV_EVENT_PORT_DOWN
expr_stmt|;
name|mlx4_en_set_default_moderation
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* Set default MAC */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
condition|;
name|i
operator|++
control|)
name|dev_addr
index|[
name|ETHER_ADDR_LEN
operator|-
literal|1
operator|-
name|i
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|priv
operator|->
name|mac
operator|>>
operator|(
literal|8
operator|*
name|i
operator|)
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|dev
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_IMASK
operator||
name|IFM_ETH_FMASK
argument_list|,
name|mlx4_en_media_change
argument_list|,
name|mlx4_en_media_status
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_1000_T
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_10G_SR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_10G_CX4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_40G_CR4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d TX rings\n"
argument_list|,
name|prof
operator|->
name|tx_ring_num
argument_list|)
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d RX rings\n"
argument_list|,
name|prof
operator|->
name|rx_ring_num
argument_list|)
expr_stmt|;
name|priv
operator|->
name|registered
operator|=
literal|1
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d TX rings\n"
argument_list|,
name|prof
operator|->
name|tx_ring_num
argument_list|)
expr_stmt|;
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Using %d RX rings\n"
argument_list|,
name|prof
operator|->
name|rx_ring_num
argument_list|)
expr_stmt|;
name|priv
operator|->
name|rx_mb_size
operator|=
name|dev
operator|->
name|if_mtu
operator|+
name|ETH_HLEN
operator|+
name|VLAN_HLEN
operator|+
name|ETH_FCS_LEN
expr_stmt|;
name|err
operator|=
name|mlx4_SET_PORT_general
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
argument_list|,
name|prof
operator|->
name|tx_pause
argument_list|,
name|prof
operator|->
name|tx_ppp
argument_list|,
name|prof
operator|->
name|rx_pause
argument_list|,
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed setting port general configurations "
literal|"for port %d, with error %d\n"
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Init port */
name|en_warn
argument_list|(
name|priv
argument_list|,
literal|"Initializing port\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_INIT_PORT
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed Initializing port\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|queue_delayed_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|stats_task
argument_list|,
name|STATS_DELAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdev
operator|->
name|dev
operator|->
name|caps
operator|.
name|flags2
operator|&
name|MLX4_DEV_CAP_FLAG2_TS
condition|)
name|queue_delayed_work
argument_list|(
name|mdev
operator|->
name|workqueue
argument_list|,
operator|&
name|priv
operator|->
name|service_task
argument_list|,
name|SERVICE_TASK_DELAY
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|mlx4_en_destroy_netdev
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_ring_size
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|int
name|rx_size
parameter_list|,
name|int
name|tx_size
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|port_up
init|=
literal|0
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|rx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|rx_size
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MIN_RX_SIZE
argument_list|)
expr_stmt|;
name|rx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|rx_size
argument_list|,
name|MLX4_EN_MAX_RX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|tx_size
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|max_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MIN_TX_SIZE
argument_list|)
expr_stmt|;
name|tx_size
operator|=
name|min_t
argument_list|(
name|u32
argument_list|,
name|tx_size
argument_list|,
name|MLX4_EN_MAX_TX_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_size
operator|==
operator|(
name|priv
operator|->
name|port_up
condition|?
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|->
name|actual_size
else|:
name|priv
operator|->
name|rx_ring
index|[
literal|0
index|]
operator|->
name|size
operator|)
operator|&&
name|tx_size
operator|==
name|priv
operator|->
name|tx_ring
index|[
literal|0
index|]
operator|->
name|size
condition|)
return|return
literal|0
return|;
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_stop_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
operator|=
name|tx_size
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
operator|=
name|rx_size
expr_stmt|;
name|err
operator|=
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed reallocating port resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|port_up
condition|)
block|{
name|err
operator|=
name|mlx4_en_start_port
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_rx_ring_size
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|size
operator|=
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|size
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
operator|-
name|mlx4_en_set_ring_size
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|size
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_tx_ring_size
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|size
operator|=
name|priv
operator|->
name|prof
operator|->
name|tx_ring_size
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|size
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
operator|-
name|mlx4_en_set_ring_size
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ring_size
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_module_info
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_modinfo
modifier|*
name|modinfo
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u8
name|data
index|[
literal|4
index|]
decl_stmt|;
comment|/* Read first 2 bytes to get Module& REV ID */
name|ret
operator|=
name|mlx4_get_module_info
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
literal|0
comment|/*offset*/
argument_list|,
literal|2
comment|/*size*/
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|2
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed to read eeprom module first two bytes, error: 0x%x\n"
argument_list|,
operator|-
name|ret
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
switch|switch
condition|(
name|data
index|[
literal|0
index|]
comment|/* identifier */
condition|)
block|{
case|case
name|MLX4_MODULE_ID_QSFP
case|:
name|modinfo
operator|->
name|type
operator|=
name|ETH_MODULE_SFF_8436
expr_stmt|;
name|modinfo
operator|->
name|eeprom_len
operator|=
name|ETH_MODULE_SFF_8436_LEN
expr_stmt|;
break|break;
case|case
name|MLX4_MODULE_ID_QSFP_PLUS
case|:
if|if
condition|(
name|data
index|[
literal|1
index|]
operator|>=
literal|0x3
condition|)
block|{
comment|/* revision id */
name|modinfo
operator|->
name|type
operator|=
name|ETH_MODULE_SFF_8636
expr_stmt|;
name|modinfo
operator|->
name|eeprom_len
operator|=
name|ETH_MODULE_SFF_8636_LEN
expr_stmt|;
block|}
else|else
block|{
name|modinfo
operator|->
name|type
operator|=
name|ETH_MODULE_SFF_8436
expr_stmt|;
name|modinfo
operator|->
name|eeprom_len
operator|=
name|ETH_MODULE_SFF_8436_LEN
expr_stmt|;
block|}
break|break;
case|case
name|MLX4_MODULE_ID_QSFP28
case|:
name|modinfo
operator|->
name|type
operator|=
name|ETH_MODULE_SFF_8636
expr_stmt|;
name|modinfo
operator|->
name|eeprom_len
operator|=
name|ETH_MODULE_SFF_8636_LEN
expr_stmt|;
break|break;
case|case
name|MLX4_MODULE_ID_SFP
case|:
name|modinfo
operator|->
name|type
operator|=
name|ETH_MODULE_SFF_8472
expr_stmt|;
name|modinfo
operator|->
name|eeprom_len
operator|=
name|ETH_MODULE_SFF_8472_LEN
expr_stmt|;
break|break;
default|default:
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"mlx4_en_get_module_info :  Not recognized cable type\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_get_module_eeprom
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|struct
name|ethtool_eeprom
modifier|*
name|ee
parameter_list|,
name|u8
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
init|=
name|netdev_priv
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|offset
init|=
name|ee
operator|->
name|offset
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
name|ee
operator|->
name|len
operator|==
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|memset
argument_list|(
name|data
argument_list|,
literal|0
argument_list|,
name|ee
operator|->
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|ee
operator|->
name|len
condition|)
block|{
name|en_dbg
argument_list|(
name|DRV
argument_list|,
name|priv
argument_list|,
literal|"mlx4_get_module_info i(%d) offset(%d) len(%d)\n"
argument_list|,
name|i
argument_list|,
name|offset
argument_list|,
name|ee
operator|->
name|len
operator|-
name|i
argument_list|)
expr_stmt|;
name|ret
operator|=
name|mlx4_get_module_info
argument_list|(
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|offset
argument_list|,
name|ee
operator|->
name|len
operator|-
name|i
argument_list|,
name|data
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
comment|/* Done reading */
return|return
literal|0
return|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"mlx4_get_module_info i(%d) offset(%d) bytes_to_read(%d) - FAILED (0x%x)\n"
argument_list|,
name|i
argument_list|,
name|offset
argument_list|,
name|ee
operator|->
name|len
operator|-
name|i
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|i
operator|+=
name|ret
expr_stmt|;
name|offset
operator|+=
name|ret
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_print_eeprom
parameter_list|(
name|u8
modifier|*
name|data
parameter_list|,
name|__u32
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|j
init|=
literal|0
decl_stmt|;
name|int
name|row
init|=
literal|0
decl_stmt|;
specifier|const
name|int
name|NUM_OF_BYTES
init|=
literal|16
decl_stmt|;
name|printf
argument_list|(
literal|"\nOffset\t\tValues\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"------\t\t------\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|row
operator|<
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"0x%04x\t\t"
argument_list|,
name|row
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_OF_BYTES
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|data
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|row
operator|++
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Read cable EEPROM module information by first inspecting the first  * two bytes to get the length and then read the rest of the information.  * The information is printed to dmesg. */
end_comment

begin_function
specifier|static
name|int
name|mlx4_en_read_eeprom
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|u8
modifier|*
name|data
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|net_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|ethtool_modinfo
name|modinfo
decl_stmt|;
name|struct
name|ethtool_eeprom
name|ee
decl_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|result
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|result
operator|==
literal|1
condition|)
block|{
name|priv
operator|=
name|arg1
expr_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
name|data
operator|=
name|kmalloc
argument_list|(
name|PAGE_SIZE
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|error
operator|=
name|mlx4_en_get_module_info
argument_list|(
name|dev
argument_list|,
operator|&
name|modinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"mlx4_en_get_module_info returned with error - FAILED (0x%x)\n"
argument_list|,
operator|-
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ee
operator|.
name|len
operator|=
name|modinfo
operator|.
name|eeprom_len
expr_stmt|;
name|ee
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|mlx4_en_get_module_eeprom
argument_list|(
name|dev
argument_list|,
operator|&
name|ee
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"mlx4_en_get_module_eeprom returned with error - FAILED (0x%x)\n"
argument_list|,
operator|-
name|error
argument_list|)
expr_stmt|;
comment|/* Continue printing partial information in case of an error */
block|}
comment|/* EEPROM information will be printed in dmesg */
name|mlx4_en_print_eeprom
argument_list|(
name|data
argument_list|,
name|ee
operator|.
name|len
argument_list|)
expr_stmt|;
name|out
label|:
name|kfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
comment|/* Return zero to prevent sysctl failure. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_tx_ppp
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|ppp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|ppp
operator|=
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ppp
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|ppp
operator|>
literal|0xff
operator|||
name|ppp
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
operator|=
name|ppp
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_SET_PORT_general
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETHER_CRC_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx4_en_set_rx_ppp
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|mlx4_en_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|mlx4_en_dev
modifier|*
name|mdev
decl_stmt|;
name|int
name|ppp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|port_up
decl_stmt|;
name|port_up
operator|=
literal|0
expr_stmt|;
name|priv
operator|=
name|arg1
expr_stmt|;
name|mdev
operator|=
name|priv
operator|->
name|mdev
expr_stmt|;
name|ppp
operator|=
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|ppp
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|ppp
operator|>
literal|0xff
operator|||
name|ppp
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
comment|/* See if we have to change the number of tx queues. */
if|if
condition|(
operator|!
name|ppp
operator|!=
operator|!
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
condition|)
block|{
name|mutex_lock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|port_up
condition|)
block|{
name|port_up
operator|=
literal|1
expr_stmt|;
name|mlx4_en_stop_port
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
name|mlx4_en_free_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
operator|=
name|ppp
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_en_alloc_resources
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed reallocating port resources\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
name|port_up
condition|)
block|{
name|error
operator|=
operator|-
name|mlx4_en_start_port
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|en_err
argument_list|(
name|priv
argument_list|,
literal|"Failed starting port\n"
argument_list|)
expr_stmt|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|mdev
operator|->
name|state_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
operator|=
name|ppp
expr_stmt|;
name|error
operator|=
operator|-
name|mlx4_SET_PORT_general
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|dev
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|rx_mb_size
operator|+
name|ETHER_CRC_LEN
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|tx_ppp
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_pause
argument_list|,
name|priv
operator|->
name|prof
operator|->
name|rx_ppp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_sysctl_conf
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|net_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|node_list
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|coal
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|coal_list
decl_stmt|;
specifier|const
name|char
modifier|*
name|pnameunit
decl_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
name|ctx
operator|=
operator|&
name|priv
operator|->
name|conf_ctx
expr_stmt|;
name|pnameunit
operator|=
name|device_get_nameunit
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|)
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|priv
operator|->
name|conf_sysctl
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_hw
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|dev
operator|->
name|if_xname
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"mlx4 10gig ethernet"
argument_list|)
expr_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|conf_sysctl
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"conf"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Configuration"
argument_list|)
expr_stmt|;
name|node_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"msg_enable"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|msg_enable
argument_list|,
literal|0
argument_list|,
literal|"Driver message enable bitfield"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring_num
argument_list|,
literal|0
argument_list|,
literal|"Number of receive rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_rings"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|tx_ring_num
argument_list|,
literal|0
argument_list|,
literal|"Number of transmit rings"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_size"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_rx_ring_size
argument_list|,
literal|"I"
argument_list|,
literal|"Receive ring size"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_size"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_tx_ring_size
argument_list|,
literal|"I"
argument_list|,
literal|"Transmit ring size"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_ppp"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_tx_ppp
argument_list|,
literal|"I"
argument_list|,
literal|"TX Per-priority pause"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_ppp"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_set_rx_ppp
argument_list|,
literal|"I"
argument_list|,
literal|"RX Per-priority pause"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"port_num"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port
argument_list|,
literal|0
argument_list|,
literal|"Port Number"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"device_name"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|__DECONST
argument_list|(
name|void
operator|*
argument_list|,
name|pnameunit
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|"PCI device name"
argument_list|)
expr_stmt|;
comment|/* Add coalescer configuration. */
name|coal
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"coalesce"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Interrupt coalesce configuration"
argument_list|)
expr_stmt|;
name|coal_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|coal
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pkt_rate_low"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|pkt_rate_low
argument_list|,
literal|0
argument_list|,
literal|"Packets per-second for minimum delay"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_usecs_low"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|rx_usecs_low
argument_list|,
literal|0
argument_list|,
literal|"Minimum RX delay in micro-seconds"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"pkt_rate_high"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|pkt_rate_high
argument_list|,
literal|0
argument_list|,
literal|"Packets per-second for maximum delay"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_usecs_high"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|rx_usecs_high
argument_list|,
literal|0
argument_list|,
literal|"Maximum RX delay in micro-seconds"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sample_interval"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|sample_interval
argument_list|,
literal|0
argument_list|,
literal|"adaptive frequency in units of HZ ticks"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|coal_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"adaptive_rx_coal"
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|priv
operator|->
name|adaptive_rx_coal
argument_list|,
literal|0
argument_list|,
literal|"Enable adaptive rx coalescing"
argument_list|)
expr_stmt|;
comment|/* EEPROM support */
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"eeprom_info"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_MPSAFE
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|mlx4_en_read_eeprom
argument_list|,
literal|"I"
argument_list|,
literal|"EEPROM information"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx4_en_sysctl_stat
parameter_list|(
name|struct
name|mlx4_en_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|node_list
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|ring_node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|ring_list
decl_stmt|;
name|struct
name|mlx4_en_tx_ring
modifier|*
name|tx_ring
decl_stmt|;
name|struct
name|mlx4_en_rx_ring
modifier|*
name|rx_ring
decl_stmt|;
name|char
name|namebuf
index|[
literal|128
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ctx
operator|=
operator|&
name|priv
operator|->
name|stat_ctx
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|priv
operator|->
name|stat_sysctl
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|conf_sysctl
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stat"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Statistics"
argument_list|)
expr_stmt|;
name|node_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|stat_sysctl
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|MLX4_EN_PERF_STAT
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_poll"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|tx_poll
argument_list|,
literal|"TX Poll calls"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_QUAD
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pktsz_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|tx_pktsz_avg
argument_list|,
literal|"TX average packet size"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"inflight_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|inflight_avg
argument_list|,
literal|"TX average packets in-flight"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_coal_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|tx_coal_avg
argument_list|,
literal|"TX average coalesced completions"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_coal_avg"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pstats
operator|.
name|rx_coal_avg
argument_list|,
literal|"RX average coalesced completions"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tso_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|tso_packets
argument_list|,
literal|"TSO packets sent"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"queue_stopped"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|queue_stopped
argument_list|,
literal|"Queue full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"wake_queue"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|wake_queue
argument_list|,
literal|"Queue resumed after full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_timeout"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|tx_timeout
argument_list|,
literal|"Transmit timeouts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_oversized_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|oversized_packets
argument_list|,
literal|"TX oversized packets, m_defrag failed"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_alloc_failed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|rx_alloc_failed
argument_list|,
literal|"RX failed to allocate mbuf"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_chksum_good"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|rx_chksum_good
argument_list|,
literal|"RX checksum offload success"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_chksum_none"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|rx_chksum_none
argument_list|,
literal|"RX without checksum offload"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_chksum_offload"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|port_stats
operator|.
name|tx_chksum_offload
argument_list|,
literal|"TX checksum offloads"
argument_list|)
expr_stmt|;
comment|/* Could strdup the names and add in a loop.  This is simpler. */
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_bytes
argument_list|,
literal|"RX Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_packets
argument_list|,
literal|"RX packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_multicast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_multicast_packets
argument_list|,
literal|"RX Multicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_broadcast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_broadcast_packets
argument_list|,
literal|"RX Broadcast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_errors
argument_list|,
literal|"RX Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_dropped"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_dropped
argument_list|,
literal|"RX Dropped"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_length_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_length_errors
argument_list|,
literal|"RX Length Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_over_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_over_errors
argument_list|,
literal|"RX Over Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_crc_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_crc_errors
argument_list|,
literal|"RX CRC Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_jabbers"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_jabbers
argument_list|,
literal|"RX Jabbers"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_in_range_length_error"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_in_range_length_error
argument_list|,
literal|"RX IN_Range Length Error"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_out_range_length_error"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_out_range_length_error
argument_list|,
literal|"RX Out Range Length Error"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_lt_64_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_lt_64_bytes_packets
argument_list|,
literal|"RX Lt 64 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_127_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_127_bytes_packets
argument_list|,
literal|"RX 127 bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_255_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_255_bytes_packets
argument_list|,
literal|"RX 255 bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_511_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_511_bytes_packets
argument_list|,
literal|"RX 511 bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_1023_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_1023_bytes_packets
argument_list|,
literal|"RX 1023 bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_1518_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_1518_bytes_packets
argument_list|,
literal|"RX 1518 bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_1522_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_1522_bytes_packets
argument_list|,
literal|"RX 1522 bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_1548_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_1548_bytes_packets
argument_list|,
literal|"RX 1548 bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_gt_1548_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|rx_gt_1548_bytes_packets
argument_list|,
literal|"RX Greater Then 1548 bytes Packets"
argument_list|)
expr_stmt|;
struct|struct
name|mlx4_en_pkt_stats
block|{
name|unsigned
name|long
name|tx_packets
decl_stmt|;
name|unsigned
name|long
name|tx_bytes
decl_stmt|;
name|unsigned
name|long
name|tx_multicast_packets
decl_stmt|;
name|unsigned
name|long
name|tx_broadcast_packets
decl_stmt|;
name|unsigned
name|long
name|tx_errors
decl_stmt|;
name|unsigned
name|long
name|tx_dropped
decl_stmt|;
name|unsigned
name|long
name|tx_lt_64_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_127_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_255_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_511_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_1023_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_1518_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_1522_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_1548_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|tx_gt_1548_bytes_packets
decl_stmt|;
name|unsigned
name|long
name|rx_prio
index|[
name|NUM_PRIORITIES
index|]
index|[
name|NUM_PRIORITY_STATS
index|]
decl_stmt|;
name|unsigned
name|long
name|tx_prio
index|[
name|NUM_PRIORITIES
index|]
index|[
name|NUM_PRIORITY_STATS
index|]
decl_stmt|;
define|#
directive|define
name|NUM_PKT_STATS
value|72
block|}
struct|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_packets
argument_list|,
literal|"TX packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_bytes
argument_list|,
literal|"TX Bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_multicast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_multicast_packets
argument_list|,
literal|"TX Multicast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_broadcast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_broadcast_packets
argument_list|,
literal|"TX Broadcast Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_errors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_errors
argument_list|,
literal|"TX Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_dropped"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_dropped
argument_list|,
literal|"TX Dropped"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_lt_64_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_lt_64_bytes_packets
argument_list|,
literal|"TX Less Then 64 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_127_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_127_bytes_packets
argument_list|,
literal|"TX 127 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_255_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_255_bytes_packets
argument_list|,
literal|"TX 255 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_511_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_511_bytes_packets
argument_list|,
literal|"TX 511 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_1023_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_1023_bytes_packets
argument_list|,
literal|"TX 1023 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_1518_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_1518_bytes_packets
argument_list|,
literal|"TX 1518 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_1522_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_1522_bytes_packets
argument_list|,
literal|"TX 1522 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_1548_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_1548_bytes_packets
argument_list|,
literal|"TX 1548 Bytes Packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_gt_1548_bytes_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|priv
operator|->
name|pkstats
operator|.
name|tx_gt_1548_bytes_packets
argument_list|,
literal|"TX Greater Then 1548 Bytes Packets"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|tx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|tx_ring
operator|=
name|priv
operator|->
name|tx_ring
index|[
name|i
index|]
expr_stmt|;
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"tx_ring%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ring_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
name|namebuf
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"TX Ring"
argument_list|)
expr_stmt|;
name|ring_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ring_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|tx_ring
operator|->
name|packets
argument_list|,
literal|"TX packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|tx_ring
operator|->
name|bytes
argument_list|,
literal|"TX bytes"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|rx_ring_num
condition|;
name|i
operator|++
control|)
block|{
name|rx_ring
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
expr_stmt|;
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"rx_ring%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ring_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|node_list
argument_list|,
name|OID_AUTO
argument_list|,
name|namebuf
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"RX Ring"
argument_list|)
expr_stmt|;
name|ring_list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|ring_node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|packets
argument_list|,
literal|"RX packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|bytes
argument_list|,
literal|"RX bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_ULONG
argument_list|(
name|ctx
argument_list|,
name|ring_list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"error"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rx_ring
operator|->
name|errors
argument_list|,
literal|"RX soft errors"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2012 Mellanox Technologies.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_comment
comment|/*#include "core_priv.h"*/
end_comment

begin_include
include|#
directive|include
file|"mlx4_ib.h"
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/string.h>
end_include

begin_include
include|#
directive|include
file|<linux/fs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_mad.h>
end_include

begin_comment
comment|/*show_admin_alias_guid returns the administratively assigned value of that GUID.  * Values returned in buf parameter string:  *	0			- requests opensm to assign a value.  *	ffffffffffffffff	- delete this entry.  *	other			- value assigned by administrator.  */
end_comment

begin_function
specifier|static
name|ssize_t
name|show_admin_alias_guid
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|record_num
decl_stmt|;
comment|/*0-15*/
name|int
name|guid_index_in_rec
decl_stmt|;
comment|/*0 - 7*/
name|struct
name|mlx4_ib_iov_sysfs_attr
modifier|*
name|mlx4_ib_iov_dentry
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|mlx4_ib_iov_sysfs_attr
argument_list|,
name|dentry
argument_list|)
decl_stmt|;
name|struct
name|mlx4_ib_iov_port
modifier|*
name|port
init|=
name|mlx4_ib_iov_dentry
operator|->
name|ctx
decl_stmt|;
name|struct
name|mlx4_ib_dev
modifier|*
name|mdev
init|=
name|port
operator|->
name|dev
decl_stmt|;
name|record_num
operator|=
name|mlx4_ib_iov_dentry
operator|->
name|entry_num
operator|/
literal|8
expr_stmt|;
name|guid_index_in_rec
operator|=
name|mlx4_ib_iov_dentry
operator|->
name|entry_num
operator|%
literal|8
expr_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%llx\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|be64_to_cpu
argument_list|(
operator|*
operator|(
name|__be64
operator|*
operator|)
operator|&
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|all_recs
index|[
literal|8
operator|*
name|guid_index_in_rec
index|]
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* store_admin_alias_guid stores the (new) administratively assigned value of that GUID.  * Values in buf parameter string:  *	0			- requests opensm to assign a value.  *	0xffffffffffffffff	- delete this entry.  *	other			- guid value assigned by the administrator.  */
end_comment

begin_function
specifier|static
name|ssize_t
name|store_admin_alias_guid
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|int
name|record_num
decl_stmt|;
comment|/*0-15*/
name|int
name|guid_index_in_rec
decl_stmt|;
comment|/*0 - 7*/
name|struct
name|mlx4_ib_iov_sysfs_attr
modifier|*
name|mlx4_ib_iov_dentry
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|mlx4_ib_iov_sysfs_attr
argument_list|,
name|dentry
argument_list|)
decl_stmt|;
name|struct
name|mlx4_ib_iov_port
modifier|*
name|port
init|=
name|mlx4_ib_iov_dentry
operator|->
name|ctx
decl_stmt|;
name|struct
name|mlx4_ib_dev
modifier|*
name|mdev
init|=
name|port
operator|->
name|dev
decl_stmt|;
name|u64
name|sysadmin_ag_val
decl_stmt|;
name|record_num
operator|=
name|mlx4_ib_iov_dentry
operator|->
name|entry_num
operator|/
literal|8
expr_stmt|;
name|guid_index_in_rec
operator|=
name|mlx4_ib_iov_dentry
operator|->
name|entry_num
operator|%
literal|8
expr_stmt|;
if|if
condition|(
literal|0
operator|==
name|record_num
operator|&&
literal|0
operator|==
name|guid_index_in_rec
condition|)
block|{
name|pr_err
argument_list|(
literal|"GUID 0 block 0 is RO\n"
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%llx"
argument_list|,
operator|&
name|sysadmin_ag_val
argument_list|)
expr_stmt|;
operator|*
operator|(
name|__be64
operator|*
operator|)
operator|&
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|all_recs
index|[
name|GUID_REC_SIZE
operator|*
name|guid_index_in_rec
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|sysadmin_ag_val
argument_list|)
expr_stmt|;
comment|/* Change the state to be pending for update */
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|status
operator|=
name|MLX4_GUID_INFO_STATUS_IDLE
expr_stmt|;
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|method
operator|=
name|MLX4_GUID_INFO_RECORD_SET
expr_stmt|;
switch|switch
condition|(
name|sysadmin_ag_val
condition|)
block|{
case|case
name|MLX4_GUID_FOR_DELETE_VAL
case|:
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|method
operator|=
name|MLX4_GUID_INFO_RECORD_DELETE
expr_stmt|;
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|ownership
operator|=
name|MLX4_GUID_SYSADMIN_ASSIGN
expr_stmt|;
break|break;
comment|/* The sysadmin requests the SM to re-assign */
case|case
name|MLX4_NOT_SET_GUID
case|:
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|ownership
operator|=
name|MLX4_GUID_DRIVER_ASSIGN
expr_stmt|;
break|break;
comment|/* The sysadmin requests a specific value.*/
default|default:
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|ownership
operator|=
name|MLX4_GUID_SYSADMIN_ASSIGN
expr_stmt|;
break|break;
block|}
comment|/* set the record index */
name|mdev
operator|->
name|sriov
operator|.
name|alias_guid
operator|.
name|ports_guid
index|[
name|port
operator|->
name|num
operator|-
literal|1
index|]
operator|.
name|all_rec_per_port
index|[
name|record_num
index|]
operator|.
name|guid_indexes
operator|=
name|mlx4_ib_get_aguid_comp_mask_from_ix
argument_list|(
name|guid_index_in_rec
argument_list|)
expr_stmt|;
name|mlx4_ib_init_alias_guid_work
argument_list|(
name|mdev
argument_list|,
name|port
operator|->
name|num
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_gid
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx4_ib_iov_sysfs_attr
modifier|*
name|mlx4_ib_iov_dentry
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|mlx4_ib_iov_sysfs_attr
argument_list|,
name|dentry
argument_list|)
decl_stmt|;
name|struct
name|mlx4_ib_iov_port
modifier|*
name|port
init|=
name|mlx4_ib_iov_dentry
operator|->
name|ctx
decl_stmt|;
name|struct
name|mlx4_ib_dev
modifier|*
name|mdev
init|=
name|port
operator|->
name|dev
decl_stmt|;
name|union
name|ib_gid
name|gid
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|__mlx4_ib_query_gid
argument_list|(
operator|&
name|mdev
operator|->
name|ib_dev
argument_list|,
name|port
operator|->
name|num
argument_list|,
name|mlx4_ib_iov_dentry
operator|->
name|entry_num
argument_list|,
operator|&
name|gid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%04x:%04x:%04x:%04x:%04x:%04x:%04x:%04x\n"
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|3
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|5
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|6
index|]
argument_list|)
argument_list|,
name|be16_to_cpu
argument_list|(
operator|(
operator|(
name|__be16
operator|*
operator|)
name|gid
operator|.
name|raw
operator|)
index|[
literal|7
index|]
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_phys_port_pkey
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx4_ib_iov_sysfs_attr
modifier|*
name|mlx4_ib_iov_dentry
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|mlx4_ib_iov_sysfs_attr
argument_list|,
name|dentry
argument_list|)
decl_stmt|;
name|struct
name|mlx4_ib_iov_port
modifier|*
name|port
init|=
name|mlx4_ib_iov_dentry
operator|->
name|ctx
decl_stmt|;
name|struct
name|mlx4_ib_dev
modifier|*
name|mdev
init|=
name|port
operator|->
name|dev
decl_stmt|;
name|u16
name|pkey
decl_stmt|;
name|ssize_t
name|ret
decl_stmt|;
name|ret
operator|=
name|__mlx4_ib_query_pkey
argument_list|(
operator|&
name|mdev
operator|->
name|ib_dev
argument_list|,
name|port
operator|->
name|num
argument_list|,
name|mlx4_ib_iov_dentry
operator|->
name|entry_num
argument_list|,
operator|&
name|pkey
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"0x%04x\n"
argument_list|,
name|pkey
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|DENTRY_REMOVE
parameter_list|(
name|_dentry
parameter_list|)
define|\
value|do {									\ 	sysfs_remove_file((_dentry)->kobj,&(_dentry)->dentry.attr);	\ } while (0);
end_define

begin_function
specifier|static
name|int
name|create_sysfs_entry
parameter_list|(
name|void
modifier|*
name|_ctx
parameter_list|,
name|struct
name|mlx4_ib_iov_sysfs_attr
modifier|*
name|_dentry
parameter_list|,
name|char
modifier|*
name|_name
parameter_list|,
name|struct
name|kobject
modifier|*
name|_kobj
parameter_list|,
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
parameter_list|,
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|device
modifier|*
name|dev
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|mlx4_ib_iov_sysfs_attr
modifier|*
name|vdentry
init|=
name|_dentry
decl_stmt|;
name|vdentry
operator|->
name|ctx
operator|=
name|_ctx
expr_stmt|;
name|vdentry
operator|->
name|dentry
operator|.
name|show
operator|=
name|show
expr_stmt|;
name|vdentry
operator|->
name|dentry
operator|.
name|store
operator|=
name|store
expr_stmt|;
name|sysfs_attr_init
argument_list|(
operator|&
name|vdentry
operator|->
name|dentry
operator|.
name|attr
argument_list|)
expr_stmt|;
name|vdentry
operator|->
name|dentry
operator|.
name|attr
operator|.
name|name
operator|=
name|vdentry
operator|->
name|name
expr_stmt|;
name|vdentry
operator|->
name|dentry
operator|.
name|attr
operator|.
name|mode
operator|=
literal|0
expr_stmt|;
name|vdentry
operator|->
name|kobj
operator|=
name|_kobj
expr_stmt|;
name|snprintf
argument_list|(
name|vdentry
operator|->
name|name
argument_list|,
literal|15
argument_list|,
literal|"%s"
argument_list|,
name|_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|vdentry
operator|->
name|dentry
operator|.
name|store
condition|)
name|vdentry
operator|->
name|dentry
operator|.
name|attr
operator|.
name|mode
operator||=
name|S_IWUSR
expr_stmt|;
if|if
condition|(
name|vdentry
operator|->
name|dentry
operator|.
name|show
condition|)
name|vdentry
operator|->
name|dentry
operator|.
name|attr
operator|.
name|mode
operator||=
name|S_IRUGO
expr_stmt|;
name|ret
operator|=
name|sysfs_create_file
argument_list|(
name|vdentry
operator|->
name|kobj
argument_list|,
operator|&
name|vdentry
operator|->
name|dentry
operator|.
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pr_err
argument_list|(
literal|"failed to create %s\n"
argument_list|,
name|vdentry
operator|->
name|dentry
operator|.
name|attr
operator|.
name|name
argument_list|)
expr_stmt|;
name|vdentry
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|add_sysfs_port_mcg_attr
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|device
parameter_list|,
name|int
name|port_num
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|mlx4_ib_iov_port
modifier|*
name|port
init|=
operator|&
name|device
operator|->
name|iov_ports
index|[
name|port_num
operator|-
literal|1
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|sysfs_create_file
argument_list|(
name|port
operator|->
name|mcgs_parent
argument_list|,
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|pr_err
argument_list|(
literal|"failed to create %s\n"
argument_list|,
name|attr
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|del_sysfs_port_mcg_attr
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|device
parameter_list|,
name|int
name|port_num
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|mlx4_ib_iov_port
modifier|*
name|port
init|=
operator|&
name|device
operator|->
name|iov_ports
index|[
name|port_num
operator|-
literal|1
index|]
decl_stmt|;
name|sysfs_remove_file
argument_list|(
name|port
operator|->
name|mcgs_parent
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_port_entries
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|device
parameter_list|,
name|int
name|port_num
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|buff
index|[
literal|10
index|]
decl_stmt|;
name|struct
name|mlx4_ib_iov_port
modifier|*
name|port
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
comment|/* get the physical gid and pkey table sizes.*/
name|ret
operator|=
name|__mlx4_ib_query_port
argument_list|(
operator|&
name|device
operator|->
name|ib_dev
argument_list|,
name|port_num
argument_list|,
operator|&
name|attr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err
goto|;
name|port
operator|=
operator|&
name|device
operator|->
name|iov_ports
index|[
name|port_num
operator|-
literal|1
index|]
expr_stmt|;
name|port
operator|->
name|dev
operator|=
name|device
expr_stmt|;
name|port
operator|->
name|num
operator|=
name|port_num
expr_stmt|;
comment|/* Directory structure: 	 * iov - 	 *   port num - 	 *	admin_guids 	 *	gids (operational) 	 *	mcg_table 	 */
name|port
operator|->
name|dentr_ar
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx4_ib_iov_sysfs_attr_ar
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|dentr_ar
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|sprintf
argument_list|(
name|buff
argument_list|,
literal|"%d"
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
name|port
operator|->
name|cur_port
operator|=
name|kobject_create_and_add
argument_list|(
name|buff
argument_list|,
name|kobject_get
argument_list|(
name|device
operator|->
name|ports_parent
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|cur_port
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|kobj_create_err
goto|;
block|}
comment|/* admin GUIDs */
name|port
operator|->
name|admin_alias_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"admin_guids"
argument_list|,
name|kobject_get
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|admin_alias_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_admin_guids
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|gid_tbl_len
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buff
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|port
operator|->
name|dentr_ar
operator|->
name|dentries
index|[
name|i
index|]
operator|.
name|entry_num
operator|=
name|i
expr_stmt|;
name|ret
operator|=
name|create_sysfs_entry
argument_list|(
name|port
argument_list|,
operator|&
name|port
operator|->
name|dentr_ar
operator|->
name|dentries
index|[
name|i
index|]
argument_list|,
name|buff
argument_list|,
name|port
operator|->
name|admin_alias_parent
argument_list|,
name|show_admin_alias_guid
argument_list|,
name|store_admin_alias_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_admin_alias_parent
goto|;
block|}
comment|/* gids subdirectory (operational gids) */
name|port
operator|->
name|gids_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"gids"
argument_list|,
name|kobject_get
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|gids_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_gids
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|gid_tbl_len
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buff
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|port
operator|->
name|dentr_ar
operator|->
name|dentries
index|[
name|attr
operator|.
name|gid_tbl_len
operator|+
name|i
index|]
operator|.
name|entry_num
operator|=
name|i
expr_stmt|;
name|ret
operator|=
name|create_sysfs_entry
argument_list|(
name|port
argument_list|,
operator|&
name|port
operator|->
name|dentr_ar
operator|->
name|dentries
index|[
name|attr
operator|.
name|gid_tbl_len
operator|+
name|i
index|]
argument_list|,
name|buff
argument_list|,
name|port
operator|->
name|gids_parent
argument_list|,
name|show_port_gid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_gids_parent
goto|;
block|}
comment|/* physical port pkey table */
name|port
operator|->
name|pkeys_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"pkeys"
argument_list|,
name|kobject_get
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|pkeys_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_pkeys
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|pkey_tbl_len
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buff
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|port
operator|->
name|dentr_ar
operator|->
name|dentries
index|[
literal|2
operator|*
name|attr
operator|.
name|gid_tbl_len
operator|+
name|i
index|]
operator|.
name|entry_num
operator|=
name|i
expr_stmt|;
name|ret
operator|=
name|create_sysfs_entry
argument_list|(
name|port
argument_list|,
operator|&
name|port
operator|->
name|dentr_ar
operator|->
name|dentries
index|[
literal|2
operator|*
name|attr
operator|.
name|gid_tbl_len
operator|+
name|i
index|]
argument_list|,
name|buff
argument_list|,
name|port
operator|->
name|pkeys_parent
argument_list|,
name|show_phys_port_pkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_pkeys_parent
goto|;
block|}
comment|/* MCGs table */
name|port
operator|->
name|mcgs_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"mcgs"
argument_list|,
name|kobject_get
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|mcgs_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_mcgs
goto|;
block|}
return|return
literal|0
return|;
name|err_mcgs
label|:
name|kobject_put
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|err_pkeys_parent
label|:
name|kobject_put
argument_list|(
name|port
operator|->
name|pkeys_parent
argument_list|)
expr_stmt|;
name|err_pkeys
label|:
name|kobject_put
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|err_gids_parent
label|:
name|kobject_put
argument_list|(
name|port
operator|->
name|gids_parent
argument_list|)
expr_stmt|;
name|err_gids
label|:
name|kobject_put
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|err_admin_alias_parent
label|:
name|kobject_put
argument_list|(
name|port
operator|->
name|admin_alias_parent
argument_list|)
expr_stmt|;
name|err_admin_guids
label|:
name|kobject_put
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|port
operator|->
name|cur_port
argument_list|)
expr_stmt|;
comment|/* once more for create_and_add buff */
name|kobj_create_err
label|:
name|kobject_put
argument_list|(
name|device
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|port
operator|->
name|dentr_ar
argument_list|)
expr_stmt|;
name|err
label|:
name|pr_err
argument_list|(
literal|"add_port_entries FAILED: for port:%d, error: %d\n"
argument_list|,
name|port_num
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_name
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|dev
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|int
name|i
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|char
name|base_name
index|[
literal|9
index|]
decl_stmt|;
comment|/* pci_name format is: bus:dev:func -> xxxx:yy:zz.n */
name|strlcpy
argument_list|(
name|name
argument_list|,
name|pci_name
argument_list|(
name|dev
operator|->
name|dev
operator|->
name|pdev
argument_list|)
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|base_name
argument_list|,
name|name
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/*till xxxx:yy:*/
name|base_name
index|[
literal|8
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* with no ARI only 3 last bits are used so when the fn is higher than 8 	 * need to add it to the dev num, so count in the last number will be 	 * modulo 8 */
name|sprintf
argument_list|(
name|name
argument_list|,
literal|"%s%.2d.%d"
argument_list|,
name|base_name
argument_list|,
operator|(
name|i
operator|/
literal|8
operator|)
argument_list|,
operator|(
name|i
operator|%
literal|8
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|mlx4_port
block|{
name|struct
name|kobject
name|kobj
decl_stmt|;
name|struct
name|mlx4_ib_dev
modifier|*
name|dev
decl_stmt|;
name|struct
name|attribute_group
name|pkey_group
decl_stmt|;
name|struct
name|attribute_group
name|gid_group
decl_stmt|;
name|u8
name|port_num
decl_stmt|;
name|int
name|slave
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|mlx4_port_release
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|)
block|{
name|struct
name|mlx4_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|mlx4_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|struct
name|attribute
modifier|*
name|a
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|p
operator|->
name|pkey_group
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|a
operator|=
name|p
operator|->
name|gid_group
operator|.
name|attrs
index|[
name|i
index|]
operator|)
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|port_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|mlx4_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|mlx4_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ssize_t
name|port_attr_show
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_attribute
modifier|*
name|port_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|mlx4_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|mlx4_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|port_attr
operator|->
name|show
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|port_attr
operator|->
name|show
argument_list|(
name|p
argument_list|,
name|port_attr
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|port_attr_store
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|struct
name|port_attribute
modifier|*
name|port_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|mlx4_port
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|mlx4_port
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|port_attr
operator|->
name|store
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|port_attr
operator|->
name|store
argument_list|(
name|p
argument_list|,
name|port_attr
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|port_sysfs_ops
init|=
block|{
operator|.
name|show
operator|=
name|port_attr_show
block|,
operator|.
name|store
operator|=
name|port_attr_store
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|port_type
init|=
block|{
operator|.
name|release
operator|=
name|mlx4_port_release
block|,
operator|.
name|sysfs_ops
operator|=
operator|&
name|port_sysfs_ops
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|port_table_attribute
block|{
name|struct
name|port_attribute
name|attr
decl_stmt|;
name|char
name|name
index|[
literal|8
index|]
decl_stmt|;
name|int
name|index
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ssize_t
name|show_port_pkey
parameter_list|(
name|struct
name|mlx4_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|ssize_t
name|ret
init|=
operator|-
name|ENODEV
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|dev
operator|->
name|pkeys
operator|.
name|virt2phys_pkey
index|[
name|p
operator|->
name|slave
index|]
index|[
name|p
operator|->
name|port_num
operator|-
literal|1
index|]
index|[
name|tab_attr
operator|->
name|index
index|]
operator|>=
operator|(
name|p
operator|->
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|pkey_table_len
index|[
name|p
operator|->
name|port_num
index|]
operator|)
condition|)
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"none\n"
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|p
operator|->
name|dev
operator|->
name|pkeys
operator|.
name|virt2phys_pkey
index|[
name|p
operator|->
name|slave
index|]
index|[
name|p
operator|->
name|port_num
operator|-
literal|1
index|]
index|[
name|tab_attr
operator|->
name|index
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|store_port_pkey
parameter_list|(
name|struct
name|mlx4_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|port_table_attribute
modifier|*
name|tab_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_table_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* do not allow remapping Dom0 virtual pkey table */
if|if
condition|(
name|p
operator|->
name|slave
operator|==
name|mlx4_master_func_num
argument_list|(
name|p
operator|->
name|dev
operator|->
name|dev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
name|buf
argument_list|,
literal|"no"
argument_list|,
literal|2
argument_list|)
condition|)
name|idx
operator|=
name|p
operator|->
name|dev
operator|->
name|dev
operator|->
name|phys_caps
operator|.
name|pkey_phys_table_len
index|[
name|p
operator|->
name|port_num
index|]
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%i"
argument_list|,
operator|&
name|idx
argument_list|)
operator|!=
literal|1
operator|||
name|idx
operator|>=
name|p
operator|->
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|pkey_table_len
index|[
name|p
operator|->
name|port_num
index|]
operator|||
name|idx
operator|<
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|p
operator|->
name|dev
operator|->
name|pkeys
operator|.
name|virt2phys_pkey
index|[
name|p
operator|->
name|slave
index|]
index|[
name|p
operator|->
name|port_num
operator|-
literal|1
index|]
index|[
name|tab_attr
operator|->
name|index
index|]
operator|=
name|idx
expr_stmt|;
name|mlx4_sync_pkey_table
argument_list|(
name|p
operator|->
name|dev
operator|->
name|dev
argument_list|,
name|p
operator|->
name|slave
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|tab_attr
operator|->
name|index
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx4_gen_pkey_eqe
argument_list|(
name|p
operator|->
name|dev
operator|->
name|dev
argument_list|,
name|p
operator|->
name|slave
argument_list|,
name|p
operator|->
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|pr_err
argument_list|(
literal|"mlx4_gen_pkey_eqe failed for slave %d,"
literal|" port %d, index %d\n"
argument_list|,
name|p
operator|->
name|slave
argument_list|,
name|p
operator|->
name|port_num
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_gid_idx
parameter_list|(
name|struct
name|mlx4_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|p
operator|->
name|slave
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|attribute
modifier|*
modifier|*
name|alloc_group_attrs
parameter_list|(
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|mlx4_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
parameter_list|,
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|mlx4_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|attribute
modifier|*
modifier|*
name|tab_attr
decl_stmt|;
name|struct
name|port_table_attribute
modifier|*
name|element
decl_stmt|;
name|int
name|i
decl_stmt|;
name|tab_attr
operator|=
name|kcalloc
argument_list|(
literal|1
operator|+
name|len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|attribute
operator|*
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tab_attr
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|element
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|port_table_attribute
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|element
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|snprintf
argument_list|(
name|element
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|element
operator|->
name|name
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|element
operator|->
name|name
argument_list|)
condition|)
block|{
name|kfree
argument_list|(
name|element
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|sysfs_attr_init
argument_list|(
operator|&
name|element
operator|->
name|attr
operator|.
name|attr
argument_list|)
expr_stmt|;
name|element
operator|->
name|attr
operator|.
name|attr
operator|.
name|name
operator|=
name|element
operator|->
name|name
expr_stmt|;
if|if
condition|(
name|store
condition|)
block|{
name|element
operator|->
name|attr
operator|.
name|attr
operator|.
name|mode
operator|=
name|S_IWUSR
operator||
name|S_IRUGO
expr_stmt|;
name|element
operator|->
name|attr
operator|.
name|store
operator|=
name|store
expr_stmt|;
block|}
else|else
name|element
operator|->
name|attr
operator|.
name|attr
operator|.
name|mode
operator|=
name|S_IRUGO
expr_stmt|;
name|element
operator|->
name|attr
operator|.
name|show
operator|=
name|show
expr_stmt|;
name|element
operator|->
name|index
operator|=
name|i
expr_stmt|;
name|tab_attr
index|[
name|i
index|]
operator|=
operator|&
name|element
operator|->
name|attr
operator|.
name|attr
expr_stmt|;
block|}
return|return
name|tab_attr
return|;
name|err
label|:
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|kfree
argument_list|(
name|tab_attr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|tab_attr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_port
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|port_num
parameter_list|,
name|int
name|slave
parameter_list|)
block|{
name|struct
name|mlx4_port
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|is_eth
init|=
name|rdma_port_get_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|port_num
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
decl_stmt|;
name|p
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|p
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|p
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|p
operator|->
name|port_num
operator|=
name|port_num
expr_stmt|;
name|p
operator|->
name|slave
operator|=
name|slave
expr_stmt|;
name|ret
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|port_type
argument_list|,
name|kobject_get
argument_list|(
name|dev
operator|->
name|dev_ports_parent
index|[
name|slave
index|]
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_alloc
goto|;
name|p
operator|->
name|pkey_group
operator|.
name|name
operator|=
literal|"pkey_idx"
expr_stmt|;
if|if
condition|(
name|is_eth
condition|)
name|p
operator|->
name|pkey_group
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_pkey
argument_list|,
name|NULL
argument_list|,
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|pkey_table_len
index|[
name|port_num
index|]
argument_list|)
expr_stmt|;
else|else
name|p
operator|->
name|pkey_group
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_pkey
argument_list|,
name|store_port_pkey
argument_list|,
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|pkey_table_len
index|[
name|port_num
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|pkey_group
operator|.
name|attrs
condition|)
goto|goto
name|err_alloc
goto|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_pkey
goto|;
name|p
operator|->
name|gid_group
operator|.
name|name
operator|=
literal|"gid_idx"
expr_stmt|;
name|p
operator|->
name|gid_group
operator|.
name|attrs
operator|=
name|alloc_group_attrs
argument_list|(
name|show_port_gid_idx
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|gid_group
operator|.
name|attrs
condition|)
goto|goto
name|err_free_pkey
goto|;
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|p
operator|->
name|kobj
argument_list|,
operator|&
name|p
operator|->
name|gid_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_free_gid
goto|;
name|list_add_tail
argument_list|(
operator|&
name|p
operator|->
name|kobj
operator|.
name|entry
argument_list|,
operator|&
name|dev
operator|->
name|pkeys
operator|.
name|pkey_port_list
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_free_gid
label|:
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|gid_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|err_free_pkey
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|pkey_table_len
index|[
name|port_num
index|]
condition|;
operator|++
name|i
control|)
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|pkey_group
operator|.
name|attrs
argument_list|)
expr_stmt|;
name|err_alloc
label|:
name|kobject_put
argument_list|(
name|dev
operator|->
name|dev_ports_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|register_one_pkey_tree
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|slave
parameter_list|)
block|{
name|char
name|name
index|[
literal|32
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|port
decl_stmt|;
name|struct
name|kobject
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|struct
name|mlx4_port
modifier|*
name|mport
decl_stmt|;
name|get_name
argument_list|(
name|dev
argument_list|,
name|name
argument_list|,
name|slave
argument_list|,
sizeof|sizeof
name|name
argument_list|)
expr_stmt|;
name|dev
operator|->
name|pkeys
operator|.
name|device_parent
index|[
name|slave
index|]
operator|=
name|kobject_create_and_add
argument_list|(
name|name
argument_list|,
name|kobject_get
argument_list|(
name|dev
operator|->
name|iov_parent
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|pkeys
operator|.
name|device_parent
index|[
name|slave
index|]
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|fail_dev
goto|;
block|}
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|dev
operator|->
name|pkeys
operator|.
name|pkey_port_list
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dev_ports_parent
index|[
name|slave
index|]
operator|=
name|kobject_create_and_add
argument_list|(
literal|"ports"
argument_list|,
name|kobject_get
argument_list|(
name|dev
operator|->
name|pkeys
operator|.
name|device_parent
index|[
name|slave
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|dev_ports_parent
index|[
name|slave
index|]
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_ports
goto|;
block|}
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|dev
operator|->
name|dev
operator|->
name|caps
operator|.
name|num_ports
condition|;
operator|++
name|port
control|)
block|{
name|err
operator|=
name|add_port
argument_list|(
name|dev
argument_list|,
name|port
argument_list|,
name|slave
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_add
goto|;
block|}
return|return
literal|0
return|;
name|err_add
label|:
name|list_for_each_entry_safe
argument_list|(
argument|p
argument_list|,
argument|t
argument_list|,
argument|&dev->pkeys.pkey_port_list[slave]
argument_list|,
argument|entry
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|p
operator|->
name|entry
argument_list|)
expr_stmt|;
name|mport
operator|=
name|container_of
argument_list|(
name|p
argument_list|,
expr|struct
name|mlx4_port
argument_list|,
name|kobj
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|mport
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|mport
operator|->
name|gid_group
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|kobject_put
argument_list|(
name|dev
operator|->
name|dev_ports_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
name|err_ports
label|:
name|kobject_put
argument_list|(
name|dev
operator|->
name|pkeys
operator|.
name|device_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
comment|/* extra put for the device_parent create_and_add */
name|kobject_put
argument_list|(
name|dev
operator|->
name|pkeys
operator|.
name|device_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
name|fail_dev
label|:
name|kobject_put
argument_list|(
name|dev
operator|->
name|iov_parent
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|register_pkey_tree
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|device
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_master
argument_list|(
name|device
operator|->
name|dev
argument_list|)
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|device
operator|->
name|dev
operator|->
name|num_vfs
condition|;
operator|++
name|i
control|)
name|register_one_pkey_tree
argument_list|(
name|device
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|unregister_pkey_tree
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|device
parameter_list|)
block|{
name|int
name|slave
decl_stmt|;
name|struct
name|kobject
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|struct
name|mlx4_port
modifier|*
name|port
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_master
argument_list|(
name|device
operator|->
name|dev
argument_list|)
condition|)
return|return;
for|for
control|(
name|slave
operator|=
name|device
operator|->
name|dev
operator|->
name|num_vfs
init|;
name|slave
operator|>=
literal|0
condition|;
operator|--
name|slave
control|)
block|{
name|list_for_each_entry_safe
argument_list|(
argument|p
argument_list|,
argument|t
argument_list|,
argument|&device->pkeys.pkey_port_list[slave]
argument_list|,
argument|entry
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|p
operator|->
name|entry
argument_list|)
expr_stmt|;
name|port
operator|=
name|container_of
argument_list|(
name|p
argument_list|,
expr|struct
name|mlx4_port
argument_list|,
name|kobj
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|pkey_group
argument_list|)
expr_stmt|;
name|sysfs_remove_group
argument_list|(
name|p
argument_list|,
operator|&
name|port
operator|->
name|gid_group
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|dev_ports_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
block|}
name|kobject_put
argument_list|(
name|device
operator|->
name|dev_ports_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|pkeys
operator|.
name|device_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|pkeys
operator|.
name|device_parent
index|[
name|slave
index|]
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|iov_parent
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|mlx4_ib_device_register_sysfs
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_master
argument_list|(
name|dev
operator|->
name|dev
argument_list|)
condition|)
return|return
literal|0
return|;
name|dev
operator|->
name|iov_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"iov"
argument_list|,
name|kobject_get
argument_list|(
name|dev
operator|->
name|ib_dev
operator|.
name|ports_parent
operator|->
name|parent
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|iov_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|dev
operator|->
name|ports_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"ports"
argument_list|,
name|kobject_get
argument_list|(
name|dev
operator|->
name|iov_parent
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|iov_parent
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_ports
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|dev
operator|->
name|ib_dev
operator|.
name|phys_port_cnt
condition|;
operator|++
name|i
control|)
block|{
name|ret
operator|=
name|add_port_entries
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_add_entries
goto|;
block|}
name|ret
operator|=
name|register_pkey_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_add_entries
goto|;
return|return
literal|0
return|;
name|err_add_entries
label|:
name|kobject_put
argument_list|(
name|dev
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
name|err_ports
label|:
name|kobject_put
argument_list|(
name|dev
operator|->
name|iov_parent
argument_list|)
expr_stmt|;
name|err
label|:
name|kobject_put
argument_list|(
name|dev
operator|->
name|ib_dev
operator|.
name|ports_parent
operator|->
name|parent
argument_list|)
expr_stmt|;
name|pr_err
argument_list|(
literal|"mlx4_ib_device_register_sysfs error (%d)\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|unregister_alias_guid_tree
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|mlx4_ib_iov_port
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|mlx4_is_master
argument_list|(
name|device
operator|->
name|dev
argument_list|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|device
operator|->
name|dev
operator|->
name|caps
operator|.
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
operator|&
name|device
operator|->
name|iov_ports
index|[
name|i
index|]
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|admin_alias_parent
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|gids_parent
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|pkeys_parent
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|mcgs_parent
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|cur_port
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|p
operator|->
name|dev
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|dentr_ar
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|mlx4_ib_device_unregister_sysfs
parameter_list|(
name|struct
name|mlx4_ib_dev
modifier|*
name|device
parameter_list|)
block|{
name|unregister_alias_guid_tree
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|unregister_pkey_tree
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|iov_parent
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|iov_parent
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
name|device
operator|->
name|ib_dev
operator|.
name|ports_parent
operator|->
name|parent
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


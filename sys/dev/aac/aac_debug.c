begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 Michael Smith  * Copyright (c) 2001 Scott Long  * Copyright (c) 2000 BSDi  * Copyright (c) 2001 Adaptec, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$FreeBSD$  */
end_comment

begin_comment
comment|/*  * Debugging support.  */
end_comment

begin_include
include|#
directive|include
file|"opt_aac.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<dev/aac/aac_compat.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/devicestat.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/aac/aacreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/aac/aac_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/aac/aacvar.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|AAC_DEBUG
end_ifdef

begin_function_decl
name|void
name|aac_printstate0
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|aac_intr0
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Dump the command queue indices  */
end_comment

begin_function
name|void
name|aac_print_queues
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"FIB queue header at %p  queues at %p\n"
argument_list|,
operator|&
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_NORM_CMD_QUEUE
index|]
index|[
literal|0
index|]
argument_list|,
operator|&
name|sc
operator|->
name|aac_queues
operator|->
name|qt_HostNormCmdQueue
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"HOST_NORM_CMD  %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_NORM_CMD_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_NORM_CMD_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_HOST_NORM_CMD_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"HOST_HIGH_CMD  %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_HIGH_CMD_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_HIGH_CMD_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_HOST_HIGH_CMD_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"ADAP_NORM_CMD  %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_NORM_CMD_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_NORM_CMD_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_ADAP_NORM_CMD_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"ADAP_HIGH_CMD  %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_HIGH_CMD_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_HIGH_CMD_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_ADAP_HIGH_CMD_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"HOST_NORM_RESP %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_NORM_RESP_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_NORM_RESP_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_HOST_NORM_RESP_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"HOST_HIGH_RESP %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_HIGH_RESP_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_HOST_HIGH_RESP_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_HOST_HIGH_RESP_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"ADAP_NORM_RESP %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_NORM_RESP_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_NORM_RESP_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_ADAP_NORM_RESP_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"ADAP_HIGH_RESP %d/%d (%d)\n"
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_HIGH_RESP_QUEUE
index|]
index|[
name|AAC_PRODUCER_INDEX
index|]
argument_list|,
name|sc
operator|->
name|aac_queues
operator|->
name|qt_qindex
index|[
name|AAC_ADAP_HIGH_RESP_QUEUE
index|]
index|[
name|AAC_CONSUMER_INDEX
index|]
argument_list|,
name|AAC_ADAP_HIGH_RESP_ENTRIES
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_FREE      %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_FREE
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_FREE
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_BIO       %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_BIO
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_BIO
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_READY     %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_READY
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_READY
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_BUSY      %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_BUSY
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_BUSY
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_COMPLETE  %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_COMPLETE
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_COMPLETE
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print the command queue states for controller 0 (callable from DDB)  */
end_comment

begin_function
name|void
name|aac_printstate0
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|aac_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|devclass_get_softc
argument_list|(
name|aac_devclass
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|aac_print_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|aac_hwif
condition|)
block|{
case|case
name|AAC_HWIF_I960RX
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"IDBR 0x%08x  IIMR 0x%08x  "
literal|"IISR 0x%08x\n"
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_IDBR
argument_list|)
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_IIMR
argument_list|)
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_IISR
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"ODBR 0x%08x  OIMR 0x%08x  "
literal|"OISR 0x%08x\n"
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_ODBR
argument_list|)
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_OIMR
argument_list|)
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_OISR
argument_list|)
argument_list|)
expr_stmt|;
name|AAC_SETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_OIMR
argument_list|,
literal|0
comment|/*~(AAC_DB_COMMAND_READY | 			    AAC_DB_RESPONSE_READY | AAC_DB_PRINTF)*/
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"ODBR 0x%08x  OIMR 0x%08x  "
literal|"OISR 0x%08x\n"
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_ODBR
argument_list|)
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_OIMR
argument_list|)
argument_list|,
name|AAC_GETREG4
argument_list|(
name|sc
argument_list|,
name|AAC_RX_OISR
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AAC_HWIF_STRONGARM
case|:
comment|/* XXX implement */
block|}
block|}
end_function

begin_comment
comment|/*  * simulate an interrupt for controller 0  */
end_comment

begin_function
name|void
name|aac_intr0
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|aac_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|devclass_get_softc
argument_list|(
name|aac_devclass
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|aac_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Panic in a slightly informative fashion  */
end_comment

begin_function
name|void
name|aac_panic
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|reason
parameter_list|)
block|{
name|aac_print_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|panic
argument_list|(
name|reason
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print a FIB  */
end_comment

begin_function
name|void
name|aac_print_fib
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|aac_fib
modifier|*
name|fib
parameter_list|,
name|char
modifier|*
name|caller
parameter_list|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"%s: FIB @ %p\n"
argument_list|,
name|caller
argument_list|,
name|fib
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  XferState %b\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|XferState
argument_list|,
literal|"\20"
literal|"\1HOSTOWNED"
literal|"\2ADAPTEROWNED"
literal|"\3INITIALISED"
literal|"\4EMPTY"
literal|"\5FROMPOOL"
literal|"\6FROMHOST"
literal|"\7FROMADAP"
literal|"\10REXPECTED"
literal|"\11RNOTEXPECTED"
literal|"\12DONEADAP"
literal|"\13DONEHOST"
literal|"\14HIGH"
literal|"\15NORM"
literal|"\16ASYNC"
literal|"\17PAGEFILEIO"
literal|"\20SHUTDOWN"
literal|"\21LAZYWRITE"
literal|"\22ADAPMICROFIB"
literal|"\23BIOSFIB"
literal|"\24FAST_RESPONSE"
literal|"\25APIFIB\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  Command       %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|Command
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  StructType    %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|StructType
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  Flags         0x%x\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|Flags
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  Size          %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|Size
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  SenderSize    %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|SenderSize
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  SenderAddress 0x%x\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|SenderFibAddress
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  RcvrAddress   0x%x\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|ReceiverFibAddress
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  SenderData    0x%x\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|SenderData
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fib
operator|->
name|Header
operator|.
name|Command
condition|)
block|{
case|case
name|ContainerCommand
case|:
block|{
name|struct
name|aac_blockread
modifier|*
name|br
decl_stmt|;
name|struct
name|aac_blockwrite
modifier|*
name|bw
decl_stmt|;
name|struct
name|aac_sg_table
modifier|*
name|sg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|br
operator|=
operator|(
expr|struct
name|aac_blockread
operator|*
operator|)
name|fib
operator|->
name|data
expr_stmt|;
name|bw
operator|=
operator|(
expr|struct
name|aac_blockwrite
operator|*
operator|)
name|fib
operator|->
name|data
expr_stmt|;
name|sg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|br
operator|->
name|Command
operator|==
name|VM_CtBlockRead
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  BlockRead: container %d  0x%x/%d\n"
argument_list|,
name|br
operator|->
name|ContainerId
argument_list|,
name|br
operator|->
name|BlockNumber
argument_list|,
name|br
operator|->
name|ByteCount
argument_list|)
expr_stmt|;
name|sg
operator|=
operator|&
name|br
operator|->
name|SgMap
expr_stmt|;
block|}
if|if
condition|(
name|bw
operator|->
name|Command
operator|==
name|VM_CtBlockWrite
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  BlockWrite: container %d  0x%x/%d "
literal|"(%s)\n"
argument_list|,
name|bw
operator|->
name|ContainerId
argument_list|,
name|bw
operator|->
name|BlockNumber
argument_list|,
name|bw
operator|->
name|ByteCount
argument_list|,
name|bw
operator|->
name|Stable
operator|==
name|CSTABLE
condition|?
literal|"stable"
else|:
literal|"unstable"
argument_list|)
expr_stmt|;
name|sg
operator|=
operator|&
name|bw
operator|->
name|SgMap
expr_stmt|;
block|}
if|if
condition|(
name|sg
operator|!=
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  %d s/g entries\n"
argument_list|,
name|sg
operator|->
name|SgCount
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sg
operator|->
name|SgCount
condition|;
name|i
operator|++
control|)
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  0x%08x/%d\n"
argument_list|,
name|sg
operator|->
name|SgEntry
index|[
name|i
index|]
operator|.
name|SgAddress
argument_list|,
name|sg
operator|->
name|SgEntry
index|[
name|i
index|]
operator|.
name|SgByteCount
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"   %16D\n"
argument_list|,
name|fib
operator|->
name|data
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"   %16D\n"
argument_list|,
name|fib
operator|->
name|data
operator|+
literal|16
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Describe an AIF we have received.  */
end_comment

begin_function
name|void
name|aac_print_aif
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|aac_aif_command
modifier|*
name|aif
parameter_list|)
block|{
switch|switch
condition|(
name|aif
operator|->
name|command
condition|)
block|{
case|case
name|AifCmdEventNotify
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"EventNotify(%d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|type
condition|)
block|{
case|case
name|AifEnGeneric
case|:
comment|/* Generic notification */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(Generic) %.*s\n"
argument_list|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EG
argument_list|)
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EG
operator|.
name|text
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnTaskComplete
case|:
comment|/* Task has completed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(TaskComplete)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnConfigChange
case|:
comment|/* Adapter configuration change 						 * occurred */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConfigChange)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnContainerChange
case|:
comment|/* Adapter specific container 						 * configuration change */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerChange) "
literal|"container %d,%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECC
operator|.
name|container
index|[
literal|0
index|]
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECC
operator|.
name|container
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnDeviceFailure
case|:
comment|/* SCSI device failed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(DeviceFailure) "
literal|"handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDF
operator|.
name|deviceHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnMirrorFailover
case|:
comment|/* Mirror failover started */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(MirrorFailover) "
literal|"container %d failed, "
literal|"migrating from slice %d to %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EMF
operator|.
name|container
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EMF
operator|.
name|failedSlice
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EMF
operator|.
name|creatingSlice
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnContainerEvent
case|:
comment|/* Significant container 						 * event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerEvent) "
literal|"container %d event "
literal|"%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECE
operator|.
name|container
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECE
operator|.
name|eventType
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnFileSystemChange
case|:
comment|/* File system changed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FileSystemChange)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnConfigPause
case|:
comment|/* Container pause event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConfigPause)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnConfigResume
case|:
comment|/* Container resume event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConfigResume)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnFailoverChange
case|:
comment|/* Failover space assignment 						 * changed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FailoverChange)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnRAID5RebuildDone
case|:
comment|/* RAID5 rebuild finished */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(RAID5RebuildDone)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnEnclosureManagement
case|:
comment|/* Enclosure management event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(EnclosureManagement) "
literal|"EMPID %d unit %d "
literal|"event %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EEE
operator|.
name|empID
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EEE
operator|.
name|unitID
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EEE
operator|.
name|eventType
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnBatteryEvent
case|:
comment|/* Significant NV battery 						 * event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(BatteryEvent) %d "
literal|"(state was %d, is %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EBE
operator|.
name|transition_type
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EBE
operator|.
name|current_state
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EBE
operator|.
name|prior_state
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnAddContainer
case|:
comment|/* A new container was 						 * created. */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(AddContainer)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnDeleteContainer
case|:
comment|/* A container was deleted. */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(DeleteContainer)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnBatteryNeedsRecond
case|:
comment|/* The battery needs 						 * reconditioning */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(BatteryNeedsRecond)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnClusterEvent
case|:
comment|/* Some cluster event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ClusterEvent) event %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECLE
operator|.
name|eventType
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnDiskSetEvent
case|:
comment|/* A disk set event occured. */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(DiskSetEvent) event %d "
literal|"diskset %lld creator %lld\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDS
operator|.
name|eventType
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDS
operator|.
name|DsNum
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDS
operator|.
name|CreatorId
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifDenMorphComplete
case|:
comment|/* A morph operation 						 * completed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(MorphComplete)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifDenVolumeExtendComplete
case|:
comment|/* A volume expand operation 						  * completed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(VolumeExtendComplete)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(%d)\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|AifCmdJobProgress
case|:
block|{
name|char
modifier|*
name|status
decl_stmt|;
switch|switch
condition|(
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|status
condition|)
block|{
case|case
name|AifJobStsSuccess
case|:
name|status
operator|=
literal|"success"
expr_stmt|;
break|break;
case|case
name|AifJobStsFinished
case|:
name|status
operator|=
literal|"finished"
expr_stmt|;
break|break;
case|case
name|AifJobStsAborted
case|:
name|status
operator|=
literal|"aborted"
expr_stmt|;
break|break;
case|case
name|AifJobStsFailed
case|:
name|status
operator|=
literal|"failed"
expr_stmt|;
break|break;
case|case
name|AifJobStsSuspended
case|:
name|status
operator|=
literal|"suspended"
expr_stmt|;
break|break;
case|case
name|AifJobStsRunning
case|:
name|status
operator|=
literal|"running"
expr_stmt|;
break|break;
default|default:
name|status
operator|=
literal|"unknown status"
expr_stmt|;
break|break;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"JobProgress (%d) - %s (%d, %d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|,
name|status
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|currentTick
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|finalTick
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|type
condition|)
block|{
case|case
name|AifJobScsiZero
case|:
comment|/* SCSI dev clear operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiZero) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobScsiVerify
case|:
comment|/* SCSI device Verify operation 						 * NO REPAIR */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiVerify) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobScsiExercise
case|:
comment|/* SCSI device Exercise 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiExercise) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobScsiVerifyRepair
case|:
comment|/* SCSI device Verify operation 						 * WITH repair */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiVerifyRepair) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrZero
case|:
comment|/* Container clear operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerZero) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrCopy
case|:
comment|/* Container copy operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerCopy) container %d to %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|dst
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrCreateMirror
case|:
comment|/* Container Create Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerCreateMirror) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobCtrMergeMirror
case|:
comment|/* Container Merge Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerMergeMirror) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobCtrScrubMirror
case|:
comment|/* Container Scrub Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerScrubMirror) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrRebuildRaid5
case|:
comment|/* Container Rebuild Raid5 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerRebuildRaid5) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrScrubRaid5
case|:
comment|/* Container Scrub Raid5 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerScrubRaid5) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrMorph
case|:
comment|/* Container morph operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerMorph) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobCtrPartCopy
case|:
comment|/* Container Partition copy 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerPartCopy) container %d to "
literal|"%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|dst
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrRebuildMirror
case|:
comment|/* Container Rebuild Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerRebuildMirror) container "
literal|"%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrCrazyCache
case|:
comment|/* crazy cache */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConatainerCrazyCache) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobFsCreate
case|:
comment|/* File System Create 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FsCreate)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobFsVerify
case|:
comment|/* File System Verify 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FsVerivy)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobFsExtend
case|:
comment|/* File System Extend 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FsExtend)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiFormatNTFS
case|:
comment|/* Format a drive to NTFS */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FormatNTFS)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiFormatFAT
case|:
comment|/* Format a drive to FAT */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FormatFAT)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiUpdateSnapshot
case|:
comment|/* update the read/write half 						 * of a snapshot */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(UpdateSnapshot)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiFormatFAT32
case|:
comment|/* Format a drive to FAT32 */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FormatFAT32)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtlContinuousCtrVerify
case|:
comment|/* Adapter operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContinuousCtrVerify)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(%d)\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
case|case
name|AifCmdAPIReport
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"APIReport (%d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifCmdDriverNotify
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"DriverNotify (%d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AIF %d (%d)\n"
argument_list|,
name|aif
operator|->
name|command
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* AAC_DEBUG */
end_comment

end_unit


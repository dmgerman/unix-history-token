begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013 Tsubai Masanari  * Copyright (c) 2013 Bryan Venteicher<bryanv@FreeBSD.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  *  * $OpenBSD: src/sys/dev/pci/if_vmx.c,v 1.11 2013/06/22 00:28:10 uebayasi Exp $  */
end_comment

begin_comment
comment|/* Driver for VMware vmxnet3 virtual ethernet devices. */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/ip6_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<machine/in_cksum.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|"if_vmxreg.h"
end_include

begin_include
include|#
directive|include
file|"if_vmxvar.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|VMXNET3_FAILPOINTS
end_ifdef

begin_include
include|#
directive|include
file|<sys/fail.h>
end_include

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|DEBUG_FP
argument_list|,
name|OID_AUTO
argument_list|,
name|vmxnet3
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"vmxnet3 fail points"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|VMXNET3_FP
value|_debug_fail_point_vmxnet3
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|vmxnet3_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_resources
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_resources
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_check_version
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_initial_config
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_check_multiqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_msix_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_msi_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_legacy_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_interrupt
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|vmxnet3_interrupt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_intr_resources
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_setup_msix_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_setup_legacy_interrupt
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_setup_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_interrupt
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|vmxnet3_interrupt
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
end_ifndef

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_start_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_drain_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|vmxnet3_init_rxq
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_init_txq
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_rxtx_queues
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_destroy_rxq
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_destroy_txq
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_rxtx_queues
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_txq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_txq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_rxq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_rxq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_queue_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_queue_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_mcast_table
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_init_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_init_hwassist
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_reinit_interface
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_reinit_rss_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_reinit_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_alloc_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_free_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_setup_interface
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_evintr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_txq_eof
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_rx_csum
parameter_list|(
name|struct
name|vmxnet3_rxcompdesc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_newbuf
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|vmxnet3_rxring
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_rxq_eof_discard
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
parameter_list|,
name|struct
name|vmxnet3_rxring
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_rxq_eof
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_legacy_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_txq_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_rxq_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_event_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_txstop
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_rxstop
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|vmxnet3_rxqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_stop
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_txinit
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_rxinit
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|vmxnet3_rxqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_reinit_queues
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_enable_device
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_reinit_rxfilters
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_reinit
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_init_locked
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_txq_offload_ctx
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_txq_load_mbuf
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|,
name|bus_dmamap_t
parameter_list|,
name|bus_dma_segment_t
index|[]
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_txq_unload_mbuf
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|,
name|bus_dmamap_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_txq_encap
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|VMXNET3_LEGACY_TX
end_ifdef

begin_function_decl
specifier|static
name|void
name|vmxnet3_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_function_decl
specifier|static
name|int
name|vmxnet3_txq_mq_start_locked
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_txq_mq_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_txq_tq_deferred
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|vmxnet3_txq_start
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_tx_start_all
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_update_vlan_filter
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_register_vlan
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_unregister_vlan
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_set_rxfilter
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_change_mtu
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
end_ifndef

begin_function_decl
specifier|static
name|void
name|vmxnet3_qflush
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|vmxnet3_watchdog
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_refresh_host_stats
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_txq_accum_stats
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|,
name|struct
name|vmxnet3_txq_stats
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_rxq_accum_stats
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
parameter_list|,
name|struct
name|vmxnet3_rxq_stats
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_tick
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_link_status
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_set_lladdr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_get_lladdr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_setup_txq_sysctl
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
parameter_list|,
name|struct
name|sysctl_oid_list
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_setup_rxq_sysctl
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
parameter_list|,
name|struct
name|sysctl_oid_list
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_setup_queue_sysctl
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
parameter_list|,
name|struct
name|sysctl_oid_list
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_setup_sysctl
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_write_bar0
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|bus_size_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|vmxnet3_read_bar1
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|bus_size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_write_bar1
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|bus_size_t
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_write_cmd
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|vmxnet3_read_cmd
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_enable_intr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_disable_intr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_enable_all_intrs
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_disable_all_intrs
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_dma_malloc
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|bus_size_t
parameter_list|,
name|bus_size_t
parameter_list|,
name|struct
name|vmxnet3_dma_alloc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vmxnet3_dma_free
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|struct
name|vmxnet3_dma_alloc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vmxnet3_tunable_int
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
enum|enum
block|{
name|VMXNET3_BARRIER_RD
block|,
name|VMXNET3_BARRIER_WR
block|,
name|VMXNET3_BARRIER_RDWR
block|, }
name|vmxnet3_barrier_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|vmxnet3_barrier
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
parameter_list|,
name|vmxnet3_barrier_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Tunables. */
end_comment

begin_decl_stmt
specifier|static
name|int
name|vmxnet3_mq_disable
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmx.mq_disable"
argument_list|,
operator|&
name|vmxnet3_mq_disable
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|vmxnet3_default_txnqueue
init|=
name|VMXNET3_DEF_TX_QUEUES
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmx.txnqueue"
argument_list|,
operator|&
name|vmxnet3_default_txnqueue
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|vmxnet3_default_rxnqueue
init|=
name|VMXNET3_DEF_RX_QUEUES
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmx.rxnqueue"
argument_list|,
operator|&
name|vmxnet3_default_rxnqueue
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|vmxnet3_default_txndesc
init|=
name|VMXNET3_DEF_TX_NDESC
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmx.txndesc"
argument_list|,
operator|&
name|vmxnet3_default_txndesc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|vmxnet3_default_rxndesc
init|=
name|VMXNET3_DEF_RX_NDESC
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.vmx.rxndesc"
argument_list|,
operator|&
name|vmxnet3_default_rxndesc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|vmxnet3_methods
index|[]
init|=
block|{
comment|/* Device interface. */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|vmxnet3_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|vmxnet3_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|vmxnet3_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|vmxnet3_shutdown
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|vmxnet3_driver
init|=
block|{
literal|"vmx"
block|,
name|vmxnet3_methods
block|,
expr|sizeof
operator|(
expr|struct
name|vmxnet3_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|vmxnet3_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|vmx
argument_list|,
name|pci
argument_list|,
name|vmxnet3_driver
argument_list|,
name|vmxnet3_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|vmx
argument_list|,
name|pci
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|vmx
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|VMXNET3_VMWARE_VENDOR_ID
value|0x15AD
end_define

begin_define
define|#
directive|define
name|VMXNET3_VMWARE_DEVICE_ID
value|0x07B0
end_define

begin_function
specifier|static
name|int
name|vmxnet3_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
name|VMXNET3_VMWARE_VENDOR_ID
operator|&&
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|VMXNET3_VMWARE_DEVICE_ID
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"VMware VMXNET3 Ethernet Adapter"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_dev
operator|=
name|dev
expr_stmt|;
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|VMXNET3_CORE_LOCK_INIT
argument_list|(
name|sc
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|vmx_tick
argument_list|,
operator|&
name|sc
operator|->
name|vmx_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vmxnet3_initial_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|vmxnet3_alloc_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|vmxnet3_check_version
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|vmxnet3_alloc_rxtx_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
name|error
operator|=
name|vmxnet3_alloc_taskqueue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
endif|#
directive|endif
name|error
operator|=
name|vmxnet3_alloc_interrupts
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|vmxnet3_check_multiqueue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|vmxnet3_alloc_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|vmxnet3_setup_interface
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|vmxnet3_setup_interrupts
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ether_ifdetach
argument_list|(
name|sc
operator|->
name|vmx_ifp
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not set up interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|vmxnet3_setup_sysctl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
name|vmxnet3_start_taskqueue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fail
label|:
if|if
condition|(
name|error
condition|)
name|vmxnet3_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
if|if
condition|(
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|vmx_tick
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
name|vmxnet3_drain_taskqueue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_vlan_attach
operator|!=
name|NULL
condition|)
block|{
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|sc
operator|->
name|vmx_vlan_attach
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_vlan_attach
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_vlan_detach
operator|!=
name|NULL
condition|)
block|{
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|sc
operator|->
name|vmx_vlan_detach
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_vlan_detach
operator|=
name|NULL
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
name|vmxnet3_free_taskqueue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|vmxnet3_free_interrupts
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
block|{
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_ifp
operator|=
name|NULL
expr_stmt|;
block|}
name|ifmedia_removeall
argument_list|(
operator|&
name|sc
operator|->
name|vmx_media
argument_list|)
expr_stmt|;
name|vmxnet3_free_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_free_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_free_rxtx_queues
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VMXNET3_CORE_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_resources
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_res0
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_res0
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not map BAR0 memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|vmx_iot0
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|vmx_res0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_ioh0
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|vmx_res0
argument_list|)
expr_stmt|;
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_res1
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_res1
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not map BAR1 memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|vmx_iot1
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|vmx_res1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_ioh1
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|vmx_res1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_find_cap
argument_list|(
name|dev
argument_list|,
name|PCIY_MSIX
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_msix_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_msix_res
operator|==
name|NULL
condition|)
name|sc
operator|->
name|vmx_flags
operator||=
name|VMXNET3_FLAG_NO_MSIX
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_resources
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_res0
operator|!=
name|NULL
condition|)
block|{
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|sc
operator|->
name|vmx_res0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_res0
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_res1
operator|!=
name|NULL
condition|)
block|{
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|sc
operator|->
name|vmx_res1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_res1
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_msix_res
operator|!=
name|NULL
condition|)
block|{
name|rid
operator|=
name|PCIR_BAR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rid
argument_list|,
name|sc
operator|->
name|vmx_msix_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_msix_res
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_check_version
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|version
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|version
operator|=
name|vmxnet3_read_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_VRRS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|version
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unsupported hardware version %#x\n"
argument_list|,
name|version
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTSUP
operator|)
return|;
block|}
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_VRRS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|version
operator|=
name|vmxnet3_read_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_UVRS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|version
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unsupported UPT version %#x\n"
argument_list|,
name|version
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTSUP
operator|)
return|;
block|}
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_UVRS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|trunc_powerof2
parameter_list|(
name|int
name|val
parameter_list|)
block|{
return|return
operator|(
literal|1U
operator|<<
operator|(
name|fls
argument_list|(
name|val
argument_list|)
operator|-
literal|1
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_initial_config
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|nqueue
decl_stmt|,
name|ndesc
decl_stmt|;
name|nqueue
operator|=
name|vmxnet3_tunable_int
argument_list|(
name|sc
argument_list|,
literal|"txnqueue"
argument_list|,
name|vmxnet3_default_txnqueue
argument_list|)
expr_stmt|;
if|if
condition|(
name|nqueue
operator|>
name|VMXNET3_MAX_TX_QUEUES
operator|||
name|nqueue
operator|<
literal|1
condition|)
name|nqueue
operator|=
name|VMXNET3_DEF_TX_QUEUES
expr_stmt|;
if|if
condition|(
name|nqueue
operator|>
name|mp_ncpus
condition|)
name|nqueue
operator|=
name|mp_ncpus
expr_stmt|;
name|sc
operator|->
name|vmx_max_ntxqueues
operator|=
name|trunc_powerof2
argument_list|(
name|nqueue
argument_list|)
expr_stmt|;
name|nqueue
operator|=
name|vmxnet3_tunable_int
argument_list|(
name|sc
argument_list|,
literal|"rxnqueue"
argument_list|,
name|vmxnet3_default_rxnqueue
argument_list|)
expr_stmt|;
if|if
condition|(
name|nqueue
operator|>
name|VMXNET3_MAX_RX_QUEUES
operator|||
name|nqueue
operator|<
literal|1
condition|)
name|nqueue
operator|=
name|VMXNET3_DEF_RX_QUEUES
expr_stmt|;
if|if
condition|(
name|nqueue
operator|>
name|mp_ncpus
condition|)
name|nqueue
operator|=
name|mp_ncpus
expr_stmt|;
name|sc
operator|->
name|vmx_max_nrxqueues
operator|=
name|trunc_powerof2
argument_list|(
name|nqueue
argument_list|)
expr_stmt|;
if|if
condition|(
name|vmxnet3_tunable_int
argument_list|(
name|sc
argument_list|,
literal|"mq_disable"
argument_list|,
name|vmxnet3_mq_disable
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vmx_max_nrxqueues
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|vmx_max_ntxqueues
operator|=
literal|1
expr_stmt|;
block|}
name|ndesc
operator|=
name|vmxnet3_tunable_int
argument_list|(
name|sc
argument_list|,
literal|"txd"
argument_list|,
name|vmxnet3_default_txndesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndesc
operator|>
name|VMXNET3_MAX_TX_NDESC
operator|||
name|ndesc
operator|<
name|VMXNET3_MIN_TX_NDESC
condition|)
name|ndesc
operator|=
name|VMXNET3_DEF_TX_NDESC
expr_stmt|;
if|if
condition|(
name|ndesc
operator|&
name|VMXNET3_MASK_TX_NDESC
condition|)
name|ndesc
operator|&=
operator|~
name|VMXNET3_MASK_TX_NDESC
expr_stmt|;
name|sc
operator|->
name|vmx_ntxdescs
operator|=
name|ndesc
expr_stmt|;
name|ndesc
operator|=
name|vmxnet3_tunable_int
argument_list|(
name|sc
argument_list|,
literal|"rxd"
argument_list|,
name|vmxnet3_default_rxndesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndesc
operator|>
name|VMXNET3_MAX_RX_NDESC
operator|||
name|ndesc
operator|<
name|VMXNET3_MIN_RX_NDESC
condition|)
name|ndesc
operator|=
name|VMXNET3_DEF_RX_NDESC
expr_stmt|;
if|if
condition|(
name|ndesc
operator|&
name|VMXNET3_MASK_RX_NDESC
condition|)
name|ndesc
operator|&=
operator|~
name|VMXNET3_MASK_RX_NDESC
expr_stmt|;
name|sc
operator|->
name|vmx_nrxdescs
operator|=
name|ndesc
expr_stmt|;
name|sc
operator|->
name|vmx_max_rxsegs
operator|=
name|VMXNET3_MAX_RX_SEGS
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_check_multiqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|vmx_intr_type
operator|!=
name|VMXNET3_IT_MSIX
condition|)
goto|goto
name|out
goto|;
comment|/* BMV: Just use the maximum configured for now. */
name|sc
operator|->
name|vmx_nrxqueues
operator|=
name|sc
operator|->
name|vmx_max_nrxqueues
expr_stmt|;
name|sc
operator|->
name|vmx_ntxqueues
operator|=
name|sc
operator|->
name|vmx_max_ntxqueues
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_nrxqueues
operator|>
literal|1
condition|)
name|sc
operator|->
name|vmx_flags
operator||=
name|VMXNET3_FLAG_RSS
expr_stmt|;
return|return;
name|out
label|:
name|sc
operator|->
name|vmx_ntxqueues
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|vmx_nrxqueues
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_msix_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|nmsix
decl_stmt|,
name|cnt
decl_stmt|,
name|required
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_flags
operator|&
name|VMXNET3_FLAG_NO_MSIX
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* Allocate an additional vector for the events interrupt. */
name|required
operator|=
name|sc
operator|->
name|vmx_max_nrxqueues
operator|+
name|sc
operator|->
name|vmx_max_ntxqueues
operator|+
literal|1
expr_stmt|;
name|nmsix
operator|=
name|pci_msix_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmsix
operator|<
name|required
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|cnt
operator|=
name|required
expr_stmt|;
if|if
condition|(
name|pci_alloc_msix
argument_list|(
name|dev
argument_list|,
operator|&
name|cnt
argument_list|)
operator|==
literal|0
operator|&&
name|cnt
operator|>=
name|required
condition|)
block|{
name|sc
operator|->
name|vmx_nintrs
operator|=
name|required
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* BMV TODO Fallback to sharing MSIX vectors if possible. */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_msi_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|nmsi
decl_stmt|,
name|cnt
decl_stmt|,
name|required
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|required
operator|=
literal|1
expr_stmt|;
name|nmsi
operator|=
name|pci_msi_count
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmsi
operator|<
name|required
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|cnt
operator|=
name|required
expr_stmt|;
if|if
condition|(
name|pci_alloc_msi
argument_list|(
name|dev
argument_list|,
operator|&
name|cnt
argument_list|)
operator|==
literal|0
operator|&&
name|cnt
operator|>=
name|required
condition|)
block|{
name|sc
operator|->
name|vmx_nintrs
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_legacy_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|vmx_nintrs
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_interrupt
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|int
name|rid
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|vmxnet3_interrupt
modifier|*
name|intr
parameter_list|)
block|{
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|irq
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|intr
operator|->
name|vmxi_irq
operator|=
name|irq
expr_stmt|;
name|intr
operator|->
name|vmxi_rid
operator|=
name|rid
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_intr_resources
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rid
decl_stmt|,
name|flags
decl_stmt|,
name|error
decl_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
name|RF_ACTIVE
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_intr_type
operator|==
name|VMXNET3_IT_LEGACY
condition|)
name|flags
operator||=
name|RF_SHAREABLE
expr_stmt|;
else|else
name|rid
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nintrs
condition|;
name|i
operator|++
operator|,
name|rid
operator|++
control|)
block|{
name|error
operator|=
name|vmxnet3_alloc_interrupt
argument_list|(
name|sc
argument_list|,
name|rid
argument_list|,
name|flags
argument_list|,
operator|&
name|sc
operator|->
name|vmx_intrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_setup_msix_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_interrupt
modifier|*
name|intr
decl_stmt|;
name|enum
name|intr_type
name|type
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|intr
operator|=
operator|&
name|sc
operator|->
name|vmx_intrs
index|[
literal|0
index|]
expr_stmt|;
name|type
operator|=
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
operator|,
name|intr
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|type
argument_list|,
name|NULL
argument_list|,
name|vmxnet3_txq_intr
argument_list|,
name|txq
argument_list|,
operator|&
name|intr
operator|->
name|vmxi_handler
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bus_describe_intr
argument_list|(
name|dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|intr
operator|->
name|vmxi_handler
argument_list|,
literal|"tq%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|txq
operator|->
name|vxtxq_intr_idx
operator|=
name|intr
operator|->
name|vmxi_rid
operator|-
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
operator|,
name|intr
operator|++
control|)
block|{
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|type
argument_list|,
name|NULL
argument_list|,
name|vmxnet3_rxq_intr
argument_list|,
name|rxq
argument_list|,
operator|&
name|intr
operator|->
name|vmxi_handler
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bus_describe_intr
argument_list|(
name|dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|intr
operator|->
name|vmxi_handler
argument_list|,
literal|"rq%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|vxrxq_intr_idx
operator|=
name|intr
operator|->
name|vmxi_rid
operator|-
literal|1
expr_stmt|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|type
argument_list|,
name|NULL
argument_list|,
name|vmxnet3_event_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|intr
operator|->
name|vmxi_handler
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bus_describe_intr
argument_list|(
name|dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|intr
operator|->
name|vmxi_handler
argument_list|,
literal|"event"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_event_intr_idx
operator|=
name|intr
operator|->
name|vmxi_rid
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_setup_legacy_interrupt
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmxnet3_interrupt
modifier|*
name|intr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|intr
operator|=
operator|&
name|sc
operator|->
name|vmx_intrs
index|[
literal|0
index|]
expr_stmt|;
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|vmxnet3_legacy_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|intr
operator|->
name|vmxi_handler
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
operator|.
name|vxtxq_intr_idx
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
operator|.
name|vxrxq_intr_idx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|vmx_event_intr_idx
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_set_interrupt_idx
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|vmxnet3_txq_shared
modifier|*
name|txs
decl_stmt|;
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_rxq_shared
modifier|*
name|rxs
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|vmx_ds
operator|->
name|evintr
operator|=
name|sc
operator|->
name|vmx_event_intr_idx
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
name|txs
operator|=
name|txq
operator|->
name|vxtxq_ts
expr_stmt|;
name|txs
operator|->
name|intr_idx
operator|=
name|txq
operator|->
name|vxtxq_intr_idx
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
block|{
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
expr_stmt|;
name|rxs
operator|=
name|rxq
operator|->
name|vxrxq_rs
expr_stmt|;
name|rxs
operator|->
name|intr_idx
operator|=
name|rxq
operator|->
name|vxrxq_intr_idx
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_setup_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|vmxnet3_alloc_intr_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|sc
operator|->
name|vmx_intr_type
condition|)
block|{
case|case
name|VMXNET3_IT_MSIX
case|:
name|error
operator|=
name|vmxnet3_setup_msix_interrupts
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|VMXNET3_IT_MSI
case|:
case|case
name|VMXNET3_IT_LEGACY
case|:
name|error
operator|=
name|vmxnet3_setup_legacy_interrupt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: invalid interrupt type %d"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|vmx_intr_type
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|vmxnet3_set_interrupt_idx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint32_t
name|config
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|config
operator|=
name|vmxnet3_read_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_GET_INTRCFG
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_intr_type
operator|=
name|config
operator|&
literal|0x03
expr_stmt|;
name|sc
operator|->
name|vmx_intr_mask_mode
operator|=
operator|(
name|config
operator|>>
literal|2
operator|)
operator|&
literal|0x03
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|vmx_intr_type
condition|)
block|{
case|case
name|VMXNET3_IT_AUTO
case|:
name|sc
operator|->
name|vmx_intr_type
operator|=
name|VMXNET3_IT_MSIX
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VMXNET3_IT_MSIX
case|:
name|error
operator|=
name|vmxnet3_alloc_msix_interrupts
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
break|break;
name|sc
operator|->
name|vmx_intr_type
operator|=
name|VMXNET3_IT_MSI
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VMXNET3_IT_MSI
case|:
name|error
operator|=
name|vmxnet3_alloc_msi_interrupts
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
break|break;
name|sc
operator|->
name|vmx_intr_type
operator|=
name|VMXNET3_IT_LEGACY
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VMXNET3_IT_LEGACY
case|:
name|error
operator|=
name|vmxnet3_alloc_legacy_interrupts
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
break|break;
comment|/* FALLTHROUGH */
default|default:
name|sc
operator|->
name|vmx_intr_type
operator|=
operator|-
literal|1
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate any interrupt resources\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_interrupt
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmxnet3_interrupt
modifier|*
name|intr
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
if|if
condition|(
name|intr
operator|->
name|vmxi_handler
operator|!=
name|NULL
condition|)
block|{
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|,
name|intr
operator|->
name|vmxi_handler
argument_list|)
expr_stmt|;
name|intr
operator|->
name|vmxi_handler
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|intr
operator|->
name|vmxi_irq
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|intr
operator|->
name|vmxi_rid
argument_list|,
name|intr
operator|->
name|vmxi_irq
argument_list|)
expr_stmt|;
name|intr
operator|->
name|vmxi_irq
operator|=
name|NULL
expr_stmt|;
name|intr
operator|->
name|vmxi_rid
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_interrupts
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nintrs
condition|;
name|i
operator|++
control|)
name|vmxnet3_free_interrupt
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_intrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_intr_type
operator|==
name|VMXNET3_IT_MSI
operator|||
name|sc
operator|->
name|vmx_intr_type
operator|==
name|VMXNET3_IT_MSIX
condition|)
name|pci_release_msi
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
end_ifndef

begin_function
specifier|static
name|int
name|vmxnet3_alloc_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|sc
operator|->
name|vmx_tq
operator|=
name|taskqueue_create
argument_list|(
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|sc
operator|->
name|vmx_tq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_tq
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_start_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|nthreads
decl_stmt|,
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
comment|/* 	 * The taskqueue is typically not frequently used, so a dedicated 	 * thread for each queue is unnecessary. 	 */
name|nthreads
operator|=
name|MAX
argument_list|(
literal|1
argument_list|,
name|sc
operator|->
name|vmx_ntxqueues
operator|/
literal|2
argument_list|)
expr_stmt|;
comment|/* 	 * Most drivers just ignore the return value - it only fails 	 * with ENOMEM so an error is not likely. It is hard for us 	 * to recover from an error here. 	 */
name|error
operator|=
name|taskqueue_start_threads
argument_list|(
operator|&
name|sc
operator|->
name|vmx_tq
argument_list|,
name|nthreads
argument_list|,
name|PI_NET
argument_list|,
literal|"%s taskq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to start taskqueue: %d"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_drain_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_tq
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_max_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|vmx_tq
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_defrtask
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_taskqueue
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|vmx_tq
operator|!=
name|NULL
condition|)
block|{
name|taskqueue_free
argument_list|(
name|sc
operator|->
name|vmx_tq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_tq
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|vmxnet3_init_rxq
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|int
name|q
parameter_list|)
block|{
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|q
index|]
expr_stmt|;
name|snprintf
argument_list|(
name|rxq
operator|->
name|vxrxq_name
argument_list|,
sizeof|sizeof
argument_list|(
name|rxq
operator|->
name|vxrxq_name
argument_list|)
argument_list|,
literal|"%s-rx%d"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|)
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|rxq
operator|->
name|vxrxq_mtx
argument_list|,
name|rxq
operator|->
name|vxrxq_name
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|vxrxq_sc
operator|=
name|sc
expr_stmt|;
name|rxq
operator|->
name|vxrxq_id
operator|=
name|q
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
name|rxr
operator|->
name|vxrxr_rid
operator|=
name|i
expr_stmt|;
name|rxr
operator|->
name|vxrxr_ndesc
operator|=
name|sc
operator|->
name|vmx_nrxdescs
expr_stmt|;
name|rxr
operator|->
name|vxrxr_rxbuf
operator|=
name|malloc
argument_list|(
name|rxr
operator|->
name|vxrxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxbuf
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxr
operator|->
name|vxrxr_rxbuf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|rxq
operator|->
name|vxrxq_comp_ring
operator|.
name|vxcr_ndesc
operator|+=
name|sc
operator|->
name|vmx_nrxdescs
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_init_txq
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|int
name|q
parameter_list|)
block|{
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|q
index|]
expr_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|snprintf
argument_list|(
name|txq
operator|->
name|vxtxq_name
argument_list|,
sizeof|sizeof
argument_list|(
name|txq
operator|->
name|vxtxq_name
argument_list|)
argument_list|,
literal|"%s-tx%d"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|)
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|txq
operator|->
name|vxtxq_mtx
argument_list|,
name|txq
operator|->
name|vxtxq_name
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|txq
operator|->
name|vxtxq_sc
operator|=
name|sc
expr_stmt|;
name|txq
operator|->
name|vxtxq_id
operator|=
name|q
expr_stmt|;
name|txr
operator|->
name|vxtxr_ndesc
operator|=
name|sc
operator|->
name|vmx_ntxdescs
expr_stmt|;
name|txr
operator|->
name|vxtxr_txbuf
operator|=
name|malloc
argument_list|(
name|txr
operator|->
name|vxtxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txbuf
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|txr
operator|->
name|vxtxr_txbuf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|txq
operator|->
name|vxtxq_comp_ring
operator|.
name|vxcr_ndesc
operator|=
name|sc
operator|->
name|vmx_ntxdescs
expr_stmt|;
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
name|TASK_INIT
argument_list|(
operator|&
name|txq
operator|->
name|vxtxq_defrtask
argument_list|,
literal|0
argument_list|,
name|vmxnet3_txq_tq_deferred
argument_list|,
name|txq
argument_list|)
expr_stmt|;
name|txq
operator|->
name|vxtxq_br
operator|=
name|buf_ring_alloc
argument_list|(
name|VMXNET3_DEF_BUFRING_SIZE
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|txq
operator|->
name|vxtxq_br
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_rxtx_queues
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
comment|/* 	 * Only attempt to create multiple queues if MSIX is available. MSIX is 	 * disabled by default because its apparently broken for devices passed 	 * through by at least ESXi 5.1. The hw.pci.honor_msi_blacklist tunable 	 * must be set to zero for MSIX. This check prevents us from allocating 	 * queue structures that we will not use. 	 */
if|if
condition|(
name|sc
operator|->
name|vmx_flags
operator|&
name|VMXNET3_FLAG_NO_MSIX
condition|)
block|{
name|sc
operator|->
name|vmx_max_nrxqueues
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|vmx_max_ntxqueues
operator|=
literal|1
expr_stmt|;
block|}
name|sc
operator|->
name|vmx_rxq
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxqueue
argument_list|)
operator|*
name|sc
operator|->
name|vmx_max_nrxqueues
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_txq
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txqueue
argument_list|)
operator|*
name|sc
operator|->
name|vmx_max_ntxqueues
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_rxq
operator|==
name|NULL
operator|||
name|sc
operator|->
name|vmx_txq
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_max_nrxqueues
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|vmxnet3_init_rxq
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_max_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|vmxnet3_init_txq
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_destroy_rxq
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rxq
operator|->
name|vxrxq_sc
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|vxrxq_id
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rxr
operator|->
name|vxrxr_rxbuf
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|rxr
operator|->
name|vxrxr_rxbuf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|rxr
operator|->
name|vxrxr_rxbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mtx_initialized
argument_list|(
operator|&
name|rxq
operator|->
name|vxrxq_mtx
argument_list|)
operator|!=
literal|0
condition|)
name|mtx_destroy
argument_list|(
operator|&
name|rxq
operator|->
name|vxrxq_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_destroy_txq
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|)
block|{
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|txq
operator|->
name|vxtxq_sc
operator|=
name|NULL
expr_stmt|;
name|txq
operator|->
name|vxtxq_id
operator|=
operator|-
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
if|if
condition|(
name|txq
operator|->
name|vxtxq_br
operator|!=
name|NULL
condition|)
block|{
name|buf_ring_free
argument_list|(
name|txq
operator|->
name|vxtxq_br
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|txq
operator|->
name|vxtxq_br
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|txr
operator|->
name|vxtxr_txbuf
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|txr
operator|->
name|vxtxr_txbuf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|txr
operator|->
name|vxtxr_txbuf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|mtx_initialized
argument_list|(
operator|&
name|txq
operator|->
name|vxtxq_mtx
argument_list|)
operator|!=
literal|0
condition|)
name|mtx_destroy
argument_list|(
operator|&
name|txq
operator|->
name|vxtxq_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_rxtx_queues
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_rxq
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_max_nrxqueues
condition|;
name|i
operator|++
control|)
name|vmxnet3_destroy_rxq
argument_list|(
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
operator|->
name|vmx_rxq
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_rxq
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_txq
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_max_ntxqueues
condition|;
name|i
operator|++
control|)
name|vmxnet3_destroy_txq
argument_list|(
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
operator|->
name|vmx_txq
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_txq
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|uint8_t
modifier|*
name|kva
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_driver_shared
argument_list|)
expr_stmt|;
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|size
argument_list|,
literal|1
argument_list|,
operator|&
name|sc
operator|->
name|vmx_ds_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot alloc shared memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sc
operator|->
name|vmx_ds
operator|=
operator|(
expr|struct
name|vmxnet3_driver_shared
operator|*
operator|)
name|sc
operator|->
name|vmx_ds_dma
operator|.
name|dma_vaddr
expr_stmt|;
name|size
operator|=
name|sc
operator|->
name|vmx_ntxqueues
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txq_shared
argument_list|)
operator|+
name|sc
operator|->
name|vmx_nrxqueues
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxq_shared
argument_list|)
expr_stmt|;
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|size
argument_list|,
literal|128
argument_list|,
operator|&
name|sc
operator|->
name|vmx_qs_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot alloc queue shared memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sc
operator|->
name|vmx_qs
operator|=
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|vmx_qs_dma
operator|.
name|dma_vaddr
expr_stmt|;
name|kva
operator|=
name|sc
operator|->
name|vmx_qs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
operator|.
name|vxtxq_ts
operator|=
operator|(
expr|struct
name|vmxnet3_txq_shared
operator|*
operator|)
name|kva
expr_stmt|;
name|kva
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txq_shared
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
operator|.
name|vxrxq_rs
operator|=
operator|(
expr|struct
name|vmxnet3_rxq_shared
operator|*
operator|)
name|kva
expr_stmt|;
name|kva
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxq_shared
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_flags
operator|&
name|VMXNET3_FLAG_RSS
condition|)
block|{
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rss_shared
argument_list|)
expr_stmt|;
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|size
argument_list|,
literal|128
argument_list|,
operator|&
name|sc
operator|->
name|vmx_rss_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot alloc rss shared memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|sc
operator|->
name|vmx_rss
operator|=
operator|(
expr|struct
name|vmxnet3_rss_shared
operator|*
operator|)
name|sc
operator|->
name|vmx_rss_dma
operator|.
name|dma_vaddr
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|vmx_rss
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_rss_dma
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_rss
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_qs
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_qs_dma
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_qs
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_ds
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_ds_dma
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_ds
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_txq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|txc
decl_stmt|;
name|size_t
name|descsz
decl_stmt|,
name|compsz
decl_stmt|;
name|int
name|i
decl_stmt|,
name|q
decl_stmt|,
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|q
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|q
index|]
expr_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|txc
operator|=
operator|&
name|txq
operator|->
name|vxtxq_comp_ring
expr_stmt|;
name|descsz
operator|=
name|txr
operator|->
name|vxtxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txdesc
argument_list|)
expr_stmt|;
name|compsz
operator|=
name|txr
operator|->
name|vxtxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txcompdesc
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|VMXNET3_TX_MAXSIZE
argument_list|,
comment|/* maxsize */
name|VMXNET3_TX_MAXSEGS
argument_list|,
comment|/* nsegments */
name|VMXNET3_TX_MAXSEGSIZE
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|txr
operator|->
name|vxtxr_txtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create Tx buffer tag for queue %d\n"
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|descsz
argument_list|,
literal|512
argument_list|,
operator|&
name|txr
operator|->
name|vxtxr_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot alloc Tx descriptors for "
literal|"queue %d error %d\n"
argument_list|,
name|q
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|txr
operator|->
name|vxtxr_txd
operator|=
operator|(
expr|struct
name|vmxnet3_txdesc
operator|*
operator|)
name|txr
operator|->
name|vxtxr_dma
operator|.
name|dma_vaddr
expr_stmt|;
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|compsz
argument_list|,
literal|512
argument_list|,
operator|&
name|txc
operator|->
name|vxcr_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot alloc Tx comp descriptors "
literal|"for queue %d error %d\n"
argument_list|,
name|q
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|txc
operator|->
name|vxcr_u
operator|.
name|txcd
operator|=
operator|(
expr|struct
name|vmxnet3_txcompdesc
operator|*
operator|)
name|txc
operator|->
name|vxcr_dma
operator|.
name|dma_vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|txr
operator|->
name|vxtxr_ndesc
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|,
literal|0
argument_list|,
operator|&
name|txr
operator|->
name|vxtxr_txbuf
index|[
name|i
index|]
operator|.
name|vtxb_dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create Tx buf "
literal|"dmamap for queue %d idx %d\n"
argument_list|,
name|q
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_txq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|txc
decl_stmt|;
name|struct
name|vmxnet3_txbuf
modifier|*
name|txb
decl_stmt|;
name|int
name|i
decl_stmt|,
name|q
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|q
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|q
index|]
expr_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|txc
operator|=
operator|&
name|txq
operator|->
name|vxtxq_comp_ring
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|txr
operator|->
name|vxtxr_ndesc
condition|;
name|i
operator|++
control|)
block|{
name|txb
operator|=
operator|&
name|txr
operator|->
name|vxtxr_txbuf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|txb
operator|->
name|vtxb_dmamap
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|,
name|txb
operator|->
name|vtxb_dmamap
argument_list|)
expr_stmt|;
name|txb
operator|->
name|vtxb_dmamap
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|txc
operator|->
name|vxcr_u
operator|.
name|txcd
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|txc
operator|->
name|vxcr_dma
argument_list|)
expr_stmt|;
name|txc
operator|->
name|vxcr_u
operator|.
name|txcd
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|txr
operator|->
name|vxtxr_txd
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|txr
operator|->
name|vxtxr_dma
argument_list|)
expr_stmt|;
name|txr
operator|->
name|vxtxr_txd
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|txr
operator|->
name|vxtxr_txtag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|)
expr_stmt|;
name|txr
operator|->
name|vxtxr_txtag
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_rxq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|rxc
decl_stmt|;
name|int
name|descsz
decl_stmt|,
name|compsz
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|q
decl_stmt|,
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|q
operator|++
control|)
block|{
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|q
index|]
expr_stmt|;
name|rxc
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
expr_stmt|;
name|compsz
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
name|descsz
operator|=
name|rxr
operator|->
name|vxrxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxdesc
argument_list|)
expr_stmt|;
name|compsz
operator|+=
name|rxr
operator|->
name|vxrxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxcompdesc
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MJUMPAGESIZE
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|MJUMPAGESIZE
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create Rx buffer tag for "
literal|"queue %d\n"
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|descsz
argument_list|,
literal|512
argument_list|,
operator|&
name|rxr
operator|->
name|vxrxr_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate Rx "
literal|"descriptors for queue %d/%d error %d\n"
argument_list|,
name|i
argument_list|,
name|q
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|rxr
operator|->
name|vxrxr_rxd
operator|=
operator|(
expr|struct
name|vmxnet3_rxdesc
operator|*
operator|)
name|rxr
operator|->
name|vxrxr_dma
operator|.
name|dma_vaddr
expr_stmt|;
block|}
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|compsz
argument_list|,
literal|512
argument_list|,
operator|&
name|rxc
operator|->
name|vxcr_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot alloc Rx comp descriptors "
literal|"for queue %d error %d\n"
argument_list|,
name|q
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|rxc
operator|->
name|vxcr_u
operator|.
name|rxcd
operator|=
operator|(
expr|struct
name|vmxnet3_rxcompdesc
operator|*
operator|)
name|rxc
operator|->
name|vxcr_dma
operator|.
name|dma_vaddr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|,
literal|0
argument_list|,
operator|&
name|rxr
operator|->
name|vxrxr_spare_dmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create spare "
literal|"dmamap for queue %d/%d error %d\n"
argument_list|,
name|q
argument_list|,
name|i
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|rxr
operator|->
name|vxrxr_ndesc
condition|;
name|j
operator|++
control|)
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|,
literal|0
argument_list|,
operator|&
name|rxr
operator|->
name|vxrxr_rxbuf
index|[
name|j
index|]
operator|.
name|vrxb_dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create "
literal|"dmamap for queue %d/%d slot %d "
literal|"error %d\n"
argument_list|,
name|q
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_rxq_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|rxc
decl_stmt|;
name|struct
name|vmxnet3_rxbuf
modifier|*
name|rxb
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|q
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|q
operator|++
control|)
block|{
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|q
index|]
expr_stmt|;
name|rxc
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rxr
operator|->
name|vxrxr_spare_dmap
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|,
name|rxr
operator|->
name|vxrxr_spare_dmap
argument_list|)
expr_stmt|;
name|rxr
operator|->
name|vxrxr_spare_dmap
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|rxr
operator|->
name|vxrxr_ndesc
condition|;
name|j
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|rxr
operator|->
name|vxrxr_rxbuf
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|rxb
operator|->
name|vrxb_dmamap
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|,
name|rxb
operator|->
name|vrxb_dmamap
argument_list|)
expr_stmt|;
name|rxb
operator|->
name|vrxb_dmamap
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|rxc
operator|->
name|vxcr_u
operator|.
name|rxcd
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|rxc
operator|->
name|vxcr_dma
argument_list|)
expr_stmt|;
name|rxc
operator|->
name|vxcr_u
operator|.
name|rxcd
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rxr
operator|->
name|vxrxr_rxd
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|rxr
operator|->
name|vxrxr_dma
argument_list|)
expr_stmt|;
name|rxr
operator|->
name|vxrxr_rxd
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|rxr
operator|->
name|vxrxr_rxtag
operator|!=
name|NULL
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|)
expr_stmt|;
name|rxr
operator|->
name|vxrxr_rxtag
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_queue_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|vmxnet3_alloc_txq_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|vmxnet3_alloc_rxq_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_queue_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|vmx_rxq
operator|!=
name|NULL
condition|)
name|vmxnet3_free_rxq_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_txq
operator|!=
name|NULL
condition|)
name|vmxnet3_free_txq_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_mcast_table
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|vmxnet3_dma_malloc
argument_list|(
name|sc
argument_list|,
name|VMXNET3_MULTICAST_MAX
operator|*
name|ETHER_ADDR_LEN
argument_list|,
literal|32
argument_list|,
operator|&
name|sc
operator|->
name|vmx_mcast_dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|,
literal|"unable to alloc multicast table\n"
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|vmx_mcast
operator|=
name|sc
operator|->
name|vmx_mcast_dma
operator|.
name|dma_vaddr
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_mcast_table
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|vmx_mcast
operator|!=
name|NULL
condition|)
block|{
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_mcast_dma
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_mcast
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_init_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmxnet3_driver_shared
modifier|*
name|ds
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|vmxnet3_txq_shared
modifier|*
name|txs
decl_stmt|;
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_rxq_shared
modifier|*
name|rxs
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ds
operator|=
name|sc
operator|->
name|vmx_ds
expr_stmt|;
comment|/* 	 * Initialize fields of the shared data that remains the same across 	 * reinits. Note the shared data is zero'd when allocated. 	 */
name|ds
operator|->
name|magic
operator|=
name|VMXNET3_REV1_MAGIC
expr_stmt|;
comment|/* DriverInfo */
name|ds
operator|->
name|version
operator|=
name|VMXNET3_DRIVER_VERSION
expr_stmt|;
name|ds
operator|->
name|guest
operator|=
name|VMXNET3_GOS_FREEBSD
operator||
ifdef|#
directive|ifdef
name|__LP64__
name|VMXNET3_GOS_64BIT
expr_stmt|;
else|#
directive|else
name|VMXNET3_GOS_32BIT
expr_stmt|;
endif|#
directive|endif
name|ds
operator|->
name|vmxnet3_revision
operator|=
literal|1
expr_stmt|;
name|ds
operator|->
name|upt_version
operator|=
literal|1
expr_stmt|;
comment|/* Misc. conf */
name|ds
operator|->
name|driver_data
operator|=
name|vtophys
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ds
operator|->
name|driver_data_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_softc
argument_list|)
expr_stmt|;
name|ds
operator|->
name|queue_shared
operator|=
name|sc
operator|->
name|vmx_qs_dma
operator|.
name|dma_paddr
expr_stmt|;
name|ds
operator|->
name|queue_shared_len
operator|=
name|sc
operator|->
name|vmx_qs_dma
operator|.
name|dma_size
expr_stmt|;
name|ds
operator|->
name|nrxsg_max
operator|=
name|sc
operator|->
name|vmx_max_rxsegs
expr_stmt|;
comment|/* RSS conf */
if|if
condition|(
name|sc
operator|->
name|vmx_flags
operator|&
name|VMXNET3_FLAG_RSS
condition|)
block|{
name|ds
operator|->
name|rss
operator|.
name|version
operator|=
literal|1
expr_stmt|;
name|ds
operator|->
name|rss
operator|.
name|paddr
operator|=
name|sc
operator|->
name|vmx_rss_dma
operator|.
name|dma_paddr
expr_stmt|;
name|ds
operator|->
name|rss
operator|.
name|len
operator|=
name|sc
operator|->
name|vmx_rss_dma
operator|.
name|dma_size
expr_stmt|;
block|}
comment|/* Interrupt control. */
name|ds
operator|->
name|automask
operator|=
name|sc
operator|->
name|vmx_intr_mask_mode
operator|==
name|VMXNET3_IMM_AUTO
expr_stmt|;
name|ds
operator|->
name|nintr
operator|=
name|sc
operator|->
name|vmx_nintrs
expr_stmt|;
name|ds
operator|->
name|evintr
operator|=
name|sc
operator|->
name|vmx_event_intr_idx
expr_stmt|;
name|ds
operator|->
name|ictrl
operator|=
name|VMXNET3_ICTRL_DISABLE_ALL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nintrs
condition|;
name|i
operator|++
control|)
name|ds
operator|->
name|modlevel
index|[
name|i
index|]
operator|=
name|UPT1_IMOD_ADAPTIVE
expr_stmt|;
comment|/* Receive filter. */
name|ds
operator|->
name|mcast_table
operator|=
name|sc
operator|->
name|vmx_mcast_dma
operator|.
name|dma_paddr
expr_stmt|;
name|ds
operator|->
name|mcast_tablelen
operator|=
name|sc
operator|->
name|vmx_mcast_dma
operator|.
name|dma_size
expr_stmt|;
comment|/* Tx queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
name|txs
operator|=
name|txq
operator|->
name|vxtxq_ts
expr_stmt|;
name|txs
operator|->
name|cmd_ring
operator|=
name|txq
operator|->
name|vxtxq_cmd_ring
operator|.
name|vxtxr_dma
operator|.
name|dma_paddr
expr_stmt|;
name|txs
operator|->
name|cmd_ring_len
operator|=
name|txq
operator|->
name|vxtxq_cmd_ring
operator|.
name|vxtxr_ndesc
expr_stmt|;
name|txs
operator|->
name|comp_ring
operator|=
name|txq
operator|->
name|vxtxq_comp_ring
operator|.
name|vxcr_dma
operator|.
name|dma_paddr
expr_stmt|;
name|txs
operator|->
name|comp_ring_len
operator|=
name|txq
operator|->
name|vxtxq_comp_ring
operator|.
name|vxcr_ndesc
expr_stmt|;
name|txs
operator|->
name|driver_data
operator|=
name|vtophys
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|txs
operator|->
name|driver_data_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txqueue
argument_list|)
expr_stmt|;
block|}
comment|/* Rx queues */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
block|{
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
expr_stmt|;
name|rxs
operator|=
name|rxq
operator|->
name|vxrxq_rs
expr_stmt|;
name|rxs
operator|->
name|cmd_ring
index|[
literal|0
index|]
operator|=
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
operator|.
name|vxrxr_dma
operator|.
name|dma_paddr
expr_stmt|;
name|rxs
operator|->
name|cmd_ring_len
index|[
literal|0
index|]
operator|=
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
operator|.
name|vxrxr_ndesc
expr_stmt|;
name|rxs
operator|->
name|cmd_ring
index|[
literal|1
index|]
operator|=
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|1
index|]
operator|.
name|vxrxr_dma
operator|.
name|dma_paddr
expr_stmt|;
name|rxs
operator|->
name|cmd_ring_len
index|[
literal|1
index|]
operator|=
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|1
index|]
operator|.
name|vxrxr_ndesc
expr_stmt|;
name|rxs
operator|->
name|comp_ring
operator|=
name|rxq
operator|->
name|vxrxq_comp_ring
operator|.
name|vxcr_dma
operator|.
name|dma_paddr
expr_stmt|;
name|rxs
operator|->
name|comp_ring_len
operator|=
name|rxq
operator|->
name|vxrxq_comp_ring
operator|.
name|vxcr_ndesc
expr_stmt|;
name|rxs
operator|->
name|driver_data
operator|=
name|vtophys
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|driver_data_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxqueue
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_init_hwassist
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|vmx_ifp
decl_stmt|;
name|uint64_t
name|hwassist
decl_stmt|;
name|hwassist
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
condition|)
name|hwassist
operator||=
name|VMXNET3_CSUM_OFFLOAD
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM_IPV6
condition|)
name|hwassist
operator||=
name|VMXNET3_CSUM_OFFLOAD_IPV6
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO4
condition|)
name|hwassist
operator||=
name|CSUM_IP_TSO
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO6
condition|)
name|hwassist
operator||=
name|CSUM_IP6_TSO
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
name|hwassist
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_reinit_interface
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
comment|/* Use the current MAC address. */
name|bcopy
argument_list|(
name|IF_LLADDR
argument_list|(
name|sc
operator|->
name|vmx_ifp
argument_list|)
argument_list|,
name|sc
operator|->
name|vmx_lladdr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|vmxnet3_set_lladdr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_init_hwassist
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_reinit_rss_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	 * Use the same key as the Linux driver until FreeBSD can do 	 * RSS (presumably Toeplitz) in software. 	 */
specifier|static
specifier|const
name|uint8_t
name|rss_key
index|[
name|UPT1_RSS_MAX_KEY_SIZE
index|]
init|=
block|{
literal|0x3b
block|,
literal|0x56
block|,
literal|0xd1
block|,
literal|0x56
block|,
literal|0x13
block|,
literal|0x4a
block|,
literal|0xe7
block|,
literal|0xac
block|,
literal|0xe8
block|,
literal|0x79
block|,
literal|0x09
block|,
literal|0x75
block|,
literal|0xe8
block|,
literal|0x65
block|,
literal|0x79
block|,
literal|0x28
block|,
literal|0x35
block|,
literal|0x12
block|,
literal|0xb9
block|,
literal|0x56
block|,
literal|0x7c
block|,
literal|0x76
block|,
literal|0x4b
block|,
literal|0x70
block|,
literal|0xd8
block|,
literal|0x56
block|,
literal|0xa3
block|,
literal|0x18
block|,
literal|0x9b
block|,
literal|0x0a
block|,
literal|0xee
block|,
literal|0xf3
block|,
literal|0x96
block|,
literal|0xa6
block|,
literal|0x9f
block|,
literal|0x8f
block|,
literal|0x9e
block|,
literal|0x8c
block|,
literal|0x90
block|,
literal|0xc9
block|, 	}
decl_stmt|;
name|struct
name|vmxnet3_driver_shared
modifier|*
name|ds
decl_stmt|;
name|struct
name|vmxnet3_rss_shared
modifier|*
name|rss
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ds
operator|=
name|sc
operator|->
name|vmx_ds
expr_stmt|;
name|rss
operator|=
name|sc
operator|->
name|vmx_rss
expr_stmt|;
name|rss
operator|->
name|hash_type
operator|=
name|UPT1_RSS_HASH_TYPE_IPV4
operator||
name|UPT1_RSS_HASH_TYPE_TCP_IPV4
operator||
name|UPT1_RSS_HASH_TYPE_IPV6
operator||
name|UPT1_RSS_HASH_TYPE_TCP_IPV6
expr_stmt|;
name|rss
operator|->
name|hash_func
operator|=
name|UPT1_RSS_HASH_FUNC_TOEPLITZ
expr_stmt|;
name|rss
operator|->
name|hash_key_size
operator|=
name|UPT1_RSS_MAX_KEY_SIZE
expr_stmt|;
name|rss
operator|->
name|ind_table_size
operator|=
name|UPT1_RSS_MAX_IND_TABLE_SIZE
expr_stmt|;
name|memcpy
argument_list|(
name|rss
operator|->
name|hash_key
argument_list|,
name|rss_key
argument_list|,
name|UPT1_RSS_MAX_KEY_SIZE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|UPT1_RSS_MAX_IND_TABLE_SIZE
condition|;
name|i
operator|++
control|)
name|rss
operator|->
name|ind_table
index|[
name|i
index|]
operator|=
name|i
operator|%
name|sc
operator|->
name|vmx_nrxqueues
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_reinit_shared_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vmxnet3_driver_shared
modifier|*
name|ds
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|ds
operator|=
name|sc
operator|->
name|vmx_ds
expr_stmt|;
name|ds
operator|->
name|mtu
operator|=
name|ifp
operator|->
name|if_mtu
expr_stmt|;
name|ds
operator|->
name|ntxqueue
operator|=
name|sc
operator|->
name|vmx_ntxqueues
expr_stmt|;
name|ds
operator|->
name|nrxqueue
operator|=
name|sc
operator|->
name|vmx_nrxqueues
expr_stmt|;
name|ds
operator|->
name|upt_features
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
operator|(
name|IFCAP_RXCSUM
operator||
name|IFCAP_RXCSUM_IPV6
operator|)
condition|)
name|ds
operator|->
name|upt_features
operator||=
name|UPT1_F_CSUM
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|ds
operator|->
name|upt_features
operator||=
name|UPT1_F_VLAN
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
condition|)
name|ds
operator|->
name|upt_features
operator||=
name|UPT1_F_LRO
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_flags
operator|&
name|VMXNET3_FLAG_RSS
condition|)
block|{
name|ds
operator|->
name|upt_features
operator||=
name|UPT1_F_RSS
expr_stmt|;
name|vmxnet3_reinit_rss_shared_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_DSL
argument_list|,
name|sc
operator|->
name|vmx_ds_dma
operator|.
name|dma_paddr
argument_list|)
expr_stmt|;
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_DSH
argument_list|,
operator|(
name|uint64_t
operator|)
name|sc
operator|->
name|vmx_ds_dma
operator|.
name|dma_paddr
operator|>>
literal|32
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_alloc_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|vmxnet3_alloc_shared_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|vmxnet3_alloc_queue_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|vmxnet3_alloc_mcast_table
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|vmxnet3_init_shared_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_free_data
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|vmxnet3_free_mcast_table
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_free_queue_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_free_shared_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_setup_interface
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate ifnet structure\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOSPC
operator|)
return|;
block|}
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|1000025
name|ifp
operator|->
name|if_baudrate
operator|=
literal|1000000000
expr_stmt|;
elif|#
directive|elif
name|__FreeBSD_version
operator|<
literal|1100011
name|if_initbaudrate
argument_list|(
name|ifp
argument_list|,
name|IF_Gbps
argument_list|(
literal|10
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|ifp
operator|->
name|if_baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|vmxnet3_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|vmxnet3_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_hw_tsomax
operator|=
literal|65536
operator|-
operator|(
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
operator|)
expr_stmt|;
name|ifp
operator|->
name|if_hw_tsomaxsegcount
operator|=
name|VMXNET3_TX_MAXSEGS
expr_stmt|;
name|ifp
operator|->
name|if_hw_tsomaxsegsize
operator|=
name|VMXNET3_TX_MAXSEGSIZE
expr_stmt|;
ifdef|#
directive|ifdef
name|VMXNET3_LEGACY_TX
name|ifp
operator|->
name|if_start
operator|=
name|vmxnet3_start
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|sc
operator|->
name|vmx_ntxdescs
operator|-
literal|1
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|sc
operator|->
name|vmx_ntxdescs
operator|-
literal|1
argument_list|)
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
else|#
directive|else
name|ifp
operator|->
name|if_transmit
operator|=
name|vmxnet3_txq_mq_start
expr_stmt|;
name|ifp
operator|->
name|if_qflush
operator|=
name|vmxnet3_qflush
expr_stmt|;
endif|#
directive|endif
name|vmxnet3_get_lladdr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|vmx_lladdr
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_RXCSUM
operator||
name|IFCAP_TXCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_RXCSUM_IPV6
operator||
name|IFCAP_TXCSUM_IPV6
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO4
operator||
name|IFCAP_TSO6
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_MTU
operator||
name|IFCAP_VLAN_HWTAGGING
operator||
name|IFCAP_VLAN_HWCSUM
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
comment|/* These capabilities are not enabled by default. */
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_LRO
operator||
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
name|sc
operator|->
name|vmx_vlan_attach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_config
argument_list|,
name|vmxnet3_register_vlan
argument_list|,
name|sc
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_vlan_detach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_config
argument_list|,
name|vmxnet3_unregister_vlan
argument_list|,
name|sc
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|vmx_media
argument_list|,
literal|0
argument_list|,
name|vmxnet3_media_change
argument_list|,
name|vmxnet3_media_status
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|vmx_media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|vmx_media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_evintr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vmxnet3_txq_shared
modifier|*
name|ts
decl_stmt|;
name|struct
name|vmxnet3_rxq_shared
modifier|*
name|rs
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|int
name|reset
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|reset
operator|=
literal|0
expr_stmt|;
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Clear events. */
name|event
operator|=
name|sc
operator|->
name|vmx_ds
operator|->
name|event
expr_stmt|;
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_EVENT
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|VMXNET3_EVENT_LINK
condition|)
block|{
name|vmxnet3_link_status
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_link_active
operator|!=
literal|0
condition|)
name|vmxnet3_tx_start_all
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|event
operator|&
operator|(
name|VMXNET3_EVENT_TQERROR
operator||
name|VMXNET3_EVENT_RQERROR
operator|)
condition|)
block|{
name|reset
operator|=
literal|1
expr_stmt|;
name|vmxnet3_read_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_GET_STATUS
argument_list|)
expr_stmt|;
name|ts
operator|=
name|sc
operator|->
name|vmx_txq
index|[
literal|0
index|]
operator|.
name|vxtxq_ts
expr_stmt|;
if|if
condition|(
name|ts
operator|->
name|stopped
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Tx queue error %#x\n"
argument_list|,
name|ts
operator|->
name|error
argument_list|)
expr_stmt|;
name|rs
operator|=
name|sc
operator|->
name|vmx_rxq
index|[
literal|0
index|]
operator|.
name|vxrxq_rs
expr_stmt|;
if|if
condition|(
name|rs
operator|->
name|stopped
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Rx queue error %#x\n"
argument_list|,
name|rs
operator|->
name|error
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Rx/Tx queue error event ... resetting\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|event
operator|&
name|VMXNET3_EVENT_DIC
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"device implementation change event\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|VMXNET3_EVENT_DEBUG
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"debug event\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|reset
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|vmxnet3_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_txq_eof
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|txc
decl_stmt|;
name|struct
name|vmxnet3_txcompdesc
modifier|*
name|txcd
decl_stmt|;
name|struct
name|vmxnet3_txbuf
modifier|*
name|txb
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|u_int
name|sop
decl_stmt|;
name|sc
operator|=
name|txq
operator|->
name|vxtxq_sc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|txc
operator|=
operator|&
name|txq
operator|->
name|vxtxq_comp_ring
expr_stmt|;
name|VMXNET3_TXQ_LOCK_ASSERT
argument_list|(
name|txq
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|txcd
operator|=
operator|&
name|txc
operator|->
name|vxcr_u
operator|.
name|txcd
index|[
name|txc
operator|->
name|vxcr_next
index|]
expr_stmt|;
if|if
condition|(
name|txcd
operator|->
name|gen
operator|!=
name|txc
operator|->
name|vxcr_gen
condition|)
break|break;
name|vmxnet3_barrier
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BARRIER_RD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|txc
operator|->
name|vxcr_next
operator|==
name|txc
operator|->
name|vxcr_ndesc
condition|)
block|{
name|txc
operator|->
name|vxcr_next
operator|=
literal|0
expr_stmt|;
name|txc
operator|->
name|vxcr_gen
operator|^=
literal|1
expr_stmt|;
block|}
name|sop
operator|=
name|txr
operator|->
name|vxtxr_next
expr_stmt|;
name|txb
operator|=
operator|&
name|txr
operator|->
name|vxtxr_txbuf
index|[
name|sop
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|m
operator|=
name|txb
operator|->
name|vtxb_m
operator|)
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|,
name|txb
operator|->
name|vtxb_dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|,
name|txb
operator|->
name|vtxb_dmamap
argument_list|)
expr_stmt|;
name|txq
operator|->
name|vxtxq_stats
operator|.
name|vmtxs_opackets
operator|++
expr_stmt|;
name|txq
operator|->
name|vxtxq_stats
operator|.
name|vmtxs_obytes
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_MCAST
condition|)
name|txq
operator|->
name|vxtxq_stats
operator|.
name|vmtxs_omcasts
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|txb
operator|->
name|vtxb_m
operator|=
name|NULL
expr_stmt|;
block|}
name|txr
operator|->
name|vxtxr_next
operator|=
operator|(
name|txcd
operator|->
name|eop_idx
operator|+
literal|1
operator|)
operator|%
name|txr
operator|->
name|vxtxr_ndesc
expr_stmt|;
block|}
if|if
condition|(
name|txr
operator|->
name|vxtxr_head
operator|==
name|txr
operator|->
name|vxtxr_next
condition|)
name|txq
operator|->
name|vxtxq_watchdog
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_newbuf
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|vmxnet3_rxdesc
modifier|*
name|rxd
decl_stmt|;
name|struct
name|vmxnet3_rxbuf
modifier|*
name|rxb
decl_stmt|;
name|bus_dma_tag_t
name|tag
decl_stmt|;
name|bus_dmamap_t
name|dmap
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|clsize
decl_stmt|,
name|btype
decl_stmt|,
name|flags
decl_stmt|,
name|nsegs
decl_stmt|,
name|error
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|tag
operator|=
name|rxr
operator|->
name|vxrxr_rxtag
expr_stmt|;
name|dmap
operator|=
name|rxr
operator|->
name|vxrxr_spare_dmap
expr_stmt|;
name|idx
operator|=
name|rxr
operator|->
name|vxrxr_fill
expr_stmt|;
name|rxd
operator|=
operator|&
name|rxr
operator|->
name|vxrxr_rxd
index|[
name|idx
index|]
expr_stmt|;
name|rxb
operator|=
operator|&
name|rxr
operator|->
name|vxrxr_rxbuf
index|[
name|idx
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|VMXNET3_FAILPOINTS
name|KFAIL_POINT_CODE
argument_list|(
argument|VMXNET3_FP
argument_list|,
argument|newbuf
argument_list|,
argument|return ENOBUFS
argument_list|)
empty_stmt|;
if|if
condition|(
name|rxr
operator|->
name|vxrxr_rid
operator|!=
literal|0
condition|)
name|KFAIL_POINT_CODE
argument_list|(
argument|VMXNET3_FP
argument_list|,
argument|newbuf_body_only
argument_list|,
argument|return ENOBUFS
argument_list|)
empty_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rxr
operator|->
name|vxrxr_rid
operator|==
literal|0
operator|&&
operator|(
name|idx
operator|%
name|sc
operator|->
name|vmx_rx_max_chain
operator|)
operator|==
literal|0
condition|)
block|{
name|flags
operator|=
name|M_PKTHDR
expr_stmt|;
name|clsize
operator|=
name|MCLBYTES
expr_stmt|;
name|btype
operator|=
name|VMXNET3_BTYPE_HEAD
expr_stmt|;
block|}
else|else
block|{
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|902001
comment|/* 		 * These mbufs will never be used for the start of a frame. 		 * Roughly prior to branching releng/9.2, the load_mbuf_sg() 		 * required the mbuf to always be a packet header. Avoid 		 * unnecessary mbuf initialization in newer versions where 		 * that is not the case. 		 */
name|flags
operator|=
name|M_PKTHDR
expr_stmt|;
else|#
directive|else
name|flags
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|clsize
operator|=
name|MJUMPAGESIZE
expr_stmt|;
name|btype
operator|=
name|VMXNET3_BTYPE_BODY
expr_stmt|;
block|}
name|m
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|flags
argument_list|,
name|clsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|vmx_stats
operator|.
name|vmst_mgetcl_failed
operator|++
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
if|if
condition|(
name|btype
operator|==
name|VMXNET3_BTYPE_HEAD
condition|)
block|{
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|clsize
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|ETHER_ALIGN
argument_list|)
expr_stmt|;
block|}
else|else
name|m
operator|->
name|m_len
operator|=
name|clsize
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|tag
argument_list|,
name|dmap
argument_list|,
name|m
argument_list|,
operator|&
name|segs
index|[
literal|0
index|]
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_stats
operator|.
name|vmst_mbuf_load_failed
operator|++
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"%s: mbuf %p with too many segments %d"
operator|,
name|__func__
operator|,
name|m
operator|,
name|nsegs
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|902001
if|if
condition|(
name|btype
operator|==
name|VMXNET3_BTYPE_BODY
condition|)
name|m
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rxb
operator|->
name|vrxb_m
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|tag
argument_list|,
name|rxb
operator|->
name|vrxb_dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|tag
argument_list|,
name|rxb
operator|->
name|vrxb_dmamap
argument_list|)
expr_stmt|;
block|}
name|rxr
operator|->
name|vxrxr_spare_dmap
operator|=
name|rxb
operator|->
name|vrxb_dmamap
expr_stmt|;
name|rxb
operator|->
name|vrxb_dmamap
operator|=
name|dmap
expr_stmt|;
name|rxb
operator|->
name|vrxb_m
operator|=
name|m
expr_stmt|;
name|rxd
operator|->
name|addr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
name|rxd
operator|->
name|len
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
expr_stmt|;
name|rxd
operator|->
name|btype
operator|=
name|btype
expr_stmt|;
name|rxd
operator|->
name|gen
operator|=
name|rxr
operator|->
name|vxrxr_gen
expr_stmt|;
name|vmxnet3_rxr_increment_fill
argument_list|(
name|rxr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rxq_eof_discard
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|,
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|struct
name|vmxnet3_rxdesc
modifier|*
name|rxd
decl_stmt|;
name|rxd
operator|=
operator|&
name|rxr
operator|->
name|vxrxr_rxd
index|[
name|idx
index|]
expr_stmt|;
name|rxd
operator|->
name|gen
operator|=
name|rxr
operator|->
name|vxrxr_gen
expr_stmt|;
name|vmxnet3_rxr_increment_fill
argument_list|(
name|rxr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rxq_discard_chain
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|rxc
decl_stmt|;
name|struct
name|vmxnet3_rxcompdesc
modifier|*
name|rxcd
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|eof
decl_stmt|;
name|sc
operator|=
name|rxq
operator|->
name|vxrxq_sc
expr_stmt|;
name|rxc
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
expr_stmt|;
do|do
block|{
name|rxcd
operator|=
operator|&
name|rxc
operator|->
name|vxcr_u
operator|.
name|rxcd
index|[
name|rxc
operator|->
name|vxcr_next
index|]
expr_stmt|;
if|if
condition|(
name|rxcd
operator|->
name|gen
operator|!=
name|rxc
operator|->
name|vxcr_gen
condition|)
break|break;
comment|/* Not expected. */
name|vmxnet3_barrier
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BARRIER_RD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|rxc
operator|->
name|vxcr_next
operator|==
name|rxc
operator|->
name|vxcr_ndesc
condition|)
block|{
name|rxc
operator|->
name|vxcr_next
operator|=
literal|0
expr_stmt|;
name|rxc
operator|->
name|vxcr_gen
operator|^=
literal|1
expr_stmt|;
block|}
name|idx
operator|=
name|rxcd
operator|->
name|rxd_idx
expr_stmt|;
name|eof
operator|=
name|rxcd
operator|->
name|eop
expr_stmt|;
if|if
condition|(
name|rxcd
operator|->
name|qid
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|)
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
expr_stmt|;
else|else
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|1
index|]
expr_stmt|;
name|vmxnet3_rxq_eof_discard
argument_list|(
name|rxq
argument_list|,
name|rxr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|eof
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rx_csum
parameter_list|(
name|struct
name|vmxnet3_rxcompdesc
modifier|*
name|rxcd
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
if|if
condition|(
name|rxcd
operator|->
name|ipv4
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
expr_stmt|;
if|if
condition|(
name|rxcd
operator|->
name|ipcsum_ok
condition|)
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_VALID
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rxcd
operator|->
name|fragment
condition|)
block|{
if|if
condition|(
name|rxcd
operator|->
name|csum_ok
operator|&&
operator|(
name|rxcd
operator|->
name|tcp
operator|||
name|rxcd
operator|->
name|udp
operator|)
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xFFFF
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rxq_input
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|,
name|struct
name|vmxnet3_rxcompdesc
modifier|*
name|rxcd
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|rxq
operator|->
name|vxrxq_sc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
if|if
condition|(
name|rxcd
operator|->
name|error
condition|)
block|{
name|rxq
operator|->
name|vxrxq_stats
operator|.
name|vmrxs_ierrors
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|notyet
switch|switch
condition|(
name|rxcd
operator|->
name|rss_type
condition|)
block|{
case|case
name|VMXNET3_RCD_RSS_TYPE_IPV4
case|:
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rxcd
operator|->
name|rss_hash
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_RSS_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
name|VMXNET3_RCD_RSS_TYPE_TCPIPV4
case|:
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rxcd
operator|->
name|rss_hash
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
name|VMXNET3_RCD_RSS_TYPE_IPV6
case|:
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rxcd
operator|->
name|rss_hash
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_RSS_IPV6
argument_list|)
expr_stmt|;
break|break;
case|case
name|VMXNET3_RCD_RSS_TYPE_TCPIPV6
case|:
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rxcd
operator|->
name|rss_hash
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV6
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* VMXNET3_RCD_RSS_TYPE_NONE */
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rxq
operator|->
name|vxrxq_id
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
break|break;
block|}
else|#
directive|else
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rxq
operator|->
name|vxrxq_id
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|m
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|rxcd
operator|->
name|no_csum
condition|)
name|vmxnet3_rx_csum
argument_list|(
name|rxcd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxcd
operator|->
name|vlan
condition|)
block|{
name|m
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|rxcd
operator|->
name|vtag
expr_stmt|;
block|}
name|rxq
operator|->
name|vxrxq_stats
operator|.
name|vmrxs_ipackets
operator|++
expr_stmt|;
name|rxq
operator|->
name|vxrxq_stats
operator|.
name|vmrxs_ibytes
operator|+=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|VMXNET3_RXQ_UNLOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|VMXNET3_RXQ_LOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rxq_eof
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|rxc
decl_stmt|;
name|struct
name|vmxnet3_rxdesc
modifier|*
name|rxd
decl_stmt|;
name|struct
name|vmxnet3_rxcompdesc
modifier|*
name|rxcd
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|m_head
decl_stmt|,
modifier|*
name|m_tail
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|length
decl_stmt|;
name|sc
operator|=
name|rxq
operator|->
name|vxrxq_sc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|rxc
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
expr_stmt|;
name|VMXNET3_RXQ_LOCK_ASSERT
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
return|return;
name|m_head
operator|=
name|rxq
operator|->
name|vxrxq_mhead
expr_stmt|;
name|rxq
operator|->
name|vxrxq_mhead
operator|=
name|NULL
expr_stmt|;
name|m_tail
operator|=
name|rxq
operator|->
name|vxrxq_mtail
expr_stmt|;
name|rxq
operator|->
name|vxrxq_mtail
operator|=
name|NULL
expr_stmt|;
name|MPASS
argument_list|(
name|m_head
operator|==
name|NULL
operator|||
name|m_tail
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|rxcd
operator|=
operator|&
name|rxc
operator|->
name|vxcr_u
operator|.
name|rxcd
index|[
name|rxc
operator|->
name|vxcr_next
index|]
expr_stmt|;
if|if
condition|(
name|rxcd
operator|->
name|gen
operator|!=
name|rxc
operator|->
name|vxcr_gen
condition|)
block|{
name|rxq
operator|->
name|vxrxq_mhead
operator|=
name|m_head
expr_stmt|;
name|rxq
operator|->
name|vxrxq_mtail
operator|=
name|m_tail
expr_stmt|;
break|break;
block|}
name|vmxnet3_barrier
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BARRIER_RD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|rxc
operator|->
name|vxcr_next
operator|==
name|rxc
operator|->
name|vxcr_ndesc
condition|)
block|{
name|rxc
operator|->
name|vxcr_next
operator|=
literal|0
expr_stmt|;
name|rxc
operator|->
name|vxcr_gen
operator|^=
literal|1
expr_stmt|;
block|}
name|idx
operator|=
name|rxcd
operator|->
name|rxd_idx
expr_stmt|;
name|length
operator|=
name|rxcd
operator|->
name|len
expr_stmt|;
if|if
condition|(
name|rxcd
operator|->
name|qid
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|)
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
expr_stmt|;
else|else
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|1
index|]
expr_stmt|;
name|rxd
operator|=
operator|&
name|rxr
operator|->
name|vxrxr_rxd
index|[
name|idx
index|]
expr_stmt|;
name|m
operator|=
name|rxr
operator|->
name|vxrxr_rxbuf
index|[
name|idx
index|]
operator|.
name|vrxb_m
expr_stmt|;
name|KASSERT
argument_list|(
name|m
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s: queue %d idx %d without mbuf"
operator|,
name|__func__
operator|,
name|rxcd
operator|->
name|qid
operator|,
name|idx
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * The host may skip descriptors. We detect this when this 		 * descriptor does not match the previous fill index. Catch 		 * up with the host now. 		 */
if|if
condition|(
name|__predict_false
argument_list|(
name|rxr
operator|->
name|vxrxr_fill
operator|!=
name|idx
argument_list|)
condition|)
block|{
while|while
condition|(
name|rxr
operator|->
name|vxrxr_fill
operator|!=
name|idx
condition|)
block|{
name|rxr
operator|->
name|vxrxr_rxd
index|[
name|rxr
operator|->
name|vxrxr_fill
index|]
operator|.
name|gen
operator|=
name|rxr
operator|->
name|vxrxr_gen
expr_stmt|;
name|vmxnet3_rxr_increment_fill
argument_list|(
name|rxr
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rxcd
operator|->
name|sop
condition|)
block|{
name|KASSERT
argument_list|(
name|rxd
operator|->
name|btype
operator|==
name|VMXNET3_BTYPE_HEAD
argument_list|,
operator|(
literal|"%s: start of frame w/o head buffer"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|rxr
operator|==
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
argument_list|,
operator|(
literal|"%s: start of frame not in ring 0"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|idx
operator|%
name|sc
operator|->
name|vmx_rx_max_chain
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"%s: start of frame at unexcepted index %d (%d)"
operator|,
name|__func__
operator|,
name|idx
operator|,
name|sc
operator|->
name|vmx_rx_max_chain
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|m_head
operator|==
name|NULL
argument_list|,
operator|(
literal|"%s: duplicate start of frame?"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|==
literal|0
condition|)
block|{
comment|/* Just ignore this descriptor. */
name|vmxnet3_rxq_eof_discard
argument_list|(
name|rxq
argument_list|,
name|rxr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
goto|goto
name|nextp
goto|;
block|}
if|if
condition|(
name|vmxnet3_newbuf
argument_list|(
name|sc
argument_list|,
name|rxr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|rxq
operator|->
name|vxrxq_stats
operator|.
name|vmrxs_iqdrops
operator|++
expr_stmt|;
name|vmxnet3_rxq_eof_discard
argument_list|(
name|rxq
argument_list|,
name|rxr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rxcd
operator|->
name|eop
condition|)
name|vmxnet3_rxq_discard_chain
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
goto|goto
name|nextp
goto|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|length
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
literal|0
expr_stmt|;
name|m_head
operator|=
name|m_tail
operator|=
name|m
expr_stmt|;
block|}
else|else
block|{
name|KASSERT
argument_list|(
name|rxd
operator|->
name|btype
operator|==
name|VMXNET3_BTYPE_BODY
argument_list|,
operator|(
literal|"%s: non start of frame w/o body buffer"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_head
operator|==
name|NULL
operator|&&
name|m_tail
operator|==
name|NULL
condition|)
block|{
comment|/* 				 * This is a continuation of a packet that we 				 * started to drop, but could not drop entirely 				 * because this segment was still owned by the 				 * host.  So, drop the remainder now. 				 */
name|vmxnet3_rxq_eof_discard
argument_list|(
name|rxq
argument_list|,
name|rxr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rxcd
operator|->
name|eop
condition|)
name|vmxnet3_rxq_discard_chain
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
goto|goto
name|nextp
goto|;
block|}
name|KASSERT
argument_list|(
name|m_head
operator|!=
name|NULL
argument_list|,
operator|(
literal|"%s: frame not started?"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vmxnet3_newbuf
argument_list|(
name|sc
argument_list|,
name|rxr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|rxq
operator|->
name|vxrxq_stats
operator|.
name|vmrxs_iqdrops
operator|++
expr_stmt|;
name|vmxnet3_rxq_eof_discard
argument_list|(
name|rxq
argument_list|,
name|rxr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rxcd
operator|->
name|eop
condition|)
name|vmxnet3_rxq_discard_chain
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m_head
argument_list|)
expr_stmt|;
name|m_head
operator|=
name|m_tail
operator|=
name|NULL
expr_stmt|;
goto|goto
name|nextp
goto|;
block|}
name|m
operator|->
name|m_len
operator|=
name|length
expr_stmt|;
name|m_head
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|length
expr_stmt|;
name|m_tail
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|m_tail
operator|=
name|m
expr_stmt|;
block|}
if|if
condition|(
name|rxcd
operator|->
name|eop
condition|)
block|{
name|vmxnet3_rxq_input
argument_list|(
name|rxq
argument_list|,
name|rxcd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
name|m_head
operator|=
name|m_tail
operator|=
name|NULL
expr_stmt|;
comment|/* Must recheck after dropping the Rx lock. */
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
name|nextp
label|:
if|if
condition|(
name|__predict_false
argument_list|(
name|rxq
operator|->
name|vxrxq_rs
operator|->
name|update_rxhead
argument_list|)
condition|)
block|{
name|int
name|qid
init|=
name|rxcd
operator|->
name|qid
decl_stmt|;
name|bus_size_t
name|r
decl_stmt|;
name|idx
operator|=
operator|(
name|idx
operator|+
literal|1
operator|)
operator|%
name|rxr
operator|->
name|vxrxr_ndesc
expr_stmt|;
if|if
condition|(
name|qid
operator|>=
name|sc
operator|->
name|vmx_nrxqueues
condition|)
block|{
name|qid
operator|-=
name|sc
operator|->
name|vmx_nrxqueues
expr_stmt|;
name|r
operator|=
name|VMXNET3_BAR0_RXH2
argument_list|(
name|qid
argument_list|)
expr_stmt|;
block|}
else|else
name|r
operator|=
name|VMXNET3_BAR0_RXH1
argument_list|(
name|qid
argument_list|)
expr_stmt|;
name|vmxnet3_write_bar0
argument_list|(
name|sc
argument_list|,
name|r
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_legacy_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
literal|0
index|]
expr_stmt|;
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_intr_type
operator|==
name|VMXNET3_IT_LEGACY
condition|)
block|{
if|if
condition|(
name|vmxnet3_read_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_INTR
argument_list|)
operator|==
literal|0
condition|)
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|vmx_intr_mask_mode
operator|==
name|VMXNET3_IMM_ACTIVE
condition|)
name|vmxnet3_disable_all_intrs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_ds
operator|->
name|event
operator|!=
literal|0
condition|)
name|vmxnet3_evintr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VMXNET3_RXQ_LOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|vmxnet3_rxq_eof
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|VMXNET3_RXQ_UNLOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_txq_eof
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_txq_start
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_enable_all_intrs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_txq_intr
parameter_list|(
name|void
modifier|*
name|xtxq
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|txq
operator|=
name|xtxq
expr_stmt|;
name|sc
operator|=
name|txq
operator|->
name|vxtxq_sc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_intr_mask_mode
operator|==
name|VMXNET3_IMM_ACTIVE
condition|)
name|vmxnet3_disable_intr
argument_list|(
name|sc
argument_list|,
name|txq
operator|->
name|vxtxq_intr_idx
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_txq_eof
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_txq_start
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_enable_intr
argument_list|(
name|sc
argument_list|,
name|txq
operator|->
name|vxtxq_intr_idx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rxq_intr
parameter_list|(
name|void
modifier|*
name|xrxq
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|rxq
operator|=
name|xrxq
expr_stmt|;
name|sc
operator|=
name|rxq
operator|->
name|vxrxq_sc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_intr_mask_mode
operator|==
name|VMXNET3_IMM_ACTIVE
condition|)
name|vmxnet3_disable_intr
argument_list|(
name|sc
argument_list|,
name|rxq
operator|->
name|vxrxq_intr_idx
argument_list|)
expr_stmt|;
name|VMXNET3_RXQ_LOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|vmxnet3_rxq_eof
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|VMXNET3_RXQ_UNLOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|vmxnet3_enable_intr
argument_list|(
name|sc
argument_list|,
name|rxq
operator|->
name|vxrxq_intr_idx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_event_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_intr_mask_mode
operator|==
name|VMXNET3_IMM_ACTIVE
condition|)
name|vmxnet3_disable_intr
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|vmx_event_intr_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vmx_ds
operator|->
name|event
operator|!=
literal|0
condition|)
name|vmxnet3_evintr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_enable_intr
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|vmx_event_intr_idx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_txstop
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|)
block|{
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|vmxnet3_txbuf
modifier|*
name|txb
decl_stmt|;
name|int
name|i
decl_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|txr
operator|->
name|vxtxr_ndesc
condition|;
name|i
operator|++
control|)
block|{
name|txb
operator|=
operator|&
name|txr
operator|->
name|vxtxr_txbuf
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|txb
operator|->
name|vtxb_m
operator|==
name|NULL
condition|)
continue|continue;
name|bus_dmamap_sync
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|,
name|txb
operator|->
name|vtxb_dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|,
name|txb
operator|->
name|vtxb_dmamap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|txb
operator|->
name|vtxb_m
argument_list|)
expr_stmt|;
name|txb
operator|->
name|vtxb_m
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rxstop
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|struct
name|vmxnet3_rxbuf
modifier|*
name|rxb
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|rxq
operator|->
name|vxrxq_mhead
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|rxq
operator|->
name|vxrxq_mhead
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|vxrxq_mhead
operator|=
name|NULL
expr_stmt|;
name|rxq
operator|->
name|vxrxq_mtail
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|rxr
operator|->
name|vxrxr_ndesc
condition|;
name|j
operator|++
control|)
block|{
name|rxb
operator|=
operator|&
name|rxr
operator|->
name|vxrxr_rxbuf
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|rxb
operator|->
name|vrxb_m
operator|==
name|NULL
condition|)
continue|continue;
name|bus_dmamap_sync
argument_list|(
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|,
name|rxb
operator|->
name|vrxb_dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|rxr
operator|->
name|vxrxr_rxtag
argument_list|,
name|rxb
operator|->
name|vrxb_dmamap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rxb
operator|->
name|vrxb_m
argument_list|)
expr_stmt|;
name|rxb
operator|->
name|vrxb_m
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_stop_rendezvous
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
block|{
name|rxq
operator|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
expr_stmt|;
name|VMXNET3_RXQ_LOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
name|VMXNET3_RXQ_UNLOCK
argument_list|(
name|rxq
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_stop
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|q
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|VMXNET3_CORE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|sc
operator|->
name|vmx_link_active
operator|=
literal|0
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|vmx_tick
argument_list|)
expr_stmt|;
comment|/* Disable interrupts. */
name|vmxnet3_disable_all_intrs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_DISABLE
argument_list|)
expr_stmt|;
name|vmxnet3_stop_rendezvous
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|q
operator|++
control|)
name|vmxnet3_txstop
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|q
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|q
operator|++
control|)
name|vmxnet3_rxstop
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|q
index|]
argument_list|)
expr_stmt|;
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_RESET
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_txinit
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|)
block|{
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|txc
decl_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|txr
operator|->
name|vxtxr_head
operator|=
literal|0
expr_stmt|;
name|txr
operator|->
name|vxtxr_next
operator|=
literal|0
expr_stmt|;
name|txr
operator|->
name|vxtxr_gen
operator|=
name|VMXNET3_INIT_GEN
expr_stmt|;
name|bzero
argument_list|(
name|txr
operator|->
name|vxtxr_txd
argument_list|,
name|txr
operator|->
name|vxtxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txdesc
argument_list|)
argument_list|)
expr_stmt|;
name|txc
operator|=
operator|&
name|txq
operator|->
name|vxtxq_comp_ring
expr_stmt|;
name|txc
operator|->
name|vxcr_next
operator|=
literal|0
expr_stmt|;
name|txc
operator|->
name|vxcr_gen
operator|=
name|VMXNET3_INIT_GEN
expr_stmt|;
name|bzero
argument_list|(
name|txc
operator|->
name|vxcr_u
operator|.
name|txcd
argument_list|,
name|txc
operator|->
name|vxcr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txcompdesc
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_rxinit
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vmxnet3_rxring
modifier|*
name|rxr
decl_stmt|;
name|struct
name|vmxnet3_comp_ring
modifier|*
name|rxc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|populate
decl_stmt|,
name|idx
decl_stmt|,
name|frame_size
decl_stmt|,
name|error
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|frame_size
operator|=
name|ETHER_ALIGN
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
operator|+
name|ifp
operator|->
name|if_mtu
expr_stmt|;
comment|/* 	 * If the MTU causes us to exceed what a regular sized cluster can 	 * handle, we allocate a second MJUMPAGESIZE cluster after it in 	 * ring 0. If in use, ring 1 always contains MJUMPAGESIZE clusters. 	 * 	 * Keep rx_max_chain a divisor of the maximum Rx ring size to make 	 * our life easier. We do not support changing the ring size after 	 * the attach. 	 */
if|if
condition|(
name|frame_size
operator|<=
name|MCLBYTES
condition|)
name|sc
operator|->
name|vmx_rx_max_chain
operator|=
literal|1
expr_stmt|;
else|else
name|sc
operator|->
name|vmx_rx_max_chain
operator|=
literal|2
expr_stmt|;
comment|/* 	 * Only populate ring 1 if the configuration will take advantage 	 * of it. That is either when LRO is enabled or the frame size 	 * exceeds what ring 0 can contain. 	 */
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
operator|)
operator|==
literal|0
operator|&&
name|frame_size
operator|<=
name|MCLBYTES
operator|+
name|MJUMPAGESIZE
condition|)
name|populate
operator|=
literal|1
expr_stmt|;
else|else
name|populate
operator|=
name|VMXNET3_RXRINGS_PERQ
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|populate
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
name|rxr
operator|->
name|vxrxr_fill
operator|=
literal|0
expr_stmt|;
name|rxr
operator|->
name|vxrxr_gen
operator|=
name|VMXNET3_INIT_GEN
expr_stmt|;
name|bzero
argument_list|(
name|rxr
operator|->
name|vxrxr_rxd
argument_list|,
name|rxr
operator|->
name|vxrxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxdesc
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|rxr
operator|->
name|vxrxr_ndesc
condition|;
name|idx
operator|++
control|)
block|{
name|error
operator|=
name|vmxnet3_newbuf
argument_list|(
name|sc
argument_list|,
name|rxr
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
for|for
control|(
comment|/**/
init|;
name|i
operator|<
name|VMXNET3_RXRINGS_PERQ
condition|;
name|i
operator|++
control|)
block|{
name|rxr
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
name|i
index|]
expr_stmt|;
name|rxr
operator|->
name|vxrxr_fill
operator|=
literal|0
expr_stmt|;
name|rxr
operator|->
name|vxrxr_gen
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
name|rxr
operator|->
name|vxrxr_rxd
argument_list|,
name|rxr
operator|->
name|vxrxr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxdesc
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|rxc
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
expr_stmt|;
name|rxc
operator|->
name|vxcr_next
operator|=
literal|0
expr_stmt|;
name|rxc
operator|->
name|vxcr_gen
operator|=
name|VMXNET3_INIT_GEN
expr_stmt|;
name|bzero
argument_list|(
name|rxc
operator|->
name|vxcr_u
operator|.
name|rxcd
argument_list|,
name|rxc
operator|->
name|vxcr_ndesc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxcompdesc
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_reinit_queues
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|q
decl_stmt|,
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|q
operator|++
control|)
name|vmxnet3_txinit
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|q
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|q
operator|++
control|)
block|{
name|error
operator|=
name|vmxnet3_rxinit
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|q
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot populate Rx queue %d\n"
argument_list|,
name|q
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_enable_device
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|q
decl_stmt|;
if|if
condition|(
name|vmxnet3_read_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_ENABLE
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|,
literal|"device enable command failed!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* Reset the Rx queue heads. */
for|for
control|(
name|q
operator|=
literal|0
init|;
name|q
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|q
operator|++
control|)
block|{
name|vmxnet3_write_bar0
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR0_RXH1
argument_list|(
name|q
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|vmxnet3_write_bar0
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR0_RXH2
argument_list|(
name|q
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_reinit_rxfilters
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|vmxnet3_set_rxfilter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
name|bcopy
argument_list|(
name|sc
operator|->
name|vmx_vlan_filter
argument_list|,
name|sc
operator|->
name|vmx_ds
operator|->
name|vlan_filter
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|vmx_ds
operator|->
name|vlan_filter
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|bzero
argument_list|(
name|sc
operator|->
name|vmx_ds
operator|->
name|vlan_filter
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|vmx_ds
operator|->
name|vlan_filter
argument_list|)
argument_list|)
expr_stmt|;
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_VLAN_FILTER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_reinit
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|vmxnet3_reinit_interface
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_reinit_shared_data
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vmxnet3_reinit_queues
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|vmxnet3_enable_device
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|vmxnet3_reinit_rxfilters
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_init_locked
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
return|return;
name|vmxnet3_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vmxnet3_reinit
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|vmxnet3_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|vmxnet3_link_status
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_enable_all_intrs
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|vmx_tick
argument_list|,
name|hz
argument_list|,
name|vmxnet3_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_init
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * BMV: Much of this can go away once we finally have offsets in  * the mbuf packet header. Bug andre@.  */
end_comment

begin_function
specifier|static
name|int
name|vmxnet3_txq_offload_ctx
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
modifier|*
name|etype
parameter_list|,
name|int
modifier|*
name|proto
parameter_list|,
name|int
modifier|*
name|start
parameter_list|)
block|{
name|struct
name|ether_vlan_header
modifier|*
name|evh
decl_stmt|;
name|int
name|offset
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
name|struct
name|ip
modifier|*
name|ip
init|=
name|NULL
decl_stmt|;
name|struct
name|ip
name|iphdr
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|NULL
decl_stmt|;
name|struct
name|ip6_hdr
name|ip6hdr
decl_stmt|;
endif|#
directive|endif
name|evh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_vlan_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|evh
operator|->
name|evl_encap_proto
operator|==
name|htons
argument_list|(
name|ETHERTYPE_VLAN
argument_list|)
condition|)
block|{
comment|/* BMV: We should handle nested VLAN tags too. */
operator|*
name|etype
operator|=
name|ntohs
argument_list|(
name|evh
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
name|offset
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_vlan_header
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|etype
operator|=
name|ntohs
argument_list|(
name|evh
operator|->
name|evl_encap_proto
argument_list|)
expr_stmt|;
name|offset
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ether_header
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
operator|*
name|etype
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
case|case
name|ETHERTYPE_IP
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|m
operator|->
name|m_len
operator|<
name|offset
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|)
condition|)
block|{
name|m_copydata
argument_list|(
name|m
argument_list|,
name|offset
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|iphdr
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|&
name|iphdr
expr_stmt|;
block|}
else|else
name|ip
operator|=
name|mtodo
argument_list|(
name|m
argument_list|,
name|offset
argument_list|)
expr_stmt|;
operator|*
name|proto
operator|=
name|ip
operator|->
name|ip_p
expr_stmt|;
operator|*
name|start
operator|=
name|offset
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
case|case
name|ETHERTYPE_IPV6
case|:
if|if
condition|(
name|__predict_false
argument_list|(
name|m
operator|->
name|m_len
operator|<
name|offset
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|)
condition|)
block|{
name|m_copydata
argument_list|(
name|m
argument_list|,
name|offset
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ip6hdr
argument_list|)
expr_stmt|;
name|ip6
operator|=
operator|&
name|ip6hdr
expr_stmt|;
block|}
else|else
name|ip6
operator|=
name|mtodo
argument_list|(
name|m
argument_list|,
name|offset
argument_list|)
expr_stmt|;
operator|*
name|proto
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|start
operator|=
name|ip6_lasthdr
argument_list|(
name|m
argument_list|,
name|offset
argument_list|,
name|IPPROTO_IPV6
argument_list|,
name|proto
argument_list|)
expr_stmt|;
comment|/* Assert the network stack sent us a valid packet. */
name|KASSERT
argument_list|(
operator|*
name|start
operator|>
name|offset
argument_list|,
operator|(
literal|"%s: mbuf %p start %d offset %d proto %d"
operator|,
name|__func__
operator|,
name|m
operator|,
operator|*
name|start
operator|,
name|offset
operator|,
operator|*
name|proto
operator|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
name|struct
name|tcphdr
modifier|*
name|tcp
decl_stmt|,
name|tcphdr
decl_stmt|;
name|uint16_t
name|sum
decl_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
operator|*
name|proto
operator|!=
name|IPPROTO_TCP
argument_list|)
condition|)
block|{
comment|/* Likely failed to correctly parse the mbuf. */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|txq
operator|->
name|vxtxq_stats
operator|.
name|vmtxs_tso
operator|++
expr_stmt|;
switch|switch
condition|(
operator|*
name|etype
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
case|case
name|ETHERTYPE_IP
case|:
name|sum
operator|=
name|in_pseudo
argument_list|(
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|,
name|htons
argument_list|(
name|IPPROTO_TCP
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
case|case
name|ETHERTYPE_IPV6
case|:
name|sum
operator|=
name|in6_cksum_pseudo
argument_list|(
name|ip6
argument_list|,
literal|0
argument_list|,
name|IPPROTO_TCP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|sum
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
operator|*
name|start
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
condition|)
block|{
name|m_copyback
argument_list|(
name|m
argument_list|,
operator|*
name|start
operator|+
name|offsetof
argument_list|(
expr|struct
name|tcphdr
argument_list|,
name|th_sum
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sum
argument_list|)
expr_stmt|;
name|m_copydata
argument_list|(
name|m
argument_list|,
operator|*
name|start
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tcphdr
argument_list|)
expr_stmt|;
name|tcp
operator|=
operator|&
name|tcphdr
expr_stmt|;
block|}
else|else
block|{
name|tcp
operator|=
name|mtodo
argument_list|(
name|m
argument_list|,
operator|*
name|start
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|th_sum
operator|=
name|sum
expr_stmt|;
block|}
comment|/* 		 * For TSO, the size of the protocol header is also 		 * included in the descriptor header size. 		 */
operator|*
name|start
operator|+=
operator|(
name|tcp
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
block|}
else|else
name|txq
operator|->
name|vxtxq_stats
operator|.
name|vmtxs_csum
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_txq_load_mbuf
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|,
name|bus_dmamap_t
name|dmap
parameter_list|,
name|bus_dma_segment_t
name|segs
index|[]
parameter_list|,
name|int
modifier|*
name|nsegs
parameter_list|)
block|{
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dma_tag_t
name|tag
decl_stmt|;
name|int
name|error
decl_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|m
operator|=
operator|*
name|m0
expr_stmt|;
name|tag
operator|=
name|txr
operator|->
name|vxtxr_txtag
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|tag
argument_list|,
name|dmap
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
operator|||
name|error
operator|!=
name|EFBIG
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|m
operator|=
name|m_defrag
argument_list|(
name|m
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
operator|*
name|m0
operator|=
name|m
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|tag
argument_list|,
name|dmap
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ENOBUFS
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m0
argument_list|)
expr_stmt|;
operator|*
name|m0
operator|=
name|NULL
expr_stmt|;
name|txq
operator|->
name|vxtxq_sc
operator|->
name|vmx_stats
operator|.
name|vmst_defrag_failed
operator|++
expr_stmt|;
block|}
else|else
name|txq
operator|->
name|vxtxq_sc
operator|->
name|vmx_stats
operator|.
name|vmst_defragged
operator|++
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_txq_unload_mbuf
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|,
name|bus_dmamap_t
name|dmap
parameter_list|)
block|{
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|txr
operator|->
name|vxtxr_txtag
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_txq_encap
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|vmxnet3_txdesc
modifier|*
name|txd
decl_stmt|,
modifier|*
name|sop
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dmamap_t
name|dmap
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|VMXNET3_TX_MAXSEGS
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|gen
decl_stmt|,
name|nsegs
decl_stmt|,
name|etype
decl_stmt|,
name|proto
decl_stmt|,
name|start
decl_stmt|,
name|error
decl_stmt|;
name|sc
operator|=
name|txq
operator|->
name|vxtxq_sc
expr_stmt|;
name|start
operator|=
literal|0
expr_stmt|;
name|txd
operator|=
name|NULL
expr_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|dmap
operator|=
name|txr
operator|->
name|vxtxr_txbuf
index|[
name|txr
operator|->
name|vxtxr_head
index|]
operator|.
name|vtxb_dmamap
expr_stmt|;
name|error
operator|=
name|vmxnet3_txq_load_mbuf
argument_list|(
name|txq
argument_list|,
name|m0
argument_list|,
name|dmap
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|m
operator|=
operator|*
name|m0
expr_stmt|;
name|M_ASSERTPKTHDR
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|VMXNET3_TX_MAXSEGS
argument_list|,
operator|(
literal|"%s: mbuf %p with too many segments %d"
operator|,
name|__func__
operator|,
name|m
operator|,
name|nsegs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|VMXNET3_TXRING_AVAIL
argument_list|(
name|txr
argument_list|)
operator|<
name|nsegs
condition|)
block|{
name|txq
operator|->
name|vxtxq_stats
operator|.
name|vmtxs_full
operator|++
expr_stmt|;
name|vmxnet3_txq_unload_mbuf
argument_list|(
name|txq
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOSPC
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|VMXNET3_CSUM_ALL_OFFLOAD
condition|)
block|{
name|error
operator|=
name|vmxnet3_txq_offload_ctx
argument_list|(
name|txq
argument_list|,
name|m
argument_list|,
operator|&
name|etype
argument_list|,
operator|&
name|proto
argument_list|,
operator|&
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|txq
operator|->
name|vxtxq_stats
operator|.
name|vmtxs_offload_failed
operator|++
expr_stmt|;
name|vmxnet3_txq_unload_mbuf
argument_list|(
name|txq
argument_list|,
name|dmap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
operator|*
name|m0
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
name|txr
operator|->
name|vxtxr_txbuf
index|[
name|txr
operator|->
name|vxtxr_head
index|]
operator|.
name|vtxb_m
operator|=
name|m
expr_stmt|;
name|sop
operator|=
operator|&
name|txr
operator|->
name|vxtxr_txd
index|[
name|txr
operator|->
name|vxtxr_head
index|]
expr_stmt|;
name|gen
operator|=
name|txr
operator|->
name|vxtxr_gen
operator|^
literal|1
expr_stmt|;
comment|/* Owned by cpu (yet) */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|txd
operator|=
operator|&
name|txr
operator|->
name|vxtxr_txd
index|[
name|txr
operator|->
name|vxtxr_head
index|]
expr_stmt|;
name|txd
operator|->
name|addr
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
expr_stmt|;
name|txd
operator|->
name|len
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
expr_stmt|;
name|txd
operator|->
name|gen
operator|=
name|gen
expr_stmt|;
name|txd
operator|->
name|dtype
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|offload_mode
operator|=
name|VMXNET3_OM_NONE
expr_stmt|;
name|txd
operator|->
name|offload_pos
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|hlen
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|eop
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|compreq
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|vtag_mode
operator|=
literal|0
expr_stmt|;
name|txd
operator|->
name|vtag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|txr
operator|->
name|vxtxr_head
operator|==
name|txr
operator|->
name|vxtxr_ndesc
condition|)
block|{
name|txr
operator|->
name|vxtxr_head
operator|=
literal|0
expr_stmt|;
name|txr
operator|->
name|vxtxr_gen
operator|^=
literal|1
expr_stmt|;
block|}
name|gen
operator|=
name|txr
operator|->
name|vxtxr_gen
expr_stmt|;
block|}
name|txd
operator|->
name|eop
operator|=
literal|1
expr_stmt|;
name|txd
operator|->
name|compreq
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_VLANTAG
condition|)
block|{
name|sop
operator|->
name|vtag_mode
operator|=
literal|1
expr_stmt|;
name|sop
operator|->
name|vtag
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_TSO
condition|)
block|{
name|sop
operator|->
name|offload_mode
operator|=
name|VMXNET3_OM_TSO
expr_stmt|;
name|sop
operator|->
name|hlen
operator|=
name|start
expr_stmt|;
name|sop
operator|->
name|offload_pos
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|tso_segsz
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
operator|(
name|VMXNET3_CSUM_OFFLOAD
operator||
name|VMXNET3_CSUM_OFFLOAD_IPV6
operator|)
condition|)
block|{
name|sop
operator|->
name|offload_mode
operator|=
name|VMXNET3_OM_CSUM
expr_stmt|;
name|sop
operator|->
name|hlen
operator|=
name|start
expr_stmt|;
name|sop
operator|->
name|offload_pos
operator|=
name|start
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
expr_stmt|;
block|}
comment|/* Finally, change the ownership. */
name|vmxnet3_barrier
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BARRIER_WR
argument_list|)
expr_stmt|;
name|sop
operator|->
name|gen
operator|^=
literal|1
expr_stmt|;
name|txq
operator|->
name|vxtxq_ts
operator|->
name|npending
operator|+=
name|nsegs
expr_stmt|;
if|if
condition|(
name|txq
operator|->
name|vxtxq_ts
operator|->
name|npending
operator|>=
name|txq
operator|->
name|vxtxq_ts
operator|->
name|intr_threshold
condition|)
block|{
name|txq
operator|->
name|vxtxq_ts
operator|->
name|npending
operator|=
literal|0
expr_stmt|;
name|vmxnet3_write_bar0
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR0_TXH
argument_list|(
name|txq
operator|->
name|vxtxq_id
argument_list|)
argument_list|,
name|txr
operator|->
name|vxtxr_head
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|VMXNET3_LEGACY_TX
end_ifdef

begin_function
specifier|static
name|void
name|vmxnet3_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_head
decl_stmt|;
name|int
name|tx
decl_stmt|,
name|avail
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
literal|0
index|]
expr_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|tx
operator|=
literal|0
expr_stmt|;
name|VMXNET3_TXQ_LOCK_ASSERT
argument_list|(
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
operator|||
name|sc
operator|->
name|vmx_link_active
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|avail
operator|=
name|VMXNET3_TXRING_AVAIL
argument_list|(
name|txr
argument_list|)
operator|)
operator|<
literal|2
condition|)
break|break;
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|m_head
operator|==
name|NULL
condition|)
break|break;
comment|/* Assume worse case if this mbuf is the head of a chain. */
if|if
condition|(
name|m_head
operator|->
name|m_next
operator|!=
name|NULL
operator|&&
name|avail
operator|<
name|VMXNET3_TX_MAXSEGS
condition|)
block|{
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vmxnet3_txq_encap
argument_list|(
name|txq
argument_list|,
operator|&
name|m_head
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|m_head
operator|!=
name|NULL
condition|)
name|IFQ_DRV_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
break|break;
block|}
name|tx
operator|++
expr_stmt|;
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tx
operator|>
literal|0
condition|)
name|txq
operator|->
name|vxtxq_watchdog
operator|=
name|VMXNET3_WATCHDOG_TIMEOUT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
literal|0
index|]
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !VMXNET3_LEGACY_TX */
end_comment

begin_function
specifier|static
name|int
name|vmxnet3_txq_mq_start_locked
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txring
modifier|*
name|txr
decl_stmt|;
name|struct
name|buf_ring
modifier|*
name|br
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|tx
decl_stmt|,
name|avail
decl_stmt|,
name|error
decl_stmt|;
name|sc
operator|=
name|txq
operator|->
name|vxtxq_sc
expr_stmt|;
name|br
operator|=
name|txq
operator|->
name|vxtxq_br
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|txr
operator|=
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
expr_stmt|;
name|tx
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|VMXNET3_TXQ_LOCK_ASSERT
argument_list|(
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
operator|||
name|sc
operator|->
name|vmx_link_active
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|error
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
while|while
condition|(
operator|(
name|avail
operator|=
name|VMXNET3_TXRING_AVAIL
argument_list|(
name|txr
argument_list|)
operator|)
operator|>=
literal|2
condition|)
block|{
name|m
operator|=
name|drbr_peek
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
break|break;
comment|/* Assume worse case if this mbuf is the head of a chain. */
if|if
condition|(
name|m
operator|->
name|m_next
operator|!=
name|NULL
operator|&&
name|avail
operator|<
name|VMXNET3_TX_MAXSEGS
condition|)
block|{
name|drbr_putback
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|,
name|m
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|vmxnet3_txq_encap
argument_list|(
name|txq
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|drbr_putback
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|else
name|drbr_advance
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|)
expr_stmt|;
break|break;
block|}
name|drbr_advance
argument_list|(
name|ifp
argument_list|,
name|br
argument_list|)
expr_stmt|;
name|tx
operator|++
expr_stmt|;
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tx
operator|>
literal|0
condition|)
name|txq
operator|->
name|vxtxq_watchdog
operator|=
name|VMXNET3_WATCHDOG_TIMEOUT
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_txq_mq_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ntxq
decl_stmt|,
name|error
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ntxq
operator|=
name|sc
operator|->
name|vmx_ntxqueues
expr_stmt|;
comment|/* check if flowid is set */
if|if
condition|(
name|M_HASHTYPE_GET
argument_list|(
name|m
argument_list|)
operator|!=
name|M_HASHTYPE_NONE
condition|)
name|i
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|%
name|ntxq
expr_stmt|;
else|else
name|i
operator|=
name|curcpu
operator|%
name|ntxq
expr_stmt|;
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|VMXNET3_TXQ_TRYLOCK
argument_list|(
name|txq
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|vmxnet3_txq_mq_start_locked
argument_list|(
name|txq
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|drbr_enqueue
argument_list|(
name|ifp
argument_list|,
name|txq
operator|->
name|vxtxq_br
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|vmx_tq
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_defrtask
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_txq_tq_deferred
parameter_list|(
name|void
modifier|*
name|xtxq
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|txq
operator|=
name|xtxq
expr_stmt|;
name|sc
operator|=
name|txq
operator|->
name|vxtxq_sc
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drbr_empty
argument_list|(
name|sc
operator|->
name|vmx_ifp
argument_list|,
name|txq
operator|->
name|vxtxq_br
argument_list|)
condition|)
name|vmxnet3_txq_mq_start_locked
argument_list|(
name|txq
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* VMXNET3_LEGACY_TX */
end_comment

begin_function
specifier|static
name|void
name|vmxnet3_txq_start
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|txq
operator|->
name|vxtxq_sc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
ifdef|#
directive|ifdef
name|VMXNET3_LEGACY_TX
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|vmxnet3_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|!
name|drbr_empty
argument_list|(
name|ifp
argument_list|,
name|txq
operator|->
name|vxtxq_br
argument_list|)
condition|)
name|vmxnet3_txq_mq_start_locked
argument_list|(
name|txq
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_tx_start_all
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|int
name|i
decl_stmt|;
name|VMXNET3_CORE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|vmxnet3_txq_start
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_update_vlan_filter
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|int
name|add
parameter_list|,
name|uint16_t
name|tag
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|bit
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|idx
operator|=
operator|(
name|tag
operator|>>
literal|5
operator|)
operator|&
literal|0x7F
expr_stmt|;
name|bit
operator|=
name|tag
operator|&
literal|0x1F
expr_stmt|;
if|if
condition|(
name|tag
operator|==
literal|0
operator|||
name|tag
operator|>
literal|4095
condition|)
return|return;
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Update our private VLAN bitvector. */
if|if
condition|(
name|add
condition|)
name|sc
operator|->
name|vmx_vlan_filter
index|[
name|idx
index|]
operator||=
operator|(
literal|1
operator|<<
name|bit
operator|)
expr_stmt|;
else|else
name|sc
operator|->
name|vmx_vlan_filter
index|[
name|idx
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|bit
operator|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
block|{
if|if
condition|(
name|add
condition|)
name|sc
operator|->
name|vmx_ds
operator|->
name|vlan_filter
index|[
name|idx
index|]
operator||=
operator|(
literal|1
operator|<<
name|bit
operator|)
expr_stmt|;
else|else
name|sc
operator|->
name|vmx_ds
operator|->
name|vlan_filter
index|[
name|idx
index|]
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|bit
operator|)
expr_stmt|;
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_VLAN_FILTER
argument_list|)
expr_stmt|;
block|}
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_register_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|uint16_t
name|tag
parameter_list|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_softc
operator|==
name|arg
condition|)
name|vmxnet3_update_vlan_filter
argument_list|(
name|arg
argument_list|,
literal|1
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_unregister_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|uint16_t
name|tag
parameter_list|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_softc
operator|==
name|arg
condition|)
name|vmxnet3_update_vlan_filter
argument_list|(
name|arg
argument_list|,
literal|0
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_set_rxfilter
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vmxnet3_driver_shared
modifier|*
name|ds
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|u_int
name|mode
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|ds
operator|=
name|sc
operator|->
name|vmx_ds
expr_stmt|;
name|mode
operator|=
name|VMXNET3_RXMODE_UCAST
operator||
name|VMXNET3_RXMODE_BCAST
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
name|mode
operator||=
name|VMXNET3_RXMODE_PROMISC
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
condition|)
name|mode
operator||=
name|VMXNET3_RXMODE_ALLMULTI
expr_stmt|;
else|else
block|{
name|int
name|cnt
init|=
literal|0
decl_stmt|,
name|overflow
init|=
literal|0
decl_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
elseif|else
if|if
condition|(
name|cnt
operator|==
name|VMXNET3_MULTICAST_MAX
condition|)
block|{
name|overflow
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|bcopy
argument_list|(
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|,
operator|&
name|sc
operator|->
name|vmx_mcast
index|[
name|cnt
operator|*
name|ETHER_ADDR_LEN
index|]
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|overflow
operator|!=
literal|0
condition|)
block|{
name|cnt
operator|=
literal|0
expr_stmt|;
name|mode
operator||=
name|VMXNET3_RXMODE_ALLMULTI
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
name|mode
operator||=
name|VMXNET3_RXMODE_MCAST
expr_stmt|;
name|ds
operator|->
name|mcast_tablelen
operator|=
name|cnt
operator|*
name|ETHER_ADDR_LEN
expr_stmt|;
block|}
name|ds
operator|->
name|rxmode
operator|=
name|mode
expr_stmt|;
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_SET_FILTER
argument_list|)
expr_stmt|;
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_SET_RXMODE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_change_mtu
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|int
name|mtu
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
if|if
condition|(
name|mtu
operator|<
name|VMXNET3_MIN_MTU
operator|||
name|mtu
operator|>
name|VMXNET3_MAX_MTU
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|ifp
operator|->
name|if_mtu
operator|=
name|mtu
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|vmxnet3_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
name|int
name|reinit
decl_stmt|,
name|mask
decl_stmt|,
name|error
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFMTU
case|:
if|if
condition|(
name|ifp
operator|->
name|if_mtu
operator|!=
name|ifr
operator|->
name|ifr_mtu
condition|)
block|{
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|vmxnet3_change_mtu
argument_list|(
name|sc
argument_list|,
name|ifr
operator|->
name|ifr_mtu
argument_list|)
expr_stmt|;
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFFLAGS
case|:
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|sc
operator|->
name|vmx_if_flags
operator|)
operator|&
operator|(
name|IFF_PROMISC
operator||
name|IFF_ALLMULTI
operator|)
condition|)
block|{
name|vmxnet3_set_rxfilter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|vmxnet3_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|vmxnet3_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|vmx_if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|vmxnet3_set_rxfilter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|vmx_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mask
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TXCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TXCSUM_IPV6
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM_IPV6
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO4
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO6
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO6
expr_stmt|;
if|if
condition|(
name|mask
operator|&
operator|(
name|IFCAP_RXCSUM
operator||
name|IFCAP_RXCSUM_IPV6
operator||
name|IFCAP_LRO
operator||
name|IFCAP_VLAN_HWTAGGING
operator||
name|IFCAP_VLAN_HWFILTER
operator|)
condition|)
block|{
comment|/* Changing these features requires us to reinit. */
name|reinit
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_RXCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_RXCSUM_IPV6
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM_IPV6
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_LRO
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_LRO
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
block|}
else|else
name|reinit
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTSO
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTSO
expr_stmt|;
if|if
condition|(
name|reinit
operator|&&
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|vmxnet3_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vmxnet3_init_hwassist
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VLAN_CAPABILITIES
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
name|VMXNET3_CORE_LOCK_ASSERT_NOTOWNED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
end_ifndef

begin_function
specifier|static
name|void
name|vmxnet3_qflush
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|txq
operator|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|buf_ring_dequeue_sc
argument_list|(
name|txq
operator|->
name|vxtxq_br
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
block|}
name|if_qflush
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|vmxnet3_watchdog
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|txq
operator|->
name|vxtxq_sc
expr_stmt|;
name|VMXNET3_TXQ_LOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|txq
operator|->
name|vxtxq_watchdog
operator|==
literal|0
operator|||
operator|--
name|txq
operator|->
name|vxtxq_watchdog
condition|)
block|{
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|VMXNET3_TXQ_UNLOCK
argument_list|(
name|txq
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|sc
operator|->
name|vmx_ifp
argument_list|,
literal|"watchdog timeout on queue %d\n"
argument_list|,
name|txq
operator|->
name|vxtxq_id
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_refresh_host_stats
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_GET_STATS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_txq_accum_stats
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|,
name|struct
name|vmxnet3_txq_stats
modifier|*
name|accum
parameter_list|)
block|{
name|struct
name|vmxnet3_txq_stats
modifier|*
name|st
decl_stmt|;
name|st
operator|=
operator|&
name|txq
operator|->
name|vxtxq_stats
expr_stmt|;
name|accum
operator|->
name|vmtxs_opackets
operator|+=
name|st
operator|->
name|vmtxs_opackets
expr_stmt|;
name|accum
operator|->
name|vmtxs_obytes
operator|+=
name|st
operator|->
name|vmtxs_obytes
expr_stmt|;
name|accum
operator|->
name|vmtxs_omcasts
operator|+=
name|st
operator|->
name|vmtxs_omcasts
expr_stmt|;
name|accum
operator|->
name|vmtxs_csum
operator|+=
name|st
operator|->
name|vmtxs_csum
expr_stmt|;
name|accum
operator|->
name|vmtxs_tso
operator|+=
name|st
operator|->
name|vmtxs_tso
expr_stmt|;
name|accum
operator|->
name|vmtxs_full
operator|+=
name|st
operator|->
name|vmtxs_full
expr_stmt|;
name|accum
operator|->
name|vmtxs_offload_failed
operator|+=
name|st
operator|->
name|vmtxs_offload_failed
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_rxq_accum_stats
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|,
name|struct
name|vmxnet3_rxq_stats
modifier|*
name|accum
parameter_list|)
block|{
name|struct
name|vmxnet3_rxq_stats
modifier|*
name|st
decl_stmt|;
name|st
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_stats
expr_stmt|;
name|accum
operator|->
name|vmrxs_ipackets
operator|+=
name|st
operator|->
name|vmrxs_ipackets
expr_stmt|;
name|accum
operator|->
name|vmrxs_ibytes
operator|+=
name|st
operator|->
name|vmrxs_ibytes
expr_stmt|;
name|accum
operator|->
name|vmrxs_iqdrops
operator|+=
name|st
operator|->
name|vmrxs_iqdrops
expr_stmt|;
name|accum
operator|->
name|vmrxs_ierrors
operator|+=
name|st
operator|->
name|vmrxs_ierrors
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_accumulate_stats
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vmxnet3_statistics
modifier|*
name|st
decl_stmt|;
name|struct
name|vmxnet3_txq_stats
name|txaccum
decl_stmt|;
name|struct
name|vmxnet3_rxq_stats
name|rxaccum
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|st
operator|=
operator|&
name|sc
operator|->
name|vmx_stats
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|txaccum
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_txq_stats
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|rxaccum
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_rxq_stats
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
name|vmxnet3_txq_accum_stats
argument_list|(
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
argument_list|,
operator|&
name|txaccum
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
name|vmxnet3_rxq_accum_stats
argument_list|(
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
argument_list|,
operator|&
name|rxaccum
argument_list|)
expr_stmt|;
comment|/* 	 * With the exception of if_ierrors, these ifnet statistics are 	 * only updated in the driver, so just set them to our accumulated 	 * values. if_ierrors is updated in ether_input() for malformed 	 * frames that we should have already discarded. 	 */
name|ifp
operator|->
name|if_ipackets
operator|=
name|rxaccum
operator|.
name|vmrxs_ipackets
expr_stmt|;
name|ifp
operator|->
name|if_iqdrops
operator|=
name|rxaccum
operator|.
name|vmrxs_iqdrops
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|=
name|rxaccum
operator|.
name|vmrxs_ierrors
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|=
name|txaccum
operator|.
name|vmtxs_opackets
expr_stmt|;
ifndef|#
directive|ifndef
name|VMXNET3_LEGACY_TX
name|ifp
operator|->
name|if_obytes
operator|=
name|txaccum
operator|.
name|vmtxs_obytes
expr_stmt|;
name|ifp
operator|->
name|if_omcasts
operator|=
name|txaccum
operator|.
name|vmtxs_omcasts
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_tick
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|timedout
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|timedout
operator|=
literal|0
expr_stmt|;
name|VMXNET3_CORE_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_accumulate_stats
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vmxnet3_refresh_host_stats
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
name|timedout
operator||=
name|vmxnet3_watchdog
argument_list|(
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|timedout
operator|!=
literal|0
condition|)
block|{
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|vmxnet3_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|vmx_tick
argument_list|,
name|hz
argument_list|,
name|vmxnet3_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_link_is_up
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|;
comment|/* Also update the link speed while here. */
name|status
operator|=
name|vmxnet3_read_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_GET_LINK
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_link_speed
operator|=
name|status
operator|>>
literal|16
expr_stmt|;
return|return
operator|!
operator|!
operator|(
name|status
operator|&
literal|0x1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_link_status
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|link
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vmx_ifp
expr_stmt|;
name|link
operator|=
name|vmxnet3_link_is_up
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
literal|0
operator|&&
name|sc
operator|->
name|vmx_link_active
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|vmx_link_active
operator|=
literal|1
expr_stmt|;
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|link
operator|==
literal|0
operator|&&
name|sc
operator|->
name|vmx_link_active
operator|!=
literal|0
condition|)
block|{
name|sc
operator|->
name|vmx_link_active
operator|=
literal|0
expr_stmt|;
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|vmxnet3_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_ETHER
operator||
name|IFM_AUTO
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|IFM_AVALID
expr_stmt|;
name|VMXNET3_CORE_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vmxnet3_link_is_up
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_ACTIVE
expr_stmt|;
else|else
name|ifmr
operator|->
name|ifm_status
operator||=
name|IFM_NONE
expr_stmt|;
name|VMXNET3_CORE_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
comment|/* Ignore. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_set_lladdr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|ml
decl_stmt|,
name|mh
decl_stmt|;
name|ml
operator|=
name|sc
operator|->
name|vmx_lladdr
index|[
literal|0
index|]
expr_stmt|;
name|ml
operator||=
name|sc
operator|->
name|vmx_lladdr
index|[
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|ml
operator||=
name|sc
operator|->
name|vmx_lladdr
index|[
literal|2
index|]
operator|<<
literal|16
expr_stmt|;
name|ml
operator||=
name|sc
operator|->
name|vmx_lladdr
index|[
literal|3
index|]
operator|<<
literal|24
expr_stmt|;
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_MACL
argument_list|,
name|ml
argument_list|)
expr_stmt|;
name|mh
operator|=
name|sc
operator|->
name|vmx_lladdr
index|[
literal|4
index|]
expr_stmt|;
name|mh
operator||=
name|sc
operator|->
name|vmx_lladdr
index|[
literal|5
index|]
operator|<<
literal|8
expr_stmt|;
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_MACH
argument_list|,
name|mh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_get_lladdr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|ml
decl_stmt|,
name|mh
decl_stmt|;
name|ml
operator|=
name|vmxnet3_read_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_GET_MACL
argument_list|)
expr_stmt|;
name|mh
operator|=
name|vmxnet3_read_cmd
argument_list|(
name|sc
argument_list|,
name|VMXNET3_CMD_GET_MACH
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vmx_lladdr
index|[
literal|0
index|]
operator|=
name|ml
expr_stmt|;
name|sc
operator|->
name|vmx_lladdr
index|[
literal|1
index|]
operator|=
name|ml
operator|>>
literal|8
expr_stmt|;
name|sc
operator|->
name|vmx_lladdr
index|[
literal|2
index|]
operator|=
name|ml
operator|>>
literal|16
expr_stmt|;
name|sc
operator|->
name|vmx_lladdr
index|[
literal|3
index|]
operator|=
name|ml
operator|>>
literal|24
expr_stmt|;
name|sc
operator|->
name|vmx_lladdr
index|[
literal|4
index|]
operator|=
name|mh
expr_stmt|;
name|sc
operator|->
name|vmx_lladdr
index|[
literal|5
index|]
operator|=
name|mh
operator|>>
literal|8
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_setup_txq_sysctl
parameter_list|(
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid_list
modifier|*
name|child
parameter_list|)
block|{
name|struct
name|sysctl_oid
modifier|*
name|node
decl_stmt|,
modifier|*
name|txsnode
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|list
decl_stmt|,
modifier|*
name|txslist
decl_stmt|;
name|struct
name|vmxnet3_txq_stats
modifier|*
name|stats
decl_stmt|;
name|struct
name|UPT1_TxStats
modifier|*
name|txstats
decl_stmt|;
name|char
name|namebuf
index|[
literal|16
index|]
decl_stmt|;
name|stats
operator|=
operator|&
name|txq
operator|->
name|vxtxq_stats
expr_stmt|;
name|txstats
operator|=
operator|&
name|txq
operator|->
name|vxtxq_ts
operator|->
name|stats
expr_stmt|;
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"txq%d"
argument_list|,
name|txq
operator|->
name|vxtxq_id
argument_list|)
expr_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
name|namebuf
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Transmit Queue"
argument_list|)
expr_stmt|;
name|txq
operator|->
name|vxtxq_sysctl
operator|=
name|list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"opackets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmtxs_opackets
argument_list|,
literal|"Transmit packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"obytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmtxs_obytes
argument_list|,
literal|"Transmit bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"omcasts"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmtxs_omcasts
argument_list|,
literal|"Transmit multicasts"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"csum"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmtxs_csum
argument_list|,
literal|"Transmit checksum offloaded"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tso"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmtxs_tso
argument_list|,
literal|"Transmit TCP segmentation offloaded"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ringfull"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmtxs_full
argument_list|,
literal|"Transmit ring full"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"offload_failed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmtxs_offload_failed
argument_list|,
literal|"Transmit checksum offload failed"
argument_list|)
expr_stmt|;
comment|/* 	 * Add statistics reported by the host. These are updated once 	 * per second. 	 */
name|txsnode
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"hstats"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Host Statistics"
argument_list|)
expr_stmt|;
name|txslist
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|txsnode
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tso_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|TSO_packets
argument_list|,
literal|"TSO packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tso_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|TSO_bytes
argument_list|,
literal|"TSO bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ucast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|ucast_packets
argument_list|,
literal|"Unicast packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"unicast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|ucast_bytes
argument_list|,
literal|"Unicast bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mcast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|mcast_packets
argument_list|,
literal|"Multicast packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mcast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|mcast_bytes
argument_list|,
literal|"Multicast bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"error"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|error
argument_list|,
literal|"Errors"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|txslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"discard"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txstats
operator|->
name|discard
argument_list|,
literal|"Discards"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_setup_rxq_sysctl
parameter_list|(
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid_list
modifier|*
name|child
parameter_list|)
block|{
name|struct
name|sysctl_oid
modifier|*
name|node
decl_stmt|,
modifier|*
name|rxsnode
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|list
decl_stmt|,
modifier|*
name|rxslist
decl_stmt|;
name|struct
name|vmxnet3_rxq_stats
modifier|*
name|stats
decl_stmt|;
name|struct
name|UPT1_RxStats
modifier|*
name|rxstats
decl_stmt|;
name|char
name|namebuf
index|[
literal|16
index|]
decl_stmt|;
name|stats
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_stats
expr_stmt|;
name|rxstats
operator|=
operator|&
name|rxq
operator|->
name|vxrxq_rs
operator|->
name|stats
expr_stmt|;
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"rxq%d"
argument_list|,
name|rxq
operator|->
name|vxrxq_id
argument_list|)
expr_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
name|namebuf
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Receive Queue"
argument_list|)
expr_stmt|;
name|rxq
operator|->
name|vxrxq_sysctl
operator|=
name|list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ipackets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmrxs_ipackets
argument_list|,
literal|"Receive packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ibytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmrxs_ibytes
argument_list|,
literal|"Receive bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"iqdrops"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmrxs_iqdrops
argument_list|,
literal|"Receive drops"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ierrors"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmrxs_ierrors
argument_list|,
literal|"Receive errors"
argument_list|)
expr_stmt|;
comment|/* 	 * Add statistics reported by the host. These are updated once 	 * per second. 	 */
name|rxsnode
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"hstats"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|"Host Statistics"
argument_list|)
expr_stmt|;
name|rxslist
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|rxsnode
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|LRO_packets
argument_list|,
literal|"LRO packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"lro_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|LRO_bytes
argument_list|,
literal|"LRO bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ucast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|ucast_packets
argument_list|,
literal|"Unicast packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"unicast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|ucast_bytes
argument_list|,
literal|"Unicast bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mcast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|mcast_packets
argument_list|,
literal|"Multicast packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mcast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|mcast_bytes
argument_list|,
literal|"Multicast bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"bcast_packets"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|bcast_packets
argument_list|,
literal|"Broadcast packets"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"bcast_bytes"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|bcast_bytes
argument_list|,
literal|"Broadcast bytes"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"nobuffer"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|nobuffer
argument_list|,
literal|"No buffer"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UQUAD
argument_list|(
name|ctx
argument_list|,
name|rxslist
argument_list|,
name|OID_AUTO
argument_list|,
literal|"error"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxstats
operator|->
name|error
argument_list|,
literal|"Errors"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_setup_debug_sysctl
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid_list
modifier|*
name|child
parameter_list|)
block|{
name|struct
name|sysctl_oid
modifier|*
name|node
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|list
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|vmxnet3_txqueue
modifier|*
name|txq
init|=
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
decl_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|txq
operator|->
name|vxtxq_sysctl
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd_head"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
operator|.
name|vxtxr_head
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd_next"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
operator|.
name|vxtxr_next
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd_ndesc"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
operator|.
name|vxtxr_ndesc
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd_gen"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_cmd_ring
operator|.
name|vxtxr_gen
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"comp_next"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_comp_ring
operator|.
name|vxcr_next
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"comp_ndesc"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_comp_ring
operator|.
name|vxcr_ndesc
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"comp_gen"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|txq
operator|->
name|vxtxq_comp_ring
operator|.
name|vxcr_gen
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|vmxnet3_rxqueue
modifier|*
name|rxq
init|=
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
decl_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|rxq
operator|->
name|vxrxq_sysctl
argument_list|,
name|OID_AUTO
argument_list|,
literal|"debug"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|list
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd0_fill"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
operator|.
name|vxrxr_fill
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd0_ndesc"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
operator|.
name|vxrxr_ndesc
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd0_gen"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|0
index|]
operator|.
name|vxrxr_gen
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd1_fill"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|1
index|]
operator|.
name|vxrxr_fill
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd1_ndesc"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|1
index|]
operator|.
name|vxrxr_ndesc
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cmd1_gen"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_cmd_ring
index|[
literal|1
index|]
operator|.
name|vxrxr_gen
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"comp_next"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
operator|.
name|vxcr_next
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"comp_ndesc"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
operator|.
name|vxcr_ndesc
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|list
argument_list|,
name|OID_AUTO
argument_list|,
literal|"comp_gen"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|rxq
operator|->
name|vxrxq_comp_ring
operator|.
name|vxcr_gen
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_setup_queue_sysctl
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
parameter_list|,
name|struct
name|sysctl_oid_list
modifier|*
name|child
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_ntxqueues
condition|;
name|i
operator|++
control|)
name|vmxnet3_setup_txq_sysctl
argument_list|(
operator|&
name|sc
operator|->
name|vmx_txq
index|[
name|i
index|]
argument_list|,
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nrxqueues
condition|;
name|i
operator|++
control|)
name|vmxnet3_setup_rxq_sysctl
argument_list|(
operator|&
name|sc
operator|->
name|vmx_rxq
index|[
name|i
index|]
argument_list|,
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|vmxnet3_setup_debug_sysctl
argument_list|(
name|sc
argument_list|,
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_setup_sysctl
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|vmxnet3_statistics
modifier|*
name|stats
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|tree
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|child
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tree
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|child
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"max_ntxqueues"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vmx_max_ntxqueues
argument_list|,
literal|0
argument_list|,
literal|"Maximum number of Tx queues"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"max_nrxqueues"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vmx_max_nrxqueues
argument_list|,
literal|0
argument_list|,
literal|"Maximum number of Rx queues"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ntxqueues"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vmx_ntxqueues
argument_list|,
literal|0
argument_list|,
literal|"Number of Tx queues"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"nrxqueues"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vmx_nrxqueues
argument_list|,
literal|0
argument_list|,
literal|"Number of Rx queues"
argument_list|)
expr_stmt|;
name|stats
operator|=
operator|&
name|sc
operator|->
name|vmx_stats
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"defragged"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmst_defragged
argument_list|,
literal|0
argument_list|,
literal|"Tx mbuf chains defragged"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"defrag_failed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmst_defrag_failed
argument_list|,
literal|0
argument_list|,
literal|"Tx mbuf dropped because defrag failed"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mgetcl_failed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmst_mgetcl_failed
argument_list|,
literal|0
argument_list|,
literal|"mbuf cluster allocation failed"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"mbuf_load_failed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|vmst_mbuf_load_failed
argument_list|,
literal|0
argument_list|,
literal|"mbuf load segments failed"
argument_list|)
expr_stmt|;
name|vmxnet3_setup_queue_sysctl
argument_list|(
name|sc
argument_list|,
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_write_bar0
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|bus_size_t
name|r
parameter_list|,
name|uint32_t
name|v
parameter_list|)
block|{
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|vmx_iot0
argument_list|,
name|sc
operator|->
name|vmx_ioh0
argument_list|,
name|r
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|vmxnet3_read_bar1
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|bus_size_t
name|r
parameter_list|)
block|{
return|return
operator|(
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|vmx_iot1
argument_list|,
name|sc
operator|->
name|vmx_ioh1
argument_list|,
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_write_bar1
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|bus_size_t
name|r
parameter_list|,
name|uint32_t
name|v
parameter_list|)
block|{
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|vmx_iot1
argument_list|,
name|sc
operator|->
name|vmx_ioh1
argument_list|,
name|r
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_write_cmd
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|cmd
parameter_list|)
block|{
name|vmxnet3_write_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_CMD
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|vmxnet3_read_cmd
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|cmd
parameter_list|)
block|{
name|vmxnet3_write_cmd
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|bus_space_barrier
argument_list|(
name|sc
operator|->
name|vmx_iot1
argument_list|,
name|sc
operator|->
name|vmx_ioh1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_BARRIER_READ
operator||
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
return|return
operator|(
name|vmxnet3_read_bar1
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR1_CMD
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_enable_intr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
name|vmxnet3_write_bar0
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR0_IMASK
argument_list|(
name|irq
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_disable_intr
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|int
name|irq
parameter_list|)
block|{
name|vmxnet3_write_bar0
argument_list|(
name|sc
argument_list|,
name|VMXNET3_BAR0_IMASK
argument_list|(
name|irq
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_enable_all_intrs
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|vmx_ds
operator|->
name|ictrl
operator|&=
operator|~
name|VMXNET3_ICTRL_DISABLE_ALL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nintrs
condition|;
name|i
operator|++
control|)
name|vmxnet3_enable_intr
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_disable_all_intrs
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|vmx_ds
operator|->
name|ictrl
operator||=
name|VMXNET3_ICTRL_DISABLE_ALL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|vmx_nintrs
condition|;
name|i
operator|++
control|)
name|vmxnet3_disable_intr
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_dmamap_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|bus_addr_t
modifier|*
name|baddr
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
operator|*
name|baddr
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_dma_malloc
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|bus_size_t
name|size
parameter_list|,
name|bus_size_t
name|align
parameter_list|,
name|struct
name|vmxnet3_dma_alloc
modifier|*
name|dma
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dev
operator|=
name|sc
operator|->
name|vmx_dev
expr_stmt|;
name|bzero
argument_list|(
name|dma
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_dma_alloc
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
name|align
argument_list|,
literal|0
argument_list|,
comment|/* alignment, bounds */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|size
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|size
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|dma
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"bus_dma_tag_create failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|dma
operator|->
name|dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|dma
operator|->
name|dma_vaddr
argument_list|,
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|dma
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"bus_dmamem_alloc failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|dma
operator|->
name|dma_tag
argument_list|,
name|dma
operator|->
name|dma_map
argument_list|,
name|dma
operator|->
name|dma_vaddr
argument_list|,
name|size
argument_list|,
name|vmxnet3_dmamap_cb
argument_list|,
operator|&
name|dma
operator|->
name|dma_paddr
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"bus_dmamap_load failed: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|dma
operator|->
name|dma_size
operator|=
name|size
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|error
condition|)
name|vmxnet3_dma_free
argument_list|(
name|sc
argument_list|,
name|dma
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vmxnet3_dma_free
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vmxnet3_dma_alloc
modifier|*
name|dma
parameter_list|)
block|{
if|if
condition|(
name|dma
operator|->
name|dma_tag
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|dma
operator|->
name|dma_map
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|dma
operator|->
name|dma_tag
argument_list|,
name|dma
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|dma
operator|->
name|dma_tag
argument_list|,
name|dma
operator|->
name|dma_map
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dma
operator|->
name|dma_vaddr
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|dma
operator|->
name|dma_tag
argument_list|,
name|dma
operator|->
name|dma_vaddr
argument_list|,
name|dma
operator|->
name|dma_map
argument_list|)
expr_stmt|;
block|}
name|bus_dma_tag_destroy
argument_list|(
name|dma
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
name|dma
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vmxnet3_dma_alloc
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vmxnet3_tunable_int
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|char
modifier|*
name|knob
parameter_list|,
name|int
name|def
parameter_list|)
block|{
name|char
name|path
index|[
literal|64
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"hw.vmx.%d.%s"
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|vmx_dev
argument_list|)
argument_list|,
name|knob
argument_list|)
expr_stmt|;
name|TUNABLE_INT_FETCH
argument_list|(
name|path
argument_list|,
operator|&
name|def
argument_list|)
expr_stmt|;
return|return
operator|(
name|def
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Since this is a purely paravirtualized device, we do not have  * to worry about DMA coherency. But at times, we must make sure  * both the compiler and CPU do not reorder memory operations.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|vmxnet3_barrier
parameter_list|(
name|struct
name|vmxnet3_softc
modifier|*
name|sc
parameter_list|,
name|vmxnet3_barrier_t
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|VMXNET3_BARRIER_RD
case|:
name|rmb
argument_list|()
expr_stmt|;
break|break;
case|case
name|VMXNET3_BARRIER_WR
case|:
name|wmb
argument_list|()
expr_stmt|;
break|break;
case|case
name|VMXNET3_BARRIER_RDWR
case|:
name|mb
argument_list|()
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: bad barrier type %d"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2010, LSI Corp.  * All rights reserved.  * Author : Manjunath Ranganathaiah  * Support: freebsdraid@lsi.com  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  * 3. Neither the name of the<ORGANIZATION> nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE  * COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<dev/tws/tws.h>
end_include

begin_include
include|#
directive|include
file|<dev/tws/tws_services.h>
end_include

begin_include
include|#
directive|include
file|<dev/tws/tws_hdm.h>
end_include

begin_include
include|#
directive|include
file|<dev/tws/tws_user.h>
end_include

begin_function_decl
name|int
name|tws_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|long
name|unsigned
name|int
name|cmd
parameter_list|,
name|caddr_t
name|buf
parameter_list|,
name|int
name|flags
parameter_list|,
name|d_thread_t
modifier|*
name|proc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|tws_passthru_complete
parameter_list|(
name|struct
name|tws_request
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|tws_circular_aenq_insert
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|tws_circular_q
modifier|*
name|cq
parameter_list|,
name|struct
name|tws_event_packet
modifier|*
name|aen
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tws_passthru
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tws_ioctl_aen
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|tws_bus_scan
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|struct
name|tws_request
modifier|*
name|tws_get_request
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|u_int16_t
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int32_t
name|tws_map_request
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|tws_request
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|tws_unmap_request
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|tws_request
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|uint8_t
name|tws_get_state
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|void
name|tws_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|tws_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|buf
parameter_list|,
name|int
name|flags
parameter_list|,
name|d_thread_t
modifier|*
name|proc
parameter_list|)
block|{
name|struct
name|tws_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|tws_softc
operator|*
operator|)
operator|(
name|dev
operator|->
name|si_drv1
operator|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"entry"
argument_list|,
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|sc
operator|->
name|stats
operator|.
name|ioctls
operator|++
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|TWS_IOCTL_FIRMWARE_PASS_THROUGH
case|:
name|error
operator|=
name|tws_passthru
argument_list|(
name|sc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
name|TWS_IOCTL_SCAN_BUS
case|:
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"scan-bus"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|sim_lock
argument_list|)
expr_stmt|;
name|error
operator|=
name|tws_bus_scan
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|sim_lock
argument_list|)
expr_stmt|;
break|break;
default|default :
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"ioctl-aen"
argument_list|,
name|cmd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|error
operator|=
name|tws_ioctl_aen
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tws_passthru
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|tws_request
modifier|*
name|req
decl_stmt|;
name|struct
name|tws_ioctl_no_data_buf
modifier|*
name|ubuf
init|=
operator|(
expr|struct
name|tws_ioctl_no_data_buf
operator|*
operator|)
name|buf
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int16_t
name|lun4
decl_stmt|;
if|if
condition|(
name|tws_get_state
argument_list|(
name|sc
argument_list|)
operator|!=
name|TWS_ONLINE
condition|)
block|{
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
comment|//==============================================================================================
comment|// Get a command
comment|//
do|do
block|{
name|req
operator|=
name|tws_get_request
argument_list|(
name|sc
argument_list|,
name|TWS_REQ_TYPE_PASSTHRU
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
block|{
name|error
operator|=
name|tsleep
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|"tws_sleep"
argument_list|,
name|TWS_IOCTL_TIMEOUT
operator|*
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|EWOULDBLOCK
condition|)
block|{
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
block|}
else|else
block|{
comment|// Make sure we are still ready for new commands...
if|if
condition|(
name|tws_get_state
argument_list|(
name|sc
argument_list|)
operator|!=
name|TWS_ONLINE
condition|)
block|{
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
break|break;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|req
operator|->
name|length
operator|=
operator|(
name|ubuf
operator|->
name|driver_pkt
operator|.
name|buffer_length
operator|+
literal|511
operator|)
operator|&
operator|~
literal|511
expr_stmt|;
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"datal,rid"
argument_list|,
name|req
operator|->
name|length
argument_list|,
name|req
operator|->
name|request_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|length
condition|)
block|{
name|req
operator|->
name|data
operator|=
name|sc
operator|->
name|ioctl_data_mem
expr_stmt|;
name|req
operator|->
name|dma_map
operator|=
name|sc
operator|->
name|ioctl_data_map
expr_stmt|;
comment|//==========================================================================================
comment|// Copy data in from user space
comment|//
name|error
operator|=
name|copyin
argument_list|(
name|ubuf
operator|->
name|pdata
argument_list|,
name|req
operator|->
name|data
argument_list|,
name|req
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
comment|//==============================================================================================
comment|// Set command fields
comment|//
name|req
operator|->
name|flags
operator|=
name|TWS_DIR_IN
operator||
name|TWS_DIR_OUT
expr_stmt|;
name|req
operator|->
name|cb
operator|=
name|tws_passthru_complete
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|req
operator|->
name|cmd_pkt
operator|->
name|cmd
argument_list|,
operator|&
name|ubuf
operator|->
name|cmd_pkt
operator|.
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_command_apache
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET_OPCODE
argument_list|(
name|req
operator|->
name|cmd_pkt
operator|->
name|cmd
operator|.
name|pkt_a
operator|.
name|res__opcode
argument_list|)
operator|==
name|TWS_FW_CMD_EXECUTE_SCSI
condition|)
block|{
name|lun4
operator|=
name|req
operator|->
name|cmd_pkt
operator|->
name|cmd
operator|.
name|pkt_a
operator|.
name|lun_l4__req_id
operator|&
literal|0xF000
expr_stmt|;
name|req
operator|->
name|cmd_pkt
operator|->
name|cmd
operator|.
name|pkt_a
operator|.
name|lun_l4__req_id
operator|=
name|lun4
operator||
name|req
operator|->
name|request_id
expr_stmt|;
block|}
else|else
block|{
name|req
operator|->
name|cmd_pkt
operator|->
name|cmd
operator|.
name|pkt_g
operator|.
name|generic
operator|.
name|request_id
operator|=
operator|(
name|u_int8_t
operator|)
name|req
operator|->
name|request_id
expr_stmt|;
block|}
comment|//==============================================================================================
comment|// Send command to controller
comment|//
name|error
operator|=
name|tws_map_request
argument_list|(
name|sc
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ubuf
operator|->
name|driver_pkt
operator|.
name|os_status
operator|=
name|error
expr_stmt|;
goto|goto
name|out_data
goto|;
block|}
if|if
condition|(
name|req
operator|->
name|state
operator|==
name|TWS_REQ_STATE_COMPLETE
condition|)
block|{
name|ubuf
operator|->
name|driver_pkt
operator|.
name|os_status
operator|=
name|req
operator|->
name|error_code
expr_stmt|;
goto|goto
name|out_unmap
goto|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|gen_lock
argument_list|)
expr_stmt|;
name|error
operator|=
name|mtx_sleep
argument_list|(
name|req
argument_list|,
operator|&
name|sc
operator|->
name|gen_lock
argument_list|,
literal|0
argument_list|,
literal|"tws_passthru"
argument_list|,
name|TWS_IOCTL_TIMEOUT
operator|*
name|hz
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|gen_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|req
operator|->
name|state
operator|!=
name|TWS_REQ_STATE_COMPLETE
operator|)
operator|&&
operator|(
name|error
operator|==
name|EWOULDBLOCK
operator|)
condition|)
block|{
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"msleep timeout"
argument_list|,
name|error
argument_list|,
name|req
operator|->
name|request_id
argument_list|)
expr_stmt|;
name|tws_timeout
argument_list|(
operator|(
name|void
operator|*
operator|)
name|req
argument_list|)
expr_stmt|;
block|}
name|out_unmap
label|:
if|if
condition|(
name|req
operator|->
name|error_code
operator|==
name|TWS_REQ_RET_RESET
condition|)
block|{
name|error
operator|=
name|EBUSY
expr_stmt|;
name|req
operator|->
name|error_code
operator|=
name|EBUSY
expr_stmt|;
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"ioctl reset"
argument_list|,
name|error
argument_list|,
name|req
operator|->
name|request_id
argument_list|)
expr_stmt|;
block|}
name|tws_unmap_request
argument_list|(
name|sc
argument_list|,
name|req
argument_list|)
expr_stmt|;
comment|//==============================================================================================
comment|// Return command status to user space
comment|//
name|memcpy
argument_list|(
operator|&
name|ubuf
operator|->
name|cmd_pkt
operator|.
name|hdr
argument_list|,
operator|&
name|req
operator|->
name|cmd_pkt
operator|->
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_command_apache
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ubuf
operator|->
name|cmd_pkt
operator|.
name|cmd
argument_list|,
operator|&
name|req
operator|->
name|cmd_pkt
operator|->
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_command_apache
argument_list|)
argument_list|)
expr_stmt|;
name|out_data
label|:
if|if
condition|(
name|req
operator|->
name|length
condition|)
block|{
comment|//==========================================================================================
comment|// Copy data out to user space
comment|//
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|copyout
argument_list|(
name|req
operator|->
name|data
argument_list|,
name|ubuf
operator|->
name|pdata
argument_list|,
name|ubuf
operator|->
name|driver_pkt
operator|.
name|buffer_length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"errored"
argument_list|,
name|error
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|error_code
operator|!=
name|TWS_REQ_RET_SUBMIT_SUCCESS
condition|)
name|ubuf
operator|->
name|driver_pkt
operator|.
name|os_status
operator|=
name|error
expr_stmt|;
comment|//==============================================================================================
comment|// Free command
comment|//
name|req
operator|->
name|state
operator|=
name|TWS_REQ_STATE_FREE
expr_stmt|;
name|wakeup_one
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tws_passthru_complete
parameter_list|(
name|struct
name|tws_request
modifier|*
name|req
parameter_list|)
block|{
name|req
operator|->
name|state
operator|=
name|TWS_REQ_STATE_COMPLETE
expr_stmt|;
name|wakeup_one
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tws_retrive_aen
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|struct
name|tws_ioctl_packet
modifier|*
name|ubuf
parameter_list|)
block|{
name|u_int16_t
name|index
init|=
literal|0
decl_stmt|;
name|struct
name|tws_event_packet
name|eventp
decl_stmt|,
modifier|*
name|qp
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|aen_q
operator|.
name|head
operator|==
name|sc
operator|->
name|aen_q
operator|.
name|tail
condition|)
block|{
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
name|TWS_AEN_NO_EVENTS
expr_stmt|;
return|return;
block|}
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
literal|0
expr_stmt|;
comment|/*       * once this flag is set cli will not display alarms       * needs a revisit from tools?      */
if|if
condition|(
name|sc
operator|->
name|aen_q
operator|.
name|overflow
condition|)
block|{
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
name|TWS_AEN_OVERFLOW
expr_stmt|;
name|sc
operator|->
name|aen_q
operator|.
name|overflow
operator|=
literal|0
expr_stmt|;
comment|/* reset */
block|}
name|qp
operator|=
operator|(
expr|struct
name|tws_event_packet
operator|*
operator|)
name|sc
operator|->
name|aen_q
operator|.
name|q
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|TWS_IOCTL_GET_FIRST_EVENT
case|:
name|index
operator|=
name|sc
operator|->
name|aen_q
operator|.
name|head
expr_stmt|;
break|break;
case|case
name|TWS_IOCTL_GET_LAST_EVENT
case|:
comment|/* index = tail-1 */
name|index
operator|=
operator|(
name|sc
operator|->
name|aen_q
operator|.
name|depth
operator|+
name|sc
operator|->
name|aen_q
operator|.
name|tail
operator|-
literal|1
operator|)
operator|%
name|sc
operator|->
name|aen_q
operator|.
name|depth
expr_stmt|;
break|break;
case|case
name|TWS_IOCTL_GET_NEXT_EVENT
case|:
name|memcpy
argument_list|(
operator|&
name|eventp
argument_list|,
name|ubuf
operator|->
name|data_buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_event_packet
argument_list|)
argument_list|)
expr_stmt|;
name|index
operator|=
name|sc
operator|->
name|aen_q
operator|.
name|head
expr_stmt|;
do|do
block|{
if|if
condition|(
name|qp
index|[
name|index
index|]
operator|.
name|sequence_id
operator|==
operator|(
name|eventp
operator|.
name|sequence_id
operator|+
literal|1
operator|)
condition|)
break|break;
name|index
operator|=
operator|(
name|index
operator|+
literal|1
operator|)
operator|%
name|sc
operator|->
name|aen_q
operator|.
name|depth
expr_stmt|;
block|}
do|while
condition|(
name|index
operator|!=
name|sc
operator|->
name|aen_q
operator|.
name|tail
condition|)
do|;
if|if
condition|(
name|index
operator|==
name|sc
operator|->
name|aen_q
operator|.
name|tail
condition|)
block|{
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
name|TWS_AEN_NO_EVENTS
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|TWS_IOCTL_GET_PREVIOUS_EVENT
case|:
name|memcpy
argument_list|(
operator|&
name|eventp
argument_list|,
name|ubuf
operator|->
name|data_buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_event_packet
argument_list|)
argument_list|)
expr_stmt|;
name|index
operator|=
name|sc
operator|->
name|aen_q
operator|.
name|head
expr_stmt|;
do|do
block|{
if|if
condition|(
name|qp
index|[
name|index
index|]
operator|.
name|sequence_id
operator|==
operator|(
name|eventp
operator|.
name|sequence_id
operator|-
literal|1
operator|)
condition|)
break|break;
name|index
operator|=
operator|(
name|index
operator|+
literal|1
operator|)
operator|%
name|sc
operator|->
name|aen_q
operator|.
name|depth
expr_stmt|;
block|}
do|while
condition|(
name|index
operator|!=
name|sc
operator|->
name|aen_q
operator|.
name|tail
condition|)
do|;
if|if
condition|(
name|index
operator|==
name|sc
operator|->
name|aen_q
operator|.
name|tail
condition|)
block|{
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
name|TWS_AEN_NO_EVENTS
expr_stmt|;
return|return;
block|}
break|break;
default|default :
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"not a valid event"
argument_list|,
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
name|TWS_AEN_NO_EVENTS
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
name|ubuf
operator|->
name|data_buf
argument_list|,
operator|&
name|qp
index|[
name|index
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_event_packet
argument_list|)
argument_list|)
expr_stmt|;
name|qp
index|[
name|index
index|]
operator|.
name|retrieved
operator|=
name|TWS_AEN_RETRIEVED
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|tws_ioctl_aen
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|tws_ioctl_packet
modifier|*
name|ubuf
init|=
operator|(
expr|struct
name|tws_ioctl_packet
operator|*
operator|)
name|buf
decl_stmt|;
name|struct
name|tws_compatibility_packet
name|cpkt
decl_stmt|;
name|struct
name|tws_lock_packet
name|lpkt
decl_stmt|;
name|time_t
name|ctime
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|gen_lock
argument_list|)
expr_stmt|;
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|TWS_IOCTL_GET_FIRST_EVENT
case|:
case|case
name|TWS_IOCTL_GET_LAST_EVENT
case|:
case|case
name|TWS_IOCTL_GET_NEXT_EVENT
case|:
case|case
name|TWS_IOCTL_GET_PREVIOUS_EVENT
case|:
name|tws_retrive_aen
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|,
name|ubuf
argument_list|)
expr_stmt|;
break|break;
case|case
name|TWS_IOCTL_GET_LOCK
case|:
name|ctime
operator|=
name|TWS_LOCAL_TIME
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|lpkt
argument_list|,
name|ubuf
operator|->
name|data_buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_lock_packet
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|ioctl_lock
operator|.
name|lock
operator|==
name|TWS_IOCTL_LOCK_FREE
operator|)
operator|||
operator|(
name|lpkt
operator|.
name|force_flag
operator|)
operator|||
operator|(
name|ctime
operator|>=
name|sc
operator|->
name|ioctl_lock
operator|.
name|timeout
operator|)
condition|)
block|{
name|sc
operator|->
name|ioctl_lock
operator|.
name|lock
operator|=
name|TWS_IOCTL_LOCK_HELD
expr_stmt|;
name|sc
operator|->
name|ioctl_lock
operator|.
name|timeout
operator|=
name|ctime
operator|+
operator|(
name|lpkt
operator|.
name|timeout_msec
operator|/
literal|1000
operator|)
expr_stmt|;
name|lpkt
operator|.
name|time_remaining_msec
operator|=
name|lpkt
operator|.
name|timeout_msec
expr_stmt|;
block|}
else|else
block|{
name|lpkt
operator|.
name|time_remaining_msec
operator|=
call|(
name|u_int32_t
call|)
argument_list|(
operator|(
name|sc
operator|->
name|ioctl_lock
operator|.
name|timeout
operator|-
name|ctime
operator|)
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
name|TWS_IOCTL_LOCK_ALREADY_HELD
expr_stmt|;
block|}
break|break;
case|case
name|TWS_IOCTL_RELEASE_LOCK
case|:
if|if
condition|(
name|sc
operator|->
name|ioctl_lock
operator|.
name|lock
operator|==
name|TWS_IOCTL_LOCK_FREE
condition|)
block|{
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
name|TWS_IOCTL_LOCK_NOT_HELD
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|ioctl_lock
operator|.
name|lock
operator|=
name|TWS_IOCTL_LOCK_FREE
expr_stmt|;
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|TWS_IOCTL_GET_COMPATIBILITY_INFO
case|:
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"get comp info"
argument_list|,
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cpkt
operator|.
name|driver_version
argument_list|,
name|TWS_DRIVER_VERSION_STRING
argument_list|,
sizeof|sizeof
argument_list|(
name|TWS_DRIVER_VERSION_STRING
argument_list|)
argument_list|)
expr_stmt|;
name|cpkt
operator|.
name|working_srl
operator|=
name|sc
operator|->
name|cinfo
operator|.
name|working_srl
expr_stmt|;
name|cpkt
operator|.
name|working_branch
operator|=
name|sc
operator|->
name|cinfo
operator|.
name|working_branch
expr_stmt|;
name|cpkt
operator|.
name|working_build
operator|=
name|sc
operator|->
name|cinfo
operator|.
name|working_build
expr_stmt|;
name|cpkt
operator|.
name|driver_srl_high
operator|=
name|TWS_CURRENT_FW_SRL
expr_stmt|;
name|cpkt
operator|.
name|driver_branch_high
operator|=
name|TWS_CURRENT_FW_BRANCH
expr_stmt|;
name|cpkt
operator|.
name|driver_build_high
operator|=
name|TWS_CURRENT_FW_BUILD
expr_stmt|;
name|cpkt
operator|.
name|driver_srl_low
operator|=
name|TWS_BASE_FW_SRL
expr_stmt|;
name|cpkt
operator|.
name|driver_branch_low
operator|=
name|TWS_BASE_FW_BRANCH
expr_stmt|;
name|cpkt
operator|.
name|driver_build_low
operator|=
name|TWS_BASE_FW_BUILD
expr_stmt|;
name|cpkt
operator|.
name|fw_on_ctlr_srl
operator|=
name|sc
operator|->
name|cinfo
operator|.
name|fw_on_ctlr_srl
expr_stmt|;
name|cpkt
operator|.
name|fw_on_ctlr_branch
operator|=
name|sc
operator|->
name|cinfo
operator|.
name|fw_on_ctlr_branch
expr_stmt|;
name|cpkt
operator|.
name|fw_on_ctlr_build
operator|=
name|sc
operator|->
name|cinfo
operator|.
name|fw_on_ctlr_build
expr_stmt|;
name|ubuf
operator|->
name|driver_pkt
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|tws_compatibility_packet
argument_list|)
decl_stmt|;
if|if
condition|(
name|ubuf
operator|->
name|driver_pkt
operator|.
name|buffer_length
operator|<
name|len
condition|)
name|len
operator|=
name|ubuf
operator|->
name|driver_pkt
operator|.
name|buffer_length
expr_stmt|;
name|memcpy
argument_list|(
name|ubuf
operator|->
name|data_buf
argument_list|,
operator|&
name|cpkt
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default :
name|TWS_TRACE_DEBUG
argument_list|(
name|sc
argument_list|,
literal|"not valid cmd"
argument_list|,
name|cmd
argument_list|,
name|TWS_IOCTL_GET_COMPATIBILITY_INFO
argument_list|)
expr_stmt|;
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|gen_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tws_circular_aenq_insert
parameter_list|(
name|struct
name|tws_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|tws_circular_q
modifier|*
name|cq
parameter_list|,
name|struct
name|tws_event_packet
modifier|*
name|aen
parameter_list|)
block|{
name|struct
name|tws_event_packet
modifier|*
name|q
init|=
operator|(
expr|struct
name|tws_event_packet
operator|*
operator|)
name|cq
operator|->
name|q
decl_stmt|;
specifier|volatile
name|u_int16_t
name|head
decl_stmt|,
name|tail
decl_stmt|;
name|u_int8_t
name|retr
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sc
operator|->
name|gen_lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|head
operator|=
name|cq
operator|->
name|head
expr_stmt|;
name|tail
operator|=
name|cq
operator|->
name|tail
expr_stmt|;
name|retr
operator|=
name|q
index|[
name|tail
index|]
operator|.
name|retrieved
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|q
index|[
name|tail
index|]
argument_list|,
name|aen
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tws_event_packet
argument_list|)
argument_list|)
expr_stmt|;
name|tail
operator|=
operator|(
name|tail
operator|+
literal|1
operator|)
operator|%
name|cq
operator|->
name|depth
expr_stmt|;
if|if
condition|(
name|head
operator|==
name|tail
condition|)
block|{
comment|/* q is full */
if|if
condition|(
name|retr
operator|!=
name|TWS_AEN_RETRIEVED
condition|)
name|cq
operator|->
name|overflow
operator|=
literal|1
expr_stmt|;
name|cq
operator|->
name|head
operator|=
operator|(
name|head
operator|+
literal|1
operator|)
operator|%
name|cq
operator|->
name|depth
expr_stmt|;
block|}
name|cq
operator|->
name|tail
operator|=
name|tail
expr_stmt|;
block|}
end_function

end_unit


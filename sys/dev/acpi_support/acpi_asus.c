begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2004, 2005 Philip Paeps<philip@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for extra ACPI-controlled gadgets (hotkeys, leds, etc) found on  * recent Asus (and Medion) laptops.  Inspired by the acpi4asus project which  * implements these features in the Linux kernel.  *  *<http://sourceforge.net/projects/acpi4asus/>  *  * Currently should support most features, but could use some more testing.  * Particularly the display-switching stuff is a bit hairy.  If you have an  * Asus laptop which doesn't appear to be supported, or strange things happen  * when using this driver, please report to<acpi@FreeBSD.org>.  */
end_comment

begin_include
include|#
directive|include
file|"opt_acpi.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/acpi.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/led/led.h>
end_include

begin_comment
comment|/* Methods */
end_comment

begin_define
define|#
directive|define
name|ACPI_ASUS_METHOD_BRN
value|1
end_define

begin_define
define|#
directive|define
name|ACPI_ASUS_METHOD_DISP
value|2
end_define

begin_define
define|#
directive|define
name|ACPI_ASUS_METHOD_LCD
value|3
end_define

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_OEM
end_define

begin_macro
name|ACPI_MODULE_NAME
argument_list|(
literal|"ASUS"
argument_list|)
end_macro

begin_struct
struct|struct
name|acpi_asus_model
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|bled_set
decl_stmt|;
name|char
modifier|*
name|mled_set
decl_stmt|;
name|char
modifier|*
name|tled_set
decl_stmt|;
name|char
modifier|*
name|wled_set
decl_stmt|;
name|char
modifier|*
name|brn_get
decl_stmt|;
name|char
modifier|*
name|brn_set
decl_stmt|;
name|char
modifier|*
name|brn_up
decl_stmt|;
name|char
modifier|*
name|brn_dn
decl_stmt|;
name|char
modifier|*
name|lcd_get
decl_stmt|;
name|char
modifier|*
name|lcd_set
decl_stmt|;
name|char
modifier|*
name|disp_get
decl_stmt|;
name|char
modifier|*
name|disp_set
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|acpi_asus_led
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|cdev
modifier|*
name|cdev
decl_stmt|;
name|int
name|busy
decl_stmt|;
name|int
name|state
decl_stmt|;
enum|enum
block|{
name|ACPI_ASUS_LED_BLED
block|,
name|ACPI_ASUS_LED_MLED
block|,
name|ACPI_ASUS_LED_TLED
block|,
name|ACPI_ASUS_LED_WLED
block|, 	}
name|type
enum|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|acpi_asus_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|ACPI_HANDLE
name|handle
decl_stmt|;
name|struct
name|acpi_asus_model
modifier|*
name|model
decl_stmt|;
name|struct
name|sysctl_ctx_list
name|sysctl_ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|sysctl_tree
decl_stmt|;
name|struct
name|acpi_asus_led
name|s_bled
decl_stmt|;
name|struct
name|acpi_asus_led
name|s_mled
decl_stmt|;
name|struct
name|acpi_asus_led
name|s_tled
decl_stmt|;
name|struct
name|acpi_asus_led
name|s_wled
decl_stmt|;
name|int
name|s_brn
decl_stmt|;
name|int
name|s_disp
decl_stmt|;
name|int
name|s_lcd
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * We can identify Asus laptops from the string they return  * as a result of calling the ATK0100 'INIT' method.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|acpi_asus_model
name|acpi_asus_models
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"xxN"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLT"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|disp_get
operator|=
literal|"\\ADVG"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"A1x"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLI"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.ISA.EC0._Q10"
block|,
operator|.
name|brn_up
operator|=
literal|"\\_SB.PCI0.ISA.EC0._Q0E"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\_SB.PCI0.ISA.EC0._Q0F"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"A2x"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BAOF"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q10"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|disp_get
operator|=
literal|"\\INFB"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"A4D"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|brn_up
operator|=
literal|"\\_SB_.PCI0.SBRG.EC0._Q0E"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\_SB_.PCI0.SBRG.EC0._Q0F"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
ifdef|#
directive|ifdef
name|notyet
operator|.
name|disp_get
operator|=
literal|"\\_SB_.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|disp_set
operator|=
literal|"\\_SB_.PCI0.SBRG.EC0._Q11"
endif|#
directive|endif
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"A6V"
block|,
operator|.
name|bled_set
operator|=
literal|"BLED"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|lcd_get
operator|=
name|NULL
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|disp_get
operator|=
literal|"\\_SB.PCI0.P0P3.VGA.GETD"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"D1x"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\GP11"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q0D"
block|,
operator|.
name|brn_up
operator|=
literal|"\\Q0C"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\Q0B"
block|,
operator|.
name|disp_get
operator|=
literal|"\\INFB"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L2D"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_up
operator|=
literal|"\\Q0E"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\Q0F"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\SGP0"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L3C"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\GL32"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.PX40.ECD0._Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L3D"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLG"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L3H"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\_SB.PCI0.PM.PBC"
block|,
operator|.
name|lcd_set
operator|=
literal|"EHK"
block|,
operator|.
name|disp_get
operator|=
literal|"\\_SB.INFB"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L4R"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\_SB.PCI0.SBSM.SEO4"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|disp_get
operator|=
literal|"\\_SB.PCI0.P0P1.VGA.GETD"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L5x"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|tled_set
operator|=
literal|"TLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BAOF"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q0D"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|disp_get
operator|=
literal|"\\INFB"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"L8L"
comment|/* Only has hotkeys, apparantly */
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"M1A"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|brn_up
operator|=
literal|"\\_SB.PCI0.PX40.EC0.Q0E"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\_SB.PCI0.PX40.EC0.Q0F"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\PNOF"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.PX40.EC0.Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"M2E"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\GP06"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\Q10"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"M6N"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\_SB.BKLT"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|,
operator|.
name|disp_get
operator|=
literal|"\\SSTE"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"M6R"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\_SB.PCI0.SBSM.SEO4"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|disp_get
operator|=
literal|"\\SSTE"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"S1x"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\PNOF"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.PX40.Q10"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"S2x"
block|,
operator|.
name|mled_set
operator|=
literal|"MLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLI"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.ISA.EC0._Q10"
block|,
operator|.
name|brn_up
operator|=
literal|"\\_SB.PCI0.ISA.EC0._Q0B"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\_SB.PCI0.ISA.EC0._Q0A"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"V6V"
block|,
operator|.
name|bled_set
operator|=
literal|"BLED"
block|,
operator|.
name|tled_set
operator|=
literal|"TLED"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLT"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|disp_get
operator|=
literal|"\\_SB.PCI0.P0P1.VGA.GETD"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"W5A"
block|,
operator|.
name|bled_set
operator|=
literal|"BLED"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLT"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.SBRG.EC0._Q10"
block|,
operator|.
name|brn_get
operator|=
literal|"GPLV"
block|,
operator|.
name|brn_set
operator|=
literal|"SPLV"
block|,
operator|.
name|disp_get
operator|=
literal|"\\_SB.PCI0.P0P2.VGA.GETD"
block|,
operator|.
name|disp_set
operator|=
literal|"SDSP"
block|}
block|,
block|{
operator|.
name|name
operator|=
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Samsung P30/P35 laptops have an Asus ATK0100 gadget interface,  * but they can't be probed quite the same way as Asus laptops.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|acpi_asus_model
name|acpi_samsung_models
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"P30"
block|,
operator|.
name|wled_set
operator|=
literal|"WLED"
block|,
operator|.
name|brn_up
operator|=
literal|"\\_SB.PCI0.LPCB.EC0._Q68"
block|,
operator|.
name|brn_dn
operator|=
literal|"\\_SB.PCI0.LPCB.EC0._Q69"
block|,
operator|.
name|lcd_get
operator|=
literal|"\\BKLT"
block|,
operator|.
name|lcd_set
operator|=
literal|"\\_SB.PCI0.LPCB.EC0._Q0E"
block|}
block|,
block|{
operator|.
name|name
operator|=
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|description
decl_stmt|;
name|int
name|method
decl_stmt|;
block|}
name|acpi_asus_sysctls
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"lcd_backlight"
block|,
operator|.
name|method
operator|=
name|ACPI_ASUS_METHOD_LCD
block|,
operator|.
name|description
operator|=
literal|"state of the lcd backlight"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"lcd_brightness"
block|,
operator|.
name|method
operator|=
name|ACPI_ASUS_METHOD_BRN
block|,
operator|.
name|description
operator|=
literal|"brightness of the lcd panel"
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"video_output"
block|,
operator|.
name|method
operator|=
name|ACPI_ASUS_METHOD_DISP
block|,
operator|.
name|description
operator|=
literal|"display output state"
block|}
block|,
block|{
operator|.
name|name
operator|=
name|NULL
block|}
block|}
struct|;
end_struct

begin_expr_stmt
name|ACPI_SERIAL_DECL
argument_list|(
name|asus
argument_list|,
literal|"ACPI ASUS extras"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Function prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|acpi_asus_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_asus_led
parameter_list|(
name|struct
name|acpi_asus_led
modifier|*
name|led
parameter_list|,
name|int
name|state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_asus_led_task
parameter_list|(
name|struct
name|acpi_asus_led
modifier|*
name|led
parameter_list|,
name|int
name|pending
name|__unused
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_sysctl_init
parameter_list|(
name|struct
name|acpi_asus_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_sysctl_get
parameter_list|(
name|struct
name|acpi_asus_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_asus_sysctl_set
parameter_list|(
name|struct
name|acpi_asus_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_asus_notify
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|acpi_asus_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|acpi_asus_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|acpi_asus_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|acpi_asus_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|acpi_asus_driver
init|=
block|{
literal|"acpi_asus"
block|,
name|acpi_asus_methods
block|,
expr|sizeof
operator|(
expr|struct
name|acpi_asus_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|acpi_asus_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|acpi_asus
argument_list|,
name|acpi
argument_list|,
name|acpi_asus_driver
argument_list|,
name|acpi_asus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|acpi_asus
argument_list|,
name|acpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|acpi_asus_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_asus_model
modifier|*
name|model
decl_stmt|;
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sbuf
modifier|*
name|sb
decl_stmt|;
name|ACPI_BUFFER
name|Buf
decl_stmt|;
name|ACPI_OBJECT
name|Arg
decl_stmt|,
modifier|*
name|Obj
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
specifier|static
name|char
modifier|*
name|asus_ids
index|[]
init|=
block|{
literal|"ATK0100"
block|,
name|NULL
block|}
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|acpi_disabled
argument_list|(
literal|"asus"
argument_list|)
operator|||
name|ACPI_ID_PROBE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|asus_ids
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|handle
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|Arg
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
operator|&
name|Arg
expr_stmt|;
name|Buf
operator|.
name|Pointer
operator|=
name|NULL
expr_stmt|;
name|Buf
operator|.
name|Length
operator|=
name|ACPI_ALLOCATE_BUFFER
expr_stmt|;
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
literal|"INIT"
argument_list|,
operator|&
name|Args
argument_list|,
operator|&
name|Buf
argument_list|)
expr_stmt|;
name|Obj
operator|=
name|Buf
operator|.
name|Pointer
expr_stmt|;
comment|/* 	 * The Samsung P30 returns a null-pointer from INIT, we 	 * can identify it from the 'ODEM' string in the DSDT. 	 */
if|if
condition|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
operator|==
name|NULL
condition|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_TABLE_HEADER
name|th
decl_stmt|;
name|status
operator|=
name|AcpiGetTableHeader
argument_list|(
name|ACPI_SIG_DSDT
argument_list|,
literal|0
argument_list|,
operator|&
name|th
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unsupported (Samsung?) laptop\n"
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|Buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
literal|"ODEM"
argument_list|,
name|th
operator|.
name|OemTableId
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|model
operator|=
operator|&
name|acpi_samsung_models
index|[
literal|0
index|]
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Samsung P30 Laptop Extras"
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|Buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|sb
operator|=
name|sbuf_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
expr_stmt|;
if|if
condition|(
name|sb
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* 	 * Asus laptops are simply identified by name, easy! 	 */
for|for
control|(
name|model
operator|=
name|acpi_asus_models
init|;
name|model
operator|->
name|name
operator|!=
name|NULL
condition|;
name|model
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
name|model
operator|->
name|name
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|good
label|:
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"Asus %s Laptop Extras"
argument_list|,
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|sc
operator|->
name|model
operator|=
name|model
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|sbuf_data
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|Buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* 		 * Some models look exactly the same as other models, but have 		 * their own ids.  If we spot these, set them up with the same 		 * details as the models they're like, possibly dealing with 		 * small differences. 		 * 		 * XXX: there must be a prettier way to do this! 		 */
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"xxN"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"M3N"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"S1N"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|)
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"A1x"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"A1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"A2x"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"A2"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"D1x"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"D1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"L3H"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"L2E"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"L5x"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"L5"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"M2E"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"M2"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"L4E"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|)
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"S1x"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"L8"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"S1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|)
condition|)
goto|goto
name|good
goto|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"S2x"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"J1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"S2"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|)
condition|)
goto|goto
name|good
goto|;
comment|/* L2B is like L3C but has no lcd_get method */
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"L3C"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"L2B"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|model
operator|->
name|lcd_get
operator|=
name|NULL
expr_stmt|;
goto|goto
name|good
goto|;
block|}
comment|/* A3G is like M6R but with a different lcd_get method */
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"M6R"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"A3G"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|model
operator|->
name|lcd_get
operator|=
literal|"\\BLFG"
expr_stmt|;
goto|goto
name|good
goto|;
block|}
comment|/* M2N and W1N are like xxN with added WLED */
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"xxN"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"M2N"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"W1N"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|model
operator|->
name|wled_set
operator|=
literal|"WLED"
expr_stmt|;
goto|goto
name|good
goto|;
block|}
comment|/* M5N and S5N are like xxN without MLED */
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|model
operator|->
name|name
argument_list|,
literal|"xxN"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"M5N"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
literal|"S5N"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|model
operator|->
name|mled_set
operator|=
name|NULL
expr_stmt|;
goto|goto
name|good
goto|;
block|}
block|}
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"Unsupported Asus laptop: %s\n"
argument_list|,
name|Obj
operator|->
name|String
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
name|sbuf_data
argument_list|(
name|sb
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|Buf
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_softc
modifier|*
name|acpi_sc
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|acpi_sc
operator|=
name|acpi_device_get_parent_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Build sysctl tree */
name|sysctl_ctx_init
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sysctl_tree
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|acpi_sc
operator|->
name|acpi_sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"asus"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* Hook up nodes */
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|acpi_asus_sysctls
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|acpi_asus_sysctl_init
argument_list|(
name|sc
argument_list|,
name|acpi_asus_sysctls
index|[
name|i
index|]
operator|.
name|method
argument_list|)
condition|)
continue|continue;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|acpi_asus_sysctls
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
operator||
name|CTLFLAG_ANYBODY
argument_list|,
name|sc
argument_list|,
name|i
argument_list|,
name|acpi_asus_sysctl
argument_list|,
literal|"I"
argument_list|,
name|acpi_asus_sysctls
index|[
name|i
index|]
operator|.
name|description
argument_list|)
expr_stmt|;
block|}
comment|/* Attach leds */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|bled_set
condition|)
block|{
name|sc
operator|->
name|s_bled
operator|.
name|busy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|s_bled
operator|.
name|sc
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|s_bled
operator|.
name|type
operator|=
name|ACPI_ASUS_LED_BLED
expr_stmt|;
name|sc
operator|->
name|s_bled
operator|.
name|cdev
operator|=
name|led_create
argument_list|(
operator|(
name|led_t
operator|*
operator|)
name|acpi_asus_led
argument_list|,
operator|&
name|sc
operator|->
name|s_bled
argument_list|,
literal|"bled"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|mled_set
condition|)
block|{
name|sc
operator|->
name|s_mled
operator|.
name|busy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|s_mled
operator|.
name|sc
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|s_mled
operator|.
name|type
operator|=
name|ACPI_ASUS_LED_MLED
expr_stmt|;
name|sc
operator|->
name|s_mled
operator|.
name|cdev
operator|=
name|led_create
argument_list|(
operator|(
name|led_t
operator|*
operator|)
name|acpi_asus_led
argument_list|,
operator|&
name|sc
operator|->
name|s_mled
argument_list|,
literal|"mled"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|tled_set
condition|)
block|{
name|sc
operator|->
name|s_tled
operator|.
name|busy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|s_tled
operator|.
name|sc
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|s_tled
operator|.
name|type
operator|=
name|ACPI_ASUS_LED_TLED
expr_stmt|;
name|sc
operator|->
name|s_tled
operator|.
name|cdev
operator|=
name|led_create
argument_list|(
operator|(
name|led_t
operator|*
operator|)
name|acpi_asus_led
argument_list|,
operator|&
name|sc
operator|->
name|s_tled
argument_list|,
literal|"tled"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|wled_set
condition|)
block|{
name|sc
operator|->
name|s_wled
operator|.
name|busy
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|s_wled
operator|.
name|sc
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|s_wled
operator|.
name|type
operator|=
name|ACPI_ASUS_LED_WLED
expr_stmt|;
name|sc
operator|->
name|s_wled
operator|.
name|cdev
operator|=
name|led_create
argument_list|(
operator|(
name|led_t
operator|*
operator|)
name|acpi_asus_led
argument_list|,
operator|&
name|sc
operator|->
name|s_wled
argument_list|,
literal|"wled"
argument_list|)
expr_stmt|;
block|}
comment|/* Activate hotkeys */
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
literal|"BSTS"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Handle notifies */
name|AcpiInstallNotifyHandler
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|ACPI_SYSTEM_NOTIFY
argument_list|,
name|acpi_asus_notify
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Turn the lights off */
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|bled_set
condition|)
name|led_destroy
argument_list|(
name|sc
operator|->
name|s_bled
operator|.
name|cdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|mled_set
condition|)
name|led_destroy
argument_list|(
name|sc
operator|->
name|s_mled
operator|.
name|cdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|tled_set
condition|)
name|led_destroy
argument_list|(
name|sc
operator|->
name|s_tled
operator|.
name|cdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|wled_set
condition|)
name|led_destroy
argument_list|(
name|sc
operator|->
name|s_wled
operator|.
name|cdev
argument_list|)
expr_stmt|;
comment|/* Remove notify handler */
name|AcpiRemoveNotifyHandler
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|ACPI_SYSTEM_NOTIFY
argument_list|,
name|acpi_asus_notify
argument_list|)
expr_stmt|;
comment|/* Free sysctl tree */
name|sysctl_ctx_free
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_ctx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_asus_led_task
parameter_list|(
name|struct
name|acpi_asus_led
modifier|*
name|led
parameter_list|,
name|int
name|pending
name|__unused
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|char
modifier|*
name|method
decl_stmt|;
name|int
name|state
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|led
operator|->
name|sc
expr_stmt|;
switch|switch
condition|(
name|led
operator|->
name|type
condition|)
block|{
case|case
name|ACPI_ASUS_LED_BLED
case|:
name|method
operator|=
name|sc
operator|->
name|model
operator|->
name|bled_set
expr_stmt|;
name|state
operator|=
name|led
operator|->
name|state
expr_stmt|;
break|break;
case|case
name|ACPI_ASUS_LED_MLED
case|:
name|method
operator|=
name|sc
operator|->
name|model
operator|->
name|mled_set
expr_stmt|;
comment|/* Note: inverted */
name|state
operator|=
operator|!
name|led
operator|->
name|state
expr_stmt|;
break|break;
case|case
name|ACPI_ASUS_LED_TLED
case|:
name|method
operator|=
name|sc
operator|->
name|model
operator|->
name|tled_set
expr_stmt|;
name|state
operator|=
name|led
operator|->
name|state
expr_stmt|;
break|break;
case|case
name|ACPI_ASUS_LED_WLED
case|:
name|method
operator|=
name|sc
operator|->
name|model
operator|->
name|wled_set
expr_stmt|;
name|state
operator|=
name|led
operator|->
name|state
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"acpi_asus_led: invalid LED type %d\n"
argument_list|,
operator|(
name|int
operator|)
name|led
operator|->
name|type
argument_list|)
expr_stmt|;
return|return;
block|}
name|acpi_SetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|method
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|led
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_asus_led
parameter_list|(
name|struct
name|acpi_asus_led
modifier|*
name|led
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|led
operator|->
name|busy
condition|)
return|return;
name|led
operator|->
name|busy
operator|=
literal|1
expr_stmt|;
name|led
operator|->
name|state
operator|=
name|state
expr_stmt|;
name|AcpiOsExecute
argument_list|(
name|OSL_NOTIFY_HANDLER
argument_list|,
operator|(
name|void
operator|*
operator|)
name|acpi_asus_led_task
argument_list|,
name|led
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|arg
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|function
decl_stmt|;
name|int
name|method
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|acpi_asus_softc
operator|*
operator|)
name|oidp
operator|->
name|oid_arg1
expr_stmt|;
name|function
operator|=
name|oidp
operator|->
name|oid_arg2
expr_stmt|;
name|method
operator|=
name|acpi_asus_sysctls
index|[
name|function
index|]
operator|.
name|method
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|asus
argument_list|)
expr_stmt|;
name|arg
operator|=
name|acpi_asus_sysctl_get
argument_list|(
name|sc
argument_list|,
name|method
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|arg
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
comment|/* Sanity check */
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
comment|/* Update */
name|error
operator|=
name|acpi_asus_sysctl_set
argument_list|(
name|sc
argument_list|,
name|method
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|out
label|:
name|ACPI_SERIAL_END
argument_list|(
name|asus
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_sysctl_get
parameter_list|(
name|struct
name|acpi_asus_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|)
block|{
name|int
name|val
init|=
literal|0
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|asus
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|method
condition|)
block|{
case|case
name|ACPI_ASUS_METHOD_BRN
case|:
name|val
operator|=
name|sc
operator|->
name|s_brn
expr_stmt|;
break|break;
case|case
name|ACPI_ASUS_METHOD_DISP
case|:
name|val
operator|=
name|sc
operator|->
name|s_disp
expr_stmt|;
break|break;
case|case
name|ACPI_ASUS_METHOD_LCD
case|:
name|val
operator|=
name|sc
operator|->
name|s_lcd
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_sysctl_set
parameter_list|(
name|struct
name|acpi_asus_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|arg
parameter_list|)
block|{
name|ACPI_STATUS
name|status
init|=
name|AE_OK
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|asus
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|method
condition|)
block|{
case|case
name|ACPI_ASUS_METHOD_BRN
case|:
if|if
condition|(
name|arg
operator|<
literal|0
operator|||
name|arg
operator|>
literal|15
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|brn_set
condition|)
name|status
operator|=
name|acpi_SetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_set
argument_list|,
name|arg
argument_list|)
expr_stmt|;
else|else
block|{
while|while
condition|(
name|arg
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
operator|(
name|arg
operator|>
literal|0
operator|)
condition|?
name|sc
operator|->
name|model
operator|->
name|brn_up
else|:
name|sc
operator|->
name|model
operator|->
name|brn_dn
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|arg
operator|>
literal|0
operator|)
condition|?
name|arg
operator|--
else|:
name|arg
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
name|sc
operator|->
name|s_brn
operator|=
name|arg
expr_stmt|;
break|break;
case|case
name|ACPI_ASUS_METHOD_DISP
case|:
if|if
condition|(
name|arg
operator|<
literal|0
operator|||
name|arg
operator|>
literal|7
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|status
operator|=
name|acpi_SetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|disp_set
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
name|sc
operator|->
name|s_disp
operator|=
name|arg
expr_stmt|;
break|break;
case|case
name|ACPI_ASUS_METHOD_LCD
case|:
if|if
condition|(
name|arg
operator|<
literal|0
operator|||
name|arg
operator|>
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|strncmp
argument_list|(
name|sc
operator|->
name|model
operator|->
name|name
argument_list|,
literal|"L3H"
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_set
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
name|acpi_SetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_set
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
name|sc
operator|->
name|s_lcd
operator|=
name|arg
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_asus_sysctl_init
parameter_list|(
name|struct
name|acpi_asus_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
switch|switch
condition|(
name|method
condition|)
block|{
case|case
name|ACPI_ASUS_METHOD_BRN
case|:
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|brn_get
condition|)
block|{
comment|/* GPLV/SPLV models */
name|status
operator|=
name|acpi_GetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_get
argument_list|,
operator|&
name|sc
operator|->
name|s_brn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|brn_up
condition|)
block|{
comment|/* Relative models */
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_up
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|brn_dn
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
return|return
operator|(
name|FALSE
operator|)
return|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
case|case
name|ACPI_ASUS_METHOD_DISP
case|:
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|disp_get
condition|)
block|{
name|status
operator|=
name|acpi_GetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|disp_get
argument_list|,
operator|&
name|sc
operator|->
name|s_disp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
case|case
name|ACPI_ASUS_METHOD_LCD
case|:
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|lcd_get
operator|&&
name|strncmp
argument_list|(
name|sc
operator|->
name|model
operator|->
name|name
argument_list|,
literal|"L3H"
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|acpi_GetInteger
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_get
argument_list|,
operator|&
name|sc
operator|->
name|s_lcd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|model
operator|->
name|lcd_get
condition|)
block|{
name|ACPI_BUFFER
name|Buf
decl_stmt|;
name|ACPI_OBJECT
name|Arg
index|[
literal|2
index|]
decl_stmt|,
name|Obj
decl_stmt|;
name|ACPI_OBJECT_LIST
name|Args
decl_stmt|;
comment|/* L3H is a bit special */
name|Arg
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0x02
expr_stmt|;
name|Arg
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|Arg
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0x03
expr_stmt|;
name|Args
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
name|Args
operator|.
name|Pointer
operator|=
name|Arg
expr_stmt|;
name|Buf
operator|.
name|Length
operator|=
sizeof|sizeof
argument_list|(
name|Obj
argument_list|)
expr_stmt|;
name|Buf
operator|.
name|Pointer
operator|=
operator|&
name|Obj
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|handle
argument_list|,
name|sc
operator|->
name|model
operator|->
name|lcd_get
argument_list|,
operator|&
name|Args
argument_list|,
operator|&
name|Buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
operator|&&
name|Obj
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
condition|)
block|{
name|sc
operator|->
name|s_lcd
operator|=
name|Obj
operator|.
name|Integer
operator|.
name|Value
operator|>>
literal|8
expr_stmt|;
return|return
operator|(
name|TRUE
operator|)
return|;
block|}
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
return|return
operator|(
name|FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_asus_notify
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|acpi_asus_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|acpi_softc
modifier|*
name|acpi_sc
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
operator|(
name|device_t
operator|)
name|context
argument_list|)
expr_stmt|;
name|acpi_sc
operator|=
name|acpi_device_get_parent_softc
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|asus
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|notify
operator|&
operator|~
literal|0x10
operator|)
operator|<=
literal|15
condition|)
block|{
name|sc
operator|->
name|s_brn
operator|=
name|notify
operator|&
operator|~
literal|0x10
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"Brightness increased\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|notify
operator|&
operator|~
literal|0x20
operator|)
operator|<=
literal|15
condition|)
block|{
name|sc
operator|->
name|s_brn
operator|=
name|notify
operator|&
operator|~
literal|0x20
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"Brightness decreased\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|notify
operator|==
literal|0x33
condition|)
block|{
name|sc
operator|->
name|s_lcd
operator|=
literal|1
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"LCD turned on\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|notify
operator|==
literal|0x34
condition|)
block|{
name|sc
operator|->
name|s_lcd
operator|=
literal|0
expr_stmt|;
name|ACPI_VPRINT
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|acpi_sc
argument_list|,
literal|"LCD turned off\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Notify devd(8) */
name|acpi_UserNotify
argument_list|(
literal|"ASUS"
argument_list|,
name|h
argument_list|,
name|notify
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|asus
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


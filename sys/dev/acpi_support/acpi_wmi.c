begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009 Michael Gmelin<freebsd@grem.de>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for acpi-wmi mapping, provides an interface for vendor specific  * implementations (e.g. HP and Acer laptops).  * Inspired by the ACPI-WMI mapping driver (c) 2008-2008 Carlos Corbacho which  * implements this functionality for Linux.  *  * WMI and ACPI: http://www.microsoft.com/whdc/system/pnppwr/wmi/wmi-acpi.mspx  * acpi-wmi for Linux: http://www.kernel.org  */
end_comment

begin_include
include|#
directive|include
file|"opt_acpi.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/acpi.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/accommon.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_include
include|#
directive|include
file|"acpi_wmi_if.h"
end_include

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_ACPIWMI
argument_list|,
literal|"acpiwmi"
argument_list|,
literal|"ACPI-WMI mapping"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_OEM
end_define

begin_expr_stmt
name|ACPI_MODULE_NAME
argument_list|(
literal|"ACPI_WMI"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|ACPI_WMI_REGFLAG_EXPENSIVE
value|0x1
end_define

begin_comment
comment|/* GUID flag: Expensive operation */
end_comment

begin_define
define|#
directive|define
name|ACPI_WMI_REGFLAG_METHOD
value|0x2
end_define

begin_comment
comment|/* GUID flag: Method call */
end_comment

begin_define
define|#
directive|define
name|ACPI_WMI_REGFLAG_STRING
value|0x4
end_define

begin_comment
comment|/* GUID flag: String */
end_comment

begin_define
define|#
directive|define
name|ACPI_WMI_REGFLAG_EVENT
value|0x8
end_define

begin_comment
comment|/* GUID flag: Event */
end_comment

begin_comment
comment|/*  * acpi_wmi driver private structure  */
end_comment

begin_struct
struct|struct
name|acpi_wmi_softc
block|{
name|device_t
name|wmi_dev
decl_stmt|;
comment|/* wmi device id */
name|ACPI_HANDLE
name|wmi_handle
decl_stmt|;
comment|/* handle of the PNP0C14 node */
name|device_t
name|ec_dev
decl_stmt|;
comment|/* acpi_ec0 */
name|struct
name|cdev
modifier|*
name|wmistat_dev_t
decl_stmt|;
comment|/* wmistat device handle */
name|struct
name|sbuf
name|wmistat_sbuf
decl_stmt|;
comment|/* sbuf for /dev/wmistat output */
name|pid_t
name|wmistat_open_pid
decl_stmt|;
comment|/* pid operating on /dev/wmistat */
name|int
name|wmistat_bufptr
decl_stmt|;
comment|/* /dev/wmistat ptr to buffer position */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Struct that holds information about  * about a single GUID entry in _WDG  */
end_comment

begin_struct
struct|struct
name|guid_info
block|{
name|char
name|guid
index|[
literal|16
index|]
decl_stmt|;
comment|/* 16 byte non human readable GUID */
name|char
name|oid
index|[
literal|2
index|]
decl_stmt|;
comment|/* object id or event notify id (first byte) */
name|UINT8
name|max_instance
decl_stmt|;
comment|/* highest instance known for this GUID */
name|UINT8
name|flags
decl_stmt|;
comment|/* ACPI_WMI_REGFLAG_%s */
block|}
struct|;
end_struct

begin_comment
comment|/* WExx event generation state (on/off) */
end_comment

begin_enum
enum|enum
name|event_generation_state
block|{
name|EVENT_GENERATION_ON
init|=
literal|1
block|,
name|EVENT_GENERATION_OFF
init|=
literal|0
block|}
enum|;
end_enum

begin_comment
comment|/*  * Information about one entry in _WDG.  * List of those is used to lookup information by GUID.  */
end_comment

begin_struct
struct|struct
name|wmi_info
block|{
name|TAILQ_ENTRY
argument_list|(
argument|wmi_info
argument_list|)
name|wmi_list
expr_stmt|;
name|struct
name|guid_info
name|ginfo
decl_stmt|;
comment|/* information on guid */
name|ACPI_NOTIFY_HANDLER
name|event_handler
decl_stmt|;
comment|/* client provided event handler */
name|void
modifier|*
name|event_handler_user_data
decl_stmt|;
comment|/* ev handler cookie  */
block|}
struct|;
end_struct

begin_macro
name|TAILQ_HEAD
argument_list|(
argument|wmi_info_list_head
argument_list|,
argument|wmi_info
argument_list|)
end_macro

begin_expr_stmt
name|wmi_info_list
operator|=
name|TAILQ_HEAD_INITIALIZER
argument_list|(
name|wmi_info_list
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ACPI_SERIAL_DECL
argument_list|(
name|acpi_wmi
argument_list|,
literal|"ACPI-WMI Mapping"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* public interface - declaration */
end_comment

begin_comment
comment|/* standard device interface*/
end_comment

begin_function_decl
specifier|static
name|int
name|acpi_wmi_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_wmi_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_wmi_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* see acpi_wmi_if.m */
end_comment

begin_function_decl
specifier|static
name|int
name|acpi_wmi_provides_guid_string_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_evaluate_call_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|UINT8
name|instance
parameter_list|,
name|UINT32
name|method_id
parameter_list|,
specifier|const
name|ACPI_BUFFER
modifier|*
name|in
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|out
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_install_event_handler_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|ACPI_NOTIFY_HANDLER
name|handler
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_remove_event_handler_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_get_event_data_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|UINT32
name|event_id
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|out
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_get_block_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|UINT8
name|instance
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|out
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_set_block_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|UINT8
name|instance
parameter_list|,
specifier|const
name|ACPI_BUFFER
modifier|*
name|in
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* private interface - declaration */
end_comment

begin_comment
comment|/* callbacks */
end_comment

begin_function_decl
specifier|static
name|void
name|acpi_wmi_notify_handler
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_ec_handler
parameter_list|(
name|UINT32
name|function
parameter_list|,
name|ACPI_PHYSICAL_ADDRESS
name|address
parameter_list|,
name|UINT32
name|width
parameter_list|,
name|UINT64
modifier|*
name|value
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|void
modifier|*
name|region_context
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* helpers */
end_comment

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_read_wdg_blocks
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ACPI_STATUS
name|acpi_wmi_toggle_we_event_generation
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|wmi_info
modifier|*
name|winfo
parameter_list|,
name|enum
name|event_generation_state
name|state
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_wmi_guid_string_to_guid
parameter_list|(
specifier|const
name|UINT8
modifier|*
name|guid_string
parameter_list|,
name|UINT8
modifier|*
name|guid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|wmi_info
modifier|*
name|acpi_wmi_lookup_wmi_info_by_guid_string
parameter_list|(
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|d_open_t
name|acpi_wmi_wmistat_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|acpi_wmi_wmistat_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_read_t
name|acpi_wmi_wmistat_read
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* handler /dev/wmistat device */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|wmistat_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_open
operator|=
name|acpi_wmi_wmistat_open
block|,
operator|.
name|d_close
operator|=
name|acpi_wmi_wmistat_close
block|,
operator|.
name|d_read
operator|=
name|acpi_wmi_wmistat_read
block|,
operator|.
name|d_name
operator|=
literal|"wmistat"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|acpi_wmi_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|acpi_wmi_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|acpi_wmi_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|acpi_wmi_detach
argument_list|)
block|,
comment|/* acpi_wmi interface */
name|DEVMETHOD
argument_list|(
name|acpi_wmi_provides_guid_string
argument_list|,
name|acpi_wmi_provides_guid_string_method
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|acpi_wmi_evaluate_call
argument_list|,
name|acpi_wmi_evaluate_call_method
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|acpi_wmi_install_event_handler
argument_list|,
name|acpi_wmi_install_event_handler_method
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|acpi_wmi_remove_event_handler
argument_list|,
name|acpi_wmi_remove_event_handler_method
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|acpi_wmi_get_event_data
argument_list|,
name|acpi_wmi_get_event_data_method
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|acpi_wmi_get_block
argument_list|,
name|acpi_wmi_get_block_method
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|acpi_wmi_set_block
argument_list|,
name|acpi_wmi_set_block_method
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|acpi_wmi_driver
init|=
block|{
literal|"acpi_wmi"
block|,
name|acpi_wmi_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|acpi_wmi_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|acpi_wmi_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|acpi_wmi
argument_list|,
name|acpi
argument_list|,
name|acpi_wmi_driver
argument_list|,
name|acpi_wmi_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|acpi_wmi
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|acpi_wmi
argument_list|,
name|acpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|wmi_ids
index|[]
init|=
block|{
literal|"PNP0C14"
block|,
literal|"PNP0c14"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Probe for the PNP0C14 ACPI node  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|acpi_disabled
argument_list|(
literal|"wmi"
argument_list|)
operator|||
name|ACPI_ID_PROBE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|wmi_ids
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"ACPI-WMI mapping"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Attach the device by:  * - Looking for the first ACPI EC device  * - Install the notify handler  * - Install the EC address space handler  * - Look for the _WDG node and read GUID information blocks  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENXIO
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
name|sc
operator|->
name|wmi_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|wmi_handle
operator|=
name|acpi_get_handle
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|wmi_info_list
argument_list|)
expr_stmt|;
comment|/* XXX Only works with one EC, but nearly all systems only have one. */
if|if
condition|(
operator|(
name|sc
operator|->
name|ec_dev
operator|=
name|devclass_get_device
argument_list|(
name|devclass_find
argument_list|(
literal|"acpi_ec"
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot find EC device\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
operator|(
name|status
operator|=
name|AcpiInstallNotifyHandler
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_wmi_notify_handler
argument_list|,
name|sc
argument_list|)
operator|)
argument_list|)
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"couldn't install notify handler - %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
operator|(
name|status
operator|=
name|AcpiInstallAddressSpaceHandler
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|ACPI_ADR_SPACE_EC
argument_list|,
name|acpi_wmi_ec_handler
argument_list|,
name|NULL
argument_list|,
name|sc
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"couldn't install EC handler - %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|AcpiRemoveNotifyHandler
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_wmi_notify_handler
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
operator|(
name|status
operator|=
name|acpi_wmi_read_wdg_blocks
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|)
operator|)
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"couldn't parse _WDG - %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|AcpiRemoveNotifyHandler
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_wmi_notify_handler
argument_list|)
expr_stmt|;
name|AcpiRemoveAddressSpaceHandler
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|ACPI_ADR_SPACE_EC
argument_list|,
name|acpi_wmi_ec_handler
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|wmistat_dev_t
operator|=
name|make_dev
argument_list|(
operator|&
name|wmistat_cdevsw
argument_list|,
literal|0
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0644
argument_list|,
literal|"wmistat"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|wmistat_dev_t
operator|->
name|si_drv1
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|wmistat_open_pid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|wmistat_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Detach the driver by:  * - Removing notification handler  * - Removing address space handler  * - Turning off event generation for all WExx event activated by  *   child drivers  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|wmistat_open_pid
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|EBUSY
expr_stmt|;
block|}
else|else
block|{
name|AcpiRemoveNotifyHandler
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|acpi_wmi_notify_handler
argument_list|)
expr_stmt|;
name|AcpiRemoveAddressSpaceHandler
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|ACPI_ADR_SPACE_EC
argument_list|,
name|acpi_wmi_ec_handler
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|winfo
argument_list|,
argument|&wmi_info_list
argument_list|,
argument|wmi_list
argument_list|,
argument|tmp
argument_list|)
block|{
if|if
condition|(
name|winfo
operator|->
name|event_handler
condition|)
name|acpi_wmi_toggle_we_event_generation
argument_list|(
name|dev
argument_list|,
name|winfo
argument_list|,
name|EVENT_GENERATION_OFF
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|wmi_info_list
argument_list|,
name|winfo
argument_list|,
name|wmi_list
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|winfo
argument_list|,
name|M_ACPIWMI
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|wmistat_bufptr
operator|!=
operator|-
literal|1
condition|)
block|{
name|sbuf_delete
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
expr_stmt|;
name|sc
operator|->
name|wmistat_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|sc
operator|->
name|wmistat_open_pid
operator|=
literal|0
expr_stmt|;
name|destroy_dev
argument_list|(
name|sc
operator|->
name|wmistat_dev_t
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if the given GUID string (human readable format  * AABBCCDD-EEFF-GGHH-IIJJ-KKLLMMNNOOPP)  * exists within _WDG  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_provides_guid_string_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|)
block|{
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
name|winfo
operator|=
name|acpi_wmi_lookup_wmi_info_by_guid_string
argument_list|(
name|guid_string
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|(
name|winfo
operator|==
name|NULL
operator|)
condition|?
literal|0
else|:
name|winfo
operator|->
name|ginfo
operator|.
name|max_instance
operator|+
literal|1
expr_stmt|;
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Call a method "method_id" on the given GUID block  * write result into user provided output buffer  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_evaluate_call_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|UINT8
name|instance
parameter_list|,
name|UINT32
name|method_id
parameter_list|,
specifier|const
name|ACPI_BUFFER
modifier|*
name|in
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|out
parameter_list|)
block|{
name|ACPI_OBJECT
name|params
index|[
literal|3
index|]
decl_stmt|;
name|ACPI_OBJECT_LIST
name|input
decl_stmt|;
name|char
name|method
index|[
literal|5
index|]
init|=
literal|"WMxx"
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|winfo
operator|=
name|acpi_wmi_lookup_wmi_info_by_guid_string
argument_list|(
name|guid_string
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|status
operator|=
name|AE_NOT_FOUND
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_METHOD
operator|)
condition|)
name|status
operator|=
name|AE_BAD_DATA
expr_stmt|;
elseif|else
if|if
condition|(
name|instance
operator|>
name|winfo
operator|->
name|ginfo
operator|.
name|max_instance
condition|)
name|status
operator|=
name|AE_BAD_PARAMETER
expr_stmt|;
else|else
block|{
name|params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|instance
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|method_id
expr_stmt|;
name|input
operator|.
name|Pointer
operator|=
name|params
expr_stmt|;
name|input
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|in
condition|)
block|{
name|params
index|[
literal|2
index|]
operator|.
name|Type
operator|=
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_STRING
operator|)
condition|?
name|ACPI_TYPE_STRING
else|:
name|ACPI_TYPE_BUFFER
expr_stmt|;
name|params
index|[
literal|2
index|]
operator|.
name|Buffer
operator|.
name|Length
operator|=
name|in
operator|->
name|Length
expr_stmt|;
name|params
index|[
literal|2
index|]
operator|.
name|Buffer
operator|.
name|Pointer
operator|=
name|in
operator|->
name|Pointer
expr_stmt|;
name|input
operator|.
name|Count
operator|=
literal|3
expr_stmt|;
block|}
name|method
index|[
literal|2
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
expr_stmt|;
name|method
index|[
literal|3
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|1
index|]
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|method
argument_list|,
operator|&
name|input
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Install a user provided event_handler on the given GUID  * provided *data will be passed on callback  * If there is already an existing event handler registered it will be silently  * discarded  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_install_event_handler_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|ACPI_NOTIFY_HANDLER
name|event_handler
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|status
operator|=
name|AE_OK
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|guid_string
operator|==
name|NULL
operator|||
name|event_handler
operator|==
name|NULL
condition|)
name|status
operator|=
name|AE_BAD_PARAMETER
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|winfo
operator|=
name|acpi_wmi_lookup_wmi_info_by_guid_string
argument_list|(
name|guid_string
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|status
operator|=
name|AE_NOT_EXIST
expr_stmt|;
elseif|else
if|if
condition|(
name|winfo
operator|->
name|event_handler
operator|!=
name|NULL
operator|||
operator|(
name|status
operator|=
name|acpi_wmi_toggle_we_event_generation
argument_list|(
name|dev
argument_list|,
name|winfo
argument_list|,
name|EVENT_GENERATION_ON
argument_list|)
operator|)
operator|==
name|AE_OK
condition|)
block|{
name|winfo
operator|->
name|event_handler
operator|=
name|event_handler
expr_stmt|;
name|winfo
operator|->
name|event_handler_user_data
operator|=
name|data
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Remove a previously installed event handler from the given GUID  * If there was none installed, this call is silently discarded and  * reported as AE_OK  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_remove_event_handler_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|)
block|{
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|status
operator|=
name|AE_OK
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|guid_string
operator|&&
operator|(
name|winfo
operator|=
name|acpi_wmi_lookup_wmi_info_by_guid_string
argument_list|(
name|guid_string
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
name|winfo
operator|->
name|event_handler
condition|)
block|{
name|status
operator|=
name|acpi_wmi_toggle_we_event_generation
argument_list|(
name|dev
argument_list|,
name|winfo
argument_list|,
name|EVENT_GENERATION_OFF
argument_list|)
expr_stmt|;
name|winfo
operator|->
name|event_handler
operator|=
name|NULL
expr_stmt|;
name|winfo
operator|->
name|event_handler_user_data
operator|=
name|NULL
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get details on an event received through a callback registered  * through ACPI_WMI_REMOVE_EVENT_HANDLER into a user provided output buffer.  * (event_id equals "notify" passed in the callback)  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_get_event_data_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|UINT32
name|event_id
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|out
parameter_list|)
block|{
name|ACPI_OBJECT_LIST
name|input
decl_stmt|;
name|ACPI_OBJECT
name|params
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|status
operator|=
name|AE_NOT_FOUND
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|event_id
expr_stmt|;
name|input
operator|.
name|Pointer
operator|=
name|params
expr_stmt|;
name|input
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|winfo
argument_list|,
argument|&wmi_info_list
argument_list|,
argument|wmi_list
argument_list|)
block|{
if|if
condition|(
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EVENT
operator|)
operator|&&
operator|(
operator|(
name|UINT8
operator|)
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
operator|==
name|event_id
operator|)
condition|)
block|{
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
literal|"_WED"
argument_list|,
operator|&
name|input
argument_list|,
name|out
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read a block of data from the given GUID (using WQxx (query))  * Will be returned in a user provided buffer (out).  * If the method is marked as expensive (ACPI_WMI_REGFLAG_EXPENSIVE)  * we will first call the WCxx control method to lock the node to  * lock the node for data collection and release it afterwards.  * (Failed WCxx calls are ignored to "support" broken implementations)  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_get_block_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|UINT8
name|instance
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|out
parameter_list|)
block|{
name|char
name|wc_method
index|[
literal|5
index|]
init|=
literal|"WCxx"
decl_stmt|;
name|char
name|wq_method
index|[
literal|5
index|]
init|=
literal|"WQxx"
decl_stmt|;
name|ACPI_OBJECT_LIST
name|wc_input
decl_stmt|;
name|ACPI_OBJECT_LIST
name|wq_input
decl_stmt|;
name|ACPI_OBJECT
name|wc_params
index|[
literal|1
index|]
decl_stmt|;
name|ACPI_OBJECT
name|wq_params
index|[
literal|1
index|]
decl_stmt|;
name|ACPI_HANDLE
name|wc_handle
decl_stmt|;
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_STATUS
name|wc_status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|wc_status
operator|=
name|AE_ERROR
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|guid_string
operator|==
name|NULL
operator|||
name|out
operator|==
name|NULL
condition|)
name|status
operator|=
name|AE_BAD_PARAMETER
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|winfo
operator|=
name|acpi_wmi_lookup_wmi_info_by_guid_string
argument_list|(
name|guid_string
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|status
operator|=
name|AE_ERROR
expr_stmt|;
elseif|else
if|if
condition|(
name|instance
operator|>
name|winfo
operator|->
name|ginfo
operator|.
name|max_instance
condition|)
name|status
operator|=
name|AE_BAD_PARAMETER
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EVENT
operator|)
operator|||
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_METHOD
operator|)
condition|)
name|status
operator|=
name|AE_ERROR
expr_stmt|;
else|else
block|{
name|wq_params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|wq_params
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|instance
expr_stmt|;
name|wq_input
operator|.
name|Pointer
operator|=
name|wq_params
expr_stmt|;
name|wq_input
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EXPENSIVE
condition|)
block|{
name|wc_params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|wc_params
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|1
expr_stmt|;
name|wc_input
operator|.
name|Pointer
operator|=
name|wc_params
expr_stmt|;
name|wc_input
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|wc_method
index|[
literal|2
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
expr_stmt|;
name|wc_method
index|[
literal|3
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|1
index|]
expr_stmt|;
name|wc_status
operator|=
name|AcpiGetHandle
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|wc_method
argument_list|,
operator|&
name|wc_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|wc_status
argument_list|)
condition|)
name|wc_status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|wc_handle
argument_list|,
name|wc_method
argument_list|,
operator|&
name|wc_input
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|wq_method
index|[
literal|2
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
expr_stmt|;
name|wq_method
index|[
literal|3
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|1
index|]
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|wq_method
argument_list|,
operator|&
name|wq_input
argument_list|,
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EXPENSIVE
operator|)
operator|&&
name|ACPI_SUCCESS
argument_list|(
name|wc_status
argument_list|)
condition|)
block|{
name|wc_params
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|wc_handle
argument_list|,
name|wc_method
argument_list|,
operator|&
name|wc_input
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* XXX this might be 				    			 the wrong status to 				    			 return? */
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Write a block of data to the given GUID (using WSxx)  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_set_block_method
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|,
name|UINT8
name|instance
parameter_list|,
specifier|const
name|ACPI_BUFFER
modifier|*
name|in
parameter_list|)
block|{
name|char
name|method
index|[
literal|5
index|]
init|=
literal|"WSxx"
decl_stmt|;
name|ACPI_OBJECT_LIST
name|input
decl_stmt|;
name|ACPI_OBJECT
name|params
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|guid_string
operator|==
name|NULL
operator|||
name|in
operator|==
name|NULL
condition|)
name|status
operator|=
name|AE_BAD_DATA
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|winfo
operator|=
name|acpi_wmi_lookup_wmi_info_by_guid_string
argument_list|(
name|guid_string
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|status
operator|=
name|AE_ERROR
expr_stmt|;
elseif|else
if|if
condition|(
name|instance
operator|>
name|winfo
operator|->
name|ginfo
operator|.
name|max_instance
condition|)
name|status
operator|=
name|AE_BAD_PARAMETER
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EVENT
operator|)
operator|||
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_METHOD
operator|)
condition|)
name|status
operator|=
name|AE_ERROR
expr_stmt|;
else|else
block|{
name|params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|instance
expr_stmt|;
name|input
operator|.
name|Pointer
operator|=
name|params
expr_stmt|;
name|input
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Type
operator|=
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_STRING
operator|)
condition|?
name|ACPI_TYPE_STRING
else|:
name|ACPI_TYPE_BUFFER
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Length
operator|=
name|in
operator|->
name|Length
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Pointer
operator|=
name|in
operator|->
name|Pointer
expr_stmt|;
name|method
index|[
literal|2
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
expr_stmt|;
name|method
index|[
literal|3
index|]
operator|=
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|1
index|]
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|method
argument_list|,
operator|&
name|input
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Handle events received and dispatch them to  * stakeholders that registered through ACPI_WMI_INSTALL_EVENT_HANDLER  */
end_comment

begin_function
specifier|static
name|void
name|acpi_wmi_notify_handler
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|ACPI_NOTIFY_HANDLER
name|handler
decl_stmt|;
name|void
modifier|*
name|handler_data
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|ACPI_FUNCTION_TRACE_U32
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|,
name|notify
argument_list|)
expr_stmt|;
name|handler
operator|=
name|NULL
expr_stmt|;
name|handler_data
operator|=
name|NULL
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|winfo
argument_list|,
argument|&wmi_info_list
argument_list|,
argument|wmi_list
argument_list|)
block|{
if|if
condition|(
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EVENT
operator|)
operator|&&
operator|(
operator|(
name|UINT8
operator|)
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
operator|==
name|notify
operator|)
condition|)
block|{
if|if
condition|(
name|winfo
operator|->
name|event_handler
condition|)
block|{
name|handler
operator|=
name|winfo
operator|->
name|event_handler
expr_stmt|;
name|handler_data
operator|=
name|winfo
operator|->
name|event_handler_user_data
expr_stmt|;
break|break;
block|}
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|handler
condition|)
block|{
name|handler
argument_list|(
name|h
argument_list|,
name|notify
argument_list|,
name|handler_data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Handle EC address space notifications reveived on the WDG node  * (this mimics EcAddressSpaceHandler in acpi_ec.c)  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_ec_handler
parameter_list|(
name|UINT32
name|function
parameter_list|,
name|ACPI_PHYSICAL_ADDRESS
name|address
parameter_list|,
name|UINT32
name|width
parameter_list|,
name|UINT64
modifier|*
name|value
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|void
modifier|*
name|region_context
parameter_list|)
block|{
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|UINT64
name|ec_data
decl_stmt|;
name|UINT8
name|ec_addr
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE_U32
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|,
operator|(
name|UINT32
operator|)
name|address
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|acpi_wmi_softc
operator|*
operator|)
name|context
expr_stmt|;
if|if
condition|(
name|width
operator|%
literal|8
operator|!=
literal|0
operator|||
name|value
operator|==
name|NULL
operator|||
name|context
operator|==
name|NULL
condition|)
return|return
operator|(
name|AE_BAD_PARAMETER
operator|)
return|;
if|if
condition|(
name|address
operator|+
operator|(
name|width
operator|/
literal|8
operator|)
operator|-
literal|1
operator|>
literal|0xFF
condition|)
return|return
operator|(
name|AE_BAD_ADDRESS
operator|)
return|;
if|if
condition|(
name|function
operator|==
name|ACPI_READ
condition|)
operator|*
name|value
operator|=
literal|0
expr_stmt|;
name|ec_addr
operator|=
name|address
expr_stmt|;
name|status
operator|=
name|AE_ERROR
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|width
condition|;
name|i
operator|+=
literal|8
operator|,
operator|++
name|ec_addr
control|)
block|{
switch|switch
condition|(
name|function
condition|)
block|{
case|case
name|ACPI_READ
case|:
name|status
operator|=
name|ACPI_EC_READ
argument_list|(
name|sc
operator|->
name|ec_dev
argument_list|,
name|ec_addr
argument_list|,
operator|&
name|ec_data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_SUCCESS
argument_list|(
name|status
argument_list|)
condition|)
operator|*
name|value
operator||=
operator|(
operator|(
name|UINT64
operator|)
name|ec_data
operator|)
operator|<<
name|i
expr_stmt|;
break|break;
case|case
name|ACPI_WRITE
case|:
name|ec_data
operator|=
call|(
name|UINT8
call|)
argument_list|(
operator|(
operator|*
name|value
operator|)
operator|>>
name|i
argument_list|)
expr_stmt|;
name|status
operator|=
name|ACPI_EC_WRITE
argument_list|(
name|sc
operator|->
name|ec_dev
argument_list|,
name|ec_addr
argument_list|,
name|ec_data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"invalid acpi_wmi_ec_handler function %d\n"
argument_list|,
name|function
argument_list|)
expr_stmt|;
name|status
operator|=
name|AE_BAD_PARAMETER
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
condition|)
break|break;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read GUID blocks from the _WDG node  * into wmi_info_list.  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_read_wdg_blocks
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|)
block|{
name|ACPI_BUFFER
name|out
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|struct
name|guid_info
modifier|*
name|ginfo
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|obj
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|UINT32
name|i
decl_stmt|;
name|UINT32
name|wdg_block_count
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|h
argument_list|,
literal|"_WDG"
argument_list|,
name|NULL
argument_list|,
operator|&
name|out
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|status
operator|)
return|;
name|obj
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|out
operator|.
name|Pointer
expr_stmt|;
name|wdg_block_count
operator|=
name|obj
operator|->
name|Buffer
operator|.
name|Length
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|guid_info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ginfo
operator|=
name|malloc
argument_list|(
name|obj
operator|->
name|Buffer
operator|.
name|Length
argument_list|,
name|M_ACPIWMI
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|AcpiOsFree
argument_list|(
name|out
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
operator|(
name|AE_NO_MEMORY
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|ginfo
argument_list|,
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
argument_list|,
name|obj
operator|->
name|Buffer
operator|.
name|Length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wdg_block_count
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|(
name|winfo
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|wmi_info
argument_list|)
argument_list|,
name|M_ACPIWMI
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|AcpiOsFree
argument_list|(
name|out
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ginfo
argument_list|,
name|M_ACPIWMI
argument_list|)
expr_stmt|;
return|return
operator|(
name|AE_NO_MEMORY
operator|)
return|;
block|}
name|winfo
operator|->
name|ginfo
operator|=
name|ginfo
index|[
name|i
index|]
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|wmi_info_list
argument_list|,
name|winfo
argument_list|,
name|wmi_list
argument_list|)
expr_stmt|;
block|}
name|AcpiOsFree
argument_list|(
name|out
operator|.
name|Pointer
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ginfo
argument_list|,
name|M_ACPIWMI
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Toggle event generation in for the given GUID (passed by winfo)  * Turn on to get notified (through acpi_wmi_notify_handler) if events happen  * on the given GUID.  */
end_comment

begin_function
specifier|static
name|ACPI_STATUS
name|acpi_wmi_toggle_we_event_generation
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|wmi_info
modifier|*
name|winfo
parameter_list|,
name|enum
name|event_generation_state
name|state
parameter_list|)
block|{
name|char
name|method
index|[
literal|5
index|]
init|=
literal|"WExx"
decl_stmt|;
name|ACPI_OBJECT_LIST
name|input
decl_stmt|;
name|ACPI_OBJECT
name|params
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|params
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|state
operator|==
name|EVENT_GENERATION_ON
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|input
operator|.
name|Pointer
operator|=
name|params
expr_stmt|;
name|input
operator|.
name|Count
operator|=
literal|1
expr_stmt|;
name|UINT8
name|hi
init|=
operator|(
operator|(
name|UINT8
operator|)
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
operator|)
operator|>>
literal|4
decl_stmt|;
name|UINT8
name|lo
init|=
operator|(
operator|(
name|UINT8
operator|)
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
operator|)
operator|&
literal|0xf
decl_stmt|;
name|method
index|[
literal|2
index|]
operator|=
operator|(
name|hi
operator|>
literal|9
condition|?
name|hi
operator|+
literal|55
else|:
name|hi
operator|+
literal|48
operator|)
expr_stmt|;
name|method
index|[
literal|3
index|]
operator|=
operator|(
name|lo
operator|>
literal|9
condition|?
name|lo
operator|+
literal|55
else|:
name|lo
operator|+
literal|48
operator|)
expr_stmt|;
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|sc
operator|->
name|wmi_handle
argument_list|,
name|method
argument_list|,
operator|&
name|input
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|AE_NOT_FOUND
condition|)
name|status
operator|=
name|AE_OK
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert given two digit hex string (hexin) to an UINT8 referenced  * by byteout.  * Return != 0 if the was a problem (invalid input)  */
end_comment

begin_function
specifier|static
name|__inline
name|int
name|acpi_wmi_hex_to_int
parameter_list|(
specifier|const
name|UINT8
modifier|*
name|hexin
parameter_list|,
name|UINT8
modifier|*
name|byteout
parameter_list|)
block|{
name|unsigned
name|int
name|hi
decl_stmt|;
name|unsigned
name|int
name|lo
decl_stmt|;
name|hi
operator|=
name|hexin
index|[
literal|0
index|]
expr_stmt|;
name|lo
operator|=
name|hexin
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
literal|'0'
operator|<=
name|hi
operator|&&
name|hi
operator|<=
literal|'9'
condition|)
name|hi
operator|-=
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
literal|'A'
operator|<=
name|hi
operator|&&
name|hi
operator|<=
literal|'F'
condition|)
name|hi
operator|-=
operator|(
literal|'A'
operator|-
literal|10
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
literal|'a'
operator|<=
name|hi
operator|&&
name|hi
operator|<=
literal|'f'
condition|)
name|hi
operator|-=
operator|(
literal|'a'
operator|-
literal|10
operator|)
expr_stmt|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
literal|'0'
operator|<=
name|lo
operator|&&
name|lo
operator|<=
literal|'9'
condition|)
name|lo
operator|-=
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
literal|'A'
operator|<=
name|lo
operator|&&
name|lo
operator|<=
literal|'F'
condition|)
name|lo
operator|-=
operator|(
literal|'A'
operator|-
literal|10
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
literal|'a'
operator|<=
name|lo
operator|&&
name|lo
operator|<=
literal|'f'
condition|)
name|lo
operator|-=
operator|(
literal|'a'
operator|-
literal|10
operator|)
expr_stmt|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
operator|*
name|byteout
operator|=
operator|(
name|hi
operator|<<
literal|4
operator|)
operator|+
name|lo
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert a human readable 36 character GUID into a 16byte  * machine readable one.  * The basic algorithm looks as follows:  * Input:  AABBCCDD-EEFF-GGHH-IIJJ-KKLLMMNNOOPP  * Output: DCBAFEHGIJKLMNOP  * (AA BB CC etc. represent two digit hex numbers == bytes)  * Return != 0 if passed guid string is invalid  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_guid_string_to_guid
parameter_list|(
specifier|const
name|UINT8
modifier|*
name|guid_string
parameter_list|,
name|UINT8
modifier|*
name|guid
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|mapping
index|[
literal|20
index|]
init|=
block|{
literal|3
block|,
literal|2
block|,
literal|1
block|,
literal|0
block|,
operator|-
literal|1
block|,
literal|5
block|,
literal|4
block|,
operator|-
literal|1
block|,
literal|7
block|,
literal|6
block|,
operator|-
literal|1
block|,
literal|8
block|,
literal|9
block|,
operator|-
literal|1
block|,
literal|10
block|,
literal|11
block|,
literal|12
block|,
literal|13
block|,
literal|14
block|,
literal|15
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
operator|++
name|i
operator|,
operator|++
name|guid_string
control|)
block|{
if|if
condition|(
name|mapping
index|[
name|i
index|]
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|acpi_wmi_hex_to_int
argument_list|(
name|guid_string
argument_list|,
operator|&
name|guid
index|[
name|mapping
index|[
name|i
index|]
index|]
argument_list|)
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|++
name|guid_string
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|guid_string
operator|!=
literal|'-'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Lookup a wmi_info structure in wmi_list based on a  * human readable GUID  * Return NULL if the GUID is unknown in the _WDG  */
end_comment

begin_function
specifier|static
name|struct
name|wmi_info
modifier|*
name|acpi_wmi_lookup_wmi_info_by_guid_string
parameter_list|(
specifier|const
name|char
modifier|*
name|guid_string
parameter_list|)
block|{
name|char
name|guid
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|acpi_wmi_guid_string_to_guid
argument_list|(
name|guid_string
argument_list|,
name|guid
argument_list|)
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|winfo
argument_list|,
argument|&wmi_info_list
argument_list|,
argument|wmi_list
argument_list|)
block|{
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|winfo
operator|->
name|ginfo
operator|.
name|guid
argument_list|,
name|guid
argument_list|,
literal|16
argument_list|)
condition|)
block|{
return|return
operator|(
name|winfo
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * open wmistat device  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_wmistat_open
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|si_drv1
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|wmistat_open_pid
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|EBUSY
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sbuf_new
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
name|NULL
argument_list|,
literal|4096
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENXIO
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|wmistat_open_pid
operator|=
name|td
operator|->
name|td_proc
operator|->
name|p_pid
expr_stmt|;
name|sc
operator|->
name|wmistat_bufptr
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * close wmistat device  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_wmistat_close
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|si_drv1
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|wmistat_open_pid
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|EBADF
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|wmistat_bufptr
operator|!=
operator|-
literal|1
condition|)
block|{
name|sbuf_delete
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
expr_stmt|;
name|sc
operator|->
name|wmistat_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|sc
operator|->
name|wmistat_open_pid
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read from wmistat guid information  */
end_comment

begin_function
specifier|static
name|int
name|acpi_wmi_wmistat_read
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|struct
name|acpi_wmi_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|wmi_info
modifier|*
name|winfo
decl_stmt|;
name|int
name|l
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|UINT8
modifier|*
name|guid
decl_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|si_drv1
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|wmistat_open_pid
operator|!=
name|buf
operator|->
name|uio_td
operator|->
name|td_proc
operator|->
name|p_pid
operator|||
name|sc
operator|->
name|wmistat_bufptr
operator|==
operator|-
literal|1
condition|)
block|{
name|ret
operator|=
name|EBADF
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|sbuf_done
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
literal|"GUID                 "
literal|"                 INST EXPE METH STR "
literal|"EVENT OID\n"
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|winfo
argument_list|,
argument|&wmi_info_list
argument_list|,
argument|wmi_list
argument_list|)
block|{
name|guid
operator|=
operator|(
name|UINT8
operator|*
operator|)
name|winfo
operator|->
name|ginfo
operator|.
name|guid
expr_stmt|;
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
literal|"{%02X%02X%02X%02X-%02X%02X-"
literal|"%02X%02X-%02X%02X-%02X%02X"
literal|"%02X%02X%02X%02X} %3d %-5s"
argument_list|,
name|guid
index|[
literal|3
index|]
argument_list|,
name|guid
index|[
literal|2
index|]
argument_list|,
name|guid
index|[
literal|1
index|]
argument_list|,
name|guid
index|[
literal|0
index|]
argument_list|,
name|guid
index|[
literal|5
index|]
argument_list|,
name|guid
index|[
literal|4
index|]
argument_list|,
name|guid
index|[
literal|7
index|]
argument_list|,
name|guid
index|[
literal|6
index|]
argument_list|,
name|guid
index|[
literal|8
index|]
argument_list|,
name|guid
index|[
literal|9
index|]
argument_list|,
name|guid
index|[
literal|10
index|]
argument_list|,
name|guid
index|[
literal|11
index|]
argument_list|,
name|guid
index|[
literal|12
index|]
argument_list|,
name|guid
index|[
literal|13
index|]
argument_list|,
name|guid
index|[
literal|14
index|]
argument_list|,
name|guid
index|[
literal|15
index|]
argument_list|,
name|winfo
operator|->
name|ginfo
operator|.
name|max_instance
argument_list|,
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EXPENSIVE
operator|)
condition|?
literal|"YES"
else|:
literal|"NO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_METHOD
condition|)
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
literal|"WM%c%c "
argument_list|,
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
argument_list|,
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
else|else
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
literal|"NO   "
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
literal|"%-4s"
argument_list|,
operator|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_STRING
operator|)
condition|?
literal|"YES"
else|:
literal|"NO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|winfo
operator|->
name|ginfo
operator|.
name|flags
operator|&
name|ACPI_WMI_REGFLAG_EVENT
condition|)
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
literal|"0x%02X%s -\n"
argument_list|,
operator|(
name|UINT8
operator|)
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
argument_list|,
name|winfo
operator|->
name|event_handler
operator|==
name|NULL
condition|?
literal|" "
else|:
literal|"+"
argument_list|)
expr_stmt|;
else|else
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|,
literal|"NO    %c%c\n"
argument_list|,
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|0
index|]
argument_list|,
name|winfo
operator|->
name|ginfo
operator|.
name|oid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|sbuf_finish
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sbuf_len
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|sbuf_delete
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
expr_stmt|;
name|sc
operator|->
name|wmistat_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|wmistat_open_pid
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
block|}
else|else
block|{
name|l
operator|=
name|min
argument_list|(
name|buf
operator|->
name|uio_resid
argument_list|,
name|sbuf_len
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
operator|-
name|sc
operator|->
name|wmistat_bufptr
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|(
name|l
operator|>
literal|0
operator|)
condition|?
name|uiomove
argument_list|(
name|sbuf_data
argument_list|(
operator|&
name|sc
operator|->
name|wmistat_sbuf
argument_list|)
operator|+
name|sc
operator|->
name|wmistat_bufptr
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
else|:
literal|0
expr_stmt|;
name|sc
operator|->
name|wmistat_bufptr
operator|+=
name|l
expr_stmt|;
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|acpi_wmi
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

end_unit


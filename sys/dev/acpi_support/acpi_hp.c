begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009 Michael Gmelin<freebsd@grem.de>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Driver for extra ACPI-controlled features found on HP laptops  * that use a WMI enabled BIOS (e.g. HP Compaq 8510p and 6510p).  * Allows to control and read status of integrated hardware and read  * BIOS settings through CMI.  * Inspired by the hp-wmi driver, which implements a subset of these  * features (hotkeys) on Linux.  *  * HP CMI whitepaper:  *     http://h20331.www2.hp.com/Hpsub/downloads/cmi_whitepaper.pdf  * wmi-hp for Linux:  *     http://www.kernel.org  * WMI and ACPI:  *     http://www.microsoft.com/whdc/system/pnppwr/wmi/wmi-acpi.mspx  */
end_comment

begin_include
include|#
directive|include
file|"opt_acpi.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/acpi.h>
end_include

begin_include
include|#
directive|include
file|<contrib/dev/acpica/include/accommon.h>
end_include

begin_include
include|#
directive|include
file|<dev/acpica/acpivar.h>
end_include

begin_include
include|#
directive|include
file|"acpi_wmi_if.h"
end_include

begin_define
define|#
directive|define
name|_COMPONENT
value|ACPI_OEM
end_define

begin_macro
name|ACPI_MODULE_NAME
argument_list|(
literal|"HP"
argument_list|)
end_macro

begin_define
define|#
directive|define
name|ACPI_HP_WMI_EVENT_GUID
value|"95F24279-4D7B-4334-9387-ACCDC67EF61C"
end_define

begin_define
define|#
directive|define
name|ACPI_HP_WMI_BIOS_GUID
value|"5FB7F034-2C63-45E9-BE91-3D44E2C707E4"
end_define

begin_define
define|#
directive|define
name|ACPI_HP_WMI_CMI_GUID
value|"2D114B49-2DFB-4130-B8FE-4A3C09E75133"
end_define

begin_define
define|#
directive|define
name|ACPI_HP_WMI_DISPLAY_COMMAND
value|0x1
end_define

begin_define
define|#
directive|define
name|ACPI_HP_WMI_HDDTEMP_COMMAND
value|0x2
end_define

begin_define
define|#
directive|define
name|ACPI_HP_WMI_ALS_COMMAND
value|0x3
end_define

begin_define
define|#
directive|define
name|ACPI_HP_WMI_DOCK_COMMAND
value|0x4
end_define

begin_define
define|#
directive|define
name|ACPI_HP_WMI_WIRELESS_COMMAND
value|0x5
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WLAN_ENABLED
value|1
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WLAN_RADIO
value|2
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WLAN_ON_AIR
value|3
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WLAN_ENABLE_IF_RADIO_ON
value|4
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WLAN_DISABLE_IF_RADIO_OFF
value|5
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_BLUETOOTH_ENABLED
value|6
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_BLUETOOTH_RADIO
value|7
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_BLUETOOTH_ON_AIR
value|8
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_BLUETOOTH_ENABLE_IF_RADIO_ON
value|9
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_BLUETOOTH_DISABLE_IF_RADIO_OFF
value|10
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WWAN_ENABLED
value|11
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WWAN_RADIO
value|12
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WWAN_ON_AIR
value|13
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WWAN_ENABLE_IF_RADIO_ON
value|14
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_WWAN_DISABLE_IF_RADIO_OFF
value|15
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_ALS
value|16
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_DISPLAY
value|17
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_HDDTEMP
value|18
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_DOCK
value|19
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_CMI_DETAIL
value|20
end_define

begin_define
define|#
directive|define
name|ACPI_HP_METHOD_VERBOSE
value|21
end_define

begin_define
define|#
directive|define
name|HP_MASK_WWAN_ON_AIR
value|0x1000000
end_define

begin_define
define|#
directive|define
name|HP_MASK_BLUETOOTH_ON_AIR
value|0x10000
end_define

begin_define
define|#
directive|define
name|HP_MASK_WLAN_ON_AIR
value|0x100
end_define

begin_define
define|#
directive|define
name|HP_MASK_WWAN_RADIO
value|0x8000000
end_define

begin_define
define|#
directive|define
name|HP_MASK_BLUETOOTH_RADIO
value|0x80000
end_define

begin_define
define|#
directive|define
name|HP_MASK_WLAN_RADIO
value|0x800
end_define

begin_define
define|#
directive|define
name|HP_MASK_WWAN_ENABLED
value|0x2000000
end_define

begin_define
define|#
directive|define
name|HP_MASK_BLUETOOTH_ENABLED
value|0x20000
end_define

begin_define
define|#
directive|define
name|HP_MASK_WLAN_ENABLED
value|0x200
end_define

begin_define
define|#
directive|define
name|ACPI_HP_CMI_DETAIL_PATHS
value|0x01
end_define

begin_define
define|#
directive|define
name|ACPI_HP_CMI_DETAIL_ENUMS
value|0x02
end_define

begin_define
define|#
directive|define
name|ACPI_HP_CMI_DETAIL_FLAGS
value|0x04
end_define

begin_define
define|#
directive|define
name|ACPI_HP_CMI_DETAIL_SHOW_MAX_INSTANCE
value|0x08
end_define

begin_struct
struct|struct
name|acpi_hp_inst_seq_pair
block|{
name|UINT32
name|sequence
decl_stmt|;
comment|/* sequence number as suggested by cmi bios */
name|UINT8
name|instance
decl_stmt|;
comment|/* object instance on guid */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|acpi_hp_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|device_t
name|wmi_dev
decl_stmt|;
name|int
name|has_notify
decl_stmt|;
comment|/* notification GUID found */
name|int
name|has_cmi
decl_stmt|;
comment|/* CMI GUID found */
name|int
name|cmi_detail
decl_stmt|;
comment|/* CMI detail level 						   (set by sysctl) */
name|int
name|verbose
decl_stmt|;
comment|/* add debug output */
name|int
name|wlan_enable_if_radio_on
decl_stmt|;
comment|/* set by sysctl */
name|int
name|wlan_disable_if_radio_off
decl_stmt|;
comment|/* set by sysctl */
name|int
name|bluetooth_enable_if_radio_on
decl_stmt|;
comment|/* set by sysctl */
name|int
name|bluetooth_disable_if_radio_off
decl_stmt|;
comment|/* set by sysctl */
name|int
name|wwan_enable_if_radio_on
decl_stmt|;
comment|/* set by sysctl */
name|int
name|wwan_disable_if_radio_off
decl_stmt|;
comment|/* set by sysctl */
name|int
name|was_wlan_on_air
decl_stmt|;
comment|/* last known WLAN 							   on air status */
name|int
name|was_bluetooth_on_air
decl_stmt|;
comment|/* last known BT 							   on air status */
name|int
name|was_wwan_on_air
decl_stmt|;
comment|/* last known WWAN 							   on air status */
name|struct
name|sysctl_ctx_list
modifier|*
name|sysctl_ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|sysctl_tree
decl_stmt|;
name|struct
name|cdev
modifier|*
name|hpcmi_dev_t
decl_stmt|;
comment|/* hpcmi device handle */
name|struct
name|sbuf
name|hpcmi_sbuf
decl_stmt|;
comment|/* /dev/hpcmi output sbuf */
name|pid_t
name|hpcmi_open_pid
decl_stmt|;
comment|/* pid operating on 						   /dev/hpcmi */
name|int
name|hpcmi_bufptr
decl_stmt|;
comment|/* current pointer position 						   in /dev/hpcmi output buffer 						 */
name|int
name|cmi_order_size
decl_stmt|;
comment|/* size of cmi_order list */
name|struct
name|acpi_hp_inst_seq_pair
name|cmi_order
index|[
literal|128
index|]
decl_stmt|;
comment|/* list of CMI 			     instances ordered by BIOS suggested sequence */
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|method
decl_stmt|;
name|char
modifier|*
name|description
decl_stmt|;
name|int
name|flag_rdonly
decl_stmt|;
block|}
name|acpi_hp_sysctls
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"wlan_enabled"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WLAN_ENABLED
block|,
operator|.
name|description
operator|=
literal|"Enable/Disable WLAN (WiFi)"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"wlan_radio"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WLAN_RADIO
block|,
operator|.
name|description
operator|=
literal|"WLAN radio status"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"wlan_on_air"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WLAN_ON_AIR
block|,
operator|.
name|description
operator|=
literal|"WLAN radio ready to use (enabled and radio)"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"wlan_enable_if_radio_on"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WLAN_ENABLE_IF_RADIO_ON
block|,
operator|.
name|description
operator|=
literal|"Enable WLAN if radio is turned on"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"wlan_disable_if_radio_off"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WLAN_DISABLE_IF_RADIO_OFF
block|,
operator|.
name|description
operator|=
literal|"Disable WLAN if radio is turned off"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"bt_enabled"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_BLUETOOTH_ENABLED
block|,
operator|.
name|description
operator|=
literal|"Enable/Disable Bluetooth"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"bt_radio"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_BLUETOOTH_RADIO
block|,
operator|.
name|description
operator|=
literal|"Bluetooth radio status"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"bt_on_air"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_BLUETOOTH_ON_AIR
block|,
operator|.
name|description
operator|=
literal|"Bluetooth radio ready to use"
literal|" (enabled and radio)"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"bt_enable_if_radio_on"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_BLUETOOTH_ENABLE_IF_RADIO_ON
block|,
operator|.
name|description
operator|=
literal|"Enable bluetooth if radio is turned on"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"bt_disable_if_radio_off"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_BLUETOOTH_DISABLE_IF_RADIO_OFF
block|,
operator|.
name|description
operator|=
literal|"Disable bluetooth if radio is turned off"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"wwan_enabled"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WWAN_ENABLED
block|,
operator|.
name|description
operator|=
literal|"Enable/Disable WWAN (UMTS)"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"wwan_radio"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WWAN_RADIO
block|,
operator|.
name|description
operator|=
literal|"WWAN radio status"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"wwan_on_air"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WWAN_ON_AIR
block|,
operator|.
name|description
operator|=
literal|"WWAN radio ready to use (enabled and radio)"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"wwan_enable_if_radio_on"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WWAN_ENABLE_IF_RADIO_ON
block|,
operator|.
name|description
operator|=
literal|"Enable WWAN if radio is turned on"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"wwan_disable_if_radio_off"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_WWAN_DISABLE_IF_RADIO_OFF
block|,
operator|.
name|description
operator|=
literal|"Disable WWAN if radio is turned off"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"als_enabled"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_ALS
block|,
operator|.
name|description
operator|=
literal|"Enable/Disable ALS (Ambient light sensor)"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"display"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_DISPLAY
block|,
operator|.
name|description
operator|=
literal|"Display status"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"hdd_temperature"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_HDDTEMP
block|,
operator|.
name|description
operator|=
literal|"HDD temperature"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"is_docked"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_DOCK
block|,
operator|.
name|description
operator|=
literal|"Docking station status"
block|,
operator|.
name|flag_rdonly
operator|=
literal|1
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"cmi_detail"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_CMI_DETAIL
block|,
operator|.
name|description
operator|=
literal|"Details shown in CMI output "
literal|"(cat /dev/hpcmi)"
block|, 	}
block|,
block|{
operator|.
name|name
operator|=
literal|"verbose"
block|,
operator|.
name|method
operator|=
name|ACPI_HP_METHOD_VERBOSE
block|,
operator|.
name|description
operator|=
literal|"Verbosity level"
block|, 	}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_expr_stmt
name|ACPI_SERIAL_DECL
argument_list|(
name|hp
argument_list|,
literal|"HP ACPI-WMI Mapping"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|void
name|acpi_hp_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_hp_evaluate_auto_on_off
parameter_list|(
name|struct
name|acpi_hp_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_sysctl_set
parameter_list|(
name|struct
name|acpi_hp_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|arg
parameter_list|,
name|int
name|oldarg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_sysctl_get
parameter_list|(
name|struct
name|acpi_hp_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_exec_wmi_command
parameter_list|(
name|device_t
name|wmi_dev
parameter_list|,
name|int
name|command
parameter_list|,
name|int
name|is_write
parameter_list|,
name|int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_hp_notify
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acpi_hp_get_cmi_block
parameter_list|(
name|device_t
name|wmi_dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid
parameter_list|,
name|UINT8
name|instance
parameter_list|,
name|char
modifier|*
name|outbuf
parameter_list|,
name|size_t
name|outsize
parameter_list|,
name|UINT32
modifier|*
name|sequence
parameter_list|,
name|int
name|detail
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|acpi_hp_hex_decode
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|d_open_t
name|acpi_hp_hpcmi_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|acpi_hp_hpcmi_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_read_t
name|acpi_hp_hpcmi_read
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* handler /dev/hpcmi device */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|hpcmi_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_open
operator|=
name|acpi_hp_hpcmi_open
block|,
operator|.
name|d_close
operator|=
name|acpi_hp_hpcmi_close
block|,
operator|.
name|d_read
operator|=
name|acpi_hp_hpcmi_read
block|,
operator|.
name|d_name
operator|=
literal|"hpcmi"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|acpi_hp_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|acpi_hp_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|acpi_hp_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|acpi_hp_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|acpi_hp_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|acpi_hp_driver
init|=
block|{
literal|"acpi_hp"
block|,
name|acpi_hp_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|acpi_hp_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|acpi_hp_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|acpi_hp
argument_list|,
name|acpi_wmi
argument_list|,
name|acpi_hp_driver
argument_list|,
name|acpi_hp_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|acpi_hp
argument_list|,
name|acpi_wmi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|acpi_hp
argument_list|,
name|acpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|acpi_hp_evaluate_auto_on_off
parameter_list|(
name|struct
name|acpi_hp_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|wireless
decl_stmt|;
name|int
name|new_wlan_status
decl_stmt|;
name|int
name|new_bluetooth_status
decl_stmt|;
name|int
name|new_wwan_status
decl_stmt|;
name|wireless
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|new_wlan_status
operator|=
operator|-
literal|1
expr_stmt|;
name|new_bluetooth_status
operator|=
operator|-
literal|1
expr_stmt|;
name|new_wwan_status
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|verbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"Wireless status is %x\n"
argument_list|,
name|wireless
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|wlan_disable_if_radio_off
operator|&&
operator|!
operator|(
name|wireless
operator|&
name|HP_MASK_WLAN_RADIO
operator|)
operator|&&
operator|(
name|wireless
operator|&
name|HP_MASK_WLAN_ENABLED
operator|)
condition|)
block|{
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
literal|0x100
argument_list|)
expr_stmt|;
name|new_wlan_status
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|wlan_enable_if_radio_on
operator|&&
operator|(
name|wireless
operator|&
name|HP_MASK_WLAN_RADIO
operator|)
operator|&&
operator|!
operator|(
name|wireless
operator|&
name|HP_MASK_WLAN_ENABLED
operator|)
condition|)
block|{
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
name|new_wlan_status
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|bluetooth_disable_if_radio_off
operator|&&
operator|!
operator|(
name|wireless
operator|&
name|HP_MASK_BLUETOOTH_RADIO
operator|)
operator|&&
operator|(
name|wireless
operator|&
name|HP_MASK_BLUETOOTH_ENABLED
operator|)
condition|)
block|{
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
name|new_bluetooth_status
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|bluetooth_enable_if_radio_on
operator|&&
operator|(
name|wireless
operator|&
name|HP_MASK_BLUETOOTH_RADIO
operator|)
operator|&&
operator|!
operator|(
name|wireless
operator|&
name|HP_MASK_BLUETOOTH_ENABLED
operator|)
condition|)
block|{
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
literal|0x202
argument_list|)
expr_stmt|;
name|new_bluetooth_status
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|wwan_disable_if_radio_off
operator|&&
operator|!
operator|(
name|wireless
operator|&
name|HP_MASK_WWAN_RADIO
operator|)
operator|&&
operator|(
name|wireless
operator|&
name|HP_MASK_WWAN_ENABLED
operator|)
condition|)
block|{
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
name|new_wwan_status
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|wwan_enable_if_radio_on
operator|&&
operator|(
name|wireless
operator|&
name|HP_MASK_WWAN_RADIO
operator|)
operator|&&
operator|!
operator|(
name|wireless
operator|&
name|HP_MASK_WWAN_ENABLED
operator|)
condition|)
block|{
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
literal|0x404
argument_list|)
expr_stmt|;
name|new_wwan_status
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|new_wlan_status
operator|==
operator|-
literal|1
condition|)
block|{
name|new_wlan_status
operator|=
operator|(
name|wireless
operator|&
name|HP_MASK_WLAN_ON_AIR
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_wlan_status
condition|?
literal|1
else|:
literal|0
operator|)
operator|!=
name|sc
operator|->
name|was_wlan_on_air
condition|)
block|{
name|sc
operator|->
name|was_wlan_on_air
operator|=
name|sc
operator|->
name|was_wlan_on_air
condition|?
literal|0
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|verbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"WLAN on air changed to %i "
literal|"(new_wlan_status is %i)\n"
argument_list|,
name|sc
operator|->
name|was_wlan_on_air
argument_list|,
name|new_wlan_status
argument_list|)
expr_stmt|;
name|acpi_UserNotify
argument_list|(
literal|"HP"
argument_list|,
name|ACPI_ROOT_OBJECT
argument_list|,
literal|0xc0
operator|+
name|sc
operator|->
name|was_wlan_on_air
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|new_bluetooth_status
operator|==
operator|-
literal|1
condition|)
block|{
name|new_bluetooth_status
operator|=
operator|(
name|wireless
operator|&
name|HP_MASK_BLUETOOTH_ON_AIR
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_bluetooth_status
condition|?
literal|1
else|:
literal|0
operator|)
operator|!=
name|sc
operator|->
name|was_bluetooth_on_air
condition|)
block|{
name|sc
operator|->
name|was_bluetooth_on_air
operator|=
name|sc
operator|->
name|was_bluetooth_on_air
condition|?
literal|0
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|verbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"BLUETOOTH on air changed"
literal|" to %i (new_bluetooth_status is %i)\n"
argument_list|,
name|sc
operator|->
name|was_bluetooth_on_air
argument_list|,
name|new_bluetooth_status
argument_list|)
expr_stmt|;
name|acpi_UserNotify
argument_list|(
literal|"HP"
argument_list|,
name|ACPI_ROOT_OBJECT
argument_list|,
literal|0xd0
operator|+
name|sc
operator|->
name|was_bluetooth_on_air
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|new_wwan_status
operator|==
operator|-
literal|1
condition|)
block|{
name|new_wwan_status
operator|=
operator|(
name|wireless
operator|&
name|HP_MASK_WWAN_ON_AIR
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_wwan_status
condition|?
literal|1
else|:
literal|0
operator|)
operator|!=
name|sc
operator|->
name|was_wwan_on_air
condition|)
block|{
name|sc
operator|->
name|was_wwan_on_air
operator|=
name|sc
operator|->
name|was_wwan_on_air
condition|?
literal|0
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|verbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
literal|"WWAN on air changed to %i"
literal|" (new_wwan_status is %i)\n"
argument_list|,
name|sc
operator|->
name|was_wwan_on_air
argument_list|,
name|new_wwan_status
argument_list|)
expr_stmt|;
name|acpi_UserNotify
argument_list|(
literal|"HP"
argument_list|,
name|ACPI_ROOT_OBJECT
argument_list|,
literal|0xe0
operator|+
name|sc
operator|->
name|was_wwan_on_air
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_hp_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
comment|/* Don't do anything if driver is disabled. */
if|if
condition|(
name|acpi_disabled
argument_list|(
literal|"hp"
argument_list|)
condition|)
return|return;
comment|/* Add only a single device instance. */
if|if
condition|(
name|device_find_child
argument_list|(
name|parent
argument_list|,
literal|"acpi_hp"
argument_list|,
operator|-
literal|1
argument_list|)
operator|!=
name|NULL
condition|)
return|return;
if|if
condition|(
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
literal|"acpi_hp"
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|NULL
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"add acpi_hp child failed\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_hp_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"HP ACPI-WMI Mapping"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_hp_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_hp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|arg
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|has_notify
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|has_cmi
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|bluetooth_enable_if_radio_on
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|bluetooth_disable_if_radio_off
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|wlan_enable_if_radio_on
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|wlan_disable_if_radio_off
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|wlan_enable_if_radio_on
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|wlan_disable_if_radio_off
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|was_wlan_on_air
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|was_bluetooth_on_air
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|was_wwan_on_air
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|cmi_detail
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|cmi_order_size
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|verbose
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|sc
operator|->
name|cmi_order
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|cmi_order
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|wmi_dev
operator|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ACPI_WMI_PROVIDES_GUID_STRING
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_BIOS_GUID
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WMI device does not provide the HP BIOS GUID\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|ACPI_WMI_PROVIDES_GUID_STRING
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_EVENT_GUID
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"HP event GUID detected, installing event handler\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ACPI_WMI_INSTALL_EVENT_HANDLER
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_EVENT_GUID
argument_list|,
name|acpi_hp_notify
argument_list|,
name|dev
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Could not install notification handler!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|has_notify
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|sc
operator|->
name|has_cmi
operator|=
name|ACPI_WMI_PROVIDES_GUID_STRING
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_CMI_GUID
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"HP CMI GUID detected\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|has_cmi
condition|)
block|{
name|sc
operator|->
name|hpcmi_dev_t
operator|=
name|make_dev
argument_list|(
operator|&
name|hpcmi_cdevsw
argument_list|,
literal|0
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0644
argument_list|,
literal|"hpcmi"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hpcmi_dev_t
operator|->
name|si_drv1
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|hpcmi_open_pid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|hpcmi_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|ACPI_SERIAL_BEGIN
argument_list|(
name|hp
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sysctl_ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sysctl_tree
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
operator|++
name|i
control|)
block|{
name|arg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|sc
operator|->
name|has_notify
operator|&&
operator|(
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_WLAN_ENABLE_IF_RADIO_ON
operator|||
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_WLAN_DISABLE_IF_RADIO_OFF
operator|||
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_BLUETOOTH_ENABLE_IF_RADIO_ON
operator|||
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_BLUETOOTH_DISABLE_IF_RADIO_OFF
operator|||
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_WWAN_ENABLE_IF_RADIO_ON
operator|||
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_WWAN_DISABLE_IF_RADIO_OFF
operator|)
operator|)
operator|||
operator|(
name|arg
operator|=
name|acpi_hp_sysctl_get
argument_list|(
name|sc
argument_list|,
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_WLAN_ON_AIR
condition|)
block|{
name|sc
operator|->
name|was_wlan_on_air
operator|=
name|arg
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_BLUETOOTH_ON_AIR
condition|)
block|{
name|sc
operator|->
name|was_bluetooth_on_air
operator|=
name|arg
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|method
operator|==
name|ACPI_HP_METHOD_WWAN_ON_AIR
condition|)
block|{
name|sc
operator|->
name|was_wwan_on_air
operator|=
name|arg
expr_stmt|;
block|}
if|if
condition|(
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|flag_rdonly
operator|!=
literal|0
condition|)
block|{
name|SYSCTL_ADD_PROC
argument_list|(
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
name|i
argument_list|,
name|acpi_hp_sysctl
argument_list|,
literal|"I"
argument_list|,
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|description
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SYSCTL_ADD_PROC
argument_list|(
name|sc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
name|i
argument_list|,
name|acpi_hp_sysctl
argument_list|,
literal|"I"
argument_list|,
name|acpi_hp_sysctls
index|[
name|i
index|]
operator|.
name|description
argument_list|)
expr_stmt|;
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|hp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_hp_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|acpi_hp_softc
modifier|*
name|sc
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|has_cmi
operator|&&
name|sc
operator|->
name|hpcmi_open_pid
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBUSY
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|has_notify
condition|)
name|ACPI_WMI_REMOVE_EVENT_HANDLER
argument_list|(
name|dev
argument_list|,
name|ACPI_HP_WMI_EVENT_GUID
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|has_cmi
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|hpcmi_bufptr
operator|!=
operator|-
literal|1
condition|)
block|{
name|sbuf_delete
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hpcmi_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|sc
operator|->
name|hpcmi_open_pid
operator|=
literal|0
expr_stmt|;
name|destroy_dev
argument_list|(
name|sc
operator|->
name|hpcmi_dev_t
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_hp_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|acpi_hp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|arg
decl_stmt|;
name|int
name|oldarg
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|function
decl_stmt|;
name|int
name|method
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|(
expr|struct
name|acpi_hp_softc
operator|*
operator|)
name|oidp
operator|->
name|oid_arg1
expr_stmt|;
name|function
operator|=
name|oidp
operator|->
name|oid_arg2
expr_stmt|;
name|method
operator|=
name|acpi_hp_sysctls
index|[
name|function
index|]
operator|.
name|method
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|hp
argument_list|)
expr_stmt|;
name|arg
operator|=
name|acpi_hp_sysctl_get
argument_list|(
name|sc
argument_list|,
name|method
argument_list|)
expr_stmt|;
name|oldarg
operator|=
name|arg
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|arg
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
operator|&&
name|req
operator|->
name|newptr
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|acpi_hp_sysctl_set
argument_list|(
name|sc
argument_list|,
name|method
argument_list|,
name|arg
argument_list|,
name|oldarg
argument_list|)
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|hp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_hp_sysctl_get
parameter_list|(
name|struct
name|acpi_hp_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|)
block|{
name|int
name|val
init|=
literal|0
decl_stmt|;
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|hp
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|method
condition|)
block|{
case|case
name|ACPI_HP_METHOD_WLAN_ENABLED
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_WLAN_ENABLED
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WLAN_RADIO
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_WLAN_RADIO
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WLAN_ON_AIR
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_WLAN_ON_AIR
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WLAN_ENABLE_IF_RADIO_ON
case|:
name|val
operator|=
name|sc
operator|->
name|wlan_enable_if_radio_on
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WLAN_DISABLE_IF_RADIO_OFF
case|:
name|val
operator|=
name|sc
operator|->
name|wlan_disable_if_radio_off
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_ENABLED
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_BLUETOOTH_ENABLED
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_RADIO
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_BLUETOOTH_RADIO
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_ON_AIR
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_BLUETOOTH_ON_AIR
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_ENABLE_IF_RADIO_ON
case|:
name|val
operator|=
name|sc
operator|->
name|bluetooth_enable_if_radio_on
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_DISABLE_IF_RADIO_OFF
case|:
name|val
operator|=
name|sc
operator|->
name|bluetooth_disable_if_radio_off
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WWAN_ENABLED
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_WWAN_ENABLED
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WWAN_RADIO
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_WWAN_RADIO
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WWAN_ON_AIR
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
operator|(
name|val
operator|&
name|HP_MASK_WWAN_ON_AIR
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WWAN_ENABLE_IF_RADIO_ON
case|:
name|val
operator|=
name|sc
operator|->
name|wwan_enable_if_radio_on
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WWAN_DISABLE_IF_RADIO_OFF
case|:
name|val
operator|=
name|sc
operator|->
name|wwan_disable_if_radio_off
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_ALS
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_ALS_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_DISPLAY
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_DISPLAY_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_HDDTEMP
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_HDDTEMP_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_DOCK
case|:
name|val
operator|=
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_DOCK_COMMAND
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_CMI_DETAIL
case|:
name|val
operator|=
name|sc
operator|->
name|cmi_detail
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_VERBOSE
case|:
name|val
operator|=
name|sc
operator|->
name|verbose
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_hp_sysctl_set
parameter_list|(
name|struct
name|acpi_hp_softc
modifier|*
name|sc
parameter_list|,
name|int
name|method
parameter_list|,
name|int
name|arg
parameter_list|,
name|int
name|oldarg
parameter_list|)
block|{
name|ACPI_FUNCTION_TRACE
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|)
expr_stmt|;
name|ACPI_SERIAL_ASSERT
argument_list|(
name|hp
argument_list|)
expr_stmt|;
if|if
condition|(
name|method
operator|!=
name|ACPI_HP_METHOD_CMI_DETAIL
operator|&&
name|method
operator|!=
name|ACPI_HP_METHOD_VERBOSE
condition|)
name|arg
operator|=
name|arg
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|arg
operator|!=
name|oldarg
condition|)
block|{
switch|switch
condition|(
name|method
condition|)
block|{
case|case
name|ACPI_HP_METHOD_WLAN_ENABLED
case|:
return|return
operator|(
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
name|arg
condition|?
literal|0x101
else|:
literal|0x100
argument_list|)
operator|)
return|;
case|case
name|ACPI_HP_METHOD_WLAN_ENABLE_IF_RADIO_ON
case|:
name|sc
operator|->
name|wlan_enable_if_radio_on
operator|=
name|arg
expr_stmt|;
name|acpi_hp_evaluate_auto_on_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WLAN_DISABLE_IF_RADIO_OFF
case|:
name|sc
operator|->
name|wlan_disable_if_radio_off
operator|=
name|arg
expr_stmt|;
name|acpi_hp_evaluate_auto_on_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_ENABLED
case|:
return|return
operator|(
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
name|arg
condition|?
literal|0x202
else|:
literal|0x200
argument_list|)
operator|)
return|;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_ENABLE_IF_RADIO_ON
case|:
name|sc
operator|->
name|bluetooth_enable_if_radio_on
operator|=
name|arg
expr_stmt|;
name|acpi_hp_evaluate_auto_on_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_BLUETOOTH_DISABLE_IF_RADIO_OFF
case|:
name|sc
operator|->
name|bluetooth_disable_if_radio_off
operator|=
name|arg
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|acpi_hp_evaluate_auto_on_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WWAN_ENABLED
case|:
return|return
operator|(
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_WIRELESS_COMMAND
argument_list|,
literal|1
argument_list|,
name|arg
condition|?
literal|0x404
else|:
literal|0x400
argument_list|)
operator|)
return|;
case|case
name|ACPI_HP_METHOD_WWAN_ENABLE_IF_RADIO_ON
case|:
name|sc
operator|->
name|wwan_enable_if_radio_on
operator|=
name|arg
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|acpi_hp_evaluate_auto_on_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_WWAN_DISABLE_IF_RADIO_OFF
case|:
name|sc
operator|->
name|wwan_disable_if_radio_off
operator|=
name|arg
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|acpi_hp_evaluate_auto_on_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|ACPI_HP_METHOD_ALS
case|:
return|return
operator|(
name|acpi_hp_exec_wmi_command
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_ALS_COMMAND
argument_list|,
literal|1
argument_list|,
name|arg
condition|?
literal|1
else|:
literal|0
argument_list|)
operator|)
return|;
case|case
name|ACPI_HP_METHOD_CMI_DETAIL
case|:
name|sc
operator|->
name|cmi_detail
operator|=
name|arg
expr_stmt|;
if|if
condition|(
operator|(
name|arg
operator|&
name|ACPI_HP_CMI_DETAIL_SHOW_MAX_INSTANCE
operator|)
operator|!=
operator|(
name|oldarg
operator|&
name|ACPI_HP_CMI_DETAIL_SHOW_MAX_INSTANCE
operator|)
condition|)
block|{
name|sc
operator|->
name|cmi_order_size
operator|=
operator|-
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|ACPI_HP_METHOD_VERBOSE
case|:
name|sc
operator|->
name|verbose
operator|=
name|arg
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|acpi_hp_free_buffer
parameter_list|(
name|ACPI_BUFFER
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|buf
operator|&&
name|buf
operator|->
name|Pointer
condition|)
block|{
name|AcpiOsFree
argument_list|(
name|buf
operator|->
name|Pointer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_hp_notify
parameter_list|(
name|ACPI_HANDLE
name|h
parameter_list|,
name|UINT32
name|notify
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|context
decl_stmt|;
name|ACPI_FUNCTION_TRACE_U32
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|__func__
argument_list|,
name|notify
argument_list|)
expr_stmt|;
name|struct
name|acpi_hp_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|ACPI_BUFFER
name|response
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|obj
decl_stmt|;
name|ACPI_WMI_GET_EVENT_DATA
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|notify
argument_list|,
operator|&
name|response
argument_list|)
expr_stmt|;
name|obj
operator|=
operator|(
name|ACPI_OBJECT
operator|*
operator|)
name|response
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|obj
operator|&&
name|obj
operator|->
name|Type
operator|==
name|ACPI_TYPE_BUFFER
operator|&&
name|obj
operator|->
name|Buffer
operator|.
name|Length
operator|==
literal|8
condition|)
block|{
if|if
condition|(
operator|*
operator|(
operator|(
name|UINT8
operator|*
operator|)
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
operator|)
operator|==
literal|0x5
condition|)
block|{
name|acpi_hp_evaluate_auto_on_off
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|acpi_hp_free_buffer
argument_list|(
operator|&
name|response
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|acpi_hp_exec_wmi_command
parameter_list|(
name|device_t
name|wmi_dev
parameter_list|,
name|int
name|command
parameter_list|,
name|int
name|is_write
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|UINT32
name|params
index|[
literal|5
index|]
init|=
block|{
literal|0x55434553
block|,
name|is_write
operator|?
literal|2
operator|:
literal|1
block|,
name|command
block|,
name|is_write
operator|?
literal|4
operator|:
literal|0
block|,
name|val
block|}
decl_stmt|;
name|UINT32
modifier|*
name|result
decl_stmt|;
name|ACPI_OBJECT
modifier|*
name|obj
decl_stmt|;
name|ACPI_BUFFER
name|in
init|=
block|{
sizeof|sizeof
argument_list|(
name|params
argument_list|)
block|,
operator|&
name|params
block|}
decl_stmt|;
name|ACPI_BUFFER
name|out
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|int
name|retval
decl_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|ACPI_WMI_EVALUATE_CALL
argument_list|(
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_BIOS_GUID
argument_list|,
literal|0
argument_list|,
literal|0x3
argument_list|,
operator|&
name|in
argument_list|,
operator|&
name|out
argument_list|)
argument_list|)
condition|)
block|{
name|acpi_hp_free_buffer
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
name|obj
operator|=
name|out
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
operator|!
name|obj
operator|||
name|obj
operator|->
name|Type
operator|!=
name|ACPI_TYPE_BUFFER
condition|)
block|{
name|acpi_hp_free_buffer
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
name|result
operator|=
operator|(
name|UINT32
operator|*
operator|)
name|obj
operator|->
name|Buffer
operator|.
name|Pointer
expr_stmt|;
name|retval
operator|=
name|result
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|result
index|[
literal|1
index|]
operator|>
literal|0
condition|)
block|{
name|retval
operator|=
name|result
index|[
literal|1
index|]
expr_stmt|;
block|}
name|acpi_hp_free_buffer
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|char
modifier|*
name|acpi_hp_get_string_from_object
parameter_list|(
name|ACPI_OBJECT
modifier|*
name|obj
parameter_list|,
name|char
modifier|*
name|dst
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|dst
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|obj
operator|->
name|Type
operator|==
name|ACPI_TYPE_STRING
condition|)
block|{
name|length
operator|=
name|obj
operator|->
name|String
operator|.
name|Length
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|length
operator|>
name|size
condition|)
block|{
name|length
operator|=
name|size
operator|-
literal|1
expr_stmt|;
block|}
name|strlcpy
argument_list|(
name|dst
argument_list|,
name|obj
operator|->
name|String
operator|.
name|Pointer
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|acpi_hp_hex_decode
argument_list|(
name|dst
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|dst
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read BIOS Setting block in instance "instance".  * The block returned is ACPI_TYPE_PACKAGE which should contain the following  * elements:  * Index Meaning  * 0        Setting Name [string]  * 1        Value (comma separated, asterisk marks the current value) [string]  * 2        Path within the bios hierarchy [string]  * 3        IsReadOnly [int]  * 4        DisplayInUI [int]  * 5        RequiresPhysicalPresence [int]  * 6        Sequence for ordering within the bios settings (absolute) [int]  * 7        Length of prerequisites array [int]  * 8..8+[7] PrerequisiteN [string]  * 9+[7]    Current value (in case of enum) [string] / Array length [int]  * 10+[7]   Enum length [int] / Array values  * 11+[7]ff Enum value at index x [string]  */
end_comment

begin_function
specifier|static
name|int
name|acpi_hp_get_cmi_block
parameter_list|(
name|device_t
name|wmi_dev
parameter_list|,
specifier|const
name|char
modifier|*
name|guid
parameter_list|,
name|UINT8
name|instance
parameter_list|,
name|char
modifier|*
name|outbuf
parameter_list|,
name|size_t
name|outsize
parameter_list|,
name|UINT32
modifier|*
name|sequence
parameter_list|,
name|int
name|detail
parameter_list|)
block|{
name|ACPI_OBJECT
modifier|*
name|obj
decl_stmt|;
name|ACPI_BUFFER
name|out
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|outlen
decl_stmt|;
name|int
name|size
init|=
literal|255
decl_stmt|;
name|int
name|has_enums
init|=
literal|0
decl_stmt|;
name|int
name|valuebase
init|=
literal|0
decl_stmt|;
name|char
name|string_buffer
index|[
name|size
index|]
decl_stmt|;
name|int
name|enumbase
decl_stmt|;
name|outlen
operator|=
literal|0
expr_stmt|;
name|outbuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|ACPI_WMI_GET_BLOCK
argument_list|(
name|wmi_dev
argument_list|,
name|guid
argument_list|,
name|instance
argument_list|,
operator|&
name|out
argument_list|)
argument_list|)
condition|)
block|{
name|acpi_hp_free_buffer
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
name|obj
operator|=
name|out
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
operator|!
name|obj
operator|||
name|obj
operator|->
name|Type
operator|!=
name|ACPI_TYPE_PACKAGE
condition|)
block|{
name|acpi_hp_free_buffer
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|obj
operator|->
name|Package
operator|.
name|Count
operator|>=
literal|8
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|7
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
condition|)
block|{
name|valuebase
operator|=
literal|8
operator|+
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|7
index|]
operator|.
name|Integer
operator|.
name|Value
expr_stmt|;
block|}
comment|/* check if this matches our expectations based on limited knowledge */
if|if
condition|(
name|valuebase
operator|>
literal|7
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Count
operator|>
name|valuebase
operator|+
literal|1
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|0
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_STRING
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|1
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_STRING
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|2
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_STRING
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|3
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|4
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|5
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|6
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
name|valuebase
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_STRING
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
name|valuebase
operator|+
literal|1
index|]
operator|.
name|Type
operator|==
name|ACPI_TYPE_INTEGER
operator|&&
name|obj
operator|->
name|Package
operator|.
name|Count
operator|>
name|valuebase
operator|+
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
name|valuebase
operator|+
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
condition|)
block|{
name|enumbase
operator|=
name|valuebase
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|detail
operator|&
name|ACPI_HP_CMI_DETAIL_PATHS
condition|)
block|{
name|strlcat
argument_list|(
name|outbuf
argument_list|,
name|acpi_hp_get_string_from_object
argument_list|(
operator|&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|2
index|]
argument_list|,
name|string_buffer
argument_list|,
name|size
argument_list|)
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|outlen
operator|+=
literal|48
expr_stmt|;
while|while
condition|(
name|strlen
argument_list|(
name|outbuf
argument_list|)
operator|<
name|outlen
condition|)
name|strlcat
argument_list|(
name|outbuf
argument_list|,
literal|" "
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
block|}
name|strlcat
argument_list|(
name|outbuf
argument_list|,
name|acpi_hp_get_string_from_object
argument_list|(
operator|&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|0
index|]
argument_list|,
name|string_buffer
argument_list|,
name|size
argument_list|)
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|outlen
operator|+=
literal|43
expr_stmt|;
while|while
condition|(
name|strlen
argument_list|(
name|outbuf
argument_list|)
operator|<
name|outlen
condition|)
name|strlcat
argument_list|(
name|outbuf
argument_list|,
literal|" "
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|outbuf
argument_list|,
name|acpi_hp_get_string_from_object
argument_list|(
operator|&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
name|valuebase
index|]
argument_list|,
name|string_buffer
argument_list|,
name|size
argument_list|)
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|outlen
operator|+=
literal|21
expr_stmt|;
while|while
condition|(
name|strlen
argument_list|(
name|outbuf
argument_list|)
operator|<
name|outlen
condition|)
name|strlcat
argument_list|(
name|outbuf
argument_list|,
literal|" "
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|outbuf
argument_list|)
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|outbuf
index|[
name|i
index|]
operator|==
literal|'\\'
condition|)
name|outbuf
index|[
name|i
index|]
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|detail
operator|&
name|ACPI_HP_CMI_DETAIL_ENUMS
condition|)
block|{
for|for
control|(
name|i
operator|=
name|enumbase
operator|+
literal|1
init|;
name|i
operator|<
name|enumbase
operator|+
literal|1
operator|+
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
name|enumbase
index|]
operator|.
name|Integer
operator|.
name|Value
condition|;
operator|++
name|i
control|)
block|{
name|acpi_hp_get_string_from_object
argument_list|(
operator|&
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
name|i
index|]
argument_list|,
name|string_buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|string_buffer
argument_list|)
operator|>
literal|1
operator|||
operator|(
name|strlen
argument_list|(
name|string_buffer
argument_list|)
operator|==
literal|1
operator|&&
name|string_buffer
index|[
literal|0
index|]
operator|!=
literal|' '
operator|)
condition|)
block|{
if|if
condition|(
name|has_enums
condition|)
name|strlcat
argument_list|(
name|outbuf
argument_list|,
literal|"/"
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
else|else
name|strlcat
argument_list|(
name|outbuf
argument_list|,
literal|" ("
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|outbuf
argument_list|,
name|string_buffer
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|has_enums
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|has_enums
condition|)
name|strlcat
argument_list|(
name|outbuf
argument_list|,
literal|")"
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|detail
operator|&
name|ACPI_HP_CMI_DETAIL_FLAGS
condition|)
block|{
name|strlcat
argument_list|(
name|outbuf
argument_list|,
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|3
index|]
operator|.
name|Integer
operator|.
name|Value
condition|?
literal|" [ReadOnly]"
else|:
literal|""
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|outbuf
argument_list|,
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|4
index|]
operator|.
name|Integer
operator|.
name|Value
condition|?
literal|""
else|:
literal|" [NOUI]"
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|outbuf
argument_list|,
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|5
index|]
operator|.
name|Integer
operator|.
name|Value
condition|?
literal|" [RPP]"
else|:
literal|""
argument_list|,
name|outsize
argument_list|)
expr_stmt|;
block|}
operator|*
name|sequence
operator|=
operator|(
name|UINT32
operator|)
name|obj
operator|->
name|Package
operator|.
name|Elements
index|[
literal|6
index|]
operator|.
name|Integer
operator|.
name|Value
expr_stmt|;
block|}
name|acpi_hp_free_buffer
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert given two digit hex string (hexin) to an UINT8 referenced  * by byteout.  * Return != 0 if the was a problem (invalid input)  */
end_comment

begin_function
specifier|static
name|__inline
name|int
name|acpi_hp_hex_to_int
parameter_list|(
specifier|const
name|UINT8
modifier|*
name|hexin
parameter_list|,
name|UINT8
modifier|*
name|byteout
parameter_list|)
block|{
name|unsigned
name|int
name|hi
decl_stmt|;
name|unsigned
name|int
name|lo
decl_stmt|;
name|hi
operator|=
name|hexin
index|[
literal|0
index|]
expr_stmt|;
name|lo
operator|=
name|hexin
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
literal|'0'
operator|<=
name|hi
operator|&&
name|hi
operator|<=
literal|'9'
condition|)
name|hi
operator|-=
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
literal|'A'
operator|<=
name|hi
operator|&&
name|hi
operator|<=
literal|'F'
condition|)
name|hi
operator|-=
operator|(
literal|'A'
operator|-
literal|10
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
literal|'a'
operator|<=
name|hi
operator|&&
name|hi
operator|<=
literal|'f'
condition|)
name|hi
operator|-=
operator|(
literal|'a'
operator|-
literal|10
operator|)
expr_stmt|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
literal|'0'
operator|<=
name|lo
operator|&&
name|lo
operator|<=
literal|'9'
condition|)
name|lo
operator|-=
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
literal|'A'
operator|<=
name|lo
operator|&&
name|lo
operator|<=
literal|'F'
condition|)
name|lo
operator|-=
operator|(
literal|'A'
operator|-
literal|10
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
literal|'a'
operator|<=
name|lo
operator|&&
name|lo
operator|<=
literal|'f'
condition|)
name|lo
operator|-=
operator|(
literal|'a'
operator|-
literal|10
operator|)
expr_stmt|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
operator|*
name|byteout
operator|=
operator|(
name|hi
operator|<<
literal|4
operator|)
operator|+
name|lo
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|acpi_hp_hex_decode
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|length
init|=
name|strlen
argument_list|(
name|buffer
argument_list|)
decl_stmt|;
name|UINT8
modifier|*
name|uin
decl_stmt|;
name|UINT8
name|uout
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|int
operator|)
name|length
operator|/
literal|2
operator|)
operator|*
literal|2
operator|==
name|length
operator|||
name|length
operator|<
literal|10
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|3
operator|)
condition|)
block|{
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|!=
literal|' '
condition|)
return|return;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
operator|(
name|buffer
index|[
name|i
index|]
operator|>=
literal|'0'
operator|&&
name|buffer
index|[
name|i
index|]
operator|<=
literal|'9'
operator|)
operator|||
operator|(
name|buffer
index|[
name|i
index|]
operator|>=
literal|'A'
operator|&&
name|buffer
index|[
name|i
index|]
operator|<=
literal|'F'
operator|)
operator|)
condition|)
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|+=
literal|3
control|)
block|{
name|uin
operator|=
operator|&
name|buffer
index|[
name|i
index|]
expr_stmt|;
name|uout
operator|=
literal|0
expr_stmt|;
name|acpi_hp_hex_to_int
argument_list|(
name|uin
argument_list|,
operator|&
name|uout
argument_list|)
expr_stmt|;
name|buffer
index|[
name|i
operator|/
literal|3
index|]
operator|=
operator|(
name|char
operator|)
name|uout
expr_stmt|;
block|}
name|buffer
index|[
operator|(
name|length
operator|+
literal|1
operator|)
operator|/
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * open hpcmi device  */
end_comment

begin_function
specifier|static
name|int
name|acpi_hp_hpcmi_open
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|acpi_hp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|si_drv1
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|hp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hpcmi_open_pid
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|EBUSY
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sbuf_new
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|,
name|NULL
argument_list|,
literal|4096
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENXIO
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|hpcmi_open_pid
operator|=
name|td
operator|->
name|td_proc
operator|->
name|p_pid
expr_stmt|;
name|sc
operator|->
name|hpcmi_bufptr
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|hp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * close hpcmi device  */
end_comment

begin_function
specifier|static
name|int
name|acpi_hp_hpcmi_close
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|acpi_hp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|si_drv1
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|hp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hpcmi_open_pid
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|EBADF
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|hpcmi_bufptr
operator|!=
operator|-
literal|1
condition|)
block|{
name|sbuf_delete
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hpcmi_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|sc
operator|->
name|hpcmi_open_pid
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|ACPI_SERIAL_END
argument_list|(
name|hp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read from hpcmi bios information  */
end_comment

begin_function
specifier|static
name|int
name|acpi_hp_hpcmi_read
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|struct
name|acpi_hp_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|pos
decl_stmt|,
name|i
decl_stmt|,
name|l
decl_stmt|,
name|ret
decl_stmt|;
name|UINT8
name|instance
decl_stmt|;
name|UINT8
name|maxInstance
decl_stmt|;
name|UINT32
name|sequence
decl_stmt|;
name|int
name|linesize
init|=
literal|1025
decl_stmt|;
name|char
name|line
index|[
name|linesize
index|]
decl_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|si_drv1
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADF
operator|)
return|;
name|sc
operator|=
name|dev
operator|->
name|si_drv1
expr_stmt|;
name|ACPI_SERIAL_BEGIN
argument_list|(
name|hp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hpcmi_open_pid
operator|!=
name|buf
operator|->
name|uio_td
operator|->
name|td_proc
operator|->
name|p_pid
operator|||
name|sc
operator|->
name|hpcmi_bufptr
operator|==
operator|-
literal|1
condition|)
block|{
name|ret
operator|=
name|EBADF
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|sbuf_done
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|cmi_order_size
operator|<
literal|0
condition|)
block|{
name|maxInstance
operator|=
name|sc
operator|->
name|has_cmi
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|cmi_detail
operator|&
name|ACPI_HP_CMI_DETAIL_SHOW_MAX_INSTANCE
operator|)
operator|&&
name|maxInstance
operator|>
literal|0
condition|)
block|{
name|maxInstance
operator|--
expr_stmt|;
block|}
name|sc
operator|->
name|cmi_order_size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|instance
operator|=
literal|0
init|;
name|instance
operator|<
name|maxInstance
condition|;
operator|++
name|instance
control|)
block|{
if|if
condition|(
name|acpi_hp_get_cmi_block
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_CMI_GUID
argument_list|,
name|instance
argument_list|,
name|line
argument_list|,
name|linesize
argument_list|,
operator|&
name|sequence
argument_list|,
name|sc
operator|->
name|cmi_detail
argument_list|)
condition|)
block|{
name|instance
operator|=
name|maxInstance
expr_stmt|;
block|}
else|else
block|{
name|pos
operator|=
name|sc
operator|->
name|cmi_order_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|cmi_order_size
operator|&&
name|i
operator|<
literal|127
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|cmi_order
index|[
name|i
index|]
operator|.
name|sequence
operator|>
name|sequence
condition|)
block|{
name|pos
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
for|for
control|(
name|i
operator|=
name|sc
operator|->
name|cmi_order_size
init|;
name|i
operator|>
name|pos
condition|;
operator|--
name|i
control|)
block|{
name|sc
operator|->
name|cmi_order
index|[
name|i
index|]
operator|.
name|sequence
operator|=
name|sc
operator|->
name|cmi_order
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|sequence
expr_stmt|;
name|sc
operator|->
name|cmi_order
index|[
name|i
index|]
operator|.
name|instance
operator|=
name|sc
operator|->
name|cmi_order
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|instance
expr_stmt|;
block|}
name|sc
operator|->
name|cmi_order
index|[
name|pos
index|]
operator|.
name|sequence
operator|=
name|sequence
expr_stmt|;
name|sc
operator|->
name|cmi_order
index|[
name|pos
index|]
operator|.
name|instance
operator|=
name|instance
expr_stmt|;
name|sc
operator|->
name|cmi_order_size
operator|++
expr_stmt|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|cmi_order_size
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|!
name|acpi_hp_get_cmi_block
argument_list|(
name|sc
operator|->
name|wmi_dev
argument_list|,
name|ACPI_HP_WMI_CMI_GUID
argument_list|,
name|sc
operator|->
name|cmi_order
index|[
name|i
index|]
operator|.
name|instance
argument_list|,
name|line
argument_list|,
name|linesize
argument_list|,
operator|&
name|sequence
argument_list|,
name|sc
operator|->
name|cmi_detail
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|,
literal|"%s\n"
argument_list|,
name|line
argument_list|)
expr_stmt|;
block|}
block|}
name|sbuf_finish
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sbuf_len
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|sbuf_delete
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hpcmi_bufptr
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|hpcmi_open_pid
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
block|}
else|else
block|{
name|l
operator|=
name|min
argument_list|(
name|buf
operator|->
name|uio_resid
argument_list|,
name|sbuf_len
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
operator|-
name|sc
operator|->
name|hpcmi_bufptr
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|(
name|l
operator|>
literal|0
operator|)
condition|?
name|uiomove
argument_list|(
name|sbuf_data
argument_list|(
operator|&
name|sc
operator|->
name|hpcmi_sbuf
argument_list|)
operator|+
name|sc
operator|->
name|hpcmi_bufptr
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
else|:
literal|0
expr_stmt|;
name|sc
operator|->
name|hpcmi_bufptr
operator|+=
name|l
expr_stmt|;
block|}
block|}
name|ACPI_SERIAL_END
argument_list|(
name|hp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

end_unit


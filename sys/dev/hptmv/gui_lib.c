begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003-2004 HighPoint Technologies, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * gui_lib.c  * Copyright (c) 2002-2004 HighPoint Technologies, Inc. All rights reserved.  *  *  Platform independent ioctl interface implementation.  *  The platform dependent part may reuse this function and/or use it own   *  implementation for each ioctl function.  *  *  This implementation doesn't use any synchronization; the caller must  *  assure the proper context when calling these functions.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<dev/hptmv/global.h>
end_include

begin_include
include|#
directive|include
file|<dev/hptmv/hptintf.h>
end_include

begin_include
include|#
directive|include
file|<dev/hptmv/osbsd.h>
end_include

begin_include
include|#
directive|include
file|<dev/hptmv/access601.h>
end_include

begin_function_decl
specifier|static
name|int
name|hpt_get_driver_capabilities
parameter_list|(
name|PDRIVER_CAPABILITIES
name|cap
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_get_controller_count
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_get_controller_info
parameter_list|(
name|int
name|id
parameter_list|,
name|PCONTROLLER_INFO
name|pInfo
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_get_channel_info
parameter_list|(
name|int
name|id
parameter_list|,
name|int
name|bus
parameter_list|,
name|PCHANNEL_INFO
name|pInfo
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_get_logical_devices
parameter_list|(
name|DEVICEID
modifier|*
name|pIds
parameter_list|,
name|int
name|nMaxCount
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_get_device_info
parameter_list|(
name|DEVICEID
name|id
parameter_list|,
name|PLOGICAL_DEVICE_INFO
name|pInfo
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|DEVICEID
name|hpt_create_array
parameter_list|(
name|_VBUS_ARG
name|PCREATE_ARRAY_PARAMS
name|pParam
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_add_spare_disk
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idDisk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_remove_spare_disk
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idDisk
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_set_array_info
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idArray
parameter_list|,
name|PALTERABLE_ARRAY_INFO
name|pInfo
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hpt_set_device_info
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idDisk
parameter_list|,
name|PALTERABLE_DEVICE_INFO
name|pInfo
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|check_VDevice_valid
parameter_list|(
name|PVDevice
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|PVDevice
name|pVDevice
decl_stmt|;
name|PVBus
name|_vbus_p
decl_stmt|;
name|IAL_ADAPTER_T
modifier|*
name|pAdapter
init|=
name|gIal_Adapter
decl_stmt|;
while|while
condition|(
name|pAdapter
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MV_SATA_CHANNELS_NUM
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|&
operator|(
name|pAdapter
operator|->
name|VDevices
index|[
name|i
index|]
operator|)
operator|==
name|p
condition|)
return|return
literal|0
return|;
name|pAdapter
operator|=
name|pAdapter
operator|->
name|next
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SUPPORT_ARRAY
name|pAdapter
operator|=
name|gIal_Adapter
expr_stmt|;
while|while
condition|(
name|pAdapter
operator|!=
literal|0
condition|)
block|{
name|_vbus_p
operator|=
operator|&
name|pAdapter
operator|->
name|VBus
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_ARRAY_PER_VBUS
condition|;
name|i
operator|++
control|)
block|{
name|pVDevice
operator|=
name|ArrayTables
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|dArStamp
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|pVDevice
operator|==
name|p
operator|)
condition|)
return|return
literal|0
return|;
block|}
name|pAdapter
operator|=
name|pAdapter
operator|->
name|next
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SUPPORT_ARRAY
end_ifdef

begin_function
specifier|static
name|void
name|get_array_info
parameter_list|(
name|PVDevice
name|pVDevice
parameter_list|,
name|PLOGICAL_DEVICE_INFO
name|pInfo
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|pInfo
operator|->
name|Type
operator|=
name|LDT_ARRAY
expr_stmt|;
name|pInfo
operator|->
name|Capacity
operator|=
name|pVDevice
operator|->
name|VDeviceCapacity
expr_stmt|;
name|pInfo
operator|->
name|ParentArray
operator|=
name|VDEV_TO_ID
argument_list|(
name|pVDevice
operator|->
name|pParent
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Name
argument_list|,
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
name|MAX_ARRAY_NAME
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pVDevice
operator|->
name|VDeviceType
condition|)
block|{
case|case
name|VD_RAID_0
case|:
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayType
operator|=
name|AT_RAID0
expr_stmt|;
break|break;
case|case
name|VD_RAID_1
case|:
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayType
operator|=
name|AT_RAID1
expr_stmt|;
break|break;
case|case
name|VD_JBOD
case|:
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayType
operator|=
name|AT_JBOD
expr_stmt|;
break|break;
case|case
name|VD_RAID_5
case|:
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayType
operator|=
name|AT_RAID5
expr_stmt|;
break|break;
default|default:
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayType
operator|=
name|AT_UNKNOWN
expr_stmt|;
block|}
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|BlockSizeShift
operator|=
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|bArBlockSizeShift
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|RebuiltSectors
operator|=
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
expr_stmt|;
comment|/* The array is disabled */
if|if
condition|(
operator|!
name|pVDevice
operator|->
name|vf_online
condition|)
block|{
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_DISABLED
expr_stmt|;
goto|goto
name|ignore_info
goto|;
block|}
comment|/* array need synchronizing */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_rebuild
operator|&&
operator|!
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_duplicate_and_create
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_NEEDBUILDING
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildingProgress
operator|=
operator|(
operator|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
operator|>>
literal|11
operator|)
operator|*
literal|1000
operator|/
operator|(
name|pVDevice
operator|->
name|VDeviceCapacity
operator|>>
literal|11
operator|)
operator|*
operator|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|-
literal|1
operator|)
operator|)
operator|*
literal|10
expr_stmt|;
comment|/* array is in rebuilding process */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_rebuilding
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_REBUILDING
expr_stmt|;
comment|/* array is being verified */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_verifying
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_VERIFYING
expr_stmt|;
comment|/* array is being initialized */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_initializing
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_INITIALIZING
expr_stmt|;
comment|/* broken but may still working */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_broken
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_BROKEN
expr_stmt|;
comment|/* array has a active partition */
if|if
condition|(
name|pVDevice
operator|->
name|vf_bootable
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_BOOTDISK
expr_stmt|;
comment|/* a newly created array */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_newly_created
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_NEWLY_CREATED
expr_stmt|;
comment|/* array has boot mark set */
if|if
condition|(
name|pVDevice
operator|->
name|vf_bootmark
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_BOOTMARK
expr_stmt|;
comment|/* auto-rebuild should start */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_auto_rebuild
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_NEED_AUTOREBUILD
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
block|{
name|PVDevice
name|pMember
init|=
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|pMember
operator|||
operator|!
name|pMember
operator|->
name|vf_online
operator|||
operator|(
name|pMember
operator|->
name|VDeviceType
operator|==
name|VD_SINGLE_DISK
operator|)
condition|)
continue|continue;
comment|/* array need synchronizing */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_rebuild
operator|&&
operator|!
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_duplicate_and_create
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_NEEDBUILDING
expr_stmt|;
comment|/* array is in rebuilding process */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_rebuilding
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_REBUILDING
expr_stmt|;
comment|/* array is being verified */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_verifying
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_VERIFYING
expr_stmt|;
comment|/* array is being initialized */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_initializing
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_INITIALIZING
expr_stmt|;
comment|/* broken but may still working */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_broken
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_BROKEN
expr_stmt|;
comment|/* a newly created array */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_newly_created
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_NEWLY_CREATED
expr_stmt|;
comment|/* auto-rebuild should start */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_auto_rebuild
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Flags
operator||=
name|ARRAY_FLAG_NEED_AUTOREBUILD
expr_stmt|;
comment|/* for RAID1/0 case */
if|if
condition|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_rebuilding
operator|||
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_verifying
operator|||
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|rf_initializing
condition|)
block|{
name|DWORD
name|percent
init|=
operator|(
operator|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
operator|>>
literal|11
operator|)
operator|*
literal|1000
operator|/
operator|(
name|pMember
operator|->
name|VDeviceCapacity
operator|>>
literal|11
operator|)
operator|*
operator|(
name|pMember
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|-
literal|1
operator|)
operator|)
operator|*
literal|10
decl_stmt|;
if|if
condition|(
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildingProgress
operator|==
literal|0
operator|||
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildingProgress
operator|>
name|percent
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildingProgress
operator|=
name|percent
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildingProgress
operator|>
literal|10000
condition|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildingProgress
operator|=
literal|10000
expr_stmt|;
name|ignore_info
label|:
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|nDisk
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_ARRAY_MEMBERS
condition|;
name|i
operator|++
control|)
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Members
index|[
name|i
index|]
operator|=
name|INVALID_DEVICEID
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|Members
index|[
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|nDisk
index|]
operator|=
name|VDEV_TO_ID
argument_list|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|array
operator|.
name|nDisk
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|get_disk_info
parameter_list|(
name|PVDevice
name|pVDevice
parameter_list|,
name|PLOGICAL_DEVICE_INFO
name|pInfo
parameter_list|)
block|{
name|MV_SATA_ADAPTER
modifier|*
name|pSataAdapter
decl_stmt|;
name|MV_SATA_CHANNEL
modifier|*
name|pSataChannel
decl_stmt|;
name|IAL_ADAPTER_T
modifier|*
name|pAdapter
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pInfo
operator|->
name|Type
operator|=
name|LDT_DEVICE
expr_stmt|;
if|if
condition|(
name|pVDevice
operator|->
name|pParent
condition|)
name|pInfo
operator|->
name|ParentArray
operator|=
name|VDEV_TO_ID
argument_list|(
name|pVDevice
operator|->
name|pParent
argument_list|)
expr_stmt|;
else|else
name|pInfo
operator|->
name|ParentArray
operator|=
name|INVALID_DEVICEID
expr_stmt|;
comment|/* report real capacity to be compatible with old arrays */
name|pInfo
operator|->
name|Capacity
operator|=
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|dDeRealCapacity
expr_stmt|;
comment|/* device location */
name|pSataChannel
operator|=
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|mv
expr_stmt|;
if|if
condition|(
name|pSataChannel
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|TargetId
operator|=
literal|0
expr_stmt|;
name|pSataAdapter
operator|=
name|pSataChannel
operator|->
name|mvSataAdapter
expr_stmt|;
if|if
condition|(
name|pSataAdapter
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pAdapter
operator|=
name|pSataAdapter
operator|->
name|IALData
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|PathId
operator|=
name|pSataChannel
operator|->
name|channelNumber
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|ControllerId
operator|=
operator|(
name|UCHAR
operator|)
name|pSataAdapter
operator|->
name|adapterId
expr_stmt|;
comment|/*GUI uses DeviceModeSetting to display to users (1) if users select a mode, GUI/BIOS should display that mode. (2) if SATA/150, GUI/BIOS should display 150 if case (1) isn't satisfied. (3) display real mode if case (1)&&(2) not satisfied. */
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|df_user_mode_set
condition|)
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|DeviceModeSetting
operator|=
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|bDeUserSelectMode
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
operator|(
operator|(
name|PIDENTIFY_DATA
operator|)
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|mv
operator|->
name|identifyDevice
operator|)
operator|->
name|SataCapability
operator|&
literal|3
operator|)
operator|==
literal|2
condition|)
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|DeviceModeSetting
operator|=
literal|15
expr_stmt|;
else|else
block|{
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
operator|(
name|PIDENTIFY_DATA
operator|)
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|mv
operator|->
name|identifyDevice
operator|)
operator|->
name|ModelNumber
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|WORD
operator|*
operator|)
name|p
operator|==
literal|0x5354
comment|/*'ST'*/
operator|&&
operator|(
operator|*
operator|(
name|WORD
operator|*
operator|)
operator|(
name|p
operator|+
literal|8
operator|)
operator|==
literal|0x4153
comment|/*'AS'*/
operator|||
operator|(
name|p
index|[
literal|8
index|]
operator|==
literal|'A'
operator|&&
name|p
index|[
literal|11
index|]
operator|==
literal|'S'
operator|)
operator|)
condition|)
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|DeviceModeSetting
operator|=
literal|15
expr_stmt|;
else|else
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|DeviceModeSetting
operator|=
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|bDeModeSetting
expr_stmt|;
block|}
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|UsableMode
operator|=
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|bDeUsable_Mode
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|DeviceType
operator|=
name|PDT_HARDDISK
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|Flags
operator|=
literal|0x0
expr_stmt|;
comment|/* device is disabled */
if|if
condition|(
operator|!
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|df_on_line
condition|)
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|Flags
operator||=
name|DEVICE_FLAG_DISABLED
expr_stmt|;
comment|/* disk has a active partition */
if|if
condition|(
name|pVDevice
operator|->
name|vf_bootable
condition|)
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|Flags
operator||=
name|DEVICE_FLAG_BOOTDISK
expr_stmt|;
comment|/* disk has boot mark set */
if|if
condition|(
name|pVDevice
operator|->
name|vf_bootmark
condition|)
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|Flags
operator||=
name|DEVICE_FLAG_BOOTMARK
expr_stmt|;
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|Flags
operator||=
name|DEVICE_FLAG_SATA
expr_stmt|;
comment|/* is a spare disk */
if|if
condition|(
name|pVDevice
operator|->
name|VDeviceType
operator|==
name|VD_SPARE
condition|)
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|Flags
operator||=
name|DEVICE_FLAG_IS_SPARE
expr_stmt|;
name|memcpy
argument_list|(
operator|&
operator|(
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|IdentifyData
operator|)
argument_list|,
operator|(
name|pSataChannel
operator|->
name|identifyDevice
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|IDENTIFY_DATA2
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|pInfo
operator|->
name|u
operator|.
name|device
operator|.
name|IdentifyData
operator|.
name|ModelNumber
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
operator|(
operator|(
name|WORD
operator|*
operator|)
name|p
operator|)
index|[
name|i
index|]
operator|=
name|shortswap
argument_list|(
name|pSataChannel
operator|->
name|identifyDevice
index|[
name|IDEN_MODEL_OFFSET
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
name|p
index|[
literal|39
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_get_driver_capabilities
parameter_list|(
name|PDRIVER_CAPABILITIES
name|cap
parameter_list|)
block|{
name|ZeroMemory
argument_list|(
name|cap
argument_list|,
sizeof|sizeof
argument_list|(
name|DRIVER_CAPABILITIES
argument_list|)
argument_list|)
expr_stmt|;
name|cap
operator|->
name|dwSize
operator|=
sizeof|sizeof
argument_list|(
name|DRIVER_CAPABILITIES
argument_list|)
expr_stmt|;
name|cap
operator|->
name|MaximumControllers
operator|=
name|MAX_VBUS
expr_stmt|;
comment|/* cap->SupportCrossControllerRAID = 0; */
comment|/* take care for various OSes! */
name|cap
operator|->
name|SupportCrossControllerRAID
operator|=
literal|0
expr_stmt|;
name|cap
operator|->
name|MinimumBlockSizeShift
operator|=
name|MinBlockSizeShift
expr_stmt|;
name|cap
operator|->
name|MaximumBlockSizeShift
operator|=
name|MaxBlockSizeShift
expr_stmt|;
name|cap
operator|->
name|SupportDiskModeSetting
operator|=
literal|0
expr_stmt|;
name|cap
operator|->
name|SupportSparePool
operator|=
literal|1
expr_stmt|;
name|cap
operator|->
name|MaximumArrayNameLength
operator|=
name|MAX_ARRAY_NAME
operator|-
literal|1
expr_stmt|;
name|cap
operator|->
name|SupportDedicatedSpare
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|SUPPORT_HOTSWAP
name|cap
operator|->
name|SupportHotSwap
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SUPPORT_ARRAY
comment|/* Stripe */
name|cap
operator|->
name|SupportedRAIDTypes
index|[
literal|0
index|]
operator|=
name|AT_RAID0
expr_stmt|;
name|cap
operator|->
name|MaximumArrayMembers
index|[
literal|0
index|]
operator|=
name|MAX_MEMBERS
expr_stmt|;
comment|/* Mirror */
name|cap
operator|->
name|SupportedRAIDTypes
index|[
literal|1
index|]
operator|=
name|AT_RAID1
expr_stmt|;
name|cap
operator|->
name|MaximumArrayMembers
index|[
literal|1
index|]
operator|=
literal|2
expr_stmt|;
comment|/* Mirror + Stripe */
ifdef|#
directive|ifdef
name|ARRAY_V2_ONLY
name|cap
operator|->
name|SupportedRAIDTypes
index|[
literal|2
index|]
operator|=
operator|(
name|AT_RAID1
operator|<<
literal|4
operator|)
operator||
name|AT_RAID0
expr_stmt|;
comment|/* RAID0/1 */
else|#
directive|else
name|cap
operator|->
name|SupportedRAIDTypes
index|[
literal|2
index|]
operator|=
operator|(
name|AT_RAID0
operator|<<
literal|4
operator|)
operator||
name|AT_RAID1
expr_stmt|;
comment|/* RAID1/0 */
endif|#
directive|endif
name|cap
operator|->
name|MaximumArrayMembers
index|[
literal|2
index|]
operator|=
name|MAX_MEMBERS
expr_stmt|;
comment|/* Jbod */
name|cap
operator|->
name|SupportedRAIDTypes
index|[
literal|3
index|]
operator|=
name|AT_JBOD
expr_stmt|;
name|cap
operator|->
name|MaximumArrayMembers
index|[
literal|3
index|]
operator|=
name|MAX_MEMBERS
expr_stmt|;
comment|/* RAID5 */
if|#
directive|if
name|SUPPORT_RAID5
name|cap
operator|->
name|SupportedRAIDTypes
index|[
literal|4
index|]
operator|=
name|AT_RAID5
expr_stmt|;
name|cap
operator|->
name|MaximumArrayMembers
index|[
literal|4
index|]
operator|=
name|MAX_MEMBERS
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
literal|0
comment|/* don't let GUI create RAID 0/1. */
comment|/* Stripe + Mirror */
block|cap->SupportedRAIDTypes[5] = (AT_RAID1<<4)|AT_RAID0; 	cap->MaximumArrayMembers[5] = 4;
endif|#
directive|endif
endif|#
directive|endif
comment|/* SUPPORT_ARRAY */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_get_controller_count
parameter_list|(
name|void
parameter_list|)
block|{
name|IAL_ADAPTER_T
modifier|*
name|pAdapTemp
init|=
name|gIal_Adapter
decl_stmt|;
name|int
name|iControllerCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|pAdapTemp
operator|!=
literal|0
condition|)
block|{
name|iControllerCount
operator|++
expr_stmt|;
name|pAdapTemp
operator|=
name|pAdapTemp
operator|->
name|next
expr_stmt|;
block|}
return|return
name|iControllerCount
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_get_controller_info
parameter_list|(
name|int
name|id
parameter_list|,
name|PCONTROLLER_INFO
name|pInfo
parameter_list|)
block|{
name|IAL_ADAPTER_T
modifier|*
name|pAdapTemp
decl_stmt|;
name|int
name|iControllerCount
init|=
literal|0
decl_stmt|;
for|for
control|(
name|pAdapTemp
operator|=
name|gIal_Adapter
init|;
name|pAdapTemp
condition|;
name|pAdapTemp
operator|=
name|pAdapTemp
operator|->
name|next
control|)
block|{
if|if
condition|(
name|iControllerCount
operator|++
operator|==
name|id
condition|)
block|{
name|pInfo
operator|->
name|InterruptLevel
operator|=
literal|0
expr_stmt|;
name|pInfo
operator|->
name|ChipType
operator|=
literal|0
expr_stmt|;
name|pInfo
operator|->
name|ChipFlags
operator|=
name|CHIP_SUPPORT_ULTRA_100
expr_stmt|;
name|strcpy
argument_list|(
name|pInfo
operator|->
name|szVendorID
argument_list|,
literal|"HighPoint Technologies, Inc."
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|GUI_CONTROLLER_NAME
ifdef|#
directive|ifdef
name|FORCE_ATA150_DISPLAY
comment|/* show "Bus Type: ATA/150" in GUI for SATA controllers */
name|pInfo
operator|->
name|ChipFlags
operator|=
name|CHIP_SUPPORT_ULTRA_150
expr_stmt|;
endif|#
directive|endif
name|strcpy
argument_list|(
name|pInfo
operator|->
name|szProductID
argument_list|,
name|GUI_CONTROLLER_NAME
argument_list|)
expr_stmt|;
define|#
directive|define
name|_set_product_id
parameter_list|(
name|x
parameter_list|)
else|#
directive|else
define|#
directive|define
name|_set_product_id
parameter_list|(
name|x
parameter_list|)
value|strcpy(pInfo->szProductID, x)
endif|#
directive|endif
name|_set_product_id
argument_list|(
literal|"RocketRAID 182x SATA Controller"
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|NumBuses
operator|=
literal|8
expr_stmt|;
name|pInfo
operator|->
name|ChipFlags
operator||=
name|CHIP_SUPPORT_ULTRA_133
operator||
name|CHIP_SUPPORT_ULTRA_150
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_get_channel_info
parameter_list|(
name|int
name|id
parameter_list|,
name|int
name|bus
parameter_list|,
name|PCHANNEL_INFO
name|pInfo
parameter_list|)
block|{
name|IAL_ADAPTER_T
modifier|*
name|pAdapTemp
init|=
name|gIal_Adapter
decl_stmt|;
name|int
name|i
decl_stmt|,
name|iControllerCount
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|pAdapTemp
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|iControllerCount
operator|++
operator|==
name|id
condition|)
goto|goto
name|found
goto|;
name|pAdapTemp
operator|=
name|pAdapTemp
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
name|found
label|:
name|pInfo
operator|->
name|IoPort
operator|=
literal|0
expr_stmt|;
name|pInfo
operator|->
name|ControlPort
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|pInfo
operator|->
name|Devices
index|[
name|i
index|]
operator|=
operator|(
name|DEVICEID
operator|)
name|INVALID_DEVICEID
expr_stmt|;
block|}
if|if
condition|(
name|pAdapTemp
operator|->
name|mvChannel
index|[
name|bus
index|]
operator|.
name|online
operator|==
name|MV_TRUE
condition|)
name|pInfo
operator|->
name|Devices
index|[
literal|0
index|]
operator|=
name|VDEV_TO_ID
argument_list|(
operator|&
name|pAdapTemp
operator|->
name|VDevices
index|[
name|bus
index|]
argument_list|)
expr_stmt|;
else|else
name|pInfo
operator|->
name|Devices
index|[
literal|0
index|]
operator|=
operator|(
name|DEVICEID
operator|)
name|INVALID_DEVICEID
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_get_logical_devices
parameter_list|(
name|DEVICEID
modifier|*
name|pIds
parameter_list|,
name|int
name|nMaxCount
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|PVDevice
name|pPhysical
decl_stmt|,
name|pLogical
decl_stmt|;
name|IAL_ADAPTER_T
modifier|*
name|pAdapTemp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nMaxCount
condition|;
name|i
operator|++
control|)
name|pIds
index|[
name|i
index|]
operator|=
name|INVALID_DEVICEID
expr_stmt|;
comment|/* append the arrays not registered on VBus */
for|for
control|(
name|pAdapTemp
operator|=
name|gIal_Adapter
init|;
name|pAdapTemp
condition|;
name|pAdapTemp
operator|=
name|pAdapTemp
operator|->
name|next
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MV_SATA_CHANNELS_NUM
condition|;
name|i
operator|++
control|)
block|{
name|pPhysical
operator|=
operator|&
name|pAdapTemp
operator|->
name|VDevices
index|[
name|i
index|]
expr_stmt|;
name|pLogical
operator|=
name|pPhysical
expr_stmt|;
while|while
condition|(
name|pLogical
operator|->
name|pParent
condition|)
name|pLogical
operator|=
name|pLogical
operator|->
name|pParent
expr_stmt|;
if|if
condition|(
name|pLogical
operator|->
name|VDeviceType
operator|==
name|VD_SPARE
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|count
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|pIds
index|[
name|j
index|]
operator|==
name|VDEV_TO_ID
argument_list|(
name|pLogical
argument_list|)
condition|)
goto|goto
name|next
goto|;
name|pIds
index|[
name|count
operator|++
index|]
operator|=
name|VDEV_TO_ID
argument_list|(
name|pLogical
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>=
name|nMaxCount
condition|)
goto|goto
name|done
goto|;
name|next
label|:
empty_stmt|;
block|}
block|}
name|done
label|:
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_get_device_info
parameter_list|(
name|DEVICEID
name|id
parameter_list|,
name|PLOGICAL_DEVICE_INFO
name|pInfo
parameter_list|)
block|{
name|PVDevice
name|pVDevice
init|=
name|ID_TO_VDEV
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|id
operator|==
name|HPT_NULL_ID
operator|)
operator|||
name|check_VDevice_valid
argument_list|(
name|pVDevice
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|SUPPORT_ARRAY
if|if
condition|(
name|mIsArray
argument_list|(
name|pVDevice
argument_list|)
condition|)
name|get_array_info
argument_list|(
name|pVDevice
argument_list|,
name|pInfo
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
return|return
name|get_disk_info
argument_list|(
name|pVDevice
argument_list|,
name|pInfo
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SUPPORT_ARRAY
end_ifdef

begin_function
specifier|static
name|DEVICEID
name|hpt_create_array
parameter_list|(
name|_VBUS_ARG
name|PCREATE_ARRAY_PARAMS
name|pParam
parameter_list|)
block|{
name|ULONG
name|Stamp
init|=
name|GetStamp
argument_list|()
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ULONG
name|capacity
init|=
name|MAX_LBA_T
decl_stmt|;
name|PVDevice
name|pArray
decl_stmt|,
name|pChild
decl_stmt|;
if|#
directive|if
name|MAX_VBUS
operator|==
literal|1
name|PVBus
name|_vbus_p
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
name|int
name|Loca
init|=
operator|-
literal|1
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pParam
operator|->
name|nDisk
condition|;
name|i
operator|++
control|)
block|{
name|PVDevice
name|pVDev
init|=
name|ID_TO_VDEV
argument_list|(
name|pParam
operator|->
name|Members
index|[
name|i
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|check_VDevice_valid
argument_list|(
name|pVDev
argument_list|)
condition|)
return|return
name|INVALID_DEVICEID
return|;
if|if
condition|(
name|mIsArray
argument_list|(
name|pVDev
argument_list|)
condition|)
return|return
name|INVALID_DEVICEID
return|;
if|if
condition|(
operator|!
name|pVDev
operator|->
name|vf_online
condition|)
return|return
name|INVALID_DEVICEID
return|;
if|if
condition|(
operator|!
name|_vbus_p
condition|)
name|_vbus_p
operator|=
name|pVDev
operator|->
name|u
operator|.
name|disk
operator|.
name|pVBus
expr_stmt|;
elseif|else
if|if
condition|(
name|_vbus_p
operator|!=
name|pVDev
operator|->
name|u
operator|.
name|disk
operator|.
name|pVBus
condition|)
return|return
name|INVALID_DEVICEID
return|;
block|}
if|if
condition|(
operator|!
name|_vbus_p
condition|)
return|return
name|INVALID_DEVICEID
return|;
name|mArGetArrayTable
argument_list|(
name|pArray
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pArray
condition|)
return|return
name|INVALID_DEVICEID
return|;
switch|switch
condition|(
name|pParam
operator|->
name|ArrayType
condition|)
block|{
case|case
name|AT_JBOD
case|:
name|pArray
operator|->
name|VDeviceType
operator|=
name|VD_JBOD
expr_stmt|;
goto|goto
name|simple
goto|;
case|case
name|AT_RAID0
case|:
if|if
condition|(
operator|(
name|pParam
operator|->
name|BlockSizeShift
operator|<
name|MinBlockSizeShift
operator|)
operator|||
operator|(
name|pParam
operator|->
name|BlockSizeShift
operator|>
name|MaxBlockSizeShift
operator|)
condition|)
goto|goto
name|error
goto|;
name|pArray
operator|->
name|VDeviceType
operator|=
name|VD_RAID_0
expr_stmt|;
goto|goto
name|simple
goto|;
case|case
name|AT_RAID5
case|:
if|if
condition|(
operator|(
name|pParam
operator|->
name|BlockSizeShift
operator|<
name|MinBlockSizeShift
operator|)
operator|||
operator|(
name|pParam
operator|->
name|BlockSizeShift
operator|>
name|MaxBlockSizeShift
operator|)
condition|)
goto|goto
name|error
goto|;
name|pArray
operator|->
name|VDeviceType
operator|=
name|VD_RAID_5
expr_stmt|;
comment|/* only "no build" R5 is not critical after creation. */
if|if
condition|(
operator|(
name|pParam
operator|->
name|CreateFlags
operator|&
name|CAF_CREATE_R5_NO_BUILD
operator|)
operator|==
literal|0
condition|)
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_rebuild
operator|=
literal|1
expr_stmt|;
goto|goto
name|simple
goto|;
case|case
name|AT_RAID1
case|:
if|if
condition|(
name|pParam
operator|->
name|nDisk
operator|<=
literal|2
condition|)
block|{
name|pArray
operator|->
name|VDeviceType
operator|=
name|VD_RAID_1
expr_stmt|;
name|simple
label|:
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|=
name|pParam
operator|->
name|nDisk
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
operator|=
name|pParam
operator|->
name|nDisk
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArBlockSizeShift
operator|=
name|pParam
operator|->
name|BlockSizeShift
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bStripeWitch
operator|=
operator|(
literal|1
operator|<<
name|pParam
operator|->
name|BlockSizeShift
operator|)
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|dArStamp
operator|=
name|Stamp
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_sync
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_newly_created
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|pParam
operator|->
name|CreateFlags
operator|&
name|CAF_CREATE_AND_DUPLICATE
operator|)
operator|&&
operator|(
name|pArray
operator|->
name|VDeviceType
operator|==
name|VD_RAID_1
operator|)
condition|)
block|{
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_newly_created
operator|=
literal|0
expr_stmt|;
comment|/* R1 shall still be accessible */
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_rebuild
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_auto_rebuild
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_duplicate_and_create
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_VDEVICE_PER_VBUS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|_vbus_p
operator|->
name|pVDevice
index|[
name|i
index|]
operator|==
name|ID_TO_VDEV
argument_list|(
name|pParam
operator|->
name|Members
index|[
literal|0
index|]
argument_list|)
condition|)
name|Loca
operator|=
name|i
expr_stmt|;
block|}
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
operator|=
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_rebuild
condition|?
literal|0
else|:
name|MAX_LBA_T
expr_stmt|;
name|memcpy
argument_list|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
name|pParam
operator|->
name|ArrayName
argument_list|,
name|MAX_ARRAY_NAME
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pParam
operator|->
name|nDisk
condition|;
name|i
operator|++
control|)
block|{
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|=
name|ID_TO_VDEV
argument_list|(
name|pParam
operator|->
name|Members
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|bSerialNumber
operator|=
name|i
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|pParent
operator|=
name|pArray
expr_stmt|;
comment|/* don't unregister source disk for duplicate RAID1 */
if|if
condition|(
name|i
operator|||
name|pArray
operator|->
name|VDeviceType
operator|!=
name|VD_RAID_1
operator|||
operator|(
name|pParam
operator|->
name|CreateFlags
operator|&
name|CAF_CREATE_AND_DUPLICATE
operator|)
operator|==
literal|0
condition|)
name|UnregisterVDevice
argument_list|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|pArray
operator|->
name|VDeviceType
operator|==
name|VD_RAID_5
condition|)
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|vf_cache_disk
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|pParam
operator|->
name|nDisk
operator|/
literal|2
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|mArGetArrayTable
argument_list|(
name|pChild
argument_list|)
expr_stmt|;
name|pChild
operator|->
name|VDeviceType
operator|=
name|VD_RAID_1
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|=
literal|2
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
operator|=
literal|2
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|bArBlockSizeShift
operator|=
name|pParam
operator|->
name|BlockSizeShift
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|bStripeWitch
operator|=
operator|(
literal|1
operator|<<
name|pParam
operator|->
name|BlockSizeShift
operator|)
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|dArStamp
operator|=
name|Stamp
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_sync
operator|=
literal|1
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|rf_newly_created
operator|=
literal|1
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
operator|=
name|MAX_LBA_T
expr_stmt|;
name|memcpy
argument_list|(
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
name|pParam
operator|->
name|ArrayName
argument_list|,
name|MAX_ARRAY_NAME
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
condition|;
name|j
operator|++
control|)
block|{
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|j
index|]
operator|=
name|ID_TO_VDEV
argument_list|(
name|pParam
operator|->
name|Members
index|[
name|i
operator|*
literal|2
operator|+
name|j
index|]
argument_list|)
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|j
index|]
operator|->
name|bSerialNumber
operator|=
name|j
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|j
index|]
operator|->
name|pParent
operator|=
name|pChild
expr_stmt|;
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|j
index|]
operator|->
name|pfnDeviceFailed
operator|=
name|pfnDeviceFailed
index|[
name|pChild
operator|->
name|VDeviceType
index|]
expr_stmt|;
name|UnregisterVDevice
argument_list|(
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|=
name|pChild
expr_stmt|;
name|pChild
operator|->
name|vf_online
operator|=
literal|1
expr_stmt|;
name|pChild
operator|->
name|bSerialNumber
operator|=
name|i
expr_stmt|;
name|pChild
operator|->
name|pParent
operator|=
name|pArray
expr_stmt|;
name|pChild
operator|->
name|VDeviceCapacity
operator|=
name|MIN
argument_list|(
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|->
name|VDeviceCapacity
argument_list|,
name|pChild
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|1
index|]
operator|->
name|VDeviceCapacity
argument_list|)
expr_stmt|;
name|pChild
operator|->
name|pfnSendCommand
operator|=
name|pfnSendCommand
index|[
name|pChild
operator|->
name|VDeviceType
index|]
expr_stmt|;
name|pChild
operator|->
name|pfnDeviceFailed
operator|=
name|pfnDeviceFailed
index|[
name|VD_RAID_0
index|]
expr_stmt|;
block|}
name|pArray
operator|->
name|VDeviceType
operator|=
name|VD_RAID_0
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|=
name|pParam
operator|->
name|nDisk
operator|/
literal|2
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
operator|=
name|pParam
operator|->
name|nDisk
operator|/
literal|2
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArBlockSizeShift
operator|=
name|pParam
operator|->
name|BlockSizeShift
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bStripeWitch
operator|=
operator|(
literal|1
operator|<<
name|pParam
operator|->
name|BlockSizeShift
operator|)
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|dArStamp
operator|=
name|Stamp
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_sync
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_newly_created
operator|=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
name|pParam
operator|->
name|ArrayName
argument_list|,
name|MAX_ARRAY_NAME
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
goto|goto
name|error
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|pfnDeviceFailed
operator|=
name|pfnDeviceFailed
index|[
name|pArray
operator|->
name|VDeviceType
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|pParam
operator|->
name|CreateFlags
operator|&
name|CAF_CREATE_AND_DUPLICATE
operator|)
operator|&&
operator|(
name|pArray
operator|->
name|VDeviceType
operator|==
name|VD_RAID_1
operator|)
condition|)
block|{
name|pArray
operator|->
name|vf_bootmark
operator|=
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|->
name|vf_bootmark
expr_stmt|;
name|pArray
operator|->
name|vf_bootable
operator|=
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|->
name|vf_bootable
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|->
name|vf_bootable
operator|=
literal|0
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|->
name|vf_bootmark
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|Loca
operator|>=
literal|0
condition|)
block|{
name|_vbus_p
operator|->
name|pVDevice
index|[
name|Loca
index|]
operator|=
name|pArray
expr_stmt|;
comment|/* to comfort OS */
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_duplicate_and_created
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|pVBus
operator|=
name|_vbus_p
expr_stmt|;
block|}
block|}
else|else
block|{
name|UCHAR
name|TempBuffer
index|[
literal|512
index|]
decl_stmt|;
name|ZeroMemory
argument_list|(
name|TempBuffer
argument_list|,
literal|512
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pParam
operator|->
name|nDisk
condition|;
name|i
operator|++
control|)
block|{
name|PVDevice
name|pDisk
init|=
name|ID_TO_VDEV
argument_list|(
name|pParam
operator|->
name|Members
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|pDisk
operator|->
name|vf_bootmark
operator|=
name|pDisk
operator|->
name|vf_bootable
operator|=
literal|0
expr_stmt|;
name|fDeReadWrite
argument_list|(
operator|&
name|pDisk
operator|->
name|u
operator|.
name|disk
argument_list|,
literal|0
argument_list|,
name|IDE_COMMAND_WRITE
argument_list|,
name|TempBuffer
argument_list|)
expr_stmt|;
block|}
block|}
name|pArray
operator|->
name|vf_online
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|pParent
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|pArray
operator|->
name|VDeviceType
condition|)
block|{
case|case
name|VD_RAID_0
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|VDeviceCapacity
operator|<
name|capacity
condition|)
name|capacity
operator|=
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|VDeviceCapacity
expr_stmt|;
ifdef|#
directive|ifdef
name|ARRAY_V2_ONLY
name|capacity
operator|-=
literal|10
expr_stmt|;
endif|#
directive|endif
name|capacity
operator|&=
operator|~
operator|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bStripeWitch
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* shrink member capacity for RAID 1/0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|mIsArray
argument_list|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
argument_list|)
condition|)
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|VDeviceCapacity
operator|=
name|capacity
expr_stmt|;
name|pArray
operator|->
name|VDeviceCapacity
operator|=
name|capacity
operator|*
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
expr_stmt|;
break|break;
case|case
name|VD_RAID_1
case|:
name|pArray
operator|->
name|VDeviceCapacity
operator|=
name|MIN
argument_list|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|->
name|VDeviceCapacity
argument_list|,
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|1
index|]
operator|->
name|VDeviceCapacity
argument_list|)
expr_stmt|;
break|break;
case|case
name|VD_JBOD
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
name|pArray
operator|->
name|VDeviceCapacity
operator|+=
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|VDeviceCapacity
ifdef|#
directive|ifdef
name|ARRAY_V2_ONLY
operator|-
literal|10
endif|#
directive|endif
expr_stmt|;
break|break;
case|case
name|VD_RAID_5
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|VDeviceCapacity
operator|<
name|capacity
condition|)
name|capacity
operator|=
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|VDeviceCapacity
expr_stmt|;
name|pArray
operator|->
name|VDeviceCapacity
operator|=
operator|(
name|capacity
operator|&
operator|~
operator|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bStripeWitch
operator|-
literal|1
operator|)
operator|)
operator|*
operator|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|error
goto|;
block|}
name|pArray
operator|->
name|pfnSendCommand
operator|=
name|pfnSendCommand
index|[
name|pArray
operator|->
name|VDeviceType
index|]
expr_stmt|;
name|pArray
operator|->
name|pfnDeviceFailed
operator|=
name|fOsDiskFailed
expr_stmt|;
name|SyncArrayInfo
argument_list|(
name|pArray
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_duplicate_and_created
condition|)
name|RegisterVDevice
argument_list|(
name|pArray
argument_list|)
expr_stmt|;
return|return
name|VDEV_TO_ID
argument_list|(
name|pArray
argument_list|)
return|;
name|error
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
block|{
name|pChild
operator|=
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|pChild
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|pChild
operator|->
name|VDeviceType
operator|!=
name|VD_SINGLE_DISK
operator|)
condition|)
name|mArFreeArrayTable
argument_list|(
name|pChild
argument_list|)
expr_stmt|;
block|}
name|mArFreeArrayTable
argument_list|(
name|pArray
argument_list|)
expr_stmt|;
return|return
name|INVALID_DEVICEID
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SUPPORT_OLD_ARRAY
end_ifdef

begin_comment
comment|/* this is only for old RAID 0/1 */
end_comment

begin_function
name|int
name|old_add_disk_to_raid01
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idArray
parameter_list|,
name|DEVICEID
name|idDisk
parameter_list|)
block|{
name|PVDevice
name|pArray1
init|=
name|ID_TO_VDEV
argument_list|(
name|idArray
argument_list|)
decl_stmt|;
name|PVDevice
name|pArray2
init|=
literal|0
decl_stmt|;
name|PVDevice
name|pDisk
init|=
name|ID_TO_VDEV
argument_list|(
name|idDisk
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|IAL_ADAPTER_T
modifier|*
name|pAdapter
init|=
name|gIal_Adapter
decl_stmt|;
if|#
directive|if
name|MAX_VBUS
operator|>
literal|1
if|if
condition|(
name|pArray1
operator|->
name|pVBus
operator|!=
name|_vbus_p
condition|)
block|{
name|HPT_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pDisk
operator|->
name|u
operator|.
name|disk
operator|.
name|dDeRealCapacity
operator|<
operator|(
name|pArray1
operator|->
name|VDeviceCapacity
operator|/
literal|2
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|pArray2
operator|=
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|pArray2
operator|==
name|NULL
condition|)
block|{
comment|/* create a Stripe */
name|mArGetArrayTable
argument_list|(
name|pArray2
argument_list|)
expr_stmt|;
name|pArray2
operator|->
name|VDeviceType
operator|=
name|VD_RAID_0
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|dArStamp
operator|=
name|GetStamp
argument_list|()
expr_stmt|;
name|pArray2
operator|->
name|vf_format_v2
operator|=
literal|1
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|rf_broken
operator|=
literal|1
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bArBlockSizeShift
operator|=
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|bArBlockSizeShift
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bStripeWitch
operator|=
operator|(
literal|1
operator|<<
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bArBlockSizeShift
operator|)
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|=
literal|2
expr_stmt|;
name|pArray2
operator|->
name|VDeviceCapacity
operator|=
name|pArray1
operator|->
name|VDeviceCapacity
expr_stmt|;
name|pArray2
operator|->
name|pfnSendCommand
operator|=
name|pfnSendCommand
index|[
name|pArray2
operator|->
name|VDeviceType
index|]
expr_stmt|;
name|pArray2
operator|->
name|pfnDeviceFailed
operator|=
name|pfnDeviceFailed
index|[
name|pArray1
operator|->
name|VDeviceType
index|]
expr_stmt|;
name|memcpy
argument_list|(
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
name|MAX_ARRAY_NAME
argument_list|)
expr_stmt|;
name|pArray2
operator|->
name|pParent
operator|=
name|pArray1
expr_stmt|;
name|pArray2
operator|->
name|bSerialNumber
operator|=
literal|1
expr_stmt|;
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|1
index|]
operator|=
name|pArray2
expr_stmt|;
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|==
name|NULL
operator|)
operator|||
operator|!
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|vf_online
condition|)
block|{
if|if
condition|(
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|pParent
operator|=
name|NULL
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|=
name|pDisk
expr_stmt|;
goto|goto
name|find
goto|;
block|}
return|return
operator|-
literal|1
return|;
name|find
label|:
name|UnregisterVDevice
argument_list|(
name|pDisk
argument_list|)
expr_stmt|;
name|pDisk
operator|->
name|VDeviceType
operator|=
name|VD_SINGLE_DISK
expr_stmt|;
name|pDisk
operator|->
name|bSerialNumber
operator|=
name|i
expr_stmt|;
name|pDisk
operator|->
name|pParent
operator|=
name|pArray2
expr_stmt|;
name|pDisk
operator|->
name|vf_format_v2
operator|=
literal|1
expr_stmt|;
name|pDisk
operator|->
name|u
operator|.
name|disk
operator|.
name|dDeHiddenLba
operator|=
name|i
condition|?
literal|10
else|:
literal|0
expr_stmt|;
name|pDisk
operator|->
name|VDeviceCapacity
operator|=
name|pDisk
operator|->
name|u
operator|.
name|disk
operator|.
name|dDeRealCapacity
expr_stmt|;
name|pDisk
operator|->
name|pfnDeviceFailed
operator|=
name|pfnDeviceFailed
index|[
name|pArray2
operator|->
name|VDeviceType
index|]
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
operator|++
expr_stmt|;
if|if
condition|(
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|==
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
condition|)
block|{
name|pArray2
operator|->
name|vf_online
operator|=
literal|1
expr_stmt|;
name|pArray2
operator|->
name|u
operator|.
name|array
operator|.
name|rf_broken
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|->
name|vf_online
operator|&&
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|1
index|]
operator|->
name|vf_online
condition|)
block|{
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
operator|=
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
expr_stmt|;
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|rf_broken
operator|=
literal|0
expr_stmt|;
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_rebuild
operator|=
literal|1
expr_stmt|;
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|rf_auto_rebuild
operator|=
literal|1
expr_stmt|;
block|}
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
operator|=
literal|0
expr_stmt|;
name|pArray1
operator|->
name|u
operator|.
name|array
operator|.
name|dArStamp
operator|=
name|GetStamp
argument_list|()
expr_stmt|;
name|SyncArrayInfo
argument_list|(
name|pArray1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|hpt_add_disk_to_array
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idArray
parameter_list|,
name|DEVICEID
name|idDisk
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|ULONG
name|Capacity
decl_stmt|;
name|PVDevice
name|pArray
init|=
name|ID_TO_VDEV
argument_list|(
name|idArray
argument_list|)
decl_stmt|;
name|PVDevice
name|pDisk
init|=
name|ID_TO_VDEV
argument_list|(
name|idDisk
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|idArray
operator|==
name|HPT_NULL_ID
operator|)
operator|||
operator|(
name|idDisk
operator|==
name|HPT_NULL_ID
operator|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|check_VDevice_valid
argument_list|(
name|pArray
argument_list|)
operator|||
name|check_VDevice_valid
argument_list|(
name|pDisk
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_broken
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pArray
operator|->
name|VDeviceType
operator|!=
name|VD_RAID_1
operator|&&
name|pArray
operator|->
name|VDeviceType
operator|!=
name|VD_RAID_5
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|pDisk
operator|->
name|VDeviceType
operator|!=
name|VD_SINGLE_DISK
operator|)
operator|&&
operator|(
name|pDisk
operator|->
name|VDeviceType
operator|!=
name|VD_SPARE
operator|)
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|SUPPORT_OLD_ARRAY
comment|/* RAID 0 + 1 */
if|if
condition|(
name|pArray
operator|->
name|vf_format_v2
operator|&&
name|pArray
operator|->
name|VDeviceType
operator|==
name|VD_RAID_1
operator|&&
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
operator|&&
name|mIsArray
argument_list|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|old_add_disk_to_raid01
argument_list|(
argument|_VBUS_P idArray
argument_list|,
argument|idDisk
argument_list|)
condition|)
return|return
literal|0
return|;
else|else
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
name|Capacity
operator|=
name|pArray
operator|->
name|VDeviceCapacity
operator|/
operator|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|pArray
operator|->
name|vf_format_v2
condition|)
block|{
if|if
condition|(
name|pDisk
operator|->
name|u
operator|.
name|disk
operator|.
name|dDeRealCapacity
operator|<
name|Capacity
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|pDisk
operator|->
name|VDeviceCapacity
operator|<
name|Capacity
condition|)
return|return
operator|-
literal|1
return|;
if|#
directive|if
name|MAX_VBUS
operator|>
literal|1
if|if
condition|(
name|pArray
operator|->
name|pVBus
operator|!=
name|_vbus_p
condition|)
block|{
name|HPT_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|==
name|NULL
operator|)
operator|||
operator|!
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|vf_online
condition|)
block|{
if|if
condition|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|->
name|pParent
operator|=
name|NULL
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|pMember
index|[
name|i
index|]
operator|=
name|pDisk
expr_stmt|;
goto|goto
name|find
goto|;
block|}
return|return
operator|-
literal|1
return|;
name|find
label|:
name|UnregisterVDevice
argument_list|(
name|pDisk
argument_list|)
expr_stmt|;
name|pDisk
operator|->
name|VDeviceType
operator|=
name|VD_SINGLE_DISK
expr_stmt|;
name|pDisk
operator|->
name|bSerialNumber
operator|=
name|i
expr_stmt|;
name|pDisk
operator|->
name|pParent
operator|=
name|pArray
expr_stmt|;
if|if
condition|(
name|pArray
operator|->
name|VDeviceType
operator|==
name|VD_RAID_5
condition|)
name|pDisk
operator|->
name|vf_cache_disk
operator|=
literal|1
expr_stmt|;
name|pDisk
operator|->
name|pfnDeviceFailed
operator|=
name|pfnDeviceFailed
index|[
name|pArray
operator|->
name|VDeviceType
index|]
expr_stmt|;
if|if
condition|(
name|pArray
operator|->
name|vf_format_v2
condition|)
block|{
name|pDisk
operator|->
name|vf_format_v2
operator|=
literal|1
expr_stmt|;
name|pDisk
operator|->
name|VDeviceCapacity
operator|=
name|pDisk
operator|->
name|u
operator|.
name|disk
operator|.
name|dDeRealCapacity
expr_stmt|;
block|}
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
operator|++
expr_stmt|;
if|if
condition|(
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArnMember
operator|==
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|bArRealnMember
condition|)
block|{
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_rebuild
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
operator|=
literal|0
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_auto_rebuild
operator|=
literal|1
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|rf_broken
operator|=
literal|0
expr_stmt|;
block|}
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|RebuildSectors
operator|=
literal|0
expr_stmt|;
comment|/* sync the whole array */
while|while
condition|(
name|pArray
operator|->
name|pParent
condition|)
name|pArray
operator|=
name|pArray
operator|->
name|pParent
expr_stmt|;
name|pArray
operator|->
name|u
operator|.
name|array
operator|.
name|dArStamp
operator|=
name|GetStamp
argument_list|()
expr_stmt|;
name|SyncArrayInfo
argument_list|(
name|pArray
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_add_spare_disk
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idDisk
parameter_list|)
block|{
name|PVDevice
name|pVDevice
init|=
name|ID_TO_VDEV
argument_list|(
name|idDisk
argument_list|)
decl_stmt|;
name|DECLARE_BUFFER
argument_list|(
name|PUCHAR
argument_list|,
name|pbuffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|idDisk
operator|==
name|HPT_NULL_ID
operator|||
name|check_VDevice_valid
argument_list|(
name|pVDevice
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pVDevice
operator|->
name|VDeviceType
operator|!=
name|VD_SINGLE_DISK
operator|||
name|pVDevice
operator|->
name|pParent
condition|)
return|return
operator|-
literal|1
return|;
if|#
directive|if
name|MAX_VBUS
operator|>
literal|1
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|pVBus
operator|!=
name|_vbus_p
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
name|UnregisterVDevice
argument_list|(
name|pVDevice
argument_list|)
expr_stmt|;
name|pVDevice
operator|->
name|VDeviceType
operator|=
name|VD_SPARE
expr_stmt|;
name|pVDevice
operator|->
name|vf_bootmark
operator|=
literal|0
expr_stmt|;
name|ZeroMemory
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pbuffer
argument_list|,
literal|512
argument_list|)
expr_stmt|;
name|fDeReadWrite
argument_list|(
operator|&
name|pVDevice
operator|->
name|u
operator|.
name|disk
argument_list|,
literal|0
argument_list|,
name|IDE_COMMAND_WRITE
argument_list|,
name|pbuffer
argument_list|)
expr_stmt|;
name|SyncArrayInfo
argument_list|(
name|pVDevice
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_remove_spare_disk
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idDisk
parameter_list|)
block|{
name|PVDevice
name|pVDevice
init|=
name|ID_TO_VDEV
argument_list|(
name|idDisk
argument_list|)
decl_stmt|;
if|if
condition|(
name|idDisk
operator|==
literal|0
operator|||
name|check_VDevice_valid
argument_list|(
name|pVDevice
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|#
directive|if
name|MAX_VBUS
operator|>
literal|1
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|pVBus
operator|!=
name|_vbus_p
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
name|pVDevice
operator|->
name|VDeviceType
operator|=
name|VD_SINGLE_DISK
expr_stmt|;
name|SyncArrayInfo
argument_list|(
name|pVDevice
argument_list|)
expr_stmt|;
name|RegisterVDevice
argument_list|(
name|pVDevice
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_set_array_info
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idArray
parameter_list|,
name|PALTERABLE_ARRAY_INFO
name|pInfo
parameter_list|)
block|{
name|PVDevice
name|pVDevice
init|=
name|ID_TO_VDEV
argument_list|(
name|idArray
argument_list|)
decl_stmt|;
if|if
condition|(
name|idArray
operator|==
name|HPT_NULL_ID
operator|||
name|check_VDevice_valid
argument_list|(
name|pVDevice
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|mIsArray
argument_list|(
name|pVDevice
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* if the pVDevice isn't a top level, return -1; */
if|if
condition|(
name|pVDevice
operator|->
name|pParent
operator|!=
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|#
directive|if
name|MAX_VBUS
operator|>
literal|1
if|if
condition|(
name|pVDevice
operator|->
name|pVBus
operator|!=
name|_vbus_p
condition|)
block|{
name|HPT_ASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pInfo
operator|->
name|ValidFields
operator|&
name|AAIF_NAME
condition|)
block|{
name|memset
argument_list|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
literal|0
argument_list|,
name|MAX_ARRAY_NAME
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|ArrayName
argument_list|,
name|pInfo
operator|->
name|Name
argument_list|,
sizeof|sizeof
argument_list|(
name|pInfo
operator|->
name|Name
argument_list|)
argument_list|)
expr_stmt|;
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_sync
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|pInfo
operator|->
name|ValidFields
operator|&
name|AAIF_DESCRIPTION
condition|)
block|{
name|memcpy
argument_list|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|Description
argument_list|,
name|pInfo
operator|->
name|Description
argument_list|,
sizeof|sizeof
argument_list|(
name|pInfo
operator|->
name|Description
argument_list|)
argument_list|)
expr_stmt|;
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_sync
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|array
operator|.
name|rf_need_sync
condition|)
name|SyncArrayInfo
argument_list|(
name|pVDevice
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hpt_set_device_info
parameter_list|(
name|_VBUS_ARG
name|DEVICEID
name|idDisk
parameter_list|,
name|PALTERABLE_DEVICE_INFO
name|pInfo
parameter_list|)
block|{
name|PVDevice
name|pVDevice
init|=
name|ID_TO_VDEV
argument_list|(
name|idDisk
argument_list|)
decl_stmt|;
comment|/* stop buzzer. */
if|if
condition|(
name|idDisk
operator|==
name|HPT_NULL_ID
condition|)
block|{
ifndef|#
directive|ifndef
name|FOR_DEMO
name|IAL_ADAPTER_T
modifier|*
name|pAdapter
decl_stmt|;
for|for
control|(
name|pAdapter
operator|=
name|gIal_Adapter
init|;
name|pAdapter
condition|;
name|pAdapter
operator|=
name|pAdapter
operator|->
name|next
control|)
block|{
if|if
condition|(
name|pAdapter
operator|->
name|beeping
condition|)
block|{
name|pAdapter
operator|->
name|beeping
operator|=
literal|0
expr_stmt|;
name|BeepOff
argument_list|(
name|pAdapter
operator|->
name|mvSataAdapter
operator|.
name|adapterIoBaseAddress
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
if|if
condition|(
name|check_VDevice_valid
argument_list|(
name|pVDevice
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|mIsArray
argument_list|(
name|pVDevice
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|#
directive|if
name|MAX_VBUS
operator|>
literal|1
if|if
condition|(
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|pVBus
operator|!=
name|_vbus_p
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/*	if (pInfo->ValidFields& ADIF_MODE) { 		pVDevice->u.disk.bDeModeSetting = pInfo->DeviceModeSetting; 		pVDevice->u.disk.bDeUserSelectMode = pInfo->DeviceModeSetting; 		pVDevice->u.disk.df_user_mode_set = 1; 		fDeSelectMode((PDevice)&(pVDevice->u.disk), (UCHAR)pInfo->DeviceModeSetting); 		SyncArrayInfo(pVDevice); 	}*/
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SUPPORT_ARRAY */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SUPPORT_HPT601
end_ifdef

begin_function
name|int
name|hpt_get_601_info
parameter_list|(
name|DEVICEID
name|idDisk
parameter_list|,
name|PHPT601_INFO
name|pInfo
parameter_list|)
block|{
name|PVDevice
name|pVDevice
init|=
name|ID_TO_VDEV
argument_list|(
name|idDisk
argument_list|)
decl_stmt|;
name|PChannel
name|pChan
init|=
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|pChannel
decl_stmt|;
name|PIDE_REGISTERS_1
name|IoPort
init|=
name|pChan
operator|->
name|BaseIoAddress1
decl_stmt|;
if|if
condition|(
operator|!
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|df_with_601
condition|)
return|return
operator|-
literal|1
return|;
name|mSelectUnit
argument_list|(
name|IoPort
argument_list|,
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|bDeUnitId
argument_list|)
expr_stmt|;
name|pChan
operator|->
name|pChipInstance
operator|->
name|ftbl
operator|.
name|pfnWaitOnBusy
argument_list|(
name|pChan
argument_list|,
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|bDeUnitId
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BeginAccess601
argument_list|(
name|IoPort
argument_list|)
expr_stmt|;
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|DeviceId
operator|=
name|InWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|)
expr_stmt|;
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|0x14
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|Temperature
operator|=
name|InWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|)
expr_stmt|;
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|0xA
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|FanStatus
operator|=
name|InWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|)
expr_stmt|;
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|BeeperControl
operator|=
name|InWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|)
expr_stmt|;
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|LED1Control
operator|=
name|InWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|)
expr_stmt|;
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|LED2Control
operator|=
name|InWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|)
expr_stmt|;
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|0x18
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|PowerStatus
operator|=
name|InWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|)
expr_stmt|;
name|EndAccess601
argument_list|(
name|IoPort
argument_list|)
expr_stmt|;
name|pInfo
operator|->
name|ValidFields
operator|=
literal|0x7F
expr_stmt|;
comment|/*DEVICEID|TEMPERATURE|FANSTATUS|BEEPERCONTROL|LED1CONTROL|LED2CONTROL|POWERSTATUS*/
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|hpt_set_601_info
parameter_list|(
name|DEVICEID
name|idDisk
parameter_list|,
name|PHPT601_INFO
name|pInfo
parameter_list|)
block|{
name|PVDevice
name|pVDevice
init|=
name|ID_TO_VDEV
argument_list|(
name|idDisk
argument_list|)
decl_stmt|;
name|PChannel
name|pChan
init|=
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|pChannel
decl_stmt|;
name|PIDE_REGISTERS_1
name|IoPort
init|=
name|pChan
operator|->
name|BaseIoAddress1
decl_stmt|;
if|if
condition|(
operator|!
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|df_with_601
condition|)
return|return
operator|-
literal|1
return|;
name|mSelectUnit
argument_list|(
name|IoPort
argument_list|,
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|bDeUnitId
argument_list|)
expr_stmt|;
name|pChan
operator|->
name|pChipInstance
operator|->
name|ftbl
operator|.
name|pfnWaitOnBusy
argument_list|(
name|pChan
argument_list|,
name|pVDevice
operator|->
name|u
operator|.
name|disk
operator|.
name|bDeUnitId
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BeginAccess601
argument_list|(
name|IoPort
argument_list|)
expr_stmt|;
if|if
condition|(
name|pInfo
operator|->
name|ValidFields
operator|&
name|HPT601_INFO_TEMPERATURE
condition|)
block|{
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OutWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|,
name|pInfo
operator|->
name|Temperature
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pInfo
operator|->
name|ValidFields
operator|&
name|HPT601_INFO_FANSTATUS
condition|)
block|{
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|0xA
argument_list|)
expr_stmt|;
name|OutWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|,
name|pInfo
operator|->
name|FanStatus
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pInfo
operator|->
name|ValidFields
operator|&
name|HPT601_INFO_BEEPERCONTROL
condition|)
block|{
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|OutWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|,
name|pInfo
operator|->
name|BeeperControl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pInfo
operator|->
name|ValidFields
operator|&
name|HPT601_INFO_LED1CONTROL
condition|)
block|{
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|OutWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|,
name|pInfo
operator|->
name|LED1Control
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pInfo
operator|->
name|ValidFields
operator|&
name|HPT601_INFO_LED2CONTROL
condition|)
block|{
name|mSetBlockCount
argument_list|(
name|IoPort
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|OutWord
argument_list|(
operator|&
name|IoPort
operator|->
name|Data
argument_list|,
name|pInfo
operator|->
name|LED2Control
argument_list|)
expr_stmt|;
block|}
name|EndAccess601
argument_list|(
name|IoPort
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* hpt_default_ioctl()  *  This is a default implementation. The platform dependent part  *  may reuse this function and/or use it own implementation for  *  each ioctl function.  */
end_comment

begin_function
name|int
name|hpt_default_ioctl
parameter_list|(
name|_VBUS_ARG
name|DWORD
name|dwIoControlCode
parameter_list|,
comment|/* operation control code */
name|PVOID
name|lpInBuffer
parameter_list|,
comment|/* input data buffer */
name|DWORD
name|nInBufferSize
parameter_list|,
comment|/* size of input data buffer */
name|PVOID
name|lpOutBuffer
parameter_list|,
comment|/* output data buffer */
name|DWORD
name|nOutBufferSize
parameter_list|,
comment|/* size of output data buffer */
name|PDWORD
name|lpBytesReturned
comment|/* byte count */
parameter_list|)
block|{
switch|switch
condition|(
name|dwIoControlCode
condition|)
block|{
case|case
name|HPT_IOCTL_GET_VERSION
case|:
if|if
condition|(
name|nInBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DWORD
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
operator|*
operator|(
operator|(
name|DWORD
operator|*
operator|)
name|lpOutBuffer
operator|)
operator|=
name|HPT_INTERFACE_VERSION
expr_stmt|;
break|break;
case|case
name|HPT_IOCTL_GET_CONTROLLER_COUNT
case|:
if|if
condition|(
name|nOutBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DWORD
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
operator|*
operator|(
name|PDWORD
operator|)
name|lpOutBuffer
operator|=
name|hpt_get_controller_count
argument_list|()
expr_stmt|;
break|break;
case|case
name|HPT_IOCTL_GET_CONTROLLER_INFO
case|:
block|{
name|int
name|id
decl_stmt|;
name|PCONTROLLER_INFO
name|pInfo
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DWORD
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|CONTROLLER_INFO
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|*
operator|(
name|DWORD
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
name|pInfo
operator|=
operator|(
name|PCONTROLLER_INFO
operator|)
name|lpOutBuffer
expr_stmt|;
if|if
condition|(
name|hpt_get_controller_info
argument_list|(
name|id
argument_list|,
name|pInfo
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_GET_CHANNEL_INFO
case|:
block|{
name|int
name|id
decl_stmt|,
name|bus
decl_stmt|;
name|PCHANNEL_INFO
name|pInfo
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
literal|8
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|CHANNEL_INFO
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|*
operator|(
name|DWORD
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
name|bus
operator|=
operator|(
operator|(
name|DWORD
operator|*
operator|)
name|lpInBuffer
operator|)
index|[
literal|1
index|]
expr_stmt|;
name|pInfo
operator|=
operator|(
name|PCHANNEL_INFO
operator|)
name|lpOutBuffer
expr_stmt|;
if|if
condition|(
name|hpt_get_channel_info
argument_list|(
name|id
argument_list|,
name|bus
argument_list|,
name|pInfo
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_GET_LOGICAL_DEVICES
case|:
block|{
name|DWORD
name|nMax
decl_stmt|;
name|DEVICEID
modifier|*
name|pIds
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DWORD
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|nMax
operator|=
operator|*
operator|(
name|DWORD
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
if|if
condition|(
name|nOutBufferSize
operator|<
sizeof|sizeof
argument_list|(
name|DWORD
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|DWORD
argument_list|)
operator|*
name|nMax
condition|)
return|return
operator|-
literal|1
return|;
name|pIds
operator|=
operator|(
operator|(
name|DEVICEID
operator|*
operator|)
name|lpOutBuffer
operator|)
operator|+
literal|1
expr_stmt|;
operator|*
operator|(
name|DWORD
operator|*
operator|)
name|lpOutBuffer
operator|=
name|hpt_get_logical_devices
argument_list|(
name|pIds
argument_list|,
name|nMax
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HPT_IOCTL_GET_DEVICE_INFO
case|:
block|{
name|DEVICEID
name|id
decl_stmt|;
name|PLOGICAL_DEVICE_INFO
name|pInfo
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DEVICEID
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|LOGICAL_DEVICE_INFO
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|*
operator|(
name|DWORD
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|INVALID_DEVICEID
condition|)
return|return
operator|-
literal|1
return|;
name|pInfo
operator|=
operator|(
name|PLOGICAL_DEVICE_INFO
operator|)
name|lpOutBuffer
expr_stmt|;
name|memset
argument_list|(
name|pInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|LOGICAL_DEVICE_INFO
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hpt_get_device_info
argument_list|(
name|id
argument_list|,
name|pInfo
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
ifdef|#
directive|ifdef
name|SUPPORT_ARRAY
case|case
name|HPT_IOCTL_CREATE_ARRAY
case|:
block|{
name|CREATE_ARRAY_PARAMS
modifier|*
name|pParam
decl_stmt|;
name|DEVICEID
name|id
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|CREATE_ARRAY_PARAMS
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DEVICEID
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pParam
operator|=
operator|(
name|PCREATE_ARRAY_PARAMS
operator|)
name|lpInBuffer
expr_stmt|;
name|id
operator|=
name|hpt_create_array
argument_list|(
argument|_VBUS_P pParam
argument_list|)
expr_stmt|;
operator|*
operator|(
name|DEVICEID
operator|*
operator|)
name|lpOutBuffer
operator|=
name|id
expr_stmt|;
if|if
condition|(
name|id
operator|==
operator|(
name|DEVICEID
operator|)
name|INVALID_DEVICEID
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_SET_ARRAY_INFO
case|:
block|{
name|DEVICEID
name|idArray
decl_stmt|;
name|PALTERABLE_ARRAY_INFO
name|pInfo
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|HPT_SET_ARRAY_INFO
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|idArray
operator|=
operator|(
operator|(
name|PHPT_SET_ARRAY_INFO
operator|)
name|lpInBuffer
operator|)
operator|->
name|idArray
expr_stmt|;
name|pInfo
operator|=
operator|&
operator|(
operator|(
name|PHPT_SET_ARRAY_INFO
operator|)
name|lpInBuffer
operator|)
operator|->
name|Info
expr_stmt|;
if|if
condition|(
name|hpt_set_array_info
argument_list|(
argument|_VBUS_P idArray
argument_list|,
argument|pInfo
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_SET_DEVICE_INFO
case|:
block|{
name|DEVICEID
name|idDisk
decl_stmt|;
name|PALTERABLE_DEVICE_INFO
name|pInfo
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|HPT_SET_DEVICE_INFO
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|idDisk
operator|=
operator|(
operator|(
name|PHPT_SET_DEVICE_INFO
operator|)
name|lpInBuffer
operator|)
operator|->
name|idDisk
expr_stmt|;
name|pInfo
operator|=
operator|&
operator|(
operator|(
name|PHPT_SET_DEVICE_INFO
operator|)
name|lpInBuffer
operator|)
operator|->
name|Info
expr_stmt|;
if|if
condition|(
name|hpt_set_device_info
argument_list|(
argument|_VBUS_P idDisk
argument_list|,
argument|pInfo
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_SET_BOOT_MARK
case|:
block|{
name|DEVICEID
name|id
decl_stmt|;
name|PVDevice
name|pTop
decl_stmt|;
name|int
name|i
decl_stmt|;
name|IAL_ADAPTER_T
modifier|*
name|pAdapter
init|=
name|gIal_Adapter
decl_stmt|;
name|PVBus
name|pVBus
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DEVICEID
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|*
operator|(
name|DEVICEID
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
while|while
condition|(
name|pAdapter
operator|!=
literal|0
condition|)
block|{
name|pVBus
operator|=
operator|&
name|pAdapter
operator|->
name|VBus
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_VDEVICE_PER_VBUS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|pTop
operator|=
name|pVBus
operator|->
name|pVDevice
index|[
name|i
index|]
operator|)
condition|)
continue|continue;
if|#
directive|if
name|MAX_VBUS
operator|>
literal|1
if|if
condition|(
name|pTop
operator|->
name|pVBus
operator|!=
name|_vbus_p
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
while|while
condition|(
name|pTop
operator|->
name|pParent
condition|)
name|pTop
operator|=
name|pTop
operator|->
name|pParent
expr_stmt|;
if|if
condition|(
name|id
operator|==
literal|0
operator|&&
name|pTop
operator|->
name|vf_bootmark
condition|)
name|pTop
operator|->
name|vf_bootmark
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|pTop
operator|==
name|ID_TO_VDEV
argument_list|(
name|id
argument_list|)
operator|&&
operator|!
name|pTop
operator|->
name|vf_bootmark
condition|)
name|pTop
operator|->
name|vf_bootmark
operator|=
literal|1
expr_stmt|;
else|else
continue|continue;
name|SyncArrayInfo
argument_list|(
name|pTop
argument_list|)
expr_stmt|;
break|break;
block|}
name|pAdapter
operator|=
name|pAdapter
operator|->
name|next
expr_stmt|;
block|}
block|}
break|break;
endif|#
directive|endif
comment|/* SUPPORT_ARRAY */
case|case
name|HPT_IOCTL_RESCAN_DEVICES
case|:
block|{
name|fRescanAllDevice
argument_list|(
name|_VBUS_P0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|fRescanAllDevice
argument_list|(
name|_VBUS_P0
argument_list|)
expr_stmt|;
block|}
break|break;
ifdef|#
directive|ifdef
name|SUPPORT_ARRAY
case|case
name|HPT_IOCTL_ADD_SPARE_DISK
case|:
block|{
name|DEVICEID
name|id
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DEVICEID
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|*
operator|(
name|DEVICEID
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
if|if
condition|(
name|hpt_add_spare_disk
argument_list|(
argument|_VBUS_P id
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_REMOVE_SPARE_DISK
case|:
block|{
name|DEVICEID
name|id
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DEVICEID
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|*
operator|(
name|DEVICEID
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
if|if
condition|(
name|hpt_remove_spare_disk
argument_list|(
argument|_VBUS_P id
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_ADD_DISK_TO_ARRAY
case|:
block|{
name|DEVICEID
name|id1
decl_stmt|,
name|id2
decl_stmt|;
name|id1
operator|=
operator|(
operator|(
name|PHPT_ADD_DISK_TO_ARRAY
operator|)
name|lpInBuffer
operator|)
operator|->
name|idArray
expr_stmt|;
name|id2
operator|=
operator|(
operator|(
name|PHPT_ADD_DISK_TO_ARRAY
operator|)
name|lpInBuffer
operator|)
operator|->
name|idDisk
expr_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|HPT_ADD_DISK_TO_ARRAY
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hpt_add_disk_to_array
argument_list|(
argument|_VBUS_P id1
argument_list|,
argument|id2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
endif|#
directive|endif
case|case
name|HPT_IOCTL_GET_DRIVER_CAPABILITIES
case|:
block|{
name|PDRIVER_CAPABILITIES
name|cap
decl_stmt|;
if|if
condition|(
name|nOutBufferSize
operator|<
sizeof|sizeof
argument_list|(
name|DRIVER_CAPABILITIES
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|cap
operator|=
operator|(
name|PDRIVER_CAPABILITIES
operator|)
name|lpOutBuffer
expr_stmt|;
if|if
condition|(
name|hpt_get_driver_capabilities
argument_list|(
name|cap
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
ifdef|#
directive|ifdef
name|SUPPORT_HPT601
case|case
name|HPT_IOCTL_GET_601_INFO
case|:
block|{
name|DEVICEID
name|id
decl_stmt|;
name|PHPT601_INFO
name|pInfo
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|DEVICEID
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|HPT601_INFO
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|*
operator|(
name|DWORD
operator|*
operator|)
name|lpInBuffer
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|INVALID_DEVICEID
condition|)
return|return
operator|-
literal|1
return|;
name|pInfo
operator|=
operator|(
name|PHPT601_INFO
operator|)
name|lpOutBuffer
expr_stmt|;
name|memset
argument_list|(
name|pInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|HPT601_INFO
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hpt_get_601_info
argument_list|(
name|id
argument_list|,
name|pInfo
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|HPT_IOCTL_SET_601_INFO
case|:
block|{
name|DEVICEID
name|id
decl_stmt|;
name|PHPT601_INFO
name|pInfo
decl_stmt|;
if|if
condition|(
name|nInBufferSize
operator|!=
sizeof|sizeof
argument_list|(
name|HPT_SET_601_INFO
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nOutBufferSize
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|id
operator|=
operator|(
operator|(
name|PHPT_SET_601_INFO
operator|)
name|lpInBuffer
operator|)
operator|->
name|idDisk
expr_stmt|;
name|pInfo
operator|=
operator|&
operator|(
operator|(
name|PHPT_SET_601_INFO
operator|)
name|lpInBuffer
operator|)
operator|->
name|Info
expr_stmt|;
if|if
condition|(
name|hpt_set_601_info
argument_list|(
name|id
argument_list|,
name|pInfo
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
break|break;
endif|#
directive|endif
default|default:
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|lpBytesReturned
condition|)
operator|*
name|lpBytesReturned
operator|=
name|nOutBufferSize
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


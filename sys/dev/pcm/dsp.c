begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999 Cameron Grant<gandalf@vilnya.demon.co.uk>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<dev/pcm/sound.h>
end_include

begin_function_decl
specifier|static
name|int
name|getchns
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|pcm_channel
modifier|*
modifier|*
name|rdch
parameter_list|,
name|pcm_channel
modifier|*
modifier|*
name|wrch
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|pcm_channel
modifier|*
name|allocchn
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|direction
parameter_list|)
block|{
name|pcm_channel
modifier|*
name|chns
init|=
operator|(
name|direction
operator|==
name|PCMDIR_PLAY
operator|)
condition|?
name|d
operator|->
name|play
else|:
name|d
operator|->
name|rec
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
init|=
operator|(
name|direction
operator|==
name|PCMDIR_PLAY
operator|)
condition|?
name|d
operator|->
name|playcount
else|:
name|d
operator|->
name|reccount
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|chns
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|CHN_F_BUSY
operator|)
condition|)
block|{
name|chns
index|[
name|i
index|]
operator|.
name|flags
operator||=
name|CHN_F_BUSY
expr_stmt|;
return|return
operator|&
name|chns
index|[
name|i
index|]
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|getchns
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|pcm_channel
modifier|*
modifier|*
name|rdch
parameter_list|,
name|pcm_channel
modifier|*
modifier|*
name|wrch
parameter_list|)
block|{
if|if
condition|(
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_PRIO_SET
operator|)
operator|==
name|SD_F_PRIO_SET
condition|)
name|panic
argument_list|(
literal|"read and write both prioritised"
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SD_F_SIMPLEX
condition|)
block|{
operator|*
name|rdch
operator|=
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_PRIO_RD
operator|)
condition|?
name|d
operator|->
name|arec
index|[
name|chan
index|]
else|:
operator|&
name|d
operator|->
name|fakechan
expr_stmt|;
operator|*
name|wrch
operator|=
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_PRIO_WR
operator|)
condition|?
name|d
operator|->
name|aplay
index|[
name|chan
index|]
else|:
operator|&
name|d
operator|->
name|fakechan
expr_stmt|;
block|}
else|else
block|{
operator|*
name|rdch
operator|=
name|d
operator|->
name|arec
index|[
name|chan
index|]
expr_stmt|;
operator|*
name|wrch
operator|=
name|d
operator|->
name|aplay
index|[
name|chan
index|]
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setchns
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
if|if
condition|(
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_PRIO_SET
operator|)
operator|==
name|SD_F_PRIO_SET
condition|)
name|panic
argument_list|(
literal|"read and write both prioritised"
argument_list|)
expr_stmt|;
name|d
operator|->
name|flags
operator||=
name|SD_F_DIR_SET
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|flags
operator|&
name|SD_F_EVILSB16
condition|)
block|{
if|if
condition|(
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_PRIO_RD
operator|)
operator|&&
operator|(
name|d
operator|->
name|aplay
index|[
name|chan
index|]
operator|)
condition|)
block|{
name|pcm_channel
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|d
operator|->
name|arec
index|[
name|chan
index|]
expr_stmt|;
name|d
operator|->
name|arec
index|[
name|chan
index|]
operator|=
name|d
operator|->
name|aplay
index|[
name|chan
index|]
expr_stmt|;
name|d
operator|->
name|aplay
index|[
name|chan
index|]
operator|=
name|tmp
expr_stmt|;
block|}
if|if
condition|(
name|d
operator|->
name|aplay
index|[
name|chan
index|]
condition|)
name|chn_setdir
argument_list|(
name|d
operator|->
name|aplay
index|[
name|chan
index|]
argument_list|,
name|PCMDIR_PLAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|arec
index|[
name|chan
index|]
condition|)
name|chn_setdir
argument_list|(
name|d
operator|->
name|arec
index|[
name|chan
index|]
argument_list|,
name|PCMDIR_REC
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|dsp_open
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|oflags
parameter_list|,
name|int
name|devtype
parameter_list|)
block|{
name|pcm_channel
modifier|*
name|rdch
init|=
name|NULL
decl_stmt|,
modifier|*
name|wrch
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|fmt
decl_stmt|;
if|if
condition|(
name|chan
operator|>=
name|d
operator|->
name|chancount
condition|)
return|return
name|ENODEV
return|;
if|if
condition|(
name|d
operator|->
name|aplay
index|[
name|chan
index|]
operator|||
name|d
operator|->
name|arec
index|[
name|chan
index|]
condition|)
return|return
name|EBUSY
return|;
if|if
condition|(
name|oflags
operator|&
name|FREAD
condition|)
block|{
name|rdch
operator|=
name|allocchn
argument_list|(
name|d
argument_list|,
name|PCMDIR_REC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdch
condition|)
return|return
name|EBUSY
return|;
block|}
if|if
condition|(
name|oflags
operator|&
name|FWRITE
condition|)
block|{
name|wrch
operator|=
name|allocchn
argument_list|(
name|d
argument_list|,
name|PCMDIR_PLAY
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wrch
condition|)
block|{
if|if
condition|(
name|rdch
condition|)
name|rdch
operator|->
name|flags
operator|&=
operator|~
name|CHN_F_BUSY
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
block|}
name|d
operator|->
name|aplay
index|[
name|chan
index|]
operator|=
name|wrch
expr_stmt|;
name|d
operator|->
name|arec
index|[
name|chan
index|]
operator|=
name|rdch
expr_stmt|;
switch|switch
condition|(
name|devtype
condition|)
block|{
case|case
name|SND_DEV_DSP16
case|:
name|fmt
operator|=
name|AFMT_S16_LE
expr_stmt|;
break|break;
case|case
name|SND_DEV_DSP
case|:
name|fmt
operator|=
name|AFMT_U8
expr_stmt|;
break|break;
case|case
name|SND_DEV_AUDIO
case|:
name|fmt
operator|=
name|AFMT_MU_LAW
expr_stmt|;
break|break;
case|case
name|SND_DEV_NORESET
case|:
name|fmt
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|rdch
condition|)
block|{
name|chn_reset
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
if|if
condition|(
name|oflags
operator|&
name|O_NONBLOCK
condition|)
name|rdch
operator|->
name|flags
operator||=
name|CHN_F_NBIO
expr_stmt|;
if|if
condition|(
name|fmt
condition|)
block|{
name|rdch
operator|->
name|volume
operator|=
operator|(
literal|100
operator|<<
literal|8
operator|)
operator||
literal|100
expr_stmt|;
name|rdch
operator|->
name|format
operator|=
name|fmt
expr_stmt|;
name|rdch
operator|->
name|speed
operator|=
name|DSP_DEFAULT_SPEED
expr_stmt|;
name|rdch
operator|->
name|blocksize
operator|=
literal|2048
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wrch
condition|)
block|{
name|chn_reset
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
if|if
condition|(
name|oflags
operator|&
name|O_NONBLOCK
condition|)
name|wrch
operator|->
name|flags
operator||=
name|CHN_F_NBIO
expr_stmt|;
if|if
condition|(
name|fmt
condition|)
block|{
name|wrch
operator|->
name|volume
operator|=
operator|(
literal|100
operator|<<
literal|8
operator|)
operator||
literal|100
expr_stmt|;
name|wrch
operator|->
name|format
operator|=
name|fmt
expr_stmt|;
name|wrch
operator|->
name|speed
operator|=
name|DSP_DEFAULT_SPEED
expr_stmt|;
name|wrch
operator|->
name|blocksize
operator|=
literal|2048
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dsp_close
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|devtype
parameter_list|)
block|{
name|pcm_channel
modifier|*
name|rdch
decl_stmt|,
modifier|*
name|wrch
decl_stmt|;
name|d
operator|->
name|flags
operator|&=
operator|~
name|SD_F_TRANSIENT
expr_stmt|;
name|rdch
operator|=
name|d
operator|->
name|arec
index|[
name|chan
index|]
expr_stmt|;
name|wrch
operator|=
name|d
operator|->
name|aplay
index|[
name|chan
index|]
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
block|{
name|chn_abort
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
name|rdch
operator|->
name|flags
operator|&=
operator|~
operator|(
name|CHN_F_BUSY
operator||
name|CHN_F_RUNNING
operator||
name|CHN_F_MAPPED
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|wrch
condition|)
name|wrch
operator|->
name|flags
operator|&=
operator|~
operator|(
name|CHN_F_BUSY
operator||
name|CHN_F_RUNNING
operator||
name|CHN_F_MAPPED
operator|)
expr_stmt|;
name|d
operator|->
name|aplay
index|[
name|chan
index|]
operator|=
name|NULL
expr_stmt|;
name|d
operator|->
name|arec
index|[
name|chan
index|]
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dsp_read
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|pcm_channel
modifier|*
name|rdch
decl_stmt|,
modifier|*
name|wrch
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_PRIO_SET
operator|)
condition|)
name|d
operator|->
name|flags
operator||=
name|SD_F_PRIO_RD
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_DIR_SET
operator|)
condition|)
name|setchns
argument_list|(
name|d
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|getchns
argument_list|(
name|d
argument_list|,
name|chan
argument_list|,
operator|&
name|rdch
argument_list|,
operator|&
name|wrch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdch
operator|||
operator|!
operator|(
name|rdch
operator|->
name|flags
operator|&
name|CHN_F_BUSY
operator|)
condition|)
name|panic
argument_list|(
literal|"dsp_read: non%s channel"
argument_list|,
name|rdch
condition|?
literal|"busy"
else|:
literal|"existant"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
operator|->
name|flags
operator|&
name|CHN_F_MAPPED
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|!
operator|(
name|rdch
operator|->
name|flags
operator|&
name|CHN_F_RUNNING
operator|)
condition|)
block|{
name|rdch
operator|->
name|flags
operator||=
name|CHN_F_RUNNING
expr_stmt|;
name|chn_reinit
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
block|}
return|return
name|chn_read
argument_list|(
name|rdch
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|dsp_write
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|pcm_channel
modifier|*
name|rdch
decl_stmt|,
modifier|*
name|wrch
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_PRIO_SET
operator|)
condition|)
name|d
operator|->
name|flags
operator||=
name|SD_F_PRIO_WR
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_DIR_SET
operator|)
condition|)
name|setchns
argument_list|(
name|d
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|getchns
argument_list|(
name|d
argument_list|,
name|chan
argument_list|,
operator|&
name|rdch
argument_list|,
operator|&
name|wrch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wrch
operator|||
operator|!
operator|(
name|wrch
operator|->
name|flags
operator|&
name|CHN_F_BUSY
operator|)
condition|)
name|panic
argument_list|(
literal|"dsp_write: non%s channel"
argument_list|,
name|wrch
condition|?
literal|"busy"
else|:
literal|"existant"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
operator|->
name|flags
operator|&
name|CHN_F_MAPPED
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|!
operator|(
name|wrch
operator|->
name|flags
operator|&
name|CHN_F_RUNNING
operator|)
condition|)
block|{
name|wrch
operator|->
name|flags
operator||=
name|CHN_F_RUNNING
expr_stmt|;
name|chn_reinit
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
block|}
return|return
name|chn_write
argument_list|(
name|wrch
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|dsp_ioctl
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|arg
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|,
modifier|*
name|arg_i
init|=
operator|(
name|int
operator|*
operator|)
name|arg
decl_stmt|;
name|u_long
name|s
decl_stmt|;
name|pcm_channel
modifier|*
name|wrch
init|=
name|NULL
decl_stmt|,
modifier|*
name|rdch
init|=
name|NULL
decl_stmt|;
name|rdch
operator|=
name|d
operator|->
name|arec
index|[
name|chan
index|]
expr_stmt|;
name|wrch
operator|=
name|d
operator|->
name|aplay
index|[
name|chan
index|]
expr_stmt|;
comment|/*      	 * all routines are called with int. blocked. Make sure that      	 * ints are re-enabled when calling slow or blocking functions!      	 */
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
comment|/*      	 * we start with the new ioctl interface.      	 */
case|case
name|AIONWRITE
case|:
comment|/* how many bytes can write ? */
if|if
condition|(
name|wrch
operator|&&
name|wrch
operator|->
name|buffer
operator|.
name|dl
condition|)
name|chn_dmaupdate
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
operator|*
name|arg_i
operator|=
name|wrch
condition|?
name|wrch
operator|->
name|buffer
operator|.
name|fl
else|:
literal|0
expr_stmt|;
break|break;
case|case
name|AIOSSIZE
case|:
comment|/* set the current blocksize */
block|{
name|struct
name|snd_size
modifier|*
name|p
init|=
operator|(
expr|struct
name|snd_size
operator|*
operator|)
name|arg
decl_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_setblocksize
argument_list|(
name|wrch
argument_list|,
name|p
operator|->
name|play_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_setblocksize
argument_list|(
name|rdch
argument_list|,
name|p
operator|->
name|rec_size
argument_list|)
expr_stmt|;
block|}
comment|/* FALLTHROUGH */
case|case
name|AIOGSIZE
case|:
comment|/* get the current blocksize */
block|{
name|struct
name|snd_size
modifier|*
name|p
init|=
operator|(
expr|struct
name|snd_size
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|wrch
condition|)
name|p
operator|->
name|play_size
operator|=
name|wrch
operator|->
name|blocksize
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|p
operator|->
name|rec_size
operator|=
name|rdch
operator|->
name|blocksize
expr_stmt|;
block|}
break|break;
case|case
name|AIOSFMT
case|:
block|{
name|snd_chan_param
modifier|*
name|p
init|=
operator|(
name|snd_chan_param
operator|*
operator|)
name|arg
decl_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
block|{
name|chn_setformat
argument_list|(
name|wrch
argument_list|,
name|p
operator|->
name|play_format
argument_list|)
expr_stmt|;
name|chn_setspeed
argument_list|(
name|wrch
argument_list|,
name|p
operator|->
name|play_rate
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdch
condition|)
block|{
name|chn_setformat
argument_list|(
name|rdch
argument_list|,
name|p
operator|->
name|rec_format
argument_list|)
expr_stmt|;
name|chn_setspeed
argument_list|(
name|rdch
argument_list|,
name|p
operator|->
name|rec_rate
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* FALLTHROUGH */
case|case
name|AIOGFMT
case|:
block|{
name|snd_chan_param
modifier|*
name|p
init|=
operator|(
name|snd_chan_param
operator|*
operator|)
name|arg
decl_stmt|;
name|p
operator|->
name|play_rate
operator|=
name|wrch
condition|?
name|wrch
operator|->
name|speed
else|:
literal|0
expr_stmt|;
name|p
operator|->
name|rec_rate
operator|=
name|rdch
condition|?
name|rdch
operator|->
name|speed
else|:
literal|0
expr_stmt|;
name|p
operator|->
name|play_format
operator|=
name|wrch
condition|?
name|wrch
operator|->
name|format
else|:
literal|0
expr_stmt|;
name|p
operator|->
name|rec_format
operator|=
name|rdch
condition|?
name|rdch
operator|->
name|format
else|:
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|AIOGCAP
case|:
comment|/* get capabilities */
block|{
name|snd_capabilities
modifier|*
name|p
init|=
operator|(
name|snd_capabilities
operator|*
operator|)
name|arg
decl_stmt|;
name|pcmchan_caps
modifier|*
name|pcaps
init|=
name|NULL
decl_stmt|,
modifier|*
name|rcaps
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|rdch
condition|)
name|rcaps
operator|=
name|chn_getcaps
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|pcaps
operator|=
name|chn_getcaps
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
name|p
operator|->
name|rate_min
operator|=
name|max
argument_list|(
name|rcaps
condition|?
name|rcaps
operator|->
name|minspeed
else|:
literal|0
argument_list|,
name|pcaps
condition|?
name|pcaps
operator|->
name|minspeed
else|:
literal|0
argument_list|)
expr_stmt|;
name|p
operator|->
name|rate_max
operator|=
name|min
argument_list|(
name|rcaps
condition|?
name|rcaps
operator|->
name|maxspeed
else|:
literal|1000000
argument_list|,
name|pcaps
condition|?
name|pcaps
operator|->
name|maxspeed
else|:
literal|1000000
argument_list|)
expr_stmt|;
name|p
operator|->
name|bufsize
operator|=
name|min
argument_list|(
name|rdch
condition|?
name|rdch
operator|->
name|buffer
operator|.
name|bufsize
else|:
literal|1000000
argument_list|,
name|wrch
condition|?
name|wrch
operator|->
name|buffer
operator|.
name|bufsize
else|:
literal|1000000
argument_list|)
expr_stmt|;
comment|/* XXX bad on sb16 */
name|p
operator|->
name|formats
operator|=
operator|(
name|rcaps
condition|?
name|rcaps
operator|->
name|formats
else|:
literal|0xffffffff
operator|)
operator|&
operator|(
name|pcaps
condition|?
name|pcaps
operator|->
name|formats
else|:
literal|0xffffffff
operator|)
expr_stmt|;
name|p
operator|->
name|mixers
operator|=
literal|1
expr_stmt|;
comment|/* default: one mixer */
name|p
operator|->
name|inputs
operator|=
name|d
operator|->
name|mixer
operator|.
name|devs
expr_stmt|;
name|p
operator|->
name|left
operator|=
name|p
operator|->
name|right
operator|=
literal|100
expr_stmt|;
block|}
break|break;
case|case
name|AIOSTOP
case|:
if|if
condition|(
operator|*
name|arg_i
operator|==
name|AIOSYNC_PLAY
operator|&&
name|wrch
condition|)
operator|*
name|arg_i
operator|=
name|chn_abort
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|arg_i
operator|==
name|AIOSYNC_CAPTURE
operator|&&
name|rdch
condition|)
operator|*
name|arg_i
operator|=
name|chn_abort
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
else|else
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"AIOSTOP: bad channel 0x%x\n"
argument_list|,
operator|*
name|arg_i
argument_list|)
expr_stmt|;
operator|*
name|arg_i
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|AIOSYNC
case|:
name|printf
argument_list|(
literal|"AIOSYNC chan 0x%03lx pos %lu unimplemented\n"
argument_list|,
operator|(
operator|(
name|snd_sync_parm
operator|*
operator|)
name|arg
operator|)
operator|->
name|chan
argument_list|,
operator|(
operator|(
name|snd_sync_parm
operator|*
operator|)
name|arg
operator|)
operator|->
name|pos
argument_list|)
expr_stmt|;
break|break;
comment|/* 	 * here follow the standard ioctls (filio.h etc.) 	 */
case|case
name|FIONREAD
case|:
comment|/* get # bytes to read */
if|if
condition|(
name|rdch
operator|&&
name|rdch
operator|->
name|buffer
operator|.
name|dl
condition|)
name|chn_dmaupdate
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
operator|*
name|arg_i
operator|=
name|rdch
condition|?
name|rdch
operator|->
name|buffer
operator|.
name|rl
else|:
literal|0
expr_stmt|;
break|break;
case|case
name|FIOASYNC
case|:
comment|/*set/clear async i/o */
name|DEB
argument_list|(
argument|printf(
literal|"FIOASYNC\n"
argument|) ;
argument_list|)
break|break;
case|case
name|SNDCTL_DSP_NONBLOCK
case|:
case|case
name|FIONBIO
case|:
comment|/* set/clear non-blocking i/o */
if|if
condition|(
name|rdch
condition|)
name|rdch
operator|->
name|flags
operator|&=
operator|~
name|CHN_F_NBIO
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|wrch
operator|->
name|flags
operator|&=
operator|~
name|CHN_F_NBIO
expr_stmt|;
if|if
condition|(
operator|*
name|arg_i
condition|)
block|{
if|if
condition|(
name|rdch
condition|)
name|rdch
operator|->
name|flags
operator||=
name|CHN_F_NBIO
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|wrch
operator|->
name|flags
operator||=
name|CHN_F_NBIO
expr_stmt|;
block|}
break|break;
comment|/* 	 * Finally, here is the linux-compatible ioctl interface 	 */
define|#
directive|define
name|THE_REAL_SNDCTL_DSP_GETBLKSIZE
value|_IOWR('P', 4, int)
case|case
name|THE_REAL_SNDCTL_DSP_GETBLKSIZE
case|:
case|case
name|SNDCTL_DSP_GETBLKSIZE
case|:
operator|*
name|arg_i
operator|=
name|wrch
condition|?
name|wrch
operator|->
name|blocksize
else|:
literal|0
expr_stmt|;
comment|/* XXX rdch? */
break|break ;
case|case
name|SNDCTL_DSP_SETBLKSIZE
case|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_setblocksize
argument_list|(
name|wrch
argument_list|,
operator|*
name|arg_i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_setblocksize
argument_list|(
name|rdch
argument_list|,
operator|*
name|arg_i
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_RESET
case|:
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"dsp reset\n"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_abort
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_abort
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_SYNC
case|:
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"dsp sync\n"
argument_list|)
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_sync
argument_list|(
name|wrch
argument_list|,
name|wrch
operator|->
name|buffer
operator|.
name|bufsize
operator|-
literal|4
argument_list|)
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_SPEED
case|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_setspeed
argument_list|(
name|wrch
argument_list|,
operator|*
name|arg_i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_setspeed
argument_list|(
name|rdch
argument_list|,
operator|*
name|arg_i
argument_list|)
expr_stmt|;
comment|/* fallthru */
case|case
name|SOUND_PCM_READ_RATE
case|:
operator|*
name|arg_i
operator|=
name|wrch
condition|?
name|wrch
operator|->
name|speed
else|:
name|rdch
operator|->
name|speed
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_STEREO
case|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_setformat
argument_list|(
name|wrch
argument_list|,
operator|(
name|wrch
operator|->
name|format
operator|&
operator|~
name|AFMT_STEREO
operator|)
operator||
operator|(
operator|(
operator|*
name|arg_i
operator|)
condition|?
name|AFMT_STEREO
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_setformat
argument_list|(
name|rdch
argument_list|,
operator|(
name|rdch
operator|->
name|format
operator|&
operator|~
name|AFMT_STEREO
operator|)
operator||
operator|(
operator|(
operator|*
name|arg_i
operator|)
condition|?
name|AFMT_STEREO
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
operator|*
name|arg_i
operator|=
operator|(
operator|(
name|wrch
condition|?
name|wrch
operator|->
name|format
else|:
name|rdch
operator|->
name|format
operator|)
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
break|break;
case|case
name|SOUND_PCM_WRITE_CHANNELS
case|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_setformat
argument_list|(
name|wrch
argument_list|,
operator|(
name|wrch
operator|->
name|format
operator|&
operator|~
name|AFMT_STEREO
operator|)
operator||
operator|(
operator|(
operator|*
name|arg_i
operator|==
literal|2
operator|)
condition|?
name|AFMT_STEREO
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_setformat
argument_list|(
name|rdch
argument_list|,
operator|(
name|rdch
operator|->
name|format
operator|&
operator|~
name|AFMT_STEREO
operator|)
operator||
operator|(
operator|(
operator|*
name|arg_i
operator|==
literal|2
operator|)
condition|?
name|AFMT_STEREO
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
comment|/* fallthru */
case|case
name|SOUND_PCM_READ_CHANNELS
case|:
operator|*
name|arg_i
operator|=
operator|(
operator|(
name|wrch
condition|?
name|wrch
operator|->
name|format
else|:
name|rdch
operator|->
name|format
operator|)
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|2
else|:
literal|1
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_GETFMTS
case|:
comment|/* returns a mask of supported fmts */
operator|*
name|arg_i
operator|=
name|wrch
condition|?
name|chn_getcaps
argument_list|(
name|wrch
argument_list|)
operator|->
name|formats
else|:
name|chn_getcaps
argument_list|(
name|rdch
argument_list|)
operator|->
name|formats
expr_stmt|;
break|break ;
case|case
name|SNDCTL_DSP_SETFMT
case|:
comment|/* sets _one_ format */
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_setformat
argument_list|(
name|wrch
argument_list|,
operator|(
operator|*
name|arg_i
operator|)
operator||
operator|(
name|wrch
operator|->
name|format
operator|&
name|AFMT_STEREO
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_setformat
argument_list|(
name|rdch
argument_list|,
operator|(
operator|*
name|arg_i
operator|)
operator||
operator|(
name|rdch
operator|->
name|format
operator|&
name|AFMT_STEREO
operator|)
argument_list|)
expr_stmt|;
operator|*
name|arg_i
operator|=
operator|(
name|wrch
condition|?
name|wrch
operator|->
name|format
else|:
name|rdch
operator|->
name|format
operator|)
operator|&
operator|~
name|AFMT_STEREO
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_SUBDIVIDE
case|:
comment|/* XXX watch out, this is RW! */
name|DEB
argument_list|(
argument|printf(
literal|"SNDCTL_DSP_SUBDIVIDE unimplemented\n"
argument|);
argument_list|)
break|break;
case|case
name|SNDCTL_DSP_SETFRAGMENT
case|:
comment|/* XXX watch out, this is RW! */
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"SNDCTL_DSP_SETFRAGMENT 0x%08x\n"
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|arg
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|int
name|bytes
init|=
literal|1
operator|<<
name|min
argument_list|(
operator|*
name|arg_i
operator|&
literal|0xffff
argument_list|,
literal|16
argument_list|)
decl_stmt|;
name|int
name|count
init|=
operator|(
operator|*
name|arg_i
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
decl_stmt|;
name|pcm_channel
modifier|*
name|c
init|=
name|wrch
condition|?
name|wrch
else|:
name|rdch
decl_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdch
condition|)
name|chn_setblocksize
argument_list|(
name|rdch
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrch
condition|)
name|chn_setblocksize
argument_list|(
name|wrch
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
comment|/* eg: 4dwave can only interrupt at buffer midpoint, so 			 * it will force blocksize == bufsize/2 			 */
name|count
operator|=
name|c
operator|->
name|buffer
operator|.
name|bufsize
operator|/
name|c
operator|->
name|blocksize
expr_stmt|;
name|bytes
operator|=
name|ffs
argument_list|(
name|c
operator|->
name|blocksize
argument_list|)
operator|-
literal|1
expr_stmt|;
operator|*
name|arg_i
operator|=
operator|(
name|count
operator|<<
literal|16
operator|)
operator||
name|bytes
expr_stmt|;
block|}
break|break;
case|case
name|SNDCTL_DSP_GETISPACE
case|:
comment|/* return space available in the input queue */
block|{
name|audio_buf_info
modifier|*
name|a
init|=
operator|(
name|audio_buf_info
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|rdch
condition|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|rdch
operator|->
name|buffer
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
condition|)
name|chn_dmaupdate
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
name|a
operator|->
name|bytes
operator|=
name|b
operator|->
name|fl
expr_stmt|;
name|a
operator|->
name|fragments
operator|=
literal|1
expr_stmt|;
name|a
operator|->
name|fragstotal
operator|=
name|b
operator|->
name|bufsize
operator|/
name|rdch
operator|->
name|blocksize
expr_stmt|;
name|a
operator|->
name|fragsize
operator|=
name|rdch
operator|->
name|blocksize
expr_stmt|;
block|}
block|}
break|break;
case|case
name|SNDCTL_DSP_GETOSPACE
case|:
comment|/* return space available in the output queue */
block|{
name|audio_buf_info
modifier|*
name|a
init|=
operator|(
name|audio_buf_info
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|wrch
condition|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|wrch
operator|->
name|buffer
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
condition|)
name|chn_dmaupdate
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
name|a
operator|->
name|bytes
operator|=
name|b
operator|->
name|fl
expr_stmt|;
name|a
operator|->
name|fragments
operator|=
literal|1
expr_stmt|;
name|a
operator|->
name|fragstotal
operator|=
name|b
operator|->
name|bufsize
operator|/
name|wrch
operator|->
name|blocksize
expr_stmt|;
name|a
operator|->
name|fragsize
operator|=
name|wrch
operator|->
name|blocksize
expr_stmt|;
block|}
block|}
break|break;
case|case
name|SNDCTL_DSP_GETIPTR
case|:
block|{
name|count_info
modifier|*
name|a
init|=
operator|(
name|count_info
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|rdch
condition|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|rdch
operator|->
name|buffer
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
condition|)
name|chn_dmaupdate
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
name|a
operator|->
name|bytes
operator|=
name|b
operator|->
name|total
expr_stmt|;
name|a
operator|->
name|blocks
operator|=
operator|(
name|b
operator|->
name|total
operator|-
name|b
operator|->
name|prev_total
operator|)
operator|/
name|rdch
operator|->
name|blocksize
expr_stmt|;
name|a
operator|->
name|ptr
operator|=
name|b
operator|->
name|fp
expr_stmt|;
name|b
operator|->
name|prev_total
operator|+=
name|a
operator|->
name|blocks
operator|*
name|rdch
operator|->
name|blocksize
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|SNDCTL_DSP_GETOPTR
case|:
block|{
name|count_info
modifier|*
name|a
init|=
operator|(
name|count_info
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|wrch
condition|)
block|{
name|snd_dbuf
modifier|*
name|b
init|=
operator|&
name|wrch
operator|->
name|buffer
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|dl
condition|)
name|chn_dmaupdate
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
name|a
operator|->
name|bytes
operator|=
name|b
operator|->
name|total
expr_stmt|;
name|a
operator|->
name|blocks
operator|=
operator|(
name|b
operator|->
name|total
operator|-
name|b
operator|->
name|prev_total
operator|)
operator|/
name|wrch
operator|->
name|blocksize
expr_stmt|;
name|a
operator|->
name|ptr
operator|=
name|b
operator|->
name|rp
expr_stmt|;
name|b
operator|->
name|prev_total
operator|+=
name|a
operator|->
name|blocks
operator|*
name|wrch
operator|->
name|blocksize
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
name|SNDCTL_DSP_GETCAPS
case|:
operator|*
name|arg_i
operator|=
name|DSP_CAP_REALTIME
operator||
name|DSP_CAP_MMAP
operator||
name|DSP_CAP_TRIGGER
expr_stmt|;
if|if
condition|(
name|rdch
operator|&&
name|wrch
operator|&&
operator|!
operator|(
name|d
operator|->
name|flags
operator|&
name|SD_F_SIMPLEX
operator|)
condition|)
operator|*
name|arg_i
operator||=
name|DSP_CAP_DUPLEX
expr_stmt|;
break|break;
case|case
name|SOUND_PCM_READ_BITS
case|:
operator|*
name|arg_i
operator|=
operator|(
operator|(
name|wrch
condition|?
name|wrch
operator|->
name|format
else|:
name|rdch
operator|->
name|format
operator|)
operator|&
name|AFMT_16BIT
operator|)
condition|?
literal|16
else|:
literal|8
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_SETTRIGGER
case|:
if|if
condition|(
name|rdch
condition|)
block|{
name|rdch
operator|->
name|flags
operator|&=
operator|~
name|CHN_F_TRIGGERED
expr_stmt|;
if|if
condition|(
operator|*
name|arg_i
operator|&
name|PCM_ENABLE_INPUT
condition|)
name|rdch
operator|->
name|flags
operator||=
name|CHN_F_TRIGGERED
expr_stmt|;
name|chn_intr
argument_list|(
name|rdch
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wrch
condition|)
block|{
name|wrch
operator|->
name|flags
operator|&=
operator|~
name|CHN_F_TRIGGERED
expr_stmt|;
if|if
condition|(
operator|*
name|arg_i
operator|&
name|PCM_ENABLE_OUTPUT
condition|)
name|wrch
operator|->
name|flags
operator||=
name|CHN_F_TRIGGERED
expr_stmt|;
name|chn_intr
argument_list|(
name|wrch
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SNDCTL_DSP_GETTRIGGER
case|:
operator|*
name|arg_i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wrch
operator|&&
name|wrch
operator|->
name|flags
operator|&
name|CHN_F_TRIGGERED
condition|)
operator|*
name|arg_i
operator||=
name|PCM_ENABLE_OUTPUT
expr_stmt|;
if|if
condition|(
name|rdch
operator|&&
name|rdch
operator|->
name|flags
operator|&
name|CHN_F_TRIGGERED
condition|)
operator|*
name|arg_i
operator||=
name|PCM_ENABLE_INPUT
expr_stmt|;
break|break;
case|case
name|SNDCTL_DSP_MAPINBUF
case|:
case|case
name|SNDCTL_DSP_MAPOUTBUF
case|:
case|case
name|SNDCTL_DSP_SETSYNCRO
case|:
comment|/* undocumented */
case|case
name|SNDCTL_DSP_POST
case|:
case|case
name|SOUND_PCM_WRITE_FILTER
case|:
case|case
name|SOUND_PCM_READ_FILTER
case|:
comment|/* dunno what these do, don't sound important */
default|default:
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"default ioctl snd%d fn 0x%08x fail\n"
argument_list|,
name|unit
argument_list|,
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|dsp_poll
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|int
name|events
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|e
decl_stmt|;
name|pcm_channel
modifier|*
name|wrch
init|=
name|NULL
decl_stmt|,
modifier|*
name|rdch
init|=
name|NULL
decl_stmt|;
name|getchns
argument_list|(
name|d
argument_list|,
name|chan
argument_list|,
operator|&
name|rdch
argument_list|,
operator|&
name|wrch
argument_list|)
expr_stmt|;
name|e
operator|=
name|events
operator|&
operator|(
name|POLLOUT
operator||
name|POLLWRNORM
operator|)
expr_stmt|;
if|if
condition|(
name|wrch
operator|&&
name|e
condition|)
name|ret
operator||=
name|chn_poll
argument_list|(
name|wrch
argument_list|,
name|e
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|e
operator|=
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
expr_stmt|;
if|if
condition|(
name|rdch
operator|&&
name|e
condition|)
name|ret
operator||=
name|chn_poll
argument_list|(
name|rdch
argument_list|,
name|e
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|dsp_mmap
parameter_list|(
name|snddev_info
modifier|*
name|d
parameter_list|,
name|int
name|chan
parameter_list|,
name|vm_offset_t
name|offset
parameter_list|,
name|int
name|nprot
parameter_list|)
block|{
name|pcm_channel
modifier|*
name|wrch
init|=
name|NULL
decl_stmt|,
modifier|*
name|rdch
init|=
name|NULL
decl_stmt|,
modifier|*
name|c
init|=
name|NULL
decl_stmt|;
name|getchns
argument_list|(
name|d
argument_list|,
name|chan
argument_list|,
operator|&
name|rdch
argument_list|,
operator|&
name|wrch
argument_list|)
expr_stmt|;
comment|/* XXX this is broken by line 204 of vm/device_pager.c, so force write buffer */
if|if
condition|(
literal|1
operator|||
operator|(
name|wrch
operator|&&
operator|(
name|nprot
operator|&
name|PROT_WRITE
operator|)
operator|)
condition|)
name|c
operator|=
name|wrch
expr_stmt|;
elseif|else
if|if
condition|(
name|rdch
operator|&&
operator|(
name|nprot
operator|&
name|PROT_READ
operator|)
condition|)
name|c
operator|=
name|rdch
expr_stmt|;
if|if
condition|(
name|c
condition|)
block|{
name|c
operator|->
name|flags
operator||=
name|CHN_F_MAPPED
expr_stmt|;
return|return
name|atop
argument_list|(
name|vtophys
argument_list|(
name|c
operator|->
name|buffer
operator|.
name|buf
operator|+
name|offset
argument_list|)
argument_list|)
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


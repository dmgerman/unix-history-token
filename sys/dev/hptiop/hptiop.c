begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * HighPoint RR3xxx RAID Driver for FreeBSD  * Copyright (C) 2005-2007 HighPoint Technologies, Inc. All Rights Reserved.  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/cons.h>
end_include

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|500000
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|500000
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|500000
operator|)
end_if

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<=
literal|500043
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/devicestat.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_message.h>
end_include

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<
literal|500043
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/bus_private.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/hptiop/hptiop.h>
end_include

begin_decl_stmt
specifier|static
name|struct
name|hpt_iop_hba
modifier|*
name|g_hba
index|[
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|iop_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|driver_name
index|[]
init|=
literal|"hptiop"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|driver_version
index|[]
init|=
literal|"v1.2 (041307)"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|osm_max_targets
init|=
literal|32
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|hptiop_devclass
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|os_request_callback
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|u_int32_t
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|os_message_callback
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|u_int32_t
name|msg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_do_ioctl
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|struct
name|hpt_iop_ioctl_param
modifier|*
name|pParams
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_bus_scan_cb
parameter_list|(
name|struct
name|cam_periph
modifier|*
name|periph
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_rescan_bus
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_post_ioctl_command
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|struct
name|hpt_iop_request_ioctl_command
modifier|*
name|req
parameter_list|,
name|struct
name|hpt_iop_ioctl_param
modifier|*
name|pParams
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|os_query_remove_device
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|int
name|target_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_async
parameter_list|(
name|void
modifier|*
name|callback_arg
parameter_list|,
name|u_int32_t
name|code
parameter_list|,
name|struct
name|cam_path
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_pci_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_release_resource
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|hptiop_reset_adapter
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_enable_interrupts
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hptiop_disable_interrupts
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|d_open_t
name|hptiop_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|hptiop_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|hptiop_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|hptiop_cdevsw
init|=
block|{
operator|.
name|d_open
operator|=
name|hptiop_open
block|,
operator|.
name|d_close
operator|=
name|hptiop_close
block|,
operator|.
name|d_ioctl
operator|=
name|hptiop_ioctl
block|,
operator|.
name|d_name
operator|=
name|driver_name
block|,
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|503000
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
endif|#
directive|endif
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|503000
operator|&&
name|__FreeBSD_version
operator|<
literal|600034
operator|)
operator|.
name|d_flags
operator|=
name|D_NEEDGIANT
block|,
endif|#
directive|endif
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|600034
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|501000
operator|.
name|d_maj
operator|=
name|MAJOR_AUTO
block|,
else|#
directive|else
operator|.
name|d_maj
operator|=
name|HPT_DEV_MAJOR
block|,
endif|#
directive|endif
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|503000
end_if

begin_define
define|#
directive|define
name|hba_from_dev
parameter_list|(
name|dev
parameter_list|)
value|((struct hpt_iop_hba *)(dev)->si_drv1)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|hba_from_dev
parameter_list|(
name|dev
parameter_list|)
define|\
value|((struct hpt_iop_hba *)devclass_get_softc(hptiop_devclass, minor(dev)))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|hptiop_open
parameter_list|(
name|ioctl_dev_t
name|dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|devtype
parameter_list|,
name|ioctl_thread_t
name|proc
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
name|hba_from_dev
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|hba
operator|==
name|NULL
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|hba
operator|->
name|flag
operator|&
name|HPT_IOCTL_FLAG_OPEN
condition|)
return|return
name|EBUSY
return|;
name|hba
operator|->
name|flag
operator||=
name|HPT_IOCTL_FLAG_OPEN
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_close
parameter_list|(
name|ioctl_dev_t
name|dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|devtype
parameter_list|,
name|ioctl_thread_t
name|proc
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
name|hba_from_dev
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|hba
operator|->
name|flag
operator|&=
operator|~
operator|(
name|u_int32_t
operator|)
name|HPT_IOCTL_FLAG_OPEN
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_ioctl
parameter_list|(
name|ioctl_dev_t
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flags
parameter_list|,
name|ioctl_thread_t
name|proc
parameter_list|)
block|{
name|int
name|ret
init|=
name|EFAULT
decl_stmt|;
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
name|hba_from_dev
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|500000
operator|)
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|HPT_DO_IOCONTROL
case|:
name|ret
operator|=
name|hptiop_do_ioctl
argument_list|(
name|hba
argument_list|,
operator|(
expr|struct
name|hpt_iop_ioctl_param
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|HPT_SCAN_BUS
case|:
name|ret
operator|=
name|hptiop_rescan_bus
argument_list|(
name|hba
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|500000
operator|)
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
modifier|*
name|iop_get_inbound_request
parameter_list|(
name|struct
name|hpt_iopmu
modifier|*
name|iop
parameter_list|)
block|{
name|u_int32_t
name|m
init|=
name|readl
argument_list|(
operator|&
name|iop
operator|->
name|inbound_queue
argument_list|)
decl_stmt|;
return|return
operator|(
name|m
operator|==
literal|0xFFFFFFFF
operator|)
condition|?
literal|0
else|:
operator|(
operator|(
name|char
operator|*
operator|)
name|iop
operator|+
name|m
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|iop_post_inbound_request
parameter_list|(
name|struct
name|hpt_iopmu
modifier|*
name|iop
parameter_list|,
name|void
modifier|*
name|req
parameter_list|)
block|{
name|writel
argument_list|(
operator|&
name|iop
operator|->
name|inbound_queue
argument_list|,
operator|(
name|char
operator|*
operator|)
name|req
operator|-
operator|(
name|char
operator|*
operator|)
name|iop
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|iop_post_outbound_request
parameter_list|(
name|struct
name|hpt_iopmu
modifier|*
name|iop
parameter_list|,
name|void
modifier|*
name|req
parameter_list|)
block|{
name|writel
argument_list|(
operator|&
name|iop
operator|->
name|outbound_queue
argument_list|,
operator|(
name|char
operator|*
operator|)
name|req
operator|-
operator|(
name|char
operator|*
operator|)
name|iop
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|hptiop_pci_posting_flush
parameter_list|(
name|struct
name|hpt_iopmu
modifier|*
name|iop
parameter_list|)
block|{
name|readl
argument_list|(
operator|&
name|iop
operator|->
name|outbound_intstatus
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|iop_wait_ready
parameter_list|(
name|struct
name|hpt_iopmu
modifier|*
name|iop
parameter_list|,
name|u_int32_t
name|millisec
parameter_list|)
block|{
name|u_int32_t
name|req
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|millisec
condition|;
name|i
operator|++
control|)
block|{
name|req
operator|=
name|readl
argument_list|(
operator|&
name|iop
operator|->
name|inbound_queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|!=
name|IOPMU_QUEUE_EMPTY
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req
operator|!=
name|IOPMU_QUEUE_EMPTY
condition|)
block|{
name|writel
argument_list|(
operator|&
name|iop
operator|->
name|outbound_queue
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|hptiop_pci_posting_flush
argument_list|(
name|iop
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iop_intr
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
block|{
name|struct
name|hpt_iopmu
modifier|*
name|iop
init|=
name|hba
operator|->
name|iop
decl_stmt|;
name|u_int32_t
name|status
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|status
operator|=
name|readl
argument_list|(
operator|&
name|iop
operator|->
name|outbound_intstatus
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|IOPMU_OUTBOUND_INT_MSG0
condition|)
block|{
name|u_int32_t
name|msg
init|=
name|readl
argument_list|(
operator|&
name|iop
operator|->
name|outbound_msgaddr0
argument_list|)
decl_stmt|;
name|KdPrint
argument_list|(
operator|(
literal|"received outbound msg %x"
operator|,
name|msg
operator|)
argument_list|)
expr_stmt|;
name|writel
argument_list|(
operator|&
name|iop
operator|->
name|outbound_intstatus
argument_list|,
name|IOPMU_OUTBOUND_INT_MSG0
argument_list|)
expr_stmt|;
name|os_message_callback
argument_list|(
name|hba
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|IOPMU_OUTBOUND_INT_POSTQUEUE
condition|)
block|{
name|u_int32_t
name|req
decl_stmt|;
while|while
condition|(
operator|(
name|req
operator|=
name|readl
argument_list|(
operator|&
name|iop
operator|->
name|outbound_queue
argument_list|)
operator|)
operator|!=
name|IOPMU_QUEUE_EMPTY
condition|)
block|{
if|if
condition|(
name|req
operator|&
name|IOPMU_QUEUE_MASK_HOST_BITS
condition|)
name|os_request_callback
argument_list|(
name|hba
argument_list|,
name|req
argument_list|)
expr_stmt|;
else|else
block|{
name|struct
name|hpt_iop_request_header
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|hba
operator|->
name|iop
operator|+
name|req
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|IOP_REQUEST_FLAG_SYNC_REQUEST
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|context
condition|)
name|os_request_callback
argument_list|(
name|hba
argument_list|,
name|req
argument_list|)
expr_stmt|;
else|else
name|p
operator|->
name|context
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|os_request_callback
argument_list|(
name|hba
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iop_send_sync_request
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|void
modifier|*
name|req
parameter_list|,
name|u_int32_t
name|millisec
parameter_list|)
block|{
name|u_int32_t
name|i
decl_stmt|;
operator|(
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
name|req
operator|)
operator|->
name|flags
operator||=
name|IOP_REQUEST_FLAG_SYNC_REQUEST
expr_stmt|;
operator|(
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
name|req
operator|)
operator|->
name|context
operator|=
literal|0
expr_stmt|;
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_queue
argument_list|,
call|(
name|u_int32_t
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|req
operator|-
operator|(
name|char
operator|*
operator|)
name|hba
operator|->
name|iop
argument_list|)
argument_list|)
expr_stmt|;
name|hptiop_pci_posting_flush
argument_list|(
name|hba
operator|->
name|iop
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|millisec
condition|;
name|i
operator|++
control|)
block|{
name|iop_intr
argument_list|(
name|hba
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
name|req
operator|)
operator|->
name|context
condition|)
return|return
literal|0
return|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iop_send_sync_msg
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|u_int32_t
name|msg
parameter_list|,
name|int
modifier|*
name|done
parameter_list|,
name|u_int32_t
name|millisec
parameter_list|)
block|{
name|u_int32_t
name|i
decl_stmt|;
operator|*
name|done
operator|=
literal|0
expr_stmt|;
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_msgaddr0
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|hptiop_pci_posting_flush
argument_list|(
name|hba
operator|->
name|iop
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|millisec
condition|;
name|i
operator|++
control|)
block|{
name|iop_intr
argument_list|(
name|hba
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|done
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
return|return
operator|*
name|done
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iop_get_config
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|struct
name|hpt_iop_request_get_config
modifier|*
name|config
parameter_list|)
block|{
name|u_int32_t
name|req32
init|=
literal|0
decl_stmt|;
name|struct
name|hpt_iop_request_get_config
modifier|*
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|req32
operator|=
name|readl
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_queue
argument_list|)
operator|)
operator|==
name|IOPMU_QUEUE_EMPTY
condition|)
return|return
operator|-
literal|1
return|;
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_get_config
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|hba
operator|->
name|iop
operator|+
name|req32
operator|)
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|type
operator|=
name|IOP_REQUEST_TYPE_GET_CONFIG
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_get_config
argument_list|)
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|result
operator|=
name|IOP_RESULT_PENDING
expr_stmt|;
if|if
condition|(
name|iop_send_sync_request
argument_list|(
name|hba
argument_list|,
name|req
argument_list|,
literal|20000
argument_list|)
condition|)
block|{
name|KdPrint
argument_list|(
operator|(
literal|"Get config send cmd failed"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|config
operator|=
operator|*
name|req
expr_stmt|;
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|outbound_queue
argument_list|,
name|req32
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iop_set_config
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|struct
name|hpt_iop_request_set_config
modifier|*
name|config
parameter_list|)
block|{
name|u_int32_t
name|req32
decl_stmt|;
name|struct
name|hpt_iop_request_set_config
modifier|*
name|req
decl_stmt|;
name|req32
operator|=
name|readl
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|req32
operator|==
name|IOPMU_QUEUE_EMPTY
condition|)
return|return
operator|-
literal|1
return|;
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_set_config
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|hba
operator|->
name|iop
operator|+
name|req32
operator|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|u_int8_t
operator|*
operator|)
name|req
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_header
argument_list|)
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
name|config
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_header
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_set_config
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_header
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|type
operator|=
name|IOP_REQUEST_TYPE_SET_CONFIG
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_set_config
argument_list|)
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|result
operator|=
name|IOP_RESULT_PENDING
expr_stmt|;
if|if
condition|(
name|iop_send_sync_request
argument_list|(
name|hba
argument_list|,
name|req
argument_list|,
literal|20000
argument_list|)
condition|)
block|{
name|KdPrint
argument_list|(
operator|(
literal|"Set config send cmd failed"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|outbound_queue
argument_list|,
name|req32
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_do_ioctl
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|struct
name|hpt_iop_ioctl_param
modifier|*
name|pParams
parameter_list|)
block|{
name|struct
name|hpt_iop_request_ioctl_command
modifier|*
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|pParams
operator|->
name|Magic
operator|!=
name|HPT_IOCTL_MAGIC
operator|)
operator|&&
operator|(
name|pParams
operator|->
name|Magic
operator|!=
name|HPT_IOCTL_MAGIC32
operator|)
condition|)
return|return
name|EFAULT
return|;
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_ioctl_command
operator|*
operator|)
name|iop_get_inbound_request
argument_list|(
name|hba
operator|->
name|iop
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: ioctl command failed"
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
if|if
condition|(
name|pParams
operator|->
name|nInBufferSize
condition|)
if|if
condition|(
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|pParams
operator|->
name|lpInBuffer
argument_list|,
name|req
operator|->
name|buf
argument_list|,
name|pParams
operator|->
name|nInBufferSize
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
if|if
condition|(
name|hptiop_post_ioctl_command
argument_list|(
name|hba
argument_list|,
name|req
argument_list|,
name|pParams
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
if|if
condition|(
name|req
operator|->
name|header
operator|.
name|result
operator|==
name|IOP_RESULT_SUCCESS
condition|)
block|{
if|if
condition|(
name|pParams
operator|->
name|nOutBufferSize
condition|)
if|if
condition|(
name|copyout
argument_list|(
name|req
operator|->
name|buf
operator|+
operator|(
operator|(
name|pParams
operator|->
name|nInBufferSize
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
operator|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pParams
operator|->
name|lpOutBuffer
argument_list|,
name|pParams
operator|->
name|nOutBufferSize
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
if|if
condition|(
name|pParams
operator|->
name|lpBytesReturned
condition|)
if|if
condition|(
name|copyout
argument_list|(
operator|&
name|req
operator|->
name|bytes_returned
argument_list|,
operator|(
name|void
operator|*
operator|)
name|pParams
operator|->
name|lpBytesReturned
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
condition|)
goto|goto
name|invalid
goto|;
name|iop_post_outbound_request
argument_list|(
name|hba
operator|->
name|iop
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|invalid
label|:
name|iop_post_outbound_request
argument_list|(
name|hba
operator|->
name|iop
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_post_ioctl_command
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|struct
name|hpt_iop_request_ioctl_command
modifier|*
name|req
parameter_list|,
name|struct
name|hpt_iop_ioctl_param
modifier|*
name|pParams
parameter_list|)
block|{
if|if
condition|(
operator|(
operator|(
name|pParams
operator|->
name|nInBufferSize
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
operator|)
operator|+
name|pParams
operator|->
name|nOutBufferSize
operator|>
name|hba
operator|->
name|max_request_size
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_header
argument_list|)
operator|-
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: request size beyond max value"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|req
operator|->
name|ioctl_code
operator|=
name|HPT_CTL_CODE_BSD_TO_IOP
argument_list|(
name|pParams
operator|->
name|dwIoControlCode
argument_list|)
expr_stmt|;
name|req
operator|->
name|inbuf_size
operator|=
name|pParams
operator|->
name|nInBufferSize
expr_stmt|;
name|req
operator|->
name|outbuf_size
operator|=
name|pParams
operator|->
name|nOutBufferSize
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_ioctl_command
argument_list|)
operator|-
literal|4
operator|+
name|pParams
operator|->
name|nInBufferSize
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|context
operator|=
operator|(
name|u_int64_t
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|type
operator|=
name|IOP_REQUEST_TYPE_IOCTL_COMMAND
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|result
operator|=
name|IOP_RESULT_PENDING
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|flags
operator||=
name|IOP_REQUEST_FLAG_SYNC_REQUEST
expr_stmt|;
name|hptiop_lock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
name|iop_post_inbound_request
argument_list|(
name|hba
operator|->
name|iop
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|hptiop_pci_posting_flush
argument_list|(
name|hba
operator|->
name|iop
argument_list|)
expr_stmt|;
while|while
condition|(
name|req
operator|->
name|header
operator|.
name|context
condition|)
block|{
if|if
condition|(
name|hptiop_sleep
argument_list|(
name|hba
argument_list|,
name|req
argument_list|,
name|PPAUSE
argument_list|,
literal|"hptctl"
argument_list|,
name|HPT_OSM_TIMEOUT
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|iop_send_sync_msg
argument_list|(
name|hba
argument_list|,
name|IOPMU_INBOUND_MSG0_RESET
argument_list|,
operator|&
name|hba
operator|->
name|msg_done
argument_list|,
literal|60000
argument_list|)
expr_stmt|;
block|}
name|hptiop_unlock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_rescan_bus
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
block|{
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|path
argument_list|,
name|xpt_periph
argument_list|,
name|cam_sim_path
argument_list|(
name|hba
operator|->
name|sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
if|if
condition|(
operator|(
name|ccb
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|union
name|ccb
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|bzero
argument_list|(
name|ccb
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|ccb
argument_list|)
argument_list|)
expr_stmt|;
name|xpt_setup_ccb
argument_list|(
operator|&
name|ccb
operator|->
name|ccb_h
argument_list|,
name|path
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SCAN_BUS
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|cbfcnp
operator|=
name|hptiop_bus_scan_cb
expr_stmt|;
name|ccb
operator|->
name|crcn
operator|.
name|flags
operator|=
name|CAM_FLAG_NONE
expr_stmt|;
name|xpt_action
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_bus_scan_cb
parameter_list|(
name|struct
name|cam_periph
modifier|*
name|periph
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|xpt_free_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ccb
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_decl_stmt
specifier|static
name|bus_dmamap_callback_t
name|hptiop_map_srb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bus_dmamap_callback_t
name|hptiop_post_scsi_command
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * CAM driver interface  */
end_comment

begin_decl_stmt
specifier|static
name|device_method_t
name|driver_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|hptiop_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|hptiop_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|hptiop_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|hptiop_shutdown
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|hptiop_pci_driver
init|=
block|{
name|driver_name
block|,
name|driver_methods
block|,
expr|sizeof
operator|(
expr|struct
name|hpt_iop_hba
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|hptiop
argument_list|,
name|pci
argument_list|,
name|hptiop_pci_driver
argument_list|,
name|hptiop_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|hptiop_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
decl_stmt|;
if|if
condition|(
operator|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x1103
operator|&&
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x3220
operator|)
operator|||
operator|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x1103
operator|&&
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x3320
operator|)
operator|||
operator|(
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x1103
operator|&&
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
literal|0x3520
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: adapter at PCI %d:%d:%d, IRQ %d"
argument_list|,
name|pci_get_bus
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_function
argument_list|(
name|dev
argument_list|)
argument_list|,
name|pci_get_irq
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|driver_name
argument_list|)
expr_stmt|;
name|hba
operator|=
operator|(
expr|struct
name|hpt_iop_hba
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|hba
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_hba
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
operator|(
expr|struct
name|hpt_iop_hba
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|hpt_iop_request_get_config
name|iop_config
decl_stmt|;
name|struct
name|hpt_iop_request_set_config
name|set_config
decl_stmt|;
name|int
name|rid
init|=
literal|0
decl_stmt|;
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
name|struct
name|ccb_setasync
name|ccb
decl_stmt|;
name|u_int32_t
name|unit
init|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%s%d: RocketRAID 3xxx controller driver %s\n"
argument_list|,
name|driver_name
argument_list|,
name|unit
argument_list|,
name|driver_version
argument_list|)
expr_stmt|;
name|KdPrint
argument_list|(
operator|(
literal|"hptiop_attach(%d, %d/%d/%d)"
operator|,
name|unit
operator|,
name|pci_get_bus
argument_list|(
name|dev
argument_list|)
operator|,
name|pci_get_slot
argument_list|(
name|dev
argument_list|)
operator|,
name|pci_get_function
argument_list|(
name|dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|440000
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|hba
operator|->
name|pcidev
operator|=
name|dev
expr_stmt|;
name|hba
operator|->
name|pciunit
operator|=
name|unit
expr_stmt|;
name|hba
operator|->
name|bar0_rid
operator|=
literal|0x10
expr_stmt|;
name|hba
operator|->
name|bar0_res
operator|=
name|bus_alloc_resource
argument_list|(
name|hba
operator|->
name|pcidev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|hba
operator|->
name|bar0_rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|0x100000
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|hba
operator|->
name|bar0_res
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: Failed to get iop base adrress.\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|hba
operator|->
name|iop
operator|=
operator|(
expr|struct
name|hpt_iopmu
operator|*
operator|)
name|rman_get_virtual
argument_list|(
name|hba
operator|->
name|bar0_res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hba
operator|->
name|iop
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: alloc mem res failed\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|iop_wait_ready
argument_list|(
name|hba
operator|->
name|iop
argument_list|,
literal|2000
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: adapter is not ready\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|iop_get_config
argument_list|(
name|hba
argument_list|,
operator|&
name|iop_config
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: Get iop config failed.\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|hba
operator|->
name|firmware_version
operator|=
name|iop_config
operator|.
name|firmware_version
expr_stmt|;
name|hba
operator|->
name|interface_version
operator|=
name|iop_config
operator|.
name|interface_version
expr_stmt|;
name|hba
operator|->
name|max_requests
operator|=
name|iop_config
operator|.
name|max_requests
expr_stmt|;
name|hba
operator|->
name|max_devices
operator|=
name|iop_config
operator|.
name|max_devices
expr_stmt|;
name|hba
operator|->
name|max_request_size
operator|=
name|iop_config
operator|.
name|request_size
expr_stmt|;
name|hba
operator|->
name|max_sg_count
operator|=
name|iop_config
operator|.
name|max_sg_count
expr_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|500000
operator|)
name|mtx_init
argument_list|(
operator|&
name|hba
operator|->
name|lock
argument_list|,
literal|"hptioplock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|NULL
argument_list|,
comment|/* parent */
literal|1
argument_list|,
comment|/* alignment */
literal|0
argument_list|,
comment|/* boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsize */
name|BUS_SPACE_UNRESTRICTED
argument_list|,
comment|/* nsegments */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|502000
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
endif|#
directive|endif
operator|&
name|hba
operator|->
name|parent_dmat
comment|/* tag */
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: alloc parent_dmat failed\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|hba
operator|->
name|parent_dmat
argument_list|,
comment|/* parent */
literal|4
argument_list|,
comment|/* alignment */
name|BUS_SPACE_MAXADDR_32BIT
operator|+
literal|1
argument_list|,
comment|/* boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|PAGE_SIZE
operator|*
operator|(
name|hba
operator|->
name|max_sg_count
operator|-
literal|1
operator|)
argument_list|,
comment|/* maxsize */
name|hba
operator|->
name|max_sg_count
argument_list|,
comment|/* nsegments */
literal|0x20000
argument_list|,
comment|/* maxsegsize */
name|BUS_DMA_ALLOCNOW
argument_list|,
comment|/* flags */
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|502000
name|busdma_lock_mutex
argument_list|,
comment|/* lockfunc */
operator|&
name|hba
operator|->
name|lock
argument_list|,
comment|/* lockfuncarg */
endif|#
directive|endif
operator|&
name|hba
operator|->
name|io_dmat
comment|/* tag */
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: alloc io_dmat failed\n"
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|hba
operator|->
name|parent_dmat
argument_list|,
comment|/* parent */
literal|1
argument_list|,
comment|/* alignment */
literal|0
argument_list|,
comment|/* boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|HPT_SRB_MAX_SIZE
operator|*
name|HPT_SRB_MAX_QUEUE_SIZE
operator|+
literal|0x20
argument_list|,
literal|1
argument_list|,
comment|/* nsegments */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|502000
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
endif|#
directive|endif
operator|&
name|hba
operator|->
name|srb_dmat
comment|/* tag */
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: alloc srb_dmat failed\n"
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|hba
operator|->
name|srb_dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|hba
operator|->
name|uncached_ptr
argument_list|,
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|501000
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_COHERENT
argument_list|,
else|#
directive|else
name|BUS_DMA_WAITOK
argument_list|,
endif|#
directive|endif
operator|&
name|hba
operator|->
name|srb_dmamap
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: bus_dmamem_alloc failed!\n"
argument_list|)
expr_stmt|;
name|release_tag
label|:
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|srb_dmat
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|hba
operator|->
name|srb_dmat
argument_list|,
name|hba
operator|->
name|srb_dmamap
argument_list|,
name|hba
operator|->
name|uncached_ptr
argument_list|,
operator|(
name|HPT_SRB_MAX_SIZE
operator|*
name|HPT_SRB_MAX_QUEUE_SIZE
operator|)
operator|+
literal|0x20
argument_list|,
name|hptiop_map_srb
argument_list|,
name|hba
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: bus_dmamap_load failed!\n"
argument_list|)
expr_stmt|;
goto|goto
name|release_tag
goto|;
block|}
if|if
condition|(
operator|(
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
name|hba
operator|->
name|max_requests
operator|-
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: cam_simq_alloc failed\n"
argument_list|)
expr_stmt|;
name|attach_failed
label|:
name|hptiop_release_resource
argument_list|(
name|hba
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|hba
operator|->
name|sim
operator|=
name|cam_sim_alloc
argument_list|(
name|hptiop_action
argument_list|,
name|hptiop_poll
argument_list|,
name|driver_name
argument_list|,
name|hba
argument_list|,
name|unit
argument_list|,
operator|&
name|Giant
argument_list|,
name|hba
operator|->
name|max_requests
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hba
operator|->
name|sim
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: cam_sim_alloc failed\n"
argument_list|)
expr_stmt|;
name|cam_simq_free
argument_list|(
name|devq
argument_list|)
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
if|if
condition|(
name|xpt_bus_register
argument_list|(
name|hba
operator|->
name|sim
argument_list|,
literal|0
argument_list|)
operator|!=
name|CAM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: xpt_bus_register failed\n"
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|hba
operator|->
name|sim
argument_list|,
comment|/*free devq*/
name|TRUE
argument_list|)
expr_stmt|;
name|hba
operator|->
name|sim
operator|=
name|NULL
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|hba
operator|->
name|path
argument_list|,
comment|/*periph */
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|hba
operator|->
name|sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: xpt_create_path failed\n"
argument_list|)
expr_stmt|;
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|hba
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|hba
operator|->
name|sim
argument_list|,
comment|/*free_devq*/
name|TRUE
argument_list|)
expr_stmt|;
name|hba
operator|->
name|sim
operator|=
name|NULL
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
name|bzero
argument_list|(
operator|&
name|set_config
argument_list|,
sizeof|sizeof
argument_list|(
name|set_config
argument_list|)
argument_list|)
expr_stmt|;
name|set_config
operator|.
name|iop_id
operator|=
name|iop_count
expr_stmt|;
name|set_config
operator|.
name|vbus_id
operator|=
name|cam_sim_path
argument_list|(
name|hba
operator|->
name|sim
argument_list|)
expr_stmt|;
name|set_config
operator|.
name|max_host_request_size
operator|=
name|HPT_SRB_MAX_REQ_SIZE
expr_stmt|;
if|if
condition|(
name|iop_set_config
argument_list|(
name|hba
argument_list|,
operator|&
name|set_config
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: Set iop config failed.\n"
argument_list|)
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
name|xpt_setup_ccb
argument_list|(
operator|&
name|ccb
operator|.
name|ccb_h
argument_list|,
name|hba
operator|->
name|path
argument_list|,
comment|/*priority*/
literal|5
argument_list|)
expr_stmt|;
name|ccb
operator|.
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SASYNC_CB
expr_stmt|;
name|ccb
operator|.
name|event_enable
operator|=
operator|(
name|AC_FOUND_DEVICE
operator||
name|AC_LOST_DEVICE
operator|)
expr_stmt|;
name|ccb
operator|.
name|callback
operator|=
name|hptiop_async
expr_stmt|;
name|ccb
operator|.
name|callback_arg
operator|=
name|hba
operator|->
name|sim
expr_stmt|;
name|xpt_action
argument_list|(
operator|(
expr|union
name|ccb
operator|*
operator|)
operator|&
name|ccb
argument_list|)
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|hba
operator|->
name|irq_res
operator|=
name|bus_alloc_resource
argument_list|(
name|hba
operator|->
name|pcidev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0ul
argument_list|,
literal|1
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: allocate irq failed!\n"
argument_list|)
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
if|if
condition|(
name|bus_setup_intr
argument_list|(
name|hba
operator|->
name|pcidev
argument_list|,
name|hba
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_CAM
argument_list|,
name|NULL
argument_list|,
name|hptiop_pci_intr
argument_list|,
name|hba
argument_list|,
operator|&
name|hba
operator|->
name|irq_handle
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: allocate intr function failed!\n"
argument_list|)
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
name|hptiop_enable_interrupts
argument_list|(
name|hba
argument_list|)
expr_stmt|;
if|if
condition|(
name|iop_send_sync_msg
argument_list|(
name|hba
argument_list|,
name|IOPMU_INBOUND_MSG0_START_BACKGROUND_TASK
argument_list|,
operator|&
name|hba
operator|->
name|msg_done
argument_list|,
literal|5000
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: Fail to start background task\n"
argument_list|)
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
name|hba
operator|->
name|ioctl_dev
operator|=
name|make_dev
argument_list|(
operator|&
name|hptiop_cdevsw
argument_list|,
name|unit
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
comment|/*GID_OPERATOR*/
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
argument_list|,
literal|"%s%d"
argument_list|,
name|driver_name
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|<
literal|503000
name|hba
operator|->
name|ioctl_dev
operator|->
name|si_drv1
operator|=
name|hba
expr_stmt|;
endif|#
directive|endif
name|hptiop_rescan_bus
argument_list|(
name|hba
argument_list|)
expr_stmt|;
name|g_hba
index|[
name|iop_count
operator|++
index|]
operator|=
name|hba
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
operator|(
expr|struct
name|hpt_iop_hba
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|error
init|=
name|EBUSY
decl_stmt|;
name|hptiop_lock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|osm_max_targets
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|os_query_remove_device
argument_list|(
name|hba
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop%d file system is busy. id=%d"
argument_list|,
name|hba
operator|->
name|pciunit
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|hptiop_shutdown
argument_list|(
name|dev
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|iop_send_sync_msg
argument_list|(
name|hba
argument_list|,
name|IOPMU_INBOUND_MSG0_STOP_BACKGROUND_TASK
argument_list|,
operator|&
name|hba
operator|->
name|msg_done
argument_list|,
literal|60000
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|hptiop_release_resource
argument_list|(
name|hba
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|out
label|:
name|hptiop_unlock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
operator|(
expr|struct
name|hpt_iop_hba
operator|*
operator|)
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|hba
operator|->
name|flag
operator|&
name|HPT_IOCTL_FLAG_OPEN
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: %d server is busy"
argument_list|,
name|hba
operator|->
name|pciunit
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
name|hptiop_disable_interrupts
argument_list|(
name|hba
argument_list|)
expr_stmt|;
if|if
condition|(
name|iop_send_sync_msg
argument_list|(
name|hba
argument_list|,
name|IOPMU_INBOUND_MSG0_SHUTDOWN
argument_list|,
operator|&
name|hba
operator|->
name|msg_done
argument_list|,
literal|60000
argument_list|)
condition|)
name|error
operator|=
name|EBUSY
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_pci_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
operator|(
expr|struct
name|hpt_iop_hba
operator|*
operator|)
name|arg
decl_stmt|;
name|hptiop_lock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
name|iop_intr
argument_list|(
name|hba
argument_list|)
expr_stmt|;
name|hptiop_unlock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_poll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
block|{
name|hptiop_pci_intr
argument_list|(
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_async
parameter_list|(
name|void
modifier|*
name|callback_arg
parameter_list|,
name|u_int32_t
name|code
parameter_list|,
name|struct
name|cam_path
modifier|*
name|path
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|hptiop_enable_interrupts
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
block|{
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|outbound_intmask
argument_list|,
operator|~
operator|(
name|IOPMU_OUTBOUND_INT_POSTQUEUE
operator||
name|IOPMU_OUTBOUND_INT_MSG0
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_disable_interrupts
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
block|{
name|u_int32_t
name|int_mask
decl_stmt|;
name|int_mask
operator|=
name|readl
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|outbound_intmask
argument_list|)
expr_stmt|;
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|outbound_intmask
argument_list|,
name|int_mask
operator||
name|IOPMU_OUTBOUND_INT_POSTQUEUE
operator||
name|IOPMU_OUTBOUND_INT_MSG0
argument_list|)
expr_stmt|;
name|hptiop_pci_posting_flush
argument_list|(
name|hba
operator|->
name|iop
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hptiop_reset_adapter
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
block|{
return|return
name|iop_send_sync_msg
argument_list|(
name|hba
argument_list|,
name|IOPMU_INBOUND_MSG0_RESET
argument_list|,
operator|&
name|hba
operator|->
name|msg_done
argument_list|,
literal|60000
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|hptiop_get_srb
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
block|{
name|struct
name|hpt_iop_srb
modifier|*
name|srb
decl_stmt|;
if|if
condition|(
name|hba
operator|->
name|srb_list
condition|)
block|{
name|srb
operator|=
name|hba
operator|->
name|srb_list
expr_stmt|;
name|hba
operator|->
name|srb_list
operator|=
name|srb
operator|->
name|next
expr_stmt|;
block|}
else|else
name|srb
operator|=
name|NULL
expr_stmt|;
return|return
name|srb
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_free_srb
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|struct
name|hpt_iop_srb
modifier|*
name|srb
parameter_list|)
block|{
name|srb
operator|->
name|next
operator|=
name|hba
operator|->
name|srb_list
expr_stmt|;
name|hba
operator|->
name|srb_list
operator|=
name|srb
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_action
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
operator|(
expr|struct
name|hpt_iop_hba
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
decl_stmt|;
name|struct
name|hpt_iop_srb
modifier|*
name|srb
decl_stmt|;
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_SCSI_IO
case|:
name|hptiop_lock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|!=
literal|0
operator|||
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|>=
name|osm_max_targets
operator|||
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_PHYS
operator|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_TID_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
goto|goto
name|scsi_done
goto|;
block|}
if|if
condition|(
operator|(
name|srb
operator|=
name|hptiop_get_srb
argument_list|(
name|hba
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: srb allocated failed"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP_ERR
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
goto|goto
name|scsi_done
goto|;
block|}
name|srb
operator|->
name|ccb
operator|=
name|ccb
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_NONE
condition|)
name|hptiop_post_scsi_command
argument_list|(
name|srb
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SCATTER_VALID
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DATA_PHYS
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|data_ptr
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
argument_list|,
name|hptiop_post_scsi_command
argument_list|,
name|srb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|&&
name|error
operator|!=
name|EINPROGRESS
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: %d bus_dmamap_load error %d"
argument_list|,
name|hba
operator|->
name|pciunit
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|xpt_freeze_simq
argument_list|(
name|hba
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP_ERR
expr_stmt|;
name|invalid
label|:
name|hptiop_free_srb
argument_list|(
name|hba
argument_list|,
name|srb
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
goto|goto
name|scsi_done
goto|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"hptiop: CAM_DATA_PHYS not supported"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP_ERR
expr_stmt|;
goto|goto
name|invalid
goto|;
block|}
block|}
else|else
block|{
name|struct
name|bus_dma_segment
modifier|*
name|segs
decl_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_SG_LIST_PHYS
operator|)
operator|==
literal|0
operator|||
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DATA_PHYS
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: SCSI cmd failed"
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_PROVIDE_FAIL
expr_stmt|;
goto|goto
name|invalid
goto|;
block|}
name|segs
operator|=
operator|(
expr|struct
name|bus_dma_segment
operator|*
operator|)
name|ccb
operator|->
name|csio
operator|.
name|data_ptr
expr_stmt|;
name|hptiop_post_scsi_command
argument_list|(
name|srb
argument_list|,
name|segs
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|sglist_cnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|scsi_done
label|:
name|hptiop_unlock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
return|return;
case|case
name|XPT_RESET_BUS
case|:
name|printf
argument_list|(
literal|"hptiop: reset adapter"
argument_list|)
expr_stmt|;
name|hptiop_lock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
name|hba
operator|->
name|msg_done
operator|=
literal|0
expr_stmt|;
name|hptiop_reset_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
name|hptiop_unlock_adapter
argument_list|(
name|hba
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_GET_TRAN_SETTINGS
case|:
case|case
name|XPT_SET_TRAN_SETTINGS
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_FUNC_NOTAVAIL
expr_stmt|;
break|break;
case|case
name|XPT_CALC_GEOMETRY
case|:
name|ccb
operator|->
name|ccg
operator|.
name|heads
operator|=
literal|255
expr_stmt|;
name|ccb
operator|->
name|ccg
operator|.
name|secs_per_track
operator|=
literal|63
expr_stmt|;
name|ccb
operator|->
name|ccg
operator|.
name|cylinders
operator|=
name|ccb
operator|->
name|ccg
operator|.
name|volume_size
operator|/
operator|(
name|ccb
operator|->
name|ccg
operator|.
name|heads
operator|*
name|ccb
operator|->
name|ccg
operator|.
name|secs_per_track
operator|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
case|case
name|XPT_PATH_INQ
case|:
block|{
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|ccb
operator|->
name|cpi
decl_stmt|;
name|cpi
operator|->
name|version_num
operator|=
literal|1
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_SDTR_ABLE
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
name|PIM_NOBUSRESET
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
name|osm_max_targets
expr_stmt|;
name|cpi
operator|->
name|max_lun
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|cam_sim_unit
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|bus_id
operator|=
name|cam_sim_bus
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|initiator_id
operator|=
name|osm_max_targets
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|3300
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"HPT   "
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|cam_sim_name
argument_list|(
name|sim
argument_list|)
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
block|}
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
block|}
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_post_scsi_command
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|struct
name|hpt_iop_srb
modifier|*
name|srb
init|=
operator|(
expr|struct
name|hpt_iop_srb
operator|*
operator|)
name|arg
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|srb
operator|->
name|ccb
decl_stmt|;
name|u_int8_t
modifier|*
name|cdb
decl_stmt|;
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
name|srb
operator|->
name|hba
decl_stmt|;
name|struct
name|hpt_iop_request_scsi_command
modifier|*
name|req
decl_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|scsi_error
label|:
name|printf
argument_list|(
literal|"hptiop: post scsi command: dma error, err = %d, nsegs = %d"
argument_list|,
name|error
argument_list|,
name|nsegs
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_BUSY
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|hptiop_free_srb
argument_list|(
name|hba
argument_list|,
name|srb
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|nsegs
operator|>
name|hba
operator|->
name|max_sg_count
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: nsegs is too large: nsegs=%d, Allowed count=%d"
argument_list|,
name|nsegs
argument_list|,
name|hba
operator|->
name|max_sg_count
argument_list|)
expr_stmt|;
goto|goto
name|scsi_error
goto|;
block|}
if|if
condition|(
operator|!
name|srb
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: invalid srb"
argument_list|)
expr_stmt|;
goto|goto
name|scsi_error
goto|;
block|}
if|if
condition|(
name|srb
operator|->
name|srb_flag
operator|&
name|HPT_SRB_FLAG_HIGH_MEM_ACESS
condition|)
block|{
name|u_int32_t
name|m
init|=
name|readl
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_queue
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|==
literal|0xFFFFFFFF
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: invaild req offset: %d"
argument_list|,
name|m
argument_list|)
expr_stmt|;
goto|goto
name|scsi_error
goto|;
block|}
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_scsi_command
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|hba
operator|->
name|iop
operator|+
name|m
operator|)
expr_stmt|;
block|}
else|else
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_scsi_command
operator|*
operator|)
name|srb
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|&&
name|nsegs
operator|>
literal|0
condition|)
block|{
name|struct
name|hpt_iopsg
modifier|*
name|psg
init|=
name|req
operator|->
name|sg_list
decl_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|nsegs
condition|;
name|idx
operator|++
operator|,
name|psg
operator|++
control|)
block|{
name|psg
operator|->
name|pci_address
operator|=
operator|(
name|u_int64_t
operator|)
name|segs
index|[
name|idx
index|]
operator|.
name|ds_addr
expr_stmt|;
name|psg
operator|->
name|size
operator|=
name|segs
index|[
name|idx
index|]
operator|.
name|ds_len
expr_stmt|;
name|psg
operator|->
name|eot
operator|=
literal|0
expr_stmt|;
block|}
name|psg
index|[
operator|-
literal|1
index|]
operator|.
name|eot
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
condition|)
name|cdb
operator|=
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_ptr
expr_stmt|;
else|else
name|cdb
operator|=
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_bytes
expr_stmt|;
name|bcopy
argument_list|(
name|cdb
argument_list|,
name|req
operator|->
name|cdb
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
argument_list|)
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|type
operator|=
name|IOP_REQUEST_TYPE_SCSI_COMMAND
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|result
operator|=
name|IOP_RESULT_PENDING
expr_stmt|;
name|req
operator|->
name|dataxfer_length
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
expr_stmt|;
name|req
operator|->
name|channel
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|target
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
expr_stmt|;
name|req
operator|->
name|lun
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_request_scsi_command
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iopsg
argument_list|)
operator|+
name|nsegs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iopsg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
name|bus_dmamap_sync
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|srb
operator|->
name|srb_flag
operator|&
name|HPT_SRB_FLAG_HIGH_MEM_ACESS
condition|)
block|{
name|req
operator|->
name|header
operator|.
name|context
operator|=
operator|(
name|u_int64_t
operator|)
operator|(
name|unsigned
name|long
operator|)
name|srb
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_queue
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|req
operator|-
operator|(
name|char
operator|*
operator|)
name|hba
operator|->
name|iop
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|req
operator|->
name|header
operator|.
name|context
operator|=
operator|(
name|u_int64_t
operator|)
name|srb
operator|->
name|index
operator||
name|IOPMU_QUEUE_ADDR_HOST_BIT
expr_stmt|;
name|req
operator|->
name|header
operator|.
name|flags
operator|=
name|IOP_REQUEST_FLAG_OUTPUT_CONTEXT
expr_stmt|;
if|if
condition|(
name|hba
operator|->
name|firmware_version
operator|>
literal|0x01020000
operator|||
name|hba
operator|->
name|interface_version
operator|>
literal|0x01020000
condition|)
block|{
name|u_int32_t
name|size_bits
decl_stmt|;
if|if
condition|(
name|req
operator|->
name|header
operator|.
name|size
operator|<
literal|256
condition|)
name|size_bits
operator|=
name|IOPMU_QUEUE_REQUEST_SIZE_BIT
expr_stmt|;
elseif|else
if|if
condition|(
name|req
operator|->
name|header
operator|.
name|size
operator|<
literal|512
condition|)
name|size_bits
operator|=
name|IOPMU_QUEUE_ADDR_HOST_BIT
expr_stmt|;
else|else
name|size_bits
operator|=
name|IOPMU_QUEUE_REQUEST_SIZE_BIT
operator||
name|IOPMU_QUEUE_ADDR_HOST_BIT
expr_stmt|;
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_queue
argument_list|,
name|srb
operator|->
name|phy_addr
operator||
name|size_bits
argument_list|)
expr_stmt|;
block|}
else|else
name|writel
argument_list|(
operator|&
name|hba
operator|->
name|iop
operator|->
name|inbound_queue
argument_list|,
name|srb
operator|->
name|phy_addr
operator||
name|IOPMU_QUEUE_ADDR_HOST_BIT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|os_request_callback
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|u_int32_t
name|index
parameter_list|)
block|{
name|struct
name|hpt_iop_srb
modifier|*
name|srb
decl_stmt|;
name|struct
name|hpt_iop_request_scsi_command
modifier|*
name|req
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|u_int8_t
modifier|*
name|cdb
decl_stmt|;
if|if
condition|(
name|index
operator|&
name|IOPMU_QUEUE_MASK_HOST_BITS
condition|)
block|{
if|if
condition|(
name|hba
operator|->
name|firmware_version
operator|>
literal|0x01020000
operator|||
name|hba
operator|->
name|interface_version
operator|>
literal|0x01020000
condition|)
block|{
name|srb
operator|=
name|hba
operator|->
name|srb
index|[
name|index
operator|&
operator|~
call|(
name|u_int32_t
call|)
argument_list|(
name|IOPMU_QUEUE_ADDR_HOST_BIT
operator||
name|IOPMU_QUEUE_REQUEST_RESULT_BIT
argument_list|)
index|]
expr_stmt|;
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_scsi_command
operator|*
operator|)
name|srb
expr_stmt|;
if|if
condition|(
name|index
operator|&
name|IOPMU_QUEUE_REQUEST_RESULT_BIT
condition|)
name|req
operator|->
name|header
operator|.
name|result
operator|=
name|IOP_RESULT_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|srb
operator|=
name|hba
operator|->
name|srb
index|[
name|index
operator|&
operator|~
operator|(
name|u_int32_t
operator|)
name|IOPMU_QUEUE_ADDR_HOST_BIT
index|]
expr_stmt|;
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_scsi_command
operator|*
operator|)
name|srb
expr_stmt|;
block|}
goto|goto
name|srb_complete
goto|;
block|}
name|req
operator|=
operator|(
expr|struct
name|hpt_iop_request_scsi_command
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|hba
operator|->
name|iop
operator|+
name|index
operator|)
expr_stmt|;
switch|switch
condition|(
operator|(
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
name|req
operator|)
operator|->
name|type
condition|)
block|{
case|case
name|IOP_REQUEST_TYPE_IOCTL_COMMAND
case|:
block|{
name|struct
name|hpt_iop_request_ioctl_command
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
expr|struct
name|hpt_iop_request_ioctl_command
operator|*
operator|)
call|(
name|unsigned
name|long
call|)
argument_list|(
operator|(
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
name|req
operator|)
operator|->
name|context
argument_list|)
expr_stmt|;
operator|(
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
name|req
operator|)
operator|->
name|context
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
name|req
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|IOP_REQUEST_TYPE_SCSI_COMMAND
case|:
name|srb
operator|=
operator|(
expr|struct
name|hpt_iop_srb
operator|*
operator|)
operator|(
name|unsigned
name|long
operator|)
name|req
operator|->
name|header
operator|.
name|context
expr_stmt|;
name|srb_complete
label|:
name|ccb
operator|=
operator|(
expr|union
name|ccb
operator|*
operator|)
name|srb
operator|->
name|ccb
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
condition|)
name|cdb
operator|=
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_ptr
expr_stmt|;
else|else
name|cdb
operator|=
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_bytes
expr_stmt|;
if|if
condition|(
name|cdb
index|[
literal|0
index|]
operator|==
name|SYNCHRONIZE_CACHE
condition|)
block|{
comment|/* ??? */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
goto|goto
name|scsi_done
goto|;
block|}
switch|switch
condition|(
operator|(
operator|(
expr|struct
name|hpt_iop_request_header
operator|*
operator|)
name|req
operator|)
operator|->
name|result
condition|)
block|{
case|case
name|IOP_RESULT_SUCCESS
case|:
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
condition|)
block|{
case|case
name|CAM_DIR_IN
case|:
name|bus_dmamap_sync
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAM_DIR_OUT
case|:
name|bus_dmamap_sync
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
name|srb
operator|->
name|dma_map
argument_list|)
expr_stmt|;
break|break;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
case|case
name|IOP_RESULT_BAD_TARGET
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_DEV_NOT_THERE
expr_stmt|;
break|break;
case|case
name|IOP_RESULT_BUSY
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_BUSY
expr_stmt|;
break|break;
case|case
name|IOP_RESULT_INVALID_REQUEST
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
case|case
name|IOP_RESULT_FAIL
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
break|break;
case|case
name|IOP_RESULT_RESET
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_BUSY
expr_stmt|;
break|break;
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
break|break;
block|}
name|scsi_done
label|:
if|if
condition|(
name|srb
operator|->
name|srb_flag
operator|&
name|HPT_SRB_FLAG_HIGH_MEM_ACESS
condition|)
name|iop_post_outbound_request
argument_list|(
name|hba
operator|->
name|iop
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|hptiop_free_srb
argument_list|(
name|hba
argument_list|,
name|srb
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_map_srb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|hpt_iop_hba
modifier|*
name|hba
init|=
operator|(
expr|struct
name|hpt_iop_hba
operator|*
operator|)
name|arg
decl_stmt|;
name|bus_addr_t
name|phy_addr
init|=
operator|(
name|segs
operator|->
name|ds_addr
operator|+
literal|0x1F
operator|)
operator|&
operator|~
operator|(
name|bus_addr_t
operator|)
literal|0x1F
decl_stmt|;
name|struct
name|hpt_iop_srb
modifier|*
name|srb
decl_stmt|,
modifier|*
name|tmp_srb
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|error
operator|||
name|nsegs
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop_map_srb error"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* map srb */
name|srb
operator|=
operator|(
expr|struct
name|hpt_iop_srb
operator|*
operator|)
operator|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|hba
operator|->
name|uncached_ptr
operator|+
literal|0x1F
operator|)
operator|&
operator|~
operator|(
name|unsigned
name|long
operator|)
literal|0x1F
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|HPT_SRB_MAX_QUEUE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|tmp_srb
operator|=
operator|(
expr|struct
name|hpt_iop_srb
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|srb
operator|+
name|i
operator|*
name|HPT_SRB_MAX_SIZE
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|unsigned
name|long
operator|)
name|tmp_srb
operator|&
literal|0x1F
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bus_dmamap_create
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|,
literal|0
argument_list|,
operator|&
name|tmp_srb
operator|->
name|dma_map
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: dmamap create failed"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
name|tmp_srb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hpt_iop_srb
argument_list|)
argument_list|)
expr_stmt|;
name|tmp_srb
operator|->
name|hba
operator|=
name|hba
expr_stmt|;
name|tmp_srb
operator|->
name|index
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|phy_addr
operator|&
name|IOPMU_MAX_MEM_SUPPORT_MASK_32G
condition|)
name|tmp_srb
operator|->
name|srb_flag
operator|=
name|HPT_SRB_FLAG_HIGH_MEM_ACESS
expr_stmt|;
name|tmp_srb
operator|->
name|phy_addr
operator|=
call|(
name|u_int32_t
call|)
argument_list|(
name|phy_addr
operator|>>
literal|5
argument_list|)
expr_stmt|;
name|hptiop_free_srb
argument_list|(
name|hba
argument_list|,
name|tmp_srb
argument_list|)
expr_stmt|;
name|hba
operator|->
name|srb
index|[
name|i
index|]
operator|=
name|tmp_srb
expr_stmt|;
name|phy_addr
operator|+=
name|HPT_SRB_MAX_SIZE
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"hptiop: invalid alignment"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|os_message_callback
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|u_int32_t
name|msg
parameter_list|)
block|{
name|hba
operator|->
name|msg_done
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|os_query_remove_device
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|,
name|int
name|target_id
parameter_list|)
block|{
name|struct
name|cam_periph
modifier|*
name|periph
init|=
name|NULL
decl_stmt|;
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|int
name|status
decl_stmt|,
name|retval
init|=
literal|0
decl_stmt|;
name|status
operator|=
name|xpt_create_path
argument_list|(
operator|&
name|path
argument_list|,
name|NULL
argument_list|,
name|hba
operator|->
name|sim
operator|->
name|path_id
argument_list|,
name|target_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|CAM_REQ_CMP
condition|)
block|{
if|if
condition|(
operator|(
name|periph
operator|=
name|cam_periph_find
argument_list|(
name|path
argument_list|,
literal|"da"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|periph
operator|->
name|refcount
operator|>=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"hptiop: %d ,target_id=0x%x, refcount=%d"
argument_list|,
name|hba
operator|->
name|pciunit
argument_list|,
name|target_id
argument_list|,
name|periph
operator|->
name|refcount
argument_list|)
expr_stmt|;
name|retval
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
name|xpt_free_path
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
return|return
name|retval
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hptiop_release_resource
parameter_list|(
name|struct
name|hpt_iop_hba
modifier|*
name|hba
parameter_list|)
block|{
name|struct
name|ccb_setasync
name|ccb
decl_stmt|;
if|if
condition|(
name|hba
operator|->
name|path
condition|)
block|{
name|xpt_setup_ccb
argument_list|(
operator|&
name|ccb
operator|.
name|ccb_h
argument_list|,
name|hba
operator|->
name|path
argument_list|,
comment|/*priority*/
literal|5
argument_list|)
expr_stmt|;
name|ccb
operator|.
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SASYNC_CB
expr_stmt|;
name|ccb
operator|.
name|event_enable
operator|=
literal|0
expr_stmt|;
name|ccb
operator|.
name|callback
operator|=
name|hptiop_async
expr_stmt|;
name|ccb
operator|.
name|callback_arg
operator|=
name|hba
operator|->
name|sim
expr_stmt|;
name|xpt_action
argument_list|(
operator|(
expr|union
name|ccb
operator|*
operator|)
operator|&
name|ccb
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|hba
operator|->
name|path
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hba
operator|->
name|sim
condition|)
block|{
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|hba
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|hba
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hba
operator|->
name|srb_dmat
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|hba
operator|->
name|srb_dmat
argument_list|,
name|hba
operator|->
name|uncached_ptr
argument_list|,
name|hba
operator|->
name|srb_dmamap
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|hba
operator|->
name|srb_dmat
argument_list|,
name|hba
operator|->
name|srb_dmamap
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|srb_dmat
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hba
operator|->
name|io_dmat
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|io_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|hba
operator|->
name|parent_dmat
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|hba
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|hba
operator|->
name|irq_handle
condition|)
name|bus_teardown_intr
argument_list|(
name|hba
operator|->
name|pcidev
argument_list|,
name|hba
operator|->
name|irq_res
argument_list|,
name|hba
operator|->
name|irq_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|hba
operator|->
name|irq_res
condition|)
name|bus_release_resource
argument_list|(
name|hba
operator|->
name|pcidev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|hba
operator|->
name|irq_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|hba
operator|->
name|bar0_res
condition|)
name|bus_release_resource
argument_list|(
name|hba
operator|->
name|pcidev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|hba
operator|->
name|bar0_rid
argument_list|,
name|hba
operator|->
name|bar0_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|hba
operator|->
name|ioctl_dev
condition|)
name|destroy_dev
argument_list|(
name|hba
operator|->
name|ioctl_dev
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


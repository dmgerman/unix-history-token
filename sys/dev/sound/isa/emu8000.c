begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Low level EMU8000 chip driver for FreeBSD. This handles io against  * /dev/midi, the midi {in, out}put event queues and the event/message  * operation to the EMU8000 chip.  *   * (C) 1999 Seigo Tanimura  *   * Redistribution and use in source and binary forms, with or  * without modification, are permitted provided that the following  * conditions are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above  *    copyright notice, this list of conditions and the following  *    disclaimer in the documentation and/or other materials provided  *    with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS  * IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * AUTHOR OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  *   */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/midi/midi.h>
end_include

begin_include
include|#
directive|include
file|<isa/isavar.h>
end_include

begin_decl_stmt
specifier|static
name|devclass_t
name|midi_devclass
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|DDB
end_ifndef

begin_undef
undef|#
directive|undef
name|DDB
end_undef

begin_define
define|#
directive|define
name|DDB
parameter_list|(
name|x
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DDB */
end_comment

begin_comment
comment|/* These are the specs of EMU8000. */
end_comment

begin_define
define|#
directive|define
name|EMU8K_MAXVOICE
value|32
end_define

begin_define
define|#
directive|define
name|EMU8K_MAXINFO
value|256
end_define

begin_define
define|#
directive|define
name|EMU8K_IDX_DATA0
value|0
end_define

begin_define
define|#
directive|define
name|EMU8K_IDX_DATA1
value|1
end_define

begin_define
define|#
directive|define
name|EMU8K_IDX_DATA2
value|1
end_define

begin_define
define|#
directive|define
name|EMU8K_IDX_DATA3
value|2
end_define

begin_define
define|#
directive|define
name|EMU8K_IDX_PTR
value|2
end_define

begin_define
define|#
directive|define
name|EMU8K_PORT_DATA0
value|0
end_define

begin_define
define|#
directive|define
name|EMU8K_PORT_DATA1
value|0
end_define

begin_define
define|#
directive|define
name|EMU8K_PORT_DATA2
value|2
end_define

begin_define
define|#
directive|define
name|EMU8K_PORT_DATA3
value|0
end_define

begin_define
define|#
directive|define
name|EMU8K_PORT_PTR
value|2
end_define

begin_define
define|#
directive|define
name|EMU8K_DRAM_RAM
value|0x200000
end_define

begin_define
define|#
directive|define
name|EMU8K_DRAM_MAX
value|0xffffe0
end_define

begin_comment
comment|/* And some convinient macros. */
end_comment

begin_define
define|#
directive|define
name|EMU8K_DMA_LEFT
value|0x00
end_define

begin_define
define|#
directive|define
name|EMU8K_DMA_RIGHT
value|0x01
end_define

begin_define
define|#
directive|define
name|EMU8K_DMA_LR
value|0x01
end_define

begin_define
define|#
directive|define
name|EMU8K_DMA_READ
value|0x00
end_define

begin_define
define|#
directive|define
name|EMU8K_DMA_WRITE
value|0x02
end_define

begin_define
define|#
directive|define
name|EMU8K_DMA_RW
value|0x02
end_define

begin_define
define|#
directive|define
name|EMU8K_DMA_MASK
value|0x03
end_define

begin_comment
comment|/* The followings are the init array for EMU8000, originally in ADIP. */
end_comment

begin_comment
comment|/* Set 1 */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|init1_1
index|[
literal|32
index|]
init|=
block|{
literal|0x03ff
block|,
literal|0x0030
block|,
literal|0x07ff
block|,
literal|0x0130
block|,
literal|0x0bff
block|,
literal|0x0230
block|,
literal|0x0fff
block|,
literal|0x0330
block|,
literal|0x13ff
block|,
literal|0x0430
block|,
literal|0x17ff
block|,
literal|0x0530
block|,
literal|0x1bff
block|,
literal|0x0630
block|,
literal|0x1fff
block|,
literal|0x0730
block|,
literal|0x23ff
block|,
literal|0x0830
block|,
literal|0x27ff
block|,
literal|0x0930
block|,
literal|0x2bff
block|,
literal|0x0a30
block|,
literal|0x2fff
block|,
literal|0x0b30
block|,
literal|0x33ff
block|,
literal|0x0c30
block|,
literal|0x37ff
block|,
literal|0x0d30
block|,
literal|0x3bff
block|,
literal|0x0e30
block|,
literal|0x3fff
block|,
literal|0x0f30
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init1_2
index|[
literal|32
index|]
init|=
block|{
literal|0x43ff
block|,
literal|0x0030
block|,
literal|0x47ff
block|,
literal|0x0130
block|,
literal|0x4bff
block|,
literal|0x0230
block|,
literal|0x4fff
block|,
literal|0x0330
block|,
literal|0x53ff
block|,
literal|0x0430
block|,
literal|0x57ff
block|,
literal|0x0530
block|,
literal|0x5bff
block|,
literal|0x0630
block|,
literal|0x5fff
block|,
literal|0x0730
block|,
literal|0x63ff
block|,
literal|0x0830
block|,
literal|0x67ff
block|,
literal|0x0930
block|,
literal|0x6bff
block|,
literal|0x0a30
block|,
literal|0x6fff
block|,
literal|0x0b30
block|,
literal|0x73ff
block|,
literal|0x0c30
block|,
literal|0x77ff
block|,
literal|0x0d30
block|,
literal|0x7bff
block|,
literal|0x0e30
block|,
literal|0x7fff
block|,
literal|0x0f30
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init1_3
index|[
literal|32
index|]
init|=
block|{
literal|0x83ff
block|,
literal|0x0030
block|,
literal|0x87ff
block|,
literal|0x0130
block|,
literal|0x8bff
block|,
literal|0x0230
block|,
literal|0x8fff
block|,
literal|0x0330
block|,
literal|0x93ff
block|,
literal|0x0430
block|,
literal|0x97ff
block|,
literal|0x0530
block|,
literal|0x9bff
block|,
literal|0x0630
block|,
literal|0x9fff
block|,
literal|0x0730
block|,
literal|0xa3ff
block|,
literal|0x0830
block|,
literal|0xa7ff
block|,
literal|0x0930
block|,
literal|0xabff
block|,
literal|0x0a30
block|,
literal|0xafff
block|,
literal|0x0b30
block|,
literal|0xb3ff
block|,
literal|0x0c30
block|,
literal|0xb7ff
block|,
literal|0x0d30
block|,
literal|0xbbff
block|,
literal|0x0e30
block|,
literal|0xbfff
block|,
literal|0x0f30
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init1_4
index|[
literal|32
index|]
init|=
block|{
literal|0xc3ff
block|,
literal|0x0030
block|,
literal|0xc7ff
block|,
literal|0x0130
block|,
literal|0xcbff
block|,
literal|0x0230
block|,
literal|0xcfff
block|,
literal|0x0330
block|,
literal|0xd3ff
block|,
literal|0x0430
block|,
literal|0xd7ff
block|,
literal|0x0530
block|,
literal|0xdbff
block|,
literal|0x0630
block|,
literal|0xdfff
block|,
literal|0x0730
block|,
literal|0xe3ff
block|,
literal|0x0830
block|,
literal|0xe7ff
block|,
literal|0x0930
block|,
literal|0xebff
block|,
literal|0x0a30
block|,
literal|0xefff
block|,
literal|0x0b30
block|,
literal|0xf3ff
block|,
literal|0x0c30
block|,
literal|0xf7ff
block|,
literal|0x0d30
block|,
literal|0xfbff
block|,
literal|0x0e30
block|,
literal|0xffff
block|,
literal|0x0f30
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Set 2 */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|init2_1
index|[
literal|32
index|]
init|=
block|{
literal|0x03ff
block|,
literal|0x8030
block|,
literal|0x07ff
block|,
literal|0x8130
block|,
literal|0x0bff
block|,
literal|0x8230
block|,
literal|0x0fff
block|,
literal|0x8330
block|,
literal|0x13ff
block|,
literal|0x8430
block|,
literal|0x17ff
block|,
literal|0x8530
block|,
literal|0x1bff
block|,
literal|0x8630
block|,
literal|0x1fff
block|,
literal|0x8730
block|,
literal|0x23ff
block|,
literal|0x8830
block|,
literal|0x27ff
block|,
literal|0x8930
block|,
literal|0x2bff
block|,
literal|0x8a30
block|,
literal|0x2fff
block|,
literal|0x8b30
block|,
literal|0x33ff
block|,
literal|0x8c30
block|,
literal|0x37ff
block|,
literal|0x8d30
block|,
literal|0x3bff
block|,
literal|0x8e30
block|,
literal|0x3fff
block|,
literal|0x8f30
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init2_2
index|[
literal|32
index|]
init|=
block|{
literal|0x43ff
block|,
literal|0x8030
block|,
literal|0x47ff
block|,
literal|0x8130
block|,
literal|0x4bff
block|,
literal|0x8230
block|,
literal|0x4fff
block|,
literal|0x8330
block|,
literal|0x53ff
block|,
literal|0x8430
block|,
literal|0x57ff
block|,
literal|0x8530
block|,
literal|0x5bff
block|,
literal|0x8630
block|,
literal|0x5fff
block|,
literal|0x8730
block|,
literal|0x63ff
block|,
literal|0x8830
block|,
literal|0x67ff
block|,
literal|0x8930
block|,
literal|0x6bff
block|,
literal|0x8a30
block|,
literal|0x6fff
block|,
literal|0x8b30
block|,
literal|0x73ff
block|,
literal|0x8c30
block|,
literal|0x77ff
block|,
literal|0x8d30
block|,
literal|0x7bff
block|,
literal|0x8e30
block|,
literal|0x7fff
block|,
literal|0x8f30
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init2_3
index|[
literal|32
index|]
init|=
block|{
literal|0x83ff
block|,
literal|0x8030
block|,
literal|0x87ff
block|,
literal|0x8130
block|,
literal|0x8bff
block|,
literal|0x8230
block|,
literal|0x8fff
block|,
literal|0x8330
block|,
literal|0x93ff
block|,
literal|0x8430
block|,
literal|0x97ff
block|,
literal|0x8530
block|,
literal|0x9bff
block|,
literal|0x8630
block|,
literal|0x9fff
block|,
literal|0x8730
block|,
literal|0xa3ff
block|,
literal|0x8830
block|,
literal|0xa7ff
block|,
literal|0x8930
block|,
literal|0xabff
block|,
literal|0x8a30
block|,
literal|0xafff
block|,
literal|0x8b30
block|,
literal|0xb3ff
block|,
literal|0x8c30
block|,
literal|0xb7ff
block|,
literal|0x8d30
block|,
literal|0xbbff
block|,
literal|0x8e30
block|,
literal|0xbfff
block|,
literal|0x8f30
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init2_4
index|[
literal|32
index|]
init|=
block|{
literal|0xc3ff
block|,
literal|0x8030
block|,
literal|0xc7ff
block|,
literal|0x8130
block|,
literal|0xcbff
block|,
literal|0x8230
block|,
literal|0xcfff
block|,
literal|0x8330
block|,
literal|0xd3ff
block|,
literal|0x8430
block|,
literal|0xd7ff
block|,
literal|0x8530
block|,
literal|0xdbff
block|,
literal|0x8630
block|,
literal|0xdfff
block|,
literal|0x8730
block|,
literal|0xe3ff
block|,
literal|0x8830
block|,
literal|0xe7ff
block|,
literal|0x8930
block|,
literal|0xebff
block|,
literal|0x8a30
block|,
literal|0xefff
block|,
literal|0x8b30
block|,
literal|0xf3ff
block|,
literal|0x8c30
block|,
literal|0xf7ff
block|,
literal|0x8d30
block|,
literal|0xfbff
block|,
literal|0x8e30
block|,
literal|0xffff
block|,
literal|0x8f30
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Set 3 */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|init3_1
index|[
literal|32
index|]
init|=
block|{
literal|0x0C10
block|,
literal|0x8470
block|,
literal|0x14FE
block|,
literal|0xB488
block|,
literal|0x167F
block|,
literal|0xA470
block|,
literal|0x18E7
block|,
literal|0x84B5
block|,
literal|0x1B6E
block|,
literal|0x842A
block|,
literal|0x1F1D
block|,
literal|0x852A
block|,
literal|0x0DA3
block|,
literal|0x8F7C
block|,
literal|0x167E
block|,
literal|0xF254
block|,
literal|0x0000
block|,
literal|0x842A
block|,
literal|0x0001
block|,
literal|0x852A
block|,
literal|0x18E6
block|,
literal|0x8BAA
block|,
literal|0x1B6D
block|,
literal|0xF234
block|,
literal|0x229F
block|,
literal|0x8429
block|,
literal|0x2746
block|,
literal|0x8529
block|,
literal|0x1F1C
block|,
literal|0x86E7
block|,
literal|0x229E
block|,
literal|0xF224
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init3_2
index|[
literal|32
index|]
init|=
block|{
literal|0x0DA4
block|,
literal|0x8429
block|,
literal|0x2C29
block|,
literal|0x8529
block|,
literal|0x2745
block|,
literal|0x87F6
block|,
literal|0x2C28
block|,
literal|0xF254
block|,
literal|0x383B
block|,
literal|0x8428
block|,
literal|0x320F
block|,
literal|0x8528
block|,
literal|0x320E
block|,
literal|0x8F02
block|,
literal|0x1341
block|,
literal|0xF264
block|,
literal|0x3EB6
block|,
literal|0x8428
block|,
literal|0x3EB9
block|,
literal|0x8528
block|,
literal|0x383A
block|,
literal|0x8FA9
block|,
literal|0x3EB5
block|,
literal|0xF294
block|,
literal|0x3EB7
block|,
literal|0x8474
block|,
literal|0x3EBA
block|,
literal|0x8575
block|,
literal|0x3EB8
block|,
literal|0xC4C3
block|,
literal|0x3EBB
block|,
literal|0xC5C3
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init3_3
index|[
literal|32
index|]
init|=
block|{
literal|0x0000
block|,
literal|0xA404
block|,
literal|0x0001
block|,
literal|0xA504
block|,
literal|0x141F
block|,
literal|0x8671
block|,
literal|0x14FD
block|,
literal|0x8287
block|,
literal|0x3EBC
block|,
literal|0xE610
block|,
literal|0x3EC8
block|,
literal|0x8C7B
block|,
literal|0x031A
block|,
literal|0x87E6
block|,
literal|0x3EC8
block|,
literal|0x86F7
block|,
literal|0x3EC0
block|,
literal|0x821E
block|,
literal|0x3EBE
block|,
literal|0xD208
block|,
literal|0x3EBD
block|,
literal|0x821F
block|,
literal|0x3ECA
block|,
literal|0x8386
block|,
literal|0x3EC1
block|,
literal|0x8C03
block|,
literal|0x3EC9
block|,
literal|0x831E
block|,
literal|0x3ECA
block|,
literal|0x8C4C
block|,
literal|0x3EBF
block|,
literal|0x8C55
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init3_4
index|[
literal|32
index|]
init|=
block|{
literal|0x3EC9
block|,
literal|0xC208
block|,
literal|0x3EC4
block|,
literal|0xBC84
block|,
literal|0x3EC8
block|,
literal|0x8EAD
block|,
literal|0x3EC8
block|,
literal|0xD308
block|,
literal|0x3EC2
block|,
literal|0x8F7E
block|,
literal|0x3ECB
block|,
literal|0x8219
block|,
literal|0x3ECB
block|,
literal|0xD26E
block|,
literal|0x3EC5
block|,
literal|0x831F
block|,
literal|0x3EC6
block|,
literal|0xC308
block|,
literal|0x3EC3
block|,
literal|0xB2FF
block|,
literal|0x3EC9
block|,
literal|0x8265
block|,
literal|0x3EC9
block|,
literal|0x8319
block|,
literal|0x1342
block|,
literal|0xD36E
block|,
literal|0x3EC7
block|,
literal|0xB3FF
block|,
literal|0x0000
block|,
literal|0x8365
block|,
literal|0x1420
block|,
literal|0x9570
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Set 4 */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|init4_1
index|[
literal|32
index|]
init|=
block|{
literal|0x0C10
block|,
literal|0x8470
block|,
literal|0x14FE
block|,
literal|0xB488
block|,
literal|0x167F
block|,
literal|0xA470
block|,
literal|0x18E7
block|,
literal|0x84B5
block|,
literal|0x1B6E
block|,
literal|0x842A
block|,
literal|0x1F1D
block|,
literal|0x852A
block|,
literal|0x0DA3
block|,
literal|0x0F7C
block|,
literal|0x167E
block|,
literal|0x7254
block|,
literal|0x0000
block|,
literal|0x842A
block|,
literal|0x0001
block|,
literal|0x852A
block|,
literal|0x18E6
block|,
literal|0x0BAA
block|,
literal|0x1B6D
block|,
literal|0x7234
block|,
literal|0x229F
block|,
literal|0x8429
block|,
literal|0x2746
block|,
literal|0x8529
block|,
literal|0x1F1C
block|,
literal|0x06E7
block|,
literal|0x229E
block|,
literal|0x7224
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init4_2
index|[
literal|32
index|]
init|=
block|{
literal|0x0DA4
block|,
literal|0x8429
block|,
literal|0x2C29
block|,
literal|0x8529
block|,
literal|0x2745
block|,
literal|0x07F6
block|,
literal|0x2C28
block|,
literal|0x7254
block|,
literal|0x383B
block|,
literal|0x8428
block|,
literal|0x320F
block|,
literal|0x8528
block|,
literal|0x320E
block|,
literal|0x0F02
block|,
literal|0x1341
block|,
literal|0x7264
block|,
literal|0x3EB6
block|,
literal|0x8428
block|,
literal|0x3EB9
block|,
literal|0x8528
block|,
literal|0x383A
block|,
literal|0x0FA9
block|,
literal|0x3EB5
block|,
literal|0x7294
block|,
literal|0x3EB7
block|,
literal|0x8474
block|,
literal|0x3EBA
block|,
literal|0x8575
block|,
literal|0x3EB8
block|,
literal|0x44C3
block|,
literal|0x3EBB
block|,
literal|0x45C3
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init4_3
index|[
literal|32
index|]
init|=
block|{
literal|0x0000
block|,
literal|0xA404
block|,
literal|0x0001
block|,
literal|0xA504
block|,
literal|0x141F
block|,
literal|0x0671
block|,
literal|0x14FD
block|,
literal|0x0287
block|,
literal|0x3EBC
block|,
literal|0xE610
block|,
literal|0x3EC8
block|,
literal|0x0C7B
block|,
literal|0x031A
block|,
literal|0x07E6
block|,
literal|0x3EC8
block|,
literal|0x86F7
block|,
literal|0x3EC0
block|,
literal|0x821E
block|,
literal|0x3EBE
block|,
literal|0xD208
block|,
literal|0x3EBD
block|,
literal|0x021F
block|,
literal|0x3ECA
block|,
literal|0x0386
block|,
literal|0x3EC1
block|,
literal|0x0C03
block|,
literal|0x3EC9
block|,
literal|0x031E
block|,
literal|0x3ECA
block|,
literal|0x8C4C
block|,
literal|0x3EBF
block|,
literal|0x0C55
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_short
name|init4_4
index|[
literal|32
index|]
init|=
block|{
literal|0x3EC9
block|,
literal|0xC208
block|,
literal|0x3EC4
block|,
literal|0xBC84
block|,
literal|0x3EC8
block|,
literal|0x0EAD
block|,
literal|0x3EC8
block|,
literal|0xD308
block|,
literal|0x3EC2
block|,
literal|0x8F7E
block|,
literal|0x3ECB
block|,
literal|0x0219
block|,
literal|0x3ECB
block|,
literal|0xD26E
block|,
literal|0x3EC5
block|,
literal|0x031F
block|,
literal|0x3EC6
block|,
literal|0xC308
block|,
literal|0x3EC3
block|,
literal|0x32FF
block|,
literal|0x3EC9
block|,
literal|0x0265
block|,
literal|0x3EC9
block|,
literal|0x8319
block|,
literal|0x1342
block|,
literal|0xD36E
block|,
literal|0x3EC7
block|,
literal|0x33FF
block|,
literal|0x0000
block|,
literal|0x8365
block|,
literal|0x1420
block|,
literal|0x9570
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The followings are the register, the channel and the port for the EMU8000 registers. */
end_comment

begin_struct
struct|struct
name|_emu_register
block|{
name|int
name|reg
decl_stmt|;
comment|/* Register */
name|int
name|index
decl_stmt|;
comment|/* Index */
name|int
name|port
decl_stmt|;
comment|/* Port */
name|int
name|chn
decl_stmt|;
comment|/* Channel */
name|int
name|size
decl_stmt|;
comment|/* Size, 0 == word, 1 == double word */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|EMU8K_CHN_ANY
value|(-1)
end_define

begin_decl_stmt
specifier|static
name|struct
name|_emu_register
name|emu_regs
index|[]
init|=
block|{
comment|/* Reg,           Index,             Port,       Channel, Size */
block|{
literal|0
block|,
name|EMU8K_IDX_DATA0
block|,
name|EMU8K_PORT_DATA0
block|,
name|EMU8K_CHN_ANY
block|,
literal|1
block|}
block|,
comment|/* CPF */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA0
block|,
name|EMU8K_PORT_DATA0
block|,
name|EMU8K_CHN_ANY
block|,
literal|1
block|}
block|,
comment|/* PTRX */
block|{
literal|2
block|,
name|EMU8K_IDX_DATA0
block|,
name|EMU8K_PORT_DATA0
block|,
name|EMU8K_CHN_ANY
block|,
literal|1
block|}
block|,
comment|/* CVCF */
block|{
literal|3
block|,
name|EMU8K_IDX_DATA0
block|,
name|EMU8K_PORT_DATA0
block|,
name|EMU8K_CHN_ANY
block|,
literal|1
block|}
block|,
comment|/* VTFT */
block|{
literal|6
block|,
name|EMU8K_IDX_DATA0
block|,
name|EMU8K_PORT_DATA0
block|,
name|EMU8K_CHN_ANY
block|,
literal|1
block|}
block|,
comment|/* PSST */
block|{
literal|7
block|,
name|EMU8K_IDX_DATA0
block|,
name|EMU8K_PORT_DATA0
block|,
name|EMU8K_CHN_ANY
block|,
literal|1
block|}
block|,
comment|/* CSL */
block|{
literal|0
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
name|EMU8K_CHN_ANY
block|,
literal|1
block|}
block|,
comment|/* CCCA */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|9
block|,
literal|1
block|}
block|,
comment|/* HWCF4 */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|10
block|,
literal|1
block|}
block|,
comment|/* HWCF5 */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|13
block|,
literal|1
block|}
block|,
comment|/* HWCF6 */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|20
block|,
literal|1
block|}
block|,
comment|/* SMALR */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|21
block|,
literal|1
block|}
block|,
comment|/* SMARR */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|22
block|,
literal|1
block|}
block|,
comment|/* SMALW */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|23
block|,
literal|1
block|}
block|,
comment|/* SMARW */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|26
block|,
literal|0
block|}
block|,
comment|/* SMLD */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
literal|26
block|,
literal|0
block|}
block|,
comment|/* SMRD */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
literal|27
block|,
literal|0
block|}
block|,
comment|/* WC */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|29
block|,
literal|0
block|}
block|,
comment|/* HWCF1 */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|30
block|,
literal|0
block|}
block|,
comment|/* HWCF2 */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
literal|31
block|,
literal|0
block|}
block|,
comment|/* HWCF3 */
block|{
literal|2
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* INIT1 */
block|{
literal|2
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* INIT2 */
block|{
literal|3
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* INIT3 */
block|{
literal|3
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* INIT4 */
block|{
literal|4
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* ENVVOL */
block|{
literal|5
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* DCYSUSV */
block|{
literal|6
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* ENVVAL */
block|{
literal|7
block|,
name|EMU8K_IDX_DATA1
block|,
name|EMU8K_PORT_DATA1
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* DCYSUS */
block|{
literal|4
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* ATKHLDV */
block|{
literal|5
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* LFO1VAL */
block|{
literal|6
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* ATKHLD */
block|{
literal|7
block|,
name|EMU8K_IDX_DATA2
block|,
name|EMU8K_PORT_DATA2
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* LFO2VAL */
block|{
literal|0
block|,
name|EMU8K_IDX_DATA3
block|,
name|EMU8K_PORT_DATA3
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* IP */
block|{
literal|1
block|,
name|EMU8K_IDX_DATA3
block|,
name|EMU8K_PORT_DATA3
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* IFATN */
block|{
literal|2
block|,
name|EMU8K_IDX_DATA3
block|,
name|EMU8K_PORT_DATA3
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* PEFE */
block|{
literal|3
block|,
name|EMU8K_IDX_DATA3
block|,
name|EMU8K_PORT_DATA3
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* FMMOD */
block|{
literal|4
block|,
name|EMU8K_IDX_DATA3
block|,
name|EMU8K_PORT_DATA3
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* TREMFRQ */
block|{
literal|5
block|,
name|EMU8K_IDX_DATA3
block|,
name|EMU8K_PORT_DATA3
block|,
name|EMU8K_CHN_ANY
block|,
literal|0
block|}
block|,
comment|/* FM2FRQ2 */
block|{
literal|7
block|,
name|EMU8K_IDX_DATA3
block|,
name|EMU8K_PORT_DATA3
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* PROBE */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* These are the EMU8000 register names. */
end_comment

begin_enum
enum|enum
block|{
name|EMU8K_CPF
init|=
literal|0
block|,
name|EMU8K_PTRX
block|,
name|EMU8K_CVCF
block|,
name|EMU8K_VTFT
block|,
name|EMU8K_PSST
block|,
name|EMU8K_CSL
block|,
name|EMU8K_CCCA
block|,
name|EMU8K_HWCF4
block|,
name|EMU8K_HWCF5
block|,
name|EMU8K_HWCF6
block|,
name|EMU8K_SMALR
block|,
name|EMU8K_SMARR
block|,
name|EMU8K_SMALW
block|,
name|EMU8K_SMARW
block|,
name|EMU8K_SMLD
block|,
name|EMU8K_SMRD
block|,
name|EMU8K_WC
block|,
name|EMU8K_HWCF1
block|,
name|EMU8K_HWCF2
block|,
name|EMU8K_HWCF3
block|,
name|EMU8K_INIT1
block|,
name|EMU8K_INIT2
block|,
name|EMU8K_INIT3
block|,
name|EMU8K_INIT4
block|,
name|EMU8K_ENVVOL
block|,
name|EMU8K_DCYSUSV
block|,
name|EMU8K_ENVVAL
block|,
name|EMU8K_DCYSUS
block|,
name|EMU8K_ATKHLDV
block|,
name|EMU8K_LFO1VAL
block|,
name|EMU8K_ATKHLD
block|,
name|EMU8K_LFO2VAL
block|,
name|EMU8K_IP
block|,
name|EMU8K_IFATN
block|,
name|EMU8K_PEFE
block|,
name|EMU8K_FMMOD
block|,
name|EMU8K_TREMFRQ
block|,
name|EMU8K_FM2FRQ2
block|,
name|EMU8K_PROBE
block|,
name|EMU8K_REGLAST
block|,
comment|/* keep this! */
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|EMU8K_REGNUM
value|(EMU8K_REGLAST)
end_define

begin_comment
comment|/* These are the synthesizer and the midi device information. */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|synth_info
name|emu_synthinfo
init|=
block|{
literal|"EMU8000 Wavetable Synth"
block|,
literal|0
block|,
name|SYNTH_TYPE_SAMPLE
block|,
name|SAMPLE_TYPE_AWE32
block|,
literal|0
block|,
name|EMU8K_MAXVOICE
block|,
literal|0
block|,
name|EMU8K_MAXINFO
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|midi_info
name|emu_midiinfo
init|=
block|{
literal|"EMU8000 Wavetable Synth"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|notyet
end_if

begin_comment
comment|/*  * These functions goes into emusynthdev_op_desc.  */
end_comment

begin_decl_stmt
specifier|static
name|mdsy_killnote_t
name|emu_killnote
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_setinstr_t
name|emu_setinstr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_startnote_t
name|emu_startnote
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_reset_t
name|emu_reset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_hwcontrol_t
name|emu_hwcontrol
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_loadpatch_t
name|emu_loadpatch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_panning_t
name|emu_panning
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_aftertouch_t
name|emu_aftertouch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_controller_t
name|emu_controller
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_patchmgr_t
name|emu_patchmgr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_bender_t
name|emu_bender
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_allocvoice_t
name|emu_allocvoice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_setupvoice_t
name|emu_setupvoice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_sendsysex_t
name|emu_sendsysex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_prefixcmd_t
name|emu_prefixcmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_volumemethod_t
name|emu_volumemethod
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This is the synthdev_info for an EMU8000 chip.  */
end_comment

begin_decl_stmt
specifier|static
name|synthdev_info
name|emusynth_op_desc
init|=
block|{
name|emu_killnote
block|,
name|emu_setinstr
block|,
name|emu_startnote
block|,
name|emu_reset
block|,
name|emu_hwcontrol
block|,
name|emu_loadpatch
block|,
name|emu_panning
block|,
name|emu_aftertouch
block|,
name|emu_controller
block|,
name|emu_patchmgr
block|,
name|emu_bender
block|,
name|emu_allocvoice
block|,
name|emu_setupvoice
block|,
name|emu_sendsysex
block|,
name|emu_prefixcmd
block|,
name|emu_volumemethod
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* notyet */
end_comment

begin_comment
comment|/*  * These functions goes into emu_op_desc to get called  * from sound.c.  */
end_comment

begin_function_decl
specifier|static
name|int
name|emu_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|emu_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|emupnp_attach
argument_list|(
name|device_t
name|dev
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_open_t
name|emu_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|emu_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_ioctl_t
name|emu_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|midi_callback_t
name|emu_callback
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* These go to mididev_info. */
end_comment

begin_decl_stmt
specifier|static
name|mdsy_readraw_t
name|emu_readraw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_writeraw_t
name|emu_writeraw
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Here is the parameter structure per a device. */
end_comment

begin_struct
struct|struct
name|emu_softc
block|{
name|device_t
name|dev
decl_stmt|;
comment|/* device information */
name|mididev_info
modifier|*
name|devinfo
decl_stmt|;
comment|/* midi device information */
name|struct
name|mtx
name|mtx
decl_stmt|;
comment|/* Mutex to protect a device */
name|struct
name|resource
modifier|*
name|io
index|[
literal|3
index|]
decl_stmt|;
comment|/* Base of io port */
name|int
name|io_rid
index|[
literal|3
index|]
decl_stmt|;
comment|/* Io resource ID */
name|u_int
name|dramsize
decl_stmt|;
comment|/* DRAM size */
name|struct
name|synth_info
name|synthinfo
decl_stmt|;
comment|/* Synthesizer information */
name|int
name|fflags
decl_stmt|;
comment|/* File flags */
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|emu_softc
modifier|*
name|sc_p
typedef|;
end_typedef

begin_comment
comment|/* These functions are local. */
end_comment

begin_function_decl
specifier|static
name|u_int
name|emu_dramsize
parameter_list|(
name|sc_p
name|scp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_allocdmachn
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_dmaaddress
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_int
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_waitstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readblkstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writeblkstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writestream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_releasedmachn
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_delay
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|short
name|n
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readcpf
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|cp
argument_list|,
name|u_int
operator|*
name|f
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writecpf
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|cp
parameter_list|,
name|u_int
name|f
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readptrx
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|pt
argument_list|,
name|u_int
operator|*
name|rs
argument_list|,
name|u_int
operator|*
name|auxd
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeptrx
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|pt
parameter_list|,
name|u_int
name|rs
parameter_list|,
name|u_int
name|auxd
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readcvcf
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|cv
argument_list|,
name|u_int
operator|*
name|cf
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writecvcf
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|cv
parameter_list|,
name|u_int
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readvtft
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|vt
argument_list|,
name|u_int
operator|*
name|ft
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writevtft
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|vt
parameter_list|,
name|u_int
name|ft
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readpsst
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|pan
argument_list|,
name|u_int
operator|*
name|st
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writepsst
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|pan
parameter_list|,
name|u_int
name|st
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readcsl
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|cs
argument_list|,
name|u_int
operator|*
name|lp
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writecsl
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|cs
parameter_list|,
name|u_int
name|lp
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readccca
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|q
argument_list|,
name|u_int
operator|*
name|dma
argument_list|,
name|u_int
operator|*
name|wr
argument_list|,
name|u_int
operator|*
name|right
argument_list|,
name|u_int
operator|*
name|ca
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeccca
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|q
parameter_list|,
name|u_int
name|dma
parameter_list|,
name|u_int
name|wr
parameter_list|,
name|u_int
name|right
parameter_list|,
name|u_int
name|ca
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readhwcf4
argument_list|(
name|sc_p
name|scp
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writehwcf4
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readhwcf5
argument_list|(
name|sc_p
name|scp
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writehwcf5
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readhwcf6
argument_list|(
name|sc_p
name|scp
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writehwcf6
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readsmalr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|mt
parameter_list|,
name|u_int
modifier|*
name|smalr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writesmalr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|mt
parameter_list|,
name|u_int
name|smalr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readsmarr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|mt
parameter_list|,
name|u_int
modifier|*
name|smarr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writesmarr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|mt
parameter_list|,
name|u_int
name|smarr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readsmalw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|full
parameter_list|,
name|u_int
modifier|*
name|smalw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writesmalw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|full
parameter_list|,
name|u_int
name|smalw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readsmarw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|full
parameter_list|,
name|u_int
modifier|*
name|smarw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writesmarw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|full
parameter_list|,
name|u_int
name|smarw
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readsmld
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
modifier|*
name|smld
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writesmld
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
name|smld
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readsmrd
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
modifier|*
name|smrd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writesmrd
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
name|smrd
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readwc
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|wc
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_writewc
argument_list|(
name|sc_p
name|scp
argument_list|,
name|u_int
name|wc
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_readhwcf1
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writehwcf1
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readhwcf2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_writehwcf2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readhwcf3
argument_list|(
name|sc_p
name|scp
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writehwcf3
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readinit1
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeinit1
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readinit2
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeinit2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readinit3
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeinit3
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readinit4
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeinit4
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readenvvol
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|envvol
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeenvvol
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|envvol
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readdcysusv
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|ph1v
argument_list|,
name|u_int
operator|*
name|susv
argument_list|,
name|u_int
operator|*
name|off
argument_list|,
name|u_int
operator|*
name|dcyv
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writedcysusv
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ph1v
parameter_list|,
name|u_int
name|susv
parameter_list|,
name|u_int
name|off
parameter_list|,
name|u_int
name|dcyv
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readenvval
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|envval
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeenvval
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|envval
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readdcysus
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|ph1
argument_list|,
name|u_int
operator|*
name|sus
argument_list|,
name|u_int
operator|*
name|dcy
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writedcysus
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ph1
parameter_list|,
name|u_int
name|sus
parameter_list|,
name|u_int
name|dcy
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readatkhldv
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|atkhldv
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeatkhldv
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|atkhldv
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readlfo1val
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|lfo1val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writelfo1val
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|lfo1val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readatkhld
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|atkhld
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeatkhld
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|atkhld
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readlfo2val
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|lfo2val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writelfo2val
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|lfo2val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readip
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|ip
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeip
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ip
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readifatn
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|ifc
argument_list|,
name|u_int
operator|*
name|atn
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writeifatn
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ifc
parameter_list|,
name|u_int
name|atn
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readpefe
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|pe
argument_list|,
name|u_int
operator|*
name|fe
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writepefe
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|pe
parameter_list|,
name|u_int
name|fe
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readfmmod
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|fm
argument_list|,
name|u_int
operator|*
name|mod
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writefmmod
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|fm
parameter_list|,
name|u_int
name|mod
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readtremfrq
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|trem
argument_list|,
name|u_int
operator|*
name|frq
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writetremfrq
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|trem
parameter_list|,
name|u_int
name|frq
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_readfm2frq2
argument_list|(
name|sc_p
name|scp
argument_list|,
name|int
name|chn
argument_list|,
name|u_int
operator|*
name|fm2
argument_list|,
name|u_int
operator|*
name|frq2
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_writefm2frq2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|fm2
parameter_list|,
name|u_int
name|frq2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_readprobe
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|emu_writeprobe
argument_list|(
name|sc_p
name|scp
argument_list|,
name|u_int
name|val
argument_list|)
name|__unused
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|emu_command
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_long
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_long
name|emu_status
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|chn
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|emu_allocres
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|emu_releaseres
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* PnP IDs */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|isa_pnp_id
name|emu_ids
index|[]
init|=
block|{
block|{
literal|0x21008c0e
block|,
literal|"CTL0021 WaveTable Synthesizer"
block|}
block|,
comment|/* CTL0021 */
block|{
literal|0x22008c0e
block|,
literal|"CTL0022 WaveTable Synthesizer"
block|}
block|,
comment|/* CTL0022 */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This is the device descriptor for the midi device.  */
end_comment

begin_decl_stmt
name|mididev_info
name|emu_op_desc
init|=
block|{
literal|"EMU8000 Wavetable Synth"
block|,
name|SNDCARD_AWE32
block|,
name|emu_open
block|,
name|emu_close
block|,
name|emu_ioctl
block|,
name|emu_callback
block|,
name|MIDI_BUFFSIZE
block|,
comment|/* Queue Length */
literal|0
block|,
comment|/* XXX This is not an *audio* device! */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Here are the main functions to interact to the user process.  */
end_comment

begin_function
specifier|static
name|int
name|emu_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|sc_p
name|scp
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|u_int
name|probe
decl_stmt|,
name|hwcf1
decl_stmt|,
name|hwcf2
decl_stmt|;
comment|/* Check isapnp ids */
if|if
condition|(
name|isa_get_logicalid
argument_list|(
name|dev
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ISA_PNP_PROBE
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|dev
argument_list|,
name|emu_ids
argument_list|)
operator|)
return|;
comment|/* XXX non-pnp emu? */
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|scp
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"EMU8000 Wavetable Synth"
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|scp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|scp
argument_list|)
argument_list|)
expr_stmt|;
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu%d: probing.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu_allocres
argument_list|(
name|scp
argument_list|,
name|dev
argument_list|)
condition|)
block|{
name|emu_releaseres
argument_list|(
name|scp
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|emu_readprobe
argument_list|(
name|scp
argument_list|,
operator|&
name|probe
argument_list|)
expr_stmt|;
name|emu_readhwcf1
argument_list|(
name|scp
argument_list|,
operator|&
name|hwcf1
argument_list|)
expr_stmt|;
name|emu_readhwcf2
argument_list|(
name|scp
argument_list|,
operator|&
name|hwcf2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|probe
operator|&
literal|0x000f
operator|)
operator|!=
literal|0x000c
operator|||
operator|(
name|hwcf1
operator|&
literal|0x007e
operator|)
operator|!=
literal|0x0058
operator|||
operator|(
name|hwcf2
operator|&
literal|0x0003
operator|)
operator|!=
literal|0x0003
condition|)
block|{
name|emu_releaseres
argument_list|(
name|scp
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu%d: probed.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|synthdev_info
name|midisynth_op_desc
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|emu_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|sc_p
name|scp
decl_stmt|;
name|mididev_info
modifier|*
name|devinfo
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|i
decl_stmt|;
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|scp
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu%d: attaching.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu_allocres
argument_list|(
name|scp
argument_list|,
name|dev
argument_list|)
condition|)
block|{
name|emu_releaseres
argument_list|(
name|scp
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* EMU8000 needs some initialization processes. */
comment|/* 1. Write HWCF{1,2}. */
name|emu_writehwcf1
argument_list|(
name|scp
argument_list|,
literal|0x0059
argument_list|)
expr_stmt|;
name|emu_writehwcf2
argument_list|(
name|scp
argument_list|,
literal|0x0020
argument_list|)
expr_stmt|;
comment|/* Disable the audio. */
name|emu_writehwcf3
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 2. Initialize the channels. */
comment|/* 2a. Write DCYSUSV. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writedcysusv
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 2b. Clear the envelope and sound engine registers. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
block|{
name|emu_writeenvvol
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeenvval
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writedcysus
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeatkhldv
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writelfo1val
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeatkhld
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writelfo2val
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeip
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeifatn
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writepefe
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writefmmod
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writetremfrq
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writefm2frq2
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeptrx
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writevtft
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writepsst
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writecsl
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeccca
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 2c. Clear the current registers. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
block|{
name|emu_writecpf
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writecvcf
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 3. Initialize the sound memory DMA registers. */
name|emu_writesmalr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writesmarr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writesmalw
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writesmarw
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 4. Fill the array. */
comment|/* 4a. Set 1. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit1
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init1_1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit2
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init1_2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit3
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init1_3
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit4
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init1_4
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 4b. Have a rest. */
name|emu_delay
argument_list|(
name|scp
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
comment|/* 1024 samples. */
comment|/* 4c. Set 2. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit1
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init2_1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit2
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init2_2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit3
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init2_3
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit4
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init2_4
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 4d. Set 3. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit1
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init3_1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit2
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init3_2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit3
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init3_3
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit4
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init3_4
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 4e. Write to HWCF{4,5,6}. */
name|emu_writehwcf4
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writehwcf5
argument_list|(
name|scp
argument_list|,
literal|0x00000083
argument_list|)
expr_stmt|;
name|emu_writehwcf6
argument_list|(
name|scp
argument_list|,
literal|0x00008000
argument_list|)
expr_stmt|;
comment|/* 4f. Set 4. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit1
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init4_1
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit2
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init4_2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit3
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init4_3
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EMU8K_MAXVOICE
condition|;
name|i
operator|++
control|)
name|emu_writeinit4
argument_list|(
name|scp
argument_list|,
name|i
argument_list|,
name|init4_4
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* 5. Determine the size of DRAM. */
name|scp
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|scp
operator|->
name|dramsize
operator|=
name|emu_dramsize
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"emu%d: DRAM size = %dKB\n"
argument_list|,
name|unit
argument_list|,
name|scp
operator|->
name|dramsize
operator|/
literal|1024
argument_list|)
expr_stmt|;
comment|/* We have inited the EMU8000. Now work on FM. */
comment|/* Write parameters for the left channel. */
name|emu_writedcysusv
argument_list|(
name|scp
argument_list|,
literal|30
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writepsst
argument_list|(
name|scp
argument_list|,
literal|30
argument_list|,
literal|0x80
argument_list|,
literal|0xffffe0
argument_list|)
expr_stmt|;
comment|/* full left */
name|emu_writecsl
argument_list|(
name|scp
argument_list|,
literal|30
argument_list|,
literal|0
argument_list|,
literal|0xfffff8
argument_list|)
expr_stmt|;
comment|/* chorus */
name|emu_writeptrx
argument_list|(
name|scp
argument_list|,
literal|30
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reverb */
name|emu_writecpf
argument_list|(
name|scp
argument_list|,
literal|30
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeccca
argument_list|(
name|scp
argument_list|,
literal|30
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0xffffe3
argument_list|)
expr_stmt|;
comment|/* Then the right channel. */
name|emu_writedcysusv
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writepsst
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
literal|0x80
argument_list|,
literal|0xfffff0
argument_list|)
expr_stmt|;
comment|/* full right */
name|emu_writecsl
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0xfffff8
argument_list|)
expr_stmt|;
comment|/* chorus */
name|emu_writeptrx
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* reverb */
name|emu_writecpf
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeccca
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0xfffff3
argument_list|)
expr_stmt|;
comment|/* Skew volume and cutoff. */
name|emu_writevtft
argument_list|(
name|scp
argument_list|,
literal|30
argument_list|,
literal|0x8000
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|emu_writevtft
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
literal|0x8000
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
comment|/* Ready to sound. */
name|emu_writehwcf3
argument_list|(
name|scp
argument_list|,
literal|0x0004
argument_list|)
expr_stmt|;
comment|/* Fill the softc for this unit. */
name|bcopy
argument_list|(
operator|&
name|emu_synthinfo
argument_list|,
operator|&
name|scp
operator|->
name|synthinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|emu_synthinfo
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|scp
operator|->
name|mtx
argument_list|,
literal|"emumid"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|scp
operator|->
name|devinfo
operator|=
name|devinfo
operator|=
name|create_mididev_info_unit
argument_list|(
name|MDT_SYNTH
argument_list|,
operator|&
name|emu_op_desc
argument_list|,
operator|&
name|midisynth_op_desc
argument_list|)
expr_stmt|;
comment|/* Fill the midi info. */
name|devinfo
operator|->
name|synth
operator|.
name|readraw
operator|=
name|emu_readraw
expr_stmt|;
name|devinfo
operator|->
name|synth
operator|.
name|writeraw
operator|=
name|emu_writeraw
expr_stmt|;
name|snprintf
argument_list|(
name|devinfo
operator|->
name|midistat
argument_list|,
sizeof|sizeof
argument_list|(
name|devinfo
operator|->
name|midistat
argument_list|)
argument_list|,
literal|"at 0x%x, 0x%x, 0x%x"
argument_list|,
operator|(
name|u_int
operator|)
name|rman_get_start
argument_list|(
name|scp
operator|->
name|io
index|[
literal|0
index|]
argument_list|)
argument_list|,
operator|(
name|u_int
operator|)
name|rman_get_start
argument_list|(
name|scp
operator|->
name|io
index|[
literal|1
index|]
argument_list|)
argument_list|,
operator|(
name|u_int
operator|)
name|rman_get_start
argument_list|(
name|scp
operator|->
name|io
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|midiinit
argument_list|(
name|devinfo
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu%d: attached.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|emupnp_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|emu_attach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|emu_open
parameter_list|(
name|dev_t
name|i_dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|emu_close
parameter_list|(
name|dev_t
name|i_dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|emu_ioctl
parameter_list|(
name|dev_t
name|i_dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|arg
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|sc_p
name|scp
decl_stmt|;
name|mididev_info
modifier|*
name|devinfo
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|struct
name|synth_info
modifier|*
name|synthinfo
decl_stmt|;
name|struct
name|midi_info
modifier|*
name|midiinfo
decl_stmt|;
name|unit
operator|=
name|MIDIUNIT
argument_list|(
name|i_dev
argument_list|)
expr_stmt|;
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu_ioctl: unit %d, cmd %s.\n"
argument_list|,
name|unit
argument_list|,
name|midi_cmdname
argument_list|(
name|cmd
argument_list|,
name|cmdtab_midiioctl
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|devinfo
operator|=
name|get_mididev_info
argument_list|(
name|i_dev
argument_list|,
operator|&
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|devinfo
operator|==
name|NULL
condition|)
block|{
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu_ioctl: unit %d is not configured.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|scp
operator|=
name|devinfo
operator|->
name|softc
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SNDCTL_SYNTH_INFO
case|:
name|synthinfo
operator|=
operator|(
expr|struct
name|synth_info
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|synthinfo
operator|->
name|device
operator|!=
name|unit
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|bcopy
argument_list|(
operator|&
name|scp
operator|->
name|synthinfo
argument_list|,
name|synthinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|scp
operator|->
name|synthinfo
argument_list|)
argument_list|)
expr_stmt|;
name|synthinfo
operator|->
name|device
operator|=
name|unit
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|SNDCTL_MIDI_INFO
case|:
name|midiinfo
operator|=
operator|(
expr|struct
name|midi_info
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|midiinfo
operator|->
name|device
operator|!=
name|unit
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|bcopy
argument_list|(
operator|&
name|emu_midiinfo
argument_list|,
name|midiinfo
argument_list|,
sizeof|sizeof
argument_list|(
name|emu_midiinfo
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|midiinfo
operator|->
name|name
argument_list|,
name|scp
operator|->
name|synthinfo
operator|.
name|name
argument_list|)
expr_stmt|;
name|midiinfo
operator|->
name|device
operator|=
name|unit
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
break|break;
case|case
name|SNDCTL_SYNTH_MEMAVL
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|arg
operator|=
literal|0x7fffffff
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
break|break;
default|default:
return|return
operator|(
name|ENOSYS
operator|)
return|;
block|}
comment|/* NOTREACHED */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|emu_callback
parameter_list|(
name|void
modifier|*
name|d
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|mididev_info
modifier|*
name|devinfo
decl_stmt|;
name|devinfo
operator|=
operator|(
name|mididev_info
operator|*
operator|)
name|d
expr_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|devinfo
operator|->
name|flagqueue_mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|emu_readraw
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|lenr
parameter_list|,
name|int
name|nonblock
parameter_list|)
block|{
name|sc_p
name|scp
decl_stmt|;
name|int
name|unit
decl_stmt|;
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|lenr
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|scp
operator|=
name|md
operator|->
name|softc
expr_stmt|;
if|if
condition|(
operator|(
name|md
operator|->
name|fflags
operator|&
name|FREAD
operator|)
operator|==
literal|0
condition|)
block|{
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu_readraw: unit %d is not for reading.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* NOP. */
operator|*
name|lenr
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|emu_writeraw
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
modifier|*
name|lenw
parameter_list|,
name|int
name|nonblock
parameter_list|)
block|{
name|sc_p
name|scp
decl_stmt|;
name|int
name|unit
decl_stmt|;
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|lenw
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|scp
operator|=
name|md
operator|->
name|softc
expr_stmt|;
if|if
condition|(
operator|(
name|md
operator|->
name|fflags
operator|&
name|FWRITE
operator|)
operator|==
literal|0
condition|)
block|{
name|MIDI_DEBUG
argument_list|(
name|printf
argument_list|(
literal|"emu_writeraw: unit %d is not for writing.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* NOP. */
operator|*
name|lenw
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * The functions below here are the synthesizer interfaces.  */
end_comment

begin_comment
comment|/*  * The functions below here are the libraries for the above ones.  */
end_comment

begin_comment
comment|/* Determine the size of DRAM. */
end_comment

begin_function
specifier|static
name|u_int
name|emu_dramsize
parameter_list|(
name|sc_p
name|scp
parameter_list|)
block|{
name|u_int
name|dramsize
decl_stmt|;
specifier|static
name|u_short
name|magiccode
index|[]
init|=
block|{
literal|0x386d
block|,
literal|0xbd2a
block|,
literal|0x73df
block|,
literal|0xf2d8
block|}
decl_stmt|;
specifier|static
name|u_short
name|magiccode2
index|[]
init|=
block|{
literal|0x5ef3
block|,
literal|0x2b90
block|,
literal|0xa4c8
block|,
literal|0x6a13
block|}
decl_stmt|;
name|u_short
name|buf
index|[
sizeof|sizeof
argument_list|(
name|magiccode
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|magiccode
argument_list|)
index|]
decl_stmt|;
comment|/* 	 * Write the magic code to the bottom of DRAM. 	 * Writing to a wrapped address clobbers the code. 	 */
name|emu_allocdmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|)
expr_stmt|;
name|emu_dmaaddress
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|,
name|EMU8K_DRAM_RAM
argument_list|)
expr_stmt|;
name|emu_writeblkstream
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|,
name|magiccode
argument_list|,
sizeof|sizeof
argument_list|(
name|magiccode
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|magiccode
argument_list|)
argument_list|)
expr_stmt|;
name|emu_releasedmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|)
expr_stmt|;
for|for
control|(
name|dramsize
operator|=
literal|0
init|;
name|dramsize
operator|+
name|EMU8K_DRAM_RAM
operator|<
name|EMU8K_DRAM_MAX
condition|;
control|)
block|{
comment|/* Read the magic code. */
name|emu_allocdmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|)
expr_stmt|;
name|emu_dmaaddress
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|,
name|EMU8K_DRAM_RAM
argument_list|)
expr_stmt|;
name|emu_readblkstream
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|emu_releasedmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|)
expr_stmt|;
comment|/* Compare the code. */
if|if
condition|(
name|bcmp
argument_list|(
name|magiccode
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|magiccode
argument_list|)
argument_list|)
condition|)
break|break;
comment|/* Increase the DRAM size. */
name|dramsize
operator|+=
literal|0x8000
expr_stmt|;
comment|/* Try writing a different magic code to dramsize. */
name|emu_allocdmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|)
expr_stmt|;
name|emu_dmaaddress
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|,
name|dramsize
operator|+
name|EMU8K_DRAM_RAM
argument_list|)
expr_stmt|;
name|emu_writeblkstream
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|,
name|magiccode2
argument_list|,
sizeof|sizeof
argument_list|(
name|magiccode2
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|magiccode2
argument_list|)
argument_list|)
expr_stmt|;
name|emu_releasedmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
argument_list|)
expr_stmt|;
comment|/* Then read the magic code. */
name|emu_allocdmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|)
expr_stmt|;
name|emu_dmaaddress
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|,
name|dramsize
operator|+
name|EMU8K_DRAM_RAM
argument_list|)
expr_stmt|;
name|emu_readblkstream
argument_list|(
name|scp
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|emu_releasedmachn
argument_list|(
name|scp
argument_list|,
literal|31
argument_list|,
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
argument_list|)
expr_stmt|;
comment|/* Compare the code. */
if|if
condition|(
name|bcmp
argument_list|(
name|magiccode2
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|magiccode2
argument_list|)
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|dramsize
operator|+
name|EMU8K_DRAM_RAM
operator|>
name|EMU8K_DRAM_MAX
condition|)
name|dramsize
operator|=
name|EMU8K_DRAM_MAX
operator|-
name|EMU8K_DRAM_RAM
expr_stmt|;
return|return
name|dramsize
operator|*
literal|2
return|;
comment|/* dramsize is in words. */
block|}
end_function

begin_comment
comment|/* Allocates a channel to a DMA stream. */
end_comment

begin_function
specifier|static
name|void
name|emu_allocdmachn
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
comment|/* Turn off the sound, prepare for a DMA stream. */
name|emu_writedcysusv
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writevtft
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writecvcf
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writeptrx
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0x4000
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writecpf
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0x4000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writepsst
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu_writecsl
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Enter DMA mode. */
name|emu_writeccca
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
operator|(
operator|(
name|mode
operator|&
name|EMU8K_DMA_WRITE
operator|)
operator|>
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
operator|(
operator|(
name|mode
operator|&
name|EMU8K_DMA_RIGHT
operator|)
operator|>
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Programs the initial address to a DMA. */
end_comment

begin_function
specifier|static
name|void
name|emu_dmaaddress
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_int
name|addr
parameter_list|)
block|{
comment|/* Wait until the stream comes ready. */
name|emu_waitstream
argument_list|(
name|scp
argument_list|,
name|mode
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
operator|&
name|EMU8K_DMA_MASK
condition|)
block|{
case|case
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
case|:
name|emu_writesmalr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|emu_readsmld
argument_list|(
name|scp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Read the stale data. */
break|break;
case|case
name|EMU8K_DMA_RIGHT
operator||
name|EMU8K_DMA_READ
case|:
name|emu_writesmarr
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|emu_readsmrd
argument_list|(
name|scp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Read the stale data. */
break|break;
case|case
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
case|:
name|emu_writesmalw
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMU8K_DMA_RIGHT
operator||
name|EMU8K_DMA_WRITE
case|:
name|emu_writesmarw
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Waits until a stream gets ready. */
end_comment

begin_function
specifier|static
name|void
name|emu_waitstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int
name|busy
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100000
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|mode
operator|&
name|EMU8K_DMA_MASK
condition|)
block|{
case|case
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
case|:
name|emu_readsmalr
argument_list|(
name|scp
argument_list|,
operator|&
name|busy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMU8K_DMA_RIGHT
operator||
name|EMU8K_DMA_READ
case|:
name|emu_readsmarr
argument_list|(
name|scp
argument_list|,
operator|&
name|busy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
case|:
name|emu_readsmalw
argument_list|(
name|scp
argument_list|,
operator|&
name|busy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMU8K_DMA_RIGHT
operator||
name|EMU8K_DMA_WRITE
case|:
name|emu_readsmarw
argument_list|(
name|scp
argument_list|,
operator|&
name|busy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|busy
condition|)
break|break;
name|emu_delay
argument_list|(
name|scp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|busy
condition|)
name|printf
argument_list|(
literal|"emu%d: stream data still busy, timed out.\n"
argument_list|,
name|device_get_unit
argument_list|(
name|scp
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Reads a word block from a stream. */
end_comment

begin_function
specifier|static
name|void
name|emu_readblkstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
while|while
condition|(
operator|(
name|len
operator|--
operator|)
operator|>
literal|0
condition|)
name|emu_readstream
argument_list|(
name|scp
argument_list|,
name|mode
argument_list|,
name|data
operator|++
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Writes a word block stream to a stream. */
end_comment

begin_function
specifier|static
name|void
name|emu_writeblkstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
while|while
condition|(
operator|(
name|len
operator|--
operator|)
operator|>
literal|0
condition|)
name|emu_writestream
argument_list|(
name|scp
argument_list|,
name|mode
argument_list|,
operator|*
operator|(
name|data
operator|++
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Reads a word from a stream. */
end_comment

begin_function
specifier|static
name|void
name|emu_readstream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
operator|(
name|mode
operator|&
name|EMU8K_DMA_RW
operator|)
operator|!=
name|EMU8K_DMA_READ
condition|)
return|return;
switch|switch
condition|(
name|mode
operator|&
name|EMU8K_DMA_MASK
condition|)
block|{
case|case
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_READ
case|:
name|emu_readsmld
argument_list|(
name|scp
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMU8K_DMA_RIGHT
operator||
name|EMU8K_DMA_READ
case|:
name|emu_readsmrd
argument_list|(
name|scp
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Writes a word to a stream. */
end_comment

begin_function
specifier|static
name|void
name|emu_writestream
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|mode
parameter_list|,
name|u_short
name|data
parameter_list|)
block|{
if|if
condition|(
operator|(
name|mode
operator|&
name|EMU8K_DMA_RW
operator|)
operator|!=
name|EMU8K_DMA_WRITE
condition|)
return|return;
switch|switch
condition|(
name|mode
operator|&
name|EMU8K_DMA_MASK
condition|)
block|{
case|case
name|EMU8K_DMA_LEFT
operator||
name|EMU8K_DMA_WRITE
case|:
name|emu_writesmld
argument_list|(
name|scp
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EMU8K_DMA_RIGHT
operator||
name|EMU8K_DMA_WRITE
case|:
name|emu_writesmrd
argument_list|(
name|scp
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Releases a channel from a DMA stream. */
end_comment

begin_function
specifier|static
name|void
name|emu_releasedmachn
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
comment|/* Wait until the stream comes ready. */
name|emu_waitstream
argument_list|(
name|scp
argument_list|,
name|mode
argument_list|)
expr_stmt|;
comment|/* Leave DMA mode. */
name|emu_writeccca
argument_list|(
name|scp
argument_list|,
name|chn
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Waits cycles.  * Idea-stolen-from: sys/i386/isa/clock.c:DELAY()  */
end_comment

begin_function
specifier|static
name|void
name|emu_delay
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|short
name|n
parameter_list|)
block|{
name|int
name|wc_prev
decl_stmt|,
name|wc
decl_stmt|,
name|wc_left
decl_stmt|,
name|wc_delta
decl_stmt|;
name|emu_readwc
argument_list|(
name|scp
argument_list|,
operator|&
name|wc_prev
argument_list|)
expr_stmt|;
name|wc_left
operator|=
name|n
expr_stmt|;
while|while
condition|(
name|wc_left
operator|>
literal|0
condition|)
block|{
name|emu_readwc
argument_list|(
name|scp
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
name|wc_delta
operator|=
name|wc
operator|-
name|wc_prev
expr_stmt|;
comment|/* The counter increases. */
name|wc_prev
operator|=
name|wc
expr_stmt|;
if|if
condition|(
name|wc_delta
operator|<
literal|0
condition|)
name|wc_delta
operator|+=
literal|0xffff
expr_stmt|;
name|wc_left
operator|-=
name|wc_delta
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* The followings provide abstract access to the registers. */
end_comment

begin_define
define|#
directive|define
name|DECBIT
parameter_list|(
name|sts
parameter_list|,
name|shift
parameter_list|,
name|len
parameter_list|)
value|(((sts)>> (shift)))& (0xffffffff>> (32 - len))
end_define

begin_define
define|#
directive|define
name|GENBIT
parameter_list|(
name|val
parameter_list|,
name|shift
parameter_list|,
name|len
parameter_list|)
value|(((val)& (0xffffffff>> (32 - len)))<< (shift))
end_define

begin_comment
comment|/* CPF: Current Pitch and Fractional Address */
end_comment

begin_function
specifier|static
name|void
name|emu_readcpf
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|cp
parameter_list|,
name|u_int
modifier|*
name|f
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_CPF
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|!=
name|NULL
condition|)
operator|*
name|cp
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|!=
name|NULL
condition|)
operator|*
name|f
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writecpf
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|cp
parameter_list|,
name|u_int
name|f
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_CPF
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|cp
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator||
name|GENBIT
argument_list|(
name|f
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* PTRX: Pitch Target, Rvb Send and Aux Byte */
end_comment

begin_function
specifier|static
name|void
name|emu_readptrx
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|pt
parameter_list|,
name|u_int
modifier|*
name|rs
parameter_list|,
name|u_int
modifier|*
name|auxd
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_PTRX
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|pt
operator|!=
name|NULL
condition|)
operator|*
name|pt
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|!=
name|NULL
condition|)
operator|*
name|rs
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|auxd
operator|!=
name|NULL
condition|)
operator|*
name|auxd
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeptrx
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|pt
parameter_list|,
name|u_int
name|rs
parameter_list|,
name|u_int
name|auxd
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_PTRX
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|pt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator||
name|GENBIT
argument_list|(
name|rs
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|auxd
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* CVCF: Current Volume and Filter Cutoff */
end_comment

begin_function
specifier|static
name|void
name|emu_readcvcf
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|cv
parameter_list|,
name|u_int
modifier|*
name|cf
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_CVCF
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|cv
operator|!=
name|NULL
condition|)
operator|*
name|cv
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|cf
operator|!=
name|NULL
condition|)
operator|*
name|cf
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writecvcf
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|cv
parameter_list|,
name|u_int
name|cf
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_CVCF
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|cv
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator||
name|GENBIT
argument_list|(
name|cf
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* VTFT: Volume and Filter Cutoff Targets */
end_comment

begin_function
specifier|static
name|void
name|emu_readvtft
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|vt
parameter_list|,
name|u_int
modifier|*
name|ft
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_VTFT
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|vt
operator|!=
name|NULL
condition|)
operator|*
name|vt
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|ft
operator|!=
name|NULL
condition|)
operator|*
name|ft
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writevtft
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|vt
parameter_list|,
name|u_int
name|ft
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_VTFT
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|vt
argument_list|,
literal|16
argument_list|,
literal|16
argument_list|)
operator||
name|GENBIT
argument_list|(
name|ft
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* PSST: Pan Send and Loop Start Address */
end_comment

begin_function
specifier|static
name|void
name|emu_readpsst
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|pan
parameter_list|,
name|u_int
modifier|*
name|st
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_PSST
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|pan
operator|!=
name|NULL
condition|)
operator|*
name|pan
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|24
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|!=
name|NULL
condition|)
operator|*
name|st
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writepsst
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|pan
parameter_list|,
name|u_int
name|st
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_PSST
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|pan
argument_list|,
literal|24
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|st
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* CSL: Chorus Send and Loop End Address */
end_comment

begin_function
specifier|static
name|void
name|emu_readcsl
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|cs
parameter_list|,
name|u_int
modifier|*
name|lp
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_CSL
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|cs
operator|!=
name|NULL
condition|)
operator|*
name|cs
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|24
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp
operator|!=
name|NULL
condition|)
operator|*
name|lp
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writecsl
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|cs
parameter_list|,
name|u_int
name|lp
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_CSL
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|cs
argument_list|,
literal|24
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|lp
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* CCCA: Q, Control Bits and Current Address */
end_comment

begin_function
specifier|static
name|void
name|emu_readccca
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|q
parameter_list|,
name|u_int
modifier|*
name|dma
parameter_list|,
name|u_int
modifier|*
name|wr
parameter_list|,
name|u_int
modifier|*
name|right
parameter_list|,
name|u_int
modifier|*
name|ca
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_CCCA
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|!=
name|NULL
condition|)
operator|*
name|q
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|28
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma
operator|!=
name|NULL
condition|)
operator|*
name|dma
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|26
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wr
operator|!=
name|NULL
condition|)
operator|*
name|wr
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|25
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|right
operator|!=
name|NULL
condition|)
operator|*
name|right
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|24
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ca
operator|!=
name|NULL
condition|)
operator|*
name|ca
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeccca
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|q
parameter_list|,
name|u_int
name|dma
parameter_list|,
name|u_int
name|wr
parameter_list|,
name|u_int
name|right
parameter_list|,
name|u_int
name|ca
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_CCCA
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|q
argument_list|,
literal|28
argument_list|,
literal|4
argument_list|)
operator||
name|GENBIT
argument_list|(
name|dma
argument_list|,
literal|26
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|wr
argument_list|,
literal|25
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|right
argument_list|,
literal|24
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|ca
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* HWCF4: Configuration Double Word 4 */
end_comment

begin_function
specifier|static
name|void
name|emu_readhwcf4
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writehwcf4
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"emu%d: writing value 0x%x to HWCF4.\n"
argument_list|,
name|device_get_unit
argument_list|(
name|scp
operator|->
name|dev
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF4
argument_list|,
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* HWCF5: Configuration Double Word 5 */
end_comment

begin_function
specifier|static
name|void
name|emu_readhwcf5
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writehwcf5
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0x00000083
condition|)
name|printf
argument_list|(
literal|"emu%d: writing value 0x%x to HWCF5.\n"
argument_list|,
name|device_get_unit
argument_list|(
name|scp
operator|->
name|dev
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF5
argument_list|,
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* HWCF6: Configuration Double Word 6 */
end_comment

begin_function
specifier|static
name|void
name|emu_readhwcf6
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF6
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writehwcf6
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0x00008000
condition|)
name|printf
argument_list|(
literal|"emu%d: writing value 0x%x to HWCF6.\n"
argument_list|,
name|device_get_unit
argument_list|(
name|scp
operator|->
name|dev
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF6
argument_list|,
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SMALR: Sound Memory Address for Left SM Reads */
end_comment

begin_function
specifier|static
name|void
name|emu_readsmalr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|mt
parameter_list|,
name|u_int
modifier|*
name|smalr
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMALR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mt
operator|!=
name|NULL
condition|)
operator|*
name|mt
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|smalr
operator|!=
name|NULL
condition|)
operator|*
name|smalr
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writesmalr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|mt
parameter_list|,
name|u_int
name|smalr
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMALR
argument_list|,
literal|0
argument_list|,
name|GENBIT
argument_list|(
name|mt
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|smalr
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SMARR: Sound Memory Address for Right SM Reads */
end_comment

begin_function
specifier|static
name|void
name|emu_readsmarr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|mt
parameter_list|,
name|u_int
modifier|*
name|smarr
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMARR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mt
operator|!=
name|NULL
condition|)
operator|*
name|mt
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|smarr
operator|!=
name|NULL
condition|)
operator|*
name|smarr
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writesmarr
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|mt
parameter_list|,
name|u_int
name|smarr
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMARR
argument_list|,
literal|0
argument_list|,
name|GENBIT
argument_list|(
name|mt
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|smarr
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SMALW: Sound Memory Address for Left SM Writes */
end_comment

begin_function
specifier|static
name|void
name|emu_readsmalw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|full
parameter_list|,
name|u_int
modifier|*
name|smalw
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMALW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|full
operator|!=
name|NULL
condition|)
operator|*
name|full
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|smalw
operator|!=
name|NULL
condition|)
operator|*
name|smalw
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writesmalw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|full
parameter_list|,
name|u_int
name|smalw
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMALW
argument_list|,
literal|0
argument_list|,
name|GENBIT
argument_list|(
name|full
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|smalw
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SMARW: Sound Memory Address for Right SM Writes */
end_comment

begin_function
specifier|static
name|void
name|emu_readsmarw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|full
parameter_list|,
name|u_int
modifier|*
name|smarw
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMARW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|full
operator|!=
name|NULL
condition|)
operator|*
name|full
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|smarw
operator|!=
name|NULL
condition|)
operator|*
name|smarw
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writesmarw
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|full
parameter_list|,
name|u_int
name|smarw
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMARW
argument_list|,
literal|0
argument_list|,
name|GENBIT
argument_list|(
name|full
argument_list|,
literal|31
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|smarw
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SMLD: Sound Memory Left Data */
end_comment

begin_function
specifier|static
name|void
name|emu_readsmld
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
modifier|*
name|smld
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMLD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|smld
operator|!=
name|NULL
condition|)
operator|*
name|smld
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writesmld
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
name|smld
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMLD
argument_list|,
literal|0
argument_list|,
name|smld
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* SMRD: Sound Memory Right Data */
end_comment

begin_function
specifier|static
name|void
name|emu_readsmrd
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
modifier|*
name|smrd
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMRD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|smrd
operator|!=
name|NULL
condition|)
operator|*
name|smrd
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writesmrd
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_short
name|smrd
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_SMRD
argument_list|,
literal|0
argument_list|,
name|smrd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* WC: Sample COunter */
end_comment

begin_function
specifier|static
name|void
name|emu_readwc
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|wc
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_WC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wc
operator|!=
name|NULL
condition|)
operator|*
name|wc
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writewc
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|wc
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_WC
argument_list|,
literal|0
argument_list|,
name|wc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* HWCF1: Configuration Double Word 1 */
end_comment

begin_function
specifier|static
name|void
name|emu_readhwcf1
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writehwcf1
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0x0059
condition|)
name|printf
argument_list|(
literal|"emu%d: writing value 0x%x to HWCF1.\n"
argument_list|,
name|device_get_unit
argument_list|(
name|scp
operator|->
name|dev
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF1
argument_list|,
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* HWCF2: Configuration Double Word 2 */
end_comment

begin_function
specifier|static
name|void
name|emu_readhwcf2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writehwcf2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0x0020
condition|)
name|printf
argument_list|(
literal|"emu%d: writing value 0x%x to HWCF2.\n"
argument_list|,
name|device_get_unit
argument_list|(
name|scp
operator|->
name|dev
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF2
argument_list|,
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* HWCF3: Configuration Double Word 3 */
end_comment

begin_function
specifier|static
name|void
name|emu_readhwcf3
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writehwcf3
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0x0004
operator|&&
name|val
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"emu%d: writing value 0x%x to HWCF3.\n"
argument_list|,
name|device_get_unit
argument_list|(
name|scp
operator|->
name|dev
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_HWCF3
argument_list|,
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* INIT1: Initialization Array 1 */
end_comment

begin_function
specifier|static
name|void
name|emu_readinit1
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT1
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeinit1
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT1
argument_list|,
name|chn
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* INIT2: Initialization Array 2 */
end_comment

begin_function
specifier|static
name|void
name|emu_readinit2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT2
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeinit2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT2
argument_list|,
name|chn
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* INIT3: Initialization Array 3 */
end_comment

begin_function
specifier|static
name|void
name|emu_readinit3
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT3
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeinit3
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT3
argument_list|,
name|chn
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* INIT4: Initialization Array 4 */
end_comment

begin_function
specifier|static
name|void
name|emu_readinit4
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT4
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeinit4
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_INIT4
argument_list|,
name|chn
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ENVVOL: Volume Envelope Decay */
end_comment

begin_function
specifier|static
name|void
name|emu_readenvvol
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|envvol
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_ENVVOL
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|envvol
operator|!=
name|NULL
condition|)
operator|*
name|envvol
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeenvvol
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|envvol
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_ENVVOL
argument_list|,
name|chn
argument_list|,
name|envvol
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* DCYSUSV: Volume Envelope Sustain and Decay */
end_comment

begin_function
specifier|static
name|void
name|emu_readdcysusv
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|ph1v
parameter_list|,
name|u_int
modifier|*
name|susv
parameter_list|,
name|u_int
modifier|*
name|off
parameter_list|,
name|u_int
modifier|*
name|dcyv
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_DCYSUSV
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph1v
operator|!=
name|NULL
condition|)
operator|*
name|ph1v
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|15
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|susv
operator|!=
name|NULL
condition|)
operator|*
name|susv
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|off
operator|!=
name|NULL
condition|)
operator|*
name|off
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|7
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dcyv
operator|!=
name|NULL
condition|)
operator|*
name|dcyv
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writedcysusv
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ph1v
parameter_list|,
name|u_int
name|susv
parameter_list|,
name|u_int
name|off
parameter_list|,
name|u_int
name|dcyv
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_DCYSUSV
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|ph1v
argument_list|,
literal|15
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|susv
argument_list|,
literal|8
argument_list|,
literal|7
argument_list|)
operator||
name|GENBIT
argument_list|(
name|off
argument_list|,
literal|7
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|dcyv
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ENVVAL: Modulation Envelope Decay */
end_comment

begin_function
specifier|static
name|void
name|emu_readenvval
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|envval
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_ENVVAL
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|envval
operator|!=
name|NULL
condition|)
operator|*
name|envval
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeenvval
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|envval
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_ENVVAL
argument_list|,
name|chn
argument_list|,
name|envval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* DCYSUS: Modulation Envelope Sustain and Decay */
end_comment

begin_function
specifier|static
name|void
name|emu_readdcysus
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|ph1
parameter_list|,
name|u_int
modifier|*
name|sus
parameter_list|,
name|u_int
modifier|*
name|dcy
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_DCYSUS
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph1
operator|!=
name|NULL
condition|)
operator|*
name|ph1
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|15
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sus
operator|!=
name|NULL
condition|)
operator|*
name|sus
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|dcy
operator|!=
name|NULL
condition|)
operator|*
name|dcy
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writedcysus
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ph1
parameter_list|,
name|u_int
name|sus
parameter_list|,
name|u_int
name|dcy
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_DCYSUS
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|ph1
argument_list|,
literal|15
argument_list|,
literal|1
argument_list|)
operator||
name|GENBIT
argument_list|(
name|sus
argument_list|,
literal|8
argument_list|,
literal|7
argument_list|)
operator||
name|GENBIT
argument_list|(
name|dcy
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ATKHLDV: Volume Envelope Hold and Attack */
end_comment

begin_function
specifier|static
name|void
name|emu_readatkhldv
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|atkhldv
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_ATKHLDV
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|atkhldv
operator|!=
name|NULL
condition|)
operator|*
name|atkhldv
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeatkhldv
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|atkhldv
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_ATKHLDV
argument_list|,
name|chn
argument_list|,
name|atkhldv
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* LFO1VAL: LFO #1 Delay */
end_comment

begin_function
specifier|static
name|void
name|emu_readlfo1val
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|lfo1val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_LFO1VAL
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|lfo1val
operator|!=
name|NULL
condition|)
operator|*
name|lfo1val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writelfo1val
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|lfo1val
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_LFO1VAL
argument_list|,
name|chn
argument_list|,
name|lfo1val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ATKHLD: Modulation Envelope Hold and Attack */
end_comment

begin_function
specifier|static
name|void
name|emu_readatkhld
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|atkhld
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_ATKHLD
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|atkhld
operator|!=
name|NULL
condition|)
operator|*
name|atkhld
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeatkhld
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|atkhld
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_ATKHLD
argument_list|,
name|chn
argument_list|,
name|atkhld
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* LFO2VAL: LFO #2 Delay */
end_comment

begin_function
specifier|static
name|void
name|emu_readlfo2val
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|lfo2val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_LFO2VAL
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|lfo2val
operator|!=
name|NULL
condition|)
operator|*
name|lfo2val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writelfo2val
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|lfo2val
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_LFO2VAL
argument_list|,
name|chn
argument_list|,
name|lfo2val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* IP: Initial Pitch */
end_comment

begin_function
specifier|static
name|void
name|emu_readip
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|ip
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_IP
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|!=
name|NULL
condition|)
operator|*
name|ip
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeip
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ip
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_IP
argument_list|,
name|chn
argument_list|,
name|ip
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* IFATN: Initial Filter Cutoff and Attenuation */
end_comment

begin_function
specifier|static
name|void
name|emu_readifatn
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|ifc
parameter_list|,
name|u_int
modifier|*
name|atn
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_IFATN
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifc
operator|!=
name|NULL
condition|)
operator|*
name|ifc
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|atn
operator|!=
name|NULL
condition|)
operator|*
name|atn
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeifatn
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|ifc
parameter_list|,
name|u_int
name|atn
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_IFATN
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|ifc
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|atn
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* PEFE: Pitch and Filter Envelope Heights */
end_comment

begin_function
specifier|static
name|void
name|emu_readpefe
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|pe
parameter_list|,
name|u_int
modifier|*
name|fe
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_PEFE
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
operator|!=
name|NULL
condition|)
operator|*
name|pe
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|fe
operator|!=
name|NULL
condition|)
operator|*
name|fe
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writepefe
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|pe
parameter_list|,
name|u_int
name|fe
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_PEFE
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|pe
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|fe
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* FMMOD: Vibrato and Filter Modulation from LFO #1 */
end_comment

begin_function
specifier|static
name|void
name|emu_readfmmod
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|fm
parameter_list|,
name|u_int
modifier|*
name|mod
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_FMMOD
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|fm
operator|!=
name|NULL
condition|)
operator|*
name|fm
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|mod
operator|!=
name|NULL
condition|)
operator|*
name|mod
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writefmmod
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|fm
parameter_list|,
name|u_int
name|mod
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_FMMOD
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|fm
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|mod
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* TREMFRQ: LFO #1 Tremolo Amount and Frequency */
end_comment

begin_function
specifier|static
name|void
name|emu_readtremfrq
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|trem
parameter_list|,
name|u_int
modifier|*
name|frq
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_TREMFRQ
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|trem
operator|!=
name|NULL
condition|)
operator|*
name|trem
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|frq
operator|!=
name|NULL
condition|)
operator|*
name|frq
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writetremfrq
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|trem
parameter_list|,
name|u_int
name|frq
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_TREMFRQ
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|trem
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|frq
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* FM2FRQ2: LFO #2 Vibrato Amount and Frequency */
end_comment

begin_function
specifier|static
name|void
name|emu_readfm2frq2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
modifier|*
name|fm2
parameter_list|,
name|u_int
modifier|*
name|frq2
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_FM2FRQ2
argument_list|,
name|chn
argument_list|)
expr_stmt|;
if|if
condition|(
name|fm2
operator|!=
name|NULL
condition|)
operator|*
name|fm2
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|frq2
operator|!=
name|NULL
condition|)
operator|*
name|frq2
operator|=
name|DECBIT
argument_list|(
name|sts
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writefm2frq2
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_int
name|fm2
parameter_list|,
name|u_int
name|frq2
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_FM2FRQ2
argument_list|,
name|chn
argument_list|,
name|GENBIT
argument_list|(
name|fm2
argument_list|,
literal|8
argument_list|,
literal|8
argument_list|)
operator||
name|GENBIT
argument_list|(
name|frq2
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* PROBE: Probe Register */
end_comment

begin_function
specifier|static
name|void
name|emu_readprobe
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
modifier|*
name|val
parameter_list|)
block|{
name|u_long
name|sts
decl_stmt|;
name|sts
operator|=
name|emu_status
argument_list|(
name|scp
argument_list|,
name|EMU8K_PROBE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|NULL
condition|)
operator|*
name|val
operator|=
name|sts
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|emu_writeprobe
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|u_int
name|val
parameter_list|)
block|{
name|emu_command
argument_list|(
name|scp
argument_list|,
name|EMU8K_PROBE
argument_list|,
literal|0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Writes to a register. */
end_comment

begin_function
specifier|static
name|void
name|emu_command
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|chn
parameter_list|,
name|u_long
name|val
parameter_list|)
block|{
if|if
condition|(
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>=
name|EMU8K_MAXVOICE
operator|||
name|reg
operator|<
literal|0
operator|||
name|reg
operator|>=
name|EMU8K_REGNUM
condition|)
return|return;
comment|/* Override the channel if necessary. */
if|if
condition|(
name|emu_regs
index|[
name|reg
index|]
operator|.
name|chn
operator|!=
name|EMU8K_CHN_ANY
condition|)
name|chn
operator|=
name|emu_regs
index|[
name|reg
index|]
operator|.
name|chn
expr_stmt|;
comment|/* Select the register first. */
name|bus_space_write_2
argument_list|(
name|rman_get_bustag
argument_list|(
name|scp
operator|->
name|io
index|[
name|EMU8K_IDX_PTR
index|]
argument_list|)
argument_list|,
name|rman_get_bushandle
argument_list|(
name|scp
operator|->
name|io
index|[
name|EMU8K_IDX_PTR
index|]
argument_list|)
argument_list|,
name|EMU8K_PORT_PTR
argument_list|,
operator|(
name|chn
operator|&
literal|0x1f
operator|)
operator||
operator|(
operator|(
name|emu_regs
index|[
name|reg
index|]
operator|.
name|reg
operator|&
literal|0x07
operator|)
operator|<<
literal|5
operator|)
argument_list|)
expr_stmt|;
comment|/* Then we write the data. */
name|bus_space_write_2
argument_list|(
name|rman_get_bustag
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|rman_get_bushandle
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|emu_regs
index|[
name|reg
index|]
operator|.
name|port
argument_list|,
name|val
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu_regs
index|[
name|reg
index|]
operator|.
name|size
condition|)
comment|/* double word */
name|bus_space_write_2
argument_list|(
name|rman_get_bustag
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|rman_get_bushandle
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|emu_regs
index|[
name|reg
index|]
operator|.
name|port
operator|+
literal|2
argument_list|,
operator|(
name|val
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Reads from a register. */
end_comment

begin_function
specifier|static
name|u_long
name|emu_status
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|chn
parameter_list|)
block|{
name|u_long
name|status
decl_stmt|;
if|if
condition|(
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>=
name|EMU8K_MAXVOICE
operator|||
name|reg
operator|<
literal|0
operator|||
name|reg
operator|>=
name|EMU8K_REGNUM
condition|)
return|return
operator|(
literal|0xffffffff
operator|)
return|;
comment|/* Override the channel if necessary. */
if|if
condition|(
name|emu_regs
index|[
name|reg
index|]
operator|.
name|chn
operator|!=
name|EMU8K_CHN_ANY
condition|)
name|chn
operator|=
name|emu_regs
index|[
name|reg
index|]
operator|.
name|chn
expr_stmt|;
comment|/* Select the register first. */
name|bus_space_write_2
argument_list|(
name|rman_get_bustag
argument_list|(
name|scp
operator|->
name|io
index|[
name|EMU8K_IDX_PTR
index|]
argument_list|)
argument_list|,
name|rman_get_bushandle
argument_list|(
name|scp
operator|->
name|io
index|[
name|EMU8K_IDX_PTR
index|]
argument_list|)
argument_list|,
name|EMU8K_PORT_PTR
argument_list|,
operator|(
name|chn
operator|&
literal|0x1f
operator|)
operator||
operator|(
operator|(
name|emu_regs
index|[
name|reg
index|]
operator|.
name|reg
operator|&
literal|0x07
operator|)
operator|<<
literal|5
operator|)
argument_list|)
expr_stmt|;
comment|/* Then we read the data. */
name|status
operator|=
name|bus_space_read_2
argument_list|(
name|rman_get_bustag
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|rman_get_bushandle
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|emu_regs
index|[
name|reg
index|]
operator|.
name|port
argument_list|)
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
name|emu_regs
index|[
name|reg
index|]
operator|.
name|size
condition|)
comment|/* double word */
name|status
operator||=
operator|(
name|bus_space_read_2
argument_list|(
name|rman_get_bustag
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|rman_get_bushandle
argument_list|(
name|scp
operator|->
name|io
index|[
name|emu_regs
index|[
name|reg
index|]
operator|.
name|index
index|]
argument_list|)
argument_list|,
name|emu_regs
index|[
name|reg
index|]
operator|.
name|port
operator|+
literal|2
argument_list|)
operator|&
literal|0xffff
operator|)
operator|<<
literal|16
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Allocates resources. */
end_comment

begin_function
specifier|static
name|int
name|emu_allocres
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* 	 * Attempt to allocate the EMU8000's three I/O port ranges. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|scp
operator|->
name|io
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|scp
operator|->
name|io_rid
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
name|scp
operator|->
name|io
index|[
name|i
index|]
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
operator|(
name|scp
operator|->
name|io_rid
index|[
name|i
index|]
operator|)
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|4
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Fail if any of the I/O ranges failed (I.e. weren't identified and 	 * configured by PNP, which can happen if the ID of the card isn't 	 * known by the PNP quirk-handling logic) 	 */
if|if
condition|(
name|scp
operator|->
name|io
index|[
literal|0
index|]
operator|==
name|NULL
operator|||
name|scp
operator|->
name|io
index|[
literal|1
index|]
operator|==
name|NULL
operator|||
name|scp
operator|->
name|io
index|[
literal|2
index|]
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"emu%d: Resource alloc failed, pnp_quirks "
literal|"may need { 0x%08x, 0x%08x }\n"
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|isa_get_vendorid
argument_list|(
name|dev
argument_list|)
argument_list|,
name|isa_get_logicalid
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Releases resources. */
end_comment

begin_function
specifier|static
name|void
name|emu_releaseres
parameter_list|(
name|sc_p
name|scp
parameter_list|,
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|scp
operator|->
name|io
index|[
literal|0
index|]
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|scp
operator|->
name|io_rid
index|[
literal|0
index|]
argument_list|,
name|scp
operator|->
name|io
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|scp
operator|->
name|io
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|scp
operator|->
name|io
index|[
literal|1
index|]
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|scp
operator|->
name|io_rid
index|[
literal|1
index|]
argument_list|,
name|scp
operator|->
name|io
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|scp
operator|->
name|io
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|scp
operator|->
name|io
index|[
literal|2
index|]
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|scp
operator|->
name|io_rid
index|[
literal|2
index|]
argument_list|,
name|scp
operator|->
name|io
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|scp
operator|->
name|io
index|[
literal|2
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|emu_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|emu_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|emu_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|emu_driver
init|=
block|{
literal|"midi"
block|,
name|emu_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|emu_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|emu
argument_list|,
name|isa
argument_list|,
name|emu_driver
argument_list|,
name|midi_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003 Mathew Kanner  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kobj.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_comment
comment|/* to get driver_intr_t */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/midi/mpu401.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/midi/midi.h>
end_include

begin_include
include|#
directive|include
file|"mpu_if.h"
end_include

begin_include
include|#
directive|include
file|"mpufoi_if.h"
end_include

begin_define
define|#
directive|define
name|MPU_DATAPORT
value|0
end_define

begin_define
define|#
directive|define
name|MPU_CMDPORT
value|1
end_define

begin_define
define|#
directive|define
name|MPU_STATPORT
value|1
end_define

begin_define
define|#
directive|define
name|MPU_RESET
value|0xff
end_define

begin_define
define|#
directive|define
name|MPU_UART
value|0x3f
end_define

begin_define
define|#
directive|define
name|MPU_ACK
value|0xfe
end_define

begin_define
define|#
directive|define
name|MPU_STATMASK
value|0xc0
end_define

begin_define
define|#
directive|define
name|MPU_OUTPUTBUSY
value|0x40
end_define

begin_define
define|#
directive|define
name|MPU_INPUTBUSY
value|0x80
end_define

begin_define
define|#
directive|define
name|MPU_TRYDATA
value|50
end_define

begin_define
define|#
directive|define
name|MPU_DELAY
value|2500
end_define

begin_define
define|#
directive|define
name|CMD
parameter_list|(
name|m
parameter_list|,
name|d
parameter_list|)
value|MPUFOI_WRITE(m, m->cookie, MPU_CMDPORT,d)
end_define

begin_define
define|#
directive|define
name|STATUS
parameter_list|(
name|m
parameter_list|)
value|MPUFOI_READ(m, m->cookie, MPU_STATPORT)
end_define

begin_define
define|#
directive|define
name|READ
parameter_list|(
name|m
parameter_list|)
value|MPUFOI_READ(m, m->cookie, MPU_DATAPORT)
end_define

begin_define
define|#
directive|define
name|WRITE
parameter_list|(
name|m
parameter_list|,
name|d
parameter_list|)
value|MPUFOI_WRITE(m, m->cookie, MPU_DATAPORT,d)
end_define

begin_struct
struct|struct
name|mpu401
block|{
name|KOBJ_FIELDS
expr_stmt|;
name|struct
name|snd_midi
modifier|*
name|mid
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|driver_intr_t
modifier|*
name|si
decl_stmt|;
name|void
modifier|*
name|cookie
decl_stmt|;
name|struct
name|callout
name|timer
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|mpu401_timeout
parameter_list|(
name|void
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|mpu401_intr_t
name|mpu401_intr
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|mpu401_minit
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mpu401_muninit
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mpu401_minqsize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mpu401_moutqsize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mpu401_mcallback
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|,
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mpu401_mcallbackp
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|,
name|int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|mpu401_mdescr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|,
name|int
name|verbosity
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|mpu401_mprovider
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|kobj_method_t
name|mpu401_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|mpu_init
argument_list|,
name|mpu401_minit
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mpu_uninit
argument_list|,
name|mpu401_muninit
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mpu_inqsize
argument_list|,
name|mpu401_minqsize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mpu_outqsize
argument_list|,
name|mpu401_moutqsize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mpu_callback
argument_list|,
name|mpu401_mcallback
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mpu_callbackp
argument_list|,
name|mpu401_mcallbackp
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mpu_descr
argument_list|,
name|mpu401_mdescr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mpu_provider
argument_list|,
name|mpu401_mprovider
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DEFINE_CLASS
argument_list|(
name|mpu401
argument_list|,
name|mpu401_methods
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mpu401_timeout
parameter_list|(
name|void
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|mpu401
modifier|*
name|m
init|=
operator|(
expr|struct
name|mpu401
operator|*
operator|)
name|a
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|si
condition|)
call|(
name|m
operator|->
name|si
call|)
argument_list|(
name|m
operator|->
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpu401_intr
parameter_list|(
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
block|{
define|#
directive|define
name|MPU_INTR_BUF
value|16
name|MIDI_TYPE
name|b
index|[
name|MPU_INTR_BUF
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|s
decl_stmt|;
comment|/* 	printf("mpu401_intr\n"); */
define|#
directive|define
name|RXRDY
parameter_list|(
name|m
parameter_list|)
value|( (STATUS(m)& MPU_INPUTBUSY) == 0)
define|#
directive|define
name|TXRDY
parameter_list|(
name|m
parameter_list|)
value|( (STATUS(m)& MPU_OUTPUTBUSY) == 0)
if|#
directive|if
literal|0
define|#
directive|define
name|D
parameter_list|(
name|x
parameter_list|,
name|l
parameter_list|)
value|printf("mpu401_intr %d %x %s %s\n",l, x, x&MPU_INPUTBUSY?"RX":"", x&MPU_OUTPUTBUSY?"TX":"")
else|#
directive|else
define|#
directive|define
name|D
parameter_list|(
name|x
parameter_list|,
name|l
parameter_list|)
endif|#
directive|endif
name|i
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|STATUS
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|D
argument_list|(
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|s
operator|&
name|MPU_INPUTBUSY
operator|)
operator|==
literal|0
operator|&&
name|i
operator|<
name|MPU_INTR_BUF
condition|)
block|{
name|b
index|[
name|i
index|]
operator|=
name|READ
argument_list|(
name|m
argument_list|)
expr_stmt|;
comment|/* 		printf("mpu401_intr in i %d d %d\n", i, b[i]); */
name|i
operator|++
expr_stmt|;
name|s
operator|=
name|STATUS
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
condition|)
name|midi_in
argument_list|(
name|m
operator|->
name|mid
argument_list|,
name|b
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|s
operator|&
name|MPU_OUTPUTBUSY
operator|)
operator|&&
name|i
operator|<
name|MPU_INTR_BUF
condition|)
block|{
if|if
condition|(
name|midi_out
argument_list|(
name|m
operator|->
name|mid
argument_list|,
name|b
argument_list|,
literal|1
argument_list|)
condition|)
block|{
comment|/* 			printf("mpu401_intr out i %d d %d\n", i, b[0]); */
name|WRITE
argument_list|(
name|m
argument_list|,
operator|*
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 			printf("mpu401_intr write: no output\n"); */
return|return
literal|0
return|;
block|}
name|i
operator|++
expr_stmt|;
comment|/* DELAY(100); */
name|s
operator|=
name|STATUS
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|m
operator|->
name|flags
operator|&
name|M_TXEN
operator|)
operator|&&
operator|(
name|m
operator|->
name|si
operator|)
condition|)
block|{
name|callout_reset
argument_list|(
operator|&
name|m
operator|->
name|timer
argument_list|,
literal|1
argument_list|,
name|mpu401_timeout
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|m
operator|->
name|flags
operator|&
name|M_TXEN
operator|)
operator|==
name|M_TXEN
return|;
block|}
end_function

begin_function
name|struct
name|mpu401
modifier|*
name|mpu401_init
parameter_list|(
name|kobj_class_t
name|cls
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|,
name|driver_intr_t
name|softintr
parameter_list|,
name|mpu401_intr_t
modifier|*
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|mpu401
modifier|*
name|m
decl_stmt|;
operator|*
name|cb
operator|=
name|NULL
expr_stmt|;
name|m
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|m
argument_list|)
argument_list|,
name|M_MIDI
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
return|return
name|NULL
return|;
name|kobj_init
argument_list|(
operator|(
name|kobj_t
operator|)
name|m
argument_list|,
name|cls
argument_list|)
expr_stmt|;
name|callout_init
argument_list|(
operator|&
name|m
operator|->
name|timer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|m
operator|->
name|si
operator|=
name|softintr
expr_stmt|;
name|m
operator|->
name|cookie
operator|=
name|cookie
expr_stmt|;
name|m
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|mid
operator|=
name|midi_init
argument_list|(
operator|&
name|mpu401_class
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
operator|->
name|mid
condition|)
goto|goto
name|err
goto|;
operator|*
name|cb
operator|=
name|mpu401_intr
expr_stmt|;
return|return
name|m
return|;
name|err
label|:
name|printf
argument_list|(
literal|"mpu401_init error\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m
argument_list|,
name|M_MIDI
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|mpu401_uninit
parameter_list|(
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
name|CMD
argument_list|(
name|m
argument_list|,
name|MPU_RESET
argument_list|)
expr_stmt|;
name|retval
operator|=
name|midi_uninit
argument_list|(
name|m
operator|->
name|mid
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
condition|)
return|return
name|retval
return|;
name|free
argument_list|(
name|m
argument_list|,
name|M_MIDI
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mpu401_minit
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CMD
argument_list|(
name|m
argument_list|,
name|MPU_RESET
argument_list|)
expr_stmt|;
name|CMD
argument_list|(
name|m
argument_list|,
name|MPU_UART
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|++
name|i
operator|<
literal|2000
condition|)
block|{
if|if
condition|(
name|RXRDY
argument_list|(
name|m
argument_list|)
condition|)
if|if
condition|(
name|READ
argument_list|(
name|m
argument_list|)
operator|==
name|MPU_ACK
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|<
literal|2000
condition|)
block|{
name|CMD
argument_list|(
name|m
argument_list|,
name|MPU_UART
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|printf
argument_list|(
literal|"mpu401_minit failed active sensing\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|mpu401_muninit
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
block|{
return|return
name|MPUFOI_UNINIT
argument_list|(
name|m
argument_list|,
name|m
operator|->
name|cookie
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mpu401_minqsize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
block|{
return|return
literal|128
return|;
block|}
end_function

begin_function
name|int
name|mpu401_moutqsize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
block|{
return|return
literal|128
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpu401_mcallback
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
if|#
directive|if
literal|0
block|printf("mpu401_callback %s %s %s %s\n", 	    flags& M_RX ? "M_RX" : "", 	    flags& M_TX ? "M_TX" : "", 	    flags& M_RXEN ? "M_RXEN" : "", 	    flags& M_TXEN ? "M_TXEN" : "");
endif|#
directive|endif
if|if
condition|(
name|flags
operator|&
name|M_TXEN
operator|&&
name|m
operator|->
name|si
condition|)
block|{
name|callout_reset
argument_list|(
operator|&
name|m
operator|->
name|timer
argument_list|,
literal|1
argument_list|,
name|mpu401_timeout
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|m
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mpu401_mcallbackp
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
comment|/*	printf("mpu401_callbackp\n"); */
name|mpu401_mcallback
argument_list|(
name|obj
argument_list|,
name|m
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|mpu401_mdescr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|,
name|int
name|verbosity
parameter_list|)
block|{
return|return
literal|"descr mpu401"
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|mpu401_mprovider
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|mpu401
modifier|*
name|m
parameter_list|)
block|{
return|return
literal|"provider mpu401"
return|;
block|}
end_function

end_unit


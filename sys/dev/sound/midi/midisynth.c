begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright by Hannu Savolainen 1993  *  * Redistribution and use in source and binary forms, with or  * without modification, are permitted provided that the following  * conditions are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above  *    copyright notice, this list of conditions and the following  *    disclaimer in the documentation and/or other materials provided  *    with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS  * IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE  * AUTHOR OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * This is the interface for a sequencer to interact a midi driver.  * This interface translates the sequencer operations to the corresponding  * midi messages, and vice versa.  */
end_comment

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/midi/midi.h>
end_include

begin_define
define|#
directive|define
name|TYPEDRANGE
parameter_list|(
name|type
parameter_list|,
name|x
parameter_list|,
name|lower
parameter_list|,
name|upper
parameter_list|)
define|\
value|{ \ 	type tl, tu; \ 	tl = (lower); \ 	tu = (upper); \ 	if (x< tl) { \ 		x = tl; \ 	} else if(x> tu) { \ 		x = tu; \ 	} \ }
end_define

begin_comment
comment|/*  * These functions goes into midisynthdev_op_desc.  */
end_comment

begin_decl_stmt
specifier|static
name|mdsy_killnote_t
name|synth_killnote
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_setinstr_t
name|synth_setinstr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_startnote_t
name|synth_startnote
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_reset_t
name|synth_reset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_hwcontrol_t
name|synth_hwcontrol
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_loadpatch_t
name|synth_loadpatch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_panning_t
name|synth_panning
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_aftertouch_t
name|synth_aftertouch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_controller_t
name|synth_controller
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_patchmgr_t
name|synth_patchmgr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_bender_t
name|synth_bender
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_allocvoice_t
name|synth_allocvoice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_setupvoice_t
name|synth_setupvoice
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_sendsysex_t
name|synth_sendsysex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_prefixcmd_t
name|synth_prefixcmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_volumemethod_t
name|synth_volumemethod
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_readraw_t
name|synth_readraw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mdsy_writeraw_t
name|synth_writeraw
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This is the synthdev_info for a midi interface device.  * You may have to replace a few of functions for an internal  * synthesizer.  */
end_comment

begin_decl_stmt
name|synthdev_info
name|midisynth_op_desc
init|=
block|{
name|synth_killnote
block|,
name|synth_setinstr
block|,
name|synth_startnote
block|,
name|synth_reset
block|,
name|synth_hwcontrol
block|,
name|synth_loadpatch
block|,
name|synth_panning
block|,
name|synth_aftertouch
block|,
name|synth_controller
block|,
name|synth_patchmgr
block|,
name|synth_bender
block|,
name|synth_allocvoice
block|,
name|synth_setupvoice
block|,
name|synth_sendsysex
block|,
name|synth_prefixcmd
block|,
name|synth_volumemethod
block|,
name|synth_readraw
block|,
name|synth_writeraw
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The following functions are local. */
end_comment

begin_function_decl
specifier|static
name|int
name|synth_leavesysex
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Here are the main functions to interact to the midi sequencer.  * These are called from the sequencer functions in sys/i386/isa/snd/sequencer.c.  */
end_comment

begin_function
specifier|static
name|int
name|synth_killnote
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|note
parameter_list|,
name|int
name|vel
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|msg
decl_stmt|,
name|chp
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
index|[
literal|3
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
if|if
condition|(
name|note
operator|<
literal|0
operator|||
name|note
operator|>
literal|127
operator|||
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>
literal|15
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|TYPEDRANGE
argument_list|(
name|int
argument_list|,
name|vel
argument_list|,
literal|0
argument_list|,
literal|127
argument_list|)
expr_stmt|;
if|if
condition|(
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|msg
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0xf0
expr_stmt|;
name|chp
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|chp
operator|==
name|chn
operator|&&
operator|(
operator|(
name|msg
operator|==
literal|0x90
operator|&&
name|vel
operator|==
literal|64
operator|)
operator|||
name|msg
operator|==
literal|0x80
operator|)
condition|)
block|{
comment|/* Use running status. */
name|c
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|note
expr_stmt|;
if|if
condition|(
name|msg
operator|==
literal|0x90
condition|)
comment|/* The note was on. */
name|c
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
else|else
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|vel
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|vel
operator|==
literal|64
condition|)
block|{
name|c
index|[
literal|0
index|]
operator|=
literal|0x90
operator||
operator|(
name|chn
operator|&
literal|0x0f
operator|)
expr_stmt|;
comment|/* Note on. */
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|note
expr_stmt|;
name|c
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|c
index|[
literal|0
index|]
operator|=
literal|0x80
operator||
operator|(
name|chn
operator|&
literal|0x0f
operator|)
expr_stmt|;
comment|/* Note off. */
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|note
expr_stmt|;
name|c
index|[
literal|2
index|]
operator|=
operator|(
name|u_char
operator|)
name|vel
expr_stmt|;
block|}
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
name|EAGAIN
return|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_setinstr
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|instr
parameter_list|)
block|{
name|int
name|unit
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
index|[
literal|2
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
if|if
condition|(
name|instr
operator|<
literal|0
operator|||
name|instr
operator|>
literal|127
operator|||
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>
literal|15
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|c
index|[
literal|0
index|]
operator|=
literal|0xc0
operator||
operator|(
name|chn
operator|&
literal|0x0f
operator|)
expr_stmt|;
comment|/* Progamme change. */
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|instr
expr_stmt|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_startnote
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|note
parameter_list|,
name|int
name|vel
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|msg
decl_stmt|,
name|chp
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
index|[
literal|3
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
if|if
condition|(
name|note
operator|<
literal|0
operator|||
name|note
operator|>
literal|127
operator|||
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>
literal|15
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|TYPEDRANGE
argument_list|(
name|int
argument_list|,
name|vel
argument_list|,
literal|0
argument_list|,
literal|127
argument_list|)
expr_stmt|;
if|if
condition|(
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|msg
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0xf0
expr_stmt|;
name|chp
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|chp
operator|==
name|chn
operator|&&
name|msg
operator|==
literal|0x90
condition|)
block|{
comment|/* Use running status. */
name|c
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|note
expr_stmt|;
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|vel
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
else|else
block|{
name|c
index|[
literal|0
index|]
operator|=
literal|0x90
operator||
operator|(
name|chn
operator|&
literal|0x0f
operator|)
expr_stmt|;
comment|/* Note on. */
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|note
expr_stmt|;
name|c
index|[
literal|2
index|]
operator|=
operator|(
name|u_char
operator|)
name|vel
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_reset
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|)
block|{
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_hwcontrol
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|u_char
modifier|*
name|event
parameter_list|)
block|{
comment|/* NOP. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_loadpatch
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|format
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|offs
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|pmgr_flag
parameter_list|)
block|{
name|struct
name|sysex_info
name|sysex
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|int
name|unit
decl_stmt|,
name|i
decl_stmt|,
name|eox_seen
decl_stmt|,
name|first_byte
decl_stmt|,
name|left
decl_stmt|,
name|src_offs
decl_stmt|,
name|hdr_size
decl_stmt|;
name|u_char
name|c
index|[
name|count
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
name|eox_seen
operator|=
literal|0
expr_stmt|;
name|first_byte
operator|=
literal|1
expr_stmt|;
name|hdr_size
operator|=
name|offsetof
argument_list|(
expr|struct
name|sysex_info
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
literal|0xf0
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|format
operator|!=
name|SYSEX_PATCH
condition|)
block|{
name|printf
argument_list|(
literal|"synth_loadpatch: patch format 0x%x is invalid.\n"
argument_list|,
name|format
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|count
operator|<
name|hdr_size
condition|)
block|{
name|printf
argument_list|(
literal|"synth_loadpatch: patch header is too short.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|count
operator|-=
name|hdr_size
expr_stmt|;
comment|/* Copy the patch data. */
if|if
condition|(
name|uiomove
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sysex
operator|)
index|[
name|offs
index|]
argument_list|,
name|hdr_size
operator|-
name|offs
argument_list|,
name|buf
argument_list|)
condition|)
name|printf
argument_list|(
literal|"synth_loadpatch: memory mangled?\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<
name|sysex
operator|.
name|len
condition|)
block|{
name|sysex
operator|.
name|len
operator|=
operator|(
name|long
operator|)
name|count
expr_stmt|;
name|printf
argument_list|(
literal|"synth_loadpatch: sysex record of %d bytes is too long, adjusted to %d bytes.\n"
argument_list|,
operator|(
name|int
operator|)
name|sysex
operator|.
name|len
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
name|left
operator|=
name|sysex
operator|.
name|len
expr_stmt|;
name|src_offs
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|left
condition|;
name|i
operator|++
control|)
block|{
name|uiomove
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|c
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|eox_seen
operator|=
name|i
operator|>
literal|0
operator|&&
operator|(
name|c
index|[
name|i
index|]
operator|&
literal|0x80
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|eox_seen
operator|&&
name|c
index|[
name|i
index|]
operator|!=
literal|0xf7
condition|)
name|c
index|[
name|i
index|]
operator|=
literal|0xf7
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|&&
name|c
index|[
name|i
index|]
operator|!=
literal|0x80
condition|)
block|{
name|printf
argument_list|(
literal|"synth_loadpatch: sysex does not begin with the status.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|first_byte
operator|&&
operator|(
name|c
index|[
name|i
index|]
operator|&
literal|0x80
operator|)
operator|!=
literal|0
condition|)
block|{
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
name|i
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
name|i
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|first_byte
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|eox_seen
condition|)
block|{
name|c
index|[
literal|0
index|]
operator|=
literal|0xf7
expr_stmt|;
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_panning
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|pan
parameter_list|)
block|{
comment|/* NOP. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_aftertouch
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|press
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|msg
decl_stmt|,
name|chp
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
index|[
literal|2
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
if|if
condition|(
name|press
operator|<
literal|0
operator|||
name|press
operator|>
literal|127
operator|||
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>
literal|15
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|msg
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0xf0
expr_stmt|;
name|chp
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|chp
operator|==
name|chn
operator|&&
name|msg
operator|==
literal|0xd0
condition|)
block|{
comment|/* Use running status. */
name|c
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|press
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
else|else
block|{
name|c
index|[
literal|0
index|]
operator|=
literal|0xd0
operator||
operator|(
name|chn
operator|&
literal|0x0f
operator|)
expr_stmt|;
comment|/* Channel Pressure. */
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|press
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_controller
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|ctrlnum
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|msg
decl_stmt|,
name|chp
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
index|[
literal|3
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
if|if
condition|(
name|ctrlnum
operator|<
literal|1
operator|||
name|ctrlnum
operator|>
literal|127
operator|||
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>
literal|15
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|msg
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0xf0
expr_stmt|;
name|chp
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|chp
operator|==
name|chn
operator|&&
name|msg
operator|==
literal|0xb0
condition|)
block|{
comment|/* Use running status. */
name|c
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|ctrlnum
expr_stmt|;
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|val
operator|&
literal|0x7f
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
else|else
block|{
name|c
index|[
literal|0
index|]
operator|=
literal|0xb0
operator||
operator|(
name|chn
operator|&
literal|0x0f
operator|)
expr_stmt|;
comment|/* Control Message. */
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|ctrlnum
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_patchmgr
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|struct
name|patmgr_info
modifier|*
name|rec
parameter_list|)
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_bender
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|msg
decl_stmt|,
name|chp
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
index|[
literal|3
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|0
operator|||
name|val
operator|>
literal|16383
operator|||
name|chn
operator|<
literal|0
operator|||
name|chn
operator|>
literal|15
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|synth_leavesysex
argument_list|(
name|md
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|msg
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0xf0
expr_stmt|;
name|chp
operator|=
name|sd
operator|->
name|prev_out_status
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
name|chp
operator|==
name|chn
operator|&&
name|msg
operator|==
literal|0xe0
condition|)
block|{
comment|/* Use running status. */
name|c
index|[
literal|0
index|]
operator|=
operator|(
name|u_char
operator|)
name|val
operator|&
literal|0x7f
expr_stmt|;
name|c
index|[
literal|1
index|]
operator|=
call|(
name|u_char
call|)
argument_list|(
name|val
operator|>>
literal|7
argument_list|)
operator|&
literal|0x7f
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
else|else
block|{
name|c
index|[
literal|0
index|]
operator|=
literal|0xe0
operator||
operator|(
name|chn
operator|&
literal|0x0f
operator|)
expr_stmt|;
comment|/* Pitch bend. */
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|u_char
operator|)
name|val
operator|&
literal|0x7f
expr_stmt|;
name|c
index|[
literal|2
index|]
operator|=
call|(
name|u_char
call|)
argument_list|(
name|val
operator|>>
literal|7
argument_list|)
operator|&
literal|0x7f
expr_stmt|;
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
name|c
index|[
literal|0
index|]
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
literal|3
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_allocvoice
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|chn
parameter_list|,
name|int
name|note
parameter_list|,
name|struct
name|voice_alloc_info
modifier|*
name|alloc
parameter_list|)
block|{
comment|/* NOP. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_setupvoice
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|voice
parameter_list|,
name|int
name|chn
parameter_list|)
block|{
comment|/* NOP. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_sendsysex
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|u_char
modifier|*
name|sysex
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
index|[
name|len
index|]
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|sysex
index|[
name|i
index|]
condition|)
block|{
case|case
literal|0xf0
case|:
comment|/* Sysex begins. */
if|if
condition|(
name|synth_prefixcmd
argument_list|(
name|md
argument_list|,
literal|0xf0
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sd
operator|->
name|sysex_state
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0xf7
case|:
comment|/* Sysex ends. */
if|if
condition|(
operator|!
name|sd
operator|->
name|sysex_state
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sd
operator|->
name|sysex_state
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
if|if
condition|(
operator|!
name|sd
operator|->
name|sysex_state
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|sysex
index|[
name|i
index|]
operator|&
literal|0x80
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* A status in a sysex? */
name|sysex
index|[
name|i
index|]
operator|=
literal|0xf7
expr_stmt|;
name|sd
operator|->
name|sysex_state
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
name|c
index|[
name|i
index|]
operator|=
name|sysex
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|sd
operator|->
name|sysex_state
condition|)
break|break;
block|}
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
name|c
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
comment|/* Update the status. */
for|for
control|(
name|j
operator|=
name|i
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
if|if
condition|(
operator|(
name|c
index|[
name|j
index|]
operator|&
literal|0x80
operator|)
operator|!=
literal|0
condition|)
block|{
name|sd
operator|->
name|prev_out_status
operator|=
name|c
index|[
name|j
index|]
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_prefixcmd
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|status
parameter_list|)
block|{
comment|/* NOP. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_volumemethod
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
comment|/* NOP. */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_readraw
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|nonblock
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|ret
decl_stmt|,
name|s
decl_stmt|;
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
if|if
condition|(
name|unit
operator|>=
name|nmidi
operator|+
name|nsynth
condition|)
block|{
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"synth_readraw: unit %d does not exist.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|md
operator|->
name|fflags
operator|&
name|FREAD
operator|)
operator|==
literal|0
condition|)
block|{
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"mpu_readraw: unit %d is not for reading.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|s
operator|=
name|splmidi
argument_list|()
expr_stmt|;
comment|/* Begin recording. */
name|md
operator|->
name|callback
argument_list|(
name|md
argument_list|,
name|MIDI_CB_START
operator||
name|MIDI_CB_RD
argument_list|)
expr_stmt|;
if|if
condition|(
name|nonblock
condition|)
block|{
comment|/* Have we got enough data to read? */
if|if
condition|(
name|md
operator|->
name|midi_dbuf_in
operator|.
name|rl
operator|<
name|len
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
name|ret
operator|=
name|midibuf_seqread
argument_list|(
operator|&
name|md
operator|->
name|midi_dbuf_in
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
name|ret
expr_stmt|;
else|else
name|ret
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|synth_writeraw
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|nonblock
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|ret
decl_stmt|,
name|s
decl_stmt|;
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
if|if
condition|(
name|unit
operator|>=
name|nmidi
operator|+
name|nsynth
condition|)
block|{
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"synth_writeraw: unit %d does not exist.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|md
operator|->
name|fflags
operator|&
name|FWRITE
operator|)
operator|==
literal|0
condition|)
block|{
name|DEB
argument_list|(
name|printf
argument_list|(
literal|"synth_writeraw: unit %d is not for writing.\n"
argument_list|,
name|unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* For nonblocking, have we got enough space to write? */
if|if
condition|(
name|nonblock
operator|&&
name|md
operator|->
name|midi_dbuf_out
operator|.
name|fl
operator|<
name|len
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|s
operator|=
name|splmidi
argument_list|()
expr_stmt|;
name|ret
operator|=
name|midibuf_seqwrite
argument_list|(
operator|&
name|md
operator|->
name|midi_dbuf_out
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
name|ret
expr_stmt|;
else|else
name|ret
operator|=
literal|0
expr_stmt|;
comment|/* Begin playing. */
name|md
operator|->
name|callback
argument_list|(
name|md
argument_list|,
name|MIDI_CB_START
operator||
name|MIDI_CB_WR
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * The functions below here are the libraries for the above ones.  */
end_comment

begin_function
specifier|static
name|int
name|synth_leavesysex
parameter_list|(
name|mididev_info
modifier|*
name|md
parameter_list|)
block|{
name|int
name|unit
decl_stmt|;
name|synthdev_info
modifier|*
name|sd
decl_stmt|;
name|u_char
name|c
decl_stmt|;
name|unit
operator|=
name|md
operator|->
name|unit
expr_stmt|;
name|sd
operator|=
operator|&
name|md
operator|->
name|synth
expr_stmt|;
if|if
condition|(
operator|!
name|sd
operator|->
name|sysex_state
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|sd
operator|->
name|sysex_state
operator|=
literal|0
expr_stmt|;
name|c
operator|=
literal|0xf7
expr_stmt|;
if|if
condition|(
name|md
operator|->
name|synth
operator|.
name|writeraw
argument_list|(
name|md
argument_list|,
operator|&
name|c
argument_list|,
sizeof|sizeof
argument_list|(
name|c
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|==
name|EAGAIN
condition|)
return|return
operator|(
name|EAGAIN
operator|)
return|;
name|sd
operator|->
name|sysex_state
operator|=
literal|0
expr_stmt|;
comment|/* Update the status. */
name|sd
operator|->
name|prev_out_status
operator|=
name|c
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2008 by Marco Trillo. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*-  * Copyright (c) 2002, 2003 Tsubai Masanari.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * 	NetBSD: tumbler.c,v 1.28 2008/05/16 03:49:54 macallan Exp  *	Id: tumbler.c,v 1.11 2002/10/31 17:42:13 tsubai Exp   */
end_comment

begin_comment
comment|/*  *	Apple I2S audio controller.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/dbdma.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr_machdep.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/pio.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iicbus.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iiconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|"mixer_if.h"
end_include

begin_decl_stmt
specifier|extern
name|kobj_class_t
name|i2s_mixer_class
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|device_t
name|i2s_mixer
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tumbler_softc
block|{
name|device_t
name|sc_dev
decl_stmt|;
name|uint32_t
name|sc_addr
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|tumbler_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tumbler_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tumbler_init
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tumbler_uninit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tumbler_reinit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tumbler_set
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|unsigned
name|dev
parameter_list|,
name|unsigned
name|left
parameter_list|,
name|unsigned
name|right
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tumbler_setrecsrc
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|u_int32_t
name|src
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|tumbler_methods
index|[]
init|=
block|{
comment|/* Device interface. */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|tumbler_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|tumbler_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|tumbler_driver
init|=
block|{
literal|"tumbler"
block|,
name|tumbler_methods
block|,
expr|sizeof
operator|(
expr|struct
name|tumbler_softc
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|tumbler_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|tumbler
argument_list|,
name|iicbus
argument_list|,
name|tumbler_driver
argument_list|,
name|tumbler_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|tumbler
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|tumbler
argument_list|,
name|iicbus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|kobj_method_t
name|tumbler_mixer_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|mixer_init
argument_list|,
name|tumbler_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_uninit
argument_list|,
name|tumbler_uninit
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_reinit
argument_list|,
name|tumbler_reinit
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_set
argument_list|,
name|tumbler_set
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_setrecsrc
argument_list|,
name|tumbler_setrecsrc
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MIXER_DECLARE
argument_list|(
name|tumbler_mixer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|TUMBLER_IICADDR
value|0x68
end_define

begin_comment
comment|/* Tumbler I2C slave address */
end_comment

begin_comment
comment|/* Tumbler (Texas Instruments TAS3001) registers. */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR
value|0x01
end_define

begin_comment
comment|/* Main control register (1byte) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_DRC
value|0x02
end_define

begin_comment
comment|/* Dynamic Range Compression (2bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_VOLUME
value|0x04
end_define

begin_comment
comment|/* Volume (6bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_TREBLE
value|0x05
end_define

begin_comment
comment|/* Treble control (1byte) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_BASS
value|0x06
end_define

begin_comment
comment|/* Bass control (1byte) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MIXER1
value|0x07
end_define

begin_comment
comment|/* Mixer1 (3bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MIXER2
value|0x08
end_define

begin_comment
comment|/* Mixer2 (3bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_LB0
value|0x0a
end_define

begin_comment
comment|/* Left biquad 0 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_LB1
value|0x0b
end_define

begin_comment
comment|/* Left biquad 1 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_LB2
value|0x0c
end_define

begin_comment
comment|/* Left biquad 2 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_LB3
value|0x0d
end_define

begin_comment
comment|/* Left biquad 3 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_LB4
value|0x0e
end_define

begin_comment
comment|/* Left biquad 4 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_LB5
value|0x0f
end_define

begin_comment
comment|/* Left biquad 5 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_RB0
value|0x13
end_define

begin_comment
comment|/* Right biquad 0 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_RB1
value|0x14
end_define

begin_comment
comment|/* Right biquad 1 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_RB2
value|0x15
end_define

begin_comment
comment|/* Right biquad 2 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_RB3
value|0x16
end_define

begin_comment
comment|/* Right biquad 3 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_RB4
value|0x17
end_define

begin_comment
comment|/* Right biquad 4 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_RB5
value|0x18
end_define

begin_comment
comment|/* Right biquad 5 (15bytes) */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_FL
value|0x80
end_define

begin_comment
comment|/* Fast load */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_SC
value|0x40
end_define

begin_comment
comment|/* SCLK frequency */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_SC_32
value|0x00
end_define

begin_comment
comment|/*  32fs */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_SC_64
value|0x40
end_define

begin_comment
comment|/*  64fs */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_SM
value|0x30
end_define

begin_comment
comment|/* Output serial port mode */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_SM_L
value|0x00
end_define

begin_comment
comment|/*  Left justified */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_SM_R
value|0x10
end_define

begin_comment
comment|/*  Right justified */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_SM_I2S
value|0x20
end_define

begin_comment
comment|/*  I2S */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_ISM
value|0x0C
end_define

begin_comment
comment|/* Input serial mode */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_ISM_L
value|0x00
end_define

begin_define
define|#
directive|define
name|TUMBLER_MCR_ISM_R
value|0x04
end_define

begin_define
define|#
directive|define
name|TUMBLER_MCR_ISM_I2S
value|0x08
end_define

begin_define
define|#
directive|define
name|TUMBLER_MCR_W
value|0x03
end_define

begin_comment
comment|/* Serial port word length */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_W_16
value|0x00
end_define

begin_comment
comment|/*  16 bit */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_W_18
value|0x01
end_define

begin_comment
comment|/*  18 bit */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_MCR_W_20
value|0x02
end_define

begin_comment
comment|/*  20 bit */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_DRC_COMP_31
value|0xc0
end_define

begin_comment
comment|/* 3:1 compression */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_DRC_ENABLE
value|0x01
end_define

begin_comment
comment|/* enable DRC */
end_comment

begin_define
define|#
directive|define
name|TUMBLER_DRC_DEFL_TH
value|0xa0
end_define

begin_comment
comment|/* default compression threshold */
end_comment

begin_comment
comment|/*  * Tumbler codec.  */
end_comment

begin_struct
struct|struct
name|tumbler_reg
block|{
name|u_char
name|MCR
index|[
literal|1
index|]
decl_stmt|;
name|u_char
name|DRC
index|[
literal|2
index|]
decl_stmt|;
name|u_char
name|VOLUME
index|[
literal|6
index|]
decl_stmt|;
name|u_char
name|TREBLE
index|[
literal|1
index|]
decl_stmt|;
name|u_char
name|BASS
index|[
literal|1
index|]
decl_stmt|;
name|u_char
name|MIXER1
index|[
literal|3
index|]
decl_stmt|;
name|u_char
name|MIXER2
index|[
literal|3
index|]
decl_stmt|;
name|u_char
name|LB0
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|LB1
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|LB2
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|LB3
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|LB4
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|LB5
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|RB0
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|RB1
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|RB2
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|RB3
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|RB4
index|[
literal|15
index|]
decl_stmt|;
name|u_char
name|RB5
index|[
literal|15
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|const
name|struct
name|tumbler_reg
name|tumbler_initdata
init|=
block|{
block|{
name|TUMBLER_MCR_SC_64
operator||
name|TUMBLER_MCR_SM_I2S
operator||
name|TUMBLER_MCR_ISM_I2S
operator||
name|TUMBLER_MCR_W_16
block|}
block|,
comment|/* MCR */
block|{
name|TUMBLER_DRC_COMP_31
block|,
name|TUMBLER_DRC_DEFL_TH
block|}
block|,
comment|/* DRC */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* VOLUME */
block|{
literal|0x72
block|}
block|,
comment|/* TREBLE */
block|{
literal|0x3e
block|}
block|,
comment|/* BASS */
block|{
literal|0x10
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* MIXER1 */
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
block|,
comment|/* MIXER2 */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* BIQUAD */
block|{
literal|0x10
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
comment|/* BIQUAD */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
name|tumbler_regsize
index|[]
init|=
block|{
literal|0
block|,
comment|/* 0x00 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|MCR
block|,
comment|/* 0x01 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|DRC
block|,
comment|/* 0x02 */
literal|0
block|,
comment|/* 0x03 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|VOLUME
block|,
comment|/* 0x04 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|TREBLE
block|,
comment|/* 0x05 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|BASS
block|,
comment|/* 0x06 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|MIXER1
block|,
comment|/* 0x07 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|MIXER2
block|,
comment|/* 0x08 */
literal|0
block|,
comment|/* 0x09 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|LB0
block|,
comment|/* 0x0a */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|LB1
block|,
comment|/* 0x0b */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|LB2
block|,
comment|/* 0x0c */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|LB3
block|,
comment|/* 0x0d */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|LB4
block|,
comment|/* 0x0e */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|LB5
block|,
comment|/* 0x0f */
literal|0
block|,
comment|/* 0x10 */
literal|0
block|,
comment|/* 0x11 */
literal|0
block|,
comment|/* 0x12 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|RB0
block|,
comment|/* 0x13 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|RB1
block|,
comment|/* 0x14 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|RB2
block|,
comment|/* 0x15 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|RB3
block|,
comment|/* 0x16 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|RB4
block|,
comment|/* 0x17 */
sizeof|sizeof
name|tumbler_initdata
operator|.
name|RB5
comment|/* 0x18 */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* dB = 20 * log (x) table. */
end_comment

begin_decl_stmt
specifier|static
name|u_int
name|tumbler_volume_table
index|[
literal|100
index|]
init|=
block|{
literal|0x00000148
block|,
literal|0x0000015C
block|,
literal|0x00000171
block|,
literal|0x00000186
block|,
comment|// -46.0,	-45.5,	-45.0,	-44.5,
literal|0x0000019E
block|,
literal|0x000001B6
block|,
literal|0x000001D0
block|,
literal|0x000001EB
block|,
comment|// -44.0,	-43.5,	-43.0,	-42.5,
literal|0x00000209
block|,
literal|0x00000227
block|,
literal|0x00000248
block|,
literal|0x0000026B
block|,
comment|// -42.0,	-41.5,	-41.0,	-40.5,
literal|0x0000028F
block|,
literal|0x000002B6
block|,
literal|0x000002DF
block|,
literal|0x0000030B
block|,
comment|// -40.0,	-39.5,	-39.0,	-38.5,
literal|0x00000339
block|,
literal|0x0000036A
block|,
literal|0x0000039E
block|,
literal|0x000003D5
block|,
comment|// -38.0,	-37.5,	-37.0,	-36.5,
literal|0x0000040F
block|,
literal|0x0000044C
block|,
literal|0x0000048D
block|,
literal|0x000004D2
block|,
comment|// -36.0,	-35.5,	-35.0,	-34.5,
literal|0x0000051C
block|,
literal|0x00000569
block|,
literal|0x000005BB
block|,
literal|0x00000612
block|,
comment|// -34.0,	-33.5,	-33.0,	-32.5,
literal|0x0000066E
block|,
literal|0x000006D0
block|,
literal|0x00000737
block|,
literal|0x000007A5
block|,
comment|// -32.0,	-31.5,	-31.0,	-30.5,
literal|0x00000818
block|,
literal|0x00000893
block|,
literal|0x00000915
block|,
literal|0x0000099F
block|,
comment|// -30.0,	-29.5,	-29.0,	-28.5,
literal|0x00000A31
block|,
literal|0x00000ACC
block|,
literal|0x00000B6F
block|,
literal|0x00000C1D
block|,
comment|// -28.0,	-27.5,	-27.0,	-26.5,
literal|0x00000CD5
block|,
literal|0x00000D97
block|,
literal|0x00000E65
block|,
literal|0x00000F40
block|,
comment|// -26.0,	-25.5,	-25.0,	-24.5,
literal|0x00001027
block|,
literal|0x0000111C
block|,
literal|0x00001220
block|,
literal|0x00001333
block|,
comment|// -24.0,	-23.5,	-23.0,	-22.5,
literal|0x00001456
block|,
literal|0x0000158A
block|,
literal|0x000016D1
block|,
literal|0x0000182B
block|,
comment|// -22.0,	-21.5,	-21.0,	-20.5,
literal|0x0000199A
block|,
literal|0x00001B1E
block|,
literal|0x00001CB9
block|,
literal|0x00001E6D
block|,
comment|// -20.0,	-19.5,	-19.0,	-18.5,
literal|0x0000203A
block|,
literal|0x00002223
block|,
literal|0x00002429
block|,
literal|0x0000264E
block|,
comment|// -18.0,	-17.5,	-17.0,	-16.5,
literal|0x00002893
block|,
literal|0x00002AFA
block|,
literal|0x00002D86
block|,
literal|0x00003039
block|,
comment|// -16.0,	-15.5,	-15.0,	-14.5,
literal|0x00003314
block|,
literal|0x0000361B
block|,
literal|0x00003950
block|,
literal|0x00003CB5
block|,
comment|// -14.0,	-13.5,	-13.0,	-12.5,
literal|0x0000404E
block|,
literal|0x0000441D
block|,
literal|0x00004827
block|,
literal|0x00004C6D
block|,
comment|// -12.0,	-11.5,	-11.0,	-10.5,
literal|0x000050F4
block|,
literal|0x000055C0
block|,
literal|0x00005AD5
block|,
literal|0x00006037
block|,
comment|// -10.0,	-9.5,	-9.0,	-8.5,
literal|0x000065EA
block|,
literal|0x00006BF4
block|,
literal|0x0000725A
block|,
literal|0x00007920
block|,
comment|// -8.0,	-7.5,	-7.0,	-6.5,
literal|0x0000804E
block|,
literal|0x000087EF
block|,
literal|0x00008FF6
block|,
literal|0x0000987D
block|,
comment|// -6.0,	-5.5,	-5.0,	-4.5,
literal|0x0000A186
block|,
literal|0x0000AB19
block|,
literal|0x0000B53C
block|,
literal|0x0000BFF9
block|,
comment|// -4.0,	-3.5,	-3.0,	-2.5,
literal|0x0000CB59
block|,
literal|0x0000D766
block|,
literal|0x0000E429
block|,
literal|0x0000F1AE
block|,
comment|// -2.0,	-1.5,	-1.0,	-0.5,
literal|0x00010000
block|,
literal|0x00010F2B
block|,
literal|0x00011F3D
block|,
literal|0x00013042
block|,
comment|// 0.0,   +0.5,	+1.0,	+1.5,
literal|0x00014249
block|,
literal|0x00015562
block|,
literal|0x0001699C
block|,
literal|0x00017F09
comment|// 2.0,   +2.5,	+3.0,	+3.5,
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|tumbler_write
parameter_list|(
name|struct
name|tumbler_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|reg
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|)
block|{
name|u_int
name|size
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_WR
block|,
literal|0
block|,
name|buf
block|}
block|}
decl_stmt|;
name|KASSERT
argument_list|(
name|reg
operator|<
sizeof|sizeof
argument_list|(
name|tumbler_regsize
argument_list|)
argument_list|,
operator|(
literal|"bad reg"
operator|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|tumbler_regsize
index|[
name|reg
index|]
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|len
operator|=
name|size
operator|+
literal|1
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|reg
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|buf
index|[
literal|1
index|]
argument_list|,
name|data
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tumbler_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|ofw_bus_get_name
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"deq"
argument_list|)
operator|==
literal|0
operator|&&
name|iicbus_get_addr
argument_list|(
name|dev
argument_list|)
operator|==
name|TUMBLER_IICADDR
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Texas Instruments TAS3001 Audio Codec"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tumbler_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tumbler_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_addr
operator|=
name|iicbus_get_addr
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|i2s_mixer_class
operator|=
operator|&
name|tumbler_mixer_class
expr_stmt|;
name|i2s_mixer
operator|=
name|dev
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tumbler_init
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|tumbler_softc
modifier|*
name|sc
decl_stmt|;
name|u_int
name|x
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_LB0
argument_list|,
name|tumbler_initdata
operator|.
name|LB0
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_LB1
argument_list|,
name|tumbler_initdata
operator|.
name|LB1
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_LB2
argument_list|,
name|tumbler_initdata
operator|.
name|LB2
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_LB3
argument_list|,
name|tumbler_initdata
operator|.
name|LB3
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_LB4
argument_list|,
name|tumbler_initdata
operator|.
name|LB4
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_LB5
argument_list|,
name|tumbler_initdata
operator|.
name|LB5
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_RB0
argument_list|,
name|tumbler_initdata
operator|.
name|RB0
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_RB1
argument_list|,
name|tumbler_initdata
operator|.
name|RB1
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_RB1
argument_list|,
name|tumbler_initdata
operator|.
name|RB1
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_RB2
argument_list|,
name|tumbler_initdata
operator|.
name|RB2
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_RB3
argument_list|,
name|tumbler_initdata
operator|.
name|RB3
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_RB4
argument_list|,
name|tumbler_initdata
operator|.
name|RB4
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_RB5
argument_list|,
name|tumbler_initdata
operator|.
name|RB5
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_MCR
argument_list|,
name|tumbler_initdata
operator|.
name|MCR
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_DRC
argument_list|,
name|tumbler_initdata
operator|.
name|DRC
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_VOLUME
argument_list|,
name|tumbler_initdata
operator|.
name|VOLUME
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_TREBLE
argument_list|,
name|tumbler_initdata
operator|.
name|TREBLE
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_BASS
argument_list|,
name|tumbler_initdata
operator|.
name|BASS
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_MIXER1
argument_list|,
name|tumbler_initdata
operator|.
name|MIXER1
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_MIXER2
argument_list|,
name|tumbler_initdata
operator|.
name|MIXER2
argument_list|)
expr_stmt|;
name|x
operator||=
name|SOUND_MASK_VOLUME
expr_stmt|;
name|mix_setdevs
argument_list|(
name|m
argument_list|,
name|x
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tumbler_uninit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|tumbler_reinit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tumbler_set
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|unsigned
name|dev
parameter_list|,
name|unsigned
name|left
parameter_list|,
name|unsigned
name|right
parameter_list|)
block|{
name|struct
name|tumbler_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mtx
modifier|*
name|mixer_lock
decl_stmt|;
name|int
name|locked
decl_stmt|;
name|u_int
name|l
decl_stmt|,
name|r
decl_stmt|;
name|u_char
name|reg
index|[
literal|6
index|]
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|mixer_lock
operator|=
name|mixer_get_lock
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|locked
operator|=
name|mtx_owned
argument_list|(
name|mixer_lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|dev
condition|)
block|{
case|case
name|SOUND_MIXER_VOLUME
case|:
if|if
condition|(
name|left
operator|>
literal|100
operator|||
name|right
operator|>
literal|100
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|l
operator|=
operator|(
name|left
operator|==
literal|0
condition|?
literal|0
else|:
name|tumbler_volume_table
index|[
name|left
operator|-
literal|1
index|]
operator|)
expr_stmt|;
name|r
operator|=
operator|(
name|right
operator|==
literal|0
condition|?
literal|0
else|:
name|tumbler_volume_table
index|[
name|right
operator|-
literal|1
index|]
operator|)
expr_stmt|;
name|reg
index|[
literal|0
index|]
operator|=
operator|(
name|l
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|reg
index|[
literal|1
index|]
operator|=
operator|(
name|l
operator|&
literal|0x00ff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|reg
index|[
literal|2
index|]
operator|=
name|l
operator|&
literal|0x0000ff
expr_stmt|;
name|reg
index|[
literal|3
index|]
operator|=
operator|(
name|r
operator|&
literal|0xff0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|reg
index|[
literal|4
index|]
operator|=
operator|(
name|r
operator|&
literal|0x00ff00
operator|)
operator|>>
literal|8
expr_stmt|;
name|reg
index|[
literal|5
index|]
operator|=
name|r
operator|&
literal|0x0000ff
expr_stmt|;
comment|/* 		 * We need to unlock the mixer lock because iicbus_transfer() 		 * may sleep. The mixer lock itself is unnecessary here 		 * because it is meant to serialize hardware access, which 		 * is taken care of by the I2C layer, so this is safe. 		 */
if|if
condition|(
name|locked
condition|)
name|mtx_unlock
argument_list|(
name|mixer_lock
argument_list|)
expr_stmt|;
name|tumbler_write
argument_list|(
name|sc
argument_list|,
name|TUMBLER_VOLUME
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|locked
condition|)
name|mtx_lock
argument_list|(
name|mixer_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|left
operator||
operator|(
name|right
operator|<<
literal|8
operator|)
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tumbler_setrecsrc
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|u_int32_t
name|src
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 Konstantin Dimitrov<kosio.dimitrov@gmail.com>  * Copyright (c) 2001 Katsurajima Naoto<raven@katsurajima.seya.yokohama.jp>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHERIN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/ac97.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pci/spicds.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pci/envy24ht.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|"mixer_if.h"
end_include

begin_expr_stmt
name|SND_DECLARE_FILE
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_ENVY24HT
argument_list|,
literal|"envy24ht"
argument_list|,
literal|"envy24ht audio"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_struct_decl
struct_decl|struct
name|sc_info
struct_decl|;
end_struct_decl

begin_define
define|#
directive|define
name|ENVY24HT_PLAY_CHNUM
value|8
end_define

begin_define
define|#
directive|define
name|ENVY24HT_REC_CHNUM
value|2
end_define

begin_define
define|#
directive|define
name|ENVY24HT_PLAY_BUFUNIT
value|(4
comment|/* byte/sample */
value|* 8
comment|/* channel */
value|)
end_define

begin_define
define|#
directive|define
name|ENVY24HT_REC_BUFUNIT
value|(4
comment|/* byte/sample */
value|* 2
comment|/* channel */
value|)
end_define

begin_define
define|#
directive|define
name|ENVY24HT_SAMPLE_NUM
value|4096
end_define

begin_define
define|#
directive|define
name|ENVY24HT_TIMEOUT
value|1000
end_define

begin_define
define|#
directive|define
name|ENVY24HT_DEFAULT_FORMAT
value|(AFMT_STEREO | AFMT_S16_LE)
end_define

begin_define
define|#
directive|define
name|ENVY24HT_NAMELEN
value|32
end_define

begin_struct
struct|struct
name|envy24ht_sample
block|{
specifier|volatile
name|u_int32_t
name|buffer
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|envy24ht_sample
name|sample32_t
typedef|;
end_typedef

begin_comment
comment|/* channel registers */
end_comment

begin_struct
struct|struct
name|sc_chinfo
block|{
name|struct
name|snd_dbuf
modifier|*
name|buffer
decl_stmt|;
name|struct
name|pcm_channel
modifier|*
name|channel
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|parent
decl_stmt|;
name|int
name|dir
decl_stmt|;
name|unsigned
name|num
decl_stmt|;
comment|/* hw channel number */
comment|/* channel information */
name|u_int32_t
name|format
decl_stmt|;
name|u_int32_t
name|speed
decl_stmt|;
name|u_int32_t
name|blk
decl_stmt|;
comment|/* hw block size(dword) */
comment|/* format conversion structure */
name|u_int8_t
modifier|*
name|data
decl_stmt|;
name|unsigned
name|int
name|size
decl_stmt|;
comment|/* data buffer size(byte) */
name|int
name|unit
decl_stmt|;
comment|/* sample size(byte) */
name|unsigned
name|int
name|offset
decl_stmt|;
comment|/* samples number offset */
name|void
function_decl|(
modifier|*
name|emldma
function_decl|)
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
parameter_list|)
function_decl|;
comment|/* flags */
name|int
name|run
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* codec interface entrys */
end_comment

begin_struct
struct|struct
name|codec_entry
block|{
name|void
modifier|*
function_decl|(
modifier|*
name|create
function_decl|)
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|int
name|dir
parameter_list|,
name|int
name|num
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|destroy
function_decl|)
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|init
function_decl|)
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|reinit
function_decl|)
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|setvolume
function_decl|)
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|,
name|int
name|dir
parameter_list|,
name|unsigned
name|int
name|left
parameter_list|,
name|unsigned
name|int
name|right
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|setrate
function_decl|)
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|,
name|int
name|which
parameter_list|,
name|int
name|rate
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_comment
comment|/* system configuration information */
end_comment

begin_struct
struct|struct
name|cfg_info
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|u_int16_t
name|subvendor
decl_stmt|,
name|subdevice
decl_stmt|;
name|u_int8_t
name|scfg
decl_stmt|,
name|acl
decl_stmt|,
name|i2s
decl_stmt|,
name|spdif
decl_stmt|;
name|u_int32_t
name|gpiomask
decl_stmt|,
name|gpiostate
decl_stmt|,
name|gpiodir
decl_stmt|;
name|u_int32_t
name|cdti
decl_stmt|,
name|cclk
decl_stmt|,
name|cs
decl_stmt|;
name|u_int8_t
name|cif
decl_stmt|,
name|type
decl_stmt|,
name|free
decl_stmt|;
name|struct
name|codec_entry
modifier|*
name|codec
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* device private data */
end_comment

begin_struct
struct|struct
name|sc_info
block|{
name|device_t
name|dev
decl_stmt|;
name|void
modifier|*
name|lock
decl_stmt|;
comment|/* Control/Status registor */
name|struct
name|resource
modifier|*
name|cs
decl_stmt|;
name|int
name|csid
decl_stmt|;
name|bus_space_tag_t
name|cst
decl_stmt|;
name|bus_space_handle_t
name|csh
decl_stmt|;
comment|/* MultiTrack registor */
name|struct
name|resource
modifier|*
name|mt
decl_stmt|;
name|int
name|mtid
decl_stmt|;
name|bus_space_tag_t
name|mtt
decl_stmt|;
name|bus_space_handle_t
name|mth
decl_stmt|;
comment|/* DMA tag */
name|bus_dma_tag_t
name|dmat
decl_stmt|;
comment|/* IRQ resource */
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
name|int
name|irqid
decl_stmt|;
name|void
modifier|*
name|ih
decl_stmt|;
comment|/* system configuration data */
name|struct
name|cfg_info
modifier|*
name|cfg
decl_stmt|;
comment|/* ADC/DAC number and info */
name|int
name|adcn
decl_stmt|,
name|dacn
decl_stmt|;
name|void
modifier|*
name|adc
index|[
literal|4
index|]
decl_stmt|,
modifier|*
name|dac
index|[
literal|4
index|]
decl_stmt|;
comment|/* mixer control data */
name|u_int32_t
name|src
decl_stmt|;
name|u_int8_t
name|left
index|[
name|ENVY24HT_CHAN_NUM
index|]
decl_stmt|;
name|u_int8_t
name|right
index|[
name|ENVY24HT_CHAN_NUM
index|]
decl_stmt|;
comment|/* Play/Record DMA fifo */
name|sample32_t
modifier|*
name|pbuf
decl_stmt|;
name|sample32_t
modifier|*
name|rbuf
decl_stmt|;
name|u_int32_t
name|psize
decl_stmt|,
name|rsize
decl_stmt|;
comment|/* DMA buffer size(byte) */
name|u_int16_t
name|blk
index|[
literal|2
index|]
decl_stmt|;
comment|/* transfer check blocksize(dword) */
name|bus_dmamap_t
name|pmap
decl_stmt|,
name|rmap
decl_stmt|;
comment|/* current status */
name|u_int32_t
name|speed
decl_stmt|;
name|int
name|run
index|[
literal|2
index|]
decl_stmt|;
name|u_int16_t
name|intr
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|pcmchan_caps
name|caps
index|[
literal|2
index|]
decl_stmt|;
comment|/* channel info table */
name|unsigned
name|chnum
decl_stmt|;
name|struct
name|sc_chinfo
name|chan
index|[
literal|11
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * prototypes  */
end_comment

begin_comment
comment|/* DMA emulator */
end_comment

begin_function_decl
specifier|static
name|void
name|envy24ht_p8u
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_p16sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_p32sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_r16sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_r32sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* channel interface */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|envy24htchan_init
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
parameter_list|,
name|struct
name|pcm_channel
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htchan_setformat
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htchan_setspeed
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htchan_setblocksize
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htchan_trigger
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htchan_getptr
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|envy24htchan_getcaps
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* mixer interface */
end_comment

begin_function_decl
specifier|static
name|int
name|envy24htmixer_init
parameter_list|(
name|struct
name|snd_mixer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htmixer_reinit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htmixer_uninit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|envy24htmixer_set
parameter_list|(
name|struct
name|snd_mixer
modifier|*
parameter_list|,
name|unsigned
parameter_list|,
name|unsigned
parameter_list|,
name|unsigned
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int32_t
name|envy24htmixer_setrecsrc
parameter_list|(
name|struct
name|snd_mixer
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* SPI codec access interface */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|envy24ht_spi_create
parameter_list|(
name|device_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_spi_destroy
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_spi_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_spi_reinit
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|envy24ht_spi_setvolume
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|,
name|unsigned
name|int
parameter_list|,
name|unsigned
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*   system constant tables */
end_comment

begin_comment
comment|/* API -> hardware channel map */
end_comment

begin_decl_stmt
specifier|static
name|unsigned
name|envy24ht_chanmap
index|[
name|ENVY24HT_CHAN_NUM
index|]
init|=
block|{
name|ENVY24HT_CHAN_PLAY_DAC1
block|,
comment|/* 1 */
name|ENVY24HT_CHAN_PLAY_DAC2
block|,
comment|/* 2 */
name|ENVY24HT_CHAN_PLAY_DAC3
block|,
comment|/* 3 */
name|ENVY24HT_CHAN_PLAY_DAC4
block|,
comment|/* 4 */
name|ENVY24HT_CHAN_PLAY_SPDIF
block|,
comment|/* 0 */
name|ENVY24HT_CHAN_REC_MIX
block|,
comment|/* 5 */
name|ENVY24HT_CHAN_REC_SPDIF
block|,
comment|/* 6 */
name|ENVY24HT_CHAN_REC_ADC1
block|,
comment|/* 7 */
name|ENVY24HT_CHAN_REC_ADC2
block|,
comment|/* 8 */
name|ENVY24HT_CHAN_REC_ADC3
block|,
comment|/* 9 */
name|ENVY24HT_CHAN_REC_ADC4
block|,
comment|/* 10 */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* mixer -> API channel map. see above */
end_comment

begin_decl_stmt
specifier|static
name|int
name|envy24ht_mixmap
index|[]
init|=
block|{
operator|-
literal|1
block|,
comment|/* Master output level. It is depend on codec support */
operator|-
literal|1
block|,
comment|/* Treble level of all output channels */
operator|-
literal|1
block|,
comment|/* Bass level of all output channels */
operator|-
literal|1
block|,
comment|/* Volume of synthesier input */
literal|0
block|,
comment|/* Output level for the audio device */
operator|-
literal|1
block|,
comment|/* Output level for the PC speaker */
literal|7
block|,
comment|/* line in jack */
operator|-
literal|1
block|,
comment|/* microphone jack */
operator|-
literal|1
block|,
comment|/* CD audio input */
operator|-
literal|1
block|,
comment|/* Recording monitor */
literal|1
block|,
comment|/* alternative codec */
operator|-
literal|1
block|,
comment|/* global recording level */
operator|-
literal|1
block|,
comment|/* Input gain */
operator|-
literal|1
block|,
comment|/* Output gain */
literal|8
block|,
comment|/* Input source 1 */
literal|9
block|,
comment|/* Input source 2 */
literal|10
block|,
comment|/* Input source 3 */
literal|6
block|,
comment|/* Digital (input) 1 */
operator|-
literal|1
block|,
comment|/* Digital (input) 2 */
operator|-
literal|1
block|,
comment|/* Digital (input) 3 */
operator|-
literal|1
block|,
comment|/* Phone input */
operator|-
literal|1
block|,
comment|/* Phone output */
operator|-
literal|1
block|,
comment|/* Video/TV (audio) in */
operator|-
literal|1
block|,
comment|/* Radio in */
operator|-
literal|1
block|,
comment|/* Monitor volume */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* variable rate audio */
end_comment

begin_decl_stmt
specifier|static
name|u_int32_t
name|envy24ht_speed
index|[]
init|=
block|{
literal|96000
block|,
literal|88200
block|,
literal|64000
block|,
literal|48000
block|,
literal|44100
block|,
literal|32000
block|,
literal|24000
block|,
literal|22050
block|,
literal|16000
block|,
literal|12000
block|,
literal|11025
block|,
literal|9600
block|,
literal|8000
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* known boards configuration */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|codec_entry
name|spi_codec
init|=
block|{
name|envy24ht_spi_create
block|,
name|envy24ht_spi_destroy
block|,
name|envy24ht_spi_init
block|,
name|envy24ht_spi_reinit
block|,
name|envy24ht_spi_setvolume
block|,
name|NULL
block|,
comment|/* setrate */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cfg_info
name|cfg_table
index|[]
init|=
block|{
block|{
literal|"Envy24HT audio (Terratec Aureon 7.1 Space)"
block|,
literal|0x153b
block|,
literal|0x1145
block|,
literal|0x0b
block|,
literal|0x80
block|,
literal|0xfc
block|,
literal|0xc3
block|,
literal|0x21efff
block|,
literal|0x7fffff
block|,
literal|0x5e1000
block|,
literal|0x40000
block|,
literal|0x80000
block|,
literal|0x1000
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0
block|,
operator|&
name|spi_codec
block|, 	}
block|,
block|{
literal|"Envy24HT audio (Terratec Aureon 5.1 Sky)"
block|,
literal|0x153b
block|,
literal|0x1147
block|,
literal|0x0a
block|,
literal|0x80
block|,
literal|0xfc
block|,
literal|0xc3
block|,
literal|0x21efff
block|,
literal|0x7fffff
block|,
literal|0x5e1000
block|,
literal|0x40000
block|,
literal|0x80000
block|,
literal|0x1000
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24HT audio (Terratec Aureon 7.1 Universe)"
block|,
literal|0x153b
block|,
literal|0x1153
block|,
literal|0x0b
block|,
literal|0x80
block|,
literal|0xfc
block|,
literal|0xc3
block|,
literal|0x21efff
block|,
literal|0x7fffff
block|,
literal|0x5e1000
block|,
literal|0x40000
block|,
literal|0x80000
block|,
literal|0x1000
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24HT audio (AudioTrak Prodigy 7.1)"
block|,
literal|0x4933
block|,
literal|0x4553
block|,
literal|0x0b
block|,
literal|0x80
block|,
literal|0xfc
block|,
literal|0xc3
block|,
literal|0x21efff
block|,
literal|0x7fffff
block|,
literal|0x5e1000
block|,
literal|0x40000
block|,
literal|0x80000
block|,
literal|0x1000
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24HT audio (Terratec PHASE 28)"
block|,
literal|0x153b
block|,
literal|0x1149
block|,
literal|0x0b
block|,
literal|0x80
block|,
literal|0xfc
block|,
literal|0xc3
block|,
literal|0x21efff
block|,
literal|0x7fffff
block|,
literal|0x5e1000
block|,
literal|0x40000
block|,
literal|0x80000
block|,
literal|0x1000
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24HT-S audio (Terratec PHASE 22)"
block|,
literal|0x153b
block|,
literal|0x1150
block|,
literal|0x10
block|,
literal|0x80
block|,
literal|0xf0
block|,
literal|0xc3
block|,
literal|0x7ffbc7
block|,
literal|0x7fffff
block|,
literal|0x438
block|,
literal|0x20
block|,
literal|0x10
block|,
literal|0x400
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24HT audio (AudioTrak Prodigy 7.1 LT)"
block|,
literal|0x3132
block|,
literal|0x4154
block|,
literal|0x0b
block|,
literal|0x80
block|,
literal|0xfc
block|,
literal|0xc3
block|,
literal|0x7ff8ff
block|,
literal|0x7fffff
block|,
literal|0x700
block|,
literal|0x400
block|,
literal|0x200
block|,
literal|0x100
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,          }
block|,
block|{
literal|"Envy24HT audio (M-Audio Revolution 7.1)"
block|,
literal|0x1412
block|,
literal|0x3630
block|,
literal|0x43
block|,
literal|0x80
block|,
literal|0xf8
block|,
literal|0xc1
block|,
literal|0x3fff85
block|,
literal|0x72
block|,
literal|0x4000fa
block|,
literal|0x08
block|,
literal|0x02
block|,
literal|0x20
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24GT audio (M-Audio Revolution 5.1)"
block|,
literal|0x1412
block|,
literal|0x3631
block|,
literal|0x42
block|,
literal|0x80
block|,
literal|0xf8
block|,
literal|0xc1
block|,
literal|0x3fff85
block|,
literal|0x72
block|,
literal|0x4000fa
block|,
literal|0x08
block|,
literal|0x02
block|,
literal|0x20
block|,
literal|0x00
block|,
literal|0x03
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24HT audio (M-Audio Audiophile 192)"
block|,
literal|0x1412
block|,
literal|0x3632
block|,
literal|0x68
block|,
literal|0x80
block|,
literal|0xf8
block|,
literal|0xc3
block|,
literal|0x45
block|,
literal|0x4000b5
block|,
literal|0x7fffba
block|,
literal|0x08
block|,
literal|0x02
block|,
literal|0x10
block|,
literal|0x00
block|,
literal|0x03
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,         }
block|,
block|{
literal|"Envy24HT audio (Generic)"
block|,
literal|0
block|,
literal|0
block|,
literal|0x0b
block|,
literal|0x80
block|,
literal|0xfc
block|,
literal|0xc3
block|,
literal|0x21efff
block|,
literal|0x7fffff
block|,
literal|0x5e1000
block|,
literal|0x40000
block|,
literal|0x80000
block|,
literal|0x1000
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0
block|,
operator|&
name|spi_codec
block|,
comment|/* default codec routines */
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|envy24ht_recfmt
index|[]
init|=
block|{
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_S32_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|envy24ht_reccaps
init|=
block|{
literal|8000
block|,
literal|96000
block|,
name|envy24ht_recfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|envy24ht_playfmt
index|[]
init|=
block|{
name|AFMT_STEREO
operator||
name|AFMT_U8
block|,
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_S32_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|envy24ht_playcaps
init|=
block|{
literal|8000
block|,
literal|96000
block|,
name|envy24ht_playfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|envy24ht_emldma
block|{
name|u_int32_t
name|format
decl_stmt|;
name|void
function_decl|(
modifier|*
name|emldma
function_decl|)
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
parameter_list|)
function_decl|;
name|int
name|unit
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|envy24ht_emldma
name|envy24ht_pemltab
index|[]
init|=
block|{
block|{
name|AFMT_STEREO
operator||
name|AFMT_U8
block|,
name|envy24ht_p8u
block|,
literal|2
block|}
block|,
block|{
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
name|envy24ht_p16sl
block|,
literal|4
block|}
block|,
block|{
name|AFMT_STEREO
operator||
name|AFMT_S32_LE
block|,
name|envy24ht_p32sl
block|,
literal|8
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|envy24ht_emldma
name|envy24ht_remltab
index|[]
init|=
block|{
block|{
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
name|envy24ht_r16sl
block|,
literal|4
block|}
block|,
block|{
name|AFMT_STEREO
operator||
name|AFMT_S32_LE
block|,
name|envy24ht_r32sl
block|,
literal|8
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* common routines */
end_comment

begin_function
specifier|static
name|u_int32_t
name|envy24ht_rdcs
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
return|return
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|cst
argument_list|,
name|sc
operator|->
name|csh
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|2
case|:
return|return
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|cst
argument_list|,
name|sc
operator|->
name|csh
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|4
case|:
return|return
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|cst
argument_list|,
name|sc
operator|->
name|csh
argument_list|,
name|regno
argument_list|)
return|;
default|default:
return|return
literal|0xffffffff
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_wrcs
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|cst
argument_list|,
name|sc
operator|->
name|csh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|cst
argument_list|,
name|sc
operator|->
name|csh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|cst
argument_list|,
name|sc
operator|->
name|csh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|envy24ht_rdmt
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
return|return
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|mtt
argument_list|,
name|sc
operator|->
name|mth
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|2
case|:
return|return
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|mtt
argument_list|,
name|sc
operator|->
name|mth
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|4
case|:
return|return
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|mtt
argument_list|,
name|sc
operator|->
name|mth
argument_list|,
name|regno
argument_list|)
return|;
default|default:
return|return
literal|0xffffffff
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_wrmt
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|mtt
argument_list|,
name|sc
operator|->
name|mth
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|mtt
argument_list|,
name|sc
operator|->
name|mth
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|mtt
argument_list|,
name|sc
operator|->
name|mth
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* I2C port/E2PROM access routines */
end_comment

begin_function
specifier|static
name|int
name|envy24ht_rdi2c
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|dev
parameter_list|,
name|u_int32_t
name|addr
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rdi2c(sc, 0x%02x, 0x%02x)\n"
argument_list|,
name|dev
argument_list|,
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ENVY24HT_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2CSTAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
name|ENVY24HT_CCS_I2CSTAT_BSY
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|32
argument_list|)
expr_stmt|;
comment|/* 31.25kHz */
block|}
if|if
condition|(
name|i
operator|==
name|ENVY24HT_TIMEOUT
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2CADDR
argument_list|,
name|addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2CDEV
argument_list|,
operator|(
name|dev
operator|&
name|ENVY24HT_CCS_I2CDEV_ADDR
operator|)
operator||
name|ENVY24HT_CCS_I2CDEV_RD
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ENVY24HT_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2CSTAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
name|ENVY24HT_CCS_I2CSTAT_BSY
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|32
argument_list|)
expr_stmt|;
comment|/* 31.25kHz */
block|}
if|if
condition|(
name|i
operator|==
name|ENVY24HT_TIMEOUT
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|data
operator|=
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2CDATA
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rdi2c(): return 0x%x\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|int
operator|)
name|data
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_if
unit|static int envy24ht_wri2c(struct sc_info *sc, u_int32_t dev, u_int32_t addr, u_int32_t data) { 	u_int32_t tmp; 	int i;
if|#
directive|if
operator|(
literal|0
operator|)
end_if

begin_endif
unit|device_printf(sc->dev, "envy24ht_rdi2c(sc, 0x%02x, 0x%02x)\n", dev, addr);
endif|#
directive|endif
end_endif

begin_comment
unit|for (i = 0; i< ENVY24HT_TIMEOUT; i++) { 		tmp = envy24ht_rdcs(sc, ENVY24HT_CCS_I2CSTAT, 1); 		if ((tmp& ENVY24HT_CCS_I2CSTAT_BSY) == 0) 			break; 		DELAY(32);
comment|/* 31.25kHz */
end_comment

begin_comment
unit|} 	if (i == ENVY24HT_TIMEOUT) { 		return -1; 	} 	envy24ht_wrcs(sc, ENVY24HT_CCS_I2CADDR, addr, 1); 	envy24ht_wrcs(sc, ENVY24HT_CCS_I2CDATA, data, 1); 	envy24ht_wrcs(sc, ENVY24HT_CCS_I2CDEV, 	    (dev& ENVY24HT_CCS_I2CDEV_ADDR) | ENVY24HT_CCS_I2CDEV_WR, 1); 	for (i = 0; i< ENVY24HT_TIMEOUT; i++) { 		data = envy24ht_rdcs(sc, ENVY24HT_CCS_I2CSTAT, 1); 		if ((data& ENVY24HT_CCS_I2CSTAT_BSY) == 0) 			break; 		DELAY(32);
comment|/* 31.25kHz */
end_comment

begin_endif
unit|} 	if (i == ENVY24HT_TIMEOUT) { 		return -1; 	}  	return 0; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|envy24ht_rdrom
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|addr
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rdrom(sc, 0x%02x)\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|data
operator|=
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2CSTAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
name|ENVY24HT_CCS_I2CSTAT_ROM
operator|)
operator|==
literal|0
condition|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rdrom(): E2PROM not presented\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|-
literal|1
return|;
block|}
return|return
name|envy24ht_rdi2c
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2CDEV_ROM
argument_list|,
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|cfg_info
modifier|*
name|envy24ht_rom2cfg
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|cfg_info
modifier|*
name|buff
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rom2cfg(sc)\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|size
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|<
name|ENVY24HT_E2PROM_GPIOSTATE
operator|+
literal|3
condition|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rom2cfg(): ENVY24HT_E2PROM_SIZE-->%d\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|buff
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|buff
argument_list|)
argument_list|,
name|M_ENVY24HT
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff
operator|==
name|NULL
condition|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rom2cfg(): malloc()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|NULL
return|;
block|}
name|buff
operator|->
name|free
operator|=
literal|1
expr_stmt|;
comment|/* no valid e2prom, using default values */
name|buff
operator|->
name|subvendor
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBVENDOR
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|buff
operator|->
name|subvendor
operator|+=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBVENDOR
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buff
operator|->
name|subdevice
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBDEVICE
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|buff
operator|->
name|subdevice
operator|+=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBDEVICE
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buff
operator|->
name|scfg
operator|=
literal|0x0b
expr_stmt|;
name|buff
operator|->
name|acl
operator|=
literal|0x80
expr_stmt|;
name|buff
operator|->
name|i2s
operator|=
literal|0xfc
expr_stmt|;
name|buff
operator|->
name|spdif
operator|=
literal|0xc3
expr_stmt|;
name|buff
operator|->
name|gpiomask
operator|=
literal|0x21efff
expr_stmt|;
name|buff
operator|->
name|gpiostate
operator|=
literal|0x7fffff
expr_stmt|;
name|buff
operator|->
name|gpiodir
operator|=
literal|0x5e1000
expr_stmt|;
name|buff
operator|->
name|cdti
operator|=
literal|0x40000
expr_stmt|;
name|buff
operator|->
name|cclk
operator|=
literal|0x80000
expr_stmt|;
name|buff
operator|->
name|cs
operator|=
literal|0x1000
expr_stmt|;
name|buff
operator|->
name|cif
operator|=
literal|0x00
expr_stmt|;
name|buff
operator|->
name|type
operator|=
literal|0x02
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|!=
literal|0
operator|||
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|==
name|buff
operator|->
name|subvendor
operator|&&
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
operator|==
name|buff
operator|->
name|subdevice
condition|)
break|break;
name|buff
operator|->
name|name
operator|=
name|cfg_table
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
name|buff
operator|->
name|codec
operator|=
name|cfg_table
index|[
name|i
index|]
operator|.
name|codec
expr_stmt|;
return|return
name|buff
return|;
if|#
directive|if
literal|0
block|return NULL;
endif|#
directive|endif
block|}
name|buff
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|buff
argument_list|)
argument_list|,
name|M_ENVY24HT
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff
operator|==
name|NULL
condition|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_rom2cfg(): malloc()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|NULL
return|;
block|}
name|buff
operator|->
name|free
operator|=
literal|1
expr_stmt|;
name|buff
operator|->
name|subvendor
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBVENDOR
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|buff
operator|->
name|subvendor
operator|+=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBVENDOR
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buff
operator|->
name|subdevice
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBDEVICE
argument_list|)
operator|<<
literal|8
expr_stmt|;
name|buff
operator|->
name|subdevice
operator|+=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SUBDEVICE
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buff
operator|->
name|scfg
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SCFG
argument_list|)
expr_stmt|;
name|buff
operator|->
name|acl
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_ACL
argument_list|)
expr_stmt|;
name|buff
operator|->
name|i2s
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_I2S
argument_list|)
expr_stmt|;
name|buff
operator|->
name|spdif
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_SPDIF
argument_list|)
expr_stmt|;
name|buff
operator|->
name|gpiomask
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIOMASK
argument_list|)
operator||
expr|\
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIOMASK
operator|+
literal|1
argument_list|)
operator|<<
literal|8
operator||
expr|\
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIOMASK
operator|+
literal|2
argument_list|)
operator|<<
literal|16
expr_stmt|;
name|buff
operator|->
name|gpiostate
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIOSTATE
argument_list|)
operator||
expr|\
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIOSTATE
operator|+
literal|1
argument_list|)
operator|<<
literal|8
operator||
expr|\
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIOSTATE
operator|+
literal|2
argument_list|)
operator|<<
literal|16
expr_stmt|;
name|buff
operator|->
name|gpiodir
operator|=
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIODIR
argument_list|)
operator||
expr|\
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIODIR
operator|+
literal|1
argument_list|)
operator|<<
literal|8
operator||
expr|\
name|envy24ht_rdrom
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_E2PROM_GPIODIR
operator|+
literal|2
argument_list|)
operator|<<
literal|16
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|!=
literal|0
operator|||
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|==
name|buff
operator|->
name|subvendor
operator|&&
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
operator|==
name|buff
operator|->
name|subdevice
condition|)
break|break;
name|buff
operator|->
name|name
operator|=
name|cfg_table
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
name|buff
operator|->
name|codec
operator|=
name|cfg_table
index|[
name|i
index|]
operator|.
name|codec
expr_stmt|;
return|return
name|buff
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_cfgfree
parameter_list|(
name|struct
name|cfg_info
modifier|*
name|cfg
parameter_list|)
block|{
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|cfg
operator|->
name|free
condition|)
name|free
argument_list|(
name|cfg
argument_list|,
name|M_ENVY24HT
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* AC'97 codec access routines */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_if
unit|static int envy24ht_coldcd(struct sc_info *sc) { 	u_int32_t data; 	int i;
if|#
directive|if
operator|(
literal|0
operator|)
end_if

begin_endif
unit|device_printf(sc->dev, "envy24ht_coldcd()\n");
endif|#
directive|endif
end_endif

begin_if
unit|envy24ht_wrmt(sc, ENVY24HT_MT_AC97CMD, ENVY24HT_MT_AC97CMD_CLD, 1); 	DELAY(10); 	envy24ht_wrmt(sc, ENVY24HT_MT_AC97CMD, 0, 1); 	DELAY(1000); 	for (i = 0; i< ENVY24HT_TIMEOUT; i++) { 		data = envy24ht_rdmt(sc, ENVY24HT_MT_AC97CMD, 1); 		if (data& ENVY24HT_MT_AC97CMD_RDY) { 			return 0; 		} 	}  	return -1; }  static int envy24ht_slavecd(struct sc_info *sc) { 	u_int32_t data; 	int i;
if|#
directive|if
operator|(
literal|0
operator|)
end_if

begin_endif
unit|device_printf(sc->dev, "envy24ht_slavecd()\n");
endif|#
directive|endif
end_endif

begin_if
unit|envy24ht_wrmt(sc, ENVY24HT_MT_AC97CMD, 	    ENVY24HT_MT_AC97CMD_CLD | ENVY24HT_MT_AC97CMD_WRM, 1); 	DELAY(10); 	envy24ht_wrmt(sc, ENVY24HT_MT_AC97CMD, 0, 1); 	DELAY(1000); 	for (i = 0; i< ENVY24HT_TIMEOUT; i++) { 		data = envy24ht_rdmt(sc, ENVY24HT_MT_AC97CMD, 1); 		if (data& ENVY24HT_MT_AC97CMD_RDY) { 			return 0; 		} 	}  	return -1; }  static int envy24ht_rdcd(kobj_t obj, void *devinfo, int regno) { 	struct sc_info *sc = (struct sc_info *)devinfo; 	u_int32_t data; 	int i;
if|#
directive|if
operator|(
literal|0
operator|)
end_if

begin_endif
unit|device_printf(sc->dev, "envy24ht_rdcd(obj, sc, 0x%02x)\n", regno);
endif|#
directive|endif
end_endif

begin_if
unit|envy24ht_wrmt(sc, ENVY24HT_MT_AC97IDX, (u_int32_t)regno, 1); 	envy24ht_wrmt(sc, ENVY24HT_MT_AC97CMD, ENVY24HT_MT_AC97CMD_RD, 1); 	for (i = 0; i< ENVY24HT_TIMEOUT; i++) { 		data = envy24ht_rdmt(sc, ENVY24HT_MT_AC97CMD, 1); 		if ((data& ENVY24HT_MT_AC97CMD_RD) == 0) 			break; 	} 	data = envy24ht_rdmt(sc, ENVY24HT_MT_AC97DLO, 2);
if|#
directive|if
operator|(
literal|0
operator|)
end_if

begin_endif
unit|device_printf(sc->dev, "envy24ht_rdcd(): return 0x%x\n", data);
endif|#
directive|endif
end_endif

begin_if
unit|return (int)data; }  static int envy24ht_wrcd(kobj_t obj, void *devinfo, int regno, u_int16_t data) { 	struct sc_info *sc = (struct sc_info *)devinfo; 	u_int32_t cmd; 	int i;
if|#
directive|if
operator|(
literal|0
operator|)
end_if

begin_endif
unit|device_printf(sc->dev, "envy24ht_wrcd(obj, sc, 0x%02x, 0x%04x)\n", regno, data);
endif|#
directive|endif
end_endif

begin_endif
unit|envy24ht_wrmt(sc, ENVY24HT_MT_AC97IDX, (u_int32_t)regno, 1); 	envy24ht_wrmt(sc, ENVY24HT_MT_AC97DLO, (u_int32_t)data, 2); 	envy24ht_wrmt(sc, ENVY24HT_MT_AC97CMD, ENVY24HT_MT_AC97CMD_WR, 1); 	for (i = 0; i< ENVY24HT_TIMEOUT; i++) { 		cmd = envy24ht_rdmt(sc, ENVY24HT_MT_AC97CMD, 1); 		if ((cmd& ENVY24HT_MT_AC97CMD_WR) == 0) 			break; 	}  	return 0; }  static kobj_method_t envy24ht_ac97_methods[] = { 	KOBJMETHOD(ac97_read,	envy24ht_rdcd), 	KOBJMETHOD(ac97_write,	envy24ht_wrcd), 	{0, 0} }; AC97_DECLARE(envy24ht_ac97);
endif|#
directive|endif
end_endif

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* GPIO access routines */
end_comment

begin_function
specifier|static
name|u_int32_t
name|envy24ht_gpiord
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|subvendor
operator|==
literal|0x153b
operator|&&
name|sc
operator|->
name|cfg
operator|->
name|subdevice
operator|==
literal|0x1150
condition|)
return|return
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_LDATA
argument_list|,
literal|2
argument_list|)
return|;
else|else
return|return
operator|(
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_HDATA
argument_list|,
literal|1
argument_list|)
operator|<<
literal|16
operator||
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_LDATA
argument_list|,
literal|2
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_gpiowr
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|data
parameter_list|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_gpiowr(sc, 0x%02x)\n"
argument_list|,
name|data
operator|&
literal|0x7FFFFF
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_LDATA
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|subdevice
operator|!=
literal|0x1150
condition|)
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_HDATA
argument_list|,
name|data
operator|>>
literal|16
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static u_int32_t envy24ht_gpiogetmask(struct sc_info *sc) { 	return (envy24ht_rdcs(sc, ENVY24HT_CCS_GPIO_HMASK, 1)<< 16 | envy24ht_rdcs(sc, ENVY24HT_CCS_GPIO_LMASK, 2)); }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|envy24ht_gpiosetmask
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|mask
parameter_list|)
block|{
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_LMASK
argument_list|,
name|mask
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|subdevice
operator|!=
literal|0x1150
condition|)
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_HMASK
argument_list|,
name|mask
operator|>>
literal|16
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static u_int32_t envy24ht_gpiogetdir(struct sc_info *sc) { 	return envy24ht_rdcs(sc, ENVY24HT_CCS_GPIO_CTLDIR, 4; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|envy24ht_gpiosetdir
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|dir
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|subvendor
operator|==
literal|0x153b
operator|&&
name|sc
operator|->
name|cfg
operator|->
name|subdevice
operator|==
literal|0x1150
condition|)
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_CTLDIR
argument_list|,
name|dir
argument_list|,
literal|2
argument_list|)
expr_stmt|;
else|else
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_GPIO_CTLDIR
argument_list|,
name|dir
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* SPI codec access interface routine */
end_comment

begin_struct
struct|struct
name|envy24ht_spi_codec
block|{
name|struct
name|spicds_info
modifier|*
name|info
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|parent
decl_stmt|;
name|int
name|dir
decl_stmt|;
name|int
name|num
decl_stmt|;
name|int
name|cs
decl_stmt|,
name|cclk
decl_stmt|,
name|cdti
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|envy24ht_spi_ctl
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|,
name|unsigned
name|int
name|cs
parameter_list|,
name|unsigned
name|int
name|cclk
parameter_list|,
name|unsigned
name|int
name|cdti
parameter_list|)
block|{
name|u_int32_t
name|data
init|=
literal|0
decl_stmt|;
name|struct
name|envy24ht_spi_codec
modifier|*
name|ptr
init|=
name|codec
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ptr
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"--> %d, %d, %d\n"
argument_list|,
name|cs
argument_list|,
name|cclk
argument_list|,
name|cdti
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|data
operator|=
name|envy24ht_gpiord
argument_list|(
name|ptr
operator|->
name|parent
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
operator|(
name|ptr
operator|->
name|cs
operator||
name|ptr
operator|->
name|cclk
operator||
name|ptr
operator|->
name|cdti
operator|)
expr_stmt|;
if|if
condition|(
name|cs
condition|)
name|data
operator|+=
name|ptr
operator|->
name|cs
expr_stmt|;
if|if
condition|(
name|cclk
condition|)
name|data
operator|+=
name|ptr
operator|->
name|cclk
expr_stmt|;
if|if
condition|(
name|cdti
condition|)
name|data
operator|+=
name|ptr
operator|->
name|cdti
expr_stmt|;
name|envy24ht_gpiowr
argument_list|(
name|ptr
operator|->
name|parent
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|envy24ht_spi_create
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|info
parameter_list|,
name|int
name|dir
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|info
decl_stmt|;
name|struct
name|envy24ht_spi_codec
modifier|*
name|buff
init|=
name|NULL
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_spi_create(dev, sc, %d, %d)\n"
argument_list|,
name|dir
argument_list|,
name|num
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|buff
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|buff
argument_list|)
argument_list|,
name|M_ENVY24HT
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|dir
operator|==
name|PCMDIR_REC
operator|&&
name|sc
operator|->
name|adc
index|[
name|num
index|]
operator|!=
name|NULL
condition|)
name|buff
operator|->
name|info
operator|=
operator|(
operator|(
expr|struct
name|envy24ht_spi_codec
operator|*
operator|)
name|sc
operator|->
name|adc
index|[
name|num
index|]
operator|)
operator|->
name|info
expr_stmt|;
elseif|else
if|if
condition|(
name|dir
operator|==
name|PCMDIR_PLAY
operator|&&
name|sc
operator|->
name|dac
index|[
name|num
index|]
operator|!=
name|NULL
condition|)
name|buff
operator|->
name|info
operator|=
operator|(
operator|(
expr|struct
name|envy24ht_spi_codec
operator|*
operator|)
name|sc
operator|->
name|dac
index|[
name|num
index|]
operator|)
operator|->
name|info
expr_stmt|;
else|else
name|buff
operator|->
name|info
operator|=
name|spicds_create
argument_list|(
name|dev
argument_list|,
name|buff
argument_list|,
name|num
argument_list|,
name|envy24ht_spi_ctl
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff
operator|->
name|info
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|buff
argument_list|,
name|M_ENVY24HT
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|buff
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|buff
operator|->
name|dir
operator|=
name|dir
expr_stmt|;
name|buff
operator|->
name|num
operator|=
name|num
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
name|buff
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_spi_destroy
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|)
block|{
name|struct
name|envy24ht_spi_codec
modifier|*
name|ptr
init|=
name|codec
decl_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ptr
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24ht_spi_destroy()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ptr
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
block|{
if|if
condition|(
name|ptr
operator|->
name|parent
operator|->
name|dac
index|[
name|ptr
operator|->
name|num
index|]
operator|!=
name|NULL
condition|)
name|spicds_destroy
argument_list|(
name|ptr
operator|->
name|info
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ptr
operator|->
name|parent
operator|->
name|adc
index|[
name|ptr
operator|->
name|num
index|]
operator|!=
name|NULL
condition|)
name|spicds_destroy
argument_list|(
name|ptr
operator|->
name|info
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|codec
argument_list|,
name|M_ENVY24HT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_spi_init
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|)
block|{
name|struct
name|envy24ht_spi_codec
modifier|*
name|ptr
init|=
name|codec
decl_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ptr
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24ht_spicds_init()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ptr
operator|->
name|cs
operator|=
name|ptr
operator|->
name|parent
operator|->
name|cfg
operator|->
name|cs
expr_stmt|;
name|ptr
operator|->
name|cclk
operator|=
name|ptr
operator|->
name|parent
operator|->
name|cfg
operator|->
name|cclk
expr_stmt|;
name|ptr
operator|->
name|cdti
operator|=
name|ptr
operator|->
name|parent
operator|->
name|cfg
operator|->
name|cdti
expr_stmt|;
name|spicds_settype
argument_list|(
name|ptr
operator|->
name|info
argument_list|,
name|ptr
operator|->
name|parent
operator|->
name|cfg
operator|->
name|type
argument_list|)
expr_stmt|;
name|spicds_setcif
argument_list|(
name|ptr
operator|->
name|info
argument_list|,
name|ptr
operator|->
name|parent
operator|->
name|cfg
operator|->
name|cif
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|->
name|parent
operator|->
name|cfg
operator|->
name|type
operator|==
name|SPICDS_TYPE_AK4524
operator|||
expr|\
name|ptr
operator|->
name|parent
operator|->
name|cfg
operator|->
name|type
operator|==
name|SPICDS_TYPE_AK4528
condition|)
block|{
name|spicds_setformat
argument_list|(
name|ptr
operator|->
name|info
argument_list|,
name|AK452X_FORMAT_I2S
operator||
name|AK452X_FORMAT_256FSN
operator||
name|AK452X_FORMAT_1X
argument_list|)
expr_stmt|;
name|spicds_setdvc
argument_list|(
name|ptr
operator|->
name|info
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* for the time being, init only first codec */
if|if
condition|(
name|ptr
operator|->
name|num
operator|==
literal|0
condition|)
name|spicds_init
argument_list|(
name|ptr
operator|->
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_spi_reinit
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|)
block|{
name|struct
name|envy24ht_spi_codec
modifier|*
name|ptr
init|=
name|codec
decl_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ptr
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24ht_spi_reinit()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|spicds_reinit
argument_list|(
name|ptr
operator|->
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|envy24ht_spi_setvolume
parameter_list|(
name|void
modifier|*
name|codec
parameter_list|,
name|int
name|dir
parameter_list|,
name|unsigned
name|int
name|left
parameter_list|,
name|unsigned
name|int
name|right
parameter_list|)
block|{
name|struct
name|envy24ht_spi_codec
modifier|*
name|ptr
init|=
name|codec
decl_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ptr
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24ht_spi_set()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|spicds_set
argument_list|(
name|ptr
operator|->
name|info
argument_list|,
name|dir
argument_list|,
name|left
argument_list|,
name|right
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* hardware access routeines */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|u_int32_t
name|speed
decl_stmt|;
name|u_int32_t
name|code
decl_stmt|;
block|}
name|envy24ht_speedtab
index|[]
init|=
block|{
block|{
literal|48000
block|,
name|ENVY24HT_MT_RATE_48000
block|}
block|,
block|{
literal|24000
block|,
name|ENVY24HT_MT_RATE_24000
block|}
block|,
block|{
literal|12000
block|,
name|ENVY24HT_MT_RATE_12000
block|}
block|,
block|{
literal|9600
block|,
name|ENVY24HT_MT_RATE_9600
block|}
block|,
block|{
literal|32000
block|,
name|ENVY24HT_MT_RATE_32000
block|}
block|,
block|{
literal|16000
block|,
name|ENVY24HT_MT_RATE_16000
block|}
block|,
block|{
literal|8000
block|,
name|ENVY24HT_MT_RATE_8000
block|}
block|,
block|{
literal|96000
block|,
name|ENVY24HT_MT_RATE_96000
block|}
block|,
block|{
literal|64000
block|,
name|ENVY24HT_MT_RATE_64000
block|}
block|,
block|{
literal|44100
block|,
name|ENVY24HT_MT_RATE_44100
block|}
block|,
block|{
literal|22050
block|,
name|ENVY24HT_MT_RATE_22050
block|}
block|,
block|{
literal|11025
block|,
name|ENVY24HT_MT_RATE_11025
block|}
block|,
block|{
literal|88200
block|,
name|ENVY24HT_MT_RATE_88200
block|}
block|,
block|{
literal|0
block|,
literal|0x10
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|envy24ht_setspeed
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|u_int32_t
name|code
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_setspeed(sc, %d)\n"
argument_list|,
name|speed
argument_list|)
expr_stmt|;
if|if
condition|(
name|speed
operator|==
literal|0
condition|)
block|{
name|code
operator|=
name|ENVY24HT_MT_RATE_SPDIF
expr_stmt|;
comment|/* external master clock */
name|envy24ht_slavecd
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|envy24ht_speedtab
index|[
name|i
index|]
operator|.
name|speed
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|envy24ht_speedtab
index|[
name|i
index|]
operator|.
name|speed
operator|==
name|speed
condition|)
break|break;
block|}
name|code
operator|=
name|envy24ht_speedtab
index|[
name|i
index|]
operator|.
name|code
expr_stmt|;
if|#
directive|if
literal|0
block|} 	device_printf(sc->dev, "envy24ht_setspeed(): speed %d/code 0x%04x\n", envy24ht_speedtab[i].speed, code);
endif|#
directive|endif
if|if
condition|(
name|code
operator|<
literal|0x10
condition|)
block|{
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_RATE
argument_list|,
name|code
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|code
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_RATE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|code
operator|&=
name|ENVY24HT_MT_RATE_MASK
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|envy24ht_speedtab
index|[
name|i
index|]
operator|.
name|code
operator|<
literal|0x10
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|envy24ht_speedtab
index|[
name|i
index|]
operator|.
name|code
operator|==
name|code
condition|)
break|break;
block|}
name|speed
operator|=
name|envy24ht_speedtab
index|[
name|i
index|]
operator|.
name|speed
expr_stmt|;
block|}
else|else
name|speed
operator|=
literal|0
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_setspeed(): return %d\n"
argument_list|,
name|speed
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|speed
return|;
block|}
specifier|static
name|void
name|envy24ht_setvolume
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|unsigned
name|ch
parameter_list|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_setvolume(sc, %d)\n"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_VOLIDX
argument_list|,
name|ch
operator|*
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_VOLUME
argument_list|,
literal|0x7f00
operator||
name|sc
operator|->
name|left
index|[
name|ch
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_VOLIDX
argument_list|,
name|ch
operator|*
literal|2
operator|+
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_VOLUME
argument_list|,
operator|(
name|sc
operator|->
name|right
index|[
name|ch
index|]
operator|<<
literal|8
operator|)
operator||
literal|0x7f
argument_list|,
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
specifier|static
name|void
name|envy24ht_mutevolume
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|unsigned
name|ch
parameter_list|)
block|{
if|#
directive|if
literal|0
block|u_int32_t vol;  	device_printf(sc->dev, "envy24ht_mutevolume(sc, %d)\n", ch); 	vol = ENVY24HT_VOL_MUTE<< 8 | ENVY24HT_VOL_MUTE; 	envy24ht_wrmt(sc, ENVY24HT_MT_VOLIDX, ch * 2, 1); 	envy24ht_wrmt(sc, ENVY24HT_MT_VOLUME, vol, 2); 	envy24ht_wrmt(sc, ENVY24HT_MT_VOLIDX, ch * 2 + 1, 1); 	envy24ht_wrmt(sc, ENVY24HT_MT_VOLUME, vol, 2);
endif|#
directive|endif
block|}
specifier|static
name|u_int32_t
name|envy24ht_gethwptr
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|regno
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|,
name|rtn
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_gethwptr(sc, %d)\n"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
block|{
name|rtn
operator|=
name|sc
operator|->
name|psize
operator|/
literal|4
expr_stmt|;
name|unit
operator|=
name|ENVY24HT_PLAY_BUFUNIT
operator|/
literal|4
expr_stmt|;
name|regno
operator|=
name|ENVY24HT_MT_PCNT
expr_stmt|;
block|}
else|else
block|{
name|rtn
operator|=
name|sc
operator|->
name|rsize
operator|/
literal|4
expr_stmt|;
name|unit
operator|=
name|ENVY24HT_REC_BUFUNIT
operator|/
literal|4
expr_stmt|;
name|regno
operator|=
name|ENVY24HT_MT_RCNT
expr_stmt|;
block|}
name|ptr
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|regno
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rtn
operator|-=
operator|(
name|ptr
operator|+
literal|1
operator|)
expr_stmt|;
name|rtn
operator|/=
name|unit
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_gethwptr(): return %d\n"
argument_list|,
name|rtn
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|rtn
return|;
block|}
specifier|static
name|void
name|envy24ht_updintr
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|int
name|regptr
decl_stmt|,
name|regintr
decl_stmt|;
name|u_int32_t
name|mask
decl_stmt|,
name|intr
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|,
name|size
decl_stmt|,
name|cnt
decl_stmt|;
name|u_int16_t
name|blk
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_updintr(sc, %d)\n"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
block|{
name|blk
operator|=
name|sc
operator|->
name|blk
index|[
literal|0
index|]
expr_stmt|;
name|size
operator|=
name|sc
operator|->
name|psize
operator|/
literal|4
expr_stmt|;
name|regptr
operator|=
name|ENVY24HT_MT_PCNT
expr_stmt|;
name|regintr
operator|=
name|ENVY24HT_MT_PTERM
expr_stmt|;
name|mask
operator|=
operator|~
name|ENVY24HT_MT_INT_PMASK
expr_stmt|;
block|}
else|else
block|{
name|blk
operator|=
name|sc
operator|->
name|blk
index|[
literal|1
index|]
expr_stmt|;
name|size
operator|=
name|sc
operator|->
name|rsize
operator|/
literal|4
expr_stmt|;
name|regptr
operator|=
name|ENVY24HT_MT_RCNT
expr_stmt|;
name|regintr
operator|=
name|ENVY24HT_MT_RTERM
expr_stmt|;
name|mask
operator|=
operator|~
name|ENVY24HT_MT_INT_RMASK
expr_stmt|;
block|}
name|ptr
operator|=
name|size
operator|-
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|regptr
argument_list|,
literal|2
argument_list|)
operator|-
literal|1
expr_stmt|;
comment|/* 	cnt = blk - ptr % blk - 1; 	if (cnt == 0) 		cnt = blk - 1; 	*/
name|cnt
operator|=
name|blk
operator|-
literal|1
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_updintr():ptr = %d, blk = %d, cnt = %d\n"
argument_list|,
name|ptr
argument_list|,
name|blk
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|regintr
argument_list|,
name|cnt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|intr
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_MASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_updintr():intr = 0x%02x, mask = 0x%02x\n"
argument_list|,
name|intr
argument_list|,
name|mask
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_MASK
argument_list|,
name|intr
operator|&
name|mask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_updintr():INT-->0x%02x\n"
argument_list|,
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_MASK
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|#
directive|if
literal|0
block|static void envy24ht_maskintr(struct sc_info *sc, int dir) { 	u_int32_t mask, intr;
if|#
directive|if
operator|(
literal|0
operator|)
block|device_printf(sc->dev, "envy24ht_maskintr(sc, %d)\n", dir);
endif|#
directive|endif
block|if (dir == PCMDIR_PLAY) 		mask = ENVY24HT_MT_INT_PMASK; 	else 		mask = ENVY24HT_MT_INT_RMASK; 	intr = envy24ht_rdmt(sc, ENVY24HT_MT_INT, 1); 	envy24ht_wrmt(sc, ENVY24HT_MT_INT, intr | mask, 1);  	return; }
endif|#
directive|endif
specifier|static
name|int
name|envy24ht_checkintr
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|u_int32_t
name|mask
decl_stmt|,
name|stat
decl_stmt|,
name|intr
decl_stmt|,
name|rtn
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_checkintr(sc, %d)\n"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|intr
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_STAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
block|{
if|if
condition|(
operator|(
name|rtn
operator|=
name|intr
operator|&
name|ENVY24HT_MT_INT_PSTAT
operator|)
operator|!=
literal|0
condition|)
block|{
name|mask
operator|=
operator|~
name|ENVY24HT_MT_INT_RSTAT
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
literal|0x1a
argument_list|,
literal|0x01
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_STAT
argument_list|,
operator|(
name|intr
operator|&
name|mask
operator|)
operator||
name|ENVY24HT_MT_INT_PSTAT
operator||
literal|0x08
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stat
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_MASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_MASK
argument_list|,
name|stat
operator||
name|ENVY24HT_MT_INT_PMASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rtn
operator|=
name|intr
operator|&
name|ENVY24HT_MT_INT_RSTAT
operator|)
operator|!=
literal|0
condition|)
block|{
name|mask
operator|=
operator|~
name|ENVY24HT_MT_INT_PSTAT
expr_stmt|;
if|#
directive|if
literal|0
block|stat = ENVY24HT_MT_INT_RSTAT | ENVY24HT_MT_INT_RMASK;
endif|#
directive|endif
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_STAT
argument_list|,
operator|(
name|intr
operator|&
name|mask
operator|)
operator||
name|ENVY24HT_MT_INT_RSTAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|stat
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_MASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_INT_MASK
argument_list|,
name|stat
operator||
name|ENVY24HT_MT_INT_RMASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|rtn
return|;
block|}
specifier|static
name|void
name|envy24ht_start
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|u_int32_t
name|stat
decl_stmt|,
name|sw
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_start(sc, %d)\n"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|sw
operator|=
name|ENVY24HT_MT_PCTL_PSTART
expr_stmt|;
else|else
name|sw
operator|=
name|ENVY24HT_MT_PCTL_RSTART
expr_stmt|;
name|stat
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCTL
argument_list|,
name|stat
operator||
name|sw
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"PADDR:0x%08x\n"
argument_list|,
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PADDR
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"PCNT:%ld\n"
argument_list|,
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCNT
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
specifier|static
name|void
name|envy24ht_stop
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|u_int32_t
name|stat
decl_stmt|,
name|sw
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_stop(sc, %d)\n"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|sw
operator|=
operator|~
name|ENVY24HT_MT_PCTL_PSTART
expr_stmt|;
else|else
name|sw
operator|=
operator|~
name|ENVY24HT_MT_PCTL_RSTART
expr_stmt|;
name|stat
operator|=
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCTL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCTL
argument_list|,
name|stat
operator|&
name|sw
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
literal|0
block|static int envy24ht_route(struct sc_info *sc, int dac, int class, int adc, int rev) { 	return 0; }
endif|#
directive|endif
comment|/* -------------------------------------------------------------------- */
comment|/* buffer copy routines */
specifier|static
name|void
name|envy24ht_p32sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|sample32_t
modifier|*
name|dmabuf
decl_stmt|;
name|u_int32_t
modifier|*
name|data
decl_stmt|;
name|int
name|src
decl_stmt|,
name|dst
decl_stmt|,
name|ssize
decl_stmt|,
name|dsize
decl_stmt|,
name|slot
decl_stmt|;
name|int
name|i
decl_stmt|;
name|length
operator|=
name|sndbuf_getready
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|8
expr_stmt|;
name|dmabuf
operator|=
name|ch
operator|->
name|parent
operator|->
name|pbuf
expr_stmt|;
name|data
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|ch
operator|->
name|data
expr_stmt|;
name|src
operator|=
name|sndbuf_getreadyptr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|4
expr_stmt|;
name|dst
operator|=
name|src
operator|/
literal|2
operator|+
name|ch
operator|->
name|offset
expr_stmt|;
name|ssize
operator|=
name|ch
operator|->
name|size
operator|/
literal|4
expr_stmt|;
name|dsize
operator|=
name|ch
operator|->
name|size
operator|/
literal|8
expr_stmt|;
name|slot
operator|=
name|ch
operator|->
name|num
operator|*
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
index|]
operator|.
name|buffer
operator|=
name|data
index|[
name|src
index|]
expr_stmt|;
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
operator|+
literal|1
index|]
operator|.
name|buffer
operator|=
name|data
index|[
name|src
operator|+
literal|1
index|]
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|dst
operator|%=
name|dsize
expr_stmt|;
name|src
operator|+=
literal|2
expr_stmt|;
name|src
operator|%=
name|ssize
expr_stmt|;
block|}
return|return;
block|}
specifier|static
name|void
name|envy24ht_p16sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|sample32_t
modifier|*
name|dmabuf
decl_stmt|;
name|u_int16_t
modifier|*
name|data
decl_stmt|;
name|int
name|src
decl_stmt|,
name|dst
decl_stmt|,
name|ssize
decl_stmt|,
name|dsize
decl_stmt|,
name|slot
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24ht_p16sl()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|length
operator|=
name|sndbuf_getready
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|4
expr_stmt|;
name|dmabuf
operator|=
name|ch
operator|->
name|parent
operator|->
name|pbuf
expr_stmt|;
name|data
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|ch
operator|->
name|data
expr_stmt|;
name|src
operator|=
name|sndbuf_getreadyptr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|2
expr_stmt|;
name|dst
operator|=
name|src
operator|/
literal|2
operator|+
name|ch
operator|->
name|offset
expr_stmt|;
name|ssize
operator|=
name|ch
operator|->
name|size
operator|/
literal|2
expr_stmt|;
name|dsize
operator|=
name|ch
operator|->
name|size
operator|/
literal|4
expr_stmt|;
name|slot
operator|=
name|ch
operator|->
name|num
operator|*
literal|2
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24ht_p16sl():%lu-->%lu(%lu)\n"
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
name|length
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
index|]
operator|.
name|buffer
operator|=
operator|(
name|u_int32_t
operator|)
name|data
index|[
name|src
index|]
operator|<<
literal|16
expr_stmt|;
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
operator|+
literal|1
index|]
operator|.
name|buffer
operator|=
operator|(
name|u_int32_t
operator|)
name|data
index|[
name|src
operator|+
literal|1
index|]
operator|<<
literal|16
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
if|if
condition|(
name|i
operator|<
literal|16
condition|)
block|{
name|printf
argument_list|(
literal|"%08x"
argument_list|,
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%08x"
argument_list|,
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|dst
operator|++
expr_stmt|;
name|dst
operator|%=
name|dsize
expr_stmt|;
name|src
operator|+=
literal|2
expr_stmt|;
name|src
operator|%=
name|ssize
expr_stmt|;
block|}
if|#
directive|if
operator|(
literal|0
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
specifier|static
name|void
name|envy24ht_p8u
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|sample32_t
modifier|*
name|dmabuf
decl_stmt|;
name|u_int8_t
modifier|*
name|data
decl_stmt|;
name|int
name|src
decl_stmt|,
name|dst
decl_stmt|,
name|ssize
decl_stmt|,
name|dsize
decl_stmt|,
name|slot
decl_stmt|;
name|int
name|i
decl_stmt|;
name|length
operator|=
name|sndbuf_getready
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|2
expr_stmt|;
name|dmabuf
operator|=
name|ch
operator|->
name|parent
operator|->
name|pbuf
expr_stmt|;
name|data
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|ch
operator|->
name|data
expr_stmt|;
name|src
operator|=
name|sndbuf_getreadyptr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|dst
operator|=
name|src
operator|/
literal|2
operator|+
name|ch
operator|->
name|offset
expr_stmt|;
name|ssize
operator|=
name|ch
operator|->
name|size
expr_stmt|;
name|dsize
operator|=
name|ch
operator|->
name|size
operator|/
literal|4
expr_stmt|;
name|slot
operator|=
name|ch
operator|->
name|num
operator|*
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
index|]
operator|.
name|buffer
operator|=
operator|(
operator|(
name|u_int32_t
operator|)
name|data
index|[
name|src
index|]
operator|^
literal|0x80
operator|)
operator|<<
literal|24
expr_stmt|;
name|dmabuf
index|[
name|dst
operator|*
name|ENVY24HT_PLAY_CHNUM
operator|+
name|slot
operator|+
literal|1
index|]
operator|.
name|buffer
operator|=
operator|(
operator|(
name|u_int32_t
operator|)
name|data
index|[
name|src
operator|+
literal|1
index|]
operator|^
literal|0x80
operator|)
operator|<<
literal|24
expr_stmt|;
name|dst
operator|++
expr_stmt|;
name|dst
operator|%=
name|dsize
expr_stmt|;
name|src
operator|+=
literal|2
expr_stmt|;
name|src
operator|%=
name|ssize
expr_stmt|;
block|}
return|return;
block|}
specifier|static
name|void
name|envy24ht_r32sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|sample32_t
modifier|*
name|dmabuf
decl_stmt|;
name|u_int32_t
modifier|*
name|data
decl_stmt|;
name|int
name|src
decl_stmt|,
name|dst
decl_stmt|,
name|ssize
decl_stmt|,
name|dsize
decl_stmt|,
name|slot
decl_stmt|;
name|int
name|i
decl_stmt|;
name|length
operator|=
name|sndbuf_getfree
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|8
expr_stmt|;
name|dmabuf
operator|=
name|ch
operator|->
name|parent
operator|->
name|rbuf
expr_stmt|;
name|data
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
name|ch
operator|->
name|data
expr_stmt|;
name|dst
operator|=
name|sndbuf_getfreeptr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|4
expr_stmt|;
name|src
operator|=
name|dst
operator|/
literal|2
operator|+
name|ch
operator|->
name|offset
expr_stmt|;
name|dsize
operator|=
name|ch
operator|->
name|size
operator|/
literal|4
expr_stmt|;
name|ssize
operator|=
name|ch
operator|->
name|size
operator|/
literal|8
expr_stmt|;
name|slot
operator|=
operator|(
name|ch
operator|->
name|num
operator|-
name|ENVY24HT_CHAN_REC_ADC1
operator|)
operator|*
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|data
index|[
name|dst
index|]
operator|=
name|dmabuf
index|[
name|src
operator|*
name|ENVY24HT_REC_CHNUM
operator|+
name|slot
index|]
operator|.
name|buffer
expr_stmt|;
name|data
index|[
name|dst
operator|+
literal|1
index|]
operator|=
name|dmabuf
index|[
name|src
operator|*
name|ENVY24HT_REC_CHNUM
operator|+
name|slot
operator|+
literal|1
index|]
operator|.
name|buffer
expr_stmt|;
name|dst
operator|+=
literal|2
expr_stmt|;
name|dst
operator|%=
name|dsize
expr_stmt|;
name|src
operator|++
expr_stmt|;
name|src
operator|%=
name|ssize
expr_stmt|;
block|}
return|return;
block|}
specifier|static
name|void
name|envy24ht_r16sl
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|sample32_t
modifier|*
name|dmabuf
decl_stmt|;
name|u_int16_t
modifier|*
name|data
decl_stmt|;
name|int
name|src
decl_stmt|,
name|dst
decl_stmt|,
name|ssize
decl_stmt|,
name|dsize
decl_stmt|,
name|slot
decl_stmt|;
name|int
name|i
decl_stmt|;
name|length
operator|=
name|sndbuf_getfree
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|4
expr_stmt|;
name|dmabuf
operator|=
name|ch
operator|->
name|parent
operator|->
name|rbuf
expr_stmt|;
name|data
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|ch
operator|->
name|data
expr_stmt|;
name|dst
operator|=
name|sndbuf_getfreeptr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
literal|2
expr_stmt|;
name|src
operator|=
name|dst
operator|/
literal|2
operator|+
name|ch
operator|->
name|offset
expr_stmt|;
name|dsize
operator|=
name|ch
operator|->
name|size
operator|/
literal|2
expr_stmt|;
name|ssize
operator|=
name|ch
operator|->
name|size
operator|/
literal|8
expr_stmt|;
name|slot
operator|=
operator|(
name|ch
operator|->
name|num
operator|-
name|ENVY24HT_CHAN_REC_ADC1
operator|)
operator|*
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
name|data
index|[
name|dst
index|]
operator|=
name|dmabuf
index|[
name|src
operator|*
name|ENVY24HT_REC_CHNUM
operator|+
name|slot
index|]
operator|.
name|buffer
expr_stmt|;
name|data
index|[
name|dst
operator|+
literal|1
index|]
operator|=
name|dmabuf
index|[
name|src
operator|*
name|ENVY24HT_REC_CHNUM
operator|+
name|slot
operator|+
literal|1
index|]
operator|.
name|buffer
expr_stmt|;
name|dst
operator|+=
literal|2
expr_stmt|;
name|dst
operator|%=
name|dsize
expr_stmt|;
name|src
operator|++
expr_stmt|;
name|src
operator|%=
name|ssize
expr_stmt|;
block|}
return|return;
block|}
comment|/* -------------------------------------------------------------------- */
comment|/* channel interface */
specifier|static
name|void
modifier|*
name|envy24htchan_init
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|struct
name|sc_chinfo
modifier|*
name|ch
decl_stmt|;
name|unsigned
name|num
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_init(obj, devinfo, b, c, %d)\n"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if ((sc->chnum> ENVY24HT_CHAN_PLAY_SPDIF&& dir != PCMDIR_REC) || 	    (sc->chnum< ENVY24HT_CHAN_REC_ADC1&& dir != PCMDIR_PLAY)) { 		snd_mtxunlock(sc->lock); 		return NULL; 	}
endif|#
directive|endif
name|num
operator|=
name|sc
operator|->
name|chnum
expr_stmt|;
name|ch
operator|=
operator|&
name|sc
operator|->
name|chan
index|[
name|num
index|]
expr_stmt|;
name|ch
operator|->
name|size
operator|=
literal|8
operator|*
name|ENVY24HT_SAMPLE_NUM
expr_stmt|;
name|ch
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|ch
operator|->
name|size
argument_list|,
name|M_ENVY24HT
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|ch
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|ch
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|ch
operator|->
name|dir
operator|=
name|dir
expr_stmt|;
comment|/* set channel map */
name|ch
operator|->
name|num
operator|=
name|envy24ht_chanmap
index|[
name|num
index|]
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|sndbuf_setup
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|ch
operator|->
name|data
argument_list|,
name|ch
operator|->
name|size
argument_list|)
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* these 2 values are dummy */
name|ch
operator|->
name|unit
operator|=
literal|4
expr_stmt|;
name|ch
operator|->
name|blk
operator|=
literal|10240
expr_stmt|;
block|}
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ch
return|;
block|}
specifier|static
name|int
name|envy24htchan_free
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_free()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|data
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ch
operator|->
name|data
argument_list|,
name|M_ENVY24HT
argument_list|)
expr_stmt|;
name|ch
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
block|}
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
specifier|static
name|int
name|envy24htchan_setformat
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|struct
name|envy24ht_emldma
modifier|*
name|emltab
decl_stmt|;
comment|/* unsigned int bcnt, bsize; */
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_setformat(obj, data, 0x%08x)\n"
argument_list|,
name|format
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* check and get format related information */
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|emltab
operator|=
name|envy24ht_pemltab
expr_stmt|;
else|else
name|emltab
operator|=
name|envy24ht_remltab
expr_stmt|;
if|if
condition|(
name|emltab
operator|==
name|NULL
condition|)
block|{
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|emltab
index|[
name|i
index|]
operator|.
name|format
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|emltab
index|[
name|i
index|]
operator|.
name|format
operator|==
name|format
condition|)
break|break;
if|if
condition|(
name|emltab
index|[
name|i
index|]
operator|.
name|format
operator|==
literal|0
condition|)
block|{
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* set format information */
name|ch
operator|->
name|format
operator|=
name|format
expr_stmt|;
name|ch
operator|->
name|emldma
operator|=
name|emltab
index|[
name|i
index|]
operator|.
name|emldma
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|unit
operator|>
name|emltab
index|[
name|i
index|]
operator|.
name|unit
condition|)
name|ch
operator|->
name|blk
operator|*=
name|ch
operator|->
name|unit
operator|/
name|emltab
index|[
name|i
index|]
operator|.
name|unit
expr_stmt|;
else|else
name|ch
operator|->
name|blk
operator|/=
name|emltab
index|[
name|i
index|]
operator|.
name|unit
operator|/
name|ch
operator|->
name|unit
expr_stmt|;
name|ch
operator|->
name|unit
operator|=
name|emltab
index|[
name|i
index|]
operator|.
name|unit
expr_stmt|;
comment|/* set channel buffer information */
name|ch
operator|->
name|size
operator|=
name|ch
operator|->
name|unit
operator|*
name|ENVY24HT_SAMPLE_NUM
expr_stmt|;
if|#
directive|if
literal|0
block|if (ch->dir == PCMDIR_PLAY) 		bsize = ch->blk * 4 / ENVY24HT_PLAY_BUFUNIT; 	else 		bsize = ch->blk * 4 / ENVY24HT_REC_BUFUNIT; 	bsize *= ch->unit; 	bcnt = ch->size / bsize; 	sndbuf_resize(ch->buffer, bcnt, bsize);
endif|#
directive|endif
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_setformat(): return 0x%08x\n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
comment|/*   IMPLEMENT NOTICE: In this driver, setspeed function only do setting   of speed information value. And real hardware speed setting is done   at start triggered(see envy24htchan_trigger()). So, at this function   is called, any value that ENVY24 can use is able to set. But, at   start triggerd, some other channel is running, and that channel's   speed isn't same with, then trigger function will fail. */
specifier|static
name|int
name|envy24htchan_setspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|u_int32_t
name|val
decl_stmt|,
name|prev
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24htchan_setspeed(obj, data, %d)\n"
argument_list|,
name|speed
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|prev
operator|=
literal|0x7fffffff
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|val
operator|=
name|envy24ht_speed
index|[
name|i
index|]
operator|)
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|abs
argument_list|(
name|val
operator|-
name|speed
argument_list|)
operator|<
name|abs
argument_list|(
name|prev
operator|-
name|speed
argument_list|)
condition|)
name|prev
operator|=
name|val
expr_stmt|;
else|else
break|break;
block|}
name|ch
operator|->
name|speed
operator|=
name|prev
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"envy24htchan_setspeed(): return %d\n"
argument_list|,
name|ch
operator|->
name|speed
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ch
operator|->
name|speed
return|;
block|}
specifier|static
name|int
name|envy24htchan_setblocksize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
comment|/* struct sc_info *sc = ch->parent; */
name|u_int32_t
name|size
decl_stmt|,
name|prev
decl_stmt|;
name|unsigned
name|int
name|bcnt
decl_stmt|,
name|bsize
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_setblocksize(obj, data, %d)\n"
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|prev
operator|=
literal|0x7fffffff
expr_stmt|;
comment|/* snd_mtxlock(sc->lock); */
for|for
control|(
name|size
operator|=
name|ch
operator|->
name|size
operator|/
literal|2
init|;
name|size
operator|>
literal|0
condition|;
name|size
operator|/=
literal|2
control|)
block|{
if|if
condition|(
name|abs
argument_list|(
name|size
operator|-
name|blocksize
argument_list|)
operator|<
name|abs
argument_list|(
name|prev
operator|-
name|blocksize
argument_list|)
condition|)
name|prev
operator|=
name|size
expr_stmt|;
else|else
break|break;
block|}
name|ch
operator|->
name|blk
operator|=
name|prev
operator|/
name|ch
operator|->
name|unit
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|ch
operator|->
name|blk
operator|*=
name|ENVY24HT_PLAY_BUFUNIT
operator|/
literal|4
expr_stmt|;
else|else
name|ch
operator|->
name|blk
operator|*=
name|ENVY24HT_REC_BUFUNIT
operator|/
literal|4
expr_stmt|;
comment|/* set channel buffer information */
comment|/* ch->size = ch->unit * ENVY24HT_SAMPLE_NUM; */
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|bsize
operator|=
name|ch
operator|->
name|blk
operator|*
literal|4
operator|/
name|ENVY24HT_PLAY_BUFUNIT
expr_stmt|;
else|else
name|bsize
operator|=
name|ch
operator|->
name|blk
operator|*
literal|4
operator|/
name|ENVY24HT_REC_BUFUNIT
expr_stmt|;
name|bsize
operator|*=
name|ch
operator|->
name|unit
expr_stmt|;
name|bcnt
operator|=
name|ch
operator|->
name|size
operator|/
name|bsize
expr_stmt|;
name|sndbuf_resize
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|bcnt
argument_list|,
name|bsize
argument_list|)
expr_stmt|;
comment|/* snd_mtxunlock(sc->lock); */
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_setblocksize(): return %d\n"
argument_list|,
name|prev
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|prev
return|;
block|}
comment|/* semantic note: must start at beginning of buffer */
specifier|static
name|int
name|envy24htchan_trigger
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|;
name|int
name|slot
decl_stmt|;
if|#
directive|if
literal|0
block|int i;  	device_printf(sc->dev, "envy24htchan_trigger(obj, data, %d)\n", go);
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|slot
operator|=
literal|0
expr_stmt|;
else|else
name|slot
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|go
condition|)
block|{
case|case
name|PCMTRIG_START
case|:
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_trigger(): start\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* check or set channel speed */
if|if
condition|(
name|sc
operator|->
name|run
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|sc
operator|->
name|run
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|speed
operator|=
name|envy24ht_setspeed
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|speed
argument_list|)
expr_stmt|;
name|sc
operator|->
name|caps
index|[
literal|0
index|]
operator|.
name|minspeed
operator|=
name|sc
operator|->
name|caps
index|[
literal|0
index|]
operator|.
name|maxspeed
operator|=
name|sc
operator|->
name|speed
expr_stmt|;
name|sc
operator|->
name|caps
index|[
literal|1
index|]
operator|.
name|minspeed
operator|=
name|sc
operator|->
name|caps
index|[
literal|1
index|]
operator|.
name|maxspeed
operator|=
name|sc
operator|->
name|speed
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|->
name|speed
operator|!=
literal|0
operator|&&
name|ch
operator|->
name|speed
operator|!=
name|sc
operator|->
name|speed
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ch
operator|->
name|speed
operator|==
literal|0
condition|)
name|ch
operator|->
name|channel
operator|->
name|speed
operator|=
name|sc
operator|->
name|speed
expr_stmt|;
comment|/* start or enable channel */
name|sc
operator|->
name|run
index|[
name|slot
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|run
index|[
name|slot
index|]
operator|==
literal|1
condition|)
block|{
comment|/* first channel */
name|ch
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|blk
index|[
name|slot
index|]
operator|=
name|ch
operator|->
name|blk
expr_stmt|;
block|}
else|else
block|{
name|ptr
operator|=
name|envy24ht_gethwptr
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dir
argument_list|)
expr_stmt|;
name|ch
operator|->
name|offset
operator|=
operator|(
operator|(
name|ptr
operator|/
name|ch
operator|->
name|blk
operator|+
literal|1
operator|)
operator|*
name|ch
operator|->
name|blk
operator|%
operator|(
name|ch
operator|->
name|size
operator|/
literal|4
operator|)
operator|)
operator|*
literal|4
operator|/
name|ch
operator|->
name|unit
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|blk
operator|<
name|sc
operator|->
name|blk
index|[
name|slot
index|]
condition|)
name|sc
operator|->
name|blk
index|[
name|slot
index|]
operator|=
name|ch
operator|->
name|blk
expr_stmt|;
block|}
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
block|{
name|ch
operator|->
name|emldma
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|envy24ht_setvolume
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|num
argument_list|)
expr_stmt|;
block|}
name|envy24ht_updintr
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|run
index|[
name|slot
index|]
operator|==
literal|1
condition|)
name|envy24ht_start
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dir
argument_list|)
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PCMTRIG_EMLDMAWR
case|:
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_trigger(): emldmawr\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ch
operator|->
name|run
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|ch
operator|->
name|emldma
argument_list|(
name|ch
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_EMLDMARD
case|:
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_trigger(): emldmard\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ch
operator|->
name|run
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|ch
operator|->
name|emldma
argument_list|(
name|ch
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_ABORT
case|:
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_trigger(): abort\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|run
index|[
name|slot
index|]
operator|--
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|envy24ht_mutevolume
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|run
index|[
name|slot
index|]
operator|==
literal|0
condition|)
block|{
name|envy24ht_stop
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dir
argument_list|)
expr_stmt|;
name|sc
operator|->
name|intr
index|[
name|slot
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/*		else if (ch->blk == sc->blk[slot]) { 			sc->blk[slot] = ENVY24HT_SAMPLE_NUM / 2; 			for (i = 0; i< ENVY24HT_CHAN_NUM; i++) { 				if (sc->chan[i].dir == ch->dir&& 				    sc->chan[i].run == 1&& 				    sc->chan[i].blk< sc->blk[slot]) 					sc->blk[slot] = sc->chan[i].blk; 			} 			if (ch->blk != sc->blk[slot]) 				envy24ht_updintr(sc, ch->dir); 		}*/
break|break;
block|}
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
specifier|static
name|int
name|envy24htchan_getptr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|;
name|int
name|rtn
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_getptr()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|envy24ht_gethwptr
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dir
argument_list|)
expr_stmt|;
name|rtn
operator|=
name|ptr
operator|*
name|ch
operator|->
name|unit
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_getptr(): return %d\n"
argument_list|,
name|rtn
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|rtn
return|;
block|}
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|envy24htchan_getcaps
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|struct
name|pcmchan_caps
modifier|*
name|rtn
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htchan_getcaps()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|run
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|rtn
operator|=
operator|&
name|envy24ht_playcaps
expr_stmt|;
else|else
name|rtn
operator|=
operator|&
name|sc
operator|->
name|caps
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|run
index|[
literal|1
index|]
operator|==
literal|0
condition|)
name|rtn
operator|=
operator|&
name|envy24ht_reccaps
expr_stmt|;
else|else
name|rtn
operator|=
operator|&
name|sc
operator|->
name|caps
index|[
literal|1
index|]
expr_stmt|;
block|}
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|rtn
return|;
block|}
specifier|static
name|kobj_method_t
name|envy24htchan_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|envy24htchan_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_free
argument_list|,
name|envy24htchan_free
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|envy24htchan_setformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|envy24htchan_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|envy24htchan_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|envy24htchan_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|envy24htchan_getptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|envy24htchan_getcaps
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|CHANNEL_DECLARE
argument_list|(
name|envy24htchan
argument_list|)
expr_stmt|;
comment|/* -------------------------------------------------------------------- */
comment|/* mixer interface */
specifier|static
name|int
name|envy24htmixer_init
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htmixer_init()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* set volume control rate */
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|envy24ht_wrmt(sc, ENVY24HT_MT_VOLRATE, 0x30, 1);
comment|/* 0x30 is default value */
endif|#
directive|endif
name|mix_setdevs
argument_list|(
name|m
argument_list|,
name|ENVY24HT_MIX_MASK
argument_list|)
expr_stmt|;
name|mix_setrecdevs
argument_list|(
name|m
argument_list|,
name|ENVY24HT_MIX_REC_MASK
argument_list|)
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
specifier|static
name|int
name|envy24htmixer_reinit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htmixer_reinit()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
specifier|static
name|int
name|envy24htmixer_uninit
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htmixer_uninit()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
specifier|static
name|int
name|envy24htmixer_set
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|unsigned
name|dev
parameter_list|,
name|unsigned
name|left
parameter_list|,
name|unsigned
name|right
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
name|int
name|ch
init|=
name|envy24ht_mixmap
index|[
name|dev
index|]
decl_stmt|;
name|int
name|hwch
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|dev
operator|==
literal|0
operator|&&
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|setvolume
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|dev
operator|!=
literal|0
operator|&&
name|ch
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|hwch
operator|=
name|envy24ht_chanmap
index|[
name|ch
index|]
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htmixer_set(m, %d, %d, %d)\n"
argument_list|,
name|dev
argument_list|,
name|left
argument_list|,
name|right
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|dacn
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|setvolume
argument_list|(
name|sc
operator|->
name|dac
index|[
name|i
index|]
argument_list|,
name|PCMDIR_PLAY
argument_list|,
name|left
argument_list|,
name|right
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* set volume value for hardware */
if|if
condition|(
operator|(
name|sc
operator|->
name|left
index|[
name|hwch
index|]
operator|=
literal|100
operator|-
name|left
operator|)
operator|>
name|ENVY24HT_VOL_MIN
condition|)
name|sc
operator|->
name|left
index|[
name|hwch
index|]
operator|=
name|ENVY24HT_VOL_MUTE
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|right
index|[
name|hwch
index|]
operator|=
literal|100
operator|-
name|right
operator|)
operator|>
name|ENVY24HT_VOL_MIN
condition|)
name|sc
operator|->
name|right
index|[
name|hwch
index|]
operator|=
name|ENVY24HT_VOL_MUTE
expr_stmt|;
comment|/* set volume for record channel and running play channel */
if|if
condition|(
name|hwch
operator|>
name|ENVY24HT_CHAN_PLAY_SPDIF
operator|||
name|sc
operator|->
name|chan
index|[
name|ch
index|]
operator|.
name|run
condition|)
name|envy24ht_setvolume
argument_list|(
name|sc
argument_list|,
name|hwch
argument_list|)
expr_stmt|;
block|}
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|right
operator|<<
literal|8
operator||
name|left
return|;
block|}
specifier|static
name|u_int32_t
name|envy24htmixer_setrecsrc
parameter_list|(
name|struct
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|u_int32_t
name|src
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
name|int
name|ch
init|=
name|envy24ht_mixmap
index|[
name|src
index|]
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24htmixer_setrecsrc(m, %d)\n"
argument_list|,
name|src
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ch
operator|>
name|ENVY24HT_CHAN_PLAY_SPDIF
condition|)
name|sc
operator|->
name|src
operator|=
name|ch
expr_stmt|;
return|return
name|src
return|;
block|}
specifier|static
name|kobj_method_t
name|envy24htmixer_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|mixer_init
argument_list|,
name|envy24htmixer_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_reinit
argument_list|,
name|envy24htmixer_reinit
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_uninit
argument_list|,
name|envy24htmixer_uninit
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_set
argument_list|,
name|envy24htmixer_set
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|mixer_setrecsrc
argument_list|,
name|envy24htmixer_setrecsrc
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|MIXER_DECLARE
argument_list|(
name|envy24htmixer
argument_list|)
expr_stmt|;
comment|/* -------------------------------------------------------------------- */
comment|/* The interrupt handler */
specifier|static
name|void
name|envy24ht_intr
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|p
decl_stmt|;
name|struct
name|sc_chinfo
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|,
name|dsize
decl_stmt|,
name|feed
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_intr()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|envy24ht_checkintr
argument_list|(
name|sc
argument_list|,
name|PCMDIR_PLAY
argument_list|)
condition|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_intr(): play\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|dsize
operator|=
name|sc
operator|->
name|psize
operator|/
literal|4
expr_stmt|;
name|ptr
operator|=
name|dsize
operator|-
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCNT
argument_list|,
literal|2
argument_list|)
operator|-
literal|1
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_intr(): ptr = %d-->"
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ptr
operator|-=
name|ptr
operator|%
name|sc
operator|->
name|blk
index|[
literal|0
index|]
expr_stmt|;
name|feed
operator|=
operator|(
name|ptr
operator|+
name|dsize
operator|-
name|sc
operator|->
name|intr
index|[
literal|0
index|]
operator|)
operator|%
name|dsize
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|printf
argument_list|(
literal|"%d intr = %d feed = %d\n"
argument_list|,
name|ptr
argument_list|,
name|sc
operator|->
name|intr
index|[
literal|0
index|]
argument_list|,
name|feed
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
name|ENVY24HT_CHAN_PLAY_DAC1
init|;
name|i
operator|<=
name|ENVY24HT_CHAN_PLAY_SPDIF
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
operator|&
name|sc
operator|->
name|chan
index|[
name|i
index|]
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
if|if
condition|(
name|ch
operator|->
name|run
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_intr(): chan[%d].blk = %d\n"
argument_list|,
name|i
argument_list|,
name|ch
operator|->
name|blk
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ch
operator|->
name|run
operator|&&
name|ch
operator|->
name|blk
operator|<=
name|feed
condition|)
block|{
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|chn_intr
argument_list|(
name|ch
operator|->
name|channel
argument_list|)
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|intr
index|[
literal|0
index|]
operator|=
name|ptr
expr_stmt|;
name|envy24ht_updintr
argument_list|(
name|sc
argument_list|,
name|PCMDIR_PLAY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|envy24ht_checkintr
argument_list|(
name|sc
argument_list|,
name|PCMDIR_REC
argument_list|)
condition|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_intr(): rec\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|dsize
operator|=
name|sc
operator|->
name|rsize
operator|/
literal|4
expr_stmt|;
name|ptr
operator|=
name|dsize
operator|-
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_RCNT
argument_list|,
literal|2
argument_list|)
operator|-
literal|1
expr_stmt|;
name|ptr
operator|-=
name|ptr
operator|%
name|sc
operator|->
name|blk
index|[
literal|1
index|]
expr_stmt|;
name|feed
operator|=
operator|(
name|ptr
operator|+
name|dsize
operator|-
name|sc
operator|->
name|intr
index|[
literal|1
index|]
operator|)
operator|%
name|dsize
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ENVY24HT_CHAN_REC_ADC1
init|;
name|i
operator|<=
name|ENVY24HT_CHAN_REC_SPDIF
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
operator|&
name|sc
operator|->
name|chan
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|run
operator|&&
name|ch
operator|->
name|blk
operator|<=
name|feed
condition|)
block|{
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|chn_intr
argument_list|(
name|ch
operator|->
name|channel
argument_list|)
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|intr
index|[
literal|1
index|]
operator|=
name|ptr
expr_stmt|;
name|envy24ht_updintr
argument_list|(
name|sc
argument_list|,
name|PCMDIR_REC
argument_list|)
expr_stmt|;
block|}
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*  * Probe and attach the card  */
specifier|static
name|int
name|envy24ht_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int16_t
name|sv
decl_stmt|,
name|sd
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|printf
argument_list|(
literal|"envy24ht_pci_probe()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pci_get_device
argument_list|(
name|dev
argument_list|)
operator|==
name|PCID_ENVY24HT
operator|&&
name|pci_get_vendor
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIV_ENVY24
condition|)
block|{
name|sv
operator|=
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sd
operator|=
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|!=
literal|0
operator|||
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|==
name|sv
operator|&&
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
operator|==
name|sd
condition|)
block|{
break|break;
block|}
block|}
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|cfg_table
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|printf
argument_list|(
literal|"envy24ht_pci_probe(): return 0\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
else|else
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|printf
argument_list|(
literal|"envy24ht_pci_probe(): return ENXIO\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ENXIO
return|;
block|}
block|}
specifier|static
name|void
name|envy24ht_dmapsetmap
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
comment|/* struct sc_info *sc = (struct sc_info *)arg; */
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmapsetmap()\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"envy24ht(play): setmap %lx, %lx; "
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_addr
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%p -> %lx\n"
argument_list|,
name|sc
operator|->
name|pmap
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|vtophys
argument_list|(
name|sc
operator|->
name|pmap
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
specifier|static
name|void
name|envy24ht_dmarsetmap
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
comment|/* struct sc_info *sc = (struct sc_info *)arg; */
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmarsetmap()\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"envy24ht(record): setmap %lx, %lx; "
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_addr
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%p -> %lx\n"
argument_list|,
name|sc
operator|->
name|rmap
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|vtophys
argument_list|(
name|sc
operator|->
name|pmap
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
specifier|static
name|void
name|envy24ht_dmafree
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmafree():"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rmap
condition|)
name|printf
argument_list|(
literal|" sc->rmap(0x%08x)"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|sc
operator|->
name|rmap
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" sc->rmap(null)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pmap
condition|)
name|printf
argument_list|(
literal|" sc->pmap(0x%08x)"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|sc
operator|->
name|pmap
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" sc->pmap(null)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rbuf
condition|)
name|printf
argument_list|(
literal|" sc->rbuf(0x%08x)"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|sc
operator|->
name|rbuf
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" sc->rbuf(null)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pbuf
condition|)
name|printf
argument_list|(
literal|" sc->pbuf(0x%08x)\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|sc
operator|->
name|pbuf
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" sc->pbuf(null)\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
operator|(
literal|0
operator|)
if|if
condition|(
name|sc
operator|->
name|rmap
condition|)
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|rmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pmap
condition|)
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|pmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|rbuf
condition|)
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|rbuf
argument_list|,
name|sc
operator|->
name|rmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pbuf
condition|)
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|pbuf
argument_list|,
name|sc
operator|->
name|pmap
argument_list|)
expr_stmt|;
else|#
directive|else
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|rmap
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|pmap
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|rbuf
argument_list|,
name|sc
operator|->
name|rmap
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|pbuf
argument_list|,
name|sc
operator|->
name|pmap
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|rmap
operator|=
name|sc
operator|->
name|pmap
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|pbuf
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|rbuf
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
specifier|static
name|int
name|envy24ht_dmainit
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|addr
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmainit()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* init values */
name|sc
operator|->
name|psize
operator|=
name|ENVY24HT_PLAY_BUFUNIT
operator|*
name|ENVY24HT_SAMPLE_NUM
expr_stmt|;
name|sc
operator|->
name|rsize
operator|=
name|ENVY24HT_REC_BUFUNIT
operator|*
name|ENVY24HT_SAMPLE_NUM
expr_stmt|;
name|sc
operator|->
name|pbuf
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|rbuf
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|pmap
operator|=
name|sc
operator|->
name|rmap
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|blk
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|blk
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* allocate DMA buffer */
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmainit(): bus_dmamem_alloc(): sc->pbuf\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|pbuf
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|sc
operator|->
name|pmap
argument_list|)
condition|)
goto|goto
name|bad
goto|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmainit(): bus_dmamem_alloc(): sc->rbuf\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|rbuf
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|sc
operator|->
name|rmap
argument_list|)
condition|)
goto|goto
name|bad
goto|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmainit(): bus_dmamem_load(): sc->pmap\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|pmap
argument_list|,
name|sc
operator|->
name|pbuf
argument_list|,
name|sc
operator|->
name|psize
argument_list|,
name|envy24ht_dmapsetmap
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|bad
goto|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_dmainit(): bus_dmamem_load(): sc->rmap\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|sc
operator|->
name|rmap
argument_list|,
name|sc
operator|->
name|rbuf
argument_list|,
name|sc
operator|->
name|rsize
argument_list|,
name|envy24ht_dmarsetmap
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|bad
goto|;
name|bzero
argument_list|(
name|sc
operator|->
name|pbuf
argument_list|,
name|sc
operator|->
name|psize
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|sc
operator|->
name|rbuf
argument_list|,
name|sc
operator|->
name|rsize
argument_list|)
expr_stmt|;
comment|/* set values to register */
name|addr
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|pbuf
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"pbuf(0x%08x)\n"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PADDR
argument_list|,
name|addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"PADDR-->(0x%08x)\n"
argument_list|,
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PADDR
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"psize(%ld)\n"
argument_list|,
name|sc
operator|->
name|psize
operator|/
literal|4
operator|-
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCNT
argument_list|,
name|sc
operator|->
name|psize
operator|/
literal|4
operator|-
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"PCNT-->(%ld)\n"
argument_list|,
name|envy24ht_rdmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_PCNT
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|addr
operator|=
name|vtophys
argument_list|(
name|sc
operator|->
name|rbuf
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_RADDR
argument_list|,
name|addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|envy24ht_wrmt
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_MT_RCNT
argument_list|,
name|sc
operator|->
name|rsize
operator|/
literal|4
operator|-
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|bad
label|:
name|envy24ht_dmafree
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|ENOSPC
return|;
block|}
specifier|static
name|void
name|envy24ht_putcfg
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"system configuration\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  SubVendorID: 0x%04x, SubDeviceID: 0x%04x\n"
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|subvendor
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|subdevice
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  XIN2 Clock Source: "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cfg
operator|->
name|scfg
operator|&
name|ENVY24HT_CCSM_SCFG_XIN2
condition|)
block|{
case|case
literal|0x00
case|:
name|printf
argument_list|(
literal|"24.576MHz(96kHz*256)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
name|printf
argument_list|(
literal|"49.152MHz(192kHz*256)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|printf
argument_list|(
literal|"reserved\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"illeagal system setting\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"  MPU-401 UART(s) #: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|scfg
operator|&
name|ENVY24HT_CCSM_SCFG_MPU
condition|)
name|printf
argument_list|(
literal|"1\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"not implemented\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|adcn
condition|)
block|{
case|case
literal|0x01
operator|||
literal|0x02
case|:
name|printf
argument_list|(
literal|"  ADC #: "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\n"
argument_list|,
name|sc
operator|->
name|adcn
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|printf
argument_list|(
literal|"  ADC #: "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" and SPDIF receiver connected\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"  no physical inputs\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"  DAC #: "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d\n"
argument_list|,
name|sc
operator|->
name|dacn
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Multi-track converter type: "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|cfg
operator|->
name|acl
operator|&
name|ENVY24HT_CCSM_ACL_MTC
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"AC'97(SDATA_OUT:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|acl
operator|&
name|ENVY24HT_CCSM_ACL_OMODE
condition|)
name|printf
argument_list|(
literal|"packed"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"split"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|")\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"I2S("
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|i2s
operator|&
name|ENVY24HT_CCSM_I2S_VOL
condition|)
name|printf
argument_list|(
literal|"with volume, "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|i2s
operator|&
name|ENVY24HT_CCSM_I2S_192KHZ
condition|)
name|printf
argument_list|(
literal|"192KHz support, "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|i2s
operator|&
name|ENVY24HT_CCSM_I2S_96KHZ
condition|)
name|printf
argument_list|(
literal|"192KHz support, "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"48KHz support, "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|cfg
operator|->
name|i2s
operator|&
name|ENVY24HT_CCSM_I2S_RES
condition|)
block|{
case|case
name|ENVY24HT_CCSM_I2S_16BIT
case|:
name|printf
argument_list|(
literal|"16bit resolution, "
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENVY24HT_CCSM_I2S_18BIT
case|:
name|printf
argument_list|(
literal|"18bit resolution, "
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENVY24HT_CCSM_I2S_20BIT
case|:
name|printf
argument_list|(
literal|"20bit resolution, "
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENVY24HT_CCSM_I2S_24BIT
case|:
name|printf
argument_list|(
literal|"24bit resolution, "
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"ID#0x%x)\n"
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|i2s
operator|&
name|ENVY24HT_CCSM_I2S_ID
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"  S/PDIF(IN/OUT): "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|spdif
operator|&
name|ENVY24HT_CCSM_SPDIF_IN
condition|)
name|printf
argument_list|(
literal|"1/"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0/"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|spdif
operator|&
name|ENVY24HT_CCSM_SPDIF_OUT
condition|)
name|printf
argument_list|(
literal|"1 "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"0 "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|spdif
operator|&
operator|(
name|ENVY24HT_CCSM_SPDIF_IN
operator||
name|ENVY24HT_CCSM_SPDIF_OUT
operator|)
condition|)
name|printf
argument_list|(
literal|"ID# 0x%02x\n"
argument_list|,
operator|(
name|sc
operator|->
name|cfg
operator|->
name|spdif
operator|&
name|ENVY24HT_CCSM_SPDIF_ID
operator|)
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  GPIO(mask/dir/state): 0x%02x/0x%02x/0x%02x\n"
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|gpiomask
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|gpiodir
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|gpiostate
argument_list|)
expr_stmt|;
block|}
specifier|static
name|int
name|envy24ht_init
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|int
name|rtn
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
name|u_int32_t
name|sv
decl_stmt|,
name|sd
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_init()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* reset chip */
if|#
directive|if
literal|0
block|envy24ht_wrcs(sc, ENVY24HT_CCS_CTL, ENVY24HT_CCS_CTL_RESET, 1); 	DELAY(200); 	envy24ht_wrcs(sc, ENVY24HT_CCS_CTL, ENVY24HT_CCS_CTL_NATIVE, 1); 	DELAY(200);
comment|/* legacy hardware disable */
block|data = pci_read_config(sc->dev, PCIR_LAC, 2); 	data |= PCIM_LAC_DISABLE; 	pci_write_config(sc->dev, PCIR_LAC, data, 2);
endif|#
directive|endif
comment|/* check system configuration */
name|sc
operator|->
name|cfg
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|!=
literal|0
operator|||
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
comment|/* 1st: search configuration from table */
name|sv
operator|=
name|pci_get_subvendor
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|sd
operator|=
name|pci_get_subdevice
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sv
operator|==
name|cfg_table
index|[
name|i
index|]
operator|.
name|subvendor
operator|&&
name|sd
operator|==
name|cfg_table
index|[
name|i
index|]
operator|.
name|subdevice
condition|)
block|{
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Set configuration from table\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|cfg
operator|=
operator|&
name|cfg_table
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|cfg
operator|==
name|NULL
condition|)
block|{
comment|/* 2nd: read configuration from table */
name|sc
operator|->
name|cfg
operator|=
name|envy24ht_rom2cfg
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|adcn
operator|=
operator|(
operator|(
name|sc
operator|->
name|cfg
operator|->
name|scfg
operator|&
name|ENVY24HT_CCSM_SCFG_ADC
operator|)
operator|>>
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
comment|/* need to be fixed */
name|sc
operator|->
name|dacn
operator|=
operator|(
name|sc
operator|->
name|cfg
operator|->
name|scfg
operator|&
name|ENVY24HT_CCSM_SCFG_DAC
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
literal|1
comment|/* bootverbose */
condition|)
block|{
name|envy24ht_putcfg
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
comment|/* set system configuration */
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_SCFG
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|scfg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_ACL
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|acl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_I2S
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|i2s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_SPDIF
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|spdif
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_gpiosetmask
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|gpiomask
argument_list|)
expr_stmt|;
name|envy24ht_gpiosetdir
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|gpiodir
argument_list|)
expr_stmt|;
name|envy24ht_gpiowr
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|cfg
operator|->
name|gpiostate
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|adcn
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|adc
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|create
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
argument_list|,
name|PCMDIR_REC
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|init
argument_list|(
name|sc
operator|->
name|adc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|dacn
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|dac
index|[
name|i
index|]
operator|=
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|create
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
argument_list|,
name|PCMDIR_PLAY
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|init
argument_list|(
name|sc
operator|->
name|dac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* initialize DMA buffer */
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_init(): initialize DMA buffer\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|envy24ht_dmainit
argument_list|(
name|sc
argument_list|)
condition|)
return|return
name|ENOSPC
return|;
comment|/* initialize status */
name|sc
operator|->
name|run
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|run
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|intr
index|[
literal|0
index|]
operator|=
name|sc
operator|->
name|intr
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|speed
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|caps
index|[
literal|0
index|]
operator|.
name|fmtlist
operator|=
name|envy24ht_playfmt
expr_stmt|;
name|sc
operator|->
name|caps
index|[
literal|1
index|]
operator|.
name|fmtlist
operator|=
name|envy24ht_recfmt
expr_stmt|;
comment|/* set channel router */
if|#
directive|if
literal|0
block|envy24ht_route(sc, ENVY24HT_ROUTE_DAC_1, ENVY24HT_ROUTE_CLASS_MIX, 0, 0); 	envy24ht_route(sc, ENVY24HT_ROUTE_DAC_SPDIF, ENVY24HT_ROUTE_CLASS_DMA, 0, 0); 	envy24ht_route(sc, ENVY24HT_ROUTE_DAC_SPDIF, ENVY24HT_ROUTE_CLASS_MIX, 0, 0);
endif|#
directive|endif
comment|/* set macro interrupt mask */
name|data
operator|=
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_IMASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|envy24ht_wrcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_IMASK
argument_list|,
name|data
operator|&
operator|~
name|ENVY24HT_CCS_IMASK_PMT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|data
operator|=
name|envy24ht_rdcs
argument_list|(
name|sc
argument_list|,
name|ENVY24HT_CCS_IMASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"envy24ht_init(): CCS_IMASK-->0x%02x\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
specifier|static
name|int
name|envy24ht_alloc_resource
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
comment|/* allocate I/O port resource */
name|sc
operator|->
name|csid
operator|=
name|PCIR_CCS
expr_stmt|;
name|sc
operator|->
name|cs
operator|=
name|bus_alloc_resource
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|sc
operator|->
name|csid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mtid
operator|=
name|ENVY24HT_PCIR_MT
expr_stmt|;
name|sc
operator|->
name|mt
operator|=
name|bus_alloc_resource
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|sc
operator|->
name|mtid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|cs
operator|||
operator|!
name|sc
operator|->
name|mt
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"unable to map IO port space\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|sc
operator|->
name|cst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|cs
argument_list|)
expr_stmt|;
name|sc
operator|->
name|csh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|cs
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mtt
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|mt
argument_list|)
expr_stmt|;
name|sc
operator|->
name|mth
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|mt
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"IO port register values\nCCS: 0x%lx\nMT: 0x%lx\n"
argument_list|,
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCIR_CCS
argument_list|,
literal|4
argument_list|)
argument_list|,
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCIR_MT
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* allocate interupt resource */
name|sc
operator|->
name|irqid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|bus_alloc_resource
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|irqid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|irq
operator|||
name|snd_setup_intr
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
literal|0
argument_list|,
name|envy24ht_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ih
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* allocate DMA resource */
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/*parent*/
name|NULL
argument_list|,
comment|/*alignment*/
literal|4
argument_list|,
comment|/*boundary*/
literal|0
argument_list|,
comment|/*lowaddr*/
name|BUS_SPACE_MAXADDR_ENVY24
argument_list|,
comment|/*highaddr*/
name|BUS_SPACE_MAXADDR_ENVY24
argument_list|,
comment|/*filter*/
name|NULL
argument_list|,
comment|/*filterarg*/
name|NULL
argument_list|,
comment|/*maxsize*/
name|BUS_SPACE_MAXSIZE_ENVY24
argument_list|,
comment|/*nsegments*/
literal|1
argument_list|,
comment|/*maxsegsz*/
literal|0x3ffff
argument_list|,
comment|/*flags*/
literal|0
argument_list|,
comment|/*lockfunc*/
name|busdma_lock_mutex
argument_list|,
comment|/*lockarg*/
operator|&
name|Giant
argument_list|,
operator|&
name|sc
operator|->
name|dmat
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"unable to create dma tag\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
return|return
literal|0
return|;
block|}
specifier|static
name|int
name|envy24ht_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|char
name|status
index|[
name|SND_STATUSLEN
index|]
decl_stmt|;
name|char
name|name
index|[
name|ENVY24HT_NAMELEN
index|]
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"envy24ht_pci_attach()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* get sc_info data area */
if|if
condition|(
operator|(
name|sc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|,
name|M_ENVY24HT
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate softc\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|bzero
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
name|ENVY24HT_NAMELEN
argument_list|,
literal|"%s:envy24ht"
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lock
operator|=
name|snd_mtxcreate
argument_list|(
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
comment|/* initialize PCI interface */
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator||=
operator|(
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* allocate resources */
name|err
operator|=
name|envy24ht_alloc_resource
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to allocate system resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* initialize card */
name|err
operator|=
name|envy24ht_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to initialize the card\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* set multi track mixer */
name|mixer_init
argument_list|(
name|dev
argument_list|,
operator|&
name|envy24htmixer_class
argument_list|,
name|sc
argument_list|)
expr_stmt|;
comment|/* set channel information */
comment|/* err = pcm_register(dev, sc, 5, 2 + sc->adcn); */
name|err
operator|=
name|pcm_register
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
literal|1
argument_list|,
literal|2
operator|+
name|sc
operator|->
name|adcn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|bad
goto|;
name|sc
operator|->
name|chnum
operator|=
literal|0
expr_stmt|;
comment|/* for (i = 0; i< 5; i++) { */
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_PLAY
argument_list|,
operator|&
name|envy24htchan_class
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|chnum
operator|++
expr_stmt|;
comment|/* } */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
operator|+
name|sc
operator|->
name|adcn
condition|;
name|i
operator|++
control|)
block|{
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_REC
argument_list|,
operator|&
name|envy24htchan_class
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|chnum
operator|++
expr_stmt|;
block|}
comment|/* set status iformation */
name|snprintf
argument_list|(
name|status
argument_list|,
name|SND_STATUSLEN
argument_list|,
literal|"at io 0x%lx:%ld,0x%lx:%ld irq %ld"
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|cs
argument_list|)
argument_list|,
name|rman_get_end
argument_list|(
name|sc
operator|->
name|cs
argument_list|)
operator|-
name|rman_get_start
argument_list|(
name|sc
operator|->
name|cs
argument_list|)
operator|+
literal|1
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|mt
argument_list|)
argument_list|,
name|rman_get_end
argument_list|(
name|sc
operator|->
name|mt
argument_list|)
operator|-
name|rman_get_start
argument_list|(
name|sc
operator|->
name|mt
argument_list|)
operator|+
literal|1
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|irq
argument_list|)
argument_list|)
expr_stmt|;
name|pcm_setstatus
argument_list|(
name|dev
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|bad
label|:
if|if
condition|(
name|sc
operator|->
name|ih
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|envy24ht_dmafree
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dmat
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|destroy
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|adcn
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|destroy
argument_list|(
name|sc
operator|->
name|adc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|dacn
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|destroy
argument_list|(
name|sc
operator|->
name|dac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|envy24ht_cfgfree
argument_list|(
name|sc
operator|->
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cs
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|csid
argument_list|,
name|sc
operator|->
name|cs
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mt
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|mtid
argument_list|,
name|sc
operator|->
name|mt
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|lock
condition|)
name|snd_mtxfree
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_ENVY24HT
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
specifier|static
name|int
name|envy24ht_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|int
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"envy24ht_pci_detach()\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sc
operator|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|r
operator|=
name|pcm_unregister
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|envy24ht_dmafree
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|destroy
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|adcn
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|destroy
argument_list|(
name|sc
operator|->
name|adc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|dacn
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|cfg
operator|->
name|codec
operator|->
name|destroy
argument_list|(
name|sc
operator|->
name|dac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|envy24ht_cfgfree
argument_list|(
name|sc
operator|->
name|cfg
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dmat
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|csid
argument_list|,
name|sc
operator|->
name|cs
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|mtid
argument_list|,
name|sc
operator|->
name|mt
argument_list|)
expr_stmt|;
name|snd_mtxfree
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_ENVY24HT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
specifier|static
name|device_method_t
name|envy24ht_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|envy24ht_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|envy24ht_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|envy24ht_pci_detach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
specifier|static
name|driver_t
name|envy24ht_driver
init|=
block|{
literal|"pcm"
block|,
name|envy24ht_methods
block|,
if|#
directive|if
name|__FreeBSD_version
operator|>
literal|500000
name|PCM_SOFTC_SIZE
block|,
else|#
directive|else
sizeof|sizeof
argument_list|(
expr|struct
name|snddev_info
argument_list|)
block|,
endif|#
directive|endif
block|}
decl_stmt|;
name|DRIVER_MODULE
argument_list|(
name|snd_envy24ht
argument_list|,
name|pci
argument_list|,
name|envy24ht_driver
argument_list|,
name|pcm_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MODULE_DEPEND
argument_list|(
name|snd_envy24ht
argument_list|,
name|sound
argument_list|,
name|SOUND_MINVER
argument_list|,
name|SOUND_PREFVER
argument_list|,
name|SOUND_MAXVER
argument_list|)
expr_stmt|;
name|MODULE_DEPEND
argument_list|(
name|snd_envy24ht
argument_list|,
name|snd_spicds
argument_list|,
name|SOUND_MINVER
argument_list|,
name|SOUND_PREFVER
argument_list|,
name|SOUND_MAXVER
argument_list|)
expr_stmt|;
name|MODULE_VERSION
argument_list|(
name|snd_envy24ht
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_function

end_unit


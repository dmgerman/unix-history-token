begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2001 Scott Long<scottl@freebsd.org>  * Copyright (c) 2001 Darrell Anderson<anderson@cs.duke.edu>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Maestro-3/Allegro FreeBSD pcm sound driver  *  * executive status summary:  * (+) /dev/dsp multiple concurrent play channels.  * (+) /dev/dsp config (speed, mono/stereo, 8/16 bit).  * (+) /dev/mixer sets left/right volumes.  * (+) /dev/dsp recording works.  Tested successfully with the cdrom channel  * (+) apm suspend/resume works, and works properly!.  * (-) hardware volme controls don't work =-(  * (-) setblocksize() does nothing.  *  * The real credit goes to:  *  * Zach Brown for his Linux driver core and helpful technical comments.  *<zab@zabbo.net>, http://www.zabbo.net/maestro3  *  * Cameron Grant created the pcm framework used here nearly verbatim.  *<cg@freebsd.org>, http://people.freebsd.org/~cg/template.c  *  * Taku YAMAMOTO for his Maestro-1/2 FreeBSD driver and sanity reference.  *<taku@cent.saitama-u.ac.jp>  *  * ESS docs explained a few magic registers and numbers.  * http://virgo.caltech.edu/~dmoore/maestro3.pdf.gz  */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/ac97.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/sound/pci/maestro3_reg.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dev/sound/pci/maestro3_dsp.h>
end_include

begin_expr_stmt
name|SND_DECLARE_FILE
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_enum
enum|enum
block|{
name|CHANGE
init|=
literal|0
block|,
name|CALL
init|=
literal|1
block|,
name|INTR
init|=
literal|2
block|,
name|BORING
init|=
literal|3
block|,
name|NONE
init|=
operator|-
literal|1
block|}
enum|;
end_enum

begin_ifndef
ifndef|#
directive|ifndef
name|M3_DEBUG_LEVEL
end_ifndef

begin_define
define|#
directive|define
name|M3_DEBUG_LEVEL
value|NONE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|M3_DEBUG
parameter_list|(
name|level
parameter_list|,
name|_msg
parameter_list|)
value|{if ((level)<= M3_DEBUG_LEVEL) {printf _msg;}}
end_define

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_enum
enum|enum
block|{
name|ESS_ALLEGRO_1
block|,
name|ESS_MAESTRO3
block|}
enum|;
end_enum

begin_struct
specifier|static
struct|struct
name|m3_card_type
block|{
name|u_int32_t
name|pci_id
decl_stmt|;
name|int
name|which
decl_stmt|;
name|int
name|delay1
decl_stmt|;
name|int
name|delay2
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|m3_card_types
index|[]
init|=
block|{
block|{
literal|0x1988125d
block|,
name|ESS_ALLEGRO_1
block|,
literal|50
block|,
literal|800
block|,
literal|"ESS Technology Allegro-1"
block|}
block|,
block|{
literal|0x1998125d
block|,
name|ESS_MAESTRO3
block|,
literal|20
block|,
literal|500
block|,
literal|"ESS Technology Maestro3"
block|}
block|,
block|{
literal|0x199a125d
block|,
name|ESS_MAESTRO3
block|,
literal|20
block|,
literal|500
block|,
literal|"ESS Technology Maestro3"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|M3_BUFSIZE_MIN
value|4096
end_define

begin_define
define|#
directive|define
name|M3_BUFSIZE_MAX
value|65536
end_define

begin_define
define|#
directive|define
name|M3_BUFSIZE_DEFAULT
value|4096
end_define

begin_define
define|#
directive|define
name|M3_PCHANS
value|4
end_define

begin_comment
comment|/* create /dev/dsp0.[0-N] to use more than one */
end_comment

begin_define
define|#
directive|define
name|M3_RCHANS
value|1
end_define

begin_define
define|#
directive|define
name|M3_MAXADDR
value|((1<< 27) - 1)
end_define

begin_struct_decl
struct_decl|struct
name|sc_info
struct_decl|;
end_struct_decl

begin_struct
struct|struct
name|sc_pchinfo
block|{
name|u_int32_t
name|spd
decl_stmt|;
name|u_int32_t
name|fmt
decl_stmt|;
name|struct
name|snd_dbuf
modifier|*
name|buffer
decl_stmt|;
name|struct
name|pcm_channel
modifier|*
name|channel
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|parent
decl_stmt|;
name|u_int32_t
name|bufsize
decl_stmt|;
name|u_int32_t
name|dac_data
decl_stmt|;
name|u_int32_t
name|dac_idx
decl_stmt|;
name|u_int32_t
name|active
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|;
name|u_int32_t
name|prevptr
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sc_rchinfo
block|{
name|u_int32_t
name|spd
decl_stmt|;
name|u_int32_t
name|fmt
decl_stmt|;
name|struct
name|snd_dbuf
modifier|*
name|buffer
decl_stmt|;
name|struct
name|pcm_channel
modifier|*
name|channel
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|parent
decl_stmt|;
name|u_int32_t
name|bufsize
decl_stmt|;
name|u_int32_t
name|adc_data
decl_stmt|;
name|u_int32_t
name|adc_idx
decl_stmt|;
name|u_int32_t
name|active
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|;
name|u_int32_t
name|prevptr
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sc_info
block|{
name|device_t
name|dev
decl_stmt|;
name|u_int32_t
name|type
decl_stmt|;
name|int
name|which
decl_stmt|;
name|int
name|delay1
decl_stmt|;
name|int
name|delay2
decl_stmt|;
name|bus_space_tag_t
name|st
decl_stmt|;
name|bus_space_handle_t
name|sh
decl_stmt|;
name|bus_dma_tag_t
name|parent_dmat
decl_stmt|;
name|struct
name|resource
modifier|*
name|reg
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
name|int
name|regtype
decl_stmt|;
name|int
name|regid
decl_stmt|;
name|int
name|irqid
decl_stmt|;
name|void
modifier|*
name|ih
decl_stmt|;
name|struct
name|sc_pchinfo
name|pch
index|[
name|M3_PCHANS
index|]
decl_stmt|;
name|struct
name|sc_rchinfo
name|rch
index|[
name|M3_RCHANS
index|]
decl_stmt|;
name|int
name|pch_cnt
decl_stmt|;
name|int
name|rch_cnt
decl_stmt|;
name|int
name|pch_active_cnt
decl_stmt|;
name|unsigned
name|int
name|bufsz
decl_stmt|;
name|u_int16_t
modifier|*
name|savemem
decl_stmt|;
name|struct
name|mtx
modifier|*
name|sc_lock
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|M3_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|snd_mtxlock((_sc)->sc_lock)
end_define

begin_define
define|#
directive|define
name|M3_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|snd_mtxunlock((_sc)->sc_lock)
end_define

begin_define
define|#
directive|define
name|M3_LOCK_ASSERT
parameter_list|(
name|_sc
parameter_list|)
value|snd_mtxassert((_sc)->sc_lock)
end_define

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* play channel interface */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|m3_pchan_init
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
parameter_list|,
name|struct
name|pcm_channel
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_pchan_free
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_pchan_setformat
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_pchan_setspeed
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_pchan_setblocksize
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_pchan_trigger
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_pchan_trigger_locked
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int32_t
name|m3_pchan_getptr_internal
parameter_list|(
name|struct
name|sc_pchinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int32_t
name|m3_pchan_getptr
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|m3_pchan_getcaps
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* record channel interface */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|m3_rchan_init
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
parameter_list|,
name|struct
name|pcm_channel
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_rchan_free
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_rchan_setformat
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_rchan_setspeed
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_rchan_setblocksize
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_rchan_trigger
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_rchan_trigger_locked
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int32_t
name|m3_rchan_getptr_internal
parameter_list|(
name|struct
name|sc_rchinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int32_t
name|m3_rchan_getptr
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|m3_rchan_getcaps
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_chan_active
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* talk to the codec - called from ac97.c */
end_comment

begin_function_decl
specifier|static
name|int
name|m3_initcd
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_rdcd
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_wrcd
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* stuff */
end_comment

begin_function_decl
specifier|static
name|void
name|m3_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_power
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_init
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|m3_uninit
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int8_t
name|m3_assp_halt
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|m3_config
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|m3_amp_enable
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|m3_enable_ints
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|m3_codec_reset
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* Codec descriptor */
end_comment

begin_decl_stmt
specifier|static
name|kobj_method_t
name|m3_codec_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|ac97_init
argument_list|,
name|m3_initcd
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|ac97_read
argument_list|,
name|m3_rdcd
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|ac97_write
argument_list|,
name|m3_wrcd
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|AC97_DECLARE
argument_list|(
name|m3_codec
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* channel descriptors */
end_comment

begin_decl_stmt
specifier|static
name|u_int32_t
name|m3_playfmt
index|[]
init|=
block|{
name|AFMT_U8
block|,
name|AFMT_STEREO
operator||
name|AFMT_U8
block|,
name|AFMT_S16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|m3_playcaps
init|=
block|{
literal|8000
block|,
literal|48000
block|,
name|m3_playfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|kobj_method_t
name|m3_pch_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|m3_pchan_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|m3_pchan_setformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|m3_pchan_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|m3_pchan_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|m3_pchan_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|m3_pchan_getptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|m3_pchan_getcaps
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_free
argument_list|,
name|m3_pchan_free
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|CHANNEL_DECLARE
argument_list|(
name|m3_pch
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|m3_recfmt
index|[]
init|=
block|{
name|AFMT_U8
block|,
name|AFMT_STEREO
operator||
name|AFMT_U8
block|,
name|AFMT_S16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|m3_reccaps
init|=
block|{
literal|8000
block|,
literal|48000
block|,
name|m3_recfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|kobj_method_t
name|m3_rch_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|m3_rchan_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|m3_rchan_setformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|m3_rchan_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|m3_rchan_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|m3_rchan_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|m3_rchan_getptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|m3_rchan_getcaps
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_free
argument_list|,
name|m3_rchan_free
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|CHANNEL_DECLARE
argument_list|(
name|m3_rch
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* some i/o convenience functions */
end_comment

begin_define
define|#
directive|define
name|m3_rd_1
parameter_list|(
name|sc
parameter_list|,
name|regno
parameter_list|)
value|bus_space_read_1(sc->st, sc->sh, regno)
end_define

begin_define
define|#
directive|define
name|m3_rd_2
parameter_list|(
name|sc
parameter_list|,
name|regno
parameter_list|)
value|bus_space_read_2(sc->st, sc->sh, regno)
end_define

begin_define
define|#
directive|define
name|m3_rd_4
parameter_list|(
name|sc
parameter_list|,
name|regno
parameter_list|)
value|bus_space_read_4(sc->st, sc->sh, regno)
end_define

begin_define
define|#
directive|define
name|m3_wr_1
parameter_list|(
name|sc
parameter_list|,
name|regno
parameter_list|,
name|data
parameter_list|)
value|bus_space_write_1(sc->st, sc->sh, regno, data)
end_define

begin_define
define|#
directive|define
name|m3_wr_2
parameter_list|(
name|sc
parameter_list|,
name|regno
parameter_list|,
name|data
parameter_list|)
value|bus_space_write_2(sc->st, sc->sh, regno, data)
end_define

begin_define
define|#
directive|define
name|m3_wr_4
parameter_list|(
name|sc
parameter_list|,
name|regno
parameter_list|,
name|data
parameter_list|)
value|bus_space_write_4(sc->st, sc->sh, regno, data)
end_define

begin_define
define|#
directive|define
name|m3_rd_assp_code
parameter_list|(
name|sc
parameter_list|,
name|index
parameter_list|)
define|\
value|m3_rd_assp(sc, MEMTYPE_INTERNAL_CODE, index)
end_define

begin_define
define|#
directive|define
name|m3_wr_assp_code
parameter_list|(
name|sc
parameter_list|,
name|index
parameter_list|,
name|data
parameter_list|)
define|\
value|m3_wr_assp(sc, MEMTYPE_INTERNAL_CODE, index, data)
end_define

begin_define
define|#
directive|define
name|m3_rd_assp_data
parameter_list|(
name|sc
parameter_list|,
name|index
parameter_list|)
define|\
value|m3_rd_assp(sc, MEMTYPE_INTERNAL_DATA, index)
end_define

begin_define
define|#
directive|define
name|m3_wr_assp_data
parameter_list|(
name|sc
parameter_list|,
name|index
parameter_list|,
name|data
parameter_list|)
define|\
value|m3_wr_assp(sc, MEMTYPE_INTERNAL_DATA, index, data)
end_define

begin_function
specifier|static
name|__inline
name|u_int16_t
name|m3_rd_assp
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int16_t
name|region
parameter_list|,
name|u_int16_t
name|index
parameter_list|)
block|{
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_MEMORY_TYPE
argument_list|,
name|region
operator|&
name|MEMTYPE_MASK
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_MEMORY_INDEX
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_MEMORY_DATA
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|void
name|m3_wr_assp
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int16_t
name|region
parameter_list|,
name|u_int16_t
name|index
parameter_list|,
name|u_int16_t
name|data
parameter_list|)
block|{
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_MEMORY_TYPE
argument_list|,
name|region
operator|&
name|MEMTYPE_MASK
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_MEMORY_INDEX
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_MEMORY_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|m3_wait
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|CODEC_STATUS
argument_list|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* ac97 codec */
end_comment

begin_function
specifier|static
name|int
name|m3_initcd
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_initcd\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* init ac-link */
name|data
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|CODEC_COMMAND
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|data
operator|&
literal|0x1
operator|)
condition|?
literal|0
else|:
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_rdcd
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|int
name|regno
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
if|if
condition|(
name|m3_wait
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_rdcd timed out.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|CODEC_COMMAND
argument_list|,
operator|(
name|regno
operator|&
literal|0x7f
operator|)
operator||
literal|0x80
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* ac97 cycle = 20.8 usec */
if|if
condition|(
name|m3_wait
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_rdcd timed out.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|CODEC_DATA
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_wrcd
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
if|if
condition|(
name|m3_wait
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_wrcd timed out.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
empty_stmt|;
block|}
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|CODEC_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|CODEC_COMMAND
argument_list|,
name|regno
operator|&
literal|0x7f
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|50
argument_list|)
expr_stmt|;
comment|/* ac97 cycle = 20.8 usec */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* play channel interface */
end_comment

begin_define
define|#
directive|define
name|LO
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x0000ffff)      )
end_define

begin_define
define|#
directive|define
name|HI
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xffff0000)>> 16)
end_define

begin_function
specifier|static
name|void
modifier|*
name|m3_pchan_init
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|devinfo
decl_stmt|;
name|struct
name|sc_pchinfo
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|bus_addr
decl_stmt|,
name|i
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|data_bytes
decl_stmt|,
name|dac_data
decl_stmt|;
name|int
name|dsp_in_size
decl_stmt|,
name|dsp_out_size
decl_stmt|,
name|dsp_in_buf
decl_stmt|,
name|dsp_out_buf
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|idx
operator|=
name|sc
operator|->
name|pch_cnt
expr_stmt|;
comment|/* dac instance number, no active reuse! */
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_pchan_init(dac=%d)\n"
operator|,
name|idx
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|PCMDIR_PLAY
condition|)
block|{
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_pchan_init not PCMDIR_PLAY\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|data_bytes
operator|=
operator|(
operator|(
operator|(
name|MINISRC_TMP_BUFFER_SIZE
operator|&
operator|~
literal|1
operator|)
operator|+
operator|(
name|MINISRC_IN_BUFFER_SIZE
operator|&
operator|~
literal|1
operator|)
operator|+
operator|(
name|MINISRC_OUT_BUFFER_SIZE
operator|&
operator|~
literal|1
operator|)
operator|+
literal|4
operator|)
operator|+
literal|255
operator|)
operator|&
operator|~
literal|255
expr_stmt|;
name|dac_data
operator|=
literal|0x1100
operator|+
operator|(
name|data_bytes
operator|*
name|idx
operator|)
expr_stmt|;
name|dsp_in_size
operator|=
name|MINISRC_IN_BUFFER_SIZE
operator|-
operator|(
literal|0x20
operator|*
literal|2
operator|)
expr_stmt|;
name|dsp_out_size
operator|=
name|MINISRC_OUT_BUFFER_SIZE
operator|-
operator|(
literal|0x20
operator|*
literal|2
operator|)
expr_stmt|;
name|dsp_in_buf
operator|=
name|dac_data
operator|+
operator|(
name|MINISRC_TMP_BUFFER_SIZE
operator|/
literal|2
operator|)
expr_stmt|;
name|dsp_out_buf
operator|=
name|dsp_in_buf
operator|+
operator|(
name|dsp_in_size
operator|/
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
name|ch
operator|=
operator|&
name|sc
operator|->
name|pch
index|[
name|idx
index|]
expr_stmt|;
name|ch
operator|->
name|dac_idx
operator|=
name|idx
expr_stmt|;
name|ch
operator|->
name|dac_data
operator|=
name|dac_data
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dac_data
operator|+
name|data_bytes
operator|/
literal|2
operator|>=
literal|0x1c00
condition|)
block|{
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_pchan_init: revb mem exhausted\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|AFMT_U8
expr_stmt|;
name|ch
operator|->
name|spd
operator|=
name|DSP_DEFAULT_SPEED
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|sndbuf_alloc
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|sc
operator|->
name|parent_dmat
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|bufsz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_pchan_init chn_allocbuf failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ch
operator|->
name|bufsize
operator|=
name|sndbuf_getsize
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
comment|/* host dma buffer pointers */
name|bus_addr
operator|=
name|sndbuf_getbufaddr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_addr
operator|&
literal|3
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_pchan_init unaligned bus_addr\n"
argument_list|)
expr_stmt|;
name|bus_addr
operator|=
operator|(
name|bus_addr
operator|+
literal|4
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_ADDRL
argument_list|,
name|LO
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_ADDRH
argument_list|,
name|HI
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_END_PLUS_1L
argument_list|,
name|LO
argument_list|(
name|bus_addr
operator|+
name|ch
operator|->
name|bufsize
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_END_PLUS_1H
argument_list|,
name|HI
argument_list|(
name|bus_addr
operator|+
name|ch
operator|->
name|bufsize
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_CURRENTL
argument_list|,
name|LO
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_CURRENTH
argument_list|,
name|HI
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* dsp buffers */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_IN_BUF_BEGIN
argument_list|,
name|dsp_in_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_IN_BUF_END_PLUS_1
argument_list|,
name|dsp_in_buf
operator|+
name|dsp_in_size
operator|/
literal|2
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_IN_BUF_HEAD
argument_list|,
name|dsp_in_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_IN_BUF_TAIL
argument_list|,
name|dsp_in_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_OUT_BUF_BEGIN
argument_list|,
name|dsp_out_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_OUT_BUF_END_PLUS_1
argument_list|,
name|dsp_out_buf
operator|+
name|dsp_out_size
operator|/
literal|2
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_OUT_BUF_HEAD
argument_list|,
name|dsp_out_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_OUT_BUF_TAIL
argument_list|,
name|dsp_out_buf
argument_list|)
expr_stmt|;
comment|/* some per client initializers */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|SRC3_DIRECTION_OFFSET
operator|+
literal|12
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
literal|40
operator|+
literal|8
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|SRC3_DIRECTION_OFFSET
operator|+
literal|19
argument_list|,
literal|0x400
operator|+
name|MINISRC_COEF_LOC
argument_list|)
expr_stmt|;
comment|/* enable or disable low pass filter? (0xff if rate> 45000) */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|SRC3_DIRECTION_OFFSET
operator|+
literal|22
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* tell it which way dma is going? */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_DMA_CONTROL
argument_list|,
name|DMACONTROL_AUTOREPEAT
operator|+
name|DMAC_PAGE3_SELECTOR
operator|+
name|DMAC_BLOCKF_SELECTOR
argument_list|)
expr_stmt|;
comment|/* set an armload of static initializers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|pv
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|pv
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|pv
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|pv
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* put us in the packed task lists */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_INSTANCE0_MINISRC
operator|+
operator|(
name|sc
operator|->
name|pch_cnt
operator|+
name|sc
operator|->
name|rch_cnt
operator|)
argument_list|,
name|ch
operator|->
name|dac_data
operator|>>
name|DP_SHIFT_COUNT
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_DMA_XFER0
operator|+
operator|(
name|sc
operator|->
name|pch_cnt
operator|+
name|sc
operator|->
name|rch_cnt
operator|)
argument_list|,
name|ch
operator|->
name|dac_data
operator|>>
name|DP_SHIFT_COUNT
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_MIXER_XFER0
operator|+
name|sc
operator|->
name|pch_cnt
argument_list|,
name|ch
operator|->
name|dac_data
operator|>>
name|DP_SHIFT_COUNT
argument_list|)
expr_stmt|;
comment|/* gotta start before stop */
name|m3_pchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
name|ch
argument_list|,
name|PCMTRIG_START
argument_list|)
expr_stmt|;
comment|/* silence noise on load */
name|m3_pchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
name|ch
argument_list|,
name|PCMTRIG_STOP
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pch_cnt
operator|++
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ch
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pchan_free
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_pchan_free(dac=%d)\n"
operator|,
name|ch
operator|->
name|dac_idx
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * should remove this exact instance from the packed lists, but all 	 * are released at once (and in a stopped state) so this is ok. 	 */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_INSTANCE0_MINISRC
operator|+
operator|(
name|sc
operator|->
name|pch_cnt
operator|-
literal|1
operator|)
operator|+
name|sc
operator|->
name|rch_cnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_DMA_XFER0
operator|+
operator|(
name|sc
operator|->
name|pch_cnt
operator|-
literal|1
operator|)
operator|+
name|sc
operator|->
name|rch_cnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_MIXER_XFER0
operator|+
operator|(
name|sc
operator|->
name|pch_cnt
operator|-
literal|1
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pch_cnt
operator|--
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pchan_setformat
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_pchan_setformat(dac=%d, format=0x%x{%s-%s})\n"
operator|,
name|ch
operator|->
name|dac_idx
operator|,
name|format
operator|,
name|format
operator|&
operator|(
name|AFMT_U8
operator||
name|AFMT_S8
operator|)
condition|?
literal|"8bit"
else|:
literal|"16bit"
operator|,
name|format
operator|&
name|AFMT_STEREO
condition|?
literal|"STEREO"
else|:
literal|"MONO"
operator|)
argument_list|)
expr_stmt|;
comment|/* mono word */
name|data
operator|=
operator|(
name|format
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|SRC3_MODE_OFFSET
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|/* 8bit word */
name|data
operator|=
operator|(
operator|(
name|format
operator|&
name|AFMT_U8
operator|)
operator|||
operator|(
name|format
operator|&
name|AFMT_S8
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|SRC3_WORD_LENGTH_OFFSET
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|format
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pchan_setspeed
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|freq
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_pchan_setspeed(dac=%d, speed=%d)\n"
operator|,
name|ch
operator|->
name|dac_idx
operator|,
name|speed
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|freq
operator|=
operator|(
operator|(
name|speed
operator|<<
literal|15
operator|)
operator|+
literal|24000
operator|)
operator|/
literal|48000
operator|)
operator|!=
literal|0
condition|)
block|{
name|freq
operator|--
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_FREQUENCY
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|ch
operator|->
name|spd
operator|=
name|speed
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* return closest possible speed */
return|return
operator|(
name|speed
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pchan_setblocksize
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_pchan_setblocksize(dac=%d, blocksize=%d)\n"
operator|,
name|ch
operator|->
name|dac_idx
operator|,
name|blocksize
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|sndbuf_getblksz
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pchan_trigger
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ret
operator|=
name|m3_pchan_trigger_locked
argument_list|(
name|kobj
argument_list|,
name|chdata
argument_list|,
name|go
argument_list|)
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_chan_active
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|pch_cnt
condition|;
name|i
operator|++
control|)
name|ret
operator|+=
name|sc
operator|->
name|pch
index|[
name|i
index|]
operator|.
name|active
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rch_cnt
condition|;
name|i
operator|++
control|)
name|ret
operator|+=
name|sc
operator|->
name|rch
index|[
name|i
index|]
operator|.
name|active
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pchan_trigger_locked
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|go
operator|==
name|PCMTRIG_START
condition|?
name|CHANGE
else|:
name|go
operator|==
name|PCMTRIG_STOP
condition|?
name|CHANGE
else|:
name|go
operator|==
name|PCMTRIG_ABORT
condition|?
name|CHANGE
else|:
name|CALL
argument_list|,
operator|(
literal|"m3_pchan_trigger(dac=%d, go=0x%x{%s})\n"
operator|,
name|ch
operator|->
name|dac_idx
operator|,
name|go
operator|,
name|go
operator|==
name|PCMTRIG_START
condition|?
literal|"PCMTRIG_START"
else|:
name|go
operator|==
name|PCMTRIG_STOP
condition|?
literal|"PCMTRIG_STOP"
else|:
name|go
operator|==
name|PCMTRIG_ABORT
condition|?
literal|"PCMTRIG_ABORT"
else|:
literal|"ignore"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|go
condition|)
block|{
case|case
name|PCMTRIG_START
case|:
if|if
condition|(
name|ch
operator|->
name|active
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ch
operator|->
name|active
operator|=
literal|1
expr_stmt|;
name|ch
operator|->
name|ptr
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|prevptr
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|pch_active_cnt
operator|++
expr_stmt|;
comment|/*[[inc_timer_users]]*/
if|if
condition|(
name|m3_chan_active
argument_list|(
name|sc
argument_list|)
operator|==
literal|1
condition|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_RELOAD
argument_list|,
literal|240
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_CURRENT
argument_list|,
literal|240
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|,
name|data
operator||
name|CLKRUN_GEN_ENABLE
argument_list|)
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_INSTANCE_READY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_MIXER_TASK_NUMBER
argument_list|,
name|sc
operator|->
name|pch_active_cnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_STOP
case|:
case|case
name|PCMTRIG_ABORT
case|:
if|if
condition|(
name|ch
operator|->
name|active
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ch
operator|->
name|active
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|pch_active_cnt
operator|--
expr_stmt|;
comment|/* XXX should the channel be drained? */
comment|/*[[dec_timer_users]]*/
if|if
condition|(
name|m3_chan_active
argument_list|(
name|sc
argument_list|)
operator|==
literal|0
condition|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_RELOAD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_CURRENT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|,
name|data
operator|&
operator|~
name|CLKRUN_GEN_ENABLE
argument_list|)
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_INSTANCE_READY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_MIXER_TASK_NUMBER
argument_list|,
name|sc
operator|->
name|pch_active_cnt
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_EMLDMAWR
case|:
comment|/* got play irq, transfer next buffer - ignore if using dma */
case|case
name|PCMTRIG_EMLDMARD
case|:
comment|/* got rec irq, transfer next buffer - ignore if using dma */
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|m3_pchan_getptr_internal
parameter_list|(
name|struct
name|sc_pchinfo
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|hi
decl_stmt|,
name|lo
decl_stmt|,
name|bus_base
decl_stmt|,
name|bus_crnt
decl_stmt|;
name|bus_base
operator|=
name|sndbuf_getbufaddr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|hi
operator|=
name|m3_rd_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_CURRENTH
argument_list|)
expr_stmt|;
name|lo
operator|=
name|m3_rd_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|dac_data
operator|+
name|CDATA_HOST_SRC_CURRENTL
argument_list|)
expr_stmt|;
name|bus_crnt
operator|=
name|lo
operator||
operator|(
name|hi
operator|<<
literal|16
operator|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_pchan_getptr(dac=%d) result=%d\n"
operator|,
name|ch
operator|->
name|dac_idx
operator|,
name|bus_crnt
operator|-
name|bus_base
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_crnt
operator|-
name|bus_base
operator|)
return|;
comment|/* current byte offset of channel */
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|m3_pchan_getptr
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|ch
operator|->
name|ptr
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|m3_pchan_getcaps
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_pchan_getcaps(dac=%d)\n"
operator|,
name|ch
operator|->
name|dac_idx
operator|)
argument_list|)
expr_stmt|;
return|return
operator|&
name|m3_playcaps
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* rec channel interface */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|m3_rchan_init
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|devinfo
decl_stmt|;
name|struct
name|sc_rchinfo
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|bus_addr
decl_stmt|,
name|i
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|data_bytes
decl_stmt|,
name|adc_data
decl_stmt|;
name|int
name|dsp_in_size
decl_stmt|,
name|dsp_out_size
decl_stmt|,
name|dsp_in_buf
decl_stmt|,
name|dsp_out_buf
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|idx
operator|=
name|sc
operator|->
name|rch_cnt
expr_stmt|;
comment|/* adc instance number, no active reuse! */
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_rchan_init(adc=%d)\n"
operator|,
name|idx
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|PCMDIR_REC
condition|)
block|{
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_pchan_init not PCMDIR_REC\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|data_bytes
operator|=
operator|(
operator|(
operator|(
name|MINISRC_TMP_BUFFER_SIZE
operator|&
operator|~
literal|1
operator|)
operator|+
operator|(
name|MINISRC_IN_BUFFER_SIZE
operator|&
operator|~
literal|1
operator|)
operator|+
operator|(
name|MINISRC_OUT_BUFFER_SIZE
operator|&
operator|~
literal|1
operator|)
operator|+
literal|4
operator|)
operator|+
literal|255
operator|)
operator|&
operator|~
literal|255
expr_stmt|;
name|adc_data
operator|=
literal|0x1100
operator|+
operator|(
name|data_bytes
operator|*
name|idx
operator|)
operator|+
name|data_bytes
operator|/
literal|2
expr_stmt|;
name|dsp_in_size
operator|=
name|MINISRC_IN_BUFFER_SIZE
operator|+
operator|(
literal|0x10
operator|*
literal|2
operator|)
expr_stmt|;
name|dsp_out_size
operator|=
name|MINISRC_OUT_BUFFER_SIZE
operator|-
operator|(
literal|0x10
operator|*
literal|2
operator|)
expr_stmt|;
name|dsp_in_buf
operator|=
name|adc_data
operator|+
operator|(
name|MINISRC_TMP_BUFFER_SIZE
operator|/
literal|2
operator|)
expr_stmt|;
name|dsp_out_buf
operator|=
name|dsp_in_buf
operator|+
operator|(
name|dsp_in_size
operator|/
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
name|ch
operator|=
operator|&
name|sc
operator|->
name|rch
index|[
name|idx
index|]
expr_stmt|;
name|ch
operator|->
name|adc_idx
operator|=
name|idx
expr_stmt|;
name|ch
operator|->
name|adc_data
operator|=
name|adc_data
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|adc_data
operator|+
name|data_bytes
operator|/
literal|2
operator|>=
literal|0x1c00
condition|)
block|{
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_rchan_init: revb mem exhausted\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|AFMT_U8
expr_stmt|;
name|ch
operator|->
name|spd
operator|=
name|DSP_DEFAULT_SPEED
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|sndbuf_alloc
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|sc
operator|->
name|parent_dmat
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|bufsz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_rchan_init chn_allocbuf failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ch
operator|->
name|bufsize
operator|=
name|sndbuf_getsize
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
comment|/* host dma buffer pointers */
name|bus_addr
operator|=
name|sndbuf_getbufaddr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_addr
operator|&
literal|3
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"m3_rchan_init unaligned bus_addr\n"
argument_list|)
expr_stmt|;
name|bus_addr
operator|=
operator|(
name|bus_addr
operator|+
literal|4
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_ADDRL
argument_list|,
name|LO
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_ADDRH
argument_list|,
name|HI
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_END_PLUS_1L
argument_list|,
name|LO
argument_list|(
name|bus_addr
operator|+
name|ch
operator|->
name|bufsize
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_END_PLUS_1H
argument_list|,
name|HI
argument_list|(
name|bus_addr
operator|+
name|ch
operator|->
name|bufsize
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_CURRENTL
argument_list|,
name|LO
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_CURRENTH
argument_list|,
name|HI
argument_list|(
name|bus_addr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* dsp buffers */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_IN_BUF_BEGIN
argument_list|,
name|dsp_in_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_IN_BUF_END_PLUS_1
argument_list|,
name|dsp_in_buf
operator|+
name|dsp_in_size
operator|/
literal|2
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_IN_BUF_HEAD
argument_list|,
name|dsp_in_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_IN_BUF_TAIL
argument_list|,
name|dsp_in_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_OUT_BUF_BEGIN
argument_list|,
name|dsp_out_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_OUT_BUF_END_PLUS_1
argument_list|,
name|dsp_out_buf
operator|+
name|dsp_out_size
operator|/
literal|2
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_OUT_BUF_HEAD
argument_list|,
name|dsp_out_buf
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_OUT_BUF_TAIL
argument_list|,
name|dsp_out_buf
argument_list|)
expr_stmt|;
comment|/* some per client initializers */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|SRC3_DIRECTION_OFFSET
operator|+
literal|12
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
literal|40
operator|+
literal|8
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_DMA_CONTROL
argument_list|,
name|DMACONTROL_DIRECTION
operator|+
name|DMACONTROL_AUTOREPEAT
operator|+
name|DMAC_PAGE3_SELECTOR
operator|+
name|DMAC_BLOCKF_SELECTOR
argument_list|)
expr_stmt|;
comment|/* set an armload of static initializers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|rv
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|rv
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|rv
index|[
name|i
index|]
operator|.
name|addr
argument_list|,
name|rv
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
block|}
comment|/* put us in the packed task lists */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_INSTANCE0_MINISRC
operator|+
operator|(
name|sc
operator|->
name|pch_cnt
operator|+
name|sc
operator|->
name|rch_cnt
operator|)
argument_list|,
name|ch
operator|->
name|adc_data
operator|>>
name|DP_SHIFT_COUNT
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_DMA_XFER0
operator|+
operator|(
name|sc
operator|->
name|pch_cnt
operator|+
name|sc
operator|->
name|rch_cnt
operator|)
argument_list|,
name|ch
operator|->
name|adc_data
operator|>>
name|DP_SHIFT_COUNT
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_ADC1_XFER0
operator|+
name|sc
operator|->
name|rch_cnt
argument_list|,
name|ch
operator|->
name|adc_data
operator|>>
name|DP_SHIFT_COUNT
argument_list|)
expr_stmt|;
comment|/* gotta start before stop */
name|m3_rchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
name|ch
argument_list|,
name|PCMTRIG_START
argument_list|)
expr_stmt|;
comment|/* stop on init */
name|m3_rchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
name|ch
argument_list|,
name|PCMTRIG_STOP
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rch_cnt
operator|++
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ch
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_rchan_free
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_rchan_free(adc=%d)\n"
operator|,
name|ch
operator|->
name|adc_idx
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * should remove this exact instance from the packed lists, but all 	 * are released at once (and in a stopped state) so this is ok. 	 */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_INSTANCE0_MINISRC
operator|+
operator|(
name|sc
operator|->
name|rch_cnt
operator|-
literal|1
operator|)
operator|+
name|sc
operator|->
name|pch_cnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_DMA_XFER0
operator|+
operator|(
name|sc
operator|->
name|rch_cnt
operator|-
literal|1
operator|)
operator|+
name|sc
operator|->
name|pch_cnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_ADC1_XFER0
operator|+
operator|(
name|sc
operator|->
name|rch_cnt
operator|-
literal|1
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rch_cnt
operator|--
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_rchan_setformat
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_rchan_setformat(dac=%d, format=0x%x{%s-%s})\n"
operator|,
name|ch
operator|->
name|adc_idx
operator|,
name|format
operator|,
name|format
operator|&
operator|(
name|AFMT_U8
operator||
name|AFMT_S8
operator|)
condition|?
literal|"8bit"
else|:
literal|"16bit"
operator|,
name|format
operator|&
name|AFMT_STEREO
condition|?
literal|"STEREO"
else|:
literal|"MONO"
operator|)
argument_list|)
expr_stmt|;
comment|/* mono word */
name|data
operator|=
operator|(
name|format
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|SRC3_MODE_OFFSET
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|/* 8bit word */
name|data
operator|=
operator|(
operator|(
name|format
operator|&
name|AFMT_U8
operator|)
operator|||
operator|(
name|format
operator|&
name|AFMT_S8
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|SRC3_WORD_LENGTH_OFFSET
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|format
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_rchan_setspeed
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|freq
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_rchan_setspeed(adc=%d, speed=%d)\n"
operator|,
name|ch
operator|->
name|adc_idx
operator|,
name|speed
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|freq
operator|=
operator|(
operator|(
name|speed
operator|<<
literal|15
operator|)
operator|+
literal|24000
operator|)
operator|/
literal|48000
operator|)
operator|!=
literal|0
condition|)
block|{
name|freq
operator|--
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_FREQUENCY
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|ch
operator|->
name|spd
operator|=
name|speed
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* return closest possible speed */
return|return
operator|(
name|speed
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_rchan_setblocksize
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_rchan_setblocksize(adc=%d, blocksize=%d)\n"
operator|,
name|ch
operator|->
name|adc_idx
operator|,
name|blocksize
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|sndbuf_getblksz
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_rchan_trigger
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ret
operator|=
name|m3_rchan_trigger_locked
argument_list|(
name|kobj
argument_list|,
name|chdata
argument_list|,
name|go
argument_list|)
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_rchan_trigger_locked
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|go
operator|==
name|PCMTRIG_START
condition|?
name|CHANGE
else|:
name|go
operator|==
name|PCMTRIG_STOP
condition|?
name|CHANGE
else|:
name|go
operator|==
name|PCMTRIG_ABORT
condition|?
name|CHANGE
else|:
name|CALL
argument_list|,
operator|(
literal|"m3_rchan_trigger(adc=%d, go=0x%x{%s})\n"
operator|,
name|ch
operator|->
name|adc_idx
operator|,
name|go
operator|,
name|go
operator|==
name|PCMTRIG_START
condition|?
literal|"PCMTRIG_START"
else|:
name|go
operator|==
name|PCMTRIG_STOP
condition|?
literal|"PCMTRIG_STOP"
else|:
name|go
operator|==
name|PCMTRIG_ABORT
condition|?
literal|"PCMTRIG_ABORT"
else|:
literal|"ignore"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|go
condition|)
block|{
case|case
name|PCMTRIG_START
case|:
if|if
condition|(
name|ch
operator|->
name|active
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ch
operator|->
name|active
operator|=
literal|1
expr_stmt|;
name|ch
operator|->
name|ptr
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|prevptr
operator|=
literal|0
expr_stmt|;
comment|/*[[inc_timer_users]]*/
if|if
condition|(
name|m3_chan_active
argument_list|(
name|sc
argument_list|)
operator|==
literal|1
condition|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_RELOAD
argument_list|,
literal|240
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_CURRENT
argument_list|,
literal|240
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|,
name|data
operator||
name|CLKRUN_GEN_ENABLE
argument_list|)
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_ADC1_REQUEST
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_INSTANCE_READY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_STOP
case|:
case|case
name|PCMTRIG_ABORT
case|:
if|if
condition|(
name|ch
operator|->
name|active
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ch
operator|->
name|active
operator|=
literal|0
expr_stmt|;
comment|/*[[dec_timer_users]]*/
if|if
condition|(
name|m3_chan_active
argument_list|(
name|sc
argument_list|)
operator|==
literal|0
condition|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_RELOAD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TIMER_COUNT_CURRENT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|,
name|data
operator|&
operator|~
name|CLKRUN_GEN_ENABLE
argument_list|)
expr_stmt|;
block|}
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_INSTANCE_READY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_ADC1_REQUEST
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_EMLDMAWR
case|:
comment|/* got play irq, transfer next buffer - ignore if using dma */
case|case
name|PCMTRIG_EMLDMARD
case|:
comment|/* got rec irq, transfer next buffer - ignore if using dma */
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|m3_rchan_getptr_internal
parameter_list|(
name|struct
name|sc_rchinfo
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|hi
decl_stmt|,
name|lo
decl_stmt|,
name|bus_base
decl_stmt|,
name|bus_crnt
decl_stmt|;
name|bus_base
operator|=
name|sndbuf_getbufaddr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|hi
operator|=
name|m3_rd_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_CURRENTH
argument_list|)
expr_stmt|;
name|lo
operator|=
name|m3_rd_assp_data
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|adc_data
operator|+
name|CDATA_HOST_SRC_CURRENTL
argument_list|)
expr_stmt|;
name|bus_crnt
operator|=
name|lo
operator||
operator|(
name|hi
operator|<<
literal|16
operator|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_rchan_getptr(adc=%d) result=%d\n"
operator|,
name|ch
operator|->
name|adc_idx
operator|,
name|bus_crnt
operator|-
name|bus_base
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_crnt
operator|-
name|bus_base
operator|)
return|;
comment|/* current byte offset of channel */
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|m3_rchan_getptr
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|ch
operator|->
name|ptr
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|m3_rchan_getcaps
parameter_list|(
name|kobj_t
name|kobj
parameter_list|,
name|void
modifier|*
name|chdata
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|chdata
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_rchan_getcaps(adc=%d)\n"
operator|,
name|ch
operator|->
name|adc_idx
operator|)
argument_list|)
expr_stmt|;
return|return
operator|&
name|m3_reccaps
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* The interrupt handler */
end_comment

begin_function
specifier|static
name|void
name|m3_intr
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|p
decl_stmt|;
name|struct
name|sc_pchinfo
modifier|*
name|pch
decl_stmt|;
name|struct
name|sc_rchinfo
modifier|*
name|rch
decl_stmt|;
name|u_int32_t
name|status
decl_stmt|,
name|ctl
decl_stmt|,
name|i
decl_stmt|,
name|delta
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|INTR
argument_list|,
operator|(
literal|"m3_intr\n"
operator|)
argument_list|)
expr_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|status
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|HOST_INT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
block|{
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|HOST_INT_STATUS
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
comment|/* ack the int? */
if|if
condition|(
name|status
operator|&
name|HV_INT_PENDING
condition|)
block|{
name|u_int8_t
name|event
decl_stmt|;
name|event
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|HW_VOL_COUNTER_MASTER
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
literal|0x99
case|:
name|mixer_hwvol_mute
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xaa
case|:
name|mixer_hwvol_step
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x66
case|:
name|mixer_hwvol_step
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x88
case|:
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unknown HWVOL event\n"
argument_list|)
expr_stmt|;
block|}
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|HW_VOL_COUNTER_MASTER
argument_list|,
literal|0x88
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|ASSP_INT_PENDING
condition|)
block|{
name|ctl
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_B
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctl
operator|&
name|STOP_ASSP_CLOCK
operator|)
condition|)
block|{
name|ctl
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|ASSP_HOST_INT_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|&
name|DSP2HOST_REQ_TIMER
condition|)
block|{
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|ASSP_HOST_INT_STATUS
argument_list|,
name|DSP2HOST_REQ_TIMER
argument_list|)
expr_stmt|;
comment|/*[[ess_update_ptr]]*/
goto|goto
name|m3_handle_channel_intr
goto|;
block|}
block|}
block|}
goto|goto
name|m3_handle_channel_intr_out
goto|;
name|m3_handle_channel_intr
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|pch_cnt
condition|;
name|i
operator|++
control|)
block|{
name|pch
operator|=
operator|&
name|sc
operator|->
name|pch
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|pch
operator|->
name|active
condition|)
block|{
name|pch
operator|->
name|ptr
operator|=
name|m3_pchan_getptr_internal
argument_list|(
name|pch
argument_list|)
expr_stmt|;
name|delta
operator|=
name|pch
operator|->
name|bufsize
operator|+
name|pch
operator|->
name|ptr
operator|-
name|pch
operator|->
name|prevptr
expr_stmt|;
name|delta
operator|%=
name|pch
operator|->
name|bufsize
expr_stmt|;
if|if
condition|(
name|delta
operator|<
name|sndbuf_getblksz
argument_list|(
name|pch
operator|->
name|buffer
argument_list|)
condition|)
continue|continue;
name|pch
operator|->
name|prevptr
operator|=
name|pch
operator|->
name|ptr
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|chn_intr
argument_list|(
name|pch
operator|->
name|channel
argument_list|)
expr_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rch_cnt
condition|;
name|i
operator|++
control|)
block|{
name|rch
operator|=
operator|&
name|sc
operator|->
name|rch
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rch
operator|->
name|active
condition|)
block|{
name|rch
operator|->
name|ptr
operator|=
name|m3_rchan_getptr_internal
argument_list|(
name|rch
argument_list|)
expr_stmt|;
name|delta
operator|=
name|rch
operator|->
name|bufsize
operator|+
name|rch
operator|->
name|ptr
operator|-
name|rch
operator|->
name|prevptr
expr_stmt|;
name|delta
operator|%=
name|rch
operator|->
name|bufsize
expr_stmt|;
if|if
condition|(
name|delta
operator|<
name|sndbuf_getblksz
argument_list|(
name|rch
operator|->
name|buffer
argument_list|)
condition|)
continue|continue;
name|rch
operator|->
name|prevptr
operator|=
name|rch
operator|->
name|ptr
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|chn_intr
argument_list|(
name|rch
operator|->
name|channel
argument_list|)
expr_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|m3_handle_channel_intr_out
label|:
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* stuff */
end_comment

begin_function
specifier|static
name|int
name|m3_power
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_power(%d)\n"
operator|,
name|state
operator|)
argument_list|)
expr_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|0x34
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
condition|)
block|{
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|data
operator|+
literal|4
argument_list|,
name|state
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_init
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|,
name|i
decl_stmt|,
name|size
decl_stmt|;
name|u_int8_t
name|reset_state
decl_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_init\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* diable legacy emulations. */
name|data
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_LEGACY_AUDIO_CTRL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator||=
name|DISABLE_LEGACY
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_LEGACY_AUDIO_CTRL
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|m3_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|reset_state
operator|=
name|m3_assp_halt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m3_codec_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* [m3_assp_init] */
comment|/* zero kernel data */
name|size
operator|=
name|REV_B_DATA_MEMORY_UNIT_LENGTH
operator|*
name|NUM_UNITS_KERNEL_DATA
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_BASE_ADDR
operator|+
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* zero mixer data? */
name|size
operator|=
name|REV_B_DATA_MEMORY_UNIT_LENGTH
operator|*
name|NUM_UNITS_KERNEL_DATA
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_BASE_ADDR2
operator|+
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* init dma pointer */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_CURRENT_DMA
argument_list|,
name|KDATA_DMA_XFER0
argument_list|)
expr_stmt|;
comment|/* write kernel into code memory */
name|size
operator|=
sizeof|sizeof
argument_list|(
name|assp_kernel_image
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_code
argument_list|(
name|sc
argument_list|,
name|REV_B_CODE_MEMORY_BEGIN
operator|+
name|i
argument_list|,
name|assp_kernel_image
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * We only have this one client and we know that 0x400 is free in 	 * our kernel's mem map, so lets just drop it there.  It seems that 	 * the minisrc doesn't need vectors, so we won't bother with them.. 	 */
name|size
operator|=
sizeof|sizeof
argument_list|(
name|assp_minisrc_image
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_code
argument_list|(
name|sc
argument_list|,
literal|0x400
operator|+
name|i
argument_list|,
name|assp_minisrc_image
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* write the coefficients for the low pass filter? */
name|size
operator|=
sizeof|sizeof
argument_list|(
name|minisrc_lpf_image
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_code
argument_list|(
name|sc
argument_list|,
literal|0x400
operator|+
name|MINISRC_COEF_LOC
operator|+
name|i
argument_list|,
name|minisrc_lpf_image
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|m3_wr_assp_code
argument_list|(
name|sc
argument_list|,
literal|0x400
operator|+
name|MINISRC_COEF_LOC
operator|+
name|size
argument_list|,
literal|0x8000
argument_list|)
expr_stmt|;
comment|/* the minisrc is the only thing on our task list */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_TASK0
argument_list|,
literal|0x400
argument_list|)
expr_stmt|;
comment|/* init the mixer number */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_MIXER_TASK_NUMBER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* extreme kernel master volume */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_DAC_LEFT_VOLUME
argument_list|,
name|ARB_VOLUME
argument_list|)
expr_stmt|;
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_DAC_RIGHT_VOLUME
argument_list|,
name|ARB_VOLUME
argument_list|)
expr_stmt|;
name|m3_amp_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* [m3_assp_client_init] (only one client at index 0) */
for|for
control|(
name|i
operator|=
literal|0x1100
init|;
name|i
operator|<
literal|0x1c00
condition|;
name|i
operator|++
control|)
block|{
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* zero entire dac/adc area */
block|}
comment|/* [m3_assp_continue] */
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_CONTROL_REG_B
argument_list|,
name|reset_state
operator||
name|REGB_ENABLE_RESET
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_uninit
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_uninit\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* Probe and attach the card */
end_comment

begin_function
specifier|static
name|int
name|m3_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|m3_card_type
modifier|*
name|card
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_pci_probe(0x%x)\n"
operator|,
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|card
operator|=
name|m3_card_types
init|;
name|card
operator|->
name|pci_id
condition|;
name|card
operator|++
control|)
block|{
if|if
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
operator|==
name|card
operator|->
name|pci_id
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|card
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|BUS_PROBE_DEFAULT
return|;
block|}
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|struct
name|ac97_info
modifier|*
name|codec
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|char
name|status
index|[
name|SND_STATUSLEN
index|]
decl_stmt|;
name|struct
name|m3_card_type
modifier|*
name|card
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|dacn
decl_stmt|,
name|adcn
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_pci_attach\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate softc\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|type
operator|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_lock
operator|=
name|snd_mtxcreate
argument_list|(
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"snd_maestro3 softc"
argument_list|)
expr_stmt|;
for|for
control|(
name|card
operator|=
name|m3_card_types
init|;
name|card
operator|->
name|pci_id
condition|;
name|card
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|type
operator|==
name|card
operator|->
name|pci_id
condition|)
block|{
name|sc
operator|->
name|which
operator|=
name|card
operator|->
name|which
expr_stmt|;
name|sc
operator|->
name|delay1
operator|=
name|card
operator|->
name|delay1
expr_stmt|;
name|sc
operator|->
name|delay2
operator|=
name|card
operator|->
name|delay2
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"dac"
argument_list|,
operator|&
name|i
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|<
literal|1
condition|)
name|dacn
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|>
name|M3_PCHANS
condition|)
name|dacn
operator|=
name|M3_PCHANS
expr_stmt|;
else|else
name|dacn
operator|=
name|i
expr_stmt|;
block|}
else|else
name|dacn
operator|=
name|M3_PCHANS
expr_stmt|;
name|adcn
operator|=
name|M3_RCHANS
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator||=
operator|(
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_MEMEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regtype
operator|=
name|SYS_RES_MEMORY
expr_stmt|;
name|sc
operator|->
name|reg
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|regtype
argument_list|,
operator|&
name|sc
operator|->
name|regid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|reg
condition|)
block|{
name|sc
operator|->
name|regtype
operator|=
name|SYS_RES_IOPORT
expr_stmt|;
name|sc
operator|->
name|reg
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|regtype
argument_list|,
operator|&
name|sc
operator|->
name|regid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sc
operator|->
name|reg
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to allocate register space\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|st
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irqid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|irqid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|irq
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to allocate interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|snd_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|INTR_MPSAFE
argument_list|,
name|m3_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ih
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|bufsz
operator|=
name|pcm_getbuffersize
argument_list|(
name|dev
argument_list|,
name|M3_BUFSIZE_MIN
argument_list|,
name|M3_BUFSIZE_DEFAULT
argument_list|,
name|M3_BUFSIZE_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
comment|/* parent */
literal|2
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|M3_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filtfunc, filtfuncarg */
name|sc
operator|->
name|bufsz
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
literal|0x3ffff
argument_list|,
comment|/* maxsegz */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
comment|/* lockfunc */
name|NULL
argument_list|,
comment|/* lockfuncarg */
operator|&
name|sc
operator|->
name|parent_dmat
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create dma tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m3_power
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* power up */
comment|/* init chip */
name|i
operator|=
name|m3_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to initialize the card\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* create/init mixer */
name|codec
operator|=
name|AC97_CREATE
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
name|m3_codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|codec
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"ac97_create error\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|mixer_init
argument_list|(
name|dev
argument_list|,
name|ac97_getmixerclass
argument_list|()
argument_list|,
name|codec
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"mixer_init error\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|m3_enable_ints
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcm_register
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
name|dacn
argument_list|,
name|adcn
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"pcm_register error\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dacn
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_PLAY
argument_list|,
operator|&
name|m3_pch_class
argument_list|,
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"pcm_addchan (play) error\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|adcn
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_REC
argument_list|,
operator|&
name|m3_rch_class
argument_list|,
name|sc
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"pcm_addchan (rec) error\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
name|snprintf
argument_list|(
name|status
argument_list|,
name|SND_STATUSLEN
argument_list|,
literal|"at %s 0x%lx irq %ld %s"
argument_list|,
operator|(
name|sc
operator|->
name|regtype
operator|==
name|SYS_RES_IOPORT
operator|)
condition|?
literal|"io"
else|:
literal|"memory"
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|reg
argument_list|)
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|irq
argument_list|)
argument_list|,
name|PCM_KLDSTRING
argument_list|(
name|snd_maestro3
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcm_setstatus
argument_list|(
name|dev
argument_list|,
name|status
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"attach: pcm_setstatus error\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|mixer_hwvol_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Create the buffer for saving the card state during suspend */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|u_int16_t
argument_list|)
operator|*
operator|(
name|REV_B_CODE_MEMORY_LENGTH
operator|+
name|REV_B_DATA_MEMORY_LENGTH
operator|)
expr_stmt|;
name|sc
operator|->
name|savemem
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|savemem
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Failed to create suspend buffer\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
return|return
literal|0
return|;
name|bad
label|:
if|if
condition|(
name|codec
condition|)
name|ac97_destroy
argument_list|(
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ih
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|reg
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|regtype
argument_list|,
name|sc
operator|->
name|regid
argument_list|,
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|parent_dmat
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_lock
condition|)
name|snd_mtxfree
argument_list|(
name|sc
operator|->
name|sc_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|r
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_pci_detach\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|pcm_unregister
argument_list|(
name|dev
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
return|return
name|r
return|;
block|}
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m3_uninit
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* shutdown chip */
name|m3_power
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* power off */
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|regtype
argument_list|,
name|sc
operator|->
name|regid
argument_list|,
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
operator|->
name|savemem
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|snd_mtxfree
argument_list|(
name|sc
operator|->
name|sc_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pci_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|index
init|=
literal|0
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_pci_suspend\n"
operator|)
argument_list|)
expr_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|pch_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|pch
index|[
name|i
index|]
operator|.
name|active
condition|)
block|{
name|m3_pchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|pch
index|[
name|i
index|]
argument_list|,
name|PCMTRIG_STOP
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rch_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|rch
index|[
name|i
index|]
operator|.
name|active
condition|)
block|{
name|m3_rchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|rch
index|[
name|i
index|]
argument_list|,
name|PCMTRIG_STOP
argument_list|)
expr_stmt|;
block|}
block|}
name|DELAY
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* give things a chance to stop */
comment|/* Disable interrupts */
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_C
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_assp_halt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Save the state of the ASSP */
for|for
control|(
name|i
operator|=
name|REV_B_CODE_MEMORY_BEGIN
init|;
name|i
operator|<=
name|REV_B_CODE_MEMORY_END
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|savemem
index|[
name|index
operator|++
index|]
operator|=
name|m3_rd_assp_code
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|REV_B_DATA_MEMORY_BEGIN
init|;
name|i
operator|<=
name|REV_B_DATA_MEMORY_END
condition|;
name|i
operator|++
control|)
name|sc
operator|->
name|savemem
index|[
name|index
operator|++
index|]
operator|=
name|m3_rd_assp_data
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* Power down the card to D3 state */
name|m3_power
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pci_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|index
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|reset_state
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CHANGE
argument_list|,
operator|(
literal|"m3_pci_resume\n"
operator|)
argument_list|)
expr_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Power the card back to D0 */
name|m3_power
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|reset_state
operator|=
name|m3_assp_halt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m3_codec_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Restore the ASSP state */
for|for
control|(
name|i
operator|=
name|REV_B_CODE_MEMORY_BEGIN
init|;
name|i
operator|<=
name|REV_B_CODE_MEMORY_END
condition|;
name|i
operator|++
control|)
name|m3_wr_assp_code
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|sc
operator|->
name|savemem
index|[
name|index
operator|++
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|REV_B_DATA_MEMORY_BEGIN
init|;
name|i
operator|<=
name|REV_B_DATA_MEMORY_END
condition|;
name|i
operator|++
control|)
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|i
argument_list|,
name|sc
operator|->
name|savemem
index|[
name|index
operator|++
index|]
argument_list|)
expr_stmt|;
comment|/* Restart the DMA engine */
name|m3_wr_assp_data
argument_list|(
name|sc
argument_list|,
name|KDATA_DMA_ACTIVE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* [m3_assp_continue] */
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_CONTROL_REG_B
argument_list|,
name|reset_state
operator||
name|REGB_ENABLE_RESET
argument_list|)
expr_stmt|;
name|m3_amp_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m3_enable_ints
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|mixer_reinit
argument_list|(
name|dev
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reinitialize the mixer\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Turn the channels back on */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|pch_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|pch
index|[
name|i
index|]
operator|.
name|active
condition|)
block|{
name|m3_pchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|pch
index|[
name|i
index|]
argument_list|,
name|PCMTRIG_START
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|rch_cnt
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|rch
index|[
name|i
index|]
operator|.
name|active
condition|)
block|{
name|m3_rchan_trigger_locked
argument_list|(
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|rch
index|[
name|i
index|]
argument_list|,
name|PCMTRIG_START
argument_list|)
expr_stmt|;
block|}
block|}
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|m3_pci_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|M3_DEBUG
argument_list|(
name|CALL
argument_list|,
operator|(
literal|"m3_pci_shutdown\n"
operator|)
argument_list|)
expr_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|m3_power
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* power off */
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int8_t
name|m3_assp_halt
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int8_t
name|data
decl_stmt|,
name|reset_state
decl_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_CONTROL_REG_B
argument_list|)
expr_stmt|;
name|reset_state
operator|=
name|data
operator|&
operator|~
name|REGB_STOP_CLOCK
expr_stmt|;
comment|/* remember for continue */
name|DELAY
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|DSP_PORT_CONTROL_REG_B
argument_list|,
name|reset_state
operator|&
operator|~
name|REGB_ENABLE_RESET
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/* necessary? */
return|return
name|reset_state
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|m3_config
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|,
name|hv_cfg
decl_stmt|;
name|int
name|hint
decl_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M3_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * The volume buttons can be wired up via two different sets of pins. 	 * This presents a problem since we can't tell which way it's 	 * configured.  Allow the user to set a hint in order to twiddle 	 * the proper bits. 	 */
if|if
condition|(
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
literal|"hwvol_config"
argument_list|,
operator|&
name|hint
argument_list|)
operator|==
literal|0
condition|)
name|hv_cfg
operator|=
operator|(
name|hint
operator|>
literal|0
operator|)
condition|?
name|HV_BUTTON_FROM_GD
else|:
literal|0
expr_stmt|;
else|else
name|hv_cfg
operator|=
name|HV_BUTTON_FROM_GD
expr_stmt|;
name|M3_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_ALLEGRO_CONFIG
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
name|HV_BUTTON_FROM_GD
expr_stmt|;
name|data
operator||=
name|REDUCED_DEBOUNCE
operator||
name|HV_CTRL_ENABLE
operator||
name|hv_cfg
expr_stmt|;
name|data
operator||=
name|PM_CTRL_ENABLE
operator||
name|CLK_DIV_BY_49
operator||
name|USE_PCI_TIMING
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_ALLEGRO_CONFIG
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_B
argument_list|,
name|RESET_ASSP
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_ALLEGRO_CONFIG
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
name|INT_CLK_SELECT
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|which
operator|==
name|ESS_MAESTRO3
condition|)
block|{
name|data
operator|&=
operator|~
name|INT_CLK_MULT_ENABLE
expr_stmt|;
name|data
operator||=
name|INT_CLK_SRC_NOT_PCI
expr_stmt|;
block|}
name|data
operator|&=
operator|~
operator|(
name|CLK_MULT_MODE_SELECT
operator||
name|CLK_MULT_MODE_SELECT_2
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_ALLEGRO_CONFIG
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|which
operator|==
name|ESS_ALLEGRO_1
condition|)
block|{
name|data
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_USER_CONFIG
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator||=
name|IN_CLK_12MHZ_SELECT
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCI_USER_CONFIG
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|data
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_A
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
operator|(
name|DSP_CLK_36MHZ_SELECT
operator||
name|ASSP_CLK_49MHZ_SELECT
operator|)
expr_stmt|;
name|data
operator||=
name|ASSP_CLK_49MHZ_SELECT
expr_stmt|;
comment|/*XXX assumes 49MHZ dsp XXX*/
name|data
operator||=
name|ASSP_0_WS_ENABLE
expr_stmt|;
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_A
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_B
argument_list|,
name|RUN_ASSP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|m3_enable_ints
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int8_t
name|data
decl_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|HOST_INT_CTRL
argument_list|,
name|ASSP_INT_ENABLE
operator||
name|HV_INT_ENABLE
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_C
argument_list|)
expr_stmt|;
name|m3_wr_1
argument_list|(
name|sc
argument_list|,
name|ASSP_CONTROL_C
argument_list|,
name|data
operator||
name|ASSP_HOST_INT_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|m3_amp_enable
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|gpo
decl_stmt|,
name|polarity_port
decl_stmt|,
name|polarity
decl_stmt|;
name|u_int16_t
name|data
decl_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|which
condition|)
block|{
case|case
name|ESS_ALLEGRO_1
case|:
name|polarity_port
operator|=
literal|0x1800
expr_stmt|;
break|break;
case|case
name|ESS_MAESTRO3
case|:
name|polarity_port
operator|=
literal|0x1100
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"bad sc->which"
argument_list|)
expr_stmt|;
block|}
name|gpo
operator|=
operator|(
name|polarity_port
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|polarity
operator|=
name|polarity_port
operator|>>
literal|12
expr_stmt|;
name|polarity
operator|=
operator|!
name|polarity
expr_stmt|;
comment|/* enable */
name|polarity
operator|=
name|polarity
operator|<<
name|gpo
expr_stmt|;
name|gpo
operator|=
literal|1
operator|<<
name|gpo
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_MASK
argument_list|,
operator|~
name|gpo
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DIRECTION
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DIRECTION
argument_list|,
name|data
operator||
name|gpo
argument_list|)
expr_stmt|;
name|data
operator|=
name|GPO_SECONDARY_AC97
operator||
name|GPO_PRIMARY_AC97
operator||
name|polarity
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_MASK
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|m3_codec_reset
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int16_t
name|data
decl_stmt|,
name|dir
decl_stmt|;
name|int
name|retry
init|=
literal|0
decl_stmt|;
name|M3_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
do|do
block|{
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DIRECTION
argument_list|)
expr_stmt|;
name|dir
operator|=
name|data
operator||
literal|0x10
expr_stmt|;
comment|/* assuming pci bus master? */
comment|/* [[remote_codec_config]] */
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|RING_BUS_CTRL_B
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|RING_BUS_CTRL_B
argument_list|,
name|data
operator|&
operator|~
name|SECOND_CODEC_ID_MASK
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|SDO_OUT_DEST_CTRL
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|SDO_OUT_DEST_CTRL
argument_list|,
name|data
operator|&
operator|~
name|COMMAND_ADDR_OUT
argument_list|)
expr_stmt|;
name|data
operator|=
name|m3_rd_2
argument_list|(
name|sc
argument_list|,
name|SDO_IN_DEST_CTRL
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|SDO_IN_DEST_CTRL
argument_list|,
name|data
operator|&
operator|~
name|STATUS_ADDR_IN
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|RING_BUS_CTRL_A
argument_list|,
name|IO_SRAM_ENABLE
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DIRECTION
argument_list|,
name|dir
operator|&
operator|~
name|GPO_PRIMARY_AC97
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_MASK
argument_list|,
operator|~
name|GPO_PRIMARY_AC97
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DATA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DIRECTION
argument_list|,
name|dir
operator||
name|GPO_PRIMARY_AC97
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|sc
operator|->
name|delay1
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/*delay1 (ALLEGRO:50, MAESTRO3:20)*/
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_DATA
argument_list|,
name|GPO_PRIMARY_AC97
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|RING_BUS_CTRL_A
argument_list|,
name|IO_SRAM_ENABLE
operator||
name|SERIAL_AC_LINK_ENABLE
argument_list|)
expr_stmt|;
name|m3_wr_2
argument_list|(
name|sc
argument_list|,
name|GPIO_MASK
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|sc
operator|->
name|delay2
operator|*
literal|1000
argument_list|)
expr_stmt|;
comment|/*delay2 (ALLEGRO:800, MAESTRO3:500)*/
comment|/* [[try read vendor]] */
name|data
operator|=
name|m3_rdcd
argument_list|(
name|NULL
argument_list|,
name|sc
argument_list|,
literal|0x7c
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|==
literal|0
operator|)
operator|||
operator|(
name|data
operator|==
literal|0xffff
operator|)
condition|)
block|{
name|retry
operator|++
expr_stmt|;
if|if
condition|(
name|retry
operator|>
literal|3
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Codec reset failed\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Codec reset retry\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|retry
operator|=
literal|0
expr_stmt|;
block|}
do|while
condition|(
name|retry
condition|)
do|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|m3_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|m3_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|m3_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|m3_pci_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|m3_pci_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|m3_pci_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|m3_pci_shutdown
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|m3_driver
init|=
block|{
literal|"pcm"
block|,
name|m3_methods
block|,
name|PCM_SOFTC_SIZE
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|snd_maestro3
argument_list|,
name|pci
argument_list|,
name|m3_driver
argument_list|,
name|pcm_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|snd_maestro3
argument_list|,
name|sound
argument_list|,
name|SOUND_MINVER
argument_list|,
name|SOUND_PREFVER
argument_list|,
name|SOUND_MAXVER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|snd_maestro3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


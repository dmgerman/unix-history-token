begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000 Katsurajima Naoto<raven@katsurajima.seya.yokohama.jp>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHERIN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THEPOSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/ac97.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_define
define|#
directive|define
name|ICH_RECPRIMARY
value|0
end_define

begin_define
define|#
directive|define
name|ICH_TIMEOUT
value|1000
end_define

begin_comment
comment|/* semaphore timeout polling count */
end_comment

begin_define
define|#
directive|define
name|PCIR_NAMBAR
value|0x10
end_define

begin_define
define|#
directive|define
name|PCIR_NABMBAR
value|0x14
end_define

begin_comment
comment|/* Native Audio Bus Master Control Registers */
end_comment

begin_define
define|#
directive|define
name|ICH_REG_PI_BDBAR
value|0x00
end_define

begin_define
define|#
directive|define
name|ICH_REG_PI_CIV
value|0x04
end_define

begin_define
define|#
directive|define
name|ICH_REG_PI_LVI
value|0x05
end_define

begin_define
define|#
directive|define
name|ICH_REG_PI_SR
value|0x06
end_define

begin_define
define|#
directive|define
name|ICH_REG_PI_PICB
value|0x08
end_define

begin_define
define|#
directive|define
name|ICH_REG_PI_PIV
value|0x0a
end_define

begin_define
define|#
directive|define
name|ICH_REG_PI_CR
value|0x0b
end_define

begin_define
define|#
directive|define
name|ICH_REG_PO_BDBAR
value|0x10
end_define

begin_define
define|#
directive|define
name|ICH_REG_PO_CIV
value|0x14
end_define

begin_define
define|#
directive|define
name|ICH_REG_PO_LVI
value|0x15
end_define

begin_define
define|#
directive|define
name|ICH_REG_PO_SR
value|0x16
end_define

begin_define
define|#
directive|define
name|ICH_REG_PO_PICB
value|0x18
end_define

begin_define
define|#
directive|define
name|ICH_REG_PO_PIV
value|0x1a
end_define

begin_define
define|#
directive|define
name|ICH_REG_PO_CR
value|0x1b
end_define

begin_define
define|#
directive|define
name|ICH_REG_MC_BDBAR
value|0x20
end_define

begin_define
define|#
directive|define
name|ICH_REG_MC_CIV
value|0x24
end_define

begin_define
define|#
directive|define
name|ICH_REG_MC_LVI
value|0x25
end_define

begin_define
define|#
directive|define
name|ICH_REG_MC_SR
value|0x26
end_define

begin_define
define|#
directive|define
name|ICH_REG_MC_PICB
value|0x28
end_define

begin_define
define|#
directive|define
name|ICH_REG_MC_PIV
value|0x2a
end_define

begin_define
define|#
directive|define
name|ICH_REG_MC_CR
value|0x2b
end_define

begin_define
define|#
directive|define
name|ICH_REG_GLOB_CNT
value|0x2c
end_define

begin_define
define|#
directive|define
name|ICH_REG_GLOB_STA
value|0x30
end_define

begin_define
define|#
directive|define
name|ICH_REG_ACC_SEMA
value|0x34
end_define

begin_comment
comment|/* Status Register Values */
end_comment

begin_define
define|#
directive|define
name|ICH_X_SR_DCH
value|0x0001
end_define

begin_define
define|#
directive|define
name|ICH_X_SR_CELV
value|0x0002
end_define

begin_define
define|#
directive|define
name|ICH_X_SR_LVBCI
value|0x0004
end_define

begin_define
define|#
directive|define
name|ICH_X_SR_BCIS
value|0x0008
end_define

begin_define
define|#
directive|define
name|ICH_X_SR_FIFOE
value|0x0010
end_define

begin_comment
comment|/* Control Register Values */
end_comment

begin_define
define|#
directive|define
name|ICH_X_CR_RPBM
value|0x01
end_define

begin_define
define|#
directive|define
name|ICH_X_CR_RR
value|0x02
end_define

begin_define
define|#
directive|define
name|ICH_X_CR_LVBIE
value|0x04
end_define

begin_define
define|#
directive|define
name|ICH_X_CR_FEIE
value|0x08
end_define

begin_define
define|#
directive|define
name|ICH_X_CR_IOCE
value|0x10
end_define

begin_comment
comment|/* Global Control Register Values */
end_comment

begin_define
define|#
directive|define
name|ICH_GLOB_CTL_GIE
value|0x00000001
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_CTL_COLD
value|0x00000002
end_define

begin_comment
comment|/* negate */
end_comment

begin_define
define|#
directive|define
name|ICH_GLOB_CTL_WARM
value|0x00000004
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_CTL_SHUT
value|0x00000008
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_CTL_PRES
value|0x00000010
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_CTL_SRES
value|0x00000020
end_define

begin_comment
comment|/* Global Status Register Values */
end_comment

begin_define
define|#
directive|define
name|ICH_GLOB_STA_GSCI
value|0x00000001
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_MIINT
value|0x00000002
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_MOINT
value|0x00000004
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_PIINT
value|0x00000020
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_POINT
value|0x00000040
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_MINT
value|0x00000080
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_PCR
value|0x00000100
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_SCR
value|0x00000200
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_PRES
value|0x00000400
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_SRES
value|0x00000800
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_SLOT12
value|0x00007000
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_RCODEC
value|0x00008000
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_AD3
value|0x00010000
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_MD3
value|0x00020000
end_define

begin_define
define|#
directive|define
name|ICH_GLOB_STA_IMASK
value|(ICH_GLOB_STA_MIINT | ICH_GLOB_STA_MOINT | ICH_GLOB_STA_PIINT | ICH_GLOB_STA_POINT | ICH_GLOB_STA_MINT | ICH_GLOB_STA_PRES | ICH_GLOB_STA_SRES)
end_define

begin_comment
comment|/* AC'97 power/ready functions */
end_comment

begin_define
define|#
directive|define
name|AC97_POWER_PINPOWER
value|0x0100
end_define

begin_define
define|#
directive|define
name|AC97_POWER_PINREADY
value|0x0001
end_define

begin_define
define|#
directive|define
name|AC97_POWER_POUTPOWER
value|0x0200
end_define

begin_define
define|#
directive|define
name|AC97_POWER_POUTREADY
value|0x0002
end_define

begin_comment
comment|/* play/record buffer */
end_comment

begin_define
define|#
directive|define
name|ICH_FIFOINDEX
value|32
end_define

begin_define
define|#
directive|define
name|ICH_BDC_IOC
value|0x80000000
end_define

begin_define
define|#
directive|define
name|ICH_BDC_BUP
value|0x40000000
end_define

begin_define
define|#
directive|define
name|ICH_DEFAULT_BLOCKSZ
value|2048
end_define

begin_comment
comment|/* buffer descriptor */
end_comment

begin_struct
struct|struct
name|ich_desc
block|{
specifier|volatile
name|u_int32_t
name|buffer
decl_stmt|;
specifier|volatile
name|u_int32_t
name|length
decl_stmt|;
block|}
struct|;
end_struct

begin_struct_decl
struct_decl|struct
name|sc_info
struct_decl|;
end_struct_decl

begin_comment
comment|/* channel registers */
end_comment

begin_struct
struct|struct
name|sc_chinfo
block|{
name|int
name|run
decl_stmt|,
name|spd
decl_stmt|,
name|dir
decl_stmt|,
name|fmt
decl_stmt|;
name|struct
name|snd_dbuf
modifier|*
name|buffer
decl_stmt|;
name|struct
name|pcm_channel
modifier|*
name|channel
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|parent
decl_stmt|;
name|struct
name|ich_desc
modifier|*
name|index
decl_stmt|;
name|bus_dmamap_t
name|imap
decl_stmt|;
name|u_int32_t
name|lvi
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* device private data */
end_comment

begin_struct
struct|struct
name|sc_info
block|{
name|device_t
name|dev
decl_stmt|;
name|u_int32_t
name|type
decl_stmt|,
name|rev
decl_stmt|;
name|u_int32_t
name|cd2id
decl_stmt|,
name|ctrlbase
decl_stmt|;
name|struct
name|resource
modifier|*
name|nambar
decl_stmt|,
modifier|*
name|nabmbar
decl_stmt|;
name|int
name|nambarid
decl_stmt|,
name|nabmbarid
decl_stmt|;
name|bus_space_tag_t
name|nambart
decl_stmt|,
name|nabmbart
decl_stmt|;
name|bus_space_handle_t
name|nambarh
decl_stmt|,
name|nabmbarh
decl_stmt|;
name|bus_dma_tag_t
name|dmat
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
name|int
name|irqid
decl_stmt|;
name|void
modifier|*
name|ih
decl_stmt|;
name|struct
name|ac97_info
modifier|*
name|codec
decl_stmt|;
name|struct
name|sc_chinfo
modifier|*
name|pi
decl_stmt|,
modifier|*
name|po
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
block|{
name|u_int32_t
name|dev
decl_stmt|,
name|subdev
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
name|ich_devs
index|[]
init|=
block|{
block|{
literal|0x71958086
block|,
literal|0
block|,
literal|"Intel 443MX"
block|}
block|,
block|{
literal|0x24138086
block|,
literal|0
block|,
literal|"Intel 82801AA (ICH)"
block|}
block|,
block|{
literal|0x24158086
block|,
literal|0
block|,
literal|"Intel 82801AA (ICH)"
block|}
block|,
block|{
literal|0x24258086
block|,
literal|0
block|,
literal|"Intel 82901AB (ICH)"
block|}
block|,
block|{
literal|0x24458086
block|,
literal|0
block|,
literal|"Intel 82801BA (ICH2)"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_comment
comment|/* variable rate audio */
end_comment

begin_decl_stmt
specifier|static
name|u_int32_t
name|ich_rate
index|[]
init|=
block|{
literal|48000
block|,
literal|44100
block|,
literal|22050
block|,
literal|16000
block|,
literal|11025
block|,
literal|8000
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * prototypes  */
end_comment

begin_comment
comment|/* channel interface */
end_comment

begin_function_decl
specifier|static
name|void
modifier|*
name|ichpchan_init
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
parameter_list|,
name|struct
name|pcm_channel
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichpchan_setformat
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichpchan_setspeed
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichpchan_setblocksize
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichpchan_trigger
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichpchan_getptr
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|ichpchan_getcaps
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ichrchan_init
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
parameter_list|,
name|struct
name|pcm_channel
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichrchan_setformat
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichrchan_setspeed
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichrchan_setblocksize
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichrchan_trigger
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ichrchan_getptr
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|ichrchan_getcaps
parameter_list|(
name|kobj_t
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* stuff */
end_comment

begin_function_decl
specifier|static
name|int
name|ich_init
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ich_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_decl_stmt
specifier|static
name|u_int32_t
name|ich_recfmt
index|[]
init|=
block|{
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|ich_reccaps
init|=
block|{
literal|8000
block|,
literal|48000
block|,
name|ich_recfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|ich_playfmt
index|[]
init|=
block|{
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|ich_playcaps
init|=
block|{
literal|8000
block|,
literal|48000
block|,
name|ich_playfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* Hardware */
end_comment

begin_function
specifier|static
name|u_int32_t
name|ich_rd
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
return|return
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|2
case|:
return|return
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|4
case|:
return|return
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|regno
argument_list|)
return|;
default|default:
return|return
literal|0xffffffff
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ich_wr
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* ac97 codec */
end_comment

begin_function
specifier|static
name|int
name|ich_waitcd
parameter_list|(
name|void
modifier|*
name|devinfo
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|data
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_ACC_SEMA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"CODEC semaphore timeout\n"
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ich_rdcd
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|int
name|regno
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|regno
operator|&=
literal|0xff
expr_stmt|;
name|ich_waitcd
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
name|ich_rd
argument_list|(
name|sc
argument_list|,
name|regno
argument_list|,
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ich_wrcd
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|regno
operator|&=
literal|0xff
expr_stmt|;
name|ich_waitcd
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ich_wr
argument_list|(
name|sc
argument_list|,
name|regno
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|ich_ac97_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|ac97_read
argument_list|,
name|ich_rdcd
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|ac97_write
argument_list|,
name|ich_wrcd
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|AC97_DECLARE
argument_list|(
name|ich_ac97
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* channel common routines */
end_comment

begin_function
specifier|static
name|void
name|ichchan_setmap
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"setmap(0x%lx, 0x%lx)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_addr
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ichchan_initbuf
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sndbuf_alloc
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|sc
operator|->
name|dmat
argument_list|,
name|ICH_DEFAULT_BLOCKSZ
operator|*
name|ICH_FIFOINDEX
argument_list|)
condition|)
block|{
return|return
name|ENOSPC
return|;
block|}
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ch
operator|->
name|index
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|ch
operator|->
name|imap
argument_list|)
condition|)
block|{
name|sndbuf_free
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
return|return
name|ENOSPC
return|;
block|}
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|ch
operator|->
name|imap
argument_list|,
name|ch
operator|->
name|index
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ich_desc
argument_list|)
operator|*
name|ICH_FIFOINDEX
argument_list|,
name|ichchan_setmap
argument_list|,
name|ch
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ch
operator|->
name|index
argument_list|,
name|ch
operator|->
name|imap
argument_list|)
expr_stmt|;
name|sndbuf_free
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
return|return
name|ENOSPC
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_FIFOINDEX
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|vtophys
argument_list|(
name|sndbuf_getbuf
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
argument_list|)
operator|+
name|ICH_DEFAULT_BLOCKSZ
operator|*
name|i
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|length
operator|=
literal|0
expr_stmt|;
else|else
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|length
operator|=
name|ICH_BDC_IOC
operator|+
name|ICH_DEFAULT_BLOCKSZ
operator|/
literal|2
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ichchan_free
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
name|ch
operator|->
name|imap
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmat
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ch
operator|->
name|index
argument_list|,
name|ch
operator|->
name|imap
argument_list|)
expr_stmt|;
name|sndbuf_free
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* play channel interface */
end_comment

begin_function
specifier|static
name|int
name|ichpchan_power
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|sw
parameter_list|)
block|{
name|u_int32_t
name|cr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cr
operator|=
name|ich_rdcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|)
expr_stmt|;
if|if
condition|(
name|sw
condition|)
block|{
comment|/* power on */
name|cr
operator|&=
operator|~
name|AC97_POWER_POUTPOWER
expr_stmt|;
name|ich_wrcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|,
name|cr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|ich_rdcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cr
operator|&
name|AC97_POWER_POUTREADY
operator|)
operator|!=
literal|0
condition|)
break|break;
block|}
block|}
else|else
block|{
comment|/* power off */
name|cr
operator||=
name|AC97_POWER_POUTPOWER
expr_stmt|;
name|ich_wrcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|,
name|cr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|ich_rdcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cr
operator|&
name|AC97_POWER_POUTREADY
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|ICH_TIMEOUT
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|ichpchan_getminspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|u_int32_t
name|extcap
decl_stmt|;
name|u_int32_t
name|minspeed
init|=
literal|48000
decl_stmt|;
comment|/* before AC'97 R2.0 */
name|int
name|i
init|=
literal|0
decl_stmt|;
name|extcap
operator|=
name|ac97_getextmode
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|extcap
operator|&
name|AC97_EXTCAP_VRA
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ich_rate
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ac97_setrate
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|,
name|AC97_REGEXT_FDACRATE
argument_list|,
name|ich_rate
index|[
name|i
index|]
argument_list|)
operator|==
name|ich_rate
index|[
name|i
index|]
condition|)
name|minspeed
operator|=
name|ich_rate
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
return|return
name|minspeed
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|ichpchan_init
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|devinfo
decl_stmt|;
name|struct
name|sc_chinfo
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|cr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
name|ICH_X_CR_RR
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cr
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|ICH_TIMEOUT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot reset play codec\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ichpchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"play DAC not ready\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ichpchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ch
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot allocate channel info area\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|ch
operator|->
name|dir
operator|=
name|PCMDIR_PLAY
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ichchan_initbuf
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot allocate channel buffer\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ch
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_BDBAR
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vtophys
argument_list|(
name|ch
operator|->
name|index
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|po
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Play codec support rate(Hz): "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ich_rate
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ichpchan_setspeed
argument_list|(
name|obj
argument_list|,
name|ch
argument_list|,
name|ich_rate
index|[
name|i
index|]
argument_list|)
operator|==
name|ich_rate
index|[
name|i
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|ich_rate
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|ich_playcaps
operator|.
name|minspeed
operator|=
name|ichpchan_getminspeed
argument_list|(
name|obj
argument_list|,
name|ch
argument_list|)
expr_stmt|;
return|return
name|ch
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichpchan_free
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ichchan_free
argument_list|(
name|ch
argument_list|)
expr_stmt|;
return|return
name|ichpchan_power
argument_list|(
name|obj
argument_list|,
name|ch
operator|->
name|parent
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichpchan_setformat
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|format
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichpchan_setspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|u_int32_t
name|extcap
decl_stmt|;
name|extcap
operator|=
name|ac97_getextmode
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|extcap
operator|&
name|AC97_EXTCAP_VRA
condition|)
block|{
name|ch
operator|->
name|spd
operator|=
operator|(
name|u_int32_t
operator|)
name|ac97_setrate
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|,
name|AC97_REGEXT_FDACRATE
argument_list|,
name|speed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|spd
operator|=
literal|48000
expr_stmt|;
comment|/* before AC'97 R2.0 */
block|}
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_setspeed():ch->spd = %d\n"
argument_list|,
name|ch
operator|->
name|spd
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ch
operator|->
name|spd
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichpchan_setblocksize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
return|return
name|blocksize
return|;
block|}
end_function

begin_comment
comment|/* update index */
end_comment

begin_function
specifier|static
name|void
name|ichpchan_update
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|lvi
decl_stmt|;
name|int
name|fp
decl_stmt|;
name|int
name|last
decl_stmt|;
name|int
name|i
decl_stmt|;
name|fp
operator|=
name|sndbuf_getfreeptr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|last
operator|=
name|fp
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|last
operator|<
literal|0
condition|)
name|last
operator|=
name|ICH_DEFAULT_BLOCKSZ
operator|*
name|ICH_FIFOINDEX
operator|-
literal|1
expr_stmt|;
name|lvi
operator|=
name|last
operator|/
name|ICH_DEFAULT_BLOCKSZ
expr_stmt|;
if|if
condition|(
name|lvi
operator|>=
name|ch
operator|->
name|lvi
condition|)
block|{
for|for
control|(
name|i
operator|=
name|ch
operator|->
name|lvi
init|;
name|i
operator|<
name|lvi
condition|;
name|i
operator|++
control|)
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|length
operator|=
name|ICH_BDC_IOC
operator|+
name|ICH_DEFAULT_BLOCKSZ
operator|/
literal|2
expr_stmt|;
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|length
operator|=
name|ICH_BDC_IOC
operator|+
name|ICH_BDC_BUP
operator|+
operator|(
name|last
operator|%
name|ICH_DEFAULT_BLOCKSZ
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
name|ch
operator|->
name|lvi
init|;
name|i
operator|<
name|ICH_FIFOINDEX
condition|;
name|i
operator|++
control|)
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|length
operator|=
name|ICH_BDC_IOC
operator|+
name|ICH_DEFAULT_BLOCKSZ
operator|/
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lvi
condition|;
name|i
operator|++
control|)
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|length
operator|=
name|ICH_BDC_IOC
operator|+
name|ICH_DEFAULT_BLOCKSZ
operator|/
literal|2
expr_stmt|;
name|ch
operator|->
name|index
index|[
name|i
index|]
operator|.
name|length
operator|=
name|ICH_BDC_IOC
operator|+
name|ICH_BDC_BUP
operator|+
operator|(
name|last
operator|%
name|ICH_DEFAULT_BLOCKSZ
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
block|}
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_LVI
argument_list|,
name|lvi
argument_list|)
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
name|lvi
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_update():fp = %d, lvi = %d\n"
argument_list|,
name|fp
argument_list|,
name|lvi
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|ichpchan_fillblank
parameter_list|(
name|struct
name|sc_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|ch
operator|->
name|lvi
operator|++
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|lvi
operator|==
name|ICH_FIFOINDEX
condition|)
name|ch
operator|->
name|lvi
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|index
index|[
name|ch
operator|->
name|lvi
index|]
operator|.
name|length
operator|=
name|ICH_BDC_BUP
operator|+
name|ICH_DEFAULT_BLOCKSZ
operator|/
literal|2
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_LVI
argument_list|,
name|ch
operator|->
name|lvi
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* semantic note: must start at beginning of buffer */
end_comment

begin_function
specifier|static
name|int
name|ichpchan_trigger
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|cr
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_trigger(0x%08x, %d)\n"
argument_list|,
name|data
argument_list|,
name|go
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|go
condition|)
block|{
case|case
name|PCMTRIG_START
case|:
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_trigger():PCMTRIG_START\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ch
operator|->
name|run
operator|=
literal|1
expr_stmt|;
name|ichpchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_BDBAR
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vtophys
argument_list|(
name|ch
operator|->
name|index
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
name|ICH_FIFOINDEX
operator|-
literal|1
expr_stmt|;
name|ichpchan_update
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
name|ICH_X_CR_RPBM
operator||
name|ICH_X_CR_LVBIE
operator||
name|ICH_X_CR_IOCE
operator||
name|ICH_X_CR_FEIE
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_STOP
case|:
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_trigger():PCMTRIG_STOP\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cr
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
name|cr
operator|&
operator|~
name|ICH_X_CR_RPBM
argument_list|)
expr_stmt|;
name|ichpchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|PCMTRIG_ABORT
case|:
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_trigger():PCMTRIG_ABORT\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
name|ICH_X_CR_RR
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cr
operator|==
literal|0
condition|)
break|break;
block|}
name|ichpchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichpchan_getptr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|ci
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_getptr(0x%08x)\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ci
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CIV
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|dev
argument_list|,
literal|"ichpchan_getptr():ICH_REG_PO_CIV = %d\n"
argument_list|,
name|ci
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ICH_DEFAULT_BLOCKSZ
operator|*
name|ci
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|ichpchan_getcaps
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
return|return
operator|&
name|ich_playcaps
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|ichpchan_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|ichpchan_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_free
argument_list|,
name|ichpchan_free
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|ichpchan_setformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|ichpchan_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|ichpchan_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|ichpchan_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|ichpchan_getptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|ichpchan_getcaps
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|CHANNEL_DECLARE
argument_list|(
name|ichpchan
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* record channel interface */
end_comment

begin_function
specifier|static
name|int
name|ichrchan_power
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|sw
parameter_list|)
block|{
name|u_int32_t
name|cr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cr
operator|=
name|ich_rdcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|)
expr_stmt|;
if|if
condition|(
name|sw
condition|)
block|{
comment|/* power on */
name|cr
operator|&=
operator|~
name|AC97_POWER_PINPOWER
expr_stmt|;
name|ich_wrcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|,
name|cr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|ich_rdcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cr
operator|&
name|AC97_POWER_PINREADY
operator|)
operator|!=
literal|0
condition|)
break|break;
block|}
block|}
else|else
block|{
comment|/* power off */
name|cr
operator||=
name|AC97_POWER_PINPOWER
expr_stmt|;
name|ich_wrcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|,
name|cr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|ich_rdcd
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
name|AC97_REG_POWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cr
operator|&
name|AC97_POWER_PINREADY
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|ICH_TIMEOUT
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|ichrchan_getminspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|u_int32_t
name|extcap
decl_stmt|;
name|u_int32_t
name|minspeed
init|=
literal|48000
decl_stmt|;
comment|/* before AC'97 R2.0 */
name|int
name|i
init|=
literal|0
decl_stmt|;
name|extcap
operator|=
name|ac97_getextmode
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|extcap
operator|&
name|AC97_EXTCAP_VRM
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ich_rate
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ac97_setrate
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|,
name|AC97_REGEXT_LADCRATE
argument_list|,
name|ich_rate
index|[
name|i
index|]
argument_list|)
operator|==
name|ich_rate
index|[
name|i
index|]
condition|)
name|minspeed
operator|=
name|ich_rate
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
return|return
name|minspeed
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|ichrchan_init
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|devinfo
decl_stmt|;
name|struct
name|sc_chinfo
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|cr
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* reset codec */
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
name|ICH_X_CR_RR
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cr
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|ICH_TIMEOUT
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot reset record codec\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ichrchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"record ADC not ready\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ichrchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ch
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot allocate channel info area\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|ch
operator|->
name|dir
operator|=
name|PCMDIR_REC
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ichchan_initbuf
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot allocate channel buffer\n"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ch
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_BDBAR
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vtophys
argument_list|(
name|ch
operator|->
name|index
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pi
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Record codec support rate(Hz): "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ich_rate
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ichrchan_setspeed
argument_list|(
name|obj
argument_list|,
name|ch
argument_list|,
name|ich_rate
index|[
name|i
index|]
argument_list|)
operator|==
name|ich_rate
index|[
name|i
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|ich_rate
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|ich_reccaps
operator|.
name|minspeed
operator|=
name|ichrchan_getminspeed
argument_list|(
name|obj
argument_list|,
name|ch
argument_list|)
expr_stmt|;
return|return
name|ch
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichrchan_free
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ichchan_free
argument_list|(
name|ch
argument_list|)
expr_stmt|;
return|return
name|ichrchan_power
argument_list|(
name|obj
argument_list|,
name|ch
operator|->
name|parent
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichrchan_setformat
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|format
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichrchan_setspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|u_int32_t
name|extcap
decl_stmt|;
name|extcap
operator|=
name|ac97_getextmode
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|extcap
operator|&
name|AC97_EXTCAP_VRM
condition|)
block|{
name|ch
operator|->
name|spd
operator|=
operator|(
name|u_int32_t
operator|)
name|ac97_setrate
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|codec
argument_list|,
name|AC97_REGEXT_LADCRATE
argument_list|,
name|speed
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|spd
operator|=
literal|48000
expr_stmt|;
comment|/* before AC'97 R2.0 */
block|}
return|return
name|ch
operator|->
name|spd
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichrchan_setblocksize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
return|return
name|blocksize
return|;
block|}
end_function

begin_comment
comment|/* semantic note: must start at beginning of buffer */
end_comment

begin_function
specifier|static
name|int
name|ichrchan_trigger
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|cr
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|go
condition|)
block|{
case|case
name|PCMTRIG_START
case|:
name|ch
operator|->
name|run
operator|=
literal|1
expr_stmt|;
name|ichrchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_BDBAR
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vtophys
argument_list|(
name|ch
operator|->
name|index
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
name|ICH_FIFOINDEX
operator|-
literal|1
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_LVI
argument_list|,
name|ch
operator|->
name|lvi
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
name|ICH_X_CR_RPBM
operator||
name|ICH_X_CR_LVBIE
operator||
name|ICH_X_CR_IOCE
operator||
name|ICH_X_CR_FEIE
argument_list|)
expr_stmt|;
break|break;
case|case
name|PCMTRIG_STOP
case|:
name|cr
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
name|cr
operator|&
operator|~
name|ICH_X_CR_RPBM
argument_list|)
expr_stmt|;
name|ichrchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|PCMTRIG_ABORT
case|:
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
name|ICH_X_CR_RR
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ICH_TIMEOUT
condition|;
name|i
operator|++
control|)
block|{
name|cr
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cr
operator|==
literal|0
condition|)
break|break;
block|}
name|ichrchan_power
argument_list|(
name|obj
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ichrchan_getptr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|ci
decl_stmt|;
name|ci
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CIV
argument_list|)
expr_stmt|;
return|return
name|ci
operator|*
name|ICH_DEFAULT_BLOCKSZ
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|ichrchan_getcaps
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
return|return
operator|&
name|ich_reccaps
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|ichrchan_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|ichrchan_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_free
argument_list|,
name|ichrchan_free
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|ichrchan_setformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|ichrchan_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|ichrchan_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|ichrchan_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|ichrchan_getptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|ichrchan_getcaps
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|CHANNEL_DECLARE
argument_list|(
name|ichrchan
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* The interrupt handler */
end_comment

begin_function
specifier|static
name|void
name|ich_intr
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|p
decl_stmt|;
name|struct
name|sc_chinfo
modifier|*
name|ch
decl_stmt|;
name|u_int32_t
name|cp
decl_stmt|;
name|u_int32_t
name|sg
decl_stmt|;
name|u_int32_t
name|st
decl_stmt|;
name|u_int32_t
name|lvi
init|=
literal|0
decl_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ich_intr(0x%08x)\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* check interface status */
name|sg
operator|=
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_GLOB_STA
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ich_intr():REG_GLOB_STA = 0x%08x\n"
argument_list|,
name|sg
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|sg
operator|&
name|ICH_GLOB_STA_POINT
condition|)
block|{
comment|/* PCM Out INTerrupt */
comment|/* mask interrupt */
name|cp
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|)
expr_stmt|;
name|cp
operator|&=
operator|~
operator|(
name|ICH_X_CR_LVBIE
operator||
name|ICH_X_CR_IOCE
operator||
name|ICH_X_CR_FEIE
operator|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
name|cp
argument_list|)
expr_stmt|;
comment|/* check channel status */
name|ch
operator|=
name|sc
operator|->
name|po
expr_stmt|;
name|st
operator|=
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_SR
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ich_intr():REG_PO_SR = 0x%02x\n"
argument_list|,
name|st
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|st
operator|&
operator|(
name|ICH_X_SR_BCIS
operator||
name|ICH_X_SR_LVBCI
operator|)
condition|)
block|{
comment|/* play buffer block complete */
if|if
condition|(
name|st
operator|&
name|ICH_X_SR_LVBCI
condition|)
name|lvi
operator|=
name|ch
operator|->
name|lvi
expr_stmt|;
comment|/* update buffer */
name|chn_intr
argument_list|(
name|ch
operator|->
name|channel
argument_list|)
expr_stmt|;
name|ichpchan_update
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|&
name|ICH_X_SR_LVBCI
condition|)
block|{
comment|/* re-check underflow status */
if|if
condition|(
name|lvi
operator|==
name|ch
operator|->
name|lvi
condition|)
block|{
comment|/* ch->buffer->underflow = 1; */
name|ichpchan_fillblank
argument_list|(
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* clear status bit */
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_SR
argument_list|,
name|st
operator|&
operator|(
name|ICH_X_SR_FIFOE
operator||
name|ICH_X_SR_BCIS
operator||
name|ICH_X_SR_LVBCI
operator|)
argument_list|)
expr_stmt|;
comment|/* set interrupt */
name|cp
operator||=
operator|(
name|ICH_X_CR_LVBIE
operator||
name|ICH_X_CR_IOCE
operator||
name|ICH_X_CR_FEIE
operator|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PO_CR
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sg
operator|&
name|ICH_GLOB_STA_PIINT
condition|)
block|{
comment|/* PCM In INTerrupt */
comment|/* mask interrupt */
name|cp
operator|=
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|)
expr_stmt|;
name|cp
operator|&=
operator|~
operator|(
name|ICH_X_CR_LVBIE
operator||
name|ICH_X_CR_IOCE
operator||
name|ICH_X_CR_FEIE
operator|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
name|cp
argument_list|)
expr_stmt|;
comment|/* check channel status */
name|ch
operator|=
name|sc
operator|->
name|pi
expr_stmt|;
name|st
operator|=
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_SR
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
literal|0
operator|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ich_intr():REG_PI_SR = 0x%02x\n"
argument_list|,
name|st
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|st
operator|&
operator|(
name|ICH_X_SR_BCIS
operator||
name|ICH_X_SR_LVBCI
operator|)
condition|)
block|{
comment|/* record buffer block filled */
if|if
condition|(
name|st
operator|&
name|ICH_X_SR_LVBCI
condition|)
name|lvi
operator|=
name|ch
operator|->
name|lvi
expr_stmt|;
comment|/* update space */
name|chn_intr
argument_list|(
name|ch
operator|->
name|channel
argument_list|)
expr_stmt|;
name|ch
operator|->
name|lvi
operator|=
name|sndbuf_getreadyptr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
operator|/
name|ICH_DEFAULT_BLOCKSZ
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|lvi
operator|<
literal|0
condition|)
name|ch
operator|->
name|lvi
operator|=
name|ICH_FIFOINDEX
operator|-
literal|1
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_LVI
argument_list|,
name|ch
operator|->
name|lvi
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|&
name|ICH_X_SR_LVBCI
condition|)
block|{
comment|/* re-check underflow status */
if|if
condition|(
name|lvi
operator|==
name|ch
operator|->
name|lvi
condition|)
block|{
name|ch
operator|->
name|lvi
operator|++
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|lvi
operator|==
name|ICH_FIFOINDEX
condition|)
name|ch
operator|->
name|lvi
operator|=
literal|0
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_LVI
argument_list|,
name|ch
operator|->
name|lvi
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* clear status bit */
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_SR
argument_list|,
name|st
operator|&
operator|(
name|ICH_X_SR_FIFOE
operator||
name|ICH_X_SR_BCIS
operator||
name|ICH_X_SR_LVBCI
operator|)
argument_list|)
expr_stmt|;
comment|/* set interrupt */
name|cp
operator||=
operator|(
name|ICH_X_CR_LVBIE
operator||
name|ICH_X_CR_IOCE
operator||
name|ICH_X_CR_FEIE
operator|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_PI_CR
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * Probe and attach the card  */
end_comment

begin_function
specifier|static
name|int
name|ich_init
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|stat
decl_stmt|;
name|u_int32_t
name|save
decl_stmt|;
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_GLOB_CNT
argument_list|,
name|ICH_GLOB_CTL_COLD
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|600000
argument_list|)
expr_stmt|;
name|stat
operator|=
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_GLOB_STA
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|stat
operator|&
name|ICH_GLOB_STA_PCR
operator|)
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|nabmbart
argument_list|,
name|sc
operator|->
name|nabmbarh
argument_list|,
name|ICH_REG_GLOB_CNT
argument_list|,
name|ICH_GLOB_CTL_COLD
operator||
name|ICH_GLOB_CTL_PRES
argument_list|)
expr_stmt|;
name|save
operator|=
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|AC97_MIX_MASTER
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|AC97_MIX_MASTER
argument_list|,
name|AC97_MUTE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ich_waitcd
argument_list|(
name|sc
argument_list|)
operator|==
name|ETIMEDOUT
condition|)
return|return
operator|-
literal|1
return|;
name|DELAY
argument_list|(
literal|600
argument_list|)
expr_stmt|;
comment|/* it is need for some system */
name|stat
operator|=
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|AC97_MIX_MASTER
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|!=
name|AC97_MUTE
condition|)
return|return
operator|-
literal|1
return|;
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|nambart
argument_list|,
name|sc
operator|->
name|nambarh
argument_list|,
name|AC97_MIX_MASTER
argument_list|,
name|save
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ich_finddev
parameter_list|(
name|u_int32_t
name|dev
parameter_list|,
name|u_int32_t
name|subdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ich_devs
index|[
name|i
index|]
operator|.
name|dev
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ich_devs
index|[
name|i
index|]
operator|.
name|dev
operator|==
name|dev
operator|&&
operator|(
name|ich_devs
index|[
name|i
index|]
operator|.
name|subdev
operator|==
name|subdev
operator|||
name|ich_devs
index|[
name|i
index|]
operator|.
name|subdev
operator|==
literal|0
operator|)
condition|)
return|return
name|i
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ich_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
name|subdev
decl_stmt|;
name|subdev
operator|=
operator|(
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|i
operator|=
name|ich_finddev
argument_list|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
argument_list|,
name|subdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|ich_devs
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ich_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
name|u_int32_t
name|subdev
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|char
name|status
index|[
name|SND_STATUSLEN
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|sc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate softc\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|bzero
argument_list|(
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|subdev
operator|=
operator|(
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|type
operator|=
name|ich_finddev
argument_list|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
argument_list|,
name|subdev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rev
operator|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator||=
operator|(
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_MEMEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nambarid
operator|=
name|PCIR_NAMBAR
expr_stmt|;
name|sc
operator|->
name|nabmbarid
operator|=
name|PCIR_NABMBAR
expr_stmt|;
name|sc
operator|->
name|nambar
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|sc
operator|->
name|nambarid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|256
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nabmbar
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|sc
operator|->
name|nabmbarid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|64
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|nambar
operator|||
operator|!
name|sc
operator|->
name|nabmbar
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map IO port space\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|nambart
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|nambar
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nambarh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|nambar
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nabmbart
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|nabmbar
argument_list|)
expr_stmt|;
name|sc
operator|->
name|nabmbarh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|nabmbar
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/*parent*/
name|NULL
argument_list|,
comment|/*alignment*/
literal|4
argument_list|,
comment|/*boundary*/
literal|0
argument_list|,
comment|/*lowaddr*/
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/*highaddr*/
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/*filter*/
name|NULL
argument_list|,
comment|/*filterarg*/
name|NULL
argument_list|,
comment|/*maxsize*/
literal|65536
argument_list|,
comment|/*nsegments*/
literal|1
argument_list|,
comment|/*maxsegsz*/
literal|0x3ffff
argument_list|,
comment|/*flags*/
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|dmat
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create dma tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|ich_init
argument_list|(
name|sc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to initialize the card\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|codec
operator|=
name|AC97_CREATE
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
name|ich_ac97
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|codec
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
name|mixer_init
argument_list|(
name|dev
argument_list|,
name|ac97_getmixerclass
argument_list|()
argument_list|,
name|sc
operator|->
name|codec
argument_list|)
expr_stmt|;
comment|/* check and set VRA function */
if|if
condition|(
name|ac97_setextmode
argument_list|(
name|sc
operator|->
name|codec
argument_list|,
name|AC97_EXTCAP_VRA
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set VRA function\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ac97_setextmode
argument_list|(
name|sc
operator|->
name|codec
argument_list|,
name|AC97_EXTCAP_VRM
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set VRM function\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|irqid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|irqid
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|irq
operator|||
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|INTR_TYPE_TTY
argument_list|,
name|ich_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ih
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|snprintf
argument_list|(
name|status
argument_list|,
name|SND_STATUSLEN
argument_list|,
literal|"at io 0x%lx-0x%lx, 0x%lx-0x%lx irq %ld"
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|nambar
argument_list|)
argument_list|,
name|rman_get_end
argument_list|(
name|sc
operator|->
name|nambar
argument_list|)
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|nabmbar
argument_list|)
argument_list|,
name|rman_get_end
argument_list|(
name|sc
operator|->
name|nabmbar
argument_list|)
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|irq
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcm_register
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|bad
goto|;
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_PLAY
argument_list|,
operator|&
name|ichpchan_class
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_REC
argument_list|,
operator|&
name|ichrchan_class
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|pcm_setstatus
argument_list|(
name|dev
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|bad
label|:
if|if
condition|(
name|sc
operator|->
name|codec
condition|)
name|ac97_destroy
argument_list|(
name|sc
operator|->
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nambar
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|nambarid
argument_list|,
name|sc
operator|->
name|nambar
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|nabmbar
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|nabmbarid
argument_list|,
name|sc
operator|->
name|nabmbar
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ih
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ich_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|pcm_unregister
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|sc
operator|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|nambarid
argument_list|,
name|sc
operator|->
name|nambar
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|sc
operator|->
name|nabmbarid
argument_list|,
name|sc
operator|->
name|nabmbar
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dmat
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ich_pci_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Reinit audio device */
if|if
condition|(
name|ich_init
argument_list|(
name|sc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reinitialize the card\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* Reinit mixer */
if|if
condition|(
name|mixer_reinit
argument_list|(
name|dev
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reinitialize the mixer\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ich_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ich_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ich_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ich_pci_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|ich_pci_resume
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ich_driver
init|=
block|{
literal|"pcm"
block|,
name|ich_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|snddev_info
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|snd_ich
argument_list|,
name|pci
argument_list|,
name|ich_driver
argument_list|,
name|pcm_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|snd_ich
argument_list|,
name|snd_pcm
argument_list|,
name|PCM_MINVER
argument_list|,
name|PCM_PREFVER
argument_list|,
name|PCM_MAXVER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|snd_ich
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 Taku YAMAMOTO<taku@cent.saitama-u.ac.jp>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$Id: maestro.c,v 1.12 2000/09/06 03:32:34 taku Exp $  */
end_comment

begin_comment
comment|/*  * Credits:  *  * Part of this code (especially in many magic numbers) was heavily inspired  * by the Linux driver originally written by  * Alan Cox<alan.cox@linux.org>, modified heavily by  * Zach Brown<zab@zabbo.net>.  *  * busdma()-ize and buffer size reduction were suggested by  * Cameron Grant<gandalf@vilnya.demon.co.uk>.  * Also he showed me the way to use busdma() suite.  *  * Internal speaker problems on NEC VersaPro's and Dell Inspiron 7500  * were looked at by  * Munehiro Matsuda<haro@tk.kubota.co.jp>,  * who brought patches based on the Linux driver with some simplification.  */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/ac97.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pci/maestro_reg.h>
end_include

begin_expr_stmt
name|SND_DECLARE_FILE
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|inline
value|__inline
end_define

begin_comment
comment|/*  * PCI IDs of supported chips:  *  * MAESTRO-1	0x01001285  * MAESTRO-2	0x1968125d  * MAESTRO-2E	0x1978125d  */
end_comment

begin_define
define|#
directive|define
name|MAESTRO_1_PCI_ID
value|0x01001285
end_define

begin_define
define|#
directive|define
name|MAESTRO_2_PCI_ID
value|0x1968125d
end_define

begin_define
define|#
directive|define
name|MAESTRO_2E_PCI_ID
value|0x1978125d
end_define

begin_define
define|#
directive|define
name|NEC_SUBID1
value|0x80581033
end_define

begin_comment
comment|/* Taken from Linux driver */
end_comment

begin_define
define|#
directive|define
name|NEC_SUBID2
value|0x803c1033
end_define

begin_comment
comment|/* NEC VersaProNX VA26D    */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|AGG_MAXPLAYCH
end_ifndef

begin_define
define|#
directive|define
name|AGG_MAXPLAYCH
value|4
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|AGG_DEFAULT_BUFSZ
value|0x4000
end_define

begin_comment
comment|/* 0x1000, but gets underflows */
end_comment

begin_comment
comment|/* -----------------------------  * Data structures.  */
end_comment

begin_struct
struct|struct
name|agg_chinfo
block|{
name|struct
name|agg_info
modifier|*
name|parent
decl_stmt|;
name|struct
name|pcm_channel
modifier|*
name|channel
decl_stmt|;
name|struct
name|snd_dbuf
modifier|*
name|buffer
decl_stmt|;
name|bus_addr_t
name|offset
decl_stmt|;
name|u_int32_t
name|blocksize
decl_stmt|;
name|u_int32_t
name|speed
decl_stmt|;
name|int
name|dir
decl_stmt|;
name|u_int
name|num
decl_stmt|;
name|u_int16_t
name|aputype
decl_stmt|;
name|u_int16_t
name|wcreg_tpl
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|agg_info
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|reg
decl_stmt|;
name|int
name|regid
decl_stmt|;
name|bus_space_tag_t
name|st
decl_stmt|;
name|bus_space_handle_t
name|sh
decl_stmt|;
name|bus_dma_tag_t
name|parent_dmat
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
decl_stmt|;
name|int
name|irqid
decl_stmt|;
name|void
modifier|*
name|ih
decl_stmt|;
name|u_int8_t
modifier|*
name|stat
decl_stmt|;
name|bus_addr_t
name|baseaddr
decl_stmt|;
name|struct
name|ac97_info
modifier|*
name|codec
decl_stmt|;
name|void
modifier|*
name|lock
decl_stmt|;
name|unsigned
name|int
name|bufsz
decl_stmt|;
name|u_int
name|playchns
decl_stmt|,
name|active
decl_stmt|;
name|struct
name|agg_chinfo
name|pch
index|[
name|AGG_MAXPLAYCH
index|]
decl_stmt|;
name|struct
name|agg_chinfo
name|rch
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
specifier|inline
name|void
name|ringbus_setdest
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|u_int16_t
name|wp_rdreg
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|wp_wrreg
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|u_int16_t
name|wp_rdapu
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|wp_wrapu
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|wp_settimer
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|wp_starttimer
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|wp_stoptimer
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|u_int16_t
name|wc_rdreg
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|wc_wrreg
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|u_int16_t
name|wc_rdchctl
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|wc_wrchctl
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|agg_power
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|agg_init
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|aggch_start_dac
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|aggch_stop_dac
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|suppress_jitter
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|u_int
name|calc_timer_freq
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_timer
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|agg_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|agg_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|agg_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|agg_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|agg_suspend
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|agg_resume
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|agg_shutdown
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|dma_malloc
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|,
name|bus_addr_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|dma_free
parameter_list|(
name|struct
name|agg_info
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* -----------------------------  * Subsystems.  */
end_comment

begin_comment
comment|/* Codec/Ringbus */
end_comment

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|u_int32_t
name|agg_ac97_init
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|sc
decl_stmt|;
return|return
operator|(
name|bus_space_read_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_STAT
argument_list|)
operator|&
name|CODEC_STAT_MASK
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_rdcodec
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|sc
decl_stmt|;
name|unsigned
name|t
decl_stmt|;
comment|/* We have to wait for a SAFE time to write addr/data */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|20
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|bus_space_read_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_STAT
argument_list|)
operator|&
name|CODEC_STAT_MASK
operator|)
operator|!=
name|CODEC_STAT_PROGLESS
condition|)
break|break;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* 20.8us / 13 */
block|}
if|if
condition|(
name|t
operator|==
literal|20
condition|)
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"agg_rdcodec() PROGLESS timed out.\n"
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_CMD
argument_list|,
name|CODEC_CMD_READ
operator||
name|regno
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|21
argument_list|)
expr_stmt|;
comment|/* AC97 cycle = 20.8usec */
comment|/* Wait for data retrieve */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|20
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|bus_space_read_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_STAT
argument_list|)
operator|&
name|CODEC_STAT_MASK
operator|)
operator|==
name|CODEC_STAT_RW_DONE
condition|)
break|break;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* 20.8us / 13 */
block|}
if|if
condition|(
name|t
operator|==
literal|20
condition|)
comment|/* Timed out, but perform dummy read. */
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"agg_rdcodec() RW_DONE timed out.\n"
argument_list|)
expr_stmt|;
return|return
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_REG
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_wrcodec
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|)
block|{
name|unsigned
name|t
decl_stmt|;
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|sc
decl_stmt|;
comment|/* We have to wait for a SAFE time to write addr/data */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|20
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|bus_space_read_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_STAT
argument_list|)
operator|&
name|CODEC_STAT_MASK
operator|)
operator|!=
name|CODEC_STAT_PROGLESS
condition|)
break|break;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* 20.8us / 13 */
block|}
if|if
condition|(
name|t
operator|==
literal|20
condition|)
block|{
comment|/* Timed out. Abort writing. */
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"agg_wrcodec() PROGLESS timed out.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_REG
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_CMD
argument_list|,
name|CODEC_CMD_WRITE
operator||
name|regno
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|agg_ac97_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|ac97_init
argument_list|,
name|agg_ac97_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|ac97_read
argument_list|,
name|agg_rdcodec
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|ac97_write
argument_list|,
name|agg_wrcodec
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|AC97_DECLARE
argument_list|(
name|agg_ac97
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|ringbus_setdest
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|int
name|src
parameter_list|,
name|int
name|dest
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
name|data
operator|=
name|bus_space_read_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
operator|(
literal|0xfU
operator|<<
name|src
operator|)
expr_stmt|;
name|data
operator||=
operator|(
literal|0xfU
operator|&
name|dest
operator|)
operator|<<
name|src
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Wave Processor */
end_comment

begin_function
specifier|static
specifier|inline
name|u_int16_t
name|wp_rdreg
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|u_int16_t
name|reg
parameter_list|)
block|{
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_DATA
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wp_wrreg
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|u_int16_t
name|reg
parameter_list|,
name|u_int16_t
name|data
parameter_list|)
block|{
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|apu_setindex
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|u_int16_t
name|reg
parameter_list|)
block|{
name|int
name|t
decl_stmt|;
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_CRAM_PTR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Sometimes WP fails to set apu register index. */
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|1000
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_DATA
argument_list|)
operator|==
name|reg
condition|)
break|break;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_DATA
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t
operator|==
literal|1000
condition|)
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"apu_setindex() timed out.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|u_int16_t
name|wp_rdapu
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|int
name|ch
parameter_list|,
name|u_int16_t
name|reg
parameter_list|)
block|{
name|u_int16_t
name|ret
decl_stmt|;
name|apu_setindex
argument_list|(
name|ess
argument_list|,
operator|(
operator|(
name|unsigned
operator|)
name|ch
operator|<<
literal|4
operator|)
operator|+
name|reg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wp_rdreg
argument_list|(
name|ess
argument_list|,
name|WPREG_DATA_PORT
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wp_wrapu
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|int
name|ch
parameter_list|,
name|u_int16_t
name|reg
parameter_list|,
name|u_int16_t
name|data
parameter_list|)
block|{
name|int
name|t
decl_stmt|;
name|apu_setindex
argument_list|(
name|ess
argument_list|,
operator|(
operator|(
name|unsigned
operator|)
name|ch
operator|<<
literal|4
operator|)
operator|+
name|reg
argument_list|)
expr_stmt|;
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_DATA_PORT
argument_list|,
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|1000
condition|;
name|t
operator|++
control|)
block|{
if|if
condition|(
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_DATA
argument_list|)
operator|==
name|data
condition|)
break|break;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_DSP_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|t
operator|==
literal|1000
condition|)
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"wp_wrapu() timed out.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wp_settimer
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|u_int
name|freq
parameter_list|)
block|{
name|u_int
name|clock
init|=
literal|48000
operator|<<
literal|2
decl_stmt|;
name|u_int
name|prescale
init|=
literal|0
decl_stmt|,
name|divide
init|=
operator|(
name|freq
operator|!=
literal|0
operator|)
condition|?
operator|(
name|clock
operator|/
name|freq
operator|)
else|:
operator|~
literal|0
decl_stmt|;
name|RANGE
argument_list|(
name|divide
argument_list|,
literal|4
argument_list|,
literal|32
operator|<<
literal|8
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|divide
operator|>
literal|32
operator|<<
literal|1
condition|;
name|divide
operator|>>=
literal|1
control|)
name|prescale
operator|++
expr_stmt|;
name|divide
operator|=
operator|(
name|divide
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
for|for
control|(
init|;
name|prescale
operator|<
literal|7
operator|&&
name|divide
operator|>
literal|2
operator|&&
operator|!
operator|(
name|divide
operator|&
literal|1
operator|)
condition|;
name|divide
operator|>>=
literal|1
control|)
name|prescale
operator|++
expr_stmt|;
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_TIMER_ENABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_TIMER_FREQ
argument_list|,
operator|(
name|prescale
operator|<<
name|WP_TIMER_FREQ_PRESCALE_SHIFT
operator|)
operator||
operator|(
name|divide
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_TIMER_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wp_starttimer
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|)
block|{
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_TIMER_START
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wp_stoptimer
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|)
block|{
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_TIMER_START
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_INT_STAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* WaveCache */
end_comment

begin_function
specifier|static
specifier|inline
name|u_int16_t
name|wc_rdreg
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|u_int16_t
name|reg
parameter_list|)
block|{
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_WAVCACHE_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_WAVCACHE_DATA
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wc_wrreg
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|u_int16_t
name|reg
parameter_list|,
name|u_int16_t
name|data
parameter_list|)
block|{
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_WAVCACHE_INDEX
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_WAVCACHE_DATA
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|u_int16_t
name|wc_rdchctl
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|int
name|ch
parameter_list|)
block|{
return|return
name|wc_rdreg
argument_list|(
name|ess
argument_list|,
name|ch
operator|<<
literal|3
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|wc_wrchctl
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|int
name|ch
parameter_list|,
name|u_int16_t
name|data
parameter_list|)
block|{
name|wc_wrreg
argument_list|(
name|ess
argument_list|,
name|ch
operator|<<
literal|3
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Power management */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|agg_power
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|u_int8_t
name|data
decl_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
name|CONF_PM_PTR
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
operator|==
name|PPMI_CID
condition|)
name|pci_write_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
name|data
operator|+
name|PM_CTRL
argument_list|,
name|status
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -----------------------------  * Controller.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|agg_initcodec
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|)
block|{
name|u_int16_t
name|data
decl_stmt|;
if|if
condition|(
name|bus_space_read_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|)
operator|&
name|RINGBUS_CTRL_ACLINK_ENABLED
condition|)
block|{
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|104
argument_list|)
expr_stmt|;
comment|/* 20.8us * (4 + 1) */
block|}
comment|/* XXX - 2nd codec should be looked at. */
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
name|RINGBUS_CTRL_AC97_SWRESET
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
name|RINGBUS_CTRL_ACLINK_ENABLED
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|21
argument_list|)
expr_stmt|;
name|agg_rdcodec
argument_list|(
name|NULL
argument_list|,
name|ess
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_space_read_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_CODEC_STAT
argument_list|)
operator|&
name|CODEC_STAT_MASK
condition|)
block|{
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|21
argument_list|)
expr_stmt|;
comment|/* Try cold reset. */
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"will perform cold reset.\n"
argument_list|)
expr_stmt|;
name|data
operator|=
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DIR
argument_list|)
expr_stmt|;
if|if
condition|(
name|pci_read_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|0x58
argument_list|,
literal|2
argument_list|)
operator|&
literal|1
condition|)
name|data
operator||=
literal|0x10
expr_stmt|;
name|data
operator||=
literal|0x009
operator|&
operator|~
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DATA
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_MASK
argument_list|,
literal|0xff6
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DIR
argument_list|,
name|data
operator||
literal|0x009
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DATA
argument_list|,
literal|0x000
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DATA
argument_list|,
literal|0x001
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DATA
argument_list|,
literal|0x009
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|500000
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DIR
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|84
argument_list|)
expr_stmt|;
comment|/* 20.8us * 4 */
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
name|RINGBUS_CTRL_ACLINK_ENABLED
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|21
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|agg_init
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
comment|/* Setup PCI config registers. */
comment|/* Disable all legacy emulations. */
name|data
operator|=
name|pci_read_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
name|CONF_LEGACY
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator||=
name|LEGACY_DISABLED
expr_stmt|;
name|pci_write_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
name|CONF_LEGACY
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Disconnect from CHI. (Makes Dell inspiron 7500 work?) 	 * Enable posted write. 	 * Prefer PCI timing rather than that of ISA. 	 * Don't swap L/R. */
name|data
operator|=
name|pci_read_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
name|CONF_MAESTRO
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator||=
name|MAESTRO_CHIBUS
operator||
name|MAESTRO_POSTEDWRITE
operator||
name|MAESTRO_DMA_PCITIMING
expr_stmt|;
name|data
operator|&=
operator|~
name|MAESTRO_SWAP_LR
expr_stmt|;
name|pci_write_config
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
name|CONF_MAESTRO
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Reset direct sound. */
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HOSTINT_CTRL
argument_list|,
name|HOSTINT_CTRL_DSOUND_RESET
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
comment|/* XXX - too long? */
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HOSTINT_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
comment|/* Enable direct sound interruption and hardware volume control. */
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HOSTINT_CTRL
argument_list|,
name|HOSTINT_CTRL_DSOUND_INT_ENABLED
operator||
name|HOSTINT_CTRL_HWVOL_ENABLED
argument_list|)
expr_stmt|;
comment|/* Setup Wave Processor. */
comment|/* Enable WaveCache, set DMA base address. */
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_WAVE_ROMRAM
argument_list|,
name|WP_WAVE_VIRTUAL_ENABLED
operator||
name|WP_WAVE_DRAM_ENABLED
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_WAVCACHE_CTRL
argument_list|,
name|WAVCACHE_ENABLED
operator||
name|WAVCACHE_WTSIZE_4MB
argument_list|)
expr_stmt|;
for|for
control|(
name|data
operator|=
name|WAVCACHE_PCMBAR
init|;
name|data
operator|<
name|WAVCACHE_PCMBAR
operator|+
literal|4
condition|;
name|data
operator|++
control|)
name|wc_wrreg
argument_list|(
name|ess
argument_list|,
name|data
argument_list|,
name|ess
operator|->
name|baseaddr
operator|>>
name|WAVCACHE_BASEADDR_SHIFT
argument_list|)
expr_stmt|;
comment|/* Setup Codec/Ringbus. */
name|agg_initcodec
argument_list|(
name|ess
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
name|RINGBUS_CTRL_RINGBUS_ENABLED
operator||
name|RINGBUS_CTRL_ACLINK_ENABLED
argument_list|)
expr_stmt|;
name|wp_wrreg
argument_list|(
name|ess
argument_list|,
name|WPREG_BASE
argument_list|,
literal|0x8500
argument_list|)
expr_stmt|;
comment|/* Parallel I/O */
name|ringbus_setdest
argument_list|(
name|ess
argument_list|,
name|RINGBUS_SRC_ADC
argument_list|,
name|RINGBUS_DEST_STEREO
operator||
name|RINGBUS_DEST_DSOUND_IN
argument_list|)
expr_stmt|;
name|ringbus_setdest
argument_list|(
name|ess
argument_list|,
name|RINGBUS_SRC_DSOUND
argument_list|,
name|RINGBUS_DEST_STEREO
operator||
name|RINGBUS_DEST_DAC
argument_list|)
expr_stmt|;
comment|/* Setup ASSP. Needed for Dell Inspiron 7500? */
name|bus_space_write_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_ASSP_CTRL_B
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_ASSP_CTRL_A
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_ASSP_CTRL_C
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* 	 * Setup GPIO. 	 * There seems to be speciality with NEC systems. 	 */
switch|switch
condition|(
name|pci_get_subvendor
argument_list|(
name|ess
operator|->
name|dev
argument_list|)
operator||
operator|(
name|pci_get_subdevice
argument_list|(
name|ess
operator|->
name|dev
argument_list|)
operator|<<
literal|16
operator|)
condition|)
block|{
case|case
name|NEC_SUBID1
case|:
case|case
name|NEC_SUBID2
case|:
comment|/* Matthew Braithwaite<matt@braithwaite.net> reported that 		 * NEC Versa LX doesn't need GPIO operation. */
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_MASK
argument_list|,
literal|0x9ff
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DIR
argument_list|,
name|bus_space_read_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DIR
argument_list|)
operator||
literal|0x600
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_GPIO_DATA
argument_list|,
literal|0x200
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Channel controller. */
end_comment

begin_function
specifier|static
name|void
name|aggch_start_dac
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|u_int
name|wpwa
init|=
name|APU_USE_SYSMEM
operator||
operator|(
name|ch
operator|->
name|offset
operator|>>
literal|9
operator|)
decl_stmt|;
name|u_int
name|size
init|=
name|ch
operator|->
name|parent
operator|->
name|bufsz
operator|>>
literal|1
decl_stmt|;
name|u_int
name|speed
init|=
name|ch
operator|->
name|speed
decl_stmt|;
name|u_int
name|offset
init|=
name|ch
operator|->
name|offset
operator|>>
literal|1
decl_stmt|;
name|u_int
name|cp
init|=
literal|0
decl_stmt|;
name|u_int16_t
name|apuch
init|=
name|ch
operator|->
name|num
operator|<<
literal|1
decl_stmt|;
name|u_int
name|dv
decl_stmt|;
name|int
name|pan
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|ch
operator|->
name|aputype
condition|)
block|{
case|case
name|APUTYPE_16BITSTEREO
case|:
name|wpwa
operator|>>=
literal|1
expr_stmt|;
name|size
operator|>>=
literal|1
expr_stmt|;
name|offset
operator|>>=
literal|1
expr_stmt|;
name|cp
operator|>>=
literal|1
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|APUTYPE_8BITSTEREO
case|:
name|pan
operator|=
literal|8
expr_stmt|;
name|apuch
operator|++
expr_stmt|;
break|break;
case|case
name|APUTYPE_8BITLINEAR
case|:
name|speed
operator|>>=
literal|1
expr_stmt|;
break|break;
block|}
name|dv
operator|=
operator|(
operator|(
operator|(
name|speed
operator|%
literal|48000
operator|)
operator|<<
literal|16
operator|)
operator|+
literal|24000
operator|)
operator|/
literal|48000
operator|+
operator|(
operator|(
name|speed
operator|/
literal|48000
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
do|do
block|{
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_WAVESPACE
argument_list|,
name|wpwa
operator|&
literal|0xff00
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_CURPTR
argument_list|,
name|offset
operator|+
name|cp
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_ENDPTR
argument_list|,
name|offset
operator|+
name|size
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_LOOPLEN
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_AMPLITUDE
argument_list|,
literal|0xe800
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_POSITION
argument_list|,
literal|0x8f00
operator||
operator|(
name|RADIUS_CENTERCIRCLE
operator|<<
name|APU_RADIUS_SHIFT
operator|)
operator||
operator|(
operator|(
name|PAN_FRONT
operator|+
name|pan
operator|)
operator|<<
name|APU_PAN_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_FREQ_LOBYTE
argument_list|,
name|APU_plus6dB
operator||
operator|(
operator|(
name|dv
operator|&
literal|0xff
operator|)
operator|<<
name|APU_FREQ_LOBYTE_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_FREQ_HIWORD
argument_list|,
name|dv
operator|>>
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|aputype
operator|==
name|APUTYPE_16BITSTEREO
condition|)
name|wpwa
operator||=
name|APU_STEREO
operator|>>
literal|1
expr_stmt|;
name|pan
operator|=
operator|-
name|pan
expr_stmt|;
block|}
do|while
condition|(
name|pan
operator|<
literal|0
operator|&&
name|apuch
operator|--
condition|)
do|;
name|wc_wrchctl
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|ch
operator|->
name|wcreg_tpl
argument_list|)
expr_stmt|;
name|wc_wrchctl
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
operator|+
literal|1
argument_list|,
name|ch
operator|->
name|wcreg_tpl
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
argument_list|,
name|APUREG_APUTYPE
argument_list|,
operator|(
name|ch
operator|->
name|aputype
operator|<<
name|APU_APUTYPE_SHIFT
operator|)
operator||
name|APU_DMA_ENABLED
operator||
literal|0xf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|wcreg_tpl
operator|&
name|WAVCACHE_CHCTL_STEREO
condition|)
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
name|apuch
operator|+
literal|1
argument_list|,
name|APUREG_APUTYPE
argument_list|,
operator|(
name|ch
operator|->
name|aputype
operator|<<
name|APU_APUTYPE_SHIFT
operator|)
operator||
name|APU_DMA_ENABLED
operator||
literal|0xf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aggch_stop_dac
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
operator|(
name|ch
operator|->
name|num
operator|<<
literal|1
operator|)
argument_list|,
name|APUREG_APUTYPE
argument_list|,
name|APUTYPE_INACTIVE
operator|<<
name|APU_APUTYPE_SHIFT
argument_list|)
expr_stmt|;
name|wp_wrapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
operator|(
name|ch
operator|->
name|num
operator|<<
literal|1
operator|)
operator|+
literal|1
argument_list|,
name|APUREG_APUTYPE
argument_list|,
name|APUTYPE_INACTIVE
operator|<<
name|APU_APUTYPE_SHIFT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Stereo jitter suppressor.  * Sometimes playback pointers differ in stereo-paired channels.  * Calling this routine within intr fixes the problem.  */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|suppress_jitter
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
name|ch
parameter_list|)
block|{
if|if
condition|(
name|ch
operator|->
name|wcreg_tpl
operator|&
name|WAVCACHE_CHCTL_STEREO
condition|)
block|{
name|int
name|cp
decl_stmt|,
name|diff
decl_stmt|,
name|halfsize
init|=
name|ch
operator|->
name|parent
operator|->
name|bufsz
operator|>>
literal|2
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|aputype
operator|==
name|APUTYPE_16BITSTEREO
condition|)
name|halfsize
operator|>>=
literal|1
expr_stmt|;
name|cp
operator|=
name|wp_rdapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
operator|(
name|ch
operator|->
name|num
operator|<<
literal|1
operator|)
argument_list|,
name|APUREG_CURPTR
argument_list|)
expr_stmt|;
name|diff
operator|=
name|wp_rdapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
operator|(
name|ch
operator|->
name|num
operator|<<
literal|1
operator|)
operator|+
literal|1
argument_list|,
name|APUREG_CURPTR
argument_list|)
expr_stmt|;
name|diff
operator|-=
name|cp
expr_stmt|;
if|if
condition|(
name|diff
operator|>>
literal|1
operator|&&
name|diff
operator|>
operator|-
name|halfsize
operator|&&
name|diff
operator|<
name|halfsize
condition|)
name|bus_space_write_2
argument_list|(
name|ch
operator|->
name|parent
operator|->
name|st
argument_list|,
name|ch
operator|->
name|parent
operator|->
name|sh
argument_list|,
name|PORT_DSP_DATA
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|u_int
name|calc_timer_freq
parameter_list|(
name|struct
name|agg_chinfo
modifier|*
name|ch
parameter_list|)
block|{
name|u_int
name|ss
init|=
literal|2
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|aputype
operator|==
name|APUTYPE_16BITSTEREO
condition|)
name|ss
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|aputype
operator|==
name|APUTYPE_8BITLINEAR
condition|)
name|ss
operator|>>=
literal|1
expr_stmt|;
return|return
operator|(
name|ch
operator|->
name|speed
operator|*
name|ss
operator|)
operator|/
name|ch
operator|->
name|blocksize
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_timer
parameter_list|(
name|struct
name|agg_info
modifier|*
name|ess
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int
name|freq
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ess
operator|->
name|playchns
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|ess
operator|->
name|active
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|&&
operator|(
name|freq
operator|<
name|calc_timer_freq
argument_list|(
name|ess
operator|->
name|pch
operator|+
name|i
argument_list|)
operator|)
condition|)
name|freq
operator|=
name|calc_timer_freq
argument_list|(
name|ess
operator|->
name|pch
operator|+
name|i
argument_list|)
expr_stmt|;
name|wp_settimer
argument_list|(
name|ess
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -----------------------------  * Newpcm glue.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|aggch_init
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|devinfo
decl_stmt|;
name|struct
name|agg_chinfo
modifier|*
name|ch
decl_stmt|;
name|bus_addr_t
name|physaddr
decl_stmt|;
name|void
modifier|*
name|p
decl_stmt|;
name|ch
operator|=
operator|(
name|dir
operator|==
name|PCMDIR_PLAY
operator|)
condition|?
name|ess
operator|->
name|pch
operator|+
name|ess
operator|->
name|playchns
else|:
operator|&
name|ess
operator|->
name|rch
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|ess
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|num
operator|=
name|ess
operator|->
name|playchns
expr_stmt|;
name|ch
operator|->
name|dir
operator|=
name|dir
expr_stmt|;
name|p
operator|=
name|dma_malloc
argument_list|(
name|ess
argument_list|,
name|ess
operator|->
name|bufsz
argument_list|,
operator|&
name|physaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|sndbuf_setup
argument_list|(
name|b
argument_list|,
name|p
argument_list|,
name|ess
operator|->
name|bufsz
argument_list|)
expr_stmt|;
name|ch
operator|->
name|offset
operator|=
name|physaddr
operator|-
name|ess
operator|->
name|baseaddr
expr_stmt|;
if|if
condition|(
name|physaddr
operator|<
name|ess
operator|->
name|baseaddr
operator|||
name|ch
operator|->
name|offset
operator|>
name|WPWA_MAXADDR
condition|)
block|{
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"offset %#x exceeds limit. "
argument_list|,
name|ch
operator|->
name|offset
argument_list|)
expr_stmt|;
name|dma_free
argument_list|(
name|ess
argument_list|,
name|sndbuf_getbuf
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ch
operator|->
name|wcreg_tpl
operator|=
operator|(
name|physaddr
operator|-
literal|16
operator|)
operator|&
name|WAVCACHE_CHCTL_ADDRTAG_MASK
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
block|{
name|ess
operator|->
name|playchns
operator|++
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"pch[%d].offset = %#x\n"
argument_list|,
name|ch
operator|->
name|num
argument_list|,
name|ch
operator|->
name|offset
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"rch.offset = %#x\n"
argument_list|,
name|ch
operator|->
name|offset
argument_list|)
expr_stmt|;
return|return
name|ch
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aggch_free
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|agg_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|ch
operator|->
name|parent
decl_stmt|;
comment|/* free up buffer - called after channel stopped */
name|dma_free
argument_list|(
name|ess
argument_list|,
name|sndbuf_getbuf
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* return 0 if ok */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aggch_setplayformat
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|agg_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|u_int16_t
name|wcreg_tpl
decl_stmt|;
name|u_int16_t
name|aputype
init|=
name|APUTYPE_16BITLINEAR
decl_stmt|;
name|wcreg_tpl
operator|=
name|ch
operator|->
name|wcreg_tpl
operator|&
name|WAVCACHE_CHCTL_ADDRTAG_MASK
expr_stmt|;
if|if
condition|(
name|format
operator|&
name|AFMT_STEREO
condition|)
block|{
name|wcreg_tpl
operator||=
name|WAVCACHE_CHCTL_STEREO
expr_stmt|;
name|aputype
operator|+=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|format
operator|&
name|AFMT_U8
operator|||
name|format
operator|&
name|AFMT_S8
condition|)
block|{
name|aputype
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|format
operator|&
name|AFMT_U8
condition|)
name|wcreg_tpl
operator||=
name|WAVCACHE_CHCTL_U8
expr_stmt|;
block|}
if|if
condition|(
name|format
operator|&
name|AFMT_BIGENDIAN
operator|||
name|format
operator|&
name|AFMT_U16_LE
condition|)
block|{
name|format
operator|&=
operator|~
name|AFMT_BIGENDIAN
operator|&
operator|~
name|AFMT_U16_LE
expr_stmt|;
name|format
operator||=
name|AFMT_S16_LE
expr_stmt|;
block|}
name|ch
operator|->
name|wcreg_tpl
operator|=
name|wcreg_tpl
expr_stmt|;
name|ch
operator|->
name|aputype
operator|=
name|aputype
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aggch_setspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|agg_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ch
operator|->
name|speed
operator|=
name|speed
expr_stmt|;
return|return
name|ch
operator|->
name|speed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aggch_setblocksize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
return|return
operator|(
operator|(
expr|struct
name|agg_chinfo
operator|*
operator|)
name|data
operator|)
operator|->
name|blocksize
operator|=
name|blocksize
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aggch_trigger
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|agg_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
switch|switch
condition|(
name|go
condition|)
block|{
case|case
name|PCMTRIG_EMLDMAWR
case|:
return|return
literal|0
return|;
case|case
name|PCMTRIG_START
case|:
name|ch
operator|->
name|parent
operator|->
name|active
operator||=
operator|(
literal|1
operator|<<
name|ch
operator|->
name|num
operator|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|aggch_start_dac
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX - RECORDING */
block|else 			aggch_start_adc(ch);
endif|#
directive|endif
break|break;
case|case
name|PCMTRIG_ABORT
case|:
case|case
name|PCMTRIG_STOP
case|:
name|ch
operator|->
name|parent
operator|->
name|active
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|ch
operator|->
name|num
operator|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
condition|)
name|aggch_stop_dac
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX - RECORDING */
block|else 			aggch_stop_adc(ch);
endif|#
directive|endif
break|break;
block|}
if|if
condition|(
name|ch
operator|->
name|parent
operator|->
name|active
condition|)
block|{
name|set_timer
argument_list|(
name|ch
operator|->
name|parent
argument_list|)
expr_stmt|;
name|wp_starttimer
argument_list|(
name|ch
operator|->
name|parent
argument_list|)
expr_stmt|;
block|}
else|else
name|wp_stoptimer
argument_list|(
name|ch
operator|->
name|parent
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aggch_getplayptr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|agg_chinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|u_int
name|cp
decl_stmt|;
name|cp
operator|=
name|wp_rdapu
argument_list|(
name|ch
operator|->
name|parent
argument_list|,
operator|(
name|ch
operator|->
name|num
operator|<<
literal|1
operator|)
argument_list|,
name|APUREG_CURPTR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|aputype
operator|==
name|APUTYPE_16BITSTEREO
condition|)
name|cp
operator|=
operator|(
literal|0xffff
operator|<<
literal|2
operator|)
operator|&
operator|(
operator|(
name|cp
operator|<<
literal|2
operator|)
operator|-
name|ch
operator|->
name|offset
operator|)
expr_stmt|;
else|else
name|cp
operator|=
operator|(
literal|0xffff
operator|<<
literal|1
operator|)
operator|&
operator|(
operator|(
name|cp
operator|<<
literal|1
operator|)
operator|-
name|ch
operator|->
name|offset
operator|)
expr_stmt|;
return|return
name|cp
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|aggch_getcaps
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
specifier|static
name|u_int32_t
name|playfmt
index|[]
init|=
block|{
name|AFMT_U8
block|,
name|AFMT_STEREO
operator||
name|AFMT_U8
block|,
name|AFMT_S8
block|,
name|AFMT_STEREO
operator||
name|AFMT_S8
block|,
name|AFMT_S16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
literal|0
block|}
decl_stmt|;
specifier|static
name|struct
name|pcmchan_caps
name|playcaps
init|=
block|{
literal|2000
block|,
literal|96000
block|,
name|playfmt
block|,
literal|0
block|}
decl_stmt|;
specifier|static
name|u_int32_t
name|recfmt
index|[]
init|=
block|{
name|AFMT_S8
block|,
name|AFMT_STEREO
operator||
name|AFMT_S8
block|,
name|AFMT_S16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
literal|0
block|}
decl_stmt|;
specifier|static
name|struct
name|pcmchan_caps
name|reccaps
init|=
block|{
literal|4000
block|,
literal|48000
block|,
name|recfmt
block|,
literal|0
block|}
decl_stmt|;
return|return
operator|(
operator|(
operator|(
expr|struct
name|agg_chinfo
operator|*
operator|)
name|data
operator|)
operator|->
name|dir
operator|==
name|PCMDIR_PLAY
operator|)
condition|?
operator|&
name|playcaps
else|:
operator|&
name|reccaps
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|aggch_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|aggch_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_free
argument_list|,
name|aggch_free
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|aggch_setplayformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|aggch_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|aggch_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|aggch_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|aggch_getplayptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|aggch_getcaps
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|CHANNEL_DECLARE
argument_list|(
name|aggch
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -----------------------------  * Bus space.  */
end_comment

begin_function
specifier|static
name|void
name|agg_intr
parameter_list|(
name|void
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|sc
decl_stmt|;
name|u_int16_t
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
name|status
operator|=
name|bus_space_read_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HOSTINT_STAT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
return|return;
comment|/* Acknowledge all. */
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_INT_STAT
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bus_space_write_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HOSTINT_STAT
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|HOSTINT_STAT_HWVOL
condition|)
block|{
name|u_int
name|event
decl_stmt|;
name|event
operator|=
name|bus_space_read_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HWVOL_MASTER
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HWVOL_MUTE
case|:
name|mixer_hwvol_mute
argument_list|(
name|ess
operator|->
name|dev
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWVOL_UP
case|:
name|mixer_hwvol_step
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWVOL_DOWN
case|:
name|mixer_hwvol_step
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|HWVOL_NOP
case|:
break|break;
default|default:
name|device_printf
argument_list|(
name|ess
operator|->
name|dev
argument_list|,
literal|"%s: unknown HWVOL event 0x%x\n"
argument_list|,
name|device_get_nameunit
argument_list|(
name|ess
operator|->
name|dev
argument_list|)
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
name|bus_space_write_1
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HWVOL_MASTER
argument_list|,
name|HWVOL_NOP
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ess
operator|->
name|playchns
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ess
operator|->
name|active
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|suppress_jitter
argument_list|(
name|ess
operator|->
name|pch
operator|+
name|i
argument_list|)
expr_stmt|;
name|chn_intr
argument_list|(
name|ess
operator|->
name|pch
index|[
name|i
index|]
operator|.
name|channel
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* XXX - RECORDING */
block|if (ess->active& (1<< i)) 		chn_intr(ess->rch.channel);
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|setmap
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|bus_addr_t
modifier|*
name|phys
init|=
name|arg
decl_stmt|;
operator|*
name|phys
operator|=
name|error
condition|?
literal|0
else|:
name|segs
operator|->
name|ds_addr
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"setmap (%lx, %lx), nseg=%d, error=%d\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_addr
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_len
argument_list|,
name|nseg
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|dma_malloc
parameter_list|(
name|struct
name|agg_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
name|sz
parameter_list|,
name|bus_addr_t
modifier|*
name|phys
parameter_list|)
block|{
name|void
modifier|*
name|buf
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|parent_dmat
argument_list|,
operator|&
name|buf
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|map
argument_list|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|parent_dmat
argument_list|,
name|map
argument_list|,
name|buf
argument_list|,
name|sz
argument_list|,
name|setmap
argument_list|,
name|phys
argument_list|,
literal|0
argument_list|)
operator|||
operator|!
operator|*
name|phys
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|parent_dmat
argument_list|,
name|buf
argument_list|,
name|map
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dma_free
parameter_list|(
name|struct
name|agg_info
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|parent_dmat
argument_list|,
name|buf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|char
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
condition|)
block|{
case|case
name|MAESTRO_1_PCI_ID
case|:
name|s
operator|=
literal|"ESS Technology Maestro-1"
expr_stmt|;
break|break;
case|case
name|MAESTRO_2_PCI_ID
case|:
name|s
operator|=
literal|"ESS Technology Maestro-2"
expr_stmt|;
break|break;
case|case
name|MAESTRO_2E_PCI_ID
case|:
name|s
operator|=
literal|"ESS Technology Maestro-2E"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|s
operator|!=
name|NULL
operator|&&
name|pci_get_class
argument_list|(
name|dev
argument_list|)
operator|==
name|PCIC_MULTIMEDIA
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|data
decl_stmt|;
name|int
name|mapped
init|=
literal|0
decl_stmt|;
name|int
name|regid
init|=
name|PCIR_MAPS
decl_stmt|;
name|struct
name|resource
modifier|*
name|reg
init|=
name|NULL
decl_stmt|;
name|struct
name|ac97_info
modifier|*
name|codec
init|=
name|NULL
decl_stmt|;
name|int
name|irqid
init|=
literal|0
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|ih
init|=
name|NULL
decl_stmt|;
name|char
name|status
index|[
name|SND_STATUSLEN
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|ess
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|ess
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate softc\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|ess
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|ess
operator|->
name|bufsz
operator|=
name|pcm_getbuffersize
argument_list|(
name|dev
argument_list|,
literal|4096
argument_list|,
name|AGG_DEFAULT_BUFSZ
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/*parent*/
name|NULL
argument_list|,
comment|/*alignment*/
literal|1
operator|<<
name|WAVCACHE_BASEADDR_SHIFT
argument_list|,
comment|/*boundary*/
name|WPWA_MAXADDR
operator|+
literal|1
argument_list|,
comment|/*lowaddr*/
name|MAESTRO_MAXADDR
argument_list|,
comment|/*highaddr*/
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/*filter*/
name|NULL
argument_list|,
comment|/*filterarg*/
name|NULL
argument_list|,
comment|/*maxsize*/
name|ess
operator|->
name|bufsz
argument_list|,
comment|/*nsegments*/
literal|1
argument_list|,
comment|/*maxsegz*/
literal|0x3ffff
argument_list|,
comment|/*flags*/
literal|0
argument_list|,
operator|&
name|ess
operator|->
name|parent_dmat
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create dma tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ess
operator|->
name|stat
operator|=
name|dma_malloc
argument_list|(
name|ess
argument_list|,
name|ess
operator|->
name|bufsz
argument_list|,
operator|&
name|ess
operator|->
name|baseaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ess
operator|->
name|stat
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate status buffer\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Maestro DMA base: %#x\n"
argument_list|,
name|ess
operator|->
name|baseaddr
argument_list|)
expr_stmt|;
name|agg_power
argument_list|(
name|ess
argument_list|,
name|PPMI_D0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator||=
operator|(
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|PCIM_CMD_PORTEN
condition|)
block|{
name|reg
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
operator|&
name|regid
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_UNRESTRICTED
argument_list|,
literal|256
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|!=
name|NULL
condition|)
block|{
name|ess
operator|->
name|reg
operator|=
name|reg
expr_stmt|;
name|ess
operator|->
name|regid
operator|=
name|regid
expr_stmt|;
name|ess
operator|->
name|st
operator|=
name|rman_get_bustag
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|ess
operator|->
name|sh
operator|=
name|rman_get_bushandle
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|mapped
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mapped
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map register space\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|agg_init
argument_list|(
name|ess
argument_list|)
expr_stmt|;
if|if
condition|(
name|agg_rdcodec
argument_list|(
name|NULL
argument_list|,
name|ess
argument_list|,
literal|0
argument_list|)
operator|==
literal|0x80
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"PT101 codec detected!\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|codec
operator|=
name|AC97_CREATE
argument_list|(
name|dev
argument_list|,
name|ess
argument_list|,
name|agg_ac97
argument_list|)
expr_stmt|;
if|if
condition|(
name|codec
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|mixer_init
argument_list|(
name|dev
argument_list|,
name|ac97_getmixerclass
argument_list|()
argument_list|,
name|codec
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|bad
goto|;
name|ess
operator|->
name|codec
operator|=
name|codec
expr_stmt|;
name|irq
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|irqid
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_UNRESTRICTED
argument_list|,
literal|1
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|irq
operator|==
name|NULL
operator|||
name|snd_setup_intr
argument_list|(
name|dev
argument_list|,
name|irq
argument_list|,
literal|0
argument_list|,
name|agg_intr
argument_list|,
name|ess
argument_list|,
operator|&
name|ih
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ess
operator|->
name|irq
operator|=
name|irq
expr_stmt|;
name|ess
operator|->
name|irqid
operator|=
name|irqid
expr_stmt|;
name|ess
operator|->
name|ih
operator|=
name|ih
expr_stmt|;
name|snprintf
argument_list|(
name|status
argument_list|,
name|SND_STATUSLEN
argument_list|,
literal|"at I/O port 0x%lx irq %ld"
argument_list|,
name|rman_get_start
argument_list|(
name|reg
argument_list|)
argument_list|,
name|rman_get_start
argument_list|(
name|irq
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcm_register
argument_list|(
name|dev
argument_list|,
name|ess
argument_list|,
name|AGG_MAXPLAYCH
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|bad
goto|;
name|mixer_hwvol_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|data
operator|=
literal|0
init|;
name|data
operator|<
name|AGG_MAXPLAYCH
condition|;
name|data
operator|++
control|)
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_PLAY
argument_list|,
operator|&
name|aggch_class
argument_list|,
name|ess
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX - RECORDING */
block|pcm_addchan(dev, PCMDIR_REC,&aggrch_class, ess);
endif|#
directive|endif
name|pcm_setstatus
argument_list|(
name|dev
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|bad
label|:
if|if
condition|(
name|codec
operator|!=
name|NULL
condition|)
name|ac97_destroy
argument_list|(
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|ih
operator|!=
name|NULL
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|irq
argument_list|,
name|ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|irq
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|irqid
argument_list|,
name|irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|regid
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ess
operator|!=
name|NULL
condition|)
block|{
name|agg_power
argument_list|(
name|ess
argument_list|,
name|PPMI_D3
argument_list|)
expr_stmt|;
if|if
condition|(
name|ess
operator|->
name|stat
operator|!=
name|NULL
condition|)
name|dma_free
argument_list|(
name|ess
argument_list|,
name|ess
operator|->
name|stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|ess
operator|->
name|parent_dmat
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|ess
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ess
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|r
decl_stmt|;
name|r
operator|=
name|pcm_unregister
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|ess
operator|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dma_free
argument_list|(
name|ess
argument_list|,
name|ess
operator|->
name|stat
argument_list|)
expr_stmt|;
comment|/* Power down everything except clock and vref. */
name|agg_wrcodec
argument_list|(
name|NULL
argument_list|,
name|ess
argument_list|,
name|AC97_REG_POWER
argument_list|,
literal|0xd700
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|agg_power
argument_list|(
name|ess
argument_list|,
name|PPMI_D3
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ess
operator|->
name|irq
argument_list|,
name|ess
operator|->
name|ih
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ess
operator|->
name|irqid
argument_list|,
name|ess
operator|->
name|irq
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IOPORT
argument_list|,
name|ess
operator|->
name|regid
argument_list|,
name|ess
operator|->
name|reg
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|ess
operator|->
name|parent_dmat
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ess
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|x
decl_stmt|;
name|x
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|wp_stoptimer
argument_list|(
name|ess
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HOSTINT_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ess
operator|->
name|playchns
condition|;
name|i
operator|++
control|)
name|aggch_stop_dac
argument_list|(
name|ess
operator|->
name|pch
operator|+
name|i
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX - RECORDING */
block|aggch_stop_adc(&ess->rch);
endif|#
directive|endif
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
comment|/* Power down everything except clock. */
name|agg_wrcodec
argument_list|(
name|NULL
argument_list|,
name|ess
argument_list|,
name|AC97_REG_POWER
argument_list|,
literal|0xdf00
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|20
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_RINGBUS_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|agg_power
argument_list|(
name|ess
argument_list|,
name|PPMI_D3
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|x
decl_stmt|;
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|agg_power
argument_list|(
name|ess
argument_list|,
name|PPMI_D0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
name|agg_init
argument_list|(
name|ess
argument_list|)
expr_stmt|;
if|if
condition|(
name|mixer_reinit
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reinitialize the mixer\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|x
operator|=
name|spltty
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ess
operator|->
name|playchns
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ess
operator|->
name|active
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|aggch_start_dac
argument_list|(
name|ess
operator|->
name|pch
operator|+
name|i
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX - RECORDING */
block|if (ess->active& (1<< i)) 		aggch_start_adc(&ess->rch);
endif|#
directive|endif
if|if
condition|(
name|ess
operator|->
name|active
condition|)
block|{
name|set_timer
argument_list|(
name|ess
argument_list|)
expr_stmt|;
name|wp_starttimer
argument_list|(
name|ess
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|x
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|agg_shutdown
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|agg_info
modifier|*
name|ess
init|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wp_stoptimer
argument_list|(
name|ess
argument_list|)
expr_stmt|;
name|bus_space_write_2
argument_list|(
name|ess
operator|->
name|st
argument_list|,
name|ess
operator|->
name|sh
argument_list|,
name|PORT_HOSTINT_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ess
operator|->
name|playchns
condition|;
name|i
operator|++
control|)
name|aggch_stop_dac
argument_list|(
name|ess
operator|->
name|pch
operator|+
name|i
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX - RECORDING */
block|aggch_stop_adc(&ess->rch);
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|agg_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|agg_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|agg_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|agg_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|agg_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|agg_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|agg_shutdown
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|agg_driver
init|=
block|{
literal|"pcm"
block|,
name|agg_methods
block|,
name|PCM_SOFTC_SIZE
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|snd_maestro
argument_list|,
name|pci
argument_list|,
name|agg_driver
argument_list|,
name|pcm_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|snd_maestro
argument_list|,
name|snd_pcm
argument_list|,
name|PCM_MINVER
argument_list|,
name|PCM_PREFVER
argument_list|,
name|PCM_MAXVER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|snd_maestro
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


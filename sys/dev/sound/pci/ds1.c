begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 Cameron Grant<cg@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHERIN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THEPOSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/ac97.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pci/ds1.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pci/ds1-fw.h>
end_include

begin_expr_stmt
name|SND_DECLARE_FILE
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_define
define|#
directive|define
name|DS1_CHANS
value|4
end_define

begin_define
define|#
directive|define
name|DS1_RECPRIMARY
value|0
end_define

begin_define
define|#
directive|define
name|DS1_IRQHZ
value|((48000<< 8) / 256)
end_define

begin_define
define|#
directive|define
name|DS1_BUFFSIZE
value|4096
end_define

begin_struct
struct|struct
name|pbank
block|{
specifier|volatile
name|u_int32_t
name|Format
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LoopDefault
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgBase
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgLoop
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgLoopEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgLoopFrac
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgDeltaEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LpfKEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|EgGainEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LchGainEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|RchGainEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|Effect1GainEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|Effect2GainEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|Effect3GainEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LpfQ
decl_stmt|;
specifier|volatile
name|u_int32_t
name|Status
decl_stmt|;
specifier|volatile
name|u_int32_t
name|NumOfFrames
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LoopCount
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgStart
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgStartFrac
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgDelta
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LpfK
decl_stmt|;
specifier|volatile
name|u_int32_t
name|EgGain
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LchGain
decl_stmt|;
specifier|volatile
name|u_int32_t
name|RchGain
decl_stmt|;
specifier|volatile
name|u_int32_t
name|Effect1Gain
decl_stmt|;
specifier|volatile
name|u_int32_t
name|Effect2Gain
decl_stmt|;
specifier|volatile
name|u_int32_t
name|Effect3Gain
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LpfD1
decl_stmt|;
specifier|volatile
name|u_int32_t
name|LpfD2
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rbank
block|{
specifier|volatile
name|u_int32_t
name|PgBase
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgLoopEnd
decl_stmt|;
specifier|volatile
name|u_int32_t
name|PgStart
decl_stmt|;
specifier|volatile
name|u_int32_t
name|NumOfLoops
decl_stmt|;
block|}
struct|;
end_struct

begin_struct_decl
struct_decl|struct
name|sc_info
struct_decl|;
end_struct_decl

begin_comment
comment|/* channel registers */
end_comment

begin_struct
struct|struct
name|sc_pchinfo
block|{
name|int
name|run
decl_stmt|,
name|spd
decl_stmt|,
name|dir
decl_stmt|,
name|fmt
decl_stmt|;
name|struct
name|snd_dbuf
modifier|*
name|buffer
decl_stmt|;
name|struct
name|pcm_channel
modifier|*
name|channel
decl_stmt|;
specifier|volatile
name|struct
name|pbank
modifier|*
name|lslot
decl_stmt|,
modifier|*
name|rslot
decl_stmt|;
name|int
name|lsnum
decl_stmt|,
name|rsnum
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|parent
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sc_rchinfo
block|{
name|int
name|run
decl_stmt|,
name|spd
decl_stmt|,
name|dir
decl_stmt|,
name|fmt
decl_stmt|,
name|num
decl_stmt|;
name|struct
name|snd_dbuf
modifier|*
name|buffer
decl_stmt|;
name|struct
name|pcm_channel
modifier|*
name|channel
decl_stmt|;
specifier|volatile
name|struct
name|rbank
modifier|*
name|slot
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|parent
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* device private data */
end_comment

begin_struct
struct|struct
name|sc_info
block|{
name|device_t
name|dev
decl_stmt|;
name|u_int32_t
name|type
decl_stmt|,
name|rev
decl_stmt|;
name|u_int32_t
name|cd2id
decl_stmt|,
name|ctrlbase
decl_stmt|;
name|bus_space_tag_t
name|st
decl_stmt|;
name|bus_space_handle_t
name|sh
decl_stmt|;
name|bus_dma_tag_t
name|buffer_dmat
decl_stmt|,
name|control_dmat
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|struct
name|resource
modifier|*
name|reg
decl_stmt|,
modifier|*
name|irq
decl_stmt|;
name|int
name|regid
decl_stmt|,
name|irqid
decl_stmt|;
name|void
modifier|*
name|ih
decl_stmt|;
name|struct
name|mtx
modifier|*
name|lock
decl_stmt|;
name|void
modifier|*
name|regbase
decl_stmt|;
name|u_int32_t
modifier|*
name|pbase
decl_stmt|,
name|pbankbase
decl_stmt|,
name|pbanksize
decl_stmt|;
specifier|volatile
name|struct
name|pbank
modifier|*
name|pbank
index|[
literal|2
operator|*
literal|64
index|]
decl_stmt|;
specifier|volatile
name|struct
name|rbank
modifier|*
name|rbank
decl_stmt|;
name|int
name|pslotfree
decl_stmt|,
name|currbank
decl_stmt|,
name|pchn
decl_stmt|,
name|rchn
decl_stmt|;
name|unsigned
name|int
name|bufsz
decl_stmt|;
name|struct
name|sc_pchinfo
name|pch
index|[
name|DS1_CHANS
index|]
decl_stmt|;
name|struct
name|sc_rchinfo
name|rch
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
block|{
name|u_int32_t
name|dev
decl_stmt|,
name|subdev
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|u_int32_t
modifier|*
name|mcode
decl_stmt|;
block|}
name|ds_devs
index|[]
init|=
block|{
block|{
literal|0x00041073
block|,
literal|0
block|,
literal|"Yamaha DS-1 (YMF724)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x000d1073
block|,
literal|0
block|,
literal|"Yamaha DS-1E (YMF724F)"
block|,
name|CntrlInst1E
block|}
block|,
block|{
literal|0x00051073
block|,
literal|0
block|,
literal|"Yamaha DS-1? (YMF734)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x00081073
block|,
literal|0
block|,
literal|"Yamaha DS-1? (YMF737)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x00201073
block|,
literal|0
block|,
literal|"Yamaha DS-1? (YMF738)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x00061073
block|,
literal|0
block|,
literal|"Yamaha DS-1? (YMF738_TEG)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x000a1073
block|,
literal|0x00041073
block|,
literal|"Yamaha DS-1 (YMF740)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x000a1073
block|,
literal|0x000a1073
block|,
literal|"Yamaha DS-1 (YMF740B)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x000a1073
block|,
literal|0x53328086
block|,
literal|"Yamaha DS-1 (YMF740I)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x000a1073
block|,
literal|0
block|,
literal|"Yamaha DS-1 (YMF740?)"
block|,
name|CntrlInst
block|}
block|,
block|{
literal|0x000c1073
block|,
literal|0
block|,
literal|"Yamaha DS-1E (YMF740C)"
block|,
name|CntrlInst1E
block|}
block|,
block|{
literal|0x00101073
block|,
literal|0
block|,
literal|"Yamaha DS-1E (YMF744)"
block|,
name|CntrlInst1E
block|}
block|,
block|{
literal|0x00121073
block|,
literal|0
block|,
literal|"Yamaha DS-1E (YMF754)"
block|,
name|CntrlInst1E
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * prototypes  */
end_comment

begin_comment
comment|/* stuff */
end_comment

begin_function_decl
specifier|static
name|int
name|ds_init
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ds_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* talk to the card */
end_comment

begin_function_decl
specifier|static
name|u_int32_t
name|ds_rd
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ds_wr
parameter_list|(
name|struct
name|sc_info
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int32_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_decl_stmt
specifier|static
name|u_int32_t
name|ds_recfmt
index|[]
init|=
block|{
name|AFMT_U8
block|,
name|AFMT_STEREO
operator||
name|AFMT_U8
block|,
name|AFMT_S8
block|,
name|AFMT_STEREO
operator||
name|AFMT_S8
block|,
name|AFMT_S16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
name|AFMT_U16_LE
block|,
name|AFMT_STEREO
operator||
name|AFMT_U16_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|ds_reccaps
init|=
block|{
literal|4000
block|,
literal|48000
block|,
name|ds_recfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int32_t
name|ds_playfmt
index|[]
init|=
block|{
name|AFMT_U8
block|,
name|AFMT_STEREO
operator||
name|AFMT_U8
block|,
comment|/* AFMT_S16_LE, */
name|AFMT_STEREO
operator||
name|AFMT_S16_LE
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pcmchan_caps
name|ds_playcaps
init|=
block|{
literal|4000
block|,
literal|96000
block|,
name|ds_playfmt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* Hardware */
end_comment

begin_function
specifier|static
name|u_int32_t
name|ds_rd
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
return|return
name|bus_space_read_1
argument_list|(
name|sc
operator|->
name|st
argument_list|,
name|sc
operator|->
name|sh
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|2
case|:
return|return
name|bus_space_read_2
argument_list|(
name|sc
operator|->
name|st
argument_list|,
name|sc
operator|->
name|sh
argument_list|,
name|regno
argument_list|)
return|;
case|case
literal|4
case|:
return|return
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|st
argument_list|,
name|sc
operator|->
name|sh
argument_list|,
name|regno
argument_list|)
return|;
default|default:
return|return
literal|0xffffffff
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ds_wr
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|,
name|int
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
name|bus_space_write_1
argument_list|(
name|sc
operator|->
name|st
argument_list|,
name|sc
operator|->
name|sh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|bus_space_write_2
argument_list|(
name|sc
operator|->
name|st
argument_list|,
name|sc
operator|->
name|sh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|bus_space_write_4
argument_list|(
name|sc
operator|->
name|st
argument_list|,
name|sc
operator|->
name|sh
argument_list|,
name|regno
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wrl
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|u_int32_t
modifier|*
name|ptr
parameter_list|,
name|u_int32_t
name|val
parameter_list|)
block|{
operator|*
operator|(
specifier|volatile
name|u_int32_t
operator|*
operator|)
name|ptr
operator|=
name|val
expr_stmt|;
name|bus_space_barrier
argument_list|(
name|sc
operator|->
name|st
argument_list|,
name|sc
operator|->
name|sh
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_BARRIER_WRITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* ac97 codec */
end_comment

begin_function
specifier|static
name|int
name|ds_cdbusy
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|sec
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|reg
decl_stmt|;
name|reg
operator|=
name|sec
condition|?
name|YDSXGR_SECSTATUSADR
else|:
name|YDSXGR_PRISTATUSADR
expr_stmt|;
name|i
operator|=
name|YDSXG_AC97TIMEOUT
expr_stmt|;
while|while
condition|(
name|i
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
literal|2
argument_list|)
operator|&
literal|0x8000
operator|)
condition|)
return|return
literal|0
return|;
name|i
operator|--
expr_stmt|;
block|}
return|return
name|ETIMEDOUT
return|;
block|}
end_function

begin_function
specifier|static
name|u_int32_t
name|ds_initcd
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|u_int32_t
name|x
decl_stmt|;
name|x
operator|=
name|pci_read_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCIR_DSXGCTRL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|&
literal|0x03
condition|)
block|{
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCIR_DSXGCTRL
argument_list|,
name|x
operator|&
operator|~
literal|0x03
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCIR_DSXGCTRL
argument_list|,
name|x
operator||
literal|0x03
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|PCIR_DSXGCTRL
argument_list|,
name|x
operator|&
operator|~
literal|0x03
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * The YMF740 on some Intel motherboards requires a pretty 		 * hefty delay after this reset for some reason...  Otherwise: 		 * "pcm0: ac97 codec init failed" 		 * Maybe this is needed for all YMF740's? 		 * 400ms and 500ms here seem to work, 300ms does not. 		 * 		 * do it for all chips -cg 		 */
name|DELAY
argument_list|(
literal|500000
argument_list|)
expr_stmt|;
block|}
return|return
name|ds_cdbusy
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_rdcd
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|int
name|regno
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|int
name|sec
decl_stmt|,
name|cid
decl_stmt|,
name|i
decl_stmt|;
name|u_int32_t
name|cmd
decl_stmt|,
name|reg
decl_stmt|;
name|sec
operator|=
name|regno
operator|&
literal|0x100
expr_stmt|;
name|regno
operator|&=
literal|0xff
expr_stmt|;
name|cid
operator|=
name|sec
condition|?
operator|(
name|sc
operator|->
name|cd2id
operator|<<
literal|8
operator|)
else|:
literal|0
expr_stmt|;
name|reg
operator|=
name|sec
condition|?
name|YDSXGR_SECSTATUSDATA
else|:
name|YDSXGR_PRISTATUSDATA
expr_stmt|;
if|if
condition|(
name|sec
operator|&&
name|cid
operator|==
literal|0
condition|)
return|return
literal|0xffffffff
return|;
name|cmd
operator|=
name|YDSXG_AC97READCMD
operator||
name|cid
operator||
name|regno
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_AC97CMDADR
argument_list|,
name|cmd
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds_cdbusy
argument_list|(
name|sc
argument_list|,
name|sec
argument_list|)
condition|)
return|return
literal|0xffffffff
return|;
if|if
condition|(
name|sc
operator|->
name|type
operator|==
literal|11
operator|&&
name|sc
operator|->
name|rev
operator|<
literal|2
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|600
condition|;
name|i
operator|++
control|)
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_wrcd
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|int
name|regno
parameter_list|,
name|u_int32_t
name|data
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|devinfo
decl_stmt|;
name|int
name|sec
decl_stmt|,
name|cid
decl_stmt|;
name|u_int32_t
name|cmd
decl_stmt|;
name|sec
operator|=
name|regno
operator|&
literal|0x100
expr_stmt|;
name|regno
operator|&=
literal|0xff
expr_stmt|;
name|cid
operator|=
name|sec
condition|?
operator|(
name|sc
operator|->
name|cd2id
operator|<<
literal|8
operator|)
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|sec
operator|&&
name|cid
operator|==
literal|0
condition|)
return|return
name|ENXIO
return|;
name|cmd
operator|=
name|YDSXG_AC97WRITECMD
operator||
name|cid
operator||
name|regno
expr_stmt|;
name|cmd
operator|<<=
literal|16
expr_stmt|;
name|cmd
operator||=
name|data
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_AC97CMDDATA
argument_list|,
name|cmd
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
name|ds_cdbusy
argument_list|(
name|sc
argument_list|,
name|sec
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|ds_ac97_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|ac97_init
argument_list|,
name|ds_initcd
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|ac97_read
argument_list|,
name|ds_rdcd
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|ac97_write
argument_list|,
name|ds_wrcd
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|AC97_DECLARE
argument_list|(
name|ds_ac97
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|void
name|ds_enadsp
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|u_int32_t
name|v
decl_stmt|,
name|i
decl_stmt|;
name|v
operator|=
name|on
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|on
condition|)
block|{
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_CONFIG
argument_list|,
literal|0x00000001
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_CONFIG
argument_list|,
literal|4
argument_list|)
condition|)
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_CONFIG
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|i
operator|=
name|YDSXG_WORKBITTIMEOUT
expr_stmt|;
while|while
condition|(
name|i
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_CONFIG
argument_list|,
literal|4
argument_list|)
operator|&
literal|0x00000002
operator|)
condition|)
break|break;
name|i
operator|--
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
specifier|volatile
name|struct
name|pbank
modifier|*
name|ds_allocpslot
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|slot
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|pslotfree
operator|>
literal|63
condition|)
return|return
name|NULL
return|;
name|slot
operator|=
name|sc
operator|->
name|pslotfree
operator|++
expr_stmt|;
return|return
name|sc
operator|->
name|pbank
index|[
name|slot
operator|*
literal|2
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_initpbank
parameter_list|(
specifier|volatile
name|struct
name|pbank
modifier|*
name|pb
parameter_list|,
name|int
name|ch
parameter_list|,
name|int
name|b16
parameter_list|,
name|int
name|stereo
parameter_list|,
name|u_int32_t
name|rate
parameter_list|,
name|bus_addr_t
name|base
parameter_list|,
name|u_int32_t
name|len
parameter_list|)
block|{
name|u_int32_t
name|lv
index|[]
init|=
block|{
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|u_int32_t
name|rv
index|[]
init|=
block|{
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|u_int32_t
name|e1
index|[]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|u_int32_t
name|e2
index|[]
init|=
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|}
decl_stmt|;
name|u_int32_t
name|e3
index|[]
init|=
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
decl_stmt|;
name|int
name|ss
decl_stmt|,
name|i
decl_stmt|;
name|u_int32_t
name|delta
decl_stmt|;
struct|struct
block|{
name|int
name|rate
decl_stmt|,
name|fK
decl_stmt|,
name|fQ
decl_stmt|;
block|}
name|speedinfo
index|[]
init|=
block|{
block|{
literal|100
block|,
literal|0x00570000
block|,
literal|0x35280000
block|}
block|,
block|{
literal|2000
block|,
literal|0x06aa0000
block|,
literal|0x34a70000
block|}
block|,
block|{
literal|8000
block|,
literal|0x18b20000
block|,
literal|0x32020000
block|}
block|,
block|{
literal|11025
block|,
literal|0x20930000
block|,
literal|0x31770000
block|}
block|,
block|{
literal|16000
block|,
literal|0x2b9a0000
block|,
literal|0x31390000
block|}
block|,
block|{
literal|22050
block|,
literal|0x35a10000
block|,
literal|0x31c90000
block|}
block|,
block|{
literal|32000
block|,
literal|0x3eaa0000
block|,
literal|0x33d00000
block|}
block|,
comment|/*		{44100, 0x04646000, 0x370a0000}, */
block|{
literal|48000
block|,
literal|0x40000000
block|,
literal|0x40000000
block|}
block|, 	}
struct|;
name|ss
operator|=
name|b16
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ss
operator|+=
name|stereo
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|delta
operator|=
operator|(
literal|65536
operator|*
name|rate
operator|)
operator|/
literal|48000
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
literal|7
operator|&&
name|speedinfo
index|[
name|i
index|]
operator|.
name|rate
operator|<
name|rate
condition|)
name|i
operator|++
expr_stmt|;
name|pb
operator|->
name|Format
operator|=
name|stereo
condition|?
literal|0x00010000
else|:
literal|0
expr_stmt|;
name|pb
operator|->
name|Format
operator||=
name|b16
condition|?
literal|0
else|:
literal|0x80000000
expr_stmt|;
name|pb
operator|->
name|Format
operator||=
operator|(
name|stereo
operator|&&
operator|(
name|ch
operator|==
literal|2
operator|||
name|ch
operator|==
literal|4
operator|)
operator|)
condition|?
literal|0x00000001
else|:
literal|0
expr_stmt|;
name|pb
operator|->
name|LoopDefault
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|PgBase
operator|=
name|base
condition|?
name|base
else|:
literal|0
expr_stmt|;
name|pb
operator|->
name|PgLoop
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|PgLoopEnd
operator|=
name|len
operator|>>
name|ss
expr_stmt|;
name|pb
operator|->
name|PgLoopFrac
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|Status
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|NumOfFrames
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|LoopCount
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|PgStart
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|PgStartFrac
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|PgDelta
operator|=
name|pb
operator|->
name|PgDeltaEnd
operator|=
name|delta
operator|<<
literal|12
expr_stmt|;
name|pb
operator|->
name|LpfQ
operator|=
name|speedinfo
index|[
name|i
index|]
operator|.
name|fQ
expr_stmt|;
name|pb
operator|->
name|LpfK
operator|=
name|pb
operator|->
name|LpfKEnd
operator|=
name|speedinfo
index|[
name|i
index|]
operator|.
name|fK
expr_stmt|;
name|pb
operator|->
name|LpfD1
operator|=
name|pb
operator|->
name|LpfD2
operator|=
literal|0
expr_stmt|;
name|pb
operator|->
name|EgGain
operator|=
name|pb
operator|->
name|EgGainEnd
operator|=
literal|0x40000000
expr_stmt|;
name|pb
operator|->
name|LchGain
operator|=
name|pb
operator|->
name|LchGainEnd
operator|=
name|lv
index|[
name|ch
index|]
operator|*
literal|0x40000000
expr_stmt|;
name|pb
operator|->
name|RchGain
operator|=
name|pb
operator|->
name|RchGainEnd
operator|=
name|rv
index|[
name|ch
index|]
operator|*
literal|0x40000000
expr_stmt|;
name|pb
operator|->
name|Effect1Gain
operator|=
name|pb
operator|->
name|Effect1GainEnd
operator|=
name|e1
index|[
name|ch
index|]
operator|*
literal|0x40000000
expr_stmt|;
name|pb
operator|->
name|Effect2Gain
operator|=
name|pb
operator|->
name|Effect2GainEnd
operator|=
name|e2
index|[
name|ch
index|]
operator|*
literal|0x40000000
expr_stmt|;
name|pb
operator|->
name|Effect3Gain
operator|=
name|pb
operator|->
name|Effect3GainEnd
operator|=
name|e3
index|[
name|ch
index|]
operator|*
literal|0x40000000
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_enapslot
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|,
name|int
name|slot
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|wrl
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|pbase
index|[
name|slot
operator|+
literal|1
index|]
argument_list|,
name|go
condition|?
operator|(
name|sc
operator|->
name|pbankbase
operator|+
literal|2
operator|*
name|slot
operator|*
name|sc
operator|->
name|pbanksize
operator|)
else|:
literal|0
argument_list|)
expr_stmt|;
comment|/* printf("pbase[%d] = 0x%x\n", slot + 1, go? (sc->pbankbase + 2 * slot * sc->pbanksize) : 0); */
block|}
end_function

begin_function
specifier|static
name|void
name|ds_setuppch
parameter_list|(
name|struct
name|sc_pchinfo
modifier|*
name|ch
parameter_list|)
block|{
name|int
name|stereo
decl_stmt|,
name|b16
decl_stmt|,
name|c
decl_stmt|,
name|sz
decl_stmt|;
name|bus_addr_t
name|addr
decl_stmt|;
name|stereo
operator|=
operator|(
name|ch
operator|->
name|fmt
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|b16
operator|=
operator|(
name|ch
operator|->
name|fmt
operator|&
name|AFMT_16BIT
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|c
operator|=
name|stereo
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|addr
operator|=
name|sndbuf_getbufaddr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|sz
operator|=
name|sndbuf_getsize
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|ds_initpbank
argument_list|(
name|ch
operator|->
name|lslot
argument_list|,
name|c
argument_list|,
name|stereo
argument_list|,
name|b16
argument_list|,
name|ch
operator|->
name|spd
argument_list|,
name|addr
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|ds_initpbank
argument_list|(
name|ch
operator|->
name|lslot
operator|+
literal|1
argument_list|,
name|c
argument_list|,
name|stereo
argument_list|,
name|b16
argument_list|,
name|ch
operator|->
name|spd
argument_list|,
name|addr
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|ds_initpbank
argument_list|(
name|ch
operator|->
name|rslot
argument_list|,
literal|2
argument_list|,
name|stereo
argument_list|,
name|b16
argument_list|,
name|ch
operator|->
name|spd
argument_list|,
name|addr
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|ds_initpbank
argument_list|(
name|ch
operator|->
name|rslot
operator|+
literal|1
argument_list|,
literal|2
argument_list|,
name|stereo
argument_list|,
name|b16
argument_list|,
name|ch
operator|->
name|spd
argument_list|,
name|addr
argument_list|,
name|sz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ds_setuprch
parameter_list|(
name|struct
name|sc_rchinfo
modifier|*
name|ch
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|int
name|stereo
decl_stmt|,
name|b16
decl_stmt|,
name|i
decl_stmt|,
name|sz
decl_stmt|,
name|pri
decl_stmt|;
name|u_int32_t
name|x
decl_stmt|,
name|y
decl_stmt|;
name|bus_addr_t
name|addr
decl_stmt|;
name|stereo
operator|=
operator|(
name|ch
operator|->
name|fmt
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|b16
operator|=
operator|(
name|ch
operator|->
name|fmt
operator|&
name|AFMT_16BIT
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|addr
operator|=
name|sndbuf_getbufaddr
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|sz
operator|=
name|sndbuf_getsize
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|pri
operator|=
operator|(
name|ch
operator|->
name|num
operator|==
name|DS1_RECPRIMARY
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|PgBase
operator|=
name|addr
expr_stmt|;
name|ch
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|PgLoopEnd
operator|=
name|sz
expr_stmt|;
name|ch
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|PgStart
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|NumOfLoops
operator|=
literal|0
expr_stmt|;
block|}
name|x
operator|=
operator|(
name|b16
condition|?
literal|0x00
else|:
literal|0x01
operator|)
operator||
operator|(
name|stereo
condition|?
literal|0x02
else|:
literal|0x00
operator|)
expr_stmt|;
name|y
operator|=
operator|(
literal|48000
operator|*
literal|4096
operator|)
operator|/
name|ch
operator|->
name|spd
expr_stmt|;
name|y
operator|--
expr_stmt|;
comment|/* printf("pri = %d, x = %d, y = %d\n", pri, x, y); */
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|pri
condition|?
name|YDSXGR_ADCFORMAT
else|:
name|YDSXGR_RECFORMAT
argument_list|,
name|x
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|pri
condition|?
name|YDSXGR_ADCSLOTSR
else|:
name|YDSXGR_RECSLOTSR
argument_list|,
name|y
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* play channel interface */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|ds1pchan_init
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|devinfo
decl_stmt|;
name|struct
name|sc_pchinfo
modifier|*
name|ch
decl_stmt|;
name|KASSERT
argument_list|(
name|dir
operator|==
name|PCMDIR_PLAY
argument_list|,
operator|(
literal|"ds1pchan_init: bad direction"
operator|)
argument_list|)
expr_stmt|;
name|ch
operator|=
operator|&
name|sc
operator|->
name|pch
index|[
name|sc
operator|->
name|pchn
operator|++
index|]
expr_stmt|;
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|dir
operator|=
name|dir
expr_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|AFMT_U8
expr_stmt|;
name|ch
operator|->
name|spd
operator|=
literal|8000
expr_stmt|;
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sndbuf_alloc
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|sc
operator|->
name|buffer_dmat
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|bufsz
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
else|else
block|{
name|ch
operator|->
name|lsnum
operator|=
name|sc
operator|->
name|pslotfree
expr_stmt|;
name|ch
operator|->
name|lslot
operator|=
name|ds_allocpslot
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ch
operator|->
name|rsnum
operator|=
name|sc
operator|->
name|pslotfree
expr_stmt|;
name|ch
operator|->
name|rslot
operator|=
name|ds_allocpslot
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ds_setuppch
argument_list|(
name|ch
argument_list|)
expr_stmt|;
return|return
name|ch
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ds1pchan_setformat
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|format
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds1pchan_setspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ch
operator|->
name|spd
operator|=
name|speed
expr_stmt|;
return|return
name|speed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds1pchan_setblocksize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|int
name|drate
decl_stmt|;
comment|/* irq rate is fixed at 187.5hz */
name|drate
operator|=
name|ch
operator|->
name|spd
operator|*
name|sndbuf_getbps
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|blocksize
operator|=
name|roundup2
argument_list|(
operator|(
name|drate
operator|<<
literal|8
operator|)
operator|/
name|DS1_IRQHZ
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sndbuf_resize
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|sc
operator|->
name|bufsz
operator|/
name|blocksize
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
return|return
name|blocksize
return|;
block|}
end_function

begin_comment
comment|/* semantic note: must start at beginning of buffer */
end_comment

begin_function
specifier|static
name|int
name|ds1pchan_trigger
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|int
name|stereo
decl_stmt|;
if|if
condition|(
name|go
operator|==
name|PCMTRIG_EMLDMAWR
operator|||
name|go
operator|==
name|PCMTRIG_EMLDMARD
condition|)
return|return
literal|0
return|;
name|stereo
operator|=
operator|(
name|ch
operator|->
name|fmt
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|go
operator|==
name|PCMTRIG_START
condition|)
block|{
name|ch
operator|->
name|run
operator|=
literal|1
expr_stmt|;
name|ds_setuppch
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|ds_enapslot
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|lsnum
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ds_enapslot
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|rsnum
argument_list|,
name|stereo
argument_list|)
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MODE
argument_list|,
literal|0x00000003
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
comment|/* ds_setuppch(ch); */
name|ds_enapslot
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|lsnum
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ds_enapslot
argument_list|(
name|sc
argument_list|,
name|ch
operator|->
name|rsnum
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds1pchan_getptr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_pchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
specifier|volatile
name|struct
name|pbank
modifier|*
name|bank
decl_stmt|;
name|int
name|ss
decl_stmt|;
name|u_int32_t
name|ptr
decl_stmt|;
name|ss
operator|=
operator|(
name|ch
operator|->
name|fmt
operator|&
name|AFMT_STEREO
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ss
operator|+=
operator|(
name|ch
operator|->
name|fmt
operator|&
name|AFMT_16BIT
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|bank
operator|=
name|ch
operator|->
name|lslot
operator|+
name|sc
operator|->
name|currbank
expr_stmt|;
comment|/* printf("getptr: %d\n", bank->PgStart<< ss); */
name|ptr
operator|=
name|bank
operator|->
name|PgStart
expr_stmt|;
name|ptr
operator|<<=
name|ss
expr_stmt|;
return|return
name|ptr
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|ds1pchan_getcaps
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
return|return
operator|&
name|ds_playcaps
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|ds1pchan_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|ds1pchan_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|ds1pchan_setformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|ds1pchan_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|ds1pchan_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|ds1pchan_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|ds1pchan_getptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|ds1pchan_getcaps
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|CHANNEL_DECLARE
argument_list|(
name|ds1pchan
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* record channel interface */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|ds1rchan_init
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|c
parameter_list|,
name|int
name|dir
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|devinfo
decl_stmt|;
name|struct
name|sc_rchinfo
modifier|*
name|ch
decl_stmt|;
name|KASSERT
argument_list|(
name|dir
operator|==
name|PCMDIR_REC
argument_list|,
operator|(
literal|"ds1rchan_init: bad direction"
operator|)
argument_list|)
expr_stmt|;
name|ch
operator|=
operator|&
name|sc
operator|->
name|rch
index|[
name|sc
operator|->
name|rchn
index|]
expr_stmt|;
name|ch
operator|->
name|num
operator|=
name|sc
operator|->
name|rchn
operator|++
expr_stmt|;
name|ch
operator|->
name|buffer
operator|=
name|b
expr_stmt|;
name|ch
operator|->
name|parent
operator|=
name|sc
expr_stmt|;
name|ch
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|ch
operator|->
name|dir
operator|=
name|dir
expr_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|AFMT_U8
expr_stmt|;
name|ch
operator|->
name|spd
operator|=
literal|8000
expr_stmt|;
if|if
condition|(
name|sndbuf_alloc
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|sc
operator|->
name|buffer_dmat
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|bufsz
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
else|else
block|{
name|ch
operator|->
name|slot
operator|=
operator|(
name|ch
operator|->
name|num
operator|==
name|DS1_RECPRIMARY
operator|)
condition|?
name|sc
operator|->
name|rbank
operator|+
literal|2
else|:
name|sc
operator|->
name|rbank
expr_stmt|;
name|ds_setuprch
argument_list|(
name|ch
argument_list|)
expr_stmt|;
return|return
name|ch
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ds1rchan_setformat
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|format
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ch
operator|->
name|fmt
operator|=
name|format
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds1rchan_setspeed
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|speed
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|ch
operator|->
name|spd
operator|=
name|speed
expr_stmt|;
return|return
name|speed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds1rchan_setblocksize
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|u_int32_t
name|blocksize
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|int
name|drate
decl_stmt|;
comment|/* irq rate is fixed at 187.5hz */
name|drate
operator|=
name|ch
operator|->
name|spd
operator|*
name|sndbuf_getbps
argument_list|(
name|ch
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|blocksize
operator|=
name|roundup2
argument_list|(
operator|(
name|drate
operator|<<
literal|8
operator|)
operator|/
name|DS1_IRQHZ
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sndbuf_resize
argument_list|(
name|ch
operator|->
name|buffer
argument_list|,
name|sc
operator|->
name|bufsz
operator|/
name|blocksize
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
return|return
name|blocksize
return|;
block|}
end_function

begin_comment
comment|/* semantic note: must start at beginning of buffer */
end_comment

begin_function
specifier|static
name|int
name|ds1rchan_trigger
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
name|u_int32_t
name|x
decl_stmt|;
if|if
condition|(
name|go
operator|==
name|PCMTRIG_EMLDMAWR
operator|||
name|go
operator|==
name|PCMTRIG_EMLDMARD
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|go
operator|==
name|PCMTRIG_START
condition|)
block|{
name|ch
operator|->
name|run
operator|=
literal|1
expr_stmt|;
name|ds_setuprch
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|x
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFREC
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|x
operator||=
operator|(
name|ch
operator|->
name|num
operator|==
name|DS1_RECPRIMARY
operator|)
condition|?
literal|0x02
else|:
literal|0x01
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFREC
argument_list|,
name|x
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MODE
argument_list|,
literal|0x00000003
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|run
operator|=
literal|0
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|x
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFREC
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|x
operator|&=
operator|~
operator|(
operator|(
name|ch
operator|->
name|num
operator|==
name|DS1_RECPRIMARY
operator|)
condition|?
literal|0x02
else|:
literal|0x01
operator|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFREC
argument_list|,
name|x
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds1rchan_getptr
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|sc_rchinfo
modifier|*
name|ch
init|=
name|data
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|ch
operator|->
name|parent
decl_stmt|;
return|return
name|ch
operator|->
name|slot
index|[
name|sc
operator|->
name|currbank
index|]
operator|.
name|PgStart
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|pcmchan_caps
modifier|*
name|ds1rchan_getcaps
parameter_list|(
name|kobj_t
name|obj
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
return|return
operator|&
name|ds_reccaps
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|kobj_method_t
name|ds1rchan_methods
index|[]
init|=
block|{
name|KOBJMETHOD
argument_list|(
name|channel_init
argument_list|,
name|ds1rchan_init
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setformat
argument_list|,
name|ds1rchan_setformat
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setspeed
argument_list|,
name|ds1rchan_setspeed
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_setblocksize
argument_list|,
name|ds1rchan_setblocksize
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_trigger
argument_list|,
name|ds1rchan_trigger
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getptr
argument_list|,
name|ds1rchan_getptr
argument_list|)
block|,
name|KOBJMETHOD
argument_list|(
name|channel_getcaps
argument_list|,
name|ds1rchan_getcaps
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|CHANNEL_DECLARE
argument_list|(
name|ds1rchan
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/* The interrupt handler */
end_comment

begin_function
specifier|static
name|void
name|ds_intr
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
operator|(
expr|struct
name|sc_info
operator|*
operator|)
name|p
decl_stmt|;
name|u_int32_t
name|i
decl_stmt|,
name|x
decl_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|i
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_STATUS
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|0x00008000
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"timeout irq\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|0x80008000
condition|)
block|{
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_STATUS
argument_list|,
name|i
operator|&
literal|0x80008000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sc
operator|->
name|currbank
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_CTRLSELECT
argument_list|,
literal|4
argument_list|)
operator|&
literal|0x00000001
expr_stmt|;
name|x
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DS1_CHANS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|pch
index|[
name|i
index|]
operator|.
name|run
condition|)
block|{
name|x
operator|=
literal|1
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|chn_intr
argument_list|(
name|sc
operator|->
name|pch
index|[
name|i
index|]
operator|.
name|channel
argument_list|)
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|rch
index|[
name|i
index|]
operator|.
name|run
condition|)
block|{
name|x
operator|=
literal|1
expr_stmt|;
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|chn_intr
argument_list|(
name|sc
operator|->
name|rch
index|[
name|i
index|]
operator|.
name|channel
argument_list|)
expr_stmt|;
name|snd_mtxlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
block|}
name|i
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MODE
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
condition|)
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MODE
argument_list|,
name|i
operator||
literal|0x00000002
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|snd_mtxunlock
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------- */
end_comment

begin_comment
comment|/*  * Probe and attach the card  */
end_comment

begin_function
specifier|static
name|void
name|ds_setmap
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|sc
operator|->
name|ctrlbase
operator|=
name|error
condition|?
literal|0
else|:
operator|(
name|u_int32_t
operator|)
name|segs
operator|->
name|ds_addr
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|printf
argument_list|(
literal|"ds1: setmap (%lx, %lx), nseg=%d, error=%d\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_addr
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|segs
operator|->
name|ds_len
argument_list|,
name|nseg
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ds_init
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
modifier|*
name|ci
decl_stmt|,
name|r
decl_stmt|,
name|pcs
decl_stmt|,
name|rcs
decl_stmt|,
name|ecs
decl_stmt|,
name|ws
decl_stmt|,
name|memsz
decl_stmt|,
name|cb
decl_stmt|;
name|u_int8_t
modifier|*
name|t
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
name|ci
operator|=
name|ds_devs
index|[
name|sc
operator|->
name|type
index|]
operator|.
name|mcode
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_NATIVEDACOUTVOL
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_enadsp
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MODE
argument_list|,
literal|0x00010000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MODE
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFREC
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFEFFECT
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_PLAYCTRLBASE
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_RECCTRLBASE
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_EFFCTRLBASE
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|r
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_GLOBALCTRL
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_GLOBALCTRL
argument_list|,
name|r
operator|&
operator|~
literal|0x0007
argument_list|,
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|YDSXG_DSPLENGTH
condition|;
name|i
operator|+=
literal|4
control|)
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_DSPINSTRAM
operator|+
name|i
argument_list|,
name|DspInst
index|[
name|i
operator|>>
literal|2
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|YDSXG_CTRLLENGTH
condition|;
name|i
operator|+=
literal|4
control|)
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_CTRLINSTRAM
operator|+
name|i
argument_list|,
name|ci
index|[
name|i
operator|>>
literal|2
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_enadsp
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pcs
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|100
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|pcs
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_PLAYCTRLSIZE
argument_list|,
literal|4
argument_list|)
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
name|pcs
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|pbank
argument_list|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pcs
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|pbank
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"preposterous playctrlsize (%d)\n"
argument_list|,
name|pcs
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|rcs
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_RECCTRLSIZE
argument_list|,
literal|4
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|ecs
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_EFFCTRLSIZE
argument_list|,
literal|4
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|ws
operator|=
name|ds_rd
argument_list|(
name|sc
argument_list|,
name|YDSXGR_WORKSIZE
argument_list|,
literal|4
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|memsz
operator|=
literal|64
operator|*
literal|2
operator|*
name|pcs
operator|+
literal|2
operator|*
literal|2
operator|*
name|rcs
operator|+
literal|5
operator|*
literal|2
operator|*
name|ecs
operator|+
name|ws
expr_stmt|;
name|memsz
operator|+=
operator|(
literal|64
operator|+
literal|1
operator|)
operator|*
literal|4
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|regbase
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|memsz
argument_list|,
literal|1
argument_list|,
name|memsz
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|control_dmat
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|control_dmat
argument_list|,
operator|&
name|buf
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|sc
operator|->
name|map
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|control_dmat
argument_list|,
name|sc
operator|->
name|map
argument_list|,
name|buf
argument_list|,
name|memsz
argument_list|,
name|ds_setmap
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
operator|||
operator|!
name|sc
operator|->
name|ctrlbase
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"pcs=%d, rcs=%d, ecs=%d, ws=%d, memsz=%d\n"
argument_list|,
name|pcs
argument_list|,
name|rcs
argument_list|,
name|ecs
argument_list|,
name|ws
argument_list|,
name|memsz
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sc
operator|->
name|regbase
operator|=
name|buf
expr_stmt|;
block|}
else|else
name|buf
operator|=
name|sc
operator|->
name|regbase
expr_stmt|;
name|cb
operator|=
literal|0
expr_stmt|;
name|t
operator|=
name|buf
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_WORKBASE
argument_list|,
name|sc
operator|->
name|ctrlbase
operator|+
name|cb
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|cb
operator|+=
name|ws
expr_stmt|;
name|sc
operator|->
name|pbase
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|t
operator|+
name|cb
operator|)
expr_stmt|;
comment|/* printf("pbase = %p -> 0x%x\n", sc->pbase, sc->ctrlbase + cb); */
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_PLAYCTRLBASE
argument_list|,
name|sc
operator|->
name|ctrlbase
operator|+
name|cb
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|cb
operator|+=
operator|(
literal|64
operator|+
literal|1
operator|)
operator|*
literal|4
expr_stmt|;
name|sc
operator|->
name|rbank
operator|=
operator|(
expr|struct
name|rbank
operator|*
operator|)
operator|(
name|t
operator|+
name|cb
operator|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_RECCTRLBASE
argument_list|,
name|sc
operator|->
name|ctrlbase
operator|+
name|cb
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|cb
operator|+=
literal|2
operator|*
literal|2
operator|*
name|rcs
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_EFFCTRLBASE
argument_list|,
name|sc
operator|->
name|ctrlbase
operator|+
name|cb
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|cb
operator|+=
literal|5
operator|*
literal|2
operator|*
name|ecs
expr_stmt|;
name|sc
operator|->
name|pbankbase
operator|=
name|sc
operator|->
name|ctrlbase
operator|+
name|cb
expr_stmt|;
name|sc
operator|->
name|pbanksize
operator|=
name|pcs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|wrl
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|pbase
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pbank
index|[
name|i
operator|*
literal|2
index|]
operator|=
operator|(
expr|struct
name|pbank
operator|*
operator|)
operator|(
name|t
operator|+
name|cb
operator|)
expr_stmt|;
comment|/* printf("pbank[%d] = %p -> 0x%x; ", i * 2, (struct pbank *)(t + cb), sc->ctrlbase + cb - vtophys(t + cb)); */
name|cb
operator|+=
name|pcs
expr_stmt|;
name|sc
operator|->
name|pbank
index|[
name|i
operator|*
literal|2
operator|+
literal|1
index|]
operator|=
operator|(
expr|struct
name|pbank
operator|*
operator|)
operator|(
name|t
operator|+
name|cb
operator|)
expr_stmt|;
comment|/* printf("pbank[%d] = %p -> 0x%x\n", i * 2 + 1, (struct pbank *)(t + cb), sc->ctrlbase + cb - vtophys(t + cb)); */
name|cb
operator|+=
name|pcs
expr_stmt|;
block|}
name|wrl
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|pbase
index|[
literal|0
index|]
argument_list|,
name|DS1_CHANS
operator|*
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pchn
operator|=
name|sc
operator|->
name|rchn
operator|=
literal|0
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_NATIVEDACOUTVOL
argument_list|,
literal|0x3fff3fff
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_NATIVEADCINVOL
argument_list|,
literal|0x3fff3fff
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_NATIVEDACINVOL
argument_list|,
literal|0x3fff3fff
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_uninit
parameter_list|(
name|struct
name|sc_info
modifier|*
name|sc
parameter_list|)
block|{
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_NATIVEDACOUTVOL
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_NATIVEADCINVOL
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_NATIVEDACINVOL
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_enadsp
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MODE
argument_list|,
literal|0x00010000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFREC
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_MAPOFEFFECT
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_PLAYCTRLBASE
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_RECCTRLBASE
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_EFFCTRLBASE
argument_list|,
literal|0x00000000
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ds_wr
argument_list|(
name|sc
argument_list|,
name|YDSXGR_GLOBALCTRL
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|control_dmat
argument_list|,
name|sc
operator|->
name|map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|control_dmat
argument_list|,
name|sc
operator|->
name|regbase
argument_list|,
name|sc
operator|->
name|map
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_finddev
parameter_list|(
name|u_int32_t
name|dev
parameter_list|,
name|u_int32_t
name|subdev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ds_devs
index|[
name|i
index|]
operator|.
name|dev
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ds_devs
index|[
name|i
index|]
operator|.
name|dev
operator|==
name|dev
operator|&&
operator|(
name|ds_devs
index|[
name|i
index|]
operator|.
name|subdev
operator|==
name|subdev
operator|||
name|ds_devs
index|[
name|i
index|]
operator|.
name|subdev
operator|==
literal|0
operator|)
condition|)
return|return
name|i
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_pci_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
name|subdev
decl_stmt|;
name|subdev
operator|=
operator|(
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|i
operator|=
name|ds_finddev
argument_list|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
argument_list|,
name|subdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
name|ds_devs
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|BUS_PROBE_DEFAULT
return|;
block|}
else|else
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_pci_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int32_t
name|data
decl_stmt|;
name|u_int32_t
name|subdev
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|struct
name|ac97_info
modifier|*
name|codec
init|=
name|NULL
decl_stmt|;
name|char
name|status
index|[
name|SND_STATUSLEN
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|sc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate softc\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|sc
operator|->
name|lock
operator|=
name|snd_mtxcreate
argument_list|(
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"snd_ds1 softc"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|subdev
operator|=
operator|(
name|pci_get_subdevice
argument_list|(
name|dev
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|pci_get_subvendor
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|type
operator|=
name|ds_finddev
argument_list|(
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
argument_list|,
name|subdev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rev
operator|=
name|pci_get_revid
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator||=
operator|(
name|PCIM_CMD_PORTEN
operator||
name|PCIM_CMD_MEMEN
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
expr_stmt|;
name|pci_write_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator|=
name|pci_read_config
argument_list|(
name|dev
argument_list|,
name|PCIR_COMMAND
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|reg
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|regid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|reg
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map register space\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|st
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bufsz
operator|=
name|pcm_getbuffersize
argument_list|(
name|dev
argument_list|,
literal|4096
argument_list|,
name|DS1_BUFFSIZE
argument_list|,
literal|65536
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
comment|/*parent*/
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
comment|/*alignment*/
literal|2
argument_list|,
comment|/*boundary*/
literal|0
argument_list|,
comment|/*lowaddr*/
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/*highaddr*/
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/*filter*/
name|NULL
argument_list|,
comment|/*filterarg*/
name|NULL
argument_list|,
comment|/*maxsize*/
name|sc
operator|->
name|bufsz
argument_list|,
comment|/*nsegments*/
literal|1
argument_list|,
comment|/*maxsegz*/
literal|0x3ffff
argument_list|,
comment|/*flags*/
literal|0
argument_list|,
comment|/*lockfunc*/
name|NULL
argument_list|,
comment|/*lockarg*/
name|NULL
argument_list|,
operator|&
name|sc
operator|->
name|buffer_dmat
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create dma tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|sc
operator|->
name|regbase
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ds_init
argument_list|(
name|sc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to initialize the card\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|codec
operator|=
name|AC97_CREATE
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
name|ds_ac97
argument_list|)
expr_stmt|;
if|if
condition|(
name|codec
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
comment|/* 	 * Turn on inverted external amplifier sense flags for few 	 * 'special' boards. 	 */
switch|switch
condition|(
name|subdev
condition|)
block|{
case|case
literal|0x81171033
case|:
comment|/* NEC ValueStar (VT550/0) */
name|ac97_setflags
argument_list|(
name|codec
argument_list|,
name|ac97_getflags
argument_list|(
name|codec
argument_list|)
operator||
name|AC97_F_EAPD_INV
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|mixer_init
argument_list|(
name|dev
argument_list|,
name|ac97_getmixerclass
argument_list|()
argument_list|,
name|codec
argument_list|)
expr_stmt|;
name|sc
operator|->
name|irqid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|irqid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|irq
operator|||
name|snd_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|INTR_MPSAFE
argument_list|,
name|ds_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ih
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|snprintf
argument_list|(
name|status
argument_list|,
name|SND_STATUSLEN
argument_list|,
literal|"at memory 0x%lx irq %ld %s"
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|reg
argument_list|)
argument_list|,
name|rman_get_start
argument_list|(
name|sc
operator|->
name|irq
argument_list|)
argument_list|,
name|PCM_KLDSTRING
argument_list|(
name|snd_ds1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcm_register
argument_list|(
name|dev
argument_list|,
name|sc
argument_list|,
name|DS1_CHANS
argument_list|,
literal|2
argument_list|)
condition|)
goto|goto
name|bad
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DS1_CHANS
condition|;
name|i
operator|++
control|)
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_PLAY
argument_list|,
operator|&
name|ds1pchan_class
argument_list|,
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
name|pcm_addchan
argument_list|(
name|dev
argument_list|,
name|PCMDIR_REC
argument_list|,
operator|&
name|ds1rchan_class
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|pcm_setstatus
argument_list|(
name|dev
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|bad
label|:
if|if
condition|(
name|codec
condition|)
name|ac97_destroy
argument_list|(
name|codec
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|reg
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|regid
argument_list|,
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ih
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|buffer_dmat
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|buffer_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|control_dmat
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|control_dmat
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|lock
condition|)
name|snd_mtxfree
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_pci_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds_init
argument_list|(
name|sc
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reinitialize the card\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
name|mixer_reinit
argument_list|(
name|dev
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to reinitialize the mixer\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ds_pci_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|struct
name|sc_info
modifier|*
name|sc
decl_stmt|;
name|r
operator|=
name|pcm_unregister
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
return|return
name|r
return|;
name|sc
operator|=
name|pcm_getdevinfo
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ds_uninit
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|regid
argument_list|,
name|sc
operator|->
name|reg
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq
argument_list|,
name|sc
operator|->
name|ih
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|sc
operator|->
name|irqid
argument_list|,
name|sc
operator|->
name|irq
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|buffer_dmat
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|control_dmat
argument_list|)
expr_stmt|;
name|snd_mtxfree
argument_list|(
name|sc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ds1_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ds_pci_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ds_pci_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ds_pci_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|ds_pci_resume
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ds1_driver
init|=
block|{
literal|"pcm"
block|,
name|ds1_methods
block|,
name|PCM_SOFTC_SIZE
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|snd_ds1
argument_list|,
name|pci
argument_list|,
name|ds1_driver
argument_list|,
name|pcm_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|snd_ds1
argument_list|,
name|sound
argument_list|,
name|SOUND_MINVER
argument_list|,
name|SOUND_PREFVER
argument_list|,
name|SOUND_MAXVER
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|snd_ds1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


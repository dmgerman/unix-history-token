begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2005-2009 Ariff Abdullah<ariff@FreeBSD.org>  * Portions Copyright (c) Ryan Beasley<ryan.beasley@gmail.com> - GSoC 2006  * Copyright (c) 1999 Cameron Grant<cg@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_KERNEL_OPTION_HEADERS
end_ifdef

begin_include
include|#
directive|include
file|"opt_snd.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|"feeder_if.h"
end_include

begin_define
define|#
directive|define
name|SND_USE_FXDIV
end_define

begin_define
define|#
directive|define
name|SND_DECLARE_FXDIV
end_define

begin_include
include|#
directive|include
file|"snd_fxdiv_gen.h"
end_include

begin_expr_stmt
name|SND_DECLARE_FILE
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|struct
name|snd_dbuf
modifier|*
name|sndbuf_create
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|drv
parameter_list|,
name|char
modifier|*
name|desc
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|channel
parameter_list|)
block|{
name|struct
name|snd_dbuf
modifier|*
name|b
decl_stmt|;
name|b
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|b
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|b
operator|->
name|name
argument_list|,
name|SNDBUF_NAMELEN
argument_list|,
literal|"%s:%s"
argument_list|,
name|drv
argument_list|,
name|desc
argument_list|)
expr_stmt|;
name|b
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|b
operator|->
name|channel
operator|=
name|channel
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_destroy
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|sndbuf_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|b
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|bus_addr_t
name|sndbuf_getbufaddr
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|buf
parameter_list|)
block|{
return|return
operator|(
name|buf
operator|->
name|buf_addr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sndbuf_setmap
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|snd_dbuf
modifier|*
name|b
init|=
operator|(
expr|struct
name|snd_dbuf
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|b
operator|->
name|dev
argument_list|,
literal|"sndbuf_setmap %lx, %lx; "
argument_list|,
operator|(
name|u_long
operator|)
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|,
operator|(
name|u_long
operator|)
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%p -> %lx\n"
argument_list|,
name|b
operator|->
name|buf
argument_list|,
operator|(
name|u_long
operator|)
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|b
operator|->
name|buf_addr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
else|else
name|b
operator|->
name|buf_addr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Allocate memory for DMA buffer. If the device does not use DMA transfers,  * the driver can call malloc(9) and sndbuf_setup() itself.  */
end_comment

begin_function
name|int
name|sndbuf_alloc
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|bus_dma_tag_t
name|dmatag
parameter_list|,
name|int
name|dmaflags
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|b
operator|->
name|dmatag
operator|=
name|dmatag
expr_stmt|;
name|b
operator|->
name|dmaflags
operator|=
name|dmaflags
operator||
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_COHERENT
expr_stmt|;
name|b
operator|->
name|maxsize
operator|=
name|size
expr_stmt|;
name|b
operator|->
name|bufsize
operator|=
name|b
operator|->
name|maxsize
expr_stmt|;
name|b
operator|->
name|buf_addr
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|flags
operator||=
name|SNDBUF_F_MANAGED
expr_stmt|;
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|b
operator|->
name|dmatag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|b
operator|->
name|buf
argument_list|,
name|b
operator|->
name|dmaflags
argument_list|,
operator|&
name|b
operator|->
name|dmamap
argument_list|)
condition|)
block|{
name|sndbuf_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|b
operator|->
name|dmatag
argument_list|,
name|b
operator|->
name|dmamap
argument_list|,
name|b
operator|->
name|buf
argument_list|,
name|b
operator|->
name|maxsize
argument_list|,
name|sndbuf_setmap
argument_list|,
name|b
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
operator|||
name|b
operator|->
name|buf_addr
operator|==
literal|0
condition|)
block|{
name|sndbuf_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|ret
operator|=
name|sndbuf_resize
argument_list|(
name|b
argument_list|,
literal|2
argument_list|,
name|b
operator|->
name|maxsize
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
name|sndbuf_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|sndbuf_setup
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|)
block|{
name|b
operator|->
name|flags
operator|&=
operator|~
name|SNDBUF_F_MANAGED
expr_stmt|;
if|if
condition|(
name|buf
condition|)
name|b
operator|->
name|flags
operator||=
name|SNDBUF_F_MANAGED
expr_stmt|;
name|b
operator|->
name|buf
operator|=
name|buf
expr_stmt|;
name|b
operator|->
name|maxsize
operator|=
name|size
expr_stmt|;
name|b
operator|->
name|bufsize
operator|=
name|b
operator|->
name|maxsize
expr_stmt|;
return|return
name|sndbuf_resize
argument_list|(
name|b
argument_list|,
literal|2
argument_list|,
name|b
operator|->
name|maxsize
operator|/
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_free
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|b
operator|->
name|tmpbuf
condition|)
name|free
argument_list|(
name|b
operator|->
name|tmpbuf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|shadbuf
condition|)
name|free
argument_list|(
name|b
operator|->
name|shadbuf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|buf
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|flags
operator|&
name|SNDBUF_F_MANAGED
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|dmamap
condition|)
name|bus_dmamap_unload
argument_list|(
name|b
operator|->
name|dmatag
argument_list|,
name|b
operator|->
name|dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|dmatag
condition|)
name|bus_dmamem_free
argument_list|(
name|b
operator|->
name|dmatag
argument_list|,
name|b
operator|->
name|buf
argument_list|,
name|b
operator|->
name|dmamap
argument_list|)
expr_stmt|;
block|}
else|else
name|free
argument_list|(
name|b
operator|->
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
name|b
operator|->
name|tmpbuf
operator|=
name|NULL
expr_stmt|;
name|b
operator|->
name|shadbuf
operator|=
name|NULL
expr_stmt|;
name|b
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
name|b
operator|->
name|sl
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|dmatag
operator|=
name|NULL
expr_stmt|;
name|b
operator|->
name|dmamap
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|SNDBUF_CACHE_SHIFT
value|5
end_define

begin_function
name|int
name|sndbuf_resize
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|blkcnt
parameter_list|,
name|unsigned
name|int
name|blksz
parameter_list|)
block|{
name|unsigned
name|int
name|bufsize
decl_stmt|,
name|allocsize
decl_stmt|;
name|u_int8_t
modifier|*
name|tmpbuf
decl_stmt|;
name|CHN_LOCK
argument_list|(
name|b
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|maxsize
operator|==
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|blkcnt
operator|==
literal|0
condition|)
name|blkcnt
operator|=
name|b
operator|->
name|blkcnt
expr_stmt|;
if|if
condition|(
name|blksz
operator|==
literal|0
condition|)
name|blksz
operator|=
name|b
operator|->
name|blksz
expr_stmt|;
if|if
condition|(
name|blkcnt
operator|<
literal|2
operator|||
name|blksz
operator|<
literal|16
operator|||
operator|(
name|blkcnt
operator|*
name|blksz
operator|)
operator|>
name|b
operator|->
name|maxsize
condition|)
block|{
name|CHN_UNLOCK
argument_list|(
name|b
operator|->
name|channel
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|blkcnt
operator|==
name|b
operator|->
name|blkcnt
operator|&&
name|blksz
operator|==
name|b
operator|->
name|blksz
condition|)
goto|goto
name|out
goto|;
name|bufsize
operator|=
name|blkcnt
operator|*
name|blksz
expr_stmt|;
if|if
condition|(
name|bufsize
operator|>
name|b
operator|->
name|allocsize
operator|||
name|bufsize
operator|<
operator|(
name|b
operator|->
name|allocsize
operator|>>
name|SNDBUF_CACHE_SHIFT
operator|)
condition|)
block|{
name|allocsize
operator|=
name|round_page
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
name|CHN_UNLOCK
argument_list|(
name|b
operator|->
name|channel
argument_list|)
expr_stmt|;
name|tmpbuf
operator|=
name|malloc
argument_list|(
name|allocsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|CHN_LOCK
argument_list|(
name|b
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|snd_verbose
operator|>
literal|3
condition|)
name|printf
argument_list|(
literal|"%s(): b=%p %p -> %p [%d -> %d : %d]\n"
argument_list|,
name|__func__
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|tmpbuf
argument_list|,
name|tmpbuf
argument_list|,
name|b
operator|->
name|allocsize
argument_list|,
name|allocsize
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|tmpbuf
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|b
operator|->
name|tmpbuf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|b
operator|->
name|tmpbuf
operator|=
name|tmpbuf
expr_stmt|;
name|b
operator|->
name|allocsize
operator|=
name|allocsize
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|snd_verbose
operator|>
literal|3
condition|)
name|printf
argument_list|(
literal|"%s(): b=%p %d [%d] NOCHANGE\n"
argument_list|,
name|__func__
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|allocsize
argument_list|,
name|b
operator|->
name|bufsize
argument_list|)
expr_stmt|;
name|b
operator|->
name|blkcnt
operator|=
name|blkcnt
expr_stmt|;
name|b
operator|->
name|blksz
operator|=
name|blksz
expr_stmt|;
name|b
operator|->
name|bufsize
operator|=
name|bufsize
expr_stmt|;
name|sndbuf_reset
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|out
label|:
name|CHN_UNLOCK
argument_list|(
name|b
operator|->
name|channel
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sndbuf_remalloc
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|blkcnt
parameter_list|,
name|unsigned
name|int
name|blksz
parameter_list|)
block|{
name|unsigned
name|int
name|bufsize
decl_stmt|,
name|allocsize
decl_stmt|;
name|u_int8_t
modifier|*
name|buf
decl_stmt|,
modifier|*
name|tmpbuf
decl_stmt|,
modifier|*
name|shadbuf
decl_stmt|;
if|if
condition|(
name|blkcnt
operator|<
literal|2
operator|||
name|blksz
operator|<
literal|16
condition|)
return|return
name|EINVAL
return|;
name|bufsize
operator|=
name|blksz
operator|*
name|blkcnt
expr_stmt|;
if|if
condition|(
name|bufsize
operator|>
name|b
operator|->
name|allocsize
operator|||
name|bufsize
operator|<
operator|(
name|b
operator|->
name|allocsize
operator|>>
name|SNDBUF_CACHE_SHIFT
operator|)
condition|)
block|{
name|allocsize
operator|=
name|round_page
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
name|CHN_UNLOCK
argument_list|(
name|b
operator|->
name|channel
argument_list|)
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|allocsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|tmpbuf
operator|=
name|malloc
argument_list|(
name|allocsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|shadbuf
operator|=
name|malloc
argument_list|(
name|allocsize
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|CHN_LOCK
argument_list|(
name|b
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|buf
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|b
operator|->
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|b
operator|->
name|buf
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|tmpbuf
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|b
operator|->
name|tmpbuf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|b
operator|->
name|tmpbuf
operator|=
name|tmpbuf
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|shadbuf
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|b
operator|->
name|shadbuf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|b
operator|->
name|shadbuf
operator|=
name|shadbuf
expr_stmt|;
if|if
condition|(
name|snd_verbose
operator|>
literal|3
condition|)
name|printf
argument_list|(
literal|"%s(): b=%p %d -> %d [%d]\n"
argument_list|,
name|__func__
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|allocsize
argument_list|,
name|allocsize
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
name|b
operator|->
name|allocsize
operator|=
name|allocsize
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|snd_verbose
operator|>
literal|3
condition|)
name|printf
argument_list|(
literal|"%s(): b=%p %d [%d] NOCHANGE\n"
argument_list|,
name|__func__
argument_list|,
name|b
argument_list|,
name|b
operator|->
name|allocsize
argument_list|,
name|b
operator|->
name|bufsize
argument_list|)
expr_stmt|;
name|b
operator|->
name|blkcnt
operator|=
name|blkcnt
expr_stmt|;
name|b
operator|->
name|blksz
operator|=
name|blksz
expr_stmt|;
name|b
operator|->
name|bufsize
operator|=
name|bufsize
expr_stmt|;
name|b
operator|->
name|maxsize
operator|=
name|bufsize
expr_stmt|;
name|b
operator|->
name|sl
operator|=
name|bufsize
expr_stmt|;
name|sndbuf_reset
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Zero out space in buffer free area  *  * This function clears a chunk of @c length bytes in the buffer free area  * (i.e., where the next write will be placed).  *  * @param b		buffer context  * @param length	number of bytes to blank  */
end_comment

begin_function
name|void
name|sndbuf_clear
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_char
name|data
decl_stmt|,
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|length
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|length
operator|>
name|b
operator|->
name|bufsize
condition|)
name|length
operator|=
name|b
operator|->
name|bufsize
expr_stmt|;
name|data
operator|=
name|sndbuf_zerodata
argument_list|(
name|b
operator|->
name|fmt
argument_list|)
expr_stmt|;
name|i
operator|=
name|sndbuf_getfreeptr
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|p
operator|=
name|sndbuf_getbuf
argument_list|(
name|b
argument_list|)
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|p
index|[
name|i
index|]
operator|=
name|data
expr_stmt|;
name|length
operator|--
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|b
operator|->
name|bufsize
condition|)
name|i
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief Zap buffer contents, resetting "ready area" fields  *  * @param b	buffer context  */
end_comment

begin_function
name|void
name|sndbuf_fillsilence
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|b
operator|->
name|bufsize
operator|>
literal|0
condition|)
name|memset
argument_list|(
name|sndbuf_getbuf
argument_list|(
name|b
argument_list|)
argument_list|,
name|sndbuf_zerodata
argument_list|(
name|b
operator|->
name|fmt
argument_list|)
argument_list|,
name|b
operator|->
name|bufsize
argument_list|)
expr_stmt|;
name|b
operator|->
name|rp
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|rl
operator|=
name|b
operator|->
name|bufsize
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sndbuf_fillsilence_rl
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|u_int
name|rl
parameter_list|)
block|{
if|if
condition|(
name|b
operator|->
name|bufsize
operator|>
literal|0
condition|)
name|memset
argument_list|(
name|sndbuf_getbuf
argument_list|(
name|b
argument_list|)
argument_list|,
name|sndbuf_zerodata
argument_list|(
name|b
operator|->
name|fmt
argument_list|)
argument_list|,
name|b
operator|->
name|bufsize
argument_list|)
expr_stmt|;
name|b
operator|->
name|rp
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|rl
operator|=
name|min
argument_list|(
name|b
operator|->
name|bufsize
argument_list|,
name|rl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief Reset buffer w/o flushing statistics  *  * This function just zeroes out buffer contents and sets the "ready length"  * to zero.  This was originally to facilitate minimal playback interruption  * (i.e., dropped samples) in SNDCTL_DSP_SILENCE/SKIP ioctls.  *  * @param b	buffer context  */
end_comment

begin_function
name|void
name|sndbuf_softreset
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|b
operator|->
name|rl
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|buf
operator|&&
name|b
operator|->
name|bufsize
operator|>
literal|0
condition|)
name|sndbuf_clear
argument_list|(
name|b
argument_list|,
name|b
operator|->
name|bufsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sndbuf_reset
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|b
operator|->
name|hp
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|rp
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|rl
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|dl
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|prev_total
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|total
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|xrun
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|buf
operator|&&
name|b
operator|->
name|bufsize
operator|>
literal|0
condition|)
name|sndbuf_clear
argument_list|(
name|b
argument_list|,
name|b
operator|->
name|bufsize
argument_list|)
expr_stmt|;
name|sndbuf_clearshadow
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u_int32_t
name|sndbuf_getfmt
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|fmt
return|;
block|}
end_function

begin_function
name|int
name|sndbuf_setfmt
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|u_int32_t
name|fmt
parameter_list|)
block|{
name|b
operator|->
name|fmt
operator|=
name|fmt
expr_stmt|;
name|b
operator|->
name|bps
operator|=
name|AFMT_BPS
argument_list|(
name|b
operator|->
name|fmt
argument_list|)
expr_stmt|;
name|b
operator|->
name|align
operator|=
name|AFMT_ALIGN
argument_list|(
name|b
operator|->
name|fmt
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|b->bps = AFMT_CHANNEL(b->fmt); 	if (b->fmt& AFMT_16BIT) 		b->bps<<= 1; 	else if (b->fmt& AFMT_24BIT) 		b->bps *= 3; 	else if (b->fmt& AFMT_32BIT) 		b->bps<<= 2;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getspd
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|spd
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_setspd
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|spd
parameter_list|)
block|{
name|b
operator|->
name|spd
operator|=
name|spd
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getalign
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
name|b
operator|->
name|align
operator|)
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getblkcnt
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|blkcnt
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_setblkcnt
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|blkcnt
parameter_list|)
block|{
name|b
operator|->
name|blkcnt
operator|=
name|blkcnt
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getblksz
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|blksz
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_setblksz
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|blksz
parameter_list|)
block|{
name|b
operator|->
name|blksz
operator|=
name|blksz
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getbps
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|bps
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|sndbuf_getbuf
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|buf
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|sndbuf_getbufofs
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|ofs
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|ofs
operator|<
name|b
operator|->
name|bufsize
argument_list|,
operator|(
literal|"%s: ofs invalid %d"
operator|,
name|__func__
operator|,
name|ofs
operator|)
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|buf
operator|+
name|ofs
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getsize
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|bufsize
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getmaxsize
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|maxsize
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getallocsize
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|allocsize
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_runsz
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|dl
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_setrun
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|b
operator|->
name|dl
operator|=
name|go
condition|?
name|b
operator|->
name|blksz
else|:
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|selinfo
modifier|*
name|sndbuf_getsel
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|&
name|b
operator|->
name|sel
return|;
block|}
end_function

begin_comment
comment|/************************************************************/
end_comment

begin_function
name|unsigned
name|int
name|sndbuf_getxrun
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|xrun
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_setxrun
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|xrun
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|->
name|xrun
operator|=
name|xrun
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_gethwptr
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|hp
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_sethwptr
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|unsigned
name|int
name|ptr
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|->
name|hp
operator|=
name|ptr
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getready
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rl
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rl
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rl invalid %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rl
operator|)
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|rl
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getreadyptr
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rp
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rp
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rp invalid %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rp
operator|)
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|rp
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getfree
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rl
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rl
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rl invalid %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rl
operator|)
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|bufsize
operator|-
name|b
operator|->
name|rl
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_getfreeptr
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rp
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rp
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rp invalid %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rp
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rl
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rl
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rl invalid %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rl
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|b
operator|->
name|rp
operator|+
name|b
operator|->
name|rl
operator|)
operator|%
name|b
operator|->
name|bufsize
return|;
block|}
end_function

begin_function
name|u_int64_t
name|sndbuf_getblocks
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|total
operator|/
name|b
operator|->
name|blksz
return|;
block|}
end_function

begin_function
name|u_int64_t
name|sndbuf_getprevblocks
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|prev_total
operator|/
name|b
operator|->
name|blksz
return|;
block|}
end_function

begin_function
name|u_int64_t
name|sndbuf_gettotal
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|total
return|;
block|}
end_function

begin_function
name|u_int64_t
name|sndbuf_getprevtotal
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|b
operator|->
name|prev_total
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_updateprevtotal
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|SNDBUF_LOCKASSERT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|->
name|prev_total
operator|=
name|b
operator|->
name|total
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|int
name|sndbuf_xbytes
parameter_list|(
name|unsigned
name|int
name|v
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|from
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|to
parameter_list|)
block|{
if|if
condition|(
name|from
operator|==
name|NULL
operator|||
name|to
operator|==
name|NULL
operator|||
name|v
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|snd_xbytes
argument_list|(
name|v
argument_list|,
name|sndbuf_getalign
argument_list|(
name|from
argument_list|)
operator|*
name|sndbuf_getspd
argument_list|(
name|from
argument_list|)
argument_list|,
name|sndbuf_getalign
argument_list|(
name|to
argument_list|)
operator|*
name|sndbuf_getspd
argument_list|(
name|to
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|u_int8_t
name|sndbuf_zerodata
parameter_list|(
name|u_int32_t
name|fmt
parameter_list|)
block|{
if|if
condition|(
name|fmt
operator|&
operator|(
name|AFMT_SIGNED
operator||
name|AFMT_PASSTHROUGH
operator|)
condition|)
return|return
operator|(
literal|0x00
operator|)
return|;
elseif|else
if|if
condition|(
name|fmt
operator|&
name|AFMT_MU_LAW
condition|)
return|return
operator|(
literal|0x7f
operator|)
return|;
elseif|else
if|if
condition|(
name|fmt
operator|&
name|AFMT_A_LAW
condition|)
return|return
operator|(
literal|0x55
operator|)
return|;
return|return
operator|(
literal|0x80
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************/
end_comment

begin_comment
comment|/**  * @brief Acquire buffer space to extend ready area  *  * This function extends the ready area length by @c count bytes, and may  * optionally copy samples from another location stored in @c from.  The  * counter @c snd_dbuf::total is also incremented by @c count bytes.  *  * @param b	audio buffer  * @param from	sample source (optional)  * @param count	number of bytes to acquire  *  * @retval 0	Unconditional  */
end_comment

begin_function
name|int
name|sndbuf_acquire
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|u_int8_t
modifier|*
name|from
parameter_list|,
name|unsigned
name|int
name|count
parameter_list|)
block|{
name|int
name|l
decl_stmt|;
name|KASSERT
argument_list|(
name|count
operator|<=
name|sndbuf_getfree
argument_list|(
name|b
argument_list|)
argument_list|,
operator|(
literal|"%s: count %d> free %d"
operator|,
name|__func__
operator|,
name|count
operator|,
name|sndbuf_getfree
argument_list|(
name|b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rl
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rl
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rl invalid %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rl
operator|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|total
operator|+=
name|count
expr_stmt|;
if|if
condition|(
name|from
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|l
operator|=
name|min
argument_list|(
name|count
argument_list|,
name|sndbuf_getsize
argument_list|(
name|b
argument_list|)
operator|-
name|sndbuf_getfreeptr
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|from
argument_list|,
name|sndbuf_getbufofs
argument_list|(
name|b
argument_list|,
name|sndbuf_getfreeptr
argument_list|(
name|b
argument_list|)
argument_list|)
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|from
operator|+=
name|l
expr_stmt|;
name|b
operator|->
name|rl
operator|+=
name|l
expr_stmt|;
name|count
operator|-=
name|l
expr_stmt|;
block|}
block|}
else|else
name|b
operator|->
name|rl
operator|+=
name|count
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rl
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rl
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rl invalid %d, count %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rl
operator|,
name|count
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * @brief Dispose samples from channel buffer, increasing size of ready area  *  * This function discards samples from the supplied buffer by advancing the  * ready area start pointer and decrementing the ready area length.  If   * @c to is not NULL, then the discard samples will be copied to the location  * it points to.  *  * @param b	PCM channel sound buffer  * @param to	destination buffer (optional)  * @param count	number of bytes to discard  *  * @returns 0 unconditionally  */
end_comment

begin_function
name|int
name|sndbuf_dispose
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|u_int8_t
modifier|*
name|to
parameter_list|,
name|unsigned
name|int
name|count
parameter_list|)
block|{
name|int
name|l
decl_stmt|;
name|KASSERT
argument_list|(
name|count
operator|<=
name|sndbuf_getready
argument_list|(
name|b
argument_list|)
argument_list|,
operator|(
literal|"%s: count %d> ready %d"
operator|,
name|__func__
operator|,
name|count
operator|,
name|sndbuf_getready
argument_list|(
name|b
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rl
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rl
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rl invalid %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rl
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|to
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|l
operator|=
name|min
argument_list|(
name|count
argument_list|,
name|sndbuf_getsize
argument_list|(
name|b
argument_list|)
operator|-
name|sndbuf_getreadyptr
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|sndbuf_getbufofs
argument_list|(
name|b
argument_list|,
name|sndbuf_getreadyptr
argument_list|(
name|b
argument_list|)
argument_list|)
argument_list|,
name|to
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|to
operator|+=
name|l
expr_stmt|;
name|b
operator|->
name|rl
operator|-=
name|l
expr_stmt|;
name|b
operator|->
name|rp
operator|=
operator|(
name|b
operator|->
name|rp
operator|+
name|l
operator|)
operator|%
name|b
operator|->
name|bufsize
expr_stmt|;
name|count
operator|-=
name|l
expr_stmt|;
block|}
block|}
else|else
block|{
name|b
operator|->
name|rl
operator|-=
name|count
expr_stmt|;
name|b
operator|->
name|rp
operator|=
operator|(
name|b
operator|->
name|rp
operator|+
name|count
operator|)
operator|%
name|b
operator|->
name|bufsize
expr_stmt|;
block|}
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|rl
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|b
operator|->
name|rl
operator|<=
name|b
operator|->
name|bufsize
operator|)
argument_list|,
operator|(
literal|"%s: b->rl invalid %d, count %d"
operator|,
name|__func__
operator|,
name|b
operator|->
name|rl
operator|,
name|count
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SND_DIAGNOSTIC
end_ifdef

begin_decl_stmt
specifier|static
name|uint32_t
name|snd_feeder_maxfeed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_UINT
argument_list|(
name|_hw_snd
argument_list|,
name|OID_AUTO
argument_list|,
name|feeder_maxfeed
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|snd_feeder_maxfeed
argument_list|,
literal|0
argument_list|,
literal|"maximum feeder count request"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|uint32_t
name|snd_feeder_maxcycle
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_UINT
argument_list|(
name|_hw_snd
argument_list|,
name|OID_AUTO
argument_list|,
name|feeder_maxcycle
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|snd_feeder_maxcycle
argument_list|,
literal|0
argument_list|,
literal|"maximum feeder cycle"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* count is number of bytes we want added to destination buffer */
end_comment

begin_function
name|int
name|sndbuf_feed
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|from
parameter_list|,
name|struct
name|snd_dbuf
modifier|*
name|to
parameter_list|,
name|struct
name|pcm_channel
modifier|*
name|channel
parameter_list|,
name|struct
name|pcm_feeder
modifier|*
name|feeder
parameter_list|,
name|unsigned
name|int
name|count
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|maxfeed
decl_stmt|;
ifdef|#
directive|ifdef
name|SND_DIAGNOSTIC
name|unsigned
name|int
name|cycle
decl_stmt|;
if|if
condition|(
name|count
operator|>
name|snd_feeder_maxfeed
condition|)
name|snd_feeder_maxfeed
operator|=
name|count
expr_stmt|;
name|cycle
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|KASSERT
argument_list|(
name|count
operator|>
literal|0
argument_list|,
operator|(
literal|"can't feed 0 bytes"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sndbuf_getfree
argument_list|(
name|to
argument_list|)
operator|<
name|count
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|maxfeed
operator|=
name|SND_FXROUND
argument_list|(
name|SND_FXDIV_MAX
argument_list|,
name|sndbuf_getalign
argument_list|(
name|to
argument_list|)
argument_list|)
expr_stmt|;
do|do
block|{
name|cnt
operator|=
name|FEEDER_FEED
argument_list|(
name|feeder
argument_list|,
name|channel
argument_list|,
name|to
operator|->
name|tmpbuf
argument_list|,
name|min
argument_list|(
name|count
argument_list|,
name|maxfeed
argument_list|)
argument_list|,
name|from
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|0
condition|)
break|break;
name|sndbuf_acquire
argument_list|(
name|to
argument_list|,
name|to
operator|->
name|tmpbuf
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
name|count
operator|-=
name|cnt
expr_stmt|;
ifdef|#
directive|ifdef
name|SND_DIAGNOSTIC
name|cycle
operator|++
expr_stmt|;
endif|#
directive|endif
block|}
do|while
condition|(
name|count
operator|!=
literal|0
condition|)
do|;
ifdef|#
directive|ifdef
name|SND_DIAGNOSTIC
if|if
condition|(
name|cycle
operator|>
name|snd_feeder_maxcycle
condition|)
name|snd_feeder_maxcycle
operator|=
name|cycle
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/************************************************************/
end_comment

begin_function
name|void
name|sndbuf_dump
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|u_int32_t
name|what
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s: ["
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|what
operator|&
literal|0x01
condition|)
name|printf
argument_list|(
literal|" bufsize: %d, maxsize: %d"
argument_list|,
name|b
operator|->
name|bufsize
argument_list|,
name|b
operator|->
name|maxsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|what
operator|&
literal|0x02
condition|)
name|printf
argument_list|(
literal|" dl: %d, rp: %d, rl: %d, hp: %d"
argument_list|,
name|b
operator|->
name|dl
argument_list|,
name|b
operator|->
name|rp
argument_list|,
name|b
operator|->
name|rl
argument_list|,
name|b
operator|->
name|hp
argument_list|)
expr_stmt|;
if|if
condition|(
name|what
operator|&
literal|0x04
condition|)
name|printf
argument_list|(
literal|" total: %ju, prev_total: %ju, xrun: %d"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|b
operator|->
name|total
argument_list|,
operator|(
name|uintmax_t
operator|)
name|b
operator|->
name|prev_total
argument_list|,
name|b
operator|->
name|xrun
argument_list|)
expr_stmt|;
if|if
condition|(
name|what
operator|&
literal|0x08
condition|)
name|printf
argument_list|(
literal|" fmt: 0x%x, spd: %d"
argument_list|,
name|b
operator|->
name|fmt
argument_list|,
name|b
operator|->
name|spd
argument_list|)
expr_stmt|;
if|if
condition|(
name|what
operator|&
literal|0x10
condition|)
name|printf
argument_list|(
literal|" blksz: %d, blkcnt: %d, flags: 0x%x"
argument_list|,
name|b
operator|->
name|blksz
argument_list|,
name|b
operator|->
name|blkcnt
argument_list|,
name|b
operator|->
name|flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ]\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/************************************************************/
end_comment

begin_function
name|u_int32_t
name|sndbuf_getflags
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
return|return
name|b
operator|->
name|flags
return|;
block|}
end_function

begin_function
name|void
name|sndbuf_setflags
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|u_int32_t
name|flags
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|b
operator|->
name|flags
operator|&=
operator|~
name|flags
expr_stmt|;
if|if
condition|(
name|on
condition|)
name|b
operator|->
name|flags
operator||=
name|flags
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief Clear the shadow buffer by filling with samples equal to zero.  *  * @param b buffer to clear  */
end_comment

begin_function
name|void
name|sndbuf_clearshadow
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|b
operator|!=
name|NULL
argument_list|,
operator|(
literal|"b is a null pointer"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|b
operator|->
name|sl
operator|>=
literal|0
argument_list|,
operator|(
literal|"illegal shadow length"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|b
operator|->
name|shadbuf
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|b
operator|->
name|sl
operator|>
literal|0
operator|)
condition|)
name|memset
argument_list|(
name|b
operator|->
name|shadbuf
argument_list|,
name|sndbuf_zerodata
argument_list|(
name|b
operator|->
name|fmt
argument_list|)
argument_list|,
name|b
operator|->
name|sl
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|OSSV4_EXPERIMENT
end_ifdef

begin_comment
comment|/**  * @brief Return peak value from samples in buffer ready area.  *  * Peak ranges from 0-32767.  If channel is monaural, most significant 16  * bits will be zero.  For now, only expects to work with 1-2 channel  * buffers.  *  * @note  Currently only operates with linear PCM formats.  *  * @param b buffer to analyze  * @param lpeak pointer to store left peak value  * @param rpeak pointer to store right peak value  */
end_comment

begin_function
name|void
name|sndbuf_getpeaks
parameter_list|(
name|struct
name|snd_dbuf
modifier|*
name|b
parameter_list|,
name|int
modifier|*
name|lp
parameter_list|,
name|int
modifier|*
name|rp
parameter_list|)
block|{
name|u_int32_t
name|lpeak
decl_stmt|,
name|rpeak
decl_stmt|;
name|lpeak
operator|=
literal|0
expr_stmt|;
name|rpeak
operator|=
literal|0
expr_stmt|;
comment|/** 	 * @todo fill this in later 	 */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999 Cameron Grant<gandalf@vilnya.demon.co.uk>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/ac97.h>
end_include

begin_struct
struct|struct
name|ac97mixtable_entry
block|{
name|int
name|reg
range|:
literal|8
decl_stmt|;
name|unsigned
name|bits
range|:
literal|4
decl_stmt|;
name|unsigned
name|ofs
range|:
literal|4
decl_stmt|;
name|unsigned
name|stereo
range|:
literal|1
decl_stmt|;
name|unsigned
name|mute
range|:
literal|1
decl_stmt|;
name|unsigned
name|recidx
range|:
literal|4
decl_stmt|;
name|unsigned
name|mask
range|:
literal|1
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ac97_info
block|{
name|device_t
name|dev
decl_stmt|;
name|ac97_init
modifier|*
name|init
decl_stmt|;
name|ac97_read
modifier|*
name|read
decl_stmt|;
name|ac97_write
modifier|*
name|write
decl_stmt|;
name|void
modifier|*
name|devinfo
decl_stmt|;
name|char
name|id
index|[
literal|4
index|]
decl_stmt|;
name|char
name|rev
decl_stmt|;
name|unsigned
name|caps
decl_stmt|,
name|se
decl_stmt|,
name|extcaps
decl_stmt|,
name|extid
decl_stmt|,
name|extstat
decl_stmt|,
name|noext
range|:
literal|1
decl_stmt|;
name|struct
name|ac97mixtable_entry
name|mix
index|[
literal|32
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ac97_codecid
block|{
name|u_int32_t
name|id
decl_stmt|,
name|noext
range|:
literal|1
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|ac97mixtable_entry
name|ac97mixtable_default
index|[
literal|32
index|]
init|=
block|{
index|[
name|SOUND_MIXER_VOLUME
index|]
operator|=
block|{
name|AC97_MIX_MASTER
block|,
literal|5
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|6
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_BASS
index|]
operator|=
block|{
name|AC97_MIX_TONE
block|,
literal|4
block|,
literal|8
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_TREBLE
index|]
operator|=
block|{
name|AC97_MIX_TONE
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
block|,
index|[
name|SOUND_MIXER_PCM
index|]
operator|=
block|{
name|AC97_MIX_PCM
block|,
literal|5
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_SPEAKER
index|]
operator|=
block|{
name|AC97_MIX_BEEP
block|,
literal|4
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_LINE
index|]
operator|=
block|{
name|AC97_MIX_LINE
block|,
literal|5
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|5
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_MIC
index|]
operator|=
block|{
name|AC97_MIX_MIC
block|,
literal|5
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_CD
index|]
operator|=
block|{
name|AC97_MIX_CD
block|,
literal|5
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_LINE1
index|]
operator|=
block|{
name|AC97_MIX_AUX
block|,
literal|5
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|4
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_VIDEO
index|]
operator|=
block|{
name|AC97_MIX_VIDEO
block|,
literal|5
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|3
block|,
literal|0
block|}
block|,
index|[
name|SOUND_MIXER_RECLEV
index|]
operator|=
block|{
operator|-
name|AC97_MIX_RGAIN
block|,
literal|4
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|ac97mixdevs
init|=
name|SOUND_MASK_VOLUME
operator||
name|SOUND_MASK_PCM
operator||
name|SOUND_MASK_SPEAKER
operator||
name|SOUND_MASK_LINE
operator||
name|SOUND_MASK_MIC
operator||
name|SOUND_MASK_CD
operator||
name|SOUND_MASK_LINE1
operator||
name|SOUND_MASK_VIDEO
operator||
name|SOUND_MASK_RECLEV
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|ac97recdevs
init|=
name|SOUND_MASK_VOLUME
operator||
name|SOUND_MASK_LINE
operator||
name|SOUND_MASK_MIC
operator||
name|SOUND_MASK_CD
operator||
name|SOUND_MASK_LINE1
operator||
name|SOUND_MASK_VIDEO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ac97_codecid
name|ac97codecid
index|[]
init|=
block|{
block|{
literal|0x414b4d00
block|,
literal|1
block|,
literal|"Asahi Kasei AK4540 rev 0"
block|}
block|,
block|{
literal|0x43525900
block|,
literal|0
block|,
literal|"Cirrus Logic CS4297"
block|}
block|,
block|{
literal|0x83847600
block|,
literal|0
block|,
literal|"SigmaTel STAC????"
block|}
block|,
block|{
literal|0x83847604
block|,
literal|0
block|,
literal|"SigmaTel STAC9701/3/4/5"
block|}
block|,
block|{
literal|0x83847605
block|,
literal|0
block|,
literal|"SigmaTel STAC9704"
block|}
block|,
block|{
literal|0x83847608
block|,
literal|0
block|,
literal|"SigmaTel STAC9708"
block|}
block|,
block|{
literal|0x83847609
block|,
literal|0
block|,
literal|"SigmaTel STAC9721"
block|}
block|,
block|{
literal|0x414b4d01
block|,
literal|1
block|,
literal|"Asahi Kasei AK4540 rev 1"
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ac97enhancement
index|[]
init|=
block|{
literal|""
block|,
literal|"Analog Devices Phat Stereo"
block|,
literal|"Creative Stereo Enhancement"
block|,
literal|"National Semi 3D Stereo Enhancement"
block|,
literal|"Yamaha Ymersion"
block|,
literal|"BBE 3D Stereo Enhancement"
block|,
literal|"Crystal Semi 3D Stereo Enhancement"
block|,
literal|"Qsound QXpander"
block|,
literal|"Spatializer 3D Stereo Enhancement"
block|,
literal|"SRS 3D Stereo Enhancement"
block|,
literal|"Platform Tech 3D Stereo Enhancement"
block|,
literal|"AKM 3D Audio"
block|,
literal|"Aureal Stereo Enhancement"
block|,
literal|"Aztech 3D Enhancement"
block|,
literal|"Binaura 3D Audio Enhancement"
block|,
literal|"ESS Technology Stereo Enhancement"
block|,
literal|"Harman International VMAx"
block|,
literal|"Nvidea 3D Stereo Enhancement"
block|,
literal|"Philips Incredible Sound"
block|,
literal|"Texas Instruments 3D Stereo Enhancement"
block|,
literal|"VLSI Technology 3D Stereo Enhancement"
block|,
literal|"TriTech 3D Stereo Enhancement"
block|,
literal|"Realtek 3D Stereo Enhancement"
block|,
literal|"Samsung 3D Stereo Enhancement"
block|,
literal|"Wolfson Microelectronics 3D Enhancement"
block|,
literal|"Delta Integration 3D Enhancement"
block|,
literal|"SigmaTel 3D Enhancement"
block|,
literal|"Reserved 27"
block|,
literal|"Rockwell 3D Stereo Enhancement"
block|,
literal|"Reserved 29"
block|,
literal|"Reserved 30"
block|,
literal|"Reserved 31"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ac97feature
index|[]
init|=
block|{
literal|"mic channel"
block|,
literal|"reserved"
block|,
literal|"tone"
block|,
literal|"simulated stereo"
block|,
literal|"headphone"
block|,
literal|"bass boost"
block|,
literal|"18 bit DAC"
block|,
literal|"20 bit DAC"
block|,
literal|"18 bit ADC"
block|,
literal|"20 bit ADC"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ac97extfeature
index|[]
init|=
block|{
literal|"variable rate PCM"
block|,
literal|"double rate PCM"
block|,
literal|"reserved 1"
block|,
literal|"variable rate mic"
block|,
literal|"reserved 2"
block|,
literal|"reserved 3"
block|,
literal|"center DAC"
block|,
literal|"surround DAC"
block|,
literal|"LFE DAC"
block|,
literal|"AMAP"
block|,
literal|"reserved 4"
block|,
literal|"reserved 5"
block|,
literal|"reserved 6"
block|,
literal|"reserved 7"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|u_int16_t
name|rdcd
parameter_list|(
name|struct
name|ac97_info
modifier|*
name|codec
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
return|return
name|codec
operator|->
name|read
argument_list|(
name|codec
operator|->
name|devinfo
argument_list|,
name|reg
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wrcd
parameter_list|(
name|struct
name|ac97_info
modifier|*
name|codec
parameter_list|,
name|int
name|reg
parameter_list|,
name|u_int16_t
name|val
parameter_list|)
block|{
name|codec
operator|->
name|write
argument_list|(
name|codec
operator|->
name|devinfo
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ac97_setrate
parameter_list|(
name|struct
name|ac97_info
modifier|*
name|codec
parameter_list|,
name|int
name|which
parameter_list|,
name|int
name|rate
parameter_list|)
block|{
name|u_int16_t
name|v
decl_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|AC97_REGEXT_FDACRATE
case|:
case|case
name|AC97_REGEXT_SDACRATE
case|:
case|case
name|AC97_REGEXT_LDACRATE
case|:
case|case
name|AC97_REGEXT_LADCRATE
case|:
case|case
name|AC97_REGEXT_MADCRATE
case|:
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|rate
operator|!=
literal|0
condition|)
block|{
name|v
operator|=
name|rate
expr_stmt|;
if|if
condition|(
name|codec
operator|->
name|extstat
operator|&
name|AC97_EXTCAP_DRA
condition|)
name|v
operator|>>=
literal|1
expr_stmt|;
name|wrcd
argument_list|(
name|codec
argument_list|,
name|which
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
name|v
operator|=
name|rdcd
argument_list|(
name|codec
argument_list|,
name|which
argument_list|)
expr_stmt|;
if|if
condition|(
name|codec
operator|->
name|extstat
operator|&
name|AC97_EXTCAP_DRA
condition|)
name|v
operator|<<=
literal|1
expr_stmt|;
return|return
name|v
return|;
block|}
end_function

begin_function
name|int
name|ac97_setextmode
parameter_list|(
name|struct
name|ac97_info
modifier|*
name|codec
parameter_list|,
name|u_int16_t
name|mode
parameter_list|)
block|{
name|mode
operator|&=
name|AC97_EXTCAPS
expr_stmt|;
if|if
condition|(
operator|(
name|mode
operator|&
operator|~
name|codec
operator|->
name|extcaps
operator|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wrcd
argument_list|(
name|codec
argument_list|,
name|AC97_REGEXT_STAT
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|codec
operator|->
name|extstat
operator|=
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_REGEXT_STAT
argument_list|)
operator|&
name|AC97_EXTCAPS
expr_stmt|;
return|return
operator|(
name|mode
operator|==
name|codec
operator|->
name|extstat
operator|)
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ac97_setrecsrc
parameter_list|(
name|struct
name|ac97_info
modifier|*
name|codec
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
name|struct
name|ac97mixtable_entry
modifier|*
name|e
init|=
operator|&
name|codec
operator|->
name|mix
index|[
name|channel
index|]
decl_stmt|;
if|if
condition|(
name|e
operator|->
name|recidx
operator|>
literal|0
condition|)
block|{
name|int
name|val
init|=
name|e
operator|->
name|recidx
operator|-
literal|1
decl_stmt|;
name|val
operator||=
name|val
operator|<<
literal|8
expr_stmt|;
name|wrcd
argument_list|(
name|codec
argument_list|,
name|AC97_REG_RECSEL
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ac97_setmixer
parameter_list|(
name|struct
name|ac97_info
modifier|*
name|codec
parameter_list|,
name|unsigned
name|channel
parameter_list|,
name|unsigned
name|left
parameter_list|,
name|unsigned
name|right
parameter_list|)
block|{
name|struct
name|ac97mixtable_entry
modifier|*
name|e
init|=
operator|&
name|codec
operator|->
name|mix
index|[
name|channel
index|]
decl_stmt|;
if|if
condition|(
name|e
operator|->
name|reg
operator|!=
literal|0
condition|)
block|{
name|int
name|max
decl_stmt|,
name|val
decl_stmt|,
name|reg
init|=
operator|(
name|e
operator|->
name|reg
operator|>=
literal|0
operator|)
condition|?
name|e
operator|->
name|reg
else|:
operator|-
name|e
operator|->
name|reg
decl_stmt|;
if|if
condition|(
operator|!
name|e
operator|->
name|stereo
condition|)
name|right
operator|=
name|left
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|reg
operator|>
literal|0
condition|)
block|{
name|left
operator|=
literal|100
operator|-
name|left
expr_stmt|;
name|right
operator|=
literal|100
operator|-
name|right
expr_stmt|;
block|}
name|max
operator|=
operator|(
literal|1
operator|<<
name|e
operator|->
name|bits
operator|)
operator|-
literal|1
expr_stmt|;
name|left
operator|=
operator|(
name|left
operator|*
name|max
operator|)
operator|/
literal|100
expr_stmt|;
name|right
operator|=
operator|(
name|right
operator|*
name|max
operator|)
operator|/
literal|100
expr_stmt|;
name|val
operator|=
operator|(
name|left
operator|<<
literal|8
operator|)
operator||
name|right
expr_stmt|;
name|left
operator|=
operator|(
name|left
operator|*
literal|100
operator|)
operator|/
name|max
expr_stmt|;
name|right
operator|=
operator|(
name|right
operator|*
literal|100
operator|)
operator|/
name|max
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|reg
operator|>
literal|0
condition|)
block|{
name|left
operator|=
literal|100
operator|-
name|left
expr_stmt|;
name|right
operator|=
literal|100
operator|-
name|right
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|e
operator|->
name|stereo
condition|)
block|{
name|val
operator|&=
name|max
expr_stmt|;
name|val
operator|<<=
name|e
operator|->
name|ofs
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|mask
condition|)
block|{
name|int
name|cur
init|=
name|rdcd
argument_list|(
name|codec
argument_list|,
name|e
operator|->
name|reg
argument_list|)
decl_stmt|;
name|val
operator||=
name|cur
operator|&
operator|~
operator|(
name|max
operator|<<
name|e
operator|->
name|ofs
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|left
operator|==
literal|0
operator|&&
name|right
operator|==
literal|0
operator|&&
name|e
operator|->
name|mute
operator|==
literal|1
condition|)
name|val
operator|=
name|AC97_MUTE
expr_stmt|;
name|wrcd
argument_list|(
name|codec
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|left
operator||
operator|(
name|right
operator|<<
literal|8
operator|)
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static int ac97_getmixer(struct ac97_info *codec, int channel) { 	struct ac97mixtable_entry *e =&codec->mix[channel]; 	if (channel< SOUND_MIXER_NRDEVICES&& e->reg != 0) { 		int max, val, volume;  		max = (1<< e->bits) - 1; 		val = rdcd(code, e->reg); 		if (val == AC97_MUTE&& e->mute == 1) 			volume = 0; 		else { 			if (e->stereo == 0) val>>= e->ofs; 			val&= max; 			volume = (val * 100) / max; 			if (e->reg> 0) volume = 100 - volume; 		} 		return volume; 	} else 		return -1; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|unsigned
name|ac97_initmixer
parameter_list|(
name|struct
name|ac97_info
modifier|*
name|codec
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_int32_t
name|id
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|codec
operator|->
name|mix
index|[
name|i
index|]
operator|=
name|ac97mixtable_default
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|codec
operator|->
name|init
condition|)
name|codec
operator|->
name|init
argument_list|(
name|codec
operator|->
name|devinfo
argument_list|)
expr_stmt|;
name|wrcd
argument_list|(
name|codec
argument_list|,
name|AC97_REG_POWER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wrcd
argument_list|(
name|codec
argument_list|,
name|AC97_REG_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
name|i
operator|=
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_REG_RESET
argument_list|)
expr_stmt|;
name|codec
operator|->
name|caps
operator|=
name|i
operator|&
literal|0x03ff
expr_stmt|;
name|codec
operator|->
name|se
operator|=
operator|(
name|i
operator|&
literal|0x7c00
operator|)
operator|>>
literal|10
expr_stmt|;
name|id
operator|=
operator|(
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_REG_ID1
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_REG_ID2
argument_list|)
expr_stmt|;
name|codec
operator|->
name|rev
operator|=
name|id
operator|&
literal|0x000000ff
expr_stmt|;
if|if
condition|(
name|id
operator|==
literal|0
operator|||
name|id
operator|==
literal|0xffffffff
condition|)
block|{
name|device_printf
argument_list|(
name|codec
operator|->
name|dev
argument_list|,
literal|"ac97 codec invalid or not present (id == %x)\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ac97codecid
index|[
name|i
index|]
operator|.
name|id
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ac97codecid
index|[
name|i
index|]
operator|.
name|id
operator|==
name|id
condition|)
name|codec
operator|->
name|noext
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|codec
operator|->
name|noext
condition|)
block|{
name|i
operator|=
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_REGEXT_ID
argument_list|)
expr_stmt|;
name|codec
operator|->
name|extcaps
operator|=
name|i
operator|&
literal|0x3fff
expr_stmt|;
name|codec
operator|->
name|extid
operator|=
operator|(
name|i
operator|&
literal|0xc000
operator|)
operator|>>
literal|14
expr_stmt|;
name|codec
operator|->
name|extstat
operator|=
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_REGEXT_STAT
argument_list|)
operator|&
name|AC97_EXTCAPS
expr_stmt|;
block|}
else|else
block|{
name|codec
operator|->
name|extcaps
operator|=
literal|0
expr_stmt|;
name|codec
operator|->
name|extid
operator|=
literal|0
expr_stmt|;
name|codec
operator|->
name|extstat
operator|=
literal|0
expr_stmt|;
block|}
name|wrcd
argument_list|(
name|codec
argument_list|,
name|AC97_MIX_MASTER
argument_list|,
literal|0x20
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_MIX_MASTER
argument_list|)
operator|&
literal|0x20
operator|)
operator|==
literal|0x20
condition|)
name|codec
operator|->
name|mix
index|[
name|SOUND_MIXER_VOLUME
index|]
operator|.
name|bits
operator|++
expr_stmt|;
name|wrcd
argument_list|(
name|codec
argument_list|,
name|AC97_MIX_MASTER
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|codec
operator|->
name|dev
argument_list|,
literal|"ac97 codec id 0x%08x"
argument_list|,
name|id
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ac97codecid
index|[
name|i
index|]
operator|.
name|id
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ac97codecid
index|[
name|i
index|]
operator|.
name|id
operator|==
name|id
condition|)
name|printf
argument_list|(
literal|" (%s)"
argument_list|,
name|ac97codecid
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|codec
operator|->
name|dev
argument_list|,
literal|"ac97 codec features "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|codec
operator|->
name|caps
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|j
operator|++
condition|?
literal|", "
else|:
literal|""
argument_list|,
name|ac97feature
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%d bit master volume"
argument_list|,
name|j
operator|++
condition|?
literal|", "
else|:
literal|""
argument_list|,
name|codec
operator|->
name|mix
index|[
name|SOUND_MIXER_VOLUME
index|]
operator|.
name|bits
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s\n"
argument_list|,
name|j
condition|?
literal|", "
else|:
literal|""
argument_list|,
name|ac97enhancement
index|[
name|codec
operator|->
name|se
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|codec
operator|->
name|extcaps
operator|!=
literal|0
operator|||
name|codec
operator|->
name|extid
condition|)
block|{
name|device_printf
argument_list|(
name|codec
operator|->
name|dev
argument_list|,
literal|"ac97 %s codec"
argument_list|,
name|codec
operator|->
name|extid
condition|?
literal|"secondary"
else|:
literal|"primary"
argument_list|)
expr_stmt|;
if|if
condition|(
name|codec
operator|->
name|extcaps
condition|)
name|printf
argument_list|(
literal|" extended features "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|14
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|codec
operator|->
name|extcaps
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|printf
argument_list|(
literal|"%s%s"
argument_list|,
name|j
operator|++
condition|?
literal|", "
else|:
literal|""
argument_list|,
name|ac97extfeature
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|rdcd
argument_list|(
name|codec
argument_list|,
name|AC97_REG_POWER
argument_list|)
operator|&
literal|2
operator|)
operator|==
literal|0
condition|)
name|device_printf
argument_list|(
name|codec
operator|->
name|dev
argument_list|,
literal|"ac97 codec reports dac not ready\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ac97_info
modifier|*
name|ac97_create
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|void
modifier|*
name|devinfo
parameter_list|,
name|ac97_init
modifier|*
name|init
parameter_list|,
name|ac97_read
modifier|*
name|rd
parameter_list|,
name|ac97_write
modifier|*
name|wr
parameter_list|)
block|{
name|struct
name|ac97_info
modifier|*
name|codec
decl_stmt|;
name|codec
operator|=
operator|(
expr|struct
name|ac97_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|codec
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|codec
operator|!=
name|NULL
condition|)
block|{
name|codec
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|codec
operator|->
name|init
operator|=
name|init
expr_stmt|;
name|codec
operator|->
name|read
operator|=
name|rd
expr_stmt|;
name|codec
operator|->
name|write
operator|=
name|wr
expr_stmt|;
name|codec
operator|->
name|devinfo
operator|=
name|devinfo
expr_stmt|;
block|}
return|return
name|codec
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ac97mix_init
parameter_list|(
name|snd_mixer
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|ac97_info
modifier|*
name|codec
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
if|if
condition|(
name|codec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ac97_initmixer
argument_list|(
name|codec
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mix_setdevs
argument_list|(
name|m
argument_list|,
name|ac97mixdevs
operator||
operator|(
operator|(
name|codec
operator|->
name|caps
operator|&
literal|4
operator|)
condition|?
name|SOUND_MASK_BASS
operator||
name|SOUND_MASK_TREBLE
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|mix_setrecdevs
argument_list|(
name|m
argument_list|,
name|ac97recdevs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ac97mix_set
parameter_list|(
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|unsigned
name|dev
parameter_list|,
name|unsigned
name|left
parameter_list|,
name|unsigned
name|right
parameter_list|)
block|{
name|struct
name|ac97_info
modifier|*
name|codec
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
if|if
condition|(
name|codec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ac97_setmixer
argument_list|(
name|codec
argument_list|,
name|dev
argument_list|,
name|left
argument_list|,
name|right
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ac97mix_setrecsrc
parameter_list|(
name|snd_mixer
modifier|*
name|m
parameter_list|,
name|u_int32_t
name|src
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ac97_info
modifier|*
name|codec
init|=
name|mix_getdevinfo
argument_list|(
name|m
argument_list|)
decl_stmt|;
if|if
condition|(
name|codec
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SOUND_MIXER_NRDEVICES
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|src
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|!=
literal|0
condition|)
break|break;
return|return
operator|(
name|ac97_setrecsrc
argument_list|(
name|codec
argument_list|,
name|i
argument_list|)
operator|==
literal|0
operator|)
condition|?
literal|1
operator|<<
name|i
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_decl_stmt
name|snd_mixer
name|ac97_mixer
init|=
block|{
literal|"AC97 mixer"
block|,
name|ac97mix_init
block|,
name|ac97mix_set
block|,
name|ac97mix_setrecsrc
block|, }
decl_stmt|;
end_decl_stmt

end_unit


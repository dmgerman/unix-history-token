begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2005-2009 Ariff Abdullah<ariff@FreeBSD.org>  * Copyright (c) 2001 Cameron Grant<cg@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_KERNEL_OPTION_HEADERS
end_ifdef

begin_include
include|#
directive|include
file|"opt_snd.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/sound/pcm/sound.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/pcm/pcm.h>
end_include

begin_include
include|#
directive|include
file|<dev/sound/version.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_expr_stmt
name|SND_DECLARE_FILE
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|SS_TYPE_MODULE
value|0
end_define

begin_define
define|#
directive|define
name|SS_TYPE_FIRST
value|1
end_define

begin_define
define|#
directive|define
name|SS_TYPE_PCM
value|1
end_define

begin_define
define|#
directive|define
name|SS_TYPE_MIDI
value|2
end_define

begin_define
define|#
directive|define
name|SS_TYPE_SEQUENCER
value|3
end_define

begin_define
define|#
directive|define
name|SS_TYPE_LAST
value|3
end_define

begin_decl_stmt
specifier|static
name|d_open_t
name|sndstat_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_close_t
name|sndstat_close
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|d_read_t
name|sndstat_read
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cdevsw
name|sndstat_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_open
operator|=
name|sndstat_open
block|,
operator|.
name|d_close
operator|=
name|sndstat_close
block|,
operator|.
name|d_read
operator|=
name|sndstat_read
block|,
operator|.
name|d_name
operator|=
literal|"sndstat"
block|,
operator|.
name|d_flags
operator|=
name|D_TRACKCLOSE
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|sndstat_entry
block|{
name|SLIST_ENTRY
argument_list|(
argument|sndstat_entry
argument_list|)
name|link
expr_stmt|;
name|device_t
name|dev
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|sndstat_handler
name|handler
decl_stmt|;
name|int
name|type
decl_stmt|,
name|unit
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|sx
name|sndstat_lock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sbuf
name|sndstat_sbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cdev
modifier|*
name|sndstat_dev
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sndstat_bufptr
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sndstat_maxunit
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sndstat_files
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SNDSTAT_PID
parameter_list|(
name|x
parameter_list|)
value|((pid_t)((intptr_t)((x)->si_drv1)))
end_define

begin_define
define|#
directive|define
name|SNDSTAT_PID_SET
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(x)->si_drv1 = (void *)((intptr_t)(y))
end_define

begin_define
define|#
directive|define
name|SNDSTAT_FLUSH
parameter_list|()
value|do {					\ 	if (sndstat_bufptr != -1) {					\ 		sbuf_delete(&sndstat_sbuf);				\ 		sndstat_bufptr = -1;					\ 	}								\ } while (0)
end_define

begin_expr_stmt
specifier|static
name|SLIST_HEAD
argument_list|(
argument_list|,
argument|sndstat_entry
argument_list|)
name|sndstat_devlist
operator|=
name|SLIST_HEAD_INITIALIZER
argument_list|(
name|sndstat_devlist
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|snd_verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.snd.verbose"
argument_list|,
operator|&
name|snd_verbose
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SND_DEBUG
end_ifdef

begin_function
specifier|static
name|int
name|sysctl_hw_snd_sndstat_pid
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|err
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
name|sndstat_dev
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|int
operator|)
name|SNDSTAT_PID
argument_list|(
name|sndstat_dev
argument_list|)
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
operator|&&
name|req
operator|->
name|newptr
operator|!=
name|NULL
operator|&&
name|val
operator|==
literal|0
condition|)
block|{
name|SNDSTAT_FLUSH
argument_list|()
expr_stmt|;
name|SNDSTAT_PID_SET
argument_list|(
name|sndstat_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|SYSCTL_PROC
argument_list|(
name|_hw_snd
argument_list|,
name|OID_AUTO
argument_list|,
name|sndstat_pid
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|sysctl_hw_snd_sndstat_pid
argument_list|,
literal|"I"
argument_list|,
literal|"sndstat busy pid"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|sndstat_prepare
parameter_list|(
name|struct
name|sbuf
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|sysctl_hw_sndverbose
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|verbose
decl_stmt|;
name|verbose
operator|=
name|snd_verbose
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|verbose
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
operator|&&
name|req
operator|->
name|newptr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|verbose
operator|<
literal|0
operator|||
name|verbose
operator|>
literal|4
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
else|else
name|snd_verbose
operator|=
name|verbose
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_expr_stmt
name|SYSCTL_PROC
argument_list|(
name|_hw_snd
argument_list|,
name|OID_AUTO
argument_list|,
name|verbose
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|sysctl_hw_sndverbose
argument_list|,
literal|"I"
argument_list|,
literal|"verbosity level"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|sndstat_open
parameter_list|(
name|struct
name|cdev
modifier|*
name|i_dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
if|if
condition|(
name|sndstat_dev
operator|==
name|NULL
operator|||
name|i_dev
operator|!=
name|sndstat_dev
condition|)
return|return
name|EBADF
return|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|SNDSTAT_PID
argument_list|(
name|i_dev
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
name|SNDSTAT_PID_SET
argument_list|(
name|i_dev
argument_list|,
name|td
operator|->
name|td_proc
operator|->
name|p_pid
argument_list|)
expr_stmt|;
if|if
condition|(
name|sbuf_new
argument_list|(
operator|&
name|sndstat_sbuf
argument_list|,
name|NULL
argument_list|,
literal|4096
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|SNDSTAT_PID_SET
argument_list|(
name|i_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
name|sndstat_bufptr
operator|=
literal|0
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sndstat_close
parameter_list|(
name|struct
name|cdev
modifier|*
name|i_dev
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|mode
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
if|if
condition|(
name|sndstat_dev
operator|==
name|NULL
operator|||
name|i_dev
operator|!=
name|sndstat_dev
condition|)
return|return
name|EBADF
return|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|SNDSTAT_PID
argument_list|(
name|i_dev
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|EBADF
return|;
block|}
name|SNDSTAT_FLUSH
argument_list|()
expr_stmt|;
name|SNDSTAT_PID_SET
argument_list|(
name|i_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sndstat_read
parameter_list|(
name|struct
name|cdev
modifier|*
name|i_dev
parameter_list|,
name|struct
name|uio
modifier|*
name|buf
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|int
name|l
decl_stmt|,
name|err
decl_stmt|;
if|if
condition|(
name|sndstat_dev
operator|==
name|NULL
operator|||
name|i_dev
operator|!=
name|sndstat_dev
condition|)
return|return
name|EBADF
return|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|SNDSTAT_PID
argument_list|(
name|i_dev
argument_list|)
operator|!=
name|buf
operator|->
name|uio_td
operator|->
name|td_proc
operator|->
name|p_pid
operator|||
name|sndstat_bufptr
operator|==
operator|-
literal|1
condition|)
block|{
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|EBADF
return|;
block|}
if|if
condition|(
name|sndstat_bufptr
operator|==
literal|0
condition|)
block|{
name|err
operator|=
operator|(
name|sndstat_prepare
argument_list|(
operator|&
name|sndstat_sbuf
argument_list|)
operator|>
literal|0
operator|)
condition|?
literal|0
else|:
name|ENOMEM
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|SNDSTAT_FLUSH
argument_list|()
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
block|}
name|l
operator|=
name|min
argument_list|(
name|buf
operator|->
name|uio_resid
argument_list|,
name|sbuf_len
argument_list|(
operator|&
name|sndstat_sbuf
argument_list|)
operator|-
name|sndstat_bufptr
argument_list|)
expr_stmt|;
name|err
operator|=
operator|(
name|l
operator|>
literal|0
operator|)
condition|?
name|uiomove
argument_list|(
name|sbuf_data
argument_list|(
operator|&
name|sndstat_sbuf
argument_list|)
operator|+
name|sndstat_bufptr
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
else|:
literal|0
expr_stmt|;
name|sndstat_bufptr
operator|+=
name|l
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/************************************************************************/
end_comment

begin_function
specifier|static
name|struct
name|sndstat_entry
modifier|*
name|sndstat_find
parameter_list|(
name|int
name|type
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|struct
name|sndstat_entry
modifier|*
name|ent
decl_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|ent
argument_list|,
argument|&sndstat_devlist
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|ent
operator|->
name|type
operator|==
name|type
operator|&&
name|ent
operator|->
name|unit
operator|==
name|unit
condition|)
return|return
name|ent
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|sndstat_acquire
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
if|if
condition|(
name|sndstat_dev
operator|==
name|NULL
condition|)
return|return
name|EBADF
return|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|SNDSTAT_PID
argument_list|(
name|sndstat_dev
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
name|SNDSTAT_PID_SET
argument_list|(
name|sndstat_dev
argument_list|,
name|td
operator|->
name|td_proc
operator|->
name|p_pid
argument_list|)
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sndstat_release
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
if|if
condition|(
name|sndstat_dev
operator|==
name|NULL
condition|)
return|return
name|EBADF
return|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|SNDSTAT_PID
argument_list|(
name|sndstat_dev
argument_list|)
operator|!=
name|td
operator|->
name|td_proc
operator|->
name|p_pid
condition|)
block|{
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|EBADF
return|;
block|}
name|SNDSTAT_PID_SET
argument_list|(
name|sndstat_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sndstat_register
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|sndstat_handler
name|handler
parameter_list|)
block|{
name|struct
name|sndstat_entry
modifier|*
name|ent
decl_stmt|;
specifier|const
name|char
modifier|*
name|devtype
decl_stmt|;
name|int
name|type
decl_stmt|,
name|unit
decl_stmt|;
if|if
condition|(
name|dev
condition|)
block|{
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|devtype
operator|=
name|device_get_name
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|devtype
argument_list|,
literal|"pcm"
argument_list|)
condition|)
name|type
operator|=
name|SS_TYPE_PCM
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|devtype
argument_list|,
literal|"midi"
argument_list|)
condition|)
name|type
operator|=
name|SS_TYPE_MIDI
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|devtype
argument_list|,
literal|"sequencer"
argument_list|)
condition|)
name|type
operator|=
name|SS_TYPE_SEQUENCER
expr_stmt|;
else|else
return|return
name|EINVAL
return|;
block|}
else|else
block|{
name|type
operator|=
name|SS_TYPE_MODULE
expr_stmt|;
name|unit
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|ent
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|ent
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ent
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|ent
operator|->
name|str
operator|=
name|str
expr_stmt|;
name|ent
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|ent
operator|->
name|unit
operator|=
name|unit
expr_stmt|;
name|ent
operator|->
name|handler
operator|=
name|handler
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
name|SLIST_INSERT_HEAD
argument_list|(
operator|&
name|sndstat_devlist
argument_list|,
name|ent
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|SS_TYPE_MODULE
condition|)
name|sndstat_files
operator|++
expr_stmt|;
name|sndstat_maxunit
operator|=
operator|(
name|unit
operator|>
name|sndstat_maxunit
operator|)
condition|?
name|unit
else|:
name|sndstat_maxunit
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sndstat_registerfile
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
return|return
name|sndstat_register
argument_list|(
name|NULL
argument_list|,
name|str
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sndstat_unregister
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sndstat_entry
modifier|*
name|ent
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|ent
argument_list|,
argument|&sndstat_devlist
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|ent
operator|->
name|dev
operator|==
name|dev
condition|)
block|{
name|SLIST_REMOVE
argument_list|(
operator|&
name|sndstat_devlist
argument_list|,
name|ent
argument_list|,
name|sndstat_entry
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ent
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_function
name|int
name|sndstat_unregisterfile
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|struct
name|sndstat_entry
modifier|*
name|ent
decl_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|ent
argument_list|,
argument|&sndstat_devlist
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|ent
operator|->
name|dev
operator|==
name|NULL
operator|&&
name|ent
operator|->
name|str
operator|==
name|str
condition|)
block|{
name|SLIST_REMOVE
argument_list|(
operator|&
name|sndstat_devlist
argument_list|,
name|ent
argument_list|,
name|sndstat_entry
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|sndstat_files
operator|--
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ent
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_comment
comment|/************************************************************************/
end_comment

begin_function
specifier|static
name|int
name|sndstat_prepare
parameter_list|(
name|struct
name|sbuf
modifier|*
name|s
parameter_list|)
block|{
name|struct
name|sndstat_entry
modifier|*
name|ent
decl_stmt|;
name|struct
name|snddev_info
modifier|*
name|d
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|snd_verbose
operator|>
literal|0
condition|)
block|{
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"FreeBSD Audio Driver (%ubit %d/%s)\n"
argument_list|,
operator|(
name|u_int
operator|)
sizeof|sizeof
argument_list|(
name|intpcm32_t
argument_list|)
operator|<<
literal|3
argument_list|,
name|SND_DRV_VERSION
argument_list|,
name|MACHINE_ARCH
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SLIST_EMPTY
argument_list|(
operator|&
name|sndstat_devlist
argument_list|)
condition|)
block|{
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"No devices installed.\n"
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|sbuf_len
argument_list|(
name|s
argument_list|)
return|;
block|}
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"Installed devices:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|sndstat_maxunit
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
name|SS_TYPE_FIRST
init|;
name|j
operator|<=
name|SS_TYPE_LAST
condition|;
name|j
operator|++
control|)
block|{
name|ent
operator|=
name|sndstat_find
argument_list|(
name|j
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ent
condition|)
continue|continue;
name|d
operator|=
name|device_get_softc
argument_list|(
name|ent
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|PCM_REGISTERED
argument_list|(
name|d
argument_list|)
condition|)
continue|continue;
comment|/* XXX Need Giant magic entry ??? */
name|PCM_ACQUIRE_QUICK
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"%s:"
argument_list|,
name|device_get_nameunit
argument_list|(
name|ent
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"<%s>"
argument_list|,
name|device_get_desc
argument_list|(
name|ent
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|snd_verbose
operator|>
literal|0
condition|)
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|" %s"
argument_list|,
name|ent
operator|->
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|handler
condition|)
name|ent
operator|->
name|handler
argument_list|(
name|s
argument_list|,
name|ent
operator|->
name|dev
argument_list|,
name|snd_verbose
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|PCM_RELEASE_QUICK
argument_list|(
name|d
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|snd_verbose
operator|>=
literal|3
operator|&&
name|sndstat_files
operator|>
literal|0
condition|)
block|{
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"\nFile Versions:\n"
argument_list|)
expr_stmt|;
name|SLIST_FOREACH
argument_list|(
argument|ent
argument_list|,
argument|&sndstat_devlist
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|ent
operator|->
name|dev
operator|==
name|NULL
operator|&&
name|ent
operator|->
name|str
operator|!=
name|NULL
condition|)
name|sbuf_printf
argument_list|(
name|s
argument_list|,
literal|"%s\n"
argument_list|,
name|ent
operator|->
name|str
argument_list|)
expr_stmt|;
block|}
block|}
name|sbuf_finish
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|sbuf_len
argument_list|(
name|s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sndstat_init
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|sndstat_dev
operator|!=
name|NULL
condition|)
return|return
name|EINVAL
return|;
name|sx_init
argument_list|(
operator|&
name|sndstat_lock
argument_list|,
literal|"sndstat lock"
argument_list|)
expr_stmt|;
name|sndstat_dev
operator|=
name|make_dev
argument_list|(
operator|&
name|sndstat_cdevsw
argument_list|,
name|SND_DEV_STATUS
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0444
argument_list|,
literal|"sndstat"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sndstat_uninit
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|sndstat_dev
operator|==
name|NULL
condition|)
return|return
name|EINVAL
return|;
name|sx_xlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|SNDSTAT_PID
argument_list|(
name|sndstat_dev
argument_list|)
operator|!=
name|curthread
operator|->
name|td_proc
operator|->
name|p_pid
condition|)
block|{
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
comment|/* XXXPHO: use destroy_dev_sched() */
name|destroy_dev
argument_list|(
name|sndstat_dev
argument_list|)
expr_stmt|;
name|sndstat_dev
operator|=
name|NULL
expr_stmt|;
name|SNDSTAT_FLUSH
argument_list|()
expr_stmt|;
name|sx_unlock
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|sndstat_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sndstat_sysinit
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|sndstat_init
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sndstat_sysuninit
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|sndstat_uninit
argument_list|()
expr_stmt|;
name|KASSERT
argument_list|(
name|error
operator|==
literal|0
argument_list|,
operator|(
literal|"%s: error = %d"
operator|,
name|__func__
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|SYSINIT
argument_list|(
name|sndstat_sysinit
argument_list|,
name|SI_SUB_DRIVERS
argument_list|,
name|SI_ORDER_FIRST
argument_list|,
name|sndstat_sysinit
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSUNINIT
argument_list|(
name|sndstat_sysuninit
argument_list|,
name|SI_SUB_DRIVERS
argument_list|,
name|SI_ORDER_FIRST
argument_list|,
name|sndstat_sysuninit
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


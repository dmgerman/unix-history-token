begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013-2015, Mellanox Technologies, Ltd.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/pci.h>
end_include

begin_include
include|#
directive|include
file|<linux/dma-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|<linux/random.h>
end_include

begin_include
include|#
directive|include
file|<linux/io-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/hardirq.h>
end_include

begin_include
include|#
directive|include
file|<linux/ktime.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/driver.h>
end_include

begin_include
include|#
directive|include
file|"mlx5_core.h"
end_include

begin_function_decl
specifier|static
name|int
name|mlx5_copy_from_msg
parameter_list|(
name|void
modifier|*
name|to
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|from
parameter_list|,
name|int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mlx5_free_cmd_msg
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|free_msg
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
parameter_list|)
function_decl|;
end_function_decl

begin_enum
enum|enum
block|{
name|CMD_IF_REV
init|=
literal|5
block|, }
enum|;
end_enum

begin_enum
enum|enum
block|{
name|CMD_MODE_POLLING
block|,
name|CMD_MODE_EVENTS
block|}
enum|;
end_enum

begin_enum
enum|enum
block|{
name|NUM_LONG_LISTS
init|=
literal|2
block|,
name|NUM_MED_LISTS
init|=
literal|64
block|,
name|LONG_LIST_SIZE
init|=
operator|(
literal|2ULL
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|1024
operator|/
name|PAGE_SIZE
operator|)
operator|*
literal|8
operator|+
literal|16
operator|+
name|MLX5_CMD_DATA_BLOCK_SIZE
block|,
name|MED_LIST_SIZE
init|=
literal|16
operator|+
name|MLX5_CMD_DATA_BLOCK_SIZE
block|, }
enum|;
end_enum

begin_enum
enum|enum
block|{
name|MLX5_CMD_DELIVERY_STAT_OK
init|=
literal|0x0
block|,
name|MLX5_CMD_DELIVERY_STAT_SIGNAT_ERR
init|=
literal|0x1
block|,
name|MLX5_CMD_DELIVERY_STAT_TOK_ERR
init|=
literal|0x2
block|,
name|MLX5_CMD_DELIVERY_STAT_BAD_BLK_NUM_ERR
init|=
literal|0x3
block|,
name|MLX5_CMD_DELIVERY_STAT_OUT_PTR_ALIGN_ERR
init|=
literal|0x4
block|,
name|MLX5_CMD_DELIVERY_STAT_IN_PTR_ALIGN_ERR
init|=
literal|0x5
block|,
name|MLX5_CMD_DELIVERY_STAT_FW_ERR
init|=
literal|0x6
block|,
name|MLX5_CMD_DELIVERY_STAT_IN_LENGTH_ERR
init|=
literal|0x7
block|,
name|MLX5_CMD_DELIVERY_STAT_OUT_LENGTH_ERR
init|=
literal|0x8
block|,
name|MLX5_CMD_DELIVERY_STAT_RES_FLD_NOT_CLR_ERR
init|=
literal|0x9
block|,
name|MLX5_CMD_DELIVERY_STAT_CMD_DESCR_ERR
init|=
literal|0x10
block|, }
enum|;
end_enum

begin_function
specifier|static
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|alloc_cmd
parameter_list|(
name|struct
name|mlx5_cmd
modifier|*
name|cmd
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|in
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|out
parameter_list|,
name|void
modifier|*
name|uout
parameter_list|,
name|int
name|uout_size
parameter_list|,
name|mlx5_cmd_cbk_t
name|cbk
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|int
name|page_queue
parameter_list|)
block|{
name|gfp_t
name|alloc_flags
init|=
name|cbk
condition|?
name|GFP_ATOMIC
else|:
name|GFP_KERNEL
decl_stmt|;
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
decl_stmt|;
name|ent
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ent
argument_list|)
argument_list|,
name|alloc_flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ent
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|ent
operator|->
name|in
operator|=
name|in
expr_stmt|;
name|ent
operator|->
name|out
operator|=
name|out
expr_stmt|;
name|ent
operator|->
name|uout
operator|=
name|uout
expr_stmt|;
name|ent
operator|->
name|uout_size
operator|=
name|uout_size
expr_stmt|;
name|ent
operator|->
name|callback
operator|=
name|cbk
expr_stmt|;
name|ent
operator|->
name|context
operator|=
name|context
expr_stmt|;
name|ent
operator|->
name|cmd
operator|=
name|cmd
expr_stmt|;
name|ent
operator|->
name|page_queue
operator|=
name|page_queue
expr_stmt|;
return|return
name|ent
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|alloc_token
parameter_list|(
name|struct
name|mlx5_cmd
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|token
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|cmd
operator|->
name|token_lock
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|token
operator|++
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|token
operator|==
literal|0
condition|)
name|cmd
operator|->
name|token
operator|++
expr_stmt|;
name|token
operator|=
name|cmd
operator|->
name|token
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|cmd
operator|->
name|token_lock
argument_list|)
expr_stmt|;
return|return
name|token
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_ent
parameter_list|(
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
name|ent
operator|->
name|cmd
decl_stmt|;
name|int
name|ret
init|=
name|cmd
operator|->
name|max_reg_cmds
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cmd
operator|->
name|alloc_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ent
operator|->
name|page_queue
condition|)
block|{
name|ret
operator|=
name|find_first_bit
argument_list|(
operator|&
name|cmd
operator|->
name|bitmask
argument_list|,
name|cmd
operator|->
name|max_reg_cmds
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
name|cmd
operator|->
name|max_reg_cmds
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
operator|-
literal|1
condition|)
block|{
name|ent
operator|->
name|idx
operator|=
name|ret
expr_stmt|;
name|clear_bit
argument_list|(
name|ent
operator|->
name|idx
argument_list|,
operator|&
name|cmd
operator|->
name|bitmask
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|ent_arr
index|[
name|ent
operator|->
name|idx
index|]
operator|=
name|ent
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cmd
operator|->
name|alloc_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_ent
parameter_list|(
name|struct
name|mlx5_cmd
modifier|*
name|cmd
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|cmd
operator|->
name|alloc_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|idx
argument_list|,
operator|&
name|cmd
operator|->
name|bitmask
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|cmd
operator|->
name|alloc_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_cmd_layout
modifier|*
name|get_inst
parameter_list|(
name|struct
name|mlx5_cmd
modifier|*
name|cmd
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
return|return
name|cmd
operator|->
name|cmd_buf
operator|+
operator|(
name|idx
operator|<<
name|cmd
operator|->
name|log_stride
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|xor8_buf
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|u8
modifier|*
name|ptr
init|=
name|buf
decl_stmt|;
name|u8
name|sum
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|sum
operator|^=
name|ptr
index|[
name|i
index|]
expr_stmt|;
return|return
name|sum
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|verify_block_sig
parameter_list|(
name|struct
name|mlx5_cmd_prot_block
modifier|*
name|block
parameter_list|)
block|{
if|if
condition|(
name|xor8_buf
argument_list|(
name|block
operator|->
name|rsvd0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|block
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|block
operator|->
name|data
argument_list|)
operator|-
literal|1
argument_list|)
operator|!=
literal|0xff
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|xor8_buf
argument_list|(
name|block
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|block
argument_list|)
argument_list|)
operator|!=
literal|0xff
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|calc_block_sig
parameter_list|(
name|struct
name|mlx5_cmd_prot_block
modifier|*
name|block
parameter_list|,
name|u8
name|token
parameter_list|,
name|int
name|csum
parameter_list|)
block|{
name|block
operator|->
name|token
operator|=
name|token
expr_stmt|;
if|if
condition|(
name|csum
condition|)
block|{
name|block
operator|->
name|ctrl_sig
operator|=
operator|~
name|xor8_buf
argument_list|(
name|block
operator|->
name|rsvd0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|block
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|block
operator|->
name|data
argument_list|)
operator|-
literal|2
argument_list|)
expr_stmt|;
name|block
operator|->
name|sig
operator|=
operator|~
name|xor8_buf
argument_list|(
name|block
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|block
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|calc_chain_sig
parameter_list|(
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
parameter_list|,
name|u8
name|token
parameter_list|,
name|int
name|csum
parameter_list|)
block|{
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|next
init|=
name|msg
operator|->
name|next
decl_stmt|;
while|while
condition|(
name|next
condition|)
block|{
name|calc_block_sig
argument_list|(
name|next
operator|->
name|buf
argument_list|,
name|token
argument_list|,
name|csum
argument_list|)
expr_stmt|;
name|next
operator|=
name|next
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_signature
parameter_list|(
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|,
name|int
name|csum
parameter_list|)
block|{
name|ent
operator|->
name|lay
operator|->
name|sig
operator|=
operator|~
name|xor8_buf
argument_list|(
name|ent
operator|->
name|lay
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ent
operator|->
name|lay
argument_list|)
argument_list|)
expr_stmt|;
name|calc_chain_sig
argument_list|(
name|ent
operator|->
name|in
argument_list|,
name|ent
operator|->
name|token
argument_list|,
name|csum
argument_list|)
expr_stmt|;
name|calc_chain_sig
argument_list|(
name|ent
operator|->
name|out
argument_list|,
name|ent
operator|->
name|token
argument_list|,
name|csum
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|poll_timeout
parameter_list|(
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|)
block|{
name|int
name|poll_end
init|=
name|jiffies
operator|+
name|msecs_to_jiffies
argument_list|(
name|MLX5_CMD_TIMEOUT_MSEC
operator|+
literal|1000
argument_list|)
decl_stmt|;
name|u8
name|own
decl_stmt|;
do|do
block|{
name|own
operator|=
name|ent
operator|->
name|lay
operator|->
name|status_own
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|own
operator|&
name|CMD_OWNER_HW
operator|)
condition|)
block|{
name|ent
operator|->
name|ret
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|usleep_range
argument_list|(
literal|5000
argument_list|,
literal|10000
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|time_before
argument_list|(
name|jiffies
argument_list|,
name|poll_end
argument_list|)
condition|)
do|;
name|ent
operator|->
name|ret
operator|=
operator|-
name|ETIMEDOUT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_cmd
parameter_list|(
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|)
block|{
name|kfree
argument_list|(
name|ent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|verify_signature
parameter_list|(
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|)
block|{
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|next
init|=
name|ent
operator|->
name|out
operator|->
name|next
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u8
name|sig
decl_stmt|;
name|sig
operator|=
name|xor8_buf
argument_list|(
name|ent
operator|->
name|lay
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ent
operator|->
name|lay
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig
operator|!=
literal|0xff
condition|)
return|return
operator|-
name|EINVAL
return|;
while|while
condition|(
name|next
condition|)
block|{
name|err
operator|=
name|verify_block_sig
argument_list|(
name|next
operator|->
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|next
operator|=
name|next
operator|->
name|next
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_buf
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|data_only
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
name|__be32
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|+=
literal|16
control|)
block|{
name|pr_debug
argument_list|(
literal|"%03x: %08x %08x %08x %08x\n"
argument_list|,
name|offset
argument_list|,
name|be32_to_cpu
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|be32_to_cpu
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
argument_list|,
name|be32_to_cpu
argument_list|(
name|p
index|[
literal|2
index|]
argument_list|)
argument_list|,
name|be32_to_cpu
argument_list|(
name|p
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|4
expr_stmt|;
name|offset
operator|+=
literal|16
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|data_only
condition|)
name|pr_debug
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|mlx5_command_str
parameter_list|(
name|int
name|command
parameter_list|)
block|{
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|MLX5_CMD_OP_QUERY_HCA_CAP
case|:
return|return
literal|"QUERY_HCA_CAP"
return|;
case|case
name|MLX5_CMD_OP_SET_HCA_CAP
case|:
return|return
literal|"SET_HCA_CAP"
return|;
case|case
name|MLX5_CMD_OP_QUERY_ADAPTER
case|:
return|return
literal|"QUERY_ADAPTER"
return|;
case|case
name|MLX5_CMD_OP_INIT_HCA
case|:
return|return
literal|"INIT_HCA"
return|;
case|case
name|MLX5_CMD_OP_TEARDOWN_HCA
case|:
return|return
literal|"TEARDOWN_HCA"
return|;
case|case
name|MLX5_CMD_OP_ENABLE_HCA
case|:
return|return
literal|"MLX5_CMD_OP_ENABLE_HCA"
return|;
case|case
name|MLX5_CMD_OP_DISABLE_HCA
case|:
return|return
literal|"MLX5_CMD_OP_DISABLE_HCA"
return|;
case|case
name|MLX5_CMD_OP_QUERY_PAGES
case|:
return|return
literal|"QUERY_PAGES"
return|;
case|case
name|MLX5_CMD_OP_MANAGE_PAGES
case|:
return|return
literal|"MANAGE_PAGES"
return|;
case|case
name|MLX5_CMD_OP_QUERY_ISSI
case|:
return|return
literal|"QUERY_ISSI"
return|;
case|case
name|MLX5_CMD_OP_SET_ISSI
case|:
return|return
literal|"SET_ISSI"
return|;
case|case
name|MLX5_CMD_OP_CREATE_MKEY
case|:
return|return
literal|"CREATE_MKEY"
return|;
case|case
name|MLX5_CMD_OP_QUERY_MKEY
case|:
return|return
literal|"QUERY_MKEY"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_MKEY
case|:
return|return
literal|"DESTROY_MKEY"
return|;
case|case
name|MLX5_CMD_OP_QUERY_SPECIAL_CONTEXTS
case|:
return|return
literal|"QUERY_SPECIAL_CONTEXTS"
return|;
case|case
name|MLX5_CMD_OP_PAGE_FAULT_RESUME
case|:
return|return
literal|"PAGE_FAULT_RESUME"
return|;
case|case
name|MLX5_CMD_OP_CREATE_EQ
case|:
return|return
literal|"CREATE_EQ"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_EQ
case|:
return|return
literal|"DESTROY_EQ"
return|;
case|case
name|MLX5_CMD_OP_QUERY_EQ
case|:
return|return
literal|"QUERY_EQ"
return|;
case|case
name|MLX5_CMD_OP_GEN_EQE
case|:
return|return
literal|"GEN_EQE"
return|;
case|case
name|MLX5_CMD_OP_CREATE_CQ
case|:
return|return
literal|"CREATE_CQ"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_CQ
case|:
return|return
literal|"DESTROY_CQ"
return|;
case|case
name|MLX5_CMD_OP_QUERY_CQ
case|:
return|return
literal|"QUERY_CQ"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_CQ
case|:
return|return
literal|"MODIFY_CQ"
return|;
case|case
name|MLX5_CMD_OP_CREATE_QP
case|:
return|return
literal|"CREATE_QP"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_QP
case|:
return|return
literal|"DESTROY_QP"
return|;
case|case
name|MLX5_CMD_OP_RST2INIT_QP
case|:
return|return
literal|"RST2INIT_QP"
return|;
case|case
name|MLX5_CMD_OP_INIT2RTR_QP
case|:
return|return
literal|"INIT2RTR_QP"
return|;
case|case
name|MLX5_CMD_OP_RTR2RTS_QP
case|:
return|return
literal|"RTR2RTS_QP"
return|;
case|case
name|MLX5_CMD_OP_RTS2RTS_QP
case|:
return|return
literal|"RTS2RTS_QP"
return|;
case|case
name|MLX5_CMD_OP_SQERR2RTS_QP
case|:
return|return
literal|"SQERR2RTS_QP"
return|;
case|case
name|MLX5_CMD_OP_2ERR_QP
case|:
return|return
literal|"2ERR_QP"
return|;
case|case
name|MLX5_CMD_OP_2RST_QP
case|:
return|return
literal|"2RST_QP"
return|;
case|case
name|MLX5_CMD_OP_QUERY_QP
case|:
return|return
literal|"QUERY_QP"
return|;
case|case
name|MLX5_CMD_OP_SQD_RTS_QP
case|:
return|return
literal|"SQD_RTS_QP"
return|;
case|case
name|MLX5_CMD_OP_MAD_IFC
case|:
return|return
literal|"MAD_IFC"
return|;
case|case
name|MLX5_CMD_OP_INIT2INIT_QP
case|:
return|return
literal|"INIT2INIT_QP"
return|;
case|case
name|MLX5_CMD_OP_CREATE_PSV
case|:
return|return
literal|"CREATE_PSV"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_PSV
case|:
return|return
literal|"DESTROY_PSV"
return|;
case|case
name|MLX5_CMD_OP_CREATE_SRQ
case|:
return|return
literal|"CREATE_SRQ"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_SRQ
case|:
return|return
literal|"DESTROY_SRQ"
return|;
case|case
name|MLX5_CMD_OP_QUERY_SRQ
case|:
return|return
literal|"QUERY_SRQ"
return|;
case|case
name|MLX5_CMD_OP_ARM_RQ
case|:
return|return
literal|"ARM_RQ"
return|;
case|case
name|MLX5_CMD_OP_CREATE_XRC_SRQ
case|:
return|return
literal|"CREATE_XRC_SRQ"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_XRC_SRQ
case|:
return|return
literal|"DESTROY_XRC_SRQ"
return|;
case|case
name|MLX5_CMD_OP_QUERY_XRC_SRQ
case|:
return|return
literal|"QUERY_XRC_SRQ"
return|;
case|case
name|MLX5_CMD_OP_ARM_XRC_SRQ
case|:
return|return
literal|"ARM_XRC_SRQ"
return|;
case|case
name|MLX5_CMD_OP_CREATE_DCT
case|:
return|return
literal|"CREATE_DCT"
return|;
case|case
name|MLX5_CMD_OP_SET_DC_CNAK_TRACE
case|:
return|return
literal|"SET_DC_CNAK_TRACE"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_DCT
case|:
return|return
literal|"DESTROY_DCT"
return|;
case|case
name|MLX5_CMD_OP_DRAIN_DCT
case|:
return|return
literal|"DRAIN_DCT"
return|;
case|case
name|MLX5_CMD_OP_QUERY_DCT
case|:
return|return
literal|"QUERY_DCT"
return|;
case|case
name|MLX5_CMD_OP_ARM_DCT_FOR_KEY_VIOLATION
case|:
return|return
literal|"ARM_DCT_FOR_KEY_VIOLATION"
return|;
case|case
name|MLX5_CMD_OP_QUERY_VPORT_STATE
case|:
return|return
literal|"QUERY_VPORT_STATE"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_VPORT_STATE
case|:
return|return
literal|"MODIFY_VPORT_STATE"
return|;
case|case
name|MLX5_CMD_OP_QUERY_ESW_VPORT_CONTEXT
case|:
return|return
literal|"QUERY_ESW_VPORT_CONTEXT"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_ESW_VPORT_CONTEXT
case|:
return|return
literal|"MODIFY_ESW_VPORT_CONTEXT"
return|;
case|case
name|MLX5_CMD_OP_QUERY_NIC_VPORT_CONTEXT
case|:
return|return
literal|"QUERY_NIC_VPORT_CONTEXT"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_NIC_VPORT_CONTEXT
case|:
return|return
literal|"MODIFY_NIC_VPORT_CONTEXT"
return|;
case|case
name|MLX5_CMD_OP_QUERY_ROCE_ADDRESS
case|:
return|return
literal|"QUERY_ROCE_ADDRESS"
return|;
case|case
name|MLX5_CMD_OP_SET_ROCE_ADDRESS
case|:
return|return
literal|"SET_ROCE_ADDRESS"
return|;
case|case
name|MLX5_CMD_OP_QUERY_HCA_VPORT_CONTEXT
case|:
return|return
literal|"QUERY_HCA_VPORT_CONTEXT"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_HCA_VPORT_CONTEXT
case|:
return|return
literal|"MODIFY_HCA_VPORT_CONTEXT"
return|;
case|case
name|MLX5_CMD_OP_QUERY_HCA_VPORT_GID
case|:
return|return
literal|"QUERY_HCA_VPORT_GID"
return|;
case|case
name|MLX5_CMD_OP_QUERY_HCA_VPORT_PKEY
case|:
return|return
literal|"QUERY_HCA_VPORT_PKEY"
return|;
case|case
name|MLX5_CMD_OP_QUERY_VPORT_COUNTER
case|:
return|return
literal|"QUERY_VPORT_COUNTER"
return|;
case|case
name|MLX5_CMD_OP_SET_WOL_ROL
case|:
return|return
literal|"SET_WOL_ROL"
return|;
case|case
name|MLX5_CMD_OP_QUERY_WOL_ROL
case|:
return|return
literal|"QUERY_WOL_ROL"
return|;
case|case
name|MLX5_CMD_OP_ALLOC_Q_COUNTER
case|:
return|return
literal|"ALLOC_Q_COUNTER"
return|;
case|case
name|MLX5_CMD_OP_DEALLOC_Q_COUNTER
case|:
return|return
literal|"DEALLOC_Q_COUNTER"
return|;
case|case
name|MLX5_CMD_OP_QUERY_Q_COUNTER
case|:
return|return
literal|"QUERY_Q_COUNTER"
return|;
case|case
name|MLX5_CMD_OP_ALLOC_PD
case|:
return|return
literal|"ALLOC_PD"
return|;
case|case
name|MLX5_CMD_OP_DEALLOC_PD
case|:
return|return
literal|"DEALLOC_PD"
return|;
case|case
name|MLX5_CMD_OP_ALLOC_UAR
case|:
return|return
literal|"ALLOC_UAR"
return|;
case|case
name|MLX5_CMD_OP_DEALLOC_UAR
case|:
return|return
literal|"DEALLOC_UAR"
return|;
case|case
name|MLX5_CMD_OP_CONFIG_INT_MODERATION
case|:
return|return
literal|"CONFIG_INT_MODERATION"
return|;
case|case
name|MLX5_CMD_OP_ATTACH_TO_MCG
case|:
return|return
literal|"ATTACH_TO_MCG"
return|;
case|case
name|MLX5_CMD_OP_DETACH_FROM_MCG
case|:
return|return
literal|"DETACH_FROM_MCG"
return|;
case|case
name|MLX5_CMD_OP_GET_DROPPED_PACKET_LOG
case|:
return|return
literal|"GET_DROPPED_PACKET_LOG"
return|;
case|case
name|MLX5_CMD_OP_QUERY_MAD_DEMUX
case|:
return|return
literal|"QUERY_MAD_DEMUX"
return|;
case|case
name|MLX5_CMD_OP_SET_MAD_DEMUX
case|:
return|return
literal|"SET_MAD_DEMUX"
return|;
case|case
name|MLX5_CMD_OP_NOP
case|:
return|return
literal|"NOP"
return|;
case|case
name|MLX5_CMD_OP_ALLOC_XRCD
case|:
return|return
literal|"ALLOC_XRCD"
return|;
case|case
name|MLX5_CMD_OP_DEALLOC_XRCD
case|:
return|return
literal|"DEALLOC_XRCD"
return|;
case|case
name|MLX5_CMD_OP_ALLOC_TRANSPORT_DOMAIN
case|:
return|return
literal|"ALLOC_TRANSPORT_DOMAIN"
return|;
case|case
name|MLX5_CMD_OP_DEALLOC_TRANSPORT_DOMAIN
case|:
return|return
literal|"DEALLOC_TRANSPORT_DOMAIN"
return|;
case|case
name|MLX5_CMD_OP_QUERY_CONG_STATUS
case|:
return|return
literal|"QUERY_CONG_STATUS"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_CONG_STATUS
case|:
return|return
literal|"MODIFY_CONG_STATUS"
return|;
case|case
name|MLX5_CMD_OP_QUERY_CONG_PARAMS
case|:
return|return
literal|"QUERY_CONG_PARAMS"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_CONG_PARAMS
case|:
return|return
literal|"MODIFY_CONG_PARAMS"
return|;
case|case
name|MLX5_CMD_OP_QUERY_CONG_STATISTICS
case|:
return|return
literal|"QUERY_CONG_STATISTICS"
return|;
case|case
name|MLX5_CMD_OP_ADD_VXLAN_UDP_DPORT
case|:
return|return
literal|"ADD_VXLAN_UDP_DPORT"
return|;
case|case
name|MLX5_CMD_OP_DELETE_VXLAN_UDP_DPORT
case|:
return|return
literal|"DELETE_VXLAN_UDP_DPORT"
return|;
case|case
name|MLX5_CMD_OP_SET_L2_TABLE_ENTRY
case|:
return|return
literal|"SET_L2_TABLE_ENTRY"
return|;
case|case
name|MLX5_CMD_OP_QUERY_L2_TABLE_ENTRY
case|:
return|return
literal|"QUERY_L2_TABLE_ENTRY"
return|;
case|case
name|MLX5_CMD_OP_DELETE_L2_TABLE_ENTRY
case|:
return|return
literal|"DELETE_L2_TABLE_ENTRY"
return|;
case|case
name|MLX5_CMD_OP_CREATE_RMP
case|:
return|return
literal|"CREATE_RMP"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_RMP
case|:
return|return
literal|"MODIFY_RMP"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_RMP
case|:
return|return
literal|"DESTROY_RMP"
return|;
case|case
name|MLX5_CMD_OP_QUERY_RMP
case|:
return|return
literal|"QUERY_RMP"
return|;
case|case
name|MLX5_CMD_OP_CREATE_RQT
case|:
return|return
literal|"CREATE_RQT"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_RQT
case|:
return|return
literal|"MODIFY_RQT"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_RQT
case|:
return|return
literal|"DESTROY_RQT"
return|;
case|case
name|MLX5_CMD_OP_QUERY_RQT
case|:
return|return
literal|"QUERY_RQT"
return|;
case|case
name|MLX5_CMD_OP_ACCESS_REG
case|:
return|return
literal|"MLX5_CMD_OP_ACCESS_REG"
return|;
case|case
name|MLX5_CMD_OP_CREATE_SQ
case|:
return|return
literal|"CREATE_SQ"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_SQ
case|:
return|return
literal|"MODIFY_SQ"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_SQ
case|:
return|return
literal|"DESTROY_SQ"
return|;
case|case
name|MLX5_CMD_OP_QUERY_SQ
case|:
return|return
literal|"QUERY_SQ"
return|;
case|case
name|MLX5_CMD_OP_CREATE_RQ
case|:
return|return
literal|"CREATE_RQ"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_RQ
case|:
return|return
literal|"MODIFY_RQ"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_RQ
case|:
return|return
literal|"DESTROY_RQ"
return|;
case|case
name|MLX5_CMD_OP_QUERY_RQ
case|:
return|return
literal|"QUERY_RQ"
return|;
case|case
name|MLX5_CMD_OP_CREATE_TIR
case|:
return|return
literal|"CREATE_TIR"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_TIR
case|:
return|return
literal|"MODIFY_TIR"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_TIR
case|:
return|return
literal|"DESTROY_TIR"
return|;
case|case
name|MLX5_CMD_OP_QUERY_TIR
case|:
return|return
literal|"QUERY_TIR"
return|;
case|case
name|MLX5_CMD_OP_CREATE_TIS
case|:
return|return
literal|"CREATE_TIS"
return|;
case|case
name|MLX5_CMD_OP_MODIFY_TIS
case|:
return|return
literal|"MODIFY_TIS"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_TIS
case|:
return|return
literal|"DESTROY_TIS"
return|;
case|case
name|MLX5_CMD_OP_QUERY_TIS
case|:
return|return
literal|"QUERY_TIS"
return|;
case|case
name|MLX5_CMD_OP_CREATE_FLOW_TABLE
case|:
return|return
literal|"CREATE_FLOW_TABLE"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_FLOW_TABLE
case|:
return|return
literal|"DESTROY_FLOW_TABLE"
return|;
case|case
name|MLX5_CMD_OP_QUERY_FLOW_TABLE
case|:
return|return
literal|"QUERY_FLOW_TABLE"
return|;
case|case
name|MLX5_CMD_OP_CREATE_FLOW_GROUP
case|:
return|return
literal|"CREATE_FLOW_GROUP"
return|;
case|case
name|MLX5_CMD_OP_DESTROY_FLOW_GROUP
case|:
return|return
literal|"DESTROY_FLOW_GROUP"
return|;
case|case
name|MLX5_CMD_OP_QUERY_FLOW_GROUP
case|:
return|return
literal|"QUERY_FLOW_GROUP"
return|;
case|case
name|MLX5_CMD_OP_SET_FLOW_TABLE_ENTRY
case|:
return|return
literal|"SET_FLOW_TABLE_ENTRY"
return|;
case|case
name|MLX5_CMD_OP_QUERY_FLOW_TABLE_ENTRY
case|:
return|return
literal|"QUERY_FLOW_TABLE_ENTRY"
return|;
case|case
name|MLX5_CMD_OP_DELETE_FLOW_TABLE_ENTRY
case|:
return|return
literal|"DELETE_FLOW_TABLE_ENTRY"
return|;
case|case
name|MLX5_CMD_OP_SET_DIAGNOSTICS
case|:
return|return
literal|"MLX5_CMD_OP_SET_DIAGNOSTICS"
return|;
case|case
name|MLX5_CMD_OP_QUERY_DIAGNOSTICS
case|:
return|return
literal|"MLX5_CMD_OP_QUERY_DIAGNOSTICS"
return|;
default|default:
return|return
literal|"unknown command opcode"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_command
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|,
name|int
name|input
parameter_list|)
block|{
name|u16
name|op
init|=
name|be16_to_cpu
argument_list|(
operator|(
operator|(
expr|struct
name|mlx5_inbox_hdr
operator|*
operator|)
operator|(
name|ent
operator|->
name|lay
operator|->
name|in
operator|)
operator|)
operator|->
name|opcode
argument_list|)
decl_stmt|;
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
init|=
name|input
condition|?
name|ent
operator|->
name|in
else|:
name|ent
operator|->
name|out
decl_stmt|;
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|next
init|=
name|msg
operator|->
name|next
decl_stmt|;
name|int
name|data_only
decl_stmt|;
name|u32
name|offset
init|=
literal|0
decl_stmt|;
name|int
name|dump_len
decl_stmt|;
name|data_only
operator|=
operator|!
operator|!
operator|(
name|mlx5_core_debug_mask
operator|&
operator|(
literal|1
operator|<<
name|MLX5_CMD_DATA
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|data_only
condition|)
name|mlx5_core_dbg_mask
argument_list|(
name|dev
argument_list|,
literal|1
operator|<<
name|MLX5_CMD_DATA
argument_list|,
literal|"dump command data %s(0x%x) %s\n"
argument_list|,
name|mlx5_command_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
name|input
condition|?
literal|"INPUT"
else|:
literal|"OUTPUT"
argument_list|)
expr_stmt|;
else|else
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"dump command %s(0x%x) %s\n"
argument_list|,
name|mlx5_command_str
argument_list|(
name|op
argument_list|)
argument_list|,
name|op
argument_list|,
name|input
condition|?
literal|"INPUT"
else|:
literal|"OUTPUT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_only
condition|)
block|{
if|if
condition|(
name|input
condition|)
block|{
name|dump_buf
argument_list|(
name|ent
operator|->
name|lay
operator|->
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|ent
operator|->
name|lay
operator|->
name|in
argument_list|)
argument_list|,
literal|1
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ent
operator|->
name|lay
operator|->
name|in
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dump_buf
argument_list|(
name|ent
operator|->
name|lay
operator|->
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|ent
operator|->
name|lay
operator|->
name|out
argument_list|)
argument_list|,
literal|1
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|ent
operator|->
name|lay
operator|->
name|out
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|dump_buf
argument_list|(
name|ent
operator|->
name|lay
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ent
operator|->
name|lay
argument_list|)
argument_list|,
literal|0
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|ent
operator|->
name|lay
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|next
operator|&&
name|offset
operator|<
name|msg
operator|->
name|len
condition|)
block|{
if|if
condition|(
name|data_only
condition|)
block|{
name|dump_len
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|MLX5_CMD_DATA_BLOCK_SIZE
argument_list|,
name|msg
operator|->
name|len
operator|-
name|offset
argument_list|)
expr_stmt|;
name|dump_buf
argument_list|(
name|next
operator|->
name|buf
argument_list|,
name|dump_len
argument_list|,
literal|1
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|MLX5_CMD_DATA_BLOCK_SIZE
expr_stmt|;
block|}
else|else
block|{
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"command block:\n"
argument_list|)
expr_stmt|;
name|dump_buf
argument_list|(
name|next
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_cmd_prot_block
argument_list|)
argument_list|,
literal|0
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_cmd_prot_block
argument_list|)
expr_stmt|;
block|}
name|next
operator|=
name|next
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|data_only
condition|)
name|pr_debug
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|complete_command
parameter_list|(
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
name|ent
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|cmd
argument_list|,
expr|struct
name|mlx5_core_dev
argument_list|,
name|cmd
argument_list|)
decl_stmt|;
name|mlx5_cmd_cbk_t
name|callback
decl_stmt|;
name|void
modifier|*
name|context
decl_stmt|;
name|s64
name|ds
decl_stmt|;
name|struct
name|mlx5_cmd_stats
modifier|*
name|stats
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|semaphore
modifier|*
name|sem
decl_stmt|;
if|if
condition|(
name|ent
operator|->
name|page_queue
condition|)
name|sem
operator|=
operator|&
name|cmd
operator|->
name|pages_sem
expr_stmt|;
else|else
name|sem
operator|=
operator|&
name|cmd
operator|->
name|sem
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|callback
condition|)
block|{
name|ds
operator|=
name|ent
operator|->
name|ts2
operator|-
name|ent
operator|->
name|ts1
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|op
operator|<
name|ARRAY_SIZE
argument_list|(
name|cmd
operator|->
name|stats
argument_list|)
condition|)
block|{
name|stats
operator|=
operator|&
name|cmd
operator|->
name|stats
index|[
name|ent
operator|->
name|op
index|]
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|stats
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|stats
operator|->
name|sum
operator|+=
name|ds
expr_stmt|;
operator|++
name|stats
operator|->
name|n
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|stats
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
name|callback
operator|=
name|ent
operator|->
name|callback
expr_stmt|;
name|context
operator|=
name|ent
operator|->
name|context
expr_stmt|;
name|err
operator|=
name|ent
operator|->
name|ret
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|mlx5_copy_from_msg
argument_list|(
name|ent
operator|->
name|uout
argument_list|,
name|ent
operator|->
name|out
argument_list|,
name|ent
operator|->
name|uout_size
argument_list|)
expr_stmt|;
name|mlx5_free_cmd_msg
argument_list|(
name|dev
argument_list|,
name|ent
operator|->
name|out
argument_list|)
expr_stmt|;
name|free_msg
argument_list|(
name|dev
argument_list|,
name|ent
operator|->
name|in
argument_list|)
expr_stmt|;
name|free_cmd
argument_list|(
name|ent
argument_list|)
expr_stmt|;
name|callback
argument_list|(
name|err
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|complete
argument_list|(
operator|&
name|ent
operator|->
name|done
argument_list|)
expr_stmt|;
block|}
name|up
argument_list|(
name|sem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cmd_work_handler
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx5_cmd_work_ent
argument_list|,
name|work
argument_list|)
decl_stmt|;
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
name|ent
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|cmd
argument_list|,
expr|struct
name|mlx5_core_dev
argument_list|,
name|cmd
argument_list|)
decl_stmt|;
name|struct
name|mlx5_cmd_layout
modifier|*
name|lay
decl_stmt|;
name|struct
name|semaphore
modifier|*
name|sem
decl_stmt|;
name|sem
operator|=
name|ent
operator|->
name|page_queue
condition|?
operator|&
name|cmd
operator|->
name|pages_sem
else|:
operator|&
name|cmd
operator|->
name|sem
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|moving_to_polling
condition|)
block|{
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"not expecting command execution, ignoring...\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|down
argument_list|(
name|sem
argument_list|)
expr_stmt|;
if|if
condition|(
name|alloc_ent
argument_list|(
name|ent
argument_list|)
operator|<
literal|0
condition|)
block|{
name|complete_command
argument_list|(
name|ent
argument_list|)
expr_stmt|;
return|return;
block|}
name|ent
operator|->
name|token
operator|=
name|alloc_token
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|lay
operator|=
name|get_inst
argument_list|(
name|cmd
argument_list|,
name|ent
operator|->
name|idx
argument_list|)
expr_stmt|;
name|ent
operator|->
name|lay
operator|=
name|lay
expr_stmt|;
name|memset
argument_list|(
name|lay
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|lay
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|lay
operator|->
name|in
argument_list|,
name|ent
operator|->
name|in
operator|->
name|first
operator|.
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|lay
operator|->
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|op
operator|=
name|be32_to_cpu
argument_list|(
name|lay
operator|->
name|in
index|[
literal|0
index|]
argument_list|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|in
operator|->
name|next
condition|)
name|lay
operator|->
name|in_ptr
operator|=
name|cpu_to_be64
argument_list|(
name|ent
operator|->
name|in
operator|->
name|next
operator|->
name|dma
argument_list|)
expr_stmt|;
name|lay
operator|->
name|inlen
operator|=
name|cpu_to_be32
argument_list|(
name|ent
operator|->
name|in
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|out
operator|->
name|next
condition|)
name|lay
operator|->
name|out_ptr
operator|=
name|cpu_to_be64
argument_list|(
name|ent
operator|->
name|out
operator|->
name|next
operator|->
name|dma
argument_list|)
expr_stmt|;
name|lay
operator|->
name|outlen
operator|=
name|cpu_to_be32
argument_list|(
name|ent
operator|->
name|out
operator|->
name|len
argument_list|)
expr_stmt|;
name|lay
operator|->
name|type
operator|=
name|MLX5_PCI_CMD_XPORT
expr_stmt|;
name|lay
operator|->
name|token
operator|=
name|ent
operator|->
name|token
expr_stmt|;
name|lay
operator|->
name|status_own
operator|=
name|CMD_OWNER_HW
expr_stmt|;
name|set_signature
argument_list|(
name|ent
argument_list|,
operator|!
name|cmd
operator|->
name|checksum_disabled
argument_list|)
expr_stmt|;
name|dump_command
argument_list|(
name|dev
argument_list|,
name|ent
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ent
operator|->
name|ts1
operator|=
name|ktime_get_ns
argument_list|()
expr_stmt|;
comment|/* ring doorbell after the descriptor is valid */
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"writing 0x%x to command doorbell\n"
argument_list|,
literal|1
operator|<<
name|ent
operator|->
name|idx
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|iowrite32be
argument_list|(
literal|1
operator|<<
name|ent
operator|->
name|idx
argument_list|,
operator|&
name|dev
operator|->
name|iseg
operator|->
name|cmd_dbell
argument_list|)
expr_stmt|;
name|mmiowb
argument_list|()
expr_stmt|;
comment|/* if not in polling don't use ent after this point*/
if|if
condition|(
name|cmd
operator|->
name|mode
operator|==
name|CMD_MODE_POLLING
condition|)
block|{
name|poll_timeout
argument_list|(
name|ent
argument_list|)
expr_stmt|;
comment|/* make sure we read the descriptor after ownership is SW */
name|rmb
argument_list|()
expr_stmt|;
name|mlx5_cmd_comp_handler
argument_list|(
name|dev
argument_list|,
literal|1U
operator|<<
name|ent
operator|->
name|idx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|deliv_status_to_str
parameter_list|(
name|u8
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|MLX5_CMD_DELIVERY_STAT_OK
case|:
return|return
literal|"no errors"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_SIGNAT_ERR
case|:
return|return
literal|"signature error"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_TOK_ERR
case|:
return|return
literal|"token error"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_BAD_BLK_NUM_ERR
case|:
return|return
literal|"bad block number"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_OUT_PTR_ALIGN_ERR
case|:
return|return
literal|"output pointer not aligned to block size"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_IN_PTR_ALIGN_ERR
case|:
return|return
literal|"input pointer not aligned to block size"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_FW_ERR
case|:
return|return
literal|"firmware internal error"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_IN_LENGTH_ERR
case|:
return|return
literal|"command input length error"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_OUT_LENGTH_ERR
case|:
return|return
literal|"command ouput length error"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_RES_FLD_NOT_CLR_ERR
case|:
return|return
literal|"reserved fields not cleared"
return|;
case|case
name|MLX5_CMD_DELIVERY_STAT_CMD_DESCR_ERR
case|:
return|return
literal|"bad command descriptor type"
return|;
default|default:
return|return
literal|"unknown status code"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|u16
name|msg_to_opcode
parameter_list|(
name|struct
name|mlx5_cmd_msg
modifier|*
name|in
parameter_list|)
block|{
name|struct
name|mlx5_inbox_hdr
modifier|*
name|hdr
init|=
operator|(
expr|struct
name|mlx5_inbox_hdr
operator|*
operator|)
operator|(
name|in
operator|->
name|first
operator|.
name|data
operator|)
decl_stmt|;
return|return
name|be16_to_cpu
argument_list|(
name|hdr
operator|->
name|opcode
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wait_func
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
parameter_list|)
block|{
name|int
name|timeout
init|=
name|msecs_to_jiffies
argument_list|(
name|MLX5_CMD_TIMEOUT_MSEC
argument_list|)
decl_stmt|;
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|cmd
operator|->
name|mode
operator|==
name|CMD_MODE_POLLING
condition|)
block|{
name|wait_for_completion
argument_list|(
operator|&
name|ent
operator|->
name|done
argument_list|)
expr_stmt|;
name|err
operator|=
name|ent
operator|->
name|ret
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wait_for_completion_timeout
argument_list|(
operator|&
name|ent
operator|->
name|done
argument_list|,
name|timeout
argument_list|)
condition|)
name|err
operator|=
operator|-
name|ETIMEDOUT
expr_stmt|;
else|else
name|err
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|==
operator|-
name|ETIMEDOUT
condition|)
block|{
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"%s(0x%x) timeout. Will cause a leak of a command resource\n"
argument_list|,
name|mlx5_command_str
argument_list|(
name|msg_to_opcode
argument_list|(
name|ent
operator|->
name|in
argument_list|)
argument_list|)
argument_list|,
name|msg_to_opcode
argument_list|(
name|ent
operator|->
name|in
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"err %d, delivery status %s(%d)\n"
argument_list|,
name|err
argument_list|,
name|deliv_status_to_str
argument_list|(
name|ent
operator|->
name|status
argument_list|)
argument_list|,
name|ent
operator|->
name|status
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*  Notes:  *    1. Callback functions may not sleep  *    2. page queue commands do not support asynchrous completion  */
end_comment

begin_function
specifier|static
name|int
name|mlx5_cmd_invoke
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|in
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|out
parameter_list|,
name|void
modifier|*
name|uout
parameter_list|,
name|int
name|uout_size
parameter_list|,
name|mlx5_cmd_cbk_t
name|callback
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|int
name|page_queue
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
decl_stmt|;
name|struct
name|mlx5_cmd_stats
modifier|*
name|stats
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|s64
name|ds
decl_stmt|;
name|u16
name|op
decl_stmt|;
if|if
condition|(
name|callback
operator|&&
name|page_queue
condition|)
return|return
operator|-
name|EINVAL
return|;
name|ent
operator|=
name|alloc_cmd
argument_list|(
name|cmd
argument_list|,
name|in
argument_list|,
name|out
argument_list|,
name|uout
argument_list|,
name|uout_size
argument_list|,
name|callback
argument_list|,
name|context
argument_list|,
name|page_queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|ent
argument_list|)
condition|)
return|return
name|PTR_ERR
argument_list|(
name|ent
argument_list|)
return|;
if|if
condition|(
operator|!
name|callback
condition|)
name|init_completion
argument_list|(
operator|&
name|ent
operator|->
name|done
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|ent
operator|->
name|work
argument_list|,
name|cmd_work_handler
argument_list|)
expr_stmt|;
if|if
condition|(
name|page_queue
condition|)
block|{
name|cmd_work_handler
argument_list|(
operator|&
name|ent
operator|->
name|work
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|queue_work
argument_list|(
name|cmd
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|work
argument_list|)
condition|)
block|{
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to queue work\n"
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
if|if
condition|(
operator|!
name|callback
condition|)
block|{
name|err
operator|=
name|wait_func
argument_list|(
name|dev
argument_list|,
name|ent
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
operator|-
name|ETIMEDOUT
condition|)
goto|goto
name|out
goto|;
name|ds
operator|=
name|ent
operator|->
name|ts2
operator|-
name|ent
operator|->
name|ts1
expr_stmt|;
name|op
operator|=
name|be16_to_cpu
argument_list|(
operator|(
operator|(
expr|struct
name|mlx5_inbox_hdr
operator|*
operator|)
name|in
operator|->
name|first
operator|.
name|data
operator|)
operator|->
name|opcode
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|<
name|ARRAY_SIZE
argument_list|(
name|cmd
operator|->
name|stats
argument_list|)
condition|)
block|{
name|stats
operator|=
operator|&
name|cmd
operator|->
name|stats
index|[
name|op
index|]
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|stats
operator|->
name|lock
argument_list|)
expr_stmt|;
name|stats
operator|->
name|sum
operator|+=
name|ds
expr_stmt|;
operator|++
name|stats
operator|->
name|n
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|stats
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|mlx5_core_dbg_mask
argument_list|(
name|dev
argument_list|,
literal|1
operator|<<
name|MLX5_CMD_TIME
argument_list|,
literal|"fw exec time for %s is %lld nsec\n"
argument_list|,
name|mlx5_command_str
argument_list|(
name|op
argument_list|)
argument_list|,
operator|(
name|long
name|long
operator|)
name|ds
argument_list|)
expr_stmt|;
operator|*
name|status
operator|=
name|ent
operator|->
name|status
expr_stmt|;
name|free_cmd
argument_list|(
name|ent
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
name|out_free
label|:
name|free_cmd
argument_list|(
name|ent
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_copy_to_msg
parameter_list|(
name|struct
name|mlx5_cmd_msg
modifier|*
name|to
parameter_list|,
name|void
modifier|*
name|from
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|mlx5_cmd_prot_block
modifier|*
name|block
decl_stmt|;
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|next
decl_stmt|;
name|int
name|copy
decl_stmt|;
if|if
condition|(
operator|!
name|to
operator|||
operator|!
name|from
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|copy
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|size
argument_list|,
sizeof|sizeof
argument_list|(
name|to
operator|->
name|first
operator|.
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|to
operator|->
name|first
operator|.
name|data
argument_list|,
name|from
argument_list|,
name|copy
argument_list|)
expr_stmt|;
name|size
operator|-=
name|copy
expr_stmt|;
name|from
operator|+=
name|copy
expr_stmt|;
name|next
operator|=
name|to
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|size
condition|)
block|{
if|if
condition|(
operator|!
name|next
condition|)
block|{
comment|/* this is a BUG */
return|return
operator|-
name|ENOMEM
return|;
block|}
name|copy
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|size
argument_list|,
name|MLX5_CMD_DATA_BLOCK_SIZE
argument_list|)
expr_stmt|;
name|block
operator|=
name|next
operator|->
name|buf
expr_stmt|;
name|memcpy
argument_list|(
name|block
operator|->
name|data
argument_list|,
name|from
argument_list|,
name|copy
argument_list|)
expr_stmt|;
name|from
operator|+=
name|copy
expr_stmt|;
name|size
operator|-=
name|copy
expr_stmt|;
name|next
operator|=
name|next
operator|->
name|next
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_copy_from_msg
parameter_list|(
name|void
modifier|*
name|to
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|from
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|mlx5_cmd_prot_block
modifier|*
name|block
decl_stmt|;
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|next
decl_stmt|;
name|int
name|copy
decl_stmt|;
if|if
condition|(
operator|!
name|to
operator|||
operator|!
name|from
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|copy
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|size
argument_list|,
sizeof|sizeof
argument_list|(
name|from
operator|->
name|first
operator|.
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|to
argument_list|,
name|from
operator|->
name|first
operator|.
name|data
argument_list|,
name|copy
argument_list|)
expr_stmt|;
name|size
operator|-=
name|copy
expr_stmt|;
name|to
operator|+=
name|copy
expr_stmt|;
name|next
operator|=
name|from
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|size
condition|)
block|{
if|if
condition|(
operator|!
name|next
condition|)
block|{
comment|/* this is a BUG */
return|return
operator|-
name|ENOMEM
return|;
block|}
name|copy
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|size
argument_list|,
name|MLX5_CMD_DATA_BLOCK_SIZE
argument_list|)
expr_stmt|;
name|block
operator|=
name|next
operator|->
name|buf
expr_stmt|;
name|memcpy
argument_list|(
name|to
argument_list|,
name|block
operator|->
name|data
argument_list|,
name|copy
argument_list|)
expr_stmt|;
name|to
operator|+=
name|copy
expr_stmt|;
name|size
operator|-=
name|copy
expr_stmt|;
name|next
operator|=
name|next
operator|->
name|next
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|alloc_cmd_box
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|gfp_t
name|flags
parameter_list|)
block|{
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|mailbox
decl_stmt|;
name|mailbox
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mailbox
argument_list|)
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailbox
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mailbox
operator|->
name|buf
operator|=
name|pci_pool_alloc
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|pool
argument_list|,
name|flags
argument_list|,
operator|&
name|mailbox
operator|->
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailbox
operator|->
name|buf
condition|)
block|{
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"failed allocation\n"
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|memset
argument_list|(
name|mailbox
operator|->
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_cmd_prot_block
argument_list|)
argument_list|)
expr_stmt|;
name|mailbox
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|mailbox
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_cmd_box
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|mailbox
parameter_list|)
block|{
name|pci_pool_free
argument_list|(
name|dev
operator|->
name|cmd
operator|.
name|pool
argument_list|,
name|mailbox
operator|->
name|buf
argument_list|,
name|mailbox
operator|->
name|dma
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mailbox
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_cmd_msg
modifier|*
name|mlx5_alloc_cmd_msg
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|gfp_t
name|flags
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|head
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_cmd_prot_block
modifier|*
name|block
decl_stmt|;
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|blen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|i
decl_stmt|;
name|msg
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|blen
operator|=
name|size
operator|-
name|min_t
argument_list|(
name|int
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|first
operator|.
name|data
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|blen
operator|+
name|MLX5_CMD_DATA_BLOCK_SIZE
operator|-
literal|1
operator|)
operator|/
name|MLX5_CMD_DATA_BLOCK_SIZE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|alloc_cmd_box
argument_list|(
name|dev
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|tmp
argument_list|)
condition|)
block|{
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"failed allocating block\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|PTR_ERR
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
goto|goto
name|err_alloc
goto|;
block|}
name|block
operator|=
name|tmp
operator|->
name|buf
expr_stmt|;
name|tmp
operator|->
name|next
operator|=
name|head
expr_stmt|;
name|block
operator|->
name|next
operator|=
name|cpu_to_be64
argument_list|(
name|tmp
operator|->
name|next
condition|?
name|tmp
operator|->
name|next
operator|->
name|dma
else|:
literal|0
argument_list|)
expr_stmt|;
name|block
operator|->
name|block_num
operator|=
name|cpu_to_be32
argument_list|(
name|n
operator|-
name|i
operator|-
literal|1
argument_list|)
expr_stmt|;
name|head
operator|=
name|tmp
expr_stmt|;
block|}
name|msg
operator|->
name|next
operator|=
name|head
expr_stmt|;
name|msg
operator|->
name|len
operator|=
name|size
expr_stmt|;
return|return
name|msg
return|;
name|err_alloc
label|:
while|while
condition|(
name|head
condition|)
block|{
name|tmp
operator|=
name|head
operator|->
name|next
expr_stmt|;
name|free_cmd_box
argument_list|(
name|dev
argument_list|,
name|head
argument_list|)
expr_stmt|;
name|head
operator|=
name|tmp
expr_stmt|;
block|}
name|kfree
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_free_cmd_msg
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|head
init|=
name|msg
operator|->
name|next
decl_stmt|;
name|struct
name|mlx5_cmd_mailbox
modifier|*
name|next
decl_stmt|;
while|while
condition|(
name|head
condition|)
block|{
name|next
operator|=
name|head
operator|->
name|next
expr_stmt|;
name|free_cmd_box
argument_list|(
name|dev
argument_list|,
name|head
argument_list|)
expr_stmt|;
name|head
operator|=
name|next
expr_stmt|;
block|}
name|kfree
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_wqname
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|snprintf
argument_list|(
name|cmd
operator|->
name|wq_name
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
operator|->
name|wq_name
argument_list|)
argument_list|,
literal|"mlx5_cmd_%s"
argument_list|,
name|dev_name
argument_list|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|clean_debug_files
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|mlx5_cmd_use_events
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|max_reg_cmds
condition|;
name|i
operator|++
control|)
name|down
argument_list|(
operator|&
name|cmd
operator|->
name|sem
argument_list|)
expr_stmt|;
name|down
argument_list|(
operator|&
name|cmd
operator|->
name|pages_sem
argument_list|)
expr_stmt|;
name|flush_workqueue
argument_list|(
name|cmd
operator|->
name|wq
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|mode
operator|=
name|CMD_MODE_EVENTS
expr_stmt|;
name|up
argument_list|(
operator|&
name|cmd
operator|->
name|pages_sem
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmd
operator|->
name|max_reg_cmds
condition|;
name|i
operator|++
control|)
name|up
argument_list|(
operator|&
name|cmd
operator|->
name|sem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx5_cmd_use_polling
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|synchronize_irq
argument_list|(
name|dev
operator|->
name|priv
operator|.
name|eq_table
operator|.
name|pages_eq
operator|.
name|irqn
argument_list|)
expr_stmt|;
name|flush_workqueue
argument_list|(
name|dev
operator|->
name|priv
operator|.
name|pg_wq
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|moving_to_polling
operator|=
literal|1
expr_stmt|;
name|flush_workqueue
argument_list|(
name|cmd
operator|->
name|wq
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|mode
operator|=
name|CMD_MODE_POLLING
expr_stmt|;
name|cmd
operator|->
name|moving_to_polling
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_msg
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
parameter_list|)
block|{
name|unsigned
name|long
name|flags
decl_stmt|;
if|if
condition|(
name|msg
operator|->
name|cache
condition|)
block|{
name|spin_lock_irqsave
argument_list|(
operator|&
name|msg
operator|->
name|cache
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|msg
operator|->
name|list
argument_list|,
operator|&
name|msg
operator|->
name|cache
operator|->
name|head
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|msg
operator|->
name|cache
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mlx5_free_cmd_msg
argument_list|(
name|dev
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|mlx5_cmd_comp_handler
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|vector
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx5_cmd_work_ent
modifier|*
name|ent
decl_stmt|;
name|int
name|i
decl_stmt|;
while|while
condition|(
name|vector
operator|!=
literal|0
condition|)
block|{
name|i
operator|=
name|ffs
argument_list|(
name|vector
argument_list|)
operator|-
literal|1
expr_stmt|;
name|vector
operator|&=
operator|~
operator|(
literal|1U
operator|<<
name|i
operator|)
expr_stmt|;
name|ent
operator|=
name|cmd
operator|->
name|ent_arr
index|[
name|i
index|]
expr_stmt|;
name|ent
operator|->
name|ts2
operator|=
name|ktime_get_ns
argument_list|()
expr_stmt|;
name|memcpy
argument_list|(
name|ent
operator|->
name|out
operator|->
name|first
operator|.
name|data
argument_list|,
name|ent
operator|->
name|lay
operator|->
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|ent
operator|->
name|lay
operator|->
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|dump_command
argument_list|(
name|dev
argument_list|,
name|ent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ent
operator|->
name|ret
condition|)
block|{
if|if
condition|(
operator|!
name|cmd
operator|->
name|checksum_disabled
condition|)
name|ent
operator|->
name|ret
operator|=
name|verify_signature
argument_list|(
name|ent
argument_list|)
expr_stmt|;
else|else
name|ent
operator|->
name|ret
operator|=
literal|0
expr_stmt|;
name|ent
operator|->
name|status
operator|=
name|ent
operator|->
name|lay
operator|->
name|status_own
operator|>>
literal|1
expr_stmt|;
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"FW command ret 0x%x, status %s(0x%x)\n"
argument_list|,
name|ent
operator|->
name|ret
argument_list|,
name|deliv_status_to_str
argument_list|(
name|ent
operator|->
name|status
argument_list|)
argument_list|,
name|ent
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
name|free_ent
argument_list|(
name|cmd
argument_list|,
name|ent
operator|->
name|idx
argument_list|)
expr_stmt|;
name|complete_command
argument_list|(
name|ent
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_cmd_comp_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|status_to_err
parameter_list|(
name|u8
name|status
parameter_list|)
block|{
return|return
name|status
condition|?
operator|-
literal|1
else|:
literal|0
return|;
comment|/* TBD more meaningful codes */
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_cmd_msg
modifier|*
name|alloc_msg
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|int
name|in_size
parameter_list|,
name|gfp_t
name|gfp
parameter_list|)
block|{
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
init|=
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
decl_stmt|;
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|struct
name|cache_ent
modifier|*
name|ent
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|in_size
operator|>
name|MED_LIST_SIZE
operator|&&
name|in_size
operator|<=
name|LONG_LIST_SIZE
condition|)
name|ent
operator|=
operator|&
name|cmd
operator|->
name|cache
operator|.
name|large
expr_stmt|;
elseif|else
if|if
condition|(
name|in_size
operator|>
literal|16
operator|&&
name|in_size
operator|<=
name|MED_LIST_SIZE
condition|)
name|ent
operator|=
operator|&
name|cmd
operator|->
name|cache
operator|.
name|med
expr_stmt|;
if|if
condition|(
name|ent
condition|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|ent
operator|->
name|head
argument_list|)
condition|)
block|{
name|msg
operator|=
name|list_entry
argument_list|(
name|ent
operator|->
name|head
operator|.
name|next
argument_list|,
expr|struct
name|mlx5_cmd_msg
argument_list|,
name|list
argument_list|)
expr_stmt|;
comment|/* For cached lists, we must explicitly state what is 			 * the real size 			 */
name|msg
operator|->
name|len
operator|=
name|in_size
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|msg
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IS_ERR
argument_list|(
name|msg
argument_list|)
condition|)
name|msg
operator|=
name|mlx5_alloc_cmd_msg
argument_list|(
name|dev
argument_list|,
name|gfp
argument_list|,
name|in_size
argument_list|)
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_manage_pages
parameter_list|(
name|struct
name|mlx5_inbox_hdr
modifier|*
name|in
parameter_list|)
block|{
return|return
name|be16_to_cpu
argument_list|(
name|in
operator|->
name|opcode
argument_list|)
operator|==
name|MLX5_CMD_OP_MANAGE_PAGES
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_exec_helper
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|in
parameter_list|,
name|int
name|in_size
parameter_list|,
name|void
modifier|*
name|out
parameter_list|,
name|int
name|out_size
parameter_list|,
name|mlx5_cmd_cbk_t
name|callback
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|mlx5_cmd_msg
modifier|*
name|inb
decl_stmt|;
name|struct
name|mlx5_cmd_msg
modifier|*
name|outb
decl_stmt|;
name|int
name|pages_queue
decl_stmt|;
name|gfp_t
name|gfp
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u8
name|status
init|=
literal|0
decl_stmt|;
name|pages_queue
operator|=
name|is_manage_pages
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|gfp
operator|=
name|callback
condition|?
name|GFP_ATOMIC
else|:
name|GFP_KERNEL
expr_stmt|;
name|inb
operator|=
name|alloc_msg
argument_list|(
name|dev
argument_list|,
name|in_size
argument_list|,
name|gfp
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|inb
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|inb
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|err
operator|=
name|mlx5_copy_to_msg
argument_list|(
name|inb
argument_list|,
name|in
argument_list|,
name|in_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"err %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|out_in
goto|;
block|}
name|outb
operator|=
name|mlx5_alloc_cmd_msg
argument_list|(
name|dev
argument_list|,
name|gfp
argument_list|,
name|out_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|outb
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|outb
argument_list|)
expr_stmt|;
goto|goto
name|out_in
goto|;
block|}
name|err
operator|=
name|mlx5_cmd_invoke
argument_list|(
name|dev
argument_list|,
name|inb
argument_list|,
name|outb
argument_list|,
name|out
argument_list|,
name|out_size
argument_list|,
name|callback
argument_list|,
name|context
argument_list|,
name|pages_queue
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|==
operator|-
name|ETIMEDOUT
condition|)
return|return
name|err
return|;
goto|goto
name|out_out
goto|;
block|}
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"err %d, status %d\n"
argument_list|,
name|err
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|err
operator|=
name|status_to_err
argument_list|(
name|status
argument_list|)
expr_stmt|;
goto|goto
name|out_out
goto|;
block|}
if|if
condition|(
name|callback
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx5_copy_from_msg
argument_list|(
name|out
argument_list|,
name|outb
argument_list|,
name|out_size
argument_list|)
expr_stmt|;
name|out_out
label|:
name|mlx5_free_cmd_msg
argument_list|(
name|dev
argument_list|,
name|outb
argument_list|)
expr_stmt|;
name|out_in
label|:
name|free_msg
argument_list|(
name|dev
argument_list|,
name|inb
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mlx5_cmd_exec
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|in
parameter_list|,
name|int
name|in_size
parameter_list|,
name|void
modifier|*
name|out
parameter_list|,
name|int
name|out_size
parameter_list|)
block|{
return|return
name|cmd_exec_helper
argument_list|(
name|dev
argument_list|,
name|in
argument_list|,
name|in_size
argument_list|,
name|out
argument_list|,
name|out_size
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_cmd_exec
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx5_cmd_exec_cb
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|in
parameter_list|,
name|int
name|in_size
parameter_list|,
name|void
modifier|*
name|out
parameter_list|,
name|int
name|out_size
parameter_list|,
name|mlx5_cmd_cbk_t
name|callback
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
return|return
name|cmd_exec_helper
argument_list|(
name|dev
argument_list|,
name|in
argument_list|,
name|in_size
argument_list|,
name|out
argument_list|,
name|out_size
argument_list|,
name|callback
argument_list|,
name|context
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_cmd_exec_cb
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|destroy_msg_cache
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|mlx5_cmd_msg
modifier|*
name|n
decl_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|msg
argument_list|,
argument|n
argument_list|,
argument|&cmd->cache.large.head
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|msg
operator|->
name|list
argument_list|)
expr_stmt|;
name|mlx5_free_cmd_msg
argument_list|(
name|dev
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
name|list_for_each_entry_safe
argument_list|(
argument|msg
argument_list|,
argument|n
argument_list|,
argument|&cmd->cache.med.head
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|msg
operator|->
name|list
argument_list|)
expr_stmt|;
name|mlx5_free_cmd_msg
argument_list|(
name|dev
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|create_msg_cache
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|struct
name|mlx5_cmd_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|cmd
operator|->
name|cache
operator|.
name|large
operator|.
name|lock
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cmd
operator|->
name|cache
operator|.
name|large
operator|.
name|head
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|cmd
operator|->
name|cache
operator|.
name|med
operator|.
name|lock
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cmd
operator|->
name|cache
operator|.
name|med
operator|.
name|head
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_LONG_LISTS
condition|;
name|i
operator|++
control|)
block|{
name|msg
operator|=
name|mlx5_alloc_cmd_msg
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|,
name|LONG_LIST_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|msg
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|ex_err
goto|;
block|}
name|msg
operator|->
name|cache
operator|=
operator|&
name|cmd
operator|->
name|cache
operator|.
name|large
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|msg
operator|->
name|list
argument_list|,
operator|&
name|cmd
operator|->
name|cache
operator|.
name|large
operator|.
name|head
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_MED_LISTS
condition|;
name|i
operator|++
control|)
block|{
name|msg
operator|=
name|mlx5_alloc_cmd_msg
argument_list|(
name|dev
argument_list|,
name|GFP_KERNEL
argument_list|,
name|MED_LIST_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|msg
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|msg
argument_list|)
expr_stmt|;
goto|goto
name|ex_err
goto|;
block|}
name|msg
operator|->
name|cache
operator|=
operator|&
name|cmd
operator|->
name|cache
operator|.
name|med
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|msg
operator|->
name|list
argument_list|,
operator|&
name|cmd
operator|->
name|cache
operator|.
name|med
operator|.
name|head
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|ex_err
label|:
name|destroy_msg_cache
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_cmd_page
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|device
modifier|*
name|ddev
init|=
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
decl_stmt|;
name|cmd
operator|->
name|cmd_alloc_buf
operator|=
name|dma_zalloc_coherent
argument_list|(
name|ddev
argument_list|,
name|MLX5_ADAPTER_PAGE_SIZE
argument_list|,
operator|&
name|cmd
operator|->
name|alloc_dma
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cmd
operator|->
name|cmd_alloc_buf
condition|)
return|return
operator|-
name|ENOMEM
return|;
comment|/* make sure it is aligned to 4K */
if|if
condition|(
operator|!
operator|(
operator|(
name|uintptr_t
operator|)
name|cmd
operator|->
name|cmd_alloc_buf
operator|&
operator|(
name|MLX5_ADAPTER_PAGE_SIZE
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
name|cmd
operator|->
name|cmd_buf
operator|=
name|cmd
operator|->
name|cmd_alloc_buf
expr_stmt|;
name|cmd
operator|->
name|dma
operator|=
name|cmd
operator|->
name|alloc_dma
expr_stmt|;
name|cmd
operator|->
name|alloc_size
operator|=
name|MLX5_ADAPTER_PAGE_SIZE
expr_stmt|;
return|return
literal|0
return|;
block|}
name|dma_free_coherent
argument_list|(
name|ddev
argument_list|,
name|MLX5_ADAPTER_PAGE_SIZE
argument_list|,
name|cmd
operator|->
name|cmd_alloc_buf
argument_list|,
name|cmd
operator|->
name|alloc_dma
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|cmd_alloc_buf
operator|=
name|dma_zalloc_coherent
argument_list|(
name|ddev
argument_list|,
literal|2
operator|*
name|MLX5_ADAPTER_PAGE_SIZE
operator|-
literal|1
argument_list|,
operator|&
name|cmd
operator|->
name|alloc_dma
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cmd
operator|->
name|cmd_alloc_buf
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|cmd
operator|->
name|cmd_buf
operator|=
name|PTR_ALIGN
argument_list|(
name|cmd
operator|->
name|cmd_alloc_buf
argument_list|,
name|MLX5_ADAPTER_PAGE_SIZE
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|dma
operator|=
name|ALIGN
argument_list|(
name|cmd
operator|->
name|alloc_dma
argument_list|,
name|MLX5_ADAPTER_PAGE_SIZE
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|alloc_size
operator|=
literal|2
operator|*
name|MLX5_ADAPTER_PAGE_SIZE
operator|-
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_cmd_page
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_cmd
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|device
modifier|*
name|ddev
init|=
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
decl_stmt|;
name|dma_free_coherent
argument_list|(
name|ddev
argument_list|,
name|cmd
operator|->
name|alloc_size
argument_list|,
name|cmd
operator|->
name|cmd_alloc_buf
argument_list|,
name|cmd
operator|->
name|alloc_dma
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5_cmd_init
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|size
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_cmd_prot_block
argument_list|)
decl_stmt|;
name|int
name|align
init|=
name|roundup_pow_of_two
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|u32
name|cmd_h
decl_stmt|,
name|cmd_l
decl_stmt|;
name|u16
name|cmd_if_rev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cmd_if_rev
operator|=
name|cmdif_rev_get
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd_if_rev
operator|!=
name|CMD_IF_REV
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Driver cmdif rev(%d) differs from firmware's(%d)\n"
argument_list|,
name|CMD_IF_REV
argument_list|,
name|cmd_if_rev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|cmd
operator|->
name|pool
operator|=
name|pci_pool_create
argument_list|(
literal|"mlx5_cmd"
argument_list|,
name|dev
operator|->
name|pdev
argument_list|,
name|size
argument_list|,
name|align
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cmd
operator|->
name|pool
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|err
operator|=
name|alloc_cmd_page
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_pool
goto|;
name|cmd_l
operator|=
name|ioread32be
argument_list|(
operator|&
name|dev
operator|->
name|iseg
operator|->
name|cmdq_addr_l_sz
argument_list|)
operator|&
literal|0xff
expr_stmt|;
name|cmd
operator|->
name|log_sz
operator|=
name|cmd_l
operator|>>
literal|4
operator|&
literal|0xf
expr_stmt|;
name|cmd
operator|->
name|log_stride
operator|=
name|cmd_l
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
literal|1
operator|<<
name|cmd
operator|->
name|log_sz
operator|>
name|MLX5_MAX_COMMANDS
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"firmware reports too many outstanding commands %d\n"
argument_list|,
literal|1
operator|<<
name|cmd
operator|->
name|log_sz
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err_free_page
goto|;
block|}
if|if
condition|(
name|cmd
operator|->
name|log_sz
operator|+
name|cmd
operator|->
name|log_stride
operator|>
name|MLX5_ADAPTER_PAGE_SHIFT
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"command queue size overflow\n"
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err_free_page
goto|;
block|}
name|cmd
operator|->
name|checksum_disabled
operator|=
literal|1
expr_stmt|;
name|cmd
operator|->
name|max_reg_cmds
operator|=
operator|(
literal|1
operator|<<
name|cmd
operator|->
name|log_sz
operator|)
operator|-
literal|1
expr_stmt|;
name|cmd
operator|->
name|bitmask
operator|=
operator|(
literal|1
operator|<<
name|cmd
operator|->
name|max_reg_cmds
operator|)
operator|-
literal|1
expr_stmt|;
name|cmd
operator|->
name|cmdif_rev
operator|=
name|ioread32be
argument_list|(
operator|&
name|dev
operator|->
name|iseg
operator|->
name|cmdif_rev_fw_sub
argument_list|)
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|cmdif_rev
operator|>
name|CMD_IF_REV
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"driver does not support command interface version. driver %d, firmware %d\n"
argument_list|,
name|CMD_IF_REV
argument_list|,
name|cmd
operator|->
name|cmdif_rev
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOTSUPP
expr_stmt|;
goto|goto
name|err_free_page
goto|;
block|}
name|spin_lock_init
argument_list|(
operator|&
name|cmd
operator|->
name|alloc_lock
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|cmd
operator|->
name|token_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|cmd
operator|->
name|stats
argument_list|)
condition|;
name|i
operator|++
control|)
name|spin_lock_init
argument_list|(
operator|&
name|cmd
operator|->
name|stats
index|[
name|i
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|cmd
operator|->
name|sem
argument_list|,
name|cmd
operator|->
name|max_reg_cmds
argument_list|)
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|cmd
operator|->
name|pages_sem
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cmd_h
operator|=
call|(
name|u32
call|)
argument_list|(
call|(
name|u64
call|)
argument_list|(
name|cmd
operator|->
name|dma
argument_list|)
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|cmd_l
operator|=
call|(
name|u32
call|)
argument_list|(
name|cmd
operator|->
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd_l
operator|&
literal|0xfff
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"invalid command queue address\n"
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free_page
goto|;
block|}
name|iowrite32be
argument_list|(
name|cmd_h
argument_list|,
operator|&
name|dev
operator|->
name|iseg
operator|->
name|cmdq_addr_h
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|cmd_l
argument_list|,
operator|&
name|dev
operator|->
name|iseg
operator|->
name|cmdq_addr_l_sz
argument_list|)
expr_stmt|;
comment|/* Make sure firmware sees the complete address before we proceed */
name|wmb
argument_list|()
expr_stmt|;
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"descriptor at dma 0x%llx\n"
argument_list|,
call|(
name|unsigned
name|long
name|long
call|)
argument_list|(
name|cmd
operator|->
name|dma
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|mode
operator|=
name|CMD_MODE_POLLING
expr_stmt|;
name|err
operator|=
name|create_msg_cache
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"failed to create command cache\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_free_page
goto|;
block|}
name|set_wqname
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|wq
operator|=
name|create_singlethread_workqueue
argument_list|(
name|cmd
operator|->
name|wq_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cmd
operator|->
name|wq
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"failed to create command workqueue\n"
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_cache
goto|;
block|}
return|return
literal|0
return|;
name|err_cache
label|:
name|destroy_msg_cache
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_free_page
label|:
name|free_cmd_page
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|err_free_pool
label|:
name|pci_pool_destroy
argument_list|(
name|cmd
operator|->
name|pool
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_cmd_init
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx5_cmd_cleanup
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_cmd
modifier|*
name|cmd
init|=
operator|&
name|dev
operator|->
name|cmd
decl_stmt|;
name|clean_debug_files
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|cmd
operator|->
name|wq
argument_list|)
expr_stmt|;
name|destroy_msg_cache
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|free_cmd_page
argument_list|(
name|dev
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|pci_pool_destroy
argument_list|(
name|cmd
operator|->
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_cmd_cleanup
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|cmd_status_str
parameter_list|(
name|u8
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|MLX5_CMD_STAT_OK
case|:
return|return
literal|"OK"
return|;
case|case
name|MLX5_CMD_STAT_INT_ERR
case|:
return|return
literal|"internal error"
return|;
case|case
name|MLX5_CMD_STAT_BAD_OP_ERR
case|:
return|return
literal|"bad operation"
return|;
case|case
name|MLX5_CMD_STAT_BAD_PARAM_ERR
case|:
return|return
literal|"bad parameter"
return|;
case|case
name|MLX5_CMD_STAT_BAD_SYS_STATE_ERR
case|:
return|return
literal|"bad system state"
return|;
case|case
name|MLX5_CMD_STAT_BAD_RES_ERR
case|:
return|return
literal|"bad resource"
return|;
case|case
name|MLX5_CMD_STAT_RES_BUSY
case|:
return|return
literal|"resource busy"
return|;
case|case
name|MLX5_CMD_STAT_LIM_ERR
case|:
return|return
literal|"limits exceeded"
return|;
case|case
name|MLX5_CMD_STAT_BAD_RES_STATE_ERR
case|:
return|return
literal|"bad resource state"
return|;
case|case
name|MLX5_CMD_STAT_IX_ERR
case|:
return|return
literal|"bad index"
return|;
case|case
name|MLX5_CMD_STAT_NO_RES_ERR
case|:
return|return
literal|"no resources"
return|;
case|case
name|MLX5_CMD_STAT_BAD_INP_LEN_ERR
case|:
return|return
literal|"bad input length"
return|;
case|case
name|MLX5_CMD_STAT_BAD_OUTP_LEN_ERR
case|:
return|return
literal|"bad output length"
return|;
case|case
name|MLX5_CMD_STAT_BAD_QP_STATE_ERR
case|:
return|return
literal|"bad QP state"
return|;
case|case
name|MLX5_CMD_STAT_BAD_PKT_ERR
case|:
return|return
literal|"bad packet (discarded)"
return|;
case|case
name|MLX5_CMD_STAT_BAD_SIZE_OUTS_CQES_ERR
case|:
return|return
literal|"bad size too many outstanding CQEs"
return|;
default|default:
return|return
literal|"unknown status"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_status_to_err_helper
parameter_list|(
name|u8
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|MLX5_CMD_STAT_OK
case|:
return|return
literal|0
return|;
case|case
name|MLX5_CMD_STAT_INT_ERR
case|:
return|return
operator|-
name|EIO
return|;
case|case
name|MLX5_CMD_STAT_BAD_OP_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
name|MLX5_CMD_STAT_BAD_PARAM_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
name|MLX5_CMD_STAT_BAD_SYS_STATE_ERR
case|:
return|return
operator|-
name|EIO
return|;
case|case
name|MLX5_CMD_STAT_BAD_RES_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
name|MLX5_CMD_STAT_RES_BUSY
case|:
return|return
operator|-
name|EBUSY
return|;
case|case
name|MLX5_CMD_STAT_LIM_ERR
case|:
return|return
operator|-
name|ENOMEM
return|;
case|case
name|MLX5_CMD_STAT_BAD_RES_STATE_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
name|MLX5_CMD_STAT_IX_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
name|MLX5_CMD_STAT_NO_RES_ERR
case|:
return|return
operator|-
name|EAGAIN
return|;
case|case
name|MLX5_CMD_STAT_BAD_INP_LEN_ERR
case|:
return|return
operator|-
name|EIO
return|;
case|case
name|MLX5_CMD_STAT_BAD_OUTP_LEN_ERR
case|:
return|return
operator|-
name|EIO
return|;
case|case
name|MLX5_CMD_STAT_BAD_QP_STATE_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
name|MLX5_CMD_STAT_BAD_PKT_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
name|MLX5_CMD_STAT_BAD_SIZE_OUTS_CQES_ERR
case|:
return|return
operator|-
name|EINVAL
return|;
default|default:
return|return
operator|-
name|EIO
return|;
block|}
block|}
end_function

begin_comment
comment|/* this will be available till all the commands use set/get macros */
end_comment

begin_function
name|int
name|mlx5_cmd_status_to_err
parameter_list|(
name|struct
name|mlx5_outbox_hdr
modifier|*
name|hdr
parameter_list|)
block|{
if|if
condition|(
operator|!
name|hdr
operator|->
name|status
condition|)
return|return
literal|0
return|;
name|printf
argument_list|(
literal|"mlx5_core: WARN: "
literal|"command failed, status %s(0x%x), syndrome 0x%x\n"
argument_list|,
name|cmd_status_str
argument_list|(
name|hdr
operator|->
name|status
argument_list|)
argument_list|,
name|hdr
operator|->
name|status
argument_list|,
name|be32_to_cpu
argument_list|(
name|hdr
operator|->
name|syndrome
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|cmd_status_to_err_helper
argument_list|(
name|hdr
operator|->
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|mlx5_cmd_status_to_err_v2
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|u32
name|syndrome
decl_stmt|;
name|u8
name|status
decl_stmt|;
name|status
operator|=
name|be32_to_cpu
argument_list|(
operator|*
operator|(
name|__be32
operator|*
operator|)
name|ptr
argument_list|)
operator|>>
literal|24
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
return|return
literal|0
return|;
name|syndrome
operator|=
name|be32_to_cpu
argument_list|(
operator|*
operator|(
name|__be32
operator|*
operator|)
operator|(
name|ptr
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"mlx5_core: WARN: "
literal|"command failed, status %s(0x%x), syndrome 0x%x\n"
argument_list|,
name|cmd_status_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|status
argument_list|,
name|syndrome
argument_list|)
expr_stmt|;
return|return
name|cmd_status_to_err_helper
argument_list|(
name|status
argument_list|)
return|;
block|}
end_function

end_unit


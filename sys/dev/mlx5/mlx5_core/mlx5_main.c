begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013-2015, Mellanox Technologies, Ltd.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_define
define|#
directive|define
name|LINUXKPI_PARAM_PREFIX
value|mlx5_
end_define

begin_include
include|#
directive|include
file|<linux/kmod.h>
end_include

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/pci.h>
end_include

begin_include
include|#
directive|include
file|<linux/dma-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/io-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/interrupt.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/driver.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/cq.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/qp.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/srq.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/mlx5_ifc.h>
end_include

begin_include
include|#
directive|include
file|"mlx5_core.h"
end_include

begin_expr_stmt
name|MODULE_AUTHOR
argument_list|(
literal|"Eli Cohen<eli@mellanox.com>"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DESCRIPTION
argument_list|(
literal|"Mellanox Connect-IB, ConnectX-4 core driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_LICENSE
argument_list|(
literal|"Dual BSD/GPL"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100000
operator|)
end_if

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5
argument_list|,
name|linuxkpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|mlx5
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|mlx5_core_debug_mask
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|debug_mask
argument_list|,
name|mlx5_core_debug_mask
argument_list|,
name|int
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|debug_mask
argument_list|,
literal|"debug mask: 1 = dump cmd data, 2 = dump cmd exec time, 3 = both. Default=0"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|MLX5_DEFAULT_PROF
value|2
end_define

begin_decl_stmt
specifier|static
name|int
name|prof_sel
init|=
name|MLX5_DEFAULT_PROF
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|prof_sel
argument_list|,
name|prof_sel
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|prof_sel
argument_list|,
literal|"profile selector. Valid range 0 - 2"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|NUMA_NO_NODE
value|-1
end_define

begin_decl_stmt
name|struct
name|workqueue_struct
modifier|*
name|mlx5_core_wq
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|LIST_HEAD
argument_list|(
name|intf_list
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|LIST_HEAD
argument_list|(
name|dev_list
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEFINE_MUTEX
argument_list|(
name|intf_mutex
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|mlx5_device_context
block|{
name|struct
name|list_head
name|list
decl_stmt|;
name|struct
name|mlx5_interface
modifier|*
name|intf
decl_stmt|;
name|void
modifier|*
name|context
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|mlx5_profile
name|profiles
index|[]
init|=
block|{
index|[
literal|0
index|]
operator|=
block|{
operator|.
name|mask
operator|=
literal|0
block|, 	}
block|,
index|[
literal|1
index|]
operator|=
block|{
operator|.
name|mask
operator|=
name|MLX5_PROF_MASK_QP_SIZE
block|,
operator|.
name|log_max_qp
operator|=
literal|12
block|, 	}
block|,
index|[
literal|2
index|]
operator|=
block|{
operator|.
name|mask
operator|=
name|MLX5_PROF_MASK_QP_SIZE
operator||
name|MLX5_PROF_MASK_MR_CACHE
block|,
operator|.
name|log_max_qp
operator|=
literal|17
block|,
operator|.
name|mr_cache
index|[
literal|0
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|1
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|2
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|3
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|4
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|5
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|6
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|7
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|8
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|9
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|10
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|11
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|500
block|,
operator|.
name|limit
operator|=
literal|250
block|}
block|,
operator|.
name|mr_cache
index|[
literal|12
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|64
block|,
operator|.
name|limit
operator|=
literal|32
block|}
block|,
operator|.
name|mr_cache
index|[
literal|13
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|32
block|,
operator|.
name|limit
operator|=
literal|16
block|}
block|,
operator|.
name|mr_cache
index|[
literal|14
index|]
operator|=
block|{
operator|.
name|size
operator|=
literal|16
block|,
operator|.
name|limit
operator|=
literal|8
block|}
block|, 	}
block|,
index|[
literal|3
index|]
operator|=
block|{
operator|.
name|mask
operator|=
name|MLX5_PROF_MASK_QP_SIZE
block|,
operator|.
name|log_max_qp
operator|=
literal|17
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|set_dma_caps
parameter_list|(
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|pci_set_dma_mask
argument_list|(
name|pdev
argument_list|,
name|DMA_BIT_MASK
argument_list|(
literal|64
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"WARN: "
literal|"Warning: couldn't set 64-bit PCI DMA mask\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|pci_set_dma_mask
argument_list|(
name|pdev
argument_list|,
name|DMA_BIT_MASK
argument_list|(
literal|32
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Can't set PCI DMA mask, aborting\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
block|}
name|err
operator|=
name|pci_set_consistent_dma_mask
argument_list|(
name|pdev
argument_list|,
name|DMA_BIT_MASK
argument_list|(
literal|64
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"WARN: "
literal|"Warning: couldn't set 64-bit consistent PCI DMA mask\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|pci_set_consistent_dma_mask
argument_list|(
name|pdev
argument_list|,
name|DMA_BIT_MASK
argument_list|(
literal|32
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Can't set consistent PCI DMA mask, aborting\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
block|}
name|dma_set_max_seg_size
argument_list|(
operator|&
name|pdev
operator|->
name|dev
argument_list|,
literal|2u
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|request_bar
parameter_list|(
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|pci_resource_flags
argument_list|(
name|pdev
argument_list|,
literal|0
argument_list|)
operator|&
name|IORESOURCE_MEM
operator|)
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Missing registers BAR, aborting\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENODEV
return|;
block|}
name|err
operator|=
name|pci_request_regions
argument_list|(
name|pdev
argument_list|,
name|DRIVER_NAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Couldn't get PCI resources, aborting\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|release_bar
parameter_list|(
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|)
block|{
name|pci_release_regions
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_enable_msix
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_eq_table
modifier|*
name|table
init|=
operator|&
name|priv
operator|->
name|eq_table
decl_stmt|;
name|int
name|num_eqs
init|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
argument_list|,
name|log_max_eq
argument_list|)
decl_stmt|;
name|int
name|nvec
decl_stmt|;
name|int
name|i
decl_stmt|;
name|nvec
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
argument_list|,
name|num_ports
argument_list|)
operator|*
name|num_online_cpus
argument_list|()
operator|+
name|MLX5_EQ_VEC_COMP_BASE
expr_stmt|;
name|nvec
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|nvec
argument_list|,
name|num_eqs
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvec
operator|<=
name|MLX5_EQ_VEC_COMP_BASE
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|priv
operator|->
name|msix_arr
operator|=
name|kzalloc
argument_list|(
name|nvec
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|priv
operator|->
name|msix_arr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|priv
operator|->
name|irq_info
operator|=
name|kzalloc
argument_list|(
name|nvec
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|priv
operator|->
name|irq_info
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nvec
condition|;
name|i
operator|++
control|)
name|priv
operator|->
name|msix_arr
index|[
name|i
index|]
operator|.
name|entry
operator|=
name|i
expr_stmt|;
name|nvec
operator|=
name|pci_enable_msix_range
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
name|priv
operator|->
name|msix_arr
argument_list|,
name|MLX5_EQ_VEC_COMP_BASE
operator|+
literal|1
argument_list|,
name|nvec
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvec
operator|<
literal|0
condition|)
return|return
name|nvec
return|;
name|table
operator|->
name|num_comp_vectors
operator|=
name|nvec
operator|-
name|MLX5_EQ_VEC_COMP_BASE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_disable_msix
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|pci_disable_msix
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|irq_info
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|msix_arr
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|mlx5_reg_host_endianess
block|{
name|u8
name|he
decl_stmt|;
name|u8
name|rsvd
index|[
literal|15
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|CAP_MASK
parameter_list|(
name|pos
parameter_list|,
name|size
parameter_list|)
value|((u64)((1<< (size)) - 1)<< (pos))
end_define

begin_enum
enum|enum
block|{
name|MLX5_CAP_BITS_RW_MASK
init|=
name|CAP_MASK
argument_list|(
name|MLX5_CAP_OFF_CMDIF_CSUM
argument_list|,
literal|2
argument_list|)
operator||
name|MLX5_DEV_CAP_FLAG_DCT
operator||
name|MLX5_DEV_CAP_FLAG_DRAIN_SIGERR
block|, }
enum|;
end_enum

begin_function
specifier|static
name|u16
name|to_fw_pkey_sz
parameter_list|(
name|u32
name|size
parameter_list|)
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|128
case|:
return|return
literal|0
return|;
case|case
literal|256
case|:
return|return
literal|1
return|;
case|case
literal|512
case|:
return|return
literal|2
return|;
case|case
literal|1024
case|:
return|return
literal|3
return|;
case|case
literal|2048
case|:
return|return
literal|4
return|;
case|case
literal|4096
case|:
return|return
literal|5
return|;
default|default:
name|printf
argument_list|(
literal|"mlx5_core: WARN: "
literal|"invalid pkey table size %d\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|int
name|mlx5_core_get_caps
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|enum
name|mlx5_cap_type
name|cap_type
parameter_list|,
name|enum
name|mlx5_cap_mode
name|cap_mode
parameter_list|)
block|{
name|u8
name|in
index|[
name|MLX5_ST_SZ_BYTES
argument_list|(
name|query_hca_cap_in
argument_list|)
index|]
decl_stmt|;
name|int
name|out_sz
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|query_hca_cap_out
argument_list|)
decl_stmt|;
name|void
modifier|*
name|out
decl_stmt|,
modifier|*
name|hca_caps
decl_stmt|;
name|u16
name|opmod
init|=
operator|(
name|cap_type
operator|<<
literal|1
operator|)
operator||
operator|(
name|cap_mode
operator|&
literal|0x01
operator|)
decl_stmt|;
name|int
name|err
decl_stmt|;
name|memset
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|out
operator|=
name|kzalloc
argument_list|(
name|out_sz
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|query_hca_cap_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_QUERY_HCA_CAP
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|query_hca_cap_in
argument_list|,
name|in
argument_list|,
name|op_mod
argument_list|,
name|opmod
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_cmd_exec
argument_list|(
name|dev
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|out
argument_list|,
name|out_sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|query_ex
goto|;
name|err
operator|=
name|mlx5_cmd_status_to_err_v2
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"QUERY_HCA_CAP : type(%x) opmode(%x) Failed(%d)\n"
argument_list|,
name|cap_type
argument_list|,
name|cap_mode
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|query_ex
goto|;
block|}
name|hca_caps
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|query_hca_cap_out
argument_list|,
name|out
argument_list|,
name|capability
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cap_mode
condition|)
block|{
case|case
name|HCA_CAP_OPMOD_GET_MAX
case|:
name|memcpy
argument_list|(
name|dev
operator|->
name|hca_caps_max
index|[
name|cap_type
index|]
argument_list|,
name|hca_caps
argument_list|,
name|MLX5_UN_SZ_BYTES
argument_list|(
name|hca_cap_union
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|HCA_CAP_OPMOD_GET_CUR
case|:
name|memcpy
argument_list|(
name|dev
operator|->
name|hca_caps_cur
index|[
name|cap_type
index|]
argument_list|,
name|hca_caps
argument_list|,
name|MLX5_UN_SZ_BYTES
argument_list|(
name|hca_cap_union
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"Tried to query dev cap type(%x) with wrong opmode(%x)\n"
argument_list|,
name|cap_type
argument_list|,
name|cap_mode
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
name|query_ex
label|:
name|kfree
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_caps
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|in
parameter_list|,
name|int
name|in_sz
parameter_list|)
block|{
name|u32
name|out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|set_hca_cap_out
argument_list|)
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|memset
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|set_hca_cap_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_SET_HCA_CAP
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_cmd_exec
argument_list|(
name|dev
argument_list|,
name|in
argument_list|,
name|in_sz
argument_list|,
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx5_cmd_status_to_err_v2
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_hca_cap
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|void
modifier|*
name|set_ctx
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_profile
modifier|*
name|prof
init|=
name|dev
operator|->
name|profile
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOMEM
decl_stmt|;
name|int
name|set_sz
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|set_hca_cap_in
argument_list|)
decl_stmt|;
name|void
modifier|*
name|set_hca_cap
decl_stmt|;
name|set_ctx
operator|=
name|kzalloc
argument_list|(
name|set_sz
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_get_caps
argument_list|(
name|dev
argument_list|,
name|MLX5_CAP_GENERAL
argument_list|,
name|HCA_CAP_OPMOD_GET_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|query_ex
goto|;
name|err
operator|=
name|mlx5_core_get_caps
argument_list|(
name|dev
argument_list|,
name|MLX5_CAP_GENERAL
argument_list|,
name|HCA_CAP_OPMOD_GET_CUR
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|query_ex
goto|;
name|set_hca_cap
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|set_hca_cap_in
argument_list|,
name|set_ctx
argument_list|,
name|capability
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|set_hca_cap
argument_list|,
name|dev
operator|->
name|hca_caps_cur
index|[
name|MLX5_CAP_GENERAL
index|]
argument_list|,
name|MLX5_ST_SZ_BYTES
argument_list|(
name|cmd_hca_cap
argument_list|)
argument_list|)
expr_stmt|;
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"Current Pkey table size %d Setting new size %d\n"
argument_list|,
name|mlx5_to_sw_pkey_sz
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
argument_list|,
name|pkey_table_size
argument_list|)
argument_list|)
argument_list|,
literal|128
argument_list|)
expr_stmt|;
comment|/* we limit the size of the pkey table to 128 entries for now */
name|MLX5_SET
argument_list|(
name|cmd_hca_cap
argument_list|,
name|set_hca_cap
argument_list|,
name|pkey_table_size
argument_list|,
name|to_fw_pkey_sz
argument_list|(
literal|128
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prof
operator|->
name|mask
operator|&
name|MLX5_PROF_MASK_QP_SIZE
condition|)
name|MLX5_SET
argument_list|(
name|cmd_hca_cap
argument_list|,
name|set_hca_cap
argument_list|,
name|log_max_qp
argument_list|,
name|prof
operator|->
name|log_max_qp
argument_list|)
expr_stmt|;
comment|/* disable cmdif checksum */
name|MLX5_SET
argument_list|(
name|cmd_hca_cap
argument_list|,
name|set_hca_cap
argument_list|,
name|cmdif_checksum
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* enable drain sigerr */
name|MLX5_SET
argument_list|(
name|cmd_hca_cap
argument_list|,
name|set_hca_cap
argument_list|,
name|drain_sigerr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cmd_hca_cap
argument_list|,
name|set_hca_cap
argument_list|,
name|log_uar_page_sz
argument_list|,
name|PAGE_SHIFT
operator|-
literal|12
argument_list|)
expr_stmt|;
name|err
operator|=
name|set_caps
argument_list|(
name|dev
argument_list|,
name|set_ctx
argument_list|,
name|set_sz
argument_list|)
expr_stmt|;
name|query_ex
label|:
name|kfree
argument_list|(
name|set_ctx
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_hca_ctrl
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_reg_host_endianess
name|he_in
decl_stmt|;
name|struct
name|mlx5_reg_host_endianess
name|he_out
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
argument_list|,
name|port_type
argument_list|)
operator|==
name|MLX5_CAP_PORT_TYPE_ETH
operator|&&
operator|!
name|MLX5_CAP_GEN
argument_list|(
name|dev
argument_list|,
name|roce
argument_list|)
condition|)
return|return
literal|0
return|;
name|memset
argument_list|(
operator|&
name|he_in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|he_in
argument_list|)
argument_list|)
expr_stmt|;
name|he_in
operator|.
name|he
operator|=
name|MLX5_SET_HOST_ENDIANNESS
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_reg
argument_list|(
name|dev
argument_list|,
operator|&
name|he_in
argument_list|,
sizeof|sizeof
argument_list|(
name|he_in
argument_list|)
argument_list|,
operator|&
name|he_out
argument_list|,
sizeof|sizeof
argument_list|(
name|he_out
argument_list|)
argument_list|,
name|MLX5_REG_HOST_ENDIANNESS
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_core_enable_hca
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|u32
name|in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|enable_hca_in
argument_list|)
index|]
decl_stmt|;
name|u32
name|out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|enable_hca_out
argument_list|)
index|]
decl_stmt|;
name|memset
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|enable_hca_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_ENABLE_HCA
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|mlx5_cmd_exec_check_status
argument_list|(
name|dev
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_core_disable_hca
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|u32
name|in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|disable_hca_in
argument_list|)
index|]
decl_stmt|;
name|u32
name|out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|disable_hca_out
argument_list|)
index|]
decl_stmt|;
name|memset
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|disable_hca_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_DISABLE_HCA
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|mlx5_cmd_exec_check_status
argument_list|(
name|dev
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_core_set_issi
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|u32
name|query_in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|query_issi_in
argument_list|)
index|]
decl_stmt|;
name|u32
name|query_out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|query_issi_out
argument_list|)
index|]
decl_stmt|;
name|u32
name|set_in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|set_issi_in
argument_list|)
index|]
decl_stmt|;
name|u32
name|set_out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|set_issi_out
argument_list|)
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|sup_issi
decl_stmt|;
name|memset
argument_list|(
name|query_in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|query_in
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|query_out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|query_out
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|query_issi_in
argument_list|,
name|query_in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_QUERY_ISSI
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_cmd_exec_check_status
argument_list|(
name|dev
argument_list|,
name|query_in
argument_list|,
sizeof|sizeof
argument_list|(
name|query_in
argument_list|)
argument_list|,
name|query_out
argument_list|,
sizeof|sizeof
argument_list|(
name|query_out
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
operator|(
operator|(
expr|struct
name|mlx5_outbox_hdr
operator|*
operator|)
name|query_out
operator|)
operator|->
name|status
operator|==
name|MLX5_CMD_STAT_BAD_OP_ERR
condition|)
block|{
name|pr_debug
argument_list|(
literal|"Only ISSI 0 is supported\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|printf
argument_list|(
literal|"mlx5_core: ERR: "
literal|"failed to query ISSI\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|sup_issi
operator|=
name|MLX5_GET
argument_list|(
name|query_issi_out
argument_list|,
name|query_out
argument_list|,
name|supported_issi_dw0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sup_issi
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
condition|)
block|{
name|memset
argument_list|(
name|set_in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|set_in
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|set_out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|set_out
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|set_issi_in
argument_list|,
name|set_in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_SET_ISSI
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|set_issi_in
argument_list|,
name|set_in
argument_list|,
name|current_issi
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_cmd_exec_check_status
argument_list|(
name|dev
argument_list|,
name|set_in
argument_list|,
sizeof|sizeof
argument_list|(
name|set_in
argument_list|)
argument_list|,
name|set_out
argument_list|,
sizeof|sizeof
argument_list|(
name|set_out
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|printf
argument_list|(
literal|"mlx5_core: ERR: "
literal|"failed to set ISSI=1\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|dev
operator|->
name|issi
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|sup_issi
operator|&
operator|(
literal|1
operator|<<
literal|0
operator|)
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
operator|-
name|ENOTSUPP
return|;
block|}
end_function

begin_function
name|int
name|mlx5_vector2eqn
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|int
name|vector
parameter_list|,
name|int
modifier|*
name|eqn
parameter_list|,
name|int
modifier|*
name|irqn
parameter_list|)
block|{
name|struct
name|mlx5_eq_table
modifier|*
name|table
init|=
operator|&
name|dev
operator|->
name|priv
operator|.
name|eq_table
decl_stmt|;
name|struct
name|mlx5_eq
modifier|*
name|eq
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOENT
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|eq
argument_list|,
argument|&table->comp_eqs_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|eq
operator|->
name|index
operator|==
name|vector
condition|)
block|{
operator|*
name|eqn
operator|=
name|eq
operator|->
name|eqn
expr_stmt|;
operator|*
name|irqn
operator|=
name|eq
operator|->
name|irqn
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|spin_unlock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_vector2eqn
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|int
name|mlx5_rename_eq
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|int
name|eq_ix
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_eq_table
modifier|*
name|table
init|=
operator|&
name|priv
operator|->
name|eq_table
decl_stmt|;
name|struct
name|mlx5_eq
modifier|*
name|eq
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOENT
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|eq
argument_list|,
argument|&table->comp_eqs_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|eq
operator|->
name|index
operator|==
name|eq_ix
condition|)
block|{
name|int
name|irq_ix
init|=
name|eq_ix
operator|+
name|MLX5_EQ_VEC_COMP_BASE
decl_stmt|;
name|snprintf
argument_list|(
name|priv
operator|->
name|irq_info
index|[
name|irq_ix
index|]
operator|.
name|name
argument_list|,
name|MLX5_MAX_IRQ_NAME
argument_list|,
literal|"%s-%d"
argument_list|,
name|name
argument_list|,
name|eq_ix
argument_list|)
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|spin_unlock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_comp_eqs
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_eq_table
modifier|*
name|table
init|=
operator|&
name|dev
operator|->
name|priv
operator|.
name|eq_table
decl_stmt|;
name|struct
name|mlx5_eq
modifier|*
name|eq
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|eq
argument_list|,
argument|n
argument_list|,
argument|&table->comp_eqs_list
argument_list|,
argument|list
argument_list|)
block|{
name|list_del
argument_list|(
operator|&
name|eq
operator|->
name|list
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_destroy_unmap_eq
argument_list|(
name|dev
argument_list|,
name|eq
argument_list|)
condition|)
name|mlx5_core_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to destroy EQ 0x%x\n"
argument_list|,
name|eq
operator|->
name|eqn
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|eq
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_comp_eqs
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_eq_table
modifier|*
name|table
init|=
operator|&
name|dev
operator|->
name|priv
operator|.
name|eq_table
decl_stmt|;
name|char
name|name
index|[
name|MLX5_MAX_IRQ_NAME
index|]
decl_stmt|;
name|struct
name|mlx5_eq
modifier|*
name|eq
decl_stmt|;
name|int
name|ncomp_vec
decl_stmt|;
name|int
name|nent
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|table
operator|->
name|comp_eqs_list
argument_list|)
expr_stmt|;
name|ncomp_vec
operator|=
name|table
operator|->
name|num_comp_vectors
expr_stmt|;
name|nent
operator|=
name|MLX5_COMP_EQ_SIZE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ncomp_vec
condition|;
name|i
operator|++
control|)
block|{
name|eq
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|eq
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
name|MLX5_MAX_IRQ_NAME
argument_list|,
literal|"mlx5_comp%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_create_map_eq
argument_list|(
name|dev
argument_list|,
name|eq
argument_list|,
name|i
operator|+
name|MLX5_EQ_VEC_COMP_BASE
argument_list|,
name|nent
argument_list|,
literal|0
argument_list|,
name|name
argument_list|,
operator|&
name|dev
operator|->
name|priv
operator|.
name|uuari
operator|.
name|uars
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|kfree
argument_list|(
name|eq
argument_list|)
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|mlx5_core_dbg
argument_list|(
name|dev
argument_list|,
literal|"allocated completion EQN %d\n"
argument_list|,
name|eq
operator|->
name|eqn
argument_list|)
expr_stmt|;
name|eq
operator|->
name|index
operator|=
name|i
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|eq
operator|->
name|list
argument_list|,
operator|&
name|table
operator|->
name|comp_eqs_list
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|clean
label|:
name|free_comp_eqs
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|map_bf_area
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|resource_size_t
name|bf_start
init|=
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|resource_size_t
name|bf_len
init|=
name|pci_resource_len
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|dev
operator|->
name|priv
operator|.
name|bf_mapping
operator|=
name|io_mapping_create_wc
argument_list|(
name|bf_start
argument_list|,
name|bf_len
argument_list|)
expr_stmt|;
return|return
name|dev
operator|->
name|priv
operator|.
name|bf_mapping
condition|?
literal|0
else|:
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|unmap_bf_area
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|priv
operator|.
name|bf_mapping
condition|)
name|io_mapping_free
argument_list|(
name|dev
operator|->
name|priv
operator|.
name|bf_mapping
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|fw_initializing
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
return|return
name|ioread32be
argument_list|(
operator|&
name|dev
operator|->
name|iseg
operator|->
name|initializing
argument_list|)
operator|>>
literal|31
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wait_fw_init
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|max_wait_mili
parameter_list|)
block|{
name|u64
name|end
init|=
name|jiffies
operator|+
name|msecs_to_jiffies
argument_list|(
name|max_wait_mili
argument_list|)
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|fw_initializing
argument_list|(
name|dev
argument_list|)
condition|)
block|{
if|if
condition|(
name|time_after
argument_list|(
name|jiffies
argument_list|,
name|end
argument_list|)
condition|)
block|{
name|err
operator|=
operator|-
name|EBUSY
expr_stmt|;
break|break;
block|}
name|msleep
argument_list|(
name|FW_INIT_WAIT_MS
argument_list|)
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_dev_init
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|int
name|err
decl_stmt|;
name|dev
operator|->
name|pdev
operator|=
name|pdev
expr_stmt|;
name|pci_set_drvdata
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|priv
operator|->
name|name
argument_list|,
name|dev_name
argument_list|(
operator|&
name|pdev
operator|->
name|dev
argument_list|)
argument_list|,
name|MLX5_MAX_NAME_LEN
argument_list|)
expr_stmt|;
name|priv
operator|->
name|name
index|[
name|MLX5_MAX_NAME_LEN
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|priv
operator|->
name|pgdir_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|pgdir_list
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|mkey_lock
argument_list|)
expr_stmt|;
name|priv
operator|->
name|numa_node
operator|=
name|NUMA_NO_NODE
expr_stmt|;
name|err
operator|=
name|pci_enable_device
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Cannot enable PCI device, aborting\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_dbg
goto|;
block|}
name|err
operator|=
name|request_bar
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"error requesting BARs, aborting\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_disable
goto|;
block|}
name|pci_set_master
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
name|err
operator|=
name|set_dma_caps
argument_list|(
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Failed setting DMA capabilities mask, aborting\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_clr_master
goto|;
block|}
name|dev
operator|->
name|iseg
operator|=
name|ioremap
argument_list|(
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|pdev
argument_list|,
literal|0
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dev
operator|->
name|iseg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|iseg
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Failed mapping initialization segment, aborting\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_clr_master
goto|;
block|}
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"INFO: "
literal|"firmware version: %d.%d.%d\n"
argument_list|,
name|fw_rev_maj
argument_list|(
name|dev
argument_list|)
argument_list|,
name|fw_rev_min
argument_list|(
name|dev
argument_list|)
argument_list|,
name|fw_rev_sub
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * On load removing any previous indication of internal error, 	 * device is up 	 */
name|dev
operator|->
name|state
operator|=
name|MLX5_DEVICE_STATE_UP
expr_stmt|;
name|err
operator|=
name|mlx5_cmd_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Failed initializing command interface, aborting\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_unmap
goto|;
block|}
name|err
operator|=
name|wait_fw_init
argument_list|(
name|dev
argument_list|,
name|FW_INIT_TIMEOUT_MILI
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Firmware over %d MS in initializing state, aborting\n"
argument_list|,
name|FW_INIT_TIMEOUT_MILI
argument_list|)
expr_stmt|;
goto|goto
name|err_cmd_cleanup
goto|;
block|}
name|mlx5_pagealloc_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_enable_hca
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"enable hca failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_pagealloc_cleanup
goto|;
block|}
name|err
operator|=
name|mlx5_core_set_issi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"failed to set issi\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_disable_hca
goto|;
block|}
name|err
operator|=
name|mlx5_pagealloc_start
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"mlx5_pagealloc_start failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_disable_hca
goto|;
block|}
name|err
operator|=
name|mlx5_satisfy_startup_pages
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"failed to allocate boot pages\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_pagealloc_stop
goto|;
block|}
name|err
operator|=
name|handle_hca_cap
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"handle_hca_cap failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|reclaim_boot_pages
goto|;
block|}
name|err
operator|=
name|set_hca_ctrl
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"set_hca_ctrl failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|reclaim_boot_pages
goto|;
block|}
name|err
operator|=
name|mlx5_satisfy_startup_pages
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"failed to allocate init pages\n"
argument_list|)
expr_stmt|;
goto|goto
name|reclaim_boot_pages
goto|;
block|}
name|err
operator|=
name|mlx5_cmd_init_hca
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"init hca failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|reclaim_boot_pages
goto|;
block|}
name|mlx5_start_health_poll
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_query_hca_caps
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"query hca failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_stop_poll
goto|;
block|}
name|err
operator|=
name|mlx5_query_board_id
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"query board id failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_stop_poll
goto|;
block|}
name|err
operator|=
name|mlx5_enable_msix
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"enable msix failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_stop_poll
goto|;
block|}
name|err
operator|=
name|mlx5_eq_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"failed to initialize eq\n"
argument_list|)
expr_stmt|;
goto|goto
name|disable_msix
goto|;
block|}
name|err
operator|=
name|mlx5_alloc_uuars
argument_list|(
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|uuari
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Failed allocating uar, aborting\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_eq_cleanup
goto|;
block|}
name|err
operator|=
name|mlx5_start_eqs
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Failed to start pages and async EQs\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_free_uar
goto|;
block|}
name|err
operator|=
name|alloc_comp_eqs
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Failed to alloc completion EQs\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_stop_eqs
goto|;
block|}
if|if
condition|(
name|map_bf_area
argument_list|(
name|dev
argument_list|)
condition|)
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"Failed to map blue flame area\n"
argument_list|)
expr_stmt|;
name|MLX5_INIT_DOORBELL_LOCK
argument_list|(
operator|&
name|priv
operator|->
name|cq_uar_lock
argument_list|)
expr_stmt|;
name|mlx5_init_cq_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_init_qp_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_init_srq_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_init_mr_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_stop_eqs
label|:
name|mlx5_stop_eqs
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_free_uar
label|:
name|mlx5_free_uuars
argument_list|(
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|uuari
argument_list|)
expr_stmt|;
name|err_eq_cleanup
label|:
name|mlx5_eq_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|disable_msix
label|:
name|mlx5_disable_msix
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_stop_poll
label|:
name|mlx5_stop_health_poll
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_cmd_teardown_hca
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"tear_down_hca failed, skip cleanup\n"
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|reclaim_boot_pages
label|:
name|mlx5_reclaim_startup_pages
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_pagealloc_stop
label|:
name|mlx5_pagealloc_stop
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_disable_hca
label|:
name|mlx5_core_disable_hca
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_pagealloc_cleanup
label|:
name|mlx5_pagealloc_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_cmd_cleanup
label|:
name|mlx5_cmd_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_unmap
label|:
name|iounmap
argument_list|(
name|dev
operator|->
name|iseg
argument_list|)
expr_stmt|;
name|err_clr_master
label|:
name|pci_clear_master
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
expr_stmt|;
name|release_bar
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
expr_stmt|;
name|err_disable
label|:
name|pci_disable_device
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
expr_stmt|;
name|err_dbg
label|:
name|dev
operator|->
name|state
operator|=
name|MLX5_DEVICE_STATE_INTERNAL_ERROR
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_dev_cleanup
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|mlx5_cleanup_mr_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_cleanup_srq_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_cleanup_qp_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_cleanup_cq_table
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|unmap_bf_area
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_wait_for_reclaim_vfs_pages
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|free_comp_eqs
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_stop_eqs
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_free_uuars
argument_list|(
name|dev
argument_list|,
operator|&
name|priv
operator|->
name|uuari
argument_list|)
expr_stmt|;
name|mlx5_eq_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_disable_msix
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_stop_health_poll
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_cmd_teardown_hca
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|dev
operator|->
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"tear_down_hca failed, skip cleanup\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mlx5_pagealloc_stop
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_reclaim_startup_pages
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_core_disable_hca
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_pagealloc_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_cmd_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|iounmap
argument_list|(
name|dev
operator|->
name|iseg
argument_list|)
expr_stmt|;
name|pci_clear_master
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
expr_stmt|;
name|release_bar
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
expr_stmt|;
name|pci_disable_device
argument_list|(
name|dev
operator|->
name|pdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_add_device
parameter_list|(
name|struct
name|mlx5_interface
modifier|*
name|intf
parameter_list|,
name|struct
name|mlx5_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5_device_context
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|priv
argument_list|,
expr|struct
name|mlx5_core_dev
argument_list|,
name|priv
argument_list|)
decl_stmt|;
name|dev_ctx
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dev_ctx
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|dev_ctx
operator|->
name|intf
operator|=
name|intf
expr_stmt|;
name|dev_ctx
operator|->
name|context
operator|=
name|intf
operator|->
name|add
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_ctx
operator|->
name|context
condition|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|dev_ctx
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|ctx_list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|kfree
argument_list|(
name|dev_ctx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_remove_device
parameter_list|(
name|struct
name|mlx5_interface
modifier|*
name|intf
parameter_list|,
name|struct
name|mlx5_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5_device_context
modifier|*
name|dev_ctx
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|priv
argument_list|,
expr|struct
name|mlx5_core_dev
argument_list|,
name|priv
argument_list|)
decl_stmt|;
name|list_for_each_entry
argument_list|(
argument|dev_ctx
argument_list|,
argument|&priv->ctx_list
argument_list|,
argument|list
argument_list|)
if|if
condition|(
name|dev_ctx
operator|->
name|intf
operator|==
name|intf
condition|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|dev_ctx
operator|->
name|list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|)
expr_stmt|;
name|intf
operator|->
name|remove
argument_list|(
name|dev
argument_list|,
name|dev_ctx
operator|->
name|context
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dev_ctx
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_register_device
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_interface
modifier|*
name|intf
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|priv
operator|->
name|dev_list
argument_list|,
operator|&
name|dev_list
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|intf
argument_list|,
argument|&intf_list
argument_list|,
argument|list
argument_list|)
name|mlx5_add_device
argument_list|(
name|intf
argument_list|,
name|priv
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_unregister_device
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_interface
modifier|*
name|intf
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|intf
argument_list|,
argument|&intf_list
argument_list|,
argument|list
argument_list|)
name|mlx5_remove_device
argument_list|(
name|intf
argument_list|,
name|priv
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|priv
operator|->
name|dev_list
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5_register_interface
parameter_list|(
name|struct
name|mlx5_interface
modifier|*
name|intf
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
decl_stmt|;
if|if
condition|(
operator|!
name|intf
operator|->
name|add
operator|||
operator|!
name|intf
operator|->
name|remove
condition|)
return|return
operator|-
name|EINVAL
return|;
name|mutex_lock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|intf
operator|->
name|list
argument_list|,
operator|&
name|intf_list
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|priv
argument_list|,
argument|&dev_list
argument_list|,
argument|dev_list
argument_list|)
name|mlx5_add_device
argument_list|(
name|intf
argument_list|,
name|priv
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_register_interface
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx5_unregister_interface
parameter_list|(
name|struct
name|mlx5_interface
modifier|*
name|intf
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|priv
argument_list|,
argument|&dev_list
argument_list|,
argument|dev_list
argument_list|)
name|mlx5_remove_device
argument_list|(
name|intf
argument_list|,
name|priv
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|intf
operator|->
name|list
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|intf_mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_unregister_interface
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
modifier|*
name|mlx5_get_protocol_dev
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|,
name|int
name|protocol
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|mdev
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_device_context
modifier|*
name|dev_ctx
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|void
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|dev_ctx
argument_list|,
argument|&mdev->priv.ctx_list
argument_list|,
argument|list
argument_list|)
if|if
condition|(
operator|(
name|dev_ctx
operator|->
name|intf
operator|->
name|protocol
operator|==
name|protocol
operator|)
operator|&&
name|dev_ctx
operator|->
name|intf
operator|->
name|get_dev
condition|)
block|{
name|result
operator|=
name|dev_ctx
operator|->
name|intf
operator|->
name|get_dev
argument_list|(
name|dev_ctx
operator|->
name|context
argument_list|)
expr_stmt|;
break|break;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_get_protocol_dev
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|mlx5_core_event
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|enum
name|mlx5_dev_event
name|event
parameter_list|,
name|unsigned
name|long
name|param
parameter_list|)
block|{
name|struct
name|mlx5_priv
modifier|*
name|priv
init|=
operator|&
name|dev
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_device_context
modifier|*
name|dev_ctx
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|dev_ctx
argument_list|,
argument|&priv->ctx_list
argument_list|,
argument|list
argument_list|)
if|if
condition|(
name|dev_ctx
operator|->
name|intf
operator|->
name|event
condition|)
name|dev_ctx
operator|->
name|intf
operator|->
name|event
argument_list|(
name|dev
argument_list|,
name|dev_ctx
operator|->
name|context
argument_list|,
name|event
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|mlx5_core_event_handler
block|{
name|void
function_decl|(
modifier|*
name|event
function_decl|)
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|enum
name|mlx5_dev_event
name|event
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|init_one
parameter_list|(
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|,
specifier|const
name|struct
name|pci_device_id
modifier|*
name|id
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|dev
decl_stmt|;
name|struct
name|mlx5_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|err
decl_stmt|;
name|dev
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dev
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|priv
operator|=
operator|&
name|dev
operator|->
name|priv
expr_stmt|;
if|if
condition|(
name|id
condition|)
name|priv
operator|->
name|pci_dev_data
operator|=
name|id
operator|->
name|driver_data
expr_stmt|;
if|if
condition|(
name|prof_sel
operator|<
literal|0
operator|||
name|prof_sel
operator|>=
name|ARRAY_SIZE
argument_list|(
name|profiles
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"mlx5_core: WARN: "
literal|"selected profile out of range, selecting default (%d)\n"
argument_list|,
name|MLX5_DEFAULT_PROF
argument_list|)
expr_stmt|;
name|prof_sel
operator|=
name|MLX5_DEFAULT_PROF
expr_stmt|;
block|}
name|dev
operator|->
name|profile
operator|=
operator|&
name|profiles
index|[
name|prof_sel
index|]
expr_stmt|;
name|dev
operator|->
name|event
operator|=
name|mlx5_core_event
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|ctx_list
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|ctx_lock
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_dev_init
argument_list|(
name|dev
argument_list|,
name|pdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"mlx5_dev_init failed %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|err
operator|=
name|mlx5_register_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
operator|(
operator|&
name|pdev
operator|->
name|dev
operator|)
operator|->
name|bsddev
argument_list|,
literal|"ERR: "
literal|"mlx5_register_device failed %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|out_init
goto|;
block|}
return|return
literal|0
return|;
name|out_init
label|:
name|mlx5_dev_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|out
label|:
name|kfree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|remove_one
parameter_list|(
name|struct
name|pci_dev
modifier|*
name|pdev
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|dev
init|=
name|pci_get_drvdata
argument_list|(
name|pdev
argument_list|)
decl_stmt|;
name|mlx5_unregister_device
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_dev_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|pci_device_id
name|mlx5_core_pci_table
index|[]
init|=
block|{
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4113
argument_list|)
block|}
block|,
comment|/* Connect-IB */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4114
argument_list|)
block|}
block|,
comment|/* Connect-IB VF */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4115
argument_list|)
block|}
block|,
comment|/* ConnectX-4 */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4116
argument_list|)
block|}
block|,
comment|/* ConnectX-4 VF */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4117
argument_list|)
block|}
block|,
comment|/* ConnectX-4LX */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4118
argument_list|)
block|}
block|,
comment|/* ConnectX-4LX VF */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4119
argument_list|)
block|}
block|,
comment|/* ConnectX-5 */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4120
argument_list|)
block|}
block|,
comment|/* ConnectX-5 VF */
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4121
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4122
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4123
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4124
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4125
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4126
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4127
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4128
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4129
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4130
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4131
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4132
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4133
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4134
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4135
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4136
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4137
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4138
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4139
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4140
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4141
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4142
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4143
argument_list|)
block|}
block|,
block|{
name|PCI_VDEVICE
argument_list|(
argument|MELLANOX
argument_list|,
literal|4144
argument_list|)
block|}
block|,
block|{
literal|0
block|, }
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MODULE_DEVICE_TABLE
argument_list|(
name|pci
argument_list|,
name|mlx5_core_pci_table
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|pci_driver
name|mlx5_core_driver
init|=
block|{
operator|.
name|name
operator|=
name|DRIVER_NAME
block|,
operator|.
name|id_table
operator|=
name|mlx5_core_pci_table
block|,
operator|.
name|probe
operator|=
name|init_one
block|,
operator|.
name|remove
operator|=
name|remove_one
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|__init
name|init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|mlx5_core_wq
operator|=
name|create_singlethread_workqueue
argument_list|(
literal|"mlx5_core_wq"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mlx5_core_wq
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_debug
goto|;
block|}
name|mlx5_health_init
argument_list|()
expr_stmt|;
name|err
operator|=
name|pci_register_driver
argument_list|(
operator|&
name|mlx5_core_driver
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_health
goto|;
return|return
literal|0
return|;
name|err_health
label|:
name|mlx5_health_cleanup
argument_list|()
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|mlx5_core_wq
argument_list|)
expr_stmt|;
name|err_debug
label|:
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__exit
name|cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|pci_unregister_driver
argument_list|(
operator|&
name|mlx5_core_driver
argument_list|)
expr_stmt|;
name|mlx5_health_cleanup
argument_list|()
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|mlx5_core_wq
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|module_init
argument_list|(
name|init
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_exit
argument_list|(
name|cleanup
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|mlx5_enter_error_state
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|state
operator|!=
name|MLX5_DEVICE_STATE_UP
condition|)
return|return;
name|dev
operator|->
name|state
operator|=
name|MLX5_DEVICE_STATE_INTERNAL_ERROR
expr_stmt|;
name|mlx5_trigger_cmd_completions
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|mlx5_enter_error_state
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Mellanox Technologies. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockopt.h>
end_include

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
end_if

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<netinet/tcp_var.h>
end_include

begin_include
include|#
directive|include
file|"tcp_tlro.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|M_HASHTYPE_LRO_TCP
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|KLD_MODULE
end_ifndef

begin_warning
warning|#
directive|warning
literal|"M_HASHTYPE_LRO_TCP is not defined"
end_warning

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|M_HASHTYPE_LRO_TCP
value|254
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
specifier|static
name|SYSCTL_NODE
argument_list|(
name|_net_inet_tcp
argument_list|,
name|OID_AUTO
argument_list|,
name|tlro
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"TCP turbo LRO parameters"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_TLRO
argument_list|,
literal|"TLRO"
argument_list|,
literal|"Turbo LRO"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|tlro_min_rate
init|=
literal|20
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Hz */
end_comment

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_net_inet_tcp_tlro
argument_list|,
name|OID_AUTO
argument_list|,
name|min_rate
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|tlro_min_rate
argument_list|,
literal|0
argument_list|,
literal|"Minimum serving rate in Hz"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|tlro_max_packet
init|=
name|IP_MAXPACKET
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_net_inet_tcp_tlro
argument_list|,
name|OID_AUTO
argument_list|,
name|max_packet
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|tlro_max_packet
argument_list|,
literal|0
argument_list|,
literal|"Maximum packet size in bytes"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_typedef
typedef|typedef
struct|struct
block|{
name|uint32_t
name|value
decl_stmt|;
block|}
name|__packed
name|uint32_p_t
typedef|;
end_typedef

begin_function
specifier|static
name|uint16_t
name|tcp_tlro_csum
parameter_list|(
specifier|const
name|uint32_p_t
modifier|*
name|p
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
specifier|const
name|uint32_p_t
modifier|*
name|pend
init|=
name|p
operator|+
operator|(
name|l
operator|/
literal|4
operator|)
decl_stmt|;
name|uint64_t
name|cs
decl_stmt|;
for|for
control|(
name|cs
operator|=
literal|0
init|;
name|p
operator|!=
name|pend
condition|;
name|p
operator|++
control|)
name|cs
operator|+=
name|le32toh
argument_list|(
name|p
operator|->
name|value
argument_list|)
expr_stmt|;
while|while
condition|(
name|cs
operator|>
literal|0xffff
condition|)
name|cs
operator|=
operator|(
name|cs
operator|>>
literal|16
operator|)
operator|+
operator|(
name|cs
operator|&
literal|0xffff
operator|)
expr_stmt|;
return|return
operator|(
name|cs
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|tcp_tlro_get_header
parameter_list|(
specifier|const
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
specifier|const
name|u_int
name|off
parameter_list|,
specifier|const
name|u_int
name|len
parameter_list|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
operator|(
name|off
operator|+
name|len
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|mtod
argument_list|(
name|m
argument_list|,
name|char
operator|*
argument_list|)
operator|+
name|off
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|tcp_tlro_info_save_timestamp
parameter_list|(
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfo
parameter_list|)
block|{
name|struct
name|tcphdr
modifier|*
name|tcp
init|=
name|pinfo
operator|->
name|tcp
decl_stmt|;
name|uint32_t
modifier|*
name|ts_ptr
decl_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_off
operator|<
operator|(
operator|(
name|TCPOLEN_TSTAMP_APPA
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
operator|)
operator|>>
literal|2
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ts_ptr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|tcp
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|ts_ptr
operator|!=
name|ntohl
argument_list|(
operator|(
name|TCPOPT_NOP
operator|<<
literal|24
operator|)
operator||
operator|(
name|TCPOPT_NOP
operator|<<
literal|16
operator|)
operator||
operator|(
name|TCPOPT_TIMESTAMP
operator|<<
literal|8
operator|)
operator||
name|TCPOLEN_TIMESTAMP
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Save timestamps */
name|pinfo
operator|->
name|tcp_ts
operator|=
name|ts_ptr
index|[
literal|1
index|]
expr_stmt|;
name|pinfo
operator|->
name|tcp_ts_reply
operator|=
name|ts_ptr
index|[
literal|2
index|]
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcp_tlro_info_restore_timestamp
parameter_list|(
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfoa
parameter_list|,
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfob
parameter_list|)
block|{
name|struct
name|tcphdr
modifier|*
name|tcp
init|=
name|pinfoa
operator|->
name|tcp
decl_stmt|;
name|uint32_t
modifier|*
name|ts_ptr
decl_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_off
operator|<
operator|(
operator|(
name|TCPOLEN_TSTAMP_APPA
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
operator|)
operator|>>
literal|2
operator|)
condition|)
return|return;
name|ts_ptr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|tcp
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|ts_ptr
operator|!=
name|ntohl
argument_list|(
operator|(
name|TCPOPT_NOP
operator|<<
literal|24
operator|)
operator||
operator|(
name|TCPOPT_NOP
operator|<<
literal|16
operator|)
operator||
operator|(
name|TCPOPT_TIMESTAMP
operator|<<
literal|8
operator|)
operator||
name|TCPOLEN_TIMESTAMP
argument_list|)
condition|)
return|return;
comment|/* Restore timestamps */
name|ts_ptr
index|[
literal|1
index|]
operator|=
name|pinfob
operator|->
name|tcp_ts
expr_stmt|;
name|ts_ptr
index|[
literal|2
index|]
operator|=
name|pinfob
operator|->
name|tcp_ts_reply
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcp_tlro_extract_header
parameter_list|(
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfo
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|seq
parameter_list|)
block|{
name|uint8_t
modifier|*
name|phdr
init|=
operator|(
name|uint8_t
operator|*
operator|)
name|pinfo
operator|->
name|buf
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ether_vlan_header
modifier|*
name|vlan
decl_stmt|;
ifdef|#
directive|ifdef
name|INET
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
endif|#
directive|endif
name|struct
name|tcphdr
modifier|*
name|tcp
decl_stmt|;
name|uint16_t
name|etype
decl_stmt|;
name|int
name|diff
decl_stmt|;
name|int
name|off
decl_stmt|;
comment|/* Fill in information */
name|pinfo
operator|->
name|head
operator|=
name|m
expr_stmt|;
name|pinfo
operator|->
name|last_tick
operator|=
name|ticks
expr_stmt|;
name|pinfo
operator|->
name|sequence
operator|=
name|seq
expr_stmt|;
name|pinfo
operator|->
name|pprev
operator|=
operator|&
name|m_last
argument_list|(
name|m
argument_list|)
operator|->
name|m_next
expr_stmt|;
name|off
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
name|off
condition|)
goto|goto
name|error
goto|;
name|eh
operator|=
name|tcp_tlro_get_header
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eh
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|memcpy
argument_list|(
name|phdr
argument_list|,
operator|&
name|eh
operator|->
name|ether_dhost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|phdr
operator|+=
name|ETHER_ADDR_LEN
expr_stmt|;
name|memcpy
argument_list|(
name|phdr
argument_list|,
operator|&
name|eh
operator|->
name|ether_type
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
operator|->
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
name|phdr
operator|+=
sizeof|sizeof
argument_list|(
name|eh
operator|->
name|ether_type
argument_list|)
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|ether_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|etype
operator|==
name|ETHERTYPE_VLAN
condition|)
block|{
name|vlan
operator|=
name|tcp_tlro_get_header
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vlan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vlan
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|memcpy
argument_list|(
name|phdr
argument_list|,
operator|&
name|vlan
operator|->
name|evl_tag
argument_list|,
sizeof|sizeof
argument_list|(
name|vlan
operator|->
name|evl_tag
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|vlan
operator|->
name|evl_proto
argument_list|)
argument_list|)
expr_stmt|;
name|phdr
operator|+=
sizeof|sizeof
argument_list|(
name|vlan
operator|->
name|evl_tag
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|vlan
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
name|etype
operator|=
name|ntohs
argument_list|(
name|vlan
operator|->
name|evl_proto
argument_list|)
expr_stmt|;
name|off
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|vlan
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|etype
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|ETHERTYPE_IP
case|:
comment|/* 		 * Cannot LRO: 		 * - Non-IP packets 		 * - Fragmented packets 		 * - Packets with IPv4 options 		 * - Non-TCP packets 		 */
name|ip
operator|=
name|tcp_tlro_get_header
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|==
name|NULL
operator|||
operator|(
name|ip
operator|->
name|ip_off
operator|&
name|htons
argument_list|(
name|IP_MF
operator||
name|IP_OFFMASK
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|ip
operator|->
name|ip_p
operator|!=
name|IPPROTO_TCP
operator|)
operator|||
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
condition|)
goto|goto
name|error
goto|;
comment|/* Legacy IP has a header checksum that needs to be correct */
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP_CHECKED
operator|)
condition|)
block|{
comment|/* Verify IP header */
if|if
condition|(
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
argument_list|)
operator|!=
literal|0xFFFF
condition|)
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
expr_stmt|;
else|else
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
expr_stmt|;
block|}
comment|/* Only accept valid checksums */
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_IP_VALID
operator|)
operator|||
operator|!
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_DATA_VALID
operator|)
condition|)
goto|goto
name|error
goto|;
name|memcpy
argument_list|(
name|phdr
argument_list|,
operator|&
name|ip
operator|->
name|ip_src
argument_list|,
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|ip_src
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|)
argument_list|)
expr_stmt|;
name|phdr
operator|+=
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|ip_src
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|M_HASHTYPE_GET
argument_list|(
name|m
argument_list|)
operator|==
name|M_HASHTYPE_LRO_TCP
condition|)
name|pinfo
operator|->
name|ip_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|off
expr_stmt|;
else|else
name|pinfo
operator|->
name|ip_len
operator|=
name|ntohs
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|pinfo
operator|->
name|ip_hdrlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
name|pinfo
operator|->
name|ip
operator|.
name|v4
operator|=
name|ip
expr_stmt|;
name|pinfo
operator|->
name|ip_version
operator|=
literal|4
expr_stmt|;
name|off
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|ETHERTYPE_IPV6
case|:
comment|/* 		 * Cannot LRO: 		 * - Non-IP packets 		 * - Packets with IPv6 options 		 * - Non-TCP packets 		 */
name|ip6
operator|=
name|tcp_tlro_get_header
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ip6
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip6
operator|==
name|NULL
operator|||
name|ip6
operator|->
name|ip6_nxt
operator|!=
name|IPPROTO_TCP
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_DATA_VALID
operator|)
condition|)
goto|goto
name|error
goto|;
name|memcpy
argument_list|(
name|phdr
argument_list|,
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|phdr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|M_HASHTYPE_GET
argument_list|(
name|m
argument_list|)
operator|==
name|M_HASHTYPE_LRO_TCP
condition|)
name|pinfo
operator|->
name|ip_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|off
expr_stmt|;
else|else
name|pinfo
operator|->
name|ip_len
operator|=
name|ntohs
argument_list|(
name|ip6
operator|->
name|ip6_plen
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ip6
argument_list|)
expr_stmt|;
name|pinfo
operator|->
name|ip_hdrlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ip6
argument_list|)
expr_stmt|;
name|pinfo
operator|->
name|ip
operator|.
name|v6
operator|=
name|ip6
expr_stmt|;
name|pinfo
operator|->
name|ip_version
operator|=
literal|6
expr_stmt|;
name|off
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|ip6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
goto|goto
name|error
goto|;
block|}
name|tcp
operator|=
name|tcp_tlro_get_header
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|memcpy
argument_list|(
name|phdr
argument_list|,
operator|&
name|tcp
operator|->
name|th_sport
argument_list|,
sizeof|sizeof
argument_list|(
name|tcp
operator|->
name|th_sport
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|tcp
operator|->
name|th_dport
argument_list|)
argument_list|)
expr_stmt|;
name|phdr
operator|+=
sizeof|sizeof
argument_list|(
name|tcp
operator|->
name|th_sport
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|tcp
operator|->
name|th_dport
argument_list|)
expr_stmt|;
comment|/* Store TCP header length */
operator|*
name|phdr
operator|++
operator|=
name|tcp
operator|->
name|th_off
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|th_off
operator|<
operator|(
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
operator|>>
literal|2
operator|)
condition|)
goto|goto
name|error
goto|;
comment|/* Compute offset to data payload */
name|pinfo
operator|->
name|tcp_len
operator|=
operator|(
name|tcp
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
name|off
operator|+=
name|pinfo
operator|->
name|tcp_len
expr_stmt|;
comment|/* Store more info */
name|pinfo
operator|->
name|data_off
operator|=
name|off
expr_stmt|;
name|pinfo
operator|->
name|tcp
operator|=
name|tcp
expr_stmt|;
comment|/* Try to save timestamp, if any */
operator|*
name|phdr
operator|++
operator|=
name|tcp_tlro_info_save_timestamp
argument_list|(
name|pinfo
argument_list|)
expr_stmt|;
comment|/* Verify offset and IP/TCP length */
if|if
condition|(
name|off
operator|>
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|||
name|pinfo
operator|->
name|ip_len
operator|<
name|pinfo
operator|->
name|tcp_len
condition|)
goto|goto
name|error
goto|;
comment|/* Compute data payload length */
name|pinfo
operator|->
name|data_len
operator|=
operator|(
name|pinfo
operator|->
name|ip_len
operator|-
name|pinfo
operator|->
name|tcp_len
operator|-
name|pinfo
operator|->
name|ip_hdrlen
operator|)
expr_stmt|;
comment|/* Trim any padded data */
name|diff
operator|=
operator|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|off
operator|)
operator|-
name|pinfo
operator|->
name|data_len
expr_stmt|;
if|if
condition|(
name|diff
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|diff
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
else|else
name|m_adj
argument_list|(
name|m
argument_list|,
operator|-
name|diff
argument_list|)
expr_stmt|;
block|}
comment|/* Compute header length */
name|pinfo
operator|->
name|buf_length
operator|=
name|phdr
operator|-
operator|(
name|uint8_t
operator|*
operator|)
name|pinfo
operator|->
name|buf
expr_stmt|;
comment|/* Zero-pad rest of buffer */
name|memset
argument_list|(
name|phdr
argument_list|,
literal|0
argument_list|,
name|TLRO_MAX_HEADER
operator|-
name|pinfo
operator|->
name|buf_length
argument_list|)
expr_stmt|;
return|return;
name|error
label|:
name|pinfo
operator|->
name|buf_length
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tcp_tlro_cmp64
parameter_list|(
specifier|const
name|uint64_t
modifier|*
name|pa
parameter_list|,
specifier|const
name|uint64_t
modifier|*
name|pb
parameter_list|)
block|{
name|int64_t
name|diff
init|=
literal|0
decl_stmt|;
name|unsigned
name|x
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|TLRO_MAX_HEADER
operator|/
literal|8
condition|;
name|x
operator|++
control|)
block|{
comment|/* 		 * NOTE: Endianness does not matter in this 		 * comparisation: 		 */
name|diff
operator|=
name|pa
index|[
name|x
index|]
operator|-
name|pb
index|[
name|x
index|]
expr_stmt|;
if|if
condition|(
name|diff
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
block|}
name|done
label|:
if|if
condition|(
name|diff
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
elseif|else
if|if
condition|(
name|diff
operator|>
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tcp_tlro_compare_header
parameter_list|(
specifier|const
name|void
modifier|*
name|_ppa
parameter_list|,
specifier|const
name|void
modifier|*
name|_ppb
parameter_list|)
block|{
specifier|const
name|struct
name|tlro_mbuf_ptr
modifier|*
name|ppa
init|=
name|_ppa
decl_stmt|;
specifier|const
name|struct
name|tlro_mbuf_ptr
modifier|*
name|ppb
init|=
name|_ppb
decl_stmt|;
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfoa
init|=
name|ppa
operator|->
name|data
decl_stmt|;
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfob
init|=
name|ppb
operator|->
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|pinfoa
operator|->
name|head
operator|==
name|NULL
operator|)
operator|-
operator|(
name|pinfob
operator|->
name|head
operator|==
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
name|ret
operator|=
name|pinfoa
operator|->
name|buf_length
operator|-
name|pinfob
operator|->
name|buf_length
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|pinfoa
operator|->
name|buf_length
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|tcp_tlro_cmp64
argument_list|(
name|pinfoa
operator|->
name|buf
argument_list|,
name|pinfob
operator|->
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
name|ret
operator|=
name|ntohl
argument_list|(
name|pinfoa
operator|->
name|tcp
operator|->
name|th_seq
argument_list|)
operator|-
name|ntohl
argument_list|(
name|pinfob
operator|->
name|tcp
operator|->
name|th_seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
name|ret
operator|=
name|ntohl
argument_list|(
name|pinfoa
operator|->
name|tcp
operator|->
name|th_ack
argument_list|)
operator|-
name|ntohl
argument_list|(
name|pinfob
operator|->
name|tcp
operator|->
name|th_ack
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
name|ret
operator|=
name|pinfoa
operator|->
name|sequence
operator|-
name|pinfob
operator|->
name|sequence
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|done
goto|;
block|}
name|done
label|:
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcp_tlro_sort
parameter_list|(
name|struct
name|tlro_ctrl
modifier|*
name|tlro
parameter_list|)
block|{
if|if
condition|(
name|tlro
operator|->
name|curr
operator|==
literal|0
condition|)
return|return;
name|qsort
argument_list|(
name|tlro
operator|->
name|mbuf
argument_list|,
name|tlro
operator|->
name|curr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tlro_mbuf_ptr
argument_list|)
argument_list|,
operator|&
name|tcp_tlro_compare_header
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tcp_tlro_get_ticks
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|to
init|=
name|tlro_min_rate
decl_stmt|;
if|if
condition|(
name|to
operator|<
literal|1
condition|)
name|to
operator|=
literal|1
expr_stmt|;
name|to
operator|=
name|hz
operator|/
name|to
expr_stmt|;
if|if
condition|(
name|to
operator|<
literal|1
condition|)
name|to
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|to
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcp_tlro_combine
parameter_list|(
name|struct
name|tlro_ctrl
modifier|*
name|tlro
parameter_list|,
name|int
name|force
parameter_list|)
block|{
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfoa
decl_stmt|;
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfob
decl_stmt|;
name|uint32_t
name|cs
decl_stmt|;
name|int
name|curr_ticks
init|=
name|ticks
decl_stmt|;
name|int
name|ticks_limit
init|=
name|tcp_tlro_get_ticks
argument_list|()
decl_stmt|;
name|unsigned
name|x
decl_stmt|;
name|unsigned
name|y
decl_stmt|;
name|unsigned
name|z
decl_stmt|;
name|int
name|temp
decl_stmt|;
if|if
condition|(
name|tlro
operator|->
name|curr
operator|==
literal|0
condition|)
return|return;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|!=
name|tlro
operator|->
name|curr
condition|;
control|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|pinfoa
operator|=
name|tlro
operator|->
name|mbuf
index|[
name|y
index|]
operator|.
name|data
expr_stmt|;
for|for
control|(
name|x
operator|=
name|y
operator|+
literal|1
init|;
name|x
operator|!=
name|tlro
operator|->
name|curr
condition|;
name|x
operator|++
control|)
block|{
name|pinfob
operator|=
name|tlro
operator|->
name|mbuf
index|[
name|x
index|]
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|pinfoa
operator|->
name|buf_length
operator|!=
name|pinfob
operator|->
name|buf_length
operator|||
name|tcp_tlro_cmp64
argument_list|(
name|pinfoa
operator|->
name|buf
argument_list|,
name|pinfob
operator|->
name|buf
argument_list|)
operator|!=
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|pinfoa
operator|->
name|buf_length
operator|==
literal|0
condition|)
block|{
comment|/* Forward traffic which cannot be combined */
for|for
control|(
name|z
operator|=
name|y
init|;
name|z
operator|!=
name|x
condition|;
name|z
operator|++
control|)
block|{
comment|/* Just forward packets */
name|pinfob
operator|=
name|tlro
operator|->
name|mbuf
index|[
name|z
index|]
operator|.
name|data
expr_stmt|;
name|m
operator|=
name|pinfob
operator|->
name|head
expr_stmt|;
comment|/* Reset info structure */
name|pinfob
operator|->
name|head
operator|=
name|NULL
expr_stmt|;
name|pinfob
operator|->
name|buf_length
operator|=
literal|0
expr_stmt|;
comment|/* Do stats */
name|tlro
operator|->
name|lro_flushed
operator|++
expr_stmt|;
comment|/* Input packet to network layer */
call|(
modifier|*
name|tlro
operator|->
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|tlro
operator|->
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|y
operator|=
name|z
expr_stmt|;
continue|continue;
block|}
comment|/* Compute current checksum subtracted some header parts */
name|temp
operator|=
operator|(
name|pinfoa
operator|->
name|ip_len
operator|-
name|pinfoa
operator|->
name|ip_hdrlen
operator|)
expr_stmt|;
name|cs
operator|=
operator|(
operator|(
name|temp
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|(
name|temp
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
operator|+
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
name|pinfoa
operator|->
name|tcp
argument_list|,
name|pinfoa
operator|->
name|tcp_len
argument_list|)
expr_stmt|;
comment|/* Append all fragments into one block */
for|for
control|(
name|z
operator|=
name|y
operator|+
literal|1
init|;
name|z
operator|!=
name|x
condition|;
name|z
operator|++
control|)
block|{
name|pinfob
operator|=
name|tlro
operator|->
name|mbuf
index|[
name|z
index|]
operator|.
name|data
expr_stmt|;
comment|/* Check for command packets */
if|if
condition|(
operator|(
name|pinfoa
operator|->
name|tcp
operator|->
name|th_flags
operator|&
operator|~
operator|(
name|TH_ACK
operator||
name|TH_PUSH
operator|)
operator|)
operator|||
operator|(
name|pinfob
operator|->
name|tcp
operator|->
name|th_flags
operator|&
operator|~
operator|(
name|TH_ACK
operator||
name|TH_PUSH
operator|)
operator|)
condition|)
break|break;
comment|/* Check if there is enough space */
if|if
condition|(
operator|(
name|pinfoa
operator|->
name|ip_len
operator|+
name|pinfob
operator|->
name|data_len
operator|)
operator|>
name|tlro_max_packet
condition|)
break|break;
comment|/* Try to append the new segment */
name|temp
operator|=
name|ntohl
argument_list|(
name|pinfoa
operator|->
name|tcp
operator|->
name|th_seq
argument_list|)
operator|+
name|pinfoa
operator|->
name|data_len
expr_stmt|;
if|if
condition|(
name|temp
operator|!=
operator|(
name|int
operator|)
name|ntohl
argument_list|(
name|pinfob
operator|->
name|tcp
operator|->
name|th_seq
argument_list|)
condition|)
break|break;
name|temp
operator|=
name|pinfob
operator|->
name|ip_len
operator|-
name|pinfob
operator|->
name|ip_hdrlen
expr_stmt|;
name|cs
operator|+=
operator|(
operator|(
name|temp
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|(
name|temp
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
operator|+
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
name|pinfob
operator|->
name|tcp
argument_list|,
name|pinfob
operator|->
name|tcp_len
argument_list|)
expr_stmt|;
comment|/* Remove fields which appear twice */
name|cs
operator|+=
operator|(
name|IPPROTO_TCP
operator|<<
literal|8
operator|)
expr_stmt|;
if|if
condition|(
name|pinfob
operator|->
name|ip_version
operator|==
literal|4
condition|)
block|{
name|cs
operator|+=
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
operator|&
name|pinfob
operator|->
name|ip
operator|.
name|v4
operator|->
name|ip_src
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|cs
operator|+=
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
operator|&
name|pinfob
operator|->
name|ip
operator|.
name|v4
operator|->
name|ip_dst
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cs
operator|+=
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
operator|&
name|pinfob
operator|->
name|ip
operator|.
name|v6
operator|->
name|ip6_src
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|cs
operator|+=
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
operator|&
name|pinfob
operator|->
name|ip
operator|.
name|v6
operator|->
name|ip6_dst
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
comment|/* Remainder computation */
while|while
condition|(
name|cs
operator|>
literal|0xffff
condition|)
name|cs
operator|=
operator|(
name|cs
operator|>>
literal|16
operator|)
operator|+
operator|(
name|cs
operator|&
literal|0xffff
operator|)
expr_stmt|;
comment|/* Update window and ack sequence number */
name|pinfoa
operator|->
name|tcp
operator|->
name|th_ack
operator|=
name|pinfob
operator|->
name|tcp
operator|->
name|th_ack
expr_stmt|;
name|pinfoa
operator|->
name|tcp
operator|->
name|th_win
operator|=
name|pinfob
operator|->
name|tcp
operator|->
name|th_win
expr_stmt|;
comment|/* Check if we should restore the timestamp */
name|tcp_tlro_info_restore_timestamp
argument_list|(
name|pinfoa
argument_list|,
name|pinfob
argument_list|)
expr_stmt|;
comment|/* Accumulate TCP flags */
name|pinfoa
operator|->
name|tcp
operator|->
name|th_flags
operator||=
name|pinfob
operator|->
name|tcp
operator|->
name|th_flags
expr_stmt|;
comment|/* update lengths */
name|pinfoa
operator|->
name|ip_len
operator|+=
name|pinfob
operator|->
name|data_len
expr_stmt|;
name|pinfoa
operator|->
name|data_len
operator|+=
name|pinfob
operator|->
name|data_len
expr_stmt|;
comment|/* Clear mbuf pointer - packet is accumulated */
name|m
operator|=
name|pinfob
operator|->
name|head
expr_stmt|;
comment|/* Reset info structure */
name|pinfob
operator|->
name|head
operator|=
name|NULL
expr_stmt|;
name|pinfob
operator|->
name|buf_length
operator|=
literal|0
expr_stmt|;
comment|/* Append data to mbuf [y] */
name|m_adj
argument_list|(
name|m
argument_list|,
name|pinfob
operator|->
name|data_off
argument_list|)
expr_stmt|;
comment|/* Delete mbuf tags, if any */
name|m_tag_delete_chain
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Clear packet header flag */
name|m
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
comment|/* Concat mbuf(s) to end of list */
name|pinfoa
operator|->
name|pprev
index|[
literal|0
index|]
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|m_last
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|pinfoa
operator|->
name|pprev
operator|=
operator|&
name|m
operator|->
name|m_next
expr_stmt|;
name|pinfoa
operator|->
name|head
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|pinfob
operator|->
name|data_len
expr_stmt|;
block|}
comment|/* Compute new TCP header checksum */
name|pinfoa
operator|->
name|tcp
operator|->
name|th_sum
operator|=
literal|0
expr_stmt|;
name|temp
operator|=
name|pinfoa
operator|->
name|ip_len
operator|-
name|pinfoa
operator|->
name|ip_hdrlen
expr_stmt|;
name|cs
operator|=
operator|(
name|cs
operator|^
literal|0xFFFF
operator|)
operator|+
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
name|pinfoa
operator|->
name|tcp
argument_list|,
name|pinfoa
operator|->
name|tcp_len
argument_list|)
operator|+
operator|(
operator|(
name|temp
operator|&
literal|0xFF
operator|)
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|(
name|temp
operator|&
literal|0xFF00
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
comment|/* Remainder computation */
while|while
condition|(
name|cs
operator|>
literal|0xffff
condition|)
name|cs
operator|=
operator|(
name|cs
operator|>>
literal|16
operator|)
operator|+
operator|(
name|cs
operator|&
literal|0xffff
operator|)
expr_stmt|;
comment|/* Update new checksum */
name|pinfoa
operator|->
name|tcp
operator|->
name|th_sum
operator|=
operator|~
name|htole16
argument_list|(
name|cs
argument_list|)
expr_stmt|;
comment|/* Update IP length, if any */
if|if
condition|(
name|pinfoa
operator|->
name|ip_version
operator|==
literal|4
condition|)
block|{
if|if
condition|(
name|pinfoa
operator|->
name|ip_len
operator|>
name|IP_MAXPACKET
condition|)
block|{
name|M_HASHTYPE_SET
argument_list|(
name|pinfoa
operator|->
name|head
argument_list|,
name|M_HASHTYPE_LRO_TCP
argument_list|)
expr_stmt|;
name|pinfoa
operator|->
name|ip
operator|.
name|v4
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|IP_MAXPACKET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pinfoa
operator|->
name|ip
operator|.
name|v4
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|pinfoa
operator|->
name|ip_len
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|pinfoa
operator|->
name|ip_len
operator|>
operator|(
name|IP_MAXPACKET
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|pinfoa
operator|->
name|ip
operator|.
name|v6
argument_list|)
operator|)
condition|)
block|{
name|M_HASHTYPE_SET
argument_list|(
name|pinfoa
operator|->
name|head
argument_list|,
name|M_HASHTYPE_LRO_TCP
argument_list|)
expr_stmt|;
name|pinfoa
operator|->
name|ip
operator|.
name|v6
operator|->
name|ip6_plen
operator|=
name|htons
argument_list|(
name|IP_MAXPACKET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|temp
operator|=
name|pinfoa
operator|->
name|ip_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|pinfoa
operator|->
name|ip
operator|.
name|v6
argument_list|)
expr_stmt|;
name|pinfoa
operator|->
name|ip
operator|.
name|v6
operator|->
name|ip6_plen
operator|=
name|htons
argument_list|(
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
name|temp
operator|=
name|curr_ticks
operator|-
name|pinfoa
operator|->
name|last_tick
expr_stmt|;
comment|/* Check if packet should be forwarded */
if|if
condition|(
name|force
operator|!=
literal|0
operator|||
name|z
operator|!=
name|x
operator|||
name|temp
operator|>=
name|ticks_limit
operator|||
name|pinfoa
operator|->
name|data_len
operator|==
literal|0
condition|)
block|{
comment|/* Compute new IPv4 header checksum */
if|if
condition|(
name|pinfoa
operator|->
name|ip_version
operator|==
literal|4
condition|)
block|{
name|pinfoa
operator|->
name|ip
operator|.
name|v4
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|cs
operator|=
name|tcp_tlro_csum
argument_list|(
operator|(
name|uint32_p_t
operator|*
operator|)
name|pinfoa
operator|->
name|ip
operator|.
name|v4
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pinfoa
operator|->
name|ip
operator|.
name|v4
argument_list|)
argument_list|)
expr_stmt|;
name|pinfoa
operator|->
name|ip
operator|.
name|v4
operator|->
name|ip_sum
operator|=
operator|~
name|htole16
argument_list|(
name|cs
argument_list|)
expr_stmt|;
block|}
comment|/* Forward packet */
name|m
operator|=
name|pinfoa
operator|->
name|head
expr_stmt|;
comment|/* Reset info structure */
name|pinfoa
operator|->
name|head
operator|=
name|NULL
expr_stmt|;
name|pinfoa
operator|->
name|buf_length
operator|=
literal|0
expr_stmt|;
comment|/* Do stats */
name|tlro
operator|->
name|lro_flushed
operator|++
expr_stmt|;
comment|/* Input packet to network layer */
call|(
modifier|*
name|tlro
operator|->
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|tlro
operator|->
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
name|y
operator|=
name|z
expr_stmt|;
block|}
comment|/* Cleanup all NULL heads */
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|!=
name|tlro
operator|->
name|curr
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
name|tlro
operator|->
name|mbuf
index|[
name|y
index|]
operator|.
name|data
operator|->
name|head
operator|==
name|NULL
condition|)
block|{
for|for
control|(
name|z
operator|=
name|y
operator|+
literal|1
init|;
name|z
operator|!=
name|tlro
operator|->
name|curr
condition|;
name|z
operator|++
control|)
block|{
name|struct
name|tlro_mbuf_ptr
name|ptemp
decl_stmt|;
if|if
condition|(
name|tlro
operator|->
name|mbuf
index|[
name|z
index|]
operator|.
name|data
operator|->
name|head
operator|==
name|NULL
condition|)
continue|continue;
name|ptemp
operator|=
name|tlro
operator|->
name|mbuf
index|[
name|y
index|]
expr_stmt|;
name|tlro
operator|->
name|mbuf
index|[
name|y
index|]
operator|=
name|tlro
operator|->
name|mbuf
index|[
name|z
index|]
expr_stmt|;
name|tlro
operator|->
name|mbuf
index|[
name|z
index|]
operator|=
name|ptemp
expr_stmt|;
name|y
operator|++
expr_stmt|;
block|}
break|break;
block|}
block|}
name|tlro
operator|->
name|curr
operator|=
name|y
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tcp_tlro_cleanup
parameter_list|(
name|struct
name|tlro_ctrl
modifier|*
name|tlro
parameter_list|)
block|{
while|while
condition|(
name|tlro
operator|->
name|curr
operator|!=
literal|0
operator|&&
name|tlro
operator|->
name|mbuf
index|[
name|tlro
operator|->
name|curr
operator|-
literal|1
index|]
operator|.
name|data
operator|->
name|head
operator|==
name|NULL
condition|)
name|tlro
operator|->
name|curr
operator|--
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tcp_tlro_flush
parameter_list|(
name|struct
name|tlro_ctrl
modifier|*
name|tlro
parameter_list|,
name|int
name|force
parameter_list|)
block|{
if|if
condition|(
name|tlro
operator|->
name|curr
operator|==
literal|0
condition|)
return|return;
name|tcp_tlro_sort
argument_list|(
name|tlro
argument_list|)
expr_stmt|;
name|tcp_tlro_cleanup
argument_list|(
name|tlro
argument_list|)
expr_stmt|;
name|tcp_tlro_combine
argument_list|(
name|tlro
argument_list|,
name|force
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|tcp_tlro_init
parameter_list|(
name|struct
name|tlro_ctrl
modifier|*
name|tlro
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|int
name|max_mbufs
parameter_list|)
block|{
name|ssize_t
name|size
decl_stmt|;
name|uint32_t
name|x
decl_stmt|;
comment|/* Set zero defaults */
name|memset
argument_list|(
name|tlro
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tlro
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Compute size needed for data */
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|tlro_mbuf_ptr
argument_list|)
operator|*
name|max_mbufs
operator|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|tlro_mbuf_data
argument_list|)
operator|*
name|max_mbufs
operator|)
expr_stmt|;
comment|/* Range check */
if|if
condition|(
name|max_mbufs
operator|<=
literal|0
operator|||
name|size
operator|<=
literal|0
operator|||
name|ifp
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Setup tlro control structure */
name|tlro
operator|->
name|mbuf
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|M_TLRO
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|tlro
operator|->
name|max
operator|=
name|max_mbufs
expr_stmt|;
name|tlro
operator|->
name|ifp
operator|=
name|ifp
expr_stmt|;
comment|/* Setup pointer array */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|tlro
operator|->
name|max
condition|;
name|x
operator|++
control|)
block|{
name|tlro
operator|->
name|mbuf
index|[
name|x
index|]
operator|.
name|data
operator|=
operator|(
operator|(
expr|struct
name|tlro_mbuf_data
operator|*
operator|)
operator|&
name|tlro
operator|->
name|mbuf
index|[
name|max_mbufs
index|]
operator|)
operator|+
name|x
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tcp_tlro_free
parameter_list|(
name|struct
name|tlro_ctrl
modifier|*
name|tlro
parameter_list|)
block|{
name|struct
name|tlro_mbuf_data
modifier|*
name|pinfo
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|uint32_t
name|y
decl_stmt|;
comment|/* Check if not setup */
if|if
condition|(
name|tlro
operator|->
name|mbuf
operator|==
name|NULL
condition|)
return|return;
comment|/* Free MBUF array and any leftover MBUFs */
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|!=
name|tlro
operator|->
name|max
condition|;
name|y
operator|++
control|)
block|{
name|pinfo
operator|=
name|tlro
operator|->
name|mbuf
index|[
name|y
index|]
operator|.
name|data
expr_stmt|;
name|m
operator|=
name|pinfo
operator|->
name|head
expr_stmt|;
comment|/* Reset info structure */
name|pinfo
operator|->
name|head
operator|=
name|NULL
expr_stmt|;
name|pinfo
operator|->
name|buf_length
operator|=
literal|0
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|tlro
operator|->
name|mbuf
argument_list|,
name|M_TLRO
argument_list|)
expr_stmt|;
comment|/* Reset buffer */
name|memset
argument_list|(
name|tlro
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tlro
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tcp_tlro_rx
parameter_list|(
name|struct
name|tlro_ctrl
modifier|*
name|tlro
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|>
literal|0
operator|&&
name|tlro
operator|->
name|curr
operator|<
name|tlro
operator|->
name|max
condition|)
block|{
comment|/* do stats */
name|tlro
operator|->
name|lro_queued
operator|++
expr_stmt|;
comment|/* extract header */
name|tcp_tlro_extract_header
argument_list|(
name|tlro
operator|->
name|mbuf
index|[
name|tlro
operator|->
name|curr
operator|++
index|]
operator|.
name|data
argument_list|,
name|m
argument_list|,
name|tlro
operator|->
name|sequence
operator|++
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tlro
operator|->
name|ifp
operator|!=
name|NULL
condition|)
block|{
comment|/* do stats */
name|tlro
operator|->
name|lro_flushed
operator|++
expr_stmt|;
comment|/* input packet to network layer */
call|(
modifier|*
name|tlro
operator|->
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|tlro
operator|->
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* packet drop */
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


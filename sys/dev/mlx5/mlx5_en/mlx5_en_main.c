begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Mellanox Technologies. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"en.h"
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_define
define|#
directive|define
name|ETH_DRIVER_VERSION
value|"3.1.0-dev"
end_define

begin_decl_stmt
name|char
name|mlx5e_version
index|[]
init|=
literal|"Mellanox Ethernet driver"
literal|" ("
name|ETH_DRIVER_VERSION
literal|")"
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|mlx5e_channel_param
block|{
name|struct
name|mlx5e_rq_param
name|rq
decl_stmt|;
name|struct
name|mlx5e_sq_param
name|sq
decl_stmt|;
name|struct
name|mlx5e_cq_param
name|rx_cq
decl_stmt|;
name|struct
name|mlx5e_cq_param
name|tx_cq
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|u32
name|subtype
decl_stmt|;
name|u64
name|baudrate
decl_stmt|;
block|}
name|mlx5e_mode_table
index|[
name|MLX5E_LINK_MODES_NUMBER
index|]
init|=
block|{
index|[
name|MLX5E_1000BASE_CX_SGMII
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_1000_CX_SGMII
block|,
operator|.
name|baudrate
operator|=
name|IF_Mbps
argument_list|(
literal|1000ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_1000BASE_KX
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_1000_KX
block|,
operator|.
name|baudrate
operator|=
name|IF_Mbps
argument_list|(
literal|1000ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_10GBASE_CX4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_10G_CX4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_10GBASE_KX4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_10G_KX4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_10GBASE_KR
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_10G_KR
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_20GBASE_KR2
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_20G_KR2
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|20ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_40GBASE_CR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_40G_CR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|40ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_40GBASE_KR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_40G_KR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|40ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_56GBASE_R4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_56G_R4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|56ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_10GBASE_CR
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_10G_CR1
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_10GBASE_SR
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_10G_SR
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_10GBASE_LR
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_10G_LR
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_40GBASE_SR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_40G_SR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|40ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_40GBASE_LR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_40G_LR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|40ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_100GBASE_CR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_100G_CR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|100ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_100GBASE_SR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_100G_SR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|100ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_100GBASE_KR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_100G_KR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|100ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_100GBASE_LR4
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_100G_LR4
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|100ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_100BASE_TX
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_100_TX
block|,
operator|.
name|baudrate
operator|=
name|IF_Mbps
argument_list|(
literal|100ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_100BASE_T
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_100_T
block|,
operator|.
name|baudrate
operator|=
name|IF_Mbps
argument_list|(
literal|100ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_10GBASE_T
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_10G_T
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|10ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_25GBASE_CR
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_25G_CR
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|25ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_25GBASE_KR
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_25G_KR
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|25ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_25GBASE_SR
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_25G_SR
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|25ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_50GBASE_CR2
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_50G_CR2
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|50ULL
argument_list|)
block|, 	}
block|,
index|[
name|MLX5E_50GBASE_KR2
index|]
operator|=
block|{
operator|.
name|subtype
operator|=
name|IFM_50G_KR2
block|,
operator|.
name|baudrate
operator|=
name|IF_Gbps
argument_list|(
literal|50ULL
argument_list|)
block|, 	}
block|, }
struct|;
end_struct

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_MLX5EN
argument_list|,
literal|"MLX5EN"
argument_list|,
literal|"MLX5 Ethernet"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|mlx5e_update_carrier
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
name|out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|ptys_reg
argument_list|)
index|]
decl_stmt|;
name|u32
name|eth_proto_oper
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u8
name|port_state
decl_stmt|;
name|u8
name|i
decl_stmt|;
name|port_state
operator|=
name|mlx5_query_vport_state
argument_list|(
name|mdev
argument_list|,
name|MLX5_QUERY_VPORT_STATE_IN_OP_MOD_VNIC_VPORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_state
operator|==
name|VPORT_STATE_UP
condition|)
block|{
name|priv
operator|->
name|media_status_last
operator||=
name|IFM_ACTIVE
expr_stmt|;
block|}
else|else
block|{
name|priv
operator|->
name|media_status_last
operator|&=
operator|~
name|IFM_ACTIVE
expr_stmt|;
name|priv
operator|->
name|media_active_last
operator|=
name|IFM_ETHER
expr_stmt|;
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
return|return;
block|}
name|error
operator|=
name|mlx5_query_port_ptys
argument_list|(
name|mdev
argument_list|,
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|,
name|MLX5_PTYS_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|priv
operator|->
name|media_active_last
operator|=
name|IFM_ETHER
expr_stmt|;
name|priv
operator|->
name|ifp
operator|->
name|if_baudrate
operator|=
literal|1
expr_stmt|;
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"%s: query port ptys failed: 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
name|eth_proto_oper
operator|=
name|MLX5_GET
argument_list|(
name|ptys_reg
argument_list|,
name|out
argument_list|,
name|eth_proto_oper
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|MLX5E_LINK_MODES_NUMBER
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|baudrate
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|MLX5E_PROT_MASK
argument_list|(
name|i
argument_list|)
operator|&
name|eth_proto_oper
condition|)
block|{
name|priv
operator|->
name|ifp
operator|->
name|if_baudrate
operator|=
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|baudrate
expr_stmt|;
name|priv
operator|->
name|media_active_last
operator|=
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|subtype
operator||
name|IFM_ETHER
operator||
name|IFM_FDX
expr_stmt|;
block|}
block|}
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
name|LINK_STATE_UP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_media_status
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|dev
operator|->
name|if_softc
decl_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|priv
operator|->
name|media_status_last
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|priv
operator|->
name|media_active_last
operator||
operator|(
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
condition|?
name|IFM_ETH_RXPAUSE
else|:
literal|0
operator|)
operator||
operator|(
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
condition|?
name|IFM_ETH_TXPAUSE
else|:
literal|0
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|mlx5e_find_link_mode
parameter_list|(
name|u32
name|subtype
parameter_list|)
block|{
name|u32
name|i
decl_stmt|;
name|u32
name|link_mode
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5E_LINK_MODES_NUMBER
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|baudrate
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|subtype
operator|==
name|subtype
condition|)
name|link_mode
operator||=
name|MLX5E_PROT_MASK
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|link_mode
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_media_change
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|dev
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
name|eth_proto_cap
decl_stmt|;
name|u32
name|link_mode
decl_stmt|;
name|int
name|was_opened
decl_stmt|;
name|int
name|locked
decl_stmt|;
name|int
name|error
decl_stmt|;
name|locked
operator|=
name|PRIV_LOCKED
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|locked
condition|)
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|priv
operator|->
name|media
operator|.
name|ifm_media
argument_list|)
operator|!=
name|IFM_ETHER
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|link_mode
operator|=
name|mlx5e_find_link_mode
argument_list|(
name|IFM_SUBTYPE
argument_list|(
name|priv
operator|->
name|media
operator|.
name|ifm_media
argument_list|)
argument_list|)
expr_stmt|;
comment|/* query supported capabilities */
name|error
operator|=
name|mlx5_query_port_proto_cap
argument_list|(
name|mdev
argument_list|,
operator|&
name|eth_proto_cap
argument_list|,
name|MLX5_PTYS_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|dev
argument_list|,
literal|"Query port media capability failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* check for autoselect */
if|if
condition|(
name|IFM_SUBTYPE
argument_list|(
name|priv
operator|->
name|media
operator|.
name|ifm_media
argument_list|)
operator|==
name|IFM_AUTO
condition|)
block|{
name|link_mode
operator|=
name|eth_proto_cap
expr_stmt|;
if|if
condition|(
name|link_mode
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|dev
argument_list|,
literal|"Port media capability is zero\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
else|else
block|{
name|link_mode
operator|=
name|link_mode
operator|&
name|eth_proto_cap
expr_stmt|;
if|if
condition|(
name|link_mode
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|dev
argument_list|,
literal|"Not supported link mode requested\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
comment|/* update pauseframe control bits */
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
operator|=
operator|(
name|priv
operator|->
name|media
operator|.
name|ifm_media
operator|&
name|IFM_ETH_RXPAUSE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
operator|=
operator|(
name|priv
operator|->
name|media
operator|.
name|ifm_media
operator|&
name|IFM_ETH_TXPAUSE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
comment|/* check if device is opened */
name|was_opened
operator|=
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
expr_stmt|;
comment|/* reconfigure the hardware */
name|mlx5_set_port_status
argument_list|(
name|mdev
argument_list|,
name|MLX5_PORT_DOWN
argument_list|)
expr_stmt|;
name|mlx5_set_port_proto
argument_list|(
name|mdev
argument_list|,
name|link_mode
argument_list|,
name|MLX5_PTYS_EN
argument_list|)
expr_stmt|;
name|mlx5_set_port_pause
argument_list|(
name|mdev
argument_list|,
literal|1
argument_list|,
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
argument_list|,
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|was_opened
condition|)
name|mlx5_set_port_status
argument_list|(
name|mdev
argument_list|,
name|MLX5_PORT_UP
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
operator|!
name|locked
condition|)
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_update_carrier_work
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx5e_priv
argument_list|,
name|update_carrier_work
argument_list|)
decl_stmt|;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_update_carrier
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This function reads the physical port counters from the firmware  * using a pre-defined layout defined by various MLX5E_PPORT_XXX()  * macros. The output is converted from big-endian 64-bit values into  * host endian ones and stored in the "priv->stats.pport" structure.  */
end_comment

begin_function
specifier|static
name|void
name|mlx5e_update_pport_counters
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx5e_pport_stats
modifier|*
name|s
init|=
operator|&
name|priv
operator|->
name|stats
operator|.
name|pport
decl_stmt|;
name|struct
name|mlx5e_port_stats_debug
modifier|*
name|s_debug
init|=
operator|&
name|priv
operator|->
name|stats
operator|.
name|port_stats_debug
decl_stmt|;
name|u32
modifier|*
name|in
decl_stmt|;
name|u32
modifier|*
name|out
decl_stmt|;
specifier|const
name|u64
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|sz
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|ppcnt_reg
argument_list|)
decl_stmt|;
name|unsigned
name|x
decl_stmt|;
name|unsigned
name|y
decl_stmt|;
comment|/* allocate firmware request structures */
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|sz
argument_list|)
expr_stmt|;
name|out
operator|=
name|mlx5_vzalloc
argument_list|(
name|sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
operator|||
name|out
operator|==
name|NULL
condition|)
goto|goto
name|free_out
goto|;
comment|/* 	 * Get pointer to the 64-bit counter set which is located at a 	 * fixed offset in the output firmware request structure: 	 */
name|ptr
operator|=
operator|(
specifier|const
name|uint64_t
operator|*
operator|)
name|MLX5_ADDR_OF
argument_list|(
name|ppcnt_reg
argument_list|,
name|out
argument_list|,
name|counter_set
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|ppcnt_reg
argument_list|,
name|in
argument_list|,
name|local_port
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* read IEEE802_3 counter group using predefined counter layout */
name|MLX5_SET
argument_list|(
name|ppcnt_reg
argument_list|,
name|in
argument_list|,
name|grp
argument_list|,
name|MLX5_IEEE_802_3_COUNTERS_GROUP
argument_list|)
expr_stmt|;
name|mlx5_core_access_reg
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|sz
argument_list|,
name|out
argument_list|,
name|sz
argument_list|,
name|MLX5_REG_PPCNT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
name|y
operator|=
literal|0
init|;
name|x
operator|!=
name|MLX5E_PPORT_IEEE802_3_STATS_NUM
condition|;
name|x
operator|++
operator|,
name|y
operator|++
control|)
name|s
operator|->
name|arg
index|[
name|y
index|]
operator|=
name|be64toh
argument_list|(
name|ptr
index|[
name|x
index|]
argument_list|)
expr_stmt|;
comment|/* read RFC2819 counter group using predefined counter layout */
name|MLX5_SET
argument_list|(
name|ppcnt_reg
argument_list|,
name|in
argument_list|,
name|grp
argument_list|,
name|MLX5_RFC_2819_COUNTERS_GROUP
argument_list|)
expr_stmt|;
name|mlx5_core_access_reg
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|sz
argument_list|,
name|out
argument_list|,
name|sz
argument_list|,
name|MLX5_REG_PPCNT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|MLX5E_PPORT_RFC2819_STATS_NUM
condition|;
name|x
operator|++
operator|,
name|y
operator|++
control|)
name|s
operator|->
name|arg
index|[
name|y
index|]
operator|=
name|be64toh
argument_list|(
name|ptr
index|[
name|x
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|x
operator|!=
name|MLX5E_PPORT_RFC2819_STATS_NUM
operator|+
name|MLX5E_PPORT_RFC2819_STATS_DEBUG_NUM
condition|;
name|x
operator|++
operator|,
name|y
operator|++
control|)
name|s_debug
operator|->
name|arg
index|[
name|y
index|]
operator|=
name|be64toh
argument_list|(
name|ptr
index|[
name|x
index|]
argument_list|)
expr_stmt|;
comment|/* read RFC2863 counter group using predefined counter layout */
name|MLX5_SET
argument_list|(
name|ppcnt_reg
argument_list|,
name|in
argument_list|,
name|grp
argument_list|,
name|MLX5_RFC_2863_COUNTERS_GROUP
argument_list|)
expr_stmt|;
name|mlx5_core_access_reg
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|sz
argument_list|,
name|out
argument_list|,
name|sz
argument_list|,
name|MLX5_REG_PPCNT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|MLX5E_PPORT_RFC2863_STATS_DEBUG_NUM
condition|;
name|x
operator|++
operator|,
name|y
operator|++
control|)
name|s_debug
operator|->
name|arg
index|[
name|y
index|]
operator|=
name|be64toh
argument_list|(
name|ptr
index|[
name|x
index|]
argument_list|)
expr_stmt|;
comment|/* read physical layer stats counter group using predefined counter layout */
name|MLX5_SET
argument_list|(
name|ppcnt_reg
argument_list|,
name|in
argument_list|,
name|grp
argument_list|,
name|MLX5_PHYSICAL_LAYER_COUNTERS_GROUP
argument_list|)
expr_stmt|;
name|mlx5_core_access_reg
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|sz
argument_list|,
name|out
argument_list|,
name|sz
argument_list|,
name|MLX5_REG_PPCNT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|MLX5E_PPORT_PHYSICAL_LAYER_STATS_DEBUG_NUM
condition|;
name|x
operator|++
operator|,
name|y
operator|++
control|)
name|s_debug
operator|->
name|arg
index|[
name|y
index|]
operator|=
name|be64toh
argument_list|(
name|ptr
index|[
name|x
index|]
argument_list|)
expr_stmt|;
name|free_out
label|:
comment|/* free firmware request structures */
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This function is called regularly to collect all statistics  * counters from the firmware. The values can be viewed through the  * sysctl interface. Execution is serialized using the priv's global  * configuration lock.  */
end_comment

begin_function
specifier|static
name|void
name|mlx5e_update_stats_work
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx5e_priv
argument_list|,
name|update_stats_work
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx5e_vport_stats
modifier|*
name|s
init|=
operator|&
name|priv
operator|->
name|stats
operator|.
name|vport
decl_stmt|;
name|struct
name|mlx5e_rq_stats
modifier|*
name|rq_stats
decl_stmt|;
name|struct
name|mlx5e_sq_stats
modifier|*
name|sq_stats
decl_stmt|;
name|struct
name|buf_ring
modifier|*
name|sq_br
decl_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<
literal|1100000
operator|)
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|priv
operator|->
name|ifp
decl_stmt|;
endif|#
directive|endif
name|u32
name|in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|query_vport_counter_in
argument_list|)
index|]
decl_stmt|;
name|u32
modifier|*
name|out
decl_stmt|;
name|int
name|outlen
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|query_vport_counter_out
argument_list|)
decl_stmt|;
name|u64
name|tso_packets
init|=
literal|0
decl_stmt|;
name|u64
name|tso_bytes
init|=
literal|0
decl_stmt|;
name|u64
name|tx_queue_dropped
init|=
literal|0
decl_stmt|;
name|u64
name|tx_defragged
init|=
literal|0
decl_stmt|;
name|u64
name|tx_offload_none
init|=
literal|0
decl_stmt|;
name|u64
name|lro_packets
init|=
literal|0
decl_stmt|;
name|u64
name|lro_bytes
init|=
literal|0
decl_stmt|;
name|u64
name|sw_lro_queued
init|=
literal|0
decl_stmt|;
name|u64
name|sw_lro_flushed
init|=
literal|0
decl_stmt|;
name|u64
name|rx_csum_none
init|=
literal|0
decl_stmt|;
name|u64
name|rx_wqe_err
init|=
literal|0
decl_stmt|;
name|u32
name|rx_out_of_buffer
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|out
operator|=
name|mlx5_vzalloc
argument_list|(
name|outlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
goto|goto
name|free_out
goto|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|free_out
goto|;
comment|/* Collect firts the SW counters and then HW for consistency */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|params
operator|.
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mlx5e_rq
modifier|*
name|rq
init|=
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
operator|->
name|rq
decl_stmt|;
name|rq_stats
operator|=
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
operator|->
name|rq
operator|.
name|stats
expr_stmt|;
comment|/* collect stats from LRO */
name|rq_stats
operator|->
name|sw_lro_queued
operator|=
name|rq
operator|->
name|lro
operator|.
name|lro_queued
expr_stmt|;
name|rq_stats
operator|->
name|sw_lro_flushed
operator|=
name|rq
operator|->
name|lro
operator|.
name|lro_flushed
expr_stmt|;
name|sw_lro_queued
operator|+=
name|rq_stats
operator|->
name|sw_lro_queued
expr_stmt|;
name|sw_lro_flushed
operator|+=
name|rq_stats
operator|->
name|sw_lro_flushed
expr_stmt|;
name|lro_packets
operator|+=
name|rq_stats
operator|->
name|lro_packets
expr_stmt|;
name|lro_bytes
operator|+=
name|rq_stats
operator|->
name|lro_bytes
expr_stmt|;
name|rx_csum_none
operator|+=
name|rq_stats
operator|->
name|csum_none
expr_stmt|;
name|rx_wqe_err
operator|+=
name|rq_stats
operator|->
name|wqe_err
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|priv
operator|->
name|num_tc
condition|;
name|j
operator|++
control|)
block|{
name|sq_stats
operator|=
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
operator|->
name|sq
index|[
name|j
index|]
operator|.
name|stats
expr_stmt|;
name|sq_br
operator|=
name|priv
operator|->
name|channel
index|[
name|i
index|]
operator|->
name|sq
index|[
name|j
index|]
operator|.
name|br
expr_stmt|;
name|tso_packets
operator|+=
name|sq_stats
operator|->
name|tso_packets
expr_stmt|;
name|tso_bytes
operator|+=
name|sq_stats
operator|->
name|tso_bytes
expr_stmt|;
name|tx_queue_dropped
operator|+=
name|sq_stats
operator|->
name|dropped
expr_stmt|;
name|tx_queue_dropped
operator|+=
name|sq_br
operator|->
name|br_drops
expr_stmt|;
name|tx_defragged
operator|+=
name|sq_stats
operator|->
name|defragged
expr_stmt|;
name|tx_offload_none
operator|+=
name|sq_stats
operator|->
name|csum_offload_none
expr_stmt|;
block|}
block|}
comment|/* update counters */
name|s
operator|->
name|tso_packets
operator|=
name|tso_packets
expr_stmt|;
name|s
operator|->
name|tso_bytes
operator|=
name|tso_bytes
expr_stmt|;
name|s
operator|->
name|tx_queue_dropped
operator|=
name|tx_queue_dropped
expr_stmt|;
name|s
operator|->
name|tx_defragged
operator|=
name|tx_defragged
expr_stmt|;
name|s
operator|->
name|lro_packets
operator|=
name|lro_packets
expr_stmt|;
name|s
operator|->
name|lro_bytes
operator|=
name|lro_bytes
expr_stmt|;
name|s
operator|->
name|sw_lro_queued
operator|=
name|sw_lro_queued
expr_stmt|;
name|s
operator|->
name|sw_lro_flushed
operator|=
name|sw_lro_flushed
expr_stmt|;
name|s
operator|->
name|rx_csum_none
operator|=
name|rx_csum_none
expr_stmt|;
name|s
operator|->
name|rx_wqe_err
operator|=
name|rx_wqe_err
expr_stmt|;
comment|/* HW counters */
name|memset
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|query_vport_counter_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_QUERY_VPORT_COUNTER
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|query_vport_counter_in
argument_list|,
name|in
argument_list|,
name|op_mod
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|query_vport_counter_in
argument_list|,
name|in
argument_list|,
name|other_vport
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
name|outlen
argument_list|)
expr_stmt|;
comment|/* get number of out-of-buffer drops first */
if|if
condition|(
name|mlx5_vport_query_out_of_rx_buffer
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|counter_set_id
argument_list|,
operator|&
name|rx_out_of_buffer
argument_list|)
condition|)
goto|goto
name|free_out
goto|;
comment|/* accumulate difference into a 64-bit counter */
name|s
operator|->
name|rx_out_of_buffer
operator|+=
call|(
name|u64
call|)
argument_list|(
name|u32
argument_list|)
argument_list|(
name|rx_out_of_buffer
operator|-
name|s
operator|->
name|rx_out_of_buffer_prev
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_out_of_buffer_prev
operator|=
name|rx_out_of_buffer
expr_stmt|;
comment|/* get port statistics */
if|if
condition|(
name|mlx5_cmd_exec
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|out
argument_list|,
name|outlen
argument_list|)
condition|)
goto|goto
name|free_out
goto|;
define|#
directive|define
name|MLX5_GET_CTR
parameter_list|(
name|out
parameter_list|,
name|x
parameter_list|)
define|\
value|MLX5_GET64(query_vport_counter_out, out, x)
name|s
operator|->
name|rx_error_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_errors
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_error_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_errors
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_error_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmit_errors
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_error_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmit_errors
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_unicast_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_eth_unicast
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_unicast_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_eth_unicast
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_unicast_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmitted_eth_unicast
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_unicast_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmitted_eth_unicast
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_multicast_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_eth_multicast
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_multicast_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_eth_multicast
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_multicast_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmitted_eth_multicast
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_multicast_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmitted_eth_multicast
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_broadcast_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_eth_broadcast
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_broadcast_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|received_eth_broadcast
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_broadcast_packets
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmitted_eth_broadcast
operator|.
name|packets
argument_list|)
expr_stmt|;
name|s
operator|->
name|tx_broadcast_bytes
operator|=
name|MLX5_GET_CTR
argument_list|(
name|out
argument_list|,
name|transmitted_eth_broadcast
operator|.
name|octets
argument_list|)
expr_stmt|;
name|s
operator|->
name|rx_packets
operator|=
name|s
operator|->
name|rx_unicast_packets
operator|+
name|s
operator|->
name|rx_multicast_packets
operator|+
name|s
operator|->
name|rx_broadcast_packets
operator|-
name|s
operator|->
name|rx_out_of_buffer
expr_stmt|;
name|s
operator|->
name|rx_bytes
operator|=
name|s
operator|->
name|rx_unicast_bytes
operator|+
name|s
operator|->
name|rx_multicast_bytes
operator|+
name|s
operator|->
name|rx_broadcast_bytes
expr_stmt|;
name|s
operator|->
name|tx_packets
operator|=
name|s
operator|->
name|tx_unicast_packets
operator|+
name|s
operator|->
name|tx_multicast_packets
operator|+
name|s
operator|->
name|tx_broadcast_packets
expr_stmt|;
name|s
operator|->
name|tx_bytes
operator|=
name|s
operator|->
name|tx_unicast_bytes
operator|+
name|s
operator|->
name|tx_multicast_bytes
operator|+
name|s
operator|->
name|tx_broadcast_bytes
expr_stmt|;
comment|/* Update calculated offload counters */
name|s
operator|->
name|tx_csum_offload
operator|=
name|s
operator|->
name|tx_packets
operator|-
name|tx_offload_none
expr_stmt|;
name|s
operator|->
name|rx_csum_good
operator|=
name|s
operator|->
name|rx_packets
operator|-
name|s
operator|->
name|rx_csum_none
expr_stmt|;
comment|/* Get physical port counters */
name|mlx5e_update_pport_counters
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<
literal|1100000
operator|)
comment|/* no get_counters interface in fbsd 10 */
name|ifp
operator|->
name|if_ipackets
operator|=
name|s
operator|->
name|rx_packets
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|=
name|s
operator|->
name|rx_error_packets
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|alignment_err
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|check_seq_err
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|crc_align_errors
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|drop_events
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|in_range_len_errors
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|jabbers
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|out_of_range_len
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|oversize_pkts
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|symbol_err
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|too_long_errors
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|undersize_pkts
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|unsupported_op_rx
expr_stmt|;
name|ifp
operator|->
name|if_iqdrops
operator|=
name|s
operator|->
name|rx_out_of_buffer
expr_stmt|;
name|ifp
operator|->
name|if_opackets
operator|=
name|s
operator|->
name|tx_packets
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|=
name|s
operator|->
name|tx_error_packets
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drops
operator|=
name|s
operator|->
name|tx_queue_dropped
expr_stmt|;
name|ifp
operator|->
name|if_ibytes
operator|=
name|s
operator|->
name|rx_bytes
expr_stmt|;
name|ifp
operator|->
name|if_obytes
operator|=
name|s
operator|->
name|tx_bytes
expr_stmt|;
name|ifp
operator|->
name|if_collisions
operator|=
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|collisions
expr_stmt|;
endif|#
directive|endif
name|free_out
label|:
name|kvfree
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_update_stats
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|arg
decl_stmt|;
name|schedule_work
argument_list|(
operator|&
name|priv
operator|->
name|update_stats_work
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|priv
operator|->
name|watchdog
argument_list|,
name|hz
argument_list|,
operator|&
name|mlx5e_update_stats
argument_list|,
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_async_event_sub
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|enum
name|mlx5_dev_event
name|event
parameter_list|)
block|{
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|MLX5_DEV_EVENT_PORT_UP
case|:
case|case
name|MLX5_DEV_EVENT_PORT_DOWN
case|:
name|schedule_work
argument_list|(
operator|&
name|priv
operator|->
name|update_carrier_work
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_async_event
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|,
name|void
modifier|*
name|vpriv
parameter_list|,
name|enum
name|mlx5_dev_event
name|event
parameter_list|,
name|unsigned
name|long
name|param
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|vpriv
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_ASYNC_EVENTS_ENABLE
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_async_event_sub
argument_list|(
name|priv
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_enable_async_events
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|set_bit
argument_list|(
name|MLX5E_STATE_ASYNC_EVENTS_ENABLE
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_disable_async_events
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|)
expr_stmt|;
name|clear_bit
argument_list|(
name|MLX5E_STATE_ASYNC_EVENTS_ENABLE
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|mlx5e_rq_stats_desc
index|[]
init|=
block|{
name|MLX5E_RQ_STATS
argument_list|(
argument|MLX5E_STATS_DESC
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mlx5e_create_rq
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|,
name|struct
name|mlx5e_rq_param
modifier|*
name|param
parameter_list|,
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|c
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
name|void
modifier|*
name|rqc
init|=
name|param
operator|->
name|rqc
decl_stmt|;
name|void
modifier|*
name|rqc_wq
init|=
name|MLX5_ADDR_OF
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|wq
argument_list|)
decl_stmt|;
name|int
name|wq_sz
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Create DMA descriptor TAG */
if|if
condition|(
operator|(
name|err
operator|=
operator|-
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|)
argument_list|,
literal|1
argument_list|,
comment|/* any alignment */
literal|0
argument_list|,
comment|/* no boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MJUM16BYTES
argument_list|,
comment|/* maxsize */
literal|1
argument_list|,
comment|/* nsegments */
name|MJUM16BYTES
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
operator|&
name|rq
operator|->
name|dma_tag
argument_list|)
operator|)
condition|)
goto|goto
name|done
goto|;
name|err
operator|=
name|mlx5_wq_ll_create
argument_list|(
name|mdev
argument_list|,
operator|&
name|param
operator|->
name|wq
argument_list|,
name|rqc_wq
argument_list|,
operator|&
name|rq
operator|->
name|wq
argument_list|,
operator|&
name|rq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_dma_tag
goto|;
name|rq
operator|->
name|wq
operator|.
name|db
operator|=
operator|&
name|rq
operator|->
name|wq
operator|.
name|db
index|[
name|MLX5_RCV_DBR
index|]
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|params
operator|.
name|hw_lro_en
condition|)
block|{
name|rq
operator|->
name|wqe_sz
operator|=
name|priv
operator|->
name|params
operator|.
name|lro_wqe_sz
expr_stmt|;
block|}
else|else
block|{
name|rq
operator|->
name|wqe_sz
operator|=
name|MLX5E_SW2MB_MTU
argument_list|(
name|priv
operator|->
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rq
operator|->
name|wqe_sz
operator|>
name|MJUM16BYTES
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_rq_wq_destroy
goto|;
block|}
elseif|else
if|if
condition|(
name|rq
operator|->
name|wqe_sz
operator|>
name|MJUM9BYTES
condition|)
block|{
name|rq
operator|->
name|wqe_sz
operator|=
name|MJUM16BYTES
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rq
operator|->
name|wqe_sz
operator|>
name|MJUMPAGESIZE
condition|)
block|{
name|rq
operator|->
name|wqe_sz
operator|=
name|MJUM9BYTES
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rq
operator|->
name|wqe_sz
operator|>
name|MCLBYTES
condition|)
block|{
name|rq
operator|->
name|wqe_sz
operator|=
name|MJUMPAGESIZE
expr_stmt|;
block|}
else|else
block|{
name|rq
operator|->
name|wqe_sz
operator|=
name|MCLBYTES
expr_stmt|;
block|}
name|wq_sz
operator|=
name|mlx5_wq_ll_get_size
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|)
expr_stmt|;
name|rq
operator|->
name|mbuf
operator|=
name|malloc
argument_list|(
name|wq_sz
operator|*
sizeof|sizeof
argument_list|(
name|rq
operator|->
name|mbuf
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|wq_sz
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mlx5e_rx_wqe
modifier|*
name|wqe
init|=
name|mlx5_wq_ll_get_wqe
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|uint32_t
name|byte_count
init|=
name|rq
operator|->
name|wqe_sz
operator|-
name|MLX5E_NET_IP_ALIGN
decl_stmt|;
name|err
operator|=
operator|-
name|bus_dmamap_create
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|rq
operator|->
name|mbuf
index|[
name|i
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
while|while
condition|(
name|i
operator|--
condition|)
name|bus_dmamap_destroy
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|i
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
goto|goto
name|err_rq_mbuf_free
goto|;
block|}
name|wqe
operator|->
name|data
operator|.
name|lkey
operator|=
name|c
operator|->
name|mkey_be
expr_stmt|;
name|wqe
operator|->
name|data
operator|.
name|byte_count
operator|=
name|cpu_to_be32
argument_list|(
name|byte_count
operator||
name|MLX5_HW_START_PADDING
argument_list|)
expr_stmt|;
block|}
name|rq
operator|->
name|ifp
operator|=
name|c
operator|->
name|ifp
expr_stmt|;
name|rq
operator|->
name|channel
operator|=
name|c
expr_stmt|;
name|rq
operator|->
name|ix
operator|=
name|c
operator|->
name|ix
expr_stmt|;
name|snprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
literal|"rxstat%d"
argument_list|,
name|c
operator|->
name|ix
argument_list|)
expr_stmt|;
name|mlx5e_create_stats
argument_list|(
operator|&
name|rq
operator|->
name|stats
operator|.
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_ifnet
argument_list|)
argument_list|,
name|buffer
argument_list|,
name|mlx5e_rq_stats_desc
argument_list|,
name|MLX5E_RQ_STATS_NUM
argument_list|,
name|rq
operator|->
name|stats
operator|.
name|arg
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_TURBO_LRO
if|if
condition|(
name|tcp_tlro_init
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|,
name|c
operator|->
name|ifp
argument_list|,
name|MLX5E_BUDGET_MAX
argument_list|)
operator|!=
literal|0
condition|)
name|rq
operator|->
name|lro
operator|.
name|mbuf
operator|=
name|NULL
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|tcp_lro_init
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|)
condition|)
name|rq
operator|->
name|lro
operator|.
name|lro_cnt
operator|=
literal|0
expr_stmt|;
else|else
name|rq
operator|->
name|lro
operator|.
name|ifp
operator|=
name|c
operator|->
name|ifp
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
name|err_rq_mbuf_free
label|:
name|free
argument_list|(
name|rq
operator|->
name|mbuf
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
name|err_rq_wq_destroy
label|:
name|mlx5_wq_destroy
argument_list|(
operator|&
name|rq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
name|err_free_dma_tag
label|:
name|bus_dma_tag_destroy
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_destroy_rq
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
name|int
name|wq_sz
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* destroy all sysctl nodes */
name|sysctl_ctx_free
argument_list|(
operator|&
name|rq
operator|->
name|stats
operator|.
name|ctx
argument_list|)
expr_stmt|;
comment|/* free leftover LRO packets, if any */
ifdef|#
directive|ifdef
name|HAVE_TURBO_LRO
name|tcp_tlro_free
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|)
expr_stmt|;
else|#
directive|else
name|tcp_lro_free
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|wq_sz
operator|=
name|mlx5_wq_ll_get_size
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|wq_sz
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rq
operator|->
name|mbuf
index|[
name|i
index|]
operator|.
name|mbuf
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|i
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rq
operator|->
name|mbuf
index|[
name|i
index|]
operator|.
name|mbuf
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_destroy
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|i
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|rq
operator|->
name|mbuf
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
name|mlx5_wq_destroy
argument_list|(
operator|&
name|rq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_enable_rq
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|mlx5e_rq_param
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|mlx5e_channel
modifier|*
name|c
init|=
name|rq
operator|->
name|channel
decl_stmt|;
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|c
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|void
modifier|*
name|in
decl_stmt|;
name|void
modifier|*
name|rqc
decl_stmt|;
name|void
modifier|*
name|wq
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|inlen
operator|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|create_rq_in
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|*
name|rq
operator|->
name|wq_ctrl
operator|.
name|buf
operator|.
name|npages
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|rqc
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|create_rq_in
argument_list|,
name|in
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|wq
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|wq
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rqc
argument_list|,
name|param
operator|->
name|rqc
argument_list|,
sizeof|sizeof
argument_list|(
name|param
operator|->
name|rqc
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|cqn
argument_list|,
name|c
operator|->
name|rq
operator|.
name|cq
operator|.
name|mcq
operator|.
name|cqn
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|state
argument_list|,
name|MLX5_RQC_STATE_RST
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|flush_in_error_en
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|counter_set_id
operator|>=
literal|0
condition|)
name|MLX5_SET
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|counter_set_id
argument_list|,
name|priv
operator|->
name|counter_set_id
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|log_wq_pg_sz
argument_list|,
name|rq
operator|->
name|wq_ctrl
operator|.
name|buf
operator|.
name|page_shift
operator|-
name|PAGE_SHIFT
argument_list|)
expr_stmt|;
name|MLX5_SET64
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|dbr_addr
argument_list|,
name|rq
operator|->
name|wq_ctrl
operator|.
name|db
operator|.
name|dma
argument_list|)
expr_stmt|;
name|mlx5_fill_page_array
argument_list|(
operator|&
name|rq
operator|->
name|wq_ctrl
operator|.
name|buf
argument_list|,
operator|(
name|__be64
operator|*
operator|)
name|MLX5_ADDR_OF
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|pas
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_rq
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
operator|&
name|rq
operator|->
name|rqn
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_modify_rq
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|,
name|int
name|curr_state
parameter_list|,
name|int
name|next_state
parameter_list|)
block|{
name|struct
name|mlx5e_channel
modifier|*
name|c
init|=
name|rq
operator|->
name|channel
decl_stmt|;
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|c
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|void
modifier|*
name|in
decl_stmt|;
name|void
modifier|*
name|rqc
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|inlen
operator|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|modify_rq_in
argument_list|)
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|rqc
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|modify_rq_in
argument_list|,
name|in
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|modify_rq_in
argument_list|,
name|in
argument_list|,
name|rqn
argument_list|,
name|rq
operator|->
name|rqn
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|modify_rq_in
argument_list|,
name|in
argument_list|,
name|rq_state
argument_list|,
name|curr_state
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|state
argument_list|,
name|next_state
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_modify_rq
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_disable_rq
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
name|struct
name|mlx5e_channel
modifier|*
name|c
init|=
name|rq
operator|->
name|channel
decl_stmt|;
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|c
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|mlx5_core_destroy_rq
argument_list|(
name|mdev
argument_list|,
name|rq
operator|->
name|rqn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_wait_for_min_rx_wqes
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
name|struct
name|mlx5e_channel
modifier|*
name|c
init|=
name|rq
operator|->
name|channel
decl_stmt|;
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|c
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_wq_ll
modifier|*
name|wq
init|=
operator|&
name|rq
operator|->
name|wq
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wq
operator|->
name|cur_sz
operator|>=
name|priv
operator|->
name|params
operator|.
name|min_rx_wqes
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|msleep
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
name|ETIMEDOUT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_rq
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|,
name|struct
name|mlx5e_rq_param
modifier|*
name|param
parameter_list|,
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5e_create_rq
argument_list|(
name|c
argument_list|,
name|param
argument_list|,
name|rq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|err
operator|=
name|mlx5e_enable_rq
argument_list|(
name|rq
argument_list|,
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_destroy_rq
goto|;
name|err
operator|=
name|mlx5e_modify_rq
argument_list|(
name|rq
argument_list|,
name|MLX5_RQC_STATE_RST
argument_list|,
name|MLX5_RQC_STATE_RDY
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_disable_rq
goto|;
name|c
operator|->
name|rq
operator|.
name|enabled
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_disable_rq
label|:
name|mlx5e_disable_rq
argument_list|(
name|rq
argument_list|)
expr_stmt|;
name|err_destroy_rq
label|:
name|mlx5e_destroy_rq
argument_list|(
name|rq
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_rq
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|rq
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|rq
operator|->
name|enabled
operator|=
literal|0
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|rq
operator|->
name|watchdog
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rq
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|rq
operator|->
name|watchdog
argument_list|)
expr_stmt|;
name|mlx5e_modify_rq
argument_list|(
name|rq
argument_list|,
name|MLX5_RQC_STATE_RDY
argument_list|,
name|MLX5_RQC_STATE_ERR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_rq_wait
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
comment|/* wait till RQ is empty */
while|while
condition|(
operator|!
name|mlx5_wq_ll_is_empty
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|)
condition|)
block|{
name|msleep
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|rq
operator|->
name|cq
operator|.
name|mcq
operator|.
name|comp
argument_list|(
operator|&
name|rq
operator|->
name|cq
operator|.
name|mcq
argument_list|)
expr_stmt|;
block|}
name|mlx5e_disable_rq
argument_list|(
name|rq
argument_list|)
expr_stmt|;
name|mlx5e_destroy_rq
argument_list|(
name|rq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx5e_free_sq_db
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
name|int
name|wq_sz
init|=
name|mlx5_wq_cyc_get_size
argument_list|(
operator|&
name|sq
operator|->
name|wq
argument_list|)
decl_stmt|;
name|int
name|x
decl_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|wq_sz
condition|;
name|x
operator|++
control|)
name|bus_dmamap_destroy
argument_list|(
name|sq
operator|->
name|dma_tag
argument_list|,
name|sq
operator|->
name|mbuf
index|[
name|x
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sq
operator|->
name|mbuf
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5e_alloc_sq_db
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
name|int
name|wq_sz
init|=
name|mlx5_wq_cyc_get_size
argument_list|(
operator|&
name|sq
operator|->
name|wq
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|x
decl_stmt|;
name|sq
operator|->
name|mbuf
operator|=
name|malloc
argument_list|(
name|wq_sz
operator|*
sizeof|sizeof
argument_list|(
name|sq
operator|->
name|mbuf
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
comment|/* Create DMA descriptor MAPs */
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|!=
name|wq_sz
condition|;
name|x
operator|++
control|)
block|{
name|err
operator|=
operator|-
name|bus_dmamap_create
argument_list|(
name|sq
operator|->
name|dma_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|sq
operator|->
name|mbuf
index|[
name|x
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
while|while
condition|(
name|x
operator|--
condition|)
name|bus_dmamap_destroy
argument_list|(
name|sq
operator|->
name|dma_tag
argument_list|,
name|sq
operator|->
name|mbuf
index|[
name|x
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sq
operator|->
name|mbuf
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|mlx5e_sq_stats_desc
index|[]
init|=
block|{
name|MLX5E_SQ_STATS
argument_list|(
argument|MLX5E_STATS_DESC
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mlx5e_create_sq
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|,
name|int
name|tc
parameter_list|,
name|struct
name|mlx5e_sq_param
modifier|*
name|param
parameter_list|,
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|c
operator|->
name|priv
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|char
name|buffer
index|[
literal|16
index|]
decl_stmt|;
name|void
modifier|*
name|sqc
init|=
name|param
operator|->
name|sqc
decl_stmt|;
name|void
modifier|*
name|sqc_wq
init|=
name|MLX5_ADDR_OF
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|wq
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|RSS
name|cpuset_t
name|cpu_mask
decl_stmt|;
name|int
name|cpu_id
decl_stmt|;
endif|#
directive|endif
name|int
name|err
decl_stmt|;
comment|/* Create DMA descriptor TAG */
if|if
condition|(
operator|(
name|err
operator|=
operator|-
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|)
argument_list|,
literal|1
argument_list|,
comment|/* any alignment */
literal|0
argument_list|,
comment|/* no boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MLX5E_MAX_TX_PAYLOAD_SIZE
argument_list|,
comment|/* maxsize */
name|MLX5E_MAX_TX_MBUF_FRAGS
argument_list|,
comment|/* nsegments */
name|MLX5E_MAX_TX_MBUF_SIZE
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
operator|&
name|sq
operator|->
name|dma_tag
argument_list|)
operator|)
condition|)
goto|goto
name|done
goto|;
name|err
operator|=
name|mlx5_alloc_map_uar
argument_list|(
name|mdev
argument_list|,
operator|&
name|sq
operator|->
name|uar
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_dma_tag
goto|;
name|err
operator|=
name|mlx5_wq_cyc_create
argument_list|(
name|mdev
argument_list|,
operator|&
name|param
operator|->
name|wq
argument_list|,
name|sqc_wq
argument_list|,
operator|&
name|sq
operator|->
name|wq
argument_list|,
operator|&
name|sq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_unmap_free_uar
goto|;
name|sq
operator|->
name|wq
operator|.
name|db
operator|=
operator|&
name|sq
operator|->
name|wq
operator|.
name|db
index|[
name|MLX5_SND_DBR
index|]
expr_stmt|;
name|sq
operator|->
name|bf_buf_size
operator|=
operator|(
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_bf_reg_size
argument_list|)
operator|)
operator|/
literal|2
expr_stmt|;
name|err
operator|=
name|mlx5e_alloc_sq_db
argument_list|(
name|sq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_sq_wq_destroy
goto|;
name|sq
operator|->
name|mkey_be
operator|=
name|c
operator|->
name|mkey_be
expr_stmt|;
name|sq
operator|->
name|ifp
operator|=
name|priv
operator|->
name|ifp
expr_stmt|;
name|sq
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|sq
operator|->
name|tc
operator|=
name|tc
expr_stmt|;
name|sq
operator|->
name|br
operator|=
name|buf_ring_alloc
argument_list|(
name|MLX5E_SQ_TX_QUEUE_SIZE
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
argument_list|,
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|sq
operator|->
name|br
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|c
operator|->
name|ifp
argument_list|,
literal|"%s: Failed allocating sq drbr buffer\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free_sq_db
goto|;
block|}
name|sq
operator|->
name|sq_tq
operator|=
name|taskqueue_create_fast
argument_list|(
literal|"mlx5e_que"
argument_list|,
name|M_WAITOK
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|sq
operator|->
name|sq_tq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sq
operator|->
name|sq_tq
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|c
operator|->
name|ifp
argument_list|,
literal|"%s: Failed allocating taskqueue\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free_drbr
goto|;
block|}
name|TASK_INIT
argument_list|(
operator|&
name|sq
operator|->
name|sq_task
argument_list|,
literal|0
argument_list|,
name|mlx5e_tx_que
argument_list|,
name|sq
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RSS
name|cpu_id
operator|=
name|rss_getcpu
argument_list|(
name|c
operator|->
name|ix
operator|%
name|rss_getnumbuckets
argument_list|()
argument_list|)
expr_stmt|;
name|CPU_SETOF
argument_list|(
name|cpu_id
argument_list|,
operator|&
name|cpu_mask
argument_list|)
expr_stmt|;
name|taskqueue_start_threads_cpuset
argument_list|(
operator|&
name|sq
operator|->
name|sq_tq
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
operator|&
name|cpu_mask
argument_list|,
literal|"%s TX SQ%d.%d CPU%d"
argument_list|,
name|c
operator|->
name|ifp
operator|->
name|if_xname
argument_list|,
name|c
operator|->
name|ix
argument_list|,
name|tc
argument_list|,
name|cpu_id
argument_list|)
expr_stmt|;
else|#
directive|else
name|taskqueue_start_threads
argument_list|(
operator|&
name|sq
operator|->
name|sq_tq
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s TX SQ%d.%d"
argument_list|,
name|c
operator|->
name|ifp
operator|->
name|if_xname
argument_list|,
name|c
operator|->
name|ix
argument_list|,
name|tc
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|snprintf
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
literal|"txstat%dtc%d"
argument_list|,
name|c
operator|->
name|ix
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|mlx5e_create_stats
argument_list|(
operator|&
name|sq
operator|->
name|stats
operator|.
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_ifnet
argument_list|)
argument_list|,
name|buffer
argument_list|,
name|mlx5e_sq_stats_desc
argument_list|,
name|MLX5E_SQ_STATS_NUM
argument_list|,
name|sq
operator|->
name|stats
operator|.
name|arg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_free_drbr
label|:
name|buf_ring_free
argument_list|(
name|sq
operator|->
name|br
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
name|err_free_sq_db
label|:
name|mlx5e_free_sq_db
argument_list|(
name|sq
argument_list|)
expr_stmt|;
name|err_sq_wq_destroy
label|:
name|mlx5_wq_destroy
argument_list|(
operator|&
name|sq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
name|err_unmap_free_uar
label|:
name|mlx5_unmap_free_uar
argument_list|(
name|mdev
argument_list|,
operator|&
name|sq
operator|->
name|uar
argument_list|)
expr_stmt|;
name|err_free_dma_tag
label|:
name|bus_dma_tag_destroy
argument_list|(
name|sq
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|done
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_destroy_sq
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
comment|/* destroy all sysctl nodes */
name|sysctl_ctx_free
argument_list|(
operator|&
name|sq
operator|->
name|stats
operator|.
name|ctx
argument_list|)
expr_stmt|;
name|mlx5e_free_sq_db
argument_list|(
name|sq
argument_list|)
expr_stmt|;
name|mlx5_wq_destroy
argument_list|(
operator|&
name|sq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
name|mlx5_unmap_free_uar
argument_list|(
name|sq
operator|->
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|sq
operator|->
name|uar
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sq
operator|->
name|sq_tq
argument_list|,
operator|&
name|sq
operator|->
name|sq_task
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|sq
operator|->
name|sq_tq
argument_list|)
expr_stmt|;
name|buf_ring_free
argument_list|(
name|sq
operator|->
name|br
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5e_enable_sq
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|,
name|struct
name|mlx5e_sq_param
modifier|*
name|param
parameter_list|,
name|int
name|tis_num
parameter_list|)
block|{
name|void
modifier|*
name|in
decl_stmt|;
name|void
modifier|*
name|sqc
decl_stmt|;
name|void
modifier|*
name|wq
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|inlen
operator|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|create_sq_in
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|*
name|sq
operator|->
name|wq_ctrl
operator|.
name|buf
operator|.
name|npages
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|sqc
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|create_sq_in
argument_list|,
name|in
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|wq
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|wq
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sqc
argument_list|,
name|param
operator|->
name|sqc
argument_list|,
sizeof|sizeof
argument_list|(
name|param
operator|->
name|sqc
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|tis_num_0
argument_list|,
name|tis_num
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|cqn
argument_list|,
name|sq
operator|->
name|cq
operator|.
name|mcq
operator|.
name|cqn
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|state
argument_list|,
name|MLX5_SQC_STATE_RST
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|tis_lst_sz
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|flush_in_error_en
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|wq_type
argument_list|,
name|MLX5_WQ_TYPE_CYCLIC
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|uar_page
argument_list|,
name|sq
operator|->
name|uar
operator|.
name|index
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|log_wq_pg_sz
argument_list|,
name|sq
operator|->
name|wq_ctrl
operator|.
name|buf
operator|.
name|page_shift
operator|-
name|PAGE_SHIFT
argument_list|)
expr_stmt|;
name|MLX5_SET64
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|dbr_addr
argument_list|,
name|sq
operator|->
name|wq_ctrl
operator|.
name|db
operator|.
name|dma
argument_list|)
expr_stmt|;
name|mlx5_fill_page_array
argument_list|(
operator|&
name|sq
operator|->
name|wq_ctrl
operator|.
name|buf
argument_list|,
operator|(
name|__be64
operator|*
operator|)
name|MLX5_ADDR_OF
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|pas
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_sq
argument_list|(
name|sq
operator|->
name|priv
operator|->
name|mdev
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
operator|&
name|sq
operator|->
name|sqn
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mlx5e_modify_sq
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|,
name|int
name|curr_state
parameter_list|,
name|int
name|next_state
parameter_list|)
block|{
name|void
modifier|*
name|in
decl_stmt|;
name|void
modifier|*
name|sqc
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|inlen
operator|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|modify_sq_in
argument_list|)
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|sqc
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|modify_sq_in
argument_list|,
name|in
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|modify_sq_in
argument_list|,
name|in
argument_list|,
name|sqn
argument_list|,
name|sq
operator|->
name|sqn
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|modify_sq_in
argument_list|,
name|in
argument_list|,
name|sq_state
argument_list|,
name|curr_state
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|state
argument_list|,
name|next_state
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_modify_sq
argument_list|(
name|sq
operator|->
name|priv
operator|->
name|mdev
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mlx5e_disable_sq
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
name|mlx5_core_destroy_sq
argument_list|(
name|sq
operator|->
name|priv
operator|->
name|mdev
argument_list|,
name|sq
operator|->
name|sqn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_sq
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|,
name|int
name|tc
parameter_list|,
name|struct
name|mlx5e_sq_param
modifier|*
name|param
parameter_list|,
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5e_create_sq
argument_list|(
name|c
argument_list|,
name|tc
argument_list|,
name|param
argument_list|,
name|sq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|err
operator|=
name|mlx5e_enable_sq
argument_list|(
name|sq
argument_list|,
name|param
argument_list|,
name|c
operator|->
name|priv
operator|->
name|tisn
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_destroy_sq
goto|;
name|err
operator|=
name|mlx5e_modify_sq
argument_list|(
name|sq
argument_list|,
name|MLX5_SQC_STATE_RST
argument_list|,
name|MLX5_SQC_STATE_RDY
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_disable_sq
goto|;
name|atomic_store_rel_int
argument_list|(
operator|&
name|sq
operator|->
name|queue_state
argument_list|,
name|MLX5E_SQ_READY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_disable_sq
label|:
name|mlx5e_disable_sq
argument_list|(
name|sq
argument_list|)
expr_stmt|;
name|err_destroy_sq
label|:
name|mlx5e_destroy_sq
argument_list|(
name|sq
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_sq_send_nops_locked
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|,
name|int
name|can_sleep
parameter_list|)
block|{
comment|/* fill up remainder with NOPs */
while|while
condition|(
name|sq
operator|->
name|cev_counter
operator|!=
literal|0
condition|)
block|{
while|while
condition|(
operator|!
name|mlx5e_sq_has_room_for
argument_list|(
name|sq
argument_list|,
literal|1
argument_list|)
condition|)
block|{
if|if
condition|(
name|can_sleep
operator|!=
literal|0
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|done
goto|;
block|}
block|}
comment|/* send a single NOP */
name|mlx5e_send_nop
argument_list|(
name|sq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
block|}
name|done
label|:
comment|/* Check if we need to write the doorbell */
if|if
condition|(
name|likely
argument_list|(
name|sq
operator|->
name|doorbell
operator|.
name|d64
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|mlx5e_tx_notify_hw
argument_list|(
name|sq
argument_list|,
name|sq
operator|->
name|doorbell
operator|.
name|d32
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sq
operator|->
name|doorbell
operator|.
name|d64
operator|=
literal|0
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|mlx5e_sq_cev_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx5e_sq
modifier|*
name|sq
init|=
name|arg
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* check next state */
switch|switch
condition|(
name|sq
operator|->
name|cev_next_state
condition|)
block|{
case|case
name|MLX5E_CEV_STATE_SEND_NOPS
case|:
comment|/* fill TX ring with NOPs, if any */
name|mlx5e_sq_send_nops_locked
argument_list|(
name|sq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* check if completed */
if|if
condition|(
name|sq
operator|->
name|cev_counter
operator|==
literal|0
condition|)
block|{
name|sq
operator|->
name|cev_next_state
operator|=
name|MLX5E_CEV_STATE_INITIAL
expr_stmt|;
return|return;
block|}
break|break;
default|default:
comment|/* send NOPs on next timeout */
name|sq
operator|->
name|cev_next_state
operator|=
name|MLX5E_CEV_STATE_SEND_NOPS
expr_stmt|;
break|break;
block|}
comment|/* restart timer */
name|callout_reset_curcpu
argument_list|(
operator|&
name|sq
operator|->
name|cev_callout
argument_list|,
name|hz
argument_list|,
name|mlx5e_sq_cev_timeout
argument_list|,
name|sq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx5e_drain_sq
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* teardown event factor timer, if any */
name|sq
operator|->
name|cev_next_state
operator|=
name|MLX5E_CEV_STATE_HOLD_NOPS
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sq
operator|->
name|cev_callout
argument_list|)
expr_stmt|;
comment|/* send dummy NOPs in order to flush the transmit ring */
name|mlx5e_sq_send_nops_locked
argument_list|(
name|sq
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* make sure it is safe to free the callout */
name|callout_drain
argument_list|(
operator|&
name|sq
operator|->
name|cev_callout
argument_list|)
expr_stmt|;
comment|/* error out remaining requests */
name|mlx5e_modify_sq
argument_list|(
name|sq
argument_list|,
name|MLX5_SQC_STATE_RDY
argument_list|,
name|MLX5_SQC_STATE_ERR
argument_list|)
expr_stmt|;
comment|/* wait till SQ is empty */
name|mtx_lock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|sq
operator|->
name|cc
operator|!=
name|sq
operator|->
name|pc
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|sq
operator|->
name|cq
operator|.
name|mcq
operator|.
name|comp
argument_list|(
operator|&
name|sq
operator|->
name|cq
operator|.
name|mcq
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_sq_wait
parameter_list|(
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
name|mlx5e_drain_sq
argument_list|(
name|sq
argument_list|)
expr_stmt|;
name|mlx5e_disable_sq
argument_list|(
name|sq
argument_list|)
expr_stmt|;
name|mlx5e_destroy_sq
argument_list|(
name|sq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_create_cq
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_cq_param
modifier|*
name|param
parameter_list|,
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|,
name|mlx5e_cq_comp_t
modifier|*
name|comp
parameter_list|,
name|int
name|eq_ix
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx5_core_cq
modifier|*
name|mcq
init|=
operator|&
name|cq
operator|->
name|mcq
decl_stmt|;
name|int
name|eqn_not_used
decl_stmt|;
name|int
name|irqn
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u32
name|i
decl_stmt|;
name|param
operator|->
name|wq
operator|.
name|buf_numa_node
operator|=
literal|0
expr_stmt|;
name|param
operator|->
name|wq
operator|.
name|db_numa_node
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|mlx5_cqwq_create
argument_list|(
name|mdev
argument_list|,
operator|&
name|param
operator|->
name|wq
argument_list|,
name|param
operator|->
name|cqc
argument_list|,
operator|&
name|cq
operator|->
name|wq
argument_list|,
operator|&
name|cq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|mlx5_vector2eqn
argument_list|(
name|mdev
argument_list|,
name|eq_ix
argument_list|,
operator|&
name|eqn_not_used
argument_list|,
operator|&
name|irqn
argument_list|)
expr_stmt|;
name|mcq
operator|->
name|cqe_sz
operator|=
literal|64
expr_stmt|;
name|mcq
operator|->
name|set_ci_db
operator|=
name|cq
operator|->
name|wq_ctrl
operator|.
name|db
operator|.
name|db
expr_stmt|;
name|mcq
operator|->
name|arm_db
operator|=
name|cq
operator|->
name|wq_ctrl
operator|.
name|db
operator|.
name|db
operator|+
literal|1
expr_stmt|;
operator|*
name|mcq
operator|->
name|set_ci_db
operator|=
literal|0
expr_stmt|;
operator|*
name|mcq
operator|->
name|arm_db
operator|=
literal|0
expr_stmt|;
name|mcq
operator|->
name|vector
operator|=
name|eq_ix
expr_stmt|;
name|mcq
operator|->
name|comp
operator|=
name|comp
expr_stmt|;
name|mcq
operator|->
name|event
operator|=
name|mlx5e_cq_error_event
expr_stmt|;
name|mcq
operator|->
name|irqn
operator|=
name|irqn
expr_stmt|;
name|mcq
operator|->
name|uar
operator|=
operator|&
name|priv
operator|->
name|cq_uar
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mlx5_cqwq_get_size
argument_list|(
operator|&
name|cq
operator|->
name|wq
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mlx5_cqe64
modifier|*
name|cqe
init|=
name|mlx5_cqwq_get_wqe
argument_list|(
operator|&
name|cq
operator|->
name|wq
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|cqe
operator|->
name|op_own
operator|=
literal|0xf1
expr_stmt|;
block|}
name|cq
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_destroy_cq
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|)
block|{
name|mlx5_wq_destroy
argument_list|(
operator|&
name|cq
operator|->
name|wq_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_enable_cq
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|mlx5e_cq_param
modifier|*
name|param
parameter_list|,
name|int
name|eq_ix
parameter_list|)
block|{
name|struct
name|mlx5_core_cq
modifier|*
name|mcq
init|=
operator|&
name|cq
operator|->
name|mcq
decl_stmt|;
name|void
modifier|*
name|in
decl_stmt|;
name|void
modifier|*
name|cqc
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|irqn_not_used
decl_stmt|;
name|int
name|eqn
decl_stmt|;
name|int
name|err
decl_stmt|;
name|inlen
operator|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|create_cq_in
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
operator|*
name|cq
operator|->
name|wq_ctrl
operator|.
name|buf
operator|.
name|npages
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|cqc
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|create_cq_in
argument_list|,
name|in
argument_list|,
name|cq_context
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|cqc
argument_list|,
name|param
operator|->
name|cqc
argument_list|,
sizeof|sizeof
argument_list|(
name|param
operator|->
name|cqc
argument_list|)
argument_list|)
expr_stmt|;
name|mlx5_fill_page_array
argument_list|(
operator|&
name|cq
operator|->
name|wq_ctrl
operator|.
name|buf
argument_list|,
operator|(
name|__be64
operator|*
operator|)
name|MLX5_ADDR_OF
argument_list|(
name|create_cq_in
argument_list|,
name|in
argument_list|,
name|pas
argument_list|)
argument_list|)
expr_stmt|;
name|mlx5_vector2eqn
argument_list|(
name|cq
operator|->
name|priv
operator|->
name|mdev
argument_list|,
name|eq_ix
argument_list|,
operator|&
name|eqn
argument_list|,
operator|&
name|irqn_not_used
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|c_eqn
argument_list|,
name|eqn
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|uar_page
argument_list|,
name|mcq
operator|->
name|uar
operator|->
name|index
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|log_page_size
argument_list|,
name|cq
operator|->
name|wq_ctrl
operator|.
name|buf
operator|.
name|page_shift
operator|-
name|PAGE_SHIFT
argument_list|)
expr_stmt|;
name|MLX5_SET64
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|dbr_addr
argument_list|,
name|cq
operator|->
name|wq_ctrl
operator|.
name|db
operator|.
name|dma
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_cq
argument_list|(
name|cq
operator|->
name|priv
operator|->
name|mdev
argument_list|,
name|mcq
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|mlx5e_cq_arm
argument_list|(
name|cq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_disable_cq
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|)
block|{
name|mlx5_core_destroy_cq
argument_list|(
name|cq
operator|->
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|cq
operator|->
name|mcq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5e_open_cq
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_cq_param
modifier|*
name|param
parameter_list|,
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|,
name|mlx5e_cq_comp_t
modifier|*
name|comp
parameter_list|,
name|int
name|eq_ix
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5e_create_cq
argument_list|(
name|priv
argument_list|,
name|param
argument_list|,
name|cq
argument_list|,
name|comp
argument_list|,
name|eq_ix
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|err
operator|=
name|mlx5e_enable_cq
argument_list|(
name|cq
argument_list|,
name|param
argument_list|,
name|eq_ix
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_destroy_cq
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_destroy_cq
label|:
name|mlx5e_destroy_cq
argument_list|(
name|cq
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mlx5e_close_cq
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|)
block|{
name|mlx5e_disable_cq
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|mlx5e_destroy_cq
argument_list|(
name|cq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_tx_cqs
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|,
name|struct
name|mlx5e_channel_param
modifier|*
name|cparam
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|c
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
comment|/* open completion queue */
name|err
operator|=
name|mlx5e_open_cq
argument_list|(
name|c
operator|->
name|priv
argument_list|,
operator|&
name|cparam
operator|->
name|tx_cq
argument_list|,
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
operator|.
name|cq
argument_list|,
operator|&
name|mlx5e_tx_cq_comp
argument_list|,
name|c
operator|->
name|ix
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_tx_cqs
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|err_close_tx_cqs
label|:
for|for
control|(
name|tc
operator|--
init|;
name|tc
operator|>=
literal|0
condition|;
name|tc
operator|--
control|)
name|mlx5e_close_cq
argument_list|(
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
operator|.
name|cq
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_tx_cqs
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|)
block|{
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|c
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
name|mlx5e_close_cq
argument_list|(
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
operator|.
name|cq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_sqs
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|,
name|struct
name|mlx5e_channel_param
modifier|*
name|cparam
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|c
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|err
operator|=
name|mlx5e_open_sq
argument_list|(
name|c
argument_list|,
name|tc
argument_list|,
operator|&
name|cparam
operator|->
name|sq
argument_list|,
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_sqs
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|err_close_sqs
label|:
for|for
control|(
name|tc
operator|--
init|;
name|tc
operator|>=
literal|0
condition|;
name|tc
operator|--
control|)
name|mlx5e_close_sq_wait
argument_list|(
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_sqs_wait
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|)
block|{
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|c
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
name|mlx5e_close_sq_wait
argument_list|(
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_chan_mtx_init
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|)
block|{
name|int
name|tc
decl_stmt|;
name|mtx_init
argument_list|(
operator|&
name|c
operator|->
name|rq
operator|.
name|mtx
argument_list|,
literal|"mlx5rx"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|c
operator|->
name|rq
operator|.
name|watchdog
argument_list|,
operator|&
name|c
operator|->
name|rq
operator|.
name|mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|c
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|struct
name|mlx5e_sq
modifier|*
name|sq
init|=
name|c
operator|->
name|sq
operator|+
name|tc
decl_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sq
operator|->
name|lock
argument_list|,
literal|"mlx5tx"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sq
operator|->
name|comp_lock
argument_list|,
literal|"mlx5comp"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sq
operator|->
name|cev_callout
argument_list|,
operator|&
name|sq
operator|->
name|lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sq
operator|->
name|cev_factor
operator|=
name|c
operator|->
name|priv
operator|->
name|params_ethtool
operator|.
name|tx_completion_fact
expr_stmt|;
comment|/* ensure the TX completion event factor is not zero */
if|if
condition|(
name|sq
operator|->
name|cev_factor
operator|==
literal|0
condition|)
name|sq
operator|->
name|cev_factor
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_chan_mtx_destroy
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|)
block|{
name|int
name|tc
decl_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|c
operator|->
name|rq
operator|.
name|mtx
argument_list|)
expr_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|c
operator|->
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|c
operator|->
name|sq
index|[
name|tc
index|]
operator|.
name|comp_lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_channel
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|ix
parameter_list|,
name|struct
name|mlx5e_channel_param
modifier|*
name|cparam
parameter_list|,
name|struct
name|mlx5e_channel
modifier|*
specifier|volatile
modifier|*
name|cp
parameter_list|)
block|{
name|struct
name|mlx5e_channel
modifier|*
name|c
decl_stmt|;
name|int
name|err
decl_stmt|;
name|c
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|c
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|c
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|c
operator|->
name|ix
operator|=
name|ix
expr_stmt|;
name|c
operator|->
name|cpu
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|ifp
operator|=
name|priv
operator|->
name|ifp
expr_stmt|;
name|c
operator|->
name|mkey_be
operator|=
name|cpu_to_be32
argument_list|(
name|priv
operator|->
name|mr
operator|.
name|key
argument_list|)
expr_stmt|;
name|c
operator|->
name|num_tc
operator|=
name|priv
operator|->
name|num_tc
expr_stmt|;
comment|/* init mutexes */
name|mlx5e_chan_mtx_init
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* open transmit completion queue */
name|err
operator|=
name|mlx5e_open_tx_cqs
argument_list|(
name|c
argument_list|,
name|cparam
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free
goto|;
comment|/* open receive completion queue */
name|err
operator|=
name|mlx5e_open_cq
argument_list|(
name|c
operator|->
name|priv
argument_list|,
operator|&
name|cparam
operator|->
name|rx_cq
argument_list|,
operator|&
name|c
operator|->
name|rq
operator|.
name|cq
argument_list|,
operator|&
name|mlx5e_rx_cq_comp
argument_list|,
name|c
operator|->
name|ix
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_tx_cqs
goto|;
name|err
operator|=
name|mlx5e_open_sqs
argument_list|(
name|c
argument_list|,
name|cparam
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_rx_cq
goto|;
name|err
operator|=
name|mlx5e_open_rq
argument_list|(
name|c
argument_list|,
operator|&
name|cparam
operator|->
name|rq
argument_list|,
operator|&
name|c
operator|->
name|rq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_sqs
goto|;
comment|/* store channel pointer */
operator|*
name|cp
operator|=
name|c
expr_stmt|;
comment|/* poll receive queue initially */
name|c
operator|->
name|rq
operator|.
name|cq
operator|.
name|mcq
operator|.
name|comp
argument_list|(
operator|&
name|c
operator|->
name|rq
operator|.
name|cq
operator|.
name|mcq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_close_sqs
label|:
name|mlx5e_close_sqs_wait
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|err_close_rx_cq
label|:
name|mlx5e_close_cq
argument_list|(
operator|&
name|c
operator|->
name|rq
operator|.
name|cq
argument_list|)
expr_stmt|;
name|err_close_tx_cqs
label|:
name|mlx5e_close_tx_cqs
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|err_free
label|:
comment|/* destroy mutexes */
name|mlx5e_chan_mtx_destroy
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_channel
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
specifier|volatile
modifier|*
name|pp
parameter_list|)
block|{
name|struct
name|mlx5e_channel
modifier|*
name|c
init|=
operator|*
name|pp
decl_stmt|;
comment|/* check if channel is already closed */
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
return|return;
name|mlx5e_close_rq
argument_list|(
operator|&
name|c
operator|->
name|rq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_channel_wait
parameter_list|(
name|struct
name|mlx5e_channel
modifier|*
specifier|volatile
modifier|*
name|pp
parameter_list|)
block|{
name|struct
name|mlx5e_channel
modifier|*
name|c
init|=
operator|*
name|pp
decl_stmt|;
comment|/* check if channel is already closed */
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
return|return;
comment|/* ensure channel pointer is no longer used */
operator|*
name|pp
operator|=
name|NULL
expr_stmt|;
name|mlx5e_close_rq_wait
argument_list|(
operator|&
name|c
operator|->
name|rq
argument_list|)
expr_stmt|;
name|mlx5e_close_sqs_wait
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|mlx5e_close_cq
argument_list|(
operator|&
name|c
operator|->
name|rq
operator|.
name|cq
argument_list|)
expr_stmt|;
name|mlx5e_close_tx_cqs
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* destroy mutexes */
name|mlx5e_chan_mtx_destroy
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_rq_param
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_rq_param
modifier|*
name|param
parameter_list|)
block|{
name|void
modifier|*
name|rqc
init|=
name|param
operator|->
name|rqc
decl_stmt|;
name|void
modifier|*
name|wq
init|=
name|MLX5_ADDR_OF
argument_list|(
name|rqc
argument_list|,
name|rqc
argument_list|,
name|wq
argument_list|)
decl_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|wq_type
argument_list|,
name|MLX5_WQ_TYPE_LINKED_LIST
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|end_padding_mode
argument_list|,
name|MLX5_WQ_END_PAD_MODE_ALIGN
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|log_wq_stride
argument_list|,
name|ilog2
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5e_rx_wqe
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|log_wq_sz
argument_list|,
name|priv
operator|->
name|params
operator|.
name|log_rq_size
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|pd
argument_list|,
name|priv
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|param
operator|->
name|wq
operator|.
name|buf_numa_node
operator|=
literal|0
expr_stmt|;
name|param
operator|->
name|wq
operator|.
name|db_numa_node
operator|=
literal|0
expr_stmt|;
name|param
operator|->
name|wq
operator|.
name|linear
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_sq_param
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_sq_param
modifier|*
name|param
parameter_list|)
block|{
name|void
modifier|*
name|sqc
init|=
name|param
operator|->
name|sqc
decl_stmt|;
name|void
modifier|*
name|wq
init|=
name|MLX5_ADDR_OF
argument_list|(
name|sqc
argument_list|,
name|sqc
argument_list|,
name|wq
argument_list|)
decl_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|log_wq_sz
argument_list|,
name|priv
operator|->
name|params
operator|.
name|log_sq_size
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|log_wq_stride
argument_list|,
name|ilog2
argument_list|(
name|MLX5_SEND_WQE_BB
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|wq
argument_list|,
name|wq
argument_list|,
name|pd
argument_list|,
name|priv
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|param
operator|->
name|wq
operator|.
name|buf_numa_node
operator|=
literal|0
expr_stmt|;
name|param
operator|->
name|wq
operator|.
name|db_numa_node
operator|=
literal|0
expr_stmt|;
name|param
operator|->
name|wq
operator|.
name|linear
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_common_cq_param
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_cq_param
modifier|*
name|param
parameter_list|)
block|{
name|void
modifier|*
name|cqc
init|=
name|param
operator|->
name|cqc
decl_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|uar_page
argument_list|,
name|priv
operator|->
name|cq_uar
operator|.
name|index
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_rx_cq_param
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_cq_param
modifier|*
name|param
parameter_list|)
block|{
name|void
modifier|*
name|cqc
init|=
name|param
operator|->
name|cqc
decl_stmt|;
comment|/* 	 * TODO The sysctl to control on/off is a bool value for now, which means 	 * we only support CSUM, once HASH is implemnted we'll need to address that. 	 */
if|if
condition|(
name|priv
operator|->
name|params
operator|.
name|cqe_zipping_en
condition|)
block|{
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|mini_cqe_res_format
argument_list|,
name|MLX5_CQE_FORMAT_CSUM
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cqe_compression_en
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|log_cq_size
argument_list|,
name|priv
operator|->
name|params
operator|.
name|log_rq_size
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period
argument_list|,
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_usec
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_max_count
argument_list|,
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_pkts
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_mode
condition|)
block|{
case|case
literal|0
case|:
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period_mode
argument_list|,
name|MLX5_CQ_PERIOD_MODE_START_FROM_EQE
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|cq_period_start_from_cqe
argument_list|)
condition|)
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period_mode
argument_list|,
name|MLX5_CQ_PERIOD_MODE_START_FROM_CQE
argument_list|)
expr_stmt|;
else|else
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period_mode
argument_list|,
name|MLX5_CQ_PERIOD_MODE_START_FROM_EQE
argument_list|)
expr_stmt|;
break|break;
block|}
name|mlx5e_build_common_cq_param
argument_list|(
name|priv
argument_list|,
name|param
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_tx_cq_param
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_cq_param
modifier|*
name|param
parameter_list|)
block|{
name|void
modifier|*
name|cqc
init|=
name|param
operator|->
name|cqc
decl_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|log_cq_size
argument_list|,
name|priv
operator|->
name|params
operator|.
name|log_sq_size
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period
argument_list|,
name|priv
operator|->
name|params
operator|.
name|tx_cq_moderation_usec
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_max_count
argument_list|,
name|priv
operator|->
name|params
operator|.
name|tx_cq_moderation_pkts
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|priv
operator|->
name|params
operator|.
name|tx_cq_moderation_mode
condition|)
block|{
case|case
literal|0
case|:
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period_mode
argument_list|,
name|MLX5_CQ_PERIOD_MODE_START_FROM_EQE
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|cq_period_start_from_cqe
argument_list|)
condition|)
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period_mode
argument_list|,
name|MLX5_CQ_PERIOD_MODE_START_FROM_CQE
argument_list|)
expr_stmt|;
else|else
name|MLX5_SET
argument_list|(
name|cqc
argument_list|,
name|cqc
argument_list|,
name|cq_period_mode
argument_list|,
name|MLX5_CQ_PERIOD_MODE_START_FROM_EQE
argument_list|)
expr_stmt|;
break|break;
block|}
name|mlx5e_build_common_cq_param
argument_list|(
name|priv
argument_list|,
name|param
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_channel_param
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_channel_param
modifier|*
name|cparam
parameter_list|)
block|{
name|memset
argument_list|(
name|cparam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cparam
argument_list|)
argument_list|)
expr_stmt|;
name|mlx5e_build_rq_param
argument_list|(
name|priv
argument_list|,
operator|&
name|cparam
operator|->
name|rq
argument_list|)
expr_stmt|;
name|mlx5e_build_sq_param
argument_list|(
name|priv
argument_list|,
operator|&
name|cparam
operator|->
name|sq
argument_list|)
expr_stmt|;
name|mlx5e_build_rx_cq_param
argument_list|(
name|priv
argument_list|,
operator|&
name|cparam
operator|->
name|rx_cq
argument_list|)
expr_stmt|;
name|mlx5e_build_tx_cq_param
argument_list|(
name|priv
argument_list|,
operator|&
name|cparam
operator|->
name|tx_cq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_channels
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5e_channel_param
name|cparam
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
name|priv
operator|->
name|channel
operator|=
name|malloc
argument_list|(
name|priv
operator|->
name|params
operator|.
name|num_channels
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5e_channel
operator|*
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mlx5e_build_channel_param
argument_list|(
name|priv
argument_list|,
operator|&
name|cparam
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|params
operator|.
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|mlx5e_open_channel
argument_list|(
name|priv
argument_list|,
name|i
argument_list|,
operator|&
name|cparam
argument_list|,
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_channels
goto|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|priv
operator|->
name|params
operator|.
name|num_channels
condition|;
name|j
operator|++
control|)
block|{
name|err
operator|=
name|mlx5e_wait_for_min_rx_wqes
argument_list|(
operator|&
name|priv
operator|->
name|channel
index|[
name|j
index|]
operator|->
name|rq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_channels
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|err_close_channels
label|:
for|for
control|(
name|i
operator|--
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|mlx5e_close_channel
argument_list|(
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mlx5e_close_channel_wait
argument_list|(
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/* remove "volatile" attribute from "channel" pointer */
name|ptr
operator|=
name|__DECONST
argument_list|(
name|void
operator|*
argument_list|,
name|priv
operator|->
name|channel
argument_list|)
expr_stmt|;
name|priv
operator|->
name|channel
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_channels
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|void
modifier|*
name|ptr
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|channel
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|params
operator|.
name|num_channels
condition|;
name|i
operator|++
control|)
name|mlx5e_close_channel
argument_list|(
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|params
operator|.
name|num_channels
condition|;
name|i
operator|++
control|)
name|mlx5e_close_channel_wait
argument_list|(
operator|&
name|priv
operator|->
name|channel
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* remove "volatile" attribute from "channel" pointer */
name|ptr
operator|=
name|__DECONST
argument_list|(
name|void
operator|*
argument_list|,
name|priv
operator|->
name|channel
argument_list|)
expr_stmt|;
name|priv
operator|->
name|channel
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_refresh_sq_params
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_sq
modifier|*
name|sq
parameter_list|)
block|{
return|return
operator|(
name|mlx5_core_modify_cq_moderation
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|sq
operator|->
name|cq
operator|.
name|mcq
argument_list|,
name|priv
operator|->
name|params
operator|.
name|tx_cq_moderation_usec
argument_list|,
name|priv
operator|->
name|params
operator|.
name|tx_cq_moderation_pkts
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_refresh_rq_params
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
return|return
operator|(
name|mlx5_core_modify_cq_moderation
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|rq
operator|->
name|cq
operator|.
name|mcq
argument_list|,
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_usec
argument_list|,
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_pkts
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_refresh_channel_params_sub
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_channel
modifier|*
name|c
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|err
operator|=
name|mlx5e_refresh_rq_params
argument_list|(
name|priv
argument_list|,
operator|&
name|c
operator|->
name|rq
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|done
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|c
operator|->
name|num_tc
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|mlx5e_refresh_sq_params
argument_list|(
name|priv
argument_list|,
operator|&
name|c
operator|->
name|sq
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|done
goto|;
block|}
name|done
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mlx5e_refresh_channel_params
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|channel
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|priv
operator|->
name|params
operator|.
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5e_refresh_channel_params_sub
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|channel
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_tis
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|tc
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
name|in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|create_tis_in
argument_list|)
index|]
decl_stmt|;
name|void
modifier|*
name|tisc
init|=
name|MLX5_ADDR_OF
argument_list|(
name|create_tis_in
argument_list|,
name|in
argument_list|,
name|ctx
argument_list|)
decl_stmt|;
name|memset
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|tisc
argument_list|,
name|tisc
argument_list|,
name|prio
argument_list|,
name|tc
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|tisc
argument_list|,
name|tisc
argument_list|,
name|transport_domain
argument_list|,
name|priv
operator|->
name|tdn
argument_list|)
expr_stmt|;
return|return
operator|(
name|mlx5_core_create_tis
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
operator|&
name|priv
operator|->
name|tisn
index|[
name|tc
index|]
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_tis
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|tc
parameter_list|)
block|{
name|mlx5_core_destroy_tis
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|tisn
index|[
name|tc
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_tises
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|num_tc
init|=
name|priv
operator|->
name|num_tc
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|num_tc
condition|;
name|tc
operator|++
control|)
block|{
name|err
operator|=
name|mlx5e_open_tis
argument_list|(
name|priv
argument_list|,
name|tc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_tises
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|err_close_tises
label|:
for|for
control|(
name|tc
operator|--
init|;
name|tc
operator|>=
literal|0
condition|;
name|tc
operator|--
control|)
name|mlx5e_close_tis
argument_list|(
name|priv
argument_list|,
name|tc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_tises
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|num_tc
init|=
name|priv
operator|->
name|num_tc
decl_stmt|;
name|int
name|tc
decl_stmt|;
for|for
control|(
name|tc
operator|=
literal|0
init|;
name|tc
operator|<
name|num_tc
condition|;
name|tc
operator|++
control|)
name|mlx5e_close_tis
argument_list|(
name|priv
argument_list|,
name|tc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_rqt
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
modifier|*
name|in
decl_stmt|;
name|u32
name|out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|create_rqt_out
argument_list|)
index|]
decl_stmt|;
name|void
modifier|*
name|rqtc
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|sz
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sz
operator|=
literal|1
operator|<<
name|priv
operator|->
name|params
operator|.
name|rx_hash_log_tbl_sz
expr_stmt|;
name|inlen
operator|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|create_rqt_in
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|*
name|sz
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|rqtc
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|create_rqt_in
argument_list|,
name|in
argument_list|,
name|rqt_context
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rqtc
argument_list|,
name|rqtc
argument_list|,
name|rqt_actual_size
argument_list|,
name|sz
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rqtc
argument_list|,
name|rqtc
argument_list|,
name|rqt_max_size
argument_list|,
name|sz
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sz
condition|;
name|i
operator|++
control|)
block|{
name|int
name|ix
decl_stmt|;
ifdef|#
directive|ifdef
name|RSS
name|ix
operator|=
name|rss_get_indirection_to_bucket
argument_list|(
name|i
argument_list|)
expr_stmt|;
else|#
directive|else
name|ix
operator|=
name|i
expr_stmt|;
endif|#
directive|endif
comment|/* ensure we don't overflow */
name|ix
operator|%=
name|priv
operator|->
name|params
operator|.
name|num_channels
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rqtc
argument_list|,
name|rqtc
argument_list|,
name|rq_num
index|[
name|i
index|]
argument_list|,
name|priv
operator|->
name|channel
index|[
name|ix
index|]
operator|->
name|rq
operator|.
name|rqn
argument_list|)
expr_stmt|;
block|}
name|MLX5_SET
argument_list|(
name|create_rqt_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_CREATE_RQT
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_cmd_exec_check_status
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|priv
operator|->
name|rqtn
operator|=
name|MLX5_GET
argument_list|(
name|create_rqt_out
argument_list|,
name|out
argument_list|,
name|rqtn
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_rqt
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|u32
name|in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|destroy_rqt_in
argument_list|)
index|]
decl_stmt|;
name|u32
name|out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|destroy_rqt_out
argument_list|)
index|]
decl_stmt|;
name|memset
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|destroy_rqt_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_DESTROY_RQT
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|destroy_rqt_in
argument_list|,
name|in
argument_list|,
name|rqtn
argument_list|,
name|priv
operator|->
name|rqtn
argument_list|)
expr_stmt|;
name|mlx5_cmd_exec_check_status
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_tir_ctx
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|u32
modifier|*
name|tirc
parameter_list|,
name|int
name|tt
parameter_list|)
block|{
name|void
modifier|*
name|hfso
init|=
name|MLX5_ADDR_OF
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|rx_hash_field_selector_outer
argument_list|)
decl_stmt|;
name|__be32
modifier|*
name|hkey
decl_stmt|;
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|transport_domain
argument_list|,
name|priv
operator|->
name|tdn
argument_list|)
expr_stmt|;
define|#
directive|define
name|ROUGH_MAX_L2_L3_HDR_SZ
value|256
define|#
directive|define
name|MLX5_HASH_IP
value|(MLX5_HASH_FIELD_SEL_SRC_IP   |\ 			  MLX5_HASH_FIELD_SEL_DST_IP)
define|#
directive|define
name|MLX5_HASH_ALL
value|(MLX5_HASH_FIELD_SEL_SRC_IP   |\ 			  MLX5_HASH_FIELD_SEL_DST_IP   |\ 			  MLX5_HASH_FIELD_SEL_L4_SPORT |\ 			  MLX5_HASH_FIELD_SEL_L4_DPORT)
define|#
directive|define
name|MLX5_HASH_IP_IPSEC_SPI
value|(MLX5_HASH_FIELD_SEL_SRC_IP   |\ 				 MLX5_HASH_FIELD_SEL_DST_IP   |\ 				 MLX5_HASH_FIELD_SEL_IPSEC_SPI)
if|if
condition|(
name|priv
operator|->
name|params
operator|.
name|hw_lro_en
condition|)
block|{
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|lro_enable_mask
argument_list|,
name|MLX5_TIRC_LRO_ENABLE_MASK_IPV4_LRO
operator||
name|MLX5_TIRC_LRO_ENABLE_MASK_IPV6_LRO
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|lro_max_msg_sz
argument_list|,
operator|(
name|priv
operator|->
name|params
operator|.
name|lro_wqe_sz
operator|-
name|ROUGH_MAX_L2_L3_HDR_SZ
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
comment|/* TODO: add the option to choose timer value dynamically */
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|lro_timeout_period_usecs
argument_list|,
name|MLX5_CAP_ETH
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|lro_timer_supported_periods
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* setup parameters for hashing TIR type, if any */
switch|switch
condition|(
name|tt
condition|)
block|{
case|case
name|MLX5E_TT_ANY
case|:
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|disp_type
argument_list|,
name|MLX5_TIRC_DISP_TYPE_DIRECT
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|inline_rqn
argument_list|,
name|priv
operator|->
name|channel
index|[
literal|0
index|]
operator|->
name|rq
operator|.
name|rqn
argument_list|)
expr_stmt|;
break|break;
default|default:
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|disp_type
argument_list|,
name|MLX5_TIRC_DISP_TYPE_INDIRECT
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|indirect_table
argument_list|,
name|priv
operator|->
name|rqtn
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|rx_hash_fn
argument_list|,
name|MLX5_TIRC_RX_HASH_FN_HASH_TOEPLITZ
argument_list|)
expr_stmt|;
name|hkey
operator|=
operator|(
name|__be32
operator|*
operator|)
name|MLX5_ADDR_OF
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|rx_hash_toeplitz_key
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RSS
comment|/* 		 * The FreeBSD RSS implementation does currently not 		 * support symmetric Toeplitz hashes: 		 */
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|rx_hash_symmetric
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rss_getkey
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|hkey
argument_list|)
expr_stmt|;
else|#
directive|else
name|MLX5_SET
argument_list|(
name|tirc
argument_list|,
name|tirc
argument_list|,
name|rx_hash_symmetric
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|0
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0xD181C62C
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|1
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0xF7F4DB5B
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|2
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0x1983A2FC
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|3
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0x943E1ADB
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|4
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0xD9389E6B
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|5
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0xD1039C2C
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|6
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0xA74499AD
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|7
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0x593D56D9
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|8
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0xF3253C06
argument_list|)
expr_stmt|;
name|hkey
index|[
literal|9
index|]
operator|=
name|cpu_to_be32
argument_list|(
literal|0x2ADC1FFC
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
switch|switch
condition|(
name|tt
condition|)
block|{
case|case
name|MLX5E_TT_IPV4_TCP
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV4
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l4_prot_type
argument_list|,
name|MLX5_L4_PROT_TYPE_TCP
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RSS
if|if
condition|(
operator|!
operator|(
name|rss_gethashconfig
argument_list|()
operator|&
name|RSS_HASHTYPE_RSS_TCP_IPV4
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_ALL
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV6_TCP
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l4_prot_type
argument_list|,
name|MLX5_L4_PROT_TYPE_TCP
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RSS
if|if
condition|(
operator|!
operator|(
name|rss_gethashconfig
argument_list|()
operator|&
name|RSS_HASHTYPE_RSS_TCP_IPV6
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_ALL
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV4_UDP
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV4
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l4_prot_type
argument_list|,
name|MLX5_L4_PROT_TYPE_UDP
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RSS
if|if
condition|(
operator|!
operator|(
name|rss_gethashconfig
argument_list|()
operator|&
name|RSS_HASHTYPE_RSS_UDP_IPV4
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_ALL
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV6_UDP
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l4_prot_type
argument_list|,
name|MLX5_L4_PROT_TYPE_UDP
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RSS
if|if
condition|(
operator|!
operator|(
name|rss_gethashconfig
argument_list|()
operator|&
name|RSS_HASHTYPE_RSS_UDP_IPV6
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_ALL
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV4_IPSEC_AH
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV4
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP_IPSEC_SPI
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV6_IPSEC_AH
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP_IPSEC_SPI
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV4_IPSEC_ESP
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV4
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP_IPSEC_SPI
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV6_IPSEC_ESP
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP_IPSEC_SPI
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV4
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV4
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_TT_IPV6
case|:
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|l3_prot_type
argument_list|,
name|MLX5_L3_PROT_TYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|rx_hash_field_select
argument_list|,
name|hfso
argument_list|,
name|selected_fields
argument_list|,
name|MLX5_HASH_IP
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_tir
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|tt
parameter_list|)
block|{
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|u32
modifier|*
name|in
decl_stmt|;
name|void
modifier|*
name|tirc
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|inlen
operator|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|create_tir_in
argument_list|)
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
name|tirc
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|create_tir_in
argument_list|,
name|in
argument_list|,
name|tir_context
argument_list|)
expr_stmt|;
name|mlx5e_build_tir_ctx
argument_list|(
name|priv
argument_list|,
name|tirc
argument_list|,
name|tt
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_tir
argument_list|(
name|mdev
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
operator|&
name|priv
operator|->
name|tirn
index|[
name|tt
index|]
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_tir
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|tt
parameter_list|)
block|{
name|mlx5_core_destroy_tir
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|tirn
index|[
name|tt
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_open_tirs
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5E_NUM_TT
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|mlx5e_open_tir
argument_list|(
name|priv
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_close_tirs
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|err_close_tirs
label|:
for|for
control|(
name|i
operator|--
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|mlx5e_close_tir
argument_list|(
name|priv
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_close_tirs
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5E_NUM_TT
condition|;
name|i
operator|++
control|)
name|mlx5e_close_tir
argument_list|(
name|priv
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * SW MTU does not include headers,  * HW MTU includes all headers and checksums.  */
end_comment

begin_function
specifier|static
name|int
name|mlx5e_set_dev_port_mtu
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|int
name|sw_mtu
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|int
name|hw_mtu
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_set_port_mtu
argument_list|(
name|mdev
argument_list|,
name|MLX5E_SW2HW_MTU
argument_list|(
name|sw_mtu
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5_set_port_mtu failed setting %d, err=%d\n"
argument_list|,
name|__func__
argument_list|,
name|sw_mtu
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|mlx5_query_port_oper_mtu
argument_list|(
name|mdev
argument_list|,
operator|&
name|hw_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Query port MTU, after setting new "
literal|"MTU value, failed\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|MLX5E_HW2SW_MTU
argument_list|(
name|hw_mtu
argument_list|)
operator|<
name|sw_mtu
condition|)
block|{
name|err
operator|=
operator|-
name|E2BIG
operator|,
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Port MTU %d is smaller than "
literal|"ifp mtu %d\n"
argument_list|,
name|hw_mtu
argument_list|,
name|sw_mtu
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|MLX5E_HW2SW_MTU
argument_list|(
name|hw_mtu
argument_list|)
operator|>
name|sw_mtu
condition|)
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Port MTU %d is bigger than "
literal|"ifp mtu %d\n"
argument_list|,
name|hw_mtu
argument_list|,
name|sw_mtu
argument_list|)
expr_stmt|;
block|}
name|ifp
operator|->
name|if_mtu
operator|=
name|sw_mtu
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mlx5e_open_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u16
name|set_id
decl_stmt|;
comment|/* check if already opened */
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
ifdef|#
directive|ifdef
name|RSS
if|if
condition|(
name|rss_getnumbuckets
argument_list|()
operator|>
name|priv
operator|->
name|params
operator|.
name|num_channels
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"NOTE: There are more RSS buckets(%u) than "
literal|"channels(%u) available\n"
argument_list|,
name|rss_getnumbuckets
argument_list|()
argument_list|,
name|priv
operator|->
name|params
operator|.
name|num_channels
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|err
operator|=
name|mlx5e_open_tises
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5e_open_tises failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|mlx5_vport_alloc_q_counter
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_ETH
argument_list|,
operator|&
name|set_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"%s: mlx5_vport_alloc_q_counter failed: %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_close_tises
goto|;
block|}
comment|/* store counter set ID */
name|priv
operator|->
name|counter_set_id
operator|=
name|set_id
expr_stmt|;
name|err
operator|=
name|mlx5e_open_channels
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5e_open_channels failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_dalloc_q_counter
goto|;
block|}
name|err
operator|=
name|mlx5e_open_rqt
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5e_open_rqt failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_close_channels
goto|;
block|}
name|err
operator|=
name|mlx5e_open_tirs
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5e_open_tir failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_close_rqls
goto|;
block|}
name|err
operator|=
name|mlx5e_open_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5e_open_flow_table failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_close_tirs
goto|;
block|}
name|err
operator|=
name|mlx5e_add_all_vlan_rules
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5e_add_all_vlan_rules failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_close_flow_table
goto|;
block|}
name|set_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
expr_stmt|;
name|mlx5e_update_carrier
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_set_rx_mode_core
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_close_flow_table
label|:
name|mlx5e_close_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err_close_tirs
label|:
name|mlx5e_close_tirs
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err_close_rqls
label|:
name|mlx5e_close_rqt
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err_close_channels
label|:
name|mlx5e_close_channels
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err_dalloc_q_counter
label|:
name|mlx5_vport_dealloc_q_counter
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_ETH
argument_list|,
name|priv
operator|->
name|counter_set_id
argument_list|)
expr_stmt|;
name|err_close_tises
label|:
name|mlx5e_close_tises
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_open
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|arg
decl_stmt|;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_set_port_status
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|MLX5_PORT_UP
argument_list|)
condition|)
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"%s: Setting port status to up failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mlx5e_open_locked
argument_list|(
name|priv
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|priv
operator|->
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5e_close_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
comment|/* check if already closed */
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|clear_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
expr_stmt|;
name|mlx5e_set_rx_mode_core
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_del_all_vlan_rules
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
name|mlx5e_close_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_close_tirs
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_close_rqt
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_close_channels
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5_vport_dealloc_q_counter
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_ETH
argument_list|,
name|priv
operator|->
name|counter_set_id
argument_list|)
expr_stmt|;
name|mlx5e_close_tises
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100000
operator|)
end_if

begin_function
specifier|static
name|uint64_t
name|mlx5e_get_counter
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|ift_counter
name|cnt
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|u64
name|retval
decl_stmt|;
comment|/* PRIV_LOCK(priv); XXX not allowed */
switch|switch
condition|(
name|cnt
condition|)
block|{
case|case
name|IFCOUNTER_IPACKETS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|rx_packets
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_IERRORS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|rx_error_packets
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|alignment_err
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|check_seq_err
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|crc_align_errors
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|drop_events
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|in_range_len_errors
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|jabbers
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|out_of_range_len
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|oversize_pkts
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|symbol_err
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|too_long_errors
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|undersize_pkts
operator|+
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|unsupported_op_rx
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_IQDROPS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|rx_out_of_buffer
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OPACKETS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|tx_packets
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OERRORS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|tx_error_packets
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_IBYTES
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|rx_bytes
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OBYTES
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|tx_bytes
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_IMCASTS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|rx_multicast_packets
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OMCASTS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|tx_multicast_packets
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_OQDROPS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|tx_queue_dropped
expr_stmt|;
break|break;
case|case
name|IFCOUNTER_COLLISIONS
case|:
name|retval
operator|=
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|collisions
expr_stmt|;
break|break;
default|default:
name|retval
operator|=
name|if_get_counter_default
argument_list|(
name|ifp
argument_list|,
name|cnt
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* PRIV_UNLOCK(priv); XXX not allowed */
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|mlx5e_set_rx_mode
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|schedule_work
argument_list|(
operator|&
name|priv
operator|->
name|set_rx_mode_work
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
name|struct
name|ifi2creq
name|i2c
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|mask
init|=
literal|0
decl_stmt|;
name|int
name|size_read
init|=
literal|0
decl_stmt|;
name|int
name|module_num
decl_stmt|;
name|int
name|max_mtu
decl_stmt|;
name|uint8_t
name|read_addr
decl_stmt|;
name|priv
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
comment|/* check if detaching */
if|if
condition|(
name|priv
operator|==
name|NULL
operator|||
name|priv
operator|->
name|gone
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFMTU
case|:
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5_query_port_max_mtu
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|max_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifr
operator|->
name|ifr_mtu
operator|>=
name|MLX5E_MTU_MIN
operator|&&
name|ifr
operator|->
name|ifr_mtu
operator|<=
name|MIN
argument_list|(
name|MLX5E_MTU_MAX
argument_list|,
name|max_mtu
argument_list|)
condition|)
block|{
name|int
name|was_opened
decl_stmt|;
name|was_opened
operator|=
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|was_opened
condition|)
name|mlx5e_close_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* set new MTU */
name|mlx5e_set_dev_port_mtu
argument_list|(
name|ifp
argument_list|,
name|ifr
operator|->
name|ifr_mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|was_opened
condition|)
name|mlx5e_open_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Invalid MTU value. Min val: %d, Max val: %d\n"
argument_list|,
name|MLX5E_MTU_MIN
argument_list|,
name|MIN
argument_list|(
name|MLX5E_MTU_MAX
argument_list|,
name|max_mtu
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|&&
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
condition|)
block|{
name|mlx5e_set_rx_mode
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
break|break;
block|}
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
operator|==
literal|0
condition|)
name|mlx5e_open_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|mlx5_set_port_status
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|MLX5_PORT_UP
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|mlx5_set_port_status
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|MLX5_PORT_DOWN
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
operator|!=
literal|0
condition|)
name|mlx5e_close_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|mlx5e_update_carrier
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
block|}
block|}
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|mlx5e_set_rx_mode
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
case|case
name|SIOCGIFXMEDIA
case|:
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|priv
operator|->
name|media
argument_list|,
name|command
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFCAP
case|:
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mask
operator|=
name|ifr
operator|->
name|ifr_reqcap
operator|^
name|ifp
operator|->
name|if_capenable
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TXCSUM
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|^=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator|)
expr_stmt|;
if|if
condition|(
name|IFCAP_TSO4
operator|&
name|ifp
operator|->
name|if_capenable
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO4
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_IP_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"tso4 disabled due to -txcsum.\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_TXCSUM_IPV6
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TXCSUM_IPV6
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|^=
operator|(
name|CSUM_UDP_IPV6
operator||
name|CSUM_TCP_IPV6
operator|)
expr_stmt|;
if|if
condition|(
name|IFCAP_TSO6
operator|&
name|ifp
operator|->
name|if_capenable
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM_IPV6
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|ifp
operator|->
name|if_capenable
operator|&=
operator|~
name|IFCAP_TSO6
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|&=
operator|~
name|CSUM_IP6_TSO
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"tso6 disabled due to -txcsum6.\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_RXCSUM
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_RXCSUM_IPV6
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_RXCSUM_IPV6
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO4
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|IFCAP_TSO4
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"enable txcsum first.\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO4
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|^=
name|CSUM_IP_TSO
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_TSO6
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|IFCAP_TSO6
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
operator|&&
operator|!
operator|(
name|IFCAP_TXCSUM_IPV6
operator|&
name|ifp
operator|->
name|if_capenable
operator|)
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"enable txcsum6 first.\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EAGAIN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_TSO6
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|^=
name|CSUM_IP6_TSO
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_VLAN_HWFILTER
condition|)
name|mlx5e_disable_vlan_filter
argument_list|(
name|priv
argument_list|)
expr_stmt|;
else|else
name|mlx5e_enable_vlan_filter
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|IFCAP_VLAN_HWTAGGING
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|IFCAP_WOL_MAGIC
condition|)
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_WOL_MAGIC
expr_stmt|;
name|VLAN_CAPABILITIES
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* turn off LRO means also turn of HW LRO - if it's on */
if|if
condition|(
name|mask
operator|&
name|IFCAP_LRO
condition|)
block|{
name|int
name|was_opened
init|=
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
decl_stmt|;
name|bool
name|need_restart
init|=
name|false
decl_stmt|;
name|ifp
operator|->
name|if_capenable
operator|^=
name|IFCAP_LRO
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
operator|)
condition|)
block|{
if|if
condition|(
name|priv
operator|->
name|params
operator|.
name|hw_lro_en
condition|)
block|{
name|priv
operator|->
name|params
operator|.
name|hw_lro_en
operator|=
name|false
expr_stmt|;
name|need_restart
operator|=
name|true
expr_stmt|;
comment|/* Not sure this is the correct way */
name|priv
operator|->
name|params_ethtool
operator|.
name|hw_lro
operator|=
name|priv
operator|->
name|params
operator|.
name|hw_lro_en
expr_stmt|;
block|}
block|}
if|if
condition|(
name|was_opened
operator|&&
name|need_restart
condition|)
block|{
name|mlx5e_close_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|mlx5e_open_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCGI2C
case|:
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
comment|/* 		 * Copy from the user-space address ifr_data to the 		 * kernel-space address i2c 		 */
name|error
operator|=
name|copyin
argument_list|(
name|ifr
operator|->
name|ifr_data
argument_list|,
operator|&
name|i2c
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
if|if
condition|(
name|i2c
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|i2c
operator|.
name|data
argument_list|)
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* Get module_num which is required for the query_eeprom */
name|error
operator|=
name|mlx5_query_module_num
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|module_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Query module num failed, eeprom "
literal|"reading is not supported\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|err_i2c
goto|;
block|}
comment|/* Check if module is present before doing an access */
if|if
condition|(
name|mlx5_query_module_status
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|module_num
argument_list|)
operator|!=
name|MLX5_MODULE_STATUS_PLUGGED
condition|)
block|{
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|err_i2c
goto|;
block|}
comment|/* 		 * Currently 0XA0 and 0xA2 are the only addresses permitted. 		 * The internal conversion is as follows: 		 */
if|if
condition|(
name|i2c
operator|.
name|dev_addr
operator|==
literal|0xA0
condition|)
name|read_addr
operator|=
name|MLX5E_I2C_ADDR_LOW
expr_stmt|;
elseif|else
if|if
condition|(
name|i2c
operator|.
name|dev_addr
operator|==
literal|0xA2
condition|)
name|read_addr
operator|=
name|MLX5E_I2C_ADDR_HIGH
expr_stmt|;
else|else
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Query eeprom failed, "
literal|"Invalid Address: %X\n"
argument_list|,
name|i2c
operator|.
name|dev_addr
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|err_i2c
goto|;
block|}
name|error
operator|=
name|mlx5_query_eeprom
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|read_addr
argument_list|,
name|MLX5E_EEPROM_LOW_PAGE
argument_list|,
operator|(
name|uint32_t
operator|)
name|i2c
operator|.
name|offset
argument_list|,
operator|(
name|uint32_t
operator|)
name|i2c
operator|.
name|len
argument_list|,
name|module_num
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|i2c
operator|.
name|data
argument_list|,
operator|&
name|size_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Query eeprom failed, eeprom "
literal|"reading is not supported\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|err_i2c
goto|;
block|}
if|if
condition|(
name|i2c
operator|.
name|len
operator|>
name|MLX5_EEPROM_MAX_BYTES
condition|)
block|{
name|error
operator|=
name|mlx5_query_eeprom
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|read_addr
argument_list|,
name|MLX5E_EEPROM_LOW_PAGE
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|i2c
operator|.
name|offset
operator|+
name|size_read
argument_list|)
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|i2c
operator|.
name|len
operator|-
name|size_read
argument_list|)
argument_list|,
name|module_num
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|i2c
operator|.
name|data
operator|+
name|size_read
operator|)
argument_list|,
operator|&
name|size_read
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Query eeprom failed, eeprom "
literal|"reading is not supported\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|err_i2c
goto|;
block|}
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|i2c
argument_list|,
name|ifr
operator|->
name|ifr_data
argument_list|,
sizeof|sizeof
argument_list|(
name|i2c
argument_list|)
argument_list|)
expr_stmt|;
name|err_i2c
label|:
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|command
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_check_required_hca_cap
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|)
block|{
comment|/* 	 * TODO: uncoment once FW really sets all these bits if 	 * (!mdev->caps.eth.rss_ind_tbl_cap || !mdev->caps.eth.csum_cap || 	 * !mdev->caps.eth.max_lso_cap || !mdev->caps.eth.vlan_cap || 	 * !(mdev->caps.gen.flags& MLX5_DEV_CAP_FLAG_SCQE_BRK_MOD)) return 	 * -ENOTSUPP; 	 */
comment|/* TODO: add more must-to-have features */
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|port_type
argument_list|)
operator|!=
name|MLX5_CAP_PORT_TYPE_ETH
condition|)
return|return
operator|(
operator|-
name|ENODEV
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_build_ifp_priv
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|,
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|num_comp_vectors
parameter_list|)
block|{
comment|/* 	 * TODO: Consider link speed for setting "log_sq_size", 	 * "log_rq_size" and "cq_moderation_xxx": 	 */
name|priv
operator|->
name|params
operator|.
name|log_sq_size
operator|=
name|MLX5E_PARAMS_DEFAULT_LOG_SQ_SIZE
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|log_rq_size
operator|=
name|MLX5E_PARAMS_DEFAULT_LOG_RQ_SIZE
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_usec
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|cq_period_start_from_cqe
argument_list|)
condition|?
name|MLX5E_PARAMS_DEFAULT_RX_CQ_MODERATION_USEC_FROM_CQE
else|:
name|MLX5E_PARAMS_DEFAULT_RX_CQ_MODERATION_USEC
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_mode
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|cq_period_start_from_cqe
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|rx_cq_moderation_pkts
operator|=
name|MLX5E_PARAMS_DEFAULT_RX_CQ_MODERATION_PKTS
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|tx_cq_moderation_usec
operator|=
name|MLX5E_PARAMS_DEFAULT_TX_CQ_MODERATION_USEC
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|tx_cq_moderation_pkts
operator|=
name|MLX5E_PARAMS_DEFAULT_TX_CQ_MODERATION_PKTS
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|min_rx_wqes
operator|=
name|MLX5E_PARAMS_DEFAULT_MIN_RX_WQES
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|rx_hash_log_tbl_sz
operator|=
operator|(
name|order_base_2
argument_list|(
name|num_comp_vectors
argument_list|)
operator|>
name|MLX5E_PARAMS_DEFAULT_RX_HASH_LOG_TBL_SZ
operator|)
condition|?
name|order_base_2
argument_list|(
name|num_comp_vectors
argument_list|)
else|:
name|MLX5E_PARAMS_DEFAULT_RX_HASH_LOG_TBL_SZ
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|num_tc
operator|=
literal|1
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|default_vlan_prio
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|counter_set_id
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* 	 * hw lro is currently defaulted to off. when it won't anymore we 	 * will consider the HW capability: "!!MLX5_CAP_ETH(mdev, lro_cap)" 	 */
name|priv
operator|->
name|params
operator|.
name|hw_lro_en
operator|=
name|false
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|lro_wqe_sz
operator|=
name|MLX5E_PARAMS_DEFAULT_LRO_WQE_SZ
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|cqe_zipping_en
operator|=
operator|!
operator|!
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|cqe_compression
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mdev
operator|=
name|mdev
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|num_channels
operator|=
name|num_comp_vectors
expr_stmt|;
name|priv
operator|->
name|order_base_2_num_channels
operator|=
name|order_base_2
argument_list|(
name|num_comp_vectors
argument_list|)
expr_stmt|;
name|priv
operator|->
name|queue_mapping_channel_mask
operator|=
name|roundup_pow_of_two
argument_list|(
name|num_comp_vectors
argument_list|)
operator|-
literal|1
expr_stmt|;
name|priv
operator|->
name|num_tc
operator|=
name|priv
operator|->
name|params
operator|.
name|num_tc
expr_stmt|;
name|priv
operator|->
name|default_vlan_prio
operator|=
name|priv
operator|->
name|params
operator|.
name|default_vlan_prio
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|update_stats_work
argument_list|,
name|mlx5e_update_stats_work
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|update_carrier_work
argument_list|,
name|mlx5e_update_carrier_work
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|set_rx_mode_work
argument_list|,
name|mlx5e_set_rx_mode_work
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_create_mkey
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|u32
name|pdn
parameter_list|,
name|struct
name|mlx5_core_mr
modifier|*
name|mr
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|priv
operator|->
name|ifp
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|priv
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx5_create_mkey_mbox_in
modifier|*
name|in
decl_stmt|;
name|int
name|err
decl_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: failed to allocate inbox\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
block|}
name|in
operator|->
name|seg
operator|.
name|flags
operator|=
name|MLX5_PERM_LOCAL_WRITE
operator||
name|MLX5_PERM_LOCAL_READ
operator||
name|MLX5_ACCESS_MODE_PA
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags_pd
operator|=
name|cpu_to_be32
argument_list|(
name|pdn
operator||
name|MLX5_MKEY_LEN64
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|qpn_mkey7_0
operator|=
name|cpu_to_be32
argument_list|(
literal|0xffffff
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_mkey
argument_list|(
name|mdev
argument_list|,
name|mr
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5_core_create_mkey failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|mlx5e_vport_stats_desc
index|[]
init|=
block|{
name|MLX5E_VPORT_STATS
argument_list|(
argument|MLX5E_STATS_DESC
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|mlx5e_pport_stats_desc
index|[]
init|=
block|{
name|MLX5E_PPORT_STATS
argument_list|(
argument|MLX5E_STATS_DESC
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|mlx5e_priv_mtx_init
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|mtx_init
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|,
literal|"mlx5async"
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|sx_init
argument_list|(
operator|&
name|priv
operator|->
name|state_lock
argument_list|,
literal|"mlx5state"
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|priv
operator|->
name|watchdog
argument_list|,
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|MLX5_INIT_DOORBELL_LOCK
argument_list|(
operator|&
name|priv
operator|->
name|doorbell_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_priv_mtx_destroy
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|priv
operator|->
name|state_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_firmware
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
comment|/* 	 * %d.%d%.d the string format. 	 * fw_rev_{maj,min,sub} return u16, 2^16 = 65536. 	 * We need at most 5 chars to store that. 	 * It also has: two "." and NULL at the end, which means we need 18 	 * (5*3 + 3) chars at most. 	 */
name|char
name|fw
index|[
literal|18
index|]
decl_stmt|;
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|arg1
decl_stmt|;
name|int
name|error
decl_stmt|;
name|snprintf
argument_list|(
name|fw
argument_list|,
sizeof|sizeof
argument_list|(
name|fw
argument_list|)
argument_list|,
literal|"%d.%d.%d"
argument_list|,
name|fw_rev_maj
argument_list|(
name|priv
operator|->
name|mdev
argument_list|)
argument_list|,
name|fw_rev_min
argument_list|(
name|priv
operator|->
name|mdev
argument_list|)
argument_list|,
name|fw_rev_sub
argument_list|(
name|priv
operator|->
name|mdev
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_string
argument_list|(
name|oidp
argument_list|,
name|fw
argument_list|,
sizeof|sizeof
argument_list|(
name|fw
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_add_hw_stats
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_hw
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fw_version"
argument_list|,
name|CTLTYPE_STRING
operator||
name|CTLFLAG_RD
argument_list|,
name|priv
argument_list|,
literal|0
argument_list|,
name|sysctl_firmware
argument_list|,
literal|"A"
argument_list|,
literal|"HCA firmware version"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_STRING
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_hw
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"board_id"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|priv
operator|->
name|mdev
operator|->
name|board_id
argument_list|,
literal|0
argument_list|,
literal|"Board ID"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_setup_pauseframes
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<
literal|1100000
operator|)
name|char
name|path
index|[
literal|64
index|]
decl_stmt|;
endif|#
directive|endif
comment|/* Only receiving pauseframes is enabled by default */
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
operator|=
literal|1
expr_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<
literal|1100000
operator|)
comment|/* compute path for sysctl */
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"dev.mce.%d.tx_pauseframe_control"
argument_list|,
name|device_get_unit
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* try to fetch tunable, if any */
name|TUNABLE_INT_FETCH
argument_list|(
name|path
argument_list|,
operator|&
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
argument_list|)
expr_stmt|;
comment|/* compute path for sysctl */
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"dev.mce.%d.rx_pauseframe_control"
argument_list|,
name|device_get_unit
argument_list|(
name|priv
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* try to fetch tunable, if any */
name|TUNABLE_INT_FETCH
argument_list|(
name|path
argument_list|,
operator|&
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* register pausframe SYSCTLs */
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_ifnet
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"tx_pauseframe_control"
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
argument_list|,
literal|0
argument_list|,
literal|"Set to enable TX pause frames. Clear to disable."
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_ifnet
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"rx_pauseframe_control"
argument_list|,
name|CTLFLAG_RDTUN
argument_list|,
operator|&
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
argument_list|,
literal|0
argument_list|,
literal|"Set to enable RX pause frames. Clear to disable."
argument_list|)
expr_stmt|;
comment|/* range check */
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
operator|=
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
operator|=
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
condition|?
literal|1
else|:
literal|0
expr_stmt|;
comment|/* update firmware */
name|mlx5_set_port_pause
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
literal|1
argument_list|,
name|priv
operator|->
name|params
operator|.
name|rx_pauseframe_control
argument_list|,
name|priv
operator|->
name|params
operator|.
name|tx_pauseframe_control
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|mlx5e_create_ifp
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|)
block|{
specifier|static
specifier|volatile
name|int
name|mlx5_en_unit
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mlx5e_priv
modifier|*
name|priv
decl_stmt|;
name|u8
name|dev_addr
index|[
name|ETHER_ADDR_LEN
index|]
name|__aligned
argument_list|(
literal|4
argument_list|)
decl_stmt|;
name|struct
name|sysctl_oid_list
modifier|*
name|child
decl_stmt|;
name|int
name|ncv
init|=
name|mdev
operator|->
name|priv
operator|.
name|eq_table
operator|.
name|num_comp_vectors
decl_stmt|;
name|char
name|unit
index|[
literal|16
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u32
name|eth_proto_cap
decl_stmt|;
if|if
condition|(
name|mlx5e_check_required_hca_cap
argument_list|(
name|mdev
argument_list|)
condition|)
block|{
name|mlx5_core_dbg
argument_list|(
name|mdev
argument_list|,
literal|"mlx5e_check_required_hca_cap() failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|priv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mlx5e_priv_mtx_init
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|priv
operator|->
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|mlx5_core_err
argument_list|(
name|mdev
argument_list|,
literal|"if_alloc() failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_free_priv
goto|;
block|}
name|ifp
operator|->
name|if_softc
operator|=
name|priv
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
literal|"mce"
argument_list|,
name|atomic_fetchadd_int
argument_list|(
operator|&
name|mlx5_en_unit
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_mtu
operator|=
name|ETHERMTU
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|mlx5e_open
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|mlx5e_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_transmit
operator|=
name|mlx5e_xmit
expr_stmt|;
name|ifp
operator|->
name|if_qflush
operator|=
name|if_qflush
expr_stmt|;
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100000
operator|)
name|ifp
operator|->
name|if_get_counter
operator|=
name|mlx5e_get_counter
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|ifqmaxlen
expr_stmt|;
comment|/*          * Set driver features          */
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWCSUM
operator||
name|IFCAP_HWCSUM_IPV6
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_MTU
operator||
name|IFCAP_VLAN_HWTAGGING
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWCSUM
operator||
name|IFCAP_VLAN_HWFILTER
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_LINKSTATE
operator||
name|IFCAP_JUMBO_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_LRO
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_TSO
operator||
name|IFCAP_VLAN_HWTSO
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_HWSTATS
expr_stmt|;
comment|/* set TSO limits so that we don't have to drop TX packets */
name|ifp
operator|->
name|if_hw_tsomax
operator|=
name|MLX5E_MAX_TX_PAYLOAD_SIZE
operator|-
operator|(
name|ETHER_HDR_LEN
operator|+
name|ETHER_VLAN_ENCAP_LEN
operator|)
expr_stmt|;
name|ifp
operator|->
name|if_hw_tsomaxsegcount
operator|=
name|MLX5E_MAX_TX_MBUF_FRAGS
operator|-
literal|1
comment|/* hdr */
expr_stmt|;
name|ifp
operator|->
name|if_hw_tsomaxsegsize
operator|=
name|MLX5E_MAX_TX_MBUF_SIZE
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator|=
name|ifp
operator|->
name|if_capabilities
expr_stmt|;
name|ifp
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TSO
condition|)
name|ifp
operator|->
name|if_hwassist
operator||=
name|CSUM_TSO
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM
condition|)
name|ifp
operator|->
name|if_hwassist
operator||=
operator|(
name|CSUM_TCP
operator||
name|CSUM_UDP
operator||
name|CSUM_IP
operator|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_TXCSUM_IPV6
condition|)
name|ifp
operator|->
name|if_hwassist
operator||=
operator|(
name|CSUM_UDP_IPV6
operator||
name|CSUM_TCP_IPV6
operator|)
expr_stmt|;
comment|/* ifnet sysctl tree */
name|sysctl_ctx_init
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|)
expr_stmt|;
name|priv
operator|->
name|sysctl_ifnet
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_dev
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|ifp
operator|->
name|if_dname
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"MLX5 ethernet - interface name"
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|sysctl_ifnet
operator|==
name|NULL
condition|)
block|{
name|mlx5_core_err
argument_list|(
name|mdev
argument_list|,
literal|"SYSCTL_ADD_NODE() failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_free_sysctl
goto|;
block|}
name|snprintf
argument_list|(
name|unit
argument_list|,
sizeof|sizeof
argument_list|(
name|unit
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|ifp
operator|->
name|if_dunit
argument_list|)
expr_stmt|;
name|priv
operator|->
name|sysctl_ifnet
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_ifnet
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|unit
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"MLX5 ethernet - interface unit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|sysctl_ifnet
operator|==
name|NULL
condition|)
block|{
name|mlx5_core_err
argument_list|(
name|mdev
argument_list|,
literal|"SYSCTL_ADD_NODE() failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_free_sysctl
goto|;
block|}
comment|/* HW sysctl tree */
name|child
operator|=
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|)
argument_list|)
expr_stmt|;
name|priv
operator|->
name|sysctl_hw
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|,
name|child
argument_list|,
name|OID_AUTO
argument_list|,
literal|"hw"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|"MLX5 ethernet dev hw"
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|sysctl_hw
operator|==
name|NULL
condition|)
block|{
name|mlx5_core_err
argument_list|(
name|mdev
argument_list|,
literal|"SYSCTL_ADD_NODE() failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_free_sysctl
goto|;
block|}
name|mlx5e_build_ifp_priv
argument_list|(
name|mdev
argument_list|,
name|priv
argument_list|,
name|ncv
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_alloc_map_uar
argument_list|(
name|mdev
argument_list|,
operator|&
name|priv
operator|->
name|cq_uar
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5_alloc_map_uar failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_free_sysctl
goto|;
block|}
name|err
operator|=
name|mlx5_core_alloc_pd
argument_list|(
name|mdev
argument_list|,
operator|&
name|priv
operator|->
name|pdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5_core_alloc_pd failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_unmap_free_uar
goto|;
block|}
name|err
operator|=
name|mlx5_alloc_transport_domain
argument_list|(
name|mdev
argument_list|,
operator|&
name|priv
operator|->
name|tdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5_alloc_transport_domain failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_dealloc_pd
goto|;
block|}
name|err
operator|=
name|mlx5e_create_mkey
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|pdn
argument_list|,
operator|&
name|priv
operator|->
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: mlx5e_create_mkey failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_dealloc_transport_domain
goto|;
block|}
name|mlx5_query_nic_vport_mac_address
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
literal|0
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
comment|/* check if we should generate a random MAC address */
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|vport_group_manager
argument_list|)
operator|==
literal|0
operator|&&
name|is_zero_ether_addr
argument_list|(
name|dev_addr
argument_list|)
condition|)
block|{
name|random_ether_addr
argument_list|(
name|dev_addr
argument_list|)
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Assigned random MAC address\n"
argument_list|)
expr_stmt|;
block|}
comment|/* set default MTU */
name|mlx5e_set_dev_port_mtu
argument_list|(
name|ifp
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
comment|/* Set desc */
name|device_set_desc
argument_list|(
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|,
name|mlx5e_version
argument_list|)
expr_stmt|;
comment|/* Set default media status */
name|priv
operator|->
name|media_status_last
operator|=
name|IFM_AVALID
expr_stmt|;
name|priv
operator|->
name|media_active_last
operator|=
name|IFM_ETHER
operator||
name|IFM_AUTO
operator||
name|IFM_ETH_RXPAUSE
operator||
name|IFM_FDX
expr_stmt|;
comment|/* setup default pauseframes configuration */
name|mlx5e_setup_pauseframes
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_query_port_proto_cap
argument_list|(
name|mdev
argument_list|,
operator|&
name|eth_proto_cap
argument_list|,
name|MLX5_PTYS_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|eth_proto_cap
operator|=
literal|0
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"%s: Query port media capability failed, %d\n"
argument_list|,
name|__func__
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
comment|/* Setup supported medias */
name|ifmedia_init
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_IMASK
operator||
name|IFM_ETH_FMASK
argument_list|,
name|mlx5e_media_change
argument_list|,
name|mlx5e_media_status
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5E_LINK_MODES_NUMBER
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|baudrate
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|MLX5E_PROT_MASK
argument_list|(
name|i
argument_list|)
operator|&
name|eth_proto_cap
condition|)
block|{
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|subtype
operator||
name|IFM_ETHER
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|mlx5e_mode_table
index|[
name|i
index|]
operator|.
name|subtype
operator||
name|IFM_ETHER
operator||
name|IFM_FDX
operator||
name|IFM_ETH_RXPAUSE
operator||
name|IFM_ETH_TXPAUSE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
operator||
name|IFM_FDX
operator||
name|IFM_ETH_RXPAUSE
operator||
name|IFM_ETH_TXPAUSE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Set autoselect by default */
name|ifmedia_set
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|,
name|IFM_ETHER
operator||
name|IFM_AUTO
operator||
name|IFM_FDX
operator||
name|IFM_ETH_RXPAUSE
operator||
name|IFM_ETH_TXPAUSE
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
comment|/* Register for VLAN events */
name|priv
operator|->
name|vlan_attach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_config
argument_list|,
name|mlx5e_vlan_rx_add_vid
argument_list|,
name|priv
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|priv
operator|->
name|vlan_detach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|mlx5e_vlan_rx_kill_vid
argument_list|,
name|priv
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
comment|/* Link is down by default */
name|if_link_state_change
argument_list|(
name|ifp
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
name|mlx5e_enable_async_events
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_add_hw_stats
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_create_stats
argument_list|(
operator|&
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_ifnet
argument_list|)
argument_list|,
literal|"vstats"
argument_list|,
name|mlx5e_vport_stats_desc
argument_list|,
name|MLX5E_VPORT_STATS_NUM
argument_list|,
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|arg
argument_list|)
expr_stmt|;
name|mlx5e_create_stats
argument_list|(
operator|&
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|priv
operator|->
name|sysctl_ifnet
argument_list|)
argument_list|,
literal|"pstats"
argument_list|,
name|mlx5e_pport_stats_desc
argument_list|,
name|MLX5E_PPORT_STATS_NUM
argument_list|,
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|arg
argument_list|)
expr_stmt|;
name|mlx5e_create_ethtool
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|)
expr_stmt|;
name|mlx5e_update_stats
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|priv
operator|->
name|async_events_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|priv
operator|)
return|;
name|err_dealloc_transport_domain
label|:
name|mlx5_dealloc_transport_domain
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|tdn
argument_list|)
expr_stmt|;
name|err_dealloc_pd
label|:
name|mlx5_core_dealloc_pd
argument_list|(
name|mdev
argument_list|,
name|priv
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|err_unmap_free_uar
label|:
name|mlx5_unmap_free_uar
argument_list|(
name|mdev
argument_list|,
operator|&
name|priv
operator|->
name|cq_uar
argument_list|)
expr_stmt|;
name|err_free_sysctl
label|:
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|err_free_priv
label|:
name|mlx5e_priv_mtx_destroy
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_destroy_ifp
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|,
name|void
modifier|*
name|vpriv
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|vpriv
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|priv
operator|->
name|ifp
decl_stmt|;
comment|/* don't allow more IOCTLs */
name|priv
operator|->
name|gone
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Clear the device description to avoid use after free, 	 * because the bsddev is not destroyed when this module is 	 * unloaded: 	 */
name|device_set_desc
argument_list|(
name|mdev
operator|->
name|pdev
operator|->
name|dev
operator|.
name|bsddev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* XXX wait a bit to allow IOCTL handlers to complete */
name|pause
argument_list|(
literal|"W"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
comment|/* stop watchdog timer */
name|callout_drain
argument_list|(
operator|&
name|priv
operator|->
name|watchdog
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_attach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|priv
operator|->
name|vlan_attach
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan_detach
operator|!=
name|NULL
condition|)
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|priv
operator|->
name|vlan_detach
argument_list|)
expr_stmt|;
comment|/* make sure device gets closed */
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_close_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* unregister device */
name|ifmedia_removeall
argument_list|(
operator|&
name|priv
operator|->
name|media
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* destroy all remaining sysctl nodes */
if|if
condition|(
name|priv
operator|->
name|sysctl_debug
condition|)
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|stats
operator|.
name|port_stats_debug
operator|.
name|ctx
argument_list|)
expr_stmt|;
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|stats
operator|.
name|vport
operator|.
name|ctx
argument_list|)
expr_stmt|;
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|stats
operator|.
name|pport
operator|.
name|ctx
argument_list|)
expr_stmt|;
name|sysctl_ctx_free
argument_list|(
operator|&
name|priv
operator|->
name|sysctl_ctx
argument_list|)
expr_stmt|;
name|mlx5_core_destroy_mkey
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|priv
operator|->
name|mr
argument_list|)
expr_stmt|;
name|mlx5_dealloc_transport_domain
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|tdn
argument_list|)
expr_stmt|;
name|mlx5_core_dealloc_pd
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|priv
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|mlx5_unmap_free_uar
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
operator|&
name|priv
operator|->
name|cq_uar
argument_list|)
expr_stmt|;
name|mlx5e_disable_async_events
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|flush_scheduled_work
argument_list|()
expr_stmt|;
name|mlx5e_priv_mtx_destroy
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|mlx5e_get_ifp
parameter_list|(
name|void
modifier|*
name|vpriv
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|vpriv
decl_stmt|;
return|return
operator|(
name|priv
operator|->
name|ifp
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|mlx5_interface
name|mlx5e_interface
init|=
block|{
operator|.
name|add
operator|=
name|mlx5e_create_ifp
block|,
operator|.
name|remove
operator|=
name|mlx5e_destroy_ifp
block|,
operator|.
name|event
operator|=
name|mlx5e_async_event
block|,
operator|.
name|protocol
operator|=
name|MLX5_INTERFACE_PROTOCOL_ETH
block|,
operator|.
name|get_dev
operator|=
name|mlx5e_get_ifp
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|mlx5e_init
parameter_list|(
name|void
parameter_list|)
block|{
name|mlx5_register_interface
argument_list|(
operator|&
name|mlx5e_interface
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx5e_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|mlx5_unregister_interface
argument_list|(
operator|&
name|mlx5e_interface
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|module_init_order
argument_list|(
name|mlx5e_init
argument_list|,
name|SI_ORDER_THIRD
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_exit_order
argument_list|(
name|mlx5e_cleanup
argument_list|,
name|SI_ORDER_THIRD
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|>=
literal|1100000
operator|)
end_if

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5en
argument_list|,
name|linuxkpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5en
argument_list|,
name|mlx5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|mlx5en
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Mellanox Technologies. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"en.h"
end_include

begin_include
include|#
directive|include
file|<linux/list.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/flow_table.h>
end_include

begin_enum
enum|enum
block|{
name|MLX5E_FULLMATCH
init|=
literal|0
block|,
name|MLX5E_ALLMULTI
init|=
literal|1
block|,
name|MLX5E_PROMISC
init|=
literal|2
block|, }
enum|;
end_enum

begin_enum
enum|enum
block|{
name|MLX5E_UC
init|=
literal|0
block|,
name|MLX5E_MC_IPV4
init|=
literal|1
block|,
name|MLX5E_MC_IPV6
init|=
literal|2
block|,
name|MLX5E_MC_OTHER
init|=
literal|3
block|, }
enum|;
end_enum

begin_enum
enum|enum
block|{
name|MLX5E_ACTION_NONE
init|=
literal|0
block|,
name|MLX5E_ACTION_ADD
init|=
literal|1
block|,
name|MLX5E_ACTION_DEL
init|=
literal|2
block|, }
enum|;
end_enum

begin_struct
struct|struct
name|mlx5e_eth_addr_hash_node
block|{
name|LIST_ENTRY
argument_list|(
argument|mlx5e_eth_addr_hash_node
argument_list|)
name|hlist
expr_stmt|;
name|u8
name|action
decl_stmt|;
name|struct
name|mlx5e_eth_addr_info
name|ai
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|inline
name|int
name|mlx5e_hash_eth_addr
parameter_list|(
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
return|return
operator|(
name|addr
index|[
literal|5
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_add_eth_addr_to_hash
parameter_list|(
name|struct
name|mlx5e_eth_addr_hash_head
modifier|*
name|hash
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|hn
decl_stmt|;
name|int
name|ix
init|=
name|mlx5e_hash_eth_addr
argument_list|(
name|addr
argument_list|)
decl_stmt|;
name|LIST_FOREACH
argument_list|(
argument|hn
argument_list|,
argument|&hash[ix]
argument_list|,
argument|hlist
argument_list|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
name|hn
operator|->
name|ai
operator|.
name|addr
argument_list|,
name|addr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hn
operator|->
name|action
operator|==
name|MLX5E_ACTION_DEL
condition|)
name|hn
operator|->
name|action
operator|=
name|MLX5E_ACTION_NONE
expr_stmt|;
return|return;
block|}
block|}
name|hn
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hn
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|hn
operator|==
name|NULL
condition|)
return|return;
name|ether_addr_copy
argument_list|(
name|hn
operator|->
name|ai
operator|.
name|addr
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|hn
operator|->
name|action
operator|=
name|MLX5E_ACTION_ADD
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|hash
index|[
name|ix
index|]
argument_list|,
name|hn
argument_list|,
name|hlist
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_del_eth_addr_from_hash
parameter_list|(
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|hn
parameter_list|)
block|{
name|LIST_REMOVE
argument_list|(
name|hn
argument_list|,
name|hlist
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hn
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_del_eth_addr_from_flow_table
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_eth_addr_info
modifier|*
name|ai
parameter_list|)
block|{
name|void
modifier|*
name|ft
init|=
name|priv
operator|->
name|ft
operator|.
expr|main
decl_stmt|;
if|if
condition|(
name|ai
operator|->
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_TCP
operator|)
condition|)
name|mlx5_del_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV6_TCP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_TCP
operator|)
condition|)
name|mlx5_del_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV4_TCP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_UDP
operator|)
condition|)
name|mlx5_del_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV6_UDP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_UDP
operator|)
condition|)
name|mlx5_del_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV4_UDP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6
operator|)
condition|)
name|mlx5_del_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV6
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4
operator|)
condition|)
name|mlx5_del_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV4
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|->
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_ANY
operator|)
condition|)
name|mlx5_del_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_ANY
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_get_eth_addr_type
parameter_list|(
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|ETHER_IS_MULTICAST
argument_list|(
name|addr
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|MLX5E_UC
operator|)
return|;
if|if
condition|(
operator|(
name|addr
index|[
literal|0
index|]
operator|==
literal|0x01
operator|)
operator|&&
operator|(
name|addr
index|[
literal|1
index|]
operator|==
literal|0x00
operator|)
operator|&&
operator|(
name|addr
index|[
literal|2
index|]
operator|==
literal|0x5e
operator|)
operator|&&
operator|!
operator|(
name|addr
index|[
literal|3
index|]
operator|&
literal|0x80
operator|)
condition|)
return|return
operator|(
name|MLX5E_MC_IPV4
operator|)
return|;
if|if
condition|(
operator|(
name|addr
index|[
literal|0
index|]
operator|==
literal|0x33
operator|)
operator|&&
operator|(
name|addr
index|[
literal|1
index|]
operator|==
literal|0x33
operator|)
condition|)
return|return
operator|(
name|MLX5E_MC_IPV6
operator|)
return|;
return|return
operator|(
name|MLX5E_MC_OTHER
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|mlx5e_get_tt_vec
parameter_list|(
name|struct
name|mlx5e_eth_addr_info
modifier|*
name|ai
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|int
name|eth_addr_type
decl_stmt|;
name|u32
name|ret
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MLX5E_FULLMATCH
case|:
name|eth_addr_type
operator|=
name|mlx5e_get_eth_addr_type
argument_list|(
name|ai
operator|->
name|addr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|eth_addr_type
condition|)
block|{
case|case
name|MLX5E_UC
case|:
name|ret
operator|=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_TCP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_TCP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_ANY
operator|)
operator||
literal|0
expr_stmt|;
break|break;
case|case
name|MLX5E_MC_IPV4
case|:
name|ret
operator|=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4
operator|)
operator||
literal|0
expr_stmt|;
break|break;
case|case
name|MLX5E_MC_IPV6
case|:
name|ret
operator|=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6
operator|)
operator||
literal|0
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
operator|(
literal|1
operator|<<
name|MLX5E_TT_ANY
operator|)
operator||
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|MLX5E_ALLMULTI
case|:
name|ret
operator|=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_ANY
operator|)
operator||
literal|0
expr_stmt|;
break|break;
default|default:
comment|/* MLX5E_PROMISC */
name|ret
operator|=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_TCP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_TCP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_UDP
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6
operator|)
operator||
operator|(
literal|1
operator|<<
name|MLX5E_TT_ANY
operator|)
operator||
literal|0
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_add_eth_addr_rule_sub
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_eth_addr_info
modifier|*
name|ai
parameter_list|,
name|int
name|type
parameter_list|,
name|void
modifier|*
name|flow_context
parameter_list|,
name|void
modifier|*
name|match_criteria
parameter_list|)
block|{
name|u8
name|match_criteria_enable
init|=
literal|0
decl_stmt|;
name|void
modifier|*
name|match_value
decl_stmt|;
name|void
modifier|*
name|dest
decl_stmt|;
name|u8
modifier|*
name|dmac
decl_stmt|;
name|u8
modifier|*
name|match_criteria_dmac
decl_stmt|;
name|void
modifier|*
name|ft
init|=
name|priv
operator|->
name|ft
operator|.
expr|main
decl_stmt|;
name|u32
modifier|*
name|tirn
init|=
name|priv
operator|->
name|tirn
decl_stmt|;
name|u32
name|tt_vec
decl_stmt|;
name|int
name|err
decl_stmt|;
name|match_value
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|match_value
argument_list|)
expr_stmt|;
name|dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|match_criteria_dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|dest
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|destination
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|action
argument_list|,
name|MLX5_FLOW_CONTEXT_ACTION_FWD_DEST
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|destination_list_size
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_type
argument_list|,
name|MLX5_FLOW_CONTEXT_DEST_TYPE_TIR
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MLX5E_FULLMATCH
case|:
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|memset
argument_list|(
name|match_criteria_dmac
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ether_addr_copy
argument_list|(
name|dmac
argument_list|,
name|ai
operator|->
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_ALLMULTI
case|:
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|match_criteria_dmac
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|dmac
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
break|break;
case|case
name|MLX5E_PROMISC
case|:
break|break;
default|default:
break|break;
block|}
name|tt_vec
operator|=
name|mlx5e_get_tt_vec
argument_list|(
name|ai
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_ANY
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|tirn
index|[
name|MLX5E_TT_ANY
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
operator|&
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_ANY
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|ai
operator|->
name|tt_vec
operator||=
operator|(
literal|1
operator|<<
name|MLX5E_TT_ANY
operator|)
expr_stmt|;
block|}
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|)
expr_stmt|;
if|if
condition|(
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|,
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|tirn
index|[
name|MLX5E_TT_IPV4
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
operator|&
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV4
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|ai
operator|->
name|tt_vec
operator||=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|,
name|ETHERTYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|tirn
index|[
name|MLX5E_TT_IPV6
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
operator|&
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV6
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|ai
operator|->
name|tt_vec
operator||=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6
operator|)
expr_stmt|;
block|}
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ip_protocol
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ip_protocol
argument_list|,
name|IPPROTO_UDP
argument_list|)
expr_stmt|;
if|if
condition|(
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_UDP
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|,
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|tirn
index|[
name|MLX5E_TT_IPV4_UDP
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
operator|&
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV4_UDP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|ai
operator|->
name|tt_vec
operator||=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_UDP
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_UDP
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|,
name|ETHERTYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|tirn
index|[
name|MLX5E_TT_IPV6_UDP
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
operator|&
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV6_UDP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|ai
operator|->
name|tt_vec
operator||=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_UDP
operator|)
expr_stmt|;
block|}
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ip_protocol
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_TCP
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|,
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|tirn
index|[
name|MLX5E_TT_IPV4_TCP
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
operator|&
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV4_TCP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|ai
operator|->
name|tt_vec
operator||=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV4_TCP
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|tt_vec
operator|&
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_TCP
operator|)
condition|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|,
name|ETHERTYPE_IPV6
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|tirn
index|[
name|MLX5E_TT_IPV6_TCP
index|]
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|ft
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
operator|&
name|ai
operator|->
name|ft_ix
index|[
name|MLX5E_TT_IPV6_TCP
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|ai
operator|->
name|tt_vec
operator||=
operator|(
literal|1
operator|<<
name|MLX5E_TT_IPV6_TCP
operator|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_add_eth_addr_rule
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_eth_addr_info
modifier|*
name|ai
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|u32
modifier|*
name|flow_context
decl_stmt|;
name|u32
modifier|*
name|match_criteria
decl_stmt|;
name|int
name|err
decl_stmt|;
name|flow_context
operator|=
name|mlx5_vzalloc
argument_list|(
name|MLX5_ST_SZ_BYTES
argument_list|(
name|flow_context
argument_list|)
operator|+
name|MLX5_ST_SZ_BYTES
argument_list|(
name|dest_format_struct
argument_list|)
argument_list|)
expr_stmt|;
name|match_criteria
operator|=
name|mlx5_vzalloc
argument_list|(
name|MLX5_ST_SZ_BYTES
argument_list|(
name|fte_match_param
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|flow_context
operator|||
operator|!
name|match_criteria
condition|)
block|{
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"%s: alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|add_eth_addr_rule_out
goto|;
block|}
name|err
operator|=
name|mlx5e_add_eth_addr_rule_sub
argument_list|(
name|priv
argument_list|,
name|ai
argument_list|,
name|type
argument_list|,
name|flow_context
argument_list|,
name|match_criteria
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|add_eth_addr_rule_out
label|:
name|kvfree
argument_list|(
name|match_criteria
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|flow_context
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_vport_context_update_vlans
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|priv
operator|->
name|ifp
decl_stmt|;
name|int
name|max_list_size
decl_stmt|;
name|int
name|list_size
decl_stmt|;
name|u16
modifier|*
name|vlans
decl_stmt|;
name|int
name|vlan
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|list_size
operator|=
literal|0
expr_stmt|;
name|for_each_set_bit
argument_list|(
argument|vlan
argument_list|,
argument|priv->vlan.active_vlans
argument_list|,
argument|VLAN_N_VID
argument_list|)
name|list_size
operator|++
expr_stmt|;
name|max_list_size
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|log_max_vlan_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|list_size
operator|>
name|max_list_size
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"ifnet vlans list size (%d)> (%d) max vport list size, some vlans will be dropped\n"
argument_list|,
name|list_size
argument_list|,
name|max_list_size
argument_list|)
expr_stmt|;
name|list_size
operator|=
name|max_list_size
expr_stmt|;
block|}
name|vlans
operator|=
name|kcalloc
argument_list|(
name|list_size
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vlans
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vlans
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|i
operator|=
literal|0
expr_stmt|;
name|for_each_set_bit
argument_list|(
argument|vlan
argument_list|,
argument|priv->vlan.active_vlans
argument_list|,
argument|VLAN_N_VID
argument_list|)
block|{
if|if
condition|(
name|i
operator|>=
name|list_size
condition|)
break|break;
name|vlans
index|[
name|i
operator|++
index|]
operator|=
name|vlan
expr_stmt|;
block|}
name|err
operator|=
name|mlx5_modify_nic_vport_vlans
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|vlans
argument_list|,
name|list_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"Failed to modify vport vlans list err(%d)\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|vlans
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_enum
enum|enum
name|mlx5e_vlan_rule_type
block|{
name|MLX5E_VLAN_RULE_TYPE_UNTAGGED
block|,
name|MLX5E_VLAN_RULE_TYPE_ANY_VID
block|,
name|MLX5E_VLAN_RULE_TYPE_MATCH_VID
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|mlx5e_add_vlan_rule
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|enum
name|mlx5e_vlan_rule_type
name|rule_type
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
name|u8
name|match_criteria_enable
init|=
literal|0
decl_stmt|;
name|u32
modifier|*
name|flow_context
decl_stmt|;
name|void
modifier|*
name|match_value
decl_stmt|;
name|void
modifier|*
name|dest
decl_stmt|;
name|u32
modifier|*
name|match_criteria
decl_stmt|;
name|u32
modifier|*
name|ft_ix
decl_stmt|;
name|int
name|err
decl_stmt|;
name|flow_context
operator|=
name|mlx5_vzalloc
argument_list|(
name|MLX5_ST_SZ_BYTES
argument_list|(
name|flow_context
argument_list|)
operator|+
name|MLX5_ST_SZ_BYTES
argument_list|(
name|dest_format_struct
argument_list|)
argument_list|)
expr_stmt|;
name|match_criteria
operator|=
name|mlx5_vzalloc
argument_list|(
name|MLX5_ST_SZ_BYTES
argument_list|(
name|fte_match_param
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|flow_context
operator|||
operator|!
name|match_criteria
condition|)
block|{
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"%s: alloc failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|add_vlan_rule_out
goto|;
block|}
name|match_value
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|match_value
argument_list|)
expr_stmt|;
name|dest
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|destination
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|action
argument_list|,
name|MLX5_FLOW_CONTEXT_ACTION_FWD_DEST
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|flow_context
argument_list|,
name|flow_context
argument_list|,
name|destination_list_size
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_type
argument_list|,
name|MLX5_FLOW_CONTEXT_DEST_TYPE_FLOW_TABLE
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|dest_format_struct
argument_list|,
name|dest
argument_list|,
name|destination_id
argument_list|,
name|mlx5_get_flow_table_id
argument_list|(
name|priv
operator|->
name|ft
operator|.
expr|main
argument_list|)
argument_list|)
expr_stmt|;
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|cvlan_tag
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rule_type
condition|)
block|{
case|case
name|MLX5E_VLAN_RULE_TYPE_UNTAGGED
case|:
name|ft_ix
operator|=
operator|&
name|priv
operator|->
name|vlan
operator|.
name|untagged_rule_ft_ix
expr_stmt|;
break|break;
case|case
name|MLX5E_VLAN_RULE_TYPE_ANY_VID
case|:
name|ft_ix
operator|=
operator|&
name|priv
operator|->
name|vlan
operator|.
name|any_vlan_rule_ft_ix
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|cvlan_tag
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* MLX5E_VLAN_RULE_TYPE_MATCH_VID */
name|ft_ix
operator|=
operator|&
name|priv
operator|->
name|vlan
operator|.
name|active_vlans_ft_ix
index|[
name|vid
index|]
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|cvlan_tag
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|first_vid
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_param
argument_list|,
name|match_value
argument_list|,
name|outer_headers
operator|.
name|first_vid
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|mlx5e_vport_context_update_vlans
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
block|}
name|err
operator|=
name|mlx5_add_flow_table_entry
argument_list|(
name|priv
operator|->
name|ft
operator|.
name|vlan
argument_list|,
name|match_criteria_enable
argument_list|,
name|match_criteria
argument_list|,
name|flow_context
argument_list|,
name|ft_ix
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"%s: failed\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|add_vlan_rule_out
label|:
name|kvfree
argument_list|(
name|match_criteria
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|flow_context
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_del_vlan_rule
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|enum
name|mlx5e_vlan_rule_type
name|rule_type
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
switch|switch
condition|(
name|rule_type
condition|)
block|{
case|case
name|MLX5E_VLAN_RULE_TYPE_UNTAGGED
case|:
name|mlx5_del_flow_table_entry
argument_list|(
name|priv
operator|->
name|ft
operator|.
name|vlan
argument_list|,
name|priv
operator|->
name|vlan
operator|.
name|untagged_rule_ft_ix
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_VLAN_RULE_TYPE_ANY_VID
case|:
name|mlx5_del_flow_table_entry
argument_list|(
name|priv
operator|->
name|ft
operator|.
name|vlan
argument_list|,
name|priv
operator|->
name|vlan
operator|.
name|any_vlan_rule_ft_ix
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5E_VLAN_RULE_TYPE_MATCH_VID
case|:
name|mlx5_del_flow_table_entry
argument_list|(
name|priv
operator|->
name|ft
operator|.
name|vlan
argument_list|,
name|priv
operator|->
name|vlan
operator|.
name|active_vlans_ft_ix
index|[
name|vid
index|]
argument_list|)
expr_stmt|;
name|mlx5e_vport_context_update_vlans
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|mlx5e_enable_vlan_filter
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
if|if
condition|(
name|priv
operator|->
name|vlan
operator|.
name|filter_disabled
condition|)
block|{
name|priv
operator|->
name|vlan
operator|.
name|filter_disabled
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_del_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_ANY_VID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|mlx5e_disable_vlan_filter
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
if|if
condition|(
operator|!
name|priv
operator|->
name|vlan
operator|.
name|filter_disabled
condition|)
block|{
name|priv
operator|->
name|vlan
operator|.
name|filter_disabled
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_add_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_ANY_VID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|mlx5e_vlan_rx_add_vid
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|priv
operator|->
name|ifp
condition|)
return|return;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|vid
argument_list|,
name|priv
operator|->
name|vlan
operator|.
name|active_vlans
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_add_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_MATCH_VID
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx5e_vlan_rx_kill_vid
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u16
name|vid
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|priv
operator|->
name|ifp
condition|)
return|return;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|clear_bit
argument_list|(
name|vid
argument_list|,
name|priv
operator|->
name|vlan
operator|.
name|active_vlans
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_del_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_MATCH_VID
argument_list|,
name|vid
argument_list|)
expr_stmt|;
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5e_add_all_vlan_rules
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|u16
name|vid
decl_stmt|;
name|int
name|err
decl_stmt|;
name|for_each_set_bit
argument_list|(
argument|vid
argument_list|,
argument|priv->vlan.active_vlans
argument_list|,
argument|VLAN_N_VID
argument_list|)
block|{
name|err
operator|=
name|mlx5e_add_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_MATCH_VID
argument_list|,
name|vid
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|mlx5e_add_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_UNTAGGED
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|priv
operator|->
name|vlan
operator|.
name|filter_disabled
condition|)
block|{
name|err
operator|=
name|mlx5e_add_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_ANY_VID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mlx5e_del_all_vlan_rules
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|u16
name|vid
decl_stmt|;
if|if
condition|(
name|priv
operator|->
name|vlan
operator|.
name|filter_disabled
condition|)
name|mlx5e_del_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_ANY_VID
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mlx5e_del_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_UNTAGGED
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|for_each_set_bit
argument_list|(
argument|vid
argument_list|,
argument|priv->vlan.active_vlans
argument_list|,
argument|VLAN_N_VID
argument_list|)
name|mlx5e_del_vlan_rule
argument_list|(
name|priv
argument_list|,
name|MLX5E_VLAN_RULE_TYPE_MATCH_VID
argument_list|,
name|vid
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|mlx5e_for_each_hash_node
parameter_list|(
name|hn
parameter_list|,
name|tmp
parameter_list|,
name|hash
parameter_list|,
name|i
parameter_list|)
define|\
value|for (i = 0; i< MLX5E_ETH_ADDR_HASH_SIZE; i++) \ 		LIST_FOREACH_SAFE(hn,&(hash)[i], hlist, tmp)
end_define

begin_function
specifier|static
name|void
name|mlx5e_execute_action
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|hn
parameter_list|)
block|{
switch|switch
condition|(
name|hn
operator|->
name|action
condition|)
block|{
case|case
name|MLX5E_ACTION_ADD
case|:
name|mlx5e_add_eth_addr_rule
argument_list|(
name|priv
argument_list|,
operator|&
name|hn
operator|->
name|ai
argument_list|,
name|MLX5E_FULLMATCH
argument_list|)
expr_stmt|;
name|hn
operator|->
name|action
operator|=
name|MLX5E_ACTION_NONE
expr_stmt|;
break|break;
case|case
name|MLX5E_ACTION_DEL
case|:
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
operator|&
name|hn
operator|->
name|ai
argument_list|)
expr_stmt|;
name|mlx5e_del_eth_addr_from_hash
argument_list|(
name|hn
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_sync_ifp_addr
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|priv
operator|->
name|ifp
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
comment|/* XXX adding this entry might not be needed */
name|mlx5e_add_eth_addr_to_hash
argument_list|(
name|priv
operator|->
name|eth_addr
operator|.
name|if_uc
argument_list|,
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|ifp
operator|->
name|if_addr
operator|->
name|ifa_addr
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|if_addr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifa
argument_list|,
argument|&ifp->if_addrhead
argument_list|,
argument|ifa_link
argument_list|)
block|{
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|mlx5e_add_eth_addr_to_hash
argument_list|(
name|priv
operator|->
name|eth_addr
operator|.
name|if_uc
argument_list|,
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|if_addr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|mlx5e_add_eth_addr_to_hash
argument_list|(
name|priv
operator|->
name|eth_addr
operator|.
name|if_mc
argument_list|,
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_fill_addr_array
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|list_type
parameter_list|,
name|u8
name|addr_array
index|[]
index|[
name|ETH_ALEN
index|]
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|bool
name|is_uc
init|=
operator|(
name|list_type
operator|==
name|MLX5_NIC_VPORT_LIST_TYPE_UC
operator|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|priv
operator|->
name|ifp
decl_stmt|;
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|hn
decl_stmt|;
name|struct
name|mlx5e_eth_addr_hash_head
modifier|*
name|addr_list
decl_stmt|;
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|tmp
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|hi
decl_stmt|;
name|addr_list
operator|=
name|is_uc
condition|?
name|priv
operator|->
name|eth_addr
operator|.
name|if_uc
else|:
name|priv
operator|->
name|eth_addr
operator|.
name|if_mc
expr_stmt|;
if|if
condition|(
name|is_uc
condition|)
comment|/* Make sure our own address is pushed first */
name|ether_addr_copy
argument_list|(
name|addr_array
index|[
name|i
operator|++
index|]
argument_list|,
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|priv
operator|->
name|eth_addr
operator|.
name|broadcast_enabled
condition|)
name|ether_addr_copy
argument_list|(
name|addr_array
index|[
name|i
operator|++
index|]
argument_list|,
name|ifp
operator|->
name|if_broadcastaddr
argument_list|)
expr_stmt|;
name|mlx5e_for_each_hash_node
argument_list|(
argument|hn
argument_list|,
argument|tmp
argument_list|,
argument|addr_list
argument_list|,
argument|hi
argument_list|)
block|{
if|if
condition|(
name|ether_addr_equal
argument_list|(
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
argument_list|,
name|hn
operator|->
name|ai
operator|.
name|addr
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|i
operator|>=
name|size
condition|)
break|break;
name|ether_addr_copy
argument_list|(
name|addr_array
index|[
name|i
operator|++
index|]
argument_list|,
name|hn
operator|->
name|ai
operator|.
name|addr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_vport_context_update_addr_list
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|,
name|int
name|list_type
parameter_list|)
block|{
name|bool
name|is_uc
init|=
operator|(
name|list_type
operator|==
name|MLX5_NIC_VPORT_LIST_TYPE_UC
operator|)
decl_stmt|;
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|hn
decl_stmt|;
name|u8
argument_list|(
operator|*
name|addr_array
argument_list|)
index|[
name|ETH_ALEN
index|]
operator|=
name|NULL
expr_stmt|;
name|struct
name|mlx5e_eth_addr_hash_head
modifier|*
name|addr_list
decl_stmt|;
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|tmp
decl_stmt|;
name|int
name|max_size
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|hi
decl_stmt|;
name|size
operator|=
name|is_uc
condition|?
literal|0
else|:
operator|(
name|priv
operator|->
name|eth_addr
operator|.
name|broadcast_enabled
condition|?
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|max_size
operator|=
name|is_uc
condition|?
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|log_max_current_uc_list
argument_list|)
else|:
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|log_max_current_mc_list
argument_list|)
expr_stmt|;
name|addr_list
operator|=
name|is_uc
condition|?
name|priv
operator|->
name|eth_addr
operator|.
name|if_uc
else|:
name|priv
operator|->
name|eth_addr
operator|.
name|if_mc
expr_stmt|;
name|mlx5e_for_each_hash_node
argument_list|(
argument|hn
argument_list|,
argument|tmp
argument_list|,
argument|addr_list
argument_list|,
argument|hi
argument_list|)
name|size
operator|++
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|max_size
condition|)
block|{
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"ifp %s list size (%d)> (%d) max vport list size, some addresses will be dropped\n"
argument_list|,
name|is_uc
condition|?
literal|"UC"
else|:
literal|"MC"
argument_list|,
name|size
argument_list|,
name|max_size
argument_list|)
expr_stmt|;
name|size
operator|=
name|max_size
expr_stmt|;
block|}
if|if
condition|(
name|size
condition|)
block|{
name|addr_array
operator|=
name|kcalloc
argument_list|(
name|size
argument_list|,
name|ETH_ALEN
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|addr_array
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|mlx5e_fill_addr_array
argument_list|(
name|priv
argument_list|,
name|list_type
argument_list|,
name|addr_array
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mlx5_modify_nic_vport_mac_list
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
name|list_type
argument_list|,
name|addr_array
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|err
condition|)
name|if_printf
argument_list|(
name|priv
operator|->
name|ifp
argument_list|,
literal|"Failed to modify vport %s list err(%d)\n"
argument_list|,
name|is_uc
condition|?
literal|"UC"
else|:
literal|"MC"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|addr_array
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_vport_context_update
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5e_eth_addr_db
modifier|*
name|ea
init|=
operator|&
name|priv
operator|->
name|eth_addr
decl_stmt|;
name|mlx5e_vport_context_update_addr_list
argument_list|(
name|priv
argument_list|,
name|MLX5_NIC_VPORT_LIST_TYPE_UC
argument_list|)
expr_stmt|;
name|mlx5e_vport_context_update_addr_list
argument_list|(
name|priv
argument_list|,
name|MLX5_NIC_VPORT_LIST_TYPE_MC
argument_list|)
expr_stmt|;
name|mlx5_modify_nic_vport_promisc
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
literal|0
argument_list|,
name|ea
operator|->
name|allmulti_enabled
argument_list|,
name|ea
operator|->
name|promisc_enabled
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_apply_ifp_addr
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|hn
decl_stmt|;
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mlx5e_for_each_hash_node
argument_list|(
argument|hn
argument_list|,
argument|tmp
argument_list|,
argument|priv->eth_addr.if_uc
argument_list|,
argument|i
argument_list|)
name|mlx5e_execute_action
argument_list|(
name|priv
argument_list|,
name|hn
argument_list|)
expr_stmt|;
name|mlx5e_for_each_hash_node
argument_list|(
argument|hn
argument_list|,
argument|tmp
argument_list|,
argument|priv->eth_addr.if_mc
argument_list|,
argument|i
argument_list|)
name|mlx5e_execute_action
argument_list|(
name|priv
argument_list|,
name|hn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_handle_ifp_addr
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|hn
decl_stmt|;
name|struct
name|mlx5e_eth_addr_hash_node
modifier|*
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mlx5e_for_each_hash_node
argument_list|(
argument|hn
argument_list|,
argument|tmp
argument_list|,
argument|priv->eth_addr.if_uc
argument_list|,
argument|i
argument_list|)
name|hn
operator|->
name|action
operator|=
name|MLX5E_ACTION_DEL
expr_stmt|;
name|mlx5e_for_each_hash_node
argument_list|(
argument|hn
argument_list|,
argument|tmp
argument_list|,
argument|priv->eth_addr.if_mc
argument_list|,
argument|i
argument_list|)
name|hn
operator|->
name|action
operator|=
name|MLX5E_ACTION_DEL
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_sync_ifp_addr
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_apply_ifp_addr
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx5e_set_rx_mode_core
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5e_eth_addr_db
modifier|*
name|ea
init|=
operator|&
name|priv
operator|->
name|eth_addr
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ndev
init|=
name|priv
operator|->
name|ifp
decl_stmt|;
name|bool
name|rx_mode_enable
init|=
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
decl_stmt|;
name|bool
name|promisc_enabled
init|=
name|rx_mode_enable
operator|&&
operator|(
name|ndev
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
decl_stmt|;
name|bool
name|allmulti_enabled
init|=
name|rx_mode_enable
operator|&&
operator|(
name|ndev
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
operator|)
decl_stmt|;
name|bool
name|broadcast_enabled
init|=
name|rx_mode_enable
decl_stmt|;
name|bool
name|enable_promisc
init|=
operator|!
name|ea
operator|->
name|promisc_enabled
operator|&&
name|promisc_enabled
decl_stmt|;
name|bool
name|disable_promisc
init|=
name|ea
operator|->
name|promisc_enabled
operator|&&
operator|!
name|promisc_enabled
decl_stmt|;
name|bool
name|enable_allmulti
init|=
operator|!
name|ea
operator|->
name|allmulti_enabled
operator|&&
name|allmulti_enabled
decl_stmt|;
name|bool
name|disable_allmulti
init|=
name|ea
operator|->
name|allmulti_enabled
operator|&&
operator|!
name|allmulti_enabled
decl_stmt|;
name|bool
name|enable_broadcast
init|=
operator|!
name|ea
operator|->
name|broadcast_enabled
operator|&&
name|broadcast_enabled
decl_stmt|;
name|bool
name|disable_broadcast
init|=
name|ea
operator|->
name|broadcast_enabled
operator|&&
operator|!
name|broadcast_enabled
decl_stmt|;
comment|/* update broadcast address */
name|ether_addr_copy
argument_list|(
name|priv
operator|->
name|eth_addr
operator|.
name|broadcast
operator|.
name|addr
argument_list|,
name|priv
operator|->
name|ifp
operator|->
name|if_broadcastaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_promisc
condition|)
name|mlx5e_add_eth_addr_rule
argument_list|(
name|priv
argument_list|,
operator|&
name|ea
operator|->
name|promisc
argument_list|,
name|MLX5E_PROMISC
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_allmulti
condition|)
name|mlx5e_add_eth_addr_rule
argument_list|(
name|priv
argument_list|,
operator|&
name|ea
operator|->
name|allmulti
argument_list|,
name|MLX5E_ALLMULTI
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_broadcast
condition|)
name|mlx5e_add_eth_addr_rule
argument_list|(
name|priv
argument_list|,
operator|&
name|ea
operator|->
name|broadcast
argument_list|,
name|MLX5E_FULLMATCH
argument_list|)
expr_stmt|;
name|mlx5e_handle_ifp_addr
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|disable_broadcast
condition|)
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
operator|&
name|ea
operator|->
name|broadcast
argument_list|)
expr_stmt|;
if|if
condition|(
name|disable_allmulti
condition|)
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
operator|&
name|ea
operator|->
name|allmulti
argument_list|)
expr_stmt|;
if|if
condition|(
name|disable_promisc
condition|)
name|mlx5e_del_eth_addr_from_flow_table
argument_list|(
name|priv
argument_list|,
operator|&
name|ea
operator|->
name|promisc
argument_list|)
expr_stmt|;
name|ea
operator|->
name|promisc_enabled
operator|=
name|promisc_enabled
expr_stmt|;
name|ea
operator|->
name|allmulti_enabled
operator|=
name|allmulti_enabled
expr_stmt|;
name|ea
operator|->
name|broadcast_enabled
operator|=
name|broadcast_enabled
expr_stmt|;
name|mlx5e_vport_context_update
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mlx5e_set_rx_mode_work
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx5e_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx5e_priv
argument_list|,
name|set_rx_mode_work
argument_list|)
decl_stmt|;
name|PRIV_LOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|MLX5E_STATE_OPENED
argument_list|,
operator|&
name|priv
operator|->
name|state
argument_list|)
condition|)
name|mlx5e_set_rx_mode_core
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|PRIV_UNLOCK
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_create_main_flow_table
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5_flow_table_group
modifier|*
name|g
decl_stmt|;
name|u8
modifier|*
name|dmac
decl_stmt|;
name|g
operator|=
name|malloc
argument_list|(
literal|9
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|g
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|g
index|[
literal|0
index|]
operator|.
name|log_sz
operator|=
literal|2
expr_stmt|;
name|g
index|[
literal|0
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|0
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|)
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|0
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ip_protocol
argument_list|)
expr_stmt|;
name|g
index|[
literal|1
index|]
operator|.
name|log_sz
operator|=
literal|1
expr_stmt|;
name|g
index|[
literal|1
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|1
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|)
expr_stmt|;
name|g
index|[
literal|2
index|]
operator|.
name|log_sz
operator|=
literal|0
expr_stmt|;
name|g
index|[
literal|3
index|]
operator|.
name|log_sz
operator|=
literal|14
expr_stmt|;
name|g
index|[
literal|3
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|3
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dmac
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|3
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|)
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|3
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ip_protocol
argument_list|)
expr_stmt|;
name|g
index|[
literal|4
index|]
operator|.
name|log_sz
operator|=
literal|13
expr_stmt|;
name|g
index|[
literal|4
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|4
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dmac
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|4
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|)
expr_stmt|;
name|g
index|[
literal|5
index|]
operator|.
name|log_sz
operator|=
literal|11
expr_stmt|;
name|g
index|[
literal|5
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|5
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dmac
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|g
index|[
literal|6
index|]
operator|.
name|log_sz
operator|=
literal|2
expr_stmt|;
name|g
index|[
literal|6
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|6
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|dmac
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|6
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|)
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|6
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ip_protocol
argument_list|)
expr_stmt|;
name|g
index|[
literal|7
index|]
operator|.
name|log_sz
operator|=
literal|1
expr_stmt|;
name|g
index|[
literal|7
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|7
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|dmac
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|7
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|ethertype
argument_list|)
expr_stmt|;
name|g
index|[
literal|8
index|]
operator|.
name|log_sz
operator|=
literal|0
expr_stmt|;
name|g
index|[
literal|8
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|dmac
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|8
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|dmac_47_16
argument_list|)
expr_stmt|;
name|dmac
index|[
literal|0
index|]
operator|=
literal|0x01
expr_stmt|;
name|priv
operator|->
name|ft
operator|.
expr|main
operator|=
name|mlx5_create_flow_table
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
literal|1
argument_list|,
name|MLX5_FLOW_TABLE_TYPE_NIC_RCV
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|g
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
return|return
operator|(
name|priv
operator|->
name|ft
operator|.
expr|main
condition|?
literal|0
else|:
operator|-
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_destroy_main_flow_table
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|mlx5_destroy_flow_table
argument_list|(
name|priv
operator|->
name|ft
operator|.
expr|main
argument_list|)
expr_stmt|;
name|priv
operator|->
name|ft
operator|.
expr|main
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_create_vlan_flow_table
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mlx5_flow_table_group
modifier|*
name|g
decl_stmt|;
name|g
operator|=
name|malloc
argument_list|(
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|g
argument_list|)
argument_list|,
name|M_MLX5EN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|g
index|[
literal|0
index|]
operator|.
name|log_sz
operator|=
literal|12
expr_stmt|;
name|g
index|[
literal|0
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|0
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|cvlan_tag
argument_list|)
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|0
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|first_vid
argument_list|)
expr_stmt|;
comment|/* untagged + any vlan id */
name|g
index|[
literal|1
index|]
operator|.
name|log_sz
operator|=
literal|1
expr_stmt|;
name|g
index|[
literal|1
index|]
operator|.
name|match_criteria_enable
operator|=
name|MLX5_MATCH_OUTER_HEADERS
expr_stmt|;
name|MLX5_SET_TO_ONES
argument_list|(
name|fte_match_param
argument_list|,
name|g
index|[
literal|1
index|]
operator|.
name|match_criteria
argument_list|,
name|outer_headers
operator|.
name|cvlan_tag
argument_list|)
expr_stmt|;
name|priv
operator|->
name|ft
operator|.
name|vlan
operator|=
name|mlx5_create_flow_table
argument_list|(
name|priv
operator|->
name|mdev
argument_list|,
literal|0
argument_list|,
name|MLX5_FLOW_TABLE_TYPE_NIC_RCV
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|g
argument_list|,
name|M_MLX5EN
argument_list|)
expr_stmt|;
return|return
operator|(
name|priv
operator|->
name|ft
operator|.
name|vlan
condition|?
literal|0
else|:
operator|-
name|ENOMEM
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_destroy_vlan_flow_table
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|mlx5_destroy_flow_table
argument_list|(
name|priv
operator|->
name|ft
operator|.
name|vlan
argument_list|)
expr_stmt|;
name|priv
operator|->
name|ft
operator|.
name|vlan
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5e_open_flow_table
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5e_create_main_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|err
operator|=
name|mlx5e_create_vlan_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_destroy_main_flow_table
goto|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_destroy_main_flow_table
label|:
name|mlx5e_destroy_main_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mlx5e_close_flow_table
parameter_list|(
name|struct
name|mlx5e_priv
modifier|*
name|priv
parameter_list|)
block|{
name|mlx5e_destroy_vlan_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mlx5e_destroy_main_flow_table
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Mellanox Technologies. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"en.h"
end_include

begin_include
include|#
directive|include
file|<machine/in_cksum.h>
end_include

begin_function
specifier|static
specifier|inline
name|int
name|mlx5e_alloc_rx_wqe
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|mlx5e_rx_wqe
modifier|*
name|wqe
parameter_list|,
name|u16
name|ix
parameter_list|)
block|{
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|rq
operator|->
name|mbuf
index|[
name|ix
index|]
operator|.
name|mbuf
operator|!=
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|mb
operator|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|rq
operator|->
name|wqe_sz
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|mb
argument_list|)
condition|)
return|return
operator|(
operator|-
name|ENOMEM
operator|)
return|;
comment|/* set initial mbuf length */
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|mb
operator|->
name|m_len
operator|=
name|rq
operator|->
name|wqe_sz
expr_stmt|;
comment|/* get IP header aligned */
name|m_adj
argument_list|(
name|mb
argument_list|,
name|MLX5E_NET_IP_ALIGN
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|ix
index|]
operator|.
name|dma_map
argument_list|,
name|mb
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
goto|goto
name|err_free_mbuf
goto|;
if|if
condition|(
name|unlikely
argument_list|(
name|nsegs
operator|!=
literal|1
argument_list|)
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|ix
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free_mbuf
goto|;
block|}
name|wqe
operator|->
name|data
operator|.
name|addr
operator|=
name|cpu_to_be64
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|rq
operator|->
name|mbuf
index|[
name|ix
index|]
operator|.
name|mbuf
operator|=
name|mb
expr_stmt|;
name|rq
operator|->
name|mbuf
index|[
name|ix
index|]
operator|.
name|data
operator|=
name|mb
operator|->
name|m_data
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|ix
index|]
operator|.
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err_free_mbuf
label|:
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_post_rx_wqes
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|)
block|{
if|if
condition|(
name|unlikely
argument_list|(
name|rq
operator|->
name|enabled
operator|==
literal|0
argument_list|)
condition|)
return|return;
while|while
condition|(
operator|!
name|mlx5_wq_ll_is_full
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|)
condition|)
block|{
name|struct
name|mlx5e_rx_wqe
modifier|*
name|wqe
init|=
name|mlx5_wq_ll_get_wqe
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|,
name|rq
operator|->
name|wq
operator|.
name|head
argument_list|)
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|mlx5e_alloc_rx_wqe
argument_list|(
name|rq
argument_list|,
name|wqe
argument_list|,
name|rq
operator|->
name|wq
operator|.
name|head
argument_list|)
argument_list|)
condition|)
block|{
name|callout_reset_curcpu
argument_list|(
operator|&
name|rq
operator|->
name|watchdog
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|mlx5e_post_rx_wqes
argument_list|,
name|rq
argument_list|)
expr_stmt|;
break|break;
block|}
name|mlx5_wq_ll_push
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|,
name|be16_to_cpu
argument_list|(
name|wqe
operator|->
name|next
operator|.
name|next_wqe_index
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* ensure wqes are visible to device before updating doorbell record */
name|wmb
argument_list|()
expr_stmt|;
name|mlx5_wq_ll_update_db_record
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5e_lro_update_hdr
parameter_list|(
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|struct
name|mlx5_cqe64
modifier|*
name|cqe
parameter_list|)
block|{
comment|/* TODO: consider vlans, ip options, ... */
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|uint16_t
name|eh_type
decl_stmt|;
name|uint16_t
name|tot_len
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
init|=
name|NULL
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip4
init|=
name|NULL
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
decl_stmt|;
name|uint32_t
modifier|*
name|ts_ptr
decl_stmt|;
name|uint8_t
name|l4_hdr_type
decl_stmt|;
name|int
name|tcp_ack
decl_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|eh_type
operator|=
name|ntohs
argument_list|(
name|eh
operator|->
name|ether_type
argument_list|)
expr_stmt|;
name|l4_hdr_type
operator|=
name|get_cqe_l4_hdr_type
argument_list|(
name|cqe
argument_list|)
expr_stmt|;
name|tcp_ack
operator|=
operator|(
operator|(
name|CQE_L4_HDR_TYPE_TCP_ACK_NO_DATA
operator|==
name|l4_hdr_type
operator|)
operator|||
operator|(
name|CQE_L4_HDR_TYPE_TCP_ACK_AND_DATA
operator|==
name|l4_hdr_type
operator|)
operator|)
expr_stmt|;
comment|/* TODO: consider vlan */
name|tot_len
operator|=
name|be32_to_cpu
argument_list|(
name|cqe
operator|->
name|byte_cnt
argument_list|)
operator|-
name|ETHER_HDR_LEN
expr_stmt|;
switch|switch
condition|(
name|eh_type
condition|)
block|{
case|case
name|ETHERTYPE_IP
case|:
name|ip4
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|ip4
operator|+
literal|1
operator|)
expr_stmt|;
break|break;
case|case
name|ETHERTYPE_IPV6
case|:
name|ip6
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|eh
operator|+
literal|1
operator|)
expr_stmt|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|ip6
operator|+
literal|1
operator|)
expr_stmt|;
break|break;
default|default:
return|return;
block|}
name|ts_ptr
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|th
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|get_cqe_lro_tcppsh
argument_list|(
name|cqe
argument_list|)
condition|)
name|th
operator|->
name|th_flags
operator||=
name|TH_PUSH
expr_stmt|;
if|if
condition|(
name|tcp_ack
condition|)
block|{
name|th
operator|->
name|th_flags
operator||=
name|TH_ACK
expr_stmt|;
name|th
operator|->
name|th_ack
operator|=
name|cqe
operator|->
name|lro_ack_seq_num
expr_stmt|;
name|th
operator|->
name|th_win
operator|=
name|cqe
operator|->
name|lro_tcp_win
expr_stmt|;
comment|/* 		 * FreeBSD handles only 32bit aligned timestamp right after 		 * the TCP hdr 		 * +--------+--------+--------+--------+ 		 * |   NOP  |  NOP   |  TSopt |   10   | 		 * +--------+--------+--------+--------+ 		 * |          TSval   timestamp        | 		 * +--------+--------+--------+--------+ 		 * |          TSecr   timestamp        | 		 * +--------+--------+--------+--------+ 		 */
if|if
condition|(
name|get_cqe_lro_timestamp_valid
argument_list|(
name|cqe
argument_list|)
operator|&&
operator|(
name|__predict_true
argument_list|(
operator|*
name|ts_ptr
argument_list|)
operator|==
name|ntohl
argument_list|(
name|TCPOPT_NOP
operator|<<
literal|24
operator||
name|TCPOPT_NOP
operator|<<
literal|16
operator||
name|TCPOPT_TIMESTAMP
operator|<<
literal|8
operator||
name|TCPOLEN_TIMESTAMP
argument_list|)
operator|)
condition|)
block|{
comment|/* 			 * cqe->timestamp is 64bit long. 			 * [0-31] - timestamp. 			 * [32-64] - timestamp echo replay. 			 */
name|ts_ptr
index|[
literal|1
index|]
operator|=
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|cqe
operator|->
name|timestamp
expr_stmt|;
name|ts_ptr
index|[
literal|2
index|]
operator|=
operator|*
operator|(
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|cqe
operator|->
name|timestamp
operator|+
literal|1
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ip4
condition|)
block|{
name|ip4
operator|->
name|ip_ttl
operator|=
name|cqe
operator|->
name|lro_min_ttl
expr_stmt|;
name|ip4
operator|->
name|ip_len
operator|=
name|cpu_to_be16
argument_list|(
name|tot_len
argument_list|)
expr_stmt|;
name|ip4
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip4
operator|->
name|ip_sum
operator|=
name|in_cksum
argument_list|(
name|mb
argument_list|,
name|ip4
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ip6
operator|->
name|ip6_hlim
operator|=
name|cqe
operator|->
name|lro_min_ttl
expr_stmt|;
name|ip6
operator|->
name|ip6_plen
operator|=
name|cpu_to_be16
argument_list|(
name|tot_len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: handle tcp checksum */
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|mlx5e_build_rx_mbuf
parameter_list|(
name|struct
name|mlx5_cqe64
modifier|*
name|cqe
parameter_list|,
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|u32
name|cqe_bcnt
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|rq
operator|->
name|ifp
decl_stmt|;
name|int
name|lro_num_seg
decl_stmt|;
comment|/* HW LRO session aggregated packets counter */
name|lro_num_seg
operator|=
name|be32_to_cpu
argument_list|(
name|cqe
operator|->
name|srqn
argument_list|)
operator|>>
literal|24
expr_stmt|;
if|if
condition|(
name|lro_num_seg
operator|>
literal|1
condition|)
block|{
name|mlx5e_lro_update_hdr
argument_list|(
name|mb
argument_list|,
name|cqe
argument_list|)
expr_stmt|;
name|rq
operator|->
name|stats
operator|.
name|lro_packets
operator|++
expr_stmt|;
name|rq
operator|->
name|stats
operator|.
name|lro_bytes
operator|+=
name|cqe_bcnt
expr_stmt|;
block|}
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|mb
operator|->
name|m_len
operator|=
name|cqe_bcnt
expr_stmt|;
comment|/* check if a Toeplitz hash was computed */
if|if
condition|(
name|cqe
operator|->
name|rss_hash_type
operator|!=
literal|0
condition|)
block|{
name|mb
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|be32_to_cpu
argument_list|(
name|cqe
operator|->
name|rss_hash_result
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RSS
comment|/* decode the RSS hash type */
switch|switch
condition|(
name|cqe
operator|->
name|rss_hash_type
operator|&
operator|(
name|CQE_RSS_DST_HTYPE_L4
operator||
name|CQE_RSS_DST_HTYPE_IP
operator|)
condition|)
block|{
comment|/* IPv4 */
case|case
operator|(
name|CQE_RSS_DST_HTYPE_TCP
operator||
name|CQE_RSS_DST_HTYPE_IPV4
operator|)
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|CQE_RSS_DST_HTYPE_UDP
operator||
name|CQE_RSS_DST_HTYPE_IPV4
operator|)
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_RSS_UDP_IPV4
argument_list|)
expr_stmt|;
break|break;
case|case
name|CQE_RSS_DST_HTYPE_IPV4
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_RSS_IPV4
argument_list|)
expr_stmt|;
break|break;
comment|/* IPv6 */
case|case
operator|(
name|CQE_RSS_DST_HTYPE_TCP
operator||
name|CQE_RSS_DST_HTYPE_IPV6
operator|)
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_RSS_TCP_IPV6
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|CQE_RSS_DST_HTYPE_UDP
operator||
name|CQE_RSS_DST_HTYPE_IPV6
operator|)
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_RSS_UDP_IPV6
argument_list|)
expr_stmt|;
break|break;
case|case
name|CQE_RSS_DST_HTYPE_IPV6
case|:
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_RSS_IPV6
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Other */
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_OPAQUE_HASH
argument_list|)
expr_stmt|;
break|break;
block|}
else|#
directive|else
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_OPAQUE_HASH
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|mb
operator|->
name|m_pkthdr
operator|.
name|flowid
operator|=
name|rq
operator|->
name|ix
expr_stmt|;
name|M_HASHTYPE_SET
argument_list|(
name|mb
argument_list|,
name|M_HASHTYPE_OPAQUE
argument_list|)
expr_stmt|;
block|}
name|mb
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
if|if
condition|(
name|likely
argument_list|(
name|ifp
operator|->
name|if_capenable
operator|&
operator|(
name|IFCAP_RXCSUM
operator||
name|IFCAP_RXCSUM_IPV6
operator|)
argument_list|)
operator|&&
operator|(
operator|(
name|cqe
operator|->
name|hds_ip_ext
operator|&
operator|(
name|CQE_L2_OK
operator||
name|CQE_L3_OK
operator||
name|CQE_L4_OK
operator|)
operator|)
operator|==
operator|(
name|CQE_L2_OK
operator||
name|CQE_L3_OK
operator||
name|CQE_L4_OK
operator|)
operator|)
condition|)
block|{
name|mb
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
operator||
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
expr_stmt|;
name|mb
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
name|htons
argument_list|(
literal|0xffff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rq
operator|->
name|stats
operator|.
name|csum_none
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|cqe_has_vlan
argument_list|(
name|cqe
argument_list|)
condition|)
block|{
name|mb
operator|->
name|m_pkthdr
operator|.
name|ether_vtag
operator|=
name|be16_to_cpu
argument_list|(
name|cqe
operator|->
name|vlan_info
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_flags
operator||=
name|M_VLANTAG
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|mlx5e_read_cqe_slot
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|,
name|u32
name|cc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|memcpy
argument_list|(
name|data
argument_list|,
name|mlx5_cqwq_get_wqe
argument_list|(
operator|&
name|cq
operator|->
name|wq
argument_list|,
operator|(
name|cc
operator|&
name|cq
operator|->
name|wq
operator|.
name|sz_m1
operator|)
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_cqe64
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|mlx5e_write_cqe_slot
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|,
name|u32
name|cc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|memcpy
argument_list|(
name|mlx5_cqwq_get_wqe
argument_list|(
operator|&
name|cq
operator|->
name|wq
argument_list|,
name|cc
operator|&
name|cq
operator|->
name|wq
operator|.
name|sz_m1
argument_list|)
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_cqe64
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|mlx5e_decompress_cqe
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|,
name|struct
name|mlx5_cqe64
modifier|*
name|title
parameter_list|,
name|struct
name|mlx5_mini_cqe8
modifier|*
name|mini
parameter_list|,
name|u16
name|wqe_counter
parameter_list|,
name|int
name|i
parameter_list|)
block|{
comment|/* 	 * NOTE: The fields which are not set here are copied from the 	 * initial and common title. See memcpy() in 	 * mlx5e_write_cqe_slot(). 	 */
name|title
operator|->
name|byte_cnt
operator|=
name|mini
operator|->
name|byte_cnt
expr_stmt|;
name|title
operator|->
name|wqe_counter
operator|=
name|cpu_to_be16
argument_list|(
operator|(
name|wqe_counter
operator|+
name|i
operator|)
operator|&
name|cq
operator|->
name|wq
operator|.
name|sz_m1
argument_list|)
expr_stmt|;
name|title
operator|->
name|check_sum
operator|=
name|mini
operator|->
name|checksum
expr_stmt|;
name|title
operator|->
name|op_own
operator|=
operator|(
name|title
operator|->
name|op_own
operator|&
literal|0xf0
operator|)
operator||
operator|(
operator|(
operator|(
name|cq
operator|->
name|wq
operator|.
name|cc
operator|+
name|i
operator|)
operator|>>
name|cq
operator|->
name|wq
operator|.
name|log_sz
operator|)
operator|&
literal|1
operator|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|MLX5E_MINI_ARRAY_SZ
value|8
end_define

begin_comment
comment|/* Make sure structs are not packet differently */
end_comment

begin_expr_stmt
name|CTASSERT
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_cqe64
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_mini_cqe8
argument_list|)
operator|*
name|MLX5E_MINI_ARRAY_SZ
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|mlx5e_decompress_cqes
parameter_list|(
name|struct
name|mlx5e_cq
modifier|*
name|cq
parameter_list|)
block|{
name|struct
name|mlx5_mini_cqe8
name|mini_array
index|[
name|MLX5E_MINI_ARRAY_SZ
index|]
decl_stmt|;
name|struct
name|mlx5_cqe64
name|title
decl_stmt|;
name|u32
name|cqe_count
decl_stmt|;
name|u32
name|i
init|=
literal|0
decl_stmt|;
name|u16
name|title_wqe_counter
decl_stmt|;
name|mlx5e_read_cqe_slot
argument_list|(
name|cq
argument_list|,
name|cq
operator|->
name|wq
operator|.
name|cc
argument_list|,
operator|&
name|title
argument_list|)
expr_stmt|;
name|title_wqe_counter
operator|=
name|be16_to_cpu
argument_list|(
name|title
operator|.
name|wqe_counter
argument_list|)
expr_stmt|;
name|cqe_count
operator|=
name|be32_to_cpu
argument_list|(
name|title
operator|.
name|byte_cnt
argument_list|)
expr_stmt|;
comment|/* Make sure we won't overflow */
name|KASSERT
argument_list|(
name|cqe_count
operator|<=
name|cq
operator|->
name|wq
operator|.
name|sz_m1
argument_list|,
operator|(
literal|"%s: cqe_count %u> cq->wq.sz_m1 %u"
operator|,
name|__func__
operator|,
name|cqe_count
operator|,
name|cq
operator|->
name|wq
operator|.
name|sz_m1
operator|)
argument_list|)
expr_stmt|;
name|mlx5e_read_cqe_slot
argument_list|(
name|cq
argument_list|,
name|cq
operator|->
name|wq
operator|.
name|cc
operator|+
literal|1
argument_list|,
name|mini_array
argument_list|)
expr_stmt|;
while|while
condition|(
name|true
condition|)
block|{
name|mlx5e_decompress_cqe
argument_list|(
name|cq
argument_list|,
operator|&
name|title
argument_list|,
operator|&
name|mini_array
index|[
name|i
operator|%
name|MLX5E_MINI_ARRAY_SZ
index|]
argument_list|,
name|title_wqe_counter
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|mlx5e_write_cqe_slot
argument_list|(
name|cq
argument_list|,
name|cq
operator|->
name|wq
operator|.
name|cc
operator|+
name|i
argument_list|,
operator|&
name|title
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|cqe_count
condition|)
break|break;
if|if
condition|(
name|i
operator|%
name|MLX5E_MINI_ARRAY_SZ
operator|==
literal|0
condition|)
name|mlx5e_read_cqe_slot
argument_list|(
name|cq
argument_list|,
name|cq
operator|->
name|wq
operator|.
name|cc
operator|+
name|i
argument_list|,
name|mini_array
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5e_poll_rx_cq
parameter_list|(
name|struct
name|mlx5e_rq
modifier|*
name|rq
parameter_list|,
name|int
name|budget
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|budget
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mlx5e_rx_wqe
modifier|*
name|wqe
decl_stmt|;
name|struct
name|mlx5_cqe64
modifier|*
name|cqe
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|__be16
name|wqe_counter_be
decl_stmt|;
name|u16
name|wqe_counter
decl_stmt|;
name|u32
name|byte_cnt
decl_stmt|;
name|cqe
operator|=
name|mlx5e_get_cqe
argument_list|(
operator|&
name|rq
operator|->
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cqe
condition|)
break|break;
if|if
condition|(
name|mlx5_get_cqe_format
argument_list|(
name|cqe
argument_list|)
operator|==
name|MLX5_COMPRESSED
condition|)
name|mlx5e_decompress_cqes
argument_list|(
operator|&
name|rq
operator|->
name|cq
argument_list|)
expr_stmt|;
name|mlx5_cqwq_pop
argument_list|(
operator|&
name|rq
operator|->
name|cq
operator|.
name|wq
argument_list|)
expr_stmt|;
name|wqe_counter_be
operator|=
name|cqe
operator|->
name|wqe_counter
expr_stmt|;
name|wqe_counter
operator|=
name|be16_to_cpu
argument_list|(
name|wqe_counter_be
argument_list|)
expr_stmt|;
name|wqe
operator|=
name|mlx5_wq_ll_get_wqe
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|,
name|wqe_counter
argument_list|)
expr_stmt|;
name|byte_cnt
operator|=
name|be32_to_cpu
argument_list|(
name|cqe
operator|->
name|byte_cnt
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|wqe_counter
index|]
operator|.
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|(
name|cqe
operator|->
name|op_own
operator|>>
literal|4
operator|)
operator|!=
name|MLX5_CQE_RESP_SEND
argument_list|)
condition|)
block|{
name|rq
operator|->
name|stats
operator|.
name|wqe_err
operator|++
expr_stmt|;
goto|goto
name|wq_ll_pop
goto|;
block|}
if|if
condition|(
operator|(
name|MHLEN
operator|-
name|MLX5E_NET_IP_ALIGN
operator|)
operator|>=
name|byte_cnt
operator|&&
operator|(
name|mb
operator|=
name|m_gethdr
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
comment|/* get IP header aligned */
name|mb
operator|->
name|m_data
operator|+=
name|MLX5E_NET_IP_ALIGN
expr_stmt|;
name|bcopy
argument_list|(
name|rq
operator|->
name|mbuf
index|[
name|wqe_counter
index|]
operator|.
name|data
argument_list|,
name|mtod
argument_list|(
name|mb
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|byte_cnt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mb
operator|=
name|rq
operator|->
name|mbuf
index|[
name|wqe_counter
index|]
operator|.
name|mbuf
expr_stmt|;
name|rq
operator|->
name|mbuf
index|[
name|wqe_counter
index|]
operator|.
name|mbuf
operator|=
name|NULL
expr_stmt|;
comment|/* safety clear */
name|bus_dmamap_unload
argument_list|(
name|rq
operator|->
name|dma_tag
argument_list|,
name|rq
operator|->
name|mbuf
index|[
name|wqe_counter
index|]
operator|.
name|dma_map
argument_list|)
expr_stmt|;
block|}
name|mlx5e_build_rx_mbuf
argument_list|(
name|cqe
argument_list|,
name|rq
argument_list|,
name|mb
argument_list|,
name|byte_cnt
argument_list|)
expr_stmt|;
name|rq
operator|->
name|stats
operator|.
name|packets
operator|++
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|HAVE_TCP_LRO_RX
argument_list|)
name|tcp_lro_queue_mbuf
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|,
name|mb
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|==
literal|0
operator|||
operator|(
name|rq
operator|->
name|ifp
operator|->
name|if_capenable
operator|&
name|IFCAP_LRO
operator|)
operator|==
literal|0
operator|||
name|rq
operator|->
name|lro
operator|.
name|lro_cnt
operator|==
literal|0
operator|||
name|tcp_lro_rx
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|,
name|mb
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|rq
operator|->
name|ifp
operator|->
name|if_input
argument_list|(
name|rq
operator|->
name|ifp
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|wq_ll_pop
label|:
name|mlx5_wq_ll_pop
argument_list|(
operator|&
name|rq
operator|->
name|wq
argument_list|,
name|wqe_counter_be
argument_list|,
operator|&
name|wqe
operator|->
name|next
operator|.
name|next_wqe_index
argument_list|)
expr_stmt|;
block|}
name|mlx5_cqwq_update_db_record
argument_list|(
operator|&
name|rq
operator|->
name|cq
operator|.
name|wq
argument_list|)
expr_stmt|;
comment|/* ensure cq space is freed before enabling more cqes */
name|wmb
argument_list|()
expr_stmt|;
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mlx5e_rx_cq_comp
parameter_list|(
name|struct
name|mlx5_core_cq
modifier|*
name|mcq
parameter_list|)
block|{
name|struct
name|mlx5e_rq
modifier|*
name|rq
init|=
name|container_of
argument_list|(
name|mcq
argument_list|,
expr|struct
name|mlx5e_rq
argument_list|,
name|cq
operator|.
name|mcq
argument_list|)
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_PER_CQ_EVENT_PACKET
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|m_getjcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|,
name|rq
operator|->
name|wqe_sz
argument_list|)
decl_stmt|;
if|if
condition|(
name|mb
operator|!=
name|NULL
condition|)
block|{
comment|/* this code is used for debugging purpose only */
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|mb
operator|->
name|m_len
operator|=
literal|15
expr_stmt|;
name|memset
argument_list|(
name|mb
operator|->
name|m_data
argument_list|,
literal|255
argument_list|,
literal|14
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_data
index|[
literal|14
index|]
operator|=
name|rq
operator|->
name|ix
expr_stmt|;
name|mb
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|rq
operator|->
name|ifp
expr_stmt|;
name|rq
operator|->
name|ifp
operator|->
name|if_input
argument_list|(
name|rq
operator|->
name|ifp
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|mtx_lock
argument_list|(
operator|&
name|rq
operator|->
name|mtx
argument_list|)
expr_stmt|;
comment|/* 	 * Polling the entire CQ without posting new WQEs results in 	 * lack of receive WQEs during heavy traffic scenarios. 	 */
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|mlx5e_poll_rx_cq
argument_list|(
name|rq
argument_list|,
name|MLX5E_RX_BUDGET_MAX
argument_list|)
operator|!=
name|MLX5E_RX_BUDGET_MAX
condition|)
break|break;
name|i
operator|+=
name|MLX5E_RX_BUDGET_MAX
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|MLX5E_BUDGET_MAX
condition|)
break|break;
name|mlx5e_post_rx_wqes
argument_list|(
name|rq
argument_list|)
expr_stmt|;
block|}
name|mlx5e_post_rx_wqes
argument_list|(
name|rq
argument_list|)
expr_stmt|;
name|mlx5e_cq_arm
argument_list|(
operator|&
name|rq
operator|->
name|cq
argument_list|)
expr_stmt|;
name|tcp_lro_flush_all
argument_list|(
operator|&
name|rq
operator|->
name|lro
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|rq
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


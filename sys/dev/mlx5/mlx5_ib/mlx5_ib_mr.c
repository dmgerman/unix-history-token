begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013-2015, Mellanox Technologies, Ltd.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<linux/kref.h>
end_include

begin_include
include|#
directive|include
file|<linux/random.h>
end_include

begin_include
include|#
directive|include
file|<linux/fs.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|"mlx5_ib.h"
end_include

begin_expr_stmt
name|CTASSERT
argument_list|(
operator|(
name|uintptr_t
operator|)
name|PAGE_MASK
operator|>
operator|(
name|uintptr_t
operator|)
name|PAGE_SIZE
argument_list|)
expr_stmt|;
end_expr_stmt

begin_enum
enum|enum
block|{
name|MAX_PENDING_REG_MR
init|=
literal|8
block|,
name|MAX_MR_RELEASE_TIMEOUT
init|=
operator|(
literal|60
operator|*
literal|20
operator|)
comment|/* Allow release timeout up to 20 min */
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|MLX5_UMR_ALIGN
value|2048
end_define

begin_function_decl
specifier|static
name|int
name|mlx5_mr_sysfs_init
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mlx5_mr_sysfs_cleanup
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|destroy_mkey
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
parameter_list|)
block|{
name|int
name|err
init|=
name|mlx5_core_destroy_mkey
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|mr
operator|->
name|mmr
argument_list|)
decl_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|order2idx
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|order
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
if|if
condition|(
name|order
operator|<
name|cache
operator|->
name|ent
index|[
literal|0
index|]
operator|.
name|order
condition|)
return|return
literal|0
return|;
else|else
return|return
name|order
operator|-
name|cache
operator|->
name|ent
index|[
literal|0
index|]
operator|.
name|order
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|reg_mr_callback
parameter_list|(
name|int
name|status
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
init|=
name|context
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|mr
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|int
name|c
init|=
name|order2idx
argument_list|(
name|dev
argument_list|,
name|mr
operator|->
name|order
argument_list|)
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|c
index|]
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx5_core_mr
modifier|*
name|mmr
init|=
operator|&
name|mr
operator|->
name|mmr
decl_stmt|;
name|struct
name|mlx5_mr_table
modifier|*
name|table
init|=
operator|&
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|mr_table
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|err
decl_stmt|;
name|u8
name|key
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ent
operator|->
name|pending
operator|--
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"async reg mr failed. status %d, order %d\n"
argument_list|,
name|status
argument_list|,
name|ent
operator|->
name|order
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
name|dev
operator|->
name|fill_delay
operator|=
literal|1
expr_stmt|;
name|mod_timer
argument_list|(
operator|&
name|dev
operator|->
name|delay_timer
argument_list|,
name|jiffies
operator|+
name|HZ
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mr
operator|->
name|out
operator|.
name|hdr
operator|.
name|status
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed - status %d, syndorme 0x%x\n"
argument_list|,
name|mr
operator|->
name|out
operator|.
name|hdr
operator|.
name|status
argument_list|,
name|be32_to_cpu
argument_list|(
name|mr
operator|->
name|out
operator|.
name|hdr
operator|.
name|syndrome
argument_list|)
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
name|dev
operator|->
name|fill_delay
operator|=
literal|1
expr_stmt|;
name|mod_timer
argument_list|(
operator|&
name|dev
operator|->
name|delay_timer
argument_list|,
name|jiffies
operator|+
name|HZ
argument_list|)
expr_stmt|;
return|return;
block|}
name|spin_lock_irqsave
argument_list|(
operator|&
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|mkey_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|key
operator|=
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|mkey_key
operator|++
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|mkey_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|mmr
operator|->
name|key
operator|=
name|mlx5_idx_to_mkey
argument_list|(
name|be32_to_cpu
argument_list|(
name|mr
operator|->
name|out
operator|.
name|mkey
argument_list|)
operator|&
literal|0xffffff
argument_list|)
operator||
name|key
expr_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"callbacked mkey 0x%x created\n"
argument_list|,
name|be32_to_cpu
argument_list|(
name|mr
operator|->
name|out
operator|.
name|mkey
argument_list|)
argument_list|)
expr_stmt|;
name|cache
operator|->
name|last_add
operator|=
name|jiffies
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|mr
operator|->
name|list
argument_list|,
operator|&
name|ent
operator|->
name|head
argument_list|)
expr_stmt|;
name|ent
operator|->
name|cur
operator|++
expr_stmt|;
name|ent
operator|->
name|size
operator|++
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|err
operator|=
name|radix_tree_insert
argument_list|(
operator|&
name|table
operator|->
name|tree
argument_list|,
name|mlx5_mkey_to_idx
argument_list|(
name|mmr
operator|->
name|key
argument_list|)
argument_list|,
name|mmr
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|table
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed radix tree insert of mkey 0x%x, %d\n"
argument_list|,
name|mmr
operator|->
name|key
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|mlx5_core_destroy_mkey
argument_list|(
name|mdev
argument_list|,
name|mmr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|add_keys
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|c
index|]
decl_stmt|;
name|struct
name|mlx5_create_mkey_mbox_in
modifier|*
name|in
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|npages
init|=
literal|1
operator|<<
name|ent
operator|->
name|order
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|in
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
return|return
operator|-
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ent
operator|->
name|pending
operator|>=
name|MAX_PENDING_REG_MR
condition|)
block|{
name|err
operator|=
operator|-
name|EAGAIN
expr_stmt|;
break|break;
block|}
name|mr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mr
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|mr
operator|->
name|order
operator|=
name|ent
operator|->
name|order
expr_stmt|;
name|mr
operator|->
name|umred
operator|=
literal|1
expr_stmt|;
name|mr
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|status
operator|=
name|MLX5_MKEY_STATUS_FREE
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|xlt_oct_size
operator|=
name|cpu_to_be32
argument_list|(
operator|(
name|npages
operator|+
literal|1
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|qpn_mkey7_0
operator|=
name|cpu_to_be32
argument_list|(
literal|0xffffff
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags
operator|=
name|MLX5_ACCESS_MODE_MTT
operator||
name|MLX5_PERM_UMR_EN
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|log2_page_size
operator|=
literal|12
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ent
operator|->
name|pending
operator|++
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_mkey
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|mr
operator|->
name|mmr
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|reg_mr_callback
argument_list|,
name|mr
argument_list|,
operator|&
name|mr
operator|->
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ent
operator|->
name|pending
operator|--
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"create mkey failed %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|kfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|remove_keys
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|c
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|c
index|]
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|list_empty
argument_list|(
operator|&
name|ent
operator|->
name|head
argument_list|)
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
name|mr
operator|=
name|list_first_entry
argument_list|(
operator|&
name|ent
operator|->
name|head
argument_list|,
expr|struct
name|mlx5_ib_mr
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|mr
operator|->
name|list
argument_list|)
expr_stmt|;
name|ent
operator|->
name|cur
operator|--
expr_stmt|;
name|ent
operator|->
name|size
operator|--
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err
operator|=
name|destroy_mkey
argument_list|(
name|dev
argument_list|,
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed destroy mkey\n"
argument_list|)
expr_stmt|;
else|else
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|someone_adding
parameter_list|(
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|cur
operator|<
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|limit
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|someone_releasing
parameter_list|(
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|cur
operator|>
literal|2
operator|*
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|limit
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__cache_work_func
parameter_list|(
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|ent
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|int
name|i
init|=
name|order2idx
argument_list|(
name|dev
argument_list|,
name|ent
operator|->
name|order
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
name|s64
name|dtime
decl_stmt|;
if|if
condition|(
name|cache
operator|->
name|stopped
condition|)
return|return;
name|ent
operator|=
operator|&
name|dev
operator|->
name|cache
operator|.
name|ent
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|cur
operator|<
literal|2
operator|*
name|ent
operator|->
name|limit
operator|&&
operator|!
name|dev
operator|->
name|fill_delay
condition|)
block|{
name|err
operator|=
name|add_keys
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|cur
operator|<
literal|2
operator|*
name|ent
operator|->
name|limit
condition|)
block|{
if|if
condition|(
name|err
operator|==
operator|-
name|EAGAIN
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"returned eagain, order %d\n"
argument_list|,
name|i
operator|+
literal|2
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|ent
operator|->
name|dwork
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|queue_delayed_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|dwork
argument_list|,
name|msecs_to_jiffies
argument_list|(
literal|3
argument_list|)
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed queueing delayed work\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"command failed order %d, err %d\n"
argument_list|,
name|i
operator|+
literal|2
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|ent
operator|->
name|dwork
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|queue_delayed_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|dwork
argument_list|,
name|msecs_to_jiffies
argument_list|(
literal|1000
argument_list|)
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed queueing delayed work\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|queue_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|work
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed queueing work\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|ent
operator|->
name|cur
operator|>
literal|2
operator|*
name|ent
operator|->
name|limit
condition|)
block|{
name|dtime
operator|=
operator|(
name|cache
operator|->
name|last_add
operator|+
operator|(
name|s64
operator|)
name|cache
operator|->
name|rel_timeout
operator|*
name|HZ
operator|)
operator|-
name|jiffies
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|rel_imm
operator|||
operator|(
name|cache
operator|->
name|rel_timeout
operator|>=
literal|0
operator|&&
operator|!
name|someone_adding
argument_list|(
name|cache
argument_list|)
operator|&&
name|dtime
operator|<=
literal|0
operator|)
condition|)
block|{
name|remove_keys
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|cur
operator|>
name|ent
operator|->
name|limit
condition|)
if|if
condition|(
operator|!
name|queue_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|work
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed queueing work\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cache
operator|->
name|rel_timeout
operator|>=
literal|0
condition|)
block|{
name|dtime
operator|=
name|max_t
argument_list|(
name|s64
argument_list|,
name|dtime
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dtime
operator|=
name|min_t
argument_list|(
name|s64
argument_list|,
name|dtime
argument_list|,
operator|(
name|MAX_MR_RELEASE_TIMEOUT
operator|*
name|HZ
operator|)
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|ent
operator|->
name|dwork
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|queue_delayed_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|dwork
argument_list|,
name|dtime
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed queueing delayed work\n"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|cache
operator|->
name|rel_imm
operator|&&
operator|!
name|someone_releasing
argument_list|(
name|cache
argument_list|)
condition|)
block|{
name|cache
operator|->
name|rel_imm
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|delayed_cache_work_func
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
decl_stmt|;
name|ent
operator|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx5_cache_ent
argument_list|,
name|dwork
operator|.
name|work
argument_list|)
expr_stmt|;
name|__cache_work_func
argument_list|(
name|ent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cache_work_func
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
decl_stmt|;
name|ent
operator|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx5_cache_ent
argument_list|,
name|work
argument_list|)
expr_stmt|;
name|__cache_work_func
argument_list|(
name|ent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_cached_mr
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
decl_stmt|;
name|int
name|shrink
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
name|c
operator|=
name|order2idx
argument_list|(
name|dev
argument_list|,
name|mr
operator|->
name|order
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
operator|||
name|c
operator|>=
name|MAX_MR_CACHE_ENTRIES
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"order %d, cache index %d\n"
argument_list|,
name|mr
operator|->
name|order
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|ent
operator|=
operator|&
name|cache
operator|->
name|ent
index|[
name|c
index|]
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|mr
operator|->
name|list
argument_list|,
operator|&
name|ent
operator|->
name|head
argument_list|)
expr_stmt|;
name|ent
operator|->
name|cur
operator|++
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|cur
operator|>
literal|2
operator|*
name|ent
operator|->
name|limit
condition|)
name|shrink
operator|=
literal|1
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|shrink
condition|)
if|if
condition|(
operator|!
name|queue_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|work
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed queueing work\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|clean_keys
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|c
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|c
index|]
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|ent
operator|->
name|dwork
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|spin_lock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|list_empty
argument_list|(
operator|&
name|ent
operator|->
name|head
argument_list|)
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
name|mr
operator|=
name|list_first_entry
argument_list|(
operator|&
name|ent
operator|->
name|head
argument_list|,
expr|struct
name|mlx5_ib_mr
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|mr
operator|->
name|list
argument_list|)
expr_stmt|;
name|ent
operator|->
name|cur
operator|--
expr_stmt|;
name|ent
operator|->
name|size
operator|--
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err
operator|=
name|destroy_mkey
argument_list|(
name|dev
argument_list|,
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed destroy mkey 0x%x from order %d\n"
argument_list|,
name|mr
operator|->
name|mmr
operator|.
name|key
argument_list|,
name|ent
operator|->
name|order
argument_list|)
expr_stmt|;
else|else
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|delay_time_func
parameter_list|(
name|unsigned
name|long
name|ctx
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
operator|(
expr|struct
name|mlx5_ib_dev
operator|*
operator|)
name|ctx
decl_stmt|;
name|dev
operator|->
name|fill_delay
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MLX5_VF_MR_LIMIT
init|=
literal|2
block|, }
enum|;
end_enum

begin_function
name|int
name|mlx5_mr_cache_init
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
decl_stmt|;
name|int
name|limit
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mutex_init
argument_list|(
operator|&
name|dev
operator|->
name|slow_path_mutex
argument_list|)
expr_stmt|;
name|cache
operator|->
name|rel_timeout
operator|=
literal|300
expr_stmt|;
name|cache
operator|->
name|wq
operator|=
name|create_singlethread_workqueue
argument_list|(
literal|"mkey_cache"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cache
operator|->
name|wq
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to create work queue\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|setup_timer
argument_list|(
operator|&
name|dev
operator|->
name|delay_timer
argument_list|,
name|delay_time_func
argument_list|,
operator|(
name|uintptr_t
operator|)
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|head
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
name|ent
operator|=
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|ent
operator|->
name|head
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|ent
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ent
operator|->
name|order
operator|=
name|i
operator|+
literal|2
expr_stmt|;
name|ent
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|mdev
operator|->
name|profile
operator|->
name|mask
operator|&
name|MLX5_PROF_MASK_MR_CACHE
condition|)
block|{
if|if
condition|(
name|mlx5_core_is_pf
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
condition|)
name|limit
operator|=
name|dev
operator|->
name|mdev
operator|->
name|profile
operator|->
name|mr_cache
index|[
name|i
index|]
operator|.
name|limit
expr_stmt|;
else|else
name|limit
operator|=
name|MLX5_VF_MR_LIMIT
expr_stmt|;
block|}
else|else
block|{
name|limit
operator|=
literal|0
expr_stmt|;
block|}
name|INIT_WORK
argument_list|(
operator|&
name|ent
operator|->
name|work
argument_list|,
name|cache_work_func
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|ent
operator|->
name|dwork
argument_list|,
name|delayed_cache_work_func
argument_list|)
expr_stmt|;
name|ent
operator|->
name|limit
operator|=
name|limit
expr_stmt|;
if|if
condition|(
operator|!
name|queue_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|ent
operator|->
name|work
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed queueing work\n"
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|mlx5_mr_sysfs_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to init mr cache sysfs\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wait_for_async_commands
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
decl_stmt|;
name|int
name|total
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|ent
operator|=
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|1000
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ent
operator|->
name|pending
condition|)
break|break;
name|msleep
argument_list|(
literal|50
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
name|ent
operator|=
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
expr_stmt|;
name|total
operator|+=
name|ent
operator|->
name|pending
expr_stmt|;
block|}
if|if
condition|(
name|total
condition|)
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"aborted, %d pending requests\n"
argument_list|,
name|total
argument_list|)
expr_stmt|;
else|else
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"done with all pending requests\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mlx5_mr_cache_cleanup
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|dev
operator|->
name|cache
operator|.
name|stopped
operator|=
literal|1
expr_stmt|;
name|flush_workqueue
argument_list|(
name|dev
operator|->
name|cache
operator|.
name|wq
argument_list|)
expr_stmt|;
name|mlx5_mr_sysfs_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
name|clean_keys
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|dev
operator|->
name|cache
operator|.
name|wq
argument_list|)
expr_stmt|;
name|wait_for_async_commands
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|del_timer_sync
argument_list|(
operator|&
name|dev
operator|->
name|delay_timer
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ib_mr
modifier|*
name|mlx5_ib_get_dma_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|int
name|acc
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|struct
name|mlx5_create_mkey_mbox_in
modifier|*
name|in
decl_stmt|;
name|struct
name|mlx5_mkey_seg
modifier|*
name|seg
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mr
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|in
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free
goto|;
block|}
name|seg
operator|=
operator|&
name|in
operator|->
name|seg
expr_stmt|;
name|seg
operator|->
name|flags
operator|=
name|convert_access
argument_list|(
name|acc
argument_list|)
operator||
name|MLX5_ACCESS_MODE_PA
expr_stmt|;
name|seg
operator|->
name|flags_pd
operator|=
name|cpu_to_be32
argument_list|(
name|to_mpd
argument_list|(
name|pd
argument_list|)
operator|->
name|pdn
operator||
name|MLX5_MKEY_LEN64
argument_list|)
expr_stmt|;
name|seg
operator|->
name|qpn_mkey7_0
operator|=
name|cpu_to_be32
argument_list|(
literal|0xffffff
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|seg
operator|->
name|start_addr
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_mkey
argument_list|(
name|mdev
argument_list|,
operator|&
name|mr
operator|->
name|mmr
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_in
goto|;
name|kfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|mr
operator|->
name|ibmr
operator|.
name|lkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
name|mr
operator|->
name|ibmr
operator|.
name|rkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
name|mr
operator|->
name|umem
operator|=
name|NULL
expr_stmt|;
return|return
operator|&
name|mr
operator|->
name|ibmr
return|;
name|err_in
label|:
name|kfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|err_free
label|:
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_octo_len
parameter_list|(
name|u64
name|addr
parameter_list|,
name|u64
name|len
parameter_list|,
name|u64
name|page_size
parameter_list|)
block|{
name|u64
name|offset
decl_stmt|;
name|int
name|npages
decl_stmt|;
name|offset
operator|=
name|addr
operator|&
operator|(
name|page_size
operator|-
literal|1ULL
operator|)
expr_stmt|;
name|npages
operator|=
name|ALIGN
argument_list|(
name|len
operator|+
name|offset
argument_list|,
name|page_size
argument_list|)
operator|>>
name|ilog2
argument_list|(
name|page_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|npages
operator|+
literal|1
operator|)
operator|/
literal|2
return|;
block|}
end_function

begin_function
name|void
name|mlx5_umr_cq_handler
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|void
modifier|*
name|cq_context
parameter_list|)
block|{
name|struct
name|mlx5_ib_umr_context
modifier|*
name|context
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|err
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|err
operator|=
name|ib_poll_cq
argument_list|(
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"mlx5_ib: WARN: "
literal|"poll cq error %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|err
operator|==
literal|0
condition|)
break|break;
name|context
operator|=
operator|(
expr|struct
name|mlx5_ib_umr_context
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|wc
operator|.
name|wr_id
expr_stmt|;
name|context
operator|->
name|status
operator|=
name|wc
operator|.
name|status
expr_stmt|;
name|complete
argument_list|(
operator|&
name|context
operator|->
name|done
argument_list|)
expr_stmt|;
block|}
name|ib_req_notify_cq
argument_list|(
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_ib_mr
modifier|*
name|reg_create
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|u64
name|virt_addr
parameter_list|,
name|u64
name|length
parameter_list|,
name|struct
name|ib_umem
modifier|*
name|umem
parameter_list|,
name|int
name|npages
parameter_list|,
name|int
name|page_shift
parameter_list|,
name|int
name|access_flags
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_create_mkey_mbox_in
modifier|*
name|in
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|bool
name|pg_cap
init|=
operator|!
operator|!
operator|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|pg
argument_list|)
operator|)
decl_stmt|;
name|mr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mr
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|inlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|in
operator|->
name|pas
argument_list|)
operator|*
operator|(
operator|(
name|npages
operator|+
literal|1
operator|)
operator|/
literal|2
operator|)
operator|*
literal|2
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_1
goto|;
block|}
name|mlx5_ib_populate_pas
argument_list|(
name|dev
argument_list|,
name|umem
argument_list|,
name|page_shift
argument_list|,
name|in
operator|->
name|pas
argument_list|,
name|pg_cap
condition|?
name|MLX5_IB_MTT_PRESENT
else|:
literal|0
argument_list|)
expr_stmt|;
comment|/* The MLX5_MKEY_INBOX_PG_ACCESS bit allows setting the access flags 	 * in the page list submitted with the command. */
name|in
operator|->
name|flags
operator|=
name|pg_cap
condition|?
name|cpu_to_be32
argument_list|(
name|MLX5_MKEY_INBOX_PG_ACCESS
argument_list|)
else|:
literal|0
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags
operator|=
name|convert_access
argument_list|(
name|access_flags
argument_list|)
operator||
name|MLX5_ACCESS_MODE_MTT
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags_pd
operator|=
name|cpu_to_be32
argument_list|(
name|to_mpd
argument_list|(
name|pd
argument_list|)
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|start_addr
operator|=
name|cpu_to_be64
argument_list|(
name|virt_addr
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|len
operator|=
name|cpu_to_be64
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|bsfs_octo_size
operator|=
literal|0
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|xlt_oct_size
operator|=
name|cpu_to_be32
argument_list|(
name|get_octo_len
argument_list|(
name|virt_addr
argument_list|,
name|length
argument_list|,
literal|1
operator|<<
name|page_shift
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|log2_page_size
operator|=
name|page_shift
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|qpn_mkey7_0
operator|=
name|cpu_to_be32
argument_list|(
literal|0xffffff
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|in
operator|->
name|xlat_oct_act_size
operator|=
name|cpu_to_be32
argument_list|(
name|get_octo_len
argument_list|(
name|virt_addr
argument_list|,
name|length
argument_list|,
literal|1
operator|<<
name|page_shift
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_mkey
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|mr
operator|->
name|mmr
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"create mkey failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_2
goto|;
block|}
name|mr
operator|->
name|umem
operator|=
name|umem
expr_stmt|;
name|mr
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"mkey = 0x%x\n"
argument_list|,
name|mr
operator|->
name|mmr
operator|.
name|key
argument_list|)
expr_stmt|;
return|return
name|mr
return|;
name|err_2
label|:
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|err_1
label|:
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MLX5_MAX_REG_ORDER
init|=
name|MAX_MR_CACHE_ENTRIES
operator|+
literal|1
block|,
name|MLX5_MAX_REG_SIZE
init|=
literal|2ul
operator|*
literal|1024
operator|*
literal|1024
operator|*
literal|1024
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|clean_mr
parameter_list|(
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|mr
operator|->
name|ibmr
operator|.
name|device
argument_list|)
decl_stmt|;
name|int
name|umred
init|=
name|mr
operator|->
name|umred
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|umred
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mr
operator|->
name|nchild
condition|;
operator|++
name|i
control|)
block|{
name|free_cached_mr
argument_list|(
name|dev
argument_list|,
name|mr
operator|->
name|children
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|mr
operator|->
name|children
argument_list|)
expr_stmt|;
name|err
operator|=
name|destroy_mkey
argument_list|(
name|dev
argument_list|,
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to destroy mkey 0x%x (%d)\n"
argument_list|,
name|mr
operator|->
name|mmr
operator|.
name|key
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ib_mr
modifier|*
name|mlx5_ib_reg_user_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|u64
name|start
parameter_list|,
name|u64
name|length
parameter_list|,
name|u64
name|virt_addr
parameter_list|,
name|int
name|access_flags
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|,
name|int
name|mr_id
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
init|=
name|NULL
decl_stmt|;
name|struct
name|ib_umem
modifier|*
name|umem
decl_stmt|;
name|int
name|page_shift
decl_stmt|;
name|int
name|npages
decl_stmt|;
name|int
name|ncont
decl_stmt|;
name|int
name|order
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"start 0x%llx, virt_addr 0x%llx, length 0x%llx, access_flags 0x%x\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|start
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|virt_addr
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|length
argument_list|,
name|access_flags
argument_list|)
expr_stmt|;
name|umem
operator|=
name|ib_umem_get
argument_list|(
name|pd
operator|->
name|uobject
operator|->
name|context
argument_list|,
name|start
argument_list|,
name|length
argument_list|,
name|access_flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|umem
argument_list|)
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"umem get failed (%ld)\n"
argument_list|,
name|PTR_ERR
argument_list|(
name|umem
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
name|umem
return|;
block|}
name|mlx5_ib_cont_pages
argument_list|(
name|umem
argument_list|,
name|start
argument_list|,
operator|&
name|npages
argument_list|,
operator|&
name|page_shift
argument_list|,
operator|&
name|ncont
argument_list|,
operator|&
name|order
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|npages
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"avoid zero region\n"
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"npages %d, ncont %d, order %d, page_shift %d\n"
argument_list|,
name|npages
argument_list|,
name|ncont
argument_list|,
name|order
argument_list|,
name|page_shift
argument_list|)
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|dev
operator|->
name|slow_path_mutex
argument_list|)
expr_stmt|;
name|mr
operator|=
name|reg_create
argument_list|(
name|pd
argument_list|,
name|virt_addr
argument_list|,
name|length
argument_list|,
name|umem
argument_list|,
name|ncont
argument_list|,
name|page_shift
argument_list|,
name|access_flags
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|dev
operator|->
name|slow_path_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mr
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|mr
argument_list|)
expr_stmt|;
name|mr
operator|=
name|NULL
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"mkey 0x%x\n"
argument_list|,
name|mr
operator|->
name|mmr
operator|.
name|key
argument_list|)
expr_stmt|;
name|mr
operator|->
name|umem
operator|=
name|umem
expr_stmt|;
name|mr
operator|->
name|npages
operator|=
name|npages
expr_stmt|;
name|atomic_add
argument_list|(
name|npages
argument_list|,
operator|&
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|reg_pages
argument_list|)
expr_stmt|;
name|mr
operator|->
name|ibmr
operator|.
name|lkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
name|mr
operator|->
name|ibmr
operator|.
name|rkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
return|return
operator|&
name|mr
operator|->
name|ibmr
return|;
name|error
label|:
comment|/* 	 * Destroy the umem *before* destroying the MR, to ensure we 	 * will not have any in-flight notifiers when destroying the 	 * MR. 	 * 	 * As the MR is completely invalid to begin with, and this 	 * error path is only taken if we can't push the mr entry into 	 * the pagefault tree, this is safe. 	 */
name|ib_umem_release
argument_list|(
name|umem
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|CTASSERT
argument_list|(
sizeof|sizeof
argument_list|(
operator|(
operator|(
expr|struct
name|ib_phys_buf
operator|*
operator|)
literal|0
operator|)
operator|->
name|size
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|struct
name|ib_mr
modifier|*
name|mlx5_ib_reg_phys_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_phys_buf
modifier|*
name|buffer_list
parameter_list|,
name|int
name|num_phys_buf
parameter_list|,
name|int
name|access_flags
parameter_list|,
name|u64
modifier|*
name|virt_addr
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_create_mkey_mbox_in
modifier|*
name|in
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
decl_stmt|;
name|u64
name|total_size
decl_stmt|;
name|u32
name|octo_len
decl_stmt|;
name|bool
name|pg_cap
init|=
operator|!
operator|!
operator|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|pg
argument_list|)
operator|)
decl_stmt|;
name|unsigned
name|long
name|mask
decl_stmt|;
name|int
name|shift
decl_stmt|;
name|int
name|npages
decl_stmt|;
name|int
name|inlen
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|;
name|mask
operator|=
name|buffer_list
index|[
literal|0
index|]
operator|.
name|addr
operator|^
operator|*
name|virt_addr
expr_stmt|;
name|total_size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_phys_buf
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|mask
operator||=
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|num_phys_buf
operator|-
literal|1
condition|)
name|mask
operator||=
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
operator|+
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
name|total_size
operator|+=
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
operator|~
name|PAGE_MASK
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|shift
operator|=
name|__ffs
argument_list|(
name|mask
operator||
literal|1
operator|<<
literal|31
argument_list|)
expr_stmt|;
name|buffer_list
index|[
literal|0
index|]
operator|.
name|size
operator|+=
name|buffer_list
index|[
literal|0
index|]
operator|.
name|addr
operator|&
operator|(
operator|(
literal|1ULL
operator|<<
name|shift
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|buffer_list
index|[
literal|0
index|]
operator|.
name|addr
operator|&=
operator|~
literal|0ULL
operator|<<
name|shift
expr_stmt|;
name|npages
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_phys_buf
condition|;
operator|++
name|i
control|)
name|npages
operator|+=
operator|(
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
operator|+
operator|(
literal|1ULL
operator|<<
name|shift
operator|)
operator|-
literal|1
operator|)
operator|>>
name|shift
expr_stmt|;
if|if
condition|(
operator|!
name|npages
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"avoid zero region\n"
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
block|}
name|mr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|mr
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mr
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|octo_len
operator|=
name|get_octo_len
argument_list|(
operator|*
name|virt_addr
argument_list|,
name|total_size
argument_list|,
literal|1ULL
operator|<<
name|shift
argument_list|)
expr_stmt|;
name|octo_len
operator|=
name|ALIGN
argument_list|(
name|octo_len
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|inlen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
operator|+
operator|(
name|octo_len
operator|*
literal|16
operator|)
expr_stmt|;
name|in
operator|=
name|mlx5_vzalloc
argument_list|(
name|inlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
block|{
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_phys_buf
condition|;
operator|++
name|i
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
name|buffer_list
index|[
name|i
index|]
operator|.
name|size
operator|+
operator|(
literal|1ULL
operator|<<
name|shift
operator|)
operator|-
literal|1
operator|)
operator|>>
name|shift
condition|;
operator|++
name|j
control|)
block|{
name|u64
name|temp
init|=
name|buffer_list
index|[
name|i
index|]
operator|.
name|addr
operator|+
operator|(
operator|(
name|u64
operator|)
name|j
operator|<<
name|shift
operator|)
decl_stmt|;
if|if
condition|(
name|pg_cap
condition|)
name|temp
operator||=
name|MLX5_IB_MTT_PRESENT
expr_stmt|;
name|in
operator|->
name|pas
index|[
name|n
operator|++
index|]
operator|=
name|cpu_to_be64
argument_list|(
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* The MLX5_MKEY_INBOX_PG_ACCESS bit allows setting the access flags 	 * in the page list submitted with the command. */
name|in
operator|->
name|flags
operator|=
name|pg_cap
condition|?
name|cpu_to_be32
argument_list|(
name|MLX5_MKEY_INBOX_PG_ACCESS
argument_list|)
else|:
literal|0
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags
operator|=
name|convert_access
argument_list|(
name|access_flags
argument_list|)
operator||
name|MLX5_ACCESS_MODE_MTT
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags_pd
operator|=
name|cpu_to_be32
argument_list|(
name|to_mpd
argument_list|(
name|pd
argument_list|)
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|start_addr
operator|=
name|cpu_to_be64
argument_list|(
operator|*
name|virt_addr
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|len
operator|=
name|cpu_to_be64
argument_list|(
name|total_size
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|bsfs_octo_size
operator|=
literal|0
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|xlt_oct_size
operator|=
name|cpu_to_be32
argument_list|(
name|octo_len
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|log2_page_size
operator|=
name|shift
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|qpn_mkey7_0
operator|=
name|cpu_to_be32
argument_list|(
literal|0xffffff
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|in
operator|->
name|xlat_oct_act_size
operator|=
name|cpu_to_be32
argument_list|(
name|octo_len
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_mkey
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|mr
operator|->
name|mmr
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mr
operator|->
name|umem
operator|=
name|NULL
expr_stmt|;
name|mr
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|mr
operator|->
name|npages
operator|=
name|npages
expr_stmt|;
name|mr
operator|->
name|ibmr
operator|.
name|lkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
name|mr
operator|->
name|ibmr
operator|.
name|rkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
name|kvfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
return|return
operator|&
name|mr
operator|->
name|ibmr
return|;
block|}
end_function

begin_function
name|int
name|mlx5_ib_dereg_mr
parameter_list|(
name|struct
name|ib_mr
modifier|*
name|ibmr
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibmr
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
init|=
name|to_mmr
argument_list|(
name|ibmr
argument_list|)
decl_stmt|;
name|struct
name|ib_umem
modifier|*
name|umem
init|=
name|mr
operator|->
name|umem
decl_stmt|;
name|int
name|npages
init|=
name|mr
operator|->
name|npages
decl_stmt|;
name|int
name|umred
init|=
name|mr
operator|->
name|umred
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|clean_mr
argument_list|(
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
if|if
condition|(
name|umem
condition|)
block|{
name|ib_umem_release
argument_list|(
name|umem
argument_list|)
expr_stmt|;
name|atomic_sub
argument_list|(
name|npages
argument_list|,
operator|&
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|reg_pages
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|umred
condition|)
name|free_cached_mr
argument_list|(
name|dev
argument_list|,
name|mr
argument_list|)
expr_stmt|;
else|else
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|mlx5_ib_destroy_mr
parameter_list|(
name|struct
name|ib_mr
modifier|*
name|ibmr
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibmr
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
init|=
name|to_mmr
argument_list|(
name|ibmr
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|mr
operator|->
name|sig
condition|)
block|{
if|if
condition|(
name|mlx5_core_destroy_psv
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|mr
operator|->
name|sig
operator|->
name|psv_memory
operator|.
name|psv_idx
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to destroy mem psv %d\n"
argument_list|,
name|mr
operator|->
name|sig
operator|->
name|psv_memory
operator|.
name|psv_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_core_destroy_psv
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|mr
operator|->
name|sig
operator|->
name|psv_wire
operator|.
name|psv_idx
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to destroy wire psv %d\n"
argument_list|,
name|mr
operator|->
name|sig
operator|->
name|psv_wire
operator|.
name|psv_idx
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mr
operator|->
name|sig
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|destroy_mkey
argument_list|(
name|dev
argument_list|,
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to destroy mkey 0x%x (%d)\n"
argument_list|,
name|mr
operator|->
name|mmr
operator|.
name|key
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|struct
name|ib_mr
modifier|*
name|mlx5_ib_alloc_fast_reg_mr
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|int
name|max_page_list_len
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_create_mkey_mbox_in
modifier|*
name|in
decl_stmt|;
name|struct
name|mlx5_ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mr
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|in
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free
goto|;
block|}
name|in
operator|->
name|seg
operator|.
name|status
operator|=
name|MLX5_MKEY_STATUS_FREE
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|xlt_oct_size
operator|=
name|cpu_to_be32
argument_list|(
operator|(
name|max_page_list_len
operator|+
literal|1
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|qpn_mkey7_0
operator|=
name|cpu_to_be32
argument_list|(
literal|0xffffff
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags
operator|=
name|MLX5_PERM_UMR_EN
operator||
name|MLX5_ACCESS_MODE_MTT
expr_stmt|;
name|in
operator|->
name|seg
operator|.
name|flags_pd
operator|=
name|cpu_to_be32
argument_list|(
name|to_mpd
argument_list|(
name|pd
argument_list|)
operator|->
name|pdn
argument_list|)
expr_stmt|;
comment|/* 	 * TBD not needed - issue 197292 */
name|in
operator|->
name|seg
operator|.
name|log2_page_size
operator|=
name|PAGE_SHIFT
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_mkey
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|mr
operator|->
name|mmr
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed create mkey\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_free
goto|;
block|}
name|mr
operator|->
name|ibmr
operator|.
name|lkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
name|mr
operator|->
name|ibmr
operator|.
name|rkey
operator|=
name|mr
operator|->
name|mmr
operator|.
name|key
expr_stmt|;
name|mr
operator|->
name|umem
operator|=
name|NULL
expr_stmt|;
return|return
operator|&
name|mr
operator|->
name|ibmr
return|;
name|err_free
label|:
name|kfree
argument_list|(
name|mr
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|ib_fast_reg_page_list
modifier|*
name|mlx5_ib_alloc_fast_reg_page_list
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|int
name|page_list_len
parameter_list|)
block|{
name|struct
name|mlx5_ib_fast_reg_page_list
modifier|*
name|mfrpl
decl_stmt|;
name|int
name|size
init|=
name|page_list_len
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
decl_stmt|;
name|mfrpl
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mfrpl
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mfrpl
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mfrpl
operator|->
name|ibfrpl
operator|.
name|page_list
operator|=
name|kmalloc
argument_list|(
name|size
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mfrpl
operator|->
name|ibfrpl
operator|.
name|page_list
condition|)
goto|goto
name|err_free
goto|;
name|mfrpl
operator|->
name|mapped_page_list
operator|=
name|dma_alloc_coherent
argument_list|(
name|ibdev
operator|->
name|dma_device
argument_list|,
name|size
argument_list|,
operator|&
name|mfrpl
operator|->
name|map
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mfrpl
operator|->
name|mapped_page_list
condition|)
goto|goto
name|err_free
goto|;
name|WARN_ON
argument_list|(
name|mfrpl
operator|->
name|map
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
return|return
operator|&
name|mfrpl
operator|->
name|ibfrpl
return|;
name|err_free
label|:
name|kfree
argument_list|(
name|mfrpl
operator|->
name|ibfrpl
operator|.
name|page_list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mfrpl
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|mlx5_ib_free_fast_reg_page_list
parameter_list|(
name|struct
name|ib_fast_reg_page_list
modifier|*
name|page_list
parameter_list|)
block|{
name|struct
name|mlx5_ib_fast_reg_page_list
modifier|*
name|mfrpl
init|=
name|to_mfrpl
argument_list|(
name|page_list
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|page_list
operator|->
name|device
argument_list|)
decl_stmt|;
name|int
name|size
init|=
name|page_list
operator|->
name|max_page_list_len
operator|*
sizeof|sizeof
argument_list|(
name|u64
argument_list|)
decl_stmt|;
name|dma_free_coherent
argument_list|(
operator|&
name|dev
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|dev
argument_list|,
name|size
argument_list|,
name|mfrpl
operator|->
name|mapped_page_list
argument_list|,
name|mfrpl
operator|->
name|map
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mfrpl
operator|->
name|ibfrpl
operator|.
name|page_list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mfrpl
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|order_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|cache_order
modifier|*
parameter_list|,
name|struct
name|order_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|cache_order
modifier|*
parameter_list|,
name|struct
name|order_attribute
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ssize_t
name|cur_show
parameter_list|(
name|struct
name|cache_order
modifier|*
name|co
parameter_list|,
name|struct
name|order_attribute
modifier|*
name|oa
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|co
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|co
operator|->
name|index
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
literal|20
argument_list|,
literal|"%d\n"
argument_list|,
name|ent
operator|->
name|cur
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|limit_show
parameter_list|(
name|struct
name|cache_order
modifier|*
name|co
parameter_list|,
name|struct
name|order_attribute
modifier|*
name|oa
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|co
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|co
operator|->
name|index
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
literal|20
argument_list|,
literal|"%d\n"
argument_list|,
name|ent
operator|->
name|limit
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|limit_store
parameter_list|(
name|struct
name|cache_order
modifier|*
name|co
parameter_list|,
name|struct
name|order_attribute
modifier|*
name|oa
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|co
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|co
operator|->
name|index
index|]
decl_stmt|;
name|u32
name|var
decl_stmt|;
name|int
name|err
decl_stmt|;
define|#
directive|define
name|kstrtouint
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
value|({*(c) = strtol(a,0,b); 0;})
define|#
directive|define
name|kstrtoint
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
value|({*(c) = strtol(a,0,b); 0;})
if|if
condition|(
name|kstrtouint
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|&
name|var
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|>
name|ent
operator|->
name|size
condition|)
return|return
operator|-
name|EINVAL
return|;
name|ent
operator|->
name|limit
operator|=
name|var
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|cur
operator|<
name|ent
operator|->
name|limit
condition|)
block|{
name|err
operator|=
name|add_keys
argument_list|(
name|dev
argument_list|,
name|co
operator|->
name|index
argument_list|,
literal|2
operator|*
name|ent
operator|->
name|limit
operator|-
name|ent
operator|->
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|miss_show
parameter_list|(
name|struct
name|cache_order
modifier|*
name|co
parameter_list|,
name|struct
name|order_attribute
modifier|*
name|oa
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|co
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|co
operator|->
name|index
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
literal|20
argument_list|,
literal|"%d\n"
argument_list|,
name|ent
operator|->
name|miss
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|miss_store
parameter_list|(
name|struct
name|cache_order
modifier|*
name|co
parameter_list|,
name|struct
name|order_attribute
modifier|*
name|oa
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|co
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|co
operator|->
name|index
index|]
decl_stmt|;
name|u32
name|var
decl_stmt|;
if|if
condition|(
name|kstrtouint
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|&
name|var
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|!=
literal|0
condition|)
return|return
operator|-
name|EINVAL
return|;
name|ent
operator|->
name|miss
operator|=
name|var
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|size_show
parameter_list|(
name|struct
name|cache_order
modifier|*
name|co
parameter_list|,
name|struct
name|order_attribute
modifier|*
name|oa
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|co
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|co
operator|->
name|index
index|]
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
literal|20
argument_list|,
literal|"%d\n"
argument_list|,
name|ent
operator|->
name|size
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|size_store
parameter_list|(
name|struct
name|cache_order
modifier|*
name|co
parameter_list|,
name|struct
name|order_attribute
modifier|*
name|oa
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|co
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|mlx5_cache_ent
modifier|*
name|ent
init|=
operator|&
name|cache
operator|->
name|ent
index|[
name|co
operator|->
name|index
index|]
decl_stmt|;
name|u32
name|var
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|kstrtouint
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|&
name|var
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|<
name|ent
operator|->
name|limit
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|>
name|ent
operator|->
name|size
condition|)
block|{
do|do
block|{
name|err
operator|=
name|add_keys
argument_list|(
name|dev
argument_list|,
name|co
operator|->
name|index
argument_list|,
name|var
operator|-
name|ent
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|!=
operator|-
name|EAGAIN
condition|)
return|return
name|err
return|;
name|usleep_range
argument_list|(
literal|3000
argument_list|,
literal|5000
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|err
condition|)
do|;
block|}
elseif|else
if|if
condition|(
name|var
operator|<
name|ent
operator|->
name|size
condition|)
block|{
name|remove_keys
argument_list|(
name|dev
argument_list|,
name|co
operator|->
name|index
argument_list|,
name|ent
operator|->
name|size
operator|-
name|var
argument_list|)
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|order_attr_show
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|order_attribute
modifier|*
name|oa
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|order_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|cache_order
modifier|*
name|co
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|cache_order
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|oa
operator|->
name|show
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|oa
operator|->
name|show
argument_list|(
name|co
argument_list|,
name|oa
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|order_attr_store
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|struct
name|order_attribute
modifier|*
name|oa
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|order_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|cache_order
modifier|*
name|co
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|cache_order
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|oa
operator|->
name|store
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|oa
operator|->
name|store
argument_list|(
name|co
argument_list|,
name|oa
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|order_sysfs_ops
init|=
block|{
operator|.
name|show
operator|=
name|order_attr_show
block|,
operator|.
name|store
operator|=
name|order_attr_store
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ORDER_ATTR
parameter_list|(
name|_name
parameter_list|)
value|struct order_attribute order_attr_##_name = \ 	__ATTR(_name, 0644, _name##_show, _name##_store)
end_define

begin_define
define|#
directive|define
name|ORDER_ATTR_RO
parameter_list|(
name|_name
parameter_list|)
value|struct order_attribute order_attr_##_name = \ 	__ATTR(_name, 0444, _name##_show, NULL)
end_define

begin_expr_stmt
specifier|static
name|ORDER_ATTR_RO
argument_list|(
name|cur
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|ORDER_ATTR
argument_list|(
name|limit
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|ORDER_ATTR
argument_list|(
name|miss
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|ORDER_ATTR
argument_list|(
name|size
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|order_default_attrs
index|[]
init|=
block|{
operator|&
name|order_attr_cur
operator|.
name|attr
block|,
operator|&
name|order_attr_limit
operator|.
name|attr
block|,
operator|&
name|order_attr_miss
operator|.
name|attr
block|,
operator|&
name|order_attr_size
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|order_type
init|=
block|{
operator|.
name|sysfs_ops
operator|=
operator|&
name|order_sysfs_ops
block|,
operator|.
name|default_attrs
operator|=
name|order_default_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|cache_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ssize_t
name|rel_imm_show
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
literal|20
argument_list|,
literal|"%d\n"
argument_list|,
name|cache
operator|->
name|rel_imm
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|rel_imm_store
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|u32
name|var
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|kstrtouint
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|&
name|var
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|>
literal|1
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|==
name|cache
operator|->
name|rel_imm
condition|)
return|return
name|count
return|;
name|cache
operator|->
name|rel_imm
operator|=
name|var
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|rel_imm
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|cur
operator|>
literal|2
operator|*
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|limit
condition|)
block|{
name|queue_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|work
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
name|cache
operator|->
name|rel_imm
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|rel_timeout_show
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
literal|20
argument_list|,
literal|"%d\n"
argument_list|,
name|cache
operator|->
name|rel_timeout
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|rel_timeout_store
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|int
name|var
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|kstrtoint
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|&
name|var
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|<
operator|-
literal|1
operator|||
name|var
operator|>
name|MAX_MR_RELEASE_TIMEOUT
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|var
operator|==
name|cache
operator|->
name|rel_timeout
condition|)
return|return
name|count
return|;
if|if
condition|(
name|cache
operator|->
name|rel_timeout
operator|==
operator|-
literal|1
operator|||
operator|(
name|var
operator|<
name|cache
operator|->
name|rel_timeout
operator|&&
name|var
operator|!=
operator|-
literal|1
operator|)
condition|)
block|{
name|cache
operator|->
name|rel_timeout
operator|=
name|var
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|cur
operator|>
literal|2
operator|*
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|limit
condition|)
name|queue_work
argument_list|(
name|cache
operator|->
name|wq
argument_list|,
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|work
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|cache
operator|->
name|rel_timeout
operator|=
name|var
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|cache_attr_show
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|cache_attribute
modifier|*
name|ca
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|cache_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|mr_cache
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ca
operator|->
name|show
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|ca
operator|->
name|show
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|cache_attr_store
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|struct
name|cache_attribute
modifier|*
name|ca
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|cache_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|mr_cache
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ca
operator|->
name|store
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|ca
operator|->
name|store
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|cache_sysfs_ops
init|=
block|{
operator|.
name|show
operator|=
name|cache_attr_show
block|,
operator|.
name|store
operator|=
name|cache_attr_store
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CACHE_ATTR
parameter_list|(
name|_name
parameter_list|)
value|struct cache_attribute cache_attr_##_name = \ 	__ATTR(_name, 0644, _name##_show, _name##_store)
end_define

begin_expr_stmt
specifier|static
name|CACHE_ATTR
argument_list|(
name|rel_imm
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CACHE_ATTR
argument_list|(
name|rel_timeout
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|cache_default_attrs
index|[]
init|=
block|{
operator|&
name|cache_attr_rel_imm
operator|.
name|attr
block|,
operator|&
name|cache_attr_rel_timeout
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|cache_type
init|=
block|{
operator|.
name|sysfs_ops
operator|=
operator|&
name|cache_sysfs_ops
block|,
operator|.
name|default_attrs
operator|=
name|cache_default_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mlx5_mr_sysfs_init
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|device
modifier|*
name|device
init|=
operator|&
name|dev
operator|->
name|ib_dev
operator|.
name|dev
decl_stmt|;
name|struct
name|cache_order
modifier|*
name|co
decl_stmt|;
name|int
name|o
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|dev
operator|->
name|mr_cache
argument_list|,
operator|&
name|cache_type
argument_list|,
operator|&
name|device
operator|->
name|kobj
argument_list|,
literal|"mr_cache"
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|-
name|ENOMEM
return|;
for|for
control|(
name|o
operator|=
literal|2
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MR_CACHE_ENTRIES
condition|;
name|o
operator|++
operator|,
name|i
operator|++
control|)
block|{
name|co
operator|=
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|co
expr_stmt|;
name|co
operator|->
name|order
operator|=
name|o
expr_stmt|;
name|co
operator|->
name|index
operator|=
name|i
expr_stmt|;
name|co
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|err
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|co
operator|->
name|kobj
argument_list|,
operator|&
name|order_type
argument_list|,
operator|&
name|dev
operator|->
name|mr_cache
argument_list|,
literal|"%d"
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_put
goto|;
block|}
return|return
literal|0
return|;
name|err_put
label|:
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|co
operator|=
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|co
expr_stmt|;
name|kobject_put
argument_list|(
operator|&
name|co
operator|->
name|kobj
argument_list|)
expr_stmt|;
block|}
name|kobject_put
argument_list|(
operator|&
name|dev
operator|->
name|mr_cache
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_mr_sysfs_cleanup
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|mlx5_mr_cache
modifier|*
name|cache
init|=
operator|&
name|dev
operator|->
name|cache
decl_stmt|;
name|struct
name|cache_order
modifier|*
name|co
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|MAX_MR_CACHE_ENTRIES
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|co
operator|=
operator|&
name|cache
operator|->
name|ent
index|[
name|i
index|]
operator|.
name|co
expr_stmt|;
name|kobject_put
argument_list|(
operator|&
name|co
operator|->
name|kobj
argument_list|)
expr_stmt|;
block|}
name|kobject_put
argument_list|(
operator|&
name|dev
operator|->
name|mr_cache
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013-2015, Mellanox Technologies, Ltd.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/pci.h>
end_include

begin_include
include|#
directive|include
file|<linux/dma-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/io-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/sched.h>
end_include

begin_include
include|#
directive|include
file|<linux/netdevice.h>
end_include

begin_include
include|#
directive|include
file|<linux/etherdevice.h>
end_include

begin_include
include|#
directive|include
file|<linux/list.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/driver.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/vport.h>
end_include

begin_include
include|#
directive|include
file|<asm/pgtable.h>
end_include

begin_include
include|#
directive|include
file|<linux/fs.h>
end_include

begin_undef
undef|#
directive|undef
name|inode
end_undef

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_smi.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|"user.h"
end_include

begin_include
include|#
directive|include
file|"mlx5_ib.h"
end_include

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_define
define|#
directive|define
name|DRIVER_NAME
value|"mlx5_ib"
end_define

begin_define
define|#
directive|define
name|DRIVER_VERSION
value|"3.2-rc1"
end_define

begin_define
define|#
directive|define
name|DRIVER_RELDATE
value|"May 2016"
end_define

begin_expr_stmt
name|MODULE_AUTHOR
argument_list|(
literal|"Eli Cohen<eli@mellanox.com>"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DESCRIPTION
argument_list|(
literal|"Mellanox Connect-IB HCA IB driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_LICENSE
argument_list|(
literal|"Dual BSD/GPL"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5ib
argument_list|,
name|linuxkpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5ib
argument_list|,
name|mlx5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5ib
argument_list|,
name|ibcore
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|mlx5ib
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|deprecated_prof_sel
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|prof_sel
argument_list|,
name|deprecated_prof_sel
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|prof_sel
argument_list|,
literal|"profile selector. Deprecated here. Moved to module mlx5_core"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_enum
enum|enum
block|{
name|MLX5_STANDARD_ATOMIC_SIZE
init|=
literal|0x8
block|, }
enum|;
end_enum

begin_decl_stmt
name|struct
name|workqueue_struct
modifier|*
name|mlx5_ib_wq
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|mlx5_version
index|[]
init|=
name|DRIVER_NAME
literal|": Mellanox Connect-IB Infiniband driver v"
name|DRIVER_VERSION
literal|" ("
name|DRIVER_RELDATE
literal|")\n"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|get_atomic_caps
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|ib_device_attr
modifier|*
name|props
parameter_list|)
block|{
name|int
name|tmp
decl_stmt|;
name|u8
name|atomic_operations
decl_stmt|;
name|u8
name|atomic_size_qp
decl_stmt|;
name|u8
name|atomic_req_endianess
decl_stmt|;
name|atomic_operations
operator|=
name|MLX5_CAP_ATOMIC
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|atomic_operations
argument_list|)
expr_stmt|;
name|atomic_size_qp
operator|=
name|MLX5_CAP_ATOMIC
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|atomic_size_qp
argument_list|)
expr_stmt|;
name|atomic_req_endianess
operator|=
name|MLX5_CAP_ATOMIC
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|atomic_req_8B_endianess_mode
argument_list|)
operator|||
operator|!
name|mlx5_host_is_le
argument_list|()
expr_stmt|;
name|tmp
operator|=
name|MLX5_ATOMIC_OPS_CMP_SWAP
operator||
name|MLX5_ATOMIC_OPS_FETCH_ADD
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|atomic_operations
operator|&
name|tmp
operator|)
operator|==
name|tmp
operator|)
operator|&&
operator|(
name|atomic_size_qp
operator|&
literal|8
operator|)
condition|)
block|{
if|if
condition|(
name|atomic_req_endianess
condition|)
block|{
name|props
operator|->
name|atomic_cap
operator|=
name|IB_ATOMIC_HCA
expr_stmt|;
block|}
else|else
block|{
name|props
operator|->
name|atomic_cap
operator|=
name|IB_ATOMIC_NONE
expr_stmt|;
block|}
block|}
else|else
block|{
name|props
operator|->
name|atomic_cap
operator|=
name|IB_ATOMIC_NONE
expr_stmt|;
block|}
name|tmp
operator|=
name|MLX5_ATOMIC_OPS_MASKED_CMP_SWAP
operator||
name|MLX5_ATOMIC_OPS_MASKED_FETCH_ADD
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|atomic_operations
operator|&
name|tmp
operator|)
operator|==
name|tmp
operator|)
operator|&&
operator|(
name|atomic_size_qp
operator|&
literal|8
operator|)
condition|)
block|{
if|if
condition|(
name|atomic_req_endianess
condition|)
name|props
operator|->
name|masked_atomic_cap
operator|=
name|IB_ATOMIC_HCA
expr_stmt|;
else|else
block|{
name|props
operator|->
name|masked_atomic_cap
operator|=
name|IB_ATOMIC_NONE
expr_stmt|;
block|}
block|}
else|else
block|{
name|props
operator|->
name|masked_atomic_cap
operator|=
name|IB_ATOMIC_NONE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|enum
name|rdma_link_layer
name|mlx5_ib_port_link_layer
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|device
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port_type
argument_list|)
condition|)
block|{
case|case
name|MLX5_CAP_PORT_TYPE_IB
case|:
return|return
name|IB_LINK_LAYER_INFINIBAND
return|;
case|case
name|MLX5_CAP_PORT_TYPE_ETH
case|:
return|return
name|IB_LINK_LAYER_ETHERNET
return|;
default|default:
return|return
name|IB_LINK_LAYER_UNSPECIFIED
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_use_mad_ifc
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
return|return
operator|!
name|dev
operator|->
name|mdev
operator|->
name|issi
return|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MLX5_VPORT_ACCESS_METHOD_MAD
block|,
name|MLX5_VPORT_ACCESS_METHOD_HCA
block|,
name|MLX5_VPORT_ACCESS_METHOD_NIC
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|mlx5_get_vport_access_method
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|)
block|{
if|if
condition|(
name|mlx5_use_mad_ifc
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
argument_list|)
condition|)
return|return
name|MLX5_VPORT_ACCESS_METHOD_MAD
return|;
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
name|ibdev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
return|return
name|MLX5_VPORT_ACCESS_METHOD_NIC
return|;
return|return
name|MLX5_VPORT_ACCESS_METHOD_HCA
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_system_image_guid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|__be64
modifier|*
name|sys_image_guid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|u64
name|tmp
decl_stmt|;
name|int
name|err
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_system_image_guid_mad_ifc
argument_list|(
name|ibdev
argument_list|,
name|sys_image_guid
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
name|err
operator|=
name|mlx5_query_hca_vport_system_image_guid
argument_list|(
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
operator|*
name|sys_image_guid
operator|=
name|cpu_to_be64
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|err
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
name|err
operator|=
name|mlx5_query_nic_vport_system_image_guid
argument_list|(
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
operator|*
name|sys_image_guid
operator|=
name|cpu_to_be64
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|err
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_max_pkeys
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u16
modifier|*
name|max_pkeys
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_max_pkeys_mad_ifc
argument_list|(
name|ibdev
argument_list|,
name|max_pkeys
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
operator|*
name|max_pkeys
operator|=
name|mlx5_to_sw_pkey_sz
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|pkey_table_size
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_vendor_id
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u32
modifier|*
name|vendor_id
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_vendor_id_mad_ifc
argument_list|(
name|ibdev
argument_list|,
name|vendor_id
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
return|return
name|mlx5_core_query_vendor_id
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|vendor_id
argument_list|)
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_node_guid
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|__be64
modifier|*
name|node_guid
parameter_list|)
block|{
name|u64
name|tmp
decl_stmt|;
name|int
name|err
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_node_guid_mad_ifc
argument_list|(
name|dev
argument_list|,
name|node_guid
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
name|err
operator|=
name|mlx5_query_hca_vport_node_guid
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
operator|*
name|node_guid
operator|=
name|cpu_to_be64
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|err
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
name|err
operator|=
name|mlx5_query_nic_vport_node_guid
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
operator|*
name|node_guid
operator|=
name|cpu_to_be64
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|err
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_struct
struct|struct
name|mlx5_reg_node_desc
block|{
name|u8
name|desc
index|[
literal|64
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|mlx5_query_node_desc
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|char
modifier|*
name|node_desc
parameter_list|)
block|{
name|struct
name|mlx5_reg_node_desc
name|in
decl_stmt|;
if|if
condition|(
name|mlx5_use_mad_ifc
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|mlx5_query_node_desc_mad_ifc
argument_list|(
name|dev
argument_list|,
name|node_desc
argument_list|)
return|;
name|memset
argument_list|(
operator|&
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|mlx5_core_access_reg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|node_desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_reg_node_desc
argument_list|)
argument_list|,
name|MLX5_REG_NODE_DESC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_query_device
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_device_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|int
name|max_sq_desc
decl_stmt|;
name|int
name|max_rq_sg
decl_stmt|;
name|int
name|max_sq_sg
decl_stmt|;
name|int
name|err
decl_stmt|;
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|props
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_query_system_image_guid
argument_list|(
name|ibdev
argument_list|,
operator|&
name|props
operator|->
name|sys_image_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx5_query_max_pkeys
argument_list|(
name|ibdev
argument_list|,
operator|&
name|props
operator|->
name|max_pkeys
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx5_query_vendor_id
argument_list|(
name|ibdev
argument_list|,
operator|&
name|props
operator|->
name|vendor_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|props
operator|->
name|fw_ver
operator|=
operator|(
operator|(
name|u64
operator|)
name|fw_rev_maj
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
operator|<<
literal|32
operator|)
operator||
operator|(
operator|(
name|u64
operator|)
name|fw_rev_min
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|fw_rev_sub
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
expr_stmt|;
name|props
operator|->
name|device_cap_flags
operator|=
name|IB_DEVICE_CHANGE_PHY_PORT
operator||
name|IB_DEVICE_PORT_ACTIVE_EVENT
operator||
name|IB_DEVICE_SYS_IMAGE_GUID
operator||
name|IB_DEVICE_RC_RNR_NAK_GEN
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|pkv
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_BAD_PKEY_CNTR
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|qkv
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_BAD_QKEY_CNTR
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|apm
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_AUTO_PATH_MIG
expr_stmt|;
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_LOCAL_DMA_LKEY
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|xrc
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_XRC
expr_stmt|;
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_MEM_MGT_EXTENSIONS
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|block_lb_mc
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
expr_stmt|;
name|props
operator|->
name|vendor_part_id
operator|=
name|mdev
operator|->
name|pdev
operator|->
name|device
expr_stmt|;
name|props
operator|->
name|hw_ver
operator|=
name|mdev
operator|->
name|pdev
operator|->
name|revision
expr_stmt|;
name|props
operator|->
name|max_mr_size
operator|=
operator|~
literal|0ull
expr_stmt|;
name|props
operator|->
name|page_size_cap
operator|=
operator|~
call|(
name|u32
call|)
argument_list|(
operator|(
literal|1ull
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_pg_sz
argument_list|)
operator|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_qp
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp_wr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_qp_sz
argument_list|)
expr_stmt|;
name|max_rq_sg
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|max_wqe_sz_rq
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_wqe_data_seg
argument_list|)
expr_stmt|;
name|max_sq_desc
operator|=
name|min
argument_list|(
operator|(
name|int
operator|)
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|max_wqe_sz_sq
argument_list|)
argument_list|,
literal|512
argument_list|)
expr_stmt|;
name|max_sq_sg
operator|=
operator|(
name|max_sq_desc
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_wqe_ctrl_seg
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_wqe_raddr_seg
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_wqe_data_seg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_sge
operator|=
name|min
argument_list|(
name|max_rq_sg
argument_list|,
name|max_sq_sg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_cq
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_cq
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_cqe
operator|=
operator|(
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_cq_sz
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|props
operator|->
name|max_mr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_mkey
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_pd
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_pd
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp_rd_atom
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_ra_req_qp
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp_init_rd_atom
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_ra_res_qp
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_srq
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_srq
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_srq_wr
operator|=
operator|(
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_srq_sz
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|props
operator|->
name|local_ca_ack_delay
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|local_ca_ack_delay
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_res_rd_atom
operator|=
name|props
operator|->
name|max_qp_rd_atom
operator|*
name|props
operator|->
name|max_qp
expr_stmt|;
name|props
operator|->
name|max_srq_sge
operator|=
name|max_rq_sg
operator|-
literal|1
expr_stmt|;
name|props
operator|->
name|max_fast_reg_page_list_len
operator|=
operator|(
name|unsigned
name|int
operator|)
operator|-
literal|1
expr_stmt|;
name|get_atomic_caps
argument_list|(
name|dev
argument_list|,
name|props
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mcast_grp
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_mcg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mcast_qp_attach
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|max_qp_mcg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_total_mcast_qp_attach
operator|=
name|props
operator|->
name|max_mcast_qp_attach
operator|*
name|props
operator|->
name|max_mcast_grp
expr_stmt|;
name|props
operator|->
name|max_map_per_fmr
operator|=
name|INT_MAX
expr_stmt|;
comment|/* no limit in ConnectIB */
name|props
operator|->
name|max_ah
operator|=
name|INT_MAX
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_enum
enum|enum
name|mlx5_ib_width
block|{
name|MLX5_IB_WIDTH_1X
init|=
literal|1
operator|<<
literal|0
block|,
name|MLX5_IB_WIDTH_2X
init|=
literal|1
operator|<<
literal|1
block|,
name|MLX5_IB_WIDTH_4X
init|=
literal|1
operator|<<
literal|2
block|,
name|MLX5_IB_WIDTH_8X
init|=
literal|1
operator|<<
literal|3
block|,
name|MLX5_IB_WIDTH_12X
init|=
literal|1
operator|<<
literal|4
block|}
enum|;
end_enum

begin_function
specifier|static
name|int
name|translate_active_width
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|active_width
parameter_list|,
name|u8
modifier|*
name|ib_width
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_1X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_1X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_2X
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"active_width %d is not supported by IB spec\n"
argument_list|,
operator|(
name|int
operator|)
name|active_width
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_4X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_4X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_8X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_8X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_12X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_12X
expr_stmt|;
block|}
else|else
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Invalid active_width %d\n"
argument_list|,
operator|(
name|int
operator|)
name|active_width
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/*  * TODO: Move to IB core  */
end_comment

begin_enum
enum|enum
name|ib_max_vl_num
block|{
name|__IB_MAX_VL_0
init|=
literal|1
block|,
name|__IB_MAX_VL_0_1
init|=
literal|2
block|,
name|__IB_MAX_VL_0_3
init|=
literal|3
block|,
name|__IB_MAX_VL_0_7
init|=
literal|4
block|,
name|__IB_MAX_VL_0_14
init|=
literal|5
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|mlx5_vl_hw_cap
block|{
name|MLX5_VL_HW_0
init|=
literal|1
block|,
name|MLX5_VL_HW_0_1
init|=
literal|2
block|,
name|MLX5_VL_HW_0_2
init|=
literal|3
block|,
name|MLX5_VL_HW_0_3
init|=
literal|4
block|,
name|MLX5_VL_HW_0_4
init|=
literal|5
block|,
name|MLX5_VL_HW_0_5
init|=
literal|6
block|,
name|MLX5_VL_HW_0_6
init|=
literal|7
block|,
name|MLX5_VL_HW_0_7
init|=
literal|8
block|,
name|MLX5_VL_HW_0_14
init|=
literal|15
block|}
enum|;
end_enum

begin_function
specifier|static
name|int
name|translate_max_vl_num
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|vl_hw_cap
parameter_list|,
name|u8
modifier|*
name|max_vl_num
parameter_list|)
block|{
switch|switch
condition|(
name|vl_hw_cap
condition|)
block|{
case|case
name|MLX5_VL_HW_0
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_1
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_1
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_3
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_3
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_7
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_7
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_14
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_14
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_port_ib
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|struct
name|ib_port_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|u32
modifier|*
name|rep
decl_stmt|;
name|int
name|outlen
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|query_hca_vport_context_out
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ptys_reg
modifier|*
name|ptys
decl_stmt|;
name|struct
name|mlx5_pmtu_reg
modifier|*
name|pmtu
decl_stmt|;
name|struct
name|mlx5_pvlc_reg
name|pvlc
decl_stmt|;
name|void
modifier|*
name|ctx
decl_stmt|;
name|int
name|err
decl_stmt|;
name|rep
operator|=
name|mlx5_vzalloc
argument_list|(
name|outlen
argument_list|)
expr_stmt|;
name|ptys
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ptys
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|pmtu
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pmtu
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rep
operator|||
operator|!
name|ptys
operator|||
operator|!
name|pmtu
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|props
argument_list|)
argument_list|)
expr_stmt|;
comment|/* what if I am pf with dual port */
name|err
operator|=
name|mlx5_query_hca_vport_context
argument_list|(
name|mdev
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|rep
argument_list|,
name|outlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|ctx
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|query_hca_vport_context_out
argument_list|,
name|rep
argument_list|,
name|hca_vport_context
argument_list|)
expr_stmt|;
name|props
operator|->
name|lid
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|lid
argument_list|)
expr_stmt|;
name|props
operator|->
name|lmc
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|lmc
argument_list|)
expr_stmt|;
name|props
operator|->
name|sm_lid
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|sm_lid
argument_list|)
expr_stmt|;
name|props
operator|->
name|sm_sl
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|sm_sl
argument_list|)
expr_stmt|;
name|props
operator|->
name|state
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|vport_state
argument_list|)
expr_stmt|;
name|props
operator|->
name|phys_state
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|port_physical_state
argument_list|)
expr_stmt|;
name|props
operator|->
name|port_cap_flags
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|cap_mask1
argument_list|)
expr_stmt|;
name|props
operator|->
name|gid_tbl_len
operator|=
name|mlx5_get_gid_table_len
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|gid_table_size
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_msg_sz
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_msg
argument_list|)
expr_stmt|;
name|props
operator|->
name|pkey_tbl_len
operator|=
name|mlx5_to_sw_pkey_sz
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|pkey_table_size
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|->
name|bad_pkey_cntr
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|pkey_violation_counter
argument_list|)
expr_stmt|;
name|props
operator|->
name|qkey_viol_cntr
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|qkey_violation_counter
argument_list|)
expr_stmt|;
name|props
operator|->
name|subnet_timeout
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|subnet_timeout
argument_list|)
expr_stmt|;
name|props
operator|->
name|init_type_reply
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|init_type_reply
argument_list|)
expr_stmt|;
name|ptys
operator|->
name|proto_mask
operator||=
name|MLX5_PTYS_IB
expr_stmt|;
name|ptys
operator|->
name|local_port
operator|=
name|port
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_ptys
argument_list|(
name|mdev
argument_list|,
name|ptys
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|translate_active_width
argument_list|(
name|ibdev
argument_list|,
name|ptys
operator|->
name|ib_link_width_oper
argument_list|,
operator|&
name|props
operator|->
name|active_width
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|props
operator|->
name|active_speed
operator|=
operator|(
name|u8
operator|)
name|ptys
operator|->
name|ib_proto_oper
expr_stmt|;
name|pmtu
operator|->
name|local_port
operator|=
name|port
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_pmtu
argument_list|(
name|mdev
argument_list|,
name|pmtu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|props
operator|->
name|max_mtu
operator|=
name|pmtu
operator|->
name|max_mtu
expr_stmt|;
name|props
operator|->
name|active_mtu
operator|=
name|pmtu
operator|->
name|oper_mtu
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pvlc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pvlc
argument_list|)
argument_list|)
expr_stmt|;
name|pvlc
operator|.
name|local_port
operator|=
name|port
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_pvlc
argument_list|(
name|mdev
argument_list|,
operator|&
name|pvlc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|translate_max_vl_num
argument_list|(
name|ibdev
argument_list|,
name|pvlc
operator|.
name|vl_hw_cap
argument_list|,
operator|&
name|props
operator|->
name|max_vl_num
argument_list|)
expr_stmt|;
name|out
label|:
name|kvfree
argument_list|(
name|rep
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|ptys
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|pmtu
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mlx5_ib_query_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|struct
name|ib_port_attr
modifier|*
name|props
parameter_list|)
block|{
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_port_mad_ifc
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|props
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
return|return
name|mlx5_query_port_ib
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|props
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
return|return
name|mlx5_query_port_roce
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|props
argument_list|)
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|mlx5_addrconf_ifid_eui48
parameter_list|(
name|u8
modifier|*
name|eui
parameter_list|,
name|struct
name|net_device
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|if_addrlen
operator|!=
name|ETH_ALEN
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|eui
argument_list|,
name|IF_LLADDR
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eui
operator|+
literal|5
argument_list|,
name|IF_LLADDR
argument_list|(
name|dev
argument_list|)
operator|+
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* NOTE: The scope ID is added by the GID to IP conversion */
name|eui
index|[
literal|3
index|]
operator|=
literal|0xFF
expr_stmt|;
name|eui
index|[
literal|4
index|]
operator|=
literal|0xFE
expr_stmt|;
name|eui
index|[
literal|0
index|]
operator|^=
literal|2
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_make_default_gid
parameter_list|(
name|struct
name|net_device
modifier|*
name|dev
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|)
block|{
name|gid
operator|->
name|global
operator|.
name|subnet_prefix
operator|=
name|cpu_to_be64
argument_list|(
literal|0xfe80000000000000LL
argument_list|)
expr_stmt|;
name|mlx5_addrconf_ifid_eui48
argument_list|(
operator|&
name|gid
operator|->
name|raw
index|[
literal|8
index|]
argument_list|,
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|mlx5_ip2gid
parameter_list|(
specifier|const
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|)
block|{
switch|switch
condition|(
name|addr
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|ipv6_addr_set_v4mapped
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
operator|(
expr|struct
name|in6_addr
operator|*
operator|)
name|gid
operator|->
name|raw
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET6
case|:
name|memcpy
argument_list|(
name|gid
operator|->
name|raw
argument_list|,
operator|&
operator|(
operator|(
specifier|const
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|addr
operator|)
operator|->
name|sin6_addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* clear SCOPE ID */
name|gid
operator|->
name|raw
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|gid
operator|->
name|raw
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_roce_port_update
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mlx5_ib_port
modifier|*
name|port
init|=
operator|(
expr|struct
name|mlx5_ib_port
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|port
operator|->
name|dev
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|struct
name|net_device
modifier|*
name|xdev
index|[
name|MLX5_IB_GID_MAX
index|]
decl_stmt|;
name|struct
name|net_device
modifier|*
name|idev
decl_stmt|;
name|struct
name|net_device
modifier|*
name|ndev
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
name|union
name|ib_gid
name|gid_temp
decl_stmt|;
while|while
condition|(
name|port
operator|->
name|port_gone
operator|==
literal|0
condition|)
block|{
name|int
name|update
init|=
literal|0
decl_stmt|;
name|int
name|gid_index
init|=
literal|0
decl_stmt|;
name|int
name|j
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ndev
operator|=
name|mlx5_get_protocol_dev
argument_list|(
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_ETH
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndev
operator|==
name|NULL
condition|)
block|{
name|pause
argument_list|(
literal|"W"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|CURVNET_SET_QUIET
argument_list|(
name|ndev
operator|->
name|if_vnet
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|gid_temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_temp
argument_list|)
argument_list|)
expr_stmt|;
name|mlx5_make_default_gid
argument_list|(
name|ndev
argument_list|,
operator|&
name|gid_temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|gid_temp
argument_list|,
operator|&
name|port
operator|->
name|gid_table
index|[
name|gid_index
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_temp
argument_list|)
argument_list|)
condition|)
block|{
name|port
operator|->
name|gid_table
index|[
name|gid_index
index|]
operator|=
name|gid_temp
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
block|}
name|xdev
index|[
name|gid_index
index|]
operator|=
name|ndev
expr_stmt|;
name|gid_index
operator|++
expr_stmt|;
name|IFNET_RLOCK
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|idev
argument_list|,
argument|&V_ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
if|if
condition|(
name|idev
operator|==
name|ndev
condition|)
break|break;
block|}
if|if
condition|(
name|idev
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|idev
argument_list|,
argument|&V_ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
if|if
condition|(
name|idev
operator|!=
name|ndev
condition|)
block|{
if|if
condition|(
name|idev
operator|->
name|if_type
operator|!=
name|IFT_L2VLAN
condition|)
continue|continue;
if|if
condition|(
name|ndev
operator|!=
name|rdma_vlan_dev_real_dev
argument_list|(
name|idev
argument_list|)
condition|)
continue|continue;
block|}
comment|/* clone address information for IPv4 and IPv6 */
name|IF_ADDR_RLOCK
argument_list|(
name|idev
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifa
argument_list|,
argument|&idev->if_addrhead
argument_list|,
argument|ifa_link
argument_list|)
block|{
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|==
name|NULL
operator|||
operator|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_INET
operator|&&
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_INET6
operator|)
operator|||
name|gid_index
operator|>=
name|MLX5_IB_GID_MAX
condition|)
continue|continue;
name|memset
argument_list|(
operator|&
name|gid_temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_temp
argument_list|)
argument_list|)
expr_stmt|;
name|mlx5_ip2gid
argument_list|(
name|ifa
operator|->
name|ifa_addr
argument_list|,
operator|&
name|gid_temp
argument_list|)
expr_stmt|;
comment|/* check for existing entry */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|!=
name|gid_index
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|gid_temp
argument_list|,
operator|&
name|port
operator|->
name|gid_table
index|[
name|j
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_temp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
comment|/* check if new entry must be added */
if|if
condition|(
name|j
operator|==
name|gid_index
condition|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|gid_temp
argument_list|,
operator|&
name|port
operator|->
name|gid_table
index|[
name|gid_index
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_temp
argument_list|)
argument_list|)
condition|)
block|{
name|port
operator|->
name|gid_table
index|[
name|gid_index
index|]
operator|=
name|gid_temp
expr_stmt|;
name|update
operator|=
literal|1
expr_stmt|;
block|}
name|xdev
index|[
name|gid_index
index|]
operator|=
name|idev
expr_stmt|;
name|gid_index
operator|++
expr_stmt|;
block|}
block|}
name|IF_ADDR_RUNLOCK
argument_list|(
name|idev
argument_list|)
expr_stmt|;
block|}
block|}
name|IFNET_RUNLOCK
argument_list|()
expr_stmt|;
name|CURVNET_RESTORE
argument_list|()
expr_stmt|;
if|if
condition|(
name|update
operator|!=
literal|0
operator|&&
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
block|{
name|struct
name|ib_event
name|event
init|=
block|{
operator|.
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
block|,
operator|.
name|element
operator|.
name|port_num
operator|=
name|port
operator|->
name|port_num
operator|+
literal|1
block|,
operator|.
name|event
operator|=
name|IB_EVENT_GID_CHANGE
block|, 			}
decl_stmt|;
comment|/* add new entries, if any */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|!=
name|gid_index
condition|;
name|j
operator|++
control|)
block|{
name|error
operator|=
name|modify_gid_roce
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|port
operator|->
name|port_num
argument_list|,
name|j
argument_list|,
name|port
operator|->
name|gid_table
operator|+
name|j
argument_list|,
name|xdev
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"mlx5_ib: Failed to update ROCE GID table: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|gid_temp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_temp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* clear old entries, if any */
for|for
control|(
init|;
name|j
operator|!=
name|MLX5_IB_GID_MAX
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|bcmp
argument_list|(
operator|&
name|gid_temp
argument_list|,
name|port
operator|->
name|gid_table
operator|+
name|j
argument_list|,
sizeof|sizeof
argument_list|(
name|gid_temp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|port
operator|->
name|gid_table
index|[
name|j
index|]
operator|=
name|gid_temp
expr_stmt|;
operator|(
name|void
operator|)
name|modify_gid_roce
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|port
operator|->
name|port_num
argument_list|,
name|j
argument_list|,
name|port
operator|->
name|gid_table
operator|+
name|j
argument_list|,
name|ndev
argument_list|)
expr_stmt|;
block|}
comment|/* make sure ibcore gets updated */
name|ib_dispatch_event
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
name|pause
argument_list|(
literal|"W"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
do|do
block|{
name|struct
name|ib_event
name|event
init|=
block|{
operator|.
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
block|,
operator|.
name|element
operator|.
name|port_num
operator|=
name|port
operator|->
name|port_num
operator|+
literal|1
block|,
operator|.
name|event
operator|=
name|IB_EVENT_GID_CHANGE
block|, 		}
decl_stmt|;
comment|/* make sure ibcore gets updated */
name|ib_dispatch_event
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
comment|/* wait a bit */
name|pause
argument_list|(
literal|"W"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|port
operator|->
name|port_gone
operator|=
literal|2
expr_stmt|;
name|kthread_exit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_query_gid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|index
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_gids_mad_ifc
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|index
argument_list|,
name|gid
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
return|return
name|mlx5_query_hca_vport_gid
argument_list|(
name|mdev
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|index
argument_list|,
name|gid
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
if|if
condition|(
name|port
operator|==
literal|0
operator|||
name|port
operator|>
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
operator|||
name|index
operator|<
literal|0
operator|||
name|index
operator|>=
name|MLX5_IB_GID_MAX
operator|||
name|dev
operator|->
name|port
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|port_gone
operator|!=
literal|0
condition|)
name|memset
argument_list|(
name|gid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|gid
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|*
name|gid
operator|=
name|dev
operator|->
name|port
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|gid_table
index|[
name|index
index|]
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_query_pkey
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u16
name|index
parameter_list|,
name|u16
modifier|*
name|pkey
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_pkey_mad_ifc
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|index
argument_list|,
name|pkey
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
return|return
name|mlx5_query_hca_vport_pkey
argument_list|(
name|mdev
argument_list|,
literal|0
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|index
argument_list|,
name|pkey
argument_list|)
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_modify_device
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|int
name|mask
parameter_list|,
name|struct
name|ib_device_modify
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_reg_node_desc
name|in
decl_stmt|;
name|struct
name|mlx5_reg_node_desc
name|out
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|mask
operator|&
operator|~
name|IB_DEVICE_MODIFY_NODE_DESC
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|IB_DEVICE_MODIFY_NODE_DESC
operator|)
condition|)
return|return
literal|0
return|;
comment|/* 	 * If possible, pass node desc to FW, so it can generate 	 * a 144 trap.  If cmd fails, just ignore. 	 */
name|memcpy
argument_list|(
operator|&
name|in
argument_list|,
name|props
operator|->
name|node_desc
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_reg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
operator|&
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|,
name|MLX5_REG_NODE_DESC
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|memcpy
argument_list|(
name|ibdev
operator|->
name|node_desc
argument_list|,
name|props
operator|->
name|node_desc
argument_list|,
literal|64
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_modify_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|mask
parameter_list|,
name|struct
name|ib_port_modify
modifier|*
name|props
parameter_list|)
block|{
name|u8
name|is_eth
init|=
operator|(
name|mlx5_ib_port_link_layer
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
operator|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* return OK if this is RoCE. CM calls ib_modify_port() regardless 	 * of whether port link layer is ETH or IB. For ETH ports, qkey 	 * violations and port capabilities are not valid. 	 */
if|if
condition|(
name|is_eth
condition|)
return|return
literal|0
return|;
name|mutex_lock
argument_list|(
operator|&
name|dev
operator|->
name|cap_mask_mutex
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_ib_query_port
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|tmp
operator|=
operator|(
name|attr
operator|.
name|port_cap_flags
operator||
name|props
operator|->
name|set_port_cap_mask
operator|)
operator|&
operator|~
name|props
operator|->
name|clr_port_cap_mask
expr_stmt|;
name|err
operator|=
name|mlx5_set_port_caps
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|dev
operator|->
name|cap_mask_mutex
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_enum
enum|enum
name|mlx5_cap_flags
block|{
name|MLX5_CAP_COMPACT_AV
init|=
literal|1
operator|<<
literal|0
block|, }
enum|;
end_enum

begin_function
specifier|static
name|void
name|set_mlx5_flags
parameter_list|(
name|u32
modifier|*
name|flags
parameter_list|,
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|)
block|{
operator|*
name|flags
operator||=
name|MLX5_CAP_GEN
argument_list|(
name|dev
argument_list|,
name|compact_address_vector
argument_list|)
condition|?
name|MLX5_CAP_COMPACT_AV
else|:
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_ucontext
modifier|*
name|mlx5_ib_alloc_ucontext
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_alloc_ucontext_req_v2
name|req
decl_stmt|;
name|struct
name|mlx5_ib_alloc_ucontext_resp
name|resp
decl_stmt|;
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
decl_stmt|;
name|struct
name|mlx5_uuar_info
modifier|*
name|uuari
decl_stmt|;
name|struct
name|mlx5_uar
modifier|*
name|uars
decl_stmt|;
name|int
name|gross_uuars
decl_stmt|;
name|int
name|num_uars
decl_stmt|;
name|int
name|ver
decl_stmt|;
name|int
name|uuarn
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|ib_active
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EAGAIN
argument_list|)
return|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|)
expr_stmt|;
name|reqlen
operator|=
name|udata
operator|->
name|inlen
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ib_uverbs_cmd_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqlen
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_ib_alloc_ucontext_req
argument_list|)
condition|)
name|ver
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|reqlen
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_ib_alloc_ucontext_req_v2
argument_list|)
condition|)
name|ver
operator|=
literal|2
expr_stmt|;
else|else
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"request malformed, reqlen: %ld\n"
argument_list|,
operator|(
name|long
operator|)
name|reqlen
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
block|}
name|err
operator|=
name|ib_copy_from_udata
argument_list|(
operator|&
name|req
argument_list|,
name|udata
argument_list|,
name|reqlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"copy failed\n"
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
if|if
condition|(
name|req
operator|.
name|reserved
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"request corrupted\n"
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
block|}
if|if
condition|(
name|req
operator|.
name|total_num_uuars
operator|==
literal|0
operator|||
name|req
operator|.
name|total_num_uuars
operator|>
name|MLX5_MAX_UUARS
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"wrong num_uuars: %d\n"
argument_list|,
name|req
operator|.
name|total_num_uuars
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
block|}
name|req
operator|.
name|total_num_uuars
operator|=
name|ALIGN
argument_list|(
name|req
operator|.
name|total_num_uuars
argument_list|,
name|MLX5_NON_FP_BF_REGS_PER_PAGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|num_low_latency_uuars
operator|>
name|req
operator|.
name|total_num_uuars
operator|-
literal|1
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"wrong num_low_latency_uuars: %d (> %d)\n"
argument_list|,
name|req
operator|.
name|total_num_uuars
argument_list|,
name|req
operator|.
name|total_num_uuars
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
block|}
name|num_uars
operator|=
name|req
operator|.
name|total_num_uuars
operator|/
name|MLX5_NON_FP_BF_REGS_PER_PAGE
expr_stmt|;
name|gross_uuars
operator|=
name|num_uars
operator|*
name|MLX5_BF_REGS_PER_PAGE
expr_stmt|;
name|resp
operator|.
name|qp_tab_size
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_core_is_pf
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
operator|&&
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|bf
argument_list|)
condition|)
name|resp
operator|.
name|bf_reg_size
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_bf_reg_size
argument_list|)
expr_stmt|;
name|resp
operator|.
name|cache_line_size
operator|=
name|L1_CACHE_BYTES
expr_stmt|;
name|resp
operator|.
name|max_sq_desc_sz
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|max_wqe_sz_sq
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_rq_desc_sz
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|max_wqe_sz_rq
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_send_wqebb
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_qp_sz
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_recv_wr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_qp_sz
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_srq_recv_wr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_srq_sz
argument_list|)
expr_stmt|;
name|set_mlx5_flags
argument_list|(
operator|&
name|resp
operator|.
name|flags
argument_list|,
name|dev
operator|->
name|mdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|offsetof
argument_list|(
expr|struct
name|mlx5_ib_alloc_ucontext_resp
argument_list|,
name|max_desc_sz_sq_dc
argument_list|)
operator|<
name|udata
operator|->
name|outlen
condition|)
name|resp
operator|.
name|max_desc_sz_sq_dc
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|max_wqe_sz_sq_dc
argument_list|)
expr_stmt|;
if|if
condition|(
name|offsetof
argument_list|(
expr|struct
name|mlx5_ib_alloc_ucontext_resp
argument_list|,
name|atomic_arg_sizes_dc
argument_list|)
operator|<
name|udata
operator|->
name|outlen
condition|)
name|resp
operator|.
name|atomic_arg_sizes_dc
operator|=
name|MLX5_CAP_ATOMIC
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|atomic_size_dc
argument_list|)
expr_stmt|;
name|context
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|context
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|uuari
operator|=
operator|&
name|context
operator|->
name|uuari
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|uuari
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uars
operator|=
name|kcalloc
argument_list|(
name|num_uars
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uars
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uars
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out_ctx
goto|;
block|}
name|uuari
operator|->
name|bitmap
operator|=
name|kcalloc
argument_list|(
name|BITS_TO_LONGS
argument_list|(
name|gross_uuars
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uuari
operator|->
name|bitmap
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uuari
operator|->
name|bitmap
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out_uar_ctx
goto|;
block|}
comment|/* 	 * clear all fast path uuars 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|gross_uuars
condition|;
name|i
operator|++
control|)
block|{
name|uuarn
operator|=
name|i
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|uuarn
operator|==
literal|2
operator|||
name|uuarn
operator|==
literal|3
condition|)
name|set_bit
argument_list|(
name|i
argument_list|,
name|uuari
operator|->
name|bitmap
argument_list|)
expr_stmt|;
block|}
name|uuari
operator|->
name|count
operator|=
name|kcalloc
argument_list|(
name|gross_uuars
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uuari
operator|->
name|count
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uuari
operator|->
name|count
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out_bitmap
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_uars
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|mlx5_cmd_alloc_uar
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"uar alloc failed at %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
goto|goto
name|out_uars
goto|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5_IB_MAX_CTX_DYNAMIC_UARS
condition|;
name|i
operator|++
control|)
name|context
operator|->
name|dynamic_wc_uar_index
index|[
name|i
index|]
operator|=
name|MLX5_IB_INVALID_UAR_INDEX
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|context
operator|->
name|db_page_list
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|context
operator|->
name|db_page_mutex
argument_list|)
expr_stmt|;
name|resp
operator|.
name|tot_uuars
operator|=
name|req
operator|.
name|total_num_uuars
expr_stmt|;
name|resp
operator|.
name|num_ports
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
expr_stmt|;
name|err
operator|=
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|resp
argument_list|,
name|min_t
argument_list|(
name|size_t
argument_list|,
name|udata
operator|->
name|outlen
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out_uars
goto|;
name|uuari
operator|->
name|ver
operator|=
name|ver
expr_stmt|;
name|uuari
operator|->
name|num_low_latency_uuars
operator|=
name|req
operator|.
name|num_low_latency_uuars
expr_stmt|;
name|uuari
operator|->
name|uars
operator|=
name|uars
expr_stmt|;
name|uuari
operator|->
name|num_uars
operator|=
name|num_uars
expr_stmt|;
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
block|{
name|err
operator|=
name|mlx5_alloc_transport_domain
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|context
operator|->
name|tdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out_uars
goto|;
block|}
return|return
operator|&
name|context
operator|->
name|ibucontext
return|;
name|out_uars
label|:
for|for
control|(
name|i
operator|--
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|mlx5_cmd_free_uar
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|uuari
operator|->
name|count
argument_list|)
expr_stmt|;
name|out_bitmap
label|:
name|kfree
argument_list|(
name|uuari
operator|->
name|bitmap
argument_list|)
expr_stmt|;
name|out_uar_ctx
label|:
name|kfree
argument_list|(
name|uars
argument_list|)
expr_stmt|;
name|out_ctx
label|:
name|kfree
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_dealloc_ucontext
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|ibcontext
parameter_list|)
block|{
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
init|=
name|to_mucontext
argument_list|(
name|ibcontext
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibcontext
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_uuar_info
modifier|*
name|uuari
init|=
operator|&
name|context
operator|->
name|uuari
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
name|mlx5_dealloc_transport_domain
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|context
operator|->
name|tdn
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|uuari
operator|->
name|num_uars
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx5_cmd_free_uar
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|uuari
operator|->
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to free UAR 0x%x\n"
argument_list|,
name|uuari
operator|->
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5_IB_MAX_CTX_DYNAMIC_UARS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|context
operator|->
name|dynamic_wc_uar_index
index|[
name|i
index|]
operator|!=
name|MLX5_IB_INVALID_UAR_INDEX
condition|)
name|mlx5_cmd_free_uar
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|context
operator|->
name|dynamic_wc_uar_index
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|uuari
operator|->
name|count
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|uuari
operator|->
name|bitmap
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|uuari
operator|->
name|uars
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|phys_addr_t
name|uar_index2pfn
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|index
parameter_list|)
block|{
return|return
operator|(
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|mdev
operator|->
name|pdev
argument_list|,
literal|0
argument_list|)
operator|>>
name|PAGE_SHIFT
operator|)
operator|+
name|index
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_command
parameter_list|(
name|unsigned
name|long
name|offset
parameter_list|)
block|{
return|return
operator|(
name|offset
operator|>>
name|MLX5_IB_MMAP_CMD_SHIFT
operator|)
operator|&
name|MLX5_IB_MMAP_CMD_MASK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_arg
parameter_list|(
name|unsigned
name|long
name|offset
parameter_list|)
block|{
return|return
name|offset
operator|&
operator|(
operator|(
literal|1
operator|<<
name|MLX5_IB_MMAP_CMD_SHIFT
operator|)
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_index
parameter_list|(
name|unsigned
name|long
name|offset
parameter_list|)
block|{
return|return
name|get_arg
argument_list|(
name|offset
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|uar_mmap
parameter_list|(
name|struct
name|vm_area_struct
modifier|*
name|vma
parameter_list|,
name|pgprot_t
name|prot
parameter_list|,
name|bool
name|is_wc
parameter_list|,
name|struct
name|mlx5_uuar_info
modifier|*
name|uuari
parameter_list|,
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
parameter_list|)
block|{
name|unsigned
name|long
name|idx
decl_stmt|;
name|phys_addr_t
name|pfn
decl_stmt|;
if|if
condition|(
name|vma
operator|->
name|vm_end
operator|-
name|vma
operator|->
name|vm_start
operator|!=
name|PAGE_SIZE
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"wrong size, expected PAGE_SIZE(%ld) got %ld\n"
argument_list|,
operator|(
name|long
operator|)
name|PAGE_SIZE
argument_list|,
call|(
name|long
call|)
argument_list|(
name|vma
operator|->
name|vm_end
operator|-
name|vma
operator|->
name|vm_start
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|idx
operator|=
name|get_index
argument_list|(
name|vma
operator|->
name|vm_pgoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|uuari
operator|->
name|num_uars
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"wrong offset, idx:%ld num_uars:%d\n"
argument_list|,
name|idx
argument_list|,
name|uuari
operator|->
name|num_uars
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|pfn
operator|=
name|uar_index2pfn
argument_list|(
name|dev
argument_list|,
name|uuari
operator|->
name|uars
index|[
name|idx
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"uar idx 0x%lx, pfn 0x%llx\n"
argument_list|,
name|idx
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|pfn
argument_list|)
expr_stmt|;
name|vma
operator|->
name|vm_page_prot
operator|=
name|prot
expr_stmt|;
if|if
condition|(
name|io_remap_pfn_range
argument_list|(
name|vma
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|pfn
argument_list|,
name|PAGE_SIZE
argument_list|,
name|vma
operator|->
name|vm_page_prot
argument_list|)
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"io remap failed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EAGAIN
return|;
block|}
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"mapped %s at 0x%lx, PA 0x%llx\n"
argument_list|,
name|is_wc
condition|?
literal|"WC"
else|:
literal|"NC"
argument_list|,
operator|(
name|long
operator|)
name|vma
operator|->
name|vm_start
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|pfn
operator|<<
name|PAGE_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_mmap
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|ibcontext
parameter_list|,
name|struct
name|vm_area_struct
modifier|*
name|vma
parameter_list|)
block|{
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
init|=
name|to_mucontext
argument_list|(
name|ibcontext
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibcontext
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_uuar_info
modifier|*
name|uuari
init|=
operator|&
name|context
operator|->
name|uuari
decl_stmt|;
name|unsigned
name|long
name|command
decl_stmt|;
name|command
operator|=
name|get_command
argument_list|(
name|vma
operator|->
name|vm_pgoff
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|MLX5_IB_MMAP_REGULAR_PAGE
case|:
return|return
name|uar_mmap
argument_list|(
name|vma
argument_list|,
name|pgprot_writecombine
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
argument_list|,
name|true
argument_list|,
name|uuari
argument_list|,
name|dev
argument_list|,
name|context
argument_list|)
return|;
break|break;
case|case
name|MLX5_IB_MMAP_WC_PAGE
case|:
return|return
name|uar_mmap
argument_list|(
name|vma
argument_list|,
name|pgprot_writecombine
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
argument_list|,
name|true
argument_list|,
name|uuari
argument_list|,
name|dev
argument_list|,
name|context
argument_list|)
return|;
break|break;
case|case
name|MLX5_IB_MMAP_NC_PAGE
case|:
return|return
name|uar_mmap
argument_list|(
name|vma
argument_list|,
name|pgprot_noncached
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
argument_list|,
name|false
argument_list|,
name|uuari
argument_list|,
name|dev
argument_list|,
name|context
argument_list|)
return|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_pa_mkey
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|u32
modifier|*
name|key
parameter_list|,
name|u32
name|pdn
parameter_list|)
block|{
name|struct
name|mlx5_create_mkey_mbox_in
modifier|*
name|in
decl_stmt|;
name|struct
name|mlx5_mkey_seg
modifier|*
name|seg
decl_stmt|;
name|struct
name|mlx5_core_mr
name|mr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|in
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|seg
operator|=
operator|&
name|in
operator|->
name|seg
expr_stmt|;
name|seg
operator|->
name|flags
operator|=
name|MLX5_PERM_LOCAL_READ
operator||
name|MLX5_ACCESS_MODE_PA
expr_stmt|;
name|seg
operator|->
name|flags_pd
operator|=
name|cpu_to_be32
argument_list|(
name|pdn
operator||
name|MLX5_MKEY_LEN64
argument_list|)
expr_stmt|;
name|seg
operator|->
name|qpn_mkey7_0
operator|=
name|cpu_to_be32
argument_list|(
literal|0xffffff
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|seg
operator|->
name|start_addr
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|mlx5_core_create_mkey
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|mr
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to create mkey, %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|err_in
goto|;
block|}
name|kfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
operator|*
name|key
operator|=
name|mr
operator|.
name|key
expr_stmt|;
return|return
literal|0
return|;
name|err_in
label|:
name|kfree
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_pa_mkey
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|u32
name|key
parameter_list|)
block|{
name|struct
name|mlx5_core_mr
name|mr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|memset
argument_list|(
operator|&
name|mr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mr
argument_list|)
argument_list|)
expr_stmt|;
name|mr
operator|.
name|key
operator|=
name|key
expr_stmt|;
name|err
operator|=
name|mlx5_core_destroy_mkey
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to destroy mkey 0x%x\n"
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_pd
modifier|*
name|mlx5_ib_alloc_pd
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_ucontext
modifier|*
name|context
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_alloc_pd_resp
name|resp
decl_stmt|;
name|struct
name|mlx5_ib_pd
modifier|*
name|pd
decl_stmt|;
name|int
name|err
decl_stmt|;
name|pd
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pd
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|err
operator|=
name|mlx5_core_alloc_pd
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
operator|->
name|mdev
argument_list|,
operator|&
name|pd
operator|->
name|pdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"pd alloc failed\n"
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|pd
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
if|if
condition|(
name|context
condition|)
block|{
name|resp
operator|.
name|pdn
operator|=
name|pd
operator|->
name|pdn
expr_stmt|;
if|if
condition|(
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|resp
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|)
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"copy failed\n"
argument_list|)
expr_stmt|;
name|mlx5_core_dealloc_pd
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
operator|->
name|mdev
argument_list|,
name|pd
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|pd
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EFAULT
argument_list|)
return|;
block|}
block|}
else|else
block|{
name|err
operator|=
name|alloc_pa_mkey
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
argument_list|,
operator|&
name|pd
operator|->
name|pa_lkey
argument_list|,
name|pd
operator|->
name|pdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"alloc mkey failed\n"
argument_list|)
expr_stmt|;
name|mlx5_core_dealloc_pd
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
operator|->
name|mdev
argument_list|,
name|pd
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|pd
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
block|}
return|return
operator|&
name|pd
operator|->
name|ibpd
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_dealloc_pd
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|mdev
init|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_pd
modifier|*
name|mpd
init|=
name|to_mpd
argument_list|(
name|pd
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|pd
operator|->
name|uobject
condition|)
name|free_pa_mkey
argument_list|(
name|mdev
argument_list|,
name|mpd
operator|->
name|pa_lkey
argument_list|)
expr_stmt|;
name|mlx5_core_dealloc_pd
argument_list|(
name|mdev
operator|->
name|mdev
argument_list|,
name|mpd
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mpd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_mcg_attach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibqp
operator|->
name|device
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|ibqp
operator|->
name|qp_type
operator|==
name|IB_QPT_RAW_PACKET
condition|)
name|err
operator|=
operator|-
name|EOPNOTSUPP
expr_stmt|;
else|else
name|err
operator|=
name|mlx5_core_attach_mcg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|gid
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed attaching QPN 0x%x, MGID %pI6\n"
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|,
name|gid
operator|->
name|raw
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_mcg_detach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibqp
operator|->
name|device
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|ibqp
operator|->
name|qp_type
operator|==
name|IB_QPT_RAW_PACKET
condition|)
name|err
operator|=
operator|-
name|EOPNOTSUPP
expr_stmt|;
else|else
name|err
operator|=
name|mlx5_core_detach_mcg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|gid
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed detaching QPN 0x%x, MGID %pI6\n"
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|,
name|gid
operator|->
name|raw
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|init_node_data
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_query_node_desc
argument_list|(
name|dev
argument_list|,
name|dev
operator|->
name|ib_dev
operator|.
name|node_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
return|return
name|mlx5_query_node_guid
argument_list|(
name|dev
argument_list|,
operator|&
name|dev
operator|->
name|ib_dev
operator|.
name|node_guid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_fw_pages
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|fw_pages
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_reg_pages
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|atomic_read
argument_list|(
operator|&
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|reg_pages
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_hca
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"MT%d\n"
argument_list|,
name|dev
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|device
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_fw_ver
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d.%d.%04d\n"
argument_list|,
name|fw_rev_maj
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
argument_list|,
name|fw_rev_min
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
argument_list|,
name|fw_rev_sub
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_rev
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%x\n"
argument_list|,
operator|(
name|unsigned
operator|)
name|dev
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|revision
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_board
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%.*s\n"
argument_list|,
name|MLX5_BOARD_ID_LEN
argument_list|,
name|dev
operator|->
name|mdev
operator|->
name|board_id
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|hw_rev
argument_list|,
name|S_IRUGO
argument_list|,
name|show_rev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|fw_ver
argument_list|,
name|S_IRUGO
argument_list|,
name|show_fw_ver
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|hca_type
argument_list|,
name|S_IRUGO
argument_list|,
name|show_hca
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|board_id
argument_list|,
name|S_IRUGO
argument_list|,
name|show_board
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|fw_pages
argument_list|,
name|S_IRUGO
argument_list|,
name|show_fw_pages
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|reg_pages
argument_list|,
name|S_IRUGO
argument_list|,
name|show_reg_pages
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|device_attribute
modifier|*
name|mlx5_class_attributes
index|[]
init|=
block|{
operator|&
name|dev_attr_hw_rev
block|,
operator|&
name|dev_attr_fw_ver
block|,
operator|&
name|dev_attr_hca_type
block|,
operator|&
name|dev_attr_board_id
block|,
operator|&
name|dev_attr_fw_pages
block|,
operator|&
name|dev_attr_reg_pages
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|mlx5_ib_handle_internal_error
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|ibdev
parameter_list|)
block|{
name|struct
name|mlx5_ib_qp
modifier|*
name|mqp
decl_stmt|;
name|struct
name|mlx5_ib_cq
modifier|*
name|send_mcq
decl_stmt|,
modifier|*
name|recv_mcq
decl_stmt|;
name|struct
name|mlx5_core_cq
modifier|*
name|mcq
decl_stmt|;
name|struct
name|list_head
name|cq_armed_list
decl_stmt|;
name|unsigned
name|long
name|flags_qp
decl_stmt|;
name|unsigned
name|long
name|flags_cq
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|mlx5_ib_warn
argument_list|(
name|ibdev
argument_list|,
literal|" started\n"
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cq_armed_list
argument_list|)
expr_stmt|;
comment|/* Go over qp list reside on that ibdev, sync with create/destroy qp.*/
name|spin_lock_irqsave
argument_list|(
operator|&
name|ibdev
operator|->
name|reset_flow_resource_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|mqp
argument_list|,
argument|&ibdev->qp_list
argument_list|,
argument|qps_list
argument_list|)
block|{
name|spin_lock_irqsave
argument_list|(
operator|&
name|mqp
operator|->
name|sq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mqp
operator|->
name|sq
operator|.
name|tail
operator|!=
name|mqp
operator|->
name|sq
operator|.
name|head
condition|)
block|{
name|send_mcq
operator|=
name|to_mcq
argument_list|(
name|mqp
operator|->
name|ibqp
operator|.
name|send_cq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|send_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_mcq
operator|->
name|mcq
operator|.
name|comp
operator|&&
name|mqp
operator|->
name|ibqp
operator|.
name|send_cq
operator|->
name|comp_handler
condition|)
block|{
if|if
condition|(
operator|!
name|send_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
condition|)
block|{
name|send_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
operator|=
literal|1
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|send_mcq
operator|->
name|mcq
operator|.
name|reset_notify
argument_list|,
operator|&
name|cq_armed_list
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|send_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|mqp
operator|->
name|sq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|mqp
operator|->
name|rq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
comment|/* no handling is needed for SRQ */
if|if
condition|(
operator|!
name|mqp
operator|->
name|ibqp
operator|.
name|srq
condition|)
block|{
if|if
condition|(
name|mqp
operator|->
name|rq
operator|.
name|tail
operator|!=
name|mqp
operator|->
name|rq
operator|.
name|head
condition|)
block|{
name|recv_mcq
operator|=
name|to_mcq
argument_list|(
name|mqp
operator|->
name|ibqp
operator|.
name|recv_cq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|recv_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|recv_mcq
operator|->
name|mcq
operator|.
name|comp
operator|&&
name|mqp
operator|->
name|ibqp
operator|.
name|recv_cq
operator|->
name|comp_handler
condition|)
block|{
if|if
condition|(
operator|!
name|recv_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
condition|)
block|{
name|recv_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
operator|=
literal|1
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|recv_mcq
operator|->
name|mcq
operator|.
name|reset_notify
argument_list|,
operator|&
name|cq_armed_list
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|recv_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|mqp
operator|->
name|rq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
block|}
comment|/*At that point all inflight post send were put to be executed as of we 	 * lock/unlock above locks Now need to arm all involved CQs. 	 */
name|list_for_each_entry
argument_list|(
argument|mcq
argument_list|,
argument|&cq_armed_list
argument_list|,
argument|reset_notify
argument_list|)
block|{
name|mcq
operator|->
name|comp
argument_list|(
name|mcq
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ibdev
operator|->
name|reset_flow_resource_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|mlx5_ib_warn
argument_list|(
name|ibdev
argument_list|,
literal|" ended\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_event
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|enum
name|mlx5_dev_event
name|event
parameter_list|,
name|unsigned
name|long
name|param
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|ibdev
init|=
operator|(
expr|struct
name|mlx5_ib_dev
operator|*
operator|)
name|context
decl_stmt|;
name|struct
name|ib_event
name|ibev
decl_stmt|;
name|u8
name|port
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|MLX5_DEV_EVENT_SYS_ERROR
case|:
name|ibdev
operator|->
name|ib_active
operator|=
name|false
expr_stmt|;
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_DEVICE_FATAL
expr_stmt|;
name|mlx5_ib_handle_internal_error
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_PORT_UP
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_PORT_ACTIVE
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_PORT_DOWN
case|:
case|case
name|MLX5_DEV_EVENT_PORT_INITIALIZED
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_PORT_ERR
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_LID_CHANGE
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_LID_CHANGE
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_PKEY_CHANGE
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_PKEY_CHANGE
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_GUID_CHANGE
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_GID_CHANGE
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_CLIENT_REREG
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_CLIENT_REREGISTER
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|ibev
operator|.
name|device
operator|=
operator|&
name|ibdev
operator|->
name|ib_dev
expr_stmt|;
name|ibev
operator|.
name|element
operator|.
name|port_num
operator|=
name|port
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|!=
name|MLX5_DEV_EVENT_SYS_ERROR
operator|)
operator|&&
operator|(
name|port
operator|<
literal|1
operator|||
name|port
operator|>
name|ibdev
operator|->
name|num_ports
operator|)
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|ibdev
argument_list|,
literal|"warning: event on port %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ibdev
operator|->
name|ib_active
condition|)
name|ib_dispatch_event
argument_list|(
operator|&
name|ibev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_ext_port_caps
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|port
decl_stmt|;
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
condition|;
name|port
operator|++
control|)
name|mlx5_query_ext_port_caps
argument_list|(
name|dev
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|config_atomic_responder
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|ib_device_attr
modifier|*
name|props
parameter_list|)
block|{
name|enum
name|ib_atomic_cap
name|cap
init|=
name|props
operator|->
name|atomic_cap
decl_stmt|;
if|#
directive|if
literal|0
block|if (cap == IB_ATOMIC_HCA || 	    cap == IB_ATOMIC_GLOB)
endif|#
directive|endif
name|dev
operator|->
name|enable_atomic_resp
operator|=
literal|1
expr_stmt|;
name|dev
operator|->
name|atomic_cap
operator|=
name|cap
expr_stmt|;
block|}
end_function

begin_enum
enum|enum
name|mlx5_addr_align
block|{
name|MLX5_ADDR_ALIGN_0
init|=
literal|0
block|,
name|MLX5_ADDR_ALIGN_64
init|=
literal|64
block|,
name|MLX5_ADDR_ALIGN_128
init|=
literal|128
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|get_port_caps
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|ib_device_attr
modifier|*
name|dprops
init|=
name|NULL
decl_stmt|;
name|struct
name|ib_port_attr
modifier|*
name|pprops
init|=
name|NULL
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOMEM
decl_stmt|;
name|int
name|port
decl_stmt|;
name|pprops
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pprops
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pprops
condition|)
goto|goto
name|out
goto|;
name|dprops
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dprops
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dprops
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|mlx5_ib_query_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|dprops
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"query_device failed %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|config_atomic_responder
argument_list|(
name|dev
argument_list|,
name|dprops
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
condition|;
name|port
operator|++
control|)
block|{
name|err
operator|=
name|mlx5_ib_query_port
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|port
argument_list|,
name|pprops
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"query_port %d failed %d\n"
argument_list|,
name|port
argument_list|,
name|err
argument_list|)
expr_stmt|;
break|break;
block|}
name|dev
operator|->
name|mdev
operator|->
name|port_caps
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|pkey_table_len
operator|=
name|dprops
operator|->
name|max_pkeys
expr_stmt|;
name|dev
operator|->
name|mdev
operator|->
name|port_caps
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|gid_table_len
operator|=
name|pprops
operator|->
name|gid_tbl_len
expr_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"pkey_table_len %d, gid_table_len %d\n"
argument_list|,
name|dprops
operator|->
name|max_pkeys
argument_list|,
name|pprops
operator|->
name|gid_tbl_len
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|kfree
argument_list|(
name|pprops
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dprops
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy_umrc_res
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_mr_cache_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"mr cache cleanup failed\n"
argument_list|)
expr_stmt|;
name|ib_dereg_mr
argument_list|(
name|dev
operator|->
name|umrc
operator|.
name|mr
argument_list|)
expr_stmt|;
name|ib_dealloc_pd
argument_list|(
name|dev
operator|->
name|umrc
operator|.
name|pd
argument_list|)
expr_stmt|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MAX_UMR_WR
init|=
literal|128
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|create_umr_res
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|ib_pd
modifier|*
name|pd
decl_stmt|;
name|struct
name|ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pd
operator|=
name|ib_alloc_pd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|pd
argument_list|)
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't create PD for sync UMR QP\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|pd
argument_list|)
expr_stmt|;
goto|goto
name|error_0
goto|;
block|}
name|mr
operator|=
name|ib_get_dma_mr
argument_list|(
name|pd
argument_list|,
name|IB_ACCESS_LOCAL_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mr
argument_list|)
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't create DMA MR for sync UMR QP\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|mr
argument_list|)
expr_stmt|;
goto|goto
name|error_1
goto|;
block|}
name|dev
operator|->
name|umrc
operator|.
name|mr
operator|=
name|mr
expr_stmt|;
name|dev
operator|->
name|umrc
operator|.
name|pd
operator|=
name|pd
expr_stmt|;
name|ret
operator|=
name|mlx5_mr_cache_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"mr cache init failed %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error_4
goto|;
block|}
return|return
literal|0
return|;
name|error_4
label|:
name|ib_dereg_mr
argument_list|(
name|mr
argument_list|)
expr_stmt|;
name|error_1
label|:
name|ib_dealloc_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|error_0
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|create_dev_resources
parameter_list|(
name|struct
name|mlx5_ib_resources
modifier|*
name|devr
parameter_list|)
block|{
name|struct
name|ib_srq_init_attr
name|attr
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|ib_cq_init_attr
name|cq_attr
init|=
block|{
operator|.
name|cqe
operator|=
literal|1
block|}
decl_stmt|;
name|dev
operator|=
name|container_of
argument_list|(
name|devr
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|devr
argument_list|)
expr_stmt|;
name|devr
operator|->
name|p0
operator|=
name|mlx5_ib_alloc_pd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|devr
operator|->
name|p0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|p0
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|p0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|devr
operator|->
name|c0
operator|=
name|mlx5_ib_create_cq
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
operator|&
name|cq_attr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
expr_stmt|;
goto|goto
name|error1
goto|;
block|}
name|devr
operator|->
name|c0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|comp_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|event_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|cq_context
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|c0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|devr
operator|->
name|x0
operator|=
name|mlx5_ib_alloc_xrcd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
expr_stmt|;
goto|goto
name|error2
goto|;
block|}
name|devr
operator|->
name|x0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|x0
operator|->
name|inode
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|x0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|devr
operator|->
name|x0
operator|->
name|tgt_qp_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|devr
operator|->
name|x0
operator|->
name|tgt_qp_list
argument_list|)
expr_stmt|;
name|devr
operator|->
name|x1
operator|=
name|mlx5_ib_alloc_xrcd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
expr_stmt|;
goto|goto
name|error3
goto|;
block|}
name|devr
operator|->
name|x1
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|x1
operator|->
name|inode
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|x1
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|devr
operator|->
name|x1
operator|->
name|tgt_qp_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|devr
operator|->
name|x1
operator|->
name|tgt_qp_list
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_sge
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_wr
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|srq_type
operator|=
name|IB_SRQT_XRC
expr_stmt|;
name|attr
operator|.
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|=
name|devr
operator|->
name|c0
expr_stmt|;
name|attr
operator|.
name|ext
operator|.
name|xrc
operator|.
name|xrcd
operator|=
name|devr
operator|->
name|x0
expr_stmt|;
name|devr
operator|->
name|s0
operator|=
name|mlx5_ib_create_srq
argument_list|(
name|devr
operator|->
name|p0
argument_list|,
operator|&
name|attr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
expr_stmt|;
goto|goto
name|error4
goto|;
block|}
name|devr
operator|->
name|s0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|pd
operator|=
name|devr
operator|->
name|p0
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|event_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|srq_context
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|srq_type
operator|=
name|IB_SRQT_XRC
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|xrcd
operator|=
name|devr
operator|->
name|x0
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|=
name|devr
operator|->
name|c0
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|xrcd
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|p0
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|s0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_sge
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_wr
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|srq_type
operator|=
name|IB_SRQT_BASIC
expr_stmt|;
name|devr
operator|->
name|s1
operator|=
name|mlx5_ib_create_srq
argument_list|(
name|devr
operator|->
name|p0
argument_list|,
operator|&
name|attr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|s1
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|s1
argument_list|)
expr_stmt|;
goto|goto
name|error5
goto|;
block|}
name|devr
operator|->
name|s1
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|pd
operator|=
name|devr
operator|->
name|p0
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|event_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|srq_context
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|srq_type
operator|=
name|IB_SRQT_BASIC
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|=
name|devr
operator|->
name|c0
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|p0
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|s1
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|error5
label|:
name|mlx5_ib_destroy_srq
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
expr_stmt|;
name|error4
label|:
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
expr_stmt|;
name|error3
label|:
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
expr_stmt|;
name|error2
label|:
name|mlx5_ib_destroy_cq
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
expr_stmt|;
name|error1
label|:
name|mlx5_ib_dealloc_pd
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
expr_stmt|;
name|error0
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy_dev_resources
parameter_list|(
name|struct
name|mlx5_ib_resources
modifier|*
name|devr
parameter_list|)
block|{
name|mlx5_ib_destroy_srq
argument_list|(
name|devr
operator|->
name|s1
argument_list|)
expr_stmt|;
name|mlx5_ib_destroy_srq
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
expr_stmt|;
name|mlx5_ib_destroy_cq
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_pd
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|enable_dc_tracer
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|device
modifier|*
name|device
init|=
name|dev
operator|->
name|ib_dev
operator|.
name|dma_device
decl_stmt|;
name|struct
name|mlx5_dc_tracer
modifier|*
name|dct
init|=
operator|&
name|dev
operator|->
name|dctr
decl_stmt|;
name|int
name|order
decl_stmt|;
name|void
modifier|*
name|tmp
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|err
decl_stmt|;
name|size
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
operator|*
literal|4096
expr_stmt|;
if|if
condition|(
name|size
operator|<=
name|PAGE_SIZE
condition|)
name|order
operator|=
literal|0
expr_stmt|;
else|else
name|order
operator|=
literal|1
expr_stmt|;
name|dct
operator|->
name|pg
operator|=
name|alloc_pages
argument_list|(
name|GFP_KERNEL
argument_list|,
name|order
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dct
operator|->
name|pg
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"failed to allocate %d pages\n"
argument_list|,
name|order
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmp
operator|=
name|page_address
argument_list|(
name|dct
operator|->
name|pg
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|tmp
argument_list|,
literal|0xff
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|dct
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|dct
operator|->
name|order
operator|=
name|order
expr_stmt|;
name|dct
operator|->
name|dma
operator|=
name|dma_map_page
argument_list|(
name|device
argument_list|,
name|dct
operator|->
name|pg
argument_list|,
literal|0
argument_list|,
name|size
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dma_mapping_error
argument_list|(
name|device
argument_list|,
name|dct
operator|->
name|dma
argument_list|)
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"dma mapping error\n"
argument_list|)
expr_stmt|;
goto|goto
name|map_err
goto|;
block|}
name|err
operator|=
name|mlx5_core_set_dc_cnak_trace
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
literal|1
argument_list|,
name|dct
operator|->
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to enable DC tracer\n"
argument_list|)
expr_stmt|;
goto|goto
name|cmd_err
goto|;
block|}
return|return;
name|cmd_err
label|:
name|dma_unmap_page
argument_list|(
name|device
argument_list|,
name|dct
operator|->
name|dma
argument_list|,
name|size
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
name|map_err
label|:
name|__free_pages
argument_list|(
name|dct
operator|->
name|pg
argument_list|,
name|dct
operator|->
name|order
argument_list|)
expr_stmt|;
name|dct
operator|->
name|pg
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|disable_dc_tracer
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|device
modifier|*
name|device
init|=
name|dev
operator|->
name|ib_dev
operator|.
name|dma_device
decl_stmt|;
name|struct
name|mlx5_dc_tracer
modifier|*
name|dct
init|=
operator|&
name|dev
operator|->
name|dctr
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|!
name|dct
operator|->
name|pg
condition|)
return|return;
name|err
operator|=
name|mlx5_core_set_dc_cnak_trace
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
literal|0
argument_list|,
name|dct
operator|->
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to disable DC tracer\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dma_unmap_page
argument_list|(
name|device
argument_list|,
name|dct
operator|->
name|dma
argument_list|,
name|dct
operator|->
name|size
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
name|__free_pages
argument_list|(
name|dct
operator|->
name|pg
argument_list|,
name|dct
operator|->
name|order
argument_list|)
expr_stmt|;
name|dct
operator|->
name|pg
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MLX5_DC_CNAK_SIZE
init|=
literal|128
block|,
name|MLX5_NUM_BUF_IN_PAGE
init|=
name|PAGE_SIZE
operator|/
name|MLX5_DC_CNAK_SIZE
block|,
name|MLX5_CNAK_TX_CQ_SIGNAL_FACTOR
init|=
literal|128
block|,
name|MLX5_DC_CNAK_SL
init|=
literal|0
block|,
name|MLX5_DC_CNAK_VL
init|=
literal|0
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|init_dc_improvements
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|mlx5_core_is_pf
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|dc_cnak_trace
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
name|enable_dc_tracer
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cleanup_dc_improvements
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|disable_dc_tracer
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_dealloc_q_port_counter
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|mlx5_vport_dealloc_q_counter
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_IB
argument_list|,
name|dev
operator|->
name|port
index|[
name|port_num
index|]
operator|.
name|q_cnt_id
argument_list|)
expr_stmt|;
name|dev
operator|->
name|port
index|[
name|port_num
index|]
operator|.
name|q_cnt_id
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_dealloc_q_counters
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
name|mlx5_ib_dealloc_q_port_counter
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_alloc_q_counters
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|mlx5_vport_alloc_q_counter
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_IB
argument_list|,
operator|&
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|q_cnt_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"couldn't allocate queue counter for port %d\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|dealloc_counters
goto|;
block|}
block|}
return|return
literal|0
return|;
name|dealloc_counters
label|:
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|mlx5_ib_dealloc_q_port_counter
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_struct
struct|struct
name|port_attribute
block|{
name|struct
name|attribute
name|attr
decl_stmt|;
name|ssize_t
function_decl|(
modifier|*
name|show
function_decl|)
parameter_list|(
name|struct
name|mlx5_ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
function_decl|;
name|ssize_t
function_decl|(
modifier|*
name|store
function_decl|)
parameter_list|(
name|struct
name|mlx5_ib_port
modifier|*
parameter_list|,
name|struct
name|port_attribute
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|count
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|port_counter_attribute
block|{
name|struct
name|port_attribute
name|attr
decl_stmt|;
name|size_t
name|offset
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|ssize_t
name|port_attr_show
parameter_list|(
name|struct
name|kobject
modifier|*
name|kobj
parameter_list|,
name|struct
name|attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|port_attribute
modifier|*
name|port_attr
init|=
name|container_of
argument_list|(
name|attr
argument_list|,
expr|struct
name|port_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_port_sysfs_group
modifier|*
name|p
init|=
name|container_of
argument_list|(
name|kobj
argument_list|,
expr|struct
name|mlx5_ib_port_sysfs_group
argument_list|,
name|kobj
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_port
modifier|*
name|mibport
init|=
name|container_of
argument_list|(
name|p
argument_list|,
expr|struct
name|mlx5_ib_port
argument_list|,
name|group
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|port_attr
operator|->
name|show
condition|)
return|return
operator|-
name|EIO
return|;
return|return
name|port_attr
operator|->
name|show
argument_list|(
name|mibport
argument_list|,
name|port_attr
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_port_counter
parameter_list|(
name|struct
name|mlx5_ib_port
modifier|*
name|p
parameter_list|,
name|struct
name|port_attribute
modifier|*
name|port_attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|outlen
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|query_q_counter_out
argument_list|)
decl_stmt|;
name|struct
name|port_counter_attribute
modifier|*
name|counter_attr
init|=
name|container_of
argument_list|(
name|port_attr
argument_list|,
expr|struct
name|port_counter_attribute
argument_list|,
name|attr
argument_list|)
decl_stmt|;
name|void
modifier|*
name|out
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|out
operator|=
name|mlx5_vzalloc
argument_list|(
name|outlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|ret
operator|=
name|mlx5_vport_query_q_counter
argument_list|(
name|p
operator|->
name|dev
operator|->
name|mdev
argument_list|,
name|p
operator|->
name|q_cnt_id
argument_list|,
literal|0
argument_list|,
name|out
argument_list|,
name|outlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
name|ret
operator|=
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|be32_to_cpu
argument_list|(
operator|*
operator|(
name|__be32
operator|*
operator|)
operator|(
name|out
operator|+
name|counter_attr
operator|->
name|offset
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|free
label|:
name|kfree
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PORT_COUNTER_ATTR
parameter_list|(
name|_name
parameter_list|)
define|\
value|struct port_counter_attribute port_counter_attr_##_name = {		\ 	.attr  = __ATTR(_name, S_IRUGO, show_port_counter, NULL),	\ 	.offset = MLX5_BYTE_OFF(query_q_counter_out, _name)		\ }
end_define

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|rx_write_requests
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|rx_read_requests
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|rx_atomic_requests
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|rx_dct_connect
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|out_of_buffer
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|out_of_sequence
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|duplicate_request
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|rnr_nak_retry_err
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|packet_seq_err
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|implied_nak_seq_err
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|PORT_COUNTER_ATTR
argument_list|(
name|local_ack_timeout_err
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute
modifier|*
name|counter_attrs
index|[]
init|=
block|{
operator|&
name|port_counter_attr_rx_write_requests
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_rx_read_requests
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_rx_atomic_requests
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_rx_dct_connect
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_out_of_buffer
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_out_of_sequence
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_duplicate_request
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_rnr_nak_retry_err
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_packet_seq_err
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_implied_nak_seq_err
operator|.
name|attr
operator|.
name|attr
block|,
operator|&
name|port_counter_attr_local_ack_timeout_err
operator|.
name|attr
operator|.
name|attr
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|attribute_group
name|port_counters_group
init|=
block|{
operator|.
name|name
operator|=
literal|"counters"
block|,
operator|.
name|attrs
operator|=
name|counter_attrs
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|sysfs_ops
name|port_sysfs_ops
init|=
block|{
operator|.
name|show
operator|=
name|port_attr_show
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|kobj_type
name|port_type
init|=
block|{
operator|.
name|sysfs_ops
operator|=
operator|&
name|port_sysfs_ops
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|add_port_attrs
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|kobject
modifier|*
name|parent
parameter_list|,
name|struct
name|mlx5_ib_port_sysfs_group
modifier|*
name|port
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|kobject_init_and_add
argument_list|(
operator|&
name|port
operator|->
name|kobj
argument_list|,
operator|&
name|port_type
argument_list|,
name|parent
argument_list|,
literal|"%d"
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|out_of_seq_cnt
argument_list|)
operator|&&
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|retransmission_q_counters
argument_list|)
condition|)
block|{
name|ret
operator|=
name|sysfs_create_group
argument_list|(
operator|&
name|port
operator|->
name|kobj
argument_list|,
operator|&
name|port_counters_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|put_kobj
goto|;
block|}
name|port
operator|->
name|enabled
operator|=
name|true
expr_stmt|;
return|return
name|ret
return|;
name|put_kobj
label|:
name|kobject_put
argument_list|(
operator|&
name|port
operator|->
name|kobj
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy_ports_attrs
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|unsigned
name|int
name|num_ports
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|mlx5_ib_port_sysfs_group
modifier|*
name|port
init|=
operator|&
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|group
decl_stmt|;
if|if
condition|(
operator|!
name|port
operator|->
name|enabled
condition|)
continue|continue;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|out_of_seq_cnt
argument_list|)
operator|&&
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|retransmission_q_counters
argument_list|)
condition|)
name|sysfs_remove_group
argument_list|(
operator|&
name|port
operator|->
name|kobj
argument_list|,
operator|&
name|port_counters_group
argument_list|)
expr_stmt|;
name|kobject_put
argument_list|(
operator|&
name|port
operator|->
name|kobj
argument_list|)
expr_stmt|;
name|port
operator|->
name|enabled
operator|=
name|false
expr_stmt|;
block|}
if|if
condition|(
name|dev
operator|->
name|ports_parent
condition|)
block|{
name|kobject_put
argument_list|(
name|dev
operator|->
name|ports_parent
argument_list|)
expr_stmt|;
name|dev
operator|->
name|ports_parent
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|create_port_attrs
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
init|=
literal|0
decl_stmt|;
name|struct
name|device
modifier|*
name|device
init|=
operator|&
name|dev
operator|->
name|ib_dev
operator|.
name|dev
decl_stmt|;
name|dev
operator|->
name|ports_parent
operator|=
name|kobject_create_and_add
argument_list|(
literal|"mlx5_ports"
argument_list|,
operator|&
name|device
operator|->
name|kobj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|ports_parent
condition|)
return|return
operator|-
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|add_port_attrs
argument_list|(
name|dev
argument_list|,
name|dev
operator|->
name|ports_parent
argument_list|,
operator|&
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|group
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|_destroy_ports_attrs
goto|;
block|}
return|return
literal|0
return|;
name|_destroy_ports_attrs
label|:
name|destroy_ports_attrs
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|mlx5_ib_add
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printk_once
argument_list|(
name|KERN_INFO
literal|"%s"
argument_list|,
name|mlx5_version
argument_list|)
expr_stmt|;
name|dev
operator|=
operator|(
expr|struct
name|mlx5_ib_dev
operator|*
operator|)
name|ib_alloc_device
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
return|return
name|NULL
return|;
name|dev
operator|->
name|mdev
operator|=
name|mdev
expr_stmt|;
name|dev
operator|->
name|port
operator|=
name|kcalloc
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dev
operator|->
name|port
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|port
condition|)
goto|goto
name|err_dealloc
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|dev
operator|=
name|dev
expr_stmt|;
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|port_num
operator|=
name|i
expr_stmt|;
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|port_gone
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|gid_table
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|gid_table
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|get_port_caps
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_port
goto|;
if|if
condition|(
name|mlx5_use_mad_ifc
argument_list|(
name|dev
argument_list|)
condition|)
name|get_ext_port_caps
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
block|{
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|roce
argument_list|)
condition|)
block|{
name|err
operator|=
name|mlx5_nic_vport_enable_roce
argument_list|(
name|mdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_port
goto|;
block|}
else|else
block|{
goto|goto
name|err_free_port
goto|;
block|}
block|}
name|MLX5_INIT_DOORBELL_LOCK
argument_list|(
operator|&
name|dev
operator|->
name|uar_lock
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|dev
operator|->
name|ib_dev
operator|.
name|name
argument_list|,
literal|"mlx5_%d"
argument_list|,
name|IB_DEVICE_NAME_MAX
argument_list|)
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|owner
operator|=
name|THIS_MODULE
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|node_type
operator|=
name|RDMA_NODE_IB_CA
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|local_dma_lkey
operator|=
name|mdev
operator|->
name|special_contexts
operator|.
name|resd_lkey
expr_stmt|;
name|dev
operator|->
name|num_ports
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|phys_port_cnt
operator|=
name|dev
operator|->
name|num_ports
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|num_comp_vectors
operator|=
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|eq_table
operator|.
name|num_comp_vectors
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dma_device
operator|=
operator|&
name|mdev
operator|->
name|pdev
operator|->
name|dev
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_abi_ver
operator|=
name|MLX5_IB_UVERBS_ABI_VERSION
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_cmd_mask
operator|=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_GET_CONTEXT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_DEVICE
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_PORT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_ALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_REG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEREG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_RESIZE_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_MODIFY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_ATTACH_MCAST
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DETACH_MCAST
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_MODIFY_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_XSRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_OPEN_QP
operator|)
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_device
operator|=
name|mlx5_ib_query_device
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_port
operator|=
name|mlx5_ib_query_port
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_link_layer
operator|=
name|mlx5_ib_port_link_layer
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_netdev
operator|=
name|mlx5_ib_get_netdev
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_gid
operator|=
name|mlx5_ib_query_gid
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_pkey
operator|=
name|mlx5_ib_query_pkey
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_device
operator|=
name|mlx5_ib_modify_device
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_port
operator|=
name|mlx5_ib_modify_port
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_ucontext
operator|=
name|mlx5_ib_alloc_ucontext
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dealloc_ucontext
operator|=
name|mlx5_ib_dealloc_ucontext
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|mmap
operator|=
name|mlx5_ib_mmap
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_pd
operator|=
name|mlx5_ib_alloc_pd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dealloc_pd
operator|=
name|mlx5_ib_dealloc_pd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_ah
operator|=
name|mlx5_ib_create_ah
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_ah
operator|=
name|mlx5_ib_query_ah
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_ah
operator|=
name|mlx5_ib_destroy_ah
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_srq
operator|=
name|mlx5_ib_create_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_srq
operator|=
name|mlx5_ib_modify_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_srq
operator|=
name|mlx5_ib_query_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_srq
operator|=
name|mlx5_ib_destroy_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|post_srq_recv
operator|=
name|mlx5_ib_post_srq_recv
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_qp
operator|=
name|mlx5_ib_create_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_qp
operator|=
name|mlx5_ib_modify_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_qp
operator|=
name|mlx5_ib_query_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_qp
operator|=
name|mlx5_ib_destroy_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|post_send
operator|=
name|mlx5_ib_post_send
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|post_recv
operator|=
name|mlx5_ib_post_recv
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_cq
operator|=
name|mlx5_ib_create_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_cq
operator|=
name|mlx5_ib_modify_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|resize_cq
operator|=
name|mlx5_ib_resize_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_cq
operator|=
name|mlx5_ib_destroy_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|poll_cq
operator|=
name|mlx5_ib_poll_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|req_notify_cq
operator|=
name|mlx5_ib_arm_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_dma_mr
operator|=
name|mlx5_ib_get_dma_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|reg_user_mr
operator|=
name|mlx5_ib_reg_user_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|reg_phys_mr
operator|=
name|mlx5_ib_reg_phys_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dereg_mr
operator|=
name|mlx5_ib_dereg_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|attach_mcast
operator|=
name|mlx5_ib_mcg_attach
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|detach_mcast
operator|=
name|mlx5_ib_mcg_detach
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|process_mad
operator|=
name|mlx5_ib_process_mad
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_fast_reg_mr
operator|=
name|mlx5_ib_alloc_fast_reg_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_fast_reg_page_list
operator|=
name|mlx5_ib_alloc_fast_reg_page_list
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|free_fast_reg_page_list
operator|=
name|mlx5_ib_free_fast_reg_page_list
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|xrc
argument_list|)
condition|)
block|{
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_xrcd
operator|=
name|mlx5_ib_alloc_xrcd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dealloc_xrcd
operator|=
name|mlx5_ib_dealloc_xrcd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_cmd_mask
operator||=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_OPEN_XRCD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CLOSE_XRCD
operator|)
expr_stmt|;
block|}
name|err
operator|=
name|init_node_data
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_disable_roce
goto|;
name|mutex_init
argument_list|(
operator|&
name|dev
operator|->
name|cap_mask_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|dev
operator|->
name|qp_list
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|dev
operator|->
name|reset_flow_resource_lock
argument_list|)
expr_stmt|;
name|err
operator|=
name|create_dev_resources
argument_list|(
operator|&
name|dev
operator|->
name|devr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_disable_roce
goto|;
name|err
operator|=
name|mlx5_ib_alloc_q_counters
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_odp
goto|;
name|err
operator|=
name|ib_register_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_q_cnt
goto|;
name|err
operator|=
name|create_umr_res
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_dev
goto|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port_type
argument_list|)
operator|==
name|MLX5_CAP_PORT_TYPE_IB
condition|)
block|{
if|if
condition|(
name|init_dc_improvements
argument_list|(
name|dev
argument_list|)
condition|)
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"init_dc_improvements - continuing\n"
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|create_port_attrs
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_dc
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|mlx5_class_attributes
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|device_create_file
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
operator|.
name|dev
argument_list|,
name|mlx5_class_attributes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_port_attrs
goto|;
block|}
if|if
condition|(
literal|1
condition|)
block|{
name|struct
name|thread
modifier|*
name|rl_thread
init|=
name|NULL
decl_stmt|;
name|struct
name|proc
modifier|*
name|rl_proc
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|kproc_kthread_add
argument_list|(
name|mlx5_ib_roce_port_update
argument_list|,
name|dev
operator|->
name|port
operator|+
name|i
argument_list|,
operator|&
name|rl_proc
argument_list|,
operator|&
name|rl_thread
argument_list|,
name|RFHIGHPID
argument_list|,
literal|0
argument_list|,
literal|"mlx5-ib-roce-port"
argument_list|,
literal|"mlx5-ib-roce_port-%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|dev
operator|->
name|ib_active
operator|=
name|true
expr_stmt|;
return|return
name|dev
return|;
name|err_port_attrs
label|:
name|destroy_ports_attrs
argument_list|(
name|dev
argument_list|,
name|dev
operator|->
name|num_ports
argument_list|)
expr_stmt|;
name|err_dc
label|:
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port_type
argument_list|)
operator|==
name|MLX5_CAP_PORT_TYPE_IB
condition|)
name|cleanup_dc_improvements
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|destroy_umrc_res
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_dev
label|:
name|ib_unregister_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
expr_stmt|;
name|err_q_cnt
label|:
name|mlx5_ib_dealloc_q_counters
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_odp
label|:
name|destroy_dev_resources
argument_list|(
operator|&
name|dev
operator|->
name|devr
argument_list|)
expr_stmt|;
name|err_disable_roce
label|:
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
operator|&&
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|roce
argument_list|)
condition|)
name|mlx5_nic_vport_disable_roce
argument_list|(
name|mdev
argument_list|)
expr_stmt|;
name|err_free_port
label|:
name|kfree
argument_list|(
name|dev
operator|->
name|port
argument_list|)
expr_stmt|;
name|err_dealloc
label|:
name|ib_dealloc_device
argument_list|(
operator|(
expr|struct
name|ib_device
operator|*
operator|)
name|dev
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_remove
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|context
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|port_gone
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|port_gone
operator|!=
literal|2
condition|)
name|pause
argument_list|(
literal|"W"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|mlx5_class_attributes
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|device_remove_file
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
operator|.
name|dev
argument_list|,
name|mlx5_class_attributes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|destroy_ports_attrs
argument_list|(
name|dev
argument_list|,
name|dev
operator|->
name|num_ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port_type
argument_list|)
operator|==
name|MLX5_CAP_PORT_TYPE_IB
condition|)
name|cleanup_dc_improvements
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_q_counters
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ib_unregister_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
expr_stmt|;
name|destroy_umrc_res
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|destroy_dev_resources
argument_list|(
operator|&
name|dev
operator|->
name|devr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
operator|&&
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|roce
argument_list|)
condition|)
name|mlx5_nic_vport_disable_roce
argument_list|(
name|mdev
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dev
operator|->
name|port
argument_list|)
expr_stmt|;
name|ib_dealloc_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|mlx5_interface
name|mlx5_ib_interface
init|=
block|{
operator|.
name|add
operator|=
name|mlx5_ib_add
block|,
operator|.
name|remove
operator|=
name|mlx5_ib_remove
block|,
operator|.
name|event
operator|=
name|mlx5_ib_event
block|,
operator|.
name|protocol
operator|=
name|MLX5_INTERFACE_PROTOCOL_IB
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|__init
name|mlx5_ib_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
name|deprecated_prof_sel
operator|!=
literal|2
condition|)
name|printf
argument_list|(
literal|"mlx5_ib: WARN: "
literal|"prof_sel is deprecated for mlx5_ib, set it for mlx5_core\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_register_interface
argument_list|(
operator|&
name|mlx5_ib_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|clean_odp
goto|;
name|mlx5_ib_wq
operator|=
name|create_singlethread_workqueue
argument_list|(
literal|"mlx5_ib_wq"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mlx5_ib_wq
condition|)
block|{
name|printf
argument_list|(
literal|"mlx5_ib: ERR: "
literal|"%s: failed to create mlx5_ib_wq\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|err_unreg
goto|;
block|}
return|return
name|err
return|;
name|err_unreg
label|:
name|mlx5_unregister_interface
argument_list|(
operator|&
name|mlx5_ib_interface
argument_list|)
expr_stmt|;
name|clean_odp
label|:
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__exit
name|mlx5_ib_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|destroy_workqueue
argument_list|(
name|mlx5_ib_wq
argument_list|)
expr_stmt|;
name|mlx5_unregister_interface
argument_list|(
operator|&
name|mlx5_ib_interface
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|module_init_order
argument_list|(
name|mlx5_ib_init
argument_list|,
name|SI_ORDER_THIRD
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_exit_order
argument_list|(
name|mlx5_ib_cleanup
argument_list|,
name|SI_ORDER_THIRD
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


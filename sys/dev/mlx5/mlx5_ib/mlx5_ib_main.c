begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013-2015, Mellanox Technologies, Ltd.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS `AS IS' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/pci.h>
end_include

begin_include
include|#
directive|include
file|<linux/dma-mapping.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_X86
argument_list|)
end_if

begin_include
include|#
directive|include
file|<asm/pat.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<linux/sched.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|<linux/fs.h>
end_include

begin_undef
undef|#
directive|undef
name|inode
end_undef

begin_include
include|#
directive|include
file|<rdma/ib_user_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_addr.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_cache.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/vport.h>
end_include

begin_include
include|#
directive|include
file|<linux/list.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_smi.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<linux/in.h>
end_include

begin_include
include|#
directive|include
file|<linux/etherdevice.h>
end_include

begin_include
include|#
directive|include
file|<dev/mlx5/fs.h>
end_include

begin_include
include|#
directive|include
file|"mlx5_ib.h"
end_include

begin_define
define|#
directive|define
name|DRIVER_NAME
value|"mlx5_ib"
end_define

begin_define
define|#
directive|define
name|DRIVER_VERSION
value|"3.4.1-BETA"
end_define

begin_define
define|#
directive|define
name|DRIVER_RELDATE
value|"October 2017"
end_define

begin_expr_stmt
name|MODULE_DESCRIPTION
argument_list|(
literal|"Mellanox Connect-IB HCA IB driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_LICENSE
argument_list|(
literal|"Dual BSD/GPL"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5ib
argument_list|,
name|linuxkpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5ib
argument_list|,
name|mlx5
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|mlx5ib
argument_list|,
name|ibcore
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|mlx5ib
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|deprecated_prof_sel
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|prof_sel
argument_list|,
name|deprecated_prof_sel
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|prof_sel
argument_list|,
literal|"profile selector. Deprecated here. Moved to module mlx5_core"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|mlx5_version
index|[]
init|=
name|DRIVER_NAME
literal|": Mellanox Connect-IB Infiniband driver v"
name|DRIVER_VERSION
literal|" ("
name|DRIVER_RELDATE
literal|")\n"
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
block|{
name|MLX5_ATOMIC_SIZE_QP_8BYTES
init|=
literal|1
operator|<<
literal|3
block|, }
enum|;
end_enum

begin_function
specifier|static
name|enum
name|rdma_link_layer
name|mlx5_port_type_cap_to_rdma_ll
parameter_list|(
name|int
name|port_type_cap
parameter_list|)
block|{
switch|switch
condition|(
name|port_type_cap
condition|)
block|{
case|case
name|MLX5_CAP_PORT_TYPE_IB
case|:
return|return
name|IB_LINK_LAYER_INFINIBAND
return|;
case|case
name|MLX5_CAP_PORT_TYPE_ETH
case|:
return|return
name|IB_LINK_LAYER_ETHERNET
return|;
default|default:
return|return
name|IB_LINK_LAYER_UNSPECIFIED
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|enum
name|rdma_link_layer
name|mlx5_ib_port_link_layer
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|device
argument_list|)
decl_stmt|;
name|int
name|port_type_cap
init|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port_type
argument_list|)
decl_stmt|;
return|return
name|mlx5_port_type_cap_to_rdma_ll
argument_list|(
name|port_type_cap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|mlx5_netdev_match
parameter_list|(
name|struct
name|net_device
modifier|*
name|ndev
parameter_list|,
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|,
specifier|const
name|char
modifier|*
name|dname
parameter_list|)
block|{
return|return
name|ndev
operator|->
name|if_type
operator|==
name|IFT_ETHER
operator|&&
name|ndev
operator|->
name|if_dname
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|ndev
operator|->
name|if_dname
argument_list|,
name|dname
argument_list|)
operator|==
literal|0
operator|&&
name|ndev
operator|->
name|if_softc
operator|!=
name|NULL
operator|&&
operator|*
operator|(
expr|struct
name|mlx5_core_dev
operator|*
operator|*
operator|)
name|ndev
operator|->
name|if_softc
operator|==
name|mdev
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_netdev_event
parameter_list|(
name|struct
name|notifier_block
modifier|*
name|this
parameter_list|,
name|unsigned
name|long
name|event
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|net_device
modifier|*
name|ndev
init|=
name|netdev_notifier_info_to_dev
argument_list|(
name|ptr
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|ibdev
init|=
name|container_of
argument_list|(
name|this
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|roce
operator|.
name|nb
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|NETDEV_REGISTER
case|:
case|case
name|NETDEV_UNREGISTER
case|:
name|write_lock
argument_list|(
operator|&
name|ibdev
operator|->
name|roce
operator|.
name|netdev_lock
argument_list|)
expr_stmt|;
comment|/* check if network interface belongs to mlx5en */
if|if
condition|(
name|mlx5_netdev_match
argument_list|(
name|ndev
argument_list|,
name|ibdev
operator|->
name|mdev
argument_list|,
literal|"mce"
argument_list|)
condition|)
name|ibdev
operator|->
name|roce
operator|.
name|netdev
operator|=
operator|(
name|event
operator|==
name|NETDEV_UNREGISTER
operator|)
condition|?
name|NULL
else|:
name|ndev
expr_stmt|;
name|write_unlock
argument_list|(
operator|&
name|ibdev
operator|->
name|roce
operator|.
name|netdev_lock
argument_list|)
expr_stmt|;
break|break;
case|case
name|NETDEV_UP
case|:
case|case
name|NETDEV_DOWN
case|:
block|{
name|struct
name|net_device
modifier|*
name|upper
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|upper
operator|==
name|ndev
operator|||
operator|(
operator|!
name|upper
operator|&&
name|ndev
operator|==
name|ibdev
operator|->
name|roce
operator|.
name|netdev
operator|)
operator|)
operator|&&
name|ibdev
operator|->
name|ib_active
condition|)
block|{
name|struct
name|ib_event
name|ibev
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ibev
operator|.
name|device
operator|=
operator|&
name|ibdev
operator|->
name|ib_dev
expr_stmt|;
name|ibev
operator|.
name|event
operator|=
operator|(
name|event
operator|==
name|NETDEV_UP
operator|)
condition|?
name|IB_EVENT_PORT_ACTIVE
else|:
name|IB_EVENT_PORT_ERR
expr_stmt|;
name|ibev
operator|.
name|element
operator|.
name|port_num
operator|=
literal|1
expr_stmt|;
name|ib_dispatch_event
argument_list|(
operator|&
name|ibev
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
default|default:
break|break;
block|}
return|return
name|NOTIFY_DONE
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|net_device
modifier|*
name|mlx5_ib_get_netdev
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|ibdev
init|=
name|to_mdev
argument_list|(
name|device
argument_list|)
decl_stmt|;
name|struct
name|net_device
modifier|*
name|ndev
decl_stmt|;
comment|/* Ensure ndev does not disappear before we invoke dev_hold() 	 */
name|read_lock
argument_list|(
operator|&
name|ibdev
operator|->
name|roce
operator|.
name|netdev_lock
argument_list|)
expr_stmt|;
name|ndev
operator|=
name|ibdev
operator|->
name|roce
operator|.
name|netdev
expr_stmt|;
if|if
condition|(
name|ndev
condition|)
name|dev_hold
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
name|read_unlock
argument_list|(
operator|&
name|ibdev
operator|->
name|roce
operator|.
name|netdev_lock
argument_list|)
expr_stmt|;
return|return
name|ndev
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_port_roce
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|struct
name|ib_port_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|device
argument_list|)
decl_stmt|;
name|struct
name|net_device
modifier|*
name|ndev
decl_stmt|;
name|enum
name|ib_mtu
name|ndev_ib_mtu
decl_stmt|;
name|u16
name|qkey_viol_cntr
decl_stmt|;
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|props
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|->
name|port_cap_flags
operator||=
name|IB_PORT_CM_SUP
expr_stmt|;
name|props
operator|->
name|port_cap_flags
operator||=
name|IB_PORT_IP_BASED_GIDS
expr_stmt|;
name|props
operator|->
name|gid_tbl_len
operator|=
name|MLX5_CAP_ROCE
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|roce_address_table_size
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mtu
operator|=
name|IB_MTU_4096
expr_stmt|;
name|props
operator|->
name|max_msg_sz
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_msg
argument_list|)
expr_stmt|;
name|props
operator|->
name|pkey_tbl_len
operator|=
literal|1
expr_stmt|;
name|props
operator|->
name|state
operator|=
name|IB_PORT_DOWN
expr_stmt|;
name|props
operator|->
name|phys_state
operator|=
literal|3
expr_stmt|;
name|mlx5_query_nic_vport_qkey_viol_cntr
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|qkey_viol_cntr
argument_list|)
expr_stmt|;
name|props
operator|->
name|qkey_viol_cntr
operator|=
name|qkey_viol_cntr
expr_stmt|;
name|ndev
operator|=
name|mlx5_ib_get_netdev
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ndev
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|netif_running
argument_list|(
name|ndev
argument_list|)
operator|&&
name|netif_carrier_ok
argument_list|(
name|ndev
argument_list|)
condition|)
block|{
name|props
operator|->
name|state
operator|=
name|IB_PORT_ACTIVE
expr_stmt|;
name|props
operator|->
name|phys_state
operator|=
literal|5
expr_stmt|;
block|}
name|ndev_ib_mtu
operator|=
name|iboe_get_mtu
argument_list|(
name|ndev
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
name|dev_put
argument_list|(
name|ndev
argument_list|)
expr_stmt|;
name|props
operator|->
name|active_mtu
operator|=
name|min
argument_list|(
name|props
operator|->
name|max_mtu
argument_list|,
name|ndev_ib_mtu
argument_list|)
expr_stmt|;
name|props
operator|->
name|active_width
operator|=
name|IB_WIDTH_4X
expr_stmt|;
comment|/* TODO */
name|props
operator|->
name|active_speed
operator|=
name|IB_SPEED_QDR
expr_stmt|;
comment|/* TODO */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ib_gid_to_mlx5_roce_addr
parameter_list|(
specifier|const
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
specifier|const
name|struct
name|ib_gid_attr
modifier|*
name|attr
parameter_list|,
name|void
modifier|*
name|mlx5_addr
parameter_list|)
block|{
define|#
directive|define
name|MLX5_SET_RA
parameter_list|(
name|p
parameter_list|,
name|f
parameter_list|,
name|v
parameter_list|)
value|MLX5_SET(roce_addr_layout, p, f, v)
name|char
modifier|*
name|mlx5_addr_l3_addr
init|=
name|MLX5_ADDR_OF
argument_list|(
name|roce_addr_layout
argument_list|,
name|mlx5_addr
argument_list|,
name|source_l3_address
argument_list|)
decl_stmt|;
name|void
modifier|*
name|mlx5_addr_mac
init|=
name|MLX5_ADDR_OF
argument_list|(
name|roce_addr_layout
argument_list|,
name|mlx5_addr
argument_list|,
name|source_mac_47_32
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|gid
condition|)
return|return;
name|ether_addr_copy
argument_list|(
name|mlx5_addr_mac
argument_list|,
name|IF_LLADDR
argument_list|(
name|attr
operator|->
name|ndev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_vlan_dev
argument_list|(
name|attr
operator|->
name|ndev
argument_list|)
condition|)
block|{
name|MLX5_SET_RA
argument_list|(
name|mlx5_addr
argument_list|,
name|vlan_valid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET_RA
argument_list|(
name|mlx5_addr
argument_list|,
name|vlan_id
argument_list|,
name|vlan_dev_vlan_id
argument_list|(
name|attr
operator|->
name|ndev
argument_list|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|attr
operator|->
name|gid_type
condition|)
block|{
case|case
name|IB_GID_TYPE_IB
case|:
name|MLX5_SET_RA
argument_list|(
name|mlx5_addr
argument_list|,
name|roce_version
argument_list|,
name|MLX5_ROCE_VERSION_1
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_GID_TYPE_ROCE_UDP_ENCAP
case|:
name|MLX5_SET_RA
argument_list|(
name|mlx5_addr
argument_list|,
name|roce_version
argument_list|,
name|MLX5_ROCE_VERSION_2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|WARN_ON
argument_list|(
name|true
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|->
name|gid_type
operator|!=
name|IB_GID_TYPE_IB
condition|)
block|{
if|if
condition|(
name|ipv6_addr_v4mapped
argument_list|(
operator|(
name|void
operator|*
operator|)
name|gid
argument_list|)
condition|)
name|MLX5_SET_RA
argument_list|(
name|mlx5_addr
argument_list|,
name|roce_l3_type
argument_list|,
name|MLX5_ROCE_L3_TYPE_IPV4
argument_list|)
expr_stmt|;
else|else
name|MLX5_SET_RA
argument_list|(
name|mlx5_addr
argument_list|,
name|roce_l3_type
argument_list|,
name|MLX5_ROCE_L3_TYPE_IPV6
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|attr
operator|->
name|gid_type
operator|==
name|IB_GID_TYPE_IB
operator|)
operator|||
operator|!
name|ipv6_addr_v4mapped
argument_list|(
operator|(
name|void
operator|*
operator|)
name|gid
argument_list|)
condition|)
name|memcpy
argument_list|(
name|mlx5_addr_l3_addr
argument_list|,
name|gid
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|gid
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|memcpy
argument_list|(
operator|&
name|mlx5_addr_l3_addr
index|[
literal|12
index|]
argument_list|,
operator|&
name|gid
operator|->
name|raw
index|[
literal|12
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_roce_addr
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|,
specifier|const
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
specifier|const
name|struct
name|ib_gid_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|device
argument_list|)
decl_stmt|;
name|u32
name|in
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|set_roce_address_in
argument_list|)
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|u32
name|out
index|[
name|MLX5_ST_SZ_DW
argument_list|(
name|set_roce_address_out
argument_list|)
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|void
modifier|*
name|in_addr
init|=
name|MLX5_ADDR_OF
argument_list|(
name|set_roce_address_in
argument_list|,
name|in
argument_list|,
name|roce_address
argument_list|)
decl_stmt|;
name|enum
name|rdma_link_layer
name|ll
init|=
name|mlx5_ib_port_link_layer
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|)
decl_stmt|;
if|if
condition|(
name|ll
operator|!=
name|IB_LINK_LAYER_ETHERNET
condition|)
return|return
operator|-
name|EINVAL
return|;
name|ib_gid_to_mlx5_roce_addr
argument_list|(
name|gid
argument_list|,
name|attr
argument_list|,
name|in_addr
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|set_roce_address_in
argument_list|,
name|in
argument_list|,
name|roce_address_index
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|set_roce_address_in
argument_list|,
name|in
argument_list|,
name|opcode
argument_list|,
name|MLX5_CMD_OP_SET_ROCE_ADDRESS
argument_list|)
expr_stmt|;
return|return
name|mlx5_cmd_exec
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_add_gid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|,
specifier|const
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
specifier|const
name|struct
name|ib_gid_attr
modifier|*
name|attr
parameter_list|,
name|__always_unused
name|void
modifier|*
modifier|*
name|context
parameter_list|)
block|{
return|return
name|set_roce_addr
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|,
name|index
argument_list|,
name|gid
argument_list|,
name|attr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_del_gid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|unsigned
name|int
name|index
parameter_list|,
name|__always_unused
name|void
modifier|*
modifier|*
name|context
parameter_list|)
block|{
return|return
name|set_roce_addr
argument_list|(
name|device
argument_list|,
name|port_num
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|__be16
name|mlx5_get_roce_udp_sport
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|ib_gid_attr
name|attr
decl_stmt|;
name|union
name|ib_gid
name|gid
decl_stmt|;
if|if
condition|(
name|ib_get_cached_gid
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|port_num
argument_list|,
name|index
argument_list|,
operator|&
name|gid
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|attr
operator|.
name|ndev
condition|)
return|return
literal|0
return|;
name|dev_put
argument_list|(
name|attr
operator|.
name|ndev
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|gid_type
operator|!=
name|IB_GID_TYPE_ROCE_UDP_ENCAP
condition|)
return|return
literal|0
return|;
return|return
name|cpu_to_be16
argument_list|(
name|MLX5_CAP_ROCE
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|r_roce_min_src_udp_port
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_use_mad_ifc
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port_type
argument_list|)
operator|==
name|MLX5_CAP_PORT_TYPE_IB
condition|)
return|return
operator|!
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|ib_virt
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MLX5_VPORT_ACCESS_METHOD_MAD
block|,
name|MLX5_VPORT_ACCESS_METHOD_HCA
block|,
name|MLX5_VPORT_ACCESS_METHOD_NIC
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|mlx5_get_vport_access_method
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|)
block|{
if|if
condition|(
name|mlx5_use_mad_ifc
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
argument_list|)
condition|)
return|return
name|MLX5_VPORT_ACCESS_METHOD_MAD
return|;
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
name|ibdev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
return|return
name|MLX5_VPORT_ACCESS_METHOD_NIC
return|;
return|return
name|MLX5_VPORT_ACCESS_METHOD_HCA
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_atomic_caps
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|ib_device_attr
modifier|*
name|props
parameter_list|)
block|{
name|u8
name|tmp
decl_stmt|;
name|u8
name|atomic_operations
init|=
name|MLX5_CAP_ATOMIC
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|atomic_operations
argument_list|)
decl_stmt|;
name|u8
name|atomic_size_qp
init|=
name|MLX5_CAP_ATOMIC
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|atomic_size_qp
argument_list|)
decl_stmt|;
name|u8
name|atomic_req_8B_endianness_mode
init|=
name|MLX5_CAP_ATOMIC
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|atomic_req_8B_endianess_mode
argument_list|)
decl_stmt|;
comment|/* Check if HW supports 8 bytes standard atomic operations and capable 	 * of host endianness respond 	 */
name|tmp
operator|=
name|MLX5_ATOMIC_OPS_CMP_SWAP
operator||
name|MLX5_ATOMIC_OPS_FETCH_ADD
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|atomic_operations
operator|&
name|tmp
operator|)
operator|==
name|tmp
operator|)
operator|&&
operator|(
name|atomic_size_qp
operator|&
name|MLX5_ATOMIC_SIZE_QP_8BYTES
operator|)
operator|&&
operator|(
name|atomic_req_8B_endianness_mode
operator|)
condition|)
block|{
name|props
operator|->
name|atomic_cap
operator|=
name|IB_ATOMIC_HCA
expr_stmt|;
block|}
else|else
block|{
name|props
operator|->
name|atomic_cap
operator|=
name|IB_ATOMIC_NONE
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_system_image_guid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|__be64
modifier|*
name|sys_image_guid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|u64
name|tmp
decl_stmt|;
name|int
name|err
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_mad_ifc_system_image_guid
argument_list|(
name|ibdev
argument_list|,
name|sys_image_guid
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
name|err
operator|=
name|mlx5_query_hca_vport_system_image_guid
argument_list|(
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
name|err
operator|=
name|mlx5_query_nic_vport_system_image_guid
argument_list|(
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|err
condition|)
operator|*
name|sys_image_guid
operator|=
name|cpu_to_be64
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_max_pkeys
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u16
modifier|*
name|max_pkeys
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_mad_ifc_max_pkeys
argument_list|(
name|ibdev
argument_list|,
name|max_pkeys
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
operator|*
name|max_pkeys
operator|=
name|mlx5_to_sw_pkey_sz
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|pkey_table_size
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_vendor_id
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u32
modifier|*
name|vendor_id
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_mad_ifc_vendor_id
argument_list|(
name|ibdev
argument_list|,
name|vendor_id
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
return|return
name|mlx5_core_query_vendor_id
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|vendor_id
argument_list|)
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_node_guid
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|__be64
modifier|*
name|node_guid
parameter_list|)
block|{
name|u64
name|tmp
decl_stmt|;
name|int
name|err
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_mad_ifc_node_guid
argument_list|(
name|dev
argument_list|,
name|node_guid
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
name|err
operator|=
name|mlx5_query_hca_vport_node_guid
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
name|err
operator|=
name|mlx5_query_nic_vport_node_guid
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|err
condition|)
operator|*
name|node_guid
operator|=
name|cpu_to_be64
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_struct
struct|struct
name|mlx5_reg_node_desc
block|{
name|u8
name|desc
index|[
name|IB_DEVICE_NODE_DESC_MAX
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|mlx5_query_node_desc
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|char
modifier|*
name|node_desc
parameter_list|)
block|{
name|struct
name|mlx5_reg_node_desc
name|in
decl_stmt|;
if|if
condition|(
name|mlx5_use_mad_ifc
argument_list|(
name|dev
argument_list|)
condition|)
return|return
name|mlx5_query_mad_ifc_node_desc
argument_list|(
name|dev
argument_list|,
name|node_desc
argument_list|)
return|;
name|memset
argument_list|(
operator|&
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|mlx5_core_access_reg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
name|node_desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_reg_node_desc
argument_list|)
argument_list|,
name|MLX5_REG_NODE_DESC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_query_device
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_device_attr
modifier|*
name|props
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|uhw
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOMEM
decl_stmt|;
name|int
name|max_rq_sg
decl_stmt|;
name|int
name|max_sq_sg
decl_stmt|;
name|u64
name|min_page_size
init|=
literal|1ull
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_pg_sz
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_query_device_resp
name|resp
init|=
block|{}
decl_stmt|;
name|size_t
name|resp_len
decl_stmt|;
name|u64
name|max_tso
decl_stmt|;
name|resp_len
operator|=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|comp_mask
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|response_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|uhw
operator|->
name|outlen
operator|&&
name|uhw
operator|->
name|outlen
operator|<
name|resp_len
condition|)
return|return
operator|-
name|EINVAL
return|;
else|else
name|resp
operator|.
name|response_length
operator|=
name|resp_len
expr_stmt|;
if|if
condition|(
name|uhw
operator|->
name|inlen
operator|&&
operator|!
name|ib_is_udata_cleared
argument_list|(
name|uhw
argument_list|,
literal|0
argument_list|,
name|uhw
operator|->
name|inlen
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|props
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_query_system_image_guid
argument_list|(
name|ibdev
argument_list|,
operator|&
name|props
operator|->
name|sys_image_guid
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx5_query_max_pkeys
argument_list|(
name|ibdev
argument_list|,
operator|&
name|props
operator|->
name|max_pkeys
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx5_query_vendor_id
argument_list|(
name|ibdev
argument_list|,
operator|&
name|props
operator|->
name|vendor_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|props
operator|->
name|fw_ver
operator|=
operator|(
operator|(
name|u64
operator|)
name|fw_rev_maj
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
operator|<<
literal|32
operator|)
operator||
operator|(
name|fw_rev_min
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
operator|<<
literal|16
operator|)
operator||
name|fw_rev_sub
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
expr_stmt|;
name|props
operator|->
name|device_cap_flags
operator|=
name|IB_DEVICE_CHANGE_PHY_PORT
operator||
name|IB_DEVICE_PORT_ACTIVE_EVENT
operator||
name|IB_DEVICE_SYS_IMAGE_GUID
operator||
name|IB_DEVICE_RC_RNR_NAK_GEN
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|pkv
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_BAD_PKEY_CNTR
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|qkv
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_BAD_QKEY_CNTR
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|apm
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_AUTO_PATH_MIG
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|xrc
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_XRC
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|imaicl
argument_list|)
condition|)
block|{
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_MEM_WINDOW
operator||
name|IB_DEVICE_MEM_WINDOW_TYPE_2B
expr_stmt|;
name|props
operator|->
name|max_mw
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_mkey
argument_list|)
expr_stmt|;
comment|/* We support 'Gappy' memory registration too */
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_SG_GAPS_REG
expr_stmt|;
block|}
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_MEM_MGT_EXTENSIONS
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|sho
argument_list|)
condition|)
block|{
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_SIGNATURE_HANDOVER
expr_stmt|;
comment|/* At this stage no support for signature handover */
name|props
operator|->
name|sig_prot_cap
operator|=
name|IB_PROT_T10DIF_TYPE_1
operator||
name|IB_PROT_T10DIF_TYPE_2
operator||
name|IB_PROT_T10DIF_TYPE_3
expr_stmt|;
name|props
operator|->
name|sig_guard_cap
operator|=
name|IB_GUARD_T10DIF_CRC
operator||
name|IB_GUARD_T10DIF_CSUM
expr_stmt|;
block|}
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|block_lb_mc
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_BLOCK_MULTICAST_LOOPBACK
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|eth_net_offloads
argument_list|)
condition|)
block|{
if|if
condition|(
name|MLX5_CAP_ETH
argument_list|(
name|mdev
argument_list|,
name|csum_cap
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_RAW_IP_CSUM
expr_stmt|;
if|if
condition|(
name|field_avail
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|tso_caps
argument_list|,
name|uhw
operator|->
name|outlen
argument_list|)
condition|)
block|{
name|max_tso
operator|=
name|MLX5_CAP_ETH
argument_list|(
name|mdev
argument_list|,
name|max_lso_cap
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_tso
condition|)
block|{
name|resp
operator|.
name|tso_caps
operator|.
name|max_tso
operator|=
literal|1
operator|<<
name|max_tso
expr_stmt|;
name|resp
operator|.
name|tso_caps
operator|.
name|supported_qpts
operator||=
literal|1
operator|<<
name|IB_QPT_RAW_PACKET
expr_stmt|;
name|resp
operator|.
name|response_length
operator|+=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|tso_caps
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|field_avail
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|rss_caps
argument_list|,
name|uhw
operator|->
name|outlen
argument_list|)
condition|)
block|{
name|resp
operator|.
name|rss_caps
operator|.
name|rx_hash_function
operator|=
name|MLX5_RX_HASH_FUNC_TOEPLITZ
expr_stmt|;
name|resp
operator|.
name|rss_caps
operator|.
name|rx_hash_fields_mask
operator|=
name|MLX5_RX_HASH_SRC_IPV4
operator||
name|MLX5_RX_HASH_DST_IPV4
operator||
name|MLX5_RX_HASH_SRC_IPV6
operator||
name|MLX5_RX_HASH_DST_IPV6
operator||
name|MLX5_RX_HASH_SRC_PORT_TCP
operator||
name|MLX5_RX_HASH_DST_PORT_TCP
operator||
name|MLX5_RX_HASH_SRC_PORT_UDP
operator||
name|MLX5_RX_HASH_DST_PORT_UDP
expr_stmt|;
name|resp
operator|.
name|response_length
operator|+=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|rss_caps
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|field_avail
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|tso_caps
argument_list|,
name|uhw
operator|->
name|outlen
argument_list|)
condition|)
name|resp
operator|.
name|response_length
operator|+=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|tso_caps
argument_list|)
expr_stmt|;
if|if
condition|(
name|field_avail
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|rss_caps
argument_list|,
name|uhw
operator|->
name|outlen
argument_list|)
condition|)
name|resp
operator|.
name|response_length
operator|+=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|rss_caps
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|ipoib_ipoib_offloads
argument_list|)
condition|)
block|{
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_UD_IP_CSUM
expr_stmt|;
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_UD_TSO
expr_stmt|;
block|}
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|eth_net_offloads
argument_list|)
operator|&&
name|MLX5_CAP_ETH
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|scatter_fcs
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_RAW_SCATTER_FCS
expr_stmt|;
if|if
condition|(
name|mlx5_get_flow_namespace
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|MLX5_FLOW_NAMESPACE_BYPASS
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_MANAGED_FLOW_STEERING
expr_stmt|;
name|props
operator|->
name|vendor_part_id
operator|=
name|mdev
operator|->
name|pdev
operator|->
name|device
expr_stmt|;
name|props
operator|->
name|hw_ver
operator|=
name|mdev
operator|->
name|pdev
operator|->
name|revision
expr_stmt|;
name|props
operator|->
name|max_mr_size
operator|=
operator|~
literal|0ull
expr_stmt|;
name|props
operator|->
name|page_size_cap
operator|=
operator|~
operator|(
name|min_page_size
operator|-
literal|1
operator|)
expr_stmt|;
name|props
operator|->
name|max_qp
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_qp
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp_wr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_qp_sz
argument_list|)
expr_stmt|;
name|max_rq_sg
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|max_wqe_sz_rq
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_wqe_data_seg
argument_list|)
expr_stmt|;
name|max_sq_sg
operator|=
operator|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|max_wqe_sz_sq
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_wqe_ctrl_seg
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_wqe_data_seg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_sge
operator|=
name|min
argument_list|(
name|max_rq_sg
argument_list|,
name|max_sq_sg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_sge_rd
operator|=
name|MLX5_MAX_SGE_RD
expr_stmt|;
name|props
operator|->
name|max_cq
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_cq
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_cqe
operator|=
operator|(
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_cq_sz
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|props
operator|->
name|max_mr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_mkey
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_pd
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_pd
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp_rd_atom
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_ra_req_qp
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_qp_init_rd_atom
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_ra_res_qp
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_srq
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_srq
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_srq_wr
operator|=
operator|(
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_srq_sz
argument_list|)
operator|)
operator|-
literal|1
expr_stmt|;
name|props
operator|->
name|local_ca_ack_delay
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|local_ca_ack_delay
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_res_rd_atom
operator|=
name|props
operator|->
name|max_qp_rd_atom
operator|*
name|props
operator|->
name|max_qp
expr_stmt|;
name|props
operator|->
name|max_srq_sge
operator|=
name|max_rq_sg
operator|-
literal|1
expr_stmt|;
name|props
operator|->
name|max_fast_reg_page_list_len
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_klm_list_size
argument_list|)
expr_stmt|;
name|get_atomic_caps
argument_list|(
name|dev
argument_list|,
name|props
argument_list|)
expr_stmt|;
name|props
operator|->
name|masked_atomic_cap
operator|=
name|IB_ATOMIC_NONE
expr_stmt|;
name|props
operator|->
name|max_mcast_grp
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_mcg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_mcast_qp_attach
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|max_qp_mcg
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_total_mcast_qp_attach
operator|=
name|props
operator|->
name|max_mcast_qp_attach
operator|*
name|props
operator|->
name|max_mcast_grp
expr_stmt|;
name|props
operator|->
name|max_map_per_fmr
operator|=
name|INT_MAX
expr_stmt|;
comment|/* no limit in ConnectIB */
name|props
operator|->
name|hca_core_clock
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|device_frequency_khz
argument_list|)
expr_stmt|;
name|props
operator|->
name|timestamp_mask
operator|=
literal|0x7FFFFFFFFFFFFFFFULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_ON_DEMAND_PAGING
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|pg
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_ON_DEMAND_PAGING
expr_stmt|;
name|props
operator|->
name|odp_caps
operator|=
name|dev
operator|->
name|odp_caps
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|cd
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_CROSS_CHANNEL
expr_stmt|;
if|if
condition|(
operator|!
name|mlx5_core_is_pf
argument_list|(
name|mdev
argument_list|)
condition|)
name|props
operator|->
name|device_cap_flags
operator||=
name|IB_DEVICE_VIRTUAL_FUNCTION
expr_stmt|;
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
name|ibdev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
block|{
name|props
operator|->
name|rss_caps
operator|.
name|max_rwq_indirection_tables
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_rqt
argument_list|)
expr_stmt|;
name|props
operator|->
name|rss_caps
operator|.
name|max_rwq_indirection_table_size
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_rqt_size
argument_list|)
expr_stmt|;
name|props
operator|->
name|rss_caps
operator|.
name|supported_qpts
operator|=
literal|1
operator|<<
name|IB_QPT_RAW_PACKET
expr_stmt|;
name|props
operator|->
name|max_wq_type_rq
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_rq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uhw
operator|->
name|outlen
condition|)
block|{
name|err
operator|=
name|ib_copy_to_udata
argument_list|(
name|uhw
argument_list|,
operator|&
name|resp
argument_list|,
name|resp
operator|.
name|response_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_enum
enum|enum
name|mlx5_ib_width
block|{
name|MLX5_IB_WIDTH_1X
init|=
literal|1
operator|<<
literal|0
block|,
name|MLX5_IB_WIDTH_2X
init|=
literal|1
operator|<<
literal|1
block|,
name|MLX5_IB_WIDTH_4X
init|=
literal|1
operator|<<
literal|2
block|,
name|MLX5_IB_WIDTH_8X
init|=
literal|1
operator|<<
literal|3
block|,
name|MLX5_IB_WIDTH_12X
init|=
literal|1
operator|<<
literal|4
block|}
enum|;
end_enum

begin_function
specifier|static
name|int
name|translate_active_width
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|active_width
parameter_list|,
name|u8
modifier|*
name|ib_width
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_1X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_1X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_2X
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"active_width %d is not supported by IB spec\n"
argument_list|,
operator|(
name|int
operator|)
name|active_width
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_4X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_4X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_8X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_8X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|active_width
operator|&
name|MLX5_IB_WIDTH_12X
condition|)
block|{
operator|*
name|ib_width
operator|=
name|IB_WIDTH_12X
expr_stmt|;
block|}
else|else
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Invalid active_width %d\n"
argument_list|,
operator|(
name|int
operator|)
name|active_width
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_enum
enum|enum
name|ib_max_vl_num
block|{
name|__IB_MAX_VL_0
init|=
literal|1
block|,
name|__IB_MAX_VL_0_1
init|=
literal|2
block|,
name|__IB_MAX_VL_0_3
init|=
literal|3
block|,
name|__IB_MAX_VL_0_7
init|=
literal|4
block|,
name|__IB_MAX_VL_0_14
init|=
literal|5
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|mlx5_vl_hw_cap
block|{
name|MLX5_VL_HW_0
init|=
literal|1
block|,
name|MLX5_VL_HW_0_1
init|=
literal|2
block|,
name|MLX5_VL_HW_0_2
init|=
literal|3
block|,
name|MLX5_VL_HW_0_3
init|=
literal|4
block|,
name|MLX5_VL_HW_0_4
init|=
literal|5
block|,
name|MLX5_VL_HW_0_5
init|=
literal|6
block|,
name|MLX5_VL_HW_0_6
init|=
literal|7
block|,
name|MLX5_VL_HW_0_7
init|=
literal|8
block|,
name|MLX5_VL_HW_0_14
init|=
literal|15
block|}
enum|;
end_enum

begin_function
specifier|static
name|int
name|translate_max_vl_num
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|vl_hw_cap
parameter_list|,
name|u8
modifier|*
name|max_vl_num
parameter_list|)
block|{
switch|switch
condition|(
name|vl_hw_cap
condition|)
block|{
case|case
name|MLX5_VL_HW_0
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_1
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_1
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_3
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_3
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_7
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_7
expr_stmt|;
break|break;
case|case
name|MLX5_VL_HW_0_14
case|:
operator|*
name|max_vl_num
operator|=
name|__IB_MAX_VL_0_14
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_query_hca_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|struct
name|ib_port_attr
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
name|u32
modifier|*
name|rep
decl_stmt|;
name|int
name|replen
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|query_hca_vport_context_out
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ptys_reg
modifier|*
name|ptys
decl_stmt|;
name|struct
name|mlx5_pmtu_reg
modifier|*
name|pmtu
decl_stmt|;
name|struct
name|mlx5_pvlc_reg
name|pvlc
decl_stmt|;
name|void
modifier|*
name|ctx
decl_stmt|;
name|int
name|err
decl_stmt|;
name|rep
operator|=
name|mlx5_vzalloc
argument_list|(
name|replen
argument_list|)
expr_stmt|;
name|ptys
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ptys
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|pmtu
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pmtu
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rep
operator|||
operator|!
name|ptys
operator|||
operator|!
name|pmtu
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memset
argument_list|(
name|props
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|props
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_query_hca_vport_context
argument_list|(
name|mdev
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|rep
argument_list|,
name|replen
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|ctx
operator|=
name|MLX5_ADDR_OF
argument_list|(
name|query_hca_vport_context_out
argument_list|,
name|rep
argument_list|,
name|hca_vport_context
argument_list|)
expr_stmt|;
name|props
operator|->
name|lid
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|lid
argument_list|)
expr_stmt|;
name|props
operator|->
name|lmc
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|lmc
argument_list|)
expr_stmt|;
name|props
operator|->
name|sm_lid
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|sm_lid
argument_list|)
expr_stmt|;
name|props
operator|->
name|sm_sl
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|sm_sl
argument_list|)
expr_stmt|;
name|props
operator|->
name|state
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|vport_state
argument_list|)
expr_stmt|;
name|props
operator|->
name|phys_state
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|port_physical_state
argument_list|)
expr_stmt|;
name|props
operator|->
name|port_cap_flags
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|cap_mask1
argument_list|)
expr_stmt|;
name|props
operator|->
name|gid_tbl_len
operator|=
name|mlx5_get_gid_table_len
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|gid_table_size
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|->
name|max_msg_sz
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|log_max_msg
argument_list|)
expr_stmt|;
name|props
operator|->
name|pkey_tbl_len
operator|=
name|mlx5_to_sw_pkey_sz
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|pkey_table_size
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|->
name|bad_pkey_cntr
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|pkey_violation_counter
argument_list|)
expr_stmt|;
name|props
operator|->
name|qkey_viol_cntr
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|qkey_violation_counter
argument_list|)
expr_stmt|;
name|props
operator|->
name|subnet_timeout
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|subnet_timeout
argument_list|)
expr_stmt|;
name|props
operator|->
name|init_type_reply
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|init_type_reply
argument_list|)
expr_stmt|;
name|props
operator|->
name|grh_required
operator|=
name|MLX5_GET
argument_list|(
name|hca_vport_context
argument_list|,
name|ctx
argument_list|,
name|grh_required
argument_list|)
expr_stmt|;
name|ptys
operator|->
name|proto_mask
operator||=
name|MLX5_PTYS_IB
expr_stmt|;
name|ptys
operator|->
name|local_port
operator|=
name|port
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_ptys
argument_list|(
name|mdev
argument_list|,
name|ptys
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|translate_active_width
argument_list|(
name|ibdev
argument_list|,
name|ptys
operator|->
name|ib_link_width_oper
argument_list|,
operator|&
name|props
operator|->
name|active_width
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|props
operator|->
name|active_speed
operator|=
operator|(
name|u8
operator|)
name|ptys
operator|->
name|ib_proto_oper
expr_stmt|;
name|pmtu
operator|->
name|local_port
operator|=
name|port
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_pmtu
argument_list|(
name|mdev
argument_list|,
name|pmtu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|props
operator|->
name|max_mtu
operator|=
name|pmtu
operator|->
name|max_mtu
expr_stmt|;
name|props
operator|->
name|active_mtu
operator|=
name|pmtu
operator|->
name|oper_mtu
expr_stmt|;
name|memset
argument_list|(
operator|&
name|pvlc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pvlc
argument_list|)
argument_list|)
expr_stmt|;
name|pvlc
operator|.
name|local_port
operator|=
name|port
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_pvlc
argument_list|(
name|mdev
argument_list|,
operator|&
name|pvlc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|translate_max_vl_num
argument_list|(
name|ibdev
argument_list|,
name|pvlc
operator|.
name|vl_hw_cap
argument_list|,
operator|&
name|props
operator|->
name|max_vl_num
argument_list|)
expr_stmt|;
name|out
label|:
name|kvfree
argument_list|(
name|rep
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|ptys
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|pmtu
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|mlx5_ib_query_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|struct
name|ib_port_attr
modifier|*
name|props
parameter_list|)
block|{
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_mad_ifc_port
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|props
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
return|return
name|mlx5_query_hca_port
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|props
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
return|return
name|mlx5_query_port_roce
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|props
argument_list|)
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_query_gid
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|index
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_mad_ifc_gids
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|index
argument_list|,
name|gid
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
return|return
name|mlx5_query_hca_vport_gid
argument_list|(
name|mdev
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|index
argument_list|,
name|gid
argument_list|)
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_query_pkey
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|u16
name|index
parameter_list|,
name|u16
modifier|*
name|pkey
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
init|=
name|dev
operator|->
name|mdev
decl_stmt|;
switch|switch
condition|(
name|mlx5_get_vport_access_method
argument_list|(
name|ibdev
argument_list|)
condition|)
block|{
case|case
name|MLX5_VPORT_ACCESS_METHOD_MAD
case|:
return|return
name|mlx5_query_mad_ifc_pkey
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
name|index
argument_list|,
name|pkey
argument_list|)
return|;
case|case
name|MLX5_VPORT_ACCESS_METHOD_HCA
case|:
case|case
name|MLX5_VPORT_ACCESS_METHOD_NIC
case|:
return|return
name|mlx5_query_hca_vport_pkey
argument_list|(
name|mdev
argument_list|,
literal|0
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
name|index
argument_list|,
name|pkey
argument_list|)
return|;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_modify_device
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|int
name|mask
parameter_list|,
name|struct
name|ib_device_modify
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_reg_node_desc
name|in
decl_stmt|;
name|struct
name|mlx5_reg_node_desc
name|out
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|mask
operator|&
operator|~
name|IB_DEVICE_MODIFY_NODE_DESC
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
if|if
condition|(
operator|!
operator|(
name|mask
operator|&
name|IB_DEVICE_MODIFY_NODE_DESC
operator|)
condition|)
return|return
literal|0
return|;
comment|/* 	 * If possible, pass node desc to FW, so it can generate 	 * a 144 trap.  If cmd fails, just ignore. 	 */
name|memcpy
argument_list|(
operator|&
name|in
argument_list|,
name|props
operator|->
name|node_desc
argument_list|,
name|IB_DEVICE_NODE_DESC_MAX
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_core_access_reg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|,
operator|&
name|out
argument_list|,
sizeof|sizeof
argument_list|(
name|out
argument_list|)
argument_list|,
name|MLX5_REG_NODE_DESC
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|memcpy
argument_list|(
name|ibdev
operator|->
name|node_desc
argument_list|,
name|props
operator|->
name|node_desc
argument_list|,
name|IB_DEVICE_NODE_DESC_MAX
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_modify_port
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|mask
parameter_list|,
name|struct
name|ib_port_modify
modifier|*
name|props
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|u32
name|tmp
decl_stmt|;
name|int
name|err
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|dev
operator|->
name|cap_mask_mutex
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_ib_query_port
argument_list|(
name|ibdev
argument_list|,
name|port
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|tmp
operator|=
operator|(
name|attr
operator|.
name|port_cap_flags
operator||
name|props
operator|->
name|set_port_cap_mask
operator|)
operator|&
operator|~
name|props
operator|->
name|clr_port_cap_mask
expr_stmt|;
name|err
operator|=
name|mlx5_set_port_caps
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|port
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|dev
operator|->
name|cap_mask_mutex
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_ucontext
modifier|*
name|mlx5_ib_alloc_ucontext
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_alloc_ucontext_req_v2
name|req
init|=
block|{}
decl_stmt|;
name|struct
name|mlx5_ib_alloc_ucontext_resp
name|resp
init|=
block|{}
decl_stmt|;
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
decl_stmt|;
name|struct
name|mlx5_uuar_info
modifier|*
name|uuari
decl_stmt|;
name|struct
name|mlx5_uar
modifier|*
name|uars
decl_stmt|;
name|int
name|gross_uuars
decl_stmt|;
name|int
name|num_uars
decl_stmt|;
name|int
name|ver
decl_stmt|;
name|int
name|uuarn
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|reqlen
decl_stmt|;
name|size_t
name|min_req_v2
init|=
name|offsetof
argument_list|(
expr|struct
name|mlx5_ib_alloc_ucontext_req_v2
argument_list|,
name|max_cqe_version
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|ib_active
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EAGAIN
argument_list|)
return|;
if|if
condition|(
name|udata
operator|->
name|inlen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ib_uverbs_cmd_hdr
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|reqlen
operator|=
name|udata
operator|->
name|inlen
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ib_uverbs_cmd_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|reqlen
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|mlx5_ib_alloc_ucontext_req
argument_list|)
condition|)
name|ver
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|reqlen
operator|>=
name|min_req_v2
condition|)
name|ver
operator|=
literal|2
expr_stmt|;
else|else
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|err
operator|=
name|ib_copy_from_udata
argument_list|(
operator|&
name|req
argument_list|,
name|udata
argument_list|,
name|min
argument_list|(
name|reqlen
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
if|if
condition|(
name|req
operator|.
name|flags
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
if|if
condition|(
name|req
operator|.
name|total_num_uuars
operator|>
name|MLX5_MAX_UUARS
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
if|if
condition|(
name|req
operator|.
name|total_num_uuars
operator|==
literal|0
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
if|if
condition|(
name|req
operator|.
name|comp_mask
operator|||
name|req
operator|.
name|reserved0
operator|||
name|req
operator|.
name|reserved1
operator|||
name|req
operator|.
name|reserved2
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EOPNOTSUPP
argument_list|)
return|;
if|if
condition|(
name|reqlen
operator|>
sizeof|sizeof
argument_list|(
name|req
argument_list|)
operator|&&
operator|!
name|ib_is_udata_cleared
argument_list|(
name|udata
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
name|reqlen
operator|-
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EOPNOTSUPP
argument_list|)
return|;
name|req
operator|.
name|total_num_uuars
operator|=
name|ALIGN
argument_list|(
name|req
operator|.
name|total_num_uuars
argument_list|,
name|MLX5_NON_FP_BF_REGS_PER_PAGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|num_low_latency_uuars
operator|>
name|req
operator|.
name|total_num_uuars
operator|-
literal|1
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|num_uars
operator|=
name|req
operator|.
name|total_num_uuars
operator|/
name|MLX5_NON_FP_BF_REGS_PER_PAGE
expr_stmt|;
name|gross_uuars
operator|=
name|num_uars
operator|*
name|MLX5_BF_REGS_PER_PAGE
expr_stmt|;
name|resp
operator|.
name|qp_tab_size
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mlx5_core_is_pf
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
operator|&&
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|bf
argument_list|)
condition|)
name|resp
operator|.
name|bf_reg_size
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_bf_reg_size
argument_list|)
expr_stmt|;
name|resp
operator|.
name|cache_line_size
operator|=
name|cache_line_size
argument_list|()
expr_stmt|;
name|resp
operator|.
name|max_sq_desc_sz
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|max_wqe_sz_sq
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_rq_desc_sz
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|max_wqe_sz_rq
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_send_wqebb
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_qp_sz
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_recv_wr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_qp_sz
argument_list|)
expr_stmt|;
name|resp
operator|.
name|max_srq_recv_wr
operator|=
literal|1
operator|<<
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_srq_sz
argument_list|)
expr_stmt|;
name|resp
operator|.
name|cqe_version
operator|=
name|min_t
argument_list|(
name|__u8
argument_list|,
operator|(
name|__u8
operator|)
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|cqe_version
argument_list|)
argument_list|,
name|req
operator|.
name|max_cqe_version
argument_list|)
expr_stmt|;
name|resp
operator|.
name|response_length
operator|=
name|min
argument_list|(
name|offsetof
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|response_length
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|response_length
argument_list|)
argument_list|,
name|udata
operator|->
name|outlen
argument_list|)
expr_stmt|;
name|context
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|context
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|uuari
operator|=
operator|&
name|context
operator|->
name|uuari
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|uuari
operator|->
name|lock
argument_list|)
expr_stmt|;
name|uars
operator|=
name|kcalloc
argument_list|(
name|num_uars
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uars
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uars
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out_ctx
goto|;
block|}
name|uuari
operator|->
name|bitmap
operator|=
name|kcalloc
argument_list|(
name|BITS_TO_LONGS
argument_list|(
name|gross_uuars
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uuari
operator|->
name|bitmap
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uuari
operator|->
name|bitmap
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out_uar_ctx
goto|;
block|}
comment|/* 	 * clear all fast path uuars 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|gross_uuars
condition|;
name|i
operator|++
control|)
block|{
name|uuarn
operator|=
name|i
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|uuarn
operator|==
literal|2
operator|||
name|uuarn
operator|==
literal|3
condition|)
name|set_bit
argument_list|(
name|i
argument_list|,
name|uuari
operator|->
name|bitmap
argument_list|)
expr_stmt|;
block|}
name|uuari
operator|->
name|count
operator|=
name|kcalloc
argument_list|(
name|gross_uuars
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uuari
operator|->
name|count
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uuari
operator|->
name|count
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|out_bitmap
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_uars
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|mlx5_cmd_alloc_uar
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out_count
goto|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_ON_DEMAND_PAGING
name|context
operator|->
name|ibucontext
operator|.
name|invalidate_range
operator|=
operator|&
name|mlx5_ib_invalidate_range
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_transport_domain
argument_list|)
condition|)
block|{
name|err
operator|=
name|mlx5_alloc_transport_domain
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
operator|&
name|context
operator|->
name|tdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out_uars
goto|;
block|}
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|context
operator|->
name|vma_private_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|context
operator|->
name|db_page_list
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|context
operator|->
name|db_page_mutex
argument_list|)
expr_stmt|;
name|resp
operator|.
name|tot_uuars
operator|=
name|req
operator|.
name|total_num_uuars
expr_stmt|;
name|resp
operator|.
name|num_ports
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
expr_stmt|;
if|if
condition|(
name|field_avail
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|cqe_version
argument_list|,
name|udata
operator|->
name|outlen
argument_list|)
condition|)
name|resp
operator|.
name|response_length
operator|+=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|cqe_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|field_avail
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|cmds_supp_uhw
argument_list|,
name|udata
operator|->
name|outlen
argument_list|)
condition|)
block|{
name|resp
operator|.
name|cmds_supp_uhw
operator||=
name|MLX5_USER_CMDS_SUPP_UHW_QUERY_DEVICE
expr_stmt|;
name|resp
operator|.
name|response_length
operator|+=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|cmds_supp_uhw
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * We don't want to expose information from the PCI bar that is located 	 * after 4096 bytes, so if the arch only supports larger pages, let's 	 * pretend we don't support reading the HCA's core clock. This is also 	 * forced by mmap function. 	 */
if|if
condition|(
name|PAGE_SIZE
operator|<=
literal|4096
operator|&&
name|field_avail
argument_list|(
name|typeof
argument_list|(
name|resp
argument_list|)
argument_list|,
name|hca_core_clock_offset
argument_list|,
name|udata
operator|->
name|outlen
argument_list|)
condition|)
block|{
name|resp
operator|.
name|comp_mask
operator||=
name|MLX5_IB_ALLOC_UCONTEXT_RESP_MASK_CORE_CLOCK_OFFSET
expr_stmt|;
name|resp
operator|.
name|hca_core_clock_offset
operator|=
name|offsetof
argument_list|(
expr|struct
name|mlx5_init_seg
argument_list|,
name|internal_timer_h
argument_list|)
operator|%
name|PAGE_SIZE
expr_stmt|;
name|resp
operator|.
name|response_length
operator|+=
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|hca_core_clock_offset
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|resp
operator|.
name|reserved2
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|resp
argument_list|,
name|resp
operator|.
name|response_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out_td
goto|;
name|uuari
operator|->
name|ver
operator|=
name|ver
expr_stmt|;
name|uuari
operator|->
name|num_low_latency_uuars
operator|=
name|req
operator|.
name|num_low_latency_uuars
expr_stmt|;
name|uuari
operator|->
name|uars
operator|=
name|uars
expr_stmt|;
name|uuari
operator|->
name|num_uars
operator|=
name|num_uars
expr_stmt|;
name|context
operator|->
name|cqe_version
operator|=
name|resp
operator|.
name|cqe_version
expr_stmt|;
return|return
operator|&
name|context
operator|->
name|ibucontext
return|;
name|out_td
label|:
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_transport_domain
argument_list|)
condition|)
name|mlx5_dealloc_transport_domain
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|context
operator|->
name|tdn
argument_list|)
expr_stmt|;
name|out_uars
label|:
for|for
control|(
name|i
operator|--
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|mlx5_cmd_free_uar
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
name|out_count
label|:
name|kfree
argument_list|(
name|uuari
operator|->
name|count
argument_list|)
expr_stmt|;
name|out_bitmap
label|:
name|kfree
argument_list|(
name|uuari
operator|->
name|bitmap
argument_list|)
expr_stmt|;
name|out_uar_ctx
label|:
name|kfree
argument_list|(
name|uars
argument_list|)
expr_stmt|;
name|out_ctx
label|:
name|kfree
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_dealloc_ucontext
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|ibcontext
parameter_list|)
block|{
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
init|=
name|to_mucontext
argument_list|(
name|ibcontext
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibcontext
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_uuar_info
modifier|*
name|uuari
init|=
operator|&
name|context
operator|->
name|uuari
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|log_max_transport_domain
argument_list|)
condition|)
name|mlx5_dealloc_transport_domain
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|context
operator|->
name|tdn
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|uuari
operator|->
name|num_uars
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mlx5_cmd_free_uar
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|uuari
operator|->
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed to free UAR 0x%x\n"
argument_list|,
name|uuari
operator|->
name|uars
index|[
name|i
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|uuari
operator|->
name|count
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|uuari
operator|->
name|bitmap
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|uuari
operator|->
name|uars
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|phys_addr_t
name|uar_index2pfn
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|int
name|index
parameter_list|)
block|{
return|return
operator|(
name|pci_resource_start
argument_list|(
name|dev
operator|->
name|mdev
operator|->
name|pdev
argument_list|,
literal|0
argument_list|)
operator|>>
name|PAGE_SHIFT
operator|)
operator|+
name|index
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_command
parameter_list|(
name|unsigned
name|long
name|offset
parameter_list|)
block|{
return|return
operator|(
name|offset
operator|>>
name|MLX5_IB_MMAP_CMD_SHIFT
operator|)
operator|&
name|MLX5_IB_MMAP_CMD_MASK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_arg
parameter_list|(
name|unsigned
name|long
name|offset
parameter_list|)
block|{
return|return
name|offset
operator|&
operator|(
operator|(
literal|1
operator|<<
name|MLX5_IB_MMAP_CMD_SHIFT
operator|)
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_index
parameter_list|(
name|unsigned
name|long
name|offset
parameter_list|)
block|{
return|return
name|get_arg
argument_list|(
name|offset
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_vma_open
parameter_list|(
name|struct
name|vm_area_struct
modifier|*
name|area
parameter_list|)
block|{
comment|/* vma_open is called when a new VMA is created on top of our VMA.  This 	 * is done through either mremap flow or split_vma (usually due to 	 * mlock, madvise, munmap, etc.) We do not support a clone of the VMA, 	 * as this VMA is strongly hardware related.  Therefore we set the 	 * vm_ops of the newly created/cloned VMA to NULL, to prevent it from 	 * calling us again and trying to do incorrect actions.  We assume that 	 * the original VMA size is exactly a single page, and therefore all 	 * "splitting" operation will not happen to it. 	 */
name|area
operator|->
name|vm_ops
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_vma_close
parameter_list|(
name|struct
name|vm_area_struct
modifier|*
name|area
parameter_list|)
block|{
name|struct
name|mlx5_ib_vma_private_data
modifier|*
name|mlx5_ib_vma_priv_data
decl_stmt|;
comment|/* It's guaranteed that all VMAs opened on a FD are closed before the 	 * file itself is closed, therefore no sync is needed with the regular 	 * closing flow. (e.g. mlx5 ib_dealloc_ucontext) 	 * However need a sync with accessing the vma as part of 	 * mlx5_ib_disassociate_ucontext. 	 * The close operation is usually called under mm->mmap_sem except when 	 * process is exiting. 	 * The exiting case is handled explicitly as part of 	 * mlx5_ib_disassociate_ucontext. 	 */
name|mlx5_ib_vma_priv_data
operator|=
operator|(
expr|struct
name|mlx5_ib_vma_private_data
operator|*
operator|)
name|area
operator|->
name|vm_private_data
expr_stmt|;
comment|/* setting the vma context pointer to null in the mlx5_ib driver's 	 * private data, to protect a race condition in 	 * mlx5_ib_disassociate_ucontext(). 	 */
name|mlx5_ib_vma_priv_data
operator|->
name|vma
operator|=
name|NULL
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|mlx5_ib_vma_priv_data
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mlx5_ib_vma_priv_data
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|vm_operations_struct
name|mlx5_ib_vm_ops
init|=
block|{
operator|.
name|open
operator|=
name|mlx5_ib_vma_open
block|,
operator|.
name|close
operator|=
name|mlx5_ib_vma_close
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mlx5_ib_set_vma_data
parameter_list|(
name|struct
name|vm_area_struct
modifier|*
name|vma
parameter_list|,
name|struct
name|mlx5_ib_ucontext
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|mlx5_ib_vma_private_data
modifier|*
name|vma_prv
decl_stmt|;
name|struct
name|list_head
modifier|*
name|vma_head
init|=
operator|&
name|ctx
operator|->
name|vma_private_list
decl_stmt|;
name|vma_prv
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|vma_prv
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vma_prv
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|vma_prv
operator|->
name|vma
operator|=
name|vma
expr_stmt|;
name|vma
operator|->
name|vm_private_data
operator|=
name|vma_prv
expr_stmt|;
name|vma
operator|->
name|vm_ops
operator|=
operator|&
name|mlx5_ib_vm_ops
expr_stmt|;
name|list_add
argument_list|(
operator|&
name|vma_prv
operator|->
name|list
argument_list|,
name|vma_head
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_disassociate_ucontext
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|ibcontext
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|vm_area_struct
modifier|*
name|vma
decl_stmt|;
name|struct
name|mlx5_ib_vma_private_data
modifier|*
name|vma_private
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
init|=
name|to_mucontext
argument_list|(
name|ibcontext
argument_list|)
decl_stmt|;
name|struct
name|task_struct
modifier|*
name|owning_process
init|=
name|NULL
decl_stmt|;
name|struct
name|mm_struct
modifier|*
name|owning_mm
init|=
name|NULL
decl_stmt|;
name|owning_process
operator|=
name|get_pid_task
argument_list|(
name|ibcontext
operator|->
name|tgid
argument_list|,
name|PIDTYPE_PID
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|owning_process
condition|)
return|return;
name|owning_mm
operator|=
name|get_task_mm
argument_list|(
name|owning_process
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|owning_mm
condition|)
block|{
name|pr_info
argument_list|(
literal|"no mm, disassociate ucontext is pending task termination\n"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|put_task_struct
argument_list|(
name|owning_process
argument_list|)
expr_stmt|;
name|usleep_range
argument_list|(
literal|1000
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
name|owning_process
operator|=
name|get_pid_task
argument_list|(
name|ibcontext
operator|->
name|tgid
argument_list|,
name|PIDTYPE_PID
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|owning_process
comment|/* || 			    owning_process->state == TASK_DEAD */
condition|)
block|{
name|pr_info
argument_list|(
literal|"disassociate ucontext done, task was terminated\n"
argument_list|)
expr_stmt|;
comment|/* in case task was dead need to release the 				 * task struct. 				 */
if|if
condition|(
name|owning_process
condition|)
name|put_task_struct
argument_list|(
name|owning_process
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
comment|/* need to protect from a race on closing the vma as part of 	 * mlx5_ib_vma_close. 	 */
name|down_read
argument_list|(
operator|&
name|owning_mm
operator|->
name|mmap_sem
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|vma_private
argument_list|,
argument|n
argument_list|,
argument|&context->vma_private_list
argument_list|,
argument|list
argument_list|)
block|{
name|vma
operator|=
name|vma_private
operator|->
name|vma
expr_stmt|;
name|ret
operator|=
name|zap_vma_ptes
argument_list|(
name|vma
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|WARN_ONCE
argument_list|(
name|ret
argument_list|,
literal|"%s: zap_vma_ptes failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* context going to be destroyed, should 		 * not access ops any more. 		 */
name|vma
operator|->
name|vm_ops
operator|=
name|NULL
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|vma_private
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|vma_private
argument_list|)
expr_stmt|;
block|}
name|up_read
argument_list|(
operator|&
name|owning_mm
operator|->
name|mmap_sem
argument_list|)
expr_stmt|;
name|mmput
argument_list|(
name|owning_mm
argument_list|)
expr_stmt|;
name|put_task_struct
argument_list|(
name|owning_process
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|char
modifier|*
name|mmap_cmd2str
parameter_list|(
name|enum
name|mlx5_ib_mmap_cmd
name|cmd
parameter_list|)
block|{
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MLX5_IB_MMAP_WC_PAGE
case|:
return|return
literal|"WC"
return|;
case|case
name|MLX5_IB_MMAP_REGULAR_PAGE
case|:
return|return
literal|"best effort WC"
return|;
case|case
name|MLX5_IB_MMAP_NC_PAGE
case|:
return|return
literal|"NC"
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|uar_mmap
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|enum
name|mlx5_ib_mmap_cmd
name|cmd
parameter_list|,
name|struct
name|vm_area_struct
modifier|*
name|vma
parameter_list|,
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|mlx5_uuar_info
modifier|*
name|uuari
init|=
operator|&
name|context
operator|->
name|uuari
decl_stmt|;
name|int
name|err
decl_stmt|;
name|unsigned
name|long
name|idx
decl_stmt|;
name|phys_addr_t
name|pfn
decl_stmt|,
name|pa
decl_stmt|;
name|pgprot_t
name|prot
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|MLX5_IB_MMAP_WC_PAGE
case|:
comment|/* Some architectures don't support WC memory */
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_X86
argument_list|)
if|if
condition|(
operator|!
name|pat_enabled
argument_list|()
condition|)
return|return
operator|-
name|EPERM
return|;
elif|#
directive|elif
operator|!
operator|(
name|defined
argument_list|(
name|CONFIG_PPC
argument_list|)
operator|||
operator|(
name|defined
argument_list|(
name|CONFIG_ARM
argument_list|)
operator|&&
name|defined
argument_list|(
name|CONFIG_MMU
argument_list|)
operator|)
operator|)
return|return
operator|-
name|EPERM
return|;
endif|#
directive|endif
comment|/* fall through */
case|case
name|MLX5_IB_MMAP_REGULAR_PAGE
case|:
comment|/* For MLX5_IB_MMAP_REGULAR_PAGE do the best effort to get WC */
name|prot
operator|=
name|pgprot_writecombine
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5_IB_MMAP_NC_PAGE
case|:
name|prot
operator|=
name|pgprot_noncached
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|vma
operator|->
name|vm_end
operator|-
name|vma
operator|->
name|vm_start
operator|!=
name|PAGE_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
name|idx
operator|=
name|get_index
argument_list|(
name|vma
operator|->
name|vm_pgoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|>=
name|uuari
operator|->
name|num_uars
condition|)
return|return
operator|-
name|EINVAL
return|;
name|pfn
operator|=
name|uar_index2pfn
argument_list|(
name|dev
argument_list|,
name|uuari
operator|->
name|uars
index|[
name|idx
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"uar idx 0x%lx, pfn %pa\n"
argument_list|,
name|idx
argument_list|,
operator|&
name|pfn
argument_list|)
expr_stmt|;
name|vma
operator|->
name|vm_page_prot
operator|=
name|prot
expr_stmt|;
name|err
operator|=
name|io_remap_pfn_range
argument_list|(
name|vma
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|pfn
argument_list|,
name|PAGE_SIZE
argument_list|,
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_err
argument_list|(
name|dev
argument_list|,
literal|"io_remap_pfn_range failed with error=%d, vm_start=0x%llx, pfn=%pa, mmap_cmd=%s\n"
argument_list|,
name|err
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|vma
operator|->
name|vm_start
argument_list|,
operator|&
name|pfn
argument_list|,
name|mmap_cmd2str
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|EAGAIN
return|;
block|}
name|pa
operator|=
name|pfn
operator|<<
name|PAGE_SHIFT
expr_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"mapped %s at 0x%llx, PA %pa\n"
argument_list|,
name|mmap_cmd2str
argument_list|(
name|cmd
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|vma
operator|->
name|vm_start
argument_list|,
operator|&
name|pa
argument_list|)
expr_stmt|;
return|return
name|mlx5_ib_set_vma_data
argument_list|(
name|vma
argument_list|,
name|context
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_mmap
parameter_list|(
name|struct
name|ib_ucontext
modifier|*
name|ibcontext
parameter_list|,
name|struct
name|vm_area_struct
modifier|*
name|vma
parameter_list|)
block|{
name|struct
name|mlx5_ib_ucontext
modifier|*
name|context
init|=
name|to_mucontext
argument_list|(
name|ibcontext
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibcontext
operator|->
name|device
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|command
decl_stmt|;
name|phys_addr_t
name|pfn
decl_stmt|;
name|command
operator|=
name|get_command
argument_list|(
name|vma
operator|->
name|vm_pgoff
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|MLX5_IB_MMAP_WC_PAGE
case|:
case|case
name|MLX5_IB_MMAP_NC_PAGE
case|:
case|case
name|MLX5_IB_MMAP_REGULAR_PAGE
case|:
return|return
name|uar_mmap
argument_list|(
name|dev
argument_list|,
name|command
argument_list|,
name|vma
argument_list|,
name|context
argument_list|)
return|;
case|case
name|MLX5_IB_MMAP_GET_CONTIGUOUS_PAGES
case|:
return|return
operator|-
name|ENOSYS
return|;
case|case
name|MLX5_IB_MMAP_CORE_CLOCK
case|:
if|if
condition|(
name|vma
operator|->
name|vm_end
operator|-
name|vma
operator|->
name|vm_start
operator|!=
name|PAGE_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|vma
operator|->
name|vm_flags
operator|&
name|VM_WRITE
condition|)
return|return
operator|-
name|EPERM
return|;
comment|/* Don't expose to user-space information it shouldn't have */
if|if
condition|(
name|PAGE_SIZE
operator|>
literal|4096
condition|)
return|return
operator|-
name|EOPNOTSUPP
return|;
name|vma
operator|->
name|vm_page_prot
operator|=
name|pgprot_noncached
argument_list|(
name|vma
operator|->
name|vm_page_prot
argument_list|)
expr_stmt|;
name|pfn
operator|=
operator|(
name|dev
operator|->
name|mdev
operator|->
name|iseg_base
operator|+
name|offsetof
argument_list|(
expr|struct
name|mlx5_init_seg
argument_list|,
name|internal_timer_h
argument_list|)
operator|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
if|if
condition|(
name|io_remap_pfn_range
argument_list|(
name|vma
argument_list|,
name|vma
operator|->
name|vm_start
argument_list|,
name|pfn
argument_list|,
name|PAGE_SIZE
argument_list|,
name|vma
operator|->
name|vm_page_prot
argument_list|)
condition|)
return|return
operator|-
name|EAGAIN
return|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"mapped internal timer at 0x%llx, PA 0x%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|vma
operator|->
name|vm_start
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|pfn
operator|<<
name|PAGE_SHIFT
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_pd
modifier|*
name|mlx5_ib_alloc_pd
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|ib_ucontext
modifier|*
name|context
parameter_list|,
name|struct
name|ib_udata
modifier|*
name|udata
parameter_list|)
block|{
name|struct
name|mlx5_ib_alloc_pd_resp
name|resp
decl_stmt|;
name|struct
name|mlx5_ib_pd
modifier|*
name|pd
decl_stmt|;
name|int
name|err
decl_stmt|;
name|pd
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pd
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|err
operator|=
name|mlx5_core_alloc_pd
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
operator|->
name|mdev
argument_list|,
operator|&
name|pd
operator|->
name|pdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|kfree
argument_list|(
name|pd
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
if|if
condition|(
name|context
condition|)
block|{
name|resp
operator|.
name|pdn
operator|=
name|pd
operator|->
name|pdn
expr_stmt|;
if|if
condition|(
name|ib_copy_to_udata
argument_list|(
name|udata
argument_list|,
operator|&
name|resp
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|)
condition|)
block|{
name|mlx5_core_dealloc_pd
argument_list|(
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
operator|->
name|mdev
argument_list|,
name|pd
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|pd
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EFAULT
argument_list|)
return|;
block|}
block|}
return|return
operator|&
name|pd
operator|->
name|ibpd
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_dealloc_pd
parameter_list|(
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|mdev
init|=
name|to_mdev
argument_list|(
name|pd
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_pd
modifier|*
name|mpd
init|=
name|to_mpd
argument_list|(
name|pd
argument_list|)
decl_stmt|;
name|mlx5_core_dealloc_pd
argument_list|(
name|mdev
operator|->
name|mdev
argument_list|,
name|mpd
operator|->
name|pdn
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|mpd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MATCH_CRITERIA_ENABLE_OUTER_BIT
block|,
name|MATCH_CRITERIA_ENABLE_MISC_BIT
block|,
name|MATCH_CRITERIA_ENABLE_INNER_BIT
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|HEADER_IS_ZERO
parameter_list|(
name|match_criteria
parameter_list|,
name|headers
parameter_list|)
define|\
value|!(memchr_inv(MLX5_ADDR_OF(fte_match_param, match_criteria, headers), \ 		    0, MLX5_FLD_SZ_BYTES(fte_match_param, headers)))       \  static u8 get_match_criteria_enable(u32 *match_criteria)
end_define

begin_block
block|{
name|u8
name|match_criteria_enable
decl_stmt|;
name|match_criteria_enable
operator|=
operator|(
operator|!
name|HEADER_IS_ZERO
argument_list|(
name|match_criteria
argument_list|,
name|outer_headers
argument_list|)
operator|)
operator|<<
name|MATCH_CRITERIA_ENABLE_OUTER_BIT
expr_stmt|;
name|match_criteria_enable
operator||=
operator|(
operator|!
name|HEADER_IS_ZERO
argument_list|(
name|match_criteria
argument_list|,
name|misc_parameters
argument_list|)
operator|)
operator|<<
name|MATCH_CRITERIA_ENABLE_MISC_BIT
expr_stmt|;
name|match_criteria_enable
operator||=
operator|(
operator|!
name|HEADER_IS_ZERO
argument_list|(
name|match_criteria
argument_list|,
name|inner_headers
argument_list|)
operator|)
operator|<<
name|MATCH_CRITERIA_ENABLE_INNER_BIT
expr_stmt|;
return|return
name|match_criteria_enable
return|;
block|}
end_block

begin_function
specifier|static
name|void
name|set_proto
parameter_list|(
name|void
modifier|*
name|outer_c
parameter_list|,
name|void
modifier|*
name|outer_v
parameter_list|,
name|u8
name|mask
parameter_list|,
name|u8
name|val
parameter_list|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_c
argument_list|,
name|ip_protocol
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_v
argument_list|,
name|ip_protocol
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_tos
parameter_list|(
name|void
modifier|*
name|outer_c
parameter_list|,
name|void
modifier|*
name|outer_v
parameter_list|,
name|u8
name|mask
parameter_list|,
name|u8
name|val
parameter_list|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_c
argument_list|,
name|ip_ecn
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_v
argument_list|,
name|ip_ecn
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_c
argument_list|,
name|ip_dscp
argument_list|,
name|mask
operator|>>
literal|2
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_v
argument_list|,
name|ip_dscp
argument_list|,
name|val
operator|>>
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|LAST_ETH_FIELD
value|vlan_tag
end_define

begin_define
define|#
directive|define
name|LAST_IB_FIELD
value|sl
end_define

begin_define
define|#
directive|define
name|LAST_IPV4_FIELD
value|tos
end_define

begin_define
define|#
directive|define
name|LAST_IPV6_FIELD
value|traffic_class
end_define

begin_define
define|#
directive|define
name|LAST_TCP_UDP_FIELD
value|src_port
end_define

begin_comment
comment|/* Field is the last supported field */
end_comment

begin_define
define|#
directive|define
name|FIELDS_NOT_SUPPORTED
parameter_list|(
name|filter
parameter_list|,
name|field
parameter_list|)
define|\
value|memchr_inv((void *)&filter.field  +\ 		   sizeof(filter.field), 0,\ 		   sizeof(filter) -\ 		   offsetof(typeof(filter), field) -\ 		   sizeof(filter.field))
end_define

begin_function
specifier|static
name|int
name|parse_flow_attr
parameter_list|(
name|u32
modifier|*
name|match_c
parameter_list|,
name|u32
modifier|*
name|match_v
parameter_list|,
specifier|const
name|union
name|ib_flow_spec
modifier|*
name|ib_spec
parameter_list|)
block|{
name|void
modifier|*
name|outer_headers_c
init|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|match_c
argument_list|,
name|outer_headers
argument_list|)
decl_stmt|;
name|void
modifier|*
name|outer_headers_v
init|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|match_v
argument_list|,
name|outer_headers
argument_list|)
decl_stmt|;
name|void
modifier|*
name|misc_params_c
init|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|match_c
argument_list|,
name|misc_parameters
argument_list|)
decl_stmt|;
name|void
modifier|*
name|misc_params_v
init|=
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_param
argument_list|,
name|match_v
argument_list|,
name|misc_parameters
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ib_spec
operator|->
name|type
condition|)
block|{
case|case
name|IB_FLOW_SPEC_ETH
case|:
if|if
condition|(
name|FIELDS_NOT_SUPPORTED
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|mask
argument_list|,
name|LAST_ETH_FIELD
argument_list|)
condition|)
return|return
operator|-
name|ENOTSUPP
return|;
name|ether_addr_copy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|dmac_47_16
argument_list|)
argument_list|,
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|dst_mac
argument_list|)
expr_stmt|;
name|ether_addr_copy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|dmac_47_16
argument_list|)
argument_list|,
name|ib_spec
operator|->
name|eth
operator|.
name|val
operator|.
name|dst_mac
argument_list|)
expr_stmt|;
name|ether_addr_copy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|smac_47_16
argument_list|)
argument_list|,
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|src_mac
argument_list|)
expr_stmt|;
name|ether_addr_copy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|smac_47_16
argument_list|)
argument_list|,
name|ib_spec
operator|->
name|eth
operator|.
name|val
operator|.
name|src_mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|vlan_tag
condition|)
block|{
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|cvlan_tag
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|cvlan_tag
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|first_vid
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|vlan_tag
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|first_vid
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|val
operator|.
name|vlan_tag
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|first_cfi
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|vlan_tag
argument_list|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|first_cfi
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|val
operator|.
name|vlan_tag
argument_list|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|first_prio
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|vlan_tag
argument_list|)
operator|>>
literal|13
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|first_prio
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|val
operator|.
name|vlan_tag
argument_list|)
operator|>>
literal|13
argument_list|)
expr_stmt|;
block|}
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|ethertype
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|ethertype
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|eth
operator|.
name|val
operator|.
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_FLOW_SPEC_IPV4
case|:
if|if
condition|(
name|FIELDS_NOT_SUPPORTED
argument_list|(
name|ib_spec
operator|->
name|ipv4
operator|.
name|mask
argument_list|,
name|LAST_IPV4_FIELD
argument_list|)
condition|)
return|return
operator|-
name|ENOTSUPP
return|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|ethertype
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|ethertype
argument_list|,
name|ETH_P_IP
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|src_ipv4_src_ipv6
operator|.
name|ipv4_layout
operator|.
name|ipv4
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv4
operator|.
name|mask
operator|.
name|src_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv4
operator|.
name|mask
operator|.
name|src_ip
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|src_ipv4_src_ipv6
operator|.
name|ipv4_layout
operator|.
name|ipv4
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv4
operator|.
name|val
operator|.
name|src_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv4
operator|.
name|val
operator|.
name|src_ip
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|dst_ipv4_dst_ipv6
operator|.
name|ipv4_layout
operator|.
name|ipv4
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv4
operator|.
name|mask
operator|.
name|dst_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv4
operator|.
name|mask
operator|.
name|dst_ip
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|dst_ipv4_dst_ipv6
operator|.
name|ipv4_layout
operator|.
name|ipv4
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv4
operator|.
name|val
operator|.
name|dst_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv4
operator|.
name|val
operator|.
name|dst_ip
argument_list|)
argument_list|)
expr_stmt|;
name|set_tos
argument_list|(
name|outer_headers_c
argument_list|,
name|outer_headers_v
argument_list|,
name|ib_spec
operator|->
name|ipv4
operator|.
name|mask
operator|.
name|tos
argument_list|,
name|ib_spec
operator|->
name|ipv4
operator|.
name|val
operator|.
name|tos
argument_list|)
expr_stmt|;
name|set_proto
argument_list|(
name|outer_headers_c
argument_list|,
name|outer_headers_v
argument_list|,
name|ib_spec
operator|->
name|ipv4
operator|.
name|mask
operator|.
name|proto
argument_list|,
name|ib_spec
operator|->
name|ipv4
operator|.
name|val
operator|.
name|proto
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_FLOW_SPEC_IPV6
case|:
if|if
condition|(
name|FIELDS_NOT_SUPPORTED
argument_list|(
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
argument_list|,
name|LAST_IPV6_FIELD
argument_list|)
condition|)
return|return
operator|-
name|ENOTSUPP
return|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|ethertype
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|ethertype
argument_list|,
name|IPPROTO_IPV6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|src_ipv4_src_ipv6
operator|.
name|ipv6_layout
operator|.
name|ipv6
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
operator|.
name|src_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
operator|.
name|src_ip
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|src_ipv4_src_ipv6
operator|.
name|ipv6_layout
operator|.
name|ipv6
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv6
operator|.
name|val
operator|.
name|src_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv6
operator|.
name|val
operator|.
name|src_ip
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|dst_ipv4_dst_ipv6
operator|.
name|ipv6_layout
operator|.
name|ipv6
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
operator|.
name|dst_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
operator|.
name|dst_ip
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|MLX5_ADDR_OF
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|dst_ipv4_dst_ipv6
operator|.
name|ipv6_layout
operator|.
name|ipv6
argument_list|)
argument_list|,
operator|&
name|ib_spec
operator|->
name|ipv6
operator|.
name|val
operator|.
name|dst_ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ib_spec
operator|->
name|ipv6
operator|.
name|val
operator|.
name|dst_ip
argument_list|)
argument_list|)
expr_stmt|;
name|set_tos
argument_list|(
name|outer_headers_c
argument_list|,
name|outer_headers_v
argument_list|,
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
operator|.
name|traffic_class
argument_list|,
name|ib_spec
operator|->
name|ipv6
operator|.
name|val
operator|.
name|traffic_class
argument_list|)
expr_stmt|;
name|set_proto
argument_list|(
name|outer_headers_c
argument_list|,
name|outer_headers_v
argument_list|,
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
operator|.
name|next_hdr
argument_list|,
name|ib_spec
operator|->
name|ipv6
operator|.
name|val
operator|.
name|next_hdr
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_misc
argument_list|,
name|misc_params_c
argument_list|,
name|outer_ipv6_flow_label
argument_list|,
name|ntohl
argument_list|(
name|ib_spec
operator|->
name|ipv6
operator|.
name|mask
operator|.
name|flow_label
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_misc
argument_list|,
name|misc_params_v
argument_list|,
name|outer_ipv6_flow_label
argument_list|,
name|ntohl
argument_list|(
name|ib_spec
operator|->
name|ipv6
operator|.
name|val
operator|.
name|flow_label
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_FLOW_SPEC_TCP
case|:
if|if
condition|(
name|FIELDS_NOT_SUPPORTED
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|mask
argument_list|,
name|LAST_TCP_UDP_FIELD
argument_list|)
condition|)
return|return
operator|-
name|ENOTSUPP
return|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|ip_protocol
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|ip_protocol
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|tcp_sport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|mask
operator|.
name|src_port
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|tcp_sport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|val
operator|.
name|src_port
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|tcp_dport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|mask
operator|.
name|dst_port
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|tcp_dport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|val
operator|.
name|dst_port
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_FLOW_SPEC_UDP
case|:
if|if
condition|(
name|FIELDS_NOT_SUPPORTED
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|mask
argument_list|,
name|LAST_TCP_UDP_FIELD
argument_list|)
condition|)
return|return
operator|-
name|ENOTSUPP
return|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|ip_protocol
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|ip_protocol
argument_list|,
name|IPPROTO_UDP
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|udp_sport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|mask
operator|.
name|src_port
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|udp_sport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|val
operator|.
name|src_port
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_c
argument_list|,
name|udp_dport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|mask
operator|.
name|dst_port
argument_list|)
argument_list|)
expr_stmt|;
name|MLX5_SET
argument_list|(
name|fte_match_set_lyr_2_4
argument_list|,
name|outer_headers_v
argument_list|,
name|udp_dport
argument_list|,
name|ntohs
argument_list|(
name|ib_spec
operator|->
name|tcp_udp
operator|.
name|val
operator|.
name|dst_port
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* If a flow could catch both multicast and unicast packets,  * it won't fall into the multicast flow steering table and this rule  * could steal other multicast packets.  */
end_comment

begin_function
specifier|static
name|bool
name|flow_is_multicast_only
parameter_list|(
name|struct
name|ib_flow_attr
modifier|*
name|ib_attr
parameter_list|)
block|{
name|struct
name|ib_flow_spec_eth
modifier|*
name|eth_spec
decl_stmt|;
if|if
condition|(
name|ib_attr
operator|->
name|type
operator|!=
name|IB_FLOW_ATTR_NORMAL
operator|||
name|ib_attr
operator|->
name|size
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ib_flow_attr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ib_flow_spec_eth
argument_list|)
operator|||
name|ib_attr
operator|->
name|num_of_specs
operator|<
literal|1
condition|)
return|return
name|false
return|;
name|eth_spec
operator|=
operator|(
expr|struct
name|ib_flow_spec_eth
operator|*
operator|)
operator|(
name|ib_attr
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|eth_spec
operator|->
name|type
operator|!=
name|IB_FLOW_SPEC_ETH
operator|||
name|eth_spec
operator|->
name|size
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|eth_spec
argument_list|)
condition|)
return|return
name|false
return|;
return|return
name|is_multicast_ether_addr
argument_list|(
name|eth_spec
operator|->
name|mask
operator|.
name|dst_mac
argument_list|)
operator|&&
name|is_multicast_ether_addr
argument_list|(
name|eth_spec
operator|->
name|val
operator|.
name|dst_mac
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|is_valid_attr
parameter_list|(
specifier|const
name|struct
name|ib_flow_attr
modifier|*
name|flow_attr
parameter_list|)
block|{
name|union
name|ib_flow_spec
modifier|*
name|ib_spec
init|=
operator|(
expr|union
name|ib_flow_spec
operator|*
operator|)
operator|(
name|flow_attr
operator|+
literal|1
operator|)
decl_stmt|;
name|bool
name|has_ipv4_spec
init|=
name|false
decl_stmt|;
name|bool
name|eth_type_ipv4
init|=
name|true
decl_stmt|;
name|unsigned
name|int
name|spec_index
decl_stmt|;
comment|/* Validate that ethertype is correct */
for|for
control|(
name|spec_index
operator|=
literal|0
init|;
name|spec_index
operator|<
name|flow_attr
operator|->
name|num_of_specs
condition|;
name|spec_index
operator|++
control|)
block|{
if|if
condition|(
name|ib_spec
operator|->
name|type
operator|==
name|IB_FLOW_SPEC_ETH
operator|&&
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|ether_type
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
name|ib_spec
operator|->
name|eth
operator|.
name|mask
operator|.
name|ether_type
operator|==
name|htons
argument_list|(
literal|0xffff
argument_list|)
operator|)
operator|&&
name|ib_spec
operator|->
name|eth
operator|.
name|val
operator|.
name|ether_type
operator|==
name|htons
argument_list|(
name|ETH_P_IP
argument_list|)
operator|)
condition|)
name|eth_type_ipv4
operator|=
name|false
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ib_spec
operator|->
name|type
operator|==
name|IB_FLOW_SPEC_IPV4
condition|)
block|{
name|has_ipv4_spec
operator|=
name|true
expr_stmt|;
block|}
name|ib_spec
operator|=
operator|(
name|void
operator|*
operator|)
name|ib_spec
operator|+
name|ib_spec
operator|->
name|size
expr_stmt|;
block|}
return|return
operator|!
name|has_ipv4_spec
operator|||
name|eth_type_ipv4
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|put_flow_table
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|prio
parameter_list|,
name|bool
name|ft_added
parameter_list|)
block|{
name|prio
operator|->
name|refcount
operator|-=
operator|!
operator|!
name|ft_added
expr_stmt|;
if|if
condition|(
operator|!
name|prio
operator|->
name|refcount
condition|)
block|{
name|mlx5_destroy_flow_table
argument_list|(
name|prio
operator|->
name|flow_table
argument_list|)
expr_stmt|;
name|prio
operator|->
name|flow_table
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_destroy_flow
parameter_list|(
name|struct
name|ib_flow
modifier|*
name|flow_id
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|flow_id
operator|->
name|qp
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler
init|=
name|container_of
argument_list|(
name|flow_id
argument_list|,
expr|struct
name|mlx5_ib_flow_handler
argument_list|,
name|ibflow
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|iter
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|iter
argument_list|,
argument|tmp
argument_list|,
argument|&handler->list
argument_list|,
argument|list
argument_list|)
block|{
name|mlx5_del_flow_rule
argument_list|(
name|iter
operator|->
name|rule
argument_list|)
expr_stmt|;
name|put_flow_table
argument_list|(
name|dev
argument_list|,
name|iter
operator|->
name|prio
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|iter
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|iter
argument_list|)
expr_stmt|;
block|}
name|mlx5_del_flow_rule
argument_list|(
name|handler
operator|->
name|rule
argument_list|)
expr_stmt|;
name|put_flow_table
argument_list|(
name|dev
argument_list|,
name|handler
operator|->
name|prio
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|lock
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|handler
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ib_prio_to_core_prio
parameter_list|(
name|unsigned
name|int
name|priority
parameter_list|,
name|bool
name|dont_trap
parameter_list|)
block|{
name|priority
operator|*=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|dont_trap
condition|)
name|priority
operator|++
expr_stmt|;
return|return
name|priority
return|;
block|}
end_function

begin_enum
enum|enum
name|flow_table_type
block|{
name|MLX5_IB_FT_RX
block|,
name|MLX5_IB_FT_TX
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|MLX5_FS_MAX_TYPES
value|10
end_define

begin_define
define|#
directive|define
name|MLX5_FS_MAX_ENTRIES
value|32000UL
end_define

begin_function
specifier|static
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|get_flow_table
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|ib_flow_attr
modifier|*
name|flow_attr
parameter_list|,
name|enum
name|flow_table_type
name|ft_type
parameter_list|)
block|{
name|bool
name|dont_trap
init|=
name|flow_attr
operator|->
name|flags
operator|&
name|IB_FLOW_ATTR_FLAGS_DONT_TRAP
decl_stmt|;
name|struct
name|mlx5_flow_namespace
modifier|*
name|ns
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|prio
decl_stmt|;
name|struct
name|mlx5_flow_table
modifier|*
name|ft
decl_stmt|;
name|int
name|num_entries
decl_stmt|;
name|int
name|num_groups
decl_stmt|;
name|int
name|priority
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_NORMAL
condition|)
block|{
if|if
condition|(
name|flow_is_multicast_only
argument_list|(
name|flow_attr
argument_list|)
operator|&&
operator|!
name|dont_trap
condition|)
name|priority
operator|=
name|MLX5_IB_FLOW_MCAST_PRIO
expr_stmt|;
else|else
name|priority
operator|=
name|ib_prio_to_core_prio
argument_list|(
name|flow_attr
operator|->
name|priority
argument_list|,
name|dont_trap
argument_list|)
expr_stmt|;
name|ns
operator|=
name|mlx5_get_flow_namespace
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|MLX5_FLOW_NAMESPACE_BYPASS
argument_list|)
expr_stmt|;
name|num_entries
operator|=
name|MLX5_FS_MAX_ENTRIES
expr_stmt|;
name|num_groups
operator|=
name|MLX5_FS_MAX_TYPES
expr_stmt|;
name|prio
operator|=
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|prios
index|[
name|priority
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_ALL_DEFAULT
operator|||
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_MC_DEFAULT
condition|)
block|{
name|ns
operator|=
name|mlx5_get_flow_namespace
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|MLX5_FLOW_NAMESPACE_LEFTOVERS
argument_list|)
expr_stmt|;
name|build_leftovers_ft_param
argument_list|(
literal|"bypass"
argument_list|,
operator|&
name|priority
argument_list|,
operator|&
name|num_entries
argument_list|,
operator|&
name|num_groups
argument_list|)
expr_stmt|;
name|prio
operator|=
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|prios
index|[
name|MLX5_IB_FLOW_LEFTOVERS_PRIO
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_SNIFFER
condition|)
block|{
if|if
condition|(
operator|!
name|MLX5_CAP_FLOWTABLE
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|allow_sniffer_and_nic_rx_shared_tir
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOTSUPP
argument_list|)
return|;
name|ns
operator|=
name|mlx5_get_flow_namespace
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|ft_type
operator|==
name|MLX5_IB_FT_RX
condition|?
name|MLX5_FLOW_NAMESPACE_SNIFFER_RX
else|:
name|MLX5_FLOW_NAMESPACE_SNIFFER_TX
argument_list|)
expr_stmt|;
name|prio
operator|=
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|sniffer
index|[
name|ft_type
index|]
expr_stmt|;
name|priority
operator|=
literal|0
expr_stmt|;
name|num_entries
operator|=
literal|1
expr_stmt|;
name|num_groups
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ns
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOTSUPP
argument_list|)
return|;
name|ft
operator|=
name|prio
operator|->
name|flow_table
expr_stmt|;
if|if
condition|(
operator|!
name|ft
condition|)
block|{
name|ft
operator|=
name|mlx5_create_auto_grouped_flow_table
argument_list|(
name|ns
argument_list|,
name|priority
argument_list|,
literal|"bypass"
argument_list|,
name|num_entries
argument_list|,
name|num_groups
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_ERR
argument_list|(
name|ft
argument_list|)
condition|)
block|{
name|prio
operator|->
name|refcount
operator|=
literal|0
expr_stmt|;
name|prio
operator|->
name|flow_table
operator|=
name|ft
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|ft
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|err
condition|?
name|ERR_PTR
argument_list|(
name|err
argument_list|)
else|:
name|prio
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|create_flow_rule
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|ft_prio
parameter_list|,
specifier|const
name|struct
name|ib_flow_attr
modifier|*
name|flow_attr
parameter_list|,
name|struct
name|mlx5_flow_destination
modifier|*
name|dst
parameter_list|)
block|{
name|struct
name|mlx5_flow_table
modifier|*
name|ft
init|=
name|ft_prio
operator|->
name|flow_table
decl_stmt|;
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler
decl_stmt|;
name|struct
name|mlx5_flow_spec
modifier|*
name|spec
decl_stmt|;
specifier|const
name|void
modifier|*
name|ib_flow
init|=
operator|(
specifier|const
name|void
operator|*
operator|)
name|flow_attr
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|flow_attr
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|spec_index
decl_stmt|;
name|u32
name|action
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|is_valid_attr
argument_list|(
name|flow_attr
argument_list|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|spec
operator|=
name|mlx5_vzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|spec
argument_list|)
argument_list|)
expr_stmt|;
name|handler
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|handler
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|handler
operator|||
operator|!
name|spec
condition|)
block|{
name|err
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|handler
operator|->
name|list
argument_list|)
expr_stmt|;
for|for
control|(
name|spec_index
operator|=
literal|0
init|;
name|spec_index
operator|<
name|flow_attr
operator|->
name|num_of_specs
condition|;
name|spec_index
operator|++
control|)
block|{
name|err
operator|=
name|parse_flow_attr
argument_list|(
name|spec
operator|->
name|match_criteria
argument_list|,
name|spec
operator|->
name|match_value
argument_list|,
name|ib_flow
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
goto|goto
name|free
goto|;
name|ib_flow
operator|+=
operator|(
operator|(
expr|union
name|ib_flow_spec
operator|*
operator|)
name|ib_flow
operator|)
operator|->
name|size
expr_stmt|;
block|}
name|spec
operator|->
name|match_criteria_enable
operator|=
name|get_match_criteria_enable
argument_list|(
name|spec
operator|->
name|match_criteria
argument_list|)
expr_stmt|;
name|action
operator|=
name|dst
condition|?
name|MLX5_FLOW_CONTEXT_ACTION_FWD_DEST
else|:
name|MLX5_FLOW_CONTEXT_ACTION_FWD_NEXT_PRIO
expr_stmt|;
name|handler
operator|->
name|rule
operator|=
name|mlx5_add_flow_rule
argument_list|(
name|ft
argument_list|,
name|spec
operator|->
name|match_criteria_enable
argument_list|,
name|spec
operator|->
name|match_criteria
argument_list|,
name|spec
operator|->
name|match_value
argument_list|,
name|action
argument_list|,
name|MLX5_FS_DEFAULT_FLOW_TAG
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|handler
operator|->
name|rule
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|handler
operator|->
name|rule
argument_list|)
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|ft_prio
operator|->
name|refcount
operator|++
expr_stmt|;
name|handler
operator|->
name|prio
operator|=
name|ft_prio
expr_stmt|;
name|ft_prio
operator|->
name|flow_table
operator|=
name|ft
expr_stmt|;
name|free
label|:
if|if
condition|(
name|err
condition|)
name|kfree
argument_list|(
name|handler
argument_list|)
expr_stmt|;
name|kvfree
argument_list|(
name|spec
argument_list|)
expr_stmt|;
return|return
name|err
condition|?
name|ERR_PTR
argument_list|(
name|err
argument_list|)
else|:
name|handler
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|create_dont_trap_rule
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|ft_prio
parameter_list|,
name|struct
name|ib_flow_attr
modifier|*
name|flow_attr
parameter_list|,
name|struct
name|mlx5_flow_destination
modifier|*
name|dst
parameter_list|)
block|{
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler_dst
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler
init|=
name|NULL
decl_stmt|;
name|handler
operator|=
name|create_flow_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
name|flow_attr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_ERR
argument_list|(
name|handler
argument_list|)
condition|)
block|{
name|handler_dst
operator|=
name|create_flow_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|handler_dst
argument_list|)
condition|)
block|{
name|mlx5_del_flow_rule
argument_list|(
name|handler
operator|->
name|rule
argument_list|)
expr_stmt|;
name|ft_prio
operator|->
name|refcount
operator|--
expr_stmt|;
name|kfree
argument_list|(
name|handler
argument_list|)
expr_stmt|;
name|handler
operator|=
name|handler_dst
expr_stmt|;
block|}
else|else
block|{
name|list_add
argument_list|(
operator|&
name|handler_dst
operator|->
name|list
argument_list|,
operator|&
name|handler
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|handler
return|;
block|}
end_function

begin_enum
enum|enum
block|{
name|LEFTOVERS_MC
block|,
name|LEFTOVERS_UC
block|, }
enum|;
end_enum

begin_function
specifier|static
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|create_leftovers_rule
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|ft_prio
parameter_list|,
name|struct
name|ib_flow_attr
modifier|*
name|flow_attr
parameter_list|,
name|struct
name|mlx5_flow_destination
modifier|*
name|dst
parameter_list|)
block|{
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler_ucast
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler
init|=
name|NULL
decl_stmt|;
specifier|static
struct|struct
block|{
name|struct
name|ib_flow_attr
name|flow_attr
decl_stmt|;
name|struct
name|ib_flow_spec_eth
name|eth_flow
decl_stmt|;
block|}
name|leftovers_specs
index|[]
init|=
block|{
index|[
name|LEFTOVERS_MC
index|]
operator|=
block|{
operator|.
name|flow_attr
operator|=
block|{
operator|.
name|num_of_specs
operator|=
literal|1
block|,
operator|.
name|size
operator|=
expr|sizeof
operator|(
name|leftovers_specs
index|[
literal|0
index|]
operator|)
block|}
block|,
operator|.
name|eth_flow
operator|=
block|{
operator|.
name|type
operator|=
name|IB_FLOW_SPEC_ETH
block|,
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ib_flow_spec_eth
argument_list|)
block|,
operator|.
name|mask
operator|=
block|{
operator|.
name|dst_mac
operator|=
block|{
literal|0x1
block|}
block|}
block|,
operator|.
name|val
operator|=
block|{
operator|.
name|dst_mac
operator|=
block|{
literal|0x1
block|}
block|}
block|}
block|}
block|,
index|[
name|LEFTOVERS_UC
index|]
operator|=
block|{
operator|.
name|flow_attr
operator|=
block|{
operator|.
name|num_of_specs
operator|=
literal|1
block|,
operator|.
name|size
operator|=
expr|sizeof
operator|(
name|leftovers_specs
index|[
literal|0
index|]
operator|)
block|}
block|,
operator|.
name|eth_flow
operator|=
block|{
operator|.
name|type
operator|=
name|IB_FLOW_SPEC_ETH
block|,
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ib_flow_spec_eth
argument_list|)
block|,
operator|.
name|mask
operator|=
block|{
operator|.
name|dst_mac
operator|=
block|{
literal|0x1
block|}
block|}
block|,
operator|.
name|val
operator|=
block|{
operator|.
name|dst_mac
operator|=
block|{}
block|}
block|}
block|}
block|}
struct|;
name|handler
operator|=
name|create_flow_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
operator|&
name|leftovers_specs
index|[
name|LEFTOVERS_MC
index|]
operator|.
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_ERR
argument_list|(
name|handler
argument_list|)
operator|&&
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_ALL_DEFAULT
condition|)
block|{
name|handler_ucast
operator|=
name|create_flow_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
operator|&
name|leftovers_specs
index|[
name|LEFTOVERS_UC
index|]
operator|.
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|handler_ucast
argument_list|)
condition|)
block|{
name|mlx5_del_flow_rule
argument_list|(
name|handler
operator|->
name|rule
argument_list|)
expr_stmt|;
name|ft_prio
operator|->
name|refcount
operator|--
expr_stmt|;
name|kfree
argument_list|(
name|handler
argument_list|)
expr_stmt|;
name|handler
operator|=
name|handler_ucast
expr_stmt|;
block|}
else|else
block|{
name|list_add
argument_list|(
operator|&
name|handler_ucast
operator|->
name|list
argument_list|,
operator|&
name|handler
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|handler
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|create_sniffer_rule
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|ft_rx
parameter_list|,
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|ft_tx
parameter_list|,
name|struct
name|mlx5_flow_destination
modifier|*
name|dst
parameter_list|)
block|{
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler_rx
decl_stmt|;
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler_tx
decl_stmt|;
name|int
name|err
decl_stmt|;
specifier|static
specifier|const
name|struct
name|ib_flow_attr
name|flow_attr
init|=
block|{
operator|.
name|num_of_specs
operator|=
literal|0
block|,
operator|.
name|size
operator|=
expr|sizeof
operator|(
name|flow_attr
operator|)
block|}
decl_stmt|;
name|handler_rx
operator|=
name|create_flow_rule
argument_list|(
name|dev
argument_list|,
name|ft_rx
argument_list|,
operator|&
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|handler_rx
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|handler_rx
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|handler_tx
operator|=
name|create_flow_rule
argument_list|(
name|dev
argument_list|,
name|ft_tx
argument_list|,
operator|&
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|handler_tx
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|handler_tx
argument_list|)
expr_stmt|;
goto|goto
name|err_tx
goto|;
block|}
name|list_add
argument_list|(
operator|&
name|handler_tx
operator|->
name|list
argument_list|,
operator|&
name|handler_rx
operator|->
name|list
argument_list|)
expr_stmt|;
return|return
name|handler_rx
return|;
name|err_tx
label|:
name|mlx5_del_flow_rule
argument_list|(
name|handler_rx
operator|->
name|rule
argument_list|)
expr_stmt|;
name|ft_rx
operator|->
name|refcount
operator|--
expr_stmt|;
name|kfree
argument_list|(
name|handler_rx
argument_list|)
expr_stmt|;
name|err
label|:
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_flow
modifier|*
name|mlx5_ib_create_flow
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|,
name|struct
name|ib_flow_attr
modifier|*
name|flow_attr
parameter_list|,
name|int
name|domain
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|qp
operator|->
name|device
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_qp
modifier|*
name|mqp
init|=
name|to_mqp
argument_list|(
name|qp
argument_list|)
decl_stmt|;
name|struct
name|mlx5_ib_flow_handler
modifier|*
name|handler
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_flow_destination
modifier|*
name|dst
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|ft_prio_tx
init|=
name|NULL
decl_stmt|;
name|struct
name|mlx5_ib_flow_prio
modifier|*
name|ft_prio
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|flow_attr
operator|->
name|priority
operator|>
name|MLX5_IB_FLOW_LAST_PRIO
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOSPC
argument_list|)
return|;
if|if
condition|(
name|domain
operator|!=
name|IB_FLOW_DOMAIN_USER
operator|||
name|flow_attr
operator|->
name|port
operator|>
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
operator|||
operator|(
name|flow_attr
operator|->
name|flags
operator|&
operator|~
name|IB_FLOW_ATTR_FLAGS_DONT_TRAP
operator|)
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|EINVAL
argument_list|)
return|;
name|dst
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst
condition|)
return|return
name|ERR_PTR
argument_list|(
operator|-
name|ENOMEM
argument_list|)
return|;
name|mutex_lock
argument_list|(
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|lock
argument_list|)
expr_stmt|;
name|ft_prio
operator|=
name|get_flow_table
argument_list|(
name|dev
argument_list|,
name|flow_attr
argument_list|,
name|MLX5_IB_FT_RX
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|ft_prio
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|ft_prio
argument_list|)
expr_stmt|;
goto|goto
name|unlock
goto|;
block|}
if|if
condition|(
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_SNIFFER
condition|)
block|{
name|ft_prio_tx
operator|=
name|get_flow_table
argument_list|(
name|dev
argument_list|,
name|flow_attr
argument_list|,
name|MLX5_IB_FT_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|ft_prio_tx
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|ft_prio_tx
argument_list|)
expr_stmt|;
name|ft_prio_tx
operator|=
name|NULL
expr_stmt|;
goto|goto
name|destroy_ft
goto|;
block|}
block|}
name|dst
operator|->
name|type
operator|=
name|MLX5_FLOW_DESTINATION_TYPE_TIR
expr_stmt|;
if|if
condition|(
name|mqp
operator|->
name|flags
operator|&
name|MLX5_IB_QP_RSS
condition|)
name|dst
operator|->
name|tir_num
operator|=
name|mqp
operator|->
name|rss_qp
operator|.
name|tirn
expr_stmt|;
else|else
name|dst
operator|->
name|tir_num
operator|=
name|mqp
operator|->
name|raw_packet_qp
operator|.
name|rq
operator|.
name|tirn
expr_stmt|;
if|if
condition|(
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_NORMAL
condition|)
block|{
if|if
condition|(
name|flow_attr
operator|->
name|flags
operator|&
name|IB_FLOW_ATTR_FLAGS_DONT_TRAP
condition|)
block|{
name|handler
operator|=
name|create_dont_trap_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|handler
operator|=
name|create_flow_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_ALL_DEFAULT
operator|||
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_MC_DEFAULT
condition|)
block|{
name|handler
operator|=
name|create_leftovers_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
name|flow_attr
argument_list|,
name|dst
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|flow_attr
operator|->
name|type
operator|==
name|IB_FLOW_ATTR_SNIFFER
condition|)
block|{
name|handler
operator|=
name|create_sniffer_rule
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
name|ft_prio_tx
argument_list|,
name|dst
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|destroy_ft
goto|;
block|}
if|if
condition|(
name|IS_ERR
argument_list|(
name|handler
argument_list|)
condition|)
block|{
name|err
operator|=
name|PTR_ERR
argument_list|(
name|handler
argument_list|)
expr_stmt|;
name|handler
operator|=
name|NULL
expr_stmt|;
goto|goto
name|destroy_ft
goto|;
block|}
name|mutex_unlock
argument_list|(
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|lock
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dst
argument_list|)
expr_stmt|;
return|return
operator|&
name|handler
operator|->
name|ibflow
return|;
name|destroy_ft
label|:
name|put_flow_table
argument_list|(
name|dev
argument_list|,
name|ft_prio
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|ft_prio_tx
condition|)
name|put_flow_table
argument_list|(
name|dev
argument_list|,
name|ft_prio_tx
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|unlock
label|:
name|mutex_unlock
argument_list|(
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|lock
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dst
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|handler
argument_list|)
expr_stmt|;
return|return
name|ERR_PTR
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_mcg_attach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibqp
operator|->
name|device
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_core_attach_mcg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|gid
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed attaching QPN 0x%x, MGID %pI6\n"
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|,
name|gid
operator|->
name|raw
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_mcg_detach
parameter_list|(
name|struct
name|ib_qp
modifier|*
name|ibqp
parameter_list|,
name|union
name|ib_gid
modifier|*
name|gid
parameter_list|,
name|u16
name|lid
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibqp
operator|->
name|device
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_core_detach_mcg
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|gid
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"failed detaching QPN 0x%x, MGID %pI6\n"
argument_list|,
name|ibqp
operator|->
name|qp_num
argument_list|,
name|gid
operator|->
name|raw
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|init_node_data
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_query_node_desc
argument_list|(
name|dev
argument_list|,
name|dev
operator|->
name|ib_dev
operator|.
name|node_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
return|return
name|mlx5_query_node_guid
argument_list|(
name|dev
argument_list|,
operator|&
name|dev
operator|->
name|ib_dev
operator|.
name|node_guid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_fw_pages
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|fw_pages
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_reg_pages
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d\n"
argument_list|,
name|atomic_read
argument_list|(
operator|&
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|reg_pages
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_hca
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"MT%d\n"
argument_list|,
name|dev
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|device
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_rev
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%x\n"
argument_list|,
name|dev
operator|->
name|mdev
operator|->
name|pdev
operator|->
name|revision
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
name|show_board
parameter_list|(
name|struct
name|device
modifier|*
name|device
parameter_list|,
name|struct
name|device_attribute
modifier|*
name|attr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|device
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
operator|.
name|dev
argument_list|)
decl_stmt|;
return|return
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%.*s\n"
argument_list|,
name|MLX5_BOARD_ID_LEN
argument_list|,
name|dev
operator|->
name|mdev
operator|->
name|board_id
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|hw_rev
argument_list|,
name|S_IRUGO
argument_list|,
name|show_rev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|hca_type
argument_list|,
name|S_IRUGO
argument_list|,
name|show_hca
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|board_id
argument_list|,
name|S_IRUGO
argument_list|,
name|show_board
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|fw_pages
argument_list|,
name|S_IRUGO
argument_list|,
name|show_fw_pages
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|DEVICE_ATTR
argument_list|(
name|reg_pages
argument_list|,
name|S_IRUGO
argument_list|,
name|show_reg_pages
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|device_attribute
modifier|*
name|mlx5_class_attributes
index|[]
init|=
block|{
operator|&
name|dev_attr_hw_rev
block|,
operator|&
name|dev_attr_hca_type
block|,
operator|&
name|dev_attr_board_id
block|,
operator|&
name|dev_attr_fw_pages
block|,
operator|&
name|dev_attr_reg_pages
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|pkey_change_handler
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|mlx5_ib_port_resources
modifier|*
name|ports
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|mlx5_ib_port_resources
argument_list|,
name|pkey_change_work
argument_list|)
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|ports
operator|->
name|devr
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|mlx5_ib_gsi_pkey_change
argument_list|(
name|ports
operator|->
name|gsi
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|ports
operator|->
name|devr
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_handle_internal_error
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|ibdev
parameter_list|)
block|{
name|struct
name|mlx5_ib_qp
modifier|*
name|mqp
decl_stmt|;
name|struct
name|mlx5_ib_cq
modifier|*
name|send_mcq
decl_stmt|,
modifier|*
name|recv_mcq
decl_stmt|;
name|struct
name|mlx5_core_cq
modifier|*
name|mcq
decl_stmt|;
name|struct
name|list_head
name|cq_armed_list
decl_stmt|;
name|unsigned
name|long
name|flags_qp
decl_stmt|;
name|unsigned
name|long
name|flags_cq
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|cq_armed_list
argument_list|)
expr_stmt|;
comment|/* Go over qp list reside on that ibdev, sync with create/destroy qp.*/
name|spin_lock_irqsave
argument_list|(
operator|&
name|ibdev
operator|->
name|reset_flow_resource_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|mqp
argument_list|,
argument|&ibdev->qp_list
argument_list|,
argument|qps_list
argument_list|)
block|{
name|spin_lock_irqsave
argument_list|(
operator|&
name|mqp
operator|->
name|sq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mqp
operator|->
name|sq
operator|.
name|tail
operator|!=
name|mqp
operator|->
name|sq
operator|.
name|head
condition|)
block|{
name|send_mcq
operator|=
name|to_mcq
argument_list|(
name|mqp
operator|->
name|ibqp
operator|.
name|send_cq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|send_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_mcq
operator|->
name|mcq
operator|.
name|comp
operator|&&
name|mqp
operator|->
name|ibqp
operator|.
name|send_cq
operator|->
name|comp_handler
condition|)
block|{
if|if
condition|(
operator|!
name|send_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
condition|)
block|{
name|send_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
operator|=
literal|1
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|send_mcq
operator|->
name|mcq
operator|.
name|reset_notify
argument_list|,
operator|&
name|cq_armed_list
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|send_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|mqp
operator|->
name|sq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|mqp
operator|->
name|rq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
comment|/* no handling is needed for SRQ */
if|if
condition|(
operator|!
name|mqp
operator|->
name|ibqp
operator|.
name|srq
condition|)
block|{
if|if
condition|(
name|mqp
operator|->
name|rq
operator|.
name|tail
operator|!=
name|mqp
operator|->
name|rq
operator|.
name|head
condition|)
block|{
name|recv_mcq
operator|=
name|to_mcq
argument_list|(
name|mqp
operator|->
name|ibqp
operator|.
name|recv_cq
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|recv_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|recv_mcq
operator|->
name|mcq
operator|.
name|comp
operator|&&
name|mqp
operator|->
name|ibqp
operator|.
name|recv_cq
operator|->
name|comp_handler
condition|)
block|{
if|if
condition|(
operator|!
name|recv_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
condition|)
block|{
name|recv_mcq
operator|->
name|mcq
operator|.
name|reset_notify_added
operator|=
literal|1
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|recv_mcq
operator|->
name|mcq
operator|.
name|reset_notify
argument_list|,
operator|&
name|cq_armed_list
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|recv_mcq
operator|->
name|lock
argument_list|,
name|flags_cq
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|mqp
operator|->
name|rq
operator|.
name|lock
argument_list|,
name|flags_qp
argument_list|)
expr_stmt|;
block|}
comment|/*At that point all inflight post send were put to be executed as of we 	 * lock/unlock above locks Now need to arm all involved CQs. 	 */
name|list_for_each_entry
argument_list|(
argument|mcq
argument_list|,
argument|&cq_armed_list
argument_list|,
argument|reset_notify
argument_list|)
block|{
name|mcq
operator|->
name|comp
argument_list|(
name|mcq
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ibdev
operator|->
name|reset_flow_resource_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_event
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|dev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|,
name|enum
name|mlx5_dev_event
name|event
parameter_list|,
name|unsigned
name|long
name|param
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|ibdev
init|=
operator|(
expr|struct
name|mlx5_ib_dev
operator|*
operator|)
name|context
decl_stmt|;
name|struct
name|ib_event
name|ibev
decl_stmt|;
name|bool
name|fatal
init|=
name|false
decl_stmt|;
name|u8
name|port
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|MLX5_DEV_EVENT_SYS_ERROR
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_DEVICE_FATAL
expr_stmt|;
name|mlx5_ib_handle_internal_error
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|fatal
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_PORT_UP
case|:
case|case
name|MLX5_DEV_EVENT_PORT_DOWN
case|:
case|case
name|MLX5_DEV_EVENT_PORT_INITIALIZED
case|:
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
comment|/* In RoCE, port up/down events are handled in 		 * mlx5_netdev_event(). 		 */
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|ibdev
operator|->
name|ib_dev
argument_list|,
name|port
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
return|return;
name|ibev
operator|.
name|event
operator|=
operator|(
name|event
operator|==
name|MLX5_DEV_EVENT_PORT_UP
operator|)
condition|?
name|IB_EVENT_PORT_ACTIVE
else|:
name|IB_EVENT_PORT_ERR
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_LID_CHANGE
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_LID_CHANGE
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_PKEY_CHANGE
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_PKEY_CHANGE
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
name|schedule_work
argument_list|(
operator|&
name|ibdev
operator|->
name|devr
operator|.
name|ports
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|pkey_change_work
argument_list|)
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_GUID_CHANGE
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_GID_CHANGE
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
case|case
name|MLX5_DEV_EVENT_CLIENT_REREG
case|:
name|ibev
operator|.
name|event
operator|=
name|IB_EVENT_CLIENT_REREGISTER
expr_stmt|;
name|port
operator|=
operator|(
name|u8
operator|)
name|param
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|ibev
operator|.
name|device
operator|=
operator|&
name|ibdev
operator|->
name|ib_dev
expr_stmt|;
name|ibev
operator|.
name|element
operator|.
name|port_num
operator|=
name|port
expr_stmt|;
if|if
condition|(
name|port
operator|<
literal|1
operator|||
name|port
operator|>
name|ibdev
operator|->
name|num_ports
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|ibdev
argument_list|,
literal|"warning: event on port %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ibdev
operator|->
name|ib_active
condition|)
name|ib_dispatch_event
argument_list|(
operator|&
name|ibev
argument_list|)
expr_stmt|;
if|if
condition|(
name|fatal
condition|)
name|ibdev
operator|->
name|ib_active
operator|=
name|false
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_ext_port_caps
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|port
decl_stmt|;
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
condition|;
name|port
operator|++
control|)
name|mlx5_query_ext_port_caps
argument_list|(
name|dev
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_port_caps
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|ib_device_attr
modifier|*
name|dprops
init|=
name|NULL
decl_stmt|;
name|struct
name|ib_port_attr
modifier|*
name|pprops
init|=
name|NULL
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOMEM
decl_stmt|;
name|int
name|port
decl_stmt|;
name|struct
name|ib_udata
name|uhw
init|=
block|{
operator|.
name|inlen
operator|=
literal|0
block|,
operator|.
name|outlen
operator|=
literal|0
block|}
decl_stmt|;
name|pprops
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pprops
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pprops
condition|)
goto|goto
name|out
goto|;
name|dprops
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dprops
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dprops
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|mlx5_ib_query_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|dprops
argument_list|,
operator|&
name|uhw
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"query_device failed %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|num_ports
argument_list|)
condition|;
name|port
operator|++
control|)
block|{
name|err
operator|=
name|mlx5_ib_query_port
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|port
argument_list|,
name|pprops
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"query_port %d failed %d\n"
argument_list|,
name|port
argument_list|,
name|err
argument_list|)
expr_stmt|;
break|break;
block|}
name|dev
operator|->
name|mdev
operator|->
name|port_caps
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|pkey_table_len
operator|=
name|dprops
operator|->
name|max_pkeys
expr_stmt|;
name|dev
operator|->
name|mdev
operator|->
name|port_caps
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|gid_table_len
operator|=
name|pprops
operator|->
name|gid_tbl_len
expr_stmt|;
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"pkey_table_len %d, gid_table_len %d\n"
argument_list|,
name|dprops
operator|->
name|max_pkeys
argument_list|,
name|pprops
operator|->
name|gid_tbl_len
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|kfree
argument_list|(
name|pprops
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dprops
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy_umrc_res
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_mr_cache_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"mr cache cleanup failed\n"
argument_list|)
expr_stmt|;
name|mlx5_ib_destroy_qp
argument_list|(
name|dev
operator|->
name|umrc
operator|.
name|qp
argument_list|)
expr_stmt|;
name|ib_free_cq
argument_list|(
name|dev
operator|->
name|umrc
operator|.
name|cq
argument_list|)
expr_stmt|;
name|ib_dealloc_pd
argument_list|(
name|dev
operator|->
name|umrc
operator|.
name|pd
argument_list|)
expr_stmt|;
block|}
end_function

begin_enum
enum|enum
block|{
name|MAX_UMR_WR
init|=
literal|128
block|, }
enum|;
end_enum

begin_function
specifier|static
name|int
name|create_umr_res
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|ib_qp_init_attr
modifier|*
name|init_attr
init|=
name|NULL
decl_stmt|;
name|struct
name|ib_qp_attr
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
name|struct
name|ib_pd
modifier|*
name|pd
decl_stmt|;
name|struct
name|ib_cq
modifier|*
name|cq
decl_stmt|;
name|struct
name|ib_qp
modifier|*
name|qp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|attr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
name|init_attr
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|init_attr
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|attr
operator|||
operator|!
name|init_attr
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|error_0
goto|;
block|}
name|pd
operator|=
name|ib_alloc_pd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|pd
argument_list|)
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't create PD for sync UMR QP\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|pd
argument_list|)
expr_stmt|;
goto|goto
name|error_0
goto|;
block|}
name|cq
operator|=
name|ib_alloc_cq
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|,
literal|128
argument_list|,
literal|0
argument_list|,
name|IB_POLL_SOFTIRQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cq
argument_list|)
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't create CQ for sync UMR QP\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|error_2
goto|;
block|}
name|init_attr
operator|->
name|send_cq
operator|=
name|cq
expr_stmt|;
name|init_attr
operator|->
name|recv_cq
operator|=
name|cq
expr_stmt|;
name|init_attr
operator|->
name|sq_sig_type
operator|=
name|IB_SIGNAL_ALL_WR
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_send_wr
operator|=
name|MAX_UMR_WR
expr_stmt|;
name|init_attr
operator|->
name|cap
operator|.
name|max_send_sge
operator|=
literal|1
expr_stmt|;
name|init_attr
operator|->
name|qp_type
operator|=
name|MLX5_IB_QPT_REG_UMR
expr_stmt|;
name|init_attr
operator|->
name|port_num
operator|=
literal|1
expr_stmt|;
name|qp
operator|=
name|mlx5_ib_create_qp
argument_list|(
name|pd
argument_list|,
name|init_attr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|qp
argument_list|)
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't create sync UMR QP\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|qp
argument_list|)
expr_stmt|;
goto|goto
name|error_3
goto|;
block|}
name|qp
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|qp
operator|->
name|real_qp
operator|=
name|qp
expr_stmt|;
name|qp
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|qp
operator|->
name|qp_type
operator|=
name|MLX5_IB_QPT_REG_UMR
expr_stmt|;
name|attr
operator|->
name|qp_state
operator|=
name|IB_QPS_INIT
expr_stmt|;
name|attr
operator|->
name|port_num
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|mlx5_ib_modify_qp
argument_list|(
name|qp
argument_list|,
name|attr
argument_list|,
name|IB_QP_STATE
operator||
name|IB_QP_PKEY_INDEX
operator||
name|IB_QP_PORT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't modify UMR QP\n"
argument_list|)
expr_stmt|;
goto|goto
name|error_4
goto|;
block|}
name|memset
argument_list|(
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|->
name|qp_state
operator|=
name|IB_QPS_RTR
expr_stmt|;
name|attr
operator|->
name|path_mtu
operator|=
name|IB_MTU_256
expr_stmt|;
name|ret
operator|=
name|mlx5_ib_modify_qp
argument_list|(
name|qp
argument_list|,
name|attr
argument_list|,
name|IB_QP_STATE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't modify umr QP to rtr\n"
argument_list|)
expr_stmt|;
goto|goto
name|error_4
goto|;
block|}
name|memset
argument_list|(
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|->
name|qp_state
operator|=
name|IB_QPS_RTS
expr_stmt|;
name|ret
operator|=
name|mlx5_ib_modify_qp
argument_list|(
name|qp
argument_list|,
name|attr
argument_list|,
name|IB_QP_STATE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_ib_dbg
argument_list|(
name|dev
argument_list|,
literal|"Couldn't modify umr QP to rts\n"
argument_list|)
expr_stmt|;
goto|goto
name|error_4
goto|;
block|}
name|dev
operator|->
name|umrc
operator|.
name|qp
operator|=
name|qp
expr_stmt|;
name|dev
operator|->
name|umrc
operator|.
name|cq
operator|=
name|cq
expr_stmt|;
name|dev
operator|->
name|umrc
operator|.
name|pd
operator|=
name|pd
expr_stmt|;
name|sema_init
argument_list|(
operator|&
name|dev
operator|->
name|umrc
operator|.
name|sem
argument_list|,
name|MAX_UMR_WR
argument_list|)
expr_stmt|;
name|ret
operator|=
name|mlx5_mr_cache_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"mr cache init failed %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error_4
goto|;
block|}
name|kfree
argument_list|(
name|attr
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|init_attr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|error_4
label|:
name|mlx5_ib_destroy_qp
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|error_3
label|:
name|ib_free_cq
argument_list|(
name|cq
argument_list|)
expr_stmt|;
name|error_2
label|:
name|ib_dealloc_pd
argument_list|(
name|pd
argument_list|)
expr_stmt|;
name|error_0
label|:
name|kfree
argument_list|(
name|attr
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|init_attr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|create_dev_resources
parameter_list|(
name|struct
name|mlx5_ib_resources
modifier|*
name|devr
parameter_list|)
block|{
name|struct
name|ib_srq_init_attr
name|attr
decl_stmt|;
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
decl_stmt|;
name|struct
name|ib_cq_init_attr
name|cq_attr
init|=
block|{
operator|.
name|cqe
operator|=
literal|1
block|}
decl_stmt|;
name|int
name|port
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|dev
operator|=
name|container_of
argument_list|(
name|devr
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|devr
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|devr
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|devr
operator|->
name|p0
operator|=
name|mlx5_ib_alloc_pd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
expr_stmt|;
goto|goto
name|error0
goto|;
block|}
name|devr
operator|->
name|p0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|p0
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|p0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|devr
operator|->
name|c0
operator|=
name|mlx5_ib_create_cq
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
operator|&
name|cq_attr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
expr_stmt|;
goto|goto
name|error1
goto|;
block|}
name|devr
operator|->
name|c0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|comp_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|event_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|c0
operator|->
name|cq_context
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|c0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|devr
operator|->
name|x0
operator|=
name|mlx5_ib_alloc_xrcd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
expr_stmt|;
goto|goto
name|error2
goto|;
block|}
name|devr
operator|->
name|x0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|x0
operator|->
name|inode
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|x0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|devr
operator|->
name|x0
operator|->
name|tgt_qp_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|devr
operator|->
name|x0
operator|->
name|tgt_qp_list
argument_list|)
expr_stmt|;
name|devr
operator|->
name|x1
operator|=
name|mlx5_ib_alloc_xrcd
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
expr_stmt|;
goto|goto
name|error3
goto|;
block|}
name|devr
operator|->
name|x1
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|x1
operator|->
name|inode
operator|=
name|NULL
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|x1
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|devr
operator|->
name|x1
operator|->
name|tgt_qp_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|devr
operator|->
name|x1
operator|->
name|tgt_qp_list
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_sge
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_wr
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|srq_type
operator|=
name|IB_SRQT_XRC
expr_stmt|;
name|attr
operator|.
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|=
name|devr
operator|->
name|c0
expr_stmt|;
name|attr
operator|.
name|ext
operator|.
name|xrc
operator|.
name|xrcd
operator|=
name|devr
operator|->
name|x0
expr_stmt|;
name|devr
operator|->
name|s0
operator|=
name|mlx5_ib_create_srq
argument_list|(
name|devr
operator|->
name|p0
argument_list|,
operator|&
name|attr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
expr_stmt|;
goto|goto
name|error4
goto|;
block|}
name|devr
operator|->
name|s0
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|pd
operator|=
name|devr
operator|->
name|p0
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|event_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|srq_context
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|srq_type
operator|=
name|IB_SRQT_XRC
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|xrcd
operator|=
name|devr
operator|->
name|x0
expr_stmt|;
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|=
name|devr
operator|->
name|c0
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|xrcd
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|s0
operator|->
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|p0
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|s0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_sge
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|attr
operator|.
name|max_wr
operator|=
literal|1
expr_stmt|;
name|attr
operator|.
name|srq_type
operator|=
name|IB_SRQT_BASIC
expr_stmt|;
name|devr
operator|->
name|s1
operator|=
name|mlx5_ib_create_srq
argument_list|(
name|devr
operator|->
name|p0
argument_list|,
operator|&
name|attr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|devr
operator|->
name|s1
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|devr
operator|->
name|s1
argument_list|)
expr_stmt|;
goto|goto
name|error5
goto|;
block|}
name|devr
operator|->
name|s1
operator|->
name|device
operator|=
operator|&
name|dev
operator|->
name|ib_dev
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|pd
operator|=
name|devr
operator|->
name|p0
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|uobject
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|event_handler
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|srq_context
operator|=
name|NULL
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|srq_type
operator|=
name|IB_SRQT_BASIC
expr_stmt|;
name|devr
operator|->
name|s1
operator|->
name|ext
operator|.
name|xrc
operator|.
name|cq
operator|=
name|devr
operator|->
name|c0
expr_stmt|;
name|atomic_inc
argument_list|(
operator|&
name|devr
operator|->
name|p0
operator|->
name|usecnt
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|devr
operator|->
name|s0
operator|->
name|usecnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|ARRAY_SIZE
argument_list|(
name|devr
operator|->
name|ports
argument_list|)
condition|;
operator|++
name|port
control|)
block|{
name|INIT_WORK
argument_list|(
operator|&
name|devr
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|pkey_change_work
argument_list|,
name|pkey_change_handler
argument_list|)
expr_stmt|;
name|devr
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|devr
operator|=
name|devr
expr_stmt|;
block|}
return|return
literal|0
return|;
name|error5
label|:
name|mlx5_ib_destroy_srq
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
expr_stmt|;
name|error4
label|:
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
expr_stmt|;
name|error3
label|:
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
expr_stmt|;
name|error2
label|:
name|mlx5_ib_destroy_cq
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
expr_stmt|;
name|error1
label|:
name|mlx5_ib_dealloc_pd
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
expr_stmt|;
name|error0
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|destroy_dev_resources
parameter_list|(
name|struct
name|mlx5_ib_resources
modifier|*
name|devr
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|devr
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|devr
argument_list|)
decl_stmt|;
name|int
name|port
decl_stmt|;
name|mlx5_ib_destroy_srq
argument_list|(
name|devr
operator|->
name|s1
argument_list|)
expr_stmt|;
name|mlx5_ib_destroy_srq
argument_list|(
name|devr
operator|->
name|s0
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x0
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_xrcd
argument_list|(
name|devr
operator|->
name|x1
argument_list|)
expr_stmt|;
name|mlx5_ib_destroy_cq
argument_list|(
name|devr
operator|->
name|c0
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_pd
argument_list|(
name|devr
operator|->
name|p0
argument_list|)
expr_stmt|;
comment|/* Make sure no change P_Key work items are still executing */
for|for
control|(
name|port
operator|=
literal|0
init|;
name|port
operator|<
name|dev
operator|->
name|num_ports
condition|;
operator|++
name|port
control|)
name|cancel_work_sync
argument_list|(
operator|&
name|devr
operator|->
name|ports
index|[
name|port
index|]
operator|.
name|pkey_change_work
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u32
name|get_core_cap_flags
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|enum
name|rdma_link_layer
name|ll
init|=
name|mlx5_ib_port_link_layer
argument_list|(
name|ibdev
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|u8
name|l3_type_cap
init|=
name|MLX5_CAP_ROCE
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|l3_type
argument_list|)
decl_stmt|;
name|u8
name|roce_version_cap
init|=
name|MLX5_CAP_ROCE
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|roce_version
argument_list|)
decl_stmt|;
name|u32
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ll
operator|==
name|IB_LINK_LAYER_INFINIBAND
condition|)
return|return
name|RDMA_CORE_PORT_IBA_IB
return|;
if|if
condition|(
operator|!
operator|(
name|l3_type_cap
operator|&
name|MLX5_ROCE_L3_TYPE_IPV4_CAP
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|l3_type_cap
operator|&
name|MLX5_ROCE_L3_TYPE_IPV6_CAP
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|roce_version_cap
operator|&
name|MLX5_ROCE_VERSION_1_CAP
condition|)
name|ret
operator||=
name|RDMA_CORE_PORT_IBA_ROCE
expr_stmt|;
if|if
condition|(
name|roce_version_cap
operator|&
name|MLX5_ROCE_VERSION_2_CAP
condition|)
name|ret
operator||=
name|RDMA_CORE_PORT_IBA_ROCE_UDP_ENCAP
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_port_immutable
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port_num
parameter_list|,
name|struct
name|ib_port_immutable
modifier|*
name|immutable
parameter_list|)
block|{
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|mlx5_ib_query_port
argument_list|(
name|ibdev
argument_list|,
name|port_num
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|immutable
operator|->
name|pkey_tbl_len
operator|=
name|attr
operator|.
name|pkey_tbl_len
expr_stmt|;
name|immutable
operator|->
name|gid_tbl_len
operator|=
name|attr
operator|.
name|gid_tbl_len
expr_stmt|;
name|immutable
operator|->
name|core_cap_flags
operator|=
name|get_core_cap_flags
argument_list|(
name|ibdev
argument_list|)
expr_stmt|;
name|immutable
operator|->
name|max_mad_size
operator|=
name|IB_MGMT_MAD_SIZE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_dev_fw_str
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|size_t
name|str_len
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|container_of
argument_list|(
name|ibdev
argument_list|,
expr|struct
name|mlx5_ib_dev
argument_list|,
name|ib_dev
argument_list|)
decl_stmt|;
name|snprintf
argument_list|(
name|str
argument_list|,
name|str_len
argument_list|,
literal|"%d.%d.%04d"
argument_list|,
name|fw_rev_maj
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
argument_list|,
name|fw_rev_min
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
argument_list|,
name|fw_rev_sub
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_roce_lag_init
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_roce_lag_cleanup
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|mlx5_remove_roce_notifier
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|roce
operator|.
name|nb
operator|.
name|notifier_call
condition|)
block|{
name|unregister_netdevice_notifier
argument_list|(
operator|&
name|dev
operator|->
name|roce
operator|.
name|nb
argument_list|)
expr_stmt|;
name|dev
operator|->
name|roce
operator|.
name|nb
operator|.
name|notifier_call
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_enable_roce
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|VNET_ITERATOR_DECL
argument_list|(
name|vnet_iter
argument_list|)
expr_stmt|;
name|struct
name|net_device
modifier|*
name|idev
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* Check if mlx5en net device already exists */
name|VNET_LIST_RLOCK
argument_list|()
expr_stmt|;
name|VNET_FOREACH
argument_list|(
argument|vnet_iter
argument_list|)
block|{
name|IFNET_RLOCK
argument_list|()
expr_stmt|;
name|CURVNET_SET_QUIET
argument_list|(
name|vnet_iter
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|idev
argument_list|,
argument|&V_ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
comment|/* check if network interface belongs to mlx5en */
if|if
condition|(
operator|!
name|mlx5_netdev_match
argument_list|(
name|idev
argument_list|,
name|dev
operator|->
name|mdev
argument_list|,
literal|"mce"
argument_list|)
condition|)
continue|continue;
name|write_lock
argument_list|(
operator|&
name|dev
operator|->
name|roce
operator|.
name|netdev_lock
argument_list|)
expr_stmt|;
name|dev
operator|->
name|roce
operator|.
name|netdev
operator|=
name|idev
expr_stmt|;
name|write_unlock
argument_list|(
operator|&
name|dev
operator|->
name|roce
operator|.
name|netdev_lock
argument_list|)
expr_stmt|;
block|}
name|CURVNET_RESTORE
argument_list|()
expr_stmt|;
name|IFNET_RUNLOCK
argument_list|()
expr_stmt|;
block|}
name|VNET_LIST_RUNLOCK
argument_list|()
expr_stmt|;
name|dev
operator|->
name|roce
operator|.
name|nb
operator|.
name|notifier_call
operator|=
name|mlx5_netdev_event
expr_stmt|;
name|err
operator|=
name|register_netdevice_notifier
argument_list|(
operator|&
name|dev
operator|->
name|roce
operator|.
name|nb
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|dev
operator|->
name|roce
operator|.
name|nb
operator|.
name|notifier_call
operator|=
name|NULL
expr_stmt|;
return|return
name|err
return|;
block|}
name|err
operator|=
name|mlx5_nic_vport_enable_roce
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_unregister_netdevice_notifier
goto|;
name|err
operator|=
name|mlx5_roce_lag_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_disable_roce
goto|;
return|return
literal|0
return|;
name|err_disable_roce
label|:
name|mlx5_nic_vport_disable_roce
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
expr_stmt|;
name|err_unregister_netdevice_notifier
label|:
name|mlx5_remove_roce_notifier
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_disable_roce
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|mlx5_roce_lag_cleanup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_nic_vport_disable_roce
argument_list|(
name|dev
operator|->
name|mdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_dealloc_q_port_counter
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|mlx5_vport_dealloc_q_counter
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_IB
argument_list|,
name|dev
operator|->
name|port
index|[
name|port_num
index|]
operator|.
name|q_cnt_id
argument_list|)
expr_stmt|;
name|dev
operator|->
name|port
index|[
name|port_num
index|]
operator|.
name|q_cnt_id
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_dealloc_q_counters
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
name|mlx5_ib_dealloc_q_port_counter
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_alloc_q_counters
parameter_list|(
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dev
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|mlx5_vport_alloc_q_counter
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|MLX5_INTERFACE_PROTOCOL_IB
argument_list|,
operator|&
name|dev
operator|->
name|port
index|[
name|i
index|]
operator|.
name|q_cnt_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|mlx5_ib_warn
argument_list|(
name|dev
argument_list|,
literal|"couldn't allocate queue counter for port %d, err %d\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|dealloc_counters
goto|;
block|}
block|}
return|return
literal|0
return|;
name|dealloc_counters
label|:
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|mlx5_ib_dealloc_q_port_counter
argument_list|(
name|dev
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|names
index|[]
init|=
block|{
literal|"rx_write_requests"
block|,
literal|"rx_read_requests"
block|,
literal|"rx_atomic_requests"
block|,
literal|"out_of_buffer"
block|,
literal|"out_of_sequence"
block|,
literal|"duplicate_request"
block|,
literal|"rnr_nak_retry_err"
block|,
literal|"packet_seq_err"
block|,
literal|"implied_nak_seq_err"
block|,
literal|"local_ack_timeout_err"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|size_t
name|stats_offsets
index|[]
init|=
block|{
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|rx_write_requests
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|rx_read_requests
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|rx_atomic_requests
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|out_of_buffer
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|out_of_sequence
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|duplicate_request
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|rnr_nak_retry_err
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|packet_seq_err
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|implied_nak_seq_err
argument_list|)
block|,
name|MLX5_BYTE_OFF
argument_list|(
name|query_q_counter_out
argument_list|,
name|local_ack_timeout_err
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|rdma_hw_stats
modifier|*
name|mlx5_ib_alloc_hw_stats
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|u8
name|port_num
parameter_list|)
block|{
name|BUILD_BUG_ON
argument_list|(
name|ARRAY_SIZE
argument_list|(
name|names
argument_list|)
operator|!=
name|ARRAY_SIZE
argument_list|(
name|stats_offsets
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We support only per port stats */
if|if
condition|(
name|port_num
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|rdma_alloc_hw_stats_struct
argument_list|(
name|names
argument_list|,
name|ARRAY_SIZE
argument_list|(
name|names
argument_list|)
argument_list|,
name|RDMA_HW_STATS_DEFAULT_LIFESPAN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mlx5_ib_get_hw_stats
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ibdev
parameter_list|,
name|struct
name|rdma_hw_stats
modifier|*
name|stats
parameter_list|,
name|u8
name|port
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|to_mdev
argument_list|(
name|ibdev
argument_list|)
decl_stmt|;
name|int
name|outlen
init|=
name|MLX5_ST_SZ_BYTES
argument_list|(
name|query_q_counter_out
argument_list|)
decl_stmt|;
name|void
modifier|*
name|out
decl_stmt|;
name|__be32
name|val
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|port
operator|||
operator|!
name|stats
condition|)
return|return
operator|-
name|ENOSYS
return|;
name|out
operator|=
name|mlx5_vzalloc
argument_list|(
name|outlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|ret
operator|=
name|mlx5_vport_query_q_counter
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|dev
operator|->
name|port
index|[
name|port
operator|-
literal|1
index|]
operator|.
name|q_cnt_id
argument_list|,
literal|0
argument_list|,
name|out
argument_list|,
name|outlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|free
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|names
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
operator|*
operator|(
name|__be32
operator|*
operator|)
operator|(
name|out
operator|+
name|stats_offsets
index|[
name|i
index|]
operator|)
expr_stmt|;
name|stats
operator|->
name|value
index|[
name|i
index|]
operator|=
operator|(
name|u64
operator|)
name|be32_to_cpu
argument_list|(
name|val
argument_list|)
expr_stmt|;
block|}
name|free
label|:
name|kvfree
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
name|ARRAY_SIZE
argument_list|(
name|names
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|mlx5_ib_add
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
decl_stmt|;
name|enum
name|rdma_link_layer
name|ll
decl_stmt|;
name|int
name|port_type_cap
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|port_type_cap
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|port_type
argument_list|)
expr_stmt|;
name|ll
operator|=
name|mlx5_port_type_cap_to_rdma_ll
argument_list|(
name|port_type_cap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ll
operator|==
name|IB_LINK_LAYER_ETHERNET
operator|)
operator|&&
operator|!
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|roce
argument_list|)
condition|)
return|return
name|NULL
return|;
name|printk_once
argument_list|(
name|KERN_INFO
literal|"%s"
argument_list|,
name|mlx5_version
argument_list|)
expr_stmt|;
name|dev
operator|=
operator|(
expr|struct
name|mlx5_ib_dev
operator|*
operator|)
name|ib_alloc_device
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
return|return
name|NULL
return|;
name|dev
operator|->
name|mdev
operator|=
name|mdev
expr_stmt|;
name|dev
operator|->
name|port
operator|=
name|kcalloc
argument_list|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dev
operator|->
name|port
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
operator|->
name|port
condition|)
goto|goto
name|err_dealloc
goto|;
name|rwlock_init
argument_list|(
operator|&
name|dev
operator|->
name|roce
operator|.
name|netdev_lock
argument_list|)
expr_stmt|;
name|err
operator|=
name|get_port_caps
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_port
goto|;
if|if
condition|(
name|mlx5_use_mad_ifc
argument_list|(
name|dev
argument_list|)
condition|)
name|get_ext_port_caps
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|MLX5_INIT_DOORBELL_LOCK
argument_list|(
operator|&
name|dev
operator|->
name|uar_lock
argument_list|)
expr_stmt|;
name|name
operator|=
literal|"mlx5_%d"
expr_stmt|;
name|strlcpy
argument_list|(
name|dev
operator|->
name|ib_dev
operator|.
name|name
argument_list|,
name|name
argument_list|,
name|IB_DEVICE_NAME_MAX
argument_list|)
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|owner
operator|=
name|THIS_MODULE
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|node_type
operator|=
name|RDMA_NODE_IB_CA
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|local_dma_lkey
operator|=
literal|0
comment|/* not supported for now */
expr_stmt|;
name|dev
operator|->
name|num_ports
operator|=
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|num_ports
argument_list|)
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|phys_port_cnt
operator|=
name|dev
operator|->
name|num_ports
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|num_comp_vectors
operator|=
name|dev
operator|->
name|mdev
operator|->
name|priv
operator|.
name|eq_table
operator|.
name|num_comp_vectors
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dma_device
operator|=
operator|&
name|mdev
operator|->
name|pdev
operator|->
name|dev
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_abi_ver
operator|=
name|MLX5_IB_UVERBS_ABI_VERSION
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_cmd_mask
operator|=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_GET_CONTEXT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_DEVICE
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_PORT
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_ALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEALLOC_PD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_REG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_REREG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEREG_MR
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_RESIZE_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_MODIFY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_QP
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_ATTACH_MCAST
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DETACH_MCAST
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_MODIFY_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_QUERY_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DESTROY_SRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CREATE_XSRQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_OPEN_QP
operator|)
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_ex_cmd_mask
operator|=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_QUERY_DEVICE
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_CREATE_CQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_CREATE_QP
operator|)
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_device
operator|=
name|mlx5_ib_query_device
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_port
operator|=
name|mlx5_ib_query_port
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_link_layer
operator|=
name|mlx5_ib_port_link_layer
expr_stmt|;
if|if
condition|(
name|ll
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
name|dev
operator|->
name|ib_dev
operator|.
name|get_netdev
operator|=
name|mlx5_ib_get_netdev
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_gid
operator|=
name|mlx5_ib_query_gid
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|add_gid
operator|=
name|mlx5_ib_add_gid
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|del_gid
operator|=
name|mlx5_ib_del_gid
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_pkey
operator|=
name|mlx5_ib_query_pkey
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_device
operator|=
name|mlx5_ib_modify_device
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_port
operator|=
name|mlx5_ib_modify_port
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_ucontext
operator|=
name|mlx5_ib_alloc_ucontext
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dealloc_ucontext
operator|=
name|mlx5_ib_dealloc_ucontext
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|mmap
operator|=
name|mlx5_ib_mmap
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_pd
operator|=
name|mlx5_ib_alloc_pd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dealloc_pd
operator|=
name|mlx5_ib_dealloc_pd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_ah
operator|=
name|mlx5_ib_create_ah
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_ah
operator|=
name|mlx5_ib_query_ah
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_ah
operator|=
name|mlx5_ib_destroy_ah
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_srq
operator|=
name|mlx5_ib_create_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_srq
operator|=
name|mlx5_ib_modify_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_srq
operator|=
name|mlx5_ib_query_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_srq
operator|=
name|mlx5_ib_destroy_srq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|post_srq_recv
operator|=
name|mlx5_ib_post_srq_recv
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_qp
operator|=
name|mlx5_ib_create_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_qp
operator|=
name|mlx5_ib_modify_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|query_qp
operator|=
name|mlx5_ib_query_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_qp
operator|=
name|mlx5_ib_destroy_qp
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|post_send
operator|=
name|mlx5_ib_post_send
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|post_recv
operator|=
name|mlx5_ib_post_recv
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_cq
operator|=
name|mlx5_ib_create_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_cq
operator|=
name|mlx5_ib_modify_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|resize_cq
operator|=
name|mlx5_ib_resize_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_cq
operator|=
name|mlx5_ib_destroy_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|poll_cq
operator|=
name|mlx5_ib_poll_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|req_notify_cq
operator|=
name|mlx5_ib_arm_cq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_dma_mr
operator|=
name|mlx5_ib_get_dma_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|reg_user_mr
operator|=
name|mlx5_ib_reg_user_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|rereg_user_mr
operator|=
name|mlx5_ib_rereg_user_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dereg_mr
operator|=
name|mlx5_ib_dereg_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|attach_mcast
operator|=
name|mlx5_ib_mcg_attach
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|detach_mcast
operator|=
name|mlx5_ib_mcg_detach
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|process_mad
operator|=
name|mlx5_ib_process_mad
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_mr
operator|=
name|mlx5_ib_alloc_mr
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|map_mr_sg
operator|=
name|mlx5_ib_map_mr_sg
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|check_mr_status
operator|=
name|mlx5_ib_check_mr_status
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_port_immutable
operator|=
name|mlx5_port_immutable
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_dev_fw_str
operator|=
name|get_dev_fw_str
expr_stmt|;
if|if
condition|(
name|mlx5_core_is_pf
argument_list|(
name|mdev
argument_list|)
condition|)
block|{
name|dev
operator|->
name|ib_dev
operator|.
name|get_vf_config
operator|=
name|mlx5_ib_get_vf_config
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|set_vf_link_state
operator|=
name|mlx5_ib_set_vf_link_state
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|get_vf_stats
operator|=
name|mlx5_ib_get_vf_stats
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|set_vf_guid
operator|=
name|mlx5_ib_set_vf_guid
expr_stmt|;
block|}
name|dev
operator|->
name|ib_dev
operator|.
name|disassociate_ucontext
operator|=
name|mlx5_ib_disassociate_ucontext
expr_stmt|;
name|mlx5_ib_internal_fill_odp_caps
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|imaicl
argument_list|)
condition|)
block|{
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_mw
operator|=
name|mlx5_ib_alloc_mw
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dealloc_mw
operator|=
name|mlx5_ib_dealloc_mw
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_cmd_mask
operator||=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_ALLOC_MW
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_DEALLOC_MW
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|out_of_seq_cnt
argument_list|)
operator|&&
name|MLX5_CAP_GEN
argument_list|(
name|dev
operator|->
name|mdev
argument_list|,
name|retransmission_q_counters
argument_list|)
condition|)
block|{
name|dev
operator|->
name|ib_dev
operator|.
name|get_hw_stats
operator|=
name|mlx5_ib_get_hw_stats
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_hw_stats
operator|=
name|mlx5_ib_alloc_hw_stats
expr_stmt|;
block|}
if|if
condition|(
name|MLX5_CAP_GEN
argument_list|(
name|mdev
argument_list|,
name|xrc
argument_list|)
condition|)
block|{
name|dev
operator|->
name|ib_dev
operator|.
name|alloc_xrcd
operator|=
name|mlx5_ib_alloc_xrcd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|dealloc_xrcd
operator|=
name|mlx5_ib_dealloc_xrcd
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_cmd_mask
operator||=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_OPEN_XRCD
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_CMD_CLOSE_XRCD
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
block|{
name|dev
operator|->
name|ib_dev
operator|.
name|create_flow
operator|=
name|mlx5_ib_create_flow
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_flow
operator|=
name|mlx5_ib_destroy_flow
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_wq
operator|=
name|mlx5_ib_create_wq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|modify_wq
operator|=
name|mlx5_ib_modify_wq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_wq
operator|=
name|mlx5_ib_destroy_wq
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|create_rwq_ind_table
operator|=
name|mlx5_ib_create_rwq_ind_table
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|destroy_rwq_ind_table
operator|=
name|mlx5_ib_destroy_rwq_ind_table
expr_stmt|;
name|dev
operator|->
name|ib_dev
operator|.
name|uverbs_ex_cmd_mask
operator||=
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_CREATE_FLOW
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_DESTROY_FLOW
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_CREATE_WQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_MODIFY_WQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_DESTROY_WQ
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_CREATE_RWQ_IND_TBL
operator|)
operator||
operator|(
literal|1ull
operator|<<
name|IB_USER_VERBS_EX_CMD_DESTROY_RWQ_IND_TBL
operator|)
expr_stmt|;
block|}
name|err
operator|=
name|init_node_data
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_port
goto|;
name|mutex_init
argument_list|(
operator|&
name|dev
operator|->
name|flow_db
operator|.
name|lock
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|dev
operator|->
name|cap_mask_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|dev
operator|->
name|qp_list
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|dev
operator|->
name|reset_flow_resource_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ll
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
block|{
name|err
operator|=
name|mlx5_enable_roce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_free_port
goto|;
block|}
name|err
operator|=
name|create_dev_resources
argument_list|(
operator|&
name|dev
operator|->
name|devr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_disable_roce
goto|;
name|err
operator|=
name|mlx5_ib_odp_init_one
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_rsrc
goto|;
name|err
operator|=
name|mlx5_ib_alloc_q_counters
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_odp
goto|;
name|err
operator|=
name|ib_register_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_q_cnt
goto|;
name|err
operator|=
name|create_umr_res
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_dev
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|mlx5_class_attributes
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|device_create_file
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
operator|.
name|dev
argument_list|,
name|mlx5_class_attributes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|err_umrc
goto|;
block|}
name|dev
operator|->
name|ib_active
operator|=
name|true
expr_stmt|;
return|return
name|dev
return|;
name|err_umrc
label|:
name|destroy_umrc_res
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_dev
label|:
name|ib_unregister_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
expr_stmt|;
name|err_q_cnt
label|:
name|mlx5_ib_dealloc_q_counters
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_odp
label|:
name|mlx5_ib_odp_remove_one
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|err_rsrc
label|:
name|destroy_dev_resources
argument_list|(
operator|&
name|dev
operator|->
name|devr
argument_list|)
expr_stmt|;
name|err_disable_roce
label|:
if|if
condition|(
name|ll
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
block|{
name|mlx5_disable_roce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_remove_roce_notifier
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
name|err_free_port
label|:
name|kfree
argument_list|(
name|dev
operator|->
name|port
argument_list|)
expr_stmt|;
name|err_dealloc
label|:
name|ib_dealloc_device
argument_list|(
operator|(
expr|struct
name|ib_device
operator|*
operator|)
name|dev
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mlx5_ib_remove
parameter_list|(
name|struct
name|mlx5_core_dev
modifier|*
name|mdev
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|mlx5_ib_dev
modifier|*
name|dev
init|=
name|context
decl_stmt|;
name|enum
name|rdma_link_layer
name|ll
init|=
name|mlx5_ib_port_link_layer
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|mlx5_remove_roce_notifier
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ib_unregister_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
expr_stmt|;
name|mlx5_ib_dealloc_q_counters
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|destroy_umrc_res
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mlx5_ib_odp_remove_one
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|destroy_dev_resources
argument_list|(
operator|&
name|dev
operator|->
name|devr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ll
operator|==
name|IB_LINK_LAYER_ETHERNET
condition|)
name|mlx5_disable_roce
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|dev
operator|->
name|port
argument_list|)
expr_stmt|;
name|ib_dealloc_device
argument_list|(
operator|&
name|dev
operator|->
name|ib_dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|mlx5_interface
name|mlx5_ib_interface
init|=
block|{
operator|.
name|add
operator|=
name|mlx5_ib_add
block|,
operator|.
name|remove
operator|=
name|mlx5_ib_remove
block|,
operator|.
name|event
operator|=
name|mlx5_ib_event
block|,
operator|.
name|protocol
operator|=
name|MLX5_INTERFACE_PROTOCOL_IB
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|__init
name|mlx5_ib_init
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
name|deprecated_prof_sel
operator|!=
literal|2
condition|)
name|pr_warn
argument_list|(
literal|"prof_sel is deprecated for mlx5_ib, set it for mlx5_core\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|mlx5_ib_odp_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|err
operator|=
name|mlx5_register_interface
argument_list|(
operator|&
name|mlx5_ib_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|clean_odp
goto|;
return|return
name|err
return|;
name|clean_odp
label|:
name|mlx5_ib_odp_cleanup
argument_list|()
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__exit
name|mlx5_ib_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|mlx5_unregister_interface
argument_list|(
operator|&
name|mlx5_ib_interface
argument_list|)
expr_stmt|;
name|mlx5_ib_odp_cleanup
argument_list|()
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|module_init_order
argument_list|(
name|mlx5_ib_init
argument_list|,
name|SI_ORDER_THIRD
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_exit_order
argument_list|(
name|mlx5_ib_cleanup
argument_list|,
name|SI_ORDER_THIRD
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


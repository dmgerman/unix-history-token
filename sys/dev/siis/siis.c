begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2009 Alexander Motin<mav@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/led/led.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<dev/pci/pcireg.h>
end_include

begin_include
include|#
directive|include
file|"siis.h"
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_debug.h>
end_include

begin_comment
comment|/* local prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|siis_setup_interrupt
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_ch_init
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_ch_deinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_ch_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_ch_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_ch_intr_locked
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_ch_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_ch_led
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|onoff
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_begin_transaction
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_dmasetprd
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_execute_transaction
parameter_list|(
name|struct
name|siis_slot
modifier|*
name|slot
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_timeout
parameter_list|(
name|struct
name|siis_slot
modifier|*
name|slot
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_end_transaction
parameter_list|(
name|struct
name|siis_slot
modifier|*
name|slot
parameter_list|,
name|enum
name|siis_err_type
name|et
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_setup_fis
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|siis_cmd
modifier|*
name|ctp
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|int
name|tag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_dmasetupc_cb
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_dmafini
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_slotsalloc
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_slotsfree
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_portinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_wait_ready
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|siis_sata_connect
parameter_list|(
name|struct
name|siis_channel
modifier|*
name|ch
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_issue_recovery
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_process_read_log
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siis_process_request_sense
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siisaction
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|siispoll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_SIIS
argument_list|,
literal|"SIIS driver"
argument_list|,
literal|"SIIS driver data buffers"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
specifier|static
struct|struct
block|{
name|uint32_t
name|id
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|ports
decl_stmt|;
name|int
name|quirks
decl_stmt|;
define|#
directive|define
name|SIIS_Q_SNTF
value|1
define|#
directive|define
name|SIIS_Q_NOMSI
value|2
block|}
name|siis_ids
index|[]
init|=
block|{
block|{
literal|0x31241095
block|,
literal|"SiI3124"
block|,
literal|4
block|,
literal|0
block|}
block|,
block|{
literal|0x31248086
block|,
literal|"SiI3124"
block|,
literal|4
block|,
literal|0
block|}
block|,
block|{
literal|0x31321095
block|,
literal|"SiI3132"
block|,
literal|2
block|,
name|SIIS_Q_SNTF
operator||
name|SIIS_Q_NOMSI
block|}
block|,
block|{
literal|0x02421095
block|,
literal|"SiI3132"
block|,
literal|2
block|,
name|SIIS_Q_SNTF
operator||
name|SIIS_Q_NOMSI
block|}
block|,
block|{
literal|0x02441095
block|,
literal|"SiI3132"
block|,
literal|2
block|,
name|SIIS_Q_SNTF
operator||
name|SIIS_Q_NOMSI
block|}
block|,
block|{
literal|0x31311095
block|,
literal|"SiI3131"
block|,
literal|1
block|,
name|SIIS_Q_SNTF
operator||
name|SIIS_Q_NOMSI
block|}
block|,
block|{
literal|0x35311095
block|,
literal|"SiI3531"
block|,
literal|1
block|,
name|SIIS_Q_SNTF
operator||
name|SIIS_Q_NOMSI
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|recovery_type
value|spriv_field0
end_define

begin_define
define|#
directive|define
name|RECOVERY_NONE
value|0
end_define

begin_define
define|#
directive|define
name|RECOVERY_READ_LOG
value|1
end_define

begin_define
define|#
directive|define
name|RECOVERY_REQUEST_SENSE
value|2
end_define

begin_define
define|#
directive|define
name|recovery_slot
value|spriv_field1
end_define

begin_function
specifier|static
name|int
name|siis_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|devid
init|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|siis_ids
index|[
name|i
index|]
operator|.
name|id
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|siis_ids
index|[
name|i
index|]
operator|.
name|id
operator|==
name|devid
condition|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s SATA controller"
argument_list|,
name|siis_ids
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint32_t
name|devid
init|=
name|pci_get_devid
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|unit
decl_stmt|;
name|ctlr
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|siis_ids
index|[
name|i
index|]
operator|.
name|id
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|siis_ids
index|[
name|i
index|]
operator|.
name|id
operator|==
name|devid
condition|)
break|break;
block|}
name|ctlr
operator|->
name|quirks
operator|=
name|siis_ids
index|[
name|i
index|]
operator|.
name|quirks
expr_stmt|;
comment|/* Global memory */
name|ctlr
operator|->
name|r_grid
operator|=
name|PCIR_BAR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_gmem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|ctlr
operator|->
name|r_grid
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|ctlr
operator|->
name|gctl
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_gmem
argument_list|,
name|SIIS_GCTL
argument_list|)
expr_stmt|;
comment|/* Channels memory */
name|ctlr
operator|->
name|r_rid
operator|=
name|PCIR_BAR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|r_mem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|ctlr
operator|->
name|r_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Setup our own memory management for channels. */
name|ctlr
operator|->
name|sc_iomem
operator|.
name|rm_start
operator|=
name|rman_get_start
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|sc_iomem
operator|.
name|rm_end
operator|=
name|rman_get_end
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|ctlr
operator|->
name|sc_iomem
operator|.
name|rm_type
operator|=
name|RMAN_ARRAY
expr_stmt|;
name|ctlr
operator|->
name|sc_iomem
operator|.
name|rm_descr
operator|=
literal|"I/O memory addresses"
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|rman_init
argument_list|(
operator|&
name|ctlr
operator|->
name|sc_iomem
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_rid
argument_list|,
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_grid
argument_list|,
name|ctlr
operator|->
name|r_gmem
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|rman_manage_region
argument_list|(
operator|&
name|ctlr
operator|->
name|sc_iomem
argument_list|,
name|rman_get_start
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|)
argument_list|,
name|rman_get_end
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_rid
argument_list|,
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_grid
argument_list|,
name|ctlr
operator|->
name|r_gmem
argument_list|)
expr_stmt|;
name|rman_fini
argument_list|(
operator|&
name|ctlr
operator|->
name|sc_iomem
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|pci_enable_busmaster
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Reset controller */
name|siis_resume
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Number of HW channels */
name|ctlr
operator|->
name|channels
operator|=
name|siis_ids
index|[
name|i
index|]
operator|.
name|ports
expr_stmt|;
comment|/* Setup interrupts. */
if|if
condition|(
name|siis_setup_interrupt
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_rid
argument_list|,
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_grid
argument_list|,
name|ctlr
operator|->
name|r_gmem
argument_list|)
expr_stmt|;
name|rman_fini
argument_list|(
operator|&
name|ctlr
operator|->
name|sc_iomem
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
comment|/* Attach all channels on this controller */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
name|child
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"siisch"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
name|NULL
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to add channel device\n"
argument_list|)
expr_stmt|;
else|else
name|device_set_ivars
argument_list|(
name|child
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|intptr_t
operator|)
name|unit
argument_list|)
expr_stmt|;
block|}
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* Detach& delete all children */
name|device_delete_children
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Free interrupts. */
if|if
condition|(
name|ctlr
operator|->
name|irq
operator|.
name|r_irq
condition|)
block|{
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|irq
operator|.
name|r_irq
argument_list|,
name|ctlr
operator|->
name|irq
operator|.
name|handle
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ctlr
operator|->
name|irq
operator|.
name|r_irq_rid
argument_list|,
name|ctlr
operator|->
name|irq
operator|.
name|r_irq
argument_list|)
expr_stmt|;
block|}
name|pci_release_msi
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Free memory. */
name|rman_fini
argument_list|(
operator|&
name|ctlr
operator|->
name|sc_iomem
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_rid
argument_list|,
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ctlr
operator|->
name|r_grid
argument_list|,
name|ctlr
operator|->
name|r_gmem
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|bus_generic_suspend
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Put controller into reset state. */
name|ctlr
operator|->
name|gctl
operator||=
name|SIIS_GCTL_GRESET
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_gmem
argument_list|,
name|SIIS_GCTL
argument_list|,
name|ctlr
operator|->
name|gctl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* Set PCIe max read request size to at least 1024 bytes */
if|if
condition|(
name|pci_get_max_read_req
argument_list|(
name|dev
argument_list|)
operator|<
literal|1024
condition|)
name|pci_set_max_read_req
argument_list|(
name|dev
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
comment|/* Put controller into reset state. */
name|ctlr
operator|->
name|gctl
operator||=
name|SIIS_GCTL_GRESET
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_gmem
argument_list|,
name|SIIS_GCTL
argument_list|,
name|ctlr
operator|->
name|gctl
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
comment|/* Get controller out of reset state and enable port interrupts. */
name|ctlr
operator|->
name|gctl
operator|&=
operator|~
operator|(
name|SIIS_GCTL_GRESET
operator||
name|SIIS_GCTL_I2C_IE
operator|)
expr_stmt|;
name|ctlr
operator|->
name|gctl
operator||=
literal|0x0000000f
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_gmem
argument_list|,
name|SIIS_GCTL
argument_list|,
name|ctlr
operator|->
name|gctl
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_generic_resume
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_setup_interrupt
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|msi
init|=
name|ctlr
operator|->
name|quirks
operator|&
name|SIIS_Q_NOMSI
condition|?
literal|0
else|:
literal|1
decl_stmt|;
comment|/* Process hints. */
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"msi"
argument_list|,
operator|&
name|msi
argument_list|)
expr_stmt|;
if|if
condition|(
name|msi
operator|<
literal|0
condition|)
name|msi
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|msi
operator|>
literal|0
condition|)
name|msi
operator|=
name|min
argument_list|(
literal|1
argument_list|,
name|pci_msi_count
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Allocate MSI if needed/present. */
if|if
condition|(
name|msi
operator|&&
name|pci_alloc_msi
argument_list|(
name|dev
argument_list|,
operator|&
name|msi
argument_list|)
operator|!=
literal|0
condition|)
name|msi
operator|=
literal|0
expr_stmt|;
comment|/* Allocate all IRQs. */
name|ctlr
operator|->
name|irq
operator|.
name|r_irq_rid
operator|=
name|msi
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctlr
operator|->
name|irq
operator|.
name|r_irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|ctlr
operator|->
name|irq
operator|.
name|r_irq_rid
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to map interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ctlr
operator|->
name|irq
operator|.
name|r_irq
argument_list|,
name|ATA_INTR_FLAGS
argument_list|,
name|NULL
argument_list|,
name|siis_intr
argument_list|,
name|ctlr
argument_list|,
operator|&
name|ctlr
operator|->
name|irq
operator|.
name|handle
argument_list|)
operator|)
condition|)
block|{
comment|/* SOS XXX release r_irq */
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to setup interrupt\n"
argument_list|)
expr_stmt|;
return|return
name|ENXIO
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Common case interrupt handler.  */
end_comment

begin_function
specifier|static
name|void
name|siis_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
operator|(
expr|struct
name|siis_controller
operator|*
operator|)
name|data
decl_stmt|;
name|u_int32_t
name|is
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|is
operator|=
name|ATA_INL
argument_list|(
name|ctlr
operator|->
name|r_gmem
argument_list|,
name|SIIS_IS
argument_list|)
expr_stmt|;
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|ctlr
operator|->
name|channels
condition|;
name|unit
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|is
operator|&
name|SIIS_IS_PORT
argument_list|(
name|unit
argument_list|)
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|arg
operator|=
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|)
condition|)
block|{
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Acknowledge interrupt, if MSI enabled. */
if|if
condition|(
name|ctlr
operator|->
name|irq
operator|.
name|r_irq_rid
condition|)
block|{
name|ATA_OUTL
argument_list|(
name|ctlr
operator|->
name|r_gmem
argument_list|,
name|SIIS_GCTL
argument_list|,
name|ctlr
operator|->
name|gctl
operator||
name|SIIS_GCTL_MSIACK
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|resource
modifier|*
name|siis_alloc_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|rman_res_t
name|start
parameter_list|,
name|rman_res_t
name|end
parameter_list|,
name|rman_res_t
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|unit
init|=
operator|(
operator|(
expr|struct
name|siis_channel
operator|*
operator|)
name|device_get_softc
argument_list|(
name|child
argument_list|)
operator|)
operator|->
name|unit
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|int
name|offset
init|=
name|unit
operator|<<
literal|13
decl_stmt|;
name|rman_res_t
name|st
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SYS_RES_MEMORY
case|:
name|st
operator|=
name|rman_get_start
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|res
operator|=
name|rman_reserve_resource
argument_list|(
operator|&
name|ctlr
operator|->
name|sc_iomem
argument_list|,
name|st
operator|+
name|offset
argument_list|,
name|st
operator|+
name|offset
operator|+
literal|0x2000
argument_list|,
literal|0x2000
argument_list|,
name|RF_ACTIVE
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|bus_space_handle_t
name|bsh
decl_stmt|;
name|bus_space_tag_t
name|bst
decl_stmt|;
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|ctlr
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|bus_space_subregion
argument_list|(
name|bst
argument_list|,
name|bsh
argument_list|,
name|offset
argument_list|,
literal|0x2000
argument_list|,
operator|&
name|bsh
argument_list|)
expr_stmt|;
name|rman_set_bushandle
argument_list|(
name|res
argument_list|,
name|bsh
argument_list|)
expr_stmt|;
name|rman_set_bustag
argument_list|(
name|res
argument_list|,
name|bst
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SYS_RES_IRQ
case|:
if|if
condition|(
operator|*
name|rid
operator|==
name|ATA_IRQ_RID
condition|)
name|res
operator|=
name|ctlr
operator|->
name|irq
operator|.
name|r_irq
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_release_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SYS_RES_MEMORY
case|:
name|rman_release_resource
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|SYS_RES_IRQ
case|:
if|if
condition|(
name|rid
operator|!=
name|ATA_IRQ_RID
condition|)
return|return
name|ENOENT
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_setup_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|int
name|flags
parameter_list|,
name|driver_filter_t
modifier|*
name|filter
parameter_list|,
name|driver_intr_t
modifier|*
name|function
parameter_list|,
name|void
modifier|*
name|argument
parameter_list|,
name|void
modifier|*
modifier|*
name|cookiep
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|unit
init|=
operator|(
name|intptr_t
operator|)
name|device_get_ivars
argument_list|(
name|child
argument_list|)
decl_stmt|;
if|if
condition|(
name|filter
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"siis.c: we cannot use a filter here\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
operator|=
name|function
expr_stmt|;
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|=
name|argument
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_teardown_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|unit
init|=
operator|(
name|intptr_t
operator|)
name|device_get_ivars
argument_list|(
name|child
argument_list|)
decl_stmt|;
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|function
operator|=
name|NULL
expr_stmt|;
name|ctlr
operator|->
name|interrupt
index|[
name|unit
index|]
operator|.
name|argument
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_print_child
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
name|retval
operator|=
name|bus_print_child_header
argument_list|(
name|dev
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|retval
operator|+=
name|printf
argument_list|(
literal|" at channel %d"
argument_list|,
operator|(
name|int
operator|)
operator|(
name|intptr_t
operator|)
name|device_get_ivars
argument_list|(
name|child
argument_list|)
argument_list|)
expr_stmt|;
name|retval
operator|+=
name|bus_print_child_footer
argument_list|(
name|dev
argument_list|,
name|child
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_child_location_str
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"channel=%d"
argument_list|,
operator|(
name|int
operator|)
operator|(
name|intptr_t
operator|)
name|device_get_ivars
argument_list|(
name|child
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bus_dma_tag_t
name|siis_get_dma_tag
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|)
block|{
return|return
operator|(
name|bus_get_dma_tag
argument_list|(
name|bus
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|devclass_t
name|siis_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|siis_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|siis_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|siis_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|siis_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|siis_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|siis_resume
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_print_child
argument_list|,
name|siis_print_child
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_alloc_resource
argument_list|,
name|siis_alloc_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_release_resource
argument_list|,
name|siis_release_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_setup_intr
argument_list|,
name|siis_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_teardown_intr
argument_list|,
name|siis_teardown_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_child_location_str
argument_list|,
name|siis_child_location_str
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_get_dma_tag
argument_list|,
name|siis_get_dma_tag
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|siis_driver
init|=
block|{
literal|"siis"
block|,
name|siis_methods
block|,
expr|sizeof
operator|(
expr|struct
name|siis_controller
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|siis
argument_list|,
name|pci
argument_list|,
name|siis_driver
argument_list|,
name|siis_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|siis
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|siis
argument_list|,
name|cam
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|siis_ch_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc_copy
argument_list|(
name|dev
argument_list|,
literal|"SIIS channel"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_ch_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_controller
modifier|*
name|ctlr
init|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|,
name|sata_rev
init|=
literal|0
decl_stmt|;
name|ch
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|ch
operator|->
name|unit
operator|=
operator|(
name|intptr_t
operator|)
name|device_get_ivars
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|quirks
operator|=
name|ctlr
operator|->
name|quirks
expr_stmt|;
name|ch
operator|->
name|pm_level
operator|=
literal|0
expr_stmt|;
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"pm_level"
argument_list|,
operator|&
name|ch
operator|->
name|pm_level
argument_list|)
expr_stmt|;
name|resource_int_value
argument_list|(
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|"sata_rev"
argument_list|,
operator|&
name|sata_rev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|user
index|[
name|i
index|]
operator|.
name|revision
operator|=
name|sata_rev
expr_stmt|;
name|ch
operator|->
name|user
index|[
name|i
index|]
operator|.
name|mode
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|user
index|[
name|i
index|]
operator|.
name|bytecount
operator|=
literal|8192
expr_stmt|;
name|ch
operator|->
name|user
index|[
name|i
index|]
operator|.
name|tags
operator|=
name|SIIS_MAX_SLOTS
expr_stmt|;
name|ch
operator|->
name|curr
index|[
name|i
index|]
operator|=
name|ch
operator|->
name|user
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|pm_level
condition|)
name|ch
operator|->
name|user
index|[
name|i
index|]
operator|.
name|caps
operator|=
name|CTS_SATA_CAPS_H_PMREQ
expr_stmt|;
name|ch
operator|->
name|user
index|[
name|i
index|]
operator|.
name|caps
operator||=
name|CTS_SATA_CAPS_H_AN
expr_stmt|;
block|}
name|mtx_init
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
literal|"SIIS channel lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|rid
operator|=
name|ch
operator|->
name|unit
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ch
operator|->
name|r_mem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|siis_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|siis_slotsalloc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|siis_ch_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|rid
operator|=
name|ATA_IRQ_RID
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ch
operator|->
name|r_irq
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_SHAREABLE
operator||
name|RF_ACTIVE
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to map interrupt\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err0
goto|;
block|}
if|if
condition|(
operator|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|ch
operator|->
name|r_irq
argument_list|,
name|ATA_INTR_FLAGS
argument_list|,
name|NULL
argument_list|,
name|siis_ch_intr_locked
argument_list|,
name|dev
argument_list|,
operator|&
name|ch
operator|->
name|ih
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to setup interrupt\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
comment|/* Create the device queue for our SIM. */
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
name|SIIS_MAX_SLOTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|devq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to allocate simq\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
comment|/* Construct SIM entry */
name|ch
operator|->
name|sim
operator|=
name|cam_sim_alloc
argument_list|(
name|siisaction
argument_list|,
name|siispoll
argument_list|,
literal|"siisch"
argument_list|,
name|ch
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|&
name|ch
operator|->
name|mtx
argument_list|,
literal|2
argument_list|,
name|SIIS_MAX_SLOTS
argument_list|,
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|sim
operator|==
name|NULL
condition|)
block|{
name|cam_simq_free
argument_list|(
name|devq
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to allocate sim\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
if|if
condition|(
name|xpt_bus_register
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|dev
argument_list|,
literal|0
argument_list|)
operator|!=
name|CAM_SUCCESS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to register xpt bus\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|ch
operator|->
name|path
argument_list|,
comment|/*periph*/
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|ch
operator|->
name|sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unable to create path\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|ch
operator|->
name|led
operator|=
name|led_create
argument_list|(
name|siis_ch_led
argument_list|,
name|dev
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|err3
label|:
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|ch
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|err2
label|:
name|cam_sim_free
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
comment|/*free_devq*/
name|TRUE
argument_list|)
expr_stmt|;
name|err1
label|:
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ATA_IRQ_RID
argument_list|,
name|ch
operator|->
name|r_irq
argument_list|)
expr_stmt|;
name|err0
label|:
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ch
operator|->
name|unit
argument_list|,
name|ch
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_ch_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|led_destroy
argument_list|(
name|ch
operator|->
name|led
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|xpt_async
argument_list|(
name|AC_LOST_DEVICE
argument_list|,
name|ch
operator|->
name|path
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|ch
operator|->
name|path
argument_list|)
expr_stmt|;
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|ch
operator|->
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
comment|/*free_devq*/
name|TRUE
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|ch
operator|->
name|r_irq
argument_list|,
name|ch
operator|->
name|ih
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|ATA_IRQ_RID
argument_list|,
name|ch
operator|->
name|r_irq
argument_list|)
expr_stmt|;
name|siis_ch_deinit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|siis_slotsfree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|siis_dmafini
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|ch
operator|->
name|unit
argument_list|,
name|ch
operator|->
name|r_mem
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_ch_init
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* Get port out of reset state. */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_PORT_RESET
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_32BIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|pm_present
condition|)
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_PME
argument_list|)
expr_stmt|;
else|else
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_PME
argument_list|)
expr_stmt|;
comment|/* Enable port interrupts */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IESET
argument_list|,
name|SIIS_P_IX_ENABLED
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_ch_deinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* Put port into reset state. */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_PORT_RESET
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_ch_suspend
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|ch
operator|->
name|oslots
condition|)
name|msleep
argument_list|(
name|ch
argument_list|,
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|PRIBIO
argument_list|,
literal|"siissusp"
argument_list|,
name|hz
operator|/
literal|100
argument_list|)
expr_stmt|;
name|siis_ch_deinit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_ch_resume
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|siis_ch_init
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|siis_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|xpt_release_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|devclass_t
name|siisch_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_method_t
name|siisch_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|siis_ch_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|siis_ch_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|siis_ch_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|siis_ch_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|siis_ch_resume
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|siisch_driver
init|=
block|{
literal|"siisch"
block|,
name|siisch_methods
block|,
expr|sizeof
operator|(
expr|struct
name|siis_channel
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|siisch
argument_list|,
name|siis
argument_list|,
name|siisch_driver
argument_list|,
name|siis_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|siis_ch_led
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|onoff
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
decl_stmt|;
name|dev
operator|=
operator|(
name|device_t
operator|)
name|priv
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|onoff
operator|==
literal|0
condition|)
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_LED_ON
argument_list|)
expr_stmt|;
else|else
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_LED_ON
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|siis_dc_cb_args
block|{
name|bus_addr_t
name|maddr
decl_stmt|;
name|int
name|error
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|siis_dmainit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|siis_dc_cb_args
name|dcba
decl_stmt|;
comment|/* Command area. */
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|1024
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|SIIS_WORK_SIZE
argument_list|,
literal|1
argument_list|,
name|SIIS_WORK_SIZE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|bus_dmamem_alloc
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|ch
operator|->
name|dma
operator|.
name|work
argument_list|,
literal|0
argument_list|,
operator|&
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|bus_dmamap_load
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work
argument_list|,
name|SIIS_WORK_SIZE
argument_list|,
name|siis_dmasetupc_cb
argument_list|,
operator|&
name|dcba
argument_list|,
literal|0
argument_list|)
operator|||
name|dcba
operator|.
name|error
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ch
operator|->
name|dma
operator|.
name|work_bus
operator|=
name|dcba
operator|.
name|maddr
expr_stmt|;
comment|/* Data area. */
if|if
condition|(
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|SIIS_SG_ENTRIES
operator|*
name|PAGE_SIZE
operator|*
name|SIIS_MAX_SLOTS
argument_list|,
name|SIIS_SG_ENTRIES
argument_list|,
literal|0xFFFFFFFF
argument_list|,
literal|0
argument_list|,
name|busdma_lock_mutex
argument_list|,
operator|&
name|ch
operator|->
name|mtx
argument_list|,
operator|&
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|)
condition|)
block|{
goto|goto
name|error
goto|;
block|}
return|return;
name|error
label|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING - DMA initialization failed\n"
argument_list|)
expr_stmt|;
name|siis_dmafini
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siis_dmasetupc_cb
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|siis_dc_cb_args
modifier|*
name|dcba
init|=
operator|(
expr|struct
name|siis_dc_cb_args
operator|*
operator|)
name|xsc
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|dcba
operator|->
name|error
operator|=
name|error
operator|)
condition|)
name|dcba
operator|->
name|maddr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siis_dmafini
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|)
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|data_tag
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ch
operator|->
name|dma
operator|.
name|work_bus
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|)
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|work_bus
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|work_map
operator|=
name|NULL
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|work
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|)
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|work_tag
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siis_slotsalloc
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Alloc and setup command/dma slots */
name|bzero
argument_list|(
name|ch
operator|->
name|slot
argument_list|,
sizeof|sizeof
argument_list|(
name|ch
operator|->
name|slot
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|siis_slot
modifier|*
name|slot
init|=
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
decl_stmt|;
name|slot
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|slot
operator|->
name|slot
operator|=
name|i
expr_stmt|;
name|slot
operator|->
name|state
operator|=
name|SIIS_SLOT_EMPTY
expr_stmt|;
name|slot
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|slot
operator|->
name|timeout
argument_list|,
operator|&
name|ch
operator|->
name|mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_dmamap_create
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|slot
operator|->
name|dma
operator|.
name|data_map
argument_list|)
condition|)
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"FAILURE - create data_map\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siis_slotsfree
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Free all dma slots */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|siis_slot
modifier|*
name|slot
init|=
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
decl_stmt|;
name|callout_drain
argument_list|(
operator|&
name|slot
operator|->
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|->
name|dma
operator|.
name|data_map
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|,
name|slot
operator|->
name|dma
operator|.
name|data_map
argument_list|)
expr_stmt|;
name|slot
operator|->
name|dma
operator|.
name|data_map
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siis_notify_events
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|cam_path
modifier|*
name|dpath
decl_stmt|;
name|u_int32_t
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ch
operator|->
name|quirks
operator|&
name|SIIS_Q_SNTF
condition|)
block|{
name|status
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SNTF
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SNTF
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Without SNTF we have no idea which device sent notification. 		 * If PMP is connected, assume it, else - device. 		 */
name|status
operator|=
operator|(
name|ch
operator|->
name|pm_present
operator|)
condition|?
literal|0x8000
else|:
literal|0x0001
expr_stmt|;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SNTF 0x%04x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|status
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|dpath
argument_list|,
name|NULL
argument_list|,
name|xpt_path_path_id
argument_list|(
name|ch
operator|->
name|path
argument_list|)
argument_list|,
name|i
argument_list|,
literal|0
argument_list|)
operator|==
name|CAM_REQ_CMP
condition|)
block|{
name|xpt_async
argument_list|(
name|AC_SCSI_AEN
argument_list|,
name|dpath
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|dpath
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siis_phy_check_events
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
comment|/* If we have a connection event, deal with it */
if|if
condition|(
name|ch
operator|->
name|pm_level
operator|==
literal|0
condition|)
block|{
name|u_int32_t
name|status
init|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SSTS
argument_list|)
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|status
operator|&
name|ATA_SS_DET_MASK
operator|)
operator|==
name|ATA_SS_DET_PHY_ONLINE
operator|)
operator|&&
operator|(
operator|(
name|status
operator|&
name|ATA_SS_SPD_MASK
operator|)
operator|!=
name|ATA_SS_SPD_NO_SPEED
operator|)
operator|&&
operator|(
operator|(
name|status
operator|&
name|ATA_SS_IPM_MASK
operator|)
operator|==
name|ATA_SS_IPM_ACTIVE
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"CONNECT requested\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"DISCONNECT requested\n"
argument_list|)
expr_stmt|;
block|}
name|siis_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|=
name|xpt_alloc_ccb_nowait
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|ch
operator|->
name|sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|xpt_free_ccb
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|xpt_rescan
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siis_ch_intr_locked
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|data
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|siis_ch_intr
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siis_ch_intr
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|data
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint32_t
name|istatus
decl_stmt|,
name|sstatus
decl_stmt|,
name|ctx
decl_stmt|,
name|estatus
decl_stmt|,
name|ok
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|;
name|enum
name|siis_err_type
name|et
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ccs
decl_stmt|,
name|port
decl_stmt|,
name|tslots
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* Read command statuses. */
name|sstatus
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SS
argument_list|)
expr_stmt|;
name|ok
operator|=
name|ch
operator|->
name|rslots
operator|&
operator|~
name|sstatus
expr_stmt|;
comment|/* Complete all successful commands. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ok
operator|>>
name|i
operator|)
operator|&
literal|1
condition|)
name|siis_end_transaction
argument_list|(
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
argument_list|,
name|SIIS_ERR_NONE
argument_list|)
expr_stmt|;
block|}
comment|/* Do we have any other events? */
if|if
condition|(
operator|(
name|sstatus
operator|&
name|SIIS_P_SS_ATTN
operator|)
operator|==
literal|0
condition|)
return|return;
comment|/* Read and clear interrupt statuses. */
name|istatus
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IS
argument_list|)
operator|&
operator|(
literal|0xFFFF
operator|&
operator|~
name|SIIS_P_IX_COMMCOMP
operator|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IS
argument_list|,
name|istatus
argument_list|)
expr_stmt|;
comment|/* Process PHY events */
if|if
condition|(
name|istatus
operator|&
name|SIIS_P_IX_PHYRDYCHG
condition|)
name|siis_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Process NOTIFY events */
if|if
condition|(
name|istatus
operator|&
name|SIIS_P_IX_SDBN
condition|)
name|siis_notify_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Process command errors */
if|if
condition|(
name|istatus
operator|&
name|SIIS_P_IX_COMMERR
condition|)
block|{
name|estatus
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CMDERR
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTX
argument_list|)
expr_stmt|;
name|ccs
operator|=
operator|(
name|ctx
operator|&
name|SIIS_P_CTX_SLOT
operator|)
operator|>>
name|SIIS_P_CTX_SLOT_SHIFT
expr_stmt|;
name|port
operator|=
operator|(
name|ctx
operator|&
name|SIIS_P_CTX_PMP
operator|)
operator|>>
name|SIIS_P_CTX_PMP_SHIFT
expr_stmt|;
name|err
operator|=
name|ch
operator|->
name|rslots
operator|&
name|sstatus
expr_stmt|;
comment|//device_printf(dev, "%s ERROR ss %08x is %08x rs %08x es %d act %d port %d serr %08x\n",
comment|//    __func__, sstatus, istatus, ch->rslots, estatus, ccs, port,
comment|//    ATA_INL(ch->r_mem, SIIS_P_SERR));
if|if
condition|(
operator|!
name|ch
operator|->
name|recoverycmd
operator|&&
operator|!
name|ch
operator|->
name|recovery
condition|)
block|{
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|ch
operator|->
name|numrslots
argument_list|)
expr_stmt|;
name|ch
operator|->
name|recovery
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ch
operator|->
name|frozen
condition|)
block|{
name|union
name|ccb
modifier|*
name|fccb
init|=
name|ch
operator|->
name|frozen
decl_stmt|;
name|ch
operator|->
name|frozen
operator|=
name|NULL
expr_stmt|;
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_STATUS_MASK
expr_stmt|;
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQUEUE_REQ
operator||
name|CAM_RELEASE_SIMQ
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_DEV_QFRZN
operator|)
condition|)
block|{
name|xpt_freeze_devq
argument_list|(
name|fccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_DEV_QFRZN
expr_stmt|;
block|}
name|xpt_done
argument_list|(
name|fccb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|estatus
operator|==
name|SIIS_P_CMDERR_DEV
operator|||
name|estatus
operator|==
name|SIIS_P_CMDERR_SDB
operator|||
name|estatus
operator|==
name|SIIS_P_CMDERR_DATAFIS
condition|)
block|{
name|tslots
operator|=
name|ch
operator|->
name|numtslots
index|[
name|port
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
comment|/* XXX: requests in loading state. */
if|if
condition|(
operator|(
operator|(
name|ch
operator|->
name|rslots
operator|>>
name|i
operator|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|ch
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|!=
name|port
condition|)
continue|continue;
if|if
condition|(
name|tslots
operator|==
literal|0
condition|)
block|{
comment|/* Untagged operation. */
if|if
condition|(
name|i
operator|==
name|ccs
condition|)
name|et
operator|=
name|SIIS_ERR_TFE
expr_stmt|;
else|else
name|et
operator|=
name|SIIS_ERR_INNOCENT
expr_stmt|;
block|}
else|else
block|{
comment|/* Tagged operation. */
name|et
operator|=
name|SIIS_ERR_NCQ
expr_stmt|;
block|}
name|siis_end_transaction
argument_list|(
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
argument_list|,
name|et
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * We can't reinit port if there are some other 			 * commands active, use resume to complete them. 			 */
if|if
condition|(
name|ch
operator|->
name|rslots
operator|!=
literal|0
operator|&&
operator|!
name|ch
operator|->
name|recoverycmd
condition|)
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_RESUME
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|estatus
operator|==
name|SIIS_P_CMDERR_SENDFIS
operator|||
name|estatus
operator|==
name|SIIS_P_CMDERR_INCSTATE
operator|||
name|estatus
operator|==
name|SIIS_P_CMDERR_PPE
operator|||
name|estatus
operator|==
name|SIIS_P_CMDERR_SERVICE
condition|)
block|{
name|et
operator|=
name|SIIS_ERR_SATA
expr_stmt|;
block|}
else|else
name|et
operator|=
name|SIIS_ERR_INVALID
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
comment|/* XXX: requests in loading state. */
if|if
condition|(
operator|(
operator|(
name|ch
operator|->
name|rslots
operator|>>
name|i
operator|)
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|siis_end_transaction
argument_list|(
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
argument_list|,
name|et
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/* Must be called with channel locked. */
end_comment

begin_function
specifier|static
name|int
name|siis_check_collision
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_FPDMA
operator|)
condition|)
block|{
comment|/* Tagged command while we have no supported tag free. */
if|if
condition|(
operator|(
operator|(
operator|~
name|ch
operator|->
name|oslots
operator|)
operator|&
operator|(
literal|0x7fffffff
operator|>>
operator|(
literal|31
operator|-
name|ch
operator|->
name|curr
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
operator|.
name|tags
operator|)
operator|)
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
operator|(
name|CAM_ATAIO_CONTROL
operator||
name|CAM_ATAIO_NEEDRESULT
operator|)
operator|)
condition|)
block|{
comment|/* Atomic command while anything active. */
if|if
condition|(
name|ch
operator|->
name|numrslots
operator|!=
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
comment|/* We have some atomic command running. */
if|if
condition|(
name|ch
operator|->
name|aslots
operator|!=
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Must be called with channel locked. */
end_comment

begin_function
specifier|static
name|void
name|siis_begin_transaction
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|siis_slot
modifier|*
name|slot
decl_stmt|;
name|int
name|tag
decl_stmt|,
name|tags
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* Choose empty slot. */
name|tags
operator|=
name|SIIS_MAX_SLOTS
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_FPDMA
operator|)
condition|)
name|tags
operator|=
name|ch
operator|->
name|curr
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
operator|.
name|tags
expr_stmt|;
name|tag
operator|=
name|fls
argument_list|(
operator|(
operator|~
name|ch
operator|->
name|oslots
operator|)
operator|&
operator|(
literal|0x7fffffff
operator|>>
operator|(
literal|31
operator|-
name|tags
operator|)
operator|)
argument_list|)
operator|-
literal|1
expr_stmt|;
comment|/* Occupy chosen slot. */
name|slot
operator|=
operator|&
name|ch
operator|->
name|slot
index|[
name|tag
index|]
expr_stmt|;
name|slot
operator|->
name|ccb
operator|=
name|ccb
expr_stmt|;
comment|/* Update channel stats. */
name|ch
operator|->
name|oslots
operator||=
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|ch
operator|->
name|numrslots
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_FPDMA
operator|)
condition|)
block|{
name|ch
operator|->
name|numtslots
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
operator|(
name|CAM_ATAIO_CONTROL
operator||
name|CAM_ATAIO_NEEDRESULT
operator|)
operator|)
condition|)
name|ch
operator|->
name|aslots
operator||=
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|slot
operator|->
name|dma
operator|.
name|nsegs
operator|=
literal|0
expr_stmt|;
comment|/* If request moves data, setup and load SG list */
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
condition|)
block|{
name|slot
operator|->
name|state
operator|=
name|SIIS_SLOT_LOADING
expr_stmt|;
name|bus_dmamap_load_ccb
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|,
name|slot
operator|->
name|dma
operator|.
name|data_map
argument_list|,
name|ccb
argument_list|,
name|siis_dmasetprd
argument_list|,
name|slot
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|siis_execute_transaction
argument_list|(
name|slot
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Locked by busdma engine. */
end_comment

begin_function
specifier|static
name|void
name|siis_dmasetprd
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|siis_slot
modifier|*
name|slot
init|=
name|arg
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|slot
operator|->
name|dev
argument_list|)
decl_stmt|;
name|struct
name|siis_cmd
modifier|*
name|ctp
decl_stmt|;
name|struct
name|siis_dma_prd
modifier|*
name|prd
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|slot
operator|->
name|dev
argument_list|,
literal|"DMA load error\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ch
operator|->
name|recoverycmd
condition|)
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|siis_end_transaction
argument_list|(
name|slot
argument_list|,
name|SIIS_ERR_INVALID
argument_list|)
expr_stmt|;
return|return;
block|}
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|SIIS_SG_ENTRIES
argument_list|,
operator|(
literal|"too many DMA segment entries\n"
operator|)
argument_list|)
expr_stmt|;
name|slot
operator|->
name|dma
operator|.
name|nsegs
operator|=
name|nsegs
expr_stmt|;
if|if
condition|(
name|nsegs
operator|!=
literal|0
condition|)
block|{
comment|/* Get a piece of the workspace for this request */
name|ctp
operator|=
operator|(
expr|struct
name|siis_cmd
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|.
name|work
operator|+
name|SIIS_CT_OFFSET
operator|+
operator|(
name|SIIS_CT_SIZE
operator|*
name|slot
operator|->
name|slot
operator|)
operator|)
expr_stmt|;
comment|/* Fill S/G table */
if|if
condition|(
name|slot
operator|->
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
condition|)
name|prd
operator|=
operator|&
name|ctp
operator|->
name|u
operator|.
name|ata
operator|.
name|prd
index|[
literal|0
index|]
expr_stmt|;
else|else
name|prd
operator|=
operator|&
name|ctp
operator|->
name|u
operator|.
name|atapi
operator|.
name|prd
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|prd
index|[
name|i
index|]
operator|.
name|dba
operator|=
name|htole64
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|dbc
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|control
operator|=
literal|0
expr_stmt|;
block|}
name|prd
index|[
name|nsegs
operator|-
literal|1
index|]
operator|.
name|control
operator|=
name|htole32
argument_list|(
name|SIIS_PRD_TRM
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|,
name|slot
operator|->
name|dma
operator|.
name|data_map
argument_list|,
operator|(
operator|(
name|slot
operator|->
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_IN
operator|)
condition|?
name|BUS_DMASYNC_PREREAD
else|:
name|BUS_DMASYNC_PREWRITE
operator|)
argument_list|)
expr_stmt|;
block|}
name|siis_execute_transaction
argument_list|(
name|slot
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Must be called with channel locked. */
end_comment

begin_function
specifier|static
name|void
name|siis_execute_transaction
parameter_list|(
name|struct
name|siis_slot
modifier|*
name|slot
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|slot
operator|->
name|dev
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|siis_cmd
modifier|*
name|ctp
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|slot
operator|->
name|ccb
decl_stmt|;
name|u_int64_t
name|prb_bus
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* Get a piece of the workspace for this request */
name|ctp
operator|=
operator|(
expr|struct
name|siis_cmd
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|.
name|work
operator|+
name|SIIS_CT_OFFSET
operator|+
operator|(
name|SIIS_CT_SIZE
operator|*
name|slot
operator|->
name|slot
operator|)
operator|)
expr_stmt|;
name|ctp
operator|->
name|control
operator|=
literal|0
expr_stmt|;
name|ctp
operator|->
name|protocol_override
operator|=
literal|0
expr_stmt|;
name|ctp
operator|->
name|transfer_count
operator|=
literal|0
expr_stmt|;
comment|/* Special handling for Soft Reset command. */
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
condition|)
block|{
if|if
condition|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_CONTROL
condition|)
block|{
name|ctp
operator|->
name|control
operator||=
name|htole16
argument_list|(
name|SIIS_PRB_SOFT_RESET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctp
operator|->
name|control
operator||=
name|htole16
argument_list|(
name|SIIS_PRB_PROTOCOL_OVERRIDE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_FPDMA
condition|)
block|{
name|ctp
operator|->
name|protocol_override
operator||=
name|htole16
argument_list|(
name|SIIS_PRB_PROTO_NCQ
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
block|{
name|ctp
operator|->
name|protocol_override
operator||=
name|htole16
argument_list|(
name|SIIS_PRB_PROTO_READ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
block|{
name|ctp
operator|->
name|protocol_override
operator||=
name|htole16
argument_list|(
name|SIIS_PRB_PROTO_WRITE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_SCSI_IO
condition|)
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
condition|)
name|ctp
operator|->
name|control
operator||=
name|htole16
argument_list|(
name|SIIS_PRB_PACKET_READ
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
name|ctp
operator|->
name|control
operator||=
name|htole16
argument_list|(
name|SIIS_PRB_PACKET_WRITE
argument_list|)
expr_stmt|;
block|}
comment|/* Special handling for Soft Reset command. */
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_CONTROL
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|control
operator|&
name|ATA_A_RESET
operator|)
condition|)
block|{
comment|/* Kick controller into sane state */
name|siis_portinit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* Setup the FIS for this request */
if|if
condition|(
operator|!
name|siis_setup_fis
argument_list|(
name|dev
argument_list|,
name|ctp
argument_list|,
name|ccb
argument_list|,
name|slot
operator|->
name|slot
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"Setting up SATA FIS failed\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ch
operator|->
name|recoverycmd
condition|)
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|siis_end_transaction
argument_list|(
name|slot
argument_list|,
name|SIIS_ERR_INVALID
argument_list|)
expr_stmt|;
return|return;
block|}
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Issue command to the controller. */
name|slot
operator|->
name|state
operator|=
name|SIIS_SLOT_RUNNING
expr_stmt|;
name|ch
operator|->
name|rslots
operator||=
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|prb_bus
operator|=
name|ch
operator|->
name|dma
operator|.
name|work_bus
operator|+
name|SIIS_CT_OFFSET
operator|+
operator|(
name|SIIS_CT_SIZE
operator|*
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CACTL
argument_list|(
name|slot
operator|->
name|slot
argument_list|)
argument_list|,
name|prb_bus
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CACTH
argument_list|(
name|slot
operator|->
name|slot
argument_list|)
argument_list|,
name|prb_bus
operator|>>
literal|32
argument_list|)
expr_stmt|;
comment|/* Start command execution timeout */
name|callout_reset_sbt
argument_list|(
operator|&
name|slot
operator|->
name|timeout
argument_list|,
name|SBT_1MS
operator|*
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout
argument_list|,
literal|0
argument_list|,
operator|(
name|timeout_t
operator|*
operator|)
name|siis_timeout
argument_list|,
name|slot
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* Must be called with channel locked. */
end_comment

begin_function
specifier|static
name|void
name|siis_process_timeout
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ch
operator|->
name|recoverycmd
operator|&&
operator|!
name|ch
operator|->
name|recovery
condition|)
block|{
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|ch
operator|->
name|numrslots
argument_list|)
expr_stmt|;
name|ch
operator|->
name|recovery
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Handle the rest of commands. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
comment|/* Do we have a running request on slot? */
if|if
condition|(
name|ch
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|state
operator|<
name|SIIS_SLOT_RUNNING
condition|)
continue|continue;
name|siis_end_transaction
argument_list|(
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
argument_list|,
name|SIIS_ERR_TIMEOUT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Must be called with channel locked. */
end_comment

begin_function
specifier|static
name|void
name|siis_rearm_timeout
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|siis_slot
modifier|*
name|slot
init|=
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
decl_stmt|;
comment|/* Do we have a running request on slot? */
if|if
condition|(
name|slot
operator|->
name|state
operator|<
name|SIIS_SLOT_RUNNING
condition|)
continue|continue;
if|if
condition|(
operator|(
name|ch
operator|->
name|toslots
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|callout_reset_sbt
argument_list|(
operator|&
name|slot
operator|->
name|timeout
argument_list|,
name|SBT_1MS
operator|*
name|slot
operator|->
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout
argument_list|,
literal|0
argument_list|,
operator|(
name|timeout_t
operator|*
operator|)
name|siis_timeout
argument_list|,
name|slot
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Locked by callout mechanism. */
end_comment

begin_function
specifier|static
name|void
name|siis_timeout
parameter_list|(
name|struct
name|siis_slot
modifier|*
name|slot
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|slot
operator|->
name|dev
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|slot
operator|->
name|ccb
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* Check for stale timeout. */
if|if
condition|(
name|slot
operator|->
name|state
operator|<
name|SIIS_SLOT_RUNNING
condition|)
return|return;
comment|/* Handle soft-reset timeouts without doing hard-reset. */
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_CONTROL
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|control
operator|&
name|ATA_A_RESET
operator|)
condition|)
block|{
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|ch
operator|->
name|numrslots
argument_list|)
expr_stmt|;
name|siis_end_transaction
argument_list|(
name|slot
argument_list|,
name|SIIS_ERR_TFE
argument_list|)
expr_stmt|;
return|return;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Timeout on slot %d\n"
argument_list|,
name|slot
operator|->
name|slot
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"%s is %08x ss %08x rs %08x es %08x sts %08x serr %08x\n"
argument_list|,
name|__func__
argument_list|,
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IS
argument_list|)
argument_list|,
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SS
argument_list|)
argument_list|,
name|ch
operator|->
name|rslots
argument_list|,
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CMDERR
argument_list|)
argument_list|,
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_STS
argument_list|)
argument_list|,
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SERR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|toslots
operator|==
literal|0
condition|)
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ch
operator|->
name|toslots
operator||=
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|->
name|rslots
operator|&
operator|~
name|ch
operator|->
name|toslots
operator|)
operator|==
literal|0
condition|)
name|siis_process_timeout
argument_list|(
name|dev
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|" ... waiting for slots %08x\n"
argument_list|,
name|ch
operator|->
name|rslots
operator|&
operator|~
name|ch
operator|->
name|toslots
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Must be called with channel locked. */
end_comment

begin_function
specifier|static
name|void
name|siis_end_transaction
parameter_list|(
name|struct
name|siis_slot
modifier|*
name|slot
parameter_list|,
name|enum
name|siis_err_type
name|et
parameter_list|)
block|{
name|device_t
name|dev
init|=
name|slot
operator|->
name|dev
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|slot
operator|->
name|ccb
decl_stmt|;
name|int
name|lastto
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
comment|/* Read result registers to the result struct 	 * May be incorrect if several commands finished same time, 	 * so read only when sure or have to. 	 */
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
condition|)
block|{
name|struct
name|ata_res
modifier|*
name|res
init|=
operator|&
name|ccb
operator|->
name|ataio
operator|.
name|res
decl_stmt|;
if|if
condition|(
operator|(
name|et
operator|==
name|SIIS_ERR_TFE
operator|)
operator|||
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_NEEDRESULT
operator|)
condition|)
block|{
name|int
name|offs
init|=
name|SIIS_P_LRAM_SLOT
argument_list|(
name|slot
operator|->
name|slot
argument_list|)
operator|+
literal|8
decl_stmt|;
name|res
operator|->
name|status
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|2
argument_list|)
expr_stmt|;
name|res
operator|->
name|error
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|3
argument_list|)
expr_stmt|;
name|res
operator|->
name|lba_low
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|4
argument_list|)
expr_stmt|;
name|res
operator|->
name|lba_mid
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|5
argument_list|)
expr_stmt|;
name|res
operator|->
name|lba_high
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|6
argument_list|)
expr_stmt|;
name|res
operator|->
name|device
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|7
argument_list|)
expr_stmt|;
name|res
operator|->
name|lba_low_exp
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|8
argument_list|)
expr_stmt|;
name|res
operator|->
name|lba_mid_exp
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|9
argument_list|)
expr_stmt|;
name|res
operator|->
name|lba_high_exp
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|10
argument_list|)
expr_stmt|;
name|res
operator|->
name|sector_count
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|12
argument_list|)
expr_stmt|;
name|res
operator|->
name|sector_count_exp
operator|=
name|ATA_INB
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|offs
operator|+
literal|13
argument_list|)
expr_stmt|;
block|}
else|else
name|bzero
argument_list|(
name|res
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
operator|&&
name|ch
operator|->
name|numrslots
operator|==
literal|1
condition|)
block|{
name|ccb
operator|->
name|ataio
operator|.
name|resid
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|dxfer_len
operator|-
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_LRAM_SLOT
argument_list|(
name|slot
operator|->
name|slot
argument_list|)
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_IN
operator|&&
name|ch
operator|->
name|numrslots
operator|==
literal|1
condition|)
block|{
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|-
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_LRAM_SLOT
argument_list|(
name|slot
operator|->
name|slot
argument_list|)
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|,
name|slot
operator|->
name|dma
operator|.
name|data_map
argument_list|,
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_IN
operator|)
condition|?
name|BUS_DMASYNC_POSTREAD
else|:
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|data_tag
argument_list|,
name|slot
operator|->
name|dma
operator|.
name|data_map
argument_list|)
expr_stmt|;
block|}
comment|/* Set proper result status. */
if|if
condition|(
name|et
operator|!=
name|SIIS_ERR_NONE
operator|||
name|ch
operator|->
name|recovery
condition|)
block|{
name|ch
operator|->
name|eslots
operator||=
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_RELEASE_SIMQ
expr_stmt|;
block|}
comment|/* In case of error, freeze device for proper recovery. */
if|if
condition|(
name|et
operator|!=
name|SIIS_ERR_NONE
operator|&&
operator|(
operator|!
name|ch
operator|->
name|recoverycmd
operator|)
operator|&&
operator|!
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_DEV_QFRZN
operator|)
condition|)
block|{
name|xpt_freeze_devq
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_DEV_QFRZN
expr_stmt|;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_STATUS_MASK
expr_stmt|;
switch|switch
condition|(
name|et
condition|)
block|{
case|case
name|SIIS_ERR_NONE
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQ_CMP
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_SCSI_IO
condition|)
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|SCSI_STATUS_OK
expr_stmt|;
break|break;
case|case
name|SIIS_ERR_INVALID
case|:
name|ch
operator|->
name|fatalerr
operator|=
literal|1
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
case|case
name|SIIS_ERR_INNOCENT
case|:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQUEUE_REQ
expr_stmt|;
break|break;
case|case
name|SIIS_ERR_TFE
case|:
case|case
name|SIIS_ERR_NCQ
case|:
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_SCSI_IO
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_SCSI_STATUS_ERROR
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|SCSI_STATUS_CHECK_COND
expr_stmt|;
block|}
else|else
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_ATA_STATUS_ERROR
expr_stmt|;
block|}
break|break;
case|case
name|SIIS_ERR_SATA
case|:
name|ch
operator|->
name|fatalerr
operator|=
literal|1
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_UNCOR_PARITY
expr_stmt|;
break|break;
case|case
name|SIIS_ERR_TIMEOUT
case|:
name|ch
operator|->
name|fatalerr
operator|=
literal|1
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_CMD_TIMEOUT
expr_stmt|;
break|break;
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQ_CMP_ERR
expr_stmt|;
block|}
comment|/* Free slot. */
name|ch
operator|->
name|oslots
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|ch
operator|->
name|rslots
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|ch
operator|->
name|aslots
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
name|slot
operator|->
name|state
operator|=
name|SIIS_SLOT_EMPTY
expr_stmt|;
name|slot
operator|->
name|ccb
operator|=
name|NULL
expr_stmt|;
comment|/* Update channel stats. */
name|ch
operator|->
name|numrslots
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
operator|)
operator|&&
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_FPDMA
operator|)
condition|)
block|{
name|ch
operator|->
name|numtslots
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
operator|--
expr_stmt|;
block|}
comment|/* Cancel timeout state if request completed normally. */
if|if
condition|(
name|et
operator|!=
name|SIIS_ERR_TIMEOUT
condition|)
block|{
name|lastto
operator|=
operator|(
name|ch
operator|->
name|toslots
operator|==
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
operator|)
expr_stmt|;
name|ch
operator|->
name|toslots
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|slot
operator|->
name|slot
operator|)
expr_stmt|;
if|if
condition|(
name|lastto
condition|)
name|xpt_release_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
comment|/* If it was our READ LOG command - process it. */
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|recovery_type
operator|==
name|RECOVERY_READ_LOG
condition|)
block|{
name|siis_process_read_log
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
comment|/* If it was our REQUEST SENSE command - process it. */
block|}
elseif|else
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|recovery_type
operator|==
name|RECOVERY_REQUEST_SENSE
condition|)
block|{
name|siis_process_request_sense
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
comment|/* If it was NCQ or ATAPI command error, put result on hold. */
block|}
elseif|else
if|if
condition|(
name|et
operator|==
name|SIIS_ERR_NCQ
operator|||
operator|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|==
name|CAM_SCSI_STATUS_ERROR
operator|&&
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIS_AUTOSENSE
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|ch
operator|->
name|hold
index|[
name|slot
operator|->
name|slot
index|]
operator|=
name|ccb
expr_stmt|;
name|ch
operator|->
name|numhslots
operator|++
expr_stmt|;
block|}
else|else
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
comment|/* If we have no other active commands, ... */
if|if
condition|(
name|ch
operator|->
name|rslots
operator|==
literal|0
condition|)
block|{
comment|/* if there were timeouts or fatal error - reset port. */
if|if
condition|(
name|ch
operator|->
name|toslots
operator|!=
literal|0
operator|||
name|ch
operator|->
name|fatalerr
condition|)
block|{
name|siis_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* if we have slots in error, we can reinit port. */
if|if
condition|(
name|ch
operator|->
name|eslots
operator|!=
literal|0
condition|)
name|siis_portinit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* if there commands on hold, we can do recovery. */
if|if
condition|(
operator|!
name|ch
operator|->
name|recoverycmd
operator|&&
name|ch
operator|->
name|numhslots
condition|)
name|siis_issue_recovery
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* If all the reset of commands are in timeout - abort them. */
block|}
elseif|else
if|if
condition|(
operator|(
name|ch
operator|->
name|rslots
operator|&
operator|~
name|ch
operator|->
name|toslots
operator|)
operator|==
literal|0
operator|&&
name|et
operator|!=
name|SIIS_ERR_TIMEOUT
condition|)
name|siis_rearm_timeout
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Unfreeze frozen command. */
if|if
condition|(
name|ch
operator|->
name|frozen
operator|&&
operator|!
name|siis_check_collision
argument_list|(
name|dev
argument_list|,
name|ch
operator|->
name|frozen
argument_list|)
condition|)
block|{
name|union
name|ccb
modifier|*
name|fccb
init|=
name|ch
operator|->
name|frozen
decl_stmt|;
name|ch
operator|->
name|frozen
operator|=
name|NULL
expr_stmt|;
name|siis_begin_transaction
argument_list|(
name|dev
argument_list|,
name|fccb
argument_list|)
expr_stmt|;
name|xpt_release_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|siis_issue_recovery
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|struct
name|ccb_ataio
modifier|*
name|ataio
decl_stmt|;
name|struct
name|ccb_scsiio
modifier|*
name|csio
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Find some held command. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|SIIS_MAX_SLOTS
condition|)
return|return;
name|ccb
operator|=
name|xpt_alloc_ccb_nowait
argument_list|()
expr_stmt|;
if|if
condition|(
name|ccb
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to allocate recovery command\n"
argument_list|)
expr_stmt|;
name|completeall
label|:
comment|/* We can't do anything -- complete held commands. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_STATUS_MASK
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_RESRC_UNAVAIL
expr_stmt|;
name|xpt_done
argument_list|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|ch
operator|->
name|numhslots
operator|--
expr_stmt|;
block|}
name|siis_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return;
block|}
name|ccb
operator|->
name|ccb_h
operator|=
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
expr_stmt|;
comment|/* Reuse old header. */
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_ATA_IO
condition|)
block|{
comment|/* READ LOG */
name|ccb
operator|->
name|ccb_h
operator|.
name|recovery_type
operator|=
name|RECOVERY_READ_LOG
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_ATA_IO
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|=
name|CAM_DIR_IN
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout
operator|=
literal|1000
expr_stmt|;
comment|/* 1s should be enough. */
name|ataio
operator|=
operator|&
name|ccb
operator|->
name|ataio
expr_stmt|;
name|ataio
operator|->
name|data_ptr
operator|=
name|malloc
argument_list|(
literal|512
argument_list|,
name|M_SIIS
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ataio
operator|->
name|data_ptr
operator|==
name|NULL
condition|)
block|{
name|xpt_free_ccb
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to allocate memory for READ LOG command\n"
argument_list|)
expr_stmt|;
goto|goto
name|completeall
goto|;
block|}
name|ataio
operator|->
name|dxfer_len
operator|=
literal|512
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ataio
operator|->
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|ataio
operator|->
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|ataio
operator|->
name|cmd
operator|.
name|flags
operator|=
name|CAM_ATAIO_48BIT
expr_stmt|;
name|ataio
operator|->
name|cmd
operator|.
name|command
operator|=
literal|0x2F
expr_stmt|;
comment|/* READ LOG EXT */
name|ataio
operator|->
name|cmd
operator|.
name|sector_count
operator|=
literal|1
expr_stmt|;
name|ataio
operator|->
name|cmd
operator|.
name|sector_count_exp
operator|=
literal|0
expr_stmt|;
name|ataio
operator|->
name|cmd
operator|.
name|lba_low
operator|=
literal|0x10
expr_stmt|;
name|ataio
operator|->
name|cmd
operator|.
name|lba_mid
operator|=
literal|0
expr_stmt|;
name|ataio
operator|->
name|cmd
operator|.
name|lba_mid_exp
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* REQUEST SENSE */
name|ccb
operator|->
name|ccb_h
operator|.
name|recovery_type
operator|=
name|RECOVERY_REQUEST_SENSE
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|recovery_slot
operator|=
name|i
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SCSI_IO
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|=
name|CAM_DIR_IN
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout
operator|=
literal|1000
expr_stmt|;
comment|/* 1s should be enough. */
name|csio
operator|=
operator|&
name|ccb
operator|->
name|csio
expr_stmt|;
name|csio
operator|->
name|data_ptr
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|csio
operator|.
name|sense_data
expr_stmt|;
name|csio
operator|->
name|dxfer_len
operator|=
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|csio
operator|.
name|sense_len
expr_stmt|;
name|csio
operator|->
name|cdb_len
operator|=
literal|6
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|csio
operator|->
name|cdb_io
argument_list|,
sizeof|sizeof
argument_list|(
name|csio
operator|->
name|cdb_io
argument_list|)
argument_list|)
expr_stmt|;
name|csio
operator|->
name|cdb_io
operator|.
name|cdb_bytes
index|[
literal|0
index|]
operator|=
literal|0x03
expr_stmt|;
name|csio
operator|->
name|cdb_io
operator|.
name|cdb_bytes
index|[
literal|4
index|]
operator|=
name|csio
operator|->
name|dxfer_len
expr_stmt|;
block|}
name|ch
operator|->
name|recoverycmd
operator|=
literal|1
expr_stmt|;
name|siis_begin_transaction
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siis_process_read_log
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|data
decl_stmt|;
name|struct
name|ata_res
modifier|*
name|res
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ch
operator|->
name|recoverycmd
operator|=
literal|0
expr_stmt|;
name|data
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|data_ptr
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|==
name|CAM_REQ_CMP
operator|&&
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x80
operator|)
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ch
operator|->
name|hold
index|[
name|i
index|]
condition|)
continue|continue;
if|if
condition|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|target_id
operator|!=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
condition|)
continue|continue;
if|if
condition|(
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x1F
operator|)
operator|==
name|i
condition|)
block|{
name|res
operator|=
operator|&
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ataio
operator|.
name|res
expr_stmt|;
name|res
operator|->
name|status
operator|=
name|data
index|[
literal|2
index|]
expr_stmt|;
name|res
operator|->
name|error
operator|=
name|data
index|[
literal|3
index|]
expr_stmt|;
name|res
operator|->
name|lba_low
operator|=
name|data
index|[
literal|4
index|]
expr_stmt|;
name|res
operator|->
name|lba_mid
operator|=
name|data
index|[
literal|5
index|]
expr_stmt|;
name|res
operator|->
name|lba_high
operator|=
name|data
index|[
literal|6
index|]
expr_stmt|;
name|res
operator|->
name|device
operator|=
name|data
index|[
literal|7
index|]
expr_stmt|;
name|res
operator|->
name|lba_low_exp
operator|=
name|data
index|[
literal|8
index|]
expr_stmt|;
name|res
operator|->
name|lba_mid_exp
operator|=
name|data
index|[
literal|9
index|]
expr_stmt|;
name|res
operator|->
name|lba_high_exp
operator|=
name|data
index|[
literal|10
index|]
expr_stmt|;
name|res
operator|->
name|sector_count
operator|=
name|data
index|[
literal|12
index|]
expr_stmt|;
name|res
operator|->
name|sector_count_exp
operator|=
name|data
index|[
literal|13
index|]
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_STATUS_MASK
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQUEUE_REQ
expr_stmt|;
block|}
name|xpt_done
argument_list|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|ch
operator|->
name|numhslots
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|!=
name|CAM_REQ_CMP
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Error while READ LOG EXT\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|data
index|[
literal|0
index|]
operator|&
literal|0x80
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Non-queued command error in READ LOG EXT\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ch
operator|->
name|hold
index|[
name|i
index|]
condition|)
continue|continue;
if|if
condition|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|target_id
operator|!=
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
condition|)
continue|continue;
name|xpt_done
argument_list|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|ch
operator|->
name|numhslots
operator|--
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|ccb
operator|->
name|ataio
operator|.
name|data_ptr
argument_list|,
name|M_SIIS
argument_list|)
expr_stmt|;
name|xpt_free_ccb
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siis_process_request_sense
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ch
operator|->
name|recoverycmd
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|recovery_slot
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|==
name|CAM_REQ_CMP
condition|)
block|{
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_AUTOSNS_VALID
expr_stmt|;
block|}
else|else
block|{
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_STATUS_MASK
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_AUTOSENSE_FAIL
expr_stmt|;
block|}
name|xpt_done
argument_list|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|ch
operator|->
name|numhslots
operator|--
expr_stmt|;
name|xpt_free_ccb
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siis_portinit
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ch
operator|->
name|eslots
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|recovery
operator|=
literal|0
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_RESUME
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_PMPSTS
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|,
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_PMPQACT
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_PORT_INIT
argument_list|)
expr_stmt|;
name|siis_wait_ready
argument_list|(
name|dev
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_devreset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_DEV_RESET
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|val
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_STS
argument_list|)
operator|)
operator|&
name|SIIS_P_CTL_DEV_RESET
operator|)
operator|!=
literal|0
condition|)
block|{
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|++
operator|>
literal|1000
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"device reset stuck "
literal|"(timeout 100ms) status = %08x\n"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_wait_ready
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|t
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|timeout
init|=
literal|0
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
while|while
condition|(
operator|(
operator|(
name|val
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_STS
argument_list|)
operator|)
operator|&
name|SIIS_P_CTL_READY
operator|)
operator|==
literal|0
condition|)
block|{
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|++
operator|>
name|t
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"port is not ready (timeout %dms) "
literal|"status = %08x\n"
argument_list|,
name|t
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siis_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|retry
init|=
literal|0
decl_stmt|,
name|sata_rev
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SIIS reset...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ch
operator|->
name|recoverycmd
operator|&&
operator|!
name|ch
operator|->
name|recovery
condition|)
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|ch
operator|->
name|numrslots
argument_list|)
expr_stmt|;
comment|/* Requeue frozen command. */
if|if
condition|(
name|ch
operator|->
name|frozen
condition|)
block|{
name|union
name|ccb
modifier|*
name|fccb
init|=
name|ch
operator|->
name|frozen
decl_stmt|;
name|ch
operator|->
name|frozen
operator|=
name|NULL
expr_stmt|;
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator|&=
operator|~
name|CAM_STATUS_MASK
expr_stmt|;
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQUEUE_REQ
operator||
name|CAM_RELEASE_SIMQ
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_DEV_QFRZN
operator|)
condition|)
block|{
name|xpt_freeze_devq
argument_list|(
name|fccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_DEV_QFRZN
expr_stmt|;
block|}
name|xpt_done
argument_list|(
name|fccb
argument_list|)
expr_stmt|;
block|}
comment|/* Requeue all running commands. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
comment|/* Do we have a running request on slot? */
if|if
condition|(
name|ch
operator|->
name|slot
index|[
name|i
index|]
operator|.
name|state
operator|<
name|SIIS_SLOT_RUNNING
condition|)
continue|continue;
comment|/* XXX; Commands in loading state. */
name|siis_end_transaction
argument_list|(
operator|&
name|ch
operator|->
name|slot
index|[
name|i
index|]
argument_list|,
name|SIIS_ERR_INNOCENT
argument_list|)
expr_stmt|;
block|}
comment|/* Finish all held commands as-is. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SIIS_MAX_SLOTS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ch
operator|->
name|hold
index|[
name|i
index|]
condition|)
continue|continue;
name|xpt_done
argument_list|(
name|ch
operator|->
name|hold
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hold
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|ch
operator|->
name|numhslots
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|ch
operator|->
name|toslots
operator|!=
literal|0
condition|)
name|xpt_release_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ch
operator|->
name|eslots
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|recovery
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|toslots
operator|=
literal|0
expr_stmt|;
name|ch
operator|->
name|fatalerr
operator|=
literal|0
expr_stmt|;
comment|/* Disable port interrupts */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IECLR
argument_list|,
literal|0x0000FFFF
argument_list|)
expr_stmt|;
comment|/* Set speed limit. */
name|sata_rev
operator|=
name|ch
operator|->
name|user
index|[
name|ch
operator|->
name|pm_present
condition|?
literal|15
else|:
literal|0
index|]
operator|.
name|revision
expr_stmt|;
if|if
condition|(
name|sata_rev
operator|==
literal|1
condition|)
name|val
operator|=
name|ATA_SC_SPD_SPEED_GEN1
expr_stmt|;
elseif|else
if|if
condition|(
name|sata_rev
operator|==
literal|2
condition|)
name|val
operator|=
name|ATA_SC_SPD_SPEED_GEN2
expr_stmt|;
elseif|else
if|if
condition|(
name|sata_rev
operator|==
literal|3
condition|)
name|val
operator|=
name|ATA_SC_SPD_SPEED_GEN3
expr_stmt|;
else|else
name|val
operator|=
literal|0
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SCTL
argument_list|,
name|ATA_SC_DET_IDLE
operator||
name|val
operator||
operator|(
operator|(
name|ch
operator|->
name|pm_level
operator|>
literal|0
operator|)
condition|?
literal|0
else|:
operator|(
name|ATA_SC_IPM_DIS_PARTIAL
operator||
name|ATA_SC_IPM_DIS_SLUMBER
operator|)
operator|)
argument_list|)
expr_stmt|;
name|retry
label|:
name|siis_devreset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Reset and reconnect PHY, */
if|if
condition|(
operator|!
name|siis_sata_connect
argument_list|(
name|ch
argument_list|)
condition|)
block|{
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
comment|/* Enable port interrupts */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IESET
argument_list|,
name|SIIS_P_IX_ENABLED
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SIIS reset done: phy reset found no device\n"
argument_list|)
expr_stmt|;
comment|/* Tell the XPT about the event */
name|xpt_async
argument_list|(
name|AC_BUS_RESET
argument_list|,
name|ch
operator|->
name|path
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xpt_release_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Wait for port ready status. */
if|if
condition|(
name|siis_wait_ready
argument_list|(
name|dev
argument_list|,
literal|1000
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"port ready timeout\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|retry
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"trying full port reset ...\n"
argument_list|)
expr_stmt|;
comment|/* Get port to the reset state. */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_PORT_RESET
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
comment|/* Get port out of reset state. */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_PORT_RESET
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_32BIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|pm_present
condition|)
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_PME
argument_list|)
expr_stmt|;
else|else
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_PME
argument_list|)
expr_stmt|;
name|siis_wait_ready
argument_list|(
name|dev
argument_list|,
literal|5000
argument_list|)
expr_stmt|;
name|retry
operator|=
literal|1
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
block|}
name|ch
operator|->
name|devices
operator|=
literal|1
expr_stmt|;
comment|/* Enable port interrupts */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IS
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_IESET
argument_list|,
name|SIIS_P_IX_ENABLED
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"SIIS reset done: devices=%08x\n"
argument_list|,
name|ch
operator|->
name|devices
argument_list|)
expr_stmt|;
comment|/* Tell the XPT about the event */
name|xpt_async
argument_list|(
name|AC_BUS_RESET
argument_list|,
name|ch
operator|->
name|path
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xpt_release_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_setup_fis
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|siis_cmd
modifier|*
name|ctp
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|int
name|tag
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|u_int8_t
modifier|*
name|fis
init|=
operator|&
name|ctp
operator|->
name|fis
index|[
literal|0
index|]
decl_stmt|;
name|bzero
argument_list|(
name|fis
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|fis
index|[
literal|0
index|]
operator|=
literal|0x27
expr_stmt|;
comment|/* host to device */
name|fis
index|[
literal|1
index|]
operator|=
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|&
literal|0x0f
operator|)
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|==
name|XPT_SCSI_IO
condition|)
block|{
name|fis
index|[
literal|1
index|]
operator||=
literal|0x80
expr_stmt|;
name|fis
index|[
literal|2
index|]
operator|=
name|ATA_PACKET_CMD
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|!=
name|CAM_DIR_NONE
operator|&&
name|ch
operator|->
name|curr
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
operator|.
name|mode
operator|>=
name|ATA_DMA
condition|)
name|fis
index|[
literal|3
index|]
operator|=
name|ATA_F_DMA
expr_stmt|;
else|else
block|{
name|fis
index|[
literal|5
index|]
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
expr_stmt|;
name|fis
index|[
literal|6
index|]
operator|=
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
operator|>>
literal|8
expr_stmt|;
block|}
name|fis
index|[
literal|7
index|]
operator|=
name|ATA_D_LBA
expr_stmt|;
name|fis
index|[
literal|15
index|]
operator|=
name|ATA_A_4BIT
expr_stmt|;
name|bzero
argument_list|(
name|ctp
operator|->
name|u
operator|.
name|atapi
operator|.
name|ccb
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_CDB_POINTER
operator|)
condition|?
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_ptr
else|:
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_bytes
argument_list|,
name|ctp
operator|->
name|u
operator|.
name|atapi
operator|.
name|ccb
argument_list|,
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_CONTROL
operator|)
operator|==
literal|0
condition|)
block|{
name|fis
index|[
literal|1
index|]
operator||=
literal|0x80
expr_stmt|;
name|fis
index|[
literal|2
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|command
expr_stmt|;
name|fis
index|[
literal|3
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|features
expr_stmt|;
name|fis
index|[
literal|4
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|lba_low
expr_stmt|;
name|fis
index|[
literal|5
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|lba_mid
expr_stmt|;
name|fis
index|[
literal|6
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|lba_high
expr_stmt|;
name|fis
index|[
literal|7
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|device
expr_stmt|;
name|fis
index|[
literal|8
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|lba_low_exp
expr_stmt|;
name|fis
index|[
literal|9
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|lba_mid_exp
expr_stmt|;
name|fis
index|[
literal|10
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|lba_high_exp
expr_stmt|;
name|fis
index|[
literal|11
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|features_exp
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|flags
operator|&
name|CAM_ATAIO_FPDMA
condition|)
block|{
name|fis
index|[
literal|12
index|]
operator|=
name|tag
operator|<<
literal|3
expr_stmt|;
name|fis
index|[
literal|13
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fis
index|[
literal|12
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|sector_count
expr_stmt|;
name|fis
index|[
literal|13
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|cmd
operator|.
name|sector_count_exp
expr_stmt|;
block|}
name|fis
index|[
literal|15
index|]
operator|=
name|ATA_A_4BIT
expr_stmt|;
if|if
condition|(
name|ccb
operator|->
name|ataio
operator|.
name|ata_flags
operator|&
name|ATA_FLAG_AUX
condition|)
block|{
name|fis
index|[
literal|16
index|]
operator|=
name|ccb
operator|->
name|ataio
operator|.
name|aux
operator|&
literal|0xff
expr_stmt|;
name|fis
index|[
literal|17
index|]
operator|=
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|aux
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|fis
index|[
literal|18
index|]
operator|=
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|aux
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|fis
index|[
literal|19
index|]
operator|=
operator|(
name|ccb
operator|->
name|ataio
operator|.
name|aux
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Soft reset. */
block|}
return|return
operator|(
literal|20
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_sata_connect
parameter_list|(
name|struct
name|siis_channel
modifier|*
name|ch
parameter_list|)
block|{
name|u_int32_t
name|status
decl_stmt|;
name|int
name|timeout
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
comment|/* Wait up to 100ms for "connect well" */
for|for
control|(
name|timeout
operator|=
literal|0
init|;
name|timeout
operator|<
literal|1000
condition|;
name|timeout
operator|++
control|)
block|{
name|status
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SSTS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|&
name|ATA_SS_DET_MASK
operator|)
operator|!=
name|ATA_SS_DET_NO_DEVICE
condition|)
name|found
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|status
operator|&
name|ATA_SS_DET_MASK
operator|)
operator|==
name|ATA_SS_DET_PHY_ONLINE
operator|)
operator|&&
operator|(
operator|(
name|status
operator|&
name|ATA_SS_SPD_MASK
operator|)
operator|!=
name|ATA_SS_SPD_NO_SPEED
operator|)
operator|&&
operator|(
operator|(
name|status
operator|&
name|ATA_SS_IPM_MASK
operator|)
operator|==
name|ATA_SS_IPM_ACTIVE
operator|)
condition|)
break|break;
if|if
condition|(
operator|(
name|status
operator|&
name|ATA_SS_DET_MASK
operator|)
operator|==
name|ATA_SS_DET_PHY_OFFLINE
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"SATA offline status=%08x\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|found
operator|==
literal|0
operator|&&
name|timeout
operator|>=
literal|100
condition|)
break|break;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeout
operator|>=
literal|1000
operator|||
operator|!
name|found
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"SATA connect timeout time=%dus status=%08x\n"
argument_list|,
name|timeout
operator|*
literal|100
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|ch
operator|->
name|dev
argument_list|,
literal|"SATA connect time=%dus status=%08x\n"
argument_list|,
name|timeout
operator|*
literal|100
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
comment|/* Clear SATA error register */
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SERR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|siis_check_ids
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|>
literal|15
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_TID_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
operator|!=
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_LUN_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|siisaction
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|)
block|{
name|device_t
name|dev
decl_stmt|,
name|parent
decl_stmt|;
name|struct
name|siis_channel
modifier|*
name|ch
decl_stmt|;
name|CAM_DEBUG
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|,
name|CAM_DEBUG_TRACE
argument_list|,
operator|(
literal|"siisaction func_code=%x\n"
operator|,
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|)
argument_list|)
expr_stmt|;
name|ch
operator|=
operator|(
expr|struct
name|siis_channel
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|dev
operator|=
name|ch
operator|->
name|dev
expr_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
comment|/* Common cases first */
case|case
name|XPT_ATA_IO
case|:
comment|/* Execute the requested I/O operation */
case|case
name|XPT_SCSI_IO
case|:
if|if
condition|(
name|siis_check_ids
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
condition|)
return|return;
if|if
condition|(
name|ch
operator|->
name|devices
operator|==
literal|0
operator|||
operator|(
name|ch
operator|->
name|pm_present
operator|==
literal|0
operator|&&
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|>
literal|0
operator|&&
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|<
literal|15
operator|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_SEL_TIMEOUT
expr_stmt|;
break|break;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|recovery_type
operator|=
name|RECOVERY_NONE
expr_stmt|;
comment|/* Check for command collision. */
if|if
condition|(
name|siis_check_collision
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
condition|)
block|{
comment|/* Freeze command. */
name|ch
operator|->
name|frozen
operator|=
name|ccb
expr_stmt|;
comment|/* We have only one frozen slot, so freeze simq also. */
name|xpt_freeze_simq
argument_list|(
name|ch
operator|->
name|sim
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|siis_begin_transaction
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
expr_stmt|;
return|return;
case|case
name|XPT_ABORT
case|:
comment|/* Abort the specified CCB */
comment|/* XXX Implement */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
case|case
name|XPT_SET_TRAN_SETTINGS
case|:
block|{
name|struct
name|ccb_trans_settings
modifier|*
name|cts
init|=
operator|&
name|ccb
operator|->
name|cts
decl_stmt|;
name|struct
name|siis_device
modifier|*
name|d
decl_stmt|;
if|if
condition|(
name|siis_check_ids
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
condition|)
return|return;
if|if
condition|(
name|cts
operator|->
name|type
operator|==
name|CTS_TYPE_CURRENT_SETTINGS
condition|)
name|d
operator|=
operator|&
name|ch
operator|->
name|curr
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
expr_stmt|;
else|else
name|d
operator|=
operator|&
name|ch
operator|->
name|user
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|&
name|CTS_SATA_VALID_REVISION
condition|)
name|d
operator|->
name|revision
operator|=
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|revision
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|&
name|CTS_SATA_VALID_MODE
condition|)
name|d
operator|->
name|mode
operator|=
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|mode
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|&
name|CTS_SATA_VALID_BYTECOUNT
condition|)
name|d
operator|->
name|bytecount
operator|=
name|min
argument_list|(
literal|8192
argument_list|,
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|bytecount
argument_list|)
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|&
name|CTS_SATA_VALID_TAGS
condition|)
name|d
operator|->
name|tags
operator|=
name|min
argument_list|(
name|SIIS_MAX_SLOTS
argument_list|,
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|tags
argument_list|)
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|&
name|CTS_SATA_VALID_PM
condition|)
block|{
name|ch
operator|->
name|pm_present
operator|=
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|pm_present
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|pm_present
condition|)
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLSET
argument_list|,
name|SIIS_P_CTL_PME
argument_list|)
expr_stmt|;
else|else
name|ATA_OUTL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_CTLCLR
argument_list|,
name|SIIS_P_CTL_PME
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|&
name|CTS_SATA_VALID_TAGS
condition|)
name|d
operator|->
name|atapi
operator|=
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|atapi
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|&
name|CTS_SATA_VALID_CAPS
condition|)
name|d
operator|->
name|caps
operator|=
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|caps
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
block|}
case|case
name|XPT_GET_TRAN_SETTINGS
case|:
comment|/* Get default/user set transfer settings for the target */
block|{
name|struct
name|ccb_trans_settings
modifier|*
name|cts
init|=
operator|&
name|ccb
operator|->
name|cts
decl_stmt|;
name|struct
name|siis_device
modifier|*
name|d
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
if|if
condition|(
name|siis_check_ids
argument_list|(
name|dev
argument_list|,
name|ccb
argument_list|)
condition|)
return|return;
if|if
condition|(
name|cts
operator|->
name|type
operator|==
name|CTS_TYPE_CURRENT_SETTINGS
condition|)
name|d
operator|=
operator|&
name|ch
operator|->
name|curr
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
expr_stmt|;
else|else
name|d
operator|=
operator|&
name|ch
operator|->
name|user
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
expr_stmt|;
name|cts
operator|->
name|protocol
operator|=
name|PROTO_UNSPECIFIED
expr_stmt|;
name|cts
operator|->
name|protocol_version
operator|=
name|PROTO_VERSION_UNSPECIFIED
expr_stmt|;
name|cts
operator|->
name|transport
operator|=
name|XPORT_SATA
expr_stmt|;
name|cts
operator|->
name|transport_version
operator|=
name|XPORT_VERSION_UNSPECIFIED
expr_stmt|;
name|cts
operator|->
name|proto_specific
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|type
operator|==
name|CTS_TYPE_CURRENT_SETTINGS
operator|&&
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|==
literal|15
operator|||
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
operator|==
literal|0
operator|&&
operator|!
name|ch
operator|->
name|pm_present
operator|)
operator|)
condition|)
block|{
name|status
operator|=
name|ATA_INL
argument_list|(
name|ch
operator|->
name|r_mem
argument_list|,
name|SIIS_P_SSTS
argument_list|)
operator|&
name|ATA_SS_SPD_MASK
expr_stmt|;
if|if
condition|(
name|status
operator|&
literal|0x0f0
condition|)
block|{
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|revision
operator|=
operator|(
name|status
operator|&
literal|0x0f0
operator|)
operator|>>
literal|4
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_REVISION
expr_stmt|;
block|}
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|caps
operator|=
name|d
operator|->
name|caps
operator|&
name|CTS_SATA_CAPS_D
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|pm_level
condition|)
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|caps
operator||=
name|CTS_SATA_CAPS_H_PMREQ
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|caps
operator||=
name|CTS_SATA_CAPS_H_AN
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|caps
operator|&=
name|ch
operator|->
name|user
index|[
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
index|]
operator|.
name|caps
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_CAPS
expr_stmt|;
block|}
else|else
block|{
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|revision
operator|=
name|d
operator|->
name|revision
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_REVISION
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|caps
operator|=
name|d
operator|->
name|caps
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|type
operator|==
name|CTS_TYPE_CURRENT_SETTINGS
operator|&&
operator|(
name|ch
operator|->
name|quirks
operator|&
name|SIIS_Q_SNTF
operator|)
operator|==
literal|0
condition|)
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|caps
operator|&=
operator|~
name|CTS_SATA_CAPS_H_AN
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_CAPS
expr_stmt|;
block|}
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|mode
operator|=
name|d
operator|->
name|mode
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_MODE
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|bytecount
operator|=
name|d
operator|->
name|bytecount
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_BYTECOUNT
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|pm_present
operator|=
name|ch
operator|->
name|pm_present
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_PM
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|tags
operator|=
name|d
operator|->
name|tags
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_TAGS
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|atapi
operator|=
name|d
operator|->
name|atapi
expr_stmt|;
name|cts
operator|->
name|xport_specific
operator|.
name|sata
operator|.
name|valid
operator||=
name|CTS_SATA_VALID_ATAPI
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
block|}
case|case
name|XPT_RESET_BUS
case|:
comment|/* Reset the specified SCSI bus */
case|case
name|XPT_RESET_DEV
case|:
comment|/* Bus Device Reset the specified SCSI device */
name|siis_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
case|case
name|XPT_TERM_IO
case|:
comment|/* Terminate the I/O process */
comment|/* XXX Implement */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
case|case
name|XPT_PATH_INQ
case|:
comment|/* Path routing inquiry */
block|{
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|ccb
operator|->
name|cpi
decl_stmt|;
name|parent
operator|=
name|device_get_parent
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|version_num
operator|=
literal|1
expr_stmt|;
comment|/* XXX??? */
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_SDTR_ABLE
operator||
name|PI_TAG_ABLE
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator||=
name|PI_SATAPM
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
name|PIM_SEQSCAN
operator||
name|PIM_UNMAPPED
operator||
name|PIM_ATA_EXT
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
literal|15
expr_stmt|;
name|cpi
operator|->
name|max_lun
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|initiator_id
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|bus_id
operator|=
name|cam_sim_bus
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|150000
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"SIIS"
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|cam_sim_name
argument_list|(
name|sim
argument_list|)
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|cam_sim_unit
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|transport
operator|=
name|XPORT_SATA
expr_stmt|;
name|cpi
operator|->
name|transport_version
operator|=
name|XPORT_VERSION_UNSPECIFIED
expr_stmt|;
name|cpi
operator|->
name|protocol
operator|=
name|PROTO_ATA
expr_stmt|;
name|cpi
operator|->
name|protocol_version
operator|=
name|PROTO_VERSION_UNSPECIFIED
expr_stmt|;
name|cpi
operator|->
name|maxio
operator|=
name|MAXPHYS
expr_stmt|;
name|cpi
operator|->
name|hba_vendor
operator|=
name|pci_get_vendor
argument_list|(
name|parent
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|hba_device
operator|=
name|pci_get_device
argument_list|(
name|parent
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|hba_subvendor
operator|=
name|pci_get_subvendor
argument_list|(
name|parent
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|hba_subdevice
operator|=
name|pci_get_subdevice
argument_list|(
name|parent
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
break|break;
block|}
default|default:
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
break|break;
block|}
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|siispoll
parameter_list|(
name|struct
name|cam_sim
modifier|*
name|sim
parameter_list|)
block|{
name|struct
name|siis_channel
modifier|*
name|ch
init|=
operator|(
expr|struct
name|siis_channel
operator|*
operator|)
name|cam_sim_softc
argument_list|(
name|sim
argument_list|)
decl_stmt|;
name|siis_ch_intr
argument_list|(
name|ch
operator|->
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006-2010 Adaptec, Inc.  * Copyright (c) 2010-2012 PMC-Sierra, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Debugging support.  */
end_comment

begin_include
include|#
directive|include
file|"opt_aacraid.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/aacraid/aacraid_reg.h>
end_include

begin_include
include|#
directive|include
file|<sys/aac_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/aacraid/aacraid_var.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<dev/aacraid/aacraid_debug.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|AACRAID_DEBUG
end_ifdef

begin_comment
comment|/*  * Dump the command queue indices  */
end_comment

begin_function
name|void
name|aacraid_print_queues
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_FREE      %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_FREE
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_FREE
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_READY     %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_READY
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_READY
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AACQ_BUSY      %d/%d\n"
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_BUSY
index|]
operator|.
name|q_length
argument_list|,
name|sc
operator|->
name|aac_qstat
index|[
name|AACQ_BUSY
index|]
operator|.
name|q_max
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print a FIB  */
end_comment

begin_function
name|void
name|aacraid_print_fib
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|aac_fib
modifier|*
name|fib
parameter_list|,
specifier|const
name|char
modifier|*
name|caller
parameter_list|)
block|{
if|if
condition|(
name|fib
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"aac_print_fib called with NULL fib\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"%s: FIB @ %p\n"
argument_list|,
name|caller
argument_list|,
name|fib
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  XferState %b\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|XferState
argument_list|,
literal|"\20"
literal|"\1HOSTOWNED"
literal|"\2ADAPTEROWNED"
literal|"\3INITIALISED"
literal|"\4EMPTY"
literal|"\5FROMPOOL"
literal|"\6FROMHOST"
literal|"\7FROMADAP"
literal|"\10REXPECTED"
literal|"\11RNOTEXPECTED"
literal|"\12DONEADAP"
literal|"\13DONEHOST"
literal|"\14HIGH"
literal|"\15NORM"
literal|"\16ASYNC"
literal|"\17PAGEFILEIO"
literal|"\20SHUTDOWN"
literal|"\21LAZYWRITE"
literal|"\22ADAPMICROFIB"
literal|"\23BIOSFIB"
literal|"\24FAST_RESPONSE"
literal|"\25APIFIB\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  Command       %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|Command
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  StructType    %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|StructType
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  Size          %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|Size
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  SenderSize    %d\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|SenderSize
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  SenderAddress 0x%x\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|SenderFibAddress
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  RcvrAddress   0x%x\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|u
operator|.
name|ReceiverFibAddress
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  Handle    0x%x\n"
argument_list|,
name|fib
operator|->
name|Header
operator|.
name|Handle
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fib
operator|->
name|Header
operator|.
name|Command
condition|)
block|{
case|case
name|ContainerCommand
case|:
block|{
name|struct
name|aac_blockread
modifier|*
name|br
decl_stmt|;
name|struct
name|aac_blockwrite
modifier|*
name|bw
decl_stmt|;
name|struct
name|aac_sg_table
modifier|*
name|sg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|br
operator|=
operator|(
expr|struct
name|aac_blockread
operator|*
operator|)
name|fib
operator|->
name|data
expr_stmt|;
name|bw
operator|=
operator|(
expr|struct
name|aac_blockwrite
operator|*
operator|)
name|fib
operator|->
name|data
expr_stmt|;
name|sg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|br
operator|->
name|Command
operator|==
name|VM_CtBlockRead
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  BlockRead: container %d  0x%x/%d\n"
argument_list|,
name|br
operator|->
name|ContainerId
argument_list|,
name|br
operator|->
name|BlockNumber
argument_list|,
name|br
operator|->
name|ByteCount
argument_list|)
expr_stmt|;
name|sg
operator|=
operator|&
name|br
operator|->
name|SgMap
expr_stmt|;
block|}
if|if
condition|(
name|bw
operator|->
name|Command
operator|==
name|VM_CtBlockWrite
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  BlockWrite: container %d  0x%x/%d "
literal|"(%s)\n"
argument_list|,
name|bw
operator|->
name|ContainerId
argument_list|,
name|bw
operator|->
name|BlockNumber
argument_list|,
name|bw
operator|->
name|ByteCount
argument_list|,
name|bw
operator|->
name|Stable
operator|==
name|CSTABLE
condition|?
literal|"stable"
else|:
literal|"unstable"
argument_list|)
expr_stmt|;
name|sg
operator|=
operator|&
name|bw
operator|->
name|SgMap
expr_stmt|;
block|}
if|if
condition|(
name|sg
operator|!=
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  %d s/g entries\n"
argument_list|,
name|sg
operator|->
name|SgCount
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sg
operator|->
name|SgCount
condition|;
name|i
operator|++
control|)
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"  0x%08x/%d\n"
argument_list|,
name|sg
operator|->
name|SgEntry
index|[
name|i
index|]
operator|.
name|SgAddress
argument_list|,
name|sg
operator|->
name|SgEntry
index|[
name|i
index|]
operator|.
name|SgByteCount
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"   %16D\n"
argument_list|,
name|fib
operator|->
name|data
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"   %16D\n"
argument_list|,
name|fib
operator|->
name|data
operator|+
literal|16
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Describe an AIF we have received.  */
end_comment

begin_function
name|void
name|aacraid_print_aif
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|aac_aif_command
modifier|*
name|aif
parameter_list|)
block|{
switch|switch
condition|(
name|aif
operator|->
name|command
condition|)
block|{
case|case
name|AifCmdEventNotify
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"EventNotify(%d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|type
condition|)
block|{
case|case
name|AifEnGeneric
case|:
comment|/* Generic notification */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(Generic) %.*s\n"
argument_list|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EG
argument_list|)
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EG
operator|.
name|text
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnTaskComplete
case|:
comment|/* Task has completed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(TaskComplete)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnConfigChange
case|:
comment|/* Adapter configuration change 						 * occurred */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConfigChange)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnContainerChange
case|:
comment|/* Adapter specific container 						 * configuration change */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerChange) "
literal|"container %d,%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECC
operator|.
name|container
index|[
literal|0
index|]
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECC
operator|.
name|container
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnDeviceFailure
case|:
comment|/* SCSI device failed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(DeviceFailure) "
literal|"handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDF
operator|.
name|deviceHandle
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnMirrorFailover
case|:
comment|/* Mirror failover started */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(MirrorFailover) "
literal|"container %d failed, "
literal|"migrating from slice %d to %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EMF
operator|.
name|container
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EMF
operator|.
name|failedSlice
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EMF
operator|.
name|creatingSlice
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnContainerEvent
case|:
comment|/* Significant container 						 * event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerEvent) "
literal|"container %d event "
literal|"%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECE
operator|.
name|container
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECE
operator|.
name|eventType
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnFileSystemChange
case|:
comment|/* File system changed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FileSystemChange)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnConfigPause
case|:
comment|/* Container pause event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConfigPause)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnConfigResume
case|:
comment|/* Container resume event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ConfigResume)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnFailoverChange
case|:
comment|/* Failover space assignment 						 * changed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FailoverChange)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnRAID5RebuildDone
case|:
comment|/* RAID5 rebuild finished */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(RAID5RebuildDone)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnEnclosureManagement
case|:
comment|/* Enclosure management event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(EnclosureManagement) "
literal|"EMPID %d unit %d "
literal|"event %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EEE
operator|.
name|empID
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EEE
operator|.
name|unitID
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EEE
operator|.
name|eventType
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnBatteryEvent
case|:
comment|/* Significant NV battery 						 * event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(BatteryEvent) %d "
literal|"(state was %d, is %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EBE
operator|.
name|transition_type
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EBE
operator|.
name|current_state
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EBE
operator|.
name|prior_state
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnAddContainer
case|:
comment|/* A new container was 						 * created. */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(AddContainer)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnDeleteContainer
case|:
comment|/* A container was deleted. */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(DeleteContainer)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnBatteryNeedsRecond
case|:
comment|/* The battery needs 						 * reconditioning */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(BatteryNeedsRecond)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnClusterEvent
case|:
comment|/* Some cluster event */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ClusterEvent) event %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|ECLE
operator|.
name|eventType
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifEnDiskSetEvent
case|:
comment|/* A disk set event occurred. */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(DiskSetEvent) event %d "
literal|"diskset %jd creator %jd\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDS
operator|.
name|eventType
argument_list|,
operator|(
name|intmax_t
operator|)
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDS
operator|.
name|DsNum
argument_list|,
operator|(
name|intmax_t
operator|)
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|data
operator|.
name|EDS
operator|.
name|CreatorId
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifDenMorphComplete
case|:
comment|/* A morph operation 						 * completed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(MorphComplete)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifDenVolumeExtendComplete
case|:
comment|/* A volume expand operation 						  * completed */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(VolumeExtendComplete)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(%d)\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|EN
operator|.
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|AifCmdJobProgress
case|:
block|{
name|char
modifier|*
name|status
decl_stmt|;
switch|switch
condition|(
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|status
condition|)
block|{
case|case
name|AifJobStsSuccess
case|:
name|status
operator|=
literal|"success"
expr_stmt|;
break|break;
case|case
name|AifJobStsFinished
case|:
name|status
operator|=
literal|"finished"
expr_stmt|;
break|break;
case|case
name|AifJobStsAborted
case|:
name|status
operator|=
literal|"aborted"
expr_stmt|;
break|break;
case|case
name|AifJobStsFailed
case|:
name|status
operator|=
literal|"failed"
expr_stmt|;
break|break;
case|case
name|AifJobStsSuspended
case|:
name|status
operator|=
literal|"suspended"
expr_stmt|;
break|break;
case|case
name|AifJobStsRunning
case|:
name|status
operator|=
literal|"running"
expr_stmt|;
break|break;
default|default:
name|status
operator|=
literal|"unknown status"
expr_stmt|;
break|break;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"JobProgress (%d) - %s (%d, %d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|,
name|status
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|currentTick
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|finalTick
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|type
condition|)
block|{
case|case
name|AifJobScsiZero
case|:
comment|/* SCSI dev clear operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiZero) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobScsiVerify
case|:
comment|/* SCSI device Verify operation 						 * NO REPAIR */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiVerify) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobScsiExercise
case|:
comment|/* SCSI device Exercise 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiExercise) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobScsiVerifyRepair
case|:
comment|/* SCSI device Verify operation 						 * WITH repair */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ScsiVerifyRepair) handle %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|scsi_dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrZero
case|:
comment|/* Container clear operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerZero) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrCopy
case|:
comment|/* Container copy operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerCopy) container %d to %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|dst
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrCreateMirror
case|:
comment|/* Container Create Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerCreateMirror) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobCtrMergeMirror
case|:
comment|/* Container Merge Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerMergeMirror) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobCtrScrubMirror
case|:
comment|/* Container Scrub Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerScrubMirror) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrRebuildRaid5
case|:
comment|/* Container Rebuild Raid5 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerRebuildRaid5) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrScrubRaid5
case|:
comment|/* Container Scrub Raid5 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerScrubRaid5) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrMorph
case|:
comment|/* Container morph operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerMorph) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobCtrPartCopy
case|:
comment|/* Container Partition copy 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerPartCopy) container %d to "
literal|"%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|dst
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrRebuildMirror
case|:
comment|/* Container Rebuild Mirror 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerRebuildMirror) container "
literal|"%d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtrCrazyCache
case|:
comment|/* crazy cache */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContainerCrazyCache) container %d\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|client
operator|.
name|container
operator|.
name|src
argument_list|)
expr_stmt|;
comment|/* XXX two containers? */
break|break;
case|case
name|AifJobFsCreate
case|:
comment|/* File System Create 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FsCreate)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobFsVerify
case|:
comment|/* File System Verify 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FsVerivy)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobFsExtend
case|:
comment|/* File System Extend 						 * operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FsExtend)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiFormatNTFS
case|:
comment|/* Format a drive to NTFS */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FormatNTFS)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiFormatFAT
case|:
comment|/* Format a drive to FAT */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FormatFAT)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiUpdateSnapshot
case|:
comment|/* update the read/write half 						 * of a snapshot */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(UpdateSnapshot)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobApiFormatFAT32
case|:
comment|/* Format a drive to FAT32 */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(FormatFAT32)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifJobCtlContinuousCtrVerify
case|:
comment|/* Adapter operation */
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(ContinuousCtrVerify)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"(%d)\n"
argument_list|,
name|aif
operator|->
name|data
operator|.
name|PR
index|[
literal|0
index|]
operator|.
name|jd
operator|.
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
case|case
name|AifCmdAPIReport
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"APIReport (%d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
break|break;
case|case
name|AifCmdDriverNotify
case|:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"DriverNotify (%d)\n"
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"AIF %d (%d)\n"
argument_list|,
name|aif
operator|->
name|command
argument_list|,
name|aif
operator|->
name|seqNumber
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* AACRAID_DEBUG */
end_comment

begin_comment
comment|/*  * Debug flags to be put into the HBA flags field when initialized  */
end_comment

begin_decl_stmt
specifier|const
name|unsigned
name|long
name|aacraid_debug_flags
init|=
comment|/* Variable to setup with above flags. */
comment|/*			HBA_FLAGS_DBG_KERNEL_PRINT_B |		*/
name|HBA_FLAGS_DBG_FW_PRINT_B
operator||
comment|/*			HBA_FLAGS_DBG_FUNCTION_ENTRY_B |	*/
name|HBA_FLAGS_DBG_FUNCTION_EXIT_B
operator||
name|HBA_FLAGS_DBG_ERROR_B
operator||
name|HBA_FLAGS_DBG_INIT_B
operator||
comment|/*			HBA_FLAGS_DBG_OS_COMMANDS_B |		*/
comment|/*			HBA_FLAGS_DBG_SCAN_B |			*/
comment|/*			HBA_FLAGS_DBG_COALESCE_B |		*/
comment|/*			HBA_FLAGS_DBG_IOCTL_COMMANDS_B |	*/
comment|/*			HBA_FLAGS_DBG_SYNC_COMMANDS_B |		*/
name|HBA_FLAGS_DBG_COMM_B
operator||
comment|/*			HBA_FLAGS_DBG_AIF_B |			*/
comment|/*			HBA_FLAGS_DBG_CSMI_COMMANDS_B | 	*/
name|HBA_FLAGS_DBG_DEBUG_B
operator||
comment|/*			HBA_FLAGS_DBG_FLAGS_MASK | 		*/
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|aacraid_get_fw_debug_buffer
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|)
block|{
name|u_int32_t
name|MonDriverBufferPhysAddrLow
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|MonDriverBufferPhysAddrHigh
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|MonDriverBufferSize
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|MonDriverHeaderSize
init|=
literal|0
decl_stmt|;
comment|/* 	 * Get the firmware print buffer parameters from the firmware 	 * If the command was successful map in the address. 	 */
if|if
condition|(
operator|!
name|aacraid_sync_command
argument_list|(
name|sc
argument_list|,
name|AAC_MONKER_GETDRVPROP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|MonDriverBufferPhysAddrLow
operator|=
name|AAC_GET_MAILBOX
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MonDriverBufferPhysAddrHigh
operator|=
name|AAC_GET_MAILBOX
argument_list|(
name|sc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|MonDriverBufferSize
operator|=
name|AAC_GET_MAILBOX
argument_list|(
name|sc
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|MonDriverHeaderSize
operator|=
name|AAC_GET_MAILBOX
argument_list|(
name|sc
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|MonDriverBufferSize
condition|)
block|{
name|unsigned
name|long
name|Offset
init|=
name|MonDriverBufferPhysAddrLow
operator|-
name|rman_get_start
argument_list|(
name|sc
operator|->
name|aac_regs_res1
argument_list|)
decl_stmt|;
comment|/* 			 * See if the address is already mapped in and if so set it up 			 * from the base address 			 */
if|if
condition|(
operator|(
name|MonDriverBufferPhysAddrHigh
operator|==
literal|0
operator|)
operator|&&
operator|(
name|Offset
operator|+
name|MonDriverBufferSize
operator|<
name|rman_get_size
argument_list|(
name|sc
operator|->
name|aac_regs_res1
argument_list|)
operator|)
condition|)
block|{
name|sc
operator|->
name|DebugOffset
operator|=
name|Offset
expr_stmt|;
name|sc
operator|->
name|DebugHeaderSize
operator|=
name|MonDriverHeaderSize
expr_stmt|;
name|sc
operator|->
name|FwDebugBufferSize
operator|=
name|MonDriverBufferSize
expr_stmt|;
name|sc
operator|->
name|FwDebugFlags
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|DebugFlags
operator|=
name|aacraid_debug_flags
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
block|}
comment|/* 	 * The GET_DRIVER_BUFFER_PROPERTIES command failed 	 */
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|PRINT_TIMEOUT
value|250000
end_define

begin_comment
comment|/* 1/4 second */
end_comment

begin_function
name|void
name|aacraid_fw_printf
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|long
name|PrintFlags
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|u_int32_t
name|Count
decl_stmt|,
name|i
decl_stmt|;
name|char
name|PrintBuffer_P
index|[
name|PRINT_BUFFER_SIZE
index|]
decl_stmt|;
name|unsigned
name|long
name|PrintType
decl_stmt|;
name|PrintType
operator|=
name|PrintFlags
operator|&
operator|~
operator|(
name|HBA_FLAGS_DBG_KERNEL_PRINT_B
operator||
name|HBA_FLAGS_DBG_FW_PRINT_B
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|PrintType
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|sc
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|sc
operator|->
name|DebugFlags
operator|&
name|PrintType
operator|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|sc
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sc
operator|->
name|DebugFlags
operator|&
operator|(
name|HBA_FLAGS_DBG_KERNEL_PRINT_B
operator||
name|HBA_FLAGS_DBG_FW_PRINT_B
operator|)
operator|)
operator|==
literal|0
operator|)
condition|)
return|return;
comment|/* 	 * Set up parameters and call sprintf function to format the data 	 */
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsprintf
argument_list|(
name|PrintBuffer_P
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure the HBA structure has been passed in for this section 	 */
if|if
condition|(
operator|(
name|sc
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sc
operator|->
name|FwDebugBufferSize
operator|)
condition|)
block|{
comment|/* 		 * If we are set up for a Firmware print 		 */
if|if
condition|(
operator|(
name|sc
operator|->
name|DebugFlags
operator|&
name|HBA_FLAGS_DBG_FW_PRINT_B
operator|)
operator|&&
operator|(
operator|(
name|PrintFlags
operator|&
operator|(
name|HBA_FLAGS_DBG_KERNEL_PRINT_B
operator||
name|HBA_FLAGS_DBG_FW_PRINT_B
operator|)
operator|)
operator|!=
name|HBA_FLAGS_DBG_KERNEL_PRINT_B
operator|)
condition|)
block|{
comment|/* 			 * Make sure the string size is within boundaries 			 */
name|Count
operator|=
name|strlen
argument_list|(
name|PrintBuffer_P
argument_list|)
expr_stmt|;
if|if
condition|(
name|Count
operator|>
name|sc
operator|->
name|FwDebugBufferSize
condition|)
name|Count
operator|=
operator|(
name|u_int16_t
operator|)
name|sc
operator|->
name|FwDebugBufferSize
expr_stmt|;
comment|/* 			 * Wait for no more than PRINT_TIMEOUT for the previous 			 * message length to clear (the handshake). 			 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PRINT_TIMEOUT
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|!
name|AAC_MEM1_GETREG4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|DebugOffset
operator|+
name|FW_DEBUG_STR_LENGTH_OFFSET
argument_list|)
condition|)
block|{
break|break;
block|}
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 			 * If the Length is clear, copy over the message, the 			 * flags, and the length. Make sure the length is the 			 * last because that is the signal for the Firmware to 			 * pick it up. 			 */
if|if
condition|(
operator|!
name|AAC_MEM1_GETREG4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|DebugOffset
operator|+
name|FW_DEBUG_STR_LENGTH_OFFSET
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|Count
condition|;
operator|++
name|i
control|)
block|{
name|AAC_MEM1_SETREG1
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|DebugOffset
operator|+
name|sc
operator|->
name|DebugHeaderSize
operator|+
name|i
argument_list|,
name|PrintBuffer_P
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|AAC_MEM1_SETREG4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|DebugOffset
operator|+
name|FW_DEBUG_FLAGS_OFFSET
argument_list|,
name|sc
operator|->
name|FwDebugFlags
argument_list|)
expr_stmt|;
name|AAC_MEM1_SETREG4
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|DebugOffset
operator|+
name|FW_DEBUG_STR_LENGTH_OFFSET
argument_list|,
name|Count
argument_list|)
expr_stmt|;
block|}
else|else
name|sc
operator|->
name|DebugFlags
operator|&=
operator|~
name|HBA_FLAGS_DBG_FW_PRINT_B
expr_stmt|;
block|}
comment|/* 		 * If the Kernel Debug Print flag is set, send it off to the 		 * Kernel debugger 		 */
if|if
condition|(
operator|(
name|sc
operator|->
name|DebugFlags
operator|&
name|HBA_FLAGS_DBG_KERNEL_PRINT_B
operator|)
operator|&&
operator|(
operator|(
name|PrintFlags
operator|&
operator|(
name|HBA_FLAGS_DBG_KERNEL_PRINT_B
operator||
name|HBA_FLAGS_DBG_FW_PRINT_B
operator|)
operator|)
operator|!=
name|HBA_FLAGS_DBG_FW_PRINT_B
operator|)
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|FwDebugFlags
operator|&
name|FW_DEBUG_FLAGS_NO_HEADERS_B
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|PrintBuffer_P
argument_list|)
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"%s\n"
argument_list|,
name|PrintBuffer_P
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * No HBA structure passed in so it has to be for the Kernel Debugger 		 */
if|if
condition|(
operator|(
name|sc
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sc
operator|->
name|FwDebugFlags
operator|&
name|FW_DEBUG_FLAGS_NO_HEADERS_B
operator|)
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|PrintBuffer_P
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sc
operator|!=
name|NULL
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|aac_dev
argument_list|,
literal|"%s\n"
argument_list|,
name|PrintBuffer_P
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|PrintBuffer_P
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|aacraid_fw_print_mem
parameter_list|(
name|struct
name|aac_softc
modifier|*
name|sc
parameter_list|,
name|unsigned
name|long
name|PrintFlags
parameter_list|,
name|u_int8_t
modifier|*
name|Addr
parameter_list|,
name|int
name|Count
parameter_list|)
block|{
name|int
name|Offset
decl_stmt|,
name|i
decl_stmt|;
name|u_int32_t
name|DebugFlags
init|=
literal|0
decl_stmt|;
name|char
name|Buffer
index|[
literal|100
index|]
decl_stmt|;
name|char
modifier|*
name|LineBuffer_P
decl_stmt|;
comment|/* 	 * If we have an HBA structure, save off the flags and set the no 	 * headers flag so we don't have garbage between our lines of data 	 */
if|if
condition|(
name|sc
operator|!=
name|NULL
condition|)
block|{
name|DebugFlags
operator|=
name|sc
operator|->
name|FwDebugFlags
expr_stmt|;
name|sc
operator|->
name|FwDebugFlags
operator||=
name|FW_DEBUG_FLAGS_NO_HEADERS_B
expr_stmt|;
block|}
name|Offset
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Loop through all the data 	 */
while|while
condition|(
name|Offset
operator|<
name|Count
condition|)
block|{
comment|/* 		 * We will format each line into a buffer and then print out 		 * the entire line so set the pointer to the beginning of the 		 * buffer 		 */
name|LineBuffer_P
operator|=
name|Buffer
expr_stmt|;
comment|/* 		 * Set up the address in HEX 		 */
name|sprintf
argument_list|(
name|LineBuffer_P
argument_list|,
literal|"\n%04x  "
argument_list|,
name|Offset
argument_list|)
expr_stmt|;
name|LineBuffer_P
operator|+=
literal|6
expr_stmt|;
comment|/* 		 * Set up 16 bytes in HEX format 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
comment|/* 			 * If we are past the count of data bytes to output, 			 * pad with blanks 			 */
if|if
condition|(
operator|(
name|Offset
operator|+
name|i
operator|)
operator|>=
name|Count
condition|)
name|sprintf
argument_list|(
name|LineBuffer_P
argument_list|,
literal|"   "
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|LineBuffer_P
argument_list|,
literal|"%02x "
argument_list|,
name|Addr
index|[
name|Offset
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
name|LineBuffer_P
operator|+=
literal|3
expr_stmt|;
comment|/* 			 * At the mid point we will put in a divider 			 */
if|if
condition|(
name|i
operator|==
literal|7
condition|)
block|{
name|sprintf
argument_list|(
name|LineBuffer_P
argument_list|,
literal|"- "
argument_list|)
expr_stmt|;
name|LineBuffer_P
operator|+=
literal|2
expr_stmt|;
block|}
block|}
comment|/* 		 * Now do the same 16 bytes at the end of the line in ASCII 		 * format 		 */
name|sprintf
argument_list|(
name|LineBuffer_P
argument_list|,
literal|"  "
argument_list|)
expr_stmt|;
name|LineBuffer_P
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
operator|++
name|i
control|)
block|{
comment|/* 			 * If all data processed, OUT-O-HERE 			 */
if|if
condition|(
operator|(
name|Offset
operator|+
name|i
operator|)
operator|>=
name|Count
condition|)
break|break;
comment|/* 			 * If this is a printable ASCII character, convert it 			 */
if|if
condition|(
operator|(
name|Addr
index|[
name|Offset
operator|+
name|i
index|]
operator|>
literal|0x1F
operator|)
operator|&&
operator|(
name|Addr
index|[
name|Offset
operator|+
name|i
index|]
operator|<
literal|0x7F
operator|)
condition|)
name|sprintf
argument_list|(
name|LineBuffer_P
argument_list|,
literal|"%c"
argument_list|,
name|Addr
index|[
name|Offset
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|LineBuffer_P
argument_list|,
literal|"."
argument_list|)
expr_stmt|;
operator|++
name|LineBuffer_P
expr_stmt|;
block|}
comment|/* 		 * The line is now formatted, so print it out 		 */
name|aacraid_fw_printf
argument_list|(
name|sc
argument_list|,
name|PrintFlags
argument_list|,
literal|"%s"
argument_list|,
name|Buffer
argument_list|)
expr_stmt|;
comment|/* 		 * Bump the offset by 16 for the next line 		 */
name|Offset
operator|+=
literal|16
expr_stmt|;
block|}
comment|/* 	 * Restore the saved off flags 	 */
if|if
condition|(
name|sc
operator|!=
name|NULL
condition|)
name|sc
operator|->
name|FwDebugFlags
operator|=
name|DebugFlags
expr_stmt|;
block|}
end_function

end_unit


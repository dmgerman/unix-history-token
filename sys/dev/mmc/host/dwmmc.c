begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014 Ruslan Bukin<br@bsdpad.com>  * All rights reserved.  *  * This software was developed by SRI International and the University of  * Cambridge Computer Laboratory under DARPA/AFRL contract (FA8750-10-C-0237)  * ("CTSRD"), as part of the DARPA CRASH research programme.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Synopsys DesignWare Mobile Storage Host Controller  * Chapter 14, Altera Cyclone V Device Handbook (CV-5V2 2014.07.22)  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<dev/mmc/bridge.h>
end_include

begin_include
include|#
directive|include
file|<dev/mmc/mmcbrvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<dev/mmc/host/dwmmc_reg.h>
end_include

begin_include
include|#
directive|include
file|<dev/mmc/host/dwmmc_var.h>
end_include

begin_include
include|#
directive|include
file|"mmcbr_if.h"
end_include

begin_define
define|#
directive|define
name|dprintf
parameter_list|(
name|x
parameter_list|,
name|arg
modifier|...
parameter_list|)
end_define

begin_define
define|#
directive|define
name|READ4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|)
define|\
value|bus_read_4((_sc)->res[0], _reg)
end_define

begin_define
define|#
directive|define
name|WRITE4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|,
name|_val
parameter_list|)
define|\
value|bus_write_4((_sc)->res[0], _reg, _val)
end_define

begin_define
define|#
directive|define
name|DIV_ROUND_UP
parameter_list|(
name|n
parameter_list|,
name|d
parameter_list|)
value|howmany(n, d)
end_define

begin_define
define|#
directive|define
name|DWMMC_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_lock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|DWMMC_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_unlock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|DWMMC_LOCK_INIT
parameter_list|(
name|_sc
parameter_list|)
define|\
value|mtx_init(&_sc->sc_mtx, device_get_nameunit(_sc->dev), \ 	    "dwmmc", MTX_DEF)
end_define

begin_define
define|#
directive|define
name|DWMMC_LOCK_DESTROY
parameter_list|(
name|_sc
parameter_list|)
value|mtx_destroy(&_sc->sc_mtx);
end_define

begin_define
define|#
directive|define
name|DWMMC_ASSERT_LOCKED
parameter_list|(
name|_sc
parameter_list|)
value|mtx_assert(&_sc->sc_mtx, MA_OWNED);
end_define

begin_define
define|#
directive|define
name|DWMMC_ASSERT_UNLOCKED
parameter_list|(
name|_sc
parameter_list|)
value|mtx_assert(&_sc->sc_mtx, MA_NOTOWNED);
end_define

begin_define
define|#
directive|define
name|PENDING_CMD
value|0x01
end_define

begin_define
define|#
directive|define
name|PENDING_STOP
value|0x02
end_define

begin_define
define|#
directive|define
name|CARD_INIT_DONE
value|0x04
end_define

begin_define
define|#
directive|define
name|DWMMC_DATA_ERR_FLAGS
value|(SDMMC_INTMASK_DRT | SDMMC_INTMASK_DCRC \ 				|SDMMC_INTMASK_HTO | SDMMC_INTMASK_SBE \ 				|SDMMC_INTMASK_EBE)
end_define

begin_define
define|#
directive|define
name|DWMMC_CMD_ERR_FLAGS
value|(SDMMC_INTMASK_RTO | SDMMC_INTMASK_RCRC \ 				|SDMMC_INTMASK_RE)
end_define

begin_define
define|#
directive|define
name|DWMMC_ERR_FLAGS
value|(DWMMC_DATA_ERR_FLAGS | DWMMC_CMD_ERR_FLAGS \ 				|SDMMC_INTMASK_HLE)
end_define

begin_define
define|#
directive|define
name|DES0_DIC
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|DES0_LD
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|DES0_FS
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|DES0_CH
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|DES0_ER
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|DES0_CES
value|(1<< 30)
end_define

begin_define
define|#
directive|define
name|DES0_OWN
value|(1<< 31)
end_define

begin_define
define|#
directive|define
name|DES1_BS1_MASK
value|0xfff
end_define

begin_define
define|#
directive|define
name|DES1_BS1_SHIFT
value|0
end_define

begin_struct
struct|struct
name|idmac_desc
block|{
name|uint32_t
name|des0
decl_stmt|;
comment|/* control */
name|uint32_t
name|des1
decl_stmt|;
comment|/* bufsize */
name|uint32_t
name|des2
decl_stmt|;
comment|/* buf1 phys addr */
name|uint32_t
name|des3
decl_stmt|;
comment|/* buf2 phys addr or next descr */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|DESC_MAX
value|256
end_define

begin_define
define|#
directive|define
name|DESC_SIZE
value|(sizeof(struct idmac_desc) * DESC_MAX)
end_define

begin_define
define|#
directive|define
name|DEF_MSIZE
value|0x2
end_define

begin_comment
comment|/* Burst size of multiple transaction */
end_comment

begin_function_decl
specifier|static
name|void
name|dwmmc_next_operation
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|dwmmc_setup_bus
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|dma_done
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
parameter_list|,
name|struct
name|mmc_command
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|dma_stop
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pio_read
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
parameter_list|,
name|struct
name|mmc_command
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pio_write
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
parameter_list|,
name|struct
name|mmc_command
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|dwmmc_spec
index|[]
init|=
block|{
block|{
name|SYS_RES_MEMORY
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|HWTYPE_MASK
value|(0x0000ffff)
end_define

begin_define
define|#
directive|define
name|HWFLAG_MASK
value|(0xffff<< 16)
end_define

begin_decl_stmt
specifier|static
name|struct
name|ofw_compat_data
name|compat_data
index|[]
init|=
block|{
block|{
literal|"altr,socfpga-dw-mshc"
block|,
name|HWTYPE_ALTERA
block|}
block|,
block|{
literal|"samsung,exynos5420-dw-mshc"
block|,
name|HWTYPE_EXYNOS
block|}
block|,
block|{
literal|"rockchip,rk2928-dw-mshc"
block|,
name|HWTYPE_ROCKCHIP
block|}
block|,
block|{
name|NULL
block|,
name|HWTYPE_NONE
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dwmmc_get1paddr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return;
operator|*
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dwmmc_ring_setup
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|idx
decl_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return;
name|sc
operator|=
name|arg
expr_stmt|;
name|dprintf
argument_list|(
literal|"nsegs %d seg0len %lu\n"
argument_list|,
name|nsegs
argument_list|,
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|nsegs
condition|;
name|idx
operator|++
control|)
block|{
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des0
operator|=
operator|(
name|DES0_OWN
operator||
name|DES0_DIC
operator||
name|DES0_CH
operator|)
expr_stmt|;
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des1
operator|=
name|segs
index|[
name|idx
index|]
operator|.
name|ds_len
expr_stmt|;
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des2
operator|=
name|segs
index|[
name|idx
index|]
operator|.
name|ds_addr
expr_stmt|;
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des0
operator||=
name|DES0_FS
expr_stmt|;
if|if
condition|(
name|idx
operator|==
operator|(
name|nsegs
operator|-
literal|1
operator|)
condition|)
block|{
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des0
operator|&=
operator|~
operator|(
name|DES0_DIC
operator||
name|DES0_CH
operator|)
expr_stmt|;
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des0
operator||=
name|DES0_LD
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_ctrl_reset
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|int
name|reset_bits
parameter_list|)
block|{
name|int
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
name|reset_bits
operator|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Wait reset done */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|)
operator|&
name|reset_bits
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Reset failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dma_setup
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|int
name|nidx
decl_stmt|;
name|int
name|idx
decl_stmt|;
comment|/* 	 * Set up TX descriptor ring, descriptors, and dma maps. 	 */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
comment|/* Parent tag. */
literal|4096
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|DESC_SIZE
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|DESC_SIZE
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|desc_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create ring DMA tag.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|desc_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|desc_ring
argument_list|,
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|desc_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not allocate descriptor ring.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|desc_tag
argument_list|,
name|sc
operator|->
name|desc_map
argument_list|,
name|sc
operator|->
name|desc_ring
argument_list|,
name|DESC_SIZE
argument_list|,
name|dwmmc_get1paddr
argument_list|,
operator|&
name|sc
operator|->
name|desc_ring_paddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not load descriptor ring map.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|sc
operator|->
name|desc_count
condition|;
name|idx
operator|++
control|)
block|{
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des0
operator|=
name|DES0_CH
expr_stmt|;
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des1
operator|=
literal|0
expr_stmt|;
name|nidx
operator|=
operator|(
name|idx
operator|+
literal|1
operator|)
operator|%
name|sc
operator|->
name|desc_count
expr_stmt|;
name|sc
operator|->
name|desc_ring
index|[
name|idx
index|]
operator|.
name|des3
operator|=
name|sc
operator|->
name|desc_ring_paddr
operator|+
expr|\
operator|(
name|nidx
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|idmac_desc
argument_list|)
operator|)
expr_stmt|;
block|}
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
comment|/* Parent tag. */
literal|4096
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|sc
operator|->
name|desc_count
operator|*
name|MMC_SECTOR_SIZE
argument_list|,
comment|/* maxsize */
name|sc
operator|->
name|desc_count
argument_list|,
comment|/* nsegments */
name|MMC_SECTOR_SIZE
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|buf_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create ring DMA tag.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|buf_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|buf_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create TX buffer DMA map.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dwmmc_cmd_done
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mmc_command
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|sc
operator|->
name|curcmd
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|cmd
operator|->
name|flags
operator|&
name|MMC_RSP_PRESENT
condition|)
block|{
if|if
condition|(
name|cmd
operator|->
name|flags
operator|&
name|MMC_RSP_136
condition|)
block|{
name|cmd
operator|->
name|resp
index|[
literal|3
index|]
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RESP0
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|resp
index|[
literal|2
index|]
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RESP1
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|resp
index|[
literal|1
index|]
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RESP2
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|resp
index|[
literal|0
index|]
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RESP3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cmd
operator|->
name|resp
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|cmd
operator|->
name|resp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|cmd
operator|->
name|resp
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|cmd
operator|->
name|resp
index|[
literal|0
index|]
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RESP0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dwmmc_tasklet
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mmc_command
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|sc
operator|->
name|curcmd
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|!
name|sc
operator|->
name|cmd_done
condition|)
return|return;
if|if
condition|(
name|cmd
operator|->
name|error
operator|!=
name|MMC_ERR_NONE
operator|||
operator|!
name|cmd
operator|->
name|data
condition|)
block|{
name|dwmmc_next_operation
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cmd
operator|->
name|data
operator|&&
name|sc
operator|->
name|dto_rcvd
condition|)
block|{
if|if
condition|(
operator|(
name|cmd
operator|->
name|opcode
operator|==
name|MMC_WRITE_MULTIPLE_BLOCK
operator|||
name|cmd
operator|->
name|opcode
operator|==
name|MMC_READ_MULTIPLE_BLOCK
operator|)
operator|&&
name|sc
operator|->
name|use_auto_stop
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|acd_rcvd
condition|)
name|dwmmc_next_operation
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dwmmc_next_operation
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dwmmc_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mmc_command
modifier|*
name|cmd
decl_stmt|;
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|DWMMC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|sc
operator|->
name|curcmd
expr_stmt|;
comment|/* First handle SDMMC controller interrupts */
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_MINTSTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|DWMMC_CMD_ERR_FLAGS
condition|)
block|{
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|DWMMC_CMD_ERR_FLAGS
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"cmd err 0x%08x cmd 0x%08x\n"
argument_list|,
name|reg
argument_list|,
name|cmd
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|error
operator|=
name|MMC_ERR_TIMEOUT
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|DWMMC_DATA_ERR_FLAGS
condition|)
block|{
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|DWMMC_DATA_ERR_FLAGS
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"data err 0x%08x cmd 0x%08x\n"
argument_list|,
name|reg
argument_list|,
name|cmd
operator|->
name|opcode
argument_list|)
expr_stmt|;
name|cmd
operator|->
name|error
operator|=
name|MMC_ERR_FAILED
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|use_pio
condition|)
block|{
name|dma_done
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|dma_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|reg
operator|&
name|SDMMC_INTMASK_CMD_DONE
condition|)
block|{
name|dwmmc_cmd_done
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|cmd_done
operator|=
literal|1
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|SDMMC_INTMASK_CMD_DONE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|SDMMC_INTMASK_ACD
condition|)
block|{
name|sc
operator|->
name|acd_rcvd
operator|=
literal|1
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|SDMMC_INTMASK_ACD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|SDMMC_INTMASK_DTO
condition|)
block|{
name|sc
operator|->
name|dto_rcvd
operator|=
literal|1
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|SDMMC_INTMASK_DTO
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|SDMMC_INTMASK_CD
condition|)
block|{
comment|/* XXX: Handle card detect */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|SDMMC_INTMASK_CD
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|use_pio
condition|)
block|{
if|if
condition|(
name|reg
operator|&
operator|(
name|SDMMC_INTMASK_RXDR
operator||
name|SDMMC_INTMASK_DTO
operator|)
condition|)
block|{
name|pio_read
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
operator|(
name|SDMMC_INTMASK_TXDR
operator||
name|SDMMC_INTMASK_DTO
operator|)
condition|)
block|{
name|pio_write
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Now handle DMA interrupts */
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_IDSTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
condition|)
block|{
name|dprintf
argument_list|(
literal|"dma intr 0x%08x\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
operator|(
name|SDMMC_IDINTEN_TI
operator||
name|SDMMC_IDINTEN_RI
operator|)
condition|)
block|{
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_IDSTS
argument_list|,
operator|(
name|SDMMC_IDINTEN_TI
operator||
name|SDMMC_IDINTEN_RI
operator|)
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_IDSTS
argument_list|,
name|SDMMC_IDINTEN_NI
argument_list|)
expr_stmt|;
name|dma_done
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|dwmmc_tasklet
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DWMMC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_fdt
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|pcell_t
name|dts_value
index|[
literal|3
index|]
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|(
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* fifo-depth */
if|if
condition|(
operator|(
name|len
operator|=
name|OF_getproplen
argument_list|(
name|node
argument_list|,
literal|"fifo-depth"
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"fifo-depth"
argument_list|,
name|dts_value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fifo_depth
operator|=
name|dts_value
index|[
literal|0
index|]
expr_stmt|;
block|}
comment|/* num-slots */
name|sc
operator|->
name|num_slots
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|OF_getproplen
argument_list|(
name|node
argument_list|,
literal|"num-slots"
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"num-slots"
argument_list|,
name|dts_value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|num_slots
operator|=
name|dts_value
index|[
literal|0
index|]
expr_stmt|;
block|}
comment|/* 	 * We need some platform-specific code to know 	 * what the clock is supplied for our device. 	 * For now rely on the value specified in FDT. 	 */
if|if
condition|(
name|sc
operator|->
name|bus_hz
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|len
operator|=
name|OF_getproplen
argument_list|(
name|node
argument_list|,
literal|"bus-frequency"
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"bus-frequency"
argument_list|,
name|dts_value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bus_hz
operator|=
name|dts_value
index|[
literal|0
index|]
expr_stmt|;
block|}
comment|/* 	 * Platform-specific stuff 	 * XXX: Move to separate file 	 */
if|if
condition|(
operator|(
name|sc
operator|->
name|hwtype
operator|&
name|HWTYPE_MASK
operator|)
operator|!=
name|HWTYPE_EXYNOS
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|len
operator|=
name|OF_getproplen
argument_list|(
name|node
argument_list|,
literal|"samsung,dw-mshc-ciu-div"
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"samsung,dw-mshc-ciu-div"
argument_list|,
name|dts_value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sdr_timing
operator|=
operator|(
name|dts_value
index|[
literal|0
index|]
operator|<<
name|SDMMC_CLKSEL_DIVIDER_SHIFT
operator|)
expr_stmt|;
name|sc
operator|->
name|ddr_timing
operator|=
operator|(
name|dts_value
index|[
literal|0
index|]
operator|<<
name|SDMMC_CLKSEL_DIVIDER_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|OF_getproplen
argument_list|(
name|node
argument_list|,
literal|"samsung,dw-mshc-sdr-timing"
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"samsung,dw-mshc-sdr-timing"
argument_list|,
name|dts_value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sdr_timing
operator||=
operator|(
operator|(
name|dts_value
index|[
literal|0
index|]
operator|<<
name|SDMMC_CLKSEL_SAMPLE_SHIFT
operator|)
operator||
operator|(
name|dts_value
index|[
literal|1
index|]
operator|<<
name|SDMMC_CLKSEL_DRIVE_SHIFT
operator|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|OF_getproplen
argument_list|(
name|node
argument_list|,
literal|"samsung,dw-mshc-ddr-timing"
argument_list|)
operator|)
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"samsung,dw-mshc-ddr-timing"
argument_list|,
name|dts_value
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ddr_timing
operator||=
operator|(
operator|(
name|dts_value
index|[
literal|0
index|]
operator|<<
name|SDMMC_CLKSEL_SAMPLE_SHIFT
operator|)
operator||
operator|(
name|dts_value
index|[
literal|1
index|]
operator|<<
name|SDMMC_CLKSEL_DRIVE_SHIFT
operator|)
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|uintptr_t
name|hwtype
decl_stmt|;
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|hwtype
operator|=
name|ofw_bus_search_compatible
argument_list|(
name|dev
argument_list|,
name|compat_data
argument_list|)
operator|->
name|ocd_data
expr_stmt|;
if|if
condition|(
name|hwtype
operator|==
name|HWTYPE_NONE
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Synopsys DesignWare Mobile "
literal|"Storage Host Controller"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dwmmc_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hwtype
operator|==
name|HWTYPE_NONE
condition|)
block|{
name|sc
operator|->
name|hwtype
operator|=
name|ofw_bus_search_compatible
argument_list|(
name|dev
argument_list|,
name|compat_data
argument_list|)
operator|->
name|ocd_data
expr_stmt|;
block|}
comment|/* Why not to use Auto Stop? It save a hundred of irq per second */
name|sc
operator|->
name|use_auto_stop
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|parse_fdt
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Can't get FDT property.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|DWMMC_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_alloc_resources
argument_list|(
name|dev
argument_list|,
name|dwmmc_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate resources\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Setup interrupt handler. */
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|res
index|[
literal|1
index|]
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|dwmmc_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|intr_cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not setup interrupt handler.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Hardware version ID is %04x\n"
argument_list|,
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_VERID
argument_list|)
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|desc_count
operator|==
literal|0
condition|)
name|sc
operator|->
name|desc_count
operator|=
name|DESC_MAX
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|hwtype
operator|&
name|HWTYPE_MASK
operator|)
operator|==
name|HWTYPE_ROCKCHIP
condition|)
block|{
name|sc
operator|->
name|use_pio
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|pwren_inverted
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sc
operator|->
name|hwtype
operator|&
name|HWTYPE_MASK
operator|)
operator|==
name|HWTYPE_EXYNOS
condition|)
block|{
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|EMMCP_MPSBEGIN0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|EMMCP_SEND0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|EMMCP_CTRL0
argument_list|,
operator|(
name|MPSCTRL_SECURE_READ_BIT
operator||
name|MPSCTRL_SECURE_WRITE_BIT
operator||
name|MPSCTRL_NON_SECURE_READ_BIT
operator||
name|MPSCTRL_NON_SECURE_WRITE_BIT
operator||
name|MPSCTRL_VALID
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* XXX: we support operation for slot index 0 only */
name|slot
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pwren_inverted
condition|)
block|{
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_PWREN
argument_list|,
operator|(
literal|0
operator|<<
name|slot
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_PWREN
argument_list|,
operator|(
literal|1
operator|<<
name|slot
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Reset all */
if|if
condition|(
name|dwmmc_ctrl_reset
argument_list|(
name|sc
argument_list|,
operator|(
name|SDMMC_CTRL_RESET
operator||
name|SDMMC_CTRL_FIFO_RESET
operator||
name|SDMMC_CTRL_DMA_RESET
operator|)
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|dwmmc_setup_bus
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|host
operator|.
name|f_min
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|fifo_depth
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|fifo_depth
operator|=
literal|1
operator|+
operator|(
operator|(
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_FIFOTH
argument_list|)
operator|>>
name|SDMMC_FIFOTH_RXWMARK_S
operator|)
operator|&
literal|0xfff
operator|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"No fifo-depth, using FIFOTH %x\n"
argument_list|,
name|sc
operator|->
name|fifo_depth
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sc
operator|->
name|use_pio
condition|)
block|{
if|if
condition|(
name|dma_setup
argument_list|(
name|sc
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* Install desc base */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_DBADDR
argument_list|,
name|sc
operator|->
name|desc_ring_paddr
argument_list|)
expr_stmt|;
comment|/* Enable DMA interrupts */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_IDSTS
argument_list|,
name|SDMMC_IDINTEN_MASK
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_IDINTEN
argument_list|,
operator|(
name|SDMMC_IDINTEN_NI
operator||
name|SDMMC_IDINTEN_RI
operator||
name|SDMMC_IDINTEN_TI
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Clear and disable interrups for a while */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_INTMASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Maximum timeout */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_TMOUT
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* Enable interrupts */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_INTMASK
argument_list|,
operator|(
name|SDMMC_INTMASK_CMD_DONE
operator||
name|SDMMC_INTMASK_DTO
operator||
name|SDMMC_INTMASK_ACD
operator||
name|SDMMC_INTMASK_TXDR
operator||
name|SDMMC_INTMASK_RXDR
operator||
name|DWMMC_ERR_FLAGS
operator||
name|SDMMC_INTMASK_CD
operator|)
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|,
name|SDMMC_CTRL_INT_ENABLE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|host
operator|.
name|f_min
operator|=
literal|400000
expr_stmt|;
name|sc
operator|->
name|host
operator|.
name|f_max
operator|=
name|min
argument_list|(
literal|200000000
argument_list|,
name|sc
operator|->
name|bus_hz
argument_list|)
expr_stmt|;
name|sc
operator|->
name|host
operator|.
name|host_ocr
operator|=
name|MMC_OCR_320_330
operator||
name|MMC_OCR_330_340
expr_stmt|;
name|sc
operator|->
name|host
operator|.
name|caps
operator|=
name|MMC_CAP_4_BIT_DATA
expr_stmt|;
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"mmc"
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_setup_bus
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|int
name|tout
decl_stmt|;
name|int
name|div
decl_stmt|;
if|if
condition|(
name|freq
operator|==
literal|0
condition|)
block|{
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CLKENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMD
argument_list|,
operator|(
name|SDMMC_CMD_WAIT_PRVDATA
operator||
name|SDMMC_CMD_UPD_CLK_ONLY
operator||
name|SDMMC_CMD_START
operator|)
argument_list|)
expr_stmt|;
name|tout
operator|=
literal|1000
expr_stmt|;
do|do
block|{
if|if
condition|(
name|tout
operator|--
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Failed update clk\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMD
argument_list|)
operator|&
name|SDMMC_CMD_START
condition|)
do|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CLKENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CLKSRC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|div
operator|=
operator|(
name|sc
operator|->
name|bus_hz
operator|!=
name|freq
operator|)
condition|?
name|DIV_ROUND_UP
argument_list|(
name|sc
operator|->
name|bus_hz
argument_list|,
literal|2
operator|*
name|freq
argument_list|)
else|:
literal|0
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CLKDIV
argument_list|,
name|div
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMD
argument_list|,
operator|(
name|SDMMC_CMD_WAIT_PRVDATA
operator||
name|SDMMC_CMD_UPD_CLK_ONLY
operator||
name|SDMMC_CMD_START
operator|)
argument_list|)
expr_stmt|;
name|tout
operator|=
literal|1000
expr_stmt|;
do|do
block|{
if|if
condition|(
name|tout
operator|--
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Failed to update clk"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMD
argument_list|)
operator|&
name|SDMMC_CMD_START
condition|)
do|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CLKENA
argument_list|,
operator|(
name|SDMMC_CLKENA_CCLK_EN
operator||
name|SDMMC_CLKENA_LP
operator|)
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMD
argument_list|,
name|SDMMC_CMD_WAIT_PRVDATA
operator||
name|SDMMC_CMD_UPD_CLK_ONLY
operator||
name|SDMMC_CMD_START
argument_list|)
expr_stmt|;
name|tout
operator|=
literal|1000
expr_stmt|;
do|do
block|{
if|if
condition|(
name|tout
operator|--
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Failed to enable clk\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMD
argument_list|)
operator|&
name|SDMMC_CMD_START
condition|)
do|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_update_ios
parameter_list|(
name|device_t
name|brdev
parameter_list|,
name|device_t
name|reqdev
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mmc_ios
modifier|*
name|ios
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|brdev
argument_list|)
expr_stmt|;
name|ios
operator|=
operator|&
name|sc
operator|->
name|host
operator|.
name|ios
expr_stmt|;
name|dprintf
argument_list|(
literal|"Setting up clk %u bus_width %d\n"
argument_list|,
name|ios
operator|->
name|clock
argument_list|,
name|ios
operator|->
name|bus_width
argument_list|)
expr_stmt|;
name|dwmmc_setup_bus
argument_list|(
name|sc
argument_list|,
name|ios
operator|->
name|clock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ios
operator|->
name|bus_width
operator|==
name|bus_width_8
condition|)
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTYPE
argument_list|,
name|SDMMC_CTYPE_8BIT
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ios
operator|->
name|bus_width
operator|==
name|bus_width_4
condition|)
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTYPE
argument_list|,
name|SDMMC_CTYPE_4BIT
argument_list|)
expr_stmt|;
else|else
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTYPE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|hwtype
operator|&
name|HWTYPE_MASK
operator|)
operator|==
name|HWTYPE_EXYNOS
condition|)
block|{
comment|/* XXX: take care about DDR or SDR use here */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CLKSEL
argument_list|,
name|sc
operator|->
name|sdr_timing
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * XXX: take care about DDR bit 	 * 	 * reg = READ4(sc, SDMMC_UHS_REG); 	 * reg |= (SDMMC_UHS_REG_DDR); 	 * WRITE4(sc, SDMMC_UHS_REG, reg); 	 */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dma_done
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mmc_command
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mmc_data
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|cmd
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|flags
operator|&
name|MMC_DATA_WRITE
condition|)
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|buf_tag
argument_list|,
name|sc
operator|->
name|buf_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
else|else
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|buf_tag
argument_list|,
name|sc
operator|->
name|buf_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|desc_tag
argument_list|,
name|sc
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|buf_tag
argument_list|,
name|sc
operator|->
name|buf_map
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dma_stop
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|reg
decl_stmt|;
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|SDMMC_CTRL_USE_IDMAC
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
name|SDMMC_CTRL_DMA_RESET
operator|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_BMOD
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|SDMMC_BMOD_DE
operator||
name|SDMMC_BMOD_FB
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
name|SDMMC_BMOD_SWR
operator|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_BMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dma_prepare
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mmc_command
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mmc_data
modifier|*
name|data
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|reg
decl_stmt|;
name|data
operator|=
name|cmd
operator|->
name|data
expr_stmt|;
name|len
operator|=
name|data
operator|->
name|len
expr_stmt|;
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_INTMASK
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|SDMMC_INTMASK_TXDR
operator||
name|SDMMC_INTMASK_RXDR
operator|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_INTMASK
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|buf_tag
argument_list|,
name|sc
operator|->
name|buf_map
argument_list|,
name|data
operator|->
name|data
argument_list|,
name|data
operator|->
name|len
argument_list|,
name|dwmmc_ring_setup
argument_list|,
name|sc
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"dmamap_load failed\n"
argument_list|)
expr_stmt|;
comment|/* Ensure the device can see the desc */
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|desc_tag
argument_list|,
name|sc
operator|->
name|desc_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|flags
operator|&
name|MMC_DATA_WRITE
condition|)
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|buf_tag
argument_list|,
name|sc
operator|->
name|buf_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
else|else
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|buf_tag
argument_list|,
name|sc
operator|->
name|buf_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
name|DEF_MSIZE
operator|<<
name|SDMMC_FIFOTH_MSIZE_S
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
name|sc
operator|->
name|fifo_depth
operator|/
literal|2
operator|)
operator|-
literal|1
operator|)
operator|<<
name|SDMMC_FIFOTH_RXWMARK_S
expr_stmt|;
name|reg
operator||=
operator|(
name|sc
operator|->
name|fifo_depth
operator|/
literal|2
operator|)
operator|<<
name|SDMMC_FIFOTH_TXWMARK_S
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_FIFOTH
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
name|SDMMC_CTRL_USE_IDMAC
operator||
name|SDMMC_CTRL_DMA_ENABLE
operator|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CTRL
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|reg
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_BMOD
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
name|SDMMC_BMOD_DE
operator||
name|SDMMC_BMOD_FB
operator|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_BMOD
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Start */
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_PLDMND
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pio_prepare
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mmc_command
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mmc_data
modifier|*
name|data
decl_stmt|;
name|int
name|reg
decl_stmt|;
name|data
operator|=
name|cmd
operator|->
name|data
expr_stmt|;
name|data
operator|->
name|xfer_len
operator|=
literal|0
expr_stmt|;
name|reg
operator|=
operator|(
name|DEF_MSIZE
operator|<<
name|SDMMC_FIFOTH_MSIZE_S
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
name|sc
operator|->
name|fifo_depth
operator|/
literal|2
operator|)
operator|-
literal|1
operator|)
operator|<<
name|SDMMC_FIFOTH_RXWMARK_S
expr_stmt|;
name|reg
operator||=
operator|(
name|sc
operator|->
name|fifo_depth
operator|/
literal|2
operator|)
operator|<<
name|SDMMC_FIFOTH_TXWMARK_S
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_FIFOTH
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pio_read
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mmc_command
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mmc_data
modifier|*
name|data
decl_stmt|;
name|uint32_t
modifier|*
name|p
decl_stmt|,
name|status
decl_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
operator|||
name|cmd
operator|->
name|data
operator|==
name|NULL
condition|)
return|return;
name|data
operator|=
name|cmd
operator|->
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|->
name|flags
operator|&
name|MMC_DATA_READ
operator|)
operator|==
literal|0
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|data
operator|->
name|xfer_len
operator|&
literal|3
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"xfer_len not aligned"
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|->
name|data
operator|+
operator|(
name|data
operator|->
name|xfer_len
operator|>>
literal|2
operator|)
expr_stmt|;
while|while
condition|(
name|data
operator|->
name|xfer_len
operator|<
name|data
operator|->
name|len
condition|)
block|{
name|status
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|SDMMC_STATUS_FIFO_EMPTY
condition|)
break|break;
operator|*
name|p
operator|++
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_DATA
argument_list|)
expr_stmt|;
name|data
operator|->
name|xfer_len
operator|+=
literal|4
expr_stmt|;
block|}
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|SDMMC_INTMASK_RXDR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pio_write
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mmc_command
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mmc_data
modifier|*
name|data
decl_stmt|;
name|uint32_t
modifier|*
name|p
decl_stmt|,
name|status
decl_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
operator|||
name|cmd
operator|->
name|data
operator|==
name|NULL
condition|)
return|return;
name|data
operator|=
name|cmd
operator|->
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|->
name|flags
operator|&
name|MMC_DATA_WRITE
operator|)
operator|==
literal|0
condition|)
return|return;
name|KASSERT
argument_list|(
operator|(
name|data
operator|->
name|xfer_len
operator|&
literal|3
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"xfer_len not aligned"
operator|)
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|->
name|data
operator|+
operator|(
name|data
operator|->
name|xfer_len
operator|>>
literal|2
operator|)
expr_stmt|;
while|while
condition|(
name|data
operator|->
name|xfer_len
operator|<
name|data
operator|->
name|len
condition|)
block|{
name|status
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|SDMMC_STATUS_FIFO_FULL
condition|)
break|break;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_DATA
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
name|data
operator|->
name|xfer_len
operator|+=
literal|4
expr_stmt|;
block|}
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_RINTSTS
argument_list|,
name|SDMMC_INTMASK_TXDR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dwmmc_start_cmd
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mmc_command
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|mmc_data
modifier|*
name|data
decl_stmt|;
name|uint32_t
name|blksz
decl_stmt|;
name|uint32_t
name|cmdr
decl_stmt|;
name|sc
operator|->
name|curcmd
operator|=
name|cmd
expr_stmt|;
name|data
operator|=
name|cmd
operator|->
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|hwtype
operator|&
name|HWTYPE_MASK
operator|)
operator|==
name|HWTYPE_ROCKCHIP
condition|)
name|dwmmc_setup_bus
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|clock
argument_list|)
expr_stmt|;
comment|/* XXX Upper layers don't always set this */
name|cmd
operator|->
name|mrq
operator|=
name|sc
operator|->
name|req
expr_stmt|;
comment|/* Begin setting up command register. */
name|cmdr
operator|=
name|cmd
operator|->
name|opcode
expr_stmt|;
name|dprintf
argument_list|(
literal|"cmd->opcode 0x%08x\n"
argument_list|,
name|cmd
operator|->
name|opcode
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|opcode
operator|==
name|MMC_STOP_TRANSMISSION
operator|||
name|cmd
operator|->
name|opcode
operator|==
name|MMC_GO_IDLE_STATE
operator|||
name|cmd
operator|->
name|opcode
operator|==
name|MMC_GO_INACTIVE_STATE
condition|)
name|cmdr
operator||=
name|SDMMC_CMD_STOP_ABORT
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|->
name|opcode
operator|!=
name|MMC_SEND_STATUS
operator|&&
name|data
condition|)
name|cmdr
operator||=
name|SDMMC_CMD_WAIT_PRVDATA
expr_stmt|;
comment|/* Set up response handling. */
if|if
condition|(
name|MMC_RSP
argument_list|(
name|cmd
operator|->
name|flags
argument_list|)
operator|!=
name|MMC_RSP_NONE
condition|)
block|{
name|cmdr
operator||=
name|SDMMC_CMD_RESP_EXP
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|flags
operator|&
name|MMC_RSP_136
condition|)
name|cmdr
operator||=
name|SDMMC_CMD_RESP_LONG
expr_stmt|;
block|}
if|if
condition|(
name|cmd
operator|->
name|flags
operator|&
name|MMC_RSP_CRC
condition|)
name|cmdr
operator||=
name|SDMMC_CMD_RESP_CRC
expr_stmt|;
comment|/* 	 * XXX: Not all platforms want this. 	 */
name|cmdr
operator||=
name|SDMMC_CMD_USE_HOLD_REG
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|flags
operator|&
name|CARD_INIT_DONE
operator|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|flags
operator||=
operator|(
name|CARD_INIT_DONE
operator|)
expr_stmt|;
name|cmdr
operator||=
name|SDMMC_CMD_SEND_INIT
expr_stmt|;
block|}
if|if
condition|(
name|data
condition|)
block|{
if|if
condition|(
operator|(
name|cmd
operator|->
name|opcode
operator|==
name|MMC_WRITE_MULTIPLE_BLOCK
operator|||
name|cmd
operator|->
name|opcode
operator|==
name|MMC_READ_MULTIPLE_BLOCK
operator|)
operator|&&
name|sc
operator|->
name|use_auto_stop
condition|)
name|cmdr
operator||=
name|SDMMC_CMD_SEND_ASTOP
expr_stmt|;
name|cmdr
operator||=
name|SDMMC_CMD_DATA_EXP
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|flags
operator|&
name|MMC_DATA_STREAM
condition|)
name|cmdr
operator||=
name|SDMMC_CMD_MODE_STREAM
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|flags
operator|&
name|MMC_DATA_WRITE
condition|)
name|cmdr
operator||=
name|SDMMC_CMD_DATA_WRITE
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_TMOUT
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_BYTCNT
argument_list|,
name|data
operator|->
name|len
argument_list|)
expr_stmt|;
name|blksz
operator|=
operator|(
name|data
operator|->
name|len
operator|<
name|MMC_SECTOR_SIZE
operator|)
condition|?
then|\
name|data
operator|->
name|len
else|:
name|MMC_SECTOR_SIZE
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_BLKSIZ
argument_list|,
name|blksz
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|use_pio
condition|)
block|{
name|pio_prepare
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dma_prepare
argument_list|(
name|sc
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
name|wmb
argument_list|()
expr_stmt|;
block|}
name|dprintf
argument_list|(
literal|"cmdr 0x%08x\n"
argument_list|,
name|cmdr
argument_list|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMDARG
argument_list|,
name|cmd
operator|->
name|arg
argument_list|)
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|SDMMC_CMD
argument_list|,
name|cmdr
operator||
name|SDMMC_CMD_START
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|dwmmc_next_operation
parameter_list|(
name|struct
name|dwmmc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|mmc_request
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|sc
operator|->
name|req
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return;
name|sc
operator|->
name|acd_rcvd
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|dto_rcvd
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|cmd_done
operator|=
literal|0
expr_stmt|;
comment|/* 	 * XXX: Wait until card is still busy. 	 * We do need this to prevent data timeouts, 	 * mostly caused by multi-block write command 	 * followed by single-read. 	 */
while|while
condition|(
name|READ4
argument_list|(
name|sc
argument_list|,
name|SDMMC_STATUS
argument_list|)
operator|&
operator|(
name|SDMMC_STATUS_DATA_BUSY
operator|)
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|PENDING_CMD
condition|)
block|{
name|sc
operator|->
name|flags
operator|&=
operator|~
name|PENDING_CMD
expr_stmt|;
name|dwmmc_start_cmd
argument_list|(
name|sc
argument_list|,
name|req
operator|->
name|cmd
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|PENDING_STOP
operator|&&
operator|!
name|sc
operator|->
name|use_auto_stop
condition|)
block|{
name|sc
operator|->
name|flags
operator|&=
operator|~
name|PENDING_STOP
expr_stmt|;
name|dwmmc_start_cmd
argument_list|(
name|sc
argument_list|,
name|req
operator|->
name|stop
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|req
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|curcmd
operator|=
name|NULL
expr_stmt|;
name|req
operator|->
name|done
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_request
parameter_list|(
name|device_t
name|brdev
parameter_list|,
name|device_t
name|reqdev
parameter_list|,
name|struct
name|mmc_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|brdev
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"%s\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|DWMMC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|req
operator|!=
name|NULL
condition|)
block|{
name|DWMMC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|sc
operator|->
name|req
operator|=
name|req
expr_stmt|;
name|sc
operator|->
name|flags
operator||=
name|PENDING_CMD
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|req
operator|->
name|stop
condition|)
name|sc
operator|->
name|flags
operator||=
name|PENDING_STOP
expr_stmt|;
name|dwmmc_next_operation
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DWMMC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_get_ro
parameter_list|(
name|device_t
name|brdev
parameter_list|,
name|device_t
name|reqdev
parameter_list|)
block|{
name|dprintf
argument_list|(
literal|"%s\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_acquire_host
parameter_list|(
name|device_t
name|brdev
parameter_list|,
name|device_t
name|reqdev
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|brdev
argument_list|)
expr_stmt|;
name|DWMMC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|bus_busy
condition|)
name|msleep
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|PZERO
argument_list|,
literal|"dwmmcah"
argument_list|,
name|hz
operator|/
literal|5
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bus_busy
operator|++
expr_stmt|;
name|DWMMC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_release_host
parameter_list|(
name|device_t
name|brdev
parameter_list|,
name|device_t
name|reqdev
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|brdev
argument_list|)
expr_stmt|;
name|DWMMC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bus_busy
operator|--
expr_stmt|;
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DWMMC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_read_ivar
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|which
parameter_list|,
name|uintptr_t
modifier|*
name|result
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|bus
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
case|case
name|MMCBR_IVAR_BUS_MODE
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|bus_mode
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_BUS_WIDTH
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|bus_width
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_CHIP_SELECT
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|chip_select
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_CLOCK
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|clock
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_F_MIN
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|f_min
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_F_MAX
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|f_max
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_HOST_OCR
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|host_ocr
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_MODE
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|mode
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_OCR
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|ocr
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_POWER_MODE
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|power_mode
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_VDD
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|vdd
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_CAPS
case|:
name|sc
operator|->
name|host
operator|.
name|caps
operator||=
name|MMC_CAP_4_BIT_DATA
operator||
name|MMC_CAP_8_BIT_DATA
expr_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|host
operator|.
name|caps
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_MAX_DATA
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|result
operator|=
name|sc
operator|->
name|desc_count
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwmmc_write_ivar
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|which
parameter_list|,
name|uintptr_t
name|value
parameter_list|)
block|{
name|struct
name|dwmmc_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|bus
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
case|case
name|MMCBR_IVAR_BUS_MODE
case|:
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|bus_mode
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_BUS_WIDTH
case|:
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|bus_width
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_CHIP_SELECT
case|:
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|chip_select
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_CLOCK
case|:
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|clock
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_MODE
case|:
name|sc
operator|->
name|host
operator|.
name|mode
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_OCR
case|:
name|sc
operator|->
name|host
operator|.
name|ocr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_POWER_MODE
case|:
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|power_mode
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|MMCBR_IVAR_VDD
case|:
name|sc
operator|->
name|host
operator|.
name|ios
operator|.
name|vdd
operator|=
name|value
expr_stmt|;
break|break;
comment|/* These are read-only */
case|case
name|MMCBR_IVAR_CAPS
case|:
case|case
name|MMCBR_IVAR_HOST_OCR
case|:
case|case
name|MMCBR_IVAR_F_MIN
case|:
case|case
name|MMCBR_IVAR_F_MAX
case|:
case|case
name|MMCBR_IVAR_MAX_DATA
case|:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|dwmmc_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|dwmmc_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|dwmmc_attach
argument_list|)
block|,
comment|/* Bus interface */
name|DEVMETHOD
argument_list|(
name|bus_read_ivar
argument_list|,
name|dwmmc_read_ivar
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_write_ivar
argument_list|,
name|dwmmc_write_ivar
argument_list|)
block|,
comment|/* mmcbr_if */
name|DEVMETHOD
argument_list|(
name|mmcbr_update_ios
argument_list|,
name|dwmmc_update_ios
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|mmcbr_request
argument_list|,
name|dwmmc_request
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|mmcbr_get_ro
argument_list|,
name|dwmmc_get_ro
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|mmcbr_acquire_host
argument_list|,
name|dwmmc_acquire_host
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|mmcbr_release_host
argument_list|,
name|dwmmc_release_host
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|driver_t
name|dwmmc_driver
init|=
block|{
literal|"dwmmc"
block|,
name|dwmmc_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|dwmmc_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|dwmmc_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|dwmmc
argument_list|,
name|simplebus
argument_list|,
name|dwmmc_driver
argument_list|,
name|dwmmc_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|dwmmc
argument_list|,
name|ofwbus
argument_list|,
name|dwmmc_driver
argument_list|,
name|dwmmc_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|mmc
argument_list|,
name|dwmmc
argument_list|,
name|mmc_driver
argument_list|,
name|mmc_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|dwmmc
argument_list|,
name|mmc
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit

